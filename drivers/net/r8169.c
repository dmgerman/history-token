multiline_comment|/*&n;=========================================================================&n; r8169.c: A RealTek RTL-8169 Gigabit Ethernet driver for Linux kernel 2.4.x.&n; --------------------------------------------------------------------&n;&n; History:&n; Feb  4 2002&t;- created initially by ShuChen &lt;shuchen@realtek.com.tw&gt;.&n; May 20 2002&t;- Add link status force-mode and TBI mode support.&n;=========================================================================&n;  1. The media can be forced in 5 modes.&n;&t; Command: &squot;insmod r8169 media = SET_MEDIA&squot;&n;&t; Ex:&t;  &squot;insmod r8169 media = 0x04&squot; will force PHY to operate in 100Mpbs Half-duplex.&n;&t;&n;&t; SET_MEDIA can be:&n; &t;&t;_10_Half&t;= 0x01&n; &t;&t;_10_Full&t;= 0x02&n; &t;&t;_100_Half&t;= 0x04&n; &t;&t;_100_Full&t;= 0x08&n; &t;&t;_1000_Full&t;= 0x10&n;  &n;  2. Support TBI mode.&n;//=========================================================================&n;RTL8169_VERSION &quot;1.1&quot;&t;&lt;2002/10/4&gt;&n;&n;&t;The bit4:0 of MII register 4 is called &quot;selector field&quot;, and have to be&n;&t;00001b to indicate support of IEEE std 802.3 during NWay process of&n;&t;exchanging Link Code Word (FLP). &n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
DECL|macro|RTL8169_VERSION
mdefine_line|#define RTL8169_VERSION &quot;1.1&quot;
DECL|macro|MODULENAME
mdefine_line|#define MODULENAME &quot;r8169&quot;
DECL|macro|RTL8169_DRIVER_NAME
mdefine_line|#define RTL8169_DRIVER_NAME   MODULENAME &quot; Gigabit Ethernet driver &quot; RTL8169_VERSION
DECL|macro|PFX
mdefine_line|#define PFX MODULENAME &quot;: &quot;
macro_line|#ifdef RTL8169_DEBUG
DECL|macro|assert
mdefine_line|#define assert(expr) &bslash;&n;        if(!(expr)) {&t;&t;&t;&t;&t;&bslash;&n;&t;        printk( &quot;Assertion failed! %s,%s,%s,line=%d&bslash;n&quot;,&t;&bslash;&n;        &t;#expr,__FILE__,__FUNCTION__,__LINE__);&t;&t;&bslash;&n;        }
macro_line|#else
DECL|macro|assert
mdefine_line|#define assert(expr) do {} while (0)
macro_line|#endif&t;
singleline_comment|// end of #ifdef RTL8169_DEBUG
multiline_comment|/* media options */
DECL|macro|MAX_UNITS
mdefine_line|#define MAX_UNITS 8
DECL|variable|media
r_static
r_int
id|media
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
multiline_comment|/* Maximum number of multicast addresses to filter (vs. Rx-all-multicast).&n;   The RTL chips use a 64 element hash table based on the Ethernet CRC.  */
DECL|variable|multicast_filter_limit
r_static
r_int
id|multicast_filter_limit
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* MAC address length*/
DECL|macro|MAC_ADDR_LEN
mdefine_line|#define MAC_ADDR_LEN&t;6
multiline_comment|/* max supported gigabit ethernet frame size -- must be at least (dev-&gt;mtu+14+4).*/
DECL|macro|MAX_ETH_FRAME_SIZE
mdefine_line|#define MAX_ETH_FRAME_SIZE&t;1536
DECL|macro|TX_FIFO_THRESH
mdefine_line|#define TX_FIFO_THRESH 256&t;&t;/* In bytes */
DECL|macro|RX_FIFO_THRESH
mdefine_line|#define RX_FIFO_THRESH&t;7&t;&t;/* 7 means NO threshold, Rx buffer level before first PCI xfer.  */
DECL|macro|RX_DMA_BURST
mdefine_line|#define RX_DMA_BURST&t;6&t;&t;/* Maximum PCI burst, &squot;6&squot; is 1024 */
DECL|macro|TX_DMA_BURST
mdefine_line|#define TX_DMA_BURST&t;6&t;&t;/* Maximum PCI burst, &squot;6&squot; is 1024 */
DECL|macro|EarlyTxThld
mdefine_line|#define EarlyTxThld &t;0x3F&t;&t;/* 0x3F means NO early transmit */
DECL|macro|RxPacketMaxSize
mdefine_line|#define RxPacketMaxSize&t;0x0800&t;&t;/* Maximum size supported is 16K-1 */
DECL|macro|InterFrameGap
mdefine_line|#define InterFrameGap&t;0x03&t;&t;/* 3 means InterFrameGap = the shortest one */
DECL|macro|NUM_TX_DESC
mdefine_line|#define NUM_TX_DESC&t;64&t;&t;/* Number of Tx descriptor registers*/
DECL|macro|NUM_RX_DESC
mdefine_line|#define NUM_RX_DESC&t;64&t;&t;/* Number of Rx descriptor registers*/
DECL|macro|RX_BUF_SIZE
mdefine_line|#define RX_BUF_SIZE&t;1536&t;&t;/* Rx Buffer size */
DECL|macro|RTL_MIN_IO_SIZE
mdefine_line|#define RTL_MIN_IO_SIZE 0x80
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  (6*HZ)
multiline_comment|/* write/read MMIO register */
DECL|macro|RTL_W8
mdefine_line|#define RTL_W8(reg, val8)&t;writeb ((val8), ioaddr + (reg))
DECL|macro|RTL_W16
mdefine_line|#define RTL_W16(reg, val16)&t;writew ((val16), ioaddr + (reg))
DECL|macro|RTL_W32
mdefine_line|#define RTL_W32(reg, val32)&t;writel ((val32), ioaddr + (reg))
DECL|macro|RTL_R8
mdefine_line|#define RTL_R8(reg)&t;&t;readb (ioaddr + (reg))
DECL|macro|RTL_R16
mdefine_line|#define RTL_R16(reg)&t;&t;readw (ioaddr + (reg))
DECL|macro|RTL_R32
mdefine_line|#define RTL_R32(reg)&t;&t;((unsigned long) readl (ioaddr + (reg)))
r_static
r_struct
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|variable|__devinitdata
)brace
id|board_info
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;RealTek RTL8169 Gigabit Ethernet&quot;
)brace
comma
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|rtl8169_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_int|0x10ec
comma
l_int|0x8169
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|rtl8169_pci_tbl
)paren
suffix:semicolon
DECL|enum|RTL8169_registers
r_enum
id|RTL8169_registers
(brace
DECL|enumerator|MAC0
id|MAC0
op_assign
l_int|0
comma
multiline_comment|/* Ethernet hardware address. */
DECL|enumerator|MAR0
id|MAR0
op_assign
l_int|8
comma
multiline_comment|/* Multicast filter. */
DECL|enumerator|TxDescStartAddr
id|TxDescStartAddr
op_assign
l_int|0x20
comma
DECL|enumerator|TxHDescStartAddr
id|TxHDescStartAddr
op_assign
l_int|0x28
comma
DECL|enumerator|FLASH
id|FLASH
op_assign
l_int|0x30
comma
DECL|enumerator|ERSR
id|ERSR
op_assign
l_int|0x36
comma
DECL|enumerator|ChipCmd
id|ChipCmd
op_assign
l_int|0x37
comma
DECL|enumerator|TxPoll
id|TxPoll
op_assign
l_int|0x38
comma
DECL|enumerator|IntrMask
id|IntrMask
op_assign
l_int|0x3C
comma
DECL|enumerator|IntrStatus
id|IntrStatus
op_assign
l_int|0x3E
comma
DECL|enumerator|TxConfig
id|TxConfig
op_assign
l_int|0x40
comma
DECL|enumerator|RxConfig
id|RxConfig
op_assign
l_int|0x44
comma
DECL|enumerator|RxMissed
id|RxMissed
op_assign
l_int|0x4C
comma
DECL|enumerator|Cfg9346
id|Cfg9346
op_assign
l_int|0x50
comma
DECL|enumerator|Config0
id|Config0
op_assign
l_int|0x51
comma
DECL|enumerator|Config1
id|Config1
op_assign
l_int|0x52
comma
DECL|enumerator|Config2
id|Config2
op_assign
l_int|0x53
comma
DECL|enumerator|Config3
id|Config3
op_assign
l_int|0x54
comma
DECL|enumerator|Config4
id|Config4
op_assign
l_int|0x55
comma
DECL|enumerator|Config5
id|Config5
op_assign
l_int|0x56
comma
DECL|enumerator|MultiIntr
id|MultiIntr
op_assign
l_int|0x5C
comma
DECL|enumerator|PHYAR
id|PHYAR
op_assign
l_int|0x60
comma
DECL|enumerator|TBICSR
id|TBICSR
op_assign
l_int|0x64
comma
DECL|enumerator|TBI_ANAR
id|TBI_ANAR
op_assign
l_int|0x68
comma
DECL|enumerator|TBI_LPAR
id|TBI_LPAR
op_assign
l_int|0x6A
comma
DECL|enumerator|PHYstatus
id|PHYstatus
op_assign
l_int|0x6C
comma
DECL|enumerator|RxMaxSize
id|RxMaxSize
op_assign
l_int|0xDA
comma
DECL|enumerator|CPlusCmd
id|CPlusCmd
op_assign
l_int|0xE0
comma
DECL|enumerator|RxDescStartAddr
id|RxDescStartAddr
op_assign
l_int|0xE4
comma
DECL|enumerator|EarlyTxThres
id|EarlyTxThres
op_assign
l_int|0xEC
comma
DECL|enumerator|FuncEvent
id|FuncEvent
op_assign
l_int|0xF0
comma
DECL|enumerator|FuncEventMask
id|FuncEventMask
op_assign
l_int|0xF4
comma
DECL|enumerator|FuncPresetState
id|FuncPresetState
op_assign
l_int|0xF8
comma
DECL|enumerator|FuncForceEvent
id|FuncForceEvent
op_assign
l_int|0xFC
comma
)brace
suffix:semicolon
DECL|enum|RTL8169_register_content
r_enum
id|RTL8169_register_content
(brace
multiline_comment|/*InterruptStatusBits*/
DECL|enumerator|SYSErr
id|SYSErr
op_assign
l_int|0x8000
comma
DECL|enumerator|PCSTimeout
id|PCSTimeout
op_assign
l_int|0x4000
comma
DECL|enumerator|SWInt
id|SWInt
op_assign
l_int|0x0100
comma
DECL|enumerator|TxDescUnavail
id|TxDescUnavail
op_assign
l_int|0x80
comma
DECL|enumerator|RxFIFOOver
id|RxFIFOOver
op_assign
l_int|0x40
comma
DECL|enumerator|RxUnderrun
id|RxUnderrun
op_assign
l_int|0x20
comma
DECL|enumerator|RxOverflow
id|RxOverflow
op_assign
l_int|0x10
comma
DECL|enumerator|TxErr
id|TxErr
op_assign
l_int|0x08
comma
DECL|enumerator|TxOK
id|TxOK
op_assign
l_int|0x04
comma
DECL|enumerator|RxErr
id|RxErr
op_assign
l_int|0x02
comma
DECL|enumerator|RxOK
id|RxOK
op_assign
l_int|0x01
comma
multiline_comment|/*RxStatusDesc*/
DECL|enumerator|RxRES
id|RxRES
op_assign
l_int|0x00200000
comma
DECL|enumerator|RxCRC
id|RxCRC
op_assign
l_int|0x00080000
comma
DECL|enumerator|RxRUNT
id|RxRUNT
op_assign
l_int|0x00100000
comma
DECL|enumerator|RxRWT
id|RxRWT
op_assign
l_int|0x00400000
comma
multiline_comment|/*ChipCmdBits*/
DECL|enumerator|CmdReset
id|CmdReset
op_assign
l_int|0x10
comma
DECL|enumerator|CmdRxEnb
id|CmdRxEnb
op_assign
l_int|0x08
comma
DECL|enumerator|CmdTxEnb
id|CmdTxEnb
op_assign
l_int|0x04
comma
DECL|enumerator|RxBufEmpty
id|RxBufEmpty
op_assign
l_int|0x01
comma
multiline_comment|/*Cfg9346Bits*/
DECL|enumerator|Cfg9346_Lock
id|Cfg9346_Lock
op_assign
l_int|0x00
comma
DECL|enumerator|Cfg9346_Unlock
id|Cfg9346_Unlock
op_assign
l_int|0xC0
comma
multiline_comment|/*rx_mode_bits*/
DECL|enumerator|AcceptErr
id|AcceptErr
op_assign
l_int|0x20
comma
DECL|enumerator|AcceptRunt
id|AcceptRunt
op_assign
l_int|0x10
comma
DECL|enumerator|AcceptBroadcast
id|AcceptBroadcast
op_assign
l_int|0x08
comma
DECL|enumerator|AcceptMulticast
id|AcceptMulticast
op_assign
l_int|0x04
comma
DECL|enumerator|AcceptMyPhys
id|AcceptMyPhys
op_assign
l_int|0x02
comma
DECL|enumerator|AcceptAllPhys
id|AcceptAllPhys
op_assign
l_int|0x01
comma
multiline_comment|/*RxConfigBits*/
DECL|enumerator|RxCfgFIFOShift
id|RxCfgFIFOShift
op_assign
l_int|13
comma
DECL|enumerator|RxCfgDMAShift
id|RxCfgDMAShift
op_assign
l_int|8
comma
multiline_comment|/*TxConfigBits*/
DECL|enumerator|TxInterFrameGapShift
id|TxInterFrameGapShift
op_assign
l_int|24
comma
DECL|enumerator|TxDMAShift
id|TxDMAShift
op_assign
l_int|8
comma
multiline_comment|/* DMA burst value (0-7) is shift this many bits */
multiline_comment|/*rtl8169_PHYstatus*/
DECL|enumerator|TBI_Enable
id|TBI_Enable
op_assign
l_int|0x80
comma
DECL|enumerator|TxFlowCtrl
id|TxFlowCtrl
op_assign
l_int|0x40
comma
DECL|enumerator|RxFlowCtrl
id|RxFlowCtrl
op_assign
l_int|0x20
comma
DECL|enumerator|_1000bpsF
id|_1000bpsF
op_assign
l_int|0x10
comma
DECL|enumerator|_100bps
id|_100bps
op_assign
l_int|0x08
comma
DECL|enumerator|_10bps
id|_10bps
op_assign
l_int|0x04
comma
DECL|enumerator|LinkStatus
id|LinkStatus
op_assign
l_int|0x02
comma
DECL|enumerator|FullDup
id|FullDup
op_assign
l_int|0x01
comma
multiline_comment|/*GIGABIT_PHY_registers*/
DECL|enumerator|PHY_CTRL_REG
id|PHY_CTRL_REG
op_assign
l_int|0
comma
DECL|enumerator|PHY_STAT_REG
id|PHY_STAT_REG
op_assign
l_int|1
comma
DECL|enumerator|PHY_AUTO_NEGO_REG
id|PHY_AUTO_NEGO_REG
op_assign
l_int|4
comma
DECL|enumerator|PHY_1000_CTRL_REG
id|PHY_1000_CTRL_REG
op_assign
l_int|9
comma
multiline_comment|/*GIGABIT_PHY_REG_BIT*/
DECL|enumerator|PHY_Restart_Auto_Nego
id|PHY_Restart_Auto_Nego
op_assign
l_int|0x0200
comma
DECL|enumerator|PHY_Enable_Auto_Nego
id|PHY_Enable_Auto_Nego
op_assign
l_int|0x1000
comma
singleline_comment|//PHY_STAT_REG = 1;
DECL|enumerator|PHY_Auto_Neco_Comp
id|PHY_Auto_Neco_Comp
op_assign
l_int|0x0020
comma
singleline_comment|//PHY_AUTO_NEGO_REG = 4;
DECL|enumerator|PHY_Cap_10_Half
id|PHY_Cap_10_Half
op_assign
l_int|0x0020
comma
DECL|enumerator|PHY_Cap_10_Full
id|PHY_Cap_10_Full
op_assign
l_int|0x0040
comma
DECL|enumerator|PHY_Cap_100_Half
id|PHY_Cap_100_Half
op_assign
l_int|0x0080
comma
DECL|enumerator|PHY_Cap_100_Full
id|PHY_Cap_100_Full
op_assign
l_int|0x0100
comma
singleline_comment|//PHY_1000_CTRL_REG = 9;
DECL|enumerator|PHY_Cap_1000_Full
id|PHY_Cap_1000_Full
op_assign
l_int|0x0200
comma
DECL|enumerator|PHY_Cap_Null
id|PHY_Cap_Null
op_assign
l_int|0x0
comma
multiline_comment|/*_MediaType*/
DECL|enumerator|_10_Half
id|_10_Half
op_assign
l_int|0x01
comma
DECL|enumerator|_10_Full
id|_10_Full
op_assign
l_int|0x02
comma
DECL|enumerator|_100_Half
id|_100_Half
op_assign
l_int|0x04
comma
DECL|enumerator|_100_Full
id|_100_Full
op_assign
l_int|0x08
comma
DECL|enumerator|_1000_Full
id|_1000_Full
op_assign
l_int|0x10
comma
multiline_comment|/*_TBICSRBit*/
DECL|enumerator|TBILinkOK
id|TBILinkOK
op_assign
l_int|0x02000000
comma
)brace
suffix:semicolon
r_const
r_static
r_struct
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|version
id|u8
id|version
suffix:semicolon
multiline_comment|/* depend on RTL8169 docs */
DECL|member|RxConfigMask
id|u32
id|RxConfigMask
suffix:semicolon
multiline_comment|/* should clear the bits supported by this chip */
DECL|variable|rtl_chip_info
)brace
id|rtl_chip_info
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;RTL-8169&quot;
comma
l_int|0x00
comma
l_int|0xff7e1880
comma
)brace
comma
)brace
suffix:semicolon
DECL|enum|_DescStatusBit
r_enum
id|_DescStatusBit
(brace
DECL|enumerator|OWNbit
id|OWNbit
op_assign
l_int|0x80000000
comma
DECL|enumerator|EORbit
id|EORbit
op_assign
l_int|0x40000000
comma
DECL|enumerator|FSbit
id|FSbit
op_assign
l_int|0x20000000
comma
DECL|enumerator|LSbit
id|LSbit
op_assign
l_int|0x10000000
comma
)brace
suffix:semicolon
DECL|struct|TxDesc
r_struct
id|TxDesc
(brace
DECL|member|status
id|u32
id|status
suffix:semicolon
DECL|member|vlan_tag
id|u32
id|vlan_tag
suffix:semicolon
DECL|member|buf_addr
id|u32
id|buf_addr
suffix:semicolon
DECL|member|buf_Haddr
id|u32
id|buf_Haddr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|RxDesc
r_struct
id|RxDesc
(brace
DECL|member|status
id|u32
id|status
suffix:semicolon
DECL|member|vlan_tag
id|u32
id|vlan_tag
suffix:semicolon
DECL|member|buf_addr
id|u32
id|buf_addr
suffix:semicolon
DECL|member|buf_Haddr
id|u32
id|buf_Haddr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|rtl8169_private
r_struct
id|rtl8169_private
(brace
DECL|member|mmio_addr
r_void
op_star
id|mmio_addr
suffix:semicolon
multiline_comment|/* memory map physical address*/
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
multiline_comment|/* Index of PCI device  */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
multiline_comment|/* statistics of net device */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* spin lock flag */
DECL|member|chipset
r_int
id|chipset
suffix:semicolon
DECL|member|cur_rx
r_int
r_int
id|cur_rx
suffix:semicolon
multiline_comment|/* Index into the Rx descriptor buffer of next Rx pkt. */
DECL|member|cur_tx
r_int
r_int
id|cur_tx
suffix:semicolon
multiline_comment|/* Index into the Tx descriptor buffer of next Rx pkt. */
DECL|member|dirty_tx
r_int
r_int
id|dirty_tx
suffix:semicolon
DECL|member|TxDescArrays
r_int
r_char
op_star
id|TxDescArrays
suffix:semicolon
multiline_comment|/* Index of Tx Descriptor buffer */
DECL|member|RxDescArrays
r_int
r_char
op_star
id|RxDescArrays
suffix:semicolon
multiline_comment|/* Index of Rx Descriptor buffer */
DECL|member|TxDescArray
r_struct
id|TxDesc
op_star
id|TxDescArray
suffix:semicolon
multiline_comment|/* Index of 256-alignment Tx Descriptor buffer */
DECL|member|RxDescArray
r_struct
id|RxDesc
op_star
id|RxDescArray
suffix:semicolon
multiline_comment|/* Index of 256-alignment Rx Descriptor buffer */
DECL|member|RxBufferRings
r_int
r_char
op_star
id|RxBufferRings
suffix:semicolon
multiline_comment|/* Index of Rx Buffer  */
DECL|member|RxBufferRing
r_int
r_char
op_star
id|RxBufferRing
(braket
id|NUM_RX_DESC
)braket
suffix:semicolon
multiline_comment|/* Index of Rx Buffer array */
DECL|member|Tx_skbuff
r_struct
id|sk_buff
op_star
id|Tx_skbuff
(braket
id|NUM_TX_DESC
)braket
suffix:semicolon
multiline_comment|/* Index of Transmit data buffer */
)brace
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;Realtek&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;RealTek RTL-8169 Gigabit Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
(paren
id|media
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
r_static
r_int
id|rtl8169_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|rtl8169_start_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rtl8169_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|rtl8169_init_ring
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rtl8169_hw_start
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|rtl8169_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_inline
id|u32
id|ether_crc
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|rtl8169_set_rx_mode
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rtl8169_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|rtl8169_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|netdev
)paren
suffix:semicolon
DECL|variable|rtl8169_intr_mask
r_static
r_const
id|u16
id|rtl8169_intr_mask
op_assign
id|SYSErr
op_or
id|PCSTimeout
op_or
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxFIFOOver
op_or
id|TxErr
op_or
id|TxOK
op_or
id|RxErr
op_or
id|RxOK
suffix:semicolon
DECL|variable|rtl8169_rx_config
r_static
r_const
r_int
r_int
id|rtl8169_rx_config
op_assign
(paren
id|RX_FIFO_THRESH
op_lshift
id|RxCfgFIFOShift
)paren
op_or
(paren
id|RX_DMA_BURST
op_lshift
id|RxCfgDMAShift
)paren
suffix:semicolon
singleline_comment|//=================================================================
singleline_comment|//&t;PHYAR
singleline_comment|//&t;bit&t;&t;Symbol
singleline_comment|//&t;31&t;&t;Flag
singleline_comment|//&t;30-21&t;reserved
singleline_comment|//&t;20-16&t;5-bit GMII/MII register address
singleline_comment|//&t;15-0&t;16-bit GMII/MII register data
singleline_comment|//=================================================================
DECL|function|RTL8169_WRITE_GMII_REG
r_void
id|RTL8169_WRITE_GMII_REG
c_func
(paren
r_void
op_star
id|ioaddr
comma
r_int
id|RegAddr
comma
r_int
id|value
)paren
(brace
r_int
id|i
suffix:semicolon
id|RTL_W32
(paren
id|PHYAR
comma
l_int|0x80000000
op_or
(paren
id|RegAddr
op_amp
l_int|0xFF
)paren
op_lshift
l_int|16
op_or
id|value
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
singleline_comment|// Check if the RTL8169 has completed writing to the specified MII register
r_if
c_cond
(paren
op_logical_neg
(paren
id|RTL_R32
c_func
(paren
id|PHYAR
)paren
op_amp
l_int|0x80000000
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_else
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
singleline_comment|// end of if( ! (RTL_R32(PHYAR)&amp;0x80000000) )
)brace
singleline_comment|// end of for() loop
)brace
singleline_comment|//=================================================================
DECL|function|RTL8169_READ_GMII_REG
r_int
id|RTL8169_READ_GMII_REG
c_func
(paren
r_void
op_star
id|ioaddr
comma
r_int
id|RegAddr
)paren
(brace
r_int
id|i
comma
id|value
op_assign
op_minus
l_int|1
suffix:semicolon
id|RTL_W32
(paren
id|PHYAR
comma
l_int|0x0
op_or
(paren
id|RegAddr
op_amp
l_int|0xFF
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
singleline_comment|// Check if the RTL8169 has completed retrieving data from the specified MII register
r_if
c_cond
(paren
id|RTL_R32
c_func
(paren
id|PHYAR
)paren
op_amp
l_int|0x80000000
)paren
(brace
id|value
op_assign
(paren
r_int
)paren
(paren
id|RTL_R32
c_func
(paren
id|PHYAR
)paren
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
singleline_comment|// end of if( RTL_R32(PHYAR) &amp; 0x80000000 )
)brace
singleline_comment|// end of for() loop
r_return
id|value
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
singleline_comment|//======================================================================================================
DECL|function|rtl8169_init_board
r_static
r_int
id|__devinit
id|rtl8169_init_board
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|net_device
op_star
op_star
id|dev_out
comma
r_void
op_star
op_star
id|ioaddr_out
)paren
(brace
r_void
op_star
id|ioaddr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|rtl8169_private
op_star
id|tp
suffix:semicolon
r_int
id|rc
comma
id|i
suffix:semicolon
r_int
r_int
id|mmio_start
comma
id|mmio_end
comma
id|mmio_flags
comma
id|mmio_len
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
m_assert
(paren
id|pdev
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|ioaddr_out
op_ne
l_int|NULL
)paren
suffix:semicolon
op_star
id|ioaddr_out
op_assign
l_int|NULL
suffix:semicolon
op_star
id|dev_out
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// dev zeroed in init_etherdev 
id|dev
op_assign
id|init_etherdev
(paren
l_int|NULL
comma
r_sizeof
(paren
op_star
id|tp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to alloc new ethernet&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
singleline_comment|// enable device (incl. PCI PM wakeup and hotplug setup)
id|rc
op_assign
id|pci_enable_device
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
id|mmio_start
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|mmio_end
op_assign
id|pci_resource_end
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|mmio_flags
op_assign
id|pci_resource_flags
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|mmio_len
op_assign
id|pci_resource_len
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// make sure PCI base addr 1 is MMIO
r_if
c_cond
(paren
op_logical_neg
(paren
id|mmio_flags
op_amp
id|IORESOURCE_MEM
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;region #1 not an MMIO resource, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
singleline_comment|// check for weird/broken PCI region reporting
r_if
c_cond
(paren
id|mmio_len
OL
id|RTL_MIN_IO_SIZE
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Invalid PCI region size(s), aborting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|rc
op_assign
id|pci_request_regions
(paren
id|pdev
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
singleline_comment|// enable PCI bus-mastering
id|pci_set_master
(paren
id|pdev
)paren
suffix:semicolon
singleline_comment|// ioremap MMIO region 
id|ioaddr
op_assign
id|ioremap
(paren
id|mmio_start
comma
id|mmio_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioaddr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot remap MMIO, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_out_free_res
suffix:semicolon
)brace
singleline_comment|// Soft reset the chip. 
id|RTL_W8
(paren
id|ChipCmd
comma
id|CmdReset
)paren
suffix:semicolon
singleline_comment|// Check that the chip has finished the reset.
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|RTL_R8
c_func
(paren
id|ChipCmd
)paren
op_amp
id|CmdReset
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_else
id|udelay
(paren
l_int|10
)paren
suffix:semicolon
singleline_comment|// identify chip attached to board
id|tmp
op_assign
id|RTL_R32
(paren
id|TxConfig
)paren
suffix:semicolon
id|tmp
op_assign
(paren
(paren
id|tmp
op_amp
l_int|0x7c000000
)paren
op_plus
(paren
(paren
id|tmp
op_amp
l_int|0x00800000
)paren
op_lshift
l_int|2
)paren
)paren
op_rshift
l_int|24
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ARRAY_SIZE
(paren
id|rtl_chip_info
)paren
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
id|tmp
op_eq
id|rtl_chip_info
(braket
id|i
)braket
dot
id|version
)paren
(brace
id|tp-&gt;chipset
op_assign
id|i
suffix:semicolon
r_goto
id|match
suffix:semicolon
)brace
singleline_comment|//if unknown chip, assume array element #0, original RTL-8169 in this case
id|printk
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;PCI device %s: unknown chip version, assuming RTL-8169&bslash;n&quot;
comma
id|pdev-&gt;slot_name
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;PCI device %s: TxConfig = 0x%lx&bslash;n&quot;
comma
id|pdev-&gt;slot_name
comma
(paren
r_int
r_int
)paren
id|RTL_R32
c_func
(paren
id|TxConfig
)paren
)paren
suffix:semicolon
id|tp-&gt;chipset
op_assign
l_int|0
suffix:semicolon
id|match
suffix:colon
op_star
id|ioaddr_out
op_assign
id|ioaddr
suffix:semicolon
op_star
id|dev_out
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
singleline_comment|//err_out_iounmap:
m_assert
(paren
id|ioaddr
OG
l_int|0
)paren
suffix:semicolon
id|iounmap
(paren
id|ioaddr
)paren
suffix:semicolon
id|err_out_free_res
suffix:colon
id|pci_release_regions
(paren
id|pdev
)paren
suffix:semicolon
id|err_out
suffix:colon
id|unregister_netdev
(paren
id|dev
)paren
suffix:semicolon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_init_one
r_static
r_int
id|__devinit
id|rtl8169_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
l_int|NULL
suffix:semicolon
r_void
op_star
id|ioaddr
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|board_idx
op_assign
op_minus
l_int|1
suffix:semicolon
r_static
r_int
id|printed_version
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|option
op_assign
op_minus
l_int|1
comma
id|Cap10_100
op_assign
l_int|0
comma
id|Cap1000
op_assign
l_int|0
suffix:semicolon
m_assert
(paren
id|pdev
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|ent
op_ne
l_int|NULL
)paren
suffix:semicolon
id|board_idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|RTL8169_DRIVER_NAME
l_string|&quot; loaded&bslash;n&quot;
)paren
suffix:semicolon
id|printed_version
op_assign
l_int|1
suffix:semicolon
)brace
id|i
op_assign
id|rtl8169_init_board
(paren
id|pdev
comma
op_amp
id|dev
comma
op_amp
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
m_assert
(paren
id|ioaddr
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|dev
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|tp
op_ne
l_int|NULL
)paren
suffix:semicolon
singleline_comment|// Get MAC address //
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAC_ADDR_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|RTL_R8
c_func
(paren
id|MAC0
op_plus
id|i
)paren
suffix:semicolon
)brace
id|dev-&gt;open
op_assign
id|rtl8169_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|rtl8169_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|rtl8169_get_stats
suffix:semicolon
id|dev-&gt;stop
op_assign
id|rtl8169_close
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|rtl8169_tx_timeout
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|rtl8169_set_rx_mode
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|ioaddr
suffix:semicolon
singleline_comment|//&t;dev-&gt;do_ioctl &t;&t;= mii_ioctl;
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
singleline_comment|// private data //
id|tp-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
id|tp-&gt;mmio_addr
op_assign
id|ioaddr
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: Identified chip type is &squot;%s&squot;.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rtl_chip_info
(braket
id|tp-&gt;chipset
)braket
dot
id|name
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
id|pdev-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: %s at 0x%lx, &quot;
l_string|&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x, &quot;
l_string|&quot;IRQ %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board_info
(braket
id|ent-&gt;driver_data
)braket
dot
id|name
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
comma
id|dev-&gt;irq
)paren
suffix:semicolon
singleline_comment|// if TBI is not endbled
r_if
c_cond
(paren
op_logical_neg
(paren
id|RTL_R8
c_func
(paren
id|PHYstatus
)paren
op_amp
id|TBI_Enable
)paren
)paren
(brace
r_int
id|val
op_assign
id|RTL8169_READ_GMII_REG
c_func
(paren
id|ioaddr
comma
id|PHY_AUTO_NEGO_REG
)paren
suffix:semicolon
id|option
op_assign
(paren
id|board_idx
op_ge
id|MAX_UNITS
)paren
ques
c_cond
l_int|0
suffix:colon
id|media
(braket
id|board_idx
)braket
suffix:semicolon
singleline_comment|// Force RTL8169 in 10/100/1000 Full/Half mode.
r_if
c_cond
(paren
id|option
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Force-mode Enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|Cap10_100
op_assign
l_int|0
comma
id|Cap1000
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|option
)paren
(brace
r_case
id|_10_Half
suffix:colon
id|Cap10_100
op_assign
id|PHY_Cap_10_Half
suffix:semicolon
id|Cap1000
op_assign
id|PHY_Cap_Null
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_10_Full
suffix:colon
id|Cap10_100
op_assign
id|PHY_Cap_10_Full
suffix:semicolon
id|Cap1000
op_assign
id|PHY_Cap_Null
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_100_Half
suffix:colon
id|Cap10_100
op_assign
id|PHY_Cap_100_Half
suffix:semicolon
id|Cap1000
op_assign
id|PHY_Cap_Null
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_100_Full
suffix:colon
id|Cap10_100
op_assign
id|PHY_Cap_100_Full
suffix:semicolon
id|Cap1000
op_assign
id|PHY_Cap_Null
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_1000_Full
suffix:colon
id|Cap10_100
op_assign
id|PHY_Cap_Null
suffix:semicolon
id|Cap1000
op_assign
id|PHY_Cap_1000_Full
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|RTL8169_WRITE_GMII_REG
c_func
(paren
id|ioaddr
comma
id|PHY_AUTO_NEGO_REG
comma
id|Cap10_100
op_or
(paren
id|val
op_amp
l_int|0x1F
)paren
)paren
suffix:semicolon
singleline_comment|//leave PHY_AUTO_NEGO_REG bit4:0 unchanged
id|RTL8169_WRITE_GMII_REG
c_func
(paren
id|ioaddr
comma
id|PHY_1000_CTRL_REG
comma
id|Cap1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Auto-negotiation Enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
singleline_comment|// enable 10/100 Full/Half Mode, leave PHY_AUTO_NEGO_REG bit4:0 unchanged
id|RTL8169_WRITE_GMII_REG
c_func
(paren
id|ioaddr
comma
id|PHY_AUTO_NEGO_REG
comma
id|PHY_Cap_10_Half
op_or
id|PHY_Cap_10_Full
op_or
id|PHY_Cap_100_Half
op_or
id|PHY_Cap_100_Full
op_or
(paren
id|val
op_amp
l_int|0x1F
)paren
)paren
suffix:semicolon
singleline_comment|// enable 1000 Full Mode
id|RTL8169_WRITE_GMII_REG
c_func
(paren
id|ioaddr
comma
id|PHY_1000_CTRL_REG
comma
id|PHY_Cap_1000_Full
)paren
suffix:semicolon
)brace
singleline_comment|// end of if( option &gt; 0 )
singleline_comment|// Enable auto-negotiation and restart auto-nigotiation
id|RTL8169_WRITE_GMII_REG
c_func
(paren
id|ioaddr
comma
id|PHY_CTRL_REG
comma
id|PHY_Enable_Auto_Nego
op_or
id|PHY_Restart_Auto_Nego
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
singleline_comment|// wait for auto-negotiation process
r_for
c_loop
(paren
id|i
op_assign
l_int|10000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
singleline_comment|//check if auto-negotiation complete
r_if
c_cond
(paren
id|RTL8169_READ_GMII_REG
c_func
(paren
id|ioaddr
comma
id|PHY_STAT_REG
)paren
op_amp
id|PHY_Auto_Neco_Comp
)paren
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|option
op_assign
id|RTL_R8
c_func
(paren
id|PHYstatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option
op_amp
id|_1000bpsF
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 1000Mbps Full-duplex operation.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %sMbps %s-duplex operation.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|option
op_amp
id|_100bps
)paren
ques
c_cond
l_string|&quot;100&quot;
suffix:colon
l_string|&quot;10&quot;
comma
(paren
id|option
op_amp
id|FullDup
)paren
ques
c_cond
l_string|&quot;Full&quot;
suffix:colon
l_string|&quot;Half&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_else
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
singleline_comment|// end of if( RTL8169_READ_GMII_REG(ioaddr, 1) &amp; 0x20 )
)brace
singleline_comment|// end for-loop to wait for auto-negotiation process
)brace
singleline_comment|// end of TBI is not enabled
r_else
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 1000Mbps Full-duplex operation, TBI Link %s!&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|RTL_R32
c_func
(paren
id|TBICSR
)paren
op_amp
id|TBILinkOK
)paren
ques
c_cond
l_string|&quot;OK&quot;
suffix:colon
l_string|&quot;Failed&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// end of TBI is not enabled
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_remove_one
r_static
r_void
id|__devexit
id|rtl8169_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
(paren
r_struct
id|rtl8169_private
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
m_assert
(paren
id|dev
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|tp
op_ne
l_int|NULL
)paren
suffix:semicolon
id|unregister_netdev
(paren
id|dev
)paren
suffix:semicolon
id|iounmap
(paren
id|tp-&gt;mmio_addr
)paren
suffix:semicolon
id|pci_release_regions
(paren
id|pdev
)paren
suffix:semicolon
singleline_comment|// poison memory before freeing 
id|memset
(paren
id|dev
comma
l_int|0xBC
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
r_sizeof
(paren
r_struct
id|rtl8169_private
)paren
)paren
suffix:semicolon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
id|pdev-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_open
r_static
r_int
id|rtl8169_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|u8
id|diff
suffix:semicolon
id|u32
id|TxPhyAddr
comma
id|RxPhyAddr
suffix:semicolon
id|retval
op_assign
id|request_irq
(paren
id|dev-&gt;irq
comma
id|rtl8169_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_return
id|retval
suffix:semicolon
)brace
singleline_comment|//////////////////////////////////////////////////////////////////////////////
id|tp-&gt;TxDescArrays
op_assign
id|kmalloc
c_func
(paren
id|NUM_TX_DESC
op_star
r_sizeof
(paren
r_struct
id|TxDesc
)paren
op_plus
l_int|256
comma
id|GFP_KERNEL
)paren
suffix:semicolon
singleline_comment|// Tx Desscriptor needs 256 bytes alignment;
id|TxPhyAddr
op_assign
id|virt_to_bus
c_func
(paren
id|tp-&gt;TxDescArrays
)paren
suffix:semicolon
id|diff
op_assign
l_int|256
op_minus
(paren
id|TxPhyAddr
op_minus
(paren
(paren
id|TxPhyAddr
op_rshift
l_int|8
)paren
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|TxPhyAddr
op_add_assign
id|diff
suffix:semicolon
id|tp-&gt;TxDescArray
op_assign
(paren
r_struct
id|TxDesc
op_star
)paren
(paren
id|tp-&gt;TxDescArrays
op_plus
id|diff
)paren
suffix:semicolon
id|tp-&gt;RxDescArrays
op_assign
id|kmalloc
c_func
(paren
id|NUM_RX_DESC
op_star
r_sizeof
(paren
r_struct
id|RxDesc
)paren
op_plus
l_int|256
comma
id|GFP_KERNEL
)paren
suffix:semicolon
singleline_comment|// Rx Desscriptor needs 256 bytes alignment;
id|RxPhyAddr
op_assign
id|virt_to_bus
c_func
(paren
id|tp-&gt;RxDescArrays
)paren
suffix:semicolon
id|diff
op_assign
l_int|256
op_minus
(paren
id|RxPhyAddr
op_minus
(paren
(paren
id|RxPhyAddr
op_rshift
l_int|8
)paren
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|RxPhyAddr
op_add_assign
id|diff
suffix:semicolon
id|tp-&gt;RxDescArray
op_assign
(paren
r_struct
id|RxDesc
op_star
)paren
(paren
id|tp-&gt;RxDescArrays
op_plus
id|diff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;TxDescArrays
op_eq
l_int|NULL
op_logical_or
id|tp-&gt;RxDescArrays
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Allocate RxDescArray or TxDescArray failed&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;TxDescArrays
)paren
id|kfree
c_func
(paren
id|tp-&gt;TxDescArrays
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;RxDescArrays
)paren
id|kfree
c_func
(paren
id|tp-&gt;RxDescArrays
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|tp-&gt;RxBufferRings
op_assign
id|kmalloc
c_func
(paren
id|RX_BUF_SIZE
op_star
id|NUM_RX_DESC
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;RxBufferRings
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Allocate RxBufferRing failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
singleline_comment|//////////////////////////////////////////////////////////////////////////////
id|rtl8169_init_ring
(paren
id|dev
)paren
suffix:semicolon
id|rtl8169_hw_start
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//end of rtl8169_open (struct net_device *dev)
singleline_comment|//======================================================================================================
DECL|function|rtl8169_hw_start
r_static
r_void
id|rtl8169_hw_start
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_void
op_star
id|ioaddr
op_assign
id|tp-&gt;mmio_addr
suffix:semicolon
id|u32
id|i
suffix:semicolon
multiline_comment|/* Soft reset the chip. */
id|RTL_W8
(paren
id|ChipCmd
comma
id|CmdReset
)paren
suffix:semicolon
multiline_comment|/* Check that the chip has finished the reset. */
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|RTL_R8
c_func
(paren
id|ChipCmd
)paren
op_amp
id|CmdReset
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_else
id|udelay
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|RTL_W8
(paren
id|Cfg9346
comma
id|Cfg9346_Unlock
)paren
suffix:semicolon
id|RTL_W8
(paren
id|ChipCmd
comma
id|CmdTxEnb
op_or
id|CmdRxEnb
)paren
suffix:semicolon
id|RTL_W8
(paren
id|EarlyTxThres
comma
id|EarlyTxThld
)paren
suffix:semicolon
singleline_comment|// For gigabit rtl8169
id|RTL_W16
(paren
id|RxMaxSize
comma
id|RxPacketMaxSize
)paren
suffix:semicolon
singleline_comment|// Set Rx Config register
id|i
op_assign
id|rtl8169_rx_config
op_or
(paren
id|RTL_R32
c_func
(paren
id|RxConfig
)paren
op_amp
id|rtl_chip_info
(braket
id|tp-&gt;chipset
)braket
dot
id|RxConfigMask
)paren
suffix:semicolon
id|RTL_W32
(paren
id|RxConfig
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Set DMA burst size and Interframe Gap Time */
id|RTL_W32
(paren
id|TxConfig
comma
(paren
id|TX_DMA_BURST
op_lshift
id|TxDMAShift
)paren
op_or
(paren
id|InterFrameGap
op_lshift
id|TxInterFrameGapShift
)paren
)paren
suffix:semicolon
id|tp-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
id|RTL_W32
(paren
id|TxDescStartAddr
comma
id|virt_to_bus
c_func
(paren
id|tp-&gt;TxDescArray
)paren
)paren
suffix:semicolon
id|RTL_W32
(paren
id|RxDescStartAddr
comma
id|virt_to_bus
c_func
(paren
id|tp-&gt;RxDescArray
)paren
)paren
suffix:semicolon
id|RTL_W8
(paren
id|Cfg9346
comma
id|Cfg9346_Lock
)paren
suffix:semicolon
id|udelay
(paren
l_int|10
)paren
suffix:semicolon
id|RTL_W32
(paren
id|RxMissed
comma
l_int|0
)paren
suffix:semicolon
id|rtl8169_set_rx_mode
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* no early-rx interrupts */
id|RTL_W16
(paren
id|MultiIntr
comma
id|RTL_R16
c_func
(paren
id|MultiIntr
)paren
op_amp
l_int|0xF000
)paren
suffix:semicolon
multiline_comment|/* Enable all known interrupts by setting the interrupt mask. */
id|RTL_W16
(paren
id|IntrMask
comma
id|rtl8169_intr_mask
)paren
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
singleline_comment|//end of rtl8169_hw_start (struct net_device *dev)
singleline_comment|//======================================================================================================
DECL|function|rtl8169_init_ring
r_static
r_void
id|rtl8169_init_ring
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tp-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|tp-&gt;TxDescArray
comma
l_int|0x0
comma
id|NUM_TX_DESC
op_star
r_sizeof
(paren
r_struct
id|TxDesc
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tp-&gt;RxDescArray
comma
l_int|0x0
comma
id|NUM_RX_DESC
op_star
r_sizeof
(paren
r_struct
id|RxDesc
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;Tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
(paren
id|NUM_RX_DESC
op_minus
l_int|1
)paren
)paren
(brace
id|tp-&gt;RxDescArray
(braket
id|i
)braket
dot
id|status
op_assign
(paren
id|OWNbit
op_or
id|EORbit
)paren
op_plus
id|RX_BUF_SIZE
suffix:semicolon
)brace
r_else
id|tp-&gt;RxDescArray
(braket
id|i
)braket
dot
id|status
op_assign
id|OWNbit
op_plus
id|RX_BUF_SIZE
suffix:semicolon
id|tp-&gt;RxBufferRing
(braket
id|i
)braket
op_assign
op_amp
(paren
id|tp-&gt;RxBufferRings
(braket
id|i
op_star
id|RX_BUF_SIZE
)braket
)paren
suffix:semicolon
id|tp-&gt;RxDescArray
(braket
id|i
)braket
dot
id|buf_addr
op_assign
id|virt_to_bus
c_func
(paren
id|tp-&gt;RxBufferRing
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_tx_clear
r_static
r_void
id|rtl8169_tx_clear
(paren
r_struct
id|rtl8169_private
op_star
id|tp
)paren
(brace
r_int
id|i
suffix:semicolon
id|tp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;Tx_skbuff
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
(paren
id|tp-&gt;Tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|tp-&gt;Tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
)brace
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_tx_timeout
r_static
r_void
id|rtl8169_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_void
op_star
id|ioaddr
op_assign
id|tp-&gt;mmio_addr
suffix:semicolon
id|u8
id|tmp8
suffix:semicolon
multiline_comment|/* disable Tx, if not already */
id|tmp8
op_assign
id|RTL_R8
c_func
(paren
id|ChipCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp8
op_amp
id|CmdTxEnb
)paren
(brace
id|RTL_W8
(paren
id|ChipCmd
comma
id|tmp8
op_amp
op_complement
id|CmdTxEnb
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|RTL_W16
(paren
id|IntrMask
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* Stop a shared interrupt from scavenging while we are. */
id|spin_lock_irq
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
id|rtl8169_tx_clear
(paren
id|tp
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* ...and finally, reset everything */
id|rtl8169_hw_start
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_start_xmit
r_static
r_int
id|rtl8169_start_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_void
op_star
id|ioaddr
op_assign
id|tp-&gt;mmio_addr
suffix:semicolon
r_int
id|entry
op_assign
id|tp-&gt;cur_tx
op_mod
id|NUM_TX_DESC
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tp-&gt;TxDescArray
(braket
id|entry
)braket
dot
id|status
op_amp
id|OWNbit
)paren
op_eq
l_int|0
)paren
(brace
id|tp-&gt;Tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|tp-&gt;TxDescArray
(braket
id|entry
)braket
dot
id|buf_addr
op_assign
id|virt_to_bus
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_ne
(paren
id|NUM_TX_DESC
op_minus
l_int|1
)paren
)paren
(brace
id|tp-&gt;TxDescArray
(braket
id|entry
)braket
dot
id|status
op_assign
(paren
id|OWNbit
op_or
id|FSbit
op_or
id|LSbit
)paren
op_or
(paren
(paren
id|skb-&gt;len
OG
id|ETH_ZLEN
)paren
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
)paren
suffix:semicolon
)brace
r_else
id|tp-&gt;TxDescArray
(braket
id|entry
)braket
dot
id|status
op_assign
(paren
id|OWNbit
op_or
id|EORbit
op_or
id|FSbit
op_or
id|LSbit
)paren
op_or
(paren
(paren
id|skb-&gt;len
OG
id|ETH_ZLEN
)paren
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
)paren
suffix:semicolon
id|RTL_W8
(paren
id|TxPoll
comma
l_int|0x40
)paren
suffix:semicolon
singleline_comment|//set polling bit
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|tp-&gt;cur_tx
op_increment
suffix:semicolon
)brace
singleline_comment|//end of if( (tp-&gt;TxDescArray[entry].status &amp; 0x80000000)==0 )
id|spin_unlock_irq
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tp-&gt;cur_tx
op_minus
id|NUM_TX_DESC
)paren
op_eq
id|tp-&gt;dirty_tx
)paren
(brace
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_tx_interrupt
r_static
r_void
id|rtl8169_tx_interrupt
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|rtl8169_private
op_star
id|tp
comma
r_void
op_star
id|ioaddr
)paren
(brace
r_int
r_int
id|dirty_tx
comma
id|tx_left
op_assign
l_int|0
suffix:semicolon
r_int
id|entry
op_assign
id|tp-&gt;cur_tx
op_mod
id|NUM_TX_DESC
suffix:semicolon
m_assert
(paren
id|dev
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|tp
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|ioaddr
op_ne
l_int|NULL
)paren
suffix:semicolon
id|dirty_tx
op_assign
id|tp-&gt;dirty_tx
suffix:semicolon
id|tx_left
op_assign
id|tp-&gt;cur_tx
op_minus
id|dirty_tx
suffix:semicolon
r_while
c_loop
(paren
id|tx_left
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|tp-&gt;TxDescArray
(braket
id|entry
)braket
dot
id|status
op_amp
id|OWNbit
)paren
op_eq
l_int|0
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|tp-&gt;Tx_skbuff
(braket
id|dirty_tx
op_mod
id|NUM_TX_DESC
)braket
)paren
suffix:semicolon
id|tp-&gt;Tx_skbuff
(braket
id|dirty_tx
op_mod
id|NUM_TX_DESC
)braket
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|dirty_tx
op_increment
suffix:semicolon
id|tx_left
op_decrement
suffix:semicolon
id|entry
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tp-&gt;dirty_tx
op_ne
id|dirty_tx
)paren
(brace
id|tp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
(paren
id|dev
)paren
)paren
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_rx_interrupt
r_static
r_void
id|rtl8169_rx_interrupt
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|rtl8169_private
op_star
id|tp
comma
r_void
op_star
id|ioaddr
)paren
(brace
r_int
id|cur_rx
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_size
op_assign
l_int|0
suffix:semicolon
m_assert
(paren
id|dev
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|tp
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|ioaddr
op_ne
l_int|NULL
)paren
suffix:semicolon
id|cur_rx
op_assign
id|tp-&gt;cur_rx
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tp-&gt;RxDescArray
(braket
id|cur_rx
)braket
dot
id|status
op_amp
id|OWNbit
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;RxDescArray
(braket
id|cur_rx
)braket
dot
id|status
op_amp
id|RxRES
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Rx ERROR!!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;RxDescArray
(braket
id|cur_rx
)braket
dot
id|status
op_amp
(paren
id|RxRWT
op_or
id|RxRUNT
)paren
)paren
id|tp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;RxDescArray
(braket
id|cur_rx
)braket
dot
id|status
op_amp
id|RxCRC
)paren
id|tp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|pkt_size
op_assign
(paren
r_int
)paren
(paren
id|tp-&gt;RxDescArray
(braket
id|cur_rx
)braket
dot
id|status
op_amp
l_int|0x00001FFF
)paren
op_minus
l_int|4
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_size
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// 16 byte align the IP fields. //
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|tp-&gt;RxBufferRing
(braket
id|cur_rx
)braket
comma
id|pkt_size
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_size
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur_rx
op_eq
(paren
id|NUM_RX_DESC
op_minus
l_int|1
)paren
)paren
(brace
id|tp-&gt;RxDescArray
(braket
id|cur_rx
)braket
dot
id|status
op_assign
(paren
id|OWNbit
op_or
id|EORbit
)paren
op_plus
id|RX_BUF_SIZE
suffix:semicolon
)brace
r_else
id|tp-&gt;RxDescArray
(braket
id|cur_rx
)braket
dot
id|status
op_assign
id|OWNbit
op_plus
id|RX_BUF_SIZE
suffix:semicolon
id|tp-&gt;RxDescArray
(braket
id|cur_rx
)braket
dot
id|buf_addr
op_assign
id|virt_to_bus
c_func
(paren
id|tp-&gt;RxBufferRing
(braket
id|cur_rx
)braket
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|tp-&gt;stats.rx_bytes
op_add_assign
id|pkt_size
suffix:semicolon
id|tp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* We should check that some rx space is free.&n;&t;&t;   &t;&t;If not, free one and mark stats-&gt;rx_dropped++. */
id|tp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
singleline_comment|// end of if (skb != NULL)
)brace
singleline_comment|// end of if( tp-&gt;RxDescArray[cur_rx].status &amp; RxRES )
id|cur_rx
op_assign
(paren
id|cur_rx
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_DESC
suffix:semicolon
)brace
singleline_comment|// end of while ( (tp-&gt;RxDescArray[cur_rx].status &amp; 0x80000000)== 0)
id|tp-&gt;cur_rx
op_assign
id|cur_rx
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up after the Tx thread. */
DECL|function|rtl8169_interrupt
r_static
r_void
id|rtl8169_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_instance
suffix:semicolon
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
r_void
op_star
id|ioaddr
op_assign
id|tp-&gt;mmio_addr
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|status
op_assign
id|RTL_R16
c_func
(paren
id|IntrStatus
)paren
suffix:semicolon
multiline_comment|/* h/w no longer present (hotplug?) or major error, bail */
r_if
c_cond
(paren
id|status
op_eq
l_int|0xFFFF
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;if (status &amp; RxUnderrun)&n;&t;&t;&t;link_changed = RTL_R16 (CSCR) &amp; CSCR_LinkChangeBit;&n;*/
id|RTL_W16
c_func
(paren
id|IntrStatus
comma
(paren
id|status
op_amp
id|RxFIFOOver
)paren
ques
c_cond
(paren
id|status
op_or
id|RxOverflow
)paren
suffix:colon
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|SYSErr
op_or
id|PCSTimeout
op_or
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxFIFOOver
op_or
id|TxErr
op_or
id|TxOK
op_or
id|RxErr
op_or
id|RxOK
)paren
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
singleline_comment|// Rx interrupt 
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RxOK
op_or
id|RxUnderrun
op_or
id|RxOverflow
op_or
id|RxFIFOOver
)paren
)paren
(brace
id|rtl8169_rx_interrupt
(paren
id|dev
comma
id|tp
comma
id|ioaddr
)paren
suffix:semicolon
)brace
singleline_comment|// Tx interrupt
r_if
c_cond
(paren
id|status
op_amp
(paren
id|TxOK
op_or
id|TxErr
)paren
)paren
(brace
id|spin_lock
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
id|rtl8169_tx_interrupt
(paren
id|dev
comma
id|tp
comma
id|ioaddr
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
)brace
id|boguscnt
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|boguscnt
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|boguscnt
op_le
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work at interrupt!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Clear all interrupt sources. */
id|RTL_W16
c_func
(paren
id|IntrStatus
comma
l_int|0xffff
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_close
r_static
r_int
id|rtl8169_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_void
op_star
id|ioaddr
op_assign
id|tp-&gt;mmio_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx DMA processes. */
id|RTL_W8
(paren
id|ChipCmd
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|RTL_W16
(paren
id|IntrMask
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* Update the error counts. */
id|tp-&gt;stats.rx_missed_errors
op_add_assign
id|RTL_R32
c_func
(paren
id|RxMissed
)paren
suffix:semicolon
id|RTL_W32
c_func
(paren
id|RxMissed
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|tp-&gt;lock
)paren
suffix:semicolon
id|synchronize_irq
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|free_irq
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|rtl8169_tx_clear
(paren
id|tp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp-&gt;TxDescArrays
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp-&gt;RxDescArrays
)paren
suffix:semicolon
id|tp-&gt;TxDescArrays
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;RxDescArrays
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;TxDescArray
op_assign
l_int|NULL
suffix:semicolon
id|tp-&gt;RxDescArray
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|tp-&gt;RxBufferRings
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;RxBufferRing
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
DECL|variable|ethernet_polynomial
r_static
r_int
r_const
id|ethernet_polynomial
op_assign
l_int|0x04c11db7U
suffix:semicolon
DECL|function|ether_crc
r_static
r_inline
id|u32
id|ether_crc
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|crc
op_assign
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|length
op_ge
l_int|0
)paren
(brace
r_int
r_char
id|current_octet
op_assign
op_star
id|data
op_increment
suffix:semicolon
r_int
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
l_int|8
suffix:semicolon
id|bit
op_increment
comma
id|current_octet
op_rshift_assign
l_int|1
)paren
id|crc
op_assign
(paren
id|crc
op_lshift
l_int|1
)paren
op_xor
(paren
(paren
id|crc
OL
l_int|0
)paren
op_xor
(paren
id|current_octet
op_amp
l_int|1
)paren
ques
c_cond
id|ethernet_polynomial
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|crc
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_set_rx_mode
r_static
r_void
id|rtl8169_set_rx_mode
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_void
op_star
id|ioaddr
op_assign
id|tp-&gt;mmio_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|mc_filter
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Multicast hash filter */
r_int
id|i
comma
id|rx_mode
suffix:semicolon
id|u32
id|tmp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Unconditionally log net taps. */
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptMyPhys
op_or
id|AcceptAllPhys
suffix:semicolon
id|mc_filter
(braket
l_int|1
)braket
op_assign
id|mc_filter
(braket
l_int|0
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to filter perfectly -- accept all multicasts. */
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptMyPhys
suffix:semicolon
id|mc_filter
(braket
l_int|1
)braket
op_assign
id|mc_filter
(braket
l_int|0
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptMyPhys
suffix:semicolon
id|mc_filter
(braket
l_int|1
)braket
op_assign
id|mc_filter
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
id|set_bit
(paren
id|ether_crc
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|26
comma
id|mc_filter
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|tp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
id|rtl8169_rx_config
op_or
id|rx_mode
op_or
(paren
id|RTL_R32
c_func
(paren
id|RxConfig
)paren
op_amp
id|rtl_chip_info
(braket
id|tp-&gt;chipset
)braket
dot
id|RxConfigMask
)paren
suffix:semicolon
id|RTL_W32
(paren
id|RxConfig
comma
id|tmp
)paren
suffix:semicolon
id|RTL_W32
(paren
id|MAR0
op_plus
l_int|0
comma
id|mc_filter
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|RTL_W32
(paren
id|MAR0
op_plus
l_int|4
comma
id|mc_filter
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|tp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
singleline_comment|//end of rtl8169_set_rx_mode (struct net_device *dev)
singleline_comment|//================================================================================
DECL|function|rtl8169_get_stats
r_struct
id|net_device_stats
op_star
id|rtl8169_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rtl8169_private
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|tp-&gt;stats
suffix:semicolon
)brace
singleline_comment|//================================================================================
DECL|variable|rtl8169_pci_driver
r_static
r_struct
id|pci_driver
id|rtl8169_pci_driver
op_assign
(brace
id|name
suffix:colon
id|MODULENAME
comma
id|id_table
suffix:colon
id|rtl8169_pci_tbl
comma
id|probe
suffix:colon
id|rtl8169_init_one
comma
id|remove
suffix:colon
id|rtl8169_remove_one
comma
id|suspend
suffix:colon
l_int|NULL
comma
id|resume
suffix:colon
l_int|NULL
comma
)brace
suffix:semicolon
singleline_comment|//======================================================================================================
DECL|function|rtl8169_init_module
r_static
r_int
id|__init
id|rtl8169_init_module
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
(paren
op_amp
id|rtl8169_pci_driver
)paren
suffix:semicolon
singleline_comment|// pci_register_driver (drv)
)brace
singleline_comment|//======================================================================================================
DECL|function|rtl8169_cleanup_module
r_static
r_void
id|__exit
id|rtl8169_cleanup_module
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|rtl8169_pci_driver
)paren
suffix:semicolon
)brace
singleline_comment|//======================================================================================================
DECL|variable|rtl8169_init_module
id|module_init
c_func
(paren
id|rtl8169_init_module
)paren
suffix:semicolon
DECL|variable|rtl8169_cleanup_module
id|module_exit
c_func
(paren
id|rtl8169_cleanup_module
)paren
suffix:semicolon
eof
