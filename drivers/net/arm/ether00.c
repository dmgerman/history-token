multiline_comment|/*&n; *  drivers/net/ether00.c&n; *&n; *  Copyright (C) 2001 Altera Corporation&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
multiline_comment|/* includes */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/pld/pld_hotswap.h&gt;
macro_line|#include &lt;asm/arch/excalibur.h&gt;
macro_line|#include &lt;asm/arch/hardware.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/sizes.h&gt;
macro_line|#include &lt;asm/arch/ether00.h&gt;
macro_line|#include &lt;asm/arch/tdkphy.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Clive Davies&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Altera Ether00 IP core driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ 1540 /* Size of each rx buffer */
DECL|macro|ETH_NR
mdefine_line|#define ETH_NR 4 /* Number of MACs this driver supports */
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)
DECL|macro|__dma_va
mdefine_line|#define __dma_va(x) (unsigned int)((unsigned int)priv-&gt;dma_data+(((unsigned int)(x))&amp;(EXC_SPSRAM_BLOCK0_SIZE-1)))
DECL|macro|__dma_pa
mdefine_line|#define __dma_pa(x) (unsigned int)(EXC_SPSRAM_BLOCK0_BASE+(((unsigned int)(x))-(unsigned int)priv-&gt;dma_data))
DECL|macro|ETHER00_BASE
mdefine_line|#define ETHER00_BASE&t;0
DECL|macro|ETHER00_TYPE
mdefine_line|#define&t;ETHER00_TYPE
DECL|macro|ETHER00_NAME
mdefine_line|#define ETHER00_NAME &quot;ether00&quot;
DECL|macro|MAC_REG_SIZE
mdefine_line|#define MAC_REG_SIZE 0x400 /* size of MAC register area */
multiline_comment|/* typedefs */
multiline_comment|/* The definition of the driver control structure */
DECL|macro|RX_NUM_BUFF
mdefine_line|#define RX_NUM_BUFF     10
DECL|macro|RX_NUM_FDESC
mdefine_line|#define RX_NUM_FDESC    10
DECL|macro|TX_NUM_FDESC
mdefine_line|#define TX_NUM_FDESC    10
DECL|struct|tx_fda_ent
r_struct
id|tx_fda_ent
(brace
DECL|member|fd
id|FDA_DESC
id|fd
suffix:semicolon
DECL|member|bd
id|BUF_DESC
id|bd
suffix:semicolon
DECL|member|pad
id|BUF_DESC
id|pad
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|rx_fda_ent
r_struct
id|rx_fda_ent
(brace
DECL|member|fd
id|FDA_DESC
id|fd
suffix:semicolon
DECL|member|bd
id|BUF_DESC
id|bd
suffix:semicolon
DECL|member|pad
id|BUF_DESC
id|pad
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|rx_blist_ent
r_struct
id|rx_blist_ent
(brace
DECL|member|fd
id|FDA_DESC
id|fd
suffix:semicolon
DECL|member|bd
id|BUF_DESC
id|bd
suffix:semicolon
DECL|member|pad
id|BUF_DESC
id|pad
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|net_priv
r_struct
id|net_priv
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|member|dma_data
r_void
op_star
id|dma_data
suffix:semicolon
DECL|member|rx_blist_vp
r_struct
id|rx_blist_ent
op_star
id|rx_blist_vp
suffix:semicolon
DECL|member|rx_fda_ptr
r_struct
id|rx_fda_ent
op_star
id|rx_fda_ptr
suffix:semicolon
DECL|member|tx_fdalist_vp
r_struct
id|tx_fda_ent
op_star
id|tx_fdalist_vp
suffix:semicolon
DECL|member|tq_memupdate
r_struct
id|tq_struct
id|tq_memupdate
suffix:semicolon
DECL|member|memupdate_scheduled
r_int
r_char
id|memupdate_scheduled
suffix:semicolon
DECL|member|rx_disabled
r_int
r_char
id|rx_disabled
suffix:semicolon
DECL|member|queue_stopped
r_int
r_char
id|queue_stopped
suffix:semicolon
DECL|member|rx_lock
id|spinlock_t
id|rx_lock
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|vendor_id
r_static
r_const
r_char
id|vendor_id
(braket
l_int|2
)braket
op_assign
initialization_block
suffix:semicolon
macro_line|#ifdef ETHER00_DEBUG
multiline_comment|/* Dump (most) registers for debugging puposes */
DECL|function|dump_regs
r_static
r_void
(def_block
id|dump_regs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
op_star
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n RX free descriptor area:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
(paren
r_int
r_int
op_star
)paren
id|priv-&gt;rx_fda_ptr
suffix:semicolon
id|i
OL
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|priv-&gt;rx_fda_ptr
op_plus
id|RX_NUM_FDESC
)paren
)paren
suffix:semicolon
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%#8x %#8x %#8x %#8x&bslash;n&quot;
comma
op_star
id|i
comma
op_star
(paren
id|i
op_plus
l_int|1
)paren
comma
op_star
(paren
id|i
op_plus
l_int|2
)paren
comma
op_star
(paren
id|i
op_plus
l_int|3
)paren
)paren
suffix:semicolon
id|i
op_add_assign
l_int|4
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n RX buffer list:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
(paren
r_int
r_int
op_star
)paren
id|priv-&gt;rx_blist_vp
suffix:semicolon
id|i
OL
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|priv-&gt;rx_blist_vp
op_plus
id|RX_NUM_BUFF
)paren
)paren
suffix:semicolon
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%#8x %#8x %#8x %#8x&bslash;n&quot;
comma
op_star
id|i
comma
op_star
(paren
id|i
op_plus
l_int|1
)paren
comma
op_star
(paren
id|i
op_plus
l_int|2
)paren
comma
op_star
(paren
id|i
op_plus
l_int|3
)paren
)paren
suffix:semicolon
id|i
op_add_assign
l_int|4
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n TX frame descriptor list:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
(paren
r_int
r_int
op_star
)paren
id|priv-&gt;tx_fdalist_vp
suffix:semicolon
id|i
OL
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|priv-&gt;tx_fdalist_vp
op_plus
id|TX_NUM_FDESC
)paren
)paren
suffix:semicolon
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%#8x %#8x %#8x %#8x&bslash;n&quot;
comma
op_star
id|i
comma
op_star
(paren
id|i
op_plus
l_int|1
)paren
comma
op_star
(paren
id|i
op_plus
l_int|2
)paren
comma
op_star
(paren
id|i
op_plus
l_int|3
)paren
)paren
suffix:semicolon
id|i
op_add_assign
l_int|4
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;ndma ctl=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_DMA_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;txfrmptr=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_TXFRMPTR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;txthrsh=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_TXTHRSH
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;txpollctr=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_TXPOLLCTR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;blfrmptr=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_BLFRMPTR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rxfragsize=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_RXFRAGSIZE
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tx_int_en=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_INT_EN
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fda_bas=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_FDA_BAS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fda_lim=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_FDA_LIM
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;int_src=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pausecnt=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_PAUSECNT
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rempaucnt=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_REMPAUCNT
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;txconfrmstat=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_TXCONFRMSTAT
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mac_ctl=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_MAC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arc_ctl=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_ARC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tx_ctl=%#x&bslash;n&quot;
comma
id|readw
c_func
(paren
id|ETHER_TX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
)brace
)def_block
macro_line|#endif /* ETHER00_DEBUG */
DECL|function|ether00_write_phy
r_static
r_int
id|ether00_write_phy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|address
comma
r_int
id|value
)paren
(brace
r_volatile
r_int
id|count
op_assign
l_int|1024
suffix:semicolon
id|writew
c_func
(paren
id|value
comma
id|ETHER_MD_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|ETHER_MD_CA_BUSY_MSK
op_or
id|ETHER_MD_CA_WR_MSK
op_or
(paren
id|address
op_amp
id|ETHER_MD_CA_ADDR_MSK
)paren
comma
id|ETHER_MD_CA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Wait for the command to complete */
r_while
c_loop
(paren
(paren
id|readw
c_func
(paren
id|ETHER_MD_CA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ETHER_MD_CA_BUSY_MSK
)paren
op_logical_and
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write to phy failed, addr=%#x, data=%#x&bslash;n&quot;
comma
id|address
comma
id|value
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether00_read_phy
r_static
r_int
id|ether00_read_phy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|address
)paren
(brace
r_volatile
r_int
id|count
op_assign
l_int|1024
suffix:semicolon
id|writew
c_func
(paren
id|ETHER_MD_CA_BUSY_MSK
op_or
(paren
id|address
op_amp
id|ETHER_MD_CA_ADDR_MSK
)paren
comma
id|ETHER_MD_CA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Wait for the command to complete */
r_while
c_loop
(paren
(paren
id|readw
c_func
(paren
id|ETHER_MD_CA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ETHER_MD_CA_BUSY_MSK
)paren
op_logical_and
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Read from phy timed out&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|readw
c_func
(paren
id|ETHER_MD_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|ether00_phy_int
r_static
r_void
id|ether00_phy_int
c_func
(paren
r_int
id|irq_num
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_int
id|irq_status
suffix:semicolon
id|irq_status
op_assign
id|ether00_read_phy
c_func
(paren
id|dev
comma
id|PHY_IRQ_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_status
op_amp
id|PHY_IRQ_CONTROL_ANEG_COMP_INT_MSK
)paren
(brace
multiline_comment|/*&n;&t;&t; * Autonegotiation complete on epxa10db. The mac doesn&squot;t&n;&t;&t; * twig if we&squot;re in full duplex so we need to check the&n;&t;&t; * phy status register and configure the mac accordingly&n;&t;&t; */
r_if
c_cond
(paren
id|ether00_read_phy
c_func
(paren
id|dev
comma
id|PHY_STATUS
)paren
op_amp
(paren
id|PHY_STATUS_10T_F_MSK
op_or
id|PHY_STATUS_100_X_F_MSK
)paren
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|ETHER_MAC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_or
id|ETHER_MAC_CTL_FULLDUP_MSK
comma
id|ETHER_MAC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|irq_status
op_amp
id|PHY_IRQ_CONTROL_LS_CHG_INT_MSK
)paren
(brace
r_if
c_cond
(paren
id|ether00_read_phy
c_func
(paren
id|dev
comma
id|PHY_STATUS
)paren
op_amp
id|PHY_STATUS_LINK_MSK
)paren
(brace
multiline_comment|/* Link is up */
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|//printk(&quot;Carrier on&bslash;n&quot;);
)brace
r_else
(brace
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|//printk(&quot;Carrier off&bslash;n&quot;);
)brace
)brace
)brace
DECL|function|setup_blist_entry
r_static
r_void
(def_block
id|setup_blist_entry
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|rx_blist_ent
op_star
id|blist_ent_ptr
)paren
(brace
multiline_comment|/* Make the buffer consistent with the cache as the mac is going to write&n;&t; * directly into it*/
id|blist_ent_ptr-&gt;fd.FDSystem
op_assign
(paren
r_int
r_int
)paren
id|skb
suffix:semicolon
id|blist_ent_ptr-&gt;bd.BuffData
op_assign
(paren
r_char
op_star
)paren
id|__pa
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|consistent_sync
c_func
(paren
id|skb-&gt;data
comma
id|PKT_BUF_SZ
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/* align IP on 16 Byte (DMA_CTL set to skip 2 bytes) */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|blist_ent_ptr-&gt;bd.BuffLength
op_assign
id|PKT_BUF_SZ
op_minus
l_int|2
suffix:semicolon
id|blist_ent_ptr-&gt;fd.FDLength
op_assign
l_int|1
suffix:semicolon
id|blist_ent_ptr-&gt;fd.FDCtl
op_assign
id|FDCTL_COWNSFD_MSK
suffix:semicolon
id|blist_ent_ptr-&gt;bd.BDCtl
op_assign
id|BDCTL_COWNSBD_MSK
suffix:semicolon
)brace
)def_block
DECL|function|ether00_mem_init
r_static
r_int
id|ether00_mem_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|tx_fda_ent
op_star
id|tx_fd_ptr
comma
op_star
id|tx_end_ptr
suffix:semicolon
r_struct
id|rx_blist_ent
op_star
id|blist_ent_ptr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Grab a block of on chip SRAM to contain the control stuctures for&n;&t; * the ethernet MAC. This uncached becuase it needs to be accesses by both&n;&t; * bus masters (cpu + mac). However, it shouldn&squot;t matter too much in terms&n;&t; * of speed as its on chip memory&n;&t; */
id|priv-&gt;dma_data
op_assign
id|ioremap_nocache
c_func
(paren
id|EXC_SPSRAM_BLOCK0_BASE
comma
id|EXC_SPSRAM_BLOCK0_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;dma_data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|priv-&gt;rx_fda_ptr
op_assign
(paren
r_struct
id|rx_fda_ent
op_star
)paren
id|priv-&gt;dma_data
suffix:semicolon
multiline_comment|/*&n;&t; * Now share it out amongst the Frame descriptors and the buffer list&n;&t; */
id|priv-&gt;rx_blist_vp
op_assign
(paren
r_struct
id|rx_blist_ent
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|priv-&gt;dma_data
op_plus
id|RX_NUM_FDESC
op_star
r_sizeof
(paren
r_struct
id|rx_fda_ent
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *Initalise the FDA list&n;&t; */
multiline_comment|/* set ownership to the controller */
id|memset
c_func
(paren
id|priv-&gt;rx_fda_ptr
comma
l_int|0x80
comma
id|RX_NUM_FDESC
op_star
r_sizeof
(paren
r_struct
id|rx_fda_ent
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *Initialise the buffer list&n;&t; */
id|blist_ent_ptr
op_assign
id|priv-&gt;rx_blist_vp
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|blist_ent_ptr
OL
(paren
id|priv-&gt;rx_blist_vp
op_plus
id|RX_NUM_BUFF
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|blist_ent_ptr-&gt;fd.FDLength
op_assign
l_int|1
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|setup_blist_entry
c_func
(paren
id|skb
comma
id|blist_ent_ptr
)paren
suffix:semicolon
id|blist_ent_ptr-&gt;fd.FDNext
op_assign
(paren
id|FDA_DESC
op_star
)paren
id|__dma_pa
c_func
(paren
id|blist_ent_ptr
op_plus
l_int|1
)paren
suffix:semicolon
id|blist_ent_ptr-&gt;bd.BDStat
op_assign
id|i
op_increment
suffix:semicolon
id|blist_ent_ptr
op_increment
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to initalise buffer list&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|blist_ent_ptr
op_decrement
suffix:semicolon
id|blist_ent_ptr-&gt;fd.FDNext
op_assign
(paren
id|FDA_DESC
op_star
)paren
id|__dma_pa
c_func
(paren
id|priv-&gt;rx_blist_vp
)paren
suffix:semicolon
id|priv-&gt;tx_fdalist_vp
op_assign
(paren
r_struct
id|tx_fda_ent
op_star
)paren
(paren
id|priv-&gt;rx_blist_vp
op_plus
id|RX_NUM_BUFF
)paren
suffix:semicolon
multiline_comment|/* Initialise the buffers to be a circular list. The mac will then go poll&n;&t; * the list until it finds a frame ready to transmit */
id|tx_end_ptr
op_assign
id|priv-&gt;tx_fdalist_vp
op_plus
id|TX_NUM_FDESC
suffix:semicolon
r_for
c_loop
(paren
id|tx_fd_ptr
op_assign
id|priv-&gt;tx_fdalist_vp
suffix:semicolon
id|tx_fd_ptr
OL
id|tx_end_ptr
suffix:semicolon
id|tx_fd_ptr
op_increment
)paren
(brace
id|tx_fd_ptr-&gt;fd.FDNext
op_assign
(paren
id|FDA_DESC
op_star
)paren
id|__dma_pa
c_func
(paren
(paren
id|tx_fd_ptr
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|tx_fd_ptr-&gt;fd.FDCtl
op_assign
l_int|1
suffix:semicolon
id|tx_fd_ptr-&gt;fd.FDStat
op_assign
l_int|0
suffix:semicolon
id|tx_fd_ptr-&gt;fd.FDLength
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Change the last FDNext pointer to make a circular list */
id|tx_fd_ptr
op_decrement
suffix:semicolon
id|tx_fd_ptr-&gt;fd.FDNext
op_assign
(paren
id|FDA_DESC
op_star
)paren
id|__dma_pa
c_func
(paren
id|priv-&gt;tx_fdalist_vp
)paren
suffix:semicolon
multiline_comment|/* Point the device at the chain of Rx and Tx Buffers */
id|writel
c_func
(paren
(paren
r_int
r_int
)paren
id|__dma_pa
c_func
(paren
id|priv-&gt;rx_fda_ptr
)paren
comma
id|ETHER_FDA_BAS
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|RX_NUM_FDESC
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|rx_fda_ent
)paren
comma
id|ETHER_FDA_LIM
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
r_int
r_int
)paren
id|__dma_pa
c_func
(paren
id|priv-&gt;rx_blist_vp
)paren
comma
id|ETHER_BLFRMPTR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
r_int
r_int
)paren
id|__dma_pa
c_func
(paren
id|priv-&gt;tx_fdalist_vp
)paren
comma
id|ETHER_TXFRMPTR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether00_mem_update
r_void
id|ether00_mem_update
c_func
(paren
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|net_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|tx_fda_ent
op_star
id|fda_ptr
op_assign
id|priv-&gt;tx_fdalist_vp
suffix:semicolon
r_struct
id|rx_blist_ent
op_star
id|blist_ent_ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|priv-&gt;tq_memupdate.sync
op_assign
l_int|0
suffix:semicolon
singleline_comment|//priv-&gt;tq_memupdate.list=
id|priv-&gt;memupdate_scheduled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Transmit interrupt */
r_while
c_loop
(paren
id|fda_ptr
OL
(paren
id|priv-&gt;tx_fdalist_vp
op_plus
id|TX_NUM_FDESC
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|FDCTL_COWNSFD_MSK
op_amp
id|fda_ptr-&gt;fd.FDCtl
)paren
op_logical_and
(paren
id|ETHER_TX_STAT_COMP_MSK
op_amp
id|fda_ptr-&gt;fd.FDStat
)paren
)paren
(brace
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_bytes
op_add_assign
id|fda_ptr-&gt;bd.BuffLength
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|fda_ptr-&gt;fd.FDSystem
suffix:semicolon
singleline_comment|//printk(&quot;%d:txcln:fda=%#x skb=%#x&bslash;n&quot;,jiffies,fda_ptr,skb);
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|fda_ptr-&gt;fd.FDSystem
op_assign
l_int|0
suffix:semicolon
id|fda_ptr-&gt;fd.FDStat
op_assign
l_int|0
suffix:semicolon
id|fda_ptr-&gt;fd.FDCtl
op_assign
l_int|0
suffix:semicolon
)brace
id|fda_ptr
op_increment
suffix:semicolon
)brace
multiline_comment|/* Fill in any missing buffers from the received queue */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;rx_lock
comma
id|flags
)paren
suffix:semicolon
id|blist_ent_ptr
op_assign
id|priv-&gt;rx_blist_vp
suffix:semicolon
r_while
c_loop
(paren
id|blist_ent_ptr
OL
(paren
id|priv-&gt;rx_blist_vp
op_plus
id|RX_NUM_BUFF
)paren
)paren
(brace
multiline_comment|/* fd.FDSystem of 0 indicates we failed to allocate the buffer in the ISR */
r_if
c_cond
(paren
op_logical_neg
id|blist_ent_ptr-&gt;fd.FDSystem
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
id|blist_ent_ptr-&gt;fd.FDSystem
op_assign
(paren
r_int
r_int
)paren
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|setup_blist_entry
c_func
(paren
id|skb
comma
id|blist_ent_ptr
)paren
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
id|blist_ent_ptr
op_increment
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rx_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;queue_stopped
)paren
(brace
singleline_comment|//printk(&quot;%d:cln:start q&bslash;n&quot;,jiffies);
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;rx_disabled
)paren
(brace
singleline_comment|//printk(&quot;%d:enable_irq&bslash;n&quot;,jiffies);
id|priv-&gt;rx_disabled
op_assign
l_int|0
suffix:semicolon
id|writel
c_func
(paren
id|ETHER_RX_CTL_RXEN_MSK
comma
id|ETHER_RX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|ether00_int
r_static
r_void
id|ether00_int
c_func
(paren
r_int
id|irq_num
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|net_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|interruptValue
suffix:semicolon
id|interruptValue
op_assign
id|readl
c_func
(paren
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
singleline_comment|//printk(&quot;INT_SRC=%x&bslash;n&quot;,interruptValue);
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ETHER_INT_SRC_IRQ_MSK
)paren
)paren
(brace
r_return
suffix:semicolon
multiline_comment|/* Interrupt wasn&squot;t caused by us!! */
)brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
(paren
id|ETHER_INT_SRC_INTMACRX_MSK
op_or
id|ETHER_INT_SRC_FDAEX_MSK
op_or
id|ETHER_INT_SRC_BLEX_MSK
)paren
)paren
(brace
r_struct
id|rx_blist_ent
op_star
id|blist_ent_ptr
suffix:semicolon
r_struct
id|rx_fda_ent
op_star
id|fda_ent_ptr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|fda_ent_ptr
op_assign
id|priv-&gt;rx_fda_ptr
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;rx_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|fda_ent_ptr
OL
(paren
id|priv-&gt;rx_fda_ptr
op_plus
id|RX_NUM_FDESC
)paren
)paren
(brace
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fda_ent_ptr-&gt;fd.FDCtl
op_amp
id|FDCTL_COWNSFD_MSK
)paren
)paren
(brace
multiline_comment|/* This frame is ready for processing */
multiline_comment|/*find the corresponding buffer in the bufferlist */
id|blist_ent_ptr
op_assign
id|priv-&gt;rx_blist_vp
op_plus
id|fda_ent_ptr-&gt;bd.BDStat
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|blist_ent_ptr-&gt;fd.FDSystem
suffix:semicolon
multiline_comment|/* Pass this skb up the stack */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|fda_ent_ptr-&gt;fd.FDLength
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
id|result
op_assign
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Update statistics */
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|fda_ent_ptr-&gt;fd.FDLength
suffix:semicolon
multiline_comment|/* Free the FDA entry */
id|fda_ent_ptr-&gt;bd.BDStat
op_assign
l_int|0xff
suffix:semicolon
id|fda_ent_ptr-&gt;fd.FDCtl
op_assign
id|FDCTL_COWNSFD_MSK
suffix:semicolon
multiline_comment|/* Allocate a new skb and point the bd entry to it */
id|blist_ent_ptr-&gt;fd.FDSystem
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
singleline_comment|//printk(&quot;allocskb=%#x&bslash;n&quot;,skb);
r_if
c_cond
(paren
id|skb
)paren
(brace
id|setup_blist_entry
c_func
(paren
id|skb
comma
id|blist_ent_ptr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;memupdate_scheduled
)paren
(brace
r_int
id|tmp
suffix:semicolon
multiline_comment|/* There are no buffers at the moment, so schedule */
multiline_comment|/* the background task to sort this out */
id|schedule_task
c_func
(paren
op_amp
id|priv-&gt;tq_memupdate
)paren
suffix:semicolon
id|priv-&gt;memupdate_scheduled
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:No buffers&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If this interrupt was due to a lack of buffers then&n;&t;&t;&t;&t;&t; * we&squot;d better stop the receiver too */
r_if
c_cond
(paren
id|interruptValue
op_amp
id|ETHER_INT_SRC_BLEX_MSK
)paren
(brace
id|priv-&gt;rx_disabled
op_assign
l_int|1
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_amp
op_complement
id|ETHER_RX_CTL_RXEN_MSK
comma
id|ETHER_RX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:Halting rx&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
id|fda_ent_ptr
op_increment
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;rx_lock
)paren
suffix:semicolon
multiline_comment|/* Clear the  interrupts */
id|writel
c_func
(paren
id|ETHER_INT_SRC_INTMACRX_MSK
op_or
id|ETHER_INT_SRC_FDAEX_MSK
op_or
id|ETHER_INT_SRC_BLEX_MSK
comma
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
id|ETHER_INT_SRC_INTMACTX_MSK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;memupdate_scheduled
)paren
(brace
id|schedule_task
c_func
(paren
op_amp
id|priv-&gt;tq_memupdate
)paren
suffix:semicolon
id|priv-&gt;memupdate_scheduled
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Clear the interrupt */
id|writel
c_func
(paren
id|ETHER_INT_SRC_INTMACTX_MSK
comma
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
(paren
id|ETHER_INT_SRC_SWINT_MSK
op_or
id|ETHER_INT_SRC_INTEARNOT_MSK
op_or
id|ETHER_INT_SRC_INTLINK_MSK
op_or
id|ETHER_INT_SRC_INTEXBD_MSK
op_or
id|ETHER_INT_SRC_INTTXCTLCMP_MSK
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Not using any of these so they shouldn&squot;t happen&n;&t;&t; *&n;&t;&t; *&t;In the cased of INTEXBD - if you allocate more&n;&t;&t; *      than 28 decsriptors you may need to think about this&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;Not using this interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|ETHER_INT_SRC
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
op_amp
(paren
id|ETHER_INT_SRC_INTSBUS_MSK
op_or
id|ETHER_INT_SRC_INTNRABT_MSK
op_or
id|ETHER_INT_SRC_DMPARERR_MSK
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Hardware errors, we can either ignore them and hope they go away&n;&t;&t; *or reset the device, I&squot;ll try the first for now to see if they happen&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;Hardware error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|ether00_setup_ethernet_address
r_static
r_void
id|ether00_setup_ethernet_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|6
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|ETHER_ARC_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|4
comma
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|ETHER_ARC_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|tmp
op_and_assign
l_int|0xffff
suffix:semicolon
id|tmp
op_or_assign
(paren
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|ETHER_ARC_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable this entry in the ARC */
id|writel
c_func
(paren
l_int|1
comma
id|ETHER_ARC_ENA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ether00_reset
r_static
r_void
id|ether00_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* reset the controller */
id|writew
c_func
(paren
id|ETHER_MAC_CTL_RESET_MSK
comma
id|ETHER_MAC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure we&squot;re not going to send anything&n;&t; */
id|writew
c_func
(paren
id|ETHER_TX_CTL_TXHALT_MSK
comma
id|ETHER_TX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure we&squot;re not going to receive anything&n;&t; */
id|writew
c_func
(paren
id|ETHER_RX_CTL_RXHALT_MSK
comma
id|ETHER_RX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Disable Interrupts for now, and set the burst size to 8 bytes&n;&t; */
id|writel
c_func
(paren
id|ETHER_DMA_CTL_INTMASK_MSK
op_or
(paren
(paren
l_int|8
op_lshift
id|ETHER_DMA_CTL_DMBURST_OFST
)paren
op_amp
id|ETHER_DMA_CTL_DMBURST_MSK
)paren
op_or
(paren
l_int|2
op_lshift
id|ETHER_DMA_CTL_RXALIGN_OFST
)paren
comma
id|ETHER_DMA_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set TxThrsh - start transmitting a packet after 1514&n;&t; * bytes or when a packet is complete, whichever comes first&n;&t; */
id|writew
c_func
(paren
l_int|1514
comma
id|ETHER_TXTHRSH
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set TxPollCtr.  Each cycle is&n;&t; * 61.44 microseconds with a 33 MHz bus&n;&t; */
id|writew
c_func
(paren
l_int|1
comma
id|ETHER_TXPOLLCTR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set Rx_Ctl - Turn off reception and let RxData turn it&n;&t; * on later&n;&t; */
id|writew
c_func
(paren
id|ETHER_RX_CTL_RXHALT_MSK
comma
id|ETHER_RX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|ether00_set_multicast
r_static
r_void
id|ether00_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|count
op_assign
id|dev-&gt;mc_count
suffix:semicolon
multiline_comment|/* Set promiscuous mode if it&squot;s asked for. */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|writew
c_func
(paren
id|ETHER_ARC_CTL_COMPEN_MSK
op_or
id|ETHER_ARC_CTL_BROADACC_MSK
op_or
id|ETHER_ARC_CTL_GROUPACC_MSK
op_or
id|ETHER_ARC_CTL_STATIONACC_MSK
comma
id|ETHER_ARC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get all multicast packets if required, or if there are too&n;&t; * many addresses to fit in hardware&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
id|writew
c_func
(paren
id|ETHER_ARC_CTL_COMPEN_MSK
op_or
id|ETHER_ARC_CTL_GROUPACC_MSK
op_or
id|ETHER_ARC_CTL_BROADACC_MSK
comma
id|ETHER_ARC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;mc_count
OG
(paren
id|ETHER_ARC_SIZE
op_minus
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Too many multicast addresses for hardware to filter - receiving all multicast packets&bslash;n&quot;
)paren
suffix:semicolon
id|writew
c_func
(paren
id|ETHER_ARC_CTL_COMPEN_MSK
op_or
id|ETHER_ARC_CTL_GROUPACC_MSK
op_or
id|ETHER_ARC_CTL_BROADACC_MSK
comma
id|ETHER_ARC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|mc_list_ent
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
r_int
id|temp
comma
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mc_count=%d mc_list=%#x&bslash;n&quot;
comma
id|dev
op_member_access_from_pointer
id|mc_count
comma
id|dev-&gt;mc_list
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mc addr=%02#x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|5
)braket
comma
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|4
)braket
comma
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|3
)braket
comma
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|2
)braket
comma
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|1
)braket
comma
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|0
)braket
)paren
suffix:semicolon
)paren
multiline_comment|/*&n;&t;&t; * The first 6 bytes are the MAC address, so&n;&t;&t; * don&squot;t change them!&n;&t;&t; */
id|writew
c_func
(paren
l_int|4
comma
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|temp
op_assign
id|readl
c_func
(paren
id|ETHER_ARC_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0xffff0000
suffix:semicolon
multiline_comment|/* Disable the current multicast stuff */
id|writel
c_func
(paren
l_int|1
comma
id|ETHER_ARC_ENA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|temp
op_or_assign
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|1
)braket
op_or
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|0
)braket
op_lshift
l_int|8
suffix:semicolon
id|writel
c_func
(paren
id|temp
comma
id|ETHER_ARC_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|i
op_assign
id|readl
c_func
(paren
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|i
op_plus
l_int|4
comma
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|temp
op_assign
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|5
)braket
op_or
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|4
)braket
op_lshift
l_int|8
op_or
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|3
)braket
op_lshift
l_int|16
op_or
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|2
)braket
op_lshift
l_int|24
suffix:semicolon
id|writel
c_func
(paren
id|temp
comma
id|ETHER_ARC_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mc_list_ent-&gt;next
op_logical_or
op_logical_neg
id|count
)paren
(brace
r_break
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mc_list_next=%#x&bslash;n&quot;
comma
id|mc_list_ent-&gt;next
)paren
suffix:semicolon
)paren
id|mc_list_ent
op_assign
id|mc_list_ent-&gt;next
suffix:semicolon
id|i
op_assign
id|readl
c_func
(paren
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i
op_plus
l_int|4
comma
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|temp
op_assign
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|3
)braket
op_or
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|2
)braket
op_lshift
l_int|8
op_or
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|1
)braket
op_lshift
l_int|16
op_or
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|0
)braket
op_lshift
l_int|24
suffix:semicolon
id|writel
c_func
(paren
id|temp
comma
id|ETHER_ARC_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|i
op_assign
id|readl
c_func
(paren
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i
op_plus
l_int|4
comma
id|ETHER_ARC_ADR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|temp
op_assign
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|4
)braket
op_lshift
l_int|16
op_or
id|mc_list_ent-&gt;dmi_addr
(braket
l_int|5
)braket
op_lshift
l_int|24
suffix:semicolon
id|writel
c_func
(paren
id|temp
comma
id|ETHER_ARC_DATA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mc_list_ent-&gt;next
op_logical_or
op_logical_neg
id|count
)paren
(brace
r_break
suffix:semicolon
)brace
id|mc_list_ent
op_assign
id|mc_list_ent-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Multicast list size error&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|writew
c_func
(paren
id|ETHER_ARC_CTL_BROADACC_MSK
op_or
id|ETHER_ARC_CTL_COMPEN_MSK
comma
id|ETHER_ARC_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* enable the active ARC enties */
id|writew
c_func
(paren
(paren
l_int|1
op_lshift
(paren
id|count
op_plus
l_int|2
)paren
)paren
op_minus
l_int|1
comma
id|ETHER_ARC_ENA
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|ether00_open
r_static
r_int
id|ether00_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|result
comma
id|tmp
suffix:semicolon
r_struct
id|net_priv
op_star
id|priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_valid_ether_addr
c_func
(paren
id|dev-&gt;dev_addr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Install interrupt handlers */
id|result
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ether00_int
comma
l_int|0
comma
l_string|&quot;ether00&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
r_goto
id|open_err1
suffix:semicolon
)brace
id|result
op_assign
id|request_irq
c_func
(paren
l_int|2
comma
id|ether00_phy_int
comma
l_int|0
comma
l_string|&quot;ether00_phy&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
r_goto
id|open_err2
suffix:semicolon
)brace
id|ether00_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|result
op_assign
id|ether00_mem_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
r_goto
id|open_err3
suffix:semicolon
)brace
id|ether00_setup_ethernet_address
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ether00_set_multicast
c_func
(paren
id|dev
)paren
suffix:semicolon
id|result
op_assign
id|ether00_write_phy
c_func
(paren
id|dev
comma
id|PHY_CONTROL
comma
id|PHY_CONTROL_ANEGEN_MSK
op_or
id|PHY_CONTROL_RANEG_MSK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
r_goto
id|open_err4
suffix:semicolon
)brace
id|result
op_assign
id|ether00_write_phy
c_func
(paren
id|dev
comma
id|PHY_IRQ_CONTROL
comma
id|PHY_IRQ_CONTROL_LS_CHG_IE_MSK
op_or
id|PHY_IRQ_CONTROL_ANEG_COMP_IE_MSK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
r_goto
id|open_err4
suffix:semicolon
)brace
multiline_comment|/* Start the device enable interrupts */
id|writew
c_func
(paren
id|ETHER_RX_CTL_RXEN_MSK
singleline_comment|//&t;       | ETHER_RX_CTL_STRIPCRC_MSK
op_or
id|ETHER_RX_CTL_ENGOOD_MSK
op_or
id|ETHER_RX_CTL_ENRXPAR_MSK
op_or
id|ETHER_RX_CTL_ENLONGERR_MSK
op_or
id|ETHER_RX_CTL_ENOVER_MSK
op_or
id|ETHER_RX_CTL_ENCRCERR_MSK
comma
id|ETHER_RX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
id|ETHER_TX_CTL_TXEN_MSK
op_or
id|ETHER_TX_CTL_ENEXDEFER_MSK
op_or
id|ETHER_TX_CTL_ENLCARR_MSK
op_or
id|ETHER_TX_CTL_ENEXCOLL_MSK
op_or
id|ETHER_TX_CTL_ENLATECOLL_MSK
op_or
id|ETHER_TX_CTL_ENTXPAR_MSK
op_or
id|ETHER_TX_CTL_ENCOMP_MSK
comma
id|ETHER_TX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|ETHER_DMA_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_amp
op_complement
id|ETHER_DMA_CTL_INTMASK_MSK
comma
id|ETHER_DMA_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|open_err4
suffix:colon
id|ether00_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|open_err3
suffix:colon
id|free_irq
c_func
(paren
l_int|2
comma
id|dev
)paren
suffix:semicolon
id|open_err2
suffix:colon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|open_err1
suffix:colon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ether00_tx
r_static
r_int
id|ether00_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|tx_fda_ent
op_star
id|fda_ptr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Find an empty slot in which to stick the frame&n;&t; */
id|fda_ptr
op_assign
(paren
r_struct
id|tx_fda_ent
op_star
)paren
id|__dma_va
c_func
(paren
id|readl
c_func
(paren
id|ETHER_TXFRMPTR
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|TX_NUM_FDESC
)paren
(brace
r_if
c_cond
(paren
id|fda_ptr-&gt;fd.FDStat
op_logical_or
(paren
id|fda_ptr-&gt;fd.FDCtl
op_amp
id|FDCTL_COWNSFD_MSK
)paren
)paren
(brace
id|fda_ptr
op_assign
(paren
r_struct
id|tx_fda_ent
op_star
)paren
id|__dma_va
c_func
(paren
(paren
r_struct
id|tx_fda_ent
op_star
)paren
id|fda_ptr-&gt;fd.FDNext
)paren
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
multiline_comment|/* Write the skb data from the cache*/
id|consistent_sync
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|fda_ptr-&gt;bd.BuffData
op_assign
(paren
r_char
op_star
)paren
id|__pa
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|fda_ptr-&gt;bd.BuffLength
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Save the pointer to the skb for freeing later */
id|fda_ptr-&gt;fd.FDSystem
op_assign
(paren
r_int
r_int
)paren
id|skb
suffix:semicolon
id|fda_ptr-&gt;fd.FDStat
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pass ownership of the buffers to the controller */
id|fda_ptr-&gt;fd.FDCtl
op_assign
l_int|1
suffix:semicolon
id|fda_ptr-&gt;fd.FDCtl
op_or_assign
id|FDCTL_COWNSFD_MSK
suffix:semicolon
multiline_comment|/* If the next buffer in the list is full, stop the queue */
id|fda_ptr
op_assign
(paren
r_struct
id|tx_fda_ent
op_star
)paren
id|__dma_va
c_func
(paren
id|fda_ptr-&gt;fd.FDNext
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fda_ptr-&gt;fd.FDStat
)paren
op_logical_or
(paren
id|fda_ptr-&gt;fd.FDCtl
op_amp
id|FDCTL_COWNSFD_MSK
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;queue_stopped
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether00_stats
r_static
r_struct
id|net_device_stats
op_star
id|ether00_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
DECL|function|ether00_stop
r_static
r_int
id|ether00_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|tmp
suffix:semicolon
multiline_comment|/* Stop/disable the device. */
id|tmp
op_assign
id|readw
c_func
(paren
id|ETHER_RX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|ETHER_RX_CTL_RXEN_MSK
op_or
id|ETHER_RX_CTL_ENGOOD_MSK
)paren
suffix:semicolon
id|tmp
op_or_assign
id|ETHER_RX_CTL_RXHALT_MSK
suffix:semicolon
id|writew
c_func
(paren
id|tmp
comma
id|ETHER_RX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|ETHER_TX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|ETHER_TX_CTL_TXEN_MSK
suffix:semicolon
id|tmp
op_or_assign
id|ETHER_TX_CTL_TXHALT_MSK
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|ETHER_TX_CTL
c_func
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Free up system resources */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
l_int|2
comma
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|priv-&gt;dma_data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether00_get_ethernet_address
r_static
r_void
id|ether00_get_ethernet_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mtd_info
op_star
id|mymtd
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|retlen
suffix:semicolon
multiline_comment|/*&n;&t; * For the Epxa10 dev board (camelot), the ethernet MAC&n;&t; * address is of the form  00:aa:aa:00:xx:xx where&n;&t; * 00:aa:aa is the Altera vendor ID and xx:xx is the&n;&t; * last 2 bytes of the board serial number, as programmed&n;&t; * into the OTP area of the flash device on EBI1. If this&n;&t; * isn&squot;t an expa10 dev board, or there&squot;s no mtd support to&n;&t; * read the serial number from flash then we&squot;ll force the&n;&t; * use to set their own mac address using ifconfig.&n;&t; */
macro_line|#ifdef CONFIG_ARCH_CAMELOT
macro_line|#ifdef CONFIG_MTD
multiline_comment|/* get the mtd_info structure for the first mtd device*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MTD_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mymtd
op_assign
id|get_mtd_device
c_func
(paren
l_int|NULL
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mymtd
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|mymtd-&gt;name
comma
l_string|&quot;EPXA10DB flash&quot;
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|mymtd
op_logical_or
op_logical_neg
id|mymtd-&gt;read_user_prot_reg
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Failed to read MAC address from flash&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|mymtd
op_member_access_from_pointer
id|read_user_prot_reg
c_func
(paren
id|mymtd
comma
l_int|2
comma
l_int|1
comma
op_amp
id|retlen
comma
op_amp
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|mymtd
op_member_access_from_pointer
id|read_user_prot_reg
c_func
(paren
id|mymtd
comma
l_int|3
comma
l_int|1
comma
op_amp
id|retlen
comma
op_amp
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
id|vendor_id
(braket
l_int|1
)braket
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
id|vendor_id
(braket
l_int|0
)braket
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: MTD support required to read MAC address from EPXA10 dev board&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|is_valid_ether_addr
c_func
(paren
id|dev-&gt;dev_addr
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Invalid ethernet MAC address.  Please set using &quot;
l_string|&quot;ifconfig&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Keep a mapping of dev_info addresses -&gt; port lines to use when&n; * removing ports dev==NULL indicates unused entry&n; */
DECL|variable|dev_list
r_static
r_struct
id|net_device
op_star
id|dev_list
(braket
id|ETH_NR
)braket
suffix:semicolon
DECL|function|ether00_add_device
r_static
r_int
id|ether00_add_device
c_func
(paren
r_struct
id|pldhs_dev_info
op_star
id|dev_info
comma
r_void
op_star
id|dev_ps_data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|net_priv
op_star
id|priv
suffix:semicolon
r_void
op_star
id|map_addr
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|dev_list
(braket
id|i
)braket
op_logical_and
id|i
OL
id|ETH_NR
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|ETH_NR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ether00: Maximum number of ports reached&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|dev_info-&gt;base_addr
comma
id|MAC_REG_SIZE
comma
l_string|&quot;ether00&quot;
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|net_priv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_release
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_priv
)paren
)paren
suffix:semicolon
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|priv-&gt;tq_memupdate.routine
op_assign
id|ether00_mem_update
suffix:semicolon
id|priv-&gt;tq_memupdate.data
op_assign
(paren
r_void
op_star
)paren
id|dev
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|priv-&gt;rx_lock
)paren
suffix:semicolon
id|map_addr
op_assign
id|ioremap_nocache
c_func
(paren
id|dev_info-&gt;base_addr
comma
id|SZ_4K
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|map_addr
)paren
(brace
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|out_kfree
suffix:semicolon
)brace
id|dev-&gt;open
op_assign
id|ether00_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ether00_stop
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|ether00_set_multicast
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ether00_tx
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ether00_stats
suffix:semicolon
id|ether00_get_ethernet_address
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|map_addr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|dev_info-&gt;irq
suffix:semicolon
id|dev-&gt;features
op_assign
id|NETIF_F_DYNALLOC
op_or
id|NETIF_F_HW_CSUM
suffix:semicolon
id|result
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Ether00: Error %i registering driver&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_goto
id|out_unmap
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;registered ether00 device at %#x&bslash;n&quot;
comma
id|dev_info-&gt;base_addr
)paren
suffix:semicolon
id|dev_list
(braket
id|i
)braket
op_assign
id|dev
suffix:semicolon
r_return
id|result
suffix:semicolon
id|out_unmap
suffix:colon
id|iounmap
c_func
(paren
id|map_addr
)paren
suffix:semicolon
id|out_kfree
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out_release
suffix:colon
id|release_mem_region
c_func
(paren
id|dev_info-&gt;base_addr
comma
id|MAC_REG_SIZE
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ether00_remove_devices
r_static
r_int
id|ether00_remove_devices
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_NR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_list
(braket
id|i
)braket
)paren
(brace
id|netif_device_detach
c_func
(paren
id|dev_list
(braket
id|i
)braket
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev_list
(braket
id|i
)braket
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|dev_list
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|dev_list
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
comma
id|MAC_REG_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_list
(braket
id|i
)braket
)paren
suffix:semicolon
id|dev_list
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ether00_pldhs_ops
r_static
r_struct
id|pld_hotswap_ops
id|ether00_pldhs_ops
op_assign
initialization_block
suffix:semicolon
DECL|function|ether00_cleanup_module
r_static
r_void
id|__exit
id|ether00_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|result
op_assign
id|ether00_remove_devices
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ether00: failed to remove all devices&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pldhs_unregister_driver
c_func
(paren
id|ETHER00_NAME
)paren
suffix:semicolon
)brace
DECL|variable|ether00_cleanup_module
id|module_exit
c_func
(paren
id|ether00_cleanup_module
)paren
suffix:semicolon
DECL|function|ether00_mod_init
r_static
r_int
id|__init
id|ether00_mod_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mod init&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pldhs_register_driver
c_func
(paren
op_amp
id|ether00_pldhs_ops
)paren
suffix:semicolon
)brace
DECL|variable|ether00_mod_init
id|module_init
c_func
(paren
id|ether00_mod_init
)paren
suffix:semicolon
eof
