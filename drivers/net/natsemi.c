multiline_comment|/* natsemi.c: A Linux PCI Ethernet driver for the NatSemi DP8381x series. */
multiline_comment|/*&n;&t;Written/copyright 1999-2001 by Donald Becker.&n;&t;Portions copyright (c) 2001 Sun Microsystems (thockin@sun.com)&n;&n;&t;This software may be used and distributed according to the terms of&n;&t;the GNU General Public License (GPL), incorporated herein by reference.&n;&t;Drivers based on or derived from this code fall under the GPL and must&n;&t;retain the authorship, copyright and license notice.  This file is not&n;&t;a complete program and may only be used when the entire operating&n;&t;system is licensed under the GPL.  License for under other terms may be&n;&t;available.  Contact the original author for details.&n;&n;&t;The original author may be reached as becker@scyld.com, or at&n;&t;Scyld Computing Corporation&n;&t;410 Severn Ave., Suite 210&n;&t;Annapolis MD 21403&n;&n;&t;Support information and updates available at&n;&t;http://www.scyld.com/network/netsemi.html&n;&n;&n;&t;Linux kernel modifications:&n;&n;&t;Version 1.0.1:&n;&t;&t;- Spinlock fixes&n;&t;&t;- Bug fixes and better intr performance (Tjeerd)&n;&t;Version 1.0.2:&n;&t;&t;- Now reads correct MAC address from eeprom&n;&t;Version 1.0.3:&n;&t;&t;- Eliminate redundant priv-&gt;tx_full flag&n;&t;&t;- Call netif_start_queue from dev-&gt;tx_timeout&n;&t;&t;- wmb() in start_tx() to flush data&n;&t;&t;- Update Tx locking&n;&t;&t;- Clean up PCI enable (davej)&n;&t;Version 1.0.4:&n;&t;&t;- Merge Donald Becker&squot;s natsemi.c version 1.07&n;&t;Version 1.0.5:&n;&t;&t;- { fill me in }&n;&t;Version 1.0.6:&n;&t;&t;* ethtool support (jgarzik)&n;&t;&t;* Proper initialization of the card (which sometimes&n;&t;&t;fails to occur and leaves the card in a non-functional&n;&t;&t;state). (uzi)&n;&n;&t;&t;* Some documented register settings to optimize some&n;&t;&t;of the 100Mbit autodetection circuitry in rev C cards. (uzi)&n;&n;&t;&t;* Polling of the PHY intr for stuff like link state&n;&t;&t;change and auto- negotiation to finally work properly. (uzi)&n;&n;&t;&t;* One-liner removal of a duplicate declaration of&n;&t;&t;netdev_error(). (uzi)&n;&n;&t;Version 1.0.7: (Manfred Spraul)&n;&t;&t;* pci dma&n;&t;&t;* SMP locking update&n;&t;&t;* full reset added into tx_timeout&n;&t;&t;* correct multicast hash generation (both big and little endian)&n;&t;&t;&t;[copied from a natsemi driver version&n;&t;&t;&t; from Myrio Corporation, Greg Smith]&n;&t;&t;* suspend/resume&n;&n;&t;version 1.0.8 (Tim Hockin &lt;thockin@sun.com&gt;)&n;&t;&t;* ETHTOOL_* support&n;&t;&t;* Wake on lan support (Erik Gilling)&n;&t;&t;* MXDMA fixes for serverworks&n;&t;&t;* EEPROM reload&n;&n;&t;version 1.0.9 (Manfred Spraul)&n;&t;&t;* Main change: fix lack of synchronize&n;&t;&t;netif_close/netif_suspend against a last interrupt&n;&t;&t;or packet.&n;&t;&t;* do not enable superflous interrupts (e.g. the&n;&t;&t;drivers relies on TxDone - TxIntr not needed)&n;&t;&t;* wait that the hardware has really stopped in close&n;&t;&t;and suspend.&n;&t;&t;* workaround for the (at least) gcc-2.95.1 compiler&n;&t;&t;problem. Also simplifies the code a bit.&n;&t;&t;* disable_irq() in tx_timeout - needed to protect&n;&t;&t;against rx interrupts.&n;&t;&t;* stop the nic before switching into silent rx mode&n;&t;&t;for wol (required according to docu).&n;&n;&t;version 1.0.10:&n;&t;&t;* use long for ee_addr (various)&n;&t;&t;* print pointers properly (DaveM)&n;&t;&t;* include asm/irq.h (?)&n;&t;&n;&t;version 1.0.11:&n;&t;&t;* check and reset if PHY errors appear (Adrian Sun)&n;&t;&t;* WoL cleanup (Tim Hockin)&n;&t;&t;* Magic number cleanup (Tim Hockin)&n;&t;&t;* Don&squot;t reload EEPROM on every reset (Tim Hockin)&n;&t;&t;* Save and restore EEPROM state across reset (Tim Hockin)&n;&t;&t;* MDIO Cleanup (Tim Hockin)&n;&t;&t;* Reformat register offsets/bits (jgarzik)&n;&n;&t;version 1.0.12:&n;&t;&t;* ETHTOOL_* further support (Tim Hockin)&n;&n;&t;version 1.0.13:&n;&t;&t;* ETHTOOL_[G]EEPROM support (Tim Hockin)&n;&n;&t;version 1.0.13:&n;&t;&t;* crc cleanup (Matt Domsch &lt;Matt_Domsch@dell.com&gt;)&n;&n;&t;version 1.0.14:&n;&t;&t;* Cleanup some messages and autoneg in ethtool (Tim Hockin)&n;&n;&t;version 1.0.15:&n;&t;&t;* Get rid of cable_magic flag&n;&t;&t;* use new (National provided) solution for cable magic issue&n;&n;&t;version 1.0.16:&n;&t;&t;* call netdev_rx() for RxErrors (Manfred Spraul)&n;&t;&t;* formatting and cleanups&n;&t;&t;* change options and full_duplex arrays to be zero&n;&t;&t;  initialized&n;&t;&t;* enable only the WoL and PHY interrupts in wol mode&n;&n;&t;version 1.0.17: (Tim Hockin)&n;&t;&t;* Only do cable_magic on 83815 and early 83816&n;&n;&t;TODO:&n;&t;* big endian support with CFG:BEM instead of cpu_to_le32&n;&t;* support for an external PHY&n;&t;* flow control&n;*/
macro_line|#if !defined(__OPTIMIZE__)
macro_line|#warning  You must compile this file with the correct options!
macro_line|#warning  See the last lines of the source file.
macro_line|#error You must compile this driver with &quot;-O&quot;.
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;asm/processor.h&gt;&t;/* Processor type for cache alignment. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;natsemi&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;1.07+LK1.0.17&quot;
DECL|macro|DRV_RELDATE
mdefine_line|#define DRV_RELDATE&t;&quot;Sep 23, 2002&quot;
multiline_comment|/* Updated to recommendations in pci-skeleton v2.03. */
multiline_comment|/* Automatically extracted configuration info:&n;probe-func: natsemi_probe&n;config-in: tristate &squot;National Semiconductor DP8381x series PCI Ethernet support&squot; CONFIG_NATSEMI&n;&n;c-help-name: National Semiconductor DP8381x series PCI Ethernet support&n;c-help-symbol: CONFIG_NATSEMI&n;c-help: This driver is for the National Semiconductor DP8381x series,&n;c-help: including the 8381[56] chips.&n;c-help: More specific information and updates are available from &n;c-help: http://www.scyld.com/network/natsemi.html&n;*/
multiline_comment|/* The user-configurable values.&n;   These may be modified when a driver module is loaded.*/
DECL|macro|NATSEMI_DEF_MSG
mdefine_line|#define NATSEMI_DEF_MSG&t;&t;(NETIF_MSG_DRV&t;&t;| &bslash;&n;&t;&t;&t;&t; NETIF_MSG_LINK&t;&t;| &bslash;&n;&t;&t;&t;&t; NETIF_MSG_WOL&t;&t;| &bslash;&n;&t;&t;&t;&t; NETIF_MSG_RX_ERR&t;| &bslash;&n;&t;&t;&t;&t; NETIF_MSG_TX_ERR)
DECL|variable|debug
r_static
r_int
id|debug
op_assign
id|NATSEMI_DEF_MSG
suffix:semicolon
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
DECL|variable|mtu
r_static
r_int
id|mtu
suffix:semicolon
multiline_comment|/* Maximum number of multicast addresses to filter (vs. rx-all-multicast).&n;   This chip uses a 512 element hash table based on the Ethernet CRC.  */
DECL|variable|multicast_filter_limit
r_static
r_int
id|multicast_filter_limit
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-frames scheme.&n;   Setting to &gt; 1518 effectively disables this feature. */
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
suffix:semicolon
multiline_comment|/* Used to pass the media type, etc.&n;   Both &squot;options[]&squot; and &squot;full_duplex[]&squot; should exist for driver&n;   interoperability.&n;   The media type is usually passed in &squot;options[]&squot;.&n;*/
DECL|macro|MAX_UNITS
mdefine_line|#define MAX_UNITS 8&t;&t;/* More are supported, limit only on options */
DECL|variable|options
r_static
r_int
id|options
(braket
id|MAX_UNITS
)braket
suffix:semicolon
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
(braket
id|MAX_UNITS
)braket
suffix:semicolon
multiline_comment|/* Operational parameters that are set at compile time. */
multiline_comment|/* Keep the ring sizes a power of two for compile efficiency.&n;   The compiler will convert &lt;unsigned&gt;&squot;%&squot;&lt;2^N&gt; into a bit mask.&n;   Making the Tx ring too large decreases the effectiveness of channel&n;   bonding and packet priority.&n;   There are no ill effects from too-large receive rings. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;16
DECL|macro|TX_QUEUE_LEN
mdefine_line|#define TX_QUEUE_LEN&t;10 /* Limit ring entries actually used, min 4. */
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;32
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  (2*HZ)
DECL|macro|NATSEMI_HW_TIMEOUT
mdefine_line|#define NATSEMI_HW_TIMEOUT&t;400
DECL|macro|NATSEMI_TIMER_FREQ
mdefine_line|#define NATSEMI_TIMER_FREQ&t;3*HZ
DECL|macro|NATSEMI_PG0_NREGS
mdefine_line|#define NATSEMI_PG0_NREGS&t;64
DECL|macro|NATSEMI_RFDR_NREGS
mdefine_line|#define NATSEMI_RFDR_NREGS&t;8
DECL|macro|NATSEMI_PG1_NREGS
mdefine_line|#define NATSEMI_PG1_NREGS&t;4
DECL|macro|NATSEMI_NREGS
mdefine_line|#define NATSEMI_NREGS&t;&t;(NATSEMI_PG0_NREGS + NATSEMI_RFDR_NREGS + &bslash;&n;&t;&t;&t;&t; NATSEMI_PG1_NREGS)
DECL|macro|NATSEMI_REGS_VER
mdefine_line|#define NATSEMI_REGS_VER&t;1 /* v1 added RFDR registers */
DECL|macro|NATSEMI_REGS_SIZE
mdefine_line|#define NATSEMI_REGS_SIZE&t;(NATSEMI_NREGS * sizeof(u32))
DECL|macro|NATSEMI_EEPROM_SIZE
mdefine_line|#define NATSEMI_EEPROM_SIZE&t;24 /* 12 16-bit values */
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536 /* Size of each temporary Rx buffer. */
multiline_comment|/* These identify the driver base version and may not be removed. */
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
id|KERN_INFO
id|DRV_NAME
l_string|&quot;.c:v1.07 1/9/2001  Written by Donald Becker &lt;becker@scyld.com&gt;&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  http://www.scyld.com/network/natsemi.html&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  (unofficial 2.4.x kernel port, version &quot;
id|DRV_VERSION
l_string|&quot;, &quot;
id|DRV_RELDATE
l_string|&quot;  Jeff Garzik, Tjeerd Mulder)&bslash;n&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@scyld.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;National Semiconductor DP8381x series PCI Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mtu
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;DP8381x maximum events handled per interrupt&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mtu
comma
l_string|&quot;DP8381x MTU (all boards)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;DP8381x default debug bitmask&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;DP8381x copy breakpoint for copy-only-tiny-frames&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|options
comma
l_string|&quot;DP8381x: Bits 0-3: media type, bit 17: full duplex&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|full_duplex
comma
l_string|&quot;DP8381x full duplex setting(s) (1)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This driver is designed for National Semiconductor DP83815 PCI Ethernet NIC.&n;It also works with other chips in in the DP83810 series.&n;&n;II. Board-specific settings&n;&n;This driver requires the PCI interrupt line to be valid.&n;It honors the EEPROM-set values. &n;&n;III. Driver operation&n;&n;IIIa. Ring buffers&n;&n;This driver uses two statically allocated fixed-size descriptor lists&n;formed into rings by a branch from the final descriptor to the beginning of&n;the list.  The ring sizes are set at compile time by RX/TX_RING_SIZE.&n;The NatSemi design uses a &squot;next descriptor&squot; pointer that the driver forms&n;into a list. &n;&n;IIIb/c. Transmit/Receive Structure&n;&n;This driver uses a zero-copy receive and transmit scheme.&n;The driver allocates full frame size skbuffs for the Rx ring buffers at&n;open() time and passes the skb-&gt;data field to the chip as receive data&n;buffers.  When an incoming frame is less than RX_COPYBREAK bytes long,&n;a fresh skbuff is allocated and the frame is copied to the new skbuff.&n;When the incoming frame is larger, the skbuff is passed directly up the&n;protocol stack.  Buffers consumed this way are replaced by newly allocated&n;skbuffs in a later phase of receives.&n;&n;The RX_COPYBREAK value is chosen to trade-off the memory wasted by&n;using a full-sized skbuff for small frames vs. the copying costs of larger&n;frames.  New boards are typically used in generously configured machines&n;and the underfilled buffers have negligible impact compared to the benefit of&n;a single allocation size, so the default value of zero results in never&n;copying packets.  When copying is done, the cost is usually mitigated by using&n;a combined copy/checksum routine.  Copying also preloads the cache, which is&n;most useful with small frames.&n;&n;A subtle aspect of the operation is that unaligned buffers are not permitted&n;by the hardware.  Thus the IP header at offset 14 in an ethernet frame isn&squot;t&n;longword aligned for further processing.  On copies frames are put into the&n;skbuff at an offset of &quot;+2&quot;, 16-byte aligning the IP header.&n;&n;IIId. Synchronization&n;&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and interrupt handling software.&n;&n;The send packet thread has partial control over the Tx ring and &squot;dev-&gt;tbusy&squot;&n;flag.  It sets the tbusy flag whenever it&squot;s queuing a Tx packet. If the next&n;queue slot is empty, it clears the tbusy flag when finished otherwise it sets&n;the &squot;lp-&gt;tx_full&squot; flag.&n;&n;The interrupt handler has exclusive control over the Rx ring and records stats&n;from the Tx ring.  After reaping the stats, it marks the Tx queue entry as&n;empty by incrementing the dirty_tx mark. Iff the &squot;lp-&gt;tx_full&squot; flag is set, it&n;clears both the tx_full and tbusy flags.&n;&n;IV. Notes&n;&n;NatSemi PCI network controllers are very uncommon.&n;&n;IVb. References&n;&n;http://www.scyld.com/expert/100mbps.html&n;http://www.scyld.com/expert/NWay.html&n;Datasheet is available from:&n;http://www.national.com/pf/DP/DP83815.html&n;&n;IVc. Errata&n;&n;None characterised.&n;*/
"&f;"
DECL|enum|pcistuff
r_enum
id|pcistuff
(brace
DECL|enumerator|PCI_USES_IO
id|PCI_USES_IO
op_assign
l_int|0x01
comma
DECL|enumerator|PCI_USES_MEM
id|PCI_USES_MEM
op_assign
l_int|0x02
comma
DECL|enumerator|PCI_USES_MASTER
id|PCI_USES_MASTER
op_assign
l_int|0x04
comma
DECL|enumerator|PCI_ADDR0
id|PCI_ADDR0
op_assign
l_int|0x08
comma
DECL|enumerator|PCI_ADDR1
id|PCI_ADDR1
op_assign
l_int|0x10
comma
)brace
suffix:semicolon
multiline_comment|/* MMIO operations required */
DECL|macro|PCI_IOTYPE
mdefine_line|#define PCI_IOTYPE (PCI_USES_MASTER | PCI_USES_MEM | PCI_ADDR1)
multiline_comment|/* array of board data directly indexed by pci_tbl[x].driver_data */
r_static
r_struct
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|variable|__devinitdata
)brace
id|natsemi_pci_info
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;NatSemi DP8381[56]&quot;
comma
id|PCI_IOTYPE
)brace
comma
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|natsemi_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_NS
comma
id|PCI_DEVICE_ID_NS_83815
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|natsemi_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* Offsets to the device registers.&n;   Unlike software-only systems, device drivers interact with complex hardware.&n;   It&squot;s not useful to define symbolic names for every register bit in the&n;   device.&n;*/
DECL|enum|register_offsets
r_enum
id|register_offsets
(brace
DECL|enumerator|ChipCmd
id|ChipCmd
op_assign
l_int|0x00
comma
DECL|enumerator|ChipConfig
id|ChipConfig
op_assign
l_int|0x04
comma
DECL|enumerator|EECtrl
id|EECtrl
op_assign
l_int|0x08
comma
DECL|enumerator|PCIBusCfg
id|PCIBusCfg
op_assign
l_int|0x0C
comma
DECL|enumerator|IntrStatus
id|IntrStatus
op_assign
l_int|0x10
comma
DECL|enumerator|IntrMask
id|IntrMask
op_assign
l_int|0x14
comma
DECL|enumerator|IntrEnable
id|IntrEnable
op_assign
l_int|0x18
comma
DECL|enumerator|IntrHoldoff
id|IntrHoldoff
op_assign
l_int|0x16
comma
multiline_comment|/* DP83816 only */
DECL|enumerator|TxRingPtr
id|TxRingPtr
op_assign
l_int|0x20
comma
DECL|enumerator|TxConfig
id|TxConfig
op_assign
l_int|0x24
comma
DECL|enumerator|RxRingPtr
id|RxRingPtr
op_assign
l_int|0x30
comma
DECL|enumerator|RxConfig
id|RxConfig
op_assign
l_int|0x34
comma
DECL|enumerator|ClkRun
id|ClkRun
op_assign
l_int|0x3C
comma
DECL|enumerator|WOLCmd
id|WOLCmd
op_assign
l_int|0x40
comma
DECL|enumerator|PauseCmd
id|PauseCmd
op_assign
l_int|0x44
comma
DECL|enumerator|RxFilterAddr
id|RxFilterAddr
op_assign
l_int|0x48
comma
DECL|enumerator|RxFilterData
id|RxFilterData
op_assign
l_int|0x4C
comma
DECL|enumerator|BootRomAddr
id|BootRomAddr
op_assign
l_int|0x50
comma
DECL|enumerator|BootRomData
id|BootRomData
op_assign
l_int|0x54
comma
DECL|enumerator|SiliconRev
id|SiliconRev
op_assign
l_int|0x58
comma
DECL|enumerator|StatsCtrl
id|StatsCtrl
op_assign
l_int|0x5C
comma
DECL|enumerator|StatsData
id|StatsData
op_assign
l_int|0x60
comma
DECL|enumerator|RxPktErrs
id|RxPktErrs
op_assign
l_int|0x60
comma
DECL|enumerator|RxMissed
id|RxMissed
op_assign
l_int|0x68
comma
DECL|enumerator|RxCRCErrs
id|RxCRCErrs
op_assign
l_int|0x64
comma
DECL|enumerator|BasicControl
id|BasicControl
op_assign
l_int|0x80
comma
DECL|enumerator|BasicStatus
id|BasicStatus
op_assign
l_int|0x84
comma
DECL|enumerator|AnegAdv
id|AnegAdv
op_assign
l_int|0x90
comma
DECL|enumerator|AnegPeer
id|AnegPeer
op_assign
l_int|0x94
comma
DECL|enumerator|PhyStatus
id|PhyStatus
op_assign
l_int|0xC0
comma
DECL|enumerator|MIntrCtrl
id|MIntrCtrl
op_assign
l_int|0xC4
comma
DECL|enumerator|MIntrStatus
id|MIntrStatus
op_assign
l_int|0xC8
comma
DECL|enumerator|PhyCtrl
id|PhyCtrl
op_assign
l_int|0xE4
comma
multiline_comment|/* These are from the spec, around page 78... on a separate table.&n;&t; * The meaning of these registers depend on the value of PGSEL. */
DECL|enumerator|PGSEL
id|PGSEL
op_assign
l_int|0xCC
comma
DECL|enumerator|PMDCSR
id|PMDCSR
op_assign
l_int|0xE4
comma
DECL|enumerator|TSTDAT
id|TSTDAT
op_assign
l_int|0xFC
comma
DECL|enumerator|DSPCFG
id|DSPCFG
op_assign
l_int|0xF4
comma
DECL|enumerator|SDCFG
id|SDCFG
op_assign
l_int|0xF8
)brace
suffix:semicolon
multiline_comment|/* the values for the &squot;magic&squot; registers above (PGSEL=1) */
DECL|macro|PMDCSR_VAL
mdefine_line|#define PMDCSR_VAL&t;0x189c&t;/* enable preferred adaptation circuitry */
DECL|macro|TSTDAT_VAL
mdefine_line|#define TSTDAT_VAL&t;0x0
DECL|macro|DSPCFG_VAL
mdefine_line|#define DSPCFG_VAL&t;0x5040
DECL|macro|SDCFG_VAL
mdefine_line|#define SDCFG_VAL&t;0x008c&t;/* set voltage thresholds for Signal Detect */
DECL|macro|DSPCFG_LOCK
mdefine_line|#define DSPCFG_LOCK&t;0x20&t;/* coefficient lock bit in DSPCFG */
DECL|macro|TSTDAT_FIXED
mdefine_line|#define TSTDAT_FIXED&t;0xe8&t;/* magic number for bad coefficients */
multiline_comment|/* misc PCI space registers */
DECL|enum|pci_register_offsets
r_enum
id|pci_register_offsets
(brace
DECL|enumerator|PCIPM
id|PCIPM
op_assign
l_int|0x44
comma
)brace
suffix:semicolon
DECL|enum|ChipCmd_bits
r_enum
id|ChipCmd_bits
(brace
DECL|enumerator|ChipReset
id|ChipReset
op_assign
l_int|0x100
comma
DECL|enumerator|RxReset
id|RxReset
op_assign
l_int|0x20
comma
DECL|enumerator|TxReset
id|TxReset
op_assign
l_int|0x10
comma
DECL|enumerator|RxOff
id|RxOff
op_assign
l_int|0x08
comma
DECL|enumerator|RxOn
id|RxOn
op_assign
l_int|0x04
comma
DECL|enumerator|TxOff
id|TxOff
op_assign
l_int|0x02
comma
DECL|enumerator|TxOn
id|TxOn
op_assign
l_int|0x01
comma
)brace
suffix:semicolon
DECL|enum|ChipConfig_bits
r_enum
id|ChipConfig_bits
(brace
DECL|enumerator|CfgPhyDis
id|CfgPhyDis
op_assign
l_int|0x200
comma
DECL|enumerator|CfgPhyRst
id|CfgPhyRst
op_assign
l_int|0x400
comma
DECL|enumerator|CfgExtPhy
id|CfgExtPhy
op_assign
l_int|0x1000
comma
DECL|enumerator|CfgAnegEnable
id|CfgAnegEnable
op_assign
l_int|0x2000
comma
DECL|enumerator|CfgAneg100
id|CfgAneg100
op_assign
l_int|0x4000
comma
DECL|enumerator|CfgAnegFull
id|CfgAnegFull
op_assign
l_int|0x8000
comma
DECL|enumerator|CfgAnegDone
id|CfgAnegDone
op_assign
l_int|0x8000000
comma
DECL|enumerator|CfgFullDuplex
id|CfgFullDuplex
op_assign
l_int|0x20000000
comma
DECL|enumerator|CfgSpeed100
id|CfgSpeed100
op_assign
l_int|0x40000000
comma
DECL|enumerator|CfgLink
id|CfgLink
op_assign
l_int|0x80000000
comma
)brace
suffix:semicolon
DECL|enum|EECtrl_bits
r_enum
id|EECtrl_bits
(brace
DECL|enumerator|EE_ShiftClk
id|EE_ShiftClk
op_assign
l_int|0x04
comma
DECL|enumerator|EE_DataIn
id|EE_DataIn
op_assign
l_int|0x01
comma
DECL|enumerator|EE_ChipSelect
id|EE_ChipSelect
op_assign
l_int|0x08
comma
DECL|enumerator|EE_DataOut
id|EE_DataOut
op_assign
l_int|0x02
comma
)brace
suffix:semicolon
DECL|enum|PCIBusCfg_bits
r_enum
id|PCIBusCfg_bits
(brace
DECL|enumerator|EepromReload
id|EepromReload
op_assign
l_int|0x4
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in the interrupt status/mask registers. */
DECL|enum|IntrStatus_bits
r_enum
id|IntrStatus_bits
(brace
DECL|enumerator|IntrRxDone
id|IntrRxDone
op_assign
l_int|0x0001
comma
DECL|enumerator|IntrRxIntr
id|IntrRxIntr
op_assign
l_int|0x0002
comma
DECL|enumerator|IntrRxErr
id|IntrRxErr
op_assign
l_int|0x0004
comma
DECL|enumerator|IntrRxEarly
id|IntrRxEarly
op_assign
l_int|0x0008
comma
DECL|enumerator|IntrRxIdle
id|IntrRxIdle
op_assign
l_int|0x0010
comma
DECL|enumerator|IntrRxOverrun
id|IntrRxOverrun
op_assign
l_int|0x0020
comma
DECL|enumerator|IntrTxDone
id|IntrTxDone
op_assign
l_int|0x0040
comma
DECL|enumerator|IntrTxIntr
id|IntrTxIntr
op_assign
l_int|0x0080
comma
DECL|enumerator|IntrTxErr
id|IntrTxErr
op_assign
l_int|0x0100
comma
DECL|enumerator|IntrTxIdle
id|IntrTxIdle
op_assign
l_int|0x0200
comma
DECL|enumerator|IntrTxUnderrun
id|IntrTxUnderrun
op_assign
l_int|0x0400
comma
DECL|enumerator|StatsMax
id|StatsMax
op_assign
l_int|0x0800
comma
DECL|enumerator|SWInt
id|SWInt
op_assign
l_int|0x1000
comma
DECL|enumerator|WOLPkt
id|WOLPkt
op_assign
l_int|0x2000
comma
DECL|enumerator|LinkChange
id|LinkChange
op_assign
l_int|0x4000
comma
DECL|enumerator|IntrHighBits
id|IntrHighBits
op_assign
l_int|0x8000
comma
DECL|enumerator|RxStatusFIFOOver
id|RxStatusFIFOOver
op_assign
l_int|0x10000
comma
DECL|enumerator|IntrPCIErr
id|IntrPCIErr
op_assign
l_int|0xf00000
comma
DECL|enumerator|RxResetDone
id|RxResetDone
op_assign
l_int|0x1000000
comma
DECL|enumerator|TxResetDone
id|TxResetDone
op_assign
l_int|0x2000000
comma
DECL|enumerator|IntrAbnormalSummary
id|IntrAbnormalSummary
op_assign
l_int|0xCD20
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Default Interrupts:&n; * Rx OK, Rx Packet Error, Rx Overrun, &n; * Tx OK, Tx Packet Error, Tx Underrun, &n; * MIB Service, Phy Interrupt, High Bits,&n; * Rx Status FIFO overrun,&n; * Received Target Abort, Received Master Abort, &n; * Signalled System Error, Received Parity Error&n; */
DECL|macro|DEFAULT_INTR
mdefine_line|#define DEFAULT_INTR 0x00f1cd65
DECL|enum|TxConfig_bits
r_enum
id|TxConfig_bits
(brace
DECL|enumerator|TxDrthMask
id|TxDrthMask
op_assign
l_int|0x3f
comma
DECL|enumerator|TxFlthMask
id|TxFlthMask
op_assign
l_int|0x3f00
comma
DECL|enumerator|TxMxdmaMask
id|TxMxdmaMask
op_assign
l_int|0x700000
comma
DECL|enumerator|TxMxdma_512
id|TxMxdma_512
op_assign
l_int|0x0
comma
DECL|enumerator|TxMxdma_4
id|TxMxdma_4
op_assign
l_int|0x100000
comma
DECL|enumerator|TxMxdma_8
id|TxMxdma_8
op_assign
l_int|0x200000
comma
DECL|enumerator|TxMxdma_16
id|TxMxdma_16
op_assign
l_int|0x300000
comma
DECL|enumerator|TxMxdma_32
id|TxMxdma_32
op_assign
l_int|0x400000
comma
DECL|enumerator|TxMxdma_64
id|TxMxdma_64
op_assign
l_int|0x500000
comma
DECL|enumerator|TxMxdma_128
id|TxMxdma_128
op_assign
l_int|0x600000
comma
DECL|enumerator|TxMxdma_256
id|TxMxdma_256
op_assign
l_int|0x700000
comma
DECL|enumerator|TxCollRetry
id|TxCollRetry
op_assign
l_int|0x800000
comma
DECL|enumerator|TxAutoPad
id|TxAutoPad
op_assign
l_int|0x10000000
comma
DECL|enumerator|TxMacLoop
id|TxMacLoop
op_assign
l_int|0x20000000
comma
DECL|enumerator|TxHeartIgn
id|TxHeartIgn
op_assign
l_int|0x40000000
comma
DECL|enumerator|TxCarrierIgn
id|TxCarrierIgn
op_assign
l_int|0x80000000
)brace
suffix:semicolon
DECL|enum|RxConfig_bits
r_enum
id|RxConfig_bits
(brace
DECL|enumerator|RxDrthMask
id|RxDrthMask
op_assign
l_int|0x3e
comma
DECL|enumerator|RxMxdmaMask
id|RxMxdmaMask
op_assign
l_int|0x700000
comma
DECL|enumerator|RxMxdma_512
id|RxMxdma_512
op_assign
l_int|0x0
comma
DECL|enumerator|RxMxdma_4
id|RxMxdma_4
op_assign
l_int|0x100000
comma
DECL|enumerator|RxMxdma_8
id|RxMxdma_8
op_assign
l_int|0x200000
comma
DECL|enumerator|RxMxdma_16
id|RxMxdma_16
op_assign
l_int|0x300000
comma
DECL|enumerator|RxMxdma_32
id|RxMxdma_32
op_assign
l_int|0x400000
comma
DECL|enumerator|RxMxdma_64
id|RxMxdma_64
op_assign
l_int|0x500000
comma
DECL|enumerator|RxMxdma_128
id|RxMxdma_128
op_assign
l_int|0x600000
comma
DECL|enumerator|RxMxdma_256
id|RxMxdma_256
op_assign
l_int|0x700000
comma
DECL|enumerator|RxAcceptLong
id|RxAcceptLong
op_assign
l_int|0x8000000
comma
DECL|enumerator|RxAcceptTx
id|RxAcceptTx
op_assign
l_int|0x10000000
comma
DECL|enumerator|RxAcceptRunt
id|RxAcceptRunt
op_assign
l_int|0x40000000
comma
DECL|enumerator|RxAcceptErr
id|RxAcceptErr
op_assign
l_int|0x80000000
)brace
suffix:semicolon
DECL|enum|ClkRun_bits
r_enum
id|ClkRun_bits
(brace
DECL|enumerator|PMEEnable
id|PMEEnable
op_assign
l_int|0x100
comma
DECL|enumerator|PMEStatus
id|PMEStatus
op_assign
l_int|0x8000
comma
)brace
suffix:semicolon
DECL|enum|WolCmd_bits
r_enum
id|WolCmd_bits
(brace
DECL|enumerator|WakePhy
id|WakePhy
op_assign
l_int|0x1
comma
DECL|enumerator|WakeUnicast
id|WakeUnicast
op_assign
l_int|0x2
comma
DECL|enumerator|WakeMulticast
id|WakeMulticast
op_assign
l_int|0x4
comma
DECL|enumerator|WakeBroadcast
id|WakeBroadcast
op_assign
l_int|0x8
comma
DECL|enumerator|WakeArp
id|WakeArp
op_assign
l_int|0x10
comma
DECL|enumerator|WakePMatch0
id|WakePMatch0
op_assign
l_int|0x20
comma
DECL|enumerator|WakePMatch1
id|WakePMatch1
op_assign
l_int|0x40
comma
DECL|enumerator|WakePMatch2
id|WakePMatch2
op_assign
l_int|0x80
comma
DECL|enumerator|WakePMatch3
id|WakePMatch3
op_assign
l_int|0x100
comma
DECL|enumerator|WakeMagic
id|WakeMagic
op_assign
l_int|0x200
comma
DECL|enumerator|WakeMagicSecure
id|WakeMagicSecure
op_assign
l_int|0x400
comma
DECL|enumerator|SecureHack
id|SecureHack
op_assign
l_int|0x100000
comma
DECL|enumerator|WokePhy
id|WokePhy
op_assign
l_int|0x400000
comma
DECL|enumerator|WokeUnicast
id|WokeUnicast
op_assign
l_int|0x800000
comma
DECL|enumerator|WokeMulticast
id|WokeMulticast
op_assign
l_int|0x1000000
comma
DECL|enumerator|WokeBroadcast
id|WokeBroadcast
op_assign
l_int|0x2000000
comma
DECL|enumerator|WokeArp
id|WokeArp
op_assign
l_int|0x4000000
comma
DECL|enumerator|WokePMatch0
id|WokePMatch0
op_assign
l_int|0x8000000
comma
DECL|enumerator|WokePMatch1
id|WokePMatch1
op_assign
l_int|0x10000000
comma
DECL|enumerator|WokePMatch2
id|WokePMatch2
op_assign
l_int|0x20000000
comma
DECL|enumerator|WokePMatch3
id|WokePMatch3
op_assign
l_int|0x40000000
comma
DECL|enumerator|WokeMagic
id|WokeMagic
op_assign
l_int|0x80000000
comma
DECL|enumerator|WakeOptsSummary
id|WakeOptsSummary
op_assign
l_int|0x7ff
)brace
suffix:semicolon
DECL|enum|RxFilterAddr_bits
r_enum
id|RxFilterAddr_bits
(brace
DECL|enumerator|RFCRAddressMask
id|RFCRAddressMask
op_assign
l_int|0x3ff
comma
DECL|enumerator|AcceptMulticast
id|AcceptMulticast
op_assign
l_int|0x00200000
comma
DECL|enumerator|AcceptMyPhys
id|AcceptMyPhys
op_assign
l_int|0x08000000
comma
DECL|enumerator|AcceptAllPhys
id|AcceptAllPhys
op_assign
l_int|0x10000000
comma
DECL|enumerator|AcceptAllMulticast
id|AcceptAllMulticast
op_assign
l_int|0x20000000
comma
DECL|enumerator|AcceptBroadcast
id|AcceptBroadcast
op_assign
l_int|0x40000000
comma
DECL|enumerator|RxFilterEnable
id|RxFilterEnable
op_assign
l_int|0x80000000
)brace
suffix:semicolon
DECL|enum|StatsCtrl_bits
r_enum
id|StatsCtrl_bits
(brace
DECL|enumerator|StatsWarn
id|StatsWarn
op_assign
l_int|0x1
comma
DECL|enumerator|StatsFreeze
id|StatsFreeze
op_assign
l_int|0x2
comma
DECL|enumerator|StatsClear
id|StatsClear
op_assign
l_int|0x4
comma
DECL|enumerator|StatsStrobe
id|StatsStrobe
op_assign
l_int|0x8
comma
)brace
suffix:semicolon
DECL|enum|MIntrCtrl_bits
r_enum
id|MIntrCtrl_bits
(brace
DECL|enumerator|MICRIntEn
id|MICRIntEn
op_assign
l_int|0x2
comma
)brace
suffix:semicolon
DECL|enum|PhyCtrl_bits
r_enum
id|PhyCtrl_bits
(brace
DECL|enumerator|PhyAddrMask
id|PhyAddrMask
op_assign
l_int|0xf
comma
)brace
suffix:semicolon
multiline_comment|/* values we might find in the silicon revision register */
DECL|macro|SRR_DP83815_C
mdefine_line|#define SRR_DP83815_C&t;0x0302
DECL|macro|SRR_DP83815_D
mdefine_line|#define SRR_DP83815_D&t;0x0403
DECL|macro|SRR_DP83816_A4
mdefine_line|#define SRR_DP83816_A4&t;0x0504
DECL|macro|SRR_DP83816_A5
mdefine_line|#define SRR_DP83816_A5&t;0x0505
multiline_comment|/* The Rx and Tx buffer descriptors. */
multiline_comment|/* Note that using only 32 bit fields simplifies conversion to big-endian&n;   architectures. */
DECL|struct|netdev_desc
r_struct
id|netdev_desc
(brace
DECL|member|next_desc
id|u32
id|next_desc
suffix:semicolon
DECL|member|cmd_status
id|s32
id|cmd_status
suffix:semicolon
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|software_use
id|u32
id|software_use
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Bits in network_desc.status */
DECL|enum|desc_status_bits
r_enum
id|desc_status_bits
(brace
DECL|enumerator|DescOwn
DECL|enumerator|DescMore
DECL|enumerator|DescIntr
id|DescOwn
op_assign
l_int|0x80000000
comma
id|DescMore
op_assign
l_int|0x40000000
comma
id|DescIntr
op_assign
l_int|0x20000000
comma
DECL|enumerator|DescNoCRC
DECL|enumerator|DescPktOK
id|DescNoCRC
op_assign
l_int|0x10000000
comma
id|DescPktOK
op_assign
l_int|0x08000000
comma
DECL|enumerator|DescSizeMask
id|DescSizeMask
op_assign
l_int|0xfff
comma
DECL|enumerator|DescTxAbort
DECL|enumerator|DescTxFIFO
id|DescTxAbort
op_assign
l_int|0x04000000
comma
id|DescTxFIFO
op_assign
l_int|0x02000000
comma
DECL|enumerator|DescTxCarrier
DECL|enumerator|DescTxDefer
id|DescTxCarrier
op_assign
l_int|0x01000000
comma
id|DescTxDefer
op_assign
l_int|0x00800000
comma
DECL|enumerator|DescTxExcDefer
DECL|enumerator|DescTxOOWCol
id|DescTxExcDefer
op_assign
l_int|0x00400000
comma
id|DescTxOOWCol
op_assign
l_int|0x00200000
comma
DECL|enumerator|DescTxExcColl
DECL|enumerator|DescTxCollCount
id|DescTxExcColl
op_assign
l_int|0x00100000
comma
id|DescTxCollCount
op_assign
l_int|0x000f0000
comma
DECL|enumerator|DescRxAbort
DECL|enumerator|DescRxOver
id|DescRxAbort
op_assign
l_int|0x04000000
comma
id|DescRxOver
op_assign
l_int|0x02000000
comma
DECL|enumerator|DescRxDest
DECL|enumerator|DescRxLong
id|DescRxDest
op_assign
l_int|0x01800000
comma
id|DescRxLong
op_assign
l_int|0x00400000
comma
DECL|enumerator|DescRxRunt
DECL|enumerator|DescRxInvalid
id|DescRxRunt
op_assign
l_int|0x00200000
comma
id|DescRxInvalid
op_assign
l_int|0x00100000
comma
DECL|enumerator|DescRxCRC
DECL|enumerator|DescRxAlign
id|DescRxCRC
op_assign
l_int|0x00080000
comma
id|DescRxAlign
op_assign
l_int|0x00040000
comma
DECL|enumerator|DescRxLoop
DECL|enumerator|DesRxColl
id|DescRxLoop
op_assign
l_int|0x00020000
comma
id|DesRxColl
op_assign
l_int|0x00010000
comma
)brace
suffix:semicolon
DECL|struct|netdev_private
r_struct
id|netdev_private
(brace
multiline_comment|/* Descriptor rings first for alignment. */
DECL|member|ring_dma
id|dma_addr_t
id|ring_dma
suffix:semicolon
DECL|member|rx_ring
r_struct
id|netdev_desc
op_star
id|rx_ring
suffix:semicolon
DECL|member|tx_ring
r_struct
id|netdev_desc
op_star
id|tx_ring
suffix:semicolon
multiline_comment|/* The addresses of receive-in-place skbuffs. */
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_dma
id|dma_addr_t
id|rx_dma
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The saved address of a sent-in-place packet/buffer, for later free(). */
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_dma
id|dma_addr_t
id|tx_dma
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media monitoring timer. */
multiline_comment|/* Frequently used values: keep some adjacent for cache effect. */
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|rx_head_desc
r_struct
id|netdev_desc
op_star
id|rx_head_desc
suffix:semicolon
DECL|member|cur_rx
DECL|member|dirty_rx
r_int
r_int
id|cur_rx
comma
id|dirty_rx
suffix:semicolon
multiline_comment|/* Producer/consumer ring indices */
DECL|member|cur_tx
DECL|member|dirty_tx
r_int
r_int
id|cur_tx
comma
id|dirty_tx
suffix:semicolon
DECL|member|rx_buf_sz
r_int
r_int
id|rx_buf_sz
suffix:semicolon
multiline_comment|/* Based on MTU+slack. */
multiline_comment|/* These values are keep track of the transceiver/media in use. */
DECL|member|full_duplex
r_int
r_int
id|full_duplex
suffix:semicolon
multiline_comment|/* Rx filter. */
DECL|member|cur_rx_mode
id|u32
id|cur_rx_mode
suffix:semicolon
DECL|member|rx_filter
id|u32
id|rx_filter
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* FIFO and PCI burst thresholds. */
DECL|member|tx_config
DECL|member|rx_config
id|u32
id|tx_config
comma
id|rx_config
suffix:semicolon
multiline_comment|/* original contents of ClkRun register */
DECL|member|SavedClkRun
id|u32
id|SavedClkRun
suffix:semicolon
multiline_comment|/* silicon revision */
DECL|member|srr
id|u32
id|srr
suffix:semicolon
multiline_comment|/* expected DSPCFG value */
DECL|member|dspcfg
id|u16
id|dspcfg
suffix:semicolon
multiline_comment|/* MII transceiver section. */
DECL|member|advertising
id|u16
id|advertising
suffix:semicolon
multiline_comment|/* NWay media advertisement */
DECL|member|iosize
r_int
r_int
id|iosize
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|msg_enable
id|u32
id|msg_enable
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|eeprom_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|reg
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|reg
comma
id|u16
id|data
)paren
suffix:semicolon
r_static
r_void
id|natsemi_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|natsemi_reload_eeprom
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|natsemi_stop_rxtx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|netdev_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|do_cable_magic
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|undo_cable_magic
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|check_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|netdev_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|alloc_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|drain_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|free_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|init_registers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|start_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|netdev_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
suffix:semicolon
r_static
r_void
id|netdev_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|netdev_tx_done
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|__set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|__get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|netdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|netdev_set_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|newval
)paren
suffix:semicolon
r_static
r_int
id|netdev_get_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|supported
comma
id|u32
op_star
id|cur
)paren
suffix:semicolon
r_static
r_int
id|netdev_set_sopass
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|newval
)paren
suffix:semicolon
r_static
r_int
id|netdev_get_sopass
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|netdev_get_ecmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|ecmd
)paren
suffix:semicolon
r_static
r_int
id|netdev_set_ecmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|ecmd
)paren
suffix:semicolon
r_static
r_void
id|enable_wol_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|enable_intr
)paren
suffix:semicolon
r_static
r_int
id|netdev_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|netdev_get_regs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|netdev_get_eeprom
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|buf
)paren
suffix:semicolon
"&f;"
DECL|function|natsemi_probe1
r_static
r_int
id|__devinit
id|natsemi_probe1
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
suffix:semicolon
r_int
id|i
comma
id|option
comma
id|irq
comma
id|chip_idx
op_assign
id|ent-&gt;driver_data
suffix:semicolon
r_static
r_int
id|find_cnt
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|ioaddr
comma
id|iosize
suffix:semicolon
r_const
r_int
id|pcibar
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* PCI base address register */
r_int
id|prev_eedata
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
multiline_comment|/* when built into the kernel, we only print version if device is found */
macro_line|#ifndef MODULE
r_static
r_int
id|printed_version
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#endif
id|i
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
multiline_comment|/* natsemi has a non-standard PM control register&n;&t; * in PCI config space.  Some boards apparently need&n;&t; * to be brought to D0 in this manner.&n;&t; */
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|PCIPM
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|PCI_PM_CTRL_STATE_MASK
)paren
(brace
multiline_comment|/* D0 state, disable PME assertion */
id|u32
id|newtmp
op_assign
id|tmp
op_amp
op_complement
id|PCI_PM_CTRL_STATE_MASK
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|PCIPM
comma
id|newtmp
)paren
suffix:semicolon
)brace
id|find_cnt
op_increment
suffix:semicolon
id|ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|pcibar
)paren
suffix:semicolon
id|iosize
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|pcibar
)paren
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|natsemi_pci_info
(braket
id|chip_idx
)braket
dot
id|flags
op_amp
id|PCI_USES_MASTER
)paren
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|netdev_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|i
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
(brace
r_void
op_star
id|mmio
op_assign
id|ioremap
(paren
id|ioaddr
comma
id|iosize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mmio
)paren
(brace
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ioaddr
op_assign
(paren
r_int
r_int
)paren
id|mmio
suffix:semicolon
)brace
multiline_comment|/* Work around the dropped serial bit. */
id|prev_eedata
op_assign
id|eeprom_read
c_func
(paren
id|ioaddr
comma
l_int|6
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|eedata
op_assign
id|eeprom_read
c_func
(paren
id|ioaddr
comma
id|i
op_plus
l_int|7
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_star
l_int|2
)braket
op_assign
(paren
id|eedata
op_lshift
l_int|1
)paren
op_plus
(paren
id|prev_eedata
op_rshift
l_int|15
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
op_assign
id|eedata
op_rshift
l_int|7
suffix:semicolon
id|prev_eedata
op_assign
id|eedata
suffix:semicolon
)brace
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|np-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|np-&gt;iosize
op_assign
id|iosize
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|np-&gt;msg_enable
op_assign
id|debug
suffix:semicolon
multiline_comment|/* Reset the chip to erase previous misconfiguration. */
id|natsemi_reload_eeprom
c_func
(paren
id|dev
)paren
suffix:semicolon
id|natsemi_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|option
op_assign
id|find_cnt
OL
id|MAX_UNITS
ques
c_cond
id|options
(braket
id|find_cnt
)braket
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
id|option
op_assign
id|dev-&gt;mem_start
suffix:semicolon
multiline_comment|/* The lower four bits are the media type. */
r_if
c_cond
(paren
id|option
)paren
(brace
r_if
c_cond
(paren
id|option
op_amp
l_int|0x200
)paren
id|np-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|option
op_amp
l_int|15
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ignoring user supplied media type %d&quot;
comma
id|dev-&gt;name
comma
id|option
op_amp
l_int|15
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|find_cnt
OL
id|MAX_UNITS
op_logical_and
id|full_duplex
(braket
id|find_cnt
)braket
)paren
id|np-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* The chip-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|netdev_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|start_tx
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|netdev_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|netdev_ioctl
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|mtu
)paren
id|dev-&gt;mtu
op_assign
id|mtu
suffix:semicolon
id|i
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_drv
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at %#08lx, &quot;
comma
id|dev-&gt;name
comma
id|natsemi_pci_info
(braket
id|chip_idx
)braket
dot
id|name
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x, IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|irq
)paren
suffix:semicolon
)brace
id|np-&gt;advertising
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ChipConfig
)paren
op_amp
l_int|0xe000
)paren
op_ne
l_int|0xe000
op_logical_and
id|netif_msg_probe
c_func
(paren
id|np
)paren
)paren
(brace
id|u32
id|chip_config
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ChipConfig
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transceiver default autonegotiation %s &quot;
l_string|&quot;10%s %s duplex.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|chip_config
op_amp
id|CfgAnegEnable
ques
c_cond
l_string|&quot;enabled, advertise&quot;
suffix:colon
l_string|&quot;disabled, force&quot;
comma
id|chip_config
op_amp
id|CfgAneg100
ques
c_cond
l_string|&quot;0&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|chip_config
op_amp
id|CfgAnegFull
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_msg_probe
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transceiver status %#04x advertising %#04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMSR
)paren
comma
id|np-&gt;advertising
)paren
suffix:semicolon
multiline_comment|/* save the silicon revision for later querying */
id|np-&gt;srr
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|SiliconRev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: silicon revision %#04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;srr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Read the EEPROM and MII Management Data I/O (MDIO) interfaces.&n;   The EEPROM code is for the common 93c06/46 EEPROMs with 6 bit addresses. */
multiline_comment|/* Delay between EEPROM clock transitions.&n;   No extra delay is needed with 33Mhz PCI, but future 66Mhz access may need&n;   a delay.  Note that pre-2.0.34 kernels had a cache-alignment bug that&n;   made udelay() unreliable.&n;   The old method of using an ISA access as a delay, __SLOW_DOWN_IO__, is&n;   depricated.&n;*/
DECL|macro|eeprom_delay
mdefine_line|#define eeprom_delay(ee_addr)&t;readl(ee_addr)
DECL|macro|EE_Write0
mdefine_line|#define EE_Write0 (EE_ChipSelect)
DECL|macro|EE_Write1
mdefine_line|#define EE_Write1 (EE_ChipSelect | EE_DataIn)
multiline_comment|/* The EEPROM commands include the alway-set leading bit. */
DECL|enum|EEPROM_Cmds
r_enum
id|EEPROM_Cmds
(brace
DECL|enumerator|EE_WriteCmd
DECL|enumerator|EE_ReadCmd
DECL|enumerator|EE_EraseCmd
id|EE_WriteCmd
op_assign
(paren
l_int|5
op_lshift
l_int|6
)paren
comma
id|EE_ReadCmd
op_assign
(paren
l_int|6
op_lshift
l_int|6
)paren
comma
id|EE_EraseCmd
op_assign
(paren
l_int|7
op_lshift
l_int|6
)paren
comma
)brace
suffix:semicolon
DECL|function|eeprom_read
r_static
r_int
id|eeprom_read
c_func
(paren
r_int
id|addr
comma
r_int
id|location
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|ee_addr
op_assign
id|addr
op_plus
id|EECtrl
suffix:semicolon
r_int
id|read_cmd
op_assign
id|location
op_or
id|EE_ReadCmd
suffix:semicolon
id|writel
c_func
(paren
id|EE_Write0
comma
id|ee_addr
)paren
suffix:semicolon
multiline_comment|/* Shift the read command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|read_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|EE_Write1
suffix:colon
id|EE_Write0
suffix:semicolon
id|writel
c_func
(paren
id|dataval
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
id|ee_addr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dataval
op_or
id|EE_ShiftClk
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
id|ee_addr
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|EE_ChipSelect
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
id|ee_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|EE_ChipSelect
op_or
id|EE_ShiftClk
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
id|ee_addr
)paren
suffix:semicolon
id|retval
op_or_assign
(paren
id|readl
c_func
(paren
id|ee_addr
)paren
op_amp
id|EE_DataOut
)paren
ques
c_cond
l_int|1
op_lshift
id|i
suffix:colon
l_int|0
suffix:semicolon
id|writel
c_func
(paren
id|EE_ChipSelect
comma
id|ee_addr
)paren
suffix:semicolon
id|eeprom_delay
c_func
(paren
id|ee_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Terminate the EEPROM access. */
id|writel
c_func
(paren
id|EE_Write0
comma
id|ee_addr
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|ee_addr
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*  MII transceiver control section.&n;&t;The 83815 series has an internal transceiver, and we present the&n;&t;management registers as if they were MII connected. */
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|reg
)paren
(brace
r_if
c_cond
(paren
id|phy_id
op_eq
l_int|1
op_logical_and
id|reg
OL
l_int|32
)paren
r_return
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|BasicControl
op_plus
(paren
id|reg
op_lshift
l_int|2
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_else
r_return
l_int|0xffff
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|reg
comma
id|u16
id|data
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|phy_id
op_eq
l_int|1
op_logical_and
id|reg
OL
l_int|32
)paren
(brace
id|writew
c_func
(paren
id|data
comma
id|dev-&gt;base_addr
op_plus
id|BasicControl
op_plus
(paren
id|reg
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reg
)paren
(brace
r_case
id|MII_ADVERTISE
suffix:colon
id|np-&gt;advertising
op_assign
id|data
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* CFG bits [13:16] [18:23] */
DECL|macro|CFG_RESET_SAVE
mdefine_line|#define CFG_RESET_SAVE 0xfde000
multiline_comment|/* WCSR bits [0:4] [9:10] */
DECL|macro|WCSR_RESET_SAVE
mdefine_line|#define WCSR_RESET_SAVE 0x61f
multiline_comment|/* RFCR bits [20] [22] [27:31] */
DECL|macro|RFCR_RESET_SAVE
mdefine_line|#define RFCR_RESET_SAVE 0xf8500000;
DECL|function|natsemi_reset
r_static
r_void
id|natsemi_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|cfg
suffix:semicolon
id|u32
id|wcsr
suffix:semicolon
id|u32
id|rfcr
suffix:semicolon
id|u16
id|pmatch
(braket
l_int|3
)braket
suffix:semicolon
id|u16
id|sopass
(braket
l_int|3
)braket
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* &n;&t; * Resetting the chip causes some registers to be lost.&n;&t; * Natsemi suggests NOT reloading the EEPROM while live, so instead&n;&t; * we save the state that would have been loaded from EEPROM&n;&t; * on a normal power-up (see the spec EEPROM map).  This assumes &n;&t; * whoever calls this will follow up with init_registers() eventually.&n;&t; */
multiline_comment|/* CFG */
id|cfg
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ChipConfig
)paren
op_amp
id|CFG_RESET_SAVE
suffix:semicolon
multiline_comment|/* WCSR */
id|wcsr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|WOLCmd
)paren
op_amp
id|WCSR_RESET_SAVE
suffix:semicolon
multiline_comment|/* RFCR */
id|rfcr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
op_amp
id|RFCR_RESET_SAVE
suffix:semicolon
multiline_comment|/* PMATCH */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|i
op_star
l_int|2
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|pmatch
(braket
id|i
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
)brace
multiline_comment|/* SOPAS */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0xa
op_plus
(paren
id|i
op_star
l_int|2
)paren
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|sopass
(braket
id|i
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
)brace
multiline_comment|/* now whack the chip */
id|writel
c_func
(paren
id|ChipReset
comma
id|dev-&gt;base_addr
op_plus
id|ChipCmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NATSEMI_HW_TIMEOUT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ChipCmd
)paren
op_amp
id|ChipReset
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|NATSEMI_HW_TIMEOUT
op_logical_and
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: reset did not complete in %d usec.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
op_star
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: reset completed in %d usec.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
op_star
l_int|5
)paren
suffix:semicolon
)brace
multiline_comment|/* restore CFG */
id|cfg
op_or_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ChipConfig
)paren
op_amp
op_complement
id|CFG_RESET_SAVE
suffix:semicolon
id|writel
c_func
(paren
id|cfg
comma
id|dev-&gt;base_addr
op_plus
id|ChipConfig
)paren
suffix:semicolon
multiline_comment|/* restore WCSR */
id|wcsr
op_or_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|WOLCmd
)paren
op_amp
op_complement
id|WCSR_RESET_SAVE
suffix:semicolon
id|writel
c_func
(paren
id|wcsr
comma
id|dev-&gt;base_addr
op_plus
id|WOLCmd
)paren
suffix:semicolon
multiline_comment|/* read RFCR */
id|rfcr
op_or_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
op_amp
op_complement
id|RFCR_RESET_SAVE
suffix:semicolon
multiline_comment|/* restore PMATCH */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|i
op_star
l_int|2
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|pmatch
(braket
id|i
)braket
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0xa
op_plus
(paren
id|i
op_star
l_int|2
)paren
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|sopass
(braket
id|i
)braket
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
)brace
multiline_comment|/* restore RFCR */
id|writel
c_func
(paren
id|rfcr
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
)brace
DECL|function|natsemi_reload_eeprom
r_static
r_void
id|natsemi_reload_eeprom
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|writel
c_func
(paren
id|EepromReload
comma
id|dev-&gt;base_addr
op_plus
id|PCIBusCfg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NATSEMI_HW_TIMEOUT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|PCIBusCfg
)paren
op_amp
id|EepromReload
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|NATSEMI_HW_TIMEOUT
op_logical_and
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: EEPROM did not reload in %d usec.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
op_star
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: EEPROM reloaded in %d usec.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
op_star
l_int|5
)paren
suffix:semicolon
)brace
)brace
DECL|function|natsemi_stop_rxtx
r_static
r_void
id|natsemi_stop_rxtx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|writel
c_func
(paren
id|RxOff
op_or
id|TxOff
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NATSEMI_HW_TIMEOUT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
op_amp
(paren
id|TxOn
op_or
id|RxOn
)paren
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|NATSEMI_HW_TIMEOUT
op_logical_and
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Tx/Rx process did not stop in %d usec.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
op_star
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Tx/Rx process stopped in %d usec.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
op_star
l_int|5
)paren
suffix:semicolon
)brace
)brace
DECL|function|netdev_open
r_static
r_int
id|netdev_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Reset the chip, just in case. */
id|natsemi_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|i
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|intr_handler
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_ifup
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: netdev_open() irq %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|i
op_assign
id|alloc_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|init_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_ifup
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Done netdev_open(), status: %#08x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the timer to check for link beat. */
id|init_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
id|np-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|NATSEMI_TIMER_FREQ
suffix:semicolon
id|np-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|np-&gt;timer.function
op_assign
op_amp
id|netdev_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_cable_magic
r_static
r_void
id|do_cable_magic
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;srr
op_ge
id|SRR_DP83816_A5
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * 100 MBit links with short cables can trip an issue with the chip.&n;&t; * The problem manifests as lots of CRC errors and/or flickering&n;&t; * activity LED while idle.  This process is based on instructions&n;&t; * from engineers at National.&n;&t; */
r_if
c_cond
(paren
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ChipConfig
)paren
op_amp
id|CfgSpeed100
)paren
(brace
id|u16
id|data
suffix:semicolon
id|writew
c_func
(paren
l_int|1
comma
id|dev-&gt;base_addr
op_plus
id|PGSEL
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * coefficient visibility should already be enabled via&n;&t;&t; * DSPCFG | 0x1000&n;&t;&t; */
id|data
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TSTDAT
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;&t;&t; * the value must be negative, and within certain values&n;&t;&t; * (these values all come from National)&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_amp
l_int|0x80
)paren
op_logical_or
(paren
(paren
id|data
op_ge
l_int|0xd8
)paren
op_logical_and
(paren
id|data
op_le
l_int|0xff
)paren
)paren
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* the bug has been triggered - fix the coefficient */
id|writew
c_func
(paren
id|TSTDAT_FIXED
comma
id|dev-&gt;base_addr
op_plus
id|TSTDAT
)paren
suffix:semicolon
multiline_comment|/* lock the value */
id|data
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|DSPCFG
)paren
suffix:semicolon
id|np-&gt;dspcfg
op_assign
id|data
op_or
id|DSPCFG_LOCK
suffix:semicolon
id|writew
c_func
(paren
id|np-&gt;dspcfg
comma
id|dev-&gt;base_addr
op_plus
id|DSPCFG
)paren
suffix:semicolon
)brace
id|writew
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|PGSEL
)paren
suffix:semicolon
)brace
)brace
DECL|function|undo_cable_magic
r_static
r_void
id|undo_cable_magic
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|u16
id|data
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;srr
op_ge
id|SRR_DP83816_A5
)paren
r_return
suffix:semicolon
id|writew
c_func
(paren
l_int|1
comma
id|dev-&gt;base_addr
op_plus
id|PGSEL
)paren
suffix:semicolon
multiline_comment|/* make sure the lock bit is clear */
id|data
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|DSPCFG
)paren
suffix:semicolon
id|np-&gt;dspcfg
op_assign
id|data
op_amp
op_complement
id|DSPCFG_LOCK
suffix:semicolon
id|writew
c_func
(paren
id|np-&gt;dspcfg
comma
id|dev-&gt;base_addr
op_plus
id|DSPCFG
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|PGSEL
)paren
suffix:semicolon
)brace
DECL|function|check_link
r_static
r_void
id|check_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|duplex
suffix:semicolon
r_int
id|chipcfg
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ChipConfig
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chipcfg
op_amp
id|CfgLink
)paren
)paren
(brace
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: link down.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|undo_cable_magic
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|netif_carrier_ok
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: link up.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
id|do_cable_magic
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|duplex
op_assign
id|np-&gt;full_duplex
op_logical_or
(paren
id|chipcfg
op_amp
id|CfgFullDuplex
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if duplex is set then bit 28 must be set, too */
r_if
c_cond
(paren
id|duplex
op_xor
op_logical_neg
op_logical_neg
(paren
id|np-&gt;rx_config
op_amp
id|RxAcceptTx
)paren
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting %s-duplex based on negotiated &quot;
l_string|&quot;link capability.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|duplex
)paren
(brace
id|np-&gt;rx_config
op_or_assign
id|RxAcceptTx
suffix:semicolon
id|np-&gt;tx_config
op_or_assign
id|TxCarrierIgn
op_or
id|TxHeartIgn
suffix:semicolon
)brace
r_else
(brace
id|np-&gt;rx_config
op_and_assign
op_complement
id|RxAcceptTx
suffix:semicolon
id|np-&gt;tx_config
op_and_assign
op_complement
(paren
id|TxCarrierIgn
op_or
id|TxHeartIgn
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|np-&gt;tx_config
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
id|writel
c_func
(paren
id|np-&gt;rx_config
comma
id|ioaddr
op_plus
id|RxConfig
)paren
suffix:semicolon
)brace
)brace
DECL|function|init_registers
r_static
r_void
id|init_registers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NATSEMI_HW_TIMEOUT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ChipConfig
)paren
op_amp
id|CfgAnegDone
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|NATSEMI_HW_TIMEOUT
op_logical_and
id|netif_msg_link
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: autonegotiation did not complete in %d usec.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
op_star
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* On page 78 of the spec, they recommend some settings for &quot;optimum&n;&t;   performance&quot; to be done in sequence.  These settings optimize some&n;&t;   of the 100Mbit autodetection circuitry.  They say we only want to &n;&t;   do this for rev C of the chip, but engineers at NSC (Bradley &n;&t;   Kennedy) recommends always setting them.  If you don&squot;t, you get &n;&t;   errors on some autonegotiations that make the device unusable.&n;&t;*/
id|writew
c_func
(paren
l_int|1
comma
id|ioaddr
op_plus
id|PGSEL
)paren
suffix:semicolon
id|writew
c_func
(paren
id|PMDCSR_VAL
comma
id|ioaddr
op_plus
id|PMDCSR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|TSTDAT_VAL
comma
id|ioaddr
op_plus
id|TSTDAT
)paren
suffix:semicolon
id|writew
c_func
(paren
id|DSPCFG_VAL
comma
id|ioaddr
op_plus
id|DSPCFG
)paren
suffix:semicolon
id|writew
c_func
(paren
id|SDCFG_VAL
comma
id|ioaddr
op_plus
id|SDCFG
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|PGSEL
)paren
suffix:semicolon
id|np-&gt;dspcfg
op_assign
id|DSPCFG_VAL
suffix:semicolon
multiline_comment|/* Enable PHY Specific event based interrupts.  Link state change&n;&t;   and Auto-Negotiation Completion are among the affected.&n;&t;   Read the intr status to clear it (needed for wake events).&n;&t;*/
id|readw
c_func
(paren
id|ioaddr
op_plus
id|MIntrStatus
)paren
suffix:semicolon
id|writew
c_func
(paren
id|MICRIntEn
comma
id|ioaddr
op_plus
id|MIntrCtrl
)paren
suffix:semicolon
multiline_comment|/* clear any interrupts that are pending, such as wake events */
id|readl
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
id|writel
c_func
(paren
id|np-&gt;ring_dma
comma
id|ioaddr
op_plus
id|RxRingPtr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|np-&gt;ring_dma
op_plus
id|RX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|netdev_desc
)paren
comma
id|ioaddr
op_plus
id|TxRingPtr
)paren
suffix:semicolon
multiline_comment|/* Initialize other registers.&n;&t; * Configure the PCI bus bursts and FIFO thresholds.&n;&t; * Configure for standard, in-spec Ethernet.&n;&t; * Start with half-duplex. check_link will update&n;&t; * to the correct settings. &n;&t; */
multiline_comment|/* DRTH: 2: start tx if 64 bytes are in the fifo&n;&t; * FLTH: 0x10: refill with next packet if 512 bytes are free&n;&t; * MXDMA: 0: up to 256 byte bursts.&n;&t; * &t;MXDMA must be &lt;= FLTH&n;&t; * ECRETRY=1&n;&t; * ATP=1&n;&t; */
id|np-&gt;tx_config
op_assign
id|TxAutoPad
op_or
id|TxCollRetry
op_or
id|TxMxdma_256
op_or
(paren
l_int|0x1002
)paren
suffix:semicolon
id|writel
c_func
(paren
id|np-&gt;tx_config
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
multiline_comment|/* DRTH 0x10: start copying to memory if 128 bytes are in the fifo&n;&t; * MXDMA 0: up to 256 byte bursts&n;&t; */
id|np-&gt;rx_config
op_assign
id|RxMxdma_256
op_or
l_int|0x20
suffix:semicolon
id|writel
c_func
(paren
id|np-&gt;rx_config
comma
id|ioaddr
op_plus
id|RxConfig
)paren
suffix:semicolon
multiline_comment|/* Disable PME:&n;&t; * The PME bit is initialized from the EEPROM contents.&n;&t; * PCI cards probably have PME disabled, but motherboard&n;&t; * implementations may have PME set to enable WakeOnLan. &n;&t; * With PME set the chip will scan incoming packets but&n;&t; * nothing will be written to memory. */
id|np-&gt;SavedClkRun
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ClkRun
)paren
suffix:semicolon
id|writel
c_func
(paren
id|np-&gt;SavedClkRun
op_amp
op_complement
id|PMEEnable
comma
id|ioaddr
op_plus
id|ClkRun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;SavedClkRun
op_amp
id|PMEStatus
op_logical_and
id|netif_msg_wol
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Wake-up event %#08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|WOLCmd
)paren
)paren
suffix:semicolon
)brace
id|check_link
c_func
(paren
id|dev
)paren
suffix:semicolon
id|__set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts by setting the interrupt mask. */
id|writel
c_func
(paren
id|DEFAULT_INTR
comma
id|ioaddr
op_plus
id|IntrMask
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|1
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
id|writel
c_func
(paren
id|RxOn
op_or
id|TxOn
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|writel
c_func
(paren
id|StatsClear
comma
id|ioaddr
op_plus
id|StatsCtrl
)paren
suffix:semicolon
multiline_comment|/* Clear Stats */
)brace
multiline_comment|/*&n; * Purpose:&n; * check for sudden death of the NIC:&n; *&n; * It seems that a reference set for this chip went out with incorrect info,&n; * and there exist boards that aren&squot;t quite right.  An unexpected voltage drop&n; * can cause the PHY to get itself in a weird state (basically reset..).&n; * NOTE: this only seems to affect revC chips.&n; */
DECL|function|netdev_timer
r_static
r_void
id|netdev_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u16
id|dspcfg
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_timer
c_func
(paren
id|np
)paren
)paren
(brace
multiline_comment|/* DO NOT read the IntrStatus register, &n;&t;&t; * a read clears any pending interrupts.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection timer tick.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* check for a nasty random phy-reset - use dspcfg as a flag */
id|writew
c_func
(paren
l_int|1
comma
id|ioaddr
op_plus
id|PGSEL
)paren
suffix:semicolon
id|dspcfg
op_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|DSPCFG
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|PGSEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dspcfg
op_ne
id|np-&gt;dspcfg
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: possible phy reset: &quot;
l_string|&quot;re-initializing&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|init_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* hurry back */
id|next_tick
op_assign
id|HZ
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* init_registers() calls check_link() for the above case */
id|check_link
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|np-&gt;timer
comma
id|jiffies
op_plus
id|next_tick
)paren
suffix:semicolon
)brace
DECL|function|dump_ring
r_static
r_void
id|dump_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_pktdata
c_func
(paren
id|np
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  Tx ring at %p:&bslash;n&quot;
comma
id|np-&gt;tx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; #%d desc. %#08x %#08x %#08x.&bslash;n&quot;
comma
id|i
comma
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|next_desc
comma
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|cmd_status
comma
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|addr
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  Rx ring %p:&bslash;n&quot;
comma
id|np-&gt;rx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; #%d desc. %#08x %#08x %#08x.&bslash;n&quot;
comma
id|i
comma
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|next_desc
comma
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|cmd_status
comma
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|tx_timeout
r_static
r_void
id|tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_tx_err
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit timed out, status %#08x,&quot;
l_string|&quot; resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
id|dump_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|natsemi_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|drain_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: tx_timeout while in suspended state?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|alloc_ring
r_static
r_int
id|alloc_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|np-&gt;rx_ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|np-&gt;pci_dev
comma
r_sizeof
(paren
r_struct
id|netdev_desc
)paren
op_star
(paren
id|RX_RING_SIZE
op_plus
id|TX_RING_SIZE
)paren
comma
op_amp
id|np-&gt;ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np-&gt;rx_ring
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|np-&gt;tx_ring
op_assign
op_amp
id|np-&gt;rx_ring
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initialize the Rx and Tx rings, along with various &squot;dev&squot; bits. */
DECL|function|init_ring
r_static
r_void
id|init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|np-&gt;cur_rx
op_assign
id|np-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|np-&gt;dirty_rx
op_assign
id|np-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_buf_sz
op_assign
(paren
id|dev-&gt;mtu
op_le
l_int|1500
ques
c_cond
id|PKT_BUF_SZ
suffix:colon
id|dev-&gt;mtu
op_plus
l_int|32
)paren
suffix:semicolon
id|np-&gt;rx_head_desc
op_assign
op_amp
id|np-&gt;rx_ring
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Please be carefull before changing this loop - at least gcc-2.95.1&n;&t; * miscompiles it otherwise.&n;&t; */
multiline_comment|/* Initialize all Rx descriptors. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|next_desc
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;ring_dma
op_plus
r_sizeof
(paren
r_struct
id|netdev_desc
)paren
op_star
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|RX_RING_SIZE
)paren
)paren
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|cmd_status
op_assign
id|cpu_to_le32
c_func
(paren
id|DescOwn
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Fill in the Rx buffers.  Handle allocation failure gracefully. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|np-&gt;rx_buf_sz
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|np-&gt;rx_dma
(braket
id|i
)braket
op_assign
id|pci_map_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;rx_dma
(braket
id|i
)braket
)paren
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|cmd_status
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;rx_buf_sz
)paren
suffix:semicolon
)brace
id|np-&gt;dirty_rx
op_assign
(paren
r_int
r_int
)paren
(paren
id|i
op_minus
id|RX_RING_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|next_desc
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;ring_dma
op_plus
r_sizeof
(paren
r_struct
id|netdev_desc
)paren
op_star
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
op_plus
id|RX_RING_SIZE
)paren
)paren
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|cmd_status
op_assign
l_int|0
suffix:semicolon
)brace
id|dump_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|drain_ring
r_static
r_void
id|drain_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Free all the skbuffs in the Rx queue. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|cmd_status
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0xBADF00D0
suffix:semicolon
multiline_comment|/* An invalid address. */
r_if
c_cond
(paren
id|np-&gt;rx_skbuff
(braket
id|i
)braket
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;rx_dma
(braket
id|i
)braket
comma
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|np-&gt;rx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;tx_skbuff
(braket
id|i
)braket
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;rx_dma
(braket
id|i
)braket
comma
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|np-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|np-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|free_ring
r_static
r_void
id|free_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|np-&gt;pci_dev
comma
r_sizeof
(paren
r_struct
id|netdev_desc
)paren
op_star
(paren
id|RX_RING_SIZE
op_plus
id|TX_RING_SIZE
)paren
comma
id|np-&gt;rx_ring
comma
id|np-&gt;ring_dma
)paren
suffix:semicolon
)brace
DECL|function|start_tx
r_static
r_int
id|start_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
suffix:semicolon
multiline_comment|/* Note: Ordering is important here, set the field with the&n;&t;   &quot;ownership&quot; bit last, and only then increment cur_tx. */
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|np-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|np-&gt;tx_dma
(braket
id|entry
)braket
op_assign
id|pci_map_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;tx_dma
(braket
id|entry
)braket
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|cmd_status
op_assign
id|cpu_to_le32
c_func
(paren
id|DescOwn
op_or
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* StrongARM: Explicitly cache flush np-&gt;tx_ring and &n;&t;&t; * skb-&gt;data,skb-&gt;len. */
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|np-&gt;cur_tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
op_ge
id|TX_QUEUE_LEN
op_minus
l_int|1
)paren
(brace
id|netdev_tx_done
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
op_ge
id|TX_QUEUE_LEN
op_minus
l_int|1
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Wake the potentially-idle transmit channel. */
id|writel
c_func
(paren
id|TxOn
comma
id|dev-&gt;base_addr
op_plus
id|ChipCmd
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|np-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_tx_queued
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit frame #%d queued in slot %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;cur_tx
comma
id|entry
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_tx_done
r_static
r_void
id|netdev_tx_done
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OG
l_int|0
suffix:semicolon
id|np-&gt;dirty_tx
op_increment
)paren
(brace
r_int
id|entry
op_assign
id|np-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|cmd_status
op_amp
id|cpu_to_le32
c_func
(paren
id|DescOwn
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_tx_done
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: tx frame #%d finished, status %#08x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;dirty_tx
comma
id|le32_to_cpu
c_func
(paren
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|cmd_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|cmd_status
op_amp
id|cpu_to_le32
c_func
(paren
id|DescPktOK
)paren
)paren
(brace
id|np-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|np-&gt;stats.tx_bytes
op_add_assign
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Various Tx errors */
r_int
id|tx_status
op_assign
id|le32_to_cpu
c_func
(paren
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|cmd_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
(paren
id|DescTxAbort
op_or
id|DescTxExcColl
)paren
)paren
id|np-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|DescTxFIFO
)paren
id|np-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|DescTxCarrier
)paren
id|np-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|DescTxOOWCol
)paren
id|np-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;tx_dma
(braket
id|entry
)braket
comma
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
multiline_comment|/* Free the original skb. */
id|dev_kfree_skb_irq
c_func
(paren
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OL
id|TX_QUEUE_LEN
op_minus
l_int|4
)paren
(brace
multiline_comment|/* The ring is no longer full, wake queue. */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|intr_handler
r_static
r_void
id|intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|rgs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
r_return
suffix:semicolon
r_do
(brace
multiline_comment|/* Reading automatically acknowledges all int sources. */
id|u32
id|intr_status
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Interrupt, status %#08x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrRxDone
op_or
id|IntrRxIntr
op_or
id|RxStatusFIFOOver
op_or
id|IntrRxErr
op_or
id|IntrRxOverrun
)paren
)paren
(brace
id|netdev_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrTxDone
op_or
id|IntrTxIntr
op_or
id|IntrTxIdle
op_or
id|IntrTxErr
)paren
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|netdev_tx_done
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Abnormal error summary/uncommon events handlers. */
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrAbnormalSummary
)paren
id|netdev_error
c_func
(paren
id|dev
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work at interrupt, &quot;
l_string|&quot;status=%#08x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* This routine is logically part of the interrupt handler, but separated&n;   for clarity and better register allocation. */
DECL|function|netdev_rx
r_static
r_void
id|netdev_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|np-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|boguscnt
op_assign
id|np-&gt;dirty_rx
op_plus
id|RX_RING_SIZE
op_minus
id|np-&gt;cur_rx
suffix:semicolon
id|s32
id|desc_status
op_assign
id|le32_to_cpu
c_func
(paren
id|np-&gt;rx_head_desc-&gt;cmd_status
)paren
suffix:semicolon
multiline_comment|/* If the driver owns the next entry it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
id|desc_status
OL
l_int|0
)paren
(brace
multiline_comment|/* e.g. &amp; DescOwn */
r_if
c_cond
(paren
id|netif_msg_rx_status
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  netdev_rx() entry %d status was %#08x.&bslash;n&quot;
comma
id|entry
comma
id|desc_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|desc_status
op_amp
(paren
id|DescMore
op_or
id|DescPktOK
op_or
id|DescRxLong
)paren
)paren
op_ne
id|DescPktOK
)paren
(brace
r_if
c_cond
(paren
id|desc_status
op_amp
id|DescMore
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_rx_err
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Oversized(?) Ethernet &quot;
l_string|&quot;frame spanned multiple &quot;
l_string|&quot;buffers, entry %#08x &quot;
l_string|&quot;status %#08x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;cur_rx
comma
id|desc_status
)paren
suffix:semicolon
id|np-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* There was an error. */
id|np-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
(paren
id|DescRxAbort
op_or
id|DescRxOver
)paren
)paren
id|np-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
(paren
id|DescRxLong
op_or
id|DescRxRunt
)paren
)paren
id|np-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
(paren
id|DescRxInvalid
op_or
id|DescRxAlign
)paren
)paren
id|np-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
id|DescRxCRC
)paren
id|np-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* Omit CRC size. */
r_int
id|pkt_len
op_assign
(paren
id|desc_status
op_amp
id|DescSizeMask
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* Check if the packet is long enough to accept &n;&t;&t;&t; * without copying to a minimally-sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OL
id|rx_copybreak
op_logical_and
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the IP header */
id|pci_dma_sync_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;rx_dma
(braket
id|entry
)braket
comma
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
macro_line|#if HAS_IP_COPYSUM
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|tail
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#else
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|tail
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;rx_dma
(braket
id|entry
)braket
comma
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
op_assign
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
comma
id|pkt_len
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* W/ hardware checksum: skb-&gt;ip_summed = CHECKSUM_UNNECESSARY; */
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|np-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|np-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
)brace
id|entry
op_assign
(paren
op_increment
id|np-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|np-&gt;rx_head_desc
op_assign
op_amp
id|np-&gt;rx_ring
(braket
id|entry
)braket
suffix:semicolon
id|desc_status
op_assign
id|le32_to_cpu
c_func
(paren
id|np-&gt;rx_head_desc-&gt;cmd_status
)paren
suffix:semicolon
)brace
multiline_comment|/* Refill the Rx ring buffers. */
r_for
c_loop
(paren
suffix:semicolon
id|np-&gt;cur_rx
op_minus
id|np-&gt;dirty_rx
OG
l_int|0
suffix:semicolon
id|np-&gt;dirty_rx
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|entry
op_assign
id|np-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|np-&gt;rx_buf_sz
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Better luck next round. */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|np-&gt;rx_dma
(braket
id|entry
)braket
op_assign
id|pci_map_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;rx_dma
(braket
id|entry
)braket
)paren
suffix:semicolon
)brace
id|np-&gt;rx_ring
(braket
id|entry
)braket
dot
id|cmd_status
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;rx_buf_sz
)paren
suffix:semicolon
)brace
multiline_comment|/* Restart Rx engine if stopped. */
id|writel
c_func
(paren
id|RxOn
comma
id|dev-&gt;base_addr
op_plus
id|ChipCmd
)paren
suffix:semicolon
)brace
DECL|function|netdev_error
r_static
r_void
id|netdev_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
id|LinkChange
)paren
(brace
id|u16
id|adv
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
id|u16
id|lpa
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMCR
)paren
op_amp
id|BMCR_ANENABLE
op_logical_and
id|netif_msg_link
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Autonegotiation advertising&quot;
l_string|&quot; %#04x  partner %#04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|adv
comma
id|lpa
)paren
suffix:semicolon
)brace
multiline_comment|/* read MII int status to clear the flag */
id|readw
c_func
(paren
id|ioaddr
op_plus
id|MIntrStatus
)paren
suffix:semicolon
id|check_link
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|StatsMax
)paren
(brace
id|__get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrTxUnderrun
)paren
(brace
r_if
c_cond
(paren
(paren
id|np-&gt;tx_config
op_amp
id|TxDrthMask
)paren
OL
l_int|62
)paren
id|np-&gt;tx_config
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_tx_err
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: increased Tx threshold, txcfg %#08x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;tx_config
)paren
suffix:semicolon
id|writel
c_func
(paren
id|np-&gt;tx_config
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|WOLPkt
op_logical_and
id|netif_msg_wol
c_func
(paren
id|np
)paren
)paren
(brace
r_int
id|wol_status
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|WOLCmd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Link wake-up event %#08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|wol_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|RxStatusFIFOOver
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_rx_err
c_func
(paren
id|np
)paren
op_logical_and
id|netif_msg_intr
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Rx status FIFO overrun&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|np-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Hmmmmm, it&squot;s not clear how to recover from PCI faults. */
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrPCIErr
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: PCI error %#08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
op_amp
id|IntrPCIErr
)paren
suffix:semicolon
id|np-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|np-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|__get_stats
r_static
r_void
id|__get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* The chip only need report frame silently dropped. */
id|np-&gt;stats.rx_crc_errors
op_add_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|RxCRCErrs
)paren
suffix:semicolon
id|np-&gt;stats.rx_missed_errors
op_add_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
)brace
DECL|function|get_stats
r_static
r_struct
id|net_device_stats
op_star
id|get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* The chip only need report frame silently dropped. */
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
op_logical_and
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
id|__get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
op_amp
id|np-&gt;stats
suffix:semicolon
)brace
multiline_comment|/**&n; * dp83815_crc - computer CRC for hash table entries&n; *&n; * Note - this is, for some reason, *not* the same function&n; * as ether_crc_le() or ether_crc(), though it uses the&n; * same big-endian polynomial.&n; */
DECL|macro|DP_POLYNOMIAL
mdefine_line|#define DP_POLYNOMIAL&t;&t;&t;0x04C11DB7
DECL|function|dp83815_crc
r_static
r_int
id|dp83815_crc
c_func
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
(brace
id|u32
id|crc
suffix:semicolon
id|u8
id|cur_byte
suffix:semicolon
id|u8
id|msb
suffix:semicolon
id|u8
id|byte
comma
id|bit
suffix:semicolon
id|crc
op_assign
op_complement
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
id|length
suffix:semicolon
id|byte
op_increment
)paren
(brace
id|cur_byte
op_assign
op_star
id|data
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
l_int|8
suffix:semicolon
id|bit
op_increment
)paren
(brace
id|msb
op_assign
id|crc
op_rshift
l_int|31
suffix:semicolon
id|crc
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|msb
op_xor
(paren
id|cur_byte
op_amp
l_int|1
)paren
)paren
(brace
id|crc
op_xor_assign
id|DP_POLYNOMIAL
suffix:semicolon
id|crc
op_or_assign
l_int|1
suffix:semicolon
)brace
id|cur_byte
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|crc
op_rshift_assign
l_int|23
suffix:semicolon
r_return
(paren
id|crc
)paren
suffix:semicolon
)brace
DECL|function|set_bit_le
r_void
id|set_bit_le
c_func
(paren
r_int
id|offset
comma
r_int
r_char
op_star
id|data
)paren
(brace
id|data
(braket
id|offset
op_rshift
l_int|3
)braket
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|offset
op_amp
l_int|0x07
)paren
)paren
suffix:semicolon
)brace
DECL|macro|HASH_TABLE
mdefine_line|#define HASH_TABLE&t;0x200
DECL|function|__set_rx_mode
r_static
r_void
id|__set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u8
id|mc_filter
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* Multicast hash filter */
id|u32
id|rx_mode
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rx_mode
op_assign
id|RxFilterEnable
op_or
id|AcceptBroadcast
op_or
id|AcceptAllMulticast
op_or
id|AcceptAllPhys
op_or
id|AcceptMyPhys
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
id|rx_mode
op_assign
id|RxFilterEnable
op_or
id|AcceptBroadcast
op_or
id|AcceptAllMulticast
op_or
id|AcceptMyPhys
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
id|set_bit_le
c_func
(paren
id|dp83815_crc
c_func
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_amp
l_int|0x1ff
comma
id|mc_filter
)paren
suffix:semicolon
)brace
id|rx_mode
op_assign
id|RxFilterEnable
op_or
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptMyPhys
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|writew
c_func
(paren
id|HASH_TABLE
op_plus
id|i
comma
id|ioaddr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|writew
c_func
(paren
(paren
id|mc_filter
(braket
id|i
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|mc_filter
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|RxFilterData
)paren
suffix:semicolon
)brace
)brace
id|writel
c_func
(paren
id|rx_mode
comma
id|ioaddr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|np-&gt;cur_rx_mode
op_assign
id|rx_mode
suffix:semicolon
)brace
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
id|__set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|netdev_ethtool_ioctl
r_static
r_int
id|netdev_ethtool_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|useraddr
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|cmd
comma
(paren
id|u32
op_star
)paren
id|useraddr
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* get driver info */
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
r_struct
id|ethtool_drvinfo
id|info
op_assign
(brace
id|ETHTOOL_GDRVINFO
)brace
suffix:semicolon
id|strncpy
c_func
(paren
id|info.driver
comma
id|DRV_NAME
comma
id|ETHTOOL_BUSINFO_LEN
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.version
comma
id|DRV_VERSION
comma
id|ETHTOOL_BUSINFO_LEN
)paren
suffix:semicolon
id|info.fw_version
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|info.bus_info
comma
id|np-&gt;pci_dev-&gt;slot_name
comma
id|ETHTOOL_BUSINFO_LEN
)paren
suffix:semicolon
id|info.eedump_len
op_assign
id|NATSEMI_EEPROM_SIZE
suffix:semicolon
id|info.regdump_len
op_assign
id|NATSEMI_REGS_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get settings */
r_case
id|ETHTOOL_GSET
suffix:colon
(brace
r_struct
id|ethtool_cmd
id|ecmd
op_assign
(brace
id|ETHTOOL_GSET
)brace
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|netdev_get_ecmd
c_func
(paren
id|dev
comma
op_amp
id|ecmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|ecmd
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set settings */
r_case
id|ETHTOOL_SSET
suffix:colon
(brace
r_struct
id|ethtool_cmd
id|ecmd
suffix:semicolon
r_int
id|r
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ecmd
comma
id|useraddr
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|r
op_assign
id|netdev_set_ecmd
c_func
(paren
id|dev
comma
op_amp
id|ecmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* get wake-on-lan */
r_case
id|ETHTOOL_GWOL
suffix:colon
(brace
r_struct
id|ethtool_wolinfo
id|wol
op_assign
(brace
id|ETHTOOL_GWOL
)brace
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|netdev_get_wol
c_func
(paren
id|dev
comma
op_amp
id|wol.supported
comma
op_amp
id|wol.wolopts
)paren
suffix:semicolon
id|netdev_get_sopass
c_func
(paren
id|dev
comma
id|wol.sopass
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|wol
comma
r_sizeof
(paren
id|wol
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set wake-on-lan */
r_case
id|ETHTOOL_SWOL
suffix:colon
(brace
r_struct
id|ethtool_wolinfo
id|wol
suffix:semicolon
r_int
id|r
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|wol
comma
id|useraddr
comma
r_sizeof
(paren
id|wol
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|netdev_set_wol
c_func
(paren
id|dev
comma
id|wol.wolopts
)paren
suffix:semicolon
id|r
op_assign
id|netdev_set_sopass
c_func
(paren
id|dev
comma
id|wol.sopass
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* get registers */
r_case
id|ETHTOOL_GREGS
suffix:colon
(brace
r_struct
id|ethtool_regs
id|regs
suffix:semicolon
id|u8
id|regbuf
(braket
id|NATSEMI_REGS_SIZE
)braket
suffix:semicolon
r_int
id|r
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|regs
comma
id|useraddr
comma
r_sizeof
(paren
id|regs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|regs.len
OG
id|NATSEMI_REGS_SIZE
)paren
(brace
id|regs.len
op_assign
id|NATSEMI_REGS_SIZE
suffix:semicolon
)brace
id|regs.version
op_assign
id|NATSEMI_REGS_VER
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|useraddr
op_add_assign
m_offsetof
(paren
r_struct
id|ethtool_regs
comma
id|data
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|r
op_assign
id|netdev_get_regs
c_func
(paren
id|dev
comma
id|regbuf
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
id|regbuf
comma
id|regs.len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get message-level */
r_case
id|ETHTOOL_GMSGLVL
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GMSGLVL
)brace
suffix:semicolon
id|edata.data
op_assign
id|np-&gt;msg_enable
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set message-level */
r_case
id|ETHTOOL_SMSGLVL
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|edata
comma
id|useraddr
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|np-&gt;msg_enable
op_assign
id|edata.data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* restart autonegotiation */
r_case
id|ETHTOOL_NWAY_RST
suffix:colon
(brace
r_int
id|tmp
suffix:semicolon
r_int
id|r
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* if autoneg is off, it&squot;s an error */
id|tmp
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|BMCR_ANENABLE
)paren
(brace
id|tmp
op_or_assign
(paren
id|BMCR_ANRESTART
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMCR
comma
id|tmp
)paren
suffix:semicolon
id|r
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* get link status */
r_case
id|ETHTOOL_GLINK
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GLINK
)brace
suffix:semicolon
multiline_comment|/* LSTATUS is latched low until a read - so read twice */
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMSR
)paren
suffix:semicolon
id|edata.data
op_assign
(paren
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMSR
)paren
op_amp
id|BMSR_LSTATUS
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get EEPROM */
r_case
id|ETHTOOL_GEEPROM
suffix:colon
(brace
r_struct
id|ethtool_eeprom
id|eeprom
suffix:semicolon
id|u8
id|eebuf
(braket
id|NATSEMI_EEPROM_SIZE
)braket
suffix:semicolon
r_int
id|r
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|eeprom
comma
id|useraddr
comma
r_sizeof
(paren
id|eeprom
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|eeprom.offset
OG
id|eeprom.offset
op_plus
id|eeprom.len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|eeprom.offset
op_plus
id|eeprom.len
)paren
OG
id|NATSEMI_EEPROM_SIZE
)paren
(brace
id|eeprom.len
op_assign
id|NATSEMI_EEPROM_SIZE
op_minus
id|eeprom.offset
suffix:semicolon
)brace
id|eeprom.magic
op_assign
id|PCI_VENDOR_ID_NS
op_or
(paren
id|PCI_DEVICE_ID_NS_83815
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|eeprom
comma
r_sizeof
(paren
id|eeprom
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|useraddr
op_add_assign
m_offsetof
(paren
r_struct
id|ethtool_eeprom
comma
id|data
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|r
op_assign
id|netdev_get_eeprom
c_func
(paren
id|dev
comma
id|eebuf
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
id|eebuf
op_plus
id|eeprom.offset
comma
id|eeprom.len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|netdev_set_wol
r_static
r_int
id|netdev_set_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|newval
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|data
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|WOLCmd
)paren
op_amp
op_complement
id|WakeOptsSummary
suffix:semicolon
multiline_comment|/* translate to bitmasks this chip understands */
r_if
c_cond
(paren
id|newval
op_amp
id|WAKE_PHY
)paren
id|data
op_or_assign
id|WakePhy
suffix:semicolon
r_if
c_cond
(paren
id|newval
op_amp
id|WAKE_UCAST
)paren
id|data
op_or_assign
id|WakeUnicast
suffix:semicolon
r_if
c_cond
(paren
id|newval
op_amp
id|WAKE_MCAST
)paren
id|data
op_or_assign
id|WakeMulticast
suffix:semicolon
r_if
c_cond
(paren
id|newval
op_amp
id|WAKE_BCAST
)paren
id|data
op_or_assign
id|WakeBroadcast
suffix:semicolon
r_if
c_cond
(paren
id|newval
op_amp
id|WAKE_ARP
)paren
id|data
op_or_assign
id|WakeArp
suffix:semicolon
r_if
c_cond
(paren
id|newval
op_amp
id|WAKE_MAGIC
)paren
id|data
op_or_assign
id|WakeMagic
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;srr
op_ge
id|SRR_DP83815_D
)paren
(brace
r_if
c_cond
(paren
id|newval
op_amp
id|WAKE_MAGICSECURE
)paren
(brace
id|data
op_or_assign
id|WakeMagicSecure
suffix:semicolon
)brace
)brace
id|writel
c_func
(paren
id|data
comma
id|dev-&gt;base_addr
op_plus
id|WOLCmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_get_wol
r_static
r_int
id|netdev_get_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|supported
comma
id|u32
op_star
id|cur
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|regval
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|WOLCmd
)paren
suffix:semicolon
op_star
id|supported
op_assign
(paren
id|WAKE_PHY
op_or
id|WAKE_UCAST
op_or
id|WAKE_MCAST
op_or
id|WAKE_BCAST
op_or
id|WAKE_ARP
op_or
id|WAKE_MAGIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;srr
op_ge
id|SRR_DP83815_D
)paren
(brace
multiline_comment|/* SOPASS works on revD and higher */
op_star
id|supported
op_or_assign
id|WAKE_MAGICSECURE
suffix:semicolon
)brace
op_star
id|cur
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* translate from chip bitmasks */
r_if
c_cond
(paren
id|regval
op_amp
id|WakePhy
)paren
op_star
id|cur
op_or_assign
id|WAKE_PHY
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
id|WakeUnicast
)paren
op_star
id|cur
op_or_assign
id|WAKE_UCAST
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
id|WakeMulticast
)paren
op_star
id|cur
op_or_assign
id|WAKE_MCAST
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
id|WakeBroadcast
)paren
op_star
id|cur
op_or_assign
id|WAKE_BCAST
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
id|WakeArp
)paren
op_star
id|cur
op_or_assign
id|WAKE_ARP
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
id|WakeMagic
)paren
op_star
id|cur
op_or_assign
id|WAKE_MAGIC
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
id|WakeMagicSecure
)paren
(brace
multiline_comment|/* this can be on in revC, but it&squot;s broken */
op_star
id|cur
op_or_assign
id|WAKE_MAGICSECURE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_set_sopass
r_static
r_int
id|netdev_set_sopass
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|newval
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u16
op_star
id|sval
op_assign
(paren
id|u16
op_star
)paren
id|newval
suffix:semicolon
id|u32
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;srr
OL
id|SRR_DP83815_D
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* enable writing to these registers by disabling the RX filter */
id|addr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
op_amp
op_complement
id|RFCRAddressMask
suffix:semicolon
id|addr
op_and_assign
op_complement
id|RxFilterEnable
suffix:semicolon
id|writel
c_func
(paren
id|addr
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
multiline_comment|/* write the three words to (undocumented) RFCR vals 0xa, 0xc, 0xe */
id|writel
c_func
(paren
id|addr
op_or
l_int|0xa
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|sval
(braket
l_int|0
)braket
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
id|writel
c_func
(paren
id|addr
op_or
l_int|0xc
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|sval
(braket
l_int|1
)braket
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
id|writel
c_func
(paren
id|addr
op_or
l_int|0xe
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|sval
(braket
l_int|2
)braket
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
multiline_comment|/* re-enable the RX filter */
id|writel
c_func
(paren
id|addr
op_or
id|RxFilterEnable
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_get_sopass
r_static
r_int
id|netdev_get_sopass
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|data
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u16
op_star
id|sval
op_assign
(paren
id|u16
op_star
)paren
id|data
suffix:semicolon
id|u32
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;srr
OL
id|SRR_DP83815_D
)paren
(brace
id|sval
(braket
l_int|0
)braket
op_assign
id|sval
(braket
l_int|1
)braket
op_assign
id|sval
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* read the three words from (undocumented) RFCR vals 0xa, 0xc, 0xe */
id|addr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
op_amp
op_complement
id|RFCRAddressMask
suffix:semicolon
id|writel
c_func
(paren
id|addr
op_or
l_int|0xa
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|sval
(braket
l_int|0
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
id|writel
c_func
(paren
id|addr
op_or
l_int|0xc
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|sval
(braket
l_int|1
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
id|writel
c_func
(paren
id|addr
op_or
l_int|0xe
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|sval
(braket
l_int|2
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
id|writel
c_func
(paren
id|addr
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_get_ecmd
r_static
r_int
id|netdev_get_ecmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|ecmd
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|ecmd-&gt;supported
op_assign
(paren
id|SUPPORTED_10baseT_Half
op_or
id|SUPPORTED_10baseT_Full
op_or
id|SUPPORTED_100baseT_Half
op_or
id|SUPPORTED_100baseT_Full
op_or
id|SUPPORTED_Autoneg
op_or
id|SUPPORTED_TP
op_or
id|SUPPORTED_MII
)paren
suffix:semicolon
multiline_comment|/* only supports twisted-pair or MII */
id|tmp
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ChipConfig
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|CfgExtPhy
)paren
id|ecmd-&gt;port
op_assign
id|PORT_MII
suffix:semicolon
r_else
id|ecmd-&gt;port
op_assign
id|PORT_TP
suffix:semicolon
multiline_comment|/* only supports internal transceiver */
id|ecmd-&gt;transceiver
op_assign
id|XCVR_INTERNAL
suffix:semicolon
multiline_comment|/* not sure what this is for */
id|ecmd-&gt;phy_address
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|PhyCtrl
)paren
op_amp
id|PhyAddrMask
suffix:semicolon
id|ecmd-&gt;advertising
op_assign
id|ADVERTISED_TP
op_or
id|ADVERTISED_MII
suffix:semicolon
id|tmp
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|ADVERTISE_10HALF
)paren
id|ecmd-&gt;advertising
op_or_assign
id|ADVERTISED_10baseT_Half
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|ADVERTISE_10FULL
)paren
id|ecmd-&gt;advertising
op_or_assign
id|ADVERTISED_10baseT_Full
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|ADVERTISE_100HALF
)paren
id|ecmd-&gt;advertising
op_or_assign
id|ADVERTISED_100baseT_Half
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|ADVERTISE_100FULL
)paren
id|ecmd-&gt;advertising
op_or_assign
id|ADVERTISED_100baseT_Full
suffix:semicolon
id|tmp
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|BMCR_ANENABLE
)paren
(brace
id|ecmd-&gt;advertising
op_or_assign
id|ADVERTISED_Autoneg
suffix:semicolon
id|ecmd-&gt;autoneg
op_assign
id|AUTONEG_ENABLE
suffix:semicolon
)brace
r_else
(brace
id|ecmd-&gt;autoneg
op_assign
id|AUTONEG_DISABLE
suffix:semicolon
)brace
id|tmp
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|ChipConfig
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|CfgSpeed100
)paren
(brace
id|ecmd-&gt;speed
op_assign
id|SPEED_100
suffix:semicolon
)brace
r_else
(brace
id|ecmd-&gt;speed
op_assign
id|SPEED_10
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp
op_amp
id|CfgFullDuplex
)paren
(brace
id|ecmd-&gt;duplex
op_assign
id|DUPLEX_FULL
suffix:semicolon
)brace
r_else
(brace
id|ecmd-&gt;duplex
op_assign
id|DUPLEX_HALF
suffix:semicolon
)brace
multiline_comment|/* ignore maxtxpkt, maxrxpkt for now */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_set_ecmd
r_static
r_int
id|netdev_set_ecmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|ecmd
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|ecmd-&gt;speed
op_ne
id|SPEED_10
op_logical_and
id|ecmd-&gt;speed
op_ne
id|SPEED_100
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ecmd-&gt;duplex
op_ne
id|DUPLEX_HALF
op_logical_and
id|ecmd-&gt;duplex
op_ne
id|DUPLEX_FULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ecmd-&gt;port
op_ne
id|PORT_TP
op_logical_and
id|ecmd-&gt;port
op_ne
id|PORT_MII
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ecmd-&gt;transceiver
op_ne
id|XCVR_INTERNAL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ecmd-&gt;autoneg
op_ne
id|AUTONEG_DISABLE
op_logical_and
id|ecmd-&gt;autoneg
op_ne
id|AUTONEG_ENABLE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* ignore phy_address, maxtxpkt, maxrxpkt for now */
multiline_comment|/* WHEW! now lets bang some bits */
id|tmp
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ecmd-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
)paren
(brace
multiline_comment|/* turn on autonegotiation */
id|tmp
op_or_assign
id|BMCR_ANENABLE
suffix:semicolon
id|np-&gt;advertising
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* turn off auto negotiation, set speed and duplexity */
id|tmp
op_and_assign
op_complement
(paren
id|BMCR_ANENABLE
op_or
id|BMCR_SPEED100
op_or
id|BMCR_FULLDPLX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ecmd-&gt;speed
op_eq
id|SPEED_100
)paren
id|tmp
op_or_assign
id|BMCR_SPEED100
suffix:semicolon
r_if
c_cond
(paren
id|ecmd-&gt;duplex
op_eq
id|DUPLEX_FULL
)paren
id|tmp
op_or_assign
id|BMCR_FULLDPLX
suffix:semicolon
r_else
id|np-&gt;full_duplex
op_assign
l_int|0
suffix:semicolon
)brace
id|mdio_write
c_func
(paren
id|dev
comma
l_int|1
comma
id|MII_BMCR
comma
id|tmp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_get_regs
r_static
r_int
id|netdev_get_regs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|buf
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
id|u32
id|rfcr
suffix:semicolon
id|u32
op_star
id|rbuf
op_assign
(paren
id|u32
op_star
)paren
id|buf
suffix:semicolon
multiline_comment|/* read all of page 0 of registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NATSEMI_PG0_NREGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rbuf
(braket
id|i
)braket
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* read only the &squot;magic&squot; registers from page 1 */
id|writew
c_func
(paren
l_int|1
comma
id|dev-&gt;base_addr
op_plus
id|PGSEL
)paren
suffix:semicolon
id|rbuf
(braket
id|i
op_increment
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|PMDCSR
)paren
suffix:semicolon
id|rbuf
(braket
id|i
op_increment
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|TSTDAT
)paren
suffix:semicolon
id|rbuf
(braket
id|i
op_increment
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|DSPCFG
)paren
suffix:semicolon
id|rbuf
(braket
id|i
op_increment
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|SDCFG
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|PGSEL
)paren
suffix:semicolon
multiline_comment|/* read RFCR indexed registers */
id|rfcr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NATSEMI_RFDR_NREGS
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
id|j
op_star
l_int|2
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
id|rbuf
(braket
id|i
op_increment
)braket
op_assign
id|readw
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|RxFilterData
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|rfcr
comma
id|dev-&gt;base_addr
op_plus
id|RxFilterAddr
)paren
suffix:semicolon
multiline_comment|/* the interrupt status is clear-on-read - see if we missed any */
r_if
c_cond
(paren
id|rbuf
(braket
l_int|4
)braket
op_amp
id|rbuf
(braket
l_int|5
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: shoot, we dropped an interrupt (%#08x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rbuf
(braket
l_int|4
)braket
op_amp
id|rbuf
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|SWAP_BITS
mdefine_line|#define SWAP_BITS(x)&t;( (((x) &amp; 0x0001) &lt;&lt; 15) | (((x) &amp; 0x0002) &lt;&lt; 13) &bslash;&n;&t;&t;&t;| (((x) &amp; 0x0004) &lt;&lt; 11) | (((x) &amp; 0x0008) &lt;&lt; 9)  &bslash;&n;&t;&t;&t;| (((x) &amp; 0x0010) &lt;&lt; 7)  | (((x) &amp; 0x0020) &lt;&lt; 5)  &bslash;&n;&t;&t;&t;| (((x) &amp; 0x0040) &lt;&lt; 3)  | (((x) &amp; 0x0080) &lt;&lt; 1)  &bslash;&n;&t;&t;&t;| (((x) &amp; 0x0100) &gt;&gt; 1)  | (((x) &amp; 0x0200) &gt;&gt; 3)  &bslash;&n;&t;&t;&t;| (((x) &amp; 0x0400) &gt;&gt; 5)  | (((x) &amp; 0x0800) &gt;&gt; 7)  &bslash;&n;&t;&t;&t;| (((x) &amp; 0x1000) &gt;&gt; 9)  | (((x) &amp; 0x2000) &gt;&gt; 11) &bslash;&n;&t;&t;&t;| (((x) &amp; 0x4000) &gt;&gt; 13) | (((x) &amp; 0x8000) &gt;&gt; 15) )
DECL|function|netdev_get_eeprom
r_static
r_int
id|netdev_get_eeprom
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|buf
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
op_star
id|ebuf
op_assign
(paren
id|u16
op_star
)paren
id|buf
suffix:semicolon
multiline_comment|/* eeprom_read reads 16 bits, and indexes by 16 bits */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NATSEMI_EEPROM_SIZE
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ebuf
(braket
id|i
)braket
op_assign
id|eeprom_read
c_func
(paren
id|dev-&gt;base_addr
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* The EEPROM itself stores data bit-swapped, but eeprom_read &n;&t;&t; * reads it back &quot;sanely&quot;. So we swap it back here in order to&n;&t;&t; * present it to userland as it is stored. */
id|ebuf
(braket
id|i
)braket
op_assign
id|SWAP_BITS
c_func
(paren
id|ebuf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_ioctl
r_static
r_int
id|netdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|mii_ioctl_data
op_star
id|data
op_assign
(paren
r_struct
id|mii_ioctl_data
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
r_return
id|netdev_ethtool_ioctl
c_func
(paren
id|dev
comma
(paren
r_void
op_star
)paren
id|rq-&gt;ifr_data
)paren
suffix:semicolon
r_case
id|SIOCGMIIPHY
suffix:colon
multiline_comment|/* Get address of MII PHY in use. */
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* for binary compat, remove in 2.5 */
id|data-&gt;phy_id
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Fall Through */
r_case
id|SIOCGMIIREG
suffix:colon
multiline_comment|/* Read MII PHY register. */
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* for binary compat, remove in 2.5 */
id|data-&gt;val_out
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|data-&gt;phy_id
op_amp
l_int|0x1f
comma
id|data-&gt;reg_num
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCSMIIREG
suffix:colon
multiline_comment|/* Write MII PHY register. */
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* for binary compat, remove in 2.5 */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|data-&gt;phy_id
op_amp
l_int|0x1f
comma
id|data-&gt;reg_num
op_amp
l_int|0x1f
comma
id|data-&gt;val_in
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|enable_wol_mode
r_static
r_void
id|enable_wol_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|enable_intr
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_wol
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: remaining active for wake-on-lan&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* For WOL we must restart the rx process in silent mode.&n;&t; * Write NULL to the RxRingPtr. Only possible if&n;&t; * rx process is stopped&n;&t; */
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RxRingPtr
)paren
suffix:semicolon
multiline_comment|/* read WoL status to clear */
id|readl
c_func
(paren
id|ioaddr
op_plus
id|WOLCmd
)paren
suffix:semicolon
multiline_comment|/* PME on, clear status */
id|writel
c_func
(paren
id|np-&gt;SavedClkRun
op_or
id|PMEEnable
op_or
id|PMEStatus
comma
id|ioaddr
op_plus
id|ClkRun
)paren
suffix:semicolon
multiline_comment|/* and restart the rx process */
id|writel
c_func
(paren
id|RxOn
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable_intr
)paren
(brace
multiline_comment|/* enable the WOL interrupt.&n;&t;&t; * Could be used to send a netlink message.&n;&t;&t; */
id|writel
c_func
(paren
id|WOLPkt
op_or
id|LinkChange
comma
id|ioaddr
op_plus
id|IntrMask
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|1
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
)brace
)brace
DECL|function|netdev_close
r_static
r_int
id|netdev_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_ifdown
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard, status was %#04x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_pktdata
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Queue pointers were Tx %d / %d,  Rx %d / %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;cur_tx
comma
id|np-&gt;dirty_tx
comma
id|np-&gt;cur_rx
comma
id|np-&gt;dirty_rx
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Disable and clear interrupts */
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
id|readl
c_func
(paren
id|ioaddr
op_plus
id|IntrMask
)paren
suffix:semicolon
id|readw
c_func
(paren
id|ioaddr
op_plus
id|MIntrStatus
)paren
suffix:semicolon
multiline_comment|/* Freeze Stats */
id|writel
c_func
(paren
id|StatsFreeze
comma
id|ioaddr
op_plus
id|StatsCtrl
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|natsemi_stop_rxtx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|__get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* race: shared irq and as most nics the DP83815&n;&t; * reports _all_ interrupt conditions in IntrStatus, even&n;&t; * disabled ones.&n;&t; * packet received after disable_irq, but before stop_rxtx&n;&t; * --&gt; race. intr_handler would restart the rx process.&n;&t; * netif_device_{de,a}tach around {enable,free}_irq.&n;&t; */
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* clear the carrier last - an interrupt could reenable it otherwise */
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dump_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|drain_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
(brace
id|u32
id|wol
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|WOLCmd
)paren
op_amp
id|WakeOptsSummary
suffix:semicolon
r_if
c_cond
(paren
id|wol
)paren
(brace
multiline_comment|/* restart the NIC in WOL mode.&n;&t;&t;&t; * The nic must be stopped for this.&n;&t;&t;&t; */
id|enable_wol_mode
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Restore PME enable bit unmolested */
id|writel
c_func
(paren
id|np-&gt;SavedClkRun
comma
id|ioaddr
op_plus
id|ClkRun
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
DECL|function|natsemi_remove1
r_static
r_void
id|__devexit
id|natsemi_remove1
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|unregister_netdev
(paren
id|dev
)paren
suffix:semicolon
id|pci_release_regions
(paren
id|pdev
)paren
suffix:semicolon
id|iounmap
(paren
(paren
r_char
op_star
)paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
multiline_comment|/*&n; * suspend/resume synchronization:&n; * entry points:&n; *   netdev_open, netdev_close, netdev_ioctl, set_rx_mode, intr_handler,&n; *   start_tx, tx_timeout&n; * Reading from some registers can restart the nic!&n; * No function accesses the hardware without checking netif_device_present().&n; * &t;the check occurs under spin_lock_irq(&amp;np-&gt;lock);&n; * exceptions:&n; * &t;* netdev_ioctl, netdev_open.&n; * &t;&t;net/core checks netif_device_present() before calling them.&n; * &t;* netdev_close: doesn&squot;t hurt.&n; *&t;* netdev_timer: timer stopped by natsemi_suspend.&n; *&t;* intr_handler: doesn&squot;t acquire the spinlock. suspend calls&n; *&t;&t;disable_irq() to enforce synchronization.&n; *&n; * netif_device_detach must occur under spin_unlock_irq(), interrupts from a&n; * detached device would cause an irq storm.&n; */
DECL|function|natsemi_suspend
r_static
r_int
id|natsemi_suspend
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
(paren
id|dev
)paren
)paren
(brace
id|del_timer_sync
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
id|natsemi_stop_rxtx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Update the error counts. */
id|__get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* pci_power_off(pdev, -1); */
id|drain_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
(brace
id|u32
id|wol
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|WOLCmd
)paren
op_amp
id|WakeOptsSummary
suffix:semicolon
multiline_comment|/* Restore PME enable bit */
r_if
c_cond
(paren
id|wol
)paren
(brace
multiline_comment|/* restart the NIC in WOL mode.&n;&t;&t;&t;&t; * The nic must be stopped for this.&n;&t;&t;&t;&t; * FIXME: use the WOL interupt &n;&t;&t;&t;&t; */
id|enable_wol_mode
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Restore PME enable bit unmolested */
id|writel
c_func
(paren
id|np-&gt;SavedClkRun
comma
id|ioaddr
op_plus
id|ClkRun
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|natsemi_resume
r_static
r_int
id|natsemi_resume
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/*&t;pci_power_on(pdev); */
id|natsemi_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|init_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|np-&gt;timer
comma
id|jiffies
op_plus
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_else
(brace
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PM */
DECL|variable|natsemi_driver
r_static
r_struct
id|pci_driver
id|natsemi_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|id_table
op_assign
id|natsemi_pci_tbl
comma
dot
id|probe
op_assign
id|natsemi_probe1
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|natsemi_remove1
)paren
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|natsemi_suspend
comma
dot
id|resume
op_assign
id|natsemi_resume
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|function|natsemi_init_mod
r_static
r_int
id|__init
id|natsemi_init_mod
(paren
r_void
)paren
(brace
multiline_comment|/* when a module, this is printed whether or not devices are found in probe */
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
(paren
op_amp
id|natsemi_driver
)paren
suffix:semicolon
)brace
DECL|function|natsemi_exit_mod
r_static
r_void
id|__exit
id|natsemi_exit_mod
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|natsemi_driver
)paren
suffix:semicolon
)brace
DECL|variable|natsemi_init_mod
id|module_init
c_func
(paren
id|natsemi_init_mod
)paren
suffix:semicolon
DECL|variable|natsemi_exit_mod
id|module_exit
c_func
(paren
id|natsemi_exit_mod
)paren
suffix:semicolon
eof
