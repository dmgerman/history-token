multiline_comment|/* File veth.c created by Kyle A. Lucke on Mon Aug  7 2000. */
multiline_comment|/*&n; * IBM eServer iSeries Virtual Ethernet Device Driver&n; * Copyright (C) 2001 Kyle A. Lucke (klucke@us.ibm.com), IBM Corp.&n; * Substantially cleaned up by:&n; * Copyright (C) 2003 David Gibson &lt;dwg@au1.ibm.com&gt;, IBM Corporation.&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as&n; * published by the Free Software Foundation; either version 2 of the&n; * License, or (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307&n; * USA&n; *&n; *&n; * This module implements the virtual ethernet device for iSeries LPAR&n; * Linux.  It uses hypervisor message passing to implement an&n; * ethernet-like network device communicating between partitions on&n; * the iSeries.&n; *&n; * The iSeries LPAR hypervisor currently allows for up to 16 different&n; * virtual ethernets.  These are all dynamically configurable on&n; * OS/400 partitions, but dynamic configuration is not supported under&n; * Linux yet.  An ethXX network device will be created for each&n; * virtual ethernet this partition is connected to.&n; *&n; * - This driver is responsible for routing packets to and from other&n; *   partitions.  The MAC addresses used by the virtual ethernets&n; *   contains meaning and must not be modified.&n; *&n; * - Having 2 virtual ethernets to the same remote partition DOES NOT&n; *   double the available bandwidth.  The 2 devices will share the&n; *   available hypervisor bandwidth.&n; *&n; * - If you send a packet to your own mac address, it will just be&n; *   dropped, you won&squot;t get it on the receive side.&n; *&n; * - Multicast is implemented by sending the frame frame to every&n; *   other partition.  It is the responsibility of the receiving&n; *   partition to filter the addresses desired.&n; *&n; * Tunable parameters:&n; *&n; * VETH_NUMBUFFERS: This compile time option defaults to 120.  It&n; * controls how much memory Linux will allocate per remote partition&n; * it is communicating with.  It can be thought of as the maximum&n; * number of packets outstanding to a remote partition at a time.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;asm/iSeries/mf.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_pci.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/iSeries/HvLpConfig.h&gt;
macro_line|#include &lt;asm/iSeries/HvTypes.h&gt;
macro_line|#include &lt;asm/iSeries/HvLpEvent.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/vio.h&gt;
macro_line|#include &quot;iseries_veth.h&quot;
r_extern
r_struct
id|vio_dev
op_star
id|iSeries_veth_dev
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Kyle Lucke &lt;klucke@us.ibm.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;iSeries Virtual ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|VETH_NUMBUFFERS
mdefine_line|#define VETH_NUMBUFFERS&t;&t;(120)
DECL|macro|VETH_ACKTIMEOUT
mdefine_line|#define VETH_ACKTIMEOUT &t;(1000000) /* microseconds */
DECL|macro|VETH_MAX_MCAST
mdefine_line|#define VETH_MAX_MCAST&t;&t;(12)
DECL|macro|VETH_MAX_MTU
mdefine_line|#define VETH_MAX_MTU&t;&t;(9000)
macro_line|#if VETH_NUMBUFFERS &lt; 10
DECL|macro|ACK_THRESHOLD
mdefine_line|#define ACK_THRESHOLD &t;&t;(1)
macro_line|#elif VETH_NUMBUFFERS &lt; 20
DECL|macro|ACK_THRESHOLD
mdefine_line|#define ACK_THRESHOLD &t;&t;(4)
macro_line|#elif VETH_NUMBUFFERS &lt; 40
DECL|macro|ACK_THRESHOLD
mdefine_line|#define ACK_THRESHOLD &t;&t;(10)
macro_line|#else
DECL|macro|ACK_THRESHOLD
mdefine_line|#define ACK_THRESHOLD &t;&t;(20)
macro_line|#endif
DECL|macro|VETH_STATE_SHUTDOWN
mdefine_line|#define&t;VETH_STATE_SHUTDOWN&t;(0x0001)
DECL|macro|VETH_STATE_OPEN
mdefine_line|#define VETH_STATE_OPEN&t;&t;(0x0002)
DECL|macro|VETH_STATE_RESET
mdefine_line|#define VETH_STATE_RESET&t;(0x0004)
DECL|macro|VETH_STATE_SENTMON
mdefine_line|#define VETH_STATE_SENTMON&t;(0x0008)
DECL|macro|VETH_STATE_SENTCAPS
mdefine_line|#define VETH_STATE_SENTCAPS&t;(0x0010)
DECL|macro|VETH_STATE_GOTCAPACK
mdefine_line|#define VETH_STATE_GOTCAPACK&t;(0x0020)
DECL|macro|VETH_STATE_GOTCAPS
mdefine_line|#define VETH_STATE_GOTCAPS&t;(0x0040)
DECL|macro|VETH_STATE_SENTCAPACK
mdefine_line|#define VETH_STATE_SENTCAPACK&t;(0x0080)
DECL|macro|VETH_STATE_READY
mdefine_line|#define VETH_STATE_READY&t;(0x0100)
DECL|struct|veth_msg
r_struct
id|veth_msg
(brace
DECL|member|next
r_struct
id|veth_msg
op_star
id|next
suffix:semicolon
DECL|member|data
r_struct
id|VethFramesData
id|data
suffix:semicolon
DECL|member|token
r_int
id|token
suffix:semicolon
DECL|member|in_use
r_int
r_int
id|in_use
suffix:semicolon
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|veth_lpar_connection
r_struct
id|veth_lpar_connection
(brace
DECL|member|remote_lp
id|HvLpIndex
id|remote_lp
suffix:semicolon
DECL|member|statemachine_wq
r_struct
id|work_struct
id|statemachine_wq
suffix:semicolon
DECL|member|msgs
r_struct
id|veth_msg
op_star
id|msgs
suffix:semicolon
DECL|member|num_events
r_int
id|num_events
suffix:semicolon
DECL|member|local_caps
r_struct
id|VethCapData
id|local_caps
suffix:semicolon
DECL|member|ack_timer
r_struct
id|timer_list
id|ack_timer
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|state
r_int
r_int
id|state
suffix:semicolon
DECL|member|src_inst
id|HvLpInstanceId
id|src_inst
suffix:semicolon
DECL|member|dst_inst
id|HvLpInstanceId
id|dst_inst
suffix:semicolon
DECL|member|cap_event
DECL|member|cap_ack_event
r_struct
id|VethLpEvent
id|cap_event
comma
id|cap_ack_event
suffix:semicolon
DECL|member|pending_acks
id|u16
id|pending_acks
(braket
id|VETH_MAX_ACKS_PER_MSG
)braket
suffix:semicolon
DECL|member|num_pending_acks
id|u32
id|num_pending_acks
suffix:semicolon
DECL|member|num_ack_events
r_int
id|num_ack_events
suffix:semicolon
DECL|member|remote_caps
r_struct
id|VethCapData
id|remote_caps
suffix:semicolon
DECL|member|ack_timeout
id|u32
id|ack_timeout
suffix:semicolon
DECL|member|msg_stack_lock
id|spinlock_t
id|msg_stack_lock
suffix:semicolon
DECL|member|msg_stack_head
r_struct
id|veth_msg
op_star
id|msg_stack_head
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|veth_port
r_struct
id|veth_port
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|mac_addr
id|u64
id|mac_addr
suffix:semicolon
DECL|member|lpar_map
id|HvLpIndexMap
id|lpar_map
suffix:semicolon
DECL|member|pending_gate
id|spinlock_t
id|pending_gate
suffix:semicolon
DECL|member|pending_skb
r_struct
id|sk_buff
op_star
id|pending_skb
suffix:semicolon
DECL|member|pending_lpmask
id|HvLpIndexMap
id|pending_lpmask
suffix:semicolon
DECL|member|mcast_gate
id|rwlock_t
id|mcast_gate
suffix:semicolon
DECL|member|promiscuous
r_int
id|promiscuous
suffix:semicolon
DECL|member|all_mcast
r_int
id|all_mcast
suffix:semicolon
DECL|member|num_mcast
r_int
id|num_mcast
suffix:semicolon
DECL|member|mcast_addr
id|u64
id|mcast_addr
(braket
id|VETH_MAX_MCAST
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|this_lp
r_static
id|HvLpIndex
id|this_lp
suffix:semicolon
DECL|variable|veth_cnx
r_static
r_struct
id|veth_lpar_connection
op_star
id|veth_cnx
(braket
id|HVMAXARCHITECTEDLPS
)braket
suffix:semicolon
multiline_comment|/* = 0 */
DECL|variable|veth_dev
r_static
r_struct
id|net_device
op_star
id|veth_dev
(braket
id|HVMAXARCHITECTEDVIRTUALLANS
)braket
suffix:semicolon
multiline_comment|/* = 0 */
r_static
r_int
id|veth_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|veth_recycle_msg
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
comma
r_struct
id|veth_msg
op_star
)paren
suffix:semicolon
r_static
r_void
id|veth_flush_pending
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
)paren
suffix:semicolon
r_static
r_void
id|veth_receive
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
comma
r_struct
id|VethLpEvent
op_star
)paren
suffix:semicolon
r_static
r_void
id|veth_timed_ack
c_func
(paren
r_int
r_int
id|connectionPtr
)paren
suffix:semicolon
multiline_comment|/*&n; * Utility functions&n; */
DECL|macro|veth_printk
mdefine_line|#define veth_printk(prio, fmt, args...) &bslash;&n;&t;printk(prio &quot;%s: &quot; fmt, __FILE__, ## args)
DECL|macro|veth_error
mdefine_line|#define veth_error(fmt, args...) &bslash;&n;&t;printk(KERN_ERR &quot;(%s:%3.3d) ERROR: &quot; fmt, __FILE__, __LINE__ , ## args)
DECL|function|veth_stack_push
r_static
r_inline
r_void
id|veth_stack_push
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
comma
r_struct
id|veth_msg
op_star
id|msg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;msg_stack_lock
comma
id|flags
)paren
suffix:semicolon
id|msg-&gt;next
op_assign
id|cnx-&gt;msg_stack_head
suffix:semicolon
id|cnx-&gt;msg_stack_head
op_assign
id|msg
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;msg_stack_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|veth_stack_pop
r_static
r_inline
r_struct
id|veth_msg
op_star
id|veth_stack_pop
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|veth_msg
op_star
id|msg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;msg_stack_lock
comma
id|flags
)paren
suffix:semicolon
id|msg
op_assign
id|cnx-&gt;msg_stack_head
suffix:semicolon
r_if
c_cond
(paren
id|msg
)paren
id|cnx-&gt;msg_stack_head
op_assign
id|cnx-&gt;msg_stack_head-&gt;next
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;msg_stack_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|msg
suffix:semicolon
)brace
r_static
r_inline
id|HvLpEvent_Rc
DECL|function|veth_signalevent
id|veth_signalevent
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
comma
id|u16
id|subtype
comma
id|HvLpEvent_AckInd
id|ackind
comma
id|HvLpEvent_AckType
id|acktype
comma
id|u64
id|token
comma
id|u64
id|data1
comma
id|u64
id|data2
comma
id|u64
id|data3
comma
id|u64
id|data4
comma
id|u64
id|data5
)paren
(brace
r_return
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|cnx-&gt;remote_lp
comma
id|HvLpEvent_Type_VirtualLan
comma
id|subtype
comma
id|ackind
comma
id|acktype
comma
id|cnx-&gt;src_inst
comma
id|cnx-&gt;dst_inst
comma
id|token
comma
id|data1
comma
id|data2
comma
id|data3
comma
id|data4
comma
id|data5
)paren
suffix:semicolon
)brace
DECL|function|veth_signaldata
r_static
r_inline
id|HvLpEvent_Rc
id|veth_signaldata
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
comma
id|u16
id|subtype
comma
id|u64
id|token
comma
r_void
op_star
id|data
)paren
(brace
id|u64
op_star
id|p
op_assign
(paren
id|u64
op_star
)paren
id|data
suffix:semicolon
r_return
id|veth_signalevent
c_func
(paren
id|cnx
comma
id|subtype
comma
id|HvLpEvent_AckInd_NoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|token
comma
id|p
(braket
l_int|0
)braket
comma
id|p
(braket
l_int|1
)braket
comma
id|p
(braket
l_int|2
)braket
comma
id|p
(braket
l_int|3
)braket
comma
id|p
(braket
l_int|4
)braket
)paren
suffix:semicolon
)brace
DECL|struct|veth_allocation
r_struct
id|veth_allocation
(brace
DECL|member|c
r_struct
id|completion
id|c
suffix:semicolon
DECL|member|num
r_int
id|num
suffix:semicolon
)brace
suffix:semicolon
DECL|function|veth_complete_allocation
r_static
r_void
id|veth_complete_allocation
c_func
(paren
r_void
op_star
id|parm
comma
r_int
id|number
)paren
(brace
r_struct
id|veth_allocation
op_star
id|vc
op_assign
(paren
r_struct
id|veth_allocation
op_star
)paren
id|parm
suffix:semicolon
id|vc-&gt;num
op_assign
id|number
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|vc-&gt;c
)paren
suffix:semicolon
)brace
DECL|function|veth_allocate_events
r_static
r_int
id|veth_allocate_events
c_func
(paren
id|HvLpIndex
id|rlp
comma
r_int
id|number
)paren
(brace
r_struct
id|veth_allocation
id|vc
op_assign
(brace
id|COMPLETION_INITIALIZER
c_func
(paren
id|vc.c
)paren
comma
l_int|0
)brace
suffix:semicolon
id|mf_allocateLpEvents
c_func
(paren
id|rlp
comma
id|HvLpEvent_Type_VirtualLan
comma
r_sizeof
(paren
r_struct
id|VethLpEvent
)paren
comma
id|number
comma
op_amp
id|veth_complete_allocation
comma
op_amp
id|vc
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|vc.c
)paren
suffix:semicolon
r_return
id|vc.num
suffix:semicolon
)brace
multiline_comment|/*&n; * LPAR connection code&n; */
DECL|function|veth_kick_statemachine
r_static
r_inline
r_void
id|veth_kick_statemachine
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
)paren
(brace
id|schedule_work
c_func
(paren
op_amp
id|cnx-&gt;statemachine_wq
)paren
suffix:semicolon
)brace
DECL|function|veth_take_cap
r_static
r_void
id|veth_take_cap
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
comma
r_struct
id|VethLpEvent
op_star
id|event
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Receiving caps may mean the other end has just come up, so&n;&t; * we need to reload the instance ID of the far end */
id|cnx-&gt;dst_inst
op_assign
id|HvCallEvent_getTargetLpInstanceId
c_func
(paren
id|cnx-&gt;remote_lp
comma
id|HvLpEvent_Type_VirtualLan
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_GOTCAPS
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;Received a second capabilities from lpar %d&bslash;n&quot;
comma
id|cnx-&gt;remote_lp
)paren
suffix:semicolon
id|event-&gt;base_event.xRc
op_assign
id|HvLpEvent_Rc_BufferNotAvailable
suffix:semicolon
id|HvCallEvent_ackLpEvent
c_func
(paren
(paren
r_struct
id|HvLpEvent
op_star
)paren
id|event
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|cnx-&gt;cap_event
comma
id|event
comma
r_sizeof
(paren
id|cnx-&gt;cap_event
)paren
)paren
suffix:semicolon
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_GOTCAPS
suffix:semicolon
id|veth_kick_statemachine
c_func
(paren
id|cnx
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|veth_take_cap_ack
r_static
r_void
id|veth_take_cap_ack
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
comma
r_struct
id|VethLpEvent
op_star
id|event
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_GOTCAPACK
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;Received a second capabilities ack from lpar %d&bslash;n&quot;
comma
id|cnx-&gt;remote_lp
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|cnx-&gt;cap_ack_event
comma
id|event
comma
r_sizeof
(paren
op_amp
id|cnx-&gt;cap_ack_event
)paren
)paren
suffix:semicolon
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_GOTCAPACK
suffix:semicolon
id|veth_kick_statemachine
c_func
(paren
id|cnx
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|veth_take_monitor_ack
r_static
r_void
id|veth_take_monitor_ack
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
comma
r_struct
id|VethLpEvent
op_star
id|event
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|veth_printk
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Monitor ack returned for lpar %d&bslash;n&quot;
comma
id|cnx-&gt;remote_lp
)paren
suffix:semicolon
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_RESET
suffix:semicolon
id|veth_kick_statemachine
c_func
(paren
id|cnx
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|veth_handle_ack
r_static
r_void
id|veth_handle_ack
c_func
(paren
r_struct
id|VethLpEvent
op_star
id|event
)paren
(brace
id|HvLpIndex
id|rlp
op_assign
id|event-&gt;base_event.xTargetLp
suffix:semicolon
r_struct
id|veth_lpar_connection
op_star
id|cnx
op_assign
id|veth_cnx
(braket
id|rlp
)braket
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|cnx
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event-&gt;base_event.xSubtype
)paren
(brace
r_case
id|VethEventTypeCap
suffix:colon
id|veth_take_cap_ack
c_func
(paren
id|cnx
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VethEventTypeMonitor
suffix:colon
id|veth_take_monitor_ack
c_func
(paren
id|cnx
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|veth_error
c_func
(paren
l_string|&quot;Unknown ack type %d from lpar %d&bslash;n&quot;
comma
id|event-&gt;base_event.xSubtype
comma
id|rlp
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
DECL|function|veth_handle_int
r_static
r_void
id|veth_handle_int
c_func
(paren
r_struct
id|VethLpEvent
op_star
id|event
)paren
(brace
id|HvLpIndex
id|rlp
op_assign
id|event-&gt;base_event.xSourceLp
suffix:semicolon
r_struct
id|veth_lpar_connection
op_star
id|cnx
op_assign
id|veth_cnx
(braket
id|rlp
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|cnx
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event-&gt;base_event.xSubtype
)paren
(brace
r_case
id|VethEventTypeCap
suffix:colon
id|veth_take_cap
c_func
(paren
id|cnx
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VethEventTypeMonitor
suffix:colon
multiline_comment|/* do nothing... this&squot;ll hang out here til we&squot;re dead,&n;&t;&t; * and the hypervisor will return it for us. */
r_break
suffix:semicolon
r_case
id|VethEventTypeFramesAck
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VETH_MAX_ACKS_PER_MSG
suffix:semicolon
op_increment
id|i
)paren
(brace
id|u16
id|msgnum
op_assign
id|event-&gt;u.frames_ack_data.token
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|msgnum
OL
id|VETH_NUMBUFFERS
)paren
id|veth_recycle_msg
c_func
(paren
id|cnx
comma
id|cnx-&gt;msgs
op_plus
id|msgnum
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|veth_flush_pending
c_func
(paren
id|cnx
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VethEventTypeFrames
suffix:colon
id|veth_receive
c_func
(paren
id|cnx
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|veth_error
c_func
(paren
l_string|&quot;Unknown interrupt type %d from lpar %d&bslash;n&quot;
comma
id|event-&gt;base_event.xSubtype
comma
id|rlp
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
DECL|function|veth_handle_event
r_static
r_void
id|veth_handle_event
c_func
(paren
r_struct
id|HvLpEvent
op_star
id|event
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|VethLpEvent
op_star
id|veth_event
op_assign
(paren
r_struct
id|VethLpEvent
op_star
)paren
id|event
suffix:semicolon
r_if
c_cond
(paren
id|event-&gt;xFlags.xFunction
op_eq
id|HvLpEvent_Function_Ack
)paren
id|veth_handle_ack
c_func
(paren
id|veth_event
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|event-&gt;xFlags.xFunction
op_eq
id|HvLpEvent_Function_Int
)paren
id|veth_handle_int
c_func
(paren
id|veth_event
)paren
suffix:semicolon
)brace
DECL|function|veth_process_caps
r_static
r_int
id|veth_process_caps
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
)paren
(brace
r_struct
id|VethCapData
op_star
id|remote_caps
op_assign
op_amp
id|cnx-&gt;remote_caps
suffix:semicolon
r_int
id|num_acks_needed
suffix:semicolon
multiline_comment|/* Convert timer to jiffies */
id|cnx-&gt;ack_timeout
op_assign
id|remote_caps-&gt;ack_timeout
op_star
id|HZ
op_div
l_int|1000000
suffix:semicolon
r_if
c_cond
(paren
(paren
id|remote_caps-&gt;num_buffers
op_eq
l_int|0
)paren
op_logical_or
(paren
id|remote_caps-&gt;ack_threshold
OG
id|VETH_MAX_ACKS_PER_MSG
)paren
op_logical_or
(paren
id|remote_caps-&gt;ack_threshold
op_eq
l_int|0
)paren
op_logical_or
(paren
id|cnx-&gt;ack_timeout
op_eq
l_int|0
)paren
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;Received incompatible capabilities from lpar %d&bslash;n&quot;
comma
id|cnx-&gt;remote_lp
)paren
suffix:semicolon
r_return
id|HvLpEvent_Rc_InvalidSubtypeData
suffix:semicolon
)brace
id|num_acks_needed
op_assign
(paren
id|remote_caps-&gt;num_buffers
op_div
id|remote_caps-&gt;ack_threshold
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* FIXME: locking on num_ack_events? */
r_if
c_cond
(paren
id|cnx-&gt;num_ack_events
OL
id|num_acks_needed
)paren
(brace
r_int
id|num
suffix:semicolon
id|num
op_assign
id|veth_allocate_events
c_func
(paren
id|cnx-&gt;remote_lp
comma
id|num_acks_needed
op_minus
id|cnx-&gt;num_ack_events
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num
OG
l_int|0
)paren
id|cnx-&gt;num_ack_events
op_add_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;num_ack_events
OL
id|num_acks_needed
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;Couldn&squot;t allocate enough ack events for lpar %d&bslash;n&quot;
comma
id|cnx-&gt;remote_lp
)paren
suffix:semicolon
r_return
id|HvLpEvent_Rc_BufferNotAvailable
suffix:semicolon
)brace
)brace
r_return
id|HvLpEvent_Rc_Good
suffix:semicolon
)brace
multiline_comment|/* FIXME: The gotos here are a bit dubious */
DECL|function|veth_statemachine
r_static
r_void
id|veth_statemachine
c_func
(paren
r_void
op_star
id|p
)paren
(brace
r_struct
id|veth_lpar_connection
op_star
id|cnx
op_assign
(paren
r_struct
id|veth_lpar_connection
op_star
)paren
id|p
suffix:semicolon
r_int
id|rlp
op_assign
id|cnx-&gt;remote_lp
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|cnx-&gt;lock
)paren
suffix:semicolon
id|restart
suffix:colon
r_if
c_cond
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_RESET
)paren
(brace
r_int
id|i
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cnx-&gt;ack_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_OPEN
)paren
id|HvCallEvent_closeLpEventPath
c_func
(paren
id|cnx-&gt;remote_lp
comma
id|HvLpEvent_Type_VirtualLan
)paren
suffix:semicolon
multiline_comment|/* reset ack data */
id|memset
c_func
(paren
op_amp
id|cnx-&gt;pending_acks
comma
l_int|0xff
comma
r_sizeof
(paren
id|cnx-&gt;pending_acks
)paren
)paren
suffix:semicolon
id|cnx-&gt;num_pending_acks
op_assign
l_int|0
suffix:semicolon
id|cnx-&gt;state
op_and_assign
op_complement
(paren
id|VETH_STATE_RESET
op_or
id|VETH_STATE_SENTMON
op_or
id|VETH_STATE_OPEN
op_or
id|VETH_STATE_SENTCAPS
op_or
id|VETH_STATE_GOTCAPACK
op_or
id|VETH_STATE_GOTCAPS
op_or
id|VETH_STATE_SENTCAPACK
op_or
id|VETH_STATE_READY
)paren
suffix:semicolon
multiline_comment|/* Clean up any leftover messages */
r_if
c_cond
(paren
id|cnx-&gt;msgs
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VETH_NUMBUFFERS
suffix:semicolon
op_increment
id|i
)paren
id|veth_recycle_msg
c_func
(paren
id|cnx
comma
id|cnx-&gt;msgs
op_plus
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_SHUTDOWN
)paren
multiline_comment|/* It&squot;s all over, do nothing */
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_OPEN
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cnx-&gt;msgs
op_logical_or
(paren
id|cnx-&gt;num_events
OL
(paren
l_int|2
op_plus
id|VETH_NUMBUFFERS
)paren
)paren
)paren
r_goto
id|cant_cope
suffix:semicolon
id|HvCallEvent_openLpEventPath
c_func
(paren
id|rlp
comma
id|HvLpEvent_Type_VirtualLan
)paren
suffix:semicolon
id|cnx-&gt;src_inst
op_assign
id|HvCallEvent_getSourceLpInstanceId
c_func
(paren
id|rlp
comma
id|HvLpEvent_Type_VirtualLan
)paren
suffix:semicolon
id|cnx-&gt;dst_inst
op_assign
id|HvCallEvent_getTargetLpInstanceId
c_func
(paren
id|rlp
comma
id|HvLpEvent_Type_VirtualLan
)paren
suffix:semicolon
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_OPEN
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_OPEN
)paren
op_logical_and
op_logical_neg
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_SENTMON
)paren
)paren
(brace
id|rc
op_assign
id|veth_signalevent
c_func
(paren
id|cnx
comma
id|VethEventTypeMonitor
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_DeferredAck
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|HvLpEvent_Rc_Good
)paren
(brace
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_SENTMON
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rc
op_ne
id|HvLpEvent_Rc_PartitionDead
)paren
op_logical_and
(paren
id|rc
op_ne
id|HvLpEvent_Rc_PathClosed
)paren
)paren
id|veth_error
c_func
(paren
l_string|&quot;Error sending monitor to &quot;
l_string|&quot;lpar %d, rc=%x&bslash;n&quot;
comma
id|rlp
comma
(paren
r_int
)paren
id|rc
)paren
suffix:semicolon
multiline_comment|/* Oh well, hope we get a cap from the other&n;&t;&t;&t; * end and do better when that kicks us */
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_OPEN
)paren
op_logical_and
op_logical_neg
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_SENTCAPS
)paren
)paren
(brace
id|u64
op_star
id|rawcap
op_assign
(paren
id|u64
op_star
)paren
op_amp
id|cnx-&gt;local_caps
suffix:semicolon
id|rc
op_assign
id|veth_signalevent
c_func
(paren
id|cnx
comma
id|VethEventTypeCap
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
l_int|0
comma
id|rawcap
(braket
l_int|0
)braket
comma
id|rawcap
(braket
l_int|1
)braket
comma
id|rawcap
(braket
l_int|2
)braket
comma
id|rawcap
(braket
l_int|3
)braket
comma
id|rawcap
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|HvLpEvent_Rc_Good
)paren
(brace
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_SENTCAPS
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rc
op_ne
id|HvLpEvent_Rc_PartitionDead
)paren
op_logical_and
(paren
id|rc
op_ne
id|HvLpEvent_Rc_PathClosed
)paren
)paren
id|veth_error
c_func
(paren
l_string|&quot;Error sending caps to &quot;
l_string|&quot;lpar %d, rc=%x&bslash;n&quot;
comma
id|rlp
comma
(paren
r_int
)paren
id|rc
)paren
suffix:semicolon
multiline_comment|/* Oh well, hope we get a cap from the other&n;&t;&t;&t; * end and do better when that kicks us */
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_GOTCAPS
)paren
op_logical_and
op_logical_neg
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_SENTCAPACK
)paren
)paren
(brace
r_struct
id|VethCapData
op_star
id|remote_caps
op_assign
op_amp
id|cnx-&gt;remote_caps
suffix:semicolon
id|memcpy
c_func
(paren
id|remote_caps
comma
op_amp
id|cnx-&gt;cap_event.u.caps_data
comma
r_sizeof
(paren
op_star
id|remote_caps
)paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|cnx-&gt;lock
)paren
suffix:semicolon
id|rc
op_assign
id|veth_process_caps
c_func
(paren
id|cnx
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|cnx-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* We dropped the lock, so recheck for anything which&n;&t;&t; * might mess us up */
r_if
c_cond
(paren
id|cnx-&gt;state
op_amp
(paren
id|VETH_STATE_RESET
op_or
id|VETH_STATE_SHUTDOWN
)paren
)paren
r_goto
id|restart
suffix:semicolon
id|cnx-&gt;cap_event.base_event.xRc
op_assign
id|rc
suffix:semicolon
id|HvCallEvent_ackLpEvent
c_func
(paren
(paren
r_struct
id|HvLpEvent
op_star
)paren
op_amp
id|cnx-&gt;cap_event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|HvLpEvent_Rc_Good
)paren
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_SENTCAPACK
suffix:semicolon
r_else
r_goto
id|cant_cope
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_GOTCAPACK
)paren
op_logical_and
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_GOTCAPS
)paren
op_logical_and
op_logical_neg
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_READY
)paren
)paren
(brace
r_if
c_cond
(paren
id|cnx-&gt;cap_ack_event.base_event.xRc
op_eq
id|HvLpEvent_Rc_Good
)paren
(brace
multiline_comment|/* Start the ACK timer */
id|cnx-&gt;ack_timer.expires
op_assign
id|jiffies
op_plus
id|cnx-&gt;ack_timeout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cnx-&gt;ack_timer
)paren
suffix:semicolon
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_READY
suffix:semicolon
)brace
r_else
(brace
id|veth_printk
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Caps rejected (rc=%d) by &quot;
l_string|&quot;lpar %d&bslash;n&quot;
comma
id|cnx-&gt;cap_ack_event.base_event.xRc
comma
id|rlp
)paren
suffix:semicolon
r_goto
id|cant_cope
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|spin_unlock_irq
c_func
(paren
op_amp
id|cnx-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
id|cant_cope
suffix:colon
multiline_comment|/* FIXME: we get here if something happens we really can&squot;t&n;&t; * cope with.  The link will never work once we get here, and&n;&t; * all we can do is not lock the rest of the system up */
id|veth_error
c_func
(paren
l_string|&quot;Badness on connection to lpar %d (state=%04lx) &quot;
l_string|&quot; - shutting down&bslash;n&quot;
comma
id|rlp
comma
id|cnx-&gt;state
)paren
suffix:semicolon
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_SHUTDOWN
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|cnx-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|veth_init_connection
r_static
r_int
id|veth_init_connection
c_func
(paren
id|u8
id|rlp
)paren
(brace
r_struct
id|veth_lpar_connection
op_star
id|cnx
suffix:semicolon
r_struct
id|veth_msg
op_star
id|msgs
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rlp
op_eq
id|this_lp
)paren
op_logical_or
op_logical_neg
id|HvLpConfig_doLpsCommunicateOnVirtualLan
c_func
(paren
id|this_lp
comma
id|rlp
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|cnx
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cnx
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cnx
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|cnx
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cnx
)paren
)paren
suffix:semicolon
id|cnx-&gt;remote_lp
op_assign
id|rlp
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|cnx-&gt;lock
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|cnx-&gt;statemachine_wq
comma
id|veth_statemachine
comma
id|cnx
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|cnx-&gt;ack_timer
)paren
suffix:semicolon
id|cnx-&gt;ack_timer.function
op_assign
id|veth_timed_ack
suffix:semicolon
id|cnx-&gt;ack_timer.data
op_assign
(paren
r_int
r_int
)paren
id|cnx
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cnx-&gt;pending_acks
comma
l_int|0xff
comma
r_sizeof
(paren
id|cnx-&gt;pending_acks
)paren
)paren
suffix:semicolon
id|veth_cnx
(braket
id|rlp
)braket
op_assign
id|cnx
suffix:semicolon
id|msgs
op_assign
id|kmalloc
c_func
(paren
id|VETH_NUMBUFFERS
op_star
r_sizeof
(paren
r_struct
id|veth_msg
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msgs
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;Can&squot;t allocate buffers for lpar %d&bslash;n&quot;
comma
id|rlp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|cnx-&gt;msgs
op_assign
id|msgs
suffix:semicolon
id|memset
c_func
(paren
id|msgs
comma
l_int|0
comma
id|VETH_NUMBUFFERS
op_star
r_sizeof
(paren
r_struct
id|veth_msg
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|cnx-&gt;msg_stack_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VETH_NUMBUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|msgs
(braket
id|i
)braket
dot
id|token
op_assign
id|i
suffix:semicolon
id|veth_stack_push
c_func
(paren
id|cnx
comma
id|msgs
op_plus
id|i
)paren
suffix:semicolon
)brace
id|cnx-&gt;num_events
op_assign
id|veth_allocate_events
c_func
(paren
id|rlp
comma
l_int|2
op_plus
id|VETH_NUMBUFFERS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;num_events
OL
(paren
l_int|2
op_plus
id|VETH_NUMBUFFERS
)paren
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;Can&squot;t allocate events for lpar %d, only got %d&bslash;n&quot;
comma
id|rlp
comma
id|cnx-&gt;num_events
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|cnx-&gt;local_caps.num_buffers
op_assign
id|VETH_NUMBUFFERS
suffix:semicolon
id|cnx-&gt;local_caps.ack_threshold
op_assign
id|ACK_THRESHOLD
suffix:semicolon
id|cnx-&gt;local_caps.ack_timeout
op_assign
id|VETH_ACKTIMEOUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|veth_destroy_connection
r_static
r_void
id|veth_destroy_connection
c_func
(paren
id|u8
id|rlp
)paren
(brace
r_struct
id|veth_lpar_connection
op_star
id|cnx
op_assign
id|veth_cnx
(braket
id|rlp
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cnx
)paren
r_return
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|cnx-&gt;lock
)paren
suffix:semicolon
id|cnx-&gt;state
op_or_assign
id|VETH_STATE_RESET
op_or
id|VETH_STATE_SHUTDOWN
suffix:semicolon
id|veth_kick_statemachine
c_func
(paren
id|cnx
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|cnx-&gt;lock
)paren
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* FIXME: not sure if this is necessary - will already have&n;&t; * been deleted by the state machine, just want to make sure&n;&t; * its not running any more */
id|del_timer_sync
c_func
(paren
op_amp
id|cnx-&gt;ack_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;num_events
OG
l_int|0
)paren
id|mf_deallocateLpEvents
c_func
(paren
id|cnx-&gt;remote_lp
comma
id|HvLpEvent_Type_VirtualLan
comma
id|cnx-&gt;num_events
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;num_ack_events
OG
l_int|0
)paren
id|mf_deallocateLpEvents
c_func
(paren
id|cnx-&gt;remote_lp
comma
id|HvLpEvent_Type_VirtualLan
comma
id|cnx-&gt;num_ack_events
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;msgs
)paren
id|kfree
c_func
(paren
id|cnx-&gt;msgs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * net_device code&n; */
DECL|function|veth_open
r_static
r_int
id|veth_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|veth_port
op_star
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|port-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|port-&gt;stats
)paren
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|veth_close
r_static
r_int
id|veth_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|veth_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|veth_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|veth_port
op_star
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|port-&gt;stats
suffix:semicolon
)brace
DECL|function|veth_change_mtu
r_static
r_int
id|veth_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|68
)paren
op_logical_or
(paren
id|new_mtu
OG
id|VETH_MAX_MTU
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|veth_set_multicast_list
r_static
r_void
id|veth_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|veth_port
op_star
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;mcast_gate
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* set promiscuous mode */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|port-&gt;promiscuous
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
id|VETH_MAX_MCAST
)paren
)paren
(brace
id|port-&gt;all_mcast
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Update table */
id|port-&gt;num_mcast
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u8
op_star
id|addr
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|u64
id|xaddr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|addr
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* multicast address? */
id|memcpy
c_func
(paren
op_amp
id|xaddr
comma
id|addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|port-&gt;mcast_addr
(braket
id|port-&gt;num_mcast
)braket
op_assign
id|xaddr
suffix:semicolon
id|port-&gt;num_mcast
op_increment
suffix:semicolon
)brace
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;mcast_gate
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|veth_ioctl
r_static
r_int
id|veth_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
macro_line|#ifdef SIOCETHTOOL
r_struct
id|ethtool_cmd
id|ecmd
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCETHTOOL
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ecmd
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|ecmd.cmd
)paren
(brace
r_case
id|ETHTOOL_GSET
suffix:colon
id|ecmd.supported
op_assign
(paren
id|SUPPORTED_1000baseT_Full
op_or
id|SUPPORTED_Autoneg
op_or
id|SUPPORTED_FIBRE
)paren
suffix:semicolon
id|ecmd.advertising
op_assign
(paren
id|SUPPORTED_1000baseT_Full
op_or
id|SUPPORTED_Autoneg
op_or
id|SUPPORTED_FIBRE
)paren
suffix:semicolon
id|ecmd.port
op_assign
id|PORT_FIBRE
suffix:semicolon
id|ecmd.transceiver
op_assign
id|XCVR_INTERNAL
suffix:semicolon
id|ecmd.phy_address
op_assign
l_int|0
suffix:semicolon
id|ecmd.speed
op_assign
id|SPEED_1000
suffix:semicolon
id|ecmd.duplex
op_assign
id|DUPLEX_FULL
suffix:semicolon
id|ecmd.autoneg
op_assign
id|AUTONEG_ENABLE
suffix:semicolon
id|ecmd.maxtxpkt
op_assign
l_int|120
suffix:semicolon
id|ecmd.maxrxpkt
op_assign
l_int|120
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|ecmd
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
r_struct
id|ethtool_drvinfo
id|info
op_assign
(brace
id|ETHTOOL_GDRVINFO
)brace
suffix:semicolon
id|strncpy
c_func
(paren
id|info.driver
comma
l_string|&quot;veth&quot;
comma
r_sizeof
(paren
id|info.driver
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|info.driver
(braket
r_sizeof
(paren
id|info.driver
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|info.version
comma
l_string|&quot;1.0&quot;
comma
r_sizeof
(paren
id|info.version
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get link status */
r_case
id|ETHTOOL_GLINK
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GLINK
)brace
suffix:semicolon
id|edata.data
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_break
suffix:semicolon
)brace
macro_line|#endif
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|veth_probe_one
r_struct
id|net_device
op_star
id|__init
id|veth_probe_one
c_func
(paren
r_int
id|vlan
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|veth_port
op_star
id|port
suffix:semicolon
r_int
id|i
comma
id|rc
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|veth_port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;Unable to allocate net_device structure!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|port-&gt;pending_gate
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|port-&gt;mcast_gate
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HVMAXARCHITECTEDLPS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|HvLpVirtualLanIndexMap
id|map
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|this_lp
)paren
r_continue
suffix:semicolon
id|map
op_assign
id|HvLpConfig_getVirtualLanIndexMapForLp
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map
op_amp
(paren
l_int|0x8000
op_rshift
id|vlan
)paren
)paren
id|port-&gt;lpar_map
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0x02
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
id|vlan
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_assign
l_int|0xff
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_assign
id|this_lp
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|VETH_MAX_MTU
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|port-&gt;mac_addr
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|veth_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|veth_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
id|veth_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|veth_get_stats
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|veth_change_mtu
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|veth_set_multicast_list
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|veth_ioctl
suffix:semicolon
id|rc
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|veth_printk
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to register ethernet device for vlan %d&bslash;n&quot;
comma
id|vlan
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|veth_printk
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;%s attached to iSeries vlan %d (lpar_map=0x%04x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|vlan
comma
id|port-&gt;lpar_map
)paren
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/*&n; * Tx path&n; */
DECL|function|veth_transmit_to_one
r_static
r_int
id|veth_transmit_to_one
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|HvLpIndex
id|rlp
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|veth_lpar_connection
op_star
id|cnx
op_assign
id|veth_cnx
(braket
id|rlp
)braket
suffix:semicolon
r_struct
id|veth_port
op_star
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|HvLpEvent_Rc
id|rc
suffix:semicolon
id|u32
id|dma_address
comma
id|dma_length
suffix:semicolon
r_struct
id|veth_msg
op_star
id|msg
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cnx
)paren
(brace
id|port-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cnx-&gt;state
op_amp
id|VETH_STATE_READY
)paren
r_goto
id|drop
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb-&gt;len
op_minus
l_int|14
)paren
OG
id|VETH_MAX_MTU
)paren
r_goto
id|drop
suffix:semicolon
id|msg
op_assign
id|veth_stack_pop
c_func
(paren
id|cnx
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msg
)paren
(brace
id|err
op_assign
l_int|1
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
id|dma_length
op_assign
id|skb-&gt;len
suffix:semicolon
id|dma_address
op_assign
id|vio_map_single
c_func
(paren
id|iSeries_veth_dev
comma
id|skb-&gt;data
comma
id|dma_length
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_mapping_error
c_func
(paren
id|dma_address
)paren
)paren
r_goto
id|recycle_and_drop
suffix:semicolon
multiline_comment|/* Is it really necessary to check the length and address&n;&t; * fields of the first entry here? */
id|msg-&gt;skb
op_assign
id|skb
suffix:semicolon
id|msg-&gt;data.addr
(braket
l_int|0
)braket
op_assign
id|dma_address
suffix:semicolon
id|msg-&gt;data.len
(braket
l_int|0
)braket
op_assign
id|dma_length
suffix:semicolon
id|msg-&gt;data.eofmask
op_assign
l_int|1
op_lshift
id|VETH_EOF_SHIFT
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
(paren
id|msg-&gt;in_use
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|veth_signaldata
c_func
(paren
id|cnx
comma
id|VethEventTypeFrames
comma
id|msg-&gt;token
comma
op_amp
id|msg-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|HvLpEvent_Rc_Good
)paren
r_goto
id|recycle_and_drop
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|recycle_and_drop
suffix:colon
id|msg-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* need to set in use to make veth_recycle_msg in case this&n;&t; * was a mapping failure */
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;in_use
)paren
suffix:semicolon
id|veth_recycle_msg
c_func
(paren
id|cnx
comma
id|msg
)paren
suffix:semicolon
id|drop
suffix:colon
id|port-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|veth_transmit_to_many
r_static
id|HvLpIndexMap
id|veth_transmit_to_many
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|HvLpIndexMap
id|lpmask
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|veth_port
op_star
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HVMAXARCHITECTEDLPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|clone
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lpmask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|clone
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|clone
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;%s: skb_clone failed %p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rc
op_assign
id|veth_transmit_to_one
c_func
(paren
id|clone
comma
id|i
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|lpmask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lpmask
)paren
(brace
id|port-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|port-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
r_return
id|lpmask
suffix:semicolon
)brace
DECL|function|veth_start_xmit
r_static
r_int
id|veth_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_char
op_star
id|frame
op_assign
id|skb-&gt;data
suffix:semicolon
r_struct
id|veth_port
op_star
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|HvLpIndexMap
id|lpmask
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|frame
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* unicast packet */
id|HvLpIndex
id|rlp
op_assign
id|frame
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
id|rlp
)paren
op_amp
id|port-&gt;lpar_map
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|lpmask
op_assign
l_int|1
op_lshift
id|rlp
suffix:semicolon
)brace
r_else
(brace
id|lpmask
op_assign
id|port-&gt;lpar_map
suffix:semicolon
)brace
id|lpmask
op_assign
id|veth_transmit_to_many
c_func
(paren
id|skb
comma
id|lpmask
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lpmask
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;pending_gate
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;pending_skb
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;%s: Tx while skb was pending!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|port-&gt;pending_skb
op_assign
id|skb
suffix:semicolon
id|port-&gt;pending_lpmask
op_assign
id|lpmask
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;pending_gate
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|veth_recycle_msg
r_static
r_void
id|veth_recycle_msg
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
comma
r_struct
id|veth_msg
op_star
id|msg
)paren
(brace
id|u32
id|dma_address
comma
id|dma_length
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;in_use
)paren
)paren
(brace
id|dma_address
op_assign
id|msg-&gt;data.addr
(braket
l_int|0
)braket
suffix:semicolon
id|dma_length
op_assign
id|msg-&gt;data.len
(braket
l_int|0
)braket
suffix:semicolon
id|vio_unmap_single
c_func
(paren
id|iSeries_veth_dev
comma
id|dma_address
comma
id|dma_length
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|msg-&gt;skb
)paren
suffix:semicolon
id|msg-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|msg-&gt;data
comma
l_int|0
comma
r_sizeof
(paren
id|msg-&gt;data
)paren
)paren
suffix:semicolon
id|veth_stack_push
c_func
(paren
id|cnx
comma
id|msg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cnx-&gt;state
op_amp
id|VETH_STATE_OPEN
)paren
id|veth_error
c_func
(paren
l_string|&quot;Bogus frames ack from lpar %d (#%d)&bslash;n&quot;
comma
id|cnx-&gt;remote_lp
comma
id|msg-&gt;token
)paren
suffix:semicolon
)brace
DECL|function|veth_flush_pending
r_static
r_void
id|veth_flush_pending
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HVMAXARCHITECTEDVIRTUALLANS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|veth_dev
(braket
id|i
)braket
suffix:semicolon
r_struct
id|veth_port
op_star
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_continue
suffix:semicolon
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;lpar_map
op_amp
(paren
l_int|1
op_lshift
id|cnx-&gt;remote_lp
)paren
)paren
)paren
r_continue
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;pending_gate
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;pending_skb
)paren
(brace
id|port-&gt;pending_lpmask
op_assign
id|veth_transmit_to_many
c_func
(paren
id|port-&gt;pending_skb
comma
id|port-&gt;pending_lpmask
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;pending_lpmask
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|port-&gt;pending_skb
)paren
suffix:semicolon
id|port-&gt;pending_skb
op_assign
l_int|NULL
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;pending_gate
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Rx path&n; */
DECL|function|veth_frame_wanted
r_static
r_inline
r_int
id|veth_frame_wanted
c_func
(paren
r_struct
id|veth_port
op_star
id|port
comma
id|u64
id|mac_addr
)paren
(brace
r_int
id|wanted
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mac_addr
op_eq
id|port-&gt;mac_addr
)paren
op_logical_or
(paren
id|mac_addr
op_eq
l_int|0xffffffffffff0000
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|mac_addr
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;mcast_gate
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;promiscuous
op_logical_or
id|port-&gt;all_mcast
)paren
(brace
id|wanted
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|port-&gt;num_mcast
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;mcast_addr
(braket
id|i
)braket
op_eq
id|mac_addr
)paren
(brace
id|wanted
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;mcast_gate
comma
id|flags
)paren
suffix:semicolon
r_return
id|wanted
suffix:semicolon
)brace
DECL|struct|dma_chunk
r_struct
id|dma_chunk
(brace
DECL|member|addr
id|u64
id|addr
suffix:semicolon
DECL|member|size
id|u64
id|size
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|VETH_MAX_PAGES_PER_FRAME
mdefine_line|#define VETH_MAX_PAGES_PER_FRAME ( (VETH_MAX_MTU+PAGE_SIZE-2)/PAGE_SIZE + 1 )
DECL|function|veth_build_dma_list
r_static
r_inline
r_void
id|veth_build_dma_list
c_func
(paren
r_struct
id|dma_chunk
op_star
id|list
comma
r_int
r_char
op_star
id|p
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_int
id|done
suffix:semicolon
r_int
id|i
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FIXME: skbs are continguous in real addresses.  Do we&n;&t; * really need to break it into PAGE_SIZE chunks, or can we do&n;&t; * it just at the granularity of iSeries real-&gt;absolute&n;&t; * mapping?  Indeed, given the way the allocator works, can we&n;&t; * count on them being absolutely contiguous? */
id|list
(braket
l_int|0
)braket
dot
id|addr
op_assign
id|ISERIES_HV_ADDR
c_func
(paren
id|p
)paren
suffix:semicolon
id|list
(braket
l_int|0
)braket
dot
id|size
op_assign
id|min
c_func
(paren
id|length
comma
id|PAGE_SIZE
op_minus
(paren
(paren
r_int
r_int
)paren
id|p
op_amp
op_complement
id|PAGE_MASK
)paren
)paren
suffix:semicolon
id|done
op_assign
id|list
(braket
l_int|0
)braket
dot
id|size
suffix:semicolon
r_while
c_loop
(paren
id|done
OL
id|length
)paren
(brace
id|list
(braket
id|i
)braket
dot
id|addr
op_assign
id|ISERIES_HV_ADDR
c_func
(paren
id|p
op_plus
id|done
)paren
suffix:semicolon
id|list
(braket
id|i
)braket
dot
id|size
op_assign
id|min
c_func
(paren
id|length
op_minus
id|done
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|done
op_add_assign
id|list
(braket
id|i
)braket
dot
id|size
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
DECL|function|veth_flush_acks
r_static
r_void
id|veth_flush_acks
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
)paren
(brace
id|HvLpEvent_Rc
id|rc
suffix:semicolon
id|rc
op_assign
id|veth_signaldata
c_func
(paren
id|cnx
comma
id|VethEventTypeFramesAck
comma
l_int|0
comma
op_amp
id|cnx-&gt;pending_acks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|HvLpEvent_Rc_Good
)paren
id|veth_error
c_func
(paren
l_string|&quot;Error 0x%x acking frames from lpar %d!&bslash;n&quot;
comma
(paren
r_int
)paren
id|rc
comma
id|cnx-&gt;remote_lp
)paren
suffix:semicolon
id|cnx-&gt;num_pending_acks
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cnx-&gt;pending_acks
comma
l_int|0xff
comma
r_sizeof
(paren
id|cnx-&gt;pending_acks
)paren
)paren
suffix:semicolon
)brace
DECL|function|veth_receive
r_static
r_void
id|veth_receive
c_func
(paren
r_struct
id|veth_lpar_connection
op_star
id|cnx
comma
r_struct
id|VethLpEvent
op_star
id|event
)paren
(brace
r_struct
id|VethFramesData
op_star
id|senddata
op_assign
op_amp
id|event-&gt;u.frames_data
suffix:semicolon
r_int
id|startchunk
op_assign
l_int|0
suffix:semicolon
r_int
id|nchunks
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|HvLpDma_Rc
id|rc
suffix:semicolon
r_do
(brace
id|u16
id|length
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|dma_chunk
id|local_list
(braket
id|VETH_MAX_PAGES_PER_FRAME
)braket
suffix:semicolon
r_struct
id|dma_chunk
id|remote_list
(braket
id|VETH_MAX_FRAMES_PER_MSG
)braket
suffix:semicolon
id|u64
id|dest
suffix:semicolon
id|HvLpVirtualLanIndex
id|vlan
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|veth_port
op_star
id|port
suffix:semicolon
multiline_comment|/* FIXME: do we need this? */
id|memset
c_func
(paren
id|local_list
comma
l_int|0
comma
r_sizeof
(paren
id|local_list
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|remote_list
comma
l_int|0
comma
r_sizeof
(paren
id|VETH_MAX_FRAMES_PER_MSG
)paren
)paren
suffix:semicolon
multiline_comment|/* a 0 address marks the end of the valid entries */
r_if
c_cond
(paren
id|senddata-&gt;addr
(braket
id|startchunk
)braket
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* make sure that we have at least 1 EOF entry in the&n;&t;&t; * remaining entries */
r_if
c_cond
(paren
op_logical_neg
(paren
id|senddata-&gt;eofmask
op_rshift
(paren
id|startchunk
op_plus
id|VETH_EOF_SHIFT
)paren
)paren
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;missing EOF frag in event &quot;
l_string|&quot;eofmask=0x%x startchunk=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|senddata-&gt;eofmask
comma
id|startchunk
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* build list of chunks in this frame */
id|nchunks
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|remote_list
(braket
id|nchunks
)braket
dot
id|addr
op_assign
(paren
id|u64
)paren
id|senddata-&gt;addr
(braket
id|startchunk
op_plus
id|nchunks
)braket
op_lshift
l_int|32
suffix:semicolon
id|remote_list
(braket
id|nchunks
)braket
dot
id|size
op_assign
id|senddata-&gt;len
(braket
id|startchunk
op_plus
id|nchunks
)braket
suffix:semicolon
id|length
op_add_assign
id|remote_list
(braket
id|nchunks
)braket
dot
id|size
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|senddata-&gt;eofmask
op_amp
(paren
l_int|1
op_lshift
(paren
id|VETH_EOF_SHIFT
op_plus
id|startchunk
op_plus
id|nchunks
op_increment
)paren
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* length == total length of all chunks */
multiline_comment|/* nchunks == # of chunks in this frame */
r_if
c_cond
(paren
(paren
id|length
op_minus
id|ETH_HLEN
)paren
OG
id|VETH_MAX_MTU
)paren
(brace
id|veth_error
c_func
(paren
l_string|&quot;Received oversize frame from lpar %d &quot;
l_string|&quot;(length=%d)&bslash;n&quot;
comma
id|cnx-&gt;remote_lp
comma
id|length
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_continue
suffix:semicolon
id|veth_build_dma_list
c_func
(paren
id|local_list
comma
id|skb-&gt;data
comma
id|length
)paren
suffix:semicolon
id|rc
op_assign
id|HvCallEvent_dmaBufList
c_func
(paren
id|HvLpEvent_Type_VirtualLan
comma
id|event-&gt;base_event.xSourceLp
comma
id|HvLpDma_Direction_RemoteToLocal
comma
id|cnx-&gt;src_inst
comma
id|cnx-&gt;dst_inst
comma
id|HvLpDma_AddressType_RealAddress
comma
id|HvLpDma_AddressType_TceIndex
comma
id|ISERIES_HV_ADDR
c_func
(paren
op_amp
id|local_list
)paren
comma
id|ISERIES_HV_ADDR
c_func
(paren
op_amp
id|remote_list
)paren
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|HvLpDma_Rc_Good
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|vlan
op_assign
id|skb-&gt;data
(braket
l_int|9
)braket
suffix:semicolon
id|dev
op_assign
id|veth_dev
(braket
id|vlan
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
multiline_comment|/* Some earlier versions of the driver sent&n;&t;&t;&t;   broadcasts down all connections, even to&n;&t;&t;&t;   lpars that weren&squot;t on the relevant vlan.&n;&t;&t;&t;   So ignore packets belonging to a vlan we&squot;re&n;&t;&t;&t;   not on. */
r_continue
suffix:semicolon
id|port
op_assign
(paren
r_struct
id|veth_port
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dest
op_assign
op_star
(paren
(paren
id|u64
op_star
)paren
id|skb-&gt;data
)paren
op_amp
l_int|0xFFFFFFFFFFFF0000
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vlan
OG
id|HVMAXARCHITECTEDVIRTUALLANS
)paren
op_logical_or
op_logical_neg
id|port
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|veth_frame_wanted
c_func
(paren
id|port
comma
id|dest
)paren
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* send it up */
id|port-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|port-&gt;stats.rx_bytes
op_add_assign
id|length
suffix:semicolon
)brace
r_while
c_loop
(paren
id|startchunk
op_add_assign
id|nchunks
comma
id|startchunk
OL
id|VETH_MAX_FRAMES_PER_MSG
)paren
suffix:semicolon
multiline_comment|/* Ack it */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|cnx-&gt;num_pending_acks
OG
id|VETH_MAX_ACKS_PER_MSG
)paren
suffix:semicolon
id|cnx-&gt;pending_acks
(braket
id|cnx-&gt;num_pending_acks
op_increment
)braket
op_assign
id|event-&gt;base_event.xCorrelationToken
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cnx-&gt;num_pending_acks
op_ge
id|cnx-&gt;remote_caps.ack_threshold
)paren
op_logical_or
(paren
id|cnx-&gt;num_pending_acks
op_ge
id|VETH_MAX_ACKS_PER_MSG
)paren
)paren
id|veth_flush_acks
c_func
(paren
id|cnx
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|veth_timed_ack
r_static
r_void
id|veth_timed_ack
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_struct
id|veth_lpar_connection
op_star
id|cnx
op_assign
(paren
r_struct
id|veth_lpar_connection
op_star
)paren
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Ack all the events */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnx-&gt;num_pending_acks
OG
l_int|0
)paren
id|veth_flush_acks
c_func
(paren
id|cnx
)paren
suffix:semicolon
multiline_comment|/* Reschedule the timer */
id|cnx-&gt;ack_timer.expires
op_assign
id|jiffies
op_plus
id|cnx-&gt;ack_timeout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cnx-&gt;ack_timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cnx-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Module initialization/cleanup&n; */
DECL|function|veth_module_cleanup
r_void
id|__exit
id|veth_module_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HVMAXARCHITECTEDLPS
suffix:semicolon
op_increment
id|i
)paren
id|veth_destroy_connection
c_func
(paren
id|i
)paren
suffix:semicolon
id|HvLpEvent_unregisterHandler
c_func
(paren
id|HvLpEvent_Type_VirtualLan
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HVMAXARCHITECTEDVIRTUALLANS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|veth_dev
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_continue
suffix:semicolon
id|veth_dev
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|variable|veth_module_cleanup
id|module_exit
c_func
(paren
id|veth_module_cleanup
)paren
suffix:semicolon
DECL|function|veth_module_init
r_int
id|__init
id|veth_module_init
c_func
(paren
r_void
)paren
(brace
id|HvLpIndexMap
id|vlan_map
op_assign
id|HvLpConfig_getVirtualLanIndexMap
c_func
(paren
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|this_lp
op_assign
id|HvLpConfig_getLpIndex_outline
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HVMAXARCHITECTEDLPS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|rc
op_assign
id|veth_init_connection
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|veth_module_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HVMAXARCHITECTEDVIRTUALLANS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vlan_map
op_amp
(paren
l_int|0x8000
op_rshift
id|i
)paren
)paren
)paren
r_continue
suffix:semicolon
id|dev
op_assign
id|veth_probe_one
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|veth_module_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|veth_dev
(braket
id|i
)braket
op_assign
id|dev
suffix:semicolon
)brace
id|HvLpEvent_registerHandler
c_func
(paren
id|HvLpEvent_Type_VirtualLan
comma
op_amp
id|veth_handle_event
)paren
suffix:semicolon
multiline_comment|/* Start the state machine on each connection, to commence&n;&t; * link negotiation */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HVMAXARCHITECTEDLPS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|veth_cnx
(braket
id|i
)braket
)paren
id|veth_kick_statemachine
c_func
(paren
id|veth_cnx
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|veth_module_init
id|module_init
c_func
(paren
id|veth_module_init
)paren
suffix:semicolon
eof
