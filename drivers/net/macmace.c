multiline_comment|/*&n; *&t;Driver for the Macintosh 68K onboard MACE controller with PSC&n; *&t;driven DMA. The MACE driver code is derived from mace.c. The&n; *&t;Mac68k theory of operation is courtesy of the MacBSD wizards.&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Copyright (C) 1996 Paul Mackerras.&n; *&t;Copyright (C) 1998 Alan Cox &lt;alan@redhat.com&gt;&n; *&n; *&t;Modified heavily by Joshua M. Thompson based on Dave Huang&squot;s NetBSD driver&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/macintosh.h&gt;
macro_line|#include &lt;asm/macints.h&gt;
macro_line|#include &lt;asm/mac_psc.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &quot;mace.h&quot;
DECL|macro|N_TX_RING
mdefine_line|#define N_TX_RING&t;1
DECL|macro|N_RX_RING
mdefine_line|#define N_RX_RING&t;8
DECL|macro|N_RX_PAGES
mdefine_line|#define N_RX_PAGES&t;((N_RX_RING * 0x0800 + PAGE_SIZE - 1) / PAGE_SIZE)
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;HZ
multiline_comment|/* Bits in transmit DMA status */
DECL|macro|TX_DMA_ERR
mdefine_line|#define TX_DMA_ERR&t;0x80
multiline_comment|/* The MACE is simply wired down on a Mac68K box */
DECL|macro|MACE_BASE
mdefine_line|#define MACE_BASE&t;(void *)(0x50F1C000)
DECL|macro|MACE_PROM
mdefine_line|#define MACE_PROM&t;(void *)(0x50F08001)
DECL|struct|mace_data
r_struct
id|mace_data
(brace
DECL|member|mace
r_volatile
r_struct
id|mace
op_star
id|mace
suffix:semicolon
DECL|member|tx_ring
r_volatile
r_int
r_char
op_star
id|tx_ring
suffix:semicolon
DECL|member|tx_ring_phys
r_volatile
r_int
r_char
op_star
id|tx_ring_phys
suffix:semicolon
DECL|member|rx_ring
r_volatile
r_int
r_char
op_star
id|rx_ring
suffix:semicolon
DECL|member|rx_ring_phys
r_volatile
r_int
r_char
op_star
id|rx_ring_phys
suffix:semicolon
DECL|member|dma_intr
r_int
id|dma_intr
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|rx_slot
DECL|member|rx_tail
r_int
id|rx_slot
comma
id|rx_tail
suffix:semicolon
DECL|member|tx_slot
DECL|member|tx_sloti
DECL|member|tx_count
r_int
id|tx_slot
comma
id|tx_sloti
comma
id|tx_count
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|mace_frame
r_struct
id|mace_frame
(brace
DECL|member|len
id|u16
id|len
suffix:semicolon
DECL|member|status
id|u16
id|status
suffix:semicolon
DECL|member|rntpc
id|u16
id|rntpc
suffix:semicolon
DECL|member|rcvcc
id|u16
id|rcvcc
suffix:semicolon
DECL|member|pad1
id|u32
id|pad1
suffix:semicolon
DECL|member|pad2
id|u32
id|pad2
suffix:semicolon
DECL|member|data
id|u8
id|data
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* And frame continues.. */
)brace
suffix:semicolon
DECL|macro|PRIV_BYTES
mdefine_line|#define PRIV_BYTES&t;sizeof(struct mace_data)
r_extern
r_void
id|psc_debug_dump
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|mace_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|mace_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mace_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mace_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|mace_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|mace_dma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|mace_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Bit-reverse one byte of an ethernet hardware address. */
DECL|function|bitrev
r_static
r_int
id|bitrev
c_func
(paren
r_int
id|b
)paren
(brace
r_int
id|d
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
comma
id|b
op_rshift_assign
l_int|1
)paren
(brace
id|d
op_assign
(paren
id|d
op_lshift
l_int|1
)paren
op_or
(paren
id|b
op_amp
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|d
suffix:semicolon
)brace
multiline_comment|/*&n; * Load a receive DMA channel with a base address and ring length&n; */
DECL|function|mace_load_rxdma_base
r_static
r_void
id|mace_load_rxdma_base
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|set
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|set
comma
l_int|0x0100
)paren
suffix:semicolon
id|psc_write_long
c_func
(paren
id|PSC_ENETRD_ADDR
op_plus
id|set
comma
(paren
id|u32
)paren
id|mp-&gt;rx_ring_phys
)paren
suffix:semicolon
id|psc_write_long
c_func
(paren
id|PSC_ENETRD_LEN
op_plus
id|set
comma
id|N_RX_RING
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|set
comma
l_int|0x9800
)paren
suffix:semicolon
id|mp-&gt;rx_tail
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Reset the receive DMA subsystem&n; */
DECL|function|mace_rxdma_reset
r_static
r_void
id|mace_rxdma_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mace
op_assign
id|mp-&gt;mace
suffix:semicolon
id|u8
id|maccc
op_assign
id|mace-&gt;maccc
suffix:semicolon
id|mace-&gt;maccc
op_assign
id|maccc
op_amp
op_complement
id|ENRCV
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|mace_load_rxdma_base
c_func
(paren
id|dev
comma
l_int|0x00
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|mace_load_rxdma_base
c_func
(paren
id|dev
comma
l_int|0x10
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
id|mace-&gt;maccc
op_assign
id|maccc
suffix:semicolon
id|mp-&gt;rx_slot
op_assign
l_int|0
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|PSC_SET0
comma
l_int|0x9800
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|PSC_SET1
comma
l_int|0x9800
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reset the transmit DMA subsystem&n; */
DECL|function|mace_txdma_reset
r_static
r_void
id|mace_txdma_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mace
op_assign
id|mp-&gt;mace
suffix:semicolon
id|u8
id|maccc
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|maccc
op_assign
id|mace-&gt;maccc
suffix:semicolon
id|mace-&gt;maccc
op_assign
id|maccc
op_amp
op_complement
id|ENXMT
suffix:semicolon
id|mp-&gt;tx_slot
op_assign
id|mp-&gt;tx_sloti
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;tx_count
op_assign
id|N_TX_RING
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
id|mace-&gt;maccc
op_assign
id|maccc
suffix:semicolon
)brace
multiline_comment|/*&n; * Disable DMA&n; */
DECL|function|mace_dma_off
r_static
r_void
id|mace_dma_off
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x1000
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|PSC_SET0
comma
l_int|0x1100
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|PSC_SET1
comma
l_int|0x1100
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x8800
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x1000
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CMD
op_plus
id|PSC_SET0
comma
l_int|0x1100
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CMD
op_plus
id|PSC_SET1
comma
l_int|0x1100
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Not really much of a probe. The hardware table tells us if this&n; * model of Macintrash has a MACE (AV macintoshes)&n; */
DECL|function|mace_probe
r_int
id|mace_probe
c_func
(paren
r_struct
id|net_device
op_star
id|unused
)paren
(brace
r_int
id|j
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
suffix:semicolon
r_int
r_char
op_star
id|addr
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
r_char
id|checksum
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|found
op_logical_or
id|macintosh_config-&gt;ether_type
op_ne
id|MAC_ETHER_MACE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* prevent &squot;finding&squot; one on every device probe */
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
id|PRIV_BYTES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
id|u32
)paren
id|MACE_BASE
suffix:semicolon
id|mp-&gt;mace
op_assign
(paren
r_volatile
r_struct
id|mace
op_star
)paren
id|MACE_BASE
suffix:semicolon
id|dev-&gt;irq
op_assign
id|IRQ_MAC_MACE
suffix:semicolon
id|mp-&gt;dma_intr
op_assign
id|IRQ_MAC_MACE_DMA
suffix:semicolon
multiline_comment|/*&n;&t; * The PROM contains 8 bytes which total 0xFF when XOR&squot;d&n;&t; * together. Due to the usual peculiar apple brain damage&n;&t; * the bytes are spaced out in a strange boundary and the&n;&t; * bits are reversed.&n;&t; */
id|addr
op_assign
(paren
r_void
op_star
)paren
id|MACE_PROM
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
op_increment
id|j
)paren
(brace
id|u8
id|v
op_assign
id|bitrev
c_func
(paren
id|addr
(braket
id|j
op_lshift
l_int|4
)braket
)paren
suffix:semicolon
id|checksum
op_xor_assign
id|v
suffix:semicolon
id|dev-&gt;dev_addr
(braket
id|j
)braket
op_assign
id|v
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
op_increment
id|j
)paren
(brace
id|checksum
op_xor_assign
id|bitrev
c_func
(paren
id|addr
(braket
id|j
op_lshift
l_int|4
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|checksum
op_ne
l_int|0xFF
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mp-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|mp-&gt;stats
)paren
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|mace_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|mace_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|mace_xmit_start
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|mace_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|mace_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|mace_set_multicast
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|mace_set_address
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 68K MACE, hardware address %.2X&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;:%.2X&quot;
comma
id|dev-&gt;dev_addr
(braket
id|j
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Load the address on a mace controller.&n; */
DECL|function|mace_set_address
r_static
r_int
id|mace_set_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
id|addr
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|maccc
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|maccc
op_assign
id|mb-&gt;maccc
suffix:semicolon
multiline_comment|/* load up the hardware address */
id|mb-&gt;iac
op_assign
id|ADDRCHG
op_or
id|PHYADDR
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mb-&gt;iac
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
(brace
id|mb-&gt;padr
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|p
(braket
id|i
)braket
suffix:semicolon
)brace
id|mb-&gt;maccc
op_assign
id|maccc
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Open the Macintosh MACE. Most of this is playing with the DMA&n; * engine. The ethernet chip is quite friendly.&n; */
DECL|function|mace_open
r_static
r_int
id|mace_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
macro_line|#if 0
r_int
id|i
suffix:semicolon
id|i
op_assign
l_int|200
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
)paren
(brace
id|mb-&gt;biucc
op_assign
id|SWRST
suffix:semicolon
r_if
c_cond
(paren
id|mb-&gt;biucc
op_amp
id|SWRST
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: software reset failed!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#endif
id|mb-&gt;biucc
op_assign
id|XMTSP_64
suffix:semicolon
id|mb-&gt;fifocc
op_assign
id|XMTFW_16
op_or
id|RCVFW_64
op_or
id|XMTFWU
op_or
id|RCVFWU
op_or
id|XMTBRST
op_or
id|RCVBRST
suffix:semicolon
id|mb-&gt;xmtfc
op_assign
id|AUTO_PAD_XMIT
suffix:semicolon
id|mb-&gt;plscc
op_assign
id|PORTSEL_AUI
suffix:semicolon
multiline_comment|/* mb-&gt;utr = RTRD; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|mace_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|mp-&gt;dma_intr
comma
id|mace_dma_intr
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mp-&gt;dma_intr
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Allocate the DMA ring buffers */
id|mp-&gt;rx_ring
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
id|N_RX_PAGES
)paren
suffix:semicolon
id|mp-&gt;tx_ring
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tx_ring
op_eq
l_int|NULL
op_logical_or
id|mp-&gt;rx_ring
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|mp-&gt;rx_ring
)paren
id|free_pages
c_func
(paren
(paren
id|u32
)paren
id|mp-&gt;rx_ring
comma
id|N_RX_PAGES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tx_ring
)paren
id|free_pages
c_func
(paren
(paren
id|u32
)paren
id|mp-&gt;tx_ring
comma
l_int|0
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|mp-&gt;dma_intr
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to allocate DMA buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|mp-&gt;rx_ring_phys
op_assign
(paren
r_int
r_char
op_star
)paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|mp-&gt;rx_ring
)paren
suffix:semicolon
id|mp-&gt;tx_ring_phys
op_assign
(paren
r_int
r_char
op_star
)paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|mp-&gt;tx_ring
)paren
suffix:semicolon
multiline_comment|/* We want the Rx buffer to be uncached and the Tx buffer to be writethrough */
id|kernel_set_cachemode
c_func
(paren
(paren
r_void
op_star
)paren
id|mp-&gt;rx_ring
comma
id|N_RX_PAGES
op_star
id|PAGE_SIZE
comma
id|IOMAP_NOCACHE_NONSER
)paren
suffix:semicolon
id|kernel_set_cachemode
c_func
(paren
(paren
r_void
op_star
)paren
id|mp-&gt;tx_ring
comma
id|PAGE_SIZE
comma
id|IOMAP_WRITETHROUGH
)paren
suffix:semicolon
id|mace_dma_off
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Not sure what these do */
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x9000
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x9000
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CTL
comma
l_int|0x0400
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* load up the hardware address */
id|mb-&gt;iac
op_assign
id|ADDRCHG
op_or
id|PHYADDR
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mb-&gt;iac
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
id|mb-&gt;padr
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* clear the multicast filter */
id|mb-&gt;iac
op_assign
id|ADDRCHG
op_or
id|LOGADDR
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mb-&gt;iac
op_amp
id|ADDRCHG
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
id|mb-&gt;ladrf
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;plscc
op_assign
id|PORTSEL_GPSI
op_plus
id|ENPLSIO
suffix:semicolon
id|mb-&gt;maccc
op_assign
id|ENXMT
op_or
id|ENRCV
suffix:semicolon
id|mb-&gt;imr
op_assign
id|RCVINT
suffix:semicolon
macro_line|#endif
id|mace_rxdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mace_txdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Shut down the mace and its interrupt channel&n; */
DECL|function|mace_close
r_static
r_int
id|mace_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
id|mb-&gt;maccc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable rx and tx&t; */
id|mb-&gt;imr
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* disable all irqs&t; */
id|mace_dma_off
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* disable rx and tx dma */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_MAC_MACE_DMA
comma
id|dev
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
id|u32
)paren
id|mp-&gt;rx_ring
comma
id|N_RX_PAGES
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
id|u32
)paren
id|mp-&gt;tx_ring
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit a frame&n; */
DECL|function|mace_xmit_start
r_static
r_int
id|mace_xmit_start
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Stop the queue if the buffer is full */
r_if
c_cond
(paren
op_logical_neg
id|mp-&gt;tx_count
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mp-&gt;tx_count
op_decrement
suffix:semicolon
id|mp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|mp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* We need to copy into our xmit buffer to take care of alignment and caching issues */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|mp-&gt;tx_ring
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* load the Tx DMA and fire it off */
id|psc_write_long
c_func
(paren
id|PSC_ENETWR_ADDR
op_plus
id|mp-&gt;tx_slot
comma
(paren
id|u32
)paren
id|mp-&gt;tx_ring_phys
)paren
suffix:semicolon
id|psc_write_long
c_func
(paren
id|PSC_ENETWR_LEN
op_plus
id|mp-&gt;tx_slot
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CMD
op_plus
id|mp-&gt;tx_slot
comma
l_int|0x9800
)paren
suffix:semicolon
id|mp-&gt;tx_slot
op_xor_assign
l_int|0x10
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mace_stats
r_static
r_struct
id|net_device_stats
op_star
id|mace_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|p
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|p-&gt;stats
suffix:semicolon
)brace
DECL|function|mace_set_multicast
r_static
r_void
id|mace_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|u32
id|crc
suffix:semicolon
id|u8
id|maccc
suffix:semicolon
id|maccc
op_assign
id|mb-&gt;maccc
suffix:semicolon
id|mb-&gt;maccc
op_and_assign
op_complement
id|PROM
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|mb-&gt;maccc
op_or_assign
id|PROM
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|multicast_filter
(braket
l_int|8
)braket
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|multicast_filter
(braket
id|i
)braket
op_assign
l_int|0xFF
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|multicast_filter
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|crc
op_assign
id|ether_crc_le
c_func
(paren
l_int|6
comma
id|dmi-&gt;dmi_addr
)paren
suffix:semicolon
id|j
op_assign
id|crc
op_rshift
l_int|26
suffix:semicolon
multiline_comment|/* bit number in multicast_filter */
id|multicast_filter
(braket
id|j
op_rshift
l_int|3
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|j
op_amp
l_int|7
)paren
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
)brace
id|mb-&gt;iac
op_assign
id|ADDRCHG
op_or
id|LOGADDR
suffix:semicolon
r_while
c_loop
(paren
id|mb-&gt;iac
op_amp
id|ADDRCHG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
(brace
id|mb-&gt;ladrf
op_assign
id|multicast_filter
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
id|mb-&gt;maccc
op_assign
id|maccc
suffix:semicolon
)brace
multiline_comment|/*&n; * Miscellaneous interrupts are handled here. We may end up &n; * having to bash the chip on the head for bad errors&n; */
DECL|function|mace_handle_misc_intrs
r_static
r_void
id|mace_handle_misc_intrs
c_func
(paren
r_struct
id|mace_data
op_star
id|mp
comma
r_int
id|intr
)paren
(brace
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
r_static
r_int
id|mace_babbles
comma
id|mace_jabbers
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|MPCO
)paren
(brace
id|mp-&gt;stats.rx_missed_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
id|mp-&gt;stats.rx_missed_errors
op_add_assign
id|mb-&gt;mpc
suffix:semicolon
multiline_comment|/* reading clears it */
r_if
c_cond
(paren
id|intr
op_amp
id|RNTPCO
)paren
(brace
id|mp-&gt;stats.rx_length_errors
op_add_assign
l_int|256
suffix:semicolon
)brace
id|mp-&gt;stats.rx_length_errors
op_add_assign
id|mb-&gt;rntpc
suffix:semicolon
multiline_comment|/* reading clears it */
r_if
c_cond
(paren
id|intr
op_amp
id|CERR
)paren
(brace
op_increment
id|mp-&gt;stats.tx_heartbeat_errors
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr
op_amp
id|BABBLE
)paren
(brace
r_if
c_cond
(paren
id|mace_babbles
op_increment
OL
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: babbling transmitter&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intr
op_amp
id|JABBER
)paren
(brace
r_if
c_cond
(paren
id|mace_jabbers
op_increment
OL
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mace: jabbering transceiver&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;A transmit error has occurred. (We kick the transmit side from&n; *&t;the DMA completion)&n; */
DECL|function|mace_xmit_error
r_static
r_void
id|mace_xmit_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
id|u8
id|xmtfs
comma
id|xmtrc
suffix:semicolon
id|xmtfs
op_assign
id|mb-&gt;xmtfs
suffix:semicolon
id|xmtrc
op_assign
id|mb-&gt;xmtrc
suffix:semicolon
r_if
c_cond
(paren
id|xmtfs
op_amp
id|XMTSV
)paren
(brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|UFLO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: DMA underrun.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|mp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|mp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|mace_txdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xmtfs
op_amp
id|RTRY
)paren
(brace
id|mp-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;A receive interrupt occurred.&n; */
DECL|function|mace_recv_interrupt
r_static
r_void
id|mace_recv_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/*&t;struct mace_data *mp = (struct mace_data *) dev-&gt;priv; */
singleline_comment|//&t;volatile struct mace *mb = mp-&gt;mace;
)brace
multiline_comment|/*&n; * Process the chip interrupt&n; */
DECL|function|mace_interrupt
r_static
id|irqreturn_t
id|mace_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
r_struct
id|mace
op_star
id|mb
op_assign
id|mp-&gt;mace
suffix:semicolon
id|u8
id|ir
suffix:semicolon
id|ir
op_assign
id|mb-&gt;ir
suffix:semicolon
id|mace_handle_misc_intrs
c_func
(paren
id|mp
comma
id|ir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ir
op_amp
id|XMTINT
)paren
(brace
id|mace_xmit_error
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ir
op_amp
id|RCVINT
)paren
(brace
id|mace_recv_interrupt
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|mace_tx_timeout
r_static
r_void
id|mace_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/*&t;struct mace_data *mp = (struct mace_data *) dev-&gt;priv; */
singleline_comment|//&t;volatile struct mace *mb = mp-&gt;mace;
)brace
multiline_comment|/*&n; * Handle a newly arrived frame&n; */
DECL|function|mace_dma_rx_frame
r_static
r_void
id|mace_dma_rx_frame
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|mace_frame
op_star
id|mf
)paren
(brace
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
id|RS_OFLO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: fifo overflow.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|mp-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|mp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
(paren
id|RS_CLSN
op_or
id|RS_FRAMERR
op_or
id|RS_FCSERR
)paren
)paren
id|mp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
id|RS_CLSN
)paren
(brace
id|mp-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
id|RS_FRAMERR
)paren
(brace
id|mp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mf-&gt;status
op_amp
id|RS_FCSERR
)paren
(brace
id|mp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|mf-&gt;len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|mp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|mf-&gt;len
)paren
comma
id|mf-&gt;data
comma
id|mf-&gt;len
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|mp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|mp-&gt;stats.rx_bytes
op_add_assign
id|mf-&gt;len
suffix:semicolon
)brace
multiline_comment|/*&n; * The PSC has passed us a DMA interrupt event.&n; */
DECL|function|mace_dma_intr
r_static
id|irqreturn_t
id|mace_dma_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|mace_data
op_star
id|mp
op_assign
(paren
r_struct
id|mace_data
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|left
comma
id|head
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|u32
id|baka
suffix:semicolon
multiline_comment|/* Not sure what this does */
r_while
c_loop
(paren
(paren
id|baka
op_assign
id|psc_read_long
c_func
(paren
id|PSC_MYSTERY
)paren
)paren
op_ne
id|psc_read_long
c_func
(paren
id|PSC_MYSTERY
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|baka
op_amp
l_int|0x60000000
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/*&n;&t; * Process the read queue&n;&t; */
id|status
op_assign
id|psc_read_word
c_func
(paren
id|PSC_ENETRD_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x2000
)paren
(brace
id|mace_rxdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0100
)paren
(brace
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|mp-&gt;rx_slot
comma
l_int|0x1100
)paren
suffix:semicolon
id|left
op_assign
id|psc_read_long
c_func
(paren
id|PSC_ENETRD_LEN
op_plus
id|mp-&gt;rx_slot
)paren
suffix:semicolon
id|head
op_assign
id|N_RX_RING
op_minus
id|left
suffix:semicolon
multiline_comment|/* Loop through the ring buffer and process new packages */
r_while
c_loop
(paren
id|mp-&gt;rx_tail
OL
id|head
)paren
(brace
id|mace_dma_rx_frame
c_func
(paren
id|dev
comma
(paren
r_struct
id|mace_frame
op_star
)paren
(paren
id|mp-&gt;rx_ring
op_plus
(paren
id|mp-&gt;rx_tail
op_star
l_int|0x0800
)paren
)paren
)paren
suffix:semicolon
id|mp-&gt;rx_tail
op_increment
suffix:semicolon
)brace
multiline_comment|/* If we&squot;re out of buffers in this ring then switch to */
multiline_comment|/* the other set, otherwise just reactivate this one.  */
r_if
c_cond
(paren
op_logical_neg
id|left
)paren
(brace
id|mace_load_rxdma_base
c_func
(paren
id|dev
comma
id|mp-&gt;rx_slot
)paren
suffix:semicolon
id|mp-&gt;rx_slot
op_xor_assign
l_int|0x10
suffix:semicolon
)brace
r_else
(brace
id|psc_write_word
c_func
(paren
id|PSC_ENETRD_CMD
op_plus
id|mp-&gt;rx_slot
comma
l_int|0x9800
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Process the write queue&n;&t; */
id|status
op_assign
id|psc_read_word
c_func
(paren
id|PSC_ENETWR_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x2000
)paren
(brace
id|mace_txdma_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0100
)paren
(brace
id|psc_write_word
c_func
(paren
id|PSC_ENETWR_CMD
op_plus
id|mp-&gt;tx_sloti
comma
l_int|0x0100
)paren
suffix:semicolon
id|mp-&gt;tx_sloti
op_xor_assign
l_int|0x10
suffix:semicolon
id|mp-&gt;tx_count
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
