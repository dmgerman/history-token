multiline_comment|/*&n; * This code is derived from the VIA reference driver (copyright message&n; * below) provided to Red Hat by VIA Networking Technologies, Inc. for&n; * addition to the Linux kernel.&n; *&n; * The code has been merged into one source file, cleaned up to follow&n; * Linux coding style,  ported to the Linux 2.6 kernel tree and cleaned&n; * for 64bit hardware platforms.&n; *&n; * TODO&n; *&t;Big-endian support&n; *&t;rx_copybreak/alignment&n; *&t;Scatter gather&n; *&t;More testing&n; *&n; * The changes are (c) Copyright 2004, Red Hat Inc. &lt;alan@redhat.com&gt;&n; * Additional fixes and clean up: Francois Romieu&n; *&n; * This source has not been verified for use in safety critical systems.&n; *&n; * Please direct queries about the revamped driver to the linux-kernel&n; * list not VIA.&n; *&n; * Original code:&n; *&n; * Copyright (c) 1996, 2003 VIA Networking Technologies, Inc.&n; * All rights reserved.&n; *&n; * This software may be redistributed and/or modified under&n; * the terms of the GNU General Public License as published by the Free&n; * Software Foundation; either version 2 of the License, or&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY&n; * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License&n; * for more details.&n; *&n; * Author: Chuang Liang-Shing, AJ Jiang&n; *&n; * Date: Jan 24, 2003&n; *&n; * MODULE_LICENSE(&quot;GPL&quot;);&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;linux/crc-ccitt.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &quot;via-velocity.h&quot;
DECL|variable|velocity_nics
r_static
r_int
id|velocity_nics
op_assign
l_int|0
suffix:semicolon
DECL|variable|msglevel
r_static
r_int
id|msglevel
op_assign
id|MSG_LEVEL_INFO
suffix:semicolon
r_static
r_int
id|velocity_mii_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
DECL|variable|velocity_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|velocity_ethtool_ops
suffix:semicolon
multiline_comment|/*&n;    Define module options&n;*/
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;VIA Networking Technologies, Inc.&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;VIA Networking Velocity Family Gigabit Ethernet Adapter Driver&quot;
)paren
suffix:semicolon
DECL|macro|VELOCITY_PARAM
mdefine_line|#define VELOCITY_PARAM(N,D) &bslash;&n;        static const int N[MAX_UNITS]=OPTION_DEFAULT;&bslash;&n;        MODULE_PARM(N, &quot;1-&quot; __MODULE_STRING(MAX_UNITS) &quot;i&quot;);&bslash;&n;        MODULE_PARM_DESC(N, D);
DECL|macro|RX_DESC_MIN
mdefine_line|#define RX_DESC_MIN     64
DECL|macro|RX_DESC_MAX
mdefine_line|#define RX_DESC_MAX     255
DECL|macro|RX_DESC_DEF
mdefine_line|#define RX_DESC_DEF     64
id|VELOCITY_PARAM
c_func
(paren
id|RxDescriptors
comma
l_string|&quot;Number of receive descriptors&quot;
)paren
suffix:semicolon
DECL|macro|TX_DESC_MIN
mdefine_line|#define TX_DESC_MIN     16
DECL|macro|TX_DESC_MAX
mdefine_line|#define TX_DESC_MAX     256
DECL|macro|TX_DESC_DEF
mdefine_line|#define TX_DESC_DEF     64
id|VELOCITY_PARAM
c_func
(paren
id|TxDescriptors
comma
l_string|&quot;Number of transmit descriptors&quot;
)paren
suffix:semicolon
DECL|macro|VLAN_ID_MIN
mdefine_line|#define VLAN_ID_MIN     0
DECL|macro|VLAN_ID_MAX
mdefine_line|#define VLAN_ID_MAX     4095
DECL|macro|VLAN_ID_DEF
mdefine_line|#define VLAN_ID_DEF     0
multiline_comment|/* VID_setting[] is used for setting the VID of NIC.&n;   0: default VID.&n;   1-4094: other VIDs.&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|VID_setting
comma
l_string|&quot;802.1Q VLAN ID&quot;
)paren
suffix:semicolon
DECL|macro|RX_THRESH_MIN
mdefine_line|#define RX_THRESH_MIN   0
DECL|macro|RX_THRESH_MAX
mdefine_line|#define RX_THRESH_MAX   3
DECL|macro|RX_THRESH_DEF
mdefine_line|#define RX_THRESH_DEF   0
multiline_comment|/* rx_thresh[] is used for controlling the receive fifo threshold.&n;   0: indicate the rxfifo threshold is 128 bytes.&n;   1: indicate the rxfifo threshold is 512 bytes.&n;   2: indicate the rxfifo threshold is 1024 bytes.&n;   3: indicate the rxfifo threshold is store &amp; forward.&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|rx_thresh
comma
l_string|&quot;Receive fifo threshold&quot;
)paren
suffix:semicolon
DECL|macro|DMA_LENGTH_MIN
mdefine_line|#define DMA_LENGTH_MIN  0
DECL|macro|DMA_LENGTH_MAX
mdefine_line|#define DMA_LENGTH_MAX  7
DECL|macro|DMA_LENGTH_DEF
mdefine_line|#define DMA_LENGTH_DEF  0
multiline_comment|/* DMA_length[] is used for controlling the DMA length&n;   0: 8 DWORDs&n;   1: 16 DWORDs&n;   2: 32 DWORDs&n;   3: 64 DWORDs&n;   4: 128 DWORDs&n;   5: 256 DWORDs&n;   6: SF(flush till emply)&n;   7: SF(flush till emply)&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|DMA_length
comma
l_string|&quot;DMA length&quot;
)paren
suffix:semicolon
DECL|macro|TAGGING_DEF
mdefine_line|#define TAGGING_DEF     0
multiline_comment|/* enable_tagging[] is used for enabling 802.1Q VID tagging.&n;   0: disable VID seeting(default).&n;   1: enable VID setting.&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|enable_tagging
comma
l_string|&quot;Enable 802.1Q tagging&quot;
)paren
suffix:semicolon
DECL|macro|IP_ALIG_DEF
mdefine_line|#define IP_ALIG_DEF     0
multiline_comment|/* IP_byte_align[] is used for IP header DWORD byte aligned&n;   0: indicate the IP header won&squot;t be DWORD byte aligned.(Default) .&n;   1: indicate the IP header will be DWORD byte aligned.&n;      In some enviroment, the IP header should be DWORD byte aligned,&n;      or the packet will be droped when we receive it. (eg: IPVS)&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|IP_byte_align
comma
l_string|&quot;Enable IP header dword aligned&quot;
)paren
suffix:semicolon
DECL|macro|TX_CSUM_DEF
mdefine_line|#define TX_CSUM_DEF     1
multiline_comment|/* txcsum_offload[] is used for setting the checksum offload ability of NIC.&n;   (We only support RX checksum offload now)&n;   0: disable csum_offload[checksum offload&n;   1: enable checksum offload. (Default)&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|txcsum_offload
comma
l_string|&quot;Enable transmit packet checksum offload&quot;
)paren
suffix:semicolon
DECL|macro|FLOW_CNTL_DEF
mdefine_line|#define FLOW_CNTL_DEF   1
DECL|macro|FLOW_CNTL_MIN
mdefine_line|#define FLOW_CNTL_MIN   1
DECL|macro|FLOW_CNTL_MAX
mdefine_line|#define FLOW_CNTL_MAX   5
multiline_comment|/* flow_control[] is used for setting the flow control ability of NIC.&n;   1: hardware deafult - AUTO (default). Use Hardware default value in ANAR.&n;   2: enable TX flow control.&n;   3: enable RX flow control.&n;   4: enable RX/TX flow control.&n;   5: disable&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|flow_control
comma
l_string|&quot;Enable flow control ability&quot;
)paren
suffix:semicolon
DECL|macro|MED_LNK_DEF
mdefine_line|#define MED_LNK_DEF 0
DECL|macro|MED_LNK_MIN
mdefine_line|#define MED_LNK_MIN 0
DECL|macro|MED_LNK_MAX
mdefine_line|#define MED_LNK_MAX 4
multiline_comment|/* speed_duplex[] is used for setting the speed and duplex mode of NIC.&n;   0: indicate autonegotiation for both speed and duplex mode&n;   1: indicate 100Mbps half duplex mode&n;   2: indicate 100Mbps full duplex mode&n;   3: indicate 10Mbps half duplex mode&n;   4: indicate 10Mbps full duplex mode&n;&n;   Note:&n;        if EEPROM have been set to the force mode, this option is ignored&n;            by driver.&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|speed_duplex
comma
l_string|&quot;Setting the speed and duplex mode&quot;
)paren
suffix:semicolon
DECL|macro|VAL_PKT_LEN_DEF
mdefine_line|#define VAL_PKT_LEN_DEF     0
multiline_comment|/* ValPktLen[] is used for setting the checksum offload ability of NIC.&n;   0: Receive frame with invalid layer 2 length (Default)&n;   1: Drop frame with invalid layer 2 length&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|ValPktLen
comma
l_string|&quot;Receiving or Drop invalid 802.3 frame&quot;
)paren
suffix:semicolon
DECL|macro|WOL_OPT_DEF
mdefine_line|#define WOL_OPT_DEF     0
DECL|macro|WOL_OPT_MIN
mdefine_line|#define WOL_OPT_MIN     0
DECL|macro|WOL_OPT_MAX
mdefine_line|#define WOL_OPT_MAX     7
multiline_comment|/* wol_opts[] is used for controlling wake on lan behavior.&n;   0: Wake up if recevied a magic packet. (Default)&n;   1: Wake up if link status is on/off.&n;   2: Wake up if recevied an arp packet.&n;   4: Wake up if recevied any unicast packet.&n;   Those value can be sumed up to support more than one option.&n;*/
id|VELOCITY_PARAM
c_func
(paren
id|wol_opts
comma
l_string|&quot;Wake On Lan options&quot;
)paren
suffix:semicolon
DECL|macro|INT_WORKS_DEF
mdefine_line|#define INT_WORKS_DEF   20
DECL|macro|INT_WORKS_MIN
mdefine_line|#define INT_WORKS_MIN   10
DECL|macro|INT_WORKS_MAX
mdefine_line|#define INT_WORKS_MAX   64
id|VELOCITY_PARAM
c_func
(paren
id|int_works
comma
l_string|&quot;Number of packets per interrupt services&quot;
)paren
suffix:semicolon
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
op_assign
l_int|200
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;Copy breakpoint for copy-only-tiny-frames&quot;
)paren
suffix:semicolon
r_static
r_void
id|velocity_init_info
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|velocity_info
op_star
id|vptr
comma
r_struct
id|velocity_info_tbl
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|velocity_get_pci_info
c_func
(paren
r_struct
id|velocity_info
op_star
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_void
id|velocity_print_info
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
suffix:semicolon
r_static
r_int
id|velocity_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|velocity_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mtu
)paren
suffix:semicolon
r_static
r_int
id|velocity_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|velocity_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|velocity_set_multi
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|velocity_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|velocity_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|velocity_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|velocity_receive_frame
c_func
(paren
r_struct
id|velocity_info
op_star
comma
r_int
id|idx
)paren
suffix:semicolon
r_static
r_int
id|velocity_alloc_rx_buf
c_func
(paren
r_struct
id|velocity_info
op_star
comma
r_int
id|idx
)paren
suffix:semicolon
r_static
r_void
id|velocity_free_rd_ring
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
suffix:semicolon
r_static
r_void
id|velocity_free_tx_buf
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_struct
id|velocity_td_info
op_star
)paren
suffix:semicolon
r_static
r_int
id|velocity_soft_reset
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
suffix:semicolon
r_static
r_void
id|mii_init
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
id|u32
id|mii_status
)paren
suffix:semicolon
r_static
id|u32
id|velocity_get_opt_media_mode
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
suffix:semicolon
r_static
r_void
id|velocity_print_link_status
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
suffix:semicolon
r_static
r_void
id|safe_disable_mii_autopoll
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|velocity_shutdown
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
suffix:semicolon
r_static
r_void
id|enable_flow_control_ability
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
suffix:semicolon
r_static
r_void
id|enable_mii_autopoll
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|velocity_mii_read
c_func
(paren
r_struct
id|mac_regs
op_star
comma
id|u8
id|byIdx
comma
id|u16
op_star
id|pdata
)paren
suffix:semicolon
r_static
r_int
id|velocity_mii_write
c_func
(paren
r_struct
id|mac_regs
op_star
comma
id|u8
id|byMiiAddr
comma
id|u16
id|data
)paren
suffix:semicolon
r_static
id|u32
id|mii_check_media_mode
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
id|u32
id|check_connection_type
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|velocity_set_media_mode
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
id|u32
id|mii_status
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PM
r_static
r_int
id|velocity_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
suffix:semicolon
r_static
r_int
id|velocity_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_int
id|velocity_netdev_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|notification
comma
r_void
op_star
id|ptr
)paren
suffix:semicolon
DECL|variable|velocity_inetaddr_notifier
r_static
r_struct
id|notifier_block
id|velocity_inetaddr_notifier
op_assign
(brace
dot
id|notifier_call
op_assign
id|velocity_netdev_event
comma
)brace
suffix:semicolon
DECL|variable|velocity_dev_list_lock
r_static
id|spinlock_t
id|velocity_dev_list_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|velocity_dev_list
)paren
suffix:semicolon
DECL|function|velocity_register_notifier
r_static
r_void
id|velocity_register_notifier
c_func
(paren
r_void
)paren
(brace
id|register_inetaddr_notifier
c_func
(paren
op_amp
id|velocity_inetaddr_notifier
)paren
suffix:semicolon
)brace
DECL|function|velocity_unregister_notifier
r_static
r_void
id|velocity_unregister_notifier
c_func
(paren
r_void
)paren
(brace
id|unregister_inetaddr_notifier
c_func
(paren
op_amp
id|velocity_inetaddr_notifier
)paren
suffix:semicolon
)brace
macro_line|#else&t;&t;&t;&t;/* CONFIG_PM */
DECL|macro|velocity_register_notifier
mdefine_line|#define velocity_register_notifier()&t;do {} while (0)
DECL|macro|velocity_unregister_notifier
mdefine_line|#define velocity_unregister_notifier()&t;do {} while (0)
macro_line|#endif&t;&t;&t;&t;/* !CONFIG_PM */
multiline_comment|/*&n; *&t;Internal board variants. At the moment we have only one&n; */
DECL|variable|chip_info_table
r_static
r_struct
id|velocity_info_tbl
id|chip_info_table
(braket
)braket
op_assign
(brace
(brace
id|CHIP_TYPE_VT6110
comma
l_string|&quot;VIA Networking Velocity Family Gigabit Ethernet Adapter&quot;
comma
l_int|256
comma
l_int|1
comma
l_int|0x00FFFFFFUL
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Describe the PCI device identifiers that we support in this&n; *&t;device driver. Used for hotplug autoloading.&n; */
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|velocity_id_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_612X
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
(paren
r_int
r_int
)paren
id|chip_info_table
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|velocity_id_table
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;get_chip_name&t;- &t;identifier to name&n; *&t;@id: chip identifier&n; *&n; *&t;Given a chip identifier return a suitable description. Returns&n; *&t;a pointer a static string valid while the driver is loaded.&n; */
DECL|function|get_chip_name
r_static
r_char
id|__devinit
op_star
id|get_chip_name
c_func
(paren
r_enum
id|chip_type
id|chip_id
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|chip_info_table
(braket
id|i
)braket
dot
id|name
op_ne
l_int|NULL
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|chip_info_table
(braket
id|i
)braket
dot
id|chip_id
op_eq
id|chip_id
)paren
r_break
suffix:semicolon
r_return
id|chip_info_table
(braket
id|i
)braket
dot
id|name
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_remove1&t;-&t;device unplug&n; *&t;@pdev: PCI device being removed&n; *&n; *&t;Device unload callback. Called on an unplug or on module&n; *&t;unload for each active device that is present. Disconnects&n; *&t;the device from the network layer and frees all the resources&n; */
DECL|function|velocity_remove1
r_static
r_void
id|__devexit
id|velocity_remove1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef CONFIG_PM
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|velocity_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|velocity_dev_list
)paren
)paren
id|list_del
c_func
(paren
op_amp
id|vptr-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|velocity_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|velocity_nics
op_decrement
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_set_int_opt&t;-&t;parser for integer options&n; *&t;@opt: pointer to option value&n; *&t;@val: value the user requested (or -1 for default)&n; *&t;@min: lowest value allowed&n; *&t;@max: highest value allowed&n; *&t;@def: default value&n; *&t;@name: property name&n; *&t;@dev: device name&n; *&n; *&t;Set an integer property in the module options. This function does&n; *&t;all the verification and checking as well as reporting so that&n; *&t;we don&squot;t duplicate code for each option.&n; */
DECL|function|velocity_set_int_opt
r_static
r_void
id|__devinit
id|velocity_set_int_opt
c_func
(paren
r_int
op_star
id|opt
comma
r_int
id|val
comma
r_int
id|min
comma
r_int
id|max
comma
r_int
id|def
comma
r_char
op_star
id|name
comma
r_char
op_star
id|devname
)paren
(brace
r_if
c_cond
(paren
id|val
op_eq
op_minus
l_int|1
)paren
op_star
id|opt
op_assign
id|def
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
template_param
id|max
)paren
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
id|KERN_NOTICE
l_string|&quot;%s: the value of parameter %s is invalid, the valid range is (%d-%d)&bslash;n&quot;
comma
id|devname
comma
id|name
comma
id|min
comma
id|max
)paren
suffix:semicolon
op_star
id|opt
op_assign
id|def
suffix:semicolon
)brace
r_else
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
id|KERN_INFO
l_string|&quot;%s: set value of parameter %s to %d&bslash;n&quot;
comma
id|devname
comma
id|name
comma
id|val
)paren
suffix:semicolon
op_star
id|opt
op_assign
id|val
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_set_bool_opt&t;-&t;parser for boolean options&n; *&t;@opt: pointer to option value&n; *&t;@val: value the user requested (or -1 for default)&n; *&t;@def: default value (yes/no)&n; *&t;@flag: numeric value to set for true.&n; *&t;@name: property name&n; *&t;@dev: device name&n; *&n; *&t;Set a boolean property in the module options. This function does&n; *&t;all the verification and checking as well as reporting so that&n; *&t;we don&squot;t duplicate code for each option.&n; */
DECL|function|velocity_set_bool_opt
r_static
r_void
id|__devinit
id|velocity_set_bool_opt
c_func
(paren
id|u32
op_star
id|opt
comma
r_int
id|val
comma
r_int
id|def
comma
id|u32
id|flag
comma
r_char
op_star
id|name
comma
r_char
op_star
id|devname
)paren
(brace
(paren
op_star
id|opt
)paren
op_and_assign
(paren
op_complement
id|flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
op_minus
l_int|1
)paren
op_star
id|opt
op_or_assign
(paren
id|def
ques
c_cond
id|flag
suffix:colon
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
template_param
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: the value of parameter %s is invalid, the valid range is (0-1)&bslash;n&quot;
comma
id|devname
comma
id|name
)paren
suffix:semicolon
op_star
id|opt
op_or_assign
(paren
id|def
ques
c_cond
id|flag
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: set parameter %s to %s&bslash;n&quot;
comma
id|devname
comma
id|name
comma
id|val
ques
c_cond
l_string|&quot;TRUE&quot;
suffix:colon
l_string|&quot;FALSE&quot;
)paren
suffix:semicolon
op_star
id|opt
op_or_assign
(paren
id|val
ques
c_cond
id|flag
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_get_options&t;-&t;set options on device&n; *&t;@opts: option structure for the device&n; *&t;@index: index of option to use in module options array&n; *&t;@devname: device name&n; *&n; *&t;Turn the module and command options into a single structure&n; *&t;for the current device&n; */
DECL|function|velocity_get_options
r_static
r_void
id|__devinit
id|velocity_get_options
c_func
(paren
r_struct
id|velocity_opt
op_star
id|opts
comma
r_int
id|index
comma
r_char
op_star
id|devname
)paren
(brace
id|velocity_set_int_opt
c_func
(paren
op_amp
id|opts-&gt;rx_thresh
comma
id|rx_thresh
(braket
id|index
)braket
comma
id|RX_THRESH_MIN
comma
id|RX_THRESH_MAX
comma
id|RX_THRESH_DEF
comma
l_string|&quot;rx_thresh&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_int_opt
c_func
(paren
op_amp
id|opts-&gt;DMA_length
comma
id|DMA_length
(braket
id|index
)braket
comma
id|DMA_LENGTH_MIN
comma
id|DMA_LENGTH_MAX
comma
id|DMA_LENGTH_DEF
comma
l_string|&quot;DMA_length&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_int_opt
c_func
(paren
op_amp
id|opts-&gt;numrx
comma
id|RxDescriptors
(braket
id|index
)braket
comma
id|RX_DESC_MIN
comma
id|RX_DESC_MAX
comma
id|RX_DESC_DEF
comma
l_string|&quot;RxDescriptors&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_int_opt
c_func
(paren
op_amp
id|opts-&gt;numtx
comma
id|TxDescriptors
(braket
id|index
)braket
comma
id|TX_DESC_MIN
comma
id|TX_DESC_MAX
comma
id|TX_DESC_DEF
comma
l_string|&quot;TxDescriptors&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_int_opt
c_func
(paren
op_amp
id|opts-&gt;vid
comma
id|VID_setting
(braket
id|index
)braket
comma
id|VLAN_ID_MIN
comma
id|VLAN_ID_MAX
comma
id|VLAN_ID_DEF
comma
l_string|&quot;VID_setting&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_bool_opt
c_func
(paren
op_amp
id|opts-&gt;flags
comma
id|enable_tagging
(braket
id|index
)braket
comma
id|TAGGING_DEF
comma
id|VELOCITY_FLAGS_TAGGING
comma
l_string|&quot;enable_tagging&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_bool_opt
c_func
(paren
op_amp
id|opts-&gt;flags
comma
id|txcsum_offload
(braket
id|index
)braket
comma
id|TX_CSUM_DEF
comma
id|VELOCITY_FLAGS_TX_CSUM
comma
l_string|&quot;txcsum_offload&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_int_opt
c_func
(paren
op_amp
id|opts-&gt;flow_cntl
comma
id|flow_control
(braket
id|index
)braket
comma
id|FLOW_CNTL_MIN
comma
id|FLOW_CNTL_MAX
comma
id|FLOW_CNTL_DEF
comma
l_string|&quot;flow_control&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_bool_opt
c_func
(paren
op_amp
id|opts-&gt;flags
comma
id|IP_byte_align
(braket
id|index
)braket
comma
id|IP_ALIG_DEF
comma
id|VELOCITY_FLAGS_IP_ALIGN
comma
l_string|&quot;IP_byte_align&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_bool_opt
c_func
(paren
op_amp
id|opts-&gt;flags
comma
id|ValPktLen
(braket
id|index
)braket
comma
id|VAL_PKT_LEN_DEF
comma
id|VELOCITY_FLAGS_VAL_PKT_LEN
comma
l_string|&quot;ValPktLen&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_int_opt
c_func
(paren
(paren
r_int
op_star
)paren
op_amp
id|opts-&gt;spd_dpx
comma
id|speed_duplex
(braket
id|index
)braket
comma
id|MED_LNK_MIN
comma
id|MED_LNK_MAX
comma
id|MED_LNK_DEF
comma
l_string|&quot;Media link mode&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_int_opt
c_func
(paren
(paren
r_int
op_star
)paren
op_amp
id|opts-&gt;wol_opts
comma
id|wol_opts
(braket
id|index
)braket
comma
id|WOL_OPT_MIN
comma
id|WOL_OPT_MAX
comma
id|WOL_OPT_DEF
comma
l_string|&quot;Wake On Lan options&quot;
comma
id|devname
)paren
suffix:semicolon
id|velocity_set_int_opt
c_func
(paren
(paren
r_int
op_star
)paren
op_amp
id|opts-&gt;int_works
comma
id|int_works
(braket
id|index
)braket
comma
id|INT_WORKS_MIN
comma
id|INT_WORKS_MAX
comma
id|INT_WORKS_DEF
comma
l_string|&quot;Interrupt service works&quot;
comma
id|devname
)paren
suffix:semicolon
id|opts-&gt;numrx
op_assign
(paren
id|opts-&gt;numrx
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_init_cam_filter&t;-&t;initialise CAM&n; *&t;@vptr: velocity to program&n; *&n; *&t;Initialize the content addressable memory used for filters. Load&n; *&t;appropriately according to the presence of VLAN&n; */
DECL|function|velocity_init_cam_filter
r_static
r_void
id|velocity_init_cam_filter
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
multiline_comment|/* T urn on MCFG_PQEN, turn off MCFG_RTGOPT */
id|WORD_REG_BITS_SET
c_func
(paren
id|MCFG_PQEN
comma
id|MCFG_RTGOPT
comma
op_amp
id|regs-&gt;MCFG
)paren
suffix:semicolon
id|WORD_REG_BITS_ON
c_func
(paren
id|MCFG_VIDFR
comma
op_amp
id|regs-&gt;MCFG
)paren
suffix:semicolon
multiline_comment|/* Disable all CAMs */
id|memset
c_func
(paren
id|vptr-&gt;vCAMmask
comma
l_int|0
comma
r_sizeof
(paren
id|u8
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vptr-&gt;mCAMmask
comma
l_int|0
comma
r_sizeof
(paren
id|u8
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|mac_set_cam_mask
c_func
(paren
id|regs
comma
id|vptr-&gt;vCAMmask
comma
id|VELOCITY_VLAN_ID_CAM
)paren
suffix:semicolon
id|mac_set_cam_mask
c_func
(paren
id|regs
comma
id|vptr-&gt;mCAMmask
comma
id|VELOCITY_MULTICAST_CAM
)paren
suffix:semicolon
multiline_comment|/* Enable first VCAM */
r_if
c_cond
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_TAGGING
)paren
(brace
multiline_comment|/* If Tagging option is enabled and VLAN ID is not zero, then&n;&t;&t;   turn on MCFG_RTGOPT also */
r_if
c_cond
(paren
id|vptr-&gt;options.vid
op_ne
l_int|0
)paren
id|WORD_REG_BITS_ON
c_func
(paren
id|MCFG_RTGOPT
comma
op_amp
id|regs-&gt;MCFG
)paren
suffix:semicolon
id|mac_set_cam
c_func
(paren
id|regs
comma
l_int|0
comma
(paren
id|u8
op_star
)paren
op_amp
(paren
id|vptr-&gt;options.vid
)paren
comma
id|VELOCITY_VLAN_ID_CAM
)paren
suffix:semicolon
id|vptr-&gt;vCAMmask
(braket
l_int|0
)braket
op_or_assign
l_int|1
suffix:semicolon
id|mac_set_cam_mask
c_func
(paren
id|regs
comma
id|vptr-&gt;vCAMmask
comma
id|VELOCITY_VLAN_ID_CAM
)paren
suffix:semicolon
)brace
r_else
(brace
id|u16
id|temp
op_assign
l_int|0
suffix:semicolon
id|mac_set_cam
c_func
(paren
id|regs
comma
l_int|0
comma
(paren
id|u8
op_star
)paren
op_amp
id|temp
comma
id|VELOCITY_VLAN_ID_CAM
)paren
suffix:semicolon
id|temp
op_assign
l_int|1
suffix:semicolon
id|mac_set_cam_mask
c_func
(paren
id|regs
comma
(paren
id|u8
op_star
)paren
op_amp
id|temp
comma
id|VELOCITY_VLAN_ID_CAM
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_rx_reset&t;-&t;handle a receive reset&n; *&t;@vptr: velocity we are resetting&n; *&n; *&t;Reset the ownership and status for the receive ring side.&n; *&t;Hand all the receive queue to the NIC.&n; */
DECL|function|velocity_rx_reset
r_static
r_void
id|velocity_rx_reset
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_int
id|i
suffix:semicolon
id|vptr-&gt;rd_dirty
op_assign
id|vptr-&gt;rd_filled
op_assign
id|vptr-&gt;rd_curr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Init state, all RD entries belong to the NIC&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vptr-&gt;options.numrx
suffix:semicolon
op_increment
id|i
)paren
id|vptr-&gt;rd_ring
(braket
id|i
)braket
dot
id|rdesc0.owner
op_assign
id|OWNED_BY_NIC
suffix:semicolon
id|writew
c_func
(paren
id|vptr-&gt;options.numrx
comma
op_amp
id|regs-&gt;RBRDU
)paren
suffix:semicolon
id|writel
c_func
(paren
id|vptr-&gt;rd_pool_dma
comma
op_amp
id|regs-&gt;RDBaseLo
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
op_amp
id|regs-&gt;RDIdx
)paren
suffix:semicolon
id|writew
c_func
(paren
id|vptr-&gt;options.numrx
op_minus
l_int|1
comma
op_amp
id|regs-&gt;RDCSize
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_init_registers&t;-&t;initialise MAC registers&n; *&t;@vptr: velocity to init&n; *&t;@type: type of initialisation (hot or cold)&n; *&n; *&t;Initialise the MAC on a reset or on first set up on the&n; *&t;hardware.&n; */
DECL|function|velocity_init_registers
r_static
r_void
id|velocity_init_registers
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_enum
id|velocity_init_type
id|type
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_int
id|i
comma
id|mii_status
suffix:semicolon
id|mac_wol_reset
c_func
(paren
id|regs
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|VELOCITY_INIT_RESET
suffix:colon
r_case
id|VELOCITY_INIT_WOL
suffix:colon
id|netif_stop_queue
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Reset RX to prevent RX pointer not on the 4X location&n;&t;&t; */
id|velocity_rx_reset
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|mac_rx_queue_run
c_func
(paren
id|regs
)paren
suffix:semicolon
id|mac_rx_queue_wake
c_func
(paren
id|regs
)paren
suffix:semicolon
id|mii_status
op_assign
id|velocity_get_opt_media_mode
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|velocity_set_media_mode
c_func
(paren
id|vptr
comma
id|mii_status
)paren
op_ne
id|VELOCITY_LINK_CHANGE
)paren
(brace
id|velocity_print_link_status
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_LINK_FAIL
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
)brace
id|enable_flow_control_ability
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|mac_clear_isr
c_func
(paren
id|regs
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR0_STOP
comma
op_amp
id|regs-&gt;CR0Clr
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|CR0_DPOLL
op_or
id|CR0_TXON
op_or
id|CR0_RXON
op_or
id|CR0_STRT
)paren
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VELOCITY_INIT_COLD
suffix:colon
r_default
suffix:colon
multiline_comment|/*&n;&t;&t; *&t;Do reset&n;&t;&t; */
id|velocity_soft_reset
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|mac_eeprom_reload
c_func
(paren
id|regs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
id|vptr-&gt;dev-&gt;dev_addr
(braket
id|i
)braket
comma
op_amp
(paren
id|regs-&gt;PAR
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;clear Pre_ACPI bit.&n;&t;&t; */
id|BYTE_REG_BITS_OFF
c_func
(paren
id|CFGA_PACPI
comma
op_amp
(paren
id|regs-&gt;CFGA
)paren
)paren
suffix:semicolon
id|mac_set_rx_thresh
c_func
(paren
id|regs
comma
id|vptr-&gt;options.rx_thresh
)paren
suffix:semicolon
id|mac_set_dma_length
c_func
(paren
id|regs
comma
id|vptr-&gt;options.DMA_length
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|WOLCFG_SAM
op_or
id|WOLCFG_SAB
comma
op_amp
id|regs-&gt;WOLCFGSet
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Bback off algorithm use original IEEE standard&n;&t;&t; */
id|BYTE_REG_BITS_SET
c_func
(paren
id|CFGB_OFSET
comma
(paren
id|CFGB_CRANDOM
op_or
id|CFGB_CAP
op_or
id|CFGB_MBA
op_or
id|CFGB_BAKOPT
)paren
comma
op_amp
id|regs-&gt;CFGB
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Init CAM filter&n;&t;&t; */
id|velocity_init_cam_filter
c_func
(paren
id|vptr
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Set packet filter: Receive directed and broadcast address&n;&t;&t; */
id|velocity_set_multi
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Enable MII auto-polling&n;&t;&t; */
id|enable_mii_autopoll
c_func
(paren
id|regs
)paren
suffix:semicolon
id|vptr-&gt;int_mask
op_assign
id|INT_MASK_DEF
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|vptr-&gt;rd_pool_dma
)paren
comma
op_amp
id|regs-&gt;RDBaseLo
)paren
suffix:semicolon
id|writew
c_func
(paren
id|vptr-&gt;options.numrx
op_minus
l_int|1
comma
op_amp
id|regs-&gt;RDCSize
)paren
suffix:semicolon
id|mac_rx_queue_run
c_func
(paren
id|regs
)paren
suffix:semicolon
id|mac_rx_queue_wake
c_func
(paren
id|regs
)paren
suffix:semicolon
id|writew
c_func
(paren
id|vptr-&gt;options.numtx
op_minus
l_int|1
comma
op_amp
id|regs-&gt;TDCSize
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vptr-&gt;num_txq
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|vptr-&gt;td_pool_dma
(braket
id|i
)braket
)paren
comma
op_amp
(paren
id|regs-&gt;TDBaseLo
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|mac_tx_queue_run
c_func
(paren
id|regs
comma
id|i
)paren
suffix:semicolon
)brace
id|init_flow_control_register
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR0_STOP
comma
op_amp
id|regs-&gt;CR0Clr
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|CR0_DPOLL
op_or
id|CR0_TXON
op_or
id|CR0_RXON
op_or
id|CR0_STRT
)paren
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
id|mii_status
op_assign
id|velocity_get_opt_media_mode
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
id|mii_init
c_func
(paren
id|vptr
comma
id|mii_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|velocity_set_media_mode
c_func
(paren
id|vptr
comma
id|mii_status
)paren
op_ne
id|VELOCITY_LINK_CHANGE
)paren
(brace
id|velocity_print_link_status
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_LINK_FAIL
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
)brace
id|enable_flow_control_ability
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|mac_hw_mibs_init
c_func
(paren
id|regs
)paren
suffix:semicolon
id|mac_write_int_mask
c_func
(paren
id|vptr-&gt;int_mask
comma
id|regs
)paren
suffix:semicolon
id|mac_clear_isr
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_soft_reset&t;-&t;soft reset&n; *&t;@vptr: velocity to reset&n; *&n; *&t;Kick off a soft reset of the velocity adapter and then poll&n; *&t;until the reset sequence has completed before returning.&n; */
DECL|function|velocity_soft_reset
r_static
r_int
id|velocity_soft_reset
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|writel
c_func
(paren
id|CR0_SFRST
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|W_MAX_TIMEOUT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DWORD_REG_BITS_IS_ON
c_func
(paren
id|CR0_SFRST
comma
op_amp
id|regs-&gt;CR0Set
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|W_MAX_TIMEOUT
)paren
(brace
id|writel
c_func
(paren
id|CR0_FORSRST
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
multiline_comment|/* FIXME: PCI POSTING */
multiline_comment|/* delay 2ms */
id|mdelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_found1&t;&t;-&t;set up discovered velocity card&n; *&t;@pdev: PCI device&n; *&t;@ent: PCI device table entry that matched&n; *&n; *&t;Configure a discovered adapter from scratch. Return a negative&n; *&t;errno error code on failure paths.&n; */
DECL|function|velocity_found1
r_static
r_int
id|__devinit
id|velocity_found1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|velocity_info_tbl
op_star
id|info
op_assign
(paren
r_struct
id|velocity_info_tbl
op_star
)paren
id|ent-&gt;driver_data
suffix:semicolon
r_struct
id|velocity_info
op_star
id|vptr
suffix:semicolon
r_struct
id|mac_regs
op_star
id|regs
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|velocity_nics
op_ge
id|MAX_UNITS
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
id|VELOCITY_NAME
l_string|&quot;: already found %d NICs.&bslash;n&quot;
comma
id|velocity_nics
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|velocity_info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|VELOCITY_NAME
l_string|&quot;: allocate net device failed.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Chain it all together */
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|first
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Ver. %s&bslash;n&quot;
comma
id|VELOCITY_FULL_DRV_NAM
comma
id|VELOCITY_VERSION
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Copyright (c) 2002, 2003 VIA Networking Technologies, Inc.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Copyright (c) 2004 Red Hat Inc.&bslash;n&quot;
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
id|velocity_init_info
c_func
(paren
id|pdev
comma
id|vptr
comma
id|info
)paren
suffix:semicolon
id|vptr-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|ret
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|err_free_dev
suffix:semicolon
id|ret
op_assign
id|velocity_get_pci_info
c_func
(paren
id|vptr
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|VELOCITY_NAME
l_string|&quot;: Failed to find PCI device.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
id|ret
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|VELOCITY_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|VELOCITY_NAME
l_string|&quot;: Failed to find PCI device.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
id|regs
op_assign
id|ioremap
c_func
(paren
id|vptr-&gt;memaddr
comma
id|vptr-&gt;io_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regs
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_release_res
suffix:semicolon
)brace
id|vptr-&gt;mac_regs
op_assign
id|regs
suffix:semicolon
id|mac_wol_reset
c_func
(paren
id|regs
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|vptr-&gt;ioaddr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
op_amp
id|regs-&gt;PAR
(braket
id|i
)braket
)paren
suffix:semicolon
id|velocity_get_options
c_func
(paren
op_amp
id|vptr-&gt;options
comma
id|velocity_nics
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *&t;Mask out the options cannot be set to the chip&n;&t; */
id|vptr-&gt;options.flags
op_and_assign
id|info-&gt;flags
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Enable the chip specified capbilities&n;&t; */
id|vptr-&gt;flags
op_assign
id|vptr-&gt;options.flags
op_or
(paren
id|info-&gt;flags
op_amp
l_int|0xFF000000UL
)paren
suffix:semicolon
id|vptr-&gt;wol_opts
op_assign
id|vptr-&gt;options.wol_opts
suffix:semicolon
id|vptr-&gt;flags
op_or_assign
id|VELOCITY_FLAGS_WOL_ENABLED
suffix:semicolon
id|vptr-&gt;phy_id
op_assign
id|MII_GET_PHY_ID
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;open
op_assign
id|velocity_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|velocity_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
id|velocity_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|velocity_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|velocity_set_multi
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|velocity_ioctl
suffix:semicolon
id|dev-&gt;ethtool_ops
op_assign
op_amp
id|velocity_ethtool_ops
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|velocity_change_mtu
suffix:semicolon
macro_line|#ifdef  VELOCITY_ZERO_COPY_SUPPORT
id|dev-&gt;features
op_or_assign
id|NETIF_F_SG
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_TX_CSUM
)paren
(brace
id|dev-&gt;features
op_or_assign
id|NETIF_F_HW_CSUM
suffix:semicolon
)brace
id|ret
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|err_iounmap
suffix:semicolon
id|velocity_print_info
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* and leave the chip powered down */
id|pci_set_power_state
c_func
(paren
id|pdev
comma
l_int|3
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PM
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|velocity_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|vptr-&gt;list
comma
op_amp
id|velocity_dev_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|velocity_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
id|velocity_nics
op_increment
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
id|err_iounmap
suffix:colon
id|iounmap
c_func
(paren
id|regs
)paren
suffix:semicolon
id|err_release_res
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_free_dev
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_print_info&t;-&t;per driver data&n; *&t;@vptr: velocity&n; *&n; *&t;Print per driver data as the kernel driver finds Velocity&n; *&t;hardware&n; */
DECL|function|velocity_print_info
r_static
r_void
id|__devinit
id|velocity_print_info
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|vptr-&gt;dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|get_chip_name
c_func
(paren
id|vptr-&gt;chip_id
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Ethernet Address: %2.2X:%2.2X:%2.2X:%2.2X:%2.2X:%2.2X&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_init_info&t;-&t;init private data&n; *&t;@pdev: PCI device&n; *&t;@vptr: Velocity info&n; *&t;@info: Board type&n; *&n; *&t;Set up the initial velocity_info struct for the device that has been&n; *&t;discovered.&n; */
DECL|function|velocity_init_info
r_static
r_void
id|__devinit
id|velocity_init_info
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|velocity_info
op_star
id|vptr
comma
r_struct
id|velocity_info_tbl
op_star
id|info
)paren
(brace
id|memset
c_func
(paren
id|vptr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|velocity_info
)paren
)paren
suffix:semicolon
id|vptr-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|vptr-&gt;chip_id
op_assign
id|info-&gt;chip_id
suffix:semicolon
id|vptr-&gt;io_size
op_assign
id|info-&gt;io_size
suffix:semicolon
id|vptr-&gt;num_txq
op_assign
id|info-&gt;txqueue
suffix:semicolon
id|vptr-&gt;multicast_limit
op_assign
id|MCAM_SIZE
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|vptr-&gt;lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|vptr-&gt;list
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_get_pci_info&t;-&t;retrieve PCI info for device&n; *&t;@vptr: velocity device&n; *&t;@pdev: PCI device it matches&n; *&n; *&t;Retrieve the PCI configuration space data that interests us from&n; *&t;the kernel PCI layer&n; */
DECL|function|velocity_get_pci_info
r_static
r_int
id|__devinit
id|velocity_get_pci_info
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|vptr-&gt;rev_id
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|vptr-&gt;ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|vptr-&gt;memaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_IO
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: region #0 is not an I/O resource, aborting.&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|1
)paren
op_amp
id|IORESOURCE_IO
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: region #1 is an I/O resource, aborting.&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
OL
l_int|256
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: region #1 is too small.&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|vptr-&gt;pdev
op_assign
id|pdev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_init_rings&t;-&t;set up DMA rings&n; *&t;@vptr: Velocity to set up&n; *&n; *&t;Allocate PCI mapped DMA rings for the receive and transmit layer&n; *&t;to use.&n; */
DECL|function|velocity_init_rings
r_static
r_int
id|velocity_init_rings
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|psize
suffix:semicolon
r_int
r_int
id|tsize
suffix:semicolon
id|dma_addr_t
id|pool_dma
suffix:semicolon
id|u8
op_star
id|pool
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Allocate all RD/TD rings a single pool &n;&t; */
id|psize
op_assign
id|vptr-&gt;options.numrx
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
op_plus
id|vptr-&gt;options.numtx
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
op_star
id|vptr-&gt;num_txq
suffix:semicolon
multiline_comment|/*&n;&t; * pci_alloc_consistent() fulfills the requirement for 64 bytes&n;&t; * alignment&n;&t; */
id|pool
op_assign
id|pci_alloc_consistent
c_func
(paren
id|vptr-&gt;pdev
comma
id|psize
comma
op_amp
id|pool_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pool
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s : DMA memory allocation failed.&bslash;n&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pool
comma
l_int|0
comma
id|psize
)paren
suffix:semicolon
id|vptr-&gt;rd_ring
op_assign
(paren
r_struct
id|rx_desc
op_star
)paren
id|pool
suffix:semicolon
id|vptr-&gt;rd_pool_dma
op_assign
id|pool_dma
suffix:semicolon
id|tsize
op_assign
id|vptr-&gt;options.numtx
op_star
id|PKT_BUF_SZ
op_star
id|vptr-&gt;num_txq
suffix:semicolon
id|vptr-&gt;tx_bufs
op_assign
id|pci_alloc_consistent
c_func
(paren
id|vptr-&gt;pdev
comma
id|tsize
comma
op_amp
id|vptr-&gt;tx_bufs_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;tx_bufs
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: DMA memory allocation failed.&bslash;n&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|vptr-&gt;pdev
comma
id|psize
comma
id|pool
comma
id|pool_dma
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|vptr-&gt;tx_bufs
comma
l_int|0
comma
id|vptr-&gt;options.numtx
op_star
id|PKT_BUF_SZ
op_star
id|vptr-&gt;num_txq
)paren
suffix:semicolon
id|i
op_assign
id|vptr-&gt;options.numrx
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
id|pool
op_add_assign
id|i
suffix:semicolon
id|pool_dma
op_add_assign
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vptr-&gt;num_txq
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|offset
op_assign
id|vptr-&gt;options.numtx
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
suffix:semicolon
id|vptr-&gt;td_pool_dma
(braket
id|i
)braket
op_assign
id|pool_dma
suffix:semicolon
id|vptr-&gt;td_rings
(braket
id|i
)braket
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
id|pool
suffix:semicolon
id|pool
op_add_assign
id|offset
suffix:semicolon
id|pool_dma
op_add_assign
id|offset
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_free_rings&t;-&t;free PCI ring pointers&n; *&t;@vptr: Velocity to free from&n; *&n; *&t;Clean up the PCI ring buffers allocated to this velocity.&n; */
DECL|function|velocity_free_rings
r_static
r_void
id|velocity_free_rings
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_int
id|size
suffix:semicolon
id|size
op_assign
id|vptr-&gt;options.numrx
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
op_plus
id|vptr-&gt;options.numtx
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
op_star
id|vptr-&gt;num_txq
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|vptr-&gt;pdev
comma
id|size
comma
id|vptr-&gt;rd_ring
comma
id|vptr-&gt;rd_pool_dma
)paren
suffix:semicolon
id|size
op_assign
id|vptr-&gt;options.numtx
op_star
id|PKT_BUF_SZ
op_star
id|vptr-&gt;num_txq
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|vptr-&gt;pdev
comma
id|size
comma
id|vptr-&gt;tx_bufs
comma
id|vptr-&gt;tx_bufs_dma
)paren
suffix:semicolon
)brace
DECL|function|velocity_give_many_rx_descs
r_static
r_inline
r_void
id|velocity_give_many_rx_descs
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_int
id|avail
comma
id|dirty
comma
id|unusable
suffix:semicolon
multiline_comment|/*&n;&t; * RD number must be equal to 4X per hardware spec&n;&t; * (programming guide rev 1.20, p.13)&n;&t; */
r_if
c_cond
(paren
id|vptr-&gt;rd_filled
OL
l_int|4
)paren
r_return
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|unusable
op_assign
id|vptr-&gt;rd_filled
op_amp
l_int|0x0003
suffix:semicolon
id|dirty
op_assign
id|vptr-&gt;rd_dirty
op_minus
id|unusable
suffix:semicolon
r_for
c_loop
(paren
id|avail
op_assign
id|vptr-&gt;rd_filled
op_amp
l_int|0xfffc
suffix:semicolon
id|avail
suffix:semicolon
id|avail
op_decrement
)paren
(brace
id|dirty
op_assign
(paren
id|dirty
OG
l_int|0
)paren
ques
c_cond
id|dirty
op_minus
l_int|1
suffix:colon
id|vptr-&gt;options.numrx
op_minus
l_int|1
suffix:semicolon
id|vptr-&gt;rd_ring
(braket
id|dirty
)braket
dot
id|rdesc0.owner
op_assign
id|OWNED_BY_NIC
suffix:semicolon
)brace
id|writew
c_func
(paren
id|vptr-&gt;rd_filled
op_amp
l_int|0xfffc
comma
op_amp
id|regs-&gt;RBRDU
)paren
suffix:semicolon
id|vptr-&gt;rd_filled
op_assign
id|unusable
suffix:semicolon
)brace
DECL|function|velocity_rx_refill
r_static
r_int
id|velocity_rx_refill
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_int
id|dirty
op_assign
id|vptr-&gt;rd_dirty
comma
id|done
op_assign
l_int|0
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_struct
id|rx_desc
op_star
id|rd
op_assign
id|vptr-&gt;rd_ring
op_plus
id|dirty
suffix:semicolon
multiline_comment|/* Fine for an all zero Rx desc at init time as well */
r_if
c_cond
(paren
id|rd-&gt;rdesc0.owner
op_eq
id|OWNED_BY_NIC
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vptr-&gt;rd_info
(braket
id|dirty
)braket
dot
id|skb
)paren
(brace
id|ret
op_assign
id|velocity_alloc_rx_buf
c_func
(paren
id|vptr
comma
id|dirty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|done
op_increment
suffix:semicolon
id|dirty
op_assign
(paren
id|dirty
OL
id|vptr-&gt;options.numrx
op_minus
l_int|1
)paren
ques
c_cond
id|dirty
op_plus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|dirty
op_ne
id|vptr-&gt;rd_curr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
(brace
id|vptr-&gt;rd_dirty
op_assign
id|dirty
suffix:semicolon
id|vptr-&gt;rd_filled
op_add_assign
id|done
suffix:semicolon
id|velocity_give_many_rx_descs
c_func
(paren
id|vptr
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_init_rd_ring&t;-&t;set up receive ring&n; *&t;@vptr: velocity to configure&n; *&n; *&t;Allocate and set up the receive buffers for each ring slot and&n; *&t;assign them to the network adapter.&n; */
DECL|function|velocity_init_rd_ring
r_static
r_int
id|velocity_init_rd_ring
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_int
r_int
id|rsize
op_assign
r_sizeof
(paren
r_struct
id|velocity_rd_info
)paren
op_star
id|vptr-&gt;options.numrx
suffix:semicolon
id|vptr-&gt;rd_info
op_assign
id|kmalloc
c_func
(paren
id|rsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;rd_info
op_eq
l_int|NULL
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|vptr-&gt;rd_info
comma
l_int|0
comma
id|rsize
)paren
suffix:semicolon
id|vptr-&gt;rd_filled
op_assign
id|vptr-&gt;rd_dirty
op_assign
id|vptr-&gt;rd_curr
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|velocity_rx_refill
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_ERR
comma
id|KERN_ERR
l_string|&quot;%s: failed to allocate RX buffer.&bslash;n&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
id|velocity_free_rd_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_free_rd_ring&t;-&t;set up receive ring&n; *&t;@vptr: velocity to clean up&n; *&n; *&t;Free the receive buffers for each ring slot and any&n; *&t;attached socket buffers that need to go away.&n; */
DECL|function|velocity_free_rd_ring
r_static
r_void
id|velocity_free_rd_ring
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;rd_info
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vptr-&gt;options.numrx
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|velocity_rd_info
op_star
id|rd_info
op_assign
op_amp
(paren
id|vptr-&gt;rd_info
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rd_info-&gt;skb
)paren
r_continue
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|vptr-&gt;pdev
comma
id|rd_info-&gt;skb_dma
comma
id|vptr-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rd_info-&gt;skb_dma
op_assign
(paren
id|dma_addr_t
)paren
l_int|NULL
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|rd_info-&gt;skb
)paren
suffix:semicolon
id|rd_info-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|vptr-&gt;rd_info
)paren
suffix:semicolon
id|vptr-&gt;rd_info
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_init_td_ring&t;-&t;set up transmit ring&n; *&t;@vptr:&t;velocity&n; *&n; *&t;Set up the transmit ring and chain the ring pointers together.&n; *&t;Returns zero on success or a negative posix errno code for&n; *&t;failure.&n; */
DECL|function|velocity_init_td_ring
r_static
r_int
id|velocity_init_td_ring
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|dma_addr_t
id|curr
suffix:semicolon
r_struct
id|tx_desc
op_star
id|td
suffix:semicolon
r_struct
id|velocity_td_info
op_star
id|td_info
suffix:semicolon
r_int
r_int
id|tsize
op_assign
r_sizeof
(paren
r_struct
id|velocity_td_info
)paren
op_star
id|vptr-&gt;options.numtx
suffix:semicolon
multiline_comment|/* Init the TD ring entries */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|vptr-&gt;num_txq
suffix:semicolon
id|j
op_increment
)paren
(brace
id|curr
op_assign
id|vptr-&gt;td_pool_dma
(braket
id|j
)braket
suffix:semicolon
id|vptr-&gt;td_infos
(braket
id|j
)braket
op_assign
id|kmalloc
c_func
(paren
id|tsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;td_infos
(braket
id|j
)braket
op_eq
l_int|NULL
)paren
(brace
r_while
c_loop
(paren
op_decrement
id|j
op_ge
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|vptr-&gt;td_infos
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|vptr-&gt;td_infos
(braket
id|j
)braket
comma
l_int|0
comma
id|tsize
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vptr-&gt;options.numtx
suffix:semicolon
id|i
op_increment
comma
id|curr
op_add_assign
r_sizeof
(paren
r_struct
id|tx_desc
)paren
)paren
(brace
id|td
op_assign
op_amp
(paren
id|vptr-&gt;td_rings
(braket
id|j
)braket
(braket
id|i
)braket
)paren
suffix:semicolon
id|td_info
op_assign
op_amp
(paren
id|vptr-&gt;td_infos
(braket
id|j
)braket
(braket
id|i
)braket
)paren
suffix:semicolon
id|td_info-&gt;buf
op_assign
id|vptr-&gt;tx_bufs
op_plus
(paren
id|i
op_plus
id|j
)paren
op_star
id|PKT_BUF_SZ
suffix:semicolon
id|td_info-&gt;buf_dma
op_assign
id|vptr-&gt;tx_bufs_dma
op_plus
(paren
id|i
op_plus
id|j
)paren
op_star
id|PKT_BUF_SZ
suffix:semicolon
)brace
id|vptr-&gt;td_tail
(braket
id|j
)braket
op_assign
id|vptr-&gt;td_curr
(braket
id|j
)braket
op_assign
id|vptr-&gt;td_used
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;FIXME: could we merge this with velocity_free_tx_buf ?&n; */
DECL|function|velocity_free_td_ring_entry
r_static
r_void
id|velocity_free_td_ring_entry
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_int
id|q
comma
r_int
id|n
)paren
(brace
r_struct
id|velocity_td_info
op_star
id|td_info
op_assign
op_amp
(paren
id|vptr-&gt;td_infos
(braket
id|q
)braket
(braket
id|n
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|td_info
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|td_info-&gt;skb
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|td_info-&gt;nskb_dma
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|td_info-&gt;skb_dma
(braket
id|i
)braket
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|vptr-&gt;pdev
comma
id|td_info-&gt;skb_dma
(braket
id|i
)braket
comma
id|td_info-&gt;skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|td_info-&gt;skb_dma
(braket
id|i
)braket
op_assign
(paren
id|dma_addr_t
)paren
l_int|NULL
suffix:semicolon
)brace
)brace
id|dev_kfree_skb
c_func
(paren
id|td_info-&gt;skb
)paren
suffix:semicolon
id|td_info-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_free_td_ring&t;-&t;free td ring&n; *&t;@vptr: velocity&n; *&n; *&t;Free up the transmit ring for this particular velocity adapter.&n; *&t;We free the ring contents but not the ring itself.&n; */
DECL|function|velocity_free_td_ring
r_static
r_void
id|velocity_free_td_ring
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|vptr-&gt;num_txq
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|vptr-&gt;td_infos
(braket
id|j
)braket
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vptr-&gt;options.numtx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|velocity_free_td_ring_entry
c_func
(paren
id|vptr
comma
id|j
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vptr-&gt;td_infos
(braket
id|j
)braket
)paren
(brace
id|kfree
c_func
(paren
id|vptr-&gt;td_infos
(braket
id|j
)braket
)paren
suffix:semicolon
id|vptr-&gt;td_infos
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; *&t;velocity_rx_srv&t;&t;-&t;service RX interrupt&n; *&t;@vptr: velocity&n; *&t;@status: adapter status (unused)&n; *&n; *&t;Walk the receive ring of the velocity adapter and remove&n; *&t;any received packets from the receive queue. Hand the ring&n; *&t;slots back to the adapter for reuse.&n; */
DECL|function|velocity_rx_srv
r_static
r_int
id|velocity_rx_srv
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_int
id|status
)paren
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|vptr-&gt;stats
suffix:semicolon
r_int
id|rd_curr
op_assign
id|vptr-&gt;rd_curr
suffix:semicolon
r_int
id|works
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_struct
id|rx_desc
op_star
id|rd
op_assign
id|vptr-&gt;rd_ring
op_plus
id|rd_curr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vptr-&gt;rd_info
(braket
id|rd_curr
)braket
dot
id|skb
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;rdesc0.owner
op_eq
id|OWNED_BY_NIC
)paren
r_break
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Don&squot;t drop CE or RL error frame although RXOK is off&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|rd-&gt;rdesc0.RSR
op_amp
id|RSR_RXOK
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|rd-&gt;rdesc0.RSR
op_amp
id|RSR_RXOK
)paren
op_logical_and
(paren
id|rd-&gt;rdesc0.RSR
op_amp
(paren
id|RSR_CE
op_or
id|RSR_RL
)paren
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|velocity_receive_frame
c_func
(paren
id|vptr
comma
id|rd_curr
)paren
OL
l_int|0
)paren
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|rd-&gt;rdesc0.RSR
op_amp
id|RSR_CRC
)paren
id|stats-&gt;rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;rdesc0.RSR
op_amp
id|RSR_FAE
)paren
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
)brace
id|rd-&gt;inten
op_assign
l_int|1
suffix:semicolon
id|vptr-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|rd_curr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rd_curr
op_ge
id|vptr-&gt;options.numrx
)paren
id|rd_curr
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|works
op_le
l_int|15
)paren
suffix:semicolon
id|vptr-&gt;rd_curr
op_assign
id|rd_curr
suffix:semicolon
r_if
c_cond
(paren
id|works
OG
l_int|0
op_logical_and
id|velocity_rx_refill
c_func
(paren
id|vptr
)paren
OL
l_int|0
)paren
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_ERR
comma
id|KERN_ERR
l_string|&quot;%s: rx buf allocation failure&bslash;n&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
id|VAR_USED
c_func
(paren
id|stats
)paren
suffix:semicolon
r_return
id|works
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_rx_csum&t;-&t;checksum process&n; *&t;@rd: receive packet descriptor&n; *&t;@skb: network layer packet buffer&n; *&n; *&t;Process the status bits for the received packet and determine&n; *&t;if the checksum was computed and verified by the hardware&n; */
DECL|function|velocity_rx_csum
r_static
r_inline
r_void
id|velocity_rx_csum
c_func
(paren
r_struct
id|rx_desc
op_star
id|rd
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;rdesc1.CSM
op_amp
id|CSM_IPKT
)paren
(brace
r_if
c_cond
(paren
id|rd-&gt;rdesc1.CSM
op_amp
id|CSM_IPOK
)paren
(brace
r_if
c_cond
(paren
(paren
id|rd-&gt;rdesc1.CSM
op_amp
id|CSM_TCPKT
)paren
op_logical_or
(paren
id|rd-&gt;rdesc1.CSM
op_amp
id|CSM_UDPKT
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rd-&gt;rdesc1.CSM
op_amp
id|CSM_TUPOK
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; *&t;velocity_rx_copy&t;-&t;in place Rx copy for small packets&n; *&t;@rx_skb: network layer packet buffer candidate&n; *&t;@pkt_size: received data size&n; *&t;@rd: receive packet descriptor&n; *&t;@dev: network device&n; *&n; *&t;Replace the current skb that is scheduled for Rx processing by a&n; *&t;shorter, immediatly allocated skb, if the received packet is small&n; *&t;enough. This function returns a negative value if the received&n; *&t;packet is too big or if memory is exhausted.&n; */
DECL|function|velocity_rx_copy
r_static
r_inline
r_int
id|velocity_rx_copy
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|rx_skb
comma
r_int
id|pkt_size
comma
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pkt_size
OL
id|rx_copybreak
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_size
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_skb
)paren
(brace
id|new_skb-&gt;dev
op_assign
id|vptr-&gt;dev
suffix:semicolon
id|new_skb-&gt;ip_summed
op_assign
id|rx_skb
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ip_summed
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_IP_ALIGN
)paren
id|skb_reserve
c_func
(paren
id|new_skb
comma
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|new_skb-&gt;data
comma
id|rx_skb
(braket
l_int|0
)braket
op_member_access_from_pointer
id|tail
comma
id|pkt_size
)paren
suffix:semicolon
op_star
id|rx_skb
op_assign
id|new_skb
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_iph_realign&t;-&t;IP header alignment&n; *&t;@vptr: velocity we are handling&n; *&t;@skb: network layer packet buffer&n; *&t;@pkt_size: received data size&n; *&n; *&t;Align IP header on a 2 bytes boundary. This behavior can be&n; *&t;configured by the user.&n; */
DECL|function|velocity_iph_realign
r_static
r_inline
r_void
id|velocity_iph_realign
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|pkt_size
)paren
(brace
multiline_comment|/* FIXME - memmove ? */
r_if
c_cond
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_IP_ALIGN
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|pkt_size
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
op_star
(paren
id|skb-&gt;data
op_plus
id|i
op_plus
l_int|2
)paren
op_assign
op_star
(paren
id|skb-&gt;data
op_plus
id|i
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_receive_frame&t;-&t;received packet processor&n; *&t;@vptr: velocity we are handling&n; *&t;@idx: ring index&n; *&t;&n; *&t;A packet has arrived. We process the packet and if appropriate&n; *&t;pass the frame up the network stack&n; */
DECL|function|velocity_receive_frame
r_static
r_int
id|velocity_receive_frame
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_int
id|idx
)paren
(brace
r_void
(paren
op_star
id|pci_action
)paren
(paren
r_struct
id|pci_dev
op_star
comma
id|dma_addr_t
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|vptr-&gt;stats
suffix:semicolon
r_struct
id|velocity_rd_info
op_star
id|rd_info
op_assign
op_amp
(paren
id|vptr-&gt;rd_info
(braket
id|idx
)braket
)paren
suffix:semicolon
r_struct
id|rx_desc
op_star
id|rd
op_assign
op_amp
(paren
id|vptr-&gt;rd_ring
(braket
id|idx
)braket
)paren
suffix:semicolon
r_int
id|pkt_len
op_assign
id|rd-&gt;rdesc0.len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;rdesc0.RSR
op_amp
(paren
id|RSR_STP
op_or
id|RSR_EDP
)paren
)paren
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_VERBOSE
comma
id|KERN_ERR
l_string|&quot; %s : the received frame span multple RDs.&bslash;n&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rd-&gt;rdesc0.RSR
op_amp
id|RSR_MAR
)paren
id|vptr-&gt;stats.multicast
op_increment
suffix:semicolon
id|skb
op_assign
id|rd_info-&gt;skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|vptr-&gt;dev
suffix:semicolon
id|pci_dma_sync_single_for_cpu
c_func
(paren
id|vptr-&gt;pdev
comma
id|rd_info-&gt;skb_dma
comma
id|vptr-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Drop frame not meeting IEEE 802.3&n;&t; */
r_if
c_cond
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_VAL_PKT_LEN
)paren
(brace
r_if
c_cond
(paren
id|rd-&gt;rdesc0.RSR
op_amp
id|RSR_RL
)paren
(brace
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|pci_action
op_assign
id|pci_dma_sync_single_for_device
suffix:semicolon
id|velocity_rx_csum
c_func
(paren
id|rd
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|velocity_rx_copy
c_func
(paren
op_amp
id|skb
comma
id|pkt_len
comma
id|vptr
)paren
OL
l_int|0
)paren
(brace
id|velocity_iph_realign
c_func
(paren
id|vptr
comma
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
id|pci_action
op_assign
id|pci_unmap_single
suffix:semicolon
id|rd_info-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pci_action
c_func
(paren
id|vptr-&gt;pdev
comma
id|rd_info-&gt;skb_dma
comma
id|vptr-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
op_minus
l_int|4
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|skb-&gt;dev
)paren
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_alloc_rx_buf&t;-&t;allocate aligned receive buffer&n; *&t;@vptr: velocity&n; *&t;@idx: ring index&n; *&n; *&t;Allocate a new full sized buffer for the reception of a frame and&n; *&t;map it into PCI space for the hardware to use. The hardware&n; *&t;requires *64* byte alignment of the buffer which makes life&n; *&t;less fun than would be ideal.&n; */
DECL|function|velocity_alloc_rx_buf
r_static
r_int
id|velocity_alloc_rx_buf
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_int
id|idx
)paren
(brace
r_struct
id|rx_desc
op_star
id|rd
op_assign
op_amp
(paren
id|vptr-&gt;rd_ring
(braket
id|idx
)braket
)paren
suffix:semicolon
r_struct
id|velocity_rd_info
op_star
id|rd_info
op_assign
op_amp
(paren
id|vptr-&gt;rd_info
(braket
id|idx
)braket
)paren
suffix:semicolon
id|rd_info-&gt;skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|vptr-&gt;rx_buf_sz
op_plus
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd_info-&gt;skb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Do the gymnastics to get the buffer head for data at&n;&t; *&t;64byte alignment.&n;&t; */
id|skb_reserve
c_func
(paren
id|rd_info-&gt;skb
comma
(paren
r_int
r_int
)paren
id|rd_info-&gt;skb-&gt;tail
op_amp
l_int|63
)paren
suffix:semicolon
id|rd_info-&gt;skb-&gt;dev
op_assign
id|vptr-&gt;dev
suffix:semicolon
id|rd_info-&gt;skb_dma
op_assign
id|pci_map_single
c_func
(paren
id|vptr-&gt;pdev
comma
id|rd_info-&gt;skb-&gt;tail
comma
id|vptr-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fill in the descriptor to match&n; &t; */
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
(paren
id|rd-&gt;rdesc0
)paren
)paren
op_assign
l_int|0
suffix:semicolon
id|rd-&gt;len
op_assign
id|cpu_to_le32
c_func
(paren
id|vptr-&gt;rx_buf_sz
)paren
suffix:semicolon
id|rd-&gt;inten
op_assign
l_int|1
suffix:semicolon
id|rd-&gt;pa_low
op_assign
id|cpu_to_le32
c_func
(paren
id|rd_info-&gt;skb_dma
)paren
suffix:semicolon
id|rd-&gt;pa_high
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;tx_srv&t;&t;-&t;transmit interrupt service&n; *&t;@vptr; Velocity&n; *&t;@status:&n; *&n; *&t;Scan the queues looking for transmitted packets that&n; *&t;we can complete and clean up. Update any statistics as&n; *&t;neccessary/&n; */
DECL|function|velocity_tx_srv
r_static
r_int
id|velocity_tx_srv
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
id|u32
id|status
)paren
(brace
r_struct
id|tx_desc
op_star
id|td
suffix:semicolon
r_int
id|qnum
suffix:semicolon
r_int
id|full
op_assign
l_int|0
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_int
id|works
op_assign
l_int|0
suffix:semicolon
r_struct
id|velocity_td_info
op_star
id|tdinfo
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|vptr-&gt;stats
suffix:semicolon
r_for
c_loop
(paren
id|qnum
op_assign
l_int|0
suffix:semicolon
id|qnum
OL
id|vptr-&gt;num_txq
suffix:semicolon
id|qnum
op_increment
)paren
(brace
r_for
c_loop
(paren
id|idx
op_assign
id|vptr-&gt;td_tail
(braket
id|qnum
)braket
suffix:semicolon
id|vptr-&gt;td_used
(braket
id|qnum
)braket
OG
l_int|0
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|vptr-&gt;options.numtx
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Get Tx Descriptor&n;&t;&t;&t; */
id|td
op_assign
op_amp
(paren
id|vptr-&gt;td_rings
(braket
id|qnum
)braket
(braket
id|idx
)braket
)paren
suffix:semicolon
id|tdinfo
op_assign
op_amp
(paren
id|vptr-&gt;td_infos
(braket
id|qnum
)braket
(braket
id|idx
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tdesc0.owner
op_eq
id|OWNED_BY_NIC
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|works
op_increment
OG
l_int|15
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tdesc0.TSR
op_amp
id|TSR0_TERR
)paren
(brace
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tdesc0.TSR
op_amp
id|TSR0_CDH
)paren
id|stats-&gt;tx_heartbeat_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tdesc0.TSR
op_amp
id|TSR0_CRS
)paren
id|stats-&gt;tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tdesc0.TSR
op_amp
id|TSR0_ABT
)paren
id|stats-&gt;tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tdesc0.TSR
op_amp
id|TSR0_OWC
)paren
id|stats-&gt;tx_window_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|tdinfo-&gt;skb-&gt;len
suffix:semicolon
)brace
id|velocity_free_tx_buf
c_func
(paren
id|vptr
comma
id|tdinfo
)paren
suffix:semicolon
id|vptr-&gt;td_used
(braket
id|qnum
)braket
op_decrement
suffix:semicolon
)brace
id|vptr-&gt;td_tail
(braket
id|qnum
)braket
op_assign
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|AVAIL_TD
c_func
(paren
id|vptr
comma
id|qnum
)paren
OL
l_int|1
)paren
(brace
id|full
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;Look to see if we should kick the transmit network&n;&t; *&t;layer for more work.&n;&t; */
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|vptr-&gt;dev
)paren
op_logical_and
(paren
id|full
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_LINK_FAIL
)paren
)paren
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
)brace
r_return
id|works
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_print_link_status&t;-&t;link status reporting&n; *&t;@vptr: velocity to report on&n; *&n; *&t;Turn the link status of the velocity card into a kernel log&n; *&t;description of the new link state, detailing speed and duplex&n; *&t;status&n; */
DECL|function|velocity_print_link_status
r_static
r_void
id|velocity_print_link_status
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_LINK_FAIL
)paren
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
id|KERN_NOTICE
l_string|&quot;%s: failed to detect cable link&bslash;n&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vptr-&gt;options.spd_dpx
op_eq
id|SPD_DPX_AUTO
)paren
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
id|KERN_NOTICE
l_string|&quot;%s: Link autonegation&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_SPEED_1000
)paren
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; speed 1000M bps&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_SPEED_100
)paren
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; speed 100M bps&quot;
)paren
suffix:semicolon
r_else
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; speed 10M bps&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; full duplex&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; half duplex&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
id|KERN_NOTICE
l_string|&quot;%s: Link forced&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|vptr-&gt;options.spd_dpx
)paren
(brace
r_case
id|SPD_DPX_100_HALF
suffix:colon
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; speed 100M bps half duplex&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPD_DPX_100_FULL
suffix:colon
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; speed 100M bps full duplex&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPD_DPX_10_HALF
suffix:colon
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; speed 10M bps half duplex&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPD_DPX_10_FULL
suffix:colon
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot; speed 10M bps full duplex&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; *&t;velocity_error&t;-&t;handle error from controller&n; *&t;@vptr: velocity&n; *&t;@status: card status&n; *&n; *&t;Process an error report from the hardware and attempt to recover&n; *&t;the card itself. At the moment we cannot recover from some &n; *&t;theoretically impossible errors but this could be fixed using&n; *&t;the pci_device_failed logic to bounce the hardware&n; *&n; */
DECL|function|velocity_error
r_static
r_void
id|velocity_error
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_int
id|status
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|ISR_TXSTLI
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;TD structure errror TDindex=%hx&bslash;n&quot;
comma
id|readw
c_func
(paren
op_amp
id|regs-&gt;TDIdx
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|BYTE_REG_BITS_ON
c_func
(paren
id|TXESR_TDSTR
comma
op_amp
id|regs-&gt;TXESR
)paren
suffix:semicolon
id|writew
c_func
(paren
id|TRDCSR_RUN
comma
op_amp
id|regs-&gt;TDCSRClr
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* FIXME: port over the pci_device_failed code and use it&n;&t;&t;   here */
)brace
r_if
c_cond
(paren
id|status
op_amp
id|ISR_SRCI
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_int
id|linked
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;options.spd_dpx
op_eq
id|SPD_DPX_AUTO
)paren
(brace
id|vptr-&gt;mii_status
op_assign
id|check_connection_type
c_func
(paren
id|regs
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;If it is a 3119, disable frame bursting in &n;&t;&t;&t; *&t;halfduplex mode and enable it in fullduplex&n;&t;&t;&t; *&t; mode&n;&t;&t;&t; */
r_if
c_cond
(paren
id|vptr-&gt;rev_id
OL
id|REV_ID_VT3216_A0
)paren
(brace
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_or
id|VELOCITY_DUPLEX_FULL
)paren
id|BYTE_REG_BITS_ON
c_func
(paren
id|TCR_TB2BDIS
comma
op_amp
id|regs-&gt;TCR
)paren
suffix:semicolon
r_else
id|BYTE_REG_BITS_OFF
c_func
(paren
id|TCR_TB2BDIS
comma
op_amp
id|regs-&gt;TCR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Only enable CD heart beat counter in 10HD mode&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
op_logical_and
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_SPEED_10
)paren
)paren
(brace
id|BYTE_REG_BITS_OFF
c_func
(paren
id|TESTCFG_HBDIS
comma
op_amp
id|regs-&gt;TESTCFG
)paren
suffix:semicolon
)brace
r_else
(brace
id|BYTE_REG_BITS_ON
c_func
(paren
id|TESTCFG_HBDIS
comma
op_amp
id|regs-&gt;TESTCFG
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; *&t;Get link status from PHYSR0&n;&t;&t; */
id|linked
op_assign
id|readb
c_func
(paren
op_amp
id|regs-&gt;PHYSR0
)paren
op_amp
id|PHYSR0_LINKGD
suffix:semicolon
r_if
c_cond
(paren
id|linked
)paren
(brace
id|vptr-&gt;mii_status
op_and_assign
op_complement
id|VELOCITY_LINK_FAIL
suffix:semicolon
)brace
r_else
(brace
id|vptr-&gt;mii_status
op_or_assign
id|VELOCITY_LINK_FAIL
suffix:semicolon
)brace
id|velocity_print_link_status
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|enable_flow_control_ability
c_func
(paren
id|vptr
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Re-enable auto-polling because SRCI will disable &n;&t;&t; *&t;auto-polling&n;&t;&t; */
id|enable_mii_autopoll
c_func
(paren
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_LINK_FAIL
)paren
id|netif_stop_queue
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
r_else
id|netif_wake_queue
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ISR_MIBFI
)paren
id|velocity_update_hw_mibs
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ISR_LSTEI
)paren
id|mac_rx_queue_wake
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_free_tx_buf&t;-&t;free transmit buffer&n; *&t;@vptr: velocity&n; *&t;@tdinfo: buffer&n; *&n; *&t;Release an transmit buffer. If the buffer was preallocated then&n; *&t;recycle it, if not then unmap the buffer.&n; */
DECL|function|velocity_free_tx_buf
r_static
r_void
id|velocity_free_tx_buf
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_struct
id|velocity_td_info
op_star
id|tdinfo
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|tdinfo-&gt;skb
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Don&squot;t unmap the pre-allocated tx_bufs&n;&t; */
r_if
c_cond
(paren
id|tdinfo-&gt;skb_dma
op_logical_and
(paren
id|tdinfo-&gt;skb_dma
(braket
l_int|0
)braket
op_ne
id|tdinfo-&gt;buf_dma
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tdinfo-&gt;nskb_dma
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#ifdef VELOCITY_ZERO_COPY_SUPPORT
id|pci_unmap_single
c_func
(paren
id|vptr-&gt;pdev
comma
id|tdinfo-&gt;skb_dma
(braket
id|i
)braket
comma
id|td-&gt;tdesc1.len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
macro_line|#else
id|pci_unmap_single
c_func
(paren
id|vptr-&gt;pdev
comma
id|tdinfo-&gt;skb_dma
(braket
id|i
)braket
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
macro_line|#endif
id|tdinfo-&gt;skb_dma
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|tdinfo-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_open&t;&t;-&t;interface activation callback&n; *&t;@dev: network layer device to open&n; *&n; *&t;Called when the network layer brings the interface up. Returns&n; *&t;a negative posix error code on failure, or zero on success.&n; *&n; *&t;All the ring allocation and set up is done on open for this&n; *&t;adapter to minimise memory usage when inactive&n; */
DECL|function|velocity_open
r_static
r_int
id|velocity_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|vptr-&gt;rx_buf_sz
op_assign
(paren
id|dev-&gt;mtu
op_le
l_int|1504
ques
c_cond
id|PKT_BUF_SZ
suffix:colon
id|dev-&gt;mtu
op_plus
l_int|32
)paren
suffix:semicolon
id|ret
op_assign
id|velocity_init_rings
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
id|velocity_init_rd_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|err_free_desc_rings
suffix:semicolon
id|ret
op_assign
id|velocity_init_td_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|err_free_rd_ring
suffix:semicolon
multiline_comment|/* Ensure chip is running */
id|pci_set_power_state
c_func
(paren
id|vptr-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
id|velocity_init_registers
c_func
(paren
id|vptr
comma
id|VELOCITY_INIT_COLD
)paren
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|vptr-&gt;pdev-&gt;irq
comma
op_amp
id|velocity_intr
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
multiline_comment|/* Power down the chip */
id|pci_set_power_state
c_func
(paren
id|vptr-&gt;pdev
comma
l_int|3
)paren
suffix:semicolon
r_goto
id|err_free_td_ring
suffix:semicolon
)brace
id|mac_enable_int
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|vptr-&gt;flags
op_or_assign
id|VELOCITY_FLAGS_OPENED
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
id|err_free_td_ring
suffix:colon
id|velocity_free_td_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|err_free_rd_ring
suffix:colon
id|velocity_free_rd_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|err_free_desc_rings
suffix:colon
id|velocity_free_rings
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/** &n; *&t;velocity_change_mtu&t;-&t;MTU change callback&n; *&t;@dev: network device&n; *&t;@new_mtu: desired MTU&n; *&n; *&t;Handle requests from the networking layer for MTU change on&n; *&t;this interface. It gets called on a change by the network layer.&n; *&t;Return zero for success or negative posix error code.&n; */
DECL|function|velocity_change_mtu
r_static
r_int
id|velocity_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|oldmtu
op_assign
id|dev-&gt;mtu
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_mtu
OL
id|VELOCITY_MIN_MTU
)paren
op_logical_or
id|new_mtu
OG
(paren
id|VELOCITY_MAX_MTU
)paren
)paren
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_ERR
comma
id|KERN_NOTICE
l_string|&quot;%s: Invalid MTU.&bslash;n&quot;
comma
id|vptr-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_mtu
op_ne
id|oldmtu
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|velocity_shutdown
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|velocity_free_td_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|velocity_free_rd_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
OG
l_int|8192
)paren
id|vptr-&gt;rx_buf_sz
op_assign
l_int|9
op_star
l_int|1024
suffix:semicolon
r_else
r_if
c_cond
(paren
id|new_mtu
OG
l_int|4096
)paren
id|vptr-&gt;rx_buf_sz
op_assign
l_int|8192
suffix:semicolon
r_else
id|vptr-&gt;rx_buf_sz
op_assign
l_int|4
op_star
l_int|1024
suffix:semicolon
id|ret
op_assign
id|velocity_init_rd_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out_unlock
suffix:semicolon
id|ret
op_assign
id|velocity_init_td_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out_unlock
suffix:semicolon
id|velocity_init_registers
c_func
(paren
id|vptr
comma
id|VELOCITY_INIT_COLD
)paren
suffix:semicolon
id|mac_enable_int
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_shutdown&t;-&t;shut down the chip&n; *&t;@vptr: velocity to deactivate&n; *&n; *&t;Shuts down the internal operations of the velocity and&n; *&t;disables interrupts, autopolling, transmit and receive&n; */
DECL|function|velocity_shutdown
r_static
r_void
id|velocity_shutdown
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
id|mac_disable_int
c_func
(paren
id|regs
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR0_STOP
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0xFFFF
comma
op_amp
id|regs-&gt;TDCSRClr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xFF
comma
op_amp
id|regs-&gt;RDCSRClr
)paren
suffix:semicolon
id|safe_disable_mii_autopoll
c_func
(paren
id|regs
)paren
suffix:semicolon
id|mac_clear_isr
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_close&t;&t;-&t;close adapter callback&n; *&t;@dev: network device&n; *&n; *&t;Callback from the network layer when the velocity is being&n; *&t;deactivated by the network layer&n; */
DECL|function|velocity_close
r_static
r_int
id|velocity_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|velocity_shutdown
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_WOL_ENABLED
)paren
id|velocity_get_ip
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
op_ne
l_int|0
)paren
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Power down the chip */
id|pci_set_power_state
c_func
(paren
id|vptr-&gt;pdev
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Free the resources */
id|velocity_free_td_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|velocity_free_rd_ring
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|velocity_free_rings
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|vptr-&gt;flags
op_and_assign
(paren
op_complement
id|VELOCITY_FLAGS_OPENED
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_xmit&t;&t;-&t;transmit packet callback&n; *&t;@skb: buffer to transmit&n; *&t;@dev: network device&n; *&n; *&t;Called by the networ layer to request a packet is queued to&n; *&t;the velocity. Returns zero on success.&n; */
DECL|function|velocity_xmit
r_static
r_int
id|velocity_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|qnum
op_assign
l_int|0
suffix:semicolon
r_struct
id|tx_desc
op_star
id|td_ptr
suffix:semicolon
r_struct
id|velocity_td_info
op_star
id|tdinfo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|index
suffix:semicolon
r_int
id|pktlen
op_assign
id|skb-&gt;len
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|index
op_assign
id|vptr-&gt;td_curr
(braket
id|qnum
)braket
suffix:semicolon
id|td_ptr
op_assign
op_amp
(paren
id|vptr-&gt;td_rings
(braket
id|qnum
)braket
(braket
id|index
)braket
)paren
suffix:semicolon
id|tdinfo
op_assign
op_amp
(paren
id|vptr-&gt;td_infos
(braket
id|qnum
)braket
(braket
id|index
)braket
)paren
suffix:semicolon
id|td_ptr-&gt;tdesc1.TCPLS
op_assign
id|TCPLS_NORMAL
suffix:semicolon
id|td_ptr-&gt;tdesc1.TCR
op_assign
id|TCR0_TIC
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|queue
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Pad short frames. &n;&t; */
r_if
c_cond
(paren
id|pktlen
OL
id|ETH_ZLEN
)paren
(brace
multiline_comment|/* Cannot occur until ZC support */
r_if
c_cond
(paren
id|skb_linearize
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|pktlen
op_assign
id|ETH_ZLEN
suffix:semicolon
id|memcpy
c_func
(paren
id|tdinfo-&gt;buf
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tdinfo-&gt;buf
op_plus
id|skb-&gt;len
comma
l_int|0
comma
id|ETH_ZLEN
op_minus
id|skb-&gt;len
)paren
suffix:semicolon
id|tdinfo-&gt;skb
op_assign
id|skb
suffix:semicolon
id|tdinfo-&gt;skb_dma
(braket
l_int|0
)braket
op_assign
id|tdinfo-&gt;buf_dma
suffix:semicolon
id|td_ptr-&gt;tdesc0.pktsize
op_assign
id|pktlen
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|pa_low
op_assign
id|cpu_to_le32
c_func
(paren
id|tdinfo-&gt;skb_dma
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|pa_high
op_assign
l_int|0
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|bufsize
op_assign
id|td_ptr-&gt;tdesc0.pktsize
suffix:semicolon
id|tdinfo-&gt;nskb_dma
op_assign
l_int|1
suffix:semicolon
id|td_ptr-&gt;tdesc1.CMDZ
op_assign
l_int|2
suffix:semicolon
)brace
r_else
macro_line|#ifdef VELOCITY_ZERO_COPY_SUPPORT
r_if
c_cond
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
OG
l_int|0
)paren
(brace
r_int
id|nfrags
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|tdinfo-&gt;skb
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|nfrags
OG
l_int|6
)paren
(brace
id|skb_linearize
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tdinfo-&gt;buf
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|tdinfo-&gt;skb_dma
(braket
l_int|0
)braket
op_assign
id|tdinfo-&gt;buf_dma
suffix:semicolon
id|td_ptr-&gt;tdesc0.pktsize
op_assign
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|pa_low
op_assign
id|cpu_to_le32
c_func
(paren
id|tdinfo-&gt;skb_dma
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|pa_high
op_assign
l_int|0
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|bufsize
op_assign
id|td_ptr-&gt;tdesc0.pktsize
suffix:semicolon
id|tdinfo-&gt;nskb_dma
op_assign
l_int|1
suffix:semicolon
id|td_ptr-&gt;tdesc1.CMDZ
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|tdinfo-&gt;nskb_dma
op_assign
l_int|0
suffix:semicolon
id|tdinfo-&gt;skb_dma
(braket
id|i
)braket
op_assign
id|pci_map_single
c_func
(paren
id|vptr-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
op_minus
id|skb-&gt;data_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|td_ptr-&gt;tdesc0.pktsize
op_assign
id|pktlen
suffix:semicolon
multiline_comment|/* FIXME: support 48bit DMA later */
id|td_ptr-&gt;td_buf
(braket
id|i
)braket
dot
id|pa_low
op_assign
id|cpu_to_le32
c_func
(paren
id|tdinfo-&gt;skb_dma
)paren
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
id|i
)braket
dot
id|pa_high
op_assign
l_int|0
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
id|i
)braket
dot
id|bufsize
op_assign
id|skb-&gt;len-&gt;skb-&gt;data_len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nfrags
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb_frag_t
op_star
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|i
)braket
suffix:semicolon
r_void
op_star
id|addr
op_assign
(paren
(paren
r_void
op_star
)paren
id|page_address
c_func
(paren
id|frag-&gt;page
op_plus
id|frag-&gt;page_offset
)paren
)paren
suffix:semicolon
id|tdinfo-&gt;skb_dma
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|pci_map_single
c_func
(paren
id|vptr-&gt;pdev
comma
id|addr
comma
id|frag-&gt;size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
id|i
op_plus
l_int|1
)braket
dot
id|pa_low
op_assign
id|cpu_to_le32
c_func
(paren
id|tdinfo-&gt;skb_dma
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
id|i
op_plus
l_int|1
)braket
dot
id|pa_high
op_assign
l_int|0
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
id|i
op_plus
l_int|1
)braket
dot
id|bufsize
op_assign
id|frag-&gt;size
suffix:semicolon
)brace
id|tdinfo-&gt;nskb_dma
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
id|td_ptr-&gt;tdesc1.CMDZ
op_assign
id|i
suffix:semicolon
)brace
)brace
r_else
macro_line|#endif
(brace
multiline_comment|/*&n;&t;&t; *&t;Map the linear network buffer into PCI space and&n;&t;&t; *&t;add it to the transmit ring.&n;&t;&t; */
id|tdinfo-&gt;skb
op_assign
id|skb
suffix:semicolon
id|tdinfo-&gt;skb_dma
(braket
l_int|0
)braket
op_assign
id|pci_map_single
c_func
(paren
id|vptr-&gt;pdev
comma
id|skb-&gt;data
comma
id|pktlen
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|td_ptr-&gt;tdesc0.pktsize
op_assign
id|pktlen
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|pa_low
op_assign
id|cpu_to_le32
c_func
(paren
id|tdinfo-&gt;skb_dma
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|pa_high
op_assign
l_int|0
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|bufsize
op_assign
id|td_ptr-&gt;tdesc0.pktsize
suffix:semicolon
id|tdinfo-&gt;nskb_dma
op_assign
l_int|1
suffix:semicolon
id|td_ptr-&gt;tdesc1.CMDZ
op_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_TAGGING
)paren
(brace
id|td_ptr-&gt;tdesc1.pqinf.VID
op_assign
(paren
id|vptr-&gt;options.vid
op_amp
l_int|0xfff
)paren
suffix:semicolon
id|td_ptr-&gt;tdesc1.pqinf.priority
op_assign
l_int|0
suffix:semicolon
id|td_ptr-&gt;tdesc1.pqinf.CFI
op_assign
l_int|0
suffix:semicolon
id|td_ptr-&gt;tdesc1.TCR
op_or_assign
id|TCR0_VETAG
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Handle hardware checksum&n;&t; */
r_if
c_cond
(paren
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_TX_CSUM
)paren
op_logical_and
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
)paren
(brace
r_struct
id|iphdr
op_star
id|ip
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
id|td_ptr-&gt;tdesc1.TCR
op_or_assign
id|TCR0_TCPCK
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ip-&gt;protocol
op_eq
id|IPPROTO_UDP
)paren
id|td_ptr-&gt;tdesc1.TCR
op_or_assign
(paren
id|TCR0_UDPCK
)paren
suffix:semicolon
id|td_ptr-&gt;tdesc1.TCR
op_or_assign
id|TCR0_IPCK
suffix:semicolon
)brace
(brace
r_int
id|prev
op_assign
id|index
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|prev
OL
l_int|0
)paren
id|prev
op_assign
id|vptr-&gt;options.numtx
op_minus
l_int|1
suffix:semicolon
id|td_ptr-&gt;tdesc0.owner
op_assign
id|OWNED_BY_NIC
suffix:semicolon
id|vptr-&gt;td_used
(braket
id|qnum
)braket
op_increment
suffix:semicolon
id|vptr-&gt;td_curr
(braket
id|qnum
)braket
op_assign
(paren
id|index
op_plus
l_int|1
)paren
op_mod
id|vptr-&gt;options.numtx
suffix:semicolon
r_if
c_cond
(paren
id|AVAIL_TD
c_func
(paren
id|vptr
comma
id|qnum
)paren
OL
l_int|1
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|td_ptr
op_assign
op_amp
(paren
id|vptr-&gt;td_rings
(braket
id|qnum
)braket
(braket
id|prev
)braket
)paren
suffix:semicolon
id|td_ptr-&gt;td_buf
(braket
l_int|0
)braket
dot
id|queue
op_assign
l_int|1
suffix:semicolon
id|mac_tx_queue_wake
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|qnum
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_intr&t;&t;-&t;interrupt callback&n; *&t;@irq: interrupt number&n; *&t;@dev_instance: interrupting device&n; *&t;@pt_regs: CPU register state at interrupt&n; *&n; *&t;Called whenever an interrupt is generated by the velocity&n; *&t;adapter IRQ line. We may not be the source of the interrupt&n; *&t;and need to identify initially if we are, and if not exit as&n; *&t;efficiently as possible.&n; */
DECL|function|velocity_intr
r_static
r_int
id|velocity_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|isr_status
suffix:semicolon
r_int
id|max_count
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|vptr-&gt;lock
)paren
suffix:semicolon
id|isr_status
op_assign
id|mac_read_isr
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
multiline_comment|/* Not us ? */
r_if
c_cond
(paren
id|isr_status
op_eq
l_int|0
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|vptr-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|mac_disable_int
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Keep processing the ISR until we have completed&n;&t; *&t;processing and the isr_status becomes zero&n;&t; */
r_while
c_loop
(paren
id|isr_status
op_ne
l_int|0
)paren
(brace
id|mac_write_isr
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|isr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr_status
op_amp
(paren
op_complement
(paren
id|ISR_PRXI
op_or
id|ISR_PPRXI
op_or
id|ISR_PTXI
op_or
id|ISR_PPTXI
)paren
)paren
)paren
id|velocity_error
c_func
(paren
id|vptr
comma
id|isr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr_status
op_amp
(paren
id|ISR_PRXI
op_or
id|ISR_PPRXI
)paren
)paren
id|max_count
op_add_assign
id|velocity_rx_srv
c_func
(paren
id|vptr
comma
id|isr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr_status
op_amp
(paren
id|ISR_PTXI
op_or
id|ISR_PPTXI
)paren
)paren
id|max_count
op_add_assign
id|velocity_tx_srv
c_func
(paren
id|vptr
comma
id|isr_status
)paren
suffix:semicolon
id|isr_status
op_assign
id|mac_read_isr
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_count
OG
id|vptr-&gt;options.int_works
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: excessive work at interrupt.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|max_count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|vptr-&gt;lock
)paren
suffix:semicolon
id|mac_enable_int
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_set_multi&t;-&t;filter list change callback&n; *&t;@dev: network device&n; *&n; *&t;Called by the network layer when the filter lists need to change&n; *&t;for a velocity adapter. Reload the CAMs with the new address&n; *&t;filter ruleset.&n; */
DECL|function|velocity_set_multi
r_static
r_void
id|velocity_set_multi
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
id|u8
id|rx_mode
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
op_amp
id|regs-&gt;MARCAM
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
op_amp
id|regs-&gt;MARCAM
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|rx_mode
op_assign
(paren
id|RCR_AM
op_or
id|RCR_AB
op_or
id|RCR_PROM
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
id|vptr-&gt;multicast_limit
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
id|writel
c_func
(paren
l_int|0xffffffff
comma
op_amp
id|regs-&gt;MARCAM
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
op_amp
id|regs-&gt;MARCAM
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|rx_mode
op_assign
(paren
id|RCR_AM
op_or
id|RCR_AB
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|offset
op_assign
id|MCAM_SIZE
op_minus
id|vptr-&gt;multicast_limit
suffix:semicolon
id|mac_get_cam_mask
c_func
(paren
id|regs
comma
id|vptr-&gt;mCAMmask
comma
id|VELOCITY_MULTICAST_CAM
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
id|mac_set_cam
c_func
(paren
id|regs
comma
id|i
op_plus
id|offset
comma
id|mclist-&gt;dmi_addr
comma
id|VELOCITY_MULTICAST_CAM
)paren
suffix:semicolon
id|vptr-&gt;mCAMmask
(braket
(paren
id|offset
op_plus
id|i
)paren
op_div
l_int|8
)braket
op_or_assign
l_int|1
op_lshift
(paren
(paren
id|offset
op_plus
id|i
)paren
op_amp
l_int|7
)paren
suffix:semicolon
)brace
id|mac_set_cam_mask
c_func
(paren
id|regs
comma
id|vptr-&gt;mCAMmask
comma
id|VELOCITY_MULTICAST_CAM
)paren
suffix:semicolon
id|rx_mode
op_assign
(paren
id|RCR_AM
op_or
id|RCR_AB
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;mtu
OG
l_int|1500
)paren
id|rx_mode
op_or_assign
id|RCR_AL
suffix:semicolon
id|BYTE_REG_BITS_ON
c_func
(paren
id|rx_mode
comma
op_amp
id|regs-&gt;RCR
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_get_status&t;-&t;statistics callback&n; *&t;@dev: network device&n; *&n; *&t;Callback from the network layer to allow driver statistics&n; *&t;to be resynchronized with hardware collected state. In the&n; *&t;case of the velocity we need to pull the MIB counters from&n; *&t;the hardware into the counters before letting the network&n; *&t;layer display them.&n; */
DECL|function|velocity_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|velocity_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* If the hardware is down, don&squot;t touch MII */
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
r_return
op_amp
id|vptr-&gt;stats
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|vptr-&gt;lock
)paren
suffix:semicolon
id|velocity_update_hw_mibs
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|vptr-&gt;lock
)paren
suffix:semicolon
id|vptr-&gt;stats.rx_packets
op_assign
id|vptr-&gt;mib_counter
(braket
id|HW_MIB_ifRxAllPkts
)braket
suffix:semicolon
id|vptr-&gt;stats.rx_errors
op_assign
id|vptr-&gt;mib_counter
(braket
id|HW_MIB_ifRxErrorPkts
)braket
suffix:semicolon
id|vptr-&gt;stats.rx_length_errors
op_assign
id|vptr-&gt;mib_counter
(braket
id|HW_MIB_ifInRangeLengthErrors
)braket
suffix:semicolon
singleline_comment|//  unsigned long   rx_dropped;     /* no space in linux buffers    */
id|vptr-&gt;stats.collisions
op_assign
id|vptr-&gt;mib_counter
(braket
id|HW_MIB_ifTxEtherCollisions
)braket
suffix:semicolon
multiline_comment|/* detailed rx_errors: */
singleline_comment|//  unsigned long   rx_length_errors;
singleline_comment|//  unsigned long   rx_over_errors;     /* receiver ring buff overflow  */
id|vptr-&gt;stats.rx_crc_errors
op_assign
id|vptr-&gt;mib_counter
(braket
id|HW_MIB_ifRxPktCRCE
)braket
suffix:semicolon
singleline_comment|//  unsigned long   rx_frame_errors;    /* recv&squot;d frame alignment error */
singleline_comment|//  unsigned long   rx_fifo_errors;     /* recv&squot;r fifo overrun      */
singleline_comment|//  unsigned long   rx_missed_errors;   /* receiver missed packet   */
multiline_comment|/* detailed tx_errors */
singleline_comment|//  unsigned long   tx_fifo_errors;
r_return
op_amp
id|vptr-&gt;stats
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_ioctl&t;&t;-&t;ioctl entry point&n; *&t;@dev: network device&n; *&t;@rq: interface request ioctl&n; *&t;@cmd: command code&n; *&n; *&t;Called when the user issues an ioctl request to the network&n; *&t;device in question. The velocity interface supports MII.&n; */
DECL|function|velocity_ioctl
r_static
r_int
id|velocity_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* If we are asked for information and the device is power&n;&t;   saving then we need to bring the device back up to talk to it */
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|pci_set_power_state
c_func
(paren
id|vptr-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGMIIPHY
suffix:colon
multiline_comment|/* Get address of MII PHY in use. */
r_case
id|SIOCGMIIREG
suffix:colon
multiline_comment|/* Read MII PHY register. */
r_case
id|SIOCSMIIREG
suffix:colon
multiline_comment|/* Write to MII PHY register. */
id|ret
op_assign
id|velocity_mii_ioctl
c_func
(paren
id|dev
comma
id|rq
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|pci_set_power_state
c_func
(paren
id|vptr-&gt;pdev
comma
l_int|3
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Definition for our device driver. The PCI layer interface&n; *&t;uses this to handle all our card discover and plugging&n; */
DECL|variable|velocity_driver
r_static
r_struct
id|pci_driver
id|velocity_driver
op_assign
(brace
dot
id|name
op_assign
id|VELOCITY_NAME
comma
dot
id|id_table
op_assign
id|velocity_id_table
comma
dot
id|probe
op_assign
id|velocity_found1
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|velocity_remove1
)paren
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|velocity_suspend
comma
dot
id|resume
op_assign
id|velocity_resume
comma
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;velocity_init_module&t;-&t;load time function&n; *&n; *&t;Called when the velocity module is loaded. The PCI driver&n; *&t;is registered with the PCI layer, and in turn will call&n; *&t;the probe functions for each velocity adapter installed&n; *&t;in the system.&n; */
DECL|function|velocity_init_module
r_static
r_int
id|__init
id|velocity_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|velocity_register_notifier
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|velocity_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|velocity_unregister_notifier
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_cleanup&t;-&t;module unload&n; *&n; *&t;When the velocity hardware is unloaded this function is called.&n; *&t;It will clean up the notifiers and the unregister the PCI &n; *&t;driver interface for this hardware. This in turn cleans up&n; *&t;all discovered interfaces before returning from the function&n; */
DECL|function|velocity_cleanup_module
r_static
r_void
id|__exit
id|velocity_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|velocity_unregister_notifier
c_func
(paren
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|velocity_driver
)paren
suffix:semicolon
)brace
DECL|variable|velocity_init_module
id|module_init
c_func
(paren
id|velocity_init_module
)paren
suffix:semicolon
DECL|variable|velocity_cleanup_module
id|module_exit
c_func
(paren
id|velocity_cleanup_module
)paren
suffix:semicolon
multiline_comment|/*&n; * MII access , media link mode setting functions&n; */
multiline_comment|/**&n; *&t;mii_init&t;-&t;set up MII&n; *&t;@vptr: velocity adapter&n; *&t;@mii_status:  links tatus&n; *&n; *&t;Set up the PHY for the current link state.&n; */
DECL|function|mii_init
r_static
r_void
id|mii_init
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
id|u32
id|mii_status
)paren
(brace
id|u16
id|BMCR
suffix:semicolon
r_switch
c_cond
(paren
id|PHYID_GET_PHY_ID
c_func
(paren
id|vptr-&gt;phy_id
)paren
)paren
(brace
r_case
id|PHYID_CICADA_CS8201
suffix:colon
multiline_comment|/*&n;&t;&t; *&t;Reset to hardware default&n;&t;&t; */
id|MII_REG_BITS_OFF
c_func
(paren
(paren
id|ANAR_ASMDIR
op_or
id|ANAR_PAUSE
)paren
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Turn on ECHODIS bit in NWay-forced full mode and turn it&n;&t;&t; *&t;off it in NWay-forced half mode for NWay-forced v.s. &n;&t;&t; *&t;legacy-forced issue.&n;&t;&t; */
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
id|MII_REG_BITS_ON
c_func
(paren
id|TCSR_ECHODIS
comma
id|MII_REG_TCSR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_else
id|MII_REG_BITS_OFF
c_func
(paren
id|TCSR_ECHODIS
comma
id|MII_REG_TCSR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Turn on Link/Activity LED enable bit for CIS8201&n;&t;&t; */
id|MII_REG_BITS_ON
c_func
(paren
id|PLED_LALBE
comma
id|MII_REG_PLED
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHYID_VT3216_32BIT
suffix:colon
r_case
id|PHYID_VT3216_64BIT
suffix:colon
multiline_comment|/*&n;&t;&t; *&t;Reset to hardware default&n;&t;&t; */
id|MII_REG_BITS_ON
c_func
(paren
(paren
id|ANAR_ASMDIR
op_or
id|ANAR_PAUSE
)paren
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Turn on ECHODIS bit in NWay-forced full mode and turn it&n;&t;&t; *&t;off it in NWay-forced half mode for NWay-forced v.s. &n;&t;&t; *&t;legacy-forced issue&n;&t;&t; */
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
id|MII_REG_BITS_ON
c_func
(paren
id|TCSR_ECHODIS
comma
id|MII_REG_TCSR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_else
id|MII_REG_BITS_OFF
c_func
(paren
id|TCSR_ECHODIS
comma
id|MII_REG_TCSR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHYID_MARVELL_1000
suffix:colon
r_case
id|PHYID_MARVELL_1000S
suffix:colon
multiline_comment|/*&n;&t;&t; *&t;Assert CRS on Transmit &n;&t;&t; */
id|MII_REG_BITS_ON
c_func
(paren
id|PSCR_ACRSTX
comma
id|MII_REG_PSCR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Reset to hardware default &n;&t;&t; */
id|MII_REG_BITS_ON
c_func
(paren
(paren
id|ANAR_ASMDIR
op_or
id|ANAR_PAUSE
)paren
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
id|velocity_mii_read
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|MII_REG_BMCR
comma
op_amp
id|BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BMCR
op_amp
id|BMCR_ISO
)paren
(brace
id|BMCR
op_and_assign
op_complement
id|BMCR_ISO
suffix:semicolon
id|velocity_mii_write
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|MII_REG_BMCR
comma
id|BMCR
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;safe_disable_mii_autopoll&t;-&t;autopoll off&n; *&t;@regs: velocity registers&n; *&n; *&t;Turn off the autopoll and wait for it to disable on the chip&n; */
DECL|function|safe_disable_mii_autopoll
r_static
r_void
id|safe_disable_mii_autopoll
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
)paren
(brace
id|u16
id|ww
suffix:semicolon
multiline_comment|/*  turn off MAUTO */
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|regs-&gt;MIICR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ww
op_assign
l_int|0
suffix:semicolon
id|ww
OL
id|W_MAX_TIMEOUT
suffix:semicolon
id|ww
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BYTE_REG_BITS_IS_ON
c_func
(paren
id|MIISR_MIDLE
comma
op_amp
id|regs-&gt;MIISR
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;enable_mii_autopoll&t;-&t;turn on autopolling&n; *&t;@regs: velocity registers&n; *&n; *&t;Enable the MII link status autopoll feature on the Velocity&n; *&t;hardware. Wait for it to enable.&n; */
DECL|function|enable_mii_autopoll
r_static
r_void
id|enable_mii_autopoll
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
)paren
(brace
r_int
id|ii
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
(paren
id|regs-&gt;MIICR
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MIIADR_SWMPL
comma
op_amp
id|regs-&gt;MIIADR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|W_MAX_TIMEOUT
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BYTE_REG_BITS_IS_ON
c_func
(paren
id|MIISR_MIDLE
comma
op_amp
id|regs-&gt;MIISR
)paren
)paren
r_break
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|MIICR_MAUTO
comma
op_amp
id|regs-&gt;MIICR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|W_MAX_TIMEOUT
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|BYTE_REG_BITS_IS_ON
c_func
(paren
id|MIISR_MIDLE
comma
op_amp
id|regs-&gt;MIISR
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_mii_read&t;-&t;read MII data&n; *&t;@regs: velocity registers&n; *&t;@index: MII register index&n; *&t;@data: buffer for received data&n; *&n; *&t;Perform a single read of an MII 16bit register. Returns zero&n; *&t;on success or -ETIMEDOUT if the PHY did not respond.&n; */
DECL|function|velocity_mii_read
r_static
r_int
id|velocity_mii_read
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
comma
id|u8
id|index
comma
id|u16
op_star
id|data
)paren
(brace
id|u16
id|ww
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Disable MIICR_MAUTO, so that mii addr can be set normally&n;&t; */
id|safe_disable_mii_autopoll
c_func
(paren
id|regs
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|index
comma
op_amp
id|regs-&gt;MIIADR
)paren
suffix:semicolon
id|BYTE_REG_BITS_ON
c_func
(paren
id|MIICR_RCMD
comma
op_amp
id|regs-&gt;MIICR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ww
op_assign
l_int|0
suffix:semicolon
id|ww
OL
id|W_MAX_TIMEOUT
suffix:semicolon
id|ww
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readb
c_func
(paren
op_amp
id|regs-&gt;MIICR
)paren
op_amp
id|MIICR_RCMD
)paren
)paren
r_break
suffix:semicolon
)brace
op_star
id|data
op_assign
id|readw
c_func
(paren
op_amp
id|regs-&gt;MIIDATA
)paren
suffix:semicolon
id|enable_mii_autopoll
c_func
(paren
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ww
op_eq
id|W_MAX_TIMEOUT
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_mii_write&t;-&t;write MII data&n; *&t;@regs: velocity registers&n; *&t;@index: MII register index&n; *&t;@data: 16bit data for the MII register&n; *&n; *&t;Perform a single write to an MII 16bit register. Returns zero&n; *&t;on success or -ETIMEDOUT if the PHY did not respond.&n; */
DECL|function|velocity_mii_write
r_static
r_int
id|velocity_mii_write
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
comma
id|u8
id|mii_addr
comma
id|u16
id|data
)paren
(brace
id|u16
id|ww
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Disable MIICR_MAUTO, so that mii addr can be set normally&n;&t; */
id|safe_disable_mii_autopoll
c_func
(paren
id|regs
)paren
suffix:semicolon
multiline_comment|/* MII reg offset */
id|writeb
c_func
(paren
id|mii_addr
comma
op_amp
id|regs-&gt;MIIADR
)paren
suffix:semicolon
multiline_comment|/* set MII data */
id|writew
c_func
(paren
id|data
comma
op_amp
id|regs-&gt;MIIDATA
)paren
suffix:semicolon
multiline_comment|/* turn on MIICR_WCMD */
id|BYTE_REG_BITS_ON
c_func
(paren
id|MIICR_WCMD
comma
op_amp
id|regs-&gt;MIICR
)paren
suffix:semicolon
multiline_comment|/* W_MAX_TIMEOUT is the timeout period */
r_for
c_loop
(paren
id|ww
op_assign
l_int|0
suffix:semicolon
id|ww
OL
id|W_MAX_TIMEOUT
suffix:semicolon
id|ww
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|readb
c_func
(paren
op_amp
id|regs-&gt;MIICR
)paren
op_amp
id|MIICR_WCMD
)paren
)paren
r_break
suffix:semicolon
)brace
id|enable_mii_autopoll
c_func
(paren
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ww
op_eq
id|W_MAX_TIMEOUT
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_get_opt_media_mode&t;-&t;get media selection&n; *&t;@vptr: velocity adapter&n; *&n; *&t;Get the media mode stored in EEPROM or module options and load&n; *&t;mii_status accordingly. The requested link state information&n; *&t;is also returned.&n; */
DECL|function|velocity_get_opt_media_mode
r_static
id|u32
id|velocity_get_opt_media_mode
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|vptr-&gt;options.spd_dpx
)paren
(brace
r_case
id|SPD_DPX_AUTO
suffix:colon
id|status
op_assign
id|VELOCITY_AUTONEG_ENABLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPD_DPX_100_FULL
suffix:colon
id|status
op_assign
id|VELOCITY_SPEED_100
op_or
id|VELOCITY_DUPLEX_FULL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPD_DPX_10_FULL
suffix:colon
id|status
op_assign
id|VELOCITY_SPEED_10
op_or
id|VELOCITY_DUPLEX_FULL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPD_DPX_100_HALF
suffix:colon
id|status
op_assign
id|VELOCITY_SPEED_100
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPD_DPX_10_HALF
suffix:colon
id|status
op_assign
id|VELOCITY_SPEED_10
suffix:semicolon
r_break
suffix:semicolon
)brace
id|vptr-&gt;mii_status
op_assign
id|status
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;mii_set_auto_on&t;&t;-&t;autonegotiate on&n; *&t;@vptr: velocity&n; *&n; *&t;Enable autonegotation on this interface&n; */
DECL|function|mii_set_auto_on
r_static
r_void
id|mii_set_auto_on
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_if
c_cond
(paren
id|MII_REG_BITS_IS_ON
c_func
(paren
id|BMCR_AUTO
comma
id|MII_REG_BMCR
comma
id|vptr-&gt;mac_regs
)paren
)paren
id|MII_REG_BITS_ON
c_func
(paren
id|BMCR_REAUTO
comma
id|MII_REG_BMCR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_else
id|MII_REG_BITS_ON
c_func
(paren
id|BMCR_AUTO
comma
id|MII_REG_BMCR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;static void mii_set_auto_off(struct velocity_info * vptr)&n;{&n;    MII_REG_BITS_OFF(BMCR_AUTO, MII_REG_BMCR, vptr-&gt;mac_regs);&n;}&n;*/
multiline_comment|/**&n; *&t;set_mii_flow_control&t;-&t;flow control setup&n; *&t;@vptr: velocity interface&n; *&n; *&t;Set up the flow control on this interface according to&n; *&t;the supplied user/eeprom options.&n; */
DECL|function|set_mii_flow_control
r_static
r_void
id|set_mii_flow_control
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
multiline_comment|/*Enable or Disable PAUSE in ANAR */
r_switch
c_cond
(paren
id|vptr-&gt;options.flow_cntl
)paren
(brace
r_case
id|FLOW_CNTL_TX
suffix:colon
id|MII_REG_BITS_OFF
c_func
(paren
id|ANAR_PAUSE
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|MII_REG_BITS_ON
c_func
(paren
id|ANAR_ASMDIR
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CNTL_RX
suffix:colon
id|MII_REG_BITS_ON
c_func
(paren
id|ANAR_PAUSE
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|MII_REG_BITS_ON
c_func
(paren
id|ANAR_ASMDIR
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CNTL_TX_RX
suffix:colon
id|MII_REG_BITS_ON
c_func
(paren
id|ANAR_PAUSE
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|MII_REG_BITS_ON
c_func
(paren
id|ANAR_ASMDIR
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CNTL_DISABLE
suffix:colon
id|MII_REG_BITS_OFF
c_func
(paren
id|ANAR_PAUSE
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|MII_REG_BITS_OFF
c_func
(paren
id|ANAR_ASMDIR
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_set_media_mode&t;&t;-&t;set media mode&n; *&t;@mii_status: old MII link state&n; *&n; *&t;Check the media link state and configure the flow control&n; *&t;PHY and also velocity hardware setup accordingly. In particular&n; *&t;we need to set up CD polling and frame bursting.&n; */
DECL|function|velocity_set_media_mode
r_static
r_int
id|velocity_set_media_mode
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
id|u32
id|mii_status
)paren
(brace
id|u32
id|curr_status
suffix:semicolon
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
id|vptr-&gt;mii_status
op_assign
id|mii_check_media_mode
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|curr_status
op_assign
id|vptr-&gt;mii_status
op_amp
(paren
op_complement
id|VELOCITY_LINK_FAIL
)paren
suffix:semicolon
multiline_comment|/* Set mii link status */
id|set_mii_flow_control
c_func
(paren
id|vptr
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Check if new status is consisent with current status&n;&t;   if (((mii_status &amp; curr_status) &amp; VELOCITY_AUTONEG_ENABLE)&n;&t;   || (mii_status==curr_status)) {&n;&t;   vptr-&gt;mii_status=mii_check_media_mode(vptr-&gt;mac_regs);&n;&t;   vptr-&gt;mii_status=check_connection_type(vptr-&gt;mac_regs);&n;&t;   VELOCITY_PRT(MSG_LEVEL_INFO, &quot;Velocity link no change&bslash;n&quot;);&n;&t;   return 0;&n;&t;   }&n;&t; */
r_if
c_cond
(paren
id|PHYID_GET_PHY_ID
c_func
(paren
id|vptr-&gt;phy_id
)paren
op_eq
id|PHYID_CICADA_CS8201
)paren
(brace
id|MII_REG_BITS_ON
c_func
(paren
id|AUXCR_MDPPS
comma
id|MII_REG_AUXCR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;If connection type is AUTO&n;&t; */
r_if
c_cond
(paren
id|mii_status
op_amp
id|VELOCITY_AUTONEG_ENABLE
)paren
(brace
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot;Velocity is AUTO mode&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* clear force MAC mode bit */
id|BYTE_REG_BITS_OFF
c_func
(paren
id|CHIPGCR_FCMODE
comma
op_amp
id|regs-&gt;CHIPGCR
)paren
suffix:semicolon
multiline_comment|/* set duplex mode of MAC according to duplex mode of MII */
id|MII_REG_BITS_ON
c_func
(paren
id|ANAR_TXFD
op_or
id|ANAR_TX
op_or
id|ANAR_10FD
op_or
id|ANAR_10
comma
id|MII_REG_ANAR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|MII_REG_BITS_ON
c_func
(paren
id|G1000CR_1000FD
op_or
id|G1000CR_1000
comma
id|MII_REG_G1000CR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|MII_REG_BITS_ON
c_func
(paren
id|BMCR_SPEED1G
comma
id|MII_REG_BMCR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
multiline_comment|/* enable AUTO-NEGO mode */
id|mii_set_auto_on
c_func
(paren
id|vptr
)paren
suffix:semicolon
)brace
r_else
(brace
id|u16
id|ANAR
suffix:semicolon
id|u8
id|CHIPGCR
suffix:semicolon
multiline_comment|/*&n;&t;&t; * 1. if it&squot;s 3119, disable frame bursting in halfduplex mode&n;&t;&t; *    and enable it in fullduplex mode&n;&t;&t; * 2. set correct MII/GMII and half/full duplex mode in CHIPGCR&n;&t;&t; * 3. only enable CD heart beat counter in 10HD mode&n;&t;&t; */
multiline_comment|/* set force MAC mode bit */
id|BYTE_REG_BITS_ON
c_func
(paren
id|CHIPGCR_FCMODE
comma
op_amp
id|regs-&gt;CHIPGCR
)paren
suffix:semicolon
id|CHIPGCR
op_assign
id|readb
c_func
(paren
op_amp
id|regs-&gt;CHIPGCR
)paren
suffix:semicolon
id|CHIPGCR
op_and_assign
op_complement
id|CHIPGCR_FCGMII
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
(brace
id|CHIPGCR
op_or_assign
id|CHIPGCR_FCFDX
suffix:semicolon
id|writeb
c_func
(paren
id|CHIPGCR
comma
op_amp
id|regs-&gt;CHIPGCR
)paren
suffix:semicolon
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot;set Velocity to forced full mode&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;rev_id
OL
id|REV_ID_VT3216_A0
)paren
id|BYTE_REG_BITS_OFF
c_func
(paren
id|TCR_TB2BDIS
comma
op_amp
id|regs-&gt;TCR
)paren
suffix:semicolon
)brace
r_else
(brace
id|CHIPGCR
op_and_assign
op_complement
id|CHIPGCR_FCFDX
suffix:semicolon
id|VELOCITY_PRT
c_func
(paren
id|MSG_LEVEL_INFO
comma
l_string|&quot;set Velocity to forced half mode&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CHIPGCR
comma
op_amp
id|regs-&gt;CHIPGCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;rev_id
OL
id|REV_ID_VT3216_A0
)paren
id|BYTE_REG_BITS_ON
c_func
(paren
id|TCR_TB2BDIS
comma
op_amp
id|regs-&gt;TCR
)paren
suffix:semicolon
)brace
id|MII_REG_BITS_OFF
c_func
(paren
id|G1000CR_1000FD
op_or
id|G1000CR_1000
comma
id|MII_REG_G1000CR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mii_status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
op_logical_and
(paren
id|mii_status
op_amp
id|VELOCITY_SPEED_10
)paren
)paren
(brace
id|BYTE_REG_BITS_OFF
c_func
(paren
id|TESTCFG_HBDIS
comma
op_amp
id|regs-&gt;TESTCFG
)paren
suffix:semicolon
)brace
r_else
(brace
id|BYTE_REG_BITS_ON
c_func
(paren
id|TESTCFG_HBDIS
comma
op_amp
id|regs-&gt;TESTCFG
)paren
suffix:semicolon
)brace
multiline_comment|/* MII_REG_BITS_OFF(BMCR_SPEED1G, MII_REG_BMCR, vptr-&gt;mac_regs); */
id|velocity_mii_read
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|MII_REG_ANAR
comma
op_amp
id|ANAR
)paren
suffix:semicolon
id|ANAR
op_and_assign
(paren
op_complement
(paren
id|ANAR_TXFD
op_or
id|ANAR_TX
op_or
id|ANAR_10FD
op_or
id|ANAR_10
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_amp
id|VELOCITY_SPEED_100
)paren
(brace
r_if
c_cond
(paren
id|mii_status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
id|ANAR
op_or_assign
id|ANAR_TXFD
suffix:semicolon
r_else
id|ANAR
op_or_assign
id|ANAR_TX
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mii_status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
id|ANAR
op_or_assign
id|ANAR_10FD
suffix:semicolon
r_else
id|ANAR
op_or_assign
id|ANAR_10
suffix:semicolon
)brace
id|velocity_mii_write
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|MII_REG_ANAR
comma
id|ANAR
)paren
suffix:semicolon
multiline_comment|/* enable AUTO-NEGO mode */
id|mii_set_auto_on
c_func
(paren
id|vptr
)paren
suffix:semicolon
multiline_comment|/* MII_REG_BITS_ON(BMCR_AUTO, MII_REG_BMCR, vptr-&gt;mac_regs); */
)brace
multiline_comment|/* vptr-&gt;mii_status=mii_check_media_mode(vptr-&gt;mac_regs); */
multiline_comment|/* vptr-&gt;mii_status=check_connection_type(vptr-&gt;mac_regs); */
r_return
id|VELOCITY_LINK_CHANGE
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;mii_check_media_mode&t;-&t;check media state&n; *&t;@regs: velocity registers&n; *&n; *&t;Check the current MII status and determine the link status&n; *&t;accordingly&n; */
DECL|function|mii_check_media_mode
r_static
id|u32
id|mii_check_media_mode
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
)paren
(brace
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
id|u16
id|ANAR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MII_REG_BITS_IS_ON
c_func
(paren
id|BMSR_LNK
comma
id|MII_REG_BMSR
comma
id|regs
)paren
)paren
id|status
op_or_assign
id|VELOCITY_LINK_FAIL
suffix:semicolon
r_if
c_cond
(paren
id|MII_REG_BITS_IS_ON
c_func
(paren
id|G1000CR_1000FD
comma
id|MII_REG_G1000CR
comma
id|regs
)paren
)paren
id|status
op_or_assign
id|VELOCITY_SPEED_1000
op_or
id|VELOCITY_DUPLEX_FULL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|MII_REG_BITS_IS_ON
c_func
(paren
id|G1000CR_1000
comma
id|MII_REG_G1000CR
comma
id|regs
)paren
)paren
id|status
op_or_assign
(paren
id|VELOCITY_SPEED_1000
)paren
suffix:semicolon
r_else
(brace
id|velocity_mii_read
c_func
(paren
id|regs
comma
id|MII_REG_ANAR
comma
op_amp
id|ANAR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ANAR
op_amp
id|ANAR_TXFD
)paren
id|status
op_or_assign
(paren
id|VELOCITY_SPEED_100
op_or
id|VELOCITY_DUPLEX_FULL
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ANAR
op_amp
id|ANAR_TX
)paren
id|status
op_or_assign
id|VELOCITY_SPEED_100
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ANAR
op_amp
id|ANAR_10FD
)paren
id|status
op_or_assign
(paren
id|VELOCITY_SPEED_10
op_or
id|VELOCITY_DUPLEX_FULL
)paren
suffix:semicolon
r_else
id|status
op_or_assign
(paren
id|VELOCITY_SPEED_10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MII_REG_BITS_IS_ON
c_func
(paren
id|BMCR_AUTO
comma
id|MII_REG_BMCR
comma
id|regs
)paren
)paren
(brace
id|velocity_mii_read
c_func
(paren
id|regs
comma
id|MII_REG_ANAR
comma
op_amp
id|ANAR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ANAR
op_amp
(paren
id|ANAR_TXFD
op_or
id|ANAR_TX
op_or
id|ANAR_10FD
op_or
id|ANAR_10
)paren
)paren
op_eq
(paren
id|ANAR_TXFD
op_or
id|ANAR_TX
op_or
id|ANAR_10FD
op_or
id|ANAR_10
)paren
)paren
(brace
r_if
c_cond
(paren
id|MII_REG_BITS_IS_ON
c_func
(paren
id|G1000CR_1000
op_or
id|G1000CR_1000FD
comma
id|MII_REG_G1000CR
comma
id|regs
)paren
)paren
id|status
op_or_assign
id|VELOCITY_AUTONEG_ENABLE
suffix:semicolon
)brace
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|check_connection_type
r_static
id|u32
id|check_connection_type
c_func
(paren
r_struct
id|mac_regs
op_star
id|regs
)paren
(brace
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
id|u8
id|PHYSR0
suffix:semicolon
id|u16
id|ANAR
suffix:semicolon
id|PHYSR0
op_assign
id|readb
c_func
(paren
op_amp
id|regs-&gt;PHYSR0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   if (!(PHYSR0 &amp; PHYSR0_LINKGD))&n;&t;   status|=VELOCITY_LINK_FAIL;&n;&t; */
r_if
c_cond
(paren
id|PHYSR0
op_amp
id|PHYSR0_FDPX
)paren
id|status
op_or_assign
id|VELOCITY_DUPLEX_FULL
suffix:semicolon
r_if
c_cond
(paren
id|PHYSR0
op_amp
id|PHYSR0_SPDG
)paren
id|status
op_or_assign
id|VELOCITY_SPEED_1000
suffix:semicolon
r_if
c_cond
(paren
id|PHYSR0
op_amp
id|PHYSR0_SPD10
)paren
id|status
op_or_assign
id|VELOCITY_SPEED_10
suffix:semicolon
r_else
id|status
op_or_assign
id|VELOCITY_SPEED_100
suffix:semicolon
r_if
c_cond
(paren
id|MII_REG_BITS_IS_ON
c_func
(paren
id|BMCR_AUTO
comma
id|MII_REG_BMCR
comma
id|regs
)paren
)paren
(brace
id|velocity_mii_read
c_func
(paren
id|regs
comma
id|MII_REG_ANAR
comma
op_amp
id|ANAR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ANAR
op_amp
(paren
id|ANAR_TXFD
op_or
id|ANAR_TX
op_or
id|ANAR_10FD
op_or
id|ANAR_10
)paren
)paren
op_eq
(paren
id|ANAR_TXFD
op_or
id|ANAR_TX
op_or
id|ANAR_10FD
op_or
id|ANAR_10
)paren
)paren
(brace
r_if
c_cond
(paren
id|MII_REG_BITS_IS_ON
c_func
(paren
id|G1000CR_1000
op_or
id|G1000CR_1000FD
comma
id|MII_REG_G1000CR
comma
id|regs
)paren
)paren
id|status
op_or_assign
id|VELOCITY_AUTONEG_ENABLE
suffix:semicolon
)brace
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;enable_flow_control_ability&t;-&t;flow control&n; *&t;@vptr: veloity to configure&n; *&n; *&t;Set up flow control according to the flow control options&n; *&t;determined by the eeprom/configuration.&n; */
DECL|function|enable_flow_control_ability
r_static
r_void
id|enable_flow_control_ability
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_switch
c_cond
(paren
id|vptr-&gt;options.flow_cntl
)paren
(brace
r_case
id|FLOW_CNTL_DEFAULT
suffix:colon
r_if
c_cond
(paren
id|BYTE_REG_BITS_IS_ON
c_func
(paren
id|PHYSR0_RXFLC
comma
op_amp
id|regs-&gt;PHYSR0
)paren
)paren
id|writel
c_func
(paren
id|CR0_FDXRFCEN
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
id|CR0_FDXRFCEN
comma
op_amp
id|regs-&gt;CR0Clr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BYTE_REG_BITS_IS_ON
c_func
(paren
id|PHYSR0_TXFLC
comma
op_amp
id|regs-&gt;PHYSR0
)paren
)paren
id|writel
c_func
(paren
id|CR0_FDXTFCEN
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
id|CR0_FDXTFCEN
comma
op_amp
id|regs-&gt;CR0Clr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CNTL_TX
suffix:colon
id|writel
c_func
(paren
id|CR0_FDXTFCEN
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR0_FDXRFCEN
comma
op_amp
id|regs-&gt;CR0Clr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CNTL_RX
suffix:colon
id|writel
c_func
(paren
id|CR0_FDXRFCEN
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR0_FDXTFCEN
comma
op_amp
id|regs-&gt;CR0Clr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CNTL_TX_RX
suffix:colon
id|writel
c_func
(paren
id|CR0_FDXTFCEN
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR0_FDXRFCEN
comma
op_amp
id|regs-&gt;CR0Set
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FLOW_CNTL_DISABLE
suffix:colon
id|writel
c_func
(paren
id|CR0_FDXRFCEN
comma
op_amp
id|regs-&gt;CR0Clr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR0_FDXTFCEN
comma
op_amp
id|regs-&gt;CR0Clr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;velocity_ethtool_up&t;-&t;pre hook for ethtool&n; *&t;@dev: network device&n; *&n; *&t;Called before an ethtool operation. We need to make sure the&n; *&t;chip is out of D3 state before we poke at it.&n; */
DECL|function|velocity_ethtool_up
r_static
r_int
id|velocity_ethtool_up
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|pci_set_power_state
c_func
(paren
id|vptr-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_ethtool_down&t;-&t;post hook for ethtool&n; *&t;@dev: network device&n; *&n; *&t;Called after an ethtool operation. Restore the chip back to D3&n; *&t;state if it isn&squot;t running.&n; */
DECL|function|velocity_ethtool_down
r_static
r_void
id|velocity_ethtool_down
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|pci_set_power_state
c_func
(paren
id|vptr-&gt;pdev
comma
l_int|3
)paren
suffix:semicolon
)brace
)brace
DECL|function|velocity_get_settings
r_static
r_int
id|velocity_get_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
id|u32
id|status
suffix:semicolon
id|status
op_assign
id|check_connection_type
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|cmd-&gt;supported
op_assign
id|SUPPORTED_TP
op_or
id|SUPPORTED_Autoneg
op_or
id|SUPPORTED_10baseT_Half
op_or
id|SUPPORTED_10baseT_Full
op_or
id|SUPPORTED_100baseT_Half
op_or
id|SUPPORTED_100baseT_Full
op_or
id|SUPPORTED_1000baseT_Half
op_or
id|SUPPORTED_1000baseT_Full
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|VELOCITY_SPEED_100
)paren
id|cmd-&gt;speed
op_assign
id|SPEED_100
suffix:semicolon
r_else
id|cmd-&gt;speed
op_assign
id|SPEED_10
suffix:semicolon
id|cmd-&gt;autoneg
op_assign
(paren
id|status
op_amp
id|VELOCITY_AUTONEG_ENABLE
)paren
ques
c_cond
id|AUTONEG_ENABLE
suffix:colon
id|AUTONEG_DISABLE
suffix:semicolon
id|cmd-&gt;port
op_assign
id|PORT_TP
suffix:semicolon
id|cmd-&gt;transceiver
op_assign
id|XCVR_INTERNAL
suffix:semicolon
id|cmd-&gt;phy_address
op_assign
id|readb
c_func
(paren
op_amp
id|regs-&gt;MIIADR
)paren
op_amp
l_int|0x1F
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|VELOCITY_DUPLEX_FULL
)paren
id|cmd-&gt;duplex
op_assign
id|DUPLEX_FULL
suffix:semicolon
r_else
id|cmd-&gt;duplex
op_assign
id|DUPLEX_HALF
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|velocity_set_settings
r_static
r_int
id|velocity_set_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|curr_status
suffix:semicolon
id|u32
id|new_status
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|curr_status
op_assign
id|check_connection_type
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|curr_status
op_and_assign
(paren
op_complement
id|VELOCITY_LINK_FAIL
)paren
suffix:semicolon
id|new_status
op_or_assign
(paren
(paren
id|cmd-&gt;autoneg
)paren
ques
c_cond
id|VELOCITY_AUTONEG_ENABLE
suffix:colon
l_int|0
)paren
suffix:semicolon
id|new_status
op_or_assign
(paren
(paren
id|cmd-&gt;speed
op_eq
id|SPEED_100
)paren
ques
c_cond
id|VELOCITY_SPEED_100
suffix:colon
l_int|0
)paren
suffix:semicolon
id|new_status
op_or_assign
(paren
(paren
id|cmd-&gt;speed
op_eq
id|SPEED_10
)paren
ques
c_cond
id|VELOCITY_SPEED_10
suffix:colon
l_int|0
)paren
suffix:semicolon
id|new_status
op_or_assign
(paren
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_FULL
)paren
ques
c_cond
id|VELOCITY_DUPLEX_FULL
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_status
op_amp
id|VELOCITY_AUTONEG_ENABLE
)paren
op_logical_and
(paren
id|new_status
op_ne
(paren
id|curr_status
op_or
id|VELOCITY_AUTONEG_ENABLE
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
id|velocity_set_media_mode
c_func
(paren
id|vptr
comma
id|new_status
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|velocity_get_link
r_static
id|u32
id|velocity_get_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_return
id|BYTE_REG_BITS_IS_ON
c_func
(paren
id|PHYSR0_LINKGD
comma
op_amp
id|regs-&gt;PHYSR0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
DECL|function|velocity_get_drvinfo
r_static
r_void
id|velocity_get_drvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;driver
comma
id|VELOCITY_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;version
comma
id|VELOCITY_VERSION
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;bus_info
comma
id|vptr-&gt;pdev-&gt;slot_name
)paren
suffix:semicolon
)brace
DECL|function|velocity_ethtool_get_wol
r_static
r_void
id|velocity_ethtool_get_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_wolinfo
op_star
id|wol
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|wol-&gt;supported
op_assign
id|WAKE_PHY
op_or
id|WAKE_MAGIC
op_or
id|WAKE_UCAST
op_or
id|WAKE_ARP
suffix:semicolon
id|wol-&gt;wolopts
op_or_assign
id|WAKE_MAGIC
suffix:semicolon
multiline_comment|/*&n;&t;   if (vptr-&gt;wol_opts &amp; VELOCITY_WOL_PHY)&n;&t;&t;   wol.wolopts|=WAKE_PHY;&n;&t;&t;&t; */
r_if
c_cond
(paren
id|vptr-&gt;wol_opts
op_amp
id|VELOCITY_WOL_UCAST
)paren
id|wol-&gt;wolopts
op_or_assign
id|WAKE_UCAST
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;wol_opts
op_amp
id|VELOCITY_WOL_ARP
)paren
id|wol-&gt;wolopts
op_or_assign
id|WAKE_ARP
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|wol-&gt;sopass
comma
id|vptr-&gt;wol_passwd
comma
l_int|6
)paren
suffix:semicolon
)brace
DECL|function|velocity_ethtool_set_wol
r_static
r_int
id|velocity_ethtool_set_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_wolinfo
op_star
id|wol
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|wol-&gt;wolopts
op_amp
(paren
id|WAKE_PHY
op_or
id|WAKE_MAGIC
op_or
id|WAKE_UCAST
op_or
id|WAKE_ARP
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|vptr-&gt;wol_opts
op_assign
id|VELOCITY_WOL_MAGIC
suffix:semicolon
multiline_comment|/*&n;&t;   if (wol.wolopts &amp; WAKE_PHY) {&n;&t;   vptr-&gt;wol_opts|=VELOCITY_WOL_PHY;&n;&t;   vptr-&gt;flags |=VELOCITY_FLAGS_WOL_ENABLED;&n;&t;   }&n;&t; */
r_if
c_cond
(paren
id|wol-&gt;wolopts
op_amp
id|WAKE_MAGIC
)paren
(brace
id|vptr-&gt;wol_opts
op_or_assign
id|VELOCITY_WOL_MAGIC
suffix:semicolon
id|vptr-&gt;flags
op_or_assign
id|VELOCITY_FLAGS_WOL_ENABLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wol-&gt;wolopts
op_amp
id|WAKE_UCAST
)paren
(brace
id|vptr-&gt;wol_opts
op_or_assign
id|VELOCITY_WOL_UCAST
suffix:semicolon
id|vptr-&gt;flags
op_or_assign
id|VELOCITY_FLAGS_WOL_ENABLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wol-&gt;wolopts
op_amp
id|WAKE_ARP
)paren
(brace
id|vptr-&gt;wol_opts
op_or_assign
id|VELOCITY_WOL_ARP
suffix:semicolon
id|vptr-&gt;flags
op_or_assign
id|VELOCITY_FLAGS_WOL_ENABLED
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|vptr-&gt;wol_passwd
comma
id|wol-&gt;sopass
comma
l_int|6
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|velocity_get_msglevel
r_static
id|u32
id|velocity_get_msglevel
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|msglevel
suffix:semicolon
)brace
DECL|function|velocity_set_msglevel
r_static
r_void
id|velocity_set_msglevel
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|value
)paren
(brace
id|msglevel
op_assign
id|value
suffix:semicolon
)brace
DECL|variable|velocity_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|velocity_ethtool_ops
op_assign
(brace
dot
id|get_settings
op_assign
id|velocity_get_settings
comma
dot
id|set_settings
op_assign
id|velocity_set_settings
comma
dot
id|get_drvinfo
op_assign
id|velocity_get_drvinfo
comma
dot
id|get_wol
op_assign
id|velocity_ethtool_get_wol
comma
dot
id|set_wol
op_assign
id|velocity_ethtool_set_wol
comma
dot
id|get_msglevel
op_assign
id|velocity_get_msglevel
comma
dot
id|set_msglevel
op_assign
id|velocity_set_msglevel
comma
dot
id|get_link
op_assign
id|velocity_get_link
comma
dot
id|begin
op_assign
id|velocity_ethtool_up
comma
dot
id|complete
op_assign
id|velocity_ethtool_down
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;velocity_mii_ioctl&t;&t;-&t;MII ioctl handler&n; *&t;@dev: network device&n; *&t;@ifr: the ifreq block for the ioctl&n; *&t;@cmd: the command&n; *&n; *&t;Process MII requests made via ioctl from the network layer. These&n; *&t;are used by tools like kudzu to interrogate the link state of the&n; *&t;hardware&n; */
DECL|function|velocity_mii_ioctl
r_static
r_int
id|velocity_mii_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|mii_ioctl_data
op_star
id|miidata
op_assign
id|if_mii
c_func
(paren
id|ifr
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGMIIPHY
suffix:colon
id|miidata-&gt;phy_id
op_assign
id|readb
c_func
(paren
op_amp
id|regs-&gt;MIIADR
)paren
op_amp
l_int|0x1f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGMIIREG
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|velocity_mii_read
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|miidata-&gt;reg_num
op_amp
l_int|0x1f
comma
op_amp
(paren
id|miidata-&gt;val_out
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCSMIIREG
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|err
op_assign
id|velocity_mii_write
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|miidata-&gt;reg_num
op_amp
l_int|0x1f
comma
id|miidata-&gt;val_in
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|check_connection_type
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
multiline_comment|/**&n; *&t;velocity_save_context&t;-&t;save registers&n; *&t;@vptr: velocity &n; *&t;@context: buffer for stored context&n; *&n; *&t;Retrieve the current configuration from the velocity hardware&n; *&t;and stash it in the context structure, for use by the context&n; *&t;restore functions. This allows us to save things we need across&n; *&t;power down states&n; */
DECL|function|velocity_save_context
r_static
r_void
id|velocity_save_context
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_struct
id|velocity_context
op_star
id|context
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
id|u16
id|i
suffix:semicolon
id|u8
op_star
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|regs
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|MAC_REG_PAR
suffix:semicolon
id|i
OL
id|MAC_REG_CR0_CLR
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
op_assign
id|readl
c_func
(paren
id|ptr
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|MAC_REG_MAR
suffix:semicolon
id|i
OL
id|MAC_REG_TDCSR_CLR
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
op_assign
id|readl
c_func
(paren
id|ptr
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|MAC_REG_RDBASE_LO
suffix:semicolon
id|i
OL
id|MAC_REG_FIFO_TEST0
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
op_assign
id|readl
c_func
(paren
id|ptr
op_plus
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_restore_context&t;-&t;restore registers&n; *&t;@vptr: velocity &n; *&t;@context: buffer for stored context&n; *&n; *&t;Reload the register configuration from the velocity context &n; *&t;created by velocity_save_context.&n; */
DECL|function|velocity_restore_context
r_static
r_void
id|velocity_restore_context
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
comma
r_struct
id|velocity_context
op_star
id|context
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u8
op_star
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|regs
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|MAC_REG_PAR
suffix:semicolon
id|i
OL
id|MAC_REG_CR0_SET
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|writel
c_func
(paren
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
comma
id|ptr
op_plus
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Just skip cr0 */
r_for
c_loop
(paren
id|i
op_assign
id|MAC_REG_CR1_SET
suffix:semicolon
id|i
OL
id|MAC_REG_CR0_CLR
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Clear */
id|writeb
c_func
(paren
op_complement
(paren
op_star
(paren
(paren
id|u8
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
)paren
comma
id|ptr
op_plus
id|i
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Set */
id|writeb
c_func
(paren
op_star
(paren
(paren
id|u8
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
comma
id|ptr
op_plus
id|i
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|MAC_REG_MAR
suffix:semicolon
id|i
OL
id|MAC_REG_IMR
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|writel
c_func
(paren
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
comma
id|ptr
op_plus
id|i
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|MAC_REG_RDBASE_LO
suffix:semicolon
id|i
OL
id|MAC_REG_FIFO_TEST0
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|writel
c_func
(paren
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
comma
id|ptr
op_plus
id|i
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|MAC_REG_TDCSR_SET
suffix:semicolon
id|i
op_le
id|MAC_REG_RDCSR_SET
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
op_star
(paren
(paren
id|u8
op_star
)paren
(paren
id|context-&gt;mac_reg
op_plus
id|i
)paren
)paren
comma
id|ptr
op_plus
id|i
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;wol_calc_crc&t;&t;-&t;WOL CRC&n; *&t;@pattern: data pattern&n; *&t;@mask_pattern: mask&n; *&n; *&t;Compute the wake on lan crc hashes for the packet header&n; *&t;we are interested in.&n; */
DECL|function|wol_calc_crc
id|u16
id|wol_calc_crc
c_func
(paren
r_int
id|size
comma
id|u8
op_star
id|pattern
comma
id|u8
op_star
id|mask_pattern
)paren
(brace
id|u16
id|crc
op_assign
l_int|0xFFFF
suffix:semicolon
id|u8
id|mask
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mask
op_assign
id|mask_pattern
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Skip this loop if the mask equals to zero */
r_if
c_cond
(paren
id|mask
op_eq
l_int|0x00
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|mask
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
(brace
id|mask
op_rshift_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|mask
op_rshift_assign
l_int|1
suffix:semicolon
id|crc
op_assign
id|crc_ccitt
c_func
(paren
id|crc
comma
op_amp
(paren
id|pattern
(braket
id|i
op_star
l_int|8
op_plus
id|j
)braket
)paren
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&t;Finally, invert the result once to get the correct data */
id|crc
op_assign
op_complement
id|crc
suffix:semicolon
r_return
id|bitreverse
c_func
(paren
id|crc
)paren
op_rshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;velocity_set_wol&t;-&t;set up for wake on lan&n; *&t;@vptr: velocity to set WOL status on&n; *&n; *&t;Set a card up for wake on lan either by unicast or by&n; *&t;ARP packet.&n; *&n; *&t;FIXME: check static buffer is safe here&n; */
DECL|function|velocity_set_wol
r_static
r_int
id|velocity_set_wol
c_func
(paren
r_struct
id|velocity_info
op_star
id|vptr
)paren
(brace
r_struct
id|mac_regs
op_star
id|regs
op_assign
id|vptr-&gt;mac_regs
suffix:semicolon
r_static
id|u8
id|buf
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_static
id|u32
id|mask_pattern
(braket
l_int|2
)braket
(braket
l_int|4
)braket
op_assign
(brace
(brace
l_int|0x00203000
comma
l_int|0x000003C0
comma
l_int|0x00000000
comma
l_int|0x0000000
)brace
comma
multiline_comment|/* ARP */
(brace
l_int|0xfffff000
comma
l_int|0xffffffff
comma
l_int|0xffffffff
comma
l_int|0x000ffff
)brace
multiline_comment|/* Magic Packet */
)brace
suffix:semicolon
id|writew
c_func
(paren
l_int|0xFFFF
comma
op_amp
id|regs-&gt;WOLCRClr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|WOLCFG_SAB
op_or
id|WOLCFG_SAM
comma
op_amp
id|regs-&gt;WOLCFGSet
)paren
suffix:semicolon
id|writew
c_func
(paren
id|WOLCR_MAGIC_EN
comma
op_amp
id|regs-&gt;WOLCRSet
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   if (vptr-&gt;wol_opts &amp; VELOCITY_WOL_PHY)&n;&t;   writew((WOLCR_LINKON_EN|WOLCR_LINKOFF_EN), &amp;regs-&gt;WOLCRSet);&n;&t; */
r_if
c_cond
(paren
id|vptr-&gt;wol_opts
op_amp
id|VELOCITY_WOL_UCAST
)paren
(brace
id|writew
c_func
(paren
id|WOLCR_UNICAST_EN
comma
op_amp
id|regs-&gt;WOLCRSet
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vptr-&gt;wol_opts
op_amp
id|VELOCITY_WOL_ARP
)paren
(brace
r_struct
id|arp_packet
op_star
id|arp
op_assign
(paren
r_struct
id|arp_packet
op_star
)paren
id|buf
suffix:semicolon
id|u16
id|crc
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|arp_packet
)paren
op_plus
l_int|7
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|writel
c_func
(paren
id|mask_pattern
(braket
l_int|0
)braket
(braket
id|i
)braket
comma
op_amp
id|regs-&gt;ByteMask
(braket
l_int|0
)braket
(braket
id|i
)braket
)paren
suffix:semicolon
id|arp-&gt;type
op_assign
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
suffix:semicolon
id|arp-&gt;ar_op
op_assign
id|htons
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|arp-&gt;ar_tip
comma
id|vptr-&gt;ip_addr
comma
l_int|4
)paren
suffix:semicolon
id|crc
op_assign
id|wol_calc_crc
c_func
(paren
(paren
r_sizeof
(paren
r_struct
id|arp_packet
)paren
op_plus
l_int|7
)paren
op_div
l_int|8
comma
id|buf
comma
(paren
id|u8
op_star
)paren
op_amp
id|mask_pattern
(braket
l_int|0
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writew
c_func
(paren
id|crc
comma
op_amp
id|regs-&gt;PatternCRC
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writew
c_func
(paren
id|WOLCR_ARP_EN
comma
op_amp
id|regs-&gt;WOLCRSet
)paren
suffix:semicolon
)brace
id|BYTE_REG_BITS_ON
c_func
(paren
id|PWCFG_WOLTYPE
comma
op_amp
id|regs-&gt;PWCFGSet
)paren
suffix:semicolon
id|BYTE_REG_BITS_ON
c_func
(paren
id|PWCFG_LEGACY_WOLEN
comma
op_amp
id|regs-&gt;PWCFGSet
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0x0FFF
comma
op_amp
id|regs-&gt;WOLSRClr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_AUTONEG_ENABLE
)paren
(brace
r_if
c_cond
(paren
id|PHYID_GET_PHY_ID
c_func
(paren
id|vptr-&gt;phy_id
)paren
op_eq
id|PHYID_CICADA_CS8201
)paren
id|MII_REG_BITS_ON
c_func
(paren
id|AUXCR_MDPPS
comma
id|MII_REG_AUXCR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|MII_REG_BITS_OFF
c_func
(paren
id|G1000CR_1000FD
op_or
id|G1000CR_1000
comma
id|MII_REG_G1000CR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vptr-&gt;mii_status
op_amp
id|VELOCITY_SPEED_1000
)paren
id|MII_REG_BITS_ON
c_func
(paren
id|BMCR_REAUTO
comma
id|MII_REG_BMCR
comma
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|BYTE_REG_BITS_ON
c_func
(paren
id|CHIPGCR_FCMODE
comma
op_amp
id|regs-&gt;CHIPGCR
)paren
suffix:semicolon
(brace
id|u8
id|GCR
suffix:semicolon
id|GCR
op_assign
id|readb
c_func
(paren
op_amp
id|regs-&gt;CHIPGCR
)paren
suffix:semicolon
id|GCR
op_assign
(paren
id|GCR
op_amp
op_complement
id|CHIPGCR_FCGMII
)paren
op_or
id|CHIPGCR_FCFDX
suffix:semicolon
id|writeb
c_func
(paren
id|GCR
comma
op_amp
id|regs-&gt;CHIPGCR
)paren
suffix:semicolon
)brace
id|BYTE_REG_BITS_OFF
c_func
(paren
id|ISR_PWEI
comma
op_amp
id|regs-&gt;ISR
)paren
suffix:semicolon
multiline_comment|/* Turn on SWPTAG just before entering power mode */
id|BYTE_REG_BITS_ON
c_func
(paren
id|STICKHW_SWPTAG
comma
op_amp
id|regs-&gt;STICKHW
)paren
suffix:semicolon
multiline_comment|/* Go to bed ..... */
id|BYTE_REG_BITS_ON
c_func
(paren
(paren
id|STICKHW_DS1
op_or
id|STICKHW_DS0
)paren
comma
op_amp
id|regs-&gt;STICKHW
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|velocity_suspend
r_static
r_int
id|velocity_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|vptr-&gt;dev
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|netif_device_detach
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|pci_save_state
c_func
(paren
id|pdev
comma
id|vptr-&gt;pci_state
)paren
suffix:semicolon
macro_line|#ifdef ETHTOOL_GWOL
r_if
c_cond
(paren
id|vptr-&gt;flags
op_amp
id|VELOCITY_FLAGS_WOL_ENABLED
)paren
(brace
id|velocity_get_ip
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|velocity_save_context
c_func
(paren
id|vptr
comma
op_amp
id|vptr-&gt;context
)paren
suffix:semicolon
id|velocity_shutdown
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|velocity_set_wol
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|pci_enable_wake
c_func
(paren
id|pdev
comma
l_int|3
comma
l_int|1
)paren
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|pdev
comma
l_int|3
)paren
suffix:semicolon
)brace
r_else
(brace
id|velocity_save_context
c_func
(paren
id|vptr
comma
op_amp
id|vptr-&gt;context
)paren
suffix:semicolon
id|velocity_shutdown
c_func
(paren
id|vptr
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|state
)paren
suffix:semicolon
)brace
macro_line|#else
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|velocity_resume
r_static
r_int
id|velocity_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|velocity_info
op_star
id|vptr
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|vptr-&gt;dev
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|pci_set_power_state
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|pci_enable_wake
c_func
(paren
id|pdev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|pci_restore_state
c_func
(paren
id|pdev
comma
id|vptr-&gt;pci_state
)paren
suffix:semicolon
id|mac_wol_reset
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|velocity_restore_context
c_func
(paren
id|vptr
comma
op_amp
id|vptr-&gt;context
)paren
suffix:semicolon
id|velocity_init_registers
c_func
(paren
id|vptr
comma
id|VELOCITY_INIT_WOL
)paren
suffix:semicolon
id|mac_disable_int
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|velocity_tx_srv
c_func
(paren
id|vptr
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vptr-&gt;num_txq
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|vptr-&gt;td_used
(braket
id|i
)braket
)paren
(brace
id|mac_tx_queue_wake
c_func
(paren
id|vptr-&gt;mac_regs
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|mac_enable_int
c_func
(paren
id|vptr-&gt;mac_regs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vptr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|vptr-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|velocity_netdev_event
r_static
r_int
id|velocity_netdev_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|notification
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
(paren
r_struct
id|in_ifaddr
op_star
)paren
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|ifa
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ifa-&gt;ifa_dev-&gt;dev
suffix:semicolon
r_struct
id|velocity_info
op_star
id|vptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|velocity_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|vptr
comma
op_amp
id|velocity_dev_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|vptr-&gt;dev
op_eq
id|dev
)paren
(brace
id|velocity_get_ip
c_func
(paren
id|vptr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|velocity_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
macro_line|#endif
eof
