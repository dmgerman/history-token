multiline_comment|/*&n; * ibm_emac_core.c&n; *&n; * Ethernet driver for the built in ethernet on the IBM 4xx PowerPC&n; * processors.&n; * &n; * (c) 2003 Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;&n; *&n; * Based on original work by&n; *&n; *      Armin Kuster &lt;akuster@mvista.com&gt;&n; * &t;Johnnie Peters &lt;jpeters@mvista.com&gt;&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; * TODO&n; *       - Check for races in the &quot;remove&quot; code path&n; *       - Add some Power Management to the MAC and the PHY&n; *       - Audit remaining of non-rewritten code (--BenH)&n; *       - Cleanup message display using msglevel mecanism&n; *       - Address all errata&n; *       - Audit all register update paths to ensure they&n; *         are being written post soft reset if required.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/ocp.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &quot;ibm_emac_core.h&quot;
singleline_comment|//#define MDIO_DEBUG(fmt) printk fmt
DECL|macro|MDIO_DEBUG
mdefine_line|#define MDIO_DEBUG(fmt)
singleline_comment|//#define LINK_DEBUG(fmt) printk fmt
DECL|macro|LINK_DEBUG
mdefine_line|#define LINK_DEBUG(fmt)
singleline_comment|//#define PKT_DEBUG(fmt) printk fmt
DECL|macro|PKT_DEBUG
mdefine_line|#define PKT_DEBUG(fmt)
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME        &quot;emac&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION     &quot;2.0&quot;
DECL|macro|DRV_AUTHOR
mdefine_line|#define DRV_AUTHOR      &quot;Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;&quot;
DECL|macro|DRV_DESC
mdefine_line|#define DRV_DESC        &quot;IBM EMAC Ethernet driver&quot;
multiline_comment|/*&n; * When mdio_idx &gt;= 0, contains a list of emac ocp_devs&n; * that have had their initialization deferred until the&n; * common MDIO controller has been initialized.&n; */
DECL|variable|emac_init_list
id|LIST_HEAD
c_func
(paren
id|emac_init_list
)paren
suffix:semicolon
DECL|variable|DRV_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRV_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRV_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRV_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|skb_res
r_static
r_int
id|skb_res
op_assign
id|SKB_RES
suffix:semicolon
id|module_param
c_func
(paren
id|skb_res
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|skb_res
comma
l_string|&quot;Amount of data to reserve on skb buffs&bslash;n&quot;
l_string|&quot;The 405 handles a misaligned IP header fine but&bslash;n&quot;
l_string|&quot;this can help if you are routing to a tunnel or a&bslash;n&quot;
l_string|&quot;device that needs aligned data. 0..2&quot;
)paren
suffix:semicolon
DECL|macro|RGMII_PRIV
mdefine_line|#define RGMII_PRIV(ocpdev) ((struct ibm_ocp_rgmii*)ocp_get_drvdata(ocpdev))
DECL|variable|rgmii_enable
r_static
r_int
r_int
id|rgmii_enable
(braket
)braket
op_assign
(brace
id|RGMII_RTBI
comma
id|RGMII_RGMII
comma
id|RGMII_TBI
comma
id|RGMII_GMII
)brace
suffix:semicolon
DECL|variable|rgmii_speed_mask
r_static
r_int
r_int
id|rgmii_speed_mask
(braket
)braket
op_assign
(brace
id|RGMII_MII2_SPDMASK
comma
id|RGMII_MII3_SPDMASK
)brace
suffix:semicolon
DECL|variable|rgmii_speed100
r_static
r_int
r_int
id|rgmii_speed100
(braket
)braket
op_assign
(brace
id|RGMII_MII2_100MB
comma
id|RGMII_MII3_100MB
)brace
suffix:semicolon
DECL|variable|rgmii_speed1000
r_static
r_int
r_int
id|rgmii_speed1000
(braket
)braket
op_assign
(brace
id|RGMII_MII2_1000MB
comma
id|RGMII_MII3_1000MB
)brace
suffix:semicolon
DECL|macro|ZMII_PRIV
mdefine_line|#define ZMII_PRIV(ocpdev) ((struct ibm_ocp_zmii*)ocp_get_drvdata(ocpdev))
DECL|variable|zmii_enable
r_static
r_int
r_int
id|zmii_enable
(braket
)braket
(braket
l_int|4
)braket
op_assign
(brace
(brace
id|ZMII_SMII0
comma
id|ZMII_RMII0
comma
id|ZMII_MII0
comma
op_complement
(paren
id|ZMII_MDI1
op_or
id|ZMII_MDI2
op_or
id|ZMII_MDI3
)paren
)brace
comma
(brace
id|ZMII_SMII1
comma
id|ZMII_RMII1
comma
id|ZMII_MII1
comma
op_complement
(paren
id|ZMII_MDI0
op_or
id|ZMII_MDI2
op_or
id|ZMII_MDI3
)paren
)brace
comma
(brace
id|ZMII_SMII2
comma
id|ZMII_RMII2
comma
id|ZMII_MII2
comma
op_complement
(paren
id|ZMII_MDI0
op_or
id|ZMII_MDI1
op_or
id|ZMII_MDI3
)paren
)brace
comma
(brace
id|ZMII_SMII3
comma
id|ZMII_RMII3
comma
id|ZMII_MII3
comma
op_complement
(paren
id|ZMII_MDI0
op_or
id|ZMII_MDI1
op_or
id|ZMII_MDI2
)paren
)brace
)brace
suffix:semicolon
DECL|variable|mdi_enable
r_static
r_int
r_int
id|mdi_enable
(braket
)braket
op_assign
(brace
id|ZMII_MDI0
comma
id|ZMII_MDI1
comma
id|ZMII_MDI2
comma
id|ZMII_MDI3
)brace
suffix:semicolon
DECL|variable|zmii_speed
r_static
r_int
r_int
id|zmii_speed
op_assign
l_int|0x0
suffix:semicolon
DECL|variable|zmii_speed100
r_static
r_int
r_int
id|zmii_speed100
(braket
)braket
op_assign
(brace
id|ZMII_MII0_100MB
comma
id|ZMII_MII1_100MB
comma
id|ZMII_MII2_100MB
comma
id|ZMII_MII3_100MB
)brace
suffix:semicolon
multiline_comment|/* Since multiple EMACs share MDIO lines in various ways, we need&n; * to avoid re-using the same PHY ID in cases where the arch didn&squot;t&n; * setup precise phy_map entries&n; */
DECL|variable|busy_phy_map
r_static
id|u32
id|busy_phy_map
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If EMACs share a common MDIO device, this points to it */
DECL|variable|mdio_ndev
r_static
r_struct
id|net_device
op_star
id|mdio_ndev
op_assign
l_int|NULL
suffix:semicolon
DECL|struct|emac_def_dev
r_struct
id|emac_def_dev
(brace
DECL|member|link
r_struct
id|list_head
id|link
suffix:semicolon
DECL|member|ocpdev
r_struct
id|ocp_device
op_star
id|ocpdev
suffix:semicolon
DECL|member|mal
r_struct
id|ibm_ocp_mal
op_star
id|mal
suffix:semicolon
)brace
suffix:semicolon
DECL|function|emac_stats
r_static
r_struct
id|net_device_stats
op_star
id|emac_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|fep-&gt;stats
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|emac_init_rgmii
id|emac_init_rgmii
c_func
(paren
r_struct
id|ocp_device
op_star
id|rgmii_dev
comma
r_int
id|input
comma
r_int
id|phy_mode
)paren
(brace
r_struct
id|ibm_ocp_rgmii
op_star
id|rgmii
op_assign
id|RGMII_PRIV
c_func
(paren
id|rgmii_dev
)paren
suffix:semicolon
r_const
r_char
op_star
id|mode_name
(braket
)braket
op_assign
(brace
l_string|&quot;RTBI&quot;
comma
l_string|&quot;RGMII&quot;
comma
l_string|&quot;TBI&quot;
comma
l_string|&quot;GMII&quot;
)brace
suffix:semicolon
r_int
id|mode
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rgmii
)paren
(brace
id|rgmii
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ibm_ocp_rgmii
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rgmii
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;rgmii%d: Out of memory allocating RGMII structure!&bslash;n&quot;
comma
id|rgmii_dev-&gt;def-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|rgmii
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|rgmii
)paren
)paren
suffix:semicolon
id|rgmii-&gt;base
op_assign
(paren
r_struct
id|rgmii_regs
op_star
)paren
id|ioremap
c_func
(paren
id|rgmii_dev-&gt;def-&gt;paddr
comma
r_sizeof
(paren
op_star
id|rgmii-&gt;base
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rgmii-&gt;base
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;rgmii%d: Cannot ioremap bridge registers!&bslash;n&quot;
comma
id|rgmii_dev-&gt;def-&gt;index
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rgmii
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ocp_set_drvdata
c_func
(paren
id|rgmii_dev
comma
id|rgmii
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|phy_mode
)paren
(brace
r_switch
c_cond
(paren
id|phy_mode
)paren
(brace
r_case
id|PHY_MODE_GMII
suffix:colon
id|mode
op_assign
id|GMII
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_MODE_TBI
suffix:colon
id|mode
op_assign
id|TBI
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_MODE_RTBI
suffix:colon
id|mode
op_assign
id|RTBI
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_MODE_RGMII
suffix:colon
r_default
suffix:colon
id|mode
op_assign
id|RGMII
suffix:semicolon
)brace
id|rgmii-&gt;base-&gt;fer
op_and_assign
op_complement
id|RGMII_FER_MASK
c_func
(paren
id|input
)paren
suffix:semicolon
id|rgmii-&gt;base-&gt;fer
op_or_assign
id|rgmii_enable
(braket
id|mode
)braket
op_lshift
(paren
l_int|4
op_star
id|input
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
(paren
id|rgmii-&gt;base-&gt;fer
op_amp
id|RGMII_FER_MASK
c_func
(paren
id|input
)paren
)paren
op_rshift
(paren
l_int|4
op_star
id|input
)paren
)paren
(brace
r_case
id|RGMII_RTBI
suffix:colon
id|mode
op_assign
id|RTBI
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RGMII_RGMII
suffix:colon
id|mode
op_assign
id|RGMII
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RGMII_TBI
suffix:colon
id|mode
op_assign
id|TBI
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RGMII_GMII
suffix:colon
id|mode
op_assign
id|GMII
suffix:semicolon
)brace
)brace
multiline_comment|/* Set mode to RGMII if nothing valid is detected */
r_if
c_cond
(paren
id|mode
OL
l_int|0
)paren
id|mode
op_assign
id|RGMII
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;rgmii%d: input %d in %s mode&bslash;n&quot;
comma
id|rgmii_dev-&gt;def-&gt;index
comma
id|input
comma
id|mode_name
(braket
id|mode
)braket
)paren
suffix:semicolon
id|rgmii-&gt;mode
(braket
id|input
)braket
op_assign
id|mode
suffix:semicolon
id|rgmii-&gt;users
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|emac_rgmii_port_speed
id|emac_rgmii_port_speed
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
comma
r_int
id|input
comma
r_int
id|speed
)paren
(brace
r_struct
id|ibm_ocp_rgmii
op_star
id|rgmii
op_assign
id|RGMII_PRIV
c_func
(paren
id|ocpdev
)paren
suffix:semicolon
r_int
r_int
id|rgmii_speed
suffix:semicolon
id|rgmii_speed
op_assign
id|in_be32
c_func
(paren
op_amp
id|rgmii-&gt;base-&gt;ssr
)paren
suffix:semicolon
id|rgmii_speed
op_and_assign
op_complement
id|rgmii_speed_mask
(braket
id|input
)braket
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
l_int|1000
)paren
id|rgmii_speed
op_or_assign
id|rgmii_speed1000
(braket
id|input
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed
op_eq
l_int|100
)paren
id|rgmii_speed
op_or_assign
id|rgmii_speed100
(braket
id|input
)braket
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|rgmii-&gt;base-&gt;ssr
comma
id|rgmii_speed
)paren
suffix:semicolon
)brace
DECL|function|emac_close_rgmii
r_static
r_void
id|emac_close_rgmii
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
)paren
(brace
r_struct
id|ibm_ocp_rgmii
op_star
id|rgmii
op_assign
id|RGMII_PRIV
c_func
(paren
id|ocpdev
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|rgmii
op_logical_or
id|rgmii-&gt;users
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|rgmii-&gt;users
)paren
(brace
id|ocp_set_drvdata
c_func
(paren
id|ocpdev
comma
l_int|NULL
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|rgmii-&gt;base
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rgmii
)paren
suffix:semicolon
)brace
)brace
DECL|function|emac_init_zmii
r_static
r_int
id|emac_init_zmii
c_func
(paren
r_struct
id|ocp_device
op_star
id|zmii_dev
comma
r_int
id|input
comma
r_int
id|phy_mode
)paren
(brace
r_struct
id|ibm_ocp_zmii
op_star
id|zmii
op_assign
id|ZMII_PRIV
c_func
(paren
id|zmii_dev
)paren
suffix:semicolon
r_const
r_char
op_star
id|mode_name
(braket
)braket
op_assign
(brace
l_string|&quot;SMII&quot;
comma
l_string|&quot;RMII&quot;
comma
l_string|&quot;MII&quot;
)brace
suffix:semicolon
r_int
id|mode
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zmii
)paren
(brace
id|zmii
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ibm_ocp_zmii
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zmii
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;zmii%d: Out of memory allocating ZMII structure!&bslash;n&quot;
comma
id|zmii_dev-&gt;def-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|zmii
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|zmii
)paren
)paren
suffix:semicolon
id|zmii-&gt;base
op_assign
(paren
r_struct
id|zmii_regs
op_star
)paren
id|ioremap
c_func
(paren
id|zmii_dev-&gt;def-&gt;paddr
comma
r_sizeof
(paren
op_star
id|zmii-&gt;base
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zmii-&gt;base
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;zmii%d: Cannot ioremap bridge registers!&bslash;n&quot;
comma
id|zmii_dev-&gt;def-&gt;index
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|zmii
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ocp_set_drvdata
c_func
(paren
id|zmii_dev
comma
id|zmii
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|phy_mode
)paren
(brace
r_switch
c_cond
(paren
id|phy_mode
)paren
(brace
r_case
id|PHY_MODE_MII
suffix:colon
id|mode
op_assign
id|MII
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_MODE_RMII
suffix:colon
id|mode
op_assign
id|RMII
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_MODE_SMII
suffix:colon
r_default
suffix:colon
id|mode
op_assign
id|SMII
suffix:semicolon
)brace
id|zmii-&gt;base-&gt;fer
op_and_assign
op_complement
id|ZMII_FER_MASK
c_func
(paren
id|input
)paren
suffix:semicolon
id|zmii-&gt;base-&gt;fer
op_or_assign
id|zmii_enable
(braket
id|input
)braket
(braket
id|mode
)braket
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
(paren
id|zmii-&gt;base-&gt;fer
op_amp
id|ZMII_FER_MASK
c_func
(paren
id|input
)paren
)paren
op_lshift
(paren
l_int|4
op_star
id|input
)paren
)paren
(brace
r_case
id|ZMII_MII0
suffix:colon
id|mode
op_assign
id|MII
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZMII_RMII0
suffix:colon
id|mode
op_assign
id|RMII
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZMII_SMII0
suffix:colon
id|mode
op_assign
id|SMII
suffix:semicolon
)brace
)brace
multiline_comment|/* Set mode to SMII if nothing valid is detected */
r_if
c_cond
(paren
id|mode
OL
l_int|0
)paren
id|mode
op_assign
id|SMII
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;zmii%d: input %d in %s mode&bslash;n&quot;
comma
id|zmii_dev-&gt;def-&gt;index
comma
id|input
comma
id|mode_name
(braket
id|mode
)braket
)paren
suffix:semicolon
id|zmii-&gt;mode
(braket
id|input
)braket
op_assign
id|mode
suffix:semicolon
id|zmii-&gt;users
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emac_enable_zmii_port
r_static
r_void
id|emac_enable_zmii_port
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
comma
r_int
id|input
)paren
(brace
id|u32
id|mask
suffix:semicolon
r_struct
id|ibm_ocp_zmii
op_star
id|zmii
op_assign
id|ZMII_PRIV
c_func
(paren
id|ocpdev
)paren
suffix:semicolon
id|mask
op_assign
id|in_be32
c_func
(paren
op_amp
id|zmii-&gt;base-&gt;fer
)paren
suffix:semicolon
id|mask
op_and_assign
id|zmii_enable
(braket
id|input
)braket
(braket
id|MDI
)braket
suffix:semicolon
multiline_comment|/* turn all non enabled MDI&squot;s off */
id|mask
op_or_assign
id|zmii_enable
(braket
id|input
)braket
(braket
id|zmii-&gt;mode
(braket
id|input
)braket
)braket
op_or
id|mdi_enable
(braket
id|input
)braket
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|zmii-&gt;base-&gt;fer
comma
id|mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|emac_zmii_port_speed
id|emac_zmii_port_speed
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
comma
r_int
id|input
comma
r_int
id|speed
)paren
(brace
r_struct
id|ibm_ocp_zmii
op_star
id|zmii
op_assign
id|ZMII_PRIV
c_func
(paren
id|ocpdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
l_int|100
)paren
id|zmii_speed
op_or_assign
id|zmii_speed100
(braket
id|input
)braket
suffix:semicolon
r_else
id|zmii_speed
op_and_assign
op_complement
id|zmii_speed100
(braket
id|input
)braket
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|zmii-&gt;base-&gt;ssr
comma
id|zmii_speed
)paren
suffix:semicolon
)brace
DECL|function|emac_close_zmii
r_static
r_void
id|emac_close_zmii
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
)paren
(brace
r_struct
id|ibm_ocp_zmii
op_star
id|zmii
op_assign
id|ZMII_PRIV
c_func
(paren
id|ocpdev
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|zmii
op_logical_or
id|zmii-&gt;users
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|zmii-&gt;users
)paren
(brace
id|ocp_set_drvdata
c_func
(paren
id|ocpdev
comma
l_int|NULL
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|zmii-&gt;base
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|zmii
)paren
suffix:semicolon
)brace
)brace
DECL|function|emac_phy_read
r_int
id|emac_phy_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mii_id
comma
r_int
id|reg
)paren
(brace
r_int
id|count
suffix:semicolon
r_uint32
id|stacr
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot;%s: phy_read, id: 0x%x, reg: 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mii_id
comma
id|reg
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable proper ZMII port */
r_if
c_cond
(paren
id|fep-&gt;zmii_dev
)paren
id|emac_enable_zmii_port
c_func
(paren
id|fep-&gt;zmii_dev
comma
id|fep-&gt;zmii_input
)paren
suffix:semicolon
multiline_comment|/* Use the EMAC that has the MDIO port */
r_if
c_cond
(paren
id|fep-&gt;mdio_dev
)paren
(brace
id|dev
op_assign
id|fep-&gt;mdio_dev
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
)brace
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
(paren
id|stacr
op_assign
id|in_be32
c_func
(paren
op_amp
id|emacp-&gt;em0stacr
)paren
)paren
op_amp
id|EMAC_STACR_OC
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|count
op_increment
OL
id|MDIO_DELAY
)paren
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot; (count was %d)&bslash;n&quot;
comma
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stacr
op_amp
id|EMAC_STACR_OC
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PHY read timeout #1!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Clear the speed bits and make a read request to the PHY */
id|stacr
op_assign
(paren
(paren
id|EMAC_STACR_READ
op_or
(paren
id|reg
op_amp
l_int|0x1f
)paren
)paren
op_amp
op_complement
id|EMAC_STACR_CLK_100MHZ
)paren
suffix:semicolon
id|stacr
op_or_assign
(paren
(paren
id|mii_id
op_amp
l_int|0x1F
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0stacr
comma
id|stacr
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
(paren
id|stacr
op_assign
id|in_be32
c_func
(paren
op_amp
id|emacp-&gt;em0stacr
)paren
)paren
op_amp
id|EMAC_STACR_OC
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|count
op_increment
OL
id|MDIO_DELAY
)paren
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot; (count was %d)&bslash;n&quot;
comma
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stacr
op_amp
id|EMAC_STACR_OC
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PHY read timeout #2!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Check for a read error */
r_if
c_cond
(paren
id|stacr
op_amp
id|EMAC_STACR_PHYE
)paren
(brace
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot;EMAC MDIO PHY error !&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot; -&gt; 0x%x&bslash;n&quot;
comma
id|stacr
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
r_return
(paren
id|stacr
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|emac_phy_write
r_void
id|emac_phy_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mii_id
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
id|count
suffix:semicolon
r_uint32
id|stacr
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot;%s phy_write, id: 0x%x, reg: 0x%x, data: 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mii_id
comma
id|reg
comma
id|data
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable proper ZMII port */
r_if
c_cond
(paren
id|fep-&gt;zmii_dev
)paren
id|emac_enable_zmii_port
c_func
(paren
id|fep-&gt;zmii_dev
comma
id|fep-&gt;zmii_input
)paren
suffix:semicolon
multiline_comment|/* Use the EMAC that has the MDIO port */
r_if
c_cond
(paren
id|fep-&gt;mdio_dev
)paren
(brace
id|dev
op_assign
id|fep-&gt;mdio_dev
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
)brace
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
(paren
id|stacr
op_assign
id|in_be32
c_func
(paren
op_amp
id|emacp-&gt;em0stacr
)paren
)paren
op_amp
id|EMAC_STACR_OC
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|count
op_increment
OL
id|MDIO_DELAY
)paren
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot; (count was %d)&bslash;n&quot;
comma
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stacr
op_amp
id|EMAC_STACR_OC
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PHY write timeout #2!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Clear the speed bits and make a read request to the PHY */
id|stacr
op_assign
(paren
(paren
id|EMAC_STACR_WRITE
op_or
(paren
id|reg
op_amp
l_int|0x1f
)paren
)paren
op_amp
op_complement
id|EMAC_STACR_CLK_100MHZ
)paren
suffix:semicolon
id|stacr
op_or_assign
(paren
(paren
id|mii_id
op_amp
l_int|0x1f
)paren
op_lshift
l_int|5
)paren
op_or
(paren
(paren
id|data
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0stacr
comma
id|stacr
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stacr
op_assign
id|in_be32
c_func
(paren
op_amp
id|emacp-&gt;em0stacr
)paren
op_amp
id|EMAC_STACR_OC
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|count
op_increment
OL
l_int|5000
)paren
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot; (count was %d)&bslash;n&quot;
comma
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stacr
op_amp
id|EMAC_STACR_OC
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PHY write timeout #2!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Check for a write error */
r_if
c_cond
(paren
(paren
id|stacr
op_amp
id|EMAC_STACR_PHYE
)paren
op_ne
l_int|0
)paren
(brace
id|MDIO_DEBUG
c_func
(paren
(paren
l_string|&quot;EMAC MDIO PHY error !&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|emac_txeob_dev
r_static
r_void
id|emac_txeob_dev
c_func
(paren
r_void
op_star
id|param
comma
id|u32
id|chanmask
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|param
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|PKT_DEBUG
c_func
(paren
(paren
l_string|&quot;emac_txeob_dev() entry, tx_cnt: %d&bslash;n&quot;
comma
id|fep-&gt;tx_cnt
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|fep-&gt;tx_cnt
op_logical_and
op_logical_neg
(paren
id|fep-&gt;tx_desc
(braket
id|fep-&gt;ack_slot
)braket
dot
id|ctrl
op_amp
id|MAL_TX_CTRL_READY
)paren
)paren
(brace
r_if
c_cond
(paren
id|fep-&gt;tx_desc
(braket
id|fep-&gt;ack_slot
)braket
dot
id|ctrl
op_amp
id|MAL_TX_CTRL_LAST
)paren
(brace
multiline_comment|/* Tell the system the transmit completed. */
id|dma_unmap_single
c_func
(paren
op_amp
id|fep-&gt;ocpdev-&gt;dev
comma
id|fep-&gt;tx_desc
(braket
id|fep-&gt;ack_slot
)braket
dot
id|data_ptr
comma
id|fep-&gt;tx_desc
(braket
id|fep-&gt;ack_slot
)braket
dot
id|data_len
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|fep-&gt;tx_skb
(braket
id|fep-&gt;ack_slot
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;tx_desc
(braket
id|fep-&gt;ack_slot
)braket
dot
id|ctrl
op_amp
(paren
id|EMAC_TX_ST_EC
op_or
id|EMAC_TX_ST_MC
op_or
id|EMAC_TX_ST_SC
)paren
)paren
id|fep-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
id|fep-&gt;tx_skb
(braket
id|fep-&gt;ack_slot
)braket
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|fep-&gt;ack_slot
op_eq
id|NUM_TX_BUFF
)paren
id|fep-&gt;ack_slot
op_assign
l_int|0
suffix:semicolon
id|fep-&gt;tx_cnt
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fep-&gt;tx_cnt
OL
id|NUM_TX_BUFF
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|PKT_DEBUG
c_func
(paren
(paren
l_string|&quot;emac_txeob_dev() exit, tx_cnt: %d&bslash;n&quot;
comma
id|fep-&gt;tx_cnt
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  Fill/Re-fill the rx chain with valid ctrl/ptrs.&n;  This function will fill from rx_slot up to the parm end.&n;  So to completely fill the chain pre-set rx_slot to 0 and&n;  pass in an end of 0.&n; */
DECL|function|emac_rx_fill
r_static
r_void
id|emac_rx_fill
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|end
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|i
op_assign
id|fep-&gt;rx_slot
suffix:semicolon
r_do
(brace
multiline_comment|/* We don&squot;t want the 16 bytes skb_reserve done by dev_alloc_skb,&n;&t;&t; * it breaks our cache line alignement. However, we still allocate&n;&t;&t; * +16 so that we end up allocating the exact same size as&n;&t;&t; * dev_alloc_skb() would do.&n;&t;&t; * Also, because of the skb_res, the max DMA size we give to EMAC&n;&t;&t; * is slighly wrong, causing it to potentially DMA 2 more bytes&n;&t;&t; * from a broken/oversized packet. These 16 bytes will take care&n;&t;&t; * that we don&squot;t walk on somebody else toes with that.&n;&t;&t; */
id|fep-&gt;rx_skb
(braket
id|i
)braket
op_assign
id|alloc_skb
c_func
(paren
id|fep-&gt;rx_buffer_size
op_plus
l_int|16
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;rx_skb
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Keep rx_slot here, the next time clean/fill is called&n;&t;&t;&t; * we will try again before the MAL wraps back here&n;&t;&t;&t; * If the MAL tries to use this descriptor with&n;&t;&t;&t; * the EMPTY bit off it will cause the&n;&t;&t;&t; * rxde interrupt.  That is where we will&n;&t;&t;&t; * try again to allocate an sk_buff.&n;&t;&t;&t; */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_res
)paren
id|skb_reserve
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|i
)braket
comma
id|skb_res
)paren
suffix:semicolon
multiline_comment|/* We must NOT dma_map_single the cache line right after the&n;&t;&t; * buffer, so we must crop our sync size to account for the&n;&t;&t; * reserved space&n;&t;&t; */
id|fep-&gt;rx_desc
(braket
id|i
)braket
dot
id|data_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|dma_map_single
c_func
(paren
op_amp
id|fep-&gt;ocpdev-&gt;dev
comma
(paren
r_void
op_star
)paren
id|fep-&gt;rx_skb
(braket
id|i
)braket
op_member_access_from_pointer
id|data
comma
id|fep-&gt;rx_buffer_size
op_minus
id|skb_res
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Some 4xx implementations use the previously&n;&t;&t; * reserved bits in data_len to encode the MS&n;&t;&t; * 4-bits of a 36-bit physical address (ERPN)&n;&t;&t; * This must be initialized.&n;&t;&t; */
id|fep-&gt;rx_desc
(braket
id|i
)braket
dot
id|data_len
op_assign
l_int|0
suffix:semicolon
id|fep-&gt;rx_desc
(braket
id|i
)braket
dot
id|ctrl
op_assign
id|MAL_RX_CTRL_EMPTY
op_or
id|MAL_RX_CTRL_INTR
op_or
(paren
id|i
op_eq
(paren
id|NUM_RX_BUFF
op_minus
l_int|1
)paren
ques
c_cond
id|MAL_RX_CTRL_WRAP
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|i
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFF
)paren
op_ne
id|end
)paren
suffix:semicolon
id|fep-&gt;rx_slot
op_assign
id|i
suffix:semicolon
)brace
r_static
r_void
DECL|function|emac_rx_csum
id|emac_rx_csum
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|ctrl
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Exit if interface has no TAH engine */
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;tah_dev
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Check for TCP/UDP/IP csum error */
r_if
c_cond
(paren
id|ctrl
op_amp
id|EMAC_CSUM_VER_ERROR
)paren
(brace
multiline_comment|/* Let the stack verify checksum errors */
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
multiline_comment|/*&t;&t;adapter-&gt;hw_csum_err++; */
)brace
r_else
(brace
multiline_comment|/* Csum is good */
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
multiline_comment|/*&t;&t;adapter-&gt;hw_csum_good++; */
)brace
)brace
DECL|function|emac_rx_clean
r_static
r_int
id|emac_rx_clean
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|b
comma
id|bnum
comma
id|buf
(braket
l_int|6
)braket
suffix:semicolon
r_int
id|error
comma
id|frame_length
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
id|i
op_assign
id|fep-&gt;rx_slot
suffix:semicolon
id|PKT_DEBUG
c_func
(paren
(paren
l_string|&quot;emac_rx_clean() entry, rx_slot: %d&bslash;n&quot;
comma
id|fep-&gt;rx_slot
)paren
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|fep-&gt;rx_skb
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
multiline_comment|/*we have already handled the packet but haved failed to alloc */
multiline_comment|/* &n;&t;&t;   since rx_desc is in uncached mem we don&squot;t keep reading it directly &n;&t;&t;   we pull out a local copy of ctrl and do the checks on the copy.&n;&t;&t; */
id|ctrl
op_assign
id|fep-&gt;rx_desc
(braket
id|i
)braket
dot
id|ctrl
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_amp
id|MAL_RX_CTRL_EMPTY
)paren
r_break
suffix:semicolon
multiline_comment|/*we don&squot;t have any more ready packets */
r_if
c_cond
(paren
id|EMAC_IS_BAD_RX_PACKET
c_func
(paren
id|ctrl
)paren
)paren
(brace
id|fep-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|fep-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_amp
id|EMAC_RX_ST_OE
)paren
id|fep-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_amp
id|EMAC_RX_ST_AE
)paren
id|fep-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_amp
id|EMAC_RX_ST_BFCS
)paren
id|fep-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_amp
(paren
id|EMAC_RX_ST_RP
op_or
id|EMAC_RX_ST_PTL
op_or
id|EMAC_RX_ST_ORE
op_or
id|EMAC_RX_ST_IRE
)paren
)paren
id|fep-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|ctrl
op_amp
(paren
id|MAL_RX_CTRL_FIRST
op_or
id|MAL_RX_CTRL_LAST
)paren
)paren
op_eq
(paren
id|MAL_RX_CTRL_FIRST
op_or
id|MAL_RX_CTRL_LAST
)paren
)paren
(brace
multiline_comment|/* Single descriptor packet */
id|emac_rx_csum
c_func
(paren
id|dev
comma
id|ctrl
comma
id|fep-&gt;rx_skb
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Send the skb up the chain. */
id|frame_length
op_assign
id|fep-&gt;rx_desc
(braket
id|i
)braket
dot
id|data_len
op_minus
l_int|4
suffix:semicolon
id|skb_put
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|i
)braket
comma
id|frame_length
)paren
suffix:semicolon
id|fep-&gt;rx_skb
(braket
id|i
)braket
op_member_access_from_pointer
id|dev
op_assign
id|dev
suffix:semicolon
id|fep-&gt;rx_skb
(braket
id|i
)braket
op_member_access_from_pointer
id|protocol
op_assign
id|eth_type_trans
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|i
)braket
comma
id|dev
)paren
suffix:semicolon
id|error
op_assign
id|netif_rx
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_eq
id|NET_RX_DROP
)paren
op_logical_or
(paren
id|error
op_eq
id|NET_RX_BAD
)paren
)paren
(brace
id|fep-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|fep-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|fep-&gt;stats.rx_bytes
op_add_assign
id|frame_length
suffix:semicolon
)brace
id|fep-&gt;rx_skb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Multiple descriptor packet */
r_if
c_cond
(paren
id|ctrl
op_amp
id|MAL_RX_CTRL_FIRST
)paren
(brace
r_if
c_cond
(paren
id|fep-&gt;rx_desc
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFF
)braket
dot
id|ctrl
op_amp
id|MAL_RX_CTRL_EMPTY
)paren
r_break
suffix:semicolon
id|bnum
op_assign
l_int|0
suffix:semicolon
id|buf
(braket
id|bnum
)braket
op_assign
id|i
suffix:semicolon
op_increment
id|bnum
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|ctrl
op_amp
id|MAL_RX_CTRL_FIRST
)paren
op_ne
id|MAL_RX_CTRL_FIRST
)paren
op_logical_and
(paren
(paren
id|ctrl
op_amp
id|MAL_RX_CTRL_LAST
)paren
op_ne
id|MAL_RX_CTRL_LAST
)paren
)paren
(brace
r_if
c_cond
(paren
id|fep-&gt;rx_desc
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFF
)braket
dot
id|ctrl
op_amp
id|MAL_RX_CTRL_EMPTY
)paren
(brace
id|i
op_assign
id|buf
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|buf
(braket
id|bnum
)braket
op_assign
id|i
suffix:semicolon
op_increment
id|bnum
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl
op_amp
id|MAL_RX_CTRL_LAST
)paren
(brace
id|buf
(braket
id|bnum
)braket
op_assign
id|i
suffix:semicolon
op_increment
id|bnum
suffix:semicolon
id|skb_put
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
comma
id|fep-&gt;rx_desc
(braket
id|buf
(braket
l_int|0
)braket
)braket
dot
id|data_len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|1
suffix:semicolon
id|b
OL
id|bnum
suffix:semicolon
id|b
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * MAL is braindead, we need&n;&t;&t;&t;&t;&t;&t; * to copy the remainder&n;&t;&t;&t;&t;&t;&t; * of the packet from the&n;&t;&t;&t;&t;&t;&t; * latter descriptor buffers&n;&t;&t;&t;&t;&t;&t; * to the first skb. Then&n;&t;&t;&t;&t;&t;&t; * dispose of the source&n;&t;&t;&t;&t;&t;&t; * skbs.&n;&t;&t;&t;&t;&t;&t; *&n;&t;&t;&t;&t;&t;&t; * Once the stack is fixed&n;&t;&t;&t;&t;&t;&t; * to handle frags on most&n;&t;&t;&t;&t;&t;&t; * protocols we can generate&n;&t;&t;&t;&t;&t;&t; * a fragmented skb with&n;&t;&t;&t;&t;&t;&t; * no copies.&n;&t;&t;&t;&t;&t;&t; */
id|memcpy
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|data
op_plus
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|len
comma
id|fep-&gt;rx_skb
(braket
id|buf
(braket
id|b
)braket
)braket
op_member_access_from_pointer
id|data
comma
id|fep-&gt;rx_desc
(braket
id|buf
(braket
id|b
)braket
)braket
dot
id|data_len
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
comma
id|fep-&gt;rx_desc
(braket
id|buf
(braket
id|b
)braket
)braket
dot
id|data_len
)paren
suffix:semicolon
id|dma_unmap_single
c_func
(paren
op_amp
id|fep-&gt;ocpdev
op_member_access_from_pointer
id|dev
comma
id|fep
op_member_access_from_pointer
id|rx_desc
(braket
id|buf
(braket
id|b
)braket
)braket
dot
id|data_ptr
comma
id|fep
op_member_access_from_pointer
id|rx_desc
(braket
id|buf
(braket
id|b
)braket
)braket
dot
id|data_len
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|fep
op_member_access_from_pointer
id|rx_skb
(braket
id|buf
(braket
id|b
)braket
)braket
)paren
suffix:semicolon
)brace
id|emac_rx_csum
c_func
(paren
id|dev
comma
id|ctrl
comma
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
)paren
suffix:semicolon
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|dev
op_assign
id|dev
suffix:semicolon
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|protocol
op_assign
id|eth_type_trans
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
comma
id|dev
)paren
suffix:semicolon
id|error
op_assign
id|netif_rx
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_eq
id|NET_RX_DROP
)paren
op_logical_or
(paren
id|error
op_eq
id|NET_RX_BAD
)paren
)paren
(brace
id|fep-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|fep-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|fep-&gt;stats.rx_bytes
op_add_assign
id|fep-&gt;rx_skb
(braket
id|buf
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
)brace
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|bnum
suffix:semicolon
id|b
op_increment
)paren
id|fep-&gt;rx_skb
(braket
id|buf
(braket
id|b
)braket
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
)brace
r_while
c_loop
(paren
(paren
id|i
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFF
)paren
op_ne
id|fep-&gt;rx_slot
)paren
suffix:semicolon
id|PKT_DEBUG
c_func
(paren
(paren
l_string|&quot;emac_rx_clean() exit, rx_slot: %d&bslash;n&quot;
comma
id|fep-&gt;rx_slot
)paren
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|emac_rxeob_dev
r_static
r_void
id|emac_rxeob_dev
c_func
(paren
r_void
op_star
id|param
comma
id|u32
id|chanmask
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|param
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|n
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n
op_assign
id|emac_rx_clean
c_func
(paren
id|dev
)paren
)paren
op_ne
id|fep-&gt;rx_slot
)paren
id|emac_rx_fill
c_func
(paren
id|dev
comma
id|n
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This interrupt should never occurr, we don&squot;t program&n; * the MAL for contiunous mode.&n; */
DECL|function|emac_txde_dev
r_static
r_void
id|emac_txde_dev
c_func
(paren
r_void
op_star
id|param
comma
id|u32
id|chanmask
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|param
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit descriptor error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|emac_mac_dump
c_func
(paren
id|dev
)paren
suffix:semicolon
id|emac_mal_dump
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Reenable the transmit channel */
id|mal_enable_tx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.tx_chan_mask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This interrupt should be very rare at best.  This occurs when&n; * the hardware has a problem with the receive descriptors.  The manual&n; * states that it occurs when the hardware cannot the receive descriptor&n; * empty bit is not set.  The recovery mechanism will be to&n; * traverse through the descriptors, handle any that are marked to be&n; * handled and reinitialize each along the way.  At that point the driver&n; * will be restarted.&n; */
DECL|function|emac_rxde_dev
r_static
r_void
id|emac_rxde_dev
c_func
(paren
r_void
op_star
id|param
comma
id|u32
id|chanmask
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|param
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: receive descriptor error&bslash;n&quot;
comma
id|fep-&gt;ndev-&gt;name
)paren
suffix:semicolon
id|emac_mac_dump
c_func
(paren
id|dev
)paren
suffix:semicolon
id|emac_mal_dump
c_func
(paren
id|dev
)paren
suffix:semicolon
id|emac_desc_dump
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable RX channel */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mal_disable_rx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
multiline_comment|/* For now, charge the error against all emacs */
id|fep-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* so do we have any good packets still? */
id|emac_rx_clean
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* When the interface is restarted it resets processing to the&n;&t; *  first descriptor in the table.&n;&t; */
id|fep-&gt;rx_slot
op_assign
l_int|0
suffix:semicolon
id|emac_rx_fill
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|fep-&gt;mal
comma
id|DCRN_MALRXEOBISR
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|fep-&gt;mal
comma
id|DCRN_MALRXDEIR
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
multiline_comment|/* Reenable the receive channels */
id|mal_enable_rx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|emac_mac_irq
id|emac_mac_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
r_int
r_int
id|tmp_em0isr
suffix:semicolon
multiline_comment|/* EMAC interrupt */
id|tmp_em0isr
op_assign
id|in_be32
c_func
(paren
op_amp
id|emacp-&gt;em0isr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_em0isr
op_amp
(paren
id|EMAC_ISR_TE0
op_or
id|EMAC_ISR_TE1
)paren
)paren
(brace
multiline_comment|/* This error is a hard transmit error - could retransmit */
id|fep-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Reenable the transmit channel */
id|mal_enable_tx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.tx_chan_mask
)paren
suffix:semicolon
)brace
r_else
(brace
id|fep-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp_em0isr
op_amp
id|EMAC_ISR_RP
)paren
id|fep-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tmp_em0isr
op_amp
id|EMAC_ISR_ALE
)paren
id|fep-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tmp_em0isr
op_amp
id|EMAC_ISR_BFCS
)paren
id|fep-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tmp_em0isr
op_amp
id|EMAC_ISR_PTLE
)paren
id|fep-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tmp_em0isr
op_amp
id|EMAC_ISR_ORE
)paren
id|fep-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tmp_em0isr
op_amp
id|EMAC_ISR_TE0
)paren
id|fep-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
id|emac_err_dump
c_func
(paren
id|dev
comma
id|tmp_em0isr
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0isr
comma
id|tmp_em0isr
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|emac_start_xmit
r_static
r_int
id|emac_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|ctrl
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
r_int
id|offset
op_assign
l_int|0
comma
id|size
comma
id|f
comma
id|tx_slot_first
suffix:semicolon
r_int
r_int
id|nr_frags
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|len
op_sub_assign
id|skb-&gt;data_len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fep-&gt;tx_cnt
op_plus
id|nr_frags
op_plus
id|len
op_div
id|DESC_BUF_SIZE
op_plus
l_int|1
)paren
OG
id|NUM_TX_BUFF
)paren
(brace
id|PKT_DEBUG
c_func
(paren
(paren
l_string|&quot;emac_start_xmit() stopping queue&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|tx_slot_first
op_assign
id|fep-&gt;tx_slot
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
id|size
op_assign
id|min
c_func
(paren
id|len
comma
id|DESC_BUF_SIZE
)paren
suffix:semicolon
id|fep-&gt;tx_desc
(braket
id|fep-&gt;tx_slot
)braket
dot
id|data_len
op_assign
(paren
r_int
)paren
id|size
suffix:semicolon
id|fep-&gt;tx_desc
(braket
id|fep-&gt;tx_slot
)braket
dot
id|data_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|dma_map_single
c_func
(paren
op_amp
id|fep-&gt;ocpdev-&gt;dev
comma
(paren
r_void
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|skb
op_member_access_from_pointer
id|data
op_plus
id|offset
)paren
comma
id|size
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|ctrl
op_assign
id|EMAC_TX_CTRL_DFLT
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;tx_slot
op_ne
id|tx_slot_first
)paren
id|ctrl
op_or_assign
id|MAL_TX_CTRL_READY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|NUM_TX_BUFF
op_minus
l_int|1
)paren
op_eq
id|fep-&gt;tx_slot
)paren
id|ctrl
op_or_assign
id|MAL_TX_CTRL_WRAP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nr_frags
op_logical_and
(paren
id|len
op_eq
id|size
)paren
)paren
(brace
id|ctrl
op_or_assign
id|MAL_TX_CTRL_LAST
suffix:semicolon
id|fep-&gt;tx_skb
(braket
id|fep-&gt;tx_slot
)braket
op_assign
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
id|ctrl
op_or_assign
id|EMAC_TX_CTRL_TAH_CSUM
suffix:semicolon
id|fep-&gt;tx_desc
(braket
id|fep-&gt;tx_slot
)braket
dot
id|ctrl
op_assign
id|ctrl
suffix:semicolon
id|len
op_sub_assign
id|size
suffix:semicolon
id|offset
op_add_assign
id|size
suffix:semicolon
multiline_comment|/* Bump tx count */
r_if
c_cond
(paren
op_increment
id|fep-&gt;tx_cnt
op_eq
id|NUM_TX_BUFF
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Next descriptor */
r_if
c_cond
(paren
op_increment
id|fep-&gt;tx_slot
op_eq
id|NUM_TX_BUFF
)paren
id|fep-&gt;tx_slot
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|f
op_assign
l_int|0
suffix:semicolon
id|f
OL
id|nr_frags
suffix:semicolon
id|f
op_increment
)paren
(brace
r_struct
id|skb_frag_struct
op_star
id|frag
suffix:semicolon
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|f
)braket
suffix:semicolon
id|len
op_assign
id|frag-&gt;size
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
id|size
op_assign
id|min
c_func
(paren
id|len
comma
id|DESC_BUF_SIZE
)paren
suffix:semicolon
id|dma_map_page
c_func
(paren
op_amp
id|fep-&gt;ocpdev-&gt;dev
comma
id|frag-&gt;page
comma
id|frag-&gt;page_offset
op_plus
id|offset
comma
id|size
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|ctrl
op_assign
id|EMAC_TX_CTRL_DFLT
op_or
id|MAL_TX_CTRL_READY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|NUM_TX_BUFF
op_minus
l_int|1
)paren
op_eq
id|fep-&gt;tx_slot
)paren
id|ctrl
op_or_assign
id|MAL_TX_CTRL_WRAP
suffix:semicolon
r_if
c_cond
(paren
(paren
id|f
op_eq
(paren
id|nr_frags
op_minus
l_int|1
)paren
)paren
op_logical_and
(paren
id|len
op_eq
id|size
)paren
)paren
(brace
id|ctrl
op_or_assign
id|MAL_TX_CTRL_LAST
suffix:semicolon
id|fep-&gt;tx_skb
(braket
id|fep-&gt;tx_slot
)braket
op_assign
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
id|ctrl
op_or_assign
id|EMAC_TX_CTRL_TAH_CSUM
suffix:semicolon
id|fep-&gt;tx_desc
(braket
id|fep-&gt;tx_slot
)braket
dot
id|data_len
op_assign
(paren
r_int
)paren
id|size
suffix:semicolon
id|fep-&gt;tx_desc
(braket
id|fep-&gt;tx_slot
)braket
dot
id|data_ptr
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
id|page_to_pfn
c_func
(paren
id|frag-&gt;page
)paren
op_lshift
id|PAGE_SHIFT
)paren
op_plus
id|frag-&gt;page_offset
op_plus
id|offset
)paren
suffix:semicolon
id|fep-&gt;tx_desc
(braket
id|fep-&gt;tx_slot
)braket
dot
id|ctrl
op_assign
id|ctrl
suffix:semicolon
id|len
op_sub_assign
id|size
suffix:semicolon
id|offset
op_add_assign
id|size
suffix:semicolon
multiline_comment|/* Bump tx count */
r_if
c_cond
(paren
op_increment
id|fep-&gt;tx_cnt
op_eq
id|NUM_TX_BUFF
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Next descriptor */
r_if
c_cond
(paren
op_increment
id|fep-&gt;tx_slot
op_eq
id|NUM_TX_BUFF
)paren
id|fep-&gt;tx_slot
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Deferred set READY on first descriptor of packet to&n;&t; * avoid TX MAL race.&n;&t; */
id|fep-&gt;tx_desc
(braket
id|tx_slot_first
)braket
dot
id|ctrl
op_or_assign
id|MAL_TX_CTRL_READY
suffix:semicolon
multiline_comment|/* Send the packet out. */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0tmr0
comma
id|EMAC_TMR0_XMIT
)paren
suffix:semicolon
id|fep-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|fep-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|PKT_DEBUG
c_func
(paren
(paren
l_string|&quot;emac_start_xmit() exitn&quot;
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emac_adjust_to_link
r_static
r_int
id|emac_adjust_to_link
c_func
(paren
r_struct
id|ocp_enet_private
op_star
id|fep
)paren
(brace
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
r_struct
id|ibm_ocp_rgmii
op_star
id|rgmii
suffix:semicolon
r_int
r_int
id|mode_reg
suffix:semicolon
r_int
id|full_duplex
comma
id|speed
suffix:semicolon
id|full_duplex
op_assign
l_int|0
suffix:semicolon
id|speed
op_assign
id|SPEED_10
suffix:semicolon
multiline_comment|/* set mode register 1 defaults */
id|mode_reg
op_assign
id|EMAC_M1_DEFAULT
suffix:semicolon
multiline_comment|/* Read link mode on PHY */
r_if
c_cond
(paren
id|fep-&gt;phy_mii.def-&gt;ops
op_member_access_from_pointer
id|read_link
c_func
(paren
op_amp
id|fep-&gt;phy_mii
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* If an error occurred, we don&squot;t deal with it yet */
id|full_duplex
op_assign
(paren
id|fep-&gt;phy_mii.duplex
op_eq
id|DUPLEX_FULL
)paren
suffix:semicolon
id|speed
op_assign
id|fep-&gt;phy_mii.speed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fep-&gt;rgmii_dev
)paren
id|rgmii
op_assign
id|RGMII_PRIV
c_func
(paren
id|fep-&gt;rgmii_dev
)paren
suffix:semicolon
multiline_comment|/* set speed (default is 10Mb) */
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
id|SPEED_1000
suffix:colon
id|mode_reg
op_or_assign
id|EMAC_M1_JUMBO_ENABLE
op_or
id|EMAC_M1_RFS_16K
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rgmii-&gt;mode
(braket
id|fep-&gt;rgmii_input
)braket
op_eq
id|RTBI
)paren
op_logical_or
(paren
id|rgmii-&gt;mode
(braket
id|fep-&gt;rgmii_input
)braket
op_eq
id|TBI
)paren
)paren
id|mode_reg
op_or_assign
id|EMAC_M1_MF_1000GPCS
suffix:semicolon
r_else
id|mode_reg
op_or_assign
id|EMAC_M1_MF_1000MBPS
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;rgmii_dev
)paren
id|emac_rgmii_port_speed
c_func
(paren
id|fep-&gt;rgmii_dev
comma
id|fep-&gt;rgmii_input
comma
l_int|1000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPEED_100
suffix:colon
id|mode_reg
op_or_assign
id|EMAC_M1_MF_100MBPS
op_or
id|EMAC_M1_RFS_4K
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;rgmii_dev
)paren
id|emac_rgmii_port_speed
c_func
(paren
id|fep-&gt;rgmii_dev
comma
id|fep-&gt;rgmii_input
comma
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;zmii_dev
)paren
id|emac_zmii_port_speed
c_func
(paren
id|fep-&gt;zmii_dev
comma
id|fep-&gt;zmii_input
comma
l_int|100
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPEED_10
suffix:colon
r_default
suffix:colon
id|mode_reg
op_assign
(paren
id|mode_reg
op_amp
op_complement
id|EMAC_M1_MF_100MBPS
)paren
op_or
id|EMAC_M1_RFS_4K
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;rgmii_dev
)paren
id|emac_rgmii_port_speed
c_func
(paren
id|fep-&gt;rgmii_dev
comma
id|fep-&gt;rgmii_input
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;zmii_dev
)paren
id|emac_zmii_port_speed
c_func
(paren
id|fep-&gt;zmii_dev
comma
id|fep-&gt;zmii_input
comma
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|full_duplex
)paren
id|mode_reg
op_or_assign
id|EMAC_M1_FDE
op_or
id|EMAC_M1_EIFC
op_or
id|EMAC_M1_IST
suffix:semicolon
r_else
id|mode_reg
op_and_assign
op_complement
(paren
id|EMAC_M1_FDE
op_or
id|EMAC_M1_EIFC
op_or
id|EMAC_M1_ILE
)paren
suffix:semicolon
id|LINK_DEBUG
c_func
(paren
(paren
l_string|&quot;%s: adjust to link, speed: %d, duplex: %d, opened: %d&bslash;n&quot;
comma
id|fep-&gt;ndev-&gt;name
comma
id|speed
comma
id|full_duplex
comma
id|fep-&gt;opened
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Speed: %d, %s duplex.&bslash;n&quot;
comma
id|fep-&gt;ndev-&gt;name
comma
id|speed
comma
id|full_duplex
ques
c_cond
l_string|&quot;Full&quot;
suffix:colon
l_string|&quot;Half&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;opened
)paren
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0mr1
comma
id|mode_reg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emac_set_mac_address
r_static
r_int
id|emac_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_void
op_star
id|p
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
r_struct
id|sockaddr
op_star
id|addr
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_valid_ether_addr
c_func
(paren
id|addr-&gt;sa_data
)paren
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|memcpy
c_func
(paren
id|ndev-&gt;dev_addr
comma
id|addr-&gt;sa_data
comma
id|ndev-&gt;addr_len
)paren
suffix:semicolon
multiline_comment|/* set the high address */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0iahr
comma
(paren
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* set the low address */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0ialr
comma
(paren
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emac_change_mtu
r_static
r_int
id|emac_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|old_mtu
op_assign
id|dev-&gt;mtu
suffix:semicolon
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
id|u32
id|em0mr0
suffix:semicolon
r_int
id|i
comma
id|full
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_mtu
OL
id|EMAC_MIN_MTU
)paren
op_logical_or
(paren
id|new_mtu
OG
id|EMAC_MAX_MTU
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;emac: Invalid MTU setting, MTU must be between %d and %d&bslash;n&quot;
comma
id|EMAC_MIN_MTU
comma
id|EMAC_MAX_MTU
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|old_mtu
op_ne
id|new_mtu
op_logical_and
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* Stop rx engine */
id|em0mr0
op_assign
id|in_be32
c_func
(paren
op_amp
id|emacp-&gt;em0mr0
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0mr0
comma
id|em0mr0
op_amp
op_complement
id|EMAC_M0_RXE
)paren
suffix:semicolon
multiline_comment|/* Wait for descriptors to be empty */
r_do
(brace
id|full
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_BUFF
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|fep-&gt;rx_desc
(braket
id|i
)braket
dot
id|ctrl
op_amp
id|MAL_RX_CTRL_EMPTY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;emac: RX ring is still full&bslash;n&quot;
)paren
suffix:semicolon
id|full
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|full
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mal_disable_rx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
multiline_comment|/* Destroy all old rx skbs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_BUFF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dma_unmap_single
c_func
(paren
op_amp
id|fep-&gt;ocpdev-&gt;dev
comma
id|fep-&gt;rx_desc
(braket
id|i
)braket
dot
id|data_ptr
comma
id|fep-&gt;rx_desc
(braket
id|i
)braket
dot
id|data_len
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|fep-&gt;rx_skb
(braket
id|i
)braket
)paren
suffix:semicolon
id|fep-&gt;rx_skb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Set new rx_buffer_size and advertise new mtu */
id|fep-&gt;rx_buffer_size
op_assign
id|new_mtu
op_plus
id|ENET_HEADER_SIZE
op_plus
id|ENET_FCS_SIZE
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
multiline_comment|/* Re-init rx skbs */
id|fep-&gt;rx_slot
op_assign
l_int|0
suffix:semicolon
id|emac_rx_fill
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Restart the rx engine */
id|mal_enable_rx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0mr0
comma
id|em0mr0
op_or
id|EMAC_M0_RXE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__emac_set_multicast_list
r_static
r_void
id|__emac_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
id|u32
id|rmr
op_assign
id|in_be32
c_func
(paren
op_amp
id|emacp-&gt;em0rmr
)paren
suffix:semicolon
multiline_comment|/* First clear all special bits, they can be set later */
id|rmr
op_and_assign
op_complement
(paren
id|EMAC_RMR_PME
op_or
id|EMAC_RMR_PMME
op_or
id|EMAC_RMR_MAE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|rmr
op_or_assign
id|EMAC_RMR_PME
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
op_logical_or
l_int|32
OL
id|dev-&gt;mc_count
)paren
(brace
multiline_comment|/*&n;&t;&t; * Must be setting up to use multicast&n;&t;&t; * Now check for promiscuous multicast&n;&t;&t; */
id|rmr
op_or_assign
id|EMAC_RMR_PMME
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_MULTICAST
op_logical_and
l_int|0
OL
id|dev-&gt;mc_count
)paren
(brace
r_int
r_int
id|em0gaht
(braket
l_int|4
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
suffix:semicolon
multiline_comment|/* Need to hash on the multicast address. */
r_for
c_loop
(paren
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|dmi
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
)paren
(brace
r_int
r_int
id|mc_crc
suffix:semicolon
r_int
r_int
id|bit_number
suffix:semicolon
id|mc_crc
op_assign
id|ether_crc
c_func
(paren
l_int|6
comma
(paren
r_char
op_star
)paren
id|dmi-&gt;dmi_addr
)paren
suffix:semicolon
id|bit_number
op_assign
l_int|63
op_minus
(paren
id|mc_crc
op_rshift
l_int|26
)paren
suffix:semicolon
multiline_comment|/* MSB: 0 LSB: 63 */
id|em0gaht
(braket
id|bit_number
op_rshift
l_int|4
)braket
op_or_assign
l_int|0x8000
op_rshift
(paren
id|bit_number
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
id|emacp-&gt;em0gaht1
op_assign
id|em0gaht
(braket
l_int|0
)braket
suffix:semicolon
id|emacp-&gt;em0gaht2
op_assign
id|em0gaht
(braket
l_int|1
)braket
suffix:semicolon
id|emacp-&gt;em0gaht3
op_assign
id|em0gaht
(braket
l_int|2
)braket
suffix:semicolon
id|emacp-&gt;em0gaht4
op_assign
id|em0gaht
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Turn on multicast addressing */
id|rmr
op_or_assign
id|EMAC_RMR_MAE
suffix:semicolon
)brace
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0rmr
comma
id|rmr
)paren
suffix:semicolon
)brace
DECL|function|emac_init_tah
r_static
r_int
id|emac_init_tah
c_func
(paren
r_struct
id|ocp_enet_private
op_star
id|fep
)paren
(brace
id|tah_t
op_star
id|tahp
suffix:semicolon
multiline_comment|/* Initialize TAH and enable checksum verification */
id|tahp
op_assign
(paren
id|tah_t
op_star
)paren
id|ioremap
c_func
(paren
id|fep-&gt;tah_dev-&gt;def-&gt;paddr
comma
r_sizeof
(paren
op_star
id|tahp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tahp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;tah%d: Cannot ioremap TAH registers!&bslash;n&quot;
comma
id|fep-&gt;tah_dev-&gt;def-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|out_be32
c_func
(paren
op_amp
id|tahp-&gt;tah_mr
comma
id|TAH_MR_SR
)paren
suffix:semicolon
multiline_comment|/* wait for reset to complete */
r_while
c_loop
(paren
id|in_be32
c_func
(paren
op_amp
id|tahp-&gt;tah_mr
)paren
op_amp
id|TAH_MR_SR
)paren
suffix:semicolon
multiline_comment|/* 10KB TAH TX FIFO accomodates the max MTU of 9000 */
id|out_be32
c_func
(paren
op_amp
id|tahp-&gt;tah_mr
comma
id|TAH_MR_CVR
op_or
id|TAH_MR_ST_768
op_or
id|TAH_MR_TFS_10KB
op_or
id|TAH_MR_DTFP
op_or
id|TAH_MR_DIG
)paren
suffix:semicolon
id|iounmap
c_func
(paren
op_amp
id|tahp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emac_init_rings
r_static
r_void
id|emac_init_rings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|ep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|loop
suffix:semicolon
id|ep-&gt;tx_desc
op_assign
(paren
r_struct
id|mal_descriptor
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|ep-&gt;mal-&gt;tx_virt_addr
op_plus
(paren
id|ep-&gt;mal_tx_chan
op_star
id|MAL_DT_ALIGN
)paren
)paren
suffix:semicolon
id|ep-&gt;rx_desc
op_assign
(paren
r_struct
id|mal_descriptor
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|ep-&gt;mal-&gt;rx_virt_addr
op_plus
(paren
id|ep-&gt;mal_rx_chan
op_star
id|MAL_DT_ALIGN
)paren
)paren
suffix:semicolon
multiline_comment|/* Fill in the transmit descriptor ring. */
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
id|NUM_TX_BUFF
suffix:semicolon
id|loop
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;tx_skb
(braket
id|loop
)braket
)paren
(brace
id|dma_unmap_single
c_func
(paren
op_amp
id|ep-&gt;ocpdev-&gt;dev
comma
id|ep-&gt;tx_desc
(braket
id|loop
)braket
dot
id|data_ptr
comma
id|ep-&gt;tx_desc
(braket
id|loop
)braket
dot
id|data_len
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|ep-&gt;tx_skb
(braket
id|loop
)braket
)paren
suffix:semicolon
)brace
id|ep-&gt;tx_skb
(braket
id|loop
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ep-&gt;tx_desc
(braket
id|loop
)braket
dot
id|ctrl
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;tx_desc
(braket
id|loop
)braket
dot
id|data_len
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;tx_desc
(braket
id|loop
)braket
dot
id|data_ptr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ep-&gt;tx_desc
(braket
id|loop
op_minus
l_int|1
)braket
dot
id|ctrl
op_or_assign
id|MAL_TX_CTRL_WRAP
suffix:semicolon
multiline_comment|/* Format the receive descriptor ring. */
id|ep-&gt;rx_slot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Default is MTU=1500 + Ethernet overhead */
id|ep-&gt;rx_buffer_size
op_assign
id|ENET_DEF_BUF_SIZE
suffix:semicolon
id|emac_rx_fill
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;rx_slot
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Not enough mem for RxChain durning Open?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*We couldn&squot;t fill the ring at startup?&n;&t;&t; *We could clean up and fail to open but right now we will try to&n;&t;&t; *carry on. It may be a sign of a bad NUM_RX_BUFF value&n;&t;&t; */
)brace
id|ep-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;tx_slot
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;ack_slot
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|emac_reset_configure
r_static
r_void
id|emac_reset_configure
c_func
(paren
r_struct
id|ocp_enet_private
op_star
id|fep
)paren
(brace
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mal_disable_tx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.tx_chan_mask
)paren
suffix:semicolon
id|mal_disable_rx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check for a link, some PHYs don&squot;t provide a clock if&n;&t; * no link is present.  Some EMACs will not come out of&n;&t; * soft reset without a PHY clock present.&n;&t; */
r_if
c_cond
(paren
id|fep-&gt;phy_mii.def-&gt;ops
op_member_access_from_pointer
id|poll_link
c_func
(paren
op_amp
id|fep-&gt;phy_mii
)paren
)paren
(brace
multiline_comment|/* Reset the EMAC */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0mr0
comma
id|EMAC_M0_SRST
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|in_be32
c_func
(paren
op_amp
id|emacp-&gt;em0mr0
)paren
op_amp
id|EMAC_M0_SRST
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|100
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Cannot reset EMAC&bslash;n&quot;
comma
id|fep-&gt;ndev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Switch IRQs off for now */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0iser
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Configure MAL rx channel */
id|mal_set_rcbs
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;mal_rx_chan
comma
id|DESC_BUF_SIZE_REG
)paren
suffix:semicolon
multiline_comment|/* set the high address */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0iahr
comma
(paren
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* set the low address */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0ialr
comma
(paren
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|fep-&gt;ndev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* Adjust to link */
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|fep-&gt;ndev
)paren
)paren
id|emac_adjust_to_link
c_func
(paren
id|fep
)paren
suffix:semicolon
multiline_comment|/* enable broadcast/individual address and RX FIFO defaults */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0rmr
comma
id|EMAC_RMR_DEFAULT
)paren
suffix:semicolon
multiline_comment|/* set transmit request threshold register */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0trtr
comma
id|EMAC_TRTR_DEFAULT
)paren
suffix:semicolon
multiline_comment|/* Reconfigure multicast */
id|__emac_set_multicast_list
c_func
(paren
id|fep-&gt;ndev
)paren
suffix:semicolon
multiline_comment|/* Set receiver/transmitter defaults */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0rwmr
comma
id|EMAC_RWMR_DEFAULT
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0tmr0
comma
id|EMAC_TMR0_DEFAULT
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0tmr1
comma
id|EMAC_TMR1_DEFAULT
)paren
suffix:semicolon
multiline_comment|/* set frame gap */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0ipgvr
comma
id|CONFIG_IBM_EMAC_FGAP
)paren
suffix:semicolon
multiline_comment|/* Init ring buffers */
id|emac_init_rings
c_func
(paren
id|fep-&gt;ndev
)paren
suffix:semicolon
)brace
DECL|function|emac_kick
r_static
r_void
id|emac_kick
c_func
(paren
r_struct
id|ocp_enet_private
op_star
id|fep
)paren
(brace
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
r_int
r_int
id|emac_ier
suffix:semicolon
id|emac_ier
op_assign
id|EMAC_ISR_PP
op_or
id|EMAC_ISR_BP
op_or
id|EMAC_ISR_RP
op_or
id|EMAC_ISR_SE
op_or
id|EMAC_ISR_PTLE
op_or
id|EMAC_ISR_ALE
op_or
id|EMAC_ISR_BFCS
op_or
id|EMAC_ISR_ORE
op_or
id|EMAC_ISR_IRE
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0iser
comma
id|emac_ier
)paren
suffix:semicolon
multiline_comment|/* enable all MAL transmit and receive channels */
id|mal_enable_tx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.tx_chan_mask
)paren
suffix:semicolon
id|mal_enable_rx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
multiline_comment|/* set transmit and receive enable */
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0mr0
comma
id|EMAC_M0_TXE
op_or
id|EMAC_M0_RXE
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|emac_start_link
id|emac_start_link
c_func
(paren
r_struct
id|ocp_enet_private
op_star
id|fep
comma
r_struct
id|ethtool_cmd
op_star
id|ep
)paren
(brace
id|u32
id|advertise
suffix:semicolon
r_int
id|autoneg
suffix:semicolon
r_int
id|forced_speed
suffix:semicolon
r_int
id|forced_duplex
suffix:semicolon
multiline_comment|/* Default advertise */
id|advertise
op_assign
id|ADVERTISED_10baseT_Half
op_or
id|ADVERTISED_10baseT_Full
op_or
id|ADVERTISED_100baseT_Half
op_or
id|ADVERTISED_100baseT_Full
op_or
id|ADVERTISED_1000baseT_Half
op_or
id|ADVERTISED_1000baseT_Full
suffix:semicolon
id|autoneg
op_assign
id|fep-&gt;want_autoneg
suffix:semicolon
id|forced_speed
op_assign
id|fep-&gt;phy_mii.speed
suffix:semicolon
id|forced_duplex
op_assign
id|fep-&gt;phy_mii.duplex
suffix:semicolon
multiline_comment|/* Setup link parameters */
r_if
c_cond
(paren
id|ep
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
)paren
(brace
id|advertise
op_assign
id|ep-&gt;advertising
suffix:semicolon
id|autoneg
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|autoneg
op_assign
l_int|0
suffix:semicolon
id|forced_speed
op_assign
id|ep-&gt;speed
suffix:semicolon
id|forced_duplex
op_assign
id|ep-&gt;duplex
suffix:semicolon
)brace
)brace
multiline_comment|/* Configure PHY &amp; start aneg */
id|fep-&gt;want_autoneg
op_assign
id|autoneg
suffix:semicolon
r_if
c_cond
(paren
id|autoneg
)paren
(brace
id|LINK_DEBUG
c_func
(paren
(paren
l_string|&quot;%s: start link aneg, advertise: 0x%x&bslash;n&quot;
comma
id|fep-&gt;ndev-&gt;name
comma
id|advertise
)paren
)paren
suffix:semicolon
id|fep-&gt;phy_mii.def-&gt;ops
op_member_access_from_pointer
id|setup_aneg
c_func
(paren
op_amp
id|fep-&gt;phy_mii
comma
id|advertise
)paren
suffix:semicolon
)brace
r_else
(brace
id|LINK_DEBUG
c_func
(paren
(paren
l_string|&quot;%s: start link forced, speed: %d, duplex: %d&bslash;n&quot;
comma
id|fep-&gt;ndev-&gt;name
comma
id|forced_speed
comma
id|forced_duplex
)paren
)paren
suffix:semicolon
id|fep-&gt;phy_mii.def-&gt;ops
op_member_access_from_pointer
id|setup_forced
c_func
(paren
op_amp
id|fep-&gt;phy_mii
comma
id|forced_speed
comma
id|forced_duplex
)paren
suffix:semicolon
)brace
id|fep-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|fep-&gt;link_timer
comma
id|jiffies
op_plus
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|emac_link_timer
r_static
r_void
id|emac_link_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
(paren
r_struct
id|ocp_enet_private
op_star
)paren
id|data
suffix:semicolon
r_int
id|link
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;going_away
)paren
r_return
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|link
op_assign
id|fep-&gt;phy_mii.def-&gt;ops
op_member_access_from_pointer
id|poll_link
c_func
(paren
op_amp
id|fep-&gt;phy_mii
)paren
suffix:semicolon
id|LINK_DEBUG
c_func
(paren
(paren
l_string|&quot;%s: poll_link: %d&bslash;n&quot;
comma
id|fep-&gt;ndev-&gt;name
comma
id|link
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link
op_eq
id|netif_carrier_ok
c_func
(paren
id|fep-&gt;ndev
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|link
op_logical_and
id|fep-&gt;want_autoneg
op_logical_and
(paren
op_increment
id|fep-&gt;timer_ticks
)paren
OG
l_int|10
)paren
id|emac_start_link
c_func
(paren
id|fep
comma
l_int|NULL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link is %s&bslash;n&quot;
comma
id|fep-&gt;ndev-&gt;name
comma
id|link
ques
c_cond
l_string|&quot;Up&quot;
suffix:colon
l_string|&quot;Down&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link
)paren
(brace
id|netif_carrier_on
c_func
(paren
id|fep-&gt;ndev
)paren
suffix:semicolon
multiline_comment|/* Chip needs a full reset on config change. That sucks, so I&n;&t;&t; * should ultimately move that to some tasklet to limit&n;&t;&t; * latency peaks caused by this code&n;&t;&t; */
id|emac_reset_configure
c_func
(paren
id|fep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;opened
)paren
id|emac_kick
c_func
(paren
id|fep
)paren
suffix:semicolon
)brace
r_else
(brace
id|fep-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|fep-&gt;ndev
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|mod_timer
c_func
(paren
op_amp
id|fep-&gt;link_timer
comma
id|jiffies
op_plus
id|HZ
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|emac_set_multicast_list
r_static
r_void
id|emac_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|__emac_set_multicast_list
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|emac_get_settings
r_static
r_int
id|emac_get_settings
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|cmd-&gt;supported
op_assign
id|fep-&gt;phy_mii.def-&gt;features
suffix:semicolon
id|cmd-&gt;port
op_assign
id|PORT_MII
suffix:semicolon
id|cmd-&gt;transceiver
op_assign
id|XCVR_EXTERNAL
suffix:semicolon
id|cmd-&gt;phy_address
op_assign
id|fep-&gt;mii_phy_addr
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|cmd-&gt;autoneg
op_assign
id|fep-&gt;want_autoneg
suffix:semicolon
id|cmd-&gt;speed
op_assign
id|fep-&gt;phy_mii.speed
suffix:semicolon
id|cmd-&gt;duplex
op_assign
id|fep-&gt;phy_mii.duplex
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emac_set_settings
r_static
r_int
id|emac_set_settings
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_int
r_int
id|features
op_assign
id|fep-&gt;phy_mii.def-&gt;features
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;autoneg
op_ne
id|AUTONEG_ENABLE
op_logical_and
id|cmd-&gt;autoneg
op_ne
id|AUTONEG_DISABLE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
op_logical_and
id|cmd-&gt;advertising
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_ne
id|DUPLEX_HALF
op_logical_and
id|cmd-&gt;duplex
op_ne
id|DUPLEX_FULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;autoneg
op_eq
id|AUTONEG_DISABLE
)paren
r_switch
c_cond
(paren
id|cmd-&gt;speed
)paren
(brace
r_case
id|SPEED_10
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_HALF
op_logical_and
(paren
id|features
op_amp
id|SUPPORTED_10baseT_Half
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_FULL
op_logical_and
(paren
id|features
op_amp
id|SUPPORTED_10baseT_Full
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPEED_100
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_HALF
op_logical_and
(paren
id|features
op_amp
id|SUPPORTED_100baseT_Half
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_FULL
op_logical_and
(paren
id|features
op_amp
id|SUPPORTED_100baseT_Full
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPEED_1000
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_HALF
op_logical_and
(paren
id|features
op_amp
id|SUPPORTED_1000baseT_Half
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_FULL
op_logical_and
(paren
id|features
op_amp
id|SUPPORTED_1000baseT_Full
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|features
op_amp
id|SUPPORTED_Autoneg
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|emac_start_link
c_func
(paren
id|fep
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|emac_get_drvinfo
id|emac_get_drvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;driver
comma
id|DRV_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;version
comma
id|DRV_VERSION
)paren
suffix:semicolon
id|info-&gt;fw_version
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sprintf
c_func
(paren
id|info-&gt;bus_info
comma
l_string|&quot;IBM EMAC %d&quot;
comma
id|fep-&gt;ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
id|info-&gt;regdump_len
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|emac_nway_reset
r_static
r_int
id|emac_nway_reset
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;want_autoneg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|emac_start_link
c_func
(paren
id|fep
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emac_get_link
r_static
id|u32
id|emac_get_link
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_return
id|netif_carrier_ok
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
DECL|variable|emac_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|emac_ethtool_ops
op_assign
(brace
dot
id|get_settings
op_assign
id|emac_get_settings
comma
dot
id|set_settings
op_assign
id|emac_set_settings
comma
dot
id|get_drvinfo
op_assign
id|emac_get_drvinfo
comma
dot
id|nway_reset
op_assign
id|emac_nway_reset
comma
dot
id|get_link
op_assign
id|emac_get_link
)brace
suffix:semicolon
DECL|function|emac_ioctl
r_static
r_int
id|emac_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|uint
op_star
id|data
op_assign
(paren
id|uint
op_star
)paren
op_amp
id|rq-&gt;ifr_ifru
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGMIIPHY
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
id|fep-&gt;mii_phy_addr
suffix:semicolon
multiline_comment|/* Fall through */
r_case
id|SIOCGMIIREG
suffix:colon
id|data
(braket
l_int|3
)braket
op_assign
id|emac_phy_read
c_func
(paren
id|dev
comma
id|fep-&gt;mii_phy_addr
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCSMIIREG
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|emac_phy_write
c_func
(paren
id|dev
comma
id|fep-&gt;mii_phy_addr
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|emac_open
r_static
r_int
id|emac_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|fep-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Reset &amp; configure the chip */
id|emac_reset_configure
c_func
(paren
id|fep
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Request our interrupt lines */
id|rc
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|emac_mac_irq
comma
l_int|0
comma
l_string|&quot;IBM EMAC MAC&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dev-&gt;irq %d failed&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
multiline_comment|/* Kick the chip rx &amp; tx channels into life */
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|emac_kick
c_func
(paren
id|fep
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|bail
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|emac_close
r_static
r_int
id|emac_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ocp_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|emac_t
op_star
id|emacp
op_assign
id|fep-&gt;emacp
suffix:semicolon
multiline_comment|/* XXX Stop IRQ emitting here */
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|fep-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|mal_disable_tx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.tx_chan_mask
)paren
suffix:semicolon
id|mal_disable_rx_channels
c_func
(paren
id|fep-&gt;mal
comma
id|fep-&gt;commac.rx_chan_mask
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check for a link, some PHYs don&squot;t provide a clock if&n;&t; * no link is present.  Some EMACs will not come out of&n;&t; * soft reset without a PHY clock present.&n;&t; */
r_if
c_cond
(paren
id|fep-&gt;phy_mii.def-&gt;ops
op_member_access_from_pointer
id|poll_link
c_func
(paren
op_amp
id|fep-&gt;phy_mii
)paren
)paren
(brace
id|out_be32
c_func
(paren
op_amp
id|emacp-&gt;em0mr0
comma
id|EMAC_M0_SRST
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emacp-&gt;em0mr0
op_amp
id|EMAC_M0_SRST
)paren
(brace
multiline_comment|/*not sure what to do here hopefully it clears before another open */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Phy SoftReset didn&squot;t clear, no link?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Free the irq&squot;s */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emac_remove
r_static
r_void
id|emac_remove
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ocp_get_drvdata
c_func
(paren
id|ocpdev
)paren
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|ep
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* FIXME: locking, races, ... */
id|ep-&gt;going_away
op_assign
l_int|1
suffix:semicolon
id|ocp_set_drvdata
c_func
(paren
id|ocpdev
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;rgmii_dev
)paren
id|emac_close_rgmii
c_func
(paren
id|ep-&gt;rgmii_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;zmii_dev
)paren
id|emac_close_zmii
c_func
(paren
id|ep-&gt;zmii_dev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|ep-&gt;link_timer
)paren
suffix:semicolon
id|mal_unregister_commac
c_func
(paren
id|ep-&gt;mal
comma
op_amp
id|ep-&gt;commac
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ep-&gt;emacp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|variable|emac_commac_ops
r_struct
id|mal_commac_ops
id|emac_commac_ops
op_assign
(brace
dot
id|txeob
op_assign
op_amp
id|emac_txeob_dev
comma
dot
id|txde
op_assign
op_amp
id|emac_txde_dev
comma
dot
id|rxeob
op_assign
op_amp
id|emac_rxeob_dev
comma
dot
id|rxde
op_assign
op_amp
id|emac_rxde_dev
comma
)brace
suffix:semicolon
DECL|function|emac_init_device
r_static
r_int
id|emac_init_device
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
comma
r_struct
id|ibm_ocp_mal
op_star
id|mal
)paren
(brace
r_int
id|deferred_init
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
suffix:semicolon
r_struct
id|ocp_enet_private
op_star
id|ep
suffix:semicolon
r_struct
id|ocp_func_emac_data
op_star
id|emacdata
suffix:semicolon
r_int
id|commac_reg
op_assign
l_int|0
suffix:semicolon
id|u32
id|phy_map
suffix:semicolon
id|emacdata
op_assign
(paren
r_struct
id|ocp_func_emac_data
op_star
)paren
id|ocpdev-&gt;def-&gt;additions
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|emacdata
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;emac%d: Missing additional data!&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Allocate our net_device structure */
id|ndev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|ocp_enet_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ndev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;emac%d: Could not allocate ethernet device.&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ep
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|ep-&gt;ndev
op_assign
id|ndev
suffix:semicolon
id|ep-&gt;ocpdev
op_assign
id|ocpdev
suffix:semicolon
id|ndev-&gt;irq
op_assign
id|ocpdev-&gt;def-&gt;irq
suffix:semicolon
id|ep-&gt;wol_irq
op_assign
id|emacdata-&gt;wol_irq
suffix:semicolon
r_if
c_cond
(paren
id|emacdata-&gt;mdio_idx
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|emacdata-&gt;mdio_idx
op_eq
id|ocpdev-&gt;def-&gt;index
)paren
(brace
multiline_comment|/* Set the common MDIO net_device */
id|mdio_ndev
op_assign
id|ndev
suffix:semicolon
id|deferred_init
op_assign
l_int|1
suffix:semicolon
)brace
id|ep-&gt;mdio_dev
op_assign
id|mdio_ndev
suffix:semicolon
)brace
r_else
(brace
id|ep-&gt;mdio_dev
op_assign
id|ndev
suffix:semicolon
)brace
id|ocp_set_drvdata
c_func
(paren
id|ocpdev
comma
id|ndev
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ep-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Fill out MAL informations and register commac */
id|ep-&gt;mal
op_assign
id|mal
suffix:semicolon
id|ep-&gt;mal_tx_chan
op_assign
id|emacdata-&gt;mal_tx_chan
suffix:semicolon
id|ep-&gt;mal_rx_chan
op_assign
id|emacdata-&gt;mal_rx_chan
suffix:semicolon
id|ep-&gt;commac.ops
op_assign
op_amp
id|emac_commac_ops
suffix:semicolon
id|ep-&gt;commac.dev
op_assign
id|ndev
suffix:semicolon
id|ep-&gt;commac.tx_chan_mask
op_assign
id|MAL_CHAN_MASK
c_func
(paren
id|ep-&gt;mal_tx_chan
)paren
suffix:semicolon
id|ep-&gt;commac.rx_chan_mask
op_assign
id|MAL_CHAN_MASK
c_func
(paren
id|ep-&gt;mal_rx_chan
)paren
suffix:semicolon
id|rc
op_assign
id|mal_register_commac
c_func
(paren
id|ep-&gt;mal
comma
op_amp
id|ep-&gt;commac
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
r_goto
id|bail
suffix:semicolon
id|commac_reg
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Map our MMIOs */
id|ep-&gt;emacp
op_assign
(paren
id|emac_t
op_star
)paren
id|ioremap
c_func
(paren
id|ocpdev-&gt;def-&gt;paddr
comma
r_sizeof
(paren
id|emac_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Check if we need to attach to a ZMII */
r_if
c_cond
(paren
id|emacdata-&gt;zmii_idx
op_ge
l_int|0
)paren
(brace
id|ep-&gt;zmii_input
op_assign
id|emacdata-&gt;zmii_mux
suffix:semicolon
id|ep-&gt;zmii_dev
op_assign
id|ocp_find_device
c_func
(paren
id|OCP_ANY_ID
comma
id|OCP_FUNC_ZMII
comma
id|emacdata-&gt;zmii_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;zmii_dev
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;emac%d: ZMII %d requested but not found !&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
comma
id|emacdata-&gt;zmii_idx
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|emac_init_zmii
c_func
(paren
id|ep-&gt;zmii_dev
comma
id|ep-&gt;zmii_input
comma
id|emacdata-&gt;phy_mode
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|bail
suffix:semicolon
)brace
multiline_comment|/* Check if we need to attach to a RGMII */
r_if
c_cond
(paren
id|emacdata-&gt;rgmii_idx
op_ge
l_int|0
)paren
(brace
id|ep-&gt;rgmii_input
op_assign
id|emacdata-&gt;rgmii_mux
suffix:semicolon
id|ep-&gt;rgmii_dev
op_assign
id|ocp_find_device
c_func
(paren
id|OCP_ANY_ID
comma
id|OCP_FUNC_RGMII
comma
id|emacdata-&gt;rgmii_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;rgmii_dev
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;emac%d: RGMII %d requested but not found !&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
comma
id|emacdata-&gt;rgmii_idx
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|emac_init_rgmii
c_func
(paren
id|ep-&gt;rgmii_dev
comma
id|ep-&gt;rgmii_input
comma
id|emacdata-&gt;phy_mode
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|bail
suffix:semicolon
)brace
multiline_comment|/* Check if we need to attach to a TAH */
r_if
c_cond
(paren
id|emacdata-&gt;tah_idx
op_ge
l_int|0
)paren
(brace
id|ep-&gt;tah_dev
op_assign
id|ocp_find_device
c_func
(paren
id|OCP_ANY_ID
comma
id|OCP_FUNC_TAH
comma
id|emacdata-&gt;tah_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;tah_dev
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;emac%d: TAH %d requested but not found !&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
comma
id|emacdata-&gt;tah_idx
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|emac_init_tah
c_func
(paren
id|ep
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|bail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|deferred_init
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|emac_init_list
)paren
)paren
(brace
r_struct
id|list_head
op_star
id|entry
suffix:semicolon
r_struct
id|emac_def_dev
op_star
id|ddev
suffix:semicolon
id|list_for_each
c_func
(paren
id|entry
comma
op_amp
id|emac_init_list
)paren
(brace
id|ddev
op_assign
id|list_entry
c_func
(paren
id|entry
comma
r_struct
id|emac_def_dev
comma
id|link
)paren
suffix:semicolon
id|emac_init_device
c_func
(paren
id|ddev-&gt;ocpdev
comma
id|ddev-&gt;mal
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Init link monitoring timer */
id|init_timer
c_func
(paren
op_amp
id|ep-&gt;link_timer
)paren
suffix:semicolon
id|ep-&gt;link_timer.function
op_assign
id|emac_link_timer
suffix:semicolon
id|ep-&gt;link_timer.data
op_assign
(paren
r_int
r_int
)paren
id|ep
suffix:semicolon
id|ep-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fill up the mii_phy structure */
id|ep-&gt;phy_mii.dev
op_assign
id|ndev
suffix:semicolon
id|ep-&gt;phy_mii.mdio_read
op_assign
id|emac_phy_read
suffix:semicolon
id|ep-&gt;phy_mii.mdio_write
op_assign
id|emac_phy_write
suffix:semicolon
id|ep-&gt;phy_mii.mode
op_assign
id|emacdata-&gt;phy_mode
suffix:semicolon
multiline_comment|/* Find PHY */
id|phy_map
op_assign
id|emacdata-&gt;phy_map
op_or
id|busy_phy_map
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|0x1f
suffix:semicolon
id|i
op_increment
comma
id|phy_map
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|phy_map
op_amp
l_int|0x1
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|val
op_assign
id|emac_phy_read
c_func
(paren
id|ndev
comma
id|i
comma
id|MII_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0xffff
op_logical_and
id|val
op_ne
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0x20
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;emac%d: Can&squot;t find PHY.&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|busy_phy_map
op_or_assign
l_int|1
op_lshift
id|i
suffix:semicolon
id|ep-&gt;mii_phy_addr
op_assign
id|i
suffix:semicolon
id|rc
op_assign
id|mii_phy_probe
c_func
(paren
op_amp
id|ep-&gt;phy_mii
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;emac%d: Failed to probe PHY type.&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
multiline_comment|/* Setup initial PHY config &amp; startup aneg */
r_if
c_cond
(paren
id|ep-&gt;phy_mii.def-&gt;ops-&gt;init
)paren
id|ep-&gt;phy_mii.def-&gt;ops
op_member_access_from_pointer
id|init
c_func
(paren
op_amp
id|ep-&gt;phy_mii
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;phy_mii.def-&gt;features
op_amp
id|SUPPORTED_Autoneg
)paren
id|ep-&gt;want_autoneg
op_assign
l_int|1
suffix:semicolon
id|emac_start_link
c_func
(paren
id|ep
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* read the MAC Address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|ndev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|emacdata-&gt;mac_addr
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Fill in the driver function table */
id|ndev-&gt;open
op_assign
op_amp
id|emac_open
suffix:semicolon
id|ndev-&gt;hard_start_xmit
op_assign
op_amp
id|emac_start_xmit
suffix:semicolon
id|ndev-&gt;stop
op_assign
op_amp
id|emac_close
suffix:semicolon
id|ndev-&gt;get_stats
op_assign
op_amp
id|emac_stats
suffix:semicolon
r_if
c_cond
(paren
id|emacdata-&gt;jumbo
)paren
id|ndev-&gt;change_mtu
op_assign
op_amp
id|emac_change_mtu
suffix:semicolon
id|ndev-&gt;set_mac_address
op_assign
op_amp
id|emac_set_mac_address
suffix:semicolon
id|ndev-&gt;set_multicast_list
op_assign
op_amp
id|emac_set_multicast_list
suffix:semicolon
id|ndev-&gt;do_ioctl
op_assign
op_amp
id|emac_ioctl
suffix:semicolon
id|SET_ETHTOOL_OPS
c_func
(paren
id|ndev
comma
op_amp
id|emac_ethtool_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emacdata-&gt;tah_idx
op_ge
l_int|0
)paren
id|ndev-&gt;features
op_assign
id|NETIF_F_IP_CSUM
op_or
id|NETIF_F_SG
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|rc
op_assign
id|register_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
r_goto
id|bail
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: IBM emac, MAC %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|ndev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Found %s PHY (0x%02x)&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|ep-&gt;phy_mii.def-&gt;name
comma
id|ep-&gt;mii_phy_addr
)paren
suffix:semicolon
id|bail
suffix:colon
r_if
c_cond
(paren
id|rc
op_logical_and
id|commac_reg
)paren
id|mal_unregister_commac
c_func
(paren
id|ep-&gt;mal
comma
op_amp
id|ep-&gt;commac
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_and
id|ndev
)paren
id|kfree
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|emac_probe
r_static
r_int
id|emac_probe
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
)paren
(brace
r_struct
id|ocp_device
op_star
id|maldev
suffix:semicolon
r_struct
id|ibm_ocp_mal
op_star
id|mal
suffix:semicolon
r_struct
id|ocp_func_emac_data
op_star
id|emacdata
suffix:semicolon
id|emacdata
op_assign
(paren
r_struct
id|ocp_func_emac_data
op_star
)paren
id|ocpdev-&gt;def-&gt;additions
suffix:semicolon
r_if
c_cond
(paren
id|emacdata
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;emac%d: Missing additional datas !&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Get the MAL device  */
id|maldev
op_assign
id|ocp_find_device
c_func
(paren
id|OCP_ANY_ID
comma
id|OCP_FUNC_MAL
comma
id|emacdata-&gt;mal_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maldev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No maldev&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get MAL driver data, it must be here due to link order.&n;&t; * When the driver is modularized, symbol dependencies will&n;&t; * ensure the MAL driver is already present if built as a&n;&t; * module.&n;&t; */
id|mal
op_assign
(paren
r_struct
id|ibm_ocp_mal
op_star
)paren
id|ocp_get_drvdata
c_func
(paren
id|maldev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mal
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No maldrv&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* If we depend on another EMAC for MDIO, wait for it to show up */
r_if
c_cond
(paren
id|emacdata-&gt;mdio_idx
op_ge
l_int|0
op_logical_and
(paren
id|emacdata-&gt;mdio_idx
op_ne
id|ocpdev-&gt;def-&gt;index
)paren
op_logical_and
op_logical_neg
id|mdio_ndev
)paren
(brace
r_struct
id|emac_def_dev
op_star
id|ddev
suffix:semicolon
multiline_comment|/* Add this index to the deferred init table */
id|ddev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|emac_def_dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ddev-&gt;ocpdev
op_assign
id|ocpdev
suffix:semicolon
id|ddev-&gt;mal
op_assign
id|mal
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ddev-&gt;link
comma
op_amp
id|emac_init_list
)paren
suffix:semicolon
)brace
r_else
(brace
id|emac_init_device
c_func
(paren
id|ocpdev
comma
id|mal
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Structure for a device driver */
DECL|variable|emac_ids
r_static
r_struct
id|ocp_device_id
id|emac_ids
(braket
)braket
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|OCP_ANY_ID
comma
dot
id|function
op_assign
id|OCP_FUNC_EMAC
)brace
comma
(brace
dot
id|vendor
op_assign
id|OCP_VENDOR_INVALID
)brace
)brace
suffix:semicolon
DECL|variable|emac_driver
r_static
r_struct
id|ocp_driver
id|emac_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;emac&quot;
comma
dot
id|id_table
op_assign
id|emac_ids
comma
dot
id|probe
op_assign
id|emac_probe
comma
dot
id|remove
op_assign
id|emac_remove
comma
)brace
suffix:semicolon
DECL|function|emac_init
r_static
r_int
id|__init
id|emac_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_NAME
l_string|&quot;: &quot;
id|DRV_DESC
l_string|&quot;, version &quot;
id|DRV_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Maintained by &quot;
id|DRV_AUTHOR
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_res
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Invalid skb_res: %d, cropping to 2&bslash;n&quot;
comma
id|skb_res
)paren
suffix:semicolon
id|skb_res
op_assign
l_int|2
suffix:semicolon
)brace
r_return
id|ocp_register_driver
c_func
(paren
op_amp
id|emac_driver
)paren
suffix:semicolon
)brace
DECL|function|emac_exit
r_static
r_void
id|__exit
id|emac_exit
c_func
(paren
r_void
)paren
(brace
id|ocp_unregister_driver
c_func
(paren
op_amp
id|emac_driver
)paren
suffix:semicolon
)brace
DECL|variable|emac_init
id|module_init
c_func
(paren
id|emac_init
)paren
suffix:semicolon
DECL|variable|emac_exit
id|module_exit
c_func
(paren
id|emac_exit
)paren
suffix:semicolon
eof
