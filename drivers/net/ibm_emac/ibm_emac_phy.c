multiline_comment|/*&n; * ibm_ocp_phy.c&n; *&n; * PHY drivers for the ibm ocp ethernet driver. Borrowed&n; * from sungem_phy.c, though I only kept the generic MII&n; * driver for now.&n; * &n; * This file should be shared with other drivers or eventually&n; * merged as the &quot;low level&quot; part of miilib&n; * &n; * (c) 2003, Benjamin Herrenscmidt (benh@kernel.crashing.org)&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &quot;ibm_emac_phy.h&quot;
DECL|function|reset_one_mii_phy
r_static
r_int
id|reset_one_mii_phy
c_func
(paren
r_struct
id|mii_phy
op_star
id|phy
comma
r_int
id|phy_id
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
id|val
op_assign
id|__phy_read
c_func
(paren
id|phy
comma
id|phy_id
comma
id|MII_BMCR
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|BMCR_ISOLATE
suffix:semicolon
id|val
op_or_assign
id|BMCR_RESET
suffix:semicolon
id|__phy_write
c_func
(paren
id|phy
comma
id|phy_id
comma
id|MII_BMCR
comma
id|val
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_while
c_loop
(paren
id|limit
op_decrement
)paren
(brace
id|val
op_assign
id|__phy_read
c_func
(paren
id|phy
comma
id|phy_id
comma
id|MII_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
id|BMCR_RESET
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|val
op_amp
id|BMCR_ISOLATE
)paren
op_logical_and
id|limit
OG
l_int|0
)paren
id|__phy_write
c_func
(paren
id|phy
comma
id|phy_id
comma
id|MII_BMCR
comma
id|val
op_amp
op_complement
id|BMCR_ISOLATE
)paren
suffix:semicolon
r_return
(paren
id|limit
op_le
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|cis8201_init
r_static
r_int
id|cis8201_init
c_func
(paren
r_struct
id|mii_phy
op_star
id|phy
)paren
(brace
id|u16
id|epcr
suffix:semicolon
id|epcr
op_assign
id|phy_read
c_func
(paren
id|phy
comma
id|MII_CIS8201_EPCR
)paren
suffix:semicolon
id|epcr
op_and_assign
op_complement
id|EPCR_MODE_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|phy-&gt;mode
)paren
(brace
r_case
id|PHY_MODE_TBI
suffix:colon
id|epcr
op_or_assign
id|EPCR_TBI_MODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_MODE_RTBI
suffix:colon
id|epcr
op_or_assign
id|EPCR_RTBI_MODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_MODE_GMII
suffix:colon
id|epcr
op_or_assign
id|EPCR_GMII_MODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_MODE_RGMII
suffix:colon
r_default
suffix:colon
id|epcr
op_or_assign
id|EPCR_RGMII_MODE
suffix:semicolon
)brace
id|phy_write
c_func
(paren
id|phy
comma
id|MII_CIS8201_EPCR
comma
id|epcr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|genmii_setup_aneg
r_static
r_int
id|genmii_setup_aneg
c_func
(paren
r_struct
id|mii_phy
op_star
id|phy
comma
id|u32
id|advertise
)paren
(brace
id|u16
id|ctl
comma
id|adv
suffix:semicolon
id|phy-&gt;autoneg
op_assign
l_int|1
suffix:semicolon
id|phy-&gt;speed
op_assign
id|SPEED_10
suffix:semicolon
id|phy-&gt;duplex
op_assign
id|DUPLEX_HALF
suffix:semicolon
id|phy-&gt;pause
op_assign
l_int|0
suffix:semicolon
id|phy-&gt;advertising
op_assign
id|advertise
suffix:semicolon
multiline_comment|/* Setup standard advertise */
id|adv
op_assign
id|phy_read
c_func
(paren
id|phy
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
id|adv
op_and_assign
op_complement
(paren
id|ADVERTISE_ALL
op_or
id|ADVERTISE_100BASE4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|advertise
op_amp
id|ADVERTISED_10baseT_Half
)paren
id|adv
op_or_assign
id|ADVERTISE_10HALF
suffix:semicolon
r_if
c_cond
(paren
id|advertise
op_amp
id|ADVERTISED_10baseT_Full
)paren
id|adv
op_or_assign
id|ADVERTISE_10FULL
suffix:semicolon
r_if
c_cond
(paren
id|advertise
op_amp
id|ADVERTISED_100baseT_Half
)paren
id|adv
op_or_assign
id|ADVERTISE_100HALF
suffix:semicolon
r_if
c_cond
(paren
id|advertise
op_amp
id|ADVERTISED_100baseT_Full
)paren
id|adv
op_or_assign
id|ADVERTISE_100FULL
suffix:semicolon
id|phy_write
c_func
(paren
id|phy
comma
id|MII_ADVERTISE
comma
id|adv
)paren
suffix:semicolon
multiline_comment|/* Start/Restart aneg */
id|ctl
op_assign
id|phy_read
c_func
(paren
id|phy
comma
id|MII_BMCR
)paren
suffix:semicolon
id|ctl
op_or_assign
(paren
id|BMCR_ANENABLE
op_or
id|BMCR_ANRESTART
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|phy
comma
id|MII_BMCR
comma
id|ctl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|genmii_setup_forced
r_static
r_int
id|genmii_setup_forced
c_func
(paren
r_struct
id|mii_phy
op_star
id|phy
comma
r_int
id|speed
comma
r_int
id|fd
)paren
(brace
id|u16
id|ctl
suffix:semicolon
id|phy-&gt;autoneg
op_assign
l_int|0
suffix:semicolon
id|phy-&gt;speed
op_assign
id|speed
suffix:semicolon
id|phy-&gt;duplex
op_assign
id|fd
suffix:semicolon
id|phy-&gt;pause
op_assign
l_int|0
suffix:semicolon
id|ctl
op_assign
id|phy_read
c_func
(paren
id|phy
comma
id|MII_BMCR
)paren
suffix:semicolon
id|ctl
op_and_assign
op_complement
(paren
id|BMCR_FULLDPLX
op_or
id|BMCR_SPEED100
op_or
id|BMCR_ANENABLE
)paren
suffix:semicolon
multiline_comment|/* First reset the PHY */
id|phy_write
c_func
(paren
id|phy
comma
id|MII_BMCR
comma
id|ctl
op_or
id|BMCR_RESET
)paren
suffix:semicolon
multiline_comment|/* Select speed &amp; duplex */
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
id|SPEED_10
suffix:colon
r_break
suffix:semicolon
r_case
id|SPEED_100
suffix:colon
id|ctl
op_or_assign
id|BMCR_SPEED100
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPEED_1000
suffix:colon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fd
op_eq
id|DUPLEX_FULL
)paren
id|ctl
op_or_assign
id|BMCR_FULLDPLX
suffix:semicolon
id|phy_write
c_func
(paren
id|phy
comma
id|MII_BMCR
comma
id|ctl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|genmii_poll_link
r_static
r_int
id|genmii_poll_link
c_func
(paren
r_struct
id|mii_phy
op_star
id|phy
)paren
(brace
id|u16
id|status
suffix:semicolon
(paren
r_void
)paren
id|phy_read
c_func
(paren
id|phy
comma
id|MII_BMSR
)paren
suffix:semicolon
id|status
op_assign
id|phy_read
c_func
(paren
id|phy
comma
id|MII_BMSR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|BMSR_LSTATUS
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|phy-&gt;autoneg
op_logical_and
op_logical_neg
(paren
id|status
op_amp
id|BMSR_ANEGCOMPLETE
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|macro|MII_CIS8201_ACSR
mdefine_line|#define&t;MII_CIS8201_ACSR&t;0x1c
DECL|macro|ACSR_DUPLEX_STATUS
mdefine_line|#define  ACSR_DUPLEX_STATUS&t;0x0020
DECL|macro|ACSR_SPEED_1000BASET
mdefine_line|#define  ACSR_SPEED_1000BASET&t;0x0010
DECL|macro|ACSR_SPEED_100BASET
mdefine_line|#define  ACSR_SPEED_100BASET&t;0x0008
DECL|function|cis8201_read_link
r_static
r_int
id|cis8201_read_link
c_func
(paren
r_struct
id|mii_phy
op_star
id|phy
)paren
(brace
id|u16
id|acsr
suffix:semicolon
r_if
c_cond
(paren
id|phy-&gt;autoneg
)paren
(brace
id|acsr
op_assign
id|phy_read
c_func
(paren
id|phy
comma
id|MII_CIS8201_ACSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acsr
op_amp
id|ACSR_DUPLEX_STATUS
)paren
id|phy-&gt;duplex
op_assign
id|DUPLEX_FULL
suffix:semicolon
r_else
id|phy-&gt;duplex
op_assign
id|DUPLEX_HALF
suffix:semicolon
r_if
c_cond
(paren
id|acsr
op_amp
id|ACSR_SPEED_1000BASET
)paren
(brace
id|phy-&gt;speed
op_assign
id|SPEED_1000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|acsr
op_amp
id|ACSR_SPEED_100BASET
)paren
id|phy-&gt;speed
op_assign
id|SPEED_100
suffix:semicolon
r_else
id|phy-&gt;speed
op_assign
id|SPEED_10
suffix:semicolon
id|phy-&gt;pause
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* On non-aneg, we assume what we put in BMCR is the speed,&n;&t; * though magic-aneg shouldn&squot;t prevent this case from occurring&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|genmii_read_link
r_static
r_int
id|genmii_read_link
c_func
(paren
r_struct
id|mii_phy
op_star
id|phy
)paren
(brace
id|u16
id|lpa
suffix:semicolon
r_if
c_cond
(paren
id|phy-&gt;autoneg
)paren
(brace
id|lpa
op_assign
id|phy_read
c_func
(paren
id|phy
comma
id|MII_LPA
)paren
op_amp
id|phy_read
c_func
(paren
id|phy
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
id|phy-&gt;speed
op_assign
id|SPEED_10
suffix:semicolon
id|phy-&gt;duplex
op_assign
id|DUPLEX_HALF
suffix:semicolon
id|phy-&gt;pause
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lpa
op_amp
(paren
id|LPA_100FULL
op_or
id|LPA_100HALF
)paren
)paren
(brace
id|phy-&gt;speed
op_assign
id|SPEED_100
suffix:semicolon
r_if
c_cond
(paren
id|lpa
op_amp
id|LPA_100FULL
)paren
id|phy-&gt;duplex
op_assign
id|DUPLEX_FULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|lpa
op_amp
id|LPA_10FULL
)paren
id|phy-&gt;duplex
op_assign
id|DUPLEX_FULL
suffix:semicolon
)brace
multiline_comment|/* On non-aneg, we assume what we put in BMCR is the speed,&n;&t; * though magic-aneg shouldn&squot;t prevent this case from occurring&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|MII_BASIC_FEATURES
mdefine_line|#define MII_BASIC_FEATURES&t;(SUPPORTED_10baseT_Half | SUPPORTED_10baseT_Full | &bslash;&n;&t;&t;&t;&t; SUPPORTED_100baseT_Half | SUPPORTED_100baseT_Full | &bslash;&n;&t;&t;&t;&t; SUPPORTED_Autoneg | SUPPORTED_TP | SUPPORTED_MII)
DECL|macro|MII_GBIT_FEATURES
mdefine_line|#define MII_GBIT_FEATURES&t;(MII_BASIC_FEATURES | &bslash;&n;&t;&t;&t;&t; SUPPORTED_1000baseT_Half | SUPPORTED_1000baseT_Full)
multiline_comment|/* CIS8201 phy ops */
DECL|variable|cis8201_phy_ops
r_static
r_struct
id|mii_phy_ops
id|cis8201_phy_ops
op_assign
(brace
id|init
suffix:colon
id|cis8201_init
comma
id|setup_aneg
suffix:colon
id|genmii_setup_aneg
comma
id|setup_forced
suffix:colon
id|genmii_setup_forced
comma
id|poll_link
suffix:colon
id|genmii_poll_link
comma
id|read_link
suffix:colon
id|cis8201_read_link
)brace
suffix:semicolon
multiline_comment|/* Generic implementation for most 10/100 PHYs */
DECL|variable|generic_phy_ops
r_static
r_struct
id|mii_phy_ops
id|generic_phy_ops
op_assign
(brace
id|setup_aneg
suffix:colon
id|genmii_setup_aneg
comma
id|setup_forced
suffix:colon
id|genmii_setup_forced
comma
id|poll_link
suffix:colon
id|genmii_poll_link
comma
id|read_link
suffix:colon
id|genmii_read_link
)brace
suffix:semicolon
DECL|variable|cis8201_phy_def
r_static
r_struct
id|mii_phy_def
id|cis8201_phy_def
op_assign
(brace
id|phy_id
suffix:colon
l_int|0x000fc410
comma
id|phy_id_mask
suffix:colon
l_int|0x000ffff0
comma
id|name
suffix:colon
l_string|&quot;CIS8201 Gigabit Ethernet&quot;
comma
id|features
suffix:colon
id|MII_GBIT_FEATURES
comma
id|magic_aneg
suffix:colon
l_int|0
comma
id|ops
suffix:colon
op_amp
id|cis8201_phy_ops
)brace
suffix:semicolon
DECL|variable|genmii_phy_def
r_static
r_struct
id|mii_phy_def
id|genmii_phy_def
op_assign
(brace
id|phy_id
suffix:colon
l_int|0x00000000
comma
id|phy_id_mask
suffix:colon
l_int|0x00000000
comma
id|name
suffix:colon
l_string|&quot;Generic MII&quot;
comma
id|features
suffix:colon
id|MII_BASIC_FEATURES
comma
id|magic_aneg
suffix:colon
l_int|0
comma
id|ops
suffix:colon
op_amp
id|generic_phy_ops
)brace
suffix:semicolon
DECL|variable|mii_phy_table
r_static
r_struct
id|mii_phy_def
op_star
id|mii_phy_table
(braket
)braket
op_assign
(brace
op_amp
id|cis8201_phy_def
comma
op_amp
id|genmii_phy_def
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|mii_phy_probe
r_int
id|mii_phy_probe
c_func
(paren
r_struct
id|mii_phy
op_star
id|phy
comma
r_int
id|mii_id
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u32
id|id
suffix:semicolon
r_struct
id|mii_phy_def
op_star
id|def
suffix:semicolon
r_int
id|i
suffix:semicolon
id|phy-&gt;autoneg
op_assign
l_int|0
suffix:semicolon
id|phy-&gt;advertising
op_assign
l_int|0
suffix:semicolon
id|phy-&gt;mii_id
op_assign
id|mii_id
suffix:semicolon
id|phy-&gt;speed
op_assign
l_int|0
suffix:semicolon
id|phy-&gt;duplex
op_assign
l_int|0
suffix:semicolon
id|phy-&gt;pause
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Take PHY out of isloate mode and reset it. */
id|rc
op_assign
id|reset_one_mii_phy
c_func
(paren
id|phy
comma
id|mii_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Read ID and find matching entry */
id|id
op_assign
(paren
id|phy_read
c_func
(paren
id|phy
comma
id|MII_PHYSID1
)paren
op_lshift
l_int|16
op_or
id|phy_read
c_func
(paren
id|phy
comma
id|MII_PHYSID2
)paren
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|def
op_assign
id|mii_phy_table
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|id
op_amp
id|def-&gt;phy_id_mask
)paren
op_eq
id|def-&gt;phy_id
)paren
r_break
suffix:semicolon
multiline_comment|/* Should never be NULL (we have a generic entry), but... */
r_if
c_cond
(paren
id|def
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|phy-&gt;def
op_assign
id|def
suffix:semicolon
multiline_comment|/* Setup default advertising */
id|phy-&gt;advertising
op_assign
id|def-&gt;features
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
