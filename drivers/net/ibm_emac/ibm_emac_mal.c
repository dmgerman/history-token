multiline_comment|/*&n; * ibm_ocp_mal.c&n; *&n; *      Armin Kuster akuster@mvista.com&n; *      Juen, 2002&n; *&n; * Copyright 2002 MontaVista Softare Inc.&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/ocp.h&gt;
macro_line|#include &quot;ibm_emac_mal.h&quot;
singleline_comment|// Locking: Should we share a lock with the client ? The client could provide
singleline_comment|// a lock pointer (optionally) in the commac structure... I don&squot;t think this is
singleline_comment|// really necessary though
multiline_comment|/* This lock protects the commac list. On today UP implementations, it&squot;s&n; * really only used as IRQ protection in mal_{register,unregister}_commac()&n; */
DECL|variable|mal_list_lock
r_static
id|rwlock_t
id|mal_list_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|function|mal_register_commac
r_int
id|mal_register_commac
c_func
(paren
r_struct
id|ibm_ocp_mal
op_star
id|mal
comma
r_struct
id|mal_commac
op_star
id|commac
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|mal_list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t let multiple commacs claim the same channel */
r_if
c_cond
(paren
(paren
id|mal-&gt;tx_chan_mask
op_amp
id|commac-&gt;tx_chan_mask
)paren
op_logical_or
(paren
id|mal-&gt;rx_chan_mask
op_amp
id|commac-&gt;rx_chan_mask
)paren
)paren
(brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|mal_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|mal-&gt;tx_chan_mask
op_or_assign
id|commac-&gt;tx_chan_mask
suffix:semicolon
id|mal-&gt;rx_chan_mask
op_or_assign
id|commac-&gt;rx_chan_mask
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|commac-&gt;list
comma
op_amp
id|mal-&gt;commac
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|mal_list_lock
comma
id|flags
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mal_unregister_commac
r_int
id|mal_unregister_commac
c_func
(paren
r_struct
id|ibm_ocp_mal
op_star
id|mal
comma
r_struct
id|mal_commac
op_star
id|commac
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|mal_list_lock
comma
id|flags
)paren
suffix:semicolon
id|mal-&gt;tx_chan_mask
op_and_assign
op_complement
id|commac-&gt;tx_chan_mask
suffix:semicolon
id|mal-&gt;rx_chan_mask
op_and_assign
op_complement
id|commac-&gt;rx_chan_mask
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|commac-&gt;list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|mal_list_lock
comma
id|flags
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mal_set_rcbs
r_int
id|mal_set_rcbs
c_func
(paren
r_struct
id|ibm_ocp_mal
op_star
id|mal
comma
r_int
id|channel
comma
r_int
r_int
id|size
)paren
(brace
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRCBS0
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef DCRN_MALRCBS1
r_case
l_int|1
suffix:colon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRCBS1
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DCRN_MALRCBS2
r_case
l_int|2
suffix:colon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRCBS2
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DCRN_MALRCBS3
r_case
l_int|3
suffix:colon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRCBS3
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mal_serr
r_static
id|irqreturn_t
id|mal_serr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ibm_ocp_mal
op_star
id|mal
op_assign
id|dev_instance
suffix:semicolon
r_int
r_int
id|mal_error
suffix:semicolon
multiline_comment|/*&n;&t; * This SERR applies to one of the devices on the MAL, here we charge&n;&t; * it against the first EMAC registered for the MAL.&n;&t; */
id|mal_error
op_assign
id|get_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALESR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: System Error (MALESR=%lx)&bslash;n&quot;
comma
l_string|&quot;MAL&quot;
multiline_comment|/* FIXME: get the name right */
comma
id|mal_error
)paren
suffix:semicolon
multiline_comment|/* FIXME: decipher error */
multiline_comment|/* DIXME: distribute to commacs, if possible */
multiline_comment|/* Clear the error status register */
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALESR
comma
id|mal_error
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|mal_txeob
r_static
id|irqreturn_t
id|mal_txeob
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ibm_ocp_mal
op_star
id|mal
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
r_int
id|isr
suffix:semicolon
id|isr
op_assign
id|get_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXEOBISR
)paren
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXEOBISR
comma
id|isr
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|mal_list_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|mal-&gt;commac
)paren
(brace
r_struct
id|mal_commac
op_star
id|mc
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|mal_commac
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|mc-&gt;tx_chan_mask
)paren
(brace
id|mc-&gt;ops
op_member_access_from_pointer
id|txeob
c_func
(paren
id|mc-&gt;dev
comma
id|isr
op_amp
id|mc-&gt;tx_chan_mask
)paren
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|mal_list_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|mal_rxeob
r_static
id|irqreturn_t
id|mal_rxeob
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ibm_ocp_mal
op_star
id|mal
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
r_int
id|isr
suffix:semicolon
id|isr
op_assign
id|get_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRXEOBISR
)paren
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRXEOBISR
comma
id|isr
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|mal_list_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|mal-&gt;commac
)paren
(brace
r_struct
id|mal_commac
op_star
id|mc
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|mal_commac
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|mc-&gt;rx_chan_mask
)paren
(brace
id|mc-&gt;ops
op_member_access_from_pointer
id|rxeob
c_func
(paren
id|mc-&gt;dev
comma
id|isr
op_amp
id|mc-&gt;rx_chan_mask
)paren
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|mal_list_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|mal_txde
r_static
id|irqreturn_t
id|mal_txde
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ibm_ocp_mal
op_star
id|mal
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
r_int
id|deir
suffix:semicolon
id|deir
op_assign
id|get_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXDEIR
)paren
suffix:semicolon
multiline_comment|/* FIXME: print which MAL correctly */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Tx descriptor error (MALTXDEIR=%lx)&bslash;n&quot;
comma
l_string|&quot;MAL&quot;
comma
id|deir
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|mal_list_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|mal-&gt;commac
)paren
(brace
r_struct
id|mal_commac
op_star
id|mc
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|mal_commac
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|deir
op_amp
id|mc-&gt;tx_chan_mask
)paren
(brace
id|mc-&gt;ops
op_member_access_from_pointer
id|txde
c_func
(paren
id|mc-&gt;dev
comma
id|deir
op_amp
id|mc-&gt;tx_chan_mask
)paren
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|mal_list_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * This interrupt should be very rare at best.  This occurs when&n; * the hardware has a problem with the receive descriptors.  The manual&n; * states that it occurs when the hardware cannot the receive descriptor&n; * empty bit is not set.  The recovery mechanism will be to&n; * traverse through the descriptors, handle any that are marked to be&n; * handled and reinitialize each along the way.  At that point the driver&n; * will be restarted.&n; */
DECL|function|mal_rxde
r_static
id|irqreturn_t
id|mal_rxde
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ibm_ocp_mal
op_star
id|mal
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
r_int
id|deir
suffix:semicolon
id|deir
op_assign
id|get_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRXDEIR
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This really is needed.  This case encountered in stress testing.&n;&t; */
r_if
c_cond
(paren
id|deir
op_eq
l_int|0
)paren
r_return
id|IRQ_HANDLED
suffix:semicolon
multiline_comment|/* FIXME: print which MAL correctly */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Rx descriptor error (MALRXDEIR=%lx)&bslash;n&quot;
comma
l_string|&quot;MAL&quot;
comma
id|deir
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|mal_list_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|mal-&gt;commac
)paren
(brace
r_struct
id|mal_commac
op_star
id|mc
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|mal_commac
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|deir
op_amp
id|mc-&gt;rx_chan_mask
)paren
(brace
id|mc-&gt;ops
op_member_access_from_pointer
id|rxde
c_func
(paren
id|mc-&gt;dev
comma
id|deir
op_amp
id|mc-&gt;rx_chan_mask
)paren
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|mal_list_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|mal_probe
r_static
r_int
id|__init
id|mal_probe
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
)paren
(brace
r_struct
id|ibm_ocp_mal
op_star
id|mal
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ocp_func_mal_data
op_star
id|maldata
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|maldata
op_assign
(paren
r_struct
id|ocp_func_mal_data
op_star
)paren
id|ocpdev-&gt;def-&gt;additions
suffix:semicolon
r_if
c_cond
(paren
id|maldata
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mal%d: Missing additional datas !&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|mal
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ibm_ocp_mal
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mal
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mal%d: Out of memory allocating MAL structure !&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mal
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mal
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ocpdev-&gt;def-&gt;index
)paren
(brace
r_case
l_int|0
suffix:colon
id|mal-&gt;dcrbase
op_assign
id|DCRN_MAL_BASE
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef DCRN_MAL1_BASE
r_case
l_int|1
suffix:colon
id|mal-&gt;dcrbase
op_assign
id|DCRN_MAL1_BASE
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**************************/
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mal-&gt;commac
)paren
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRXCARR
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCARR
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALCR
comma
id|MALCR_MMSR
)paren
suffix:semicolon
multiline_comment|/* 384 */
multiline_comment|/* FIXME: Add delay */
multiline_comment|/* Set the MAL configuration register */
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALCR
comma
id|MALCR_PLBB
op_or
id|MALCR_OPBBL
op_or
id|MALCR_LEA
op_or
id|MALCR_PLBLT_DEFAULT
)paren
suffix:semicolon
multiline_comment|/* It would be nice to allocate buffers separately for each&n;&t; * channel, but we can&squot;t because the channels share the upper&n;&t; * 13 bits of address lines.  Each channels buffer must also&n;&t; * be 4k aligned, so we allocate 4k for each channel.  This is&n;&t; * inefficient FIXME: do better, if possible */
id|mal-&gt;tx_virt_addr
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ocpdev-&gt;dev
comma
id|MAL_DT_ALIGN
op_star
id|maldata-&gt;num_tx_chans
comma
op_amp
id|mal-&gt;tx_phys_addr
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mal-&gt;tx_virt_addr
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mal%d: Out of memory allocating MAL descriptors !&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* God, oh, god, I hate DCRs */
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCTP0R
comma
id|mal-&gt;tx_phys_addr
)paren
suffix:semicolon
macro_line|#ifdef DCRN_MALTXCTP1R
r_if
c_cond
(paren
id|maldata-&gt;num_tx_chans
OG
l_int|1
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCTP1R
comma
id|mal-&gt;tx_phys_addr
op_plus
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALTXCTP1R */
macro_line|#ifdef DCRN_MALTXCTP2R
r_if
c_cond
(paren
id|maldata-&gt;num_tx_chans
OG
l_int|2
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCTP2R
comma
id|mal-&gt;tx_phys_addr
op_plus
l_int|2
op_star
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALTXCTP2R */
macro_line|#ifdef DCRN_MALTXCTP3R
r_if
c_cond
(paren
id|maldata-&gt;num_tx_chans
OG
l_int|3
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCTP3R
comma
id|mal-&gt;tx_phys_addr
op_plus
l_int|3
op_star
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALTXCTP3R */
macro_line|#ifdef DCRN_MALTXCTP4R
r_if
c_cond
(paren
id|maldata-&gt;num_tx_chans
OG
l_int|4
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCTP4R
comma
id|mal-&gt;tx_phys_addr
op_plus
l_int|4
op_star
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALTXCTP4R */
macro_line|#ifdef DCRN_MALTXCTP5R
r_if
c_cond
(paren
id|maldata-&gt;num_tx_chans
OG
l_int|5
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCTP5R
comma
id|mal-&gt;tx_phys_addr
op_plus
l_int|5
op_star
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALTXCTP5R */
macro_line|#ifdef DCRN_MALTXCTP6R
r_if
c_cond
(paren
id|maldata-&gt;num_tx_chans
OG
l_int|6
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCTP6R
comma
id|mal-&gt;tx_phys_addr
op_plus
l_int|6
op_star
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALTXCTP6R */
macro_line|#ifdef DCRN_MALTXCTP7R
r_if
c_cond
(paren
id|maldata-&gt;num_tx_chans
OG
l_int|7
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALTXCTP7R
comma
id|mal-&gt;tx_phys_addr
op_plus
l_int|7
op_star
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALTXCTP7R */
id|mal-&gt;rx_virt_addr
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ocpdev-&gt;dev
comma
id|MAL_DT_ALIGN
op_star
id|maldata-&gt;num_rx_chans
comma
op_amp
id|mal-&gt;rx_phys_addr
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRXCTP0R
comma
id|mal-&gt;rx_phys_addr
)paren
suffix:semicolon
macro_line|#ifdef DCRN_MALRXCTP1R
r_if
c_cond
(paren
id|maldata-&gt;num_rx_chans
OG
l_int|1
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRXCTP1R
comma
id|mal-&gt;rx_phys_addr
op_plus
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALRXCTP1R */
macro_line|#ifdef DCRN_MALRXCTP2R
r_if
c_cond
(paren
id|maldata-&gt;num_rx_chans
OG
l_int|2
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRXCTP2R
comma
id|mal-&gt;rx_phys_addr
op_plus
l_int|2
op_star
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALRXCTP2R */
macro_line|#ifdef DCRN_MALRXCTP3R
r_if
c_cond
(paren
id|maldata-&gt;num_rx_chans
OG
l_int|3
)paren
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALRXCTP3R
comma
id|mal-&gt;rx_phys_addr
op_plus
l_int|3
op_star
id|MAL_DT_ALIGN
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DCRN_MALRXCTP3R */
id|err
op_assign
id|request_irq
c_func
(paren
id|maldata-&gt;serr_irq
comma
id|mal_serr
comma
l_int|0
comma
l_string|&quot;MAL SERR&quot;
comma
id|mal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|fail
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|maldata-&gt;txde_irq
comma
id|mal_txde
comma
l_int|0
comma
l_string|&quot;MAL TX DE &quot;
comma
id|mal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|fail
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|maldata-&gt;txeob_irq
comma
id|mal_txeob
comma
l_int|0
comma
l_string|&quot;MAL TX EOB&quot;
comma
id|mal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|fail
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|maldata-&gt;rxde_irq
comma
id|mal_rxde
comma
l_int|0
comma
l_string|&quot;MAL RX DE&quot;
comma
id|mal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|fail
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|maldata-&gt;rxeob_irq
comma
id|mal_rxeob
comma
l_int|0
comma
l_string|&quot;MAL RX EOB&quot;
comma
id|mal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|fail
suffix:semicolon
id|set_mal_dcrn
c_func
(paren
id|mal
comma
id|DCRN_MALIER
comma
id|MALIER_DE
op_or
id|MALIER_NE
op_or
id|MALIER_TE
op_or
id|MALIER_OPBE
op_or
id|MALIER_PLBE
)paren
suffix:semicolon
multiline_comment|/* Advertise me to the rest of the world */
id|ocp_set_drvdata
c_func
(paren
id|ocpdev
comma
id|mal
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mal%d: Initialized, %d tx channels, %d rx channels&bslash;n&quot;
comma
id|ocpdev-&gt;def-&gt;index
comma
id|maldata-&gt;num_tx_chans
comma
id|maldata-&gt;num_rx_chans
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
multiline_comment|/* FIXME: dispose requested IRQs ! */
r_if
c_cond
(paren
id|err
op_logical_and
id|mal
)paren
id|kfree
c_func
(paren
id|mal
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mal_remove
r_static
r_void
id|__exit
id|mal_remove
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocpdev
)paren
(brace
r_struct
id|ibm_ocp_mal
op_star
id|mal
op_assign
id|ocp_get_drvdata
c_func
(paren
id|ocpdev
)paren
suffix:semicolon
r_struct
id|ocp_func_mal_data
op_star
id|maldata
op_assign
id|ocpdev-&gt;def-&gt;additions
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|maldata
)paren
suffix:semicolon
id|ocp_set_drvdata
c_func
(paren
id|ocpdev
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* FIXME: shut down the MAL, deal with dependency with emac */
id|free_irq
c_func
(paren
id|maldata-&gt;serr_irq
comma
id|mal
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|maldata-&gt;txde_irq
comma
id|mal
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|maldata-&gt;txeob_irq
comma
id|mal
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|maldata-&gt;rxde_irq
comma
id|mal
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|maldata-&gt;rxeob_irq
comma
id|mal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mal-&gt;tx_virt_addr
)paren
id|dma_free_coherent
c_func
(paren
op_amp
id|ocpdev-&gt;dev
comma
id|MAL_DT_ALIGN
op_star
id|maldata-&gt;num_tx_chans
comma
id|mal-&gt;tx_virt_addr
comma
id|mal-&gt;tx_phys_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mal-&gt;rx_virt_addr
)paren
id|dma_free_coherent
c_func
(paren
op_amp
id|ocpdev-&gt;dev
comma
id|MAL_DT_ALIGN
op_star
id|maldata-&gt;num_rx_chans
comma
id|mal-&gt;rx_virt_addr
comma
id|mal-&gt;rx_phys_addr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mal
)paren
suffix:semicolon
)brace
multiline_comment|/* Structure for a device driver */
DECL|variable|mal_ids
r_static
r_struct
id|ocp_device_id
id|mal_ids
(braket
)braket
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|OCP_ANY_ID
comma
dot
id|function
op_assign
id|OCP_FUNC_MAL
)brace
comma
(brace
dot
id|vendor
op_assign
id|OCP_VENDOR_INVALID
)brace
)brace
suffix:semicolon
DECL|variable|mal_driver
r_static
r_struct
id|ocp_driver
id|mal_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;mal&quot;
comma
dot
id|id_table
op_assign
id|mal_ids
comma
dot
id|probe
op_assign
id|mal_probe
comma
dot
id|remove
op_assign
id|mal_remove
comma
)brace
suffix:semicolon
DECL|function|init_mals
r_static
r_int
id|__init
id|init_mals
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|ocp_register_driver
c_func
(paren
op_amp
id|mal_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|ocp_unregister_driver
c_func
(paren
op_amp
id|mal_driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_mals
r_static
r_void
id|__exit
id|exit_mals
c_func
(paren
r_void
)paren
(brace
id|ocp_unregister_driver
c_func
(paren
op_amp
id|mal_driver
)paren
suffix:semicolon
)brace
DECL|variable|init_mals
id|module_init
c_func
(paren
id|init_mals
)paren
suffix:semicolon
DECL|variable|exit_mals
id|module_exit
c_func
(paren
id|exit_mals
)paren
suffix:semicolon
eof
