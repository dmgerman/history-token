multiline_comment|/**************************************************************************/
multiline_comment|/*                                                                        */
multiline_comment|/* IBM eServer i/pSeries Virtual Ethernet Device Driver                   */
multiline_comment|/* Copyright (C) 2003 IBM Corp.                                           */
multiline_comment|/*  Originally written by Dave Larson (larson1@us.ibm.com)                */
multiline_comment|/*  Maintained by Santiago Leon (santil@us.ibm.com)                       */
multiline_comment|/*                                                                        */
multiline_comment|/*  This program is free software; you can redistribute it and/or modify  */
multiline_comment|/*  it under the terms of the GNU General Public License as published by  */
multiline_comment|/*  the Free Software Foundation; either version 2 of the License, or     */
multiline_comment|/*  (at your option) any later version.                                   */
multiline_comment|/*                                                                        */
multiline_comment|/*  This program is distributed in the hope that it will be useful,       */
multiline_comment|/*  but WITHOUT ANY WARRANTY; without even the implied warranty of        */
multiline_comment|/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         */
multiline_comment|/*  GNU General Public License for more details.                          */
multiline_comment|/*                                                                        */
multiline_comment|/*  You should have received a copy of the GNU General Public License     */
multiline_comment|/*  along with this program; if not, write to the Free Software           */
multiline_comment|/*  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  */
multiline_comment|/*                                                                   USA  */
multiline_comment|/*                                                                        */
multiline_comment|/* This module contains the implementation of a virtual ethernet device   */
multiline_comment|/* for use with IBM i/pSeries LPAR Linux.  It utilizes the logical LAN    */
multiline_comment|/* option of the RS/6000 Platform Architechture to interface with virtual */
multiline_comment|/* ethernet NICs that are presented to the partition by the hypervisor.   */
multiline_comment|/*                                                                        */
multiline_comment|/**************************************************************************/
multiline_comment|/*&n;  TODO:&n;  - remove frag processing code - no longer needed&n;  - add support for sysfs&n;  - possibly remove procfs support&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/hvcall.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/vio.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &quot;ibmveth.h&quot;
DECL|macro|DEBUG
mdefine_line|#define DEBUG 1
DECL|macro|ibmveth_printk
mdefine_line|#define ibmveth_printk(fmt, args...) &bslash;&n;  printk(KERN_INFO &quot;%s: &quot; fmt, __FILE__, ## args)
DECL|macro|ibmveth_error_printk
mdefine_line|#define ibmveth_error_printk(fmt, args...) &bslash;&n;  printk(KERN_ERR &quot;(%s:%3.3d ua:%x) ERROR: &quot; fmt, __FILE__, __LINE__ , adapter-&gt;vdev-&gt;unit_address, ## args)
macro_line|#ifdef DEBUG
DECL|macro|ibmveth_debug_printk_no_adapter
mdefine_line|#define ibmveth_debug_printk_no_adapter(fmt, args...) &bslash;&n;  printk(KERN_DEBUG &quot;(%s:%3.3d): &quot; fmt, __FILE__, __LINE__ , ## args)
DECL|macro|ibmveth_debug_printk
mdefine_line|#define ibmveth_debug_printk(fmt, args...) &bslash;&n;  printk(KERN_DEBUG &quot;(%s:%3.3d ua:%x): &quot; fmt, __FILE__, __LINE__ , adapter-&gt;vdev-&gt;unit_address, ## args)
DECL|macro|ibmveth_assert
mdefine_line|#define ibmveth_assert(expr) &bslash;&n;  if(!(expr)) {                                   &bslash;&n;    printk(KERN_DEBUG &quot;assertion failed (%s:%3.3d ua:%x): %s&bslash;n&quot;, __FILE__, __LINE__, adapter-&gt;vdev-&gt;unit_address, #expr); &bslash;&n;    BUG(); &bslash;&n;  }
macro_line|#else
DECL|macro|ibmveth_debug_printk_no_adapter
mdefine_line|#define ibmveth_debug_printk_no_adapter(fmt, args...)
DECL|macro|ibmveth_debug_printk
mdefine_line|#define ibmveth_debug_printk(fmt, args...)
DECL|macro|ibmveth_assert
mdefine_line|#define ibmveth_assert(expr) 
macro_line|#endif
r_static
r_int
id|ibmveth_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ibmveth_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ibmveth_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|ibmveth_poll
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
op_star
id|budget
)paren
suffix:semicolon
r_static
r_int
id|ibmveth_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ibmveth_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ibmveth_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ibmveth_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
suffix:semicolon
r_static
r_void
id|ibmveth_proc_register_driver
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ibmveth_proc_unregister_driver
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ibmveth_proc_register_adapter
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
suffix:semicolon
r_static
r_void
id|ibmveth_proc_unregister_adapter
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|ibmveth_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
DECL|macro|IBMVETH_PROC_DIR
mdefine_line|#define IBMVETH_PROC_DIR &quot;ibmveth&quot;
DECL|variable|ibmveth_proc_dir
r_static
r_struct
id|proc_dir_entry
op_star
id|ibmveth_proc_dir
suffix:semicolon
macro_line|#endif
DECL|variable|ibmveth_driver_name
r_static
r_const
r_char
id|ibmveth_driver_name
(braket
)braket
op_assign
l_string|&quot;ibmveth&quot;
suffix:semicolon
DECL|variable|ibmveth_driver_string
r_static
r_const
r_char
id|ibmveth_driver_string
(braket
)braket
op_assign
l_string|&quot;IBM i/pSeries Virtual Ethernet Driver&quot;
suffix:semicolon
DECL|macro|ibmveth_driver_version
mdefine_line|#define ibmveth_driver_version &quot;1.02&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Santiago Leon &lt;santil@us.ibm.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IBM i/pSeries Virtual Ethernet Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|ibmveth_driver_version
id|MODULE_VERSION
c_func
(paren
id|ibmveth_driver_version
)paren
suffix:semicolon
multiline_comment|/* simple methods of getting data from the current rxq entry */
DECL|function|ibmveth_rxq_pending_buffer
r_static
r_inline
r_int
id|ibmveth_rxq_pending_buffer
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_return
(paren
id|adapter-&gt;rx_queue.queue_addr
(braket
id|adapter-&gt;rx_queue.index
)braket
dot
id|toggle
op_eq
id|adapter-&gt;rx_queue.toggle
)paren
suffix:semicolon
)brace
DECL|function|ibmveth_rxq_buffer_valid
r_static
r_inline
r_int
id|ibmveth_rxq_buffer_valid
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_return
(paren
id|adapter-&gt;rx_queue.queue_addr
(braket
id|adapter-&gt;rx_queue.index
)braket
dot
id|valid
)paren
suffix:semicolon
)brace
DECL|function|ibmveth_rxq_frame_offset
r_static
r_inline
r_int
id|ibmveth_rxq_frame_offset
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_return
(paren
id|adapter-&gt;rx_queue.queue_addr
(braket
id|adapter-&gt;rx_queue.index
)braket
dot
id|offset
)paren
suffix:semicolon
)brace
DECL|function|ibmveth_rxq_frame_length
r_static
r_inline
r_int
id|ibmveth_rxq_frame_length
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_return
(paren
id|adapter-&gt;rx_queue.queue_addr
(braket
id|adapter-&gt;rx_queue.index
)braket
dot
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/* setup the initial settings for a buffer pool */
DECL|function|ibmveth_init_buffer_pool
r_static
r_void
id|ibmveth_init_buffer_pool
c_func
(paren
r_struct
id|ibmveth_buff_pool
op_star
id|pool
comma
id|u32
id|pool_index
comma
id|u32
id|pool_size
comma
id|u32
id|buff_size
)paren
(brace
id|pool-&gt;size
op_assign
id|pool_size
suffix:semicolon
id|pool-&gt;index
op_assign
id|pool_index
suffix:semicolon
id|pool-&gt;buff_size
op_assign
id|buff_size
suffix:semicolon
id|pool-&gt;threshold
op_assign
id|pool_size
op_div
l_int|2
suffix:semicolon
)brace
multiline_comment|/* allocate and setup an buffer pool - called during open */
DECL|function|ibmveth_alloc_buffer_pool
r_static
r_int
id|ibmveth_alloc_buffer_pool
c_func
(paren
r_struct
id|ibmveth_buff_pool
op_star
id|pool
)paren
(brace
r_int
id|i
suffix:semicolon
id|pool-&gt;free_map
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|u16
)paren
op_star
id|pool-&gt;size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pool-&gt;free_map
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pool-&gt;dma_addr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_star
id|pool-&gt;size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pool-&gt;dma_addr
)paren
(brace
id|kfree
c_func
(paren
id|pool-&gt;free_map
)paren
suffix:semicolon
id|pool-&gt;free_map
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pool-&gt;skbuff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|pool-&gt;size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pool-&gt;skbuff
)paren
(brace
id|kfree
c_func
(paren
id|pool-&gt;dma_addr
)paren
suffix:semicolon
id|pool-&gt;dma_addr
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|pool-&gt;free_map
)paren
suffix:semicolon
id|pool-&gt;free_map
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pool-&gt;skbuff
comma
l_int|0
comma
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|pool-&gt;size
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pool-&gt;dma_addr
comma
l_int|0
comma
r_sizeof
(paren
id|dma_addr_t
)paren
op_star
id|pool-&gt;size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pool-&gt;size
suffix:semicolon
op_increment
id|i
)paren
(brace
id|pool-&gt;free_map
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|pool-&gt;available
comma
l_int|0
)paren
suffix:semicolon
id|pool-&gt;producer_index
op_assign
l_int|0
suffix:semicolon
id|pool-&gt;consumer_index
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* replenish the buffers for a pool.  note that we don&squot;t need to&n; * skb_reserve these since they are used for incoming...&n; */
DECL|function|ibmveth_replenish_buffer_pool
r_static
r_void
id|ibmveth_replenish_buffer_pool
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
comma
r_struct
id|ibmveth_buff_pool
op_star
id|pool
)paren
(brace
id|u32
id|i
suffix:semicolon
id|u32
id|count
op_assign
id|pool-&gt;size
op_minus
id|atomic_read
c_func
(paren
op_amp
id|pool-&gt;available
)paren
suffix:semicolon
id|u32
id|buffers_added
op_assign
l_int|0
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|free_index
comma
id|index
suffix:semicolon
id|u64
id|correlator
suffix:semicolon
r_union
id|ibmveth_buf_desc
id|desc
suffix:semicolon
r_int
r_int
id|lpar_rc
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|pool-&gt;buff_size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;replenish: unable to allocate skb&bslash;n&quot;
)paren
suffix:semicolon
id|adapter-&gt;replenish_no_mem
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|free_index
op_assign
id|pool-&gt;consumer_index
op_increment
op_mod
id|pool-&gt;size
suffix:semicolon
id|index
op_assign
id|pool-&gt;free_map
(braket
id|free_index
)braket
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|index
op_ne
id|IBM_VETH_INVALID_MAP
)paren
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|pool-&gt;skbuff
(braket
id|index
)braket
op_eq
l_int|NULL
)paren
suffix:semicolon
id|dma_addr
op_assign
id|vio_map_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|skb-&gt;data
comma
id|pool-&gt;buff_size
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|pool-&gt;free_map
(braket
id|free_index
)braket
op_assign
id|IBM_VETH_INVALID_MAP
suffix:semicolon
id|pool-&gt;dma_addr
(braket
id|index
)braket
op_assign
id|dma_addr
suffix:semicolon
id|pool-&gt;skbuff
(braket
id|index
)braket
op_assign
id|skb
suffix:semicolon
id|correlator
op_assign
(paren
(paren
id|u64
)paren
id|pool-&gt;index
op_lshift
l_int|32
)paren
op_or
id|index
suffix:semicolon
op_star
(paren
id|u64
op_star
)paren
id|skb-&gt;data
op_assign
id|correlator
suffix:semicolon
id|desc.desc
op_assign
l_int|0
suffix:semicolon
id|desc.fields.valid
op_assign
l_int|1
suffix:semicolon
id|desc.fields.length
op_assign
id|pool-&gt;buff_size
suffix:semicolon
id|desc.fields.address
op_assign
id|dma_addr
suffix:semicolon
id|lpar_rc
op_assign
id|h_add_logical_lan_buffer
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|desc.desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
)paren
(brace
id|pool-&gt;free_map
(braket
id|free_index
)braket
op_assign
id|IBM_VETH_INVALID_MAP
suffix:semicolon
id|pool-&gt;skbuff
(braket
id|index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|pool-&gt;consumer_index
op_decrement
suffix:semicolon
id|vio_unmap_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|pool-&gt;dma_addr
(braket
id|index
)braket
comma
id|pool-&gt;buff_size
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|adapter-&gt;replenish_add_buff_failure
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|buffers_added
op_increment
suffix:semicolon
id|adapter-&gt;replenish_add_buff_success
op_increment
suffix:semicolon
)brace
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|atomic_add
c_func
(paren
id|buffers_added
comma
op_amp
(paren
id|pool-&gt;available
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* check if replenishing is needed.  */
DECL|function|ibmveth_is_replenishing_needed
r_static
r_inline
r_int
id|ibmveth_is_replenishing_needed
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_return
(paren
(paren
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|0
)braket
dot
id|available
)paren
OL
id|adapter-&gt;rx_buff_pool
(braket
l_int|0
)braket
dot
id|threshold
)paren
op_logical_or
(paren
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|1
)braket
dot
id|available
)paren
OL
id|adapter-&gt;rx_buff_pool
(braket
l_int|1
)braket
dot
id|threshold
)paren
op_logical_or
(paren
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|2
)braket
dot
id|available
)paren
OL
id|adapter-&gt;rx_buff_pool
(braket
l_int|2
)braket
dot
id|threshold
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* replenish tasklet routine */
DECL|function|ibmveth_replenish_task
r_static
r_void
id|ibmveth_replenish_task
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
id|adapter-&gt;replenish_task_cycles
op_increment
suffix:semicolon
id|ibmveth_replenish_buffer_pool
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ibmveth_replenish_buffer_pool
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ibmveth_replenish_buffer_pool
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|adapter-&gt;rx_no_buffer
op_assign
op_star
(paren
id|u64
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|adapter-&gt;buffer_list_addr
)paren
op_plus
l_int|4096
op_minus
l_int|8
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|adapter-&gt;not_replenishing
)paren
suffix:semicolon
)brace
multiline_comment|/* kick the replenish tasklet if we need replenishing and it isn&squot;t already running */
DECL|function|ibmveth_schedule_replenishing
r_static
r_inline
r_void
id|ibmveth_schedule_replenishing
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_if
c_cond
(paren
id|ibmveth_is_replenishing_needed
c_func
(paren
id|adapter
)paren
op_logical_and
(paren
id|atomic_dec_if_positive
c_func
(paren
op_amp
id|adapter-&gt;not_replenishing
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|schedule_work
c_func
(paren
op_amp
id|adapter-&gt;replenish_task
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* empty and free ana buffer pool - also used to do cleanup in error paths */
DECL|function|ibmveth_free_buffer_pool
r_static
r_void
id|ibmveth_free_buffer_pool
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
comma
r_struct
id|ibmveth_buff_pool
op_star
id|pool
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pool-&gt;free_map
)paren
(brace
id|kfree
c_func
(paren
id|pool-&gt;free_map
)paren
suffix:semicolon
id|pool-&gt;free_map
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pool-&gt;skbuff
op_logical_and
id|pool-&gt;dma_addr
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pool-&gt;size
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|pool-&gt;skbuff
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|vio_unmap_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|pool-&gt;dma_addr
(braket
id|i
)braket
comma
id|pool-&gt;buff_size
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|pool-&gt;skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|pool-&gt;dma_addr
)paren
(brace
id|kfree
c_func
(paren
id|pool-&gt;dma_addr
)paren
suffix:semicolon
id|pool-&gt;dma_addr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pool-&gt;skbuff
)paren
(brace
id|kfree
c_func
(paren
id|pool-&gt;skbuff
)paren
suffix:semicolon
id|pool-&gt;skbuff
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* remove a buffer from a pool */
DECL|function|ibmveth_remove_buffer_from_pool
r_static
r_void
id|ibmveth_remove_buffer_from_pool
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
comma
id|u64
id|correlator
)paren
(brace
r_int
r_int
id|pool
op_assign
id|correlator
op_rshift
l_int|32
suffix:semicolon
r_int
r_int
id|index
op_assign
id|correlator
op_amp
l_int|0xffffffffUL
suffix:semicolon
r_int
r_int
id|free_index
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|pool
OL
id|IbmVethNumBufferPools
)paren
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|index
OL
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|size
)paren
suffix:semicolon
id|skb
op_assign
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|skbuff
(braket
id|index
)braket
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|skb
op_ne
l_int|NULL
)paren
suffix:semicolon
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|skbuff
(braket
id|index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|vio_unmap_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|dma_addr
(braket
id|index
)braket
comma
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|buff_size
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|free_index
op_assign
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|producer_index
op_increment
op_mod
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|size
suffix:semicolon
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|free_map
(braket
id|free_index
)braket
op_assign
id|index
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
(paren
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|available
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* get the current buffer on the rx queue */
DECL|function|ibmveth_rxq_get_buffer
r_static
r_inline
r_struct
id|sk_buff
op_star
id|ibmveth_rxq_get_buffer
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
id|u64
id|correlator
op_assign
id|adapter-&gt;rx_queue.queue_addr
(braket
id|adapter-&gt;rx_queue.index
)braket
dot
id|correlator
suffix:semicolon
r_int
r_int
id|pool
op_assign
id|correlator
op_rshift
l_int|32
suffix:semicolon
r_int
r_int
id|index
op_assign
id|correlator
op_amp
l_int|0xffffffffUL
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|pool
OL
id|IbmVethNumBufferPools
)paren
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|index
OL
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|size
)paren
suffix:semicolon
r_return
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|skbuff
(braket
id|index
)braket
suffix:semicolon
)brace
multiline_comment|/* recycle the current buffer on the rx queue */
DECL|function|ibmveth_rxq_recycle_buffer
r_static
r_void
id|ibmveth_rxq_recycle_buffer
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
id|u32
id|q_index
op_assign
id|adapter-&gt;rx_queue.index
suffix:semicolon
id|u64
id|correlator
op_assign
id|adapter-&gt;rx_queue.queue_addr
(braket
id|q_index
)braket
dot
id|correlator
suffix:semicolon
r_int
r_int
id|pool
op_assign
id|correlator
op_rshift
l_int|32
suffix:semicolon
r_int
r_int
id|index
op_assign
id|correlator
op_amp
l_int|0xffffffffUL
suffix:semicolon
r_union
id|ibmveth_buf_desc
id|desc
suffix:semicolon
r_int
r_int
id|lpar_rc
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|pool
OL
id|IbmVethNumBufferPools
)paren
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|index
OL
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|size
)paren
suffix:semicolon
id|desc.desc
op_assign
l_int|0
suffix:semicolon
id|desc.fields.valid
op_assign
l_int|1
suffix:semicolon
id|desc.fields.length
op_assign
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|buff_size
suffix:semicolon
id|desc.fields.address
op_assign
id|adapter-&gt;rx_buff_pool
(braket
id|pool
)braket
dot
id|dma_addr
(braket
id|index
)braket
suffix:semicolon
id|lpar_rc
op_assign
id|h_add_logical_lan_buffer
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|desc.desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
)paren
(brace
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;h_add_logical_lan_buffer failed during recycle rc=%ld&quot;
comma
id|lpar_rc
)paren
suffix:semicolon
id|ibmveth_remove_buffer_from_pool
c_func
(paren
id|adapter
comma
id|adapter-&gt;rx_queue.queue_addr
(braket
id|adapter-&gt;rx_queue.index
)braket
dot
id|correlator
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|adapter-&gt;rx_queue.index
op_eq
id|adapter-&gt;rx_queue.num_slots
)paren
(brace
id|adapter-&gt;rx_queue.index
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;rx_queue.toggle
op_assign
op_logical_neg
id|adapter-&gt;rx_queue.toggle
suffix:semicolon
)brace
)brace
DECL|function|ibmveth_rxq_harvest_buffer
r_static
r_inline
r_void
id|ibmveth_rxq_harvest_buffer
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
id|ibmveth_remove_buffer_from_pool
c_func
(paren
id|adapter
comma
id|adapter-&gt;rx_queue.queue_addr
(braket
id|adapter-&gt;rx_queue.index
)braket
dot
id|correlator
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|adapter-&gt;rx_queue.index
op_eq
id|adapter-&gt;rx_queue.num_slots
)paren
(brace
id|adapter-&gt;rx_queue.index
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;rx_queue.toggle
op_assign
op_logical_neg
id|adapter-&gt;rx_queue.toggle
suffix:semicolon
)brace
)brace
DECL|function|ibmveth_cleanup
r_static
r_void
id|ibmveth_cleanup
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_if
c_cond
(paren
id|adapter-&gt;buffer_list_addr
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dma_mapping_error
c_func
(paren
id|adapter-&gt;buffer_list_dma
)paren
)paren
(brace
id|vio_unmap_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|adapter-&gt;buffer_list_dma
comma
l_int|4096
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|adapter-&gt;buffer_list_dma
op_assign
id|DMA_ERROR_CODE
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|adapter-&gt;buffer_list_addr
)paren
suffix:semicolon
id|adapter-&gt;buffer_list_addr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adapter-&gt;filter_list_addr
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dma_mapping_error
c_func
(paren
id|adapter-&gt;filter_list_dma
)paren
)paren
(brace
id|vio_unmap_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|adapter-&gt;filter_list_dma
comma
l_int|4096
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|adapter-&gt;filter_list_dma
op_assign
id|DMA_ERROR_CODE
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|adapter-&gt;filter_list_addr
)paren
suffix:semicolon
id|adapter-&gt;filter_list_addr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adapter-&gt;rx_queue.queue_addr
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dma_mapping_error
c_func
(paren
id|adapter-&gt;rx_queue.queue_dma
)paren
)paren
(brace
id|vio_unmap_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|adapter-&gt;rx_queue.queue_dma
comma
id|adapter-&gt;rx_queue.queue_len
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|adapter-&gt;rx_queue.queue_dma
op_assign
id|DMA_ERROR_CODE
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|adapter-&gt;rx_queue.queue_addr
)paren
suffix:semicolon
id|adapter-&gt;rx_queue.queue_addr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ibmveth_free_buffer_pool
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ibmveth_free_buffer_pool
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ibmveth_free_buffer_pool
c_func
(paren
id|adapter
comma
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
DECL|function|ibmveth_open
r_static
r_int
id|ibmveth_open
c_func
(paren
r_struct
id|net_device
op_star
id|netdev
)paren
(brace
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|netdev-&gt;priv
suffix:semicolon
id|u64
id|mac_address
op_assign
l_int|0
suffix:semicolon
r_int
id|rxq_entries
suffix:semicolon
r_int
r_int
id|lpar_rc
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_union
id|ibmveth_buf_desc
id|rxq_desc
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;open starting&bslash;n&quot;
)paren
suffix:semicolon
id|rxq_entries
op_assign
id|adapter-&gt;rx_buff_pool
(braket
l_int|0
)braket
dot
id|size
op_plus
id|adapter-&gt;rx_buff_pool
(braket
l_int|1
)braket
dot
id|size
op_plus
id|adapter-&gt;rx_buff_pool
(braket
l_int|2
)braket
dot
id|size
op_plus
l_int|1
suffix:semicolon
id|adapter-&gt;buffer_list_addr
op_assign
(paren
r_void
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
id|adapter-&gt;filter_list_addr
op_assign
(paren
r_void
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;buffer_list_addr
op_logical_or
op_logical_neg
id|adapter-&gt;filter_list_addr
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;unable to allocate filter or buffer list pages&bslash;n&quot;
)paren
suffix:semicolon
id|ibmveth_cleanup
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|adapter-&gt;rx_queue.queue_len
op_assign
r_sizeof
(paren
r_struct
id|ibmveth_rx_q_entry
)paren
op_star
id|rxq_entries
suffix:semicolon
id|adapter-&gt;rx_queue.queue_addr
op_assign
id|kmalloc
c_func
(paren
id|adapter-&gt;rx_queue.queue_len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;rx_queue.queue_addr
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;unable to allocate rx queue pages&bslash;n&quot;
)paren
suffix:semicolon
id|ibmveth_cleanup
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|adapter-&gt;buffer_list_dma
op_assign
id|vio_map_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|adapter-&gt;buffer_list_addr
comma
l_int|4096
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|adapter-&gt;filter_list_dma
op_assign
id|vio_map_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|adapter-&gt;filter_list_addr
comma
l_int|4096
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|adapter-&gt;rx_queue.queue_dma
op_assign
id|vio_map_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|adapter-&gt;rx_queue.queue_addr
comma
id|adapter-&gt;rx_queue.queue_len
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dma_mapping_error
c_func
(paren
id|adapter-&gt;buffer_list_dma
)paren
)paren
op_logical_or
(paren
id|dma_mapping_error
c_func
(paren
id|adapter-&gt;filter_list_dma
)paren
)paren
op_logical_or
(paren
id|dma_mapping_error
c_func
(paren
id|adapter-&gt;rx_queue.queue_dma
)paren
)paren
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;unable to map filter or buffer list pages&bslash;n&quot;
)paren
suffix:semicolon
id|ibmveth_cleanup
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|adapter-&gt;rx_queue.index
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;rx_queue.num_slots
op_assign
id|rxq_entries
suffix:semicolon
id|adapter-&gt;rx_queue.toggle
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ibmveth_alloc_buffer_pool
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|0
)braket
)paren
op_logical_or
id|ibmveth_alloc_buffer_pool
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|1
)braket
)paren
op_logical_or
id|ibmveth_alloc_buffer_pool
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|2
)braket
)paren
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;unable to allocate buffer pools&bslash;n&quot;
)paren
suffix:semicolon
id|ibmveth_cleanup
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|mac_address
comma
id|netdev-&gt;dev_addr
comma
id|netdev-&gt;addr_len
)paren
suffix:semicolon
id|mac_address
op_assign
id|mac_address
op_rshift
l_int|16
suffix:semicolon
id|rxq_desc.desc
op_assign
l_int|0
suffix:semicolon
id|rxq_desc.fields.valid
op_assign
l_int|1
suffix:semicolon
id|rxq_desc.fields.length
op_assign
id|adapter-&gt;rx_queue.queue_len
suffix:semicolon
id|rxq_desc.fields.address
op_assign
id|adapter-&gt;rx_queue.queue_dma
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;buffer list @ 0x%p&bslash;n&quot;
comma
id|adapter-&gt;buffer_list_addr
)paren
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;filter list @ 0x%p&bslash;n&quot;
comma
id|adapter-&gt;filter_list_addr
)paren
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;receive q   @ 0x%p&bslash;n&quot;
comma
id|adapter-&gt;rx_queue.queue_addr
)paren
suffix:semicolon
id|lpar_rc
op_assign
id|h_register_logical_lan
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|adapter-&gt;buffer_list_dma
comma
id|rxq_desc.desc
comma
id|adapter-&gt;filter_list_dma
comma
id|mac_address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;h_register_logical_lan failed with %ld&bslash;n&quot;
comma
id|lpar_rc
)paren
suffix:semicolon
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;buffer TCE:0x%x filter TCE:0x%x rxq desc:0x%lx MAC:0x%lx&bslash;n&quot;
comma
id|adapter-&gt;buffer_list_dma
comma
id|adapter-&gt;filter_list_dma
comma
id|rxq_desc.desc
comma
id|mac_address
)paren
suffix:semicolon
id|ibmveth_cleanup
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
op_minus
id|ENONET
suffix:semicolon
)brace
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;registering irq 0x%x&bslash;n&quot;
comma
id|netdev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|request_irq
c_func
(paren
id|netdev-&gt;irq
comma
op_amp
id|ibmveth_interrupt
comma
l_int|0
comma
id|netdev-&gt;name
comma
id|netdev
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;unable to request irq 0x%x, rc %d&bslash;n&quot;
comma
id|netdev-&gt;irq
comma
id|rc
)paren
suffix:semicolon
r_do
(brace
id|rc
op_assign
id|h_free_logical_lan
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|H_isLongBusy
c_func
(paren
id|rc
)paren
op_logical_or
(paren
id|rc
op_eq
id|H_Busy
)paren
)paren
suffix:semicolon
id|ibmveth_cleanup
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|netdev
)paren
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;scheduling initial replenish cycle&bslash;n&quot;
)paren
suffix:semicolon
id|ibmveth_schedule_replenishing
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;open complete&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmveth_close
r_static
r_int
id|ibmveth_close
c_func
(paren
r_struct
id|net_device
op_star
id|netdev
)paren
(brace
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|netdev-&gt;priv
suffix:semicolon
r_int
id|lpar_rc
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;close starting&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|netdev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|netdev-&gt;irq
comma
id|netdev
)paren
suffix:semicolon
id|cancel_delayed_work
c_func
(paren
op_amp
id|adapter-&gt;replenish_task
)paren
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
id|lpar_rc
op_assign
id|h_free_logical_lan
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|H_isLongBusy
c_func
(paren
id|lpar_rc
)paren
op_logical_or
(paren
id|lpar_rc
op_eq
id|H_Busy
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;h_free_logical_lan failed with %lx, continuing with close&bslash;n&quot;
comma
id|lpar_rc
)paren
suffix:semicolon
)brace
id|adapter-&gt;rx_no_buffer
op_assign
op_star
(paren
id|u64
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|adapter-&gt;buffer_list_addr
)paren
op_plus
l_int|4096
op_minus
l_int|8
)paren
suffix:semicolon
id|ibmveth_cleanup
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;close complete&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_get_settings
r_static
r_int
id|netdev_get_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
id|cmd-&gt;supported
op_assign
(paren
id|SUPPORTED_1000baseT_Full
op_or
id|SUPPORTED_Autoneg
op_or
id|SUPPORTED_FIBRE
)paren
suffix:semicolon
id|cmd-&gt;advertising
op_assign
(paren
id|ADVERTISED_1000baseT_Full
op_or
id|ADVERTISED_Autoneg
op_or
id|ADVERTISED_FIBRE
)paren
suffix:semicolon
id|cmd-&gt;speed
op_assign
id|SPEED_1000
suffix:semicolon
id|cmd-&gt;duplex
op_assign
id|DUPLEX_FULL
suffix:semicolon
id|cmd-&gt;port
op_assign
id|PORT_FIBRE
suffix:semicolon
id|cmd-&gt;phy_address
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;transceiver
op_assign
id|XCVR_INTERNAL
suffix:semicolon
id|cmd-&gt;autoneg
op_assign
id|AUTONEG_ENABLE
suffix:semicolon
id|cmd-&gt;maxtxpkt
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;maxrxpkt
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netdev_get_drvinfo
r_static
r_void
id|netdev_get_drvinfo
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
id|strncpy
c_func
(paren
id|info-&gt;driver
comma
id|ibmveth_driver_name
comma
r_sizeof
(paren
id|info-&gt;driver
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info-&gt;version
comma
id|ibmveth_driver_version
comma
r_sizeof
(paren
id|info-&gt;version
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|netdev_get_link
r_static
id|u32
id|netdev_get_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|netdev_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|netdev_ethtool_ops
op_assign
(brace
dot
id|get_drvinfo
op_assign
id|netdev_get_drvinfo
comma
dot
id|get_settings
op_assign
id|netdev_get_settings
comma
dot
id|get_link
op_assign
id|netdev_get_link
comma
dot
id|get_sg
op_assign
id|ethtool_op_get_sg
comma
dot
id|get_tx_csum
op_assign
id|ethtool_op_get_tx_csum
comma
)brace
suffix:semicolon
DECL|function|ibmveth_ioctl
r_static
r_int
id|ibmveth_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|macro|page_offset
mdefine_line|#define page_offset(v) ((unsigned long)(v) &amp; ((1 &lt;&lt; 12) - 1))
DECL|function|ibmveth_start_xmit
r_static
r_int
id|ibmveth_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|netdev
)paren
(brace
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|netdev-&gt;priv
suffix:semicolon
r_union
id|ibmveth_buf_desc
id|desc
(braket
id|IbmVethMaxSendFrags
)braket
suffix:semicolon
r_int
r_int
id|lpar_rc
suffix:semicolon
r_int
id|nfrags
op_assign
l_int|0
comma
id|curfrag
suffix:semicolon
r_int
r_int
id|correlator
suffix:semicolon
r_int
r_int
id|retry_count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
op_plus
l_int|1
)paren
OG
id|IbmVethMaxSendFrags
)paren
(brace
id|adapter-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|desc
comma
l_int|0
comma
r_sizeof
(paren
id|desc
)paren
)paren
suffix:semicolon
multiline_comment|/* nfrags = number of frags after the initial fragment */
id|nfrags
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
r_if
c_cond
(paren
id|nfrags
)paren
(brace
id|adapter-&gt;tx_multidesc_send
op_increment
suffix:semicolon
)brace
multiline_comment|/* map the initial fragment */
id|desc
(braket
l_int|0
)braket
dot
id|fields.length
op_assign
id|nfrags
ques
c_cond
id|skb-&gt;len
op_minus
id|skb-&gt;data_len
suffix:colon
id|skb-&gt;len
suffix:semicolon
id|desc
(braket
l_int|0
)braket
dot
id|fields.address
op_assign
id|vio_map_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|skb-&gt;data
comma
id|desc
(braket
l_int|0
)braket
dot
id|fields.length
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|desc
(braket
l_int|0
)braket
dot
id|fields.valid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dma_mapping_error
c_func
(paren
id|desc
(braket
l_int|0
)braket
dot
id|fields.address
)paren
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;tx: unable to map initial fragment&bslash;n&quot;
)paren
suffix:semicolon
id|adapter-&gt;tx_map_failed
op_increment
suffix:semicolon
id|adapter-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|curfrag
op_assign
id|nfrags
suffix:semicolon
multiline_comment|/* map fragments past the initial portion if there are any */
r_while
c_loop
(paren
id|curfrag
op_decrement
)paren
(brace
id|skb_frag_t
op_star
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|curfrag
)braket
suffix:semicolon
id|desc
(braket
id|curfrag
op_plus
l_int|1
)braket
dot
id|fields.address
op_assign
id|vio_map_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|page_address
c_func
(paren
id|frag-&gt;page
)paren
op_plus
id|frag-&gt;page_offset
comma
id|frag-&gt;size
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|desc
(braket
id|curfrag
op_plus
l_int|1
)braket
dot
id|fields.length
op_assign
id|frag-&gt;size
suffix:semicolon
id|desc
(braket
id|curfrag
op_plus
l_int|1
)braket
dot
id|fields.valid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dma_mapping_error
c_func
(paren
id|desc
(braket
id|curfrag
op_plus
l_int|1
)braket
dot
id|fields.address
)paren
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;tx: unable to map fragment %d&bslash;n&quot;
comma
id|curfrag
)paren
suffix:semicolon
id|adapter-&gt;tx_map_failed
op_increment
suffix:semicolon
id|adapter-&gt;stats.tx_dropped
op_increment
suffix:semicolon
multiline_comment|/* Free all the mappings we just created */
r_while
c_loop
(paren
id|curfrag
OL
id|nfrags
)paren
(brace
id|vio_unmap_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|desc
(braket
id|curfrag
op_plus
l_int|1
)braket
dot
id|fields.address
comma
id|desc
(braket
id|curfrag
op_plus
l_int|1
)braket
dot
id|fields.length
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|curfrag
op_increment
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* send the frame. Arbitrarily set retrycount to 1024 */
id|correlator
op_assign
l_int|0
suffix:semicolon
id|retry_count
op_assign
l_int|1024
suffix:semicolon
r_do
(brace
id|lpar_rc
op_assign
id|h_send_logical_lan
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|desc
(braket
l_int|0
)braket
dot
id|desc
comma
id|desc
(braket
l_int|1
)braket
dot
id|desc
comma
id|desc
(braket
l_int|2
)braket
dot
id|desc
comma
id|desc
(braket
l_int|3
)braket
dot
id|desc
comma
id|desc
(braket
l_int|4
)braket
dot
id|desc
comma
id|desc
(braket
l_int|5
)braket
dot
id|desc
comma
id|correlator
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|lpar_rc
op_eq
id|H_Busy
)paren
op_logical_and
(paren
id|retry_count
op_decrement
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
op_logical_and
id|lpar_rc
op_ne
id|H_Dropped
)paren
(brace
r_int
id|i
suffix:semicolon
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;tx: h_send_logical_lan failed with rc=%ld&bslash;n&quot;
comma
id|lpar_rc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;tx: desc[%i] valid=%d, len=%d, address=0x%d&bslash;n&quot;
comma
id|i
comma
id|desc
(braket
id|i
)braket
dot
id|fields.valid
comma
id|desc
(braket
id|i
)braket
dot
id|fields.length
comma
id|desc
(braket
id|i
)braket
dot
id|fields.address
)paren
suffix:semicolon
)brace
id|adapter-&gt;tx_send_failed
op_increment
suffix:semicolon
id|adapter-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|adapter-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|adapter-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
r_do
(brace
id|vio_unmap_single
c_func
(paren
id|adapter-&gt;vdev
comma
id|desc
(braket
id|nfrags
)braket
dot
id|fields.address
comma
id|desc
(braket
id|nfrags
)braket
dot
id|fields.length
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|nfrags
op_ge
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmveth_poll
r_static
r_int
id|ibmveth_poll
c_func
(paren
r_struct
id|net_device
op_star
id|netdev
comma
r_int
op_star
id|budget
)paren
(brace
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|netdev-&gt;priv
suffix:semicolon
r_int
id|max_frames_to_process
op_assign
id|netdev-&gt;quota
suffix:semicolon
r_int
id|frames_processed
op_assign
l_int|0
suffix:semicolon
r_int
id|more_work
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|lpar_rc
suffix:semicolon
id|restart_poll
suffix:colon
r_do
(brace
r_struct
id|net_device
op_star
id|netdev
op_assign
id|adapter-&gt;netdev
suffix:semicolon
r_if
c_cond
(paren
id|ibmveth_rxq_pending_buffer
c_func
(paren
id|adapter
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ibmveth_rxq_buffer_valid
c_func
(paren
id|adapter
)paren
)paren
(brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* suggested by larson1 */
id|adapter-&gt;rx_invalid_buffer
op_increment
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;recycling invalid buffer&bslash;n&quot;
)paren
suffix:semicolon
id|ibmveth_rxq_recycle_buffer
c_func
(paren
id|adapter
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|length
op_assign
id|ibmveth_rxq_frame_length
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_int
id|offset
op_assign
id|ibmveth_rxq_frame_offset
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|skb
op_assign
id|ibmveth_rxq_get_buffer
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|ibmveth_rxq_harvest_buffer
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|offset
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|netdev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|netdev
)paren
suffix:semicolon
id|netif_receive_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* send it up */
id|adapter-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|adapter-&gt;stats.rx_bytes
op_add_assign
id|length
suffix:semicolon
id|frames_processed
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|more_work
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|more_work
op_logical_and
(paren
id|frames_processed
OL
id|max_frames_to_process
)paren
)paren
(brace
suffix:semicolon
)brace
id|ibmveth_schedule_replenishing
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|more_work
)paren
(brace
multiline_comment|/* more work to do - return that we are not done yet */
id|netdev-&gt;quota
op_sub_assign
id|frames_processed
suffix:semicolon
op_star
id|budget
op_sub_assign
id|frames_processed
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* we think we are done - reenable interrupts, then check once more to make sure we are done */
id|lpar_rc
op_assign
id|h_vio_signal
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|VIO_IRQ_ENABLE
)paren
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|lpar_rc
op_eq
id|H_Success
)paren
suffix:semicolon
id|netif_rx_complete
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmveth_rxq_pending_buffer
c_func
(paren
id|adapter
)paren
op_logical_and
id|netif_rx_reschedule
c_func
(paren
id|netdev
comma
id|frames_processed
)paren
)paren
(brace
id|lpar_rc
op_assign
id|h_vio_signal
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|VIO_IRQ_DISABLE
)paren
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|lpar_rc
op_eq
id|H_Success
)paren
suffix:semicolon
id|more_work
op_assign
l_int|1
suffix:semicolon
r_goto
id|restart_poll
suffix:semicolon
)brace
id|netdev-&gt;quota
op_sub_assign
id|frames_processed
suffix:semicolon
op_star
id|budget
op_sub_assign
id|frames_processed
suffix:semicolon
multiline_comment|/* we really are done */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmveth_interrupt
r_static
id|irqreturn_t
id|ibmveth_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|netdev
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|netdev-&gt;priv
suffix:semicolon
r_int
r_int
id|lpar_rc
suffix:semicolon
r_if
c_cond
(paren
id|netif_rx_schedule_prep
c_func
(paren
id|netdev
)paren
)paren
(brace
id|lpar_rc
op_assign
id|h_vio_signal
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|VIO_IRQ_DISABLE
)paren
suffix:semicolon
id|ibmveth_assert
c_func
(paren
id|lpar_rc
op_eq
id|H_Success
)paren
suffix:semicolon
id|__netif_rx_schedule
c_func
(paren
id|netdev
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|ibmveth_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ibmveth_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|adapter-&gt;stats
suffix:semicolon
)brace
DECL|function|ibmveth_set_multicast_list
r_static
r_void
id|ibmveth_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|netdev
)paren
(brace
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|netdev-&gt;priv
suffix:semicolon
r_int
r_int
id|lpar_rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|netdev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_logical_or
(paren
id|netdev-&gt;mc_count
OG
id|adapter-&gt;mcastFilterSize
)paren
)paren
(brace
id|lpar_rc
op_assign
id|h_multicast_ctrl
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|IbmVethMcastEnableRecv
op_or
id|IbmVethMcastDisableFiltering
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;h_multicast_ctrl rc=%ld when entering promisc mode&bslash;n&quot;
comma
id|lpar_rc
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
op_assign
id|netdev-&gt;mc_list
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* clear the filter table &amp; disable filtering */
id|lpar_rc
op_assign
id|h_multicast_ctrl
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|IbmVethMcastEnableRecv
op_or
id|IbmVethMcastDisableFiltering
op_or
id|IbmVethMcastClearFilterTable
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;h_multicast_ctrl rc=%ld when attempting to clear filter table&bslash;n&quot;
comma
id|lpar_rc
)paren
suffix:semicolon
)brace
multiline_comment|/* add the addresses to the filter table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|netdev-&gt;mc_count
suffix:semicolon
op_increment
id|i
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
singleline_comment|// add the multicast address to the filter table
r_int
r_int
id|mcast_addr
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|mcast_addr
)paren
op_plus
l_int|2
comma
id|mclist-&gt;dmi_addr
comma
l_int|6
)paren
suffix:semicolon
id|lpar_rc
op_assign
id|h_multicast_ctrl
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|IbmVethMcastAddFilter
comma
id|mcast_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;h_multicast_ctrl rc=%ld when adding an entry to the filter table&bslash;n&quot;
comma
id|lpar_rc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* re-enable filtering */
id|lpar_rc
op_assign
id|h_multicast_ctrl
c_func
(paren
id|adapter-&gt;vdev-&gt;unit_address
comma
id|IbmVethMcastEnableFiltering
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpar_rc
op_ne
id|H_Success
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;h_multicast_ctrl rc=%ld when enabling filtering&bslash;n&quot;
comma
id|lpar_rc
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|ibmveth_change_mtu
r_static
r_int
id|ibmveth_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|68
)paren
op_logical_or
(paren
id|new_mtu
OG
(paren
l_int|1
op_lshift
l_int|20
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmveth_probe
r_static
r_int
id|__devinit
id|ibmveth_probe
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
comma
r_const
r_struct
id|vio_device_id
op_star
id|id
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|net_device
op_star
id|netdev
suffix:semicolon
r_struct
id|ibmveth_adapter
op_star
id|adapter
suffix:semicolon
r_int
r_char
op_star
id|mac_addr_p
suffix:semicolon
r_int
r_int
op_star
id|mcastFilterSize_p
suffix:semicolon
id|ibmveth_debug_printk_no_adapter
c_func
(paren
l_string|&quot;entering ibmveth_probe for UA 0x%x&bslash;n&quot;
comma
id|dev-&gt;unit_address
)paren
suffix:semicolon
id|mac_addr_p
op_assign
(paren
r_int
r_char
op_star
)paren
id|vio_get_attribute
c_func
(paren
id|dev
comma
id|VETH_MAC_ADDR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mac_addr_p
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;(%s:%3.3d) ERROR: Can&squot;t find VETH_MAC_ADDR &quot;
l_string|&quot;attribute&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mcastFilterSize_p
op_assign
(paren
r_int
r_int
op_star
)paren
id|vio_get_attribute
c_func
(paren
id|dev
comma
id|VETH_MCAST_FILTER_SIZE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mcastFilterSize_p
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;(%s:%3.3d) ERROR: Can&squot;t find &quot;
l_string|&quot;VETH_MCAST_FILTER_SIZE attribute&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|netdev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|ibmveth_adapter
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netdev
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|netdev
)paren
suffix:semicolon
id|adapter
op_assign
id|netdev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|adapter
comma
l_int|0
comma
r_sizeof
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|dev-&gt;dev.driver_data
op_assign
id|netdev
suffix:semicolon
id|adapter-&gt;vdev
op_assign
id|dev
suffix:semicolon
id|adapter-&gt;netdev
op_assign
id|netdev
suffix:semicolon
id|adapter-&gt;mcastFilterSize
op_assign
op_star
id|mcastFilterSize_p
suffix:semicolon
multiline_comment|/* &t;Some older boxes running PHYP non-natively have an OF that&n;&t;&t;returns a 8-byte local-mac-address field (and the first &n;&t;&t;2 bytes have to be ignored) while newer boxes&squot; OF return&n;&t;&t;a 6-byte field. Note that IEEE 1275 specifies that &n;&t;&t;local-mac-address must be a 6-byte field.&n;&t;&t;The RPA doc specifies that the first byte must be 10b, so &n;&t;&t;we&squot;ll just look for it to solve this 8 vs. 6 byte field issue */
r_if
c_cond
(paren
(paren
op_star
id|mac_addr_p
op_amp
l_int|0x3
)paren
op_ne
l_int|0x02
)paren
id|mac_addr_p
op_add_assign
l_int|2
suffix:semicolon
id|adapter-&gt;mac_addr
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|adapter-&gt;mac_addr
comma
id|mac_addr_p
comma
l_int|6
)paren
suffix:semicolon
id|adapter-&gt;liobn
op_assign
id|dev-&gt;iommu_table-&gt;it_index
suffix:semicolon
id|netdev-&gt;irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|netdev-&gt;open
op_assign
id|ibmveth_open
suffix:semicolon
id|netdev-&gt;poll
op_assign
id|ibmveth_poll
suffix:semicolon
id|netdev-&gt;weight
op_assign
l_int|16
suffix:semicolon
id|netdev-&gt;stop
op_assign
id|ibmveth_close
suffix:semicolon
id|netdev-&gt;hard_start_xmit
op_assign
id|ibmveth_start_xmit
suffix:semicolon
id|netdev-&gt;get_stats
op_assign
id|ibmveth_get_stats
suffix:semicolon
id|netdev-&gt;set_multicast_list
op_assign
id|ibmveth_set_multicast_list
suffix:semicolon
id|netdev-&gt;do_ioctl
op_assign
id|ibmveth_ioctl
suffix:semicolon
id|netdev-&gt;ethtool_ops
op_assign
op_amp
id|netdev_ethtool_ops
suffix:semicolon
id|netdev-&gt;change_mtu
op_assign
id|ibmveth_change_mtu
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|netdev
comma
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|netdev-&gt;dev_addr
comma
op_amp
id|adapter-&gt;mac_addr
comma
id|netdev-&gt;addr_len
)paren
suffix:semicolon
id|ibmveth_init_buffer_pool
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|0
)braket
comma
l_int|0
comma
id|IbmVethPool0DftCnt
comma
id|IbmVethPool0DftSize
)paren
suffix:semicolon
id|ibmveth_init_buffer_pool
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|1
)braket
comma
l_int|1
comma
id|IbmVethPool1DftCnt
comma
id|IbmVethPool1DftSize
)paren
suffix:semicolon
id|ibmveth_init_buffer_pool
c_func
(paren
op_amp
id|adapter-&gt;rx_buff_pool
(braket
l_int|2
)braket
comma
l_int|2
comma
id|IbmVethPool2DftCnt
comma
id|IbmVethPool2DftSize
)paren
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;adapter @ 0x%p&bslash;n&quot;
comma
id|adapter
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|adapter-&gt;replenish_task
comma
(paren
r_void
op_star
)paren
id|ibmveth_replenish_task
comma
(paren
r_void
op_star
)paren
id|adapter
)paren
suffix:semicolon
id|adapter-&gt;buffer_list_dma
op_assign
id|DMA_ERROR_CODE
suffix:semicolon
id|adapter-&gt;filter_list_dma
op_assign
id|DMA_ERROR_CODE
suffix:semicolon
id|adapter-&gt;rx_queue.queue_dma
op_assign
id|DMA_ERROR_CODE
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;not_replenishing
comma
l_int|1
)paren
suffix:semicolon
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;registering netdev...&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|register_netdev
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;failed to register netdev rc=%d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|ibmveth_debug_printk
c_func
(paren
l_string|&quot;registered&bslash;n&quot;
)paren
suffix:semicolon
id|ibmveth_proc_register_adapter
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmveth_remove
r_static
r_int
id|__devexit
id|ibmveth_remove
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
)paren
(brace
r_struct
id|net_device
op_star
id|netdev
op_assign
id|dev-&gt;dev.driver_data
suffix:semicolon
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|netdev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|netdev
)paren
suffix:semicolon
id|ibmveth_proc_unregister_adapter
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|ibmveth_proc_register_driver
r_static
r_void
id|ibmveth_proc_register_driver
c_func
(paren
r_void
)paren
(brace
id|ibmveth_proc_dir
op_assign
id|create_proc_entry
c_func
(paren
id|IBMVETH_PROC_DIR
comma
id|S_IFDIR
comma
id|proc_net
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmveth_proc_dir
)paren
(brace
id|SET_MODULE_OWNER
c_func
(paren
id|ibmveth_proc_dir
)paren
suffix:semicolon
)brace
)brace
DECL|function|ibmveth_proc_unregister_driver
r_static
r_void
id|ibmveth_proc_unregister_driver
c_func
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|IBMVETH_PROC_DIR
comma
id|proc_net
)paren
suffix:semicolon
)brace
DECL|function|ibmveth_seq_start
r_static
r_void
op_star
id|ibmveth_seq_start
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_if
c_cond
(paren
op_star
id|pos
op_eq
l_int|0
)paren
(brace
r_return
(paren
r_void
op_star
)paren
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|ibmveth_seq_next
r_static
r_void
op_star
id|ibmveth_seq_next
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
(brace
op_increment
op_star
id|pos
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ibmveth_seq_stop
r_static
r_void
id|ibmveth_seq_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
)brace
DECL|function|ibmveth_seq_show
r_static
r_int
id|ibmveth_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
r_struct
id|ibmveth_adapter
op_star
id|adapter
op_assign
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
r_char
op_star
id|current_mac
op_assign
(paren
(paren
r_char
op_star
)paren
op_amp
id|adapter-&gt;netdev-&gt;dev_addr
)paren
suffix:semicolon
r_char
op_star
id|firmware_mac
op_assign
(paren
(paren
r_char
op_star
)paren
op_amp
id|adapter-&gt;mac_addr
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;%s %s&bslash;n&bslash;n&quot;
comma
id|ibmveth_driver_string
comma
id|ibmveth_driver_version
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;Unit Address:    0x%x&bslash;n&quot;
comma
id|adapter-&gt;vdev-&gt;unit_address
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;LIOBN:           0x%lx&bslash;n&quot;
comma
id|adapter-&gt;liobn
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;Current MAC:     %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|current_mac
(braket
l_int|0
)braket
comma
id|current_mac
(braket
l_int|1
)braket
comma
id|current_mac
(braket
l_int|2
)braket
comma
id|current_mac
(braket
l_int|3
)braket
comma
id|current_mac
(braket
l_int|4
)braket
comma
id|current_mac
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;Firmware MAC:    %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|firmware_mac
(braket
l_int|0
)braket
comma
id|firmware_mac
(braket
l_int|1
)braket
comma
id|firmware_mac
(braket
l_int|2
)braket
comma
id|firmware_mac
(braket
l_int|3
)braket
comma
id|firmware_mac
(braket
l_int|4
)braket
comma
id|firmware_mac
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;&bslash;nAdapter Statistics:&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;  TX:  skbuffs linearized:          %ld&bslash;n&quot;
comma
id|adapter-&gt;tx_linearized
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;       multi-descriptor sends:      %ld&bslash;n&quot;
comma
id|adapter-&gt;tx_multidesc_send
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;       skb_linearize failures:      %ld&bslash;n&quot;
comma
id|adapter-&gt;tx_linearize_failed
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;       vio_map_single failres:      %ld&bslash;n&quot;
comma
id|adapter-&gt;tx_map_failed
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;       send failures:               %ld&bslash;n&quot;
comma
id|adapter-&gt;tx_send_failed
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;  RX:  replenish task cycles:       %ld&bslash;n&quot;
comma
id|adapter-&gt;replenish_task_cycles
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;       alloc_skb_failures:          %ld&bslash;n&quot;
comma
id|adapter-&gt;replenish_no_mem
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;       add buffer failures:         %ld&bslash;n&quot;
comma
id|adapter-&gt;replenish_add_buff_failure
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;       invalid buffers:             %ld&bslash;n&quot;
comma
id|adapter-&gt;rx_invalid_buffer
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;       no buffers:                  %ld&bslash;n&quot;
comma
id|adapter-&gt;rx_no_buffer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ibmveth_seq_ops
r_static
r_struct
id|seq_operations
id|ibmveth_seq_ops
op_assign
(brace
dot
id|start
op_assign
id|ibmveth_seq_start
comma
dot
id|next
op_assign
id|ibmveth_seq_next
comma
dot
id|stop
op_assign
id|ibmveth_seq_stop
comma
dot
id|show
op_assign
id|ibmveth_seq_show
comma
)brace
suffix:semicolon
DECL|function|ibmveth_proc_open
r_static
r_int
id|ibmveth_proc_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|seq_file
op_star
id|seq
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|proc
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|ibmveth_seq_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
multiline_comment|/* recover the pointer buried in proc_dir_entry data */
id|seq
op_assign
id|file-&gt;private_data
suffix:semicolon
id|proc
op_assign
id|PDE
c_func
(paren
id|inode
)paren
suffix:semicolon
id|seq
op_member_access_from_pointer
r_private
op_assign
id|proc-&gt;data
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|ibmveth_proc_fops
r_static
r_struct
id|file_operations
id|ibmveth_proc_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|ibmveth_proc_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
DECL|function|ibmveth_proc_register_adapter
r_static
r_void
id|ibmveth_proc_register_adapter
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|ibmveth_proc_dir
)paren
(brace
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|adapter-&gt;netdev-&gt;name
comma
id|S_IFREG
comma
id|ibmveth_proc_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
(brace
id|ibmveth_error_printk
c_func
(paren
l_string|&quot;Cannot create adapter proc entry&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|entry-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|adapter
suffix:semicolon
id|entry-&gt;proc_fops
op_assign
op_amp
id|ibmveth_proc_fops
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|function|ibmveth_proc_unregister_adapter
r_static
r_void
id|ibmveth_proc_unregister_adapter
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
r_if
c_cond
(paren
id|ibmveth_proc_dir
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|adapter-&gt;netdev-&gt;name
comma
id|ibmveth_proc_dir
)paren
suffix:semicolon
)brace
)brace
macro_line|#else /* CONFIG_PROC_FS */
DECL|function|ibmveth_proc_register_adapter
r_static
r_void
id|ibmveth_proc_register_adapter
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
)brace
DECL|function|ibmveth_proc_unregister_adapter
r_static
r_void
id|ibmveth_proc_unregister_adapter
c_func
(paren
r_struct
id|ibmveth_adapter
op_star
id|adapter
)paren
(brace
)brace
DECL|function|ibmveth_proc_register_driver
r_static
r_void
id|ibmveth_proc_register_driver
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|ibmveth_proc_unregister_driver
r_static
r_void
id|ibmveth_proc_unregister_driver
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif /* CONFIG_PROC_FS */
DECL|variable|__devinitdata
r_static
r_struct
id|vio_device_id
id|ibmveth_device_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;network&quot;
comma
l_string|&quot;IBM,l-lan&quot;
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|vio
comma
id|ibmveth_device_table
)paren
suffix:semicolon
DECL|variable|ibmveth_driver
r_static
r_struct
id|vio_driver
id|ibmveth_driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
id|ibmveth_driver_name
comma
dot
id|id_table
op_assign
id|ibmveth_device_table
comma
dot
id|probe
op_assign
id|ibmveth_probe
comma
dot
id|remove
op_assign
id|ibmveth_remove
)brace
suffix:semicolon
DECL|function|ibmveth_module_init
r_static
r_int
id|__init
id|ibmveth_module_init
c_func
(paren
r_void
)paren
(brace
id|ibmveth_printk
c_func
(paren
l_string|&quot;%s: %s %s&bslash;n&quot;
comma
id|ibmveth_driver_name
comma
id|ibmveth_driver_string
comma
id|ibmveth_driver_version
)paren
suffix:semicolon
id|ibmveth_proc_register_driver
c_func
(paren
)paren
suffix:semicolon
r_return
id|vio_register_driver
c_func
(paren
op_amp
id|ibmveth_driver
)paren
suffix:semicolon
)brace
DECL|function|ibmveth_module_exit
r_static
r_void
id|__exit
id|ibmveth_module_exit
c_func
(paren
r_void
)paren
(brace
id|vio_unregister_driver
c_func
(paren
op_amp
id|ibmveth_driver
)paren
suffix:semicolon
id|ibmveth_proc_unregister_driver
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|ibmveth_module_init
id|module_init
c_func
(paren
id|ibmveth_module_init
)paren
suffix:semicolon
DECL|variable|ibmveth_module_exit
id|module_exit
c_func
(paren
id|ibmveth_module_exit
)paren
suffix:semicolon
eof
