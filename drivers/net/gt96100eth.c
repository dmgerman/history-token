multiline_comment|/*&n; * Copyright 2000 MontaVista Software Inc.&n; * Author: MontaVista Software, Inc.&n; *         &t;stevel@mvista.com or support@mvista.com&n; *&n; * ########################################################################&n; *&n; *  This program is free software; you can distribute it and/or modify it&n; *  under the terms of the GNU General Public License (Version 2) as&n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; *  for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * ########################################################################&n; *&n; * Ethernet driver for the MIPS GT96100 Advanced Communication Controller.&n; * &n; */
macro_line|#ifndef __mips__
macro_line|#error This driver only works with MIPS architectures!
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;gt96100eth.h&quot;
macro_line|#ifdef GT96100_DEBUG
DECL|variable|gt96100_debug
r_static
r_int
id|gt96100_debug
op_assign
id|GT96100_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|gt96100_debug
r_static
r_int
id|gt96100_debug
op_assign
l_int|3
suffix:semicolon
macro_line|#endif
singleline_comment|// prototypes
r_static
r_void
op_star
id|dmaalloc
c_func
(paren
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
suffix:semicolon
r_static
r_void
id|dmafree
c_func
(paren
r_int
id|size
comma
r_void
op_star
id|vaddr
)paren
suffix:semicolon
r_static
r_int
id|gt96100_add_hash_entry
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|read_mib_counters
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
suffix:semicolon
r_static
r_int
id|read_MII
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|reg
)paren
suffix:semicolon
r_static
r_int
id|write_MII
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|reg
comma
id|u16
id|data
)paren
suffix:semicolon
r_static
r_void
id|dump_MII
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|update_stats
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
suffix:semicolon
r_static
r_void
m_abort
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|abort_bits
)paren
suffix:semicolon
r_static
r_void
id|hard_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|enable_ether_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|disable_ether_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|__init
id|gt96100_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|port_num
)paren
suffix:semicolon
r_static
r_int
id|gt96100_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
)paren
suffix:semicolon
r_static
r_void
id|gt96100_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|gt96100_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|gt96100_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|gt96100_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;gt96100eth.c:0.1 stevel@mvista.com&bslash;n&quot;
suffix:semicolon
singleline_comment|// FIX! Need real Ethernet addresses
DECL|variable|__devinitdata
r_static
r_int
r_char
id|gt96100_station_addr
(braket
l_int|2
)braket
(braket
l_int|6
)braket
id|__devinitdata
op_assign
(brace
(brace
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x05
comma
l_int|0x06
)brace
comma
(brace
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x05
comma
l_int|0x07
)brace
)brace
suffix:semicolon
DECL|macro|nibswap
mdefine_line|#define nibswap(x) ((((x) &gt;&gt; 4) &amp; 0x0f) | (((x) &lt;&lt; 4) &amp; 0xf0))
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
singleline_comment|// For reading/writing 32-bit words from/to DMA memory
DECL|macro|cpu_to_dma32
mdefine_line|#define cpu_to_dma32 cpu_to_be32
DECL|macro|dma32_to_cpu
mdefine_line|#define dma32_to_cpu be32_to_cpu
multiline_comment|/*&n; * Base address and interupt of the GT96100 ethernet controllers&n; */
r_static
r_struct
(brace
DECL|member|port
r_int
r_int
id|port
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|variable|gt96100_iflist
)brace
id|gt96100_iflist
(braket
id|NUM_INTERFACES
)braket
op_assign
(brace
(brace
id|GT96100_ETH0_BASE
comma
id|GT96100_ETHER0_IRQ
)brace
comma
(brace
id|GT96100_ETH1_BASE
comma
id|GT96100_ETHER1_IRQ
)brace
)brace
suffix:semicolon
multiline_comment|/*&n;  DMA memory allocation, derived from pci_alloc_consistent.&n;*/
DECL|function|dmaalloc
r_static
r_void
op_star
id|dmaalloc
c_func
(paren
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
id|ret
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
op_or
id|GFP_DMA
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
(brace
id|dma_cache_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|ret
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_handle
op_ne
l_int|NULL
)paren
op_star
id|dma_handle
op_assign
id|virt_to_phys
c_func
(paren
id|ret
)paren
suffix:semicolon
multiline_comment|/* bump virtual address up to non-cached area */
id|ret
op_assign
id|KSEG1ADDR
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dmafree
r_static
r_void
id|dmafree
c_func
(paren
r_int
id|size
comma
r_void
op_star
id|vaddr
)paren
(brace
id|vaddr
op_assign
id|KSEG0ADDR
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|vaddr
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
)brace
DECL|function|read_MII
r_static
r_int
id|read_MII
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|reg
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|timedout
op_assign
l_int|20
suffix:semicolon
id|u32
id|smir
op_assign
id|smirOpCode
op_or
(paren
id|gp-&gt;phy_addr
op_lshift
id|smirPhyAdBit
)paren
op_or
(paren
id|reg
op_lshift
id|smirRegAdBit
)paren
suffix:semicolon
singleline_comment|// wait for last operation to complete
r_while
c_loop
(paren
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_SMI_REG
)paren
op_amp
id|smirBusy
)paren
(brace
singleline_comment|// snooze for 1 msec and check again
macro_line|#if 0
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
op_star
id|HZ
op_div
l_int|10000
)paren
suffix:semicolon
macro_line|#else
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: read_MII busy timeout!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|GT96100_WRITE
c_func
(paren
id|GT96100_ETH_SMI_REG
comma
id|smir
)paren
suffix:semicolon
id|timedout
op_assign
l_int|20
suffix:semicolon
singleline_comment|// wait for read to complete
r_while
c_loop
(paren
op_logical_neg
(paren
id|smir
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_SMI_REG
)paren
op_amp
id|smirReadValid
)paren
)paren
(brace
singleline_comment|// snooze for 1 msec and check again
macro_line|#if 0
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
op_star
id|HZ
op_div
l_int|10000
)paren
suffix:semicolon
macro_line|#else
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: read_MII timeout!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
(paren
r_int
)paren
(paren
id|smir
op_amp
id|smirDataMask
)paren
suffix:semicolon
)brace
DECL|function|write_MII
r_static
r_int
id|write_MII
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|reg
comma
id|u16
id|data
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|timedout
op_assign
l_int|20
suffix:semicolon
id|u32
id|smir
op_assign
(paren
id|gp-&gt;phy_addr
op_lshift
id|smirPhyAdBit
)paren
op_or
(paren
id|reg
op_lshift
id|smirRegAdBit
)paren
op_or
id|data
suffix:semicolon
singleline_comment|// wait for last operation to complete
r_while
c_loop
(paren
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_SMI_REG
)paren
op_amp
id|smirBusy
)paren
(brace
singleline_comment|// snooze for 1 msec and check again
macro_line|#if 0
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
op_star
id|HZ
op_div
l_int|10000
)paren
suffix:semicolon
macro_line|#else
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: write_MII busy timeout!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|GT96100_WRITE
c_func
(paren
id|GT96100_ETH_SMI_REG
comma
id|smir
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dump_MII
r_static
r_void
id|dump_MII
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|val
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|read_MII
c_func
(paren
id|dev
comma
id|i
)paren
)paren
op_ge
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: MII Reg %d=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|val
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|21
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|read_MII
c_func
(paren
id|dev
comma
id|i
)paren
)paren
op_ge
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: MII Reg %d=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|val
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|gt96100_add_hash_entry
id|gt96100_add_hash_entry
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|addr
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|hashResult
comma
id|stmp
suffix:semicolon
r_int
r_char
id|ctmp
comma
id|hash_ea
(braket
l_int|6
)braket
suffix:semicolon
id|u32
id|tblEntry
comma
op_star
id|tblEntryAddr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|// nibble swap
id|ctmp
op_assign
id|nibswap
c_func
(paren
id|addr
(braket
id|i
)braket
)paren
suffix:semicolon
singleline_comment|// invert every nibble
id|hash_ea
(braket
id|i
)braket
op_assign
(paren
(paren
id|ctmp
op_amp
l_int|1
)paren
op_lshift
l_int|3
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|8
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|2
)paren
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|4
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|hash_ea
(braket
id|i
)braket
op_or_assign
(paren
(paren
id|ctmp
op_amp
l_int|0x10
)paren
op_lshift
l_int|3
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|0x80
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|0x20
)paren
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|0x40
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gp-&gt;hash_mode
op_eq
l_int|0
)paren
(brace
id|hashResult
op_assign
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|0
)braket
op_amp
l_int|0xfc
)paren
op_lshift
l_int|7
suffix:semicolon
id|stmp
op_assign
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|0
)braket
op_amp
l_int|0x03
)paren
op_or
(paren
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|1
)braket
op_amp
l_int|0x7f
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|stmp
op_xor_assign
(paren
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|1
)braket
op_rshift
l_int|7
)paren
op_amp
l_int|0x01
)paren
op_or
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|2
)braket
op_lshift
l_int|1
)paren
suffix:semicolon
id|stmp
op_xor_assign
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|3
)braket
op_or
(paren
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|4
)braket
op_amp
l_int|1
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|hashResult
op_or_assign
id|stmp
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// don&squot;t support hash mode 1
)brace
id|tblEntryAddr
op_assign
(paren
id|u32
op_star
)paren
(paren
op_amp
id|gp-&gt;hash_table
(braket
(paren
(paren
id|u32
)paren
id|hashResult
op_amp
l_int|0x7ff
)paren
op_lshift
l_int|3
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HASH_HOP_NUMBER
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|tblEntryAddr
op_amp
id|hteValid
)paren
op_logical_and
op_logical_neg
(paren
op_star
id|tblEntryAddr
op_amp
id|hteSkip
)paren
)paren
(brace
singleline_comment|// This entry is already occupied, go to next entry
id|tblEntryAddr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|tblEntryAddr
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
id|tblEntry
op_assign
id|hteValid
op_or
id|hteRD
suffix:semicolon
id|tblEntry
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|5
)braket
op_lshift
l_int|3
suffix:semicolon
id|tblEntry
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|4
)braket
op_lshift
l_int|11
suffix:semicolon
id|tblEntry
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|3
)braket
op_lshift
l_int|19
suffix:semicolon
id|tblEntry
op_or_assign
(paren
(paren
id|u32
)paren
id|addr
(braket
l_int|2
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|27
suffix:semicolon
op_star
(paren
id|tblEntryAddr
op_plus
l_int|1
)paren
op_assign
id|cpu_to_dma32
c_func
(paren
id|tblEntry
)paren
suffix:semicolon
id|tblEntry
op_assign
(paren
(paren
id|u32
)paren
id|addr
(braket
l_int|2
)braket
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
suffix:semicolon
id|tblEntry
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|1
)braket
op_lshift
l_int|3
suffix:semicolon
id|tblEntry
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|0
)braket
op_lshift
l_int|11
suffix:semicolon
op_star
id|tblEntryAddr
op_assign
id|cpu_to_dma32
c_func
(paren
id|tblEntry
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_ge
id|HASH_HOP_NUMBER
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: gt96100_add_hash_entry expired!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// Couldn&squot;t find an unused entry
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|read_mib_counters
r_static
r_void
id|read_mib_counters
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
(brace
id|u32
op_star
id|mib_regs
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|gp-&gt;mib
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|mib_counters_t
)paren
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|i
op_increment
)paren
id|mib_regs
(braket
id|i
)braket
op_assign
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_MIB_COUNT_BASE
op_plus
id|i
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
DECL|function|update_stats
r_static
r_void
id|update_stats
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
(brace
id|mib_counters_t
op_star
id|mib
op_assign
op_amp
id|gp-&gt;mib
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|gp-&gt;stats
suffix:semicolon
id|read_mib_counters
c_func
(paren
id|gp
)paren
suffix:semicolon
id|stats-&gt;rx_packets
op_assign
id|mib-&gt;totalFramesReceived
suffix:semicolon
id|stats-&gt;tx_packets
op_assign
id|mib-&gt;framesSent
suffix:semicolon
id|stats-&gt;rx_bytes
op_assign
id|mib-&gt;totalByteReceived
suffix:semicolon
id|stats-&gt;tx_bytes
op_assign
id|mib-&gt;byteSent
suffix:semicolon
id|stats-&gt;rx_errors
op_assign
id|mib-&gt;totalFramesReceived
op_minus
id|mib-&gt;framesReceived
suffix:semicolon
singleline_comment|//the tx error counters are incremented by the ISR
singleline_comment|//rx_dropped incremented by gt96100_rx
singleline_comment|//tx_dropped incremented by gt96100_tx
id|stats-&gt;multicast
op_assign
id|mib-&gt;multicastFramesReceived
suffix:semicolon
singleline_comment|// Tx collisions incremented by ISR, so add in MIB Rx collisions
id|stats-&gt;collisions
op_add_assign
id|mib-&gt;collision
op_plus
id|mib-&gt;lateCollision
suffix:semicolon
id|stats-&gt;rx_length_errors
op_assign
id|mib-&gt;oversizeFrames
op_plus
id|mib-&gt;fragments
suffix:semicolon
singleline_comment|// The RxError condition means the Rx DMA encountered a
singleline_comment|// CPU owned descriptor, which, if things are working as
singleline_comment|// they should, means the Rx ring has overflowed.
id|stats-&gt;rx_over_errors
op_assign
id|mib-&gt;macRxError
suffix:semicolon
id|stats-&gt;rx_crc_errors
op_assign
id|mib-&gt;cRCError
suffix:semicolon
)brace
DECL|function|abort
r_static
r_void
m_abort
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|abort_bits
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|timedout
op_assign
l_int|100
suffix:semicolon
singleline_comment|// wait up to 100 msec for hard stop to complete
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: abort&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
singleline_comment|// Return if neither Rx or Tx abort bits are set
r_if
c_cond
(paren
op_logical_neg
(paren
id|abort_bits
op_amp
(paren
id|sdcmrAR
op_or
id|sdcmrAT
)paren
)paren
)paren
r_return
suffix:semicolon
singleline_comment|// make sure only the Rx/Tx abort bits are set
id|abort_bits
op_and_assign
(paren
id|sdcmrAR
op_or
id|sdcmrAT
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
singleline_comment|// abort any Rx/Tx DMA immediately
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|abort_bits
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: abort: SDMA comm = %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
)paren
)paren
suffix:semicolon
singleline_comment|// wait for abort to complete
r_while
c_loop
(paren
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
)paren
op_amp
id|abort_bits
)paren
(brace
singleline_comment|// snooze for 20 msec and check again
macro_line|#if 0
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
op_star
id|HZ
op_div
l_int|10000
)paren
suffix:semicolon
macro_line|#else
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: abort timeout!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: abort: timedout=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|timedout
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|hard_stop
r_static
r_void
id|hard_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: hard stop&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|disable_ether_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
m_abort
(paren
id|dev
comma
id|sdcmrAR
op_or
id|sdcmrAT
)paren
suffix:semicolon
singleline_comment|// disable port
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|enable_ether_irq
r_static
r_void
id|enable_ether_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|intMask
suffix:semicolon
singleline_comment|// unmask interrupts
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_MASK
comma
id|icrRxBuffer
op_or
id|icrTxBufferLow
op_or
id|icrTxEndLow
op_or
id|icrRxError
op_or
id|icrTxErrorLow
op_or
id|icrRxOVR
op_or
id|icrTxUdr
op_or
id|icrRxBufferQ0
op_or
id|icrRxErrorQ0
op_or
id|icrMIIPhySTC
)paren
suffix:semicolon
singleline_comment|// now route ethernet interrupts to GT Int0 (eth0 and eth1 will be
singleline_comment|// sharing it).
singleline_comment|// FIX! The kernel&squot;s irq code should do this
id|intMask
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_INT0_HIGH_MASK
)paren
suffix:semicolon
id|intMask
op_or_assign
l_int|1
op_lshift
id|gp-&gt;port_num
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|GT96100_INT0_HIGH_MASK
comma
id|intMask
)paren
suffix:semicolon
)brace
DECL|function|disable_ether_irq
r_static
r_void
id|disable_ether_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|intMask
suffix:semicolon
singleline_comment|// FIX! The kernel&squot;s irq code should do this
id|intMask
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_INT0_HIGH_MASK
)paren
suffix:semicolon
id|intMask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|gp-&gt;port_num
)paren
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|GT96100_INT0_HIGH_MASK
comma
id|intMask
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_MASK
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Probe for a GT96100 ethernet controller.&n; */
DECL|function|gt96100_probe
r_int
id|__init
id|gt96100_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|base_addr
op_assign
id|dev
ques
c_cond
id|dev-&gt;base_addr
suffix:colon
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifndef CONFIG_MIPS_GT96100ETH
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: gt96100_probe&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
op_ge
id|KSEG0
)paren
multiline_comment|/* Check a single specified location. */
r_return
id|gt96100_probe1
c_func
(paren
id|dev
comma
id|base_addr
comma
id|dev-&gt;irq
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|base_addr
op_ne
l_int|0
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
singleline_comment|//&t;for (i = 0; i&lt;NUM_INTERFACES; i++) {
r_for
c_loop
(paren
id|i
op_assign
id|NUM_INTERFACES
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|base_addr
op_assign
id|gt96100_iflist
(braket
id|i
)braket
dot
id|port
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|base_addr
comma
id|GT96100_ETH_IO_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: gt96100_probe: ioaddr 0x%lx taken?&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|base_addr
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|gt96100_probe1
(paren
id|dev
comma
id|base_addr
comma
id|gt96100_iflist
(braket
id|i
)braket
dot
id|irq
comma
id|i
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|gt96100_probe1
id|gt96100_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|port_num
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|gt96100_private
op_star
id|gp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|retval
suffix:semicolon
id|u32
id|cpuConfig
suffix:semicolon
singleline_comment|// FIX! probe for GT96100 by reading a suitable register
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;gt96100_probe1: ioaddr 0x%lx, irq %d&bslash;n&quot;
comma
id|ioaddr
comma
id|irq
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|ioaddr
comma
id|GT96100_ETH_IO_SIZE
comma
l_string|&quot;GT96100ETH&quot;
)paren
suffix:semicolon
id|cpuConfig
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_CPU_INTERF_CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpuConfig
op_amp
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gt96100_probe1: must be in Big Endian mode!&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;gt96100_probe1: chip in Big Endian mode - cool&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Allocate a new &squot;dev&squot; if needed. */
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|gt96100_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
op_logical_and
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gt96100_probe1: irq unknown - probing not supported&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: GT-96100 ethernet found at 0x%lx, irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ioaddr
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* private struct aligned and zeroed by init_etherdev */
multiline_comment|/* Fill in the &squot;dev&squot; fields. */
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|gt96100_station_addr
(braket
id|port_num
)braket
comma
r_sizeof
(paren
id|dev-&gt;dev_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: HW Address &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|dev-&gt;dev_addr
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|i
OL
l_int|5
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize our private structure. */
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|gp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
id|gp
suffix:semicolon
)brace
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|gp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|gp
)paren
)paren
suffix:semicolon
singleline_comment|// clear it
id|gp-&gt;port_num
op_assign
id|port_num
suffix:semicolon
id|gp-&gt;io_size
op_assign
id|GT96100_ETH_IO_SIZE
suffix:semicolon
id|gp-&gt;port_offset
op_assign
id|port_num
op_star
id|GT96100_ETH_IO_SIZE
suffix:semicolon
id|gp-&gt;phy_addr
op_assign
id|port_num
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: gt96100_probe1, port %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|gp-&gt;port_num
)paren
suffix:semicolon
singleline_comment|// Allocate Rx and Tx descriptor rings
r_if
c_cond
(paren
id|gp-&gt;rx_ring
op_eq
l_int|NULL
)paren
(brace
singleline_comment|// All descriptors in ring must be 16-byte aligned
id|gp-&gt;rx_ring
op_assign
id|dmaalloc
c_func
(paren
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
id|RX_RING_SIZE
op_plus
r_sizeof
(paren
id|gt96100_td_t
)paren
op_star
id|TX_RING_SIZE
comma
op_amp
id|gp-&gt;rx_ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;rx_ring
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
id|gp-&gt;tx_ring
op_assign
(paren
id|gt96100_td_t
op_star
)paren
(paren
id|gp-&gt;rx_ring
op_plus
id|RX_RING_SIZE
)paren
suffix:semicolon
id|gp-&gt;tx_ring_dma
op_assign
id|gp-&gt;rx_ring_dma
op_plus
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
id|RX_RING_SIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: gt96100_probe1, rx_ring=%p, tx_ring=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|gp-&gt;rx_ring
comma
id|gp-&gt;tx_ring
)paren
suffix:semicolon
singleline_comment|// Allocate Rx Hash Table
r_if
c_cond
(paren
id|gp-&gt;hash_table
op_eq
l_int|NULL
)paren
(brace
id|gp-&gt;hash_table
op_assign
(paren
r_char
op_star
)paren
id|dmaalloc
c_func
(paren
id|RX_HASH_TABLE_SIZE
comma
op_amp
id|gp-&gt;hash_table_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;hash_table
op_eq
l_int|NULL
)paren
(brace
id|dmafree
c_func
(paren
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
id|RX_RING_SIZE
op_plus
r_sizeof
(paren
id|gt96100_td_t
)paren
op_star
id|TX_RING_SIZE
comma
id|gp-&gt;rx_ring
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: gt96100_probe1, hash=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|gp-&gt;hash_table
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|gt96100_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|gt96100_tx
suffix:semicolon
id|dev-&gt;stop
op_assign
id|gt96100_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|gt96100_get_stats
suffix:semicolon
singleline_comment|//dev-&gt;do_ioctl = gt96100_ioctl;
id|dev-&gt;set_multicast_list
op_assign
id|gt96100_set_rx_mode
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|gt96100_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|GT96100ETH_TX_TIMEOUT
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with ethernet values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|free_region
suffix:colon
id|release_region
c_func
(paren
id|ioaddr
comma
id|gp-&gt;io_size
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: gt96100_probe1 failed.  Returns %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|gt96100_init
r_static
r_int
id|gt96100_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|phyAD
comma
id|ciu
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
singleline_comment|// Stop and disable Port
id|hard_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
singleline_comment|// First things first, set-up hash table
id|memset
c_func
(paren
id|gp-&gt;hash_table
comma
l_int|0
comma
id|RX_HASH_TABLE_SIZE
)paren
suffix:semicolon
singleline_comment|// clear it
id|gp-&gt;hash_mode
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Add a single entry to hash table - our ethernet address
id|gt96100_add_hash_entry
c_func
(paren
id|dev
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
singleline_comment|// Set-up DMA ptr to hash table
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_HASH_TBL_PTR
comma
id|gp-&gt;hash_table_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: Hash Tbl Ptr=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_HASH_TBL_PTR
)paren
)paren
suffix:semicolon
singleline_comment|// Setup Tx descriptor ring
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|gp-&gt;tx_ring
(braket
id|i
)braket
dot
id|cmdstat
op_assign
l_int|0
suffix:semicolon
singleline_comment|// CPU owns
id|gp-&gt;tx_ring
(braket
id|i
)braket
dot
id|byte_cnt
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;tx_ring
(braket
id|i
)braket
dot
id|buff_ptr
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;tx_ring
(braket
id|i
)braket
dot
id|next
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;tx_ring_dma
op_plus
r_sizeof
(paren
id|gt96100_td_t
)paren
op_star
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Wrap the ring. */
id|gp-&gt;tx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;tx_ring_dma
)paren
suffix:semicolon
singleline_comment|// setup only the lowest priority TxCDP reg
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_TX_DESC_PTR0
comma
id|gp-&gt;tx_ring_dma
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_TX_DESC_PTR1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: Curr Tx Desc Ptr0=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_TX_DESC_PTR0
)paren
)paren
suffix:semicolon
singleline_comment|// Setup Rx descriptor ring 
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dma_addr_t
id|rx_buff_dma
suffix:semicolon
id|gp-&gt;rx_ring
(braket
id|i
)braket
dot
id|next
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;rx_ring_dma
op_plus
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;rx_buff
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
id|gp-&gt;rx_buff
(braket
id|i
)braket
op_assign
id|dmaalloc
c_func
(paren
id|PKT_BUF_SZ
comma
op_amp
id|rx_buff_dma
)paren
suffix:semicolon
r_else
id|rx_buff_dma
op_assign
id|virt_to_phys
c_func
(paren
id|gp-&gt;rx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;rx_buff
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|gp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buff_ptr
op_assign
id|cpu_to_dma32
c_func
(paren
id|rx_buff_dma
)paren
suffix:semicolon
id|gp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buff_cnt_sz
op_assign
id|cpu_to_dma32
c_func
(paren
id|PKT_BUF_SZ
op_lshift
id|rdBuffSzBit
)paren
suffix:semicolon
singleline_comment|// Give ownership to device, enable interrupt
id|gp-&gt;rx_ring
(braket
id|i
)braket
dot
id|cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
(paren
id|u32
)paren
(paren
id|rxOwn
op_or
id|rxEI
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
id|RX_RING_SIZE
)paren
(brace
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|RX_RING_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;rx_buff
(braket
id|j
)braket
)paren
(brace
id|dmafree
c_func
(paren
id|PKT_BUF_SZ
comma
id|gp-&gt;rx_buff
(braket
id|j
)braket
)paren
suffix:semicolon
id|gp-&gt;rx_buff
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Rx ring allocation failed.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Wrap the ring. */
id|gp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;rx_ring_dma
)paren
suffix:semicolon
singleline_comment|// Set our MII PHY device address
id|phyAD
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_PHY_ADDR_REG
)paren
suffix:semicolon
id|phyAD
op_and_assign
op_complement
(paren
l_int|0x1f
op_lshift
(paren
id|gp-&gt;port_num
op_star
l_int|5
)paren
)paren
suffix:semicolon
id|phyAD
op_or_assign
id|gp-&gt;phy_addr
op_lshift
(paren
id|gp-&gt;port_num
op_star
l_int|5
)paren
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|GT96100_ETH_PHY_ADDR_REG
comma
id|phyAD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: PhyAD=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_PHY_ADDR_REG
)paren
)paren
suffix:semicolon
singleline_comment|// Clear all the RxFDP and RXCDP regs...
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_1ST_RX_DESC_PTR0
op_plus
id|i
op_star
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_RX_DESC_PTR0
op_plus
id|i
op_star
l_int|4
comma
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|// and setup only the lowest priority RxFDP and RxCDP regs
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_1ST_RX_DESC_PTR0
comma
id|gp-&gt;rx_ring_dma
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_RX_DESC_PTR0
comma
id|gp-&gt;rx_ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: 1st/Curr Rx Desc Ptr0=%x/%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_1ST_RX_DESC_PTR0
)paren
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_RX_DESC_PTR0
)paren
)paren
suffix:semicolon
singleline_comment|// init Rx/Tx indeces and pkt counters
id|gp-&gt;rx_next_out
op_assign
id|gp-&gt;tx_next_in
op_assign
id|gp-&gt;tx_next_out
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;tx_count
op_assign
l_int|0
suffix:semicolon
singleline_comment|// setup DMA
singleline_comment|// FIX! this should be done by Kernel setup code
id|ciu
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_CIU_ARBITER_CONFIG
)paren
suffix:semicolon
id|ciu
op_or_assign
(paren
l_int|0x0c
op_lshift
(paren
id|gp-&gt;port_num
op_star
l_int|2
)paren
)paren
suffix:semicolon
singleline_comment|// set Ether DMA req priority to high
singleline_comment|// FIX! setting the following bit causes the EV96100 board to hang!!!
singleline_comment|//ciu |= (1 &lt;&lt; (24+gp-&gt;port_num));   // pull Ethernet port out of Reset???
singleline_comment|// FIX! endian mode???
id|ciu
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|31
)paren
suffix:semicolon
singleline_comment|// set desc endianess to Big
id|GT96100_WRITE
c_func
(paren
id|GT96100_CIU_ARBITER_CONFIG
comma
id|ciu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: CIU Config=%x/%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ciu
comma
id|GT96100_READ
c_func
(paren
id|GT96100_CIU_ARBITER_CONFIG
)paren
)paren
suffix:semicolon
singleline_comment|// We want the Rx/Tx DMA to write/read data to/from memory in
singleline_comment|// Big Endian mode. Also set DMA Burst Size to 8 64Bit words.
singleline_comment|// FIX! endian mode???
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_CONFIG
comma
singleline_comment|//sdcrBLMR | sdcrBLMT |
(paren
l_int|0xf
op_lshift
id|sdcrRCBit
)paren
op_or
id|sdcrRIFB
op_or
(paren
l_int|3
op_lshift
id|sdcrBSZBit
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: SDMA Config=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_CONFIG
)paren
)paren
suffix:semicolon
singleline_comment|// start Rx DMA
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|sdcmrERD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: SDMA Comm=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
)paren
)paren
suffix:semicolon
singleline_comment|// enable interrupts
id|enable_ether_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Disable all Type-of-Service queueing. All Rx packets will be&n;&t; * treated normally and will be sent to the lowest priority&n;&t; * queue.&n;&t; *&n;&t; * Disable flow-control for now. FIX! support flow control?&n;&t; */
singleline_comment|// clear all the MIB ctr regs
singleline_comment|// Enable reg clear on read. FIX! desc of this bit is inconsistent
singleline_comment|// in the GT-96100A datasheet.
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG_EXT
comma
id|pcxrFCTL
op_or
id|pcxrFCTLen
op_or
id|pcxrFLP
)paren
suffix:semicolon
id|read_mib_counters
c_func
(paren
id|gp
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG_EXT
comma
id|pcxrFCTL
op_or
id|pcxrFCTLen
op_or
id|pcxrFLP
op_or
id|pcxrMIBclrMode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: Port Config Ext=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG_EXT
)paren
)paren
suffix:semicolon
singleline_comment|// enable this port (set hash size to 1/2K)
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG
comma
id|pcrEN
op_or
id|pcrHS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_init: Port Config=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG
)paren
)paren
suffix:semicolon
singleline_comment|// we should now be receiving frames
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|dump_MII
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gt96100_open
r_static
r_int
id|gt96100_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|retval
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_open: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|gt96100_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
singleline_comment|// Initialize and startup the GT-96100 ethernet port
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|gt96100_init
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: error in gt96100_init&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_open: Initialization done.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gt96100_close
r_static
r_int
id|gt96100_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_close: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
singleline_comment|// stop the device
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hard_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
singleline_comment|// free the Rx DMA buffers
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;rx_buff
(braket
id|i
)braket
)paren
(brace
id|dmafree
c_func
(paren
id|PKT_BUF_SZ
comma
id|gp-&gt;rx_buff
(braket
id|i
)braket
)paren
suffix:semicolon
id|gp-&gt;rx_buff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gt96100_tx
r_static
r_int
id|gt96100_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|nextIn
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_tx: skb-&gt;len=%d, skb-&gt;data=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
comma
id|skb-&gt;data
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;tx_count
op_ge
id|TX_RING_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Tx Ring full, refusing to send buffer.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
singleline_comment|// Prepare the Descriptor at tx_next_in
id|nextIn
op_assign
id|gp-&gt;tx_next_in
suffix:semicolon
r_if
c_cond
(paren
id|dma32_to_cpu
c_func
(paren
id|gp-&gt;tx_ring
(braket
id|nextIn
)braket
dot
id|cmdstat
)paren
op_amp
id|txOwn
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: gt96100_tx: TxOwn bit wrong!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|gp-&gt;tx_skbuff
(braket
id|nextIn
)braket
op_assign
id|skb
suffix:semicolon
id|gp-&gt;tx_ring
(braket
id|nextIn
)braket
dot
id|byte_cnt
op_assign
id|cpu_to_dma32
c_func
(paren
id|skb-&gt;len
op_lshift
id|tdByteCntBit
)paren
suffix:semicolon
id|gp-&gt;tx_ring
(braket
id|nextIn
)braket
dot
id|buff_ptr
op_assign
id|cpu_to_dma32
c_func
(paren
id|virt_to_phys
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
singleline_comment|// Give ownership to device, set first and last desc, enable interrupt
singleline_comment|// Setting of ownership bit must be *last*!
id|gp-&gt;tx_ring
(braket
id|nextIn
)braket
dot
id|cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
(paren
id|u32
)paren
(paren
id|txOwn
op_or
id|txEI
op_or
id|txFirst
op_or
id|txLast
)paren
)paren
suffix:semicolon
singleline_comment|// increment tx_next_in with wrap
id|gp-&gt;tx_next_in
op_assign
(paren
id|nextIn
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
suffix:semicolon
singleline_comment|// If count is zero, DMA should be stopped, so restart
r_if
c_cond
(paren
id|gp-&gt;tx_count
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_STATUS
)paren
op_amp
id|psrTxLow
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Tx count zero but Tx queue running!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|sdcmrERD
op_or
id|sdcmrTXDL
)paren
suffix:semicolon
)brace
singleline_comment|// increment count and stop queue if full
r_if
c_cond
(paren
op_increment
id|gp-&gt;tx_count
op_eq
id|TX_RING_SIZE
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gt96100_rx
r_static
r_int
id|gt96100_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_len
comma
id|nextOut
suffix:semicolon
id|gt96100_rd_t
op_star
id|rd
suffix:semicolon
id|u32
id|cmdstat
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_rx: dev=%p, status = %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
comma
id|status
)paren
suffix:semicolon
singleline_comment|// Continue until we reach the current descriptor pointer
r_for
c_loop
(paren
id|nextOut
op_assign
id|gp-&gt;rx_next_out
suffix:semicolon
id|nextOut
op_ne
(paren
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_RX_DESC_PTR0
)paren
op_minus
id|gp-&gt;rx_ring_dma
)paren
op_div
r_sizeof
(paren
id|gt96100_rd_t
)paren
suffix:semicolon
id|nextOut
op_assign
(paren
id|nextOut
op_plus
l_int|1
)paren
op_mod
id|RX_RING_SIZE
)paren
(brace
id|rd
op_assign
op_amp
id|gp-&gt;rx_ring
(braket
id|nextOut
)braket
suffix:semicolon
id|cmdstat
op_assign
id|dma32_to_cpu
c_func
(paren
id|rd-&gt;cmdstat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxOwn
)paren
(brace
id|cmdstat
op_and_assign
op_complement
(paren
(paren
id|u32
)paren
id|rxOwn
)paren
suffix:semicolon
id|rd-&gt;cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
id|cmdstat
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: gt96100_rx: ownership bit wrong!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
singleline_comment|// must be first and last (ie only) buffer of packet
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxFirst
)paren
op_logical_or
op_logical_neg
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxLast
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: gt96100_rx: desc not first and last!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
singleline_comment|// drop this received pkt if there were any errors
r_if
c_cond
(paren
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxErrorSummary
)paren
op_logical_or
(paren
id|status
op_amp
id|icrRxErrorQ0
)paren
)paren
(brace
singleline_comment|// update the detailed rx error counters that are not covered
singleline_comment|// by the MIB counters.
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxOverrun
)paren
id|gp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pkt_len
op_assign
id|dma32_to_cpu
c_func
(paren
id|rd-&gt;buff_cnt_sz
)paren
op_amp
id|rdByteCntMask
suffix:semicolon
multiline_comment|/* Create new skb. */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte IP header align */
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Make room */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|gp-&gt;rx_buff
(braket
id|nextOut
)braket
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* pass the packet to upper layers */
singleline_comment|// now we can release ownership of this desc back to device
id|cmdstat
op_or_assign
(paren
id|u32
)paren
id|rxOwn
suffix:semicolon
id|rd-&gt;cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
id|cmdstat
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
id|gp-&gt;rx_next_out
op_assign
id|nextOut
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gt96100_interrupt
r_static
r_void
id|gt96100_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|status
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: null dev ptr&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|status
op_assign
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
)paren
suffix:semicolon
singleline_comment|// ACK interrupts
macro_line|#if 0
id|GT96100ETH_CLRBIT
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
comma
id|icrEtherIntSum
op_or
id|icrRxBufferQ1
op_or
id|icrRxBufferQ2
op_or
id|icrRxBufferQ3
op_or
id|icrRxBufferQ0
op_or
id|icrTxBufferHigh
op_or
id|icrTxEndHigh
op_or
id|icrTxBufferLow
op_or
id|icrTxEndLow
op_or
id|icrTxErrorHigh
op_or
id|icrTxErrorLow
op_or
id|icrTxUdr
)paren
suffix:semicolon
macro_line|#else
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|status
op_amp
id|icrEtherIntSum
)paren
op_eq
l_int|0
)paren
(brace
singleline_comment|// not our interrupt
singleline_comment|//printk(&quot;%s: isr: no ints? icr=%x,cp0_cause=%x&bslash;n&quot;,
singleline_comment|//       dev-&gt;name, status, read_32bit_cp0_register(CP0_CAUSE));
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: isr: entry, icr=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|icrRxBufferQ1
op_or
id|icrRxBufferQ2
op_or
id|icrRxBufferQ3
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: Rx intr in unused queues!?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|icrRxBufferQ0
)paren
(brace
id|gt96100_rx
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|icrTxBufferHigh
op_or
id|icrTxEndHigh
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: Tx intr in unused queue!?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|icrMIIPhySTC
)paren
(brace
id|u32
id|psr
op_assign
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_STATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: port status:&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%s:     %s MBit/s, %s-duplex, flow-control %s, link is %s,&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|psr
op_amp
id|psrSpeed
ques
c_cond
l_string|&quot;100&quot;
suffix:colon
l_string|&quot;10&quot;
comma
id|psr
op_amp
id|psrDuplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|psr
op_amp
id|psrFctl
ques
c_cond
l_string|&quot;disabled&quot;
suffix:colon
l_string|&quot;enabled&quot;
comma
id|psr
op_amp
id|psrLink
ques
c_cond
l_string|&quot;up&quot;
suffix:colon
l_string|&quot;down&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%s:     TxLowQ is %s, TxHighQ is %s, Transmitter is %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|psr
op_amp
id|psrTxLow
ques
c_cond
l_string|&quot;running&quot;
suffix:colon
l_string|&quot;stopped&quot;
comma
id|psr
op_amp
id|psrTxHigh
ques
c_cond
l_string|&quot;running&quot;
suffix:colon
l_string|&quot;stopped&quot;
comma
id|psr
op_amp
id|psrTxInProg
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|gp-&gt;last_psr
op_assign
id|psr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|icrTxBufferLow
op_or
id|icrTxEndLow
)paren
)paren
(brace
r_int
id|nextOut
suffix:semicolon
id|gt96100_td_t
op_star
id|td
suffix:semicolon
id|u32
id|cmdstat
suffix:semicolon
singleline_comment|// Continue until we reach the current descriptor pointer
r_for
c_loop
(paren
id|nextOut
op_assign
id|gp-&gt;tx_next_out
suffix:semicolon
id|nextOut
op_ne
(paren
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_TX_DESC_PTR0
)paren
op_minus
id|gp-&gt;tx_ring_dma
)paren
op_div
r_sizeof
(paren
id|gt96100_td_t
)paren
suffix:semicolon
id|nextOut
op_assign
(paren
id|nextOut
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)paren
(brace
id|td
op_assign
op_amp
id|gp-&gt;tx_ring
(braket
id|nextOut
)braket
suffix:semicolon
id|cmdstat
op_assign
id|dma32_to_cpu
c_func
(paren
id|td-&gt;cmdstat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: isr: Tx desc cmdstat=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cmdstat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txOwn
)paren
(brace
id|cmdstat
op_and_assign
op_complement
(paren
(paren
id|u32
)paren
id|txOwn
)paren
suffix:semicolon
id|td-&gt;cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
id|cmdstat
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: Tx ownership bit wrong!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
singleline_comment|// increment Tx error stats
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txErrorSummary
)paren
(brace
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
(paren
l_string|&quot;%s: gt96100_interrupt: Tx error, cmdstat = %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cmdstat
)paren
suffix:semicolon
id|gp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txReTxLimit
)paren
id|gp-&gt;stats.collisions
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txUnderrun
)paren
id|gp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txLateCollision
)paren
id|gp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
)brace
singleline_comment|// Wake the queue if the ring was full
r_if
c_cond
(paren
id|gp-&gt;tx_count
op_eq
id|TX_RING_SIZE
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|// decrement tx ring buffer count
r_if
c_cond
(paren
id|gp-&gt;tx_count
)paren
id|gp-&gt;tx_count
op_decrement
suffix:semicolon
singleline_comment|// free the skb
r_if
c_cond
(paren
id|gp-&gt;tx_skbuff
(braket
id|nextOut
)braket
)paren
(brace
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
(paren
l_string|&quot;%s: isr: good Tx, skb=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|gp-&gt;tx_skbuff
(braket
id|nextOut
)braket
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|gp-&gt;tx_skbuff
(braket
id|nextOut
)braket
)paren
suffix:semicolon
id|gp-&gt;tx_skbuff
(braket
id|nextOut
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: no skb!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|gp-&gt;tx_count
op_eq
l_int|0
op_logical_and
id|nextOut
op_ne
id|gp-&gt;tx_next_in
)paren
(brace
singleline_comment|// FIX! this should probably be a panic
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: warning! Tx queue inconsistent&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|gp-&gt;tx_next_out
op_assign
id|nextOut
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|icrTxEndLow
)paren
op_logical_and
id|gp-&gt;tx_count
op_ne
l_int|0
)paren
(brace
singleline_comment|// we must restart the DMA
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: isr: Restarting Tx DMA&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|sdcmrERD
op_or
id|sdcmrTXDL
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// Now check TX errors (RX errors were handled in gt96100_rx)
r_if
c_cond
(paren
id|status
op_amp
id|icrTxErrorHigh
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: Tx resource error in unused queue!?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|icrTxErrorLow
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: Tx resource error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|icrTxUdr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: Tx underrun error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: isr: exit, icr=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The Tx ring has been full longer than the watchdog timeout&n; * value, meaning that the interrupt routine has not been freeing&n; * up space in the Tx ring buffer.&n; */
DECL|function|gt96100_tx_timeout
r_static
r_void
id|gt96100_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
singleline_comment|//    struct gt96100_private *gp = (struct gt96100_private *)dev-&gt;priv;
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: gt96100_tx_timeout: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
singleline_comment|// FIX! do something, like reset the device
)brace
DECL|function|gt96100_set_rx_mode
r_static
r_void
id|gt96100_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mcptr
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_set_rx_mode: dev=%p, flags=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
comma
id|dev-&gt;flags
)paren
suffix:semicolon
singleline_comment|// stop the Receiver DMA
m_abort
(paren
id|dev
comma
id|sdcmrAR
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG
comma
id|pcrEN
op_or
id|pcrHS
op_or
id|pcrPM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|gp-&gt;hash_table
comma
l_int|0
comma
id|RX_HASH_TABLE_SIZE
)paren
suffix:semicolon
singleline_comment|// clear hash table
singleline_comment|// Add our ethernet address
id|gt96100_add_hash_entry
c_func
(paren
id|dev
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
r_for
c_loop
(paren
id|mcptr
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mcptr
suffix:semicolon
id|mcptr
op_assign
id|mcptr-&gt;next
)paren
(brace
id|gt96100_add_hash_entry
c_func
(paren
id|dev
comma
id|mcptr-&gt;dmi_addr
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// restart Rx DMA
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|sdcmrERD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|gt96100_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|gt96100_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;%s: gt96100_get_stats: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
op_amp
id|gp-&gt;stats
suffix:semicolon
)brace
DECL|variable|gt96100_probe
id|module_init
c_func
(paren
id|gt96100_probe
)paren
suffix:semicolon
eof
