multiline_comment|/*&n; * Copyright 2000, 2001 MontaVista Software Inc.&n; * Author: MontaVista Software, Inc.&n; *         &t;stevel@mvista.com or source@mvista.com&n; *&n; * ########################################################################&n; *&n; *  This program is free software; you can distribute it and/or modify it&n; *  under the terms of the GNU General Public License (Version 2) as&n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; *  for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * ########################################################################&n; *&n; * Ethernet driver for the MIPS GT96100 Advanced Communication Controller.&n; * &n; *  Revision history&n; *    &n; *    11.11.2001  Moved to 2.4.14, ppopov@mvista.com.  Modified driver to add&n; *                proper gt96100A support.&n; *    12.05.2001  Moved eth port 0 to irq 3 (mapped to GT_SERINT0 on EV96100A)&n; *                in order for both ports to work. Also cleaned up boot&n; *                option support (mac address string parsing), fleshed out&n; *                gt96100_cleanup_module(), and other general code cleanups&n; *                &lt;stevel@mvista.com&gt;.&n; */
macro_line|#ifndef __OPTIMIZE__
macro_line|#error You must compile this file with the correct options!
macro_line|#error See the last lines of the source file.
macro_line|#error You must compile this driver with &quot;-O&quot;.
macro_line|#endif
macro_line|#ifndef __mips__
macro_line|#error This driver only works with MIPS architectures!
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|DESC_BE
mdefine_line|#define DESC_BE 1
DECL|macro|DESC_DATA_BE
mdefine_line|#define DESC_DATA_BE 1
DECL|macro|GT96100_DEBUG
mdefine_line|#define GT96100_DEBUG 2
macro_line|#include &quot;gt96100eth.h&quot;
singleline_comment|// prototypes
r_static
r_void
op_star
id|dmaalloc
c_func
(paren
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
suffix:semicolon
r_static
r_void
id|dmafree
c_func
(paren
r_int
id|size
comma
r_void
op_star
id|vaddr
)paren
suffix:semicolon
r_static
r_void
id|gt96100_delay
c_func
(paren
r_int
id|msec
)paren
suffix:semicolon
r_static
r_int
id|gt96100_add_hash_entry
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|read_mib_counters
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
suffix:semicolon
r_static
r_int
id|read_MII
c_func
(paren
r_int
id|phy_addr
comma
id|u32
id|reg
)paren
suffix:semicolon
r_static
r_int
id|write_MII
c_func
(paren
r_int
id|phy_addr
comma
id|u32
id|reg
comma
id|u16
id|data
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_void
id|dump_tx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|dump_rx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|gt96100_init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|gt96100_cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|dump_MII
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|dump_tx_desc
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|i
)paren
suffix:semicolon
r_static
r_void
id|dump_rx_desc
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|i
)paren
suffix:semicolon
r_static
r_void
id|dump_skb
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|dump_hw_addr
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
comma
r_const
r_char
op_star
id|pfx
comma
r_int
r_char
op_star
id|addr_str
)paren
suffix:semicolon
r_static
r_void
id|update_stats
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
suffix:semicolon
r_static
r_void
m_abort
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|abort_bits
)paren
suffix:semicolon
r_static
r_void
id|hard_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|enable_ether_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|disable_ether_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_probe1
c_func
(paren
r_int
id|port_num
)paren
suffix:semicolon
r_static
r_void
id|reset_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|reset_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_check_tx_consistent
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
suffix:semicolon
r_static
r_int
id|gt96100_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|gt96100_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
)paren
suffix:semicolon
r_static
r_void
id|gt96100_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|gt96100_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|gt96100_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|gt96100_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_extern
r_char
op_star
id|__init
id|prom_getcmdline
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|32
suffix:semicolon
DECL|macro|nibswap
mdefine_line|#define nibswap(x) ((((x) &gt;&gt; 4) &amp; 0x0f) | (((x) &lt;&lt; 4) &amp; 0xf0))
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
singleline_comment|// For reading/writing 32-bit words and half-words from/to DMA memory
macro_line|#ifdef DESC_BE
DECL|macro|cpu_to_dma32
mdefine_line|#define cpu_to_dma32 cpu_to_be32
DECL|macro|dma32_to_cpu
mdefine_line|#define dma32_to_cpu be32_to_cpu
DECL|macro|cpu_to_dma16
mdefine_line|#define cpu_to_dma16 cpu_to_be16
DECL|macro|dma16_to_cpu
mdefine_line|#define dma16_to_cpu be16_to_cpu
macro_line|#else
DECL|macro|cpu_to_dma32
mdefine_line|#define cpu_to_dma32 cpu_to_le32
DECL|macro|dma32_to_cpu
mdefine_line|#define dma32_to_cpu le32_to_cpu
DECL|macro|cpu_to_dma16
mdefine_line|#define cpu_to_dma16 cpu_to_le16
DECL|macro|dma16_to_cpu
mdefine_line|#define dma16_to_cpu le16_to_cpu
macro_line|#endif
DECL|variable|mac0
r_static
r_char
id|mac0
(braket
l_int|18
)braket
op_assign
l_string|&quot;00.02.03.04.05.06&quot;
suffix:semicolon
DECL|variable|mac1
r_static
r_char
id|mac1
(braket
l_int|18
)braket
op_assign
l_string|&quot;00.01.02.03.04.05&quot;
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mac0
comma
l_string|&quot;c18&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mac1
comma
l_string|&quot;c18&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mac0
comma
l_string|&quot;MAC address for GT96100 ethernet port 0&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mac1
comma
l_string|&quot;MAC address for GT96100 ethernet port 1&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Info for the GT96100 ethernet controller&squot;s ports.&n; */
DECL|struct|gt96100_if_t
r_static
r_struct
id|gt96100_if_t
(brace
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
DECL|member|iobase
r_int
r_int
id|iobase
suffix:semicolon
singleline_comment|// IO Base address of this port
DECL|member|irq
r_int
id|irq
suffix:semicolon
singleline_comment|// IRQ number of this port
DECL|member|mac_str
r_char
op_star
id|mac_str
suffix:semicolon
DECL|variable|gt96100_iflist
)brace
id|gt96100_iflist
(braket
id|NUM_INTERFACES
)braket
op_assign
(brace
(brace
l_int|NULL
comma
id|GT96100_ETH0_BASE
comma
id|GT96100_ETHER0_IRQ
comma
id|mac0
)brace
comma
(brace
l_int|NULL
comma
id|GT96100_ETH1_BASE
comma
id|GT96100_ETHER1_IRQ
comma
id|mac1
)brace
)brace
suffix:semicolon
r_static
r_inline
r_const
r_char
op_star
DECL|function|chip_name
id|chip_name
c_func
(paren
r_int
id|chip_rev
)paren
(brace
r_switch
c_cond
(paren
id|chip_rev
)paren
(brace
r_case
id|REV_GT96100
suffix:colon
r_return
l_string|&quot;GT96100&quot;
suffix:semicolon
r_case
id|REV_GT96100A_1
suffix:colon
r_case
id|REV_GT96100A
suffix:colon
r_return
l_string|&quot;GT96100A&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;Unknown GT96100&quot;
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;  DMA memory allocation, derived from pci_alloc_consistent.&n;*/
r_static
r_void
op_star
DECL|function|dmaalloc
id|dmaalloc
c_func
(paren
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
id|ret
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
op_or
id|GFP_DMA
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
(brace
id|dma_cache_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|ret
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_handle
op_ne
l_int|NULL
)paren
op_star
id|dma_handle
op_assign
id|virt_to_phys
c_func
(paren
id|ret
)paren
suffix:semicolon
multiline_comment|/* bump virtual address up to non-cached area */
id|ret
op_assign
(paren
r_void
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|dmafree
id|dmafree
c_func
(paren
r_int
id|size
comma
r_void
op_star
id|vaddr
)paren
(brace
id|vaddr
op_assign
(paren
r_void
op_star
)paren
id|KSEG0ADDR
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|vaddr
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|gt96100_delay
id|gt96100_delay
c_func
(paren
r_int
id|ms
)paren
(brace
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
r_else
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|ms
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|parse_mac_addr
id|parse_mac_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|macstr
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_char
id|result
comma
id|value
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|5
op_logical_and
op_star
(paren
id|macstr
op_plus
l_int|2
)paren
op_ne
l_char|&squot;.&squot;
)paren
(brace
id|err
c_func
(paren
id|__FILE__
l_string|&quot;invalid mac address format: %d %c&bslash;n&quot;
comma
id|i
comma
op_star
(paren
id|macstr
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|isxdigit
c_func
(paren
op_star
id|macstr
)paren
op_logical_and
(paren
id|value
op_assign
id|isdigit
c_func
(paren
op_star
id|macstr
)paren
ques
c_cond
op_star
id|macstr
op_minus
l_char|&squot;0&squot;
suffix:colon
id|toupper
c_func
(paren
op_star
id|macstr
)paren
op_minus
l_char|&squot;A&squot;
op_plus
l_int|10
)paren
OL
l_int|16
)paren
(brace
id|result
op_assign
id|result
op_star
l_int|16
op_plus
id|value
suffix:semicolon
id|macstr
op_increment
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
id|__FILE__
l_string|&quot;invalid mac address &quot;
l_string|&quot;character: %c&bslash;n&quot;
comma
op_star
id|macstr
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|macstr
op_increment
suffix:semicolon
singleline_comment|// step over &squot;.&squot;
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|result
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_MII
id|read_MII
c_func
(paren
r_int
id|phy_addr
comma
id|u32
id|reg
)paren
(brace
r_int
id|timedout
op_assign
l_int|20
suffix:semicolon
id|u32
id|smir
op_assign
id|smirOpCode
op_or
(paren
id|phy_addr
op_lshift
id|smirPhyAdBit
)paren
op_or
(paren
id|reg
op_lshift
id|smirRegAdBit
)paren
suffix:semicolon
singleline_comment|// wait for last operation to complete
r_while
c_loop
(paren
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_SMI_REG
)paren
op_amp
id|smirBusy
)paren
(brace
singleline_comment|// snooze for 1 msec and check again
id|gt96100_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: busy timeout!!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
id|GT96100_WRITE
c_func
(paren
id|GT96100_ETH_SMI_REG
comma
id|smir
)paren
suffix:semicolon
id|timedout
op_assign
l_int|20
suffix:semicolon
singleline_comment|// wait for read to complete
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|smir
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_SMI_REG
)paren
)paren
op_amp
id|smirReadValid
)paren
)paren
(brace
singleline_comment|// snooze for 1 msec and check again
id|gt96100_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: timeout!!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_return
(paren
r_int
)paren
(paren
id|smir
op_amp
id|smirDataMask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dump_tx_desc
id|dump_tx_desc
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|i
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|gt96100_td_t
op_star
id|td
op_assign
op_amp
id|gp-&gt;tx_ring
(braket
id|i
)braket
suffix:semicolon
id|dbg
c_func
(paren
id|dbg_lvl
comma
l_string|&quot;Tx descriptor at 0x%08lx:&bslash;n&quot;
comma
id|virt_to_phys
c_func
(paren
id|td
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|dbg_lvl
comma
l_string|&quot;    cmdstat=%04x, byte_cnt=%04x, buff_ptr=%04x, next=%04x&bslash;n&quot;
comma
id|dma32_to_cpu
c_func
(paren
id|td-&gt;cmdstat
)paren
comma
id|dma16_to_cpu
c_func
(paren
id|td-&gt;byte_cnt
)paren
comma
id|dma32_to_cpu
c_func
(paren
id|td-&gt;buff_ptr
)paren
comma
id|dma32_to_cpu
c_func
(paren
id|td-&gt;next
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dump_rx_desc
id|dump_rx_desc
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|i
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|gt96100_rd_t
op_star
id|rd
op_assign
op_amp
id|gp-&gt;rx_ring
(braket
id|i
)braket
suffix:semicolon
id|dbg
c_func
(paren
id|dbg_lvl
comma
l_string|&quot;Rx descriptor at 0x%08lx:&bslash;n&quot;
comma
id|virt_to_phys
c_func
(paren
id|rd
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|dbg_lvl
comma
l_string|&quot;    cmdstat=%04x, buff_sz=%04x, byte_cnt=%04x, &quot;
l_string|&quot;buff_ptr=%04x, next=%04x&bslash;n&quot;
comma
id|dma32_to_cpu
c_func
(paren
id|rd-&gt;cmdstat
)paren
comma
id|dma16_to_cpu
c_func
(paren
id|rd-&gt;buff_sz
)paren
comma
id|dma16_to_cpu
c_func
(paren
id|rd-&gt;byte_cnt
)paren
comma
id|dma32_to_cpu
c_func
(paren
id|rd-&gt;buff_ptr
)paren
comma
id|dma32_to_cpu
c_func
(paren
id|rd-&gt;next
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|write_MII
id|write_MII
c_func
(paren
r_int
id|phy_addr
comma
id|u32
id|reg
comma
id|u16
id|data
)paren
(brace
r_int
id|timedout
op_assign
l_int|20
suffix:semicolon
id|u32
id|smir
op_assign
(paren
id|phy_addr
op_lshift
id|smirPhyAdBit
)paren
op_or
(paren
id|reg
op_lshift
id|smirRegAdBit
)paren
op_or
id|data
suffix:semicolon
singleline_comment|// wait for last operation to complete
r_while
c_loop
(paren
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_SMI_REG
)paren
op_amp
id|smirBusy
)paren
(brace
singleline_comment|// snooze for 1 msec and check again
id|gt96100_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: busy timeout!!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|GT96100_WRITE
c_func
(paren
id|GT96100_ETH_SMI_REG
comma
id|smir
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
singleline_comment|// These routines work, just disabled to avoid compile warnings
r_static
r_void
id|dump_tx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dbg
c_func
(paren
l_int|0
comma
l_string|&quot;%s: txno/txni/cnt=%d/%d/%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|gp-&gt;tx_next_out
comma
id|gp-&gt;tx_next_in
comma
id|gp-&gt;tx_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|dump_tx_desc
c_func
(paren
l_int|0
comma
id|dev
comma
id|i
)paren
suffix:semicolon
)brace
r_static
r_void
id|dump_rx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dbg
c_func
(paren
l_int|0
comma
l_string|&quot;%s: rxno=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|gp-&gt;rx_next_out
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|dump_rx_desc
c_func
(paren
l_int|0
comma
id|dev
comma
id|i
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_void
DECL|function|dump_MII
id|dump_MII
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|val
suffix:semicolon
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dbg_lvl
op_le
id|GT96100_DEBUG
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|read_MII
c_func
(paren
id|gp-&gt;phy_addr
comma
id|i
)paren
)paren
op_ge
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;MII Reg %d=%x&bslash;n&quot;
comma
id|i
comma
id|val
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|21
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|read_MII
c_func
(paren
id|gp-&gt;phy_addr
comma
id|i
)paren
)paren
op_ge
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;MII Reg %d=%x&bslash;n&quot;
comma
id|i
comma
id|val
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|dump_hw_addr
id|dump_hw_addr
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
comma
r_const
r_char
op_star
id|pfx
comma
r_int
r_char
op_star
id|addr_str
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|buf
(braket
l_int|100
)braket
comma
id|octet
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dbg_lvl
op_le
id|GT96100_DEBUG
)paren
(brace
id|strcpy
c_func
(paren
id|buf
comma
id|pfx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|octet
comma
l_string|&quot;%2.2x%s&quot;
comma
id|addr_str
(braket
id|i
)braket
comma
id|i
OL
l_int|5
ques
c_cond
l_string|&quot;:&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|buf
comma
id|octet
)paren
suffix:semicolon
)brace
id|info
c_func
(paren
l_string|&quot;%s&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|dump_skb
id|dump_skb
c_func
(paren
r_int
id|dbg_lvl
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|skbdata
suffix:semicolon
r_if
c_cond
(paren
id|dbg_lvl
op_le
id|GT96100_DEBUG
)paren
(brace
id|dbg
c_func
(paren
id|dbg_lvl
comma
l_string|&quot;%s: skb=%p, skb-&gt;data=%p, skb-&gt;len=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|skb
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|skbdata
op_assign
(paren
r_int
r_char
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_mod
l_int|16
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n   %3.3x: %2.2x,&quot;
comma
id|i
comma
id|skbdata
(braket
id|i
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%2.2x,&quot;
comma
id|skbdata
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|gt96100_add_hash_entry
id|gt96100_add_hash_entry
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|addr
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
singleline_comment|//u16 hashResult, stmp;
singleline_comment|//unsigned char ctmp, hash_ea[6];
id|u32
id|tblEntry1
comma
id|tblEntry0
comma
op_star
id|tblEntryAddr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tblEntry1
op_assign
id|hteValid
op_or
id|hteRD
suffix:semicolon
id|tblEntry1
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|5
)braket
op_lshift
l_int|3
suffix:semicolon
id|tblEntry1
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|4
)braket
op_lshift
l_int|11
suffix:semicolon
id|tblEntry1
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|3
)braket
op_lshift
l_int|19
suffix:semicolon
id|tblEntry1
op_or_assign
(paren
(paren
id|u32
)paren
id|addr
(braket
l_int|2
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|27
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: tblEntry1=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tblEntry1
)paren
suffix:semicolon
id|tblEntry0
op_assign
(paren
(paren
id|u32
)paren
id|addr
(braket
l_int|2
)braket
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
suffix:semicolon
id|tblEntry0
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|1
)braket
op_lshift
l_int|3
suffix:semicolon
id|tblEntry0
op_or_assign
(paren
id|u32
)paren
id|addr
(braket
l_int|0
)braket
op_lshift
l_int|11
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: tblEntry0=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tblEntry0
)paren
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|// nibble swap
id|ctmp
op_assign
id|nibswap
c_func
(paren
id|addr
(braket
id|i
)braket
)paren
suffix:semicolon
singleline_comment|// invert every nibble
id|hash_ea
(braket
id|i
)braket
op_assign
(paren
(paren
id|ctmp
op_amp
l_int|1
)paren
op_lshift
l_int|3
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|8
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|2
)paren
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|4
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|hash_ea
(braket
id|i
)braket
op_or_assign
(paren
(paren
id|ctmp
op_amp
l_int|0x10
)paren
op_lshift
l_int|3
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|0x80
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|0x20
)paren
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|ctmp
op_amp
l_int|0x40
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
id|dump_hw_addr
c_func
(paren
l_int|3
comma
id|dev
comma
l_string|&quot;%s: nib swap/invt addr=&quot;
comma
id|__FUNCTION__
comma
id|hash_ea
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;hash_mode
op_eq
l_int|0
)paren
(brace
id|hashResult
op_assign
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|0
)braket
op_amp
l_int|0xfc
)paren
op_lshift
l_int|7
suffix:semicolon
id|stmp
op_assign
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|0
)braket
op_amp
l_int|0x03
)paren
op_or
(paren
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|1
)braket
op_amp
l_int|0x7f
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|stmp
op_xor_assign
(paren
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|1
)braket
op_rshift
l_int|7
)paren
op_amp
l_int|0x01
)paren
op_or
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|2
)braket
op_lshift
l_int|1
)paren
suffix:semicolon
id|stmp
op_xor_assign
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|3
)braket
op_or
(paren
(paren
(paren
id|u16
)paren
id|hash_ea
(braket
l_int|4
)braket
op_amp
l_int|1
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|hashResult
op_or_assign
id|stmp
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// don&squot;t support hash mode 1
)brace
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: hashResult=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hashResult
)paren
suffix:semicolon
id|tblEntryAddr
op_assign
(paren
id|u32
op_star
)paren
(paren
op_amp
id|gp-&gt;hash_table
(braket
(paren
(paren
id|u32
)paren
id|hashResult
op_amp
l_int|0x7ff
)paren
op_lshift
l_int|3
)braket
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: tblEntryAddr=%p&bslash;n&quot;
comma
id|tblEntryAddr
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HASH_HOP_NUMBER
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|tblEntryAddr
op_amp
id|hteValid
)paren
op_logical_and
op_logical_neg
(paren
op_star
id|tblEntryAddr
op_amp
id|hteSkip
)paren
)paren
(brace
singleline_comment|// This entry is already occupied, go to next entry
id|tblEntryAddr
op_add_assign
l_int|2
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: skipping to %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tblEntryAddr
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|tblEntryAddr
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
id|tblEntryAddr
(braket
l_int|1
)braket
op_assign
id|cpu_to_dma32
c_func
(paren
id|tblEntry1
)paren
suffix:semicolon
id|tblEntryAddr
(braket
l_int|0
)braket
op_assign
id|cpu_to_dma32
c_func
(paren
id|tblEntry0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_ge
id|HASH_HOP_NUMBER
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: expired!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// Couldn&squot;t find an unused entry
)brace
macro_line|#else
id|tblEntryAddr
op_assign
(paren
id|u32
op_star
)paren
id|gp-&gt;hash_table
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_HASH_TABLE_SIZE
op_div
l_int|4
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|tblEntryAddr
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|cpu_to_dma32
c_func
(paren
id|tblEntry1
)paren
suffix:semicolon
id|tblEntryAddr
(braket
id|i
)braket
op_assign
id|cpu_to_dma32
c_func
(paren
id|tblEntry0
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|read_mib_counters
id|read_mib_counters
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
(brace
id|u32
op_star
id|mib_regs
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|gp-&gt;mib
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|mib_counters_t
)paren
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|i
op_increment
)paren
id|mib_regs
(braket
id|i
)braket
op_assign
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_MIB_COUNT_BASE
op_plus
id|i
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|update_stats
id|update_stats
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
(brace
id|mib_counters_t
op_star
id|mib
op_assign
op_amp
id|gp-&gt;mib
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|gp-&gt;stats
suffix:semicolon
id|read_mib_counters
c_func
(paren
id|gp
)paren
suffix:semicolon
id|stats-&gt;rx_packets
op_assign
id|mib-&gt;totalFramesReceived
suffix:semicolon
id|stats-&gt;tx_packets
op_assign
id|mib-&gt;framesSent
suffix:semicolon
id|stats-&gt;rx_bytes
op_assign
id|mib-&gt;totalByteReceived
suffix:semicolon
id|stats-&gt;tx_bytes
op_assign
id|mib-&gt;byteSent
suffix:semicolon
id|stats-&gt;rx_errors
op_assign
id|mib-&gt;totalFramesReceived
op_minus
id|mib-&gt;framesReceived
suffix:semicolon
singleline_comment|//the tx error counters are incremented by the ISR
singleline_comment|//rx_dropped incremented by gt96100_rx
singleline_comment|//tx_dropped incremented by gt96100_tx
id|stats-&gt;multicast
op_assign
id|mib-&gt;multicastFramesReceived
suffix:semicolon
singleline_comment|// collisions incremented by gt96100_tx_complete
id|stats-&gt;rx_length_errors
op_assign
id|mib-&gt;oversizeFrames
op_plus
id|mib-&gt;fragments
suffix:semicolon
singleline_comment|// The RxError condition means the Rx DMA encountered a
singleline_comment|// CPU owned descriptor, which, if things are working as
singleline_comment|// they should, means the Rx ring has overflowed.
id|stats-&gt;rx_over_errors
op_assign
id|mib-&gt;macRxError
suffix:semicolon
id|stats-&gt;rx_crc_errors
op_assign
id|mib-&gt;cRCError
suffix:semicolon
)brace
r_static
r_void
DECL|function|abort
m_abort
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|abort_bits
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|timedout
op_assign
l_int|100
suffix:semicolon
singleline_comment|// wait up to 100 msec for hard stop to complete
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// Return if neither Rx or Tx abort bits are set
r_if
c_cond
(paren
op_logical_neg
(paren
id|abort_bits
op_amp
(paren
id|sdcmrAR
op_or
id|sdcmrAT
)paren
)paren
)paren
r_return
suffix:semicolon
singleline_comment|// make sure only the Rx/Tx abort bits are set
id|abort_bits
op_and_assign
(paren
id|sdcmrAR
op_or
id|sdcmrAT
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
singleline_comment|// abort any Rx/Tx DMA immediately
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|abort_bits
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: SDMA comm = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
)paren
)paren
suffix:semicolon
singleline_comment|// wait for abort to complete
r_while
c_loop
(paren
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
)paren
op_amp
id|abort_bits
)paren
(brace
singleline_comment|// snooze for 20 msec and check again
id|gt96100_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: timeout!!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|hard_stop
id|hard_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|disable_ether_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
m_abort
(paren
id|dev
comma
id|sdcmrAR
op_or
id|sdcmrAT
)paren
suffix:semicolon
singleline_comment|// disable port
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|enable_ether_irq
id|enable_ether_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|intMask
suffix:semicolon
multiline_comment|/*&n;&t; * route ethernet interrupt to GT_SERINT0 for port 0,&n;&t; * GT_INT0 for port 1.&n;&t; */
r_int
id|intr_mask_reg
op_assign
(paren
id|gp-&gt;port_num
op_eq
l_int|0
)paren
ques
c_cond
id|GT96100_SERINT0_MASK
suffix:colon
id|GT96100_INT0_HIGH_MASK
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;chip_rev
op_ge
id|REV_GT96100A_1
)paren
(brace
id|intMask
op_assign
id|icrTxBufferLow
op_or
id|icrTxEndLow
op_or
id|icrTxErrorLow
op_or
id|icrRxOVR
op_or
id|icrTxUdr
op_or
id|icrRxBufferQ0
op_or
id|icrRxErrorQ0
op_or
id|icrMIIPhySTC
op_or
id|icrEtherIntSum
suffix:semicolon
)brace
r_else
(brace
id|intMask
op_assign
id|icrTxBufferLow
op_or
id|icrTxEndLow
op_or
id|icrTxErrorLow
op_or
id|icrRxOVR
op_or
id|icrTxUdr
op_or
id|icrRxBuffer
op_or
id|icrRxError
op_or
id|icrMIIPhySTC
op_or
id|icrEtherIntSum
suffix:semicolon
)brace
singleline_comment|// unmask interrupts
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_MASK
comma
id|intMask
)paren
suffix:semicolon
id|intMask
op_assign
id|GT96100_READ
c_func
(paren
id|intr_mask_reg
)paren
suffix:semicolon
id|intMask
op_or_assign
l_int|1
op_lshift
id|gp-&gt;port_num
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|intr_mask_reg
comma
id|intMask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|disable_ether_irq
id|disable_ether_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|intMask
suffix:semicolon
r_int
id|intr_mask_reg
op_assign
(paren
id|gp-&gt;port_num
op_eq
l_int|0
)paren
ques
c_cond
id|GT96100_SERINT0_MASK
suffix:colon
id|GT96100_INT0_HIGH_MASK
suffix:semicolon
id|intMask
op_assign
id|GT96100_READ
c_func
(paren
id|intr_mask_reg
)paren
suffix:semicolon
id|intMask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|gp-&gt;port_num
)paren
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|intr_mask_reg
comma
id|intMask
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_MASK
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Init GT96100 ethernet controller driver&n; */
DECL|function|gt96100_init_module
r_int
id|gt96100_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|retval
op_assign
l_int|0
suffix:semicolon
id|u16
id|vendor_id
comma
id|device_id
suffix:semicolon
id|u32
id|cpuConfig
suffix:semicolon
macro_line|#ifndef CONFIG_MIPS_GT96100ETH
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
singleline_comment|// probe for GT96100 by reading PCI0 vendor/device ID register
id|pcibios_read_config_word
c_func
(paren
l_int|0
comma
l_int|0
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor_id
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
l_int|0
comma
l_int|0
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendor_id
op_ne
id|PCI_VENDOR_ID_GALILEO
op_logical_or
(paren
id|device_id
op_ne
id|PCI_DEVICE_ID_GALILEO_GT96100
op_logical_and
id|device_id
op_ne
id|PCI_DEVICE_ID_GALILEO_GT96100A
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|__FILE__
l_string|&quot;: GT96100 not found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cpuConfig
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_CPU_INTERF_CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpuConfig
op_amp
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|__FILE__
l_string|&quot;: must be in Big Endian mode!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTERFACES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|retval
op_or_assign
id|gt96100_probe1
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|gt96100_probe1
id|gt96100_probe1
c_func
(paren
r_int
id|port_num
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|gt96100_if_t
op_star
id|gtif
op_assign
op_amp
id|gt96100_iflist
(braket
id|port_num
)braket
suffix:semicolon
r_int
id|phy_addr
comma
id|phy_id1
comma
id|phy_id2
suffix:semicolon
id|u32
id|phyAD
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
r_char
id|chip_rev
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|gtif-&gt;irq
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: irq unknown - probing not supported&bslash;n&quot;
comma
id|__FUNCTION_
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pcibios_read_config_byte
c_func
(paren
l_int|0
comma
l_int|0
comma
id|PCI_REVISION_ID
comma
op_amp
id|chip_rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip_rev
op_ge
id|REV_GT96100A_1
)paren
(brace
id|phyAD
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_PHY_ADDR_REG
)paren
suffix:semicolon
id|phy_addr
op_assign
(paren
id|phyAD
op_rshift
(paren
l_int|5
op_star
id|port_num
)paren
)paren
op_amp
l_int|0x1f
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * not sure what&squot;s this about -- probably &n;&t;&t; * a gt bug&n;&t;&t; */
id|phy_addr
op_assign
id|port_num
suffix:semicolon
id|phyAD
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_PHY_ADDR_REG
)paren
suffix:semicolon
id|phyAD
op_and_assign
op_complement
(paren
l_int|0x1f
op_lshift
(paren
id|port_num
op_star
l_int|5
)paren
)paren
suffix:semicolon
id|phyAD
op_or_assign
id|phy_addr
op_lshift
(paren
id|port_num
op_star
l_int|5
)paren
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|GT96100_ETH_PHY_ADDR_REG
comma
id|phyAD
)paren
suffix:semicolon
)brace
singleline_comment|// probe for the external PHY
r_if
c_cond
(paren
(paren
id|phy_id1
op_assign
id|read_MII
c_func
(paren
id|phy_addr
comma
l_int|2
)paren
)paren
op_le
l_int|0
op_logical_or
(paren
id|phy_id2
op_assign
id|read_MII
c_func
(paren
id|phy_addr
comma
l_int|3
)paren
)paren
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: no PHY found on MII%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|port_num
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|gtif-&gt;iobase
comma
id|GT96100_ETH_IO_SIZE
comma
l_string|&quot;GT96100ETH&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: request_region failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|gt96100_private
)paren
)paren
suffix:semicolon
id|gtif-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* private struct aligned and zeroed by init_etherdev */
multiline_comment|/* Fill in the &squot;dev&squot; fields. */
id|dev-&gt;base_addr
op_assign
id|gtif-&gt;iobase
suffix:semicolon
id|dev-&gt;irq
op_assign
id|gtif-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|parse_mac_addr
c_func
(paren
id|dev
comma
id|gtif-&gt;mac_str
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: MAC address parse failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
multiline_comment|/* Initialize our private structure. */
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|gp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
id|gp
suffix:semicolon
)brace
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|gp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|gp
)paren
)paren
suffix:semicolon
singleline_comment|// clear it
id|gp-&gt;port_num
op_assign
id|port_num
suffix:semicolon
id|gp-&gt;io_size
op_assign
id|GT96100_ETH_IO_SIZE
suffix:semicolon
id|gp-&gt;port_offset
op_assign
id|port_num
op_star
id|GT96100_ETH_IO_SIZE
suffix:semicolon
id|gp-&gt;phy_addr
op_assign
id|phy_addr
suffix:semicolon
id|gp-&gt;chip_rev
op_assign
id|chip_rev
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;%s found at 0x%x, irq %d&bslash;n&quot;
comma
id|chip_name
c_func
(paren
id|gp-&gt;chip_rev
)paren
comma
id|gtif-&gt;iobase
comma
id|gtif-&gt;irq
)paren
suffix:semicolon
id|dump_hw_addr
c_func
(paren
l_int|0
comma
id|dev
comma
l_string|&quot;HW Address &quot;
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;%s chip revision=%d&bslash;n&quot;
comma
id|chip_name
c_func
(paren
id|gp-&gt;chip_rev
)paren
comma
id|gp-&gt;chip_rev
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;%s ethernet port %d&bslash;n&quot;
comma
id|chip_name
c_func
(paren
id|gp-&gt;chip_rev
)paren
comma
id|gp-&gt;port_num
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;external PHY ID1=0x%04x, ID2=0x%04x&bslash;n&quot;
comma
id|phy_id1
comma
id|phy_id2
)paren
suffix:semicolon
singleline_comment|// Allocate Rx and Tx descriptor rings
r_if
c_cond
(paren
id|gp-&gt;rx_ring
op_eq
l_int|NULL
)paren
(brace
singleline_comment|// All descriptors in ring must be 16-byte aligned
id|gp-&gt;rx_ring
op_assign
id|dmaalloc
c_func
(paren
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
id|RX_RING_SIZE
op_plus
r_sizeof
(paren
id|gt96100_td_t
)paren
op_star
id|TX_RING_SIZE
comma
op_amp
id|gp-&gt;rx_ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;rx_ring
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
id|gp-&gt;tx_ring
op_assign
(paren
id|gt96100_td_t
op_star
)paren
(paren
id|gp-&gt;rx_ring
op_plus
id|RX_RING_SIZE
)paren
suffix:semicolon
id|gp-&gt;tx_ring_dma
op_assign
id|gp-&gt;rx_ring_dma
op_plus
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
id|RX_RING_SIZE
suffix:semicolon
)brace
singleline_comment|// Allocate the Rx Data Buffers
r_if
c_cond
(paren
id|gp-&gt;rx_buff
op_eq
l_int|NULL
)paren
(brace
id|gp-&gt;rx_buff
op_assign
id|dmaalloc
c_func
(paren
id|PKT_BUF_SZ
op_star
id|RX_RING_SIZE
comma
op_amp
id|gp-&gt;rx_buff_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;rx_buff
op_eq
l_int|NULL
)paren
(brace
id|dmafree
c_func
(paren
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
id|RX_RING_SIZE
op_plus
r_sizeof
(paren
id|gt96100_td_t
)paren
op_star
id|TX_RING_SIZE
comma
id|gp-&gt;rx_ring
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: rx_ring=%p, tx_ring=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|gp-&gt;rx_ring
comma
id|gp-&gt;tx_ring
)paren
suffix:semicolon
singleline_comment|// Allocate Rx Hash Table
r_if
c_cond
(paren
id|gp-&gt;hash_table
op_eq
l_int|NULL
)paren
(brace
id|gp-&gt;hash_table
op_assign
(paren
r_char
op_star
)paren
id|dmaalloc
c_func
(paren
id|RX_HASH_TABLE_SIZE
comma
op_amp
id|gp-&gt;hash_table_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;hash_table
op_eq
l_int|NULL
)paren
(brace
id|dmafree
c_func
(paren
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
id|RX_RING_SIZE
op_plus
r_sizeof
(paren
id|gt96100_td_t
)paren
op_star
id|TX_RING_SIZE
comma
id|gp-&gt;rx_ring
)paren
suffix:semicolon
id|dmafree
c_func
(paren
id|PKT_BUF_SZ
op_star
id|RX_RING_SIZE
comma
id|gp-&gt;rx_buff
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: hash=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|gp-&gt;hash_table
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|gt96100_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|gt96100_tx
suffix:semicolon
id|dev-&gt;stop
op_assign
id|gt96100_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|gt96100_get_stats
suffix:semicolon
singleline_comment|//dev-&gt;do_ioctl = gt96100_ioctl;
id|dev-&gt;set_multicast_list
op_assign
id|gt96100_set_rx_mode
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|gt96100_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|GT96100ETH_TX_TIMEOUT
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with ethernet values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|free_region
suffix:colon
id|release_region
c_func
(paren
id|gtif-&gt;iobase
comma
id|GT96100_ETH_IO_SIZE
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s failed.  Returns %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_void
DECL|function|reset_tx
id|reset_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
m_abort
(paren
id|dev
comma
id|sdcmrAT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
id|dev_kfree_skb_irq
c_func
(paren
id|gp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
r_else
id|dev_kfree_skb
c_func
(paren
id|gp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|gp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|gp-&gt;tx_ring
(braket
id|i
)braket
dot
id|cmdstat
op_assign
l_int|0
suffix:semicolon
singleline_comment|// CPU owns
id|gp-&gt;tx_ring
(braket
id|i
)braket
dot
id|byte_cnt
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;tx_ring
(braket
id|i
)braket
dot
id|buff_ptr
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;tx_ring
(braket
id|i
)braket
dot
id|next
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;tx_ring_dma
op_plus
r_sizeof
(paren
id|gt96100_td_t
)paren
op_star
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|dump_tx_desc
c_func
(paren
l_int|4
comma
id|dev
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Wrap the ring. */
id|gp-&gt;tx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;tx_ring_dma
)paren
suffix:semicolon
singleline_comment|// setup only the lowest priority TxCDP reg
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_TX_DESC_PTR0
comma
id|gp-&gt;tx_ring_dma
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_TX_DESC_PTR1
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// init Tx indeces and pkt counter
id|gp-&gt;tx_next_in
op_assign
id|gp-&gt;tx_next_out
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;tx_count
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|reset_rx
id|reset_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
m_abort
(paren
id|dev
comma
id|sdcmrAR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|gp-&gt;rx_ring
(braket
id|i
)braket
dot
id|next
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;rx_ring_dma
op_plus
r_sizeof
(paren
id|gt96100_rd_t
)paren
op_star
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|gp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buff_ptr
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;rx_buff_dma
op_plus
id|i
op_star
id|PKT_BUF_SZ
)paren
suffix:semicolon
id|gp-&gt;rx_ring
(braket
id|i
)braket
dot
id|buff_sz
op_assign
id|cpu_to_dma16
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
singleline_comment|// Give ownership to device, set first and last, enable intr
id|gp-&gt;rx_ring
(braket
id|i
)braket
dot
id|cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
(paren
id|u32
)paren
(paren
id|rxFirst
op_or
id|rxLast
op_or
id|rxOwn
op_or
id|rxEI
)paren
)paren
suffix:semicolon
id|dump_rx_desc
c_func
(paren
l_int|4
comma
id|dev
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Wrap the ring. */
id|gp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next
op_assign
id|cpu_to_dma32
c_func
(paren
id|gp-&gt;rx_ring_dma
)paren
suffix:semicolon
singleline_comment|// Setup only the lowest priority RxFDP and RxCDP regs
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_1ST_RX_DESC_PTR0
comma
id|gp-&gt;rx_ring_dma
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_RX_DESC_PTR0
comma
id|gp-&gt;rx_ring_dma
)paren
suffix:semicolon
)brace
r_else
(brace
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_1ST_RX_DESC_PTR0
op_plus
id|i
op_star
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_RX_DESC_PTR0
op_plus
id|i
op_star
l_int|4
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// init Rx NextOut index
id|gp-&gt;rx_next_out
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|// Returns 1 if the Tx counter and indeces don&squot;t gel
r_static
r_int
DECL|function|gt96100_check_tx_consistent
id|gt96100_check_tx_consistent
c_func
(paren
r_struct
id|gt96100_private
op_star
id|gp
)paren
(brace
r_int
id|diff
op_assign
id|gp-&gt;tx_next_in
op_minus
id|gp-&gt;tx_next_out
suffix:semicolon
id|diff
op_assign
id|diff
OL
l_int|0
ques
c_cond
id|TX_RING_SIZE
op_plus
id|diff
suffix:colon
id|diff
suffix:semicolon
id|diff
op_assign
id|gp-&gt;tx_count
op_eq
id|TX_RING_SIZE
ques
c_cond
id|diff
op_plus
id|TX_RING_SIZE
suffix:colon
id|diff
suffix:semicolon
r_return
(paren
id|diff
op_ne
id|gp-&gt;tx_count
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|gt96100_init
id|gt96100_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|u16
id|mii_reg
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: dev=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: scs10_lo=%4x, scs10_hi=%4x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100_READ
c_func
(paren
l_int|0x8
)paren
comma
id|GT96100_READ
c_func
(paren
l_int|0x10
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: scs32_lo=%4x, scs32_hi=%4x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100_READ
c_func
(paren
l_int|0x18
)paren
comma
id|GT96100_READ
c_func
(paren
l_int|0x20
)paren
)paren
suffix:semicolon
singleline_comment|// Stop and disable Port
id|hard_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|// Setup CIU Arbiter
id|tmp
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_CIU_ARBITER_CONFIG
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
l_int|0x0c
op_lshift
(paren
id|gp-&gt;port_num
op_star
l_int|2
)paren
)paren
suffix:semicolon
singleline_comment|// set Ether DMA req priority to hi
macro_line|#ifndef DESC_BE
id|tmp
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|31
)paren
suffix:semicolon
singleline_comment|// set desc endianess to little
macro_line|#else
id|tmp
op_or_assign
(paren
l_int|1
op_lshift
l_int|31
)paren
suffix:semicolon
macro_line|#endif
id|GT96100_WRITE
c_func
(paren
id|GT96100_CIU_ARBITER_CONFIG
comma
id|tmp
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: CIU Config=%x/%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tmp
comma
id|GT96100_READ
c_func
(paren
id|GT96100_CIU_ARBITER_CONFIG
)paren
)paren
suffix:semicolon
singleline_comment|// Set routing.
id|tmp
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_ROUTE_MAIN
)paren
op_amp
(paren
l_int|0x3f
op_lshift
l_int|18
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
l_int|0x07
op_lshift
(paren
l_int|18
op_plus
id|gp-&gt;port_num
op_star
l_int|3
)paren
)paren
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|GT96100_ROUTE_MAIN
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* set MII as peripheral func */
id|tmp
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_GPP_CONFIG2
)paren
suffix:semicolon
id|tmp
op_or_assign
l_int|0x7fff
op_lshift
(paren
id|gp-&gt;port_num
op_star
l_int|16
)paren
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|GT96100_GPP_CONFIG2
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Set up MII port pin directions */
id|tmp
op_assign
id|GT96100_READ
c_func
(paren
id|GT96100_GPP_IO2
)paren
suffix:semicolon
id|tmp
op_or_assign
l_int|0x003d
op_lshift
(paren
id|gp-&gt;port_num
op_star
l_int|16
)paren
suffix:semicolon
id|GT96100_WRITE
c_func
(paren
id|GT96100_GPP_IO2
comma
id|tmp
)paren
suffix:semicolon
singleline_comment|// Set-up hash table
id|memset
c_func
(paren
id|gp-&gt;hash_table
comma
l_int|0
comma
id|RX_HASH_TABLE_SIZE
)paren
suffix:semicolon
singleline_comment|// clear it
id|gp-&gt;hash_mode
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Add a single entry to hash table - our ethernet address
id|gt96100_add_hash_entry
c_func
(paren
id|dev
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
singleline_comment|// Set-up DMA ptr to hash table
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_HASH_TBL_PTR
comma
id|gp-&gt;hash_table_dma
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: Hash Tbl Ptr=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_HASH_TBL_PTR
)paren
)paren
suffix:semicolon
singleline_comment|// Setup Tx
id|reset_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: Curr Tx Desc Ptr0=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_TX_DESC_PTR0
)paren
)paren
suffix:semicolon
singleline_comment|// Setup Rx
id|reset_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: 1st/Curr Rx Desc Ptr0=%x/%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_1ST_RX_DESC_PTR0
)paren
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_RX_DESC_PTR0
)paren
)paren
suffix:semicolon
singleline_comment|// eth port config register
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG_EXT
comma
id|pcxrFCTL
op_or
id|pcxrFCTLen
op_or
id|pcxrFLP
op_or
id|pcxrDPLXen
)paren
suffix:semicolon
id|mii_reg
op_assign
id|read_MII
c_func
(paren
id|gp-&gt;phy_addr
comma
l_int|0x11
)paren
suffix:semicolon
multiline_comment|/* int enable register */
id|mii_reg
op_or_assign
l_int|2
suffix:semicolon
multiline_comment|/* enable mii interrupt */
id|write_MII
c_func
(paren
id|gp-&gt;phy_addr
comma
l_int|0x11
comma
id|mii_reg
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: PhyAD=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100_READ
c_func
(paren
id|GT96100_ETH_PHY_ADDR_REG
)paren
)paren
suffix:semicolon
singleline_comment|// setup DMA
singleline_comment|// We want the Rx/Tx DMA to write/read data to/from memory in
singleline_comment|// Big Endian mode. Also set DMA Burst Size to 8 64Bit words.
macro_line|#ifdef DESC_DATA_BE
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_CONFIG
comma
(paren
l_int|0xf
op_lshift
id|sdcrRCBit
)paren
op_or
id|sdcrRIFB
op_or
(paren
l_int|3
op_lshift
id|sdcrBSZBit
)paren
)paren
suffix:semicolon
macro_line|#else
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_CONFIG
comma
id|sdcrBLMR
op_or
id|sdcrBLMT
op_or
(paren
l_int|0xf
op_lshift
id|sdcrRCBit
)paren
op_or
id|sdcrRIFB
op_or
(paren
l_int|3
op_lshift
id|sdcrBSZBit
)paren
)paren
suffix:semicolon
macro_line|#endif
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: SDMA Config=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_CONFIG
)paren
)paren
suffix:semicolon
singleline_comment|// start Rx DMA
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|sdcmrERD
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: SDMA Comm=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
)paren
)paren
suffix:semicolon
singleline_comment|// enable this port (set hash size to 1/2K)
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG
comma
id|pcrEN
op_or
id|pcrHS
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: Port Config=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Disable all Type-of-Service queueing. All Rx packets will be&n;&t; * treated normally and will be sent to the lowest priority&n;&t; * queue.&n;&t; *&n;&t; * Disable flow-control for now. FIXME: support flow control?&n;&t; */
singleline_comment|// clear all the MIB ctr regs
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG_EXT
comma
id|pcxrFCTL
op_or
id|pcxrFCTLen
op_or
id|pcxrFLP
op_or
id|pcxrPRIOrxOverride
)paren
suffix:semicolon
id|read_mib_counters
c_func
(paren
id|gp
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG_EXT
comma
id|pcxrFCTL
op_or
id|pcxrFCTLen
op_or
id|pcxrFLP
op_or
id|pcxrPRIOrxOverride
op_or
id|pcxrMIBclrMode
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: Port Config Ext=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG_EXT
)paren
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dump_MII
c_func
(paren
l_int|4
comma
id|dev
)paren
suffix:semicolon
singleline_comment|// enable interrupts
id|enable_ether_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|// we should now be receiving frames
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|gt96100_open
id|gt96100_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|retval
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dbg
c_func
(paren
l_int|2
comma
l_string|&quot;%s: dev=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
singleline_comment|// Initialize and startup the GT-96100 ethernet port
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|gt96100_init
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;error in gt96100_init&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|gt96100_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;unable to get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_int|2
comma
l_string|&quot;%s: Initialization done.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|gt96100_close
id|gt96100_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: dev=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
singleline_comment|// stop the device
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hard_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|gt96100_tx
id|gt96100_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|nextIn
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|nextIn
op_assign
id|gp-&gt;tx_next_in
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: nextIn=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|nextIn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;tx_count
op_ge
id|TX_RING_SIZE
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Tx Ring full, pkt dropped.&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|gp-&gt;last_psr
op_amp
id|psrLink
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Link down, pkt dropped.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|gp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma32_to_cpu
c_func
(paren
id|gp-&gt;tx_ring
(braket
id|nextIn
)braket
dot
id|cmdstat
)paren
op_amp
id|txOwn
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: device owns descriptor, pkt dropped.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|gp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
singleline_comment|// stop the queue, so Tx timeout can fix it
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
singleline_comment|// Prepare the Descriptor at tx_next_in
id|gp-&gt;tx_skbuff
(braket
id|nextIn
)braket
op_assign
id|skb
suffix:semicolon
id|gp-&gt;tx_ring
(braket
id|nextIn
)braket
dot
id|byte_cnt
op_assign
id|cpu_to_dma16
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|gp-&gt;tx_ring
(braket
id|nextIn
)braket
dot
id|buff_ptr
op_assign
id|cpu_to_dma32
c_func
(paren
id|virt_to_phys
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
singleline_comment|// make sure packet gets written back to memory
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
(paren
id|skb-&gt;data
)paren
comma
id|skb-&gt;len
)paren
suffix:semicolon
singleline_comment|// Give ownership to device, set first and last desc, enable interrupt
singleline_comment|// Setting of ownership bit must be *last*!
id|gp-&gt;tx_ring
(braket
id|nextIn
)braket
dot
id|cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
(paren
id|u32
)paren
(paren
id|txOwn
op_or
id|txGenCRC
op_or
id|txEI
op_or
id|txPad
op_or
id|txFirst
op_or
id|txLast
)paren
)paren
suffix:semicolon
id|dump_tx_desc
c_func
(paren
l_int|4
comma
id|dev
comma
id|nextIn
)paren
suffix:semicolon
id|dump_skb
c_func
(paren
l_int|4
comma
id|dev
comma
id|skb
)paren
suffix:semicolon
singleline_comment|// increment tx_next_in with wrap
id|gp-&gt;tx_next_in
op_assign
(paren
id|nextIn
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
suffix:semicolon
singleline_comment|// If DMA is stopped, restart
r_if
c_cond
(paren
op_logical_neg
(paren
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_STATUS
)paren
op_amp
id|psrTxLow
)paren
)paren
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|sdcmrERD
op_or
id|sdcmrTXDL
)paren
suffix:semicolon
singleline_comment|// increment count and stop queue if full
r_if
c_cond
(paren
op_increment
id|gp-&gt;tx_count
op_eq
id|TX_RING_SIZE
)paren
(brace
id|gp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|2
comma
l_string|&quot;Tx Ring now full, queue stopped.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|gt96100_rx
id|gt96100_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_len
comma
id|nextOut
comma
id|cdp
suffix:semicolon
id|gt96100_rd_t
op_star
id|rd
suffix:semicolon
id|u32
id|cmdstat
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: dev=%p, status=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
comma
id|status
)paren
suffix:semicolon
id|cdp
op_assign
(paren
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_1ST_RX_DESC_PTR0
)paren
op_minus
id|gp-&gt;rx_ring_dma
)paren
op_div
r_sizeof
(paren
id|gt96100_rd_t
)paren
suffix:semicolon
singleline_comment|// Continue until we reach 1st descriptor pointer
r_for
c_loop
(paren
id|nextOut
op_assign
id|gp-&gt;rx_next_out
suffix:semicolon
id|nextOut
op_ne
id|cdp
suffix:semicolon
id|nextOut
op_assign
(paren
id|nextOut
op_plus
l_int|1
)paren
op_mod
id|RX_RING_SIZE
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|gp-&gt;intr_work_done
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|rd
op_assign
op_amp
id|gp-&gt;rx_ring
(braket
id|nextOut
)braket
suffix:semicolon
id|cmdstat
op_assign
id|dma32_to_cpu
c_func
(paren
id|rd-&gt;cmdstat
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|4
comma
l_string|&quot;%s: Rx desc cmdstat=%x, nextOut=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmdstat
comma
id|nextOut
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxOwn
)paren
(brace
singleline_comment|//err(__FUNCTION__ &quot;: device owns descriptor!&bslash;n&quot;);
singleline_comment|// DMA is not finished updating descriptor???
singleline_comment|// Leave and come back later to pick-up where
singleline_comment|// we left off.
r_break
suffix:semicolon
)brace
singleline_comment|// Drop this received pkt if there were any errors
r_if
c_cond
(paren
(paren
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
(paren
id|rxErrorSummary
)paren
)paren
op_logical_and
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
(paren
id|rxFirst
)paren
)paren
)paren
op_logical_or
(paren
id|status
op_amp
id|icrRxError
)paren
)paren
(brace
singleline_comment|// update the detailed rx error counters that
singleline_comment|// are not covered by the MIB counters.
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxOverrun
)paren
id|gp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
id|cmdstat
op_or_assign
(paren
id|u32
)paren
id|rxOwn
suffix:semicolon
id|rd-&gt;cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
id|cmdstat
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Must be first and last (ie only) descriptor of packet. We&n;&t;&t; * ignore (drop) any packets that do not fit in one descriptor.&n;&t;&t; * Every descriptor&squot;s receive buffer is large enough to hold&n;&t;&t; * the maximum 802.3 frame size, so a multi-descriptor packet&n;&t;&t; * indicates an error. Most if not all corrupted packets will&n;&t;&t; * have already been dropped by the above check for the&n;&t;&t; * rxErrorSummary status bit.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxFirst
)paren
op_logical_or
op_logical_neg
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxLast
)paren
)paren
(brace
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|rxFirst
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * This is the first descriptor of a&n;&t;&t;&t;&t; * multi-descriptor packet. It isn&squot;t corrupted&n;&t;&t;&t;&t; * because the above check for rxErrorSummary&n;&t;&t;&t;&t; * would have dropped it already, so what&squot;s&n;&t;&t;&t;&t; * the deal with this packet? Good question,&n;&t;&t;&t;&t; * let&squot;s dump it out.&n;&t;&t;&t;&t; */
id|err
c_func
(paren
l_string|&quot;%s: desc not first and last!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dump_rx_desc
c_func
(paren
l_int|0
comma
id|dev
comma
id|nextOut
)paren
suffix:semicolon
)brace
id|cmdstat
op_or_assign
(paren
id|u32
)paren
id|rxOwn
suffix:semicolon
id|rd-&gt;cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
id|cmdstat
)paren
suffix:semicolon
singleline_comment|// continue to drop every descriptor of this packet
r_continue
suffix:semicolon
)brace
id|pkt_len
op_assign
id|dma16_to_cpu
c_func
(paren
id|rd-&gt;byte_cnt
)paren
suffix:semicolon
multiline_comment|/* Create new skb. */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|gp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|cmdstat
op_or_assign
(paren
id|u32
)paren
id|rxOwn
suffix:semicolon
id|rd-&gt;cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
id|cmdstat
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte IP header align */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
op_amp
id|gp-&gt;rx_buff
(braket
id|nextOut
op_star
id|PKT_BUF_SZ
)braket
comma
id|pkt_len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|dump_skb
c_func
(paren
l_int|4
comma
id|dev
comma
id|skb
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* pass the packet to upper layers */
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
singleline_comment|// now we can release ownership of this desc back to device
id|cmdstat
op_or_assign
(paren
id|u32
)paren
id|rxOwn
suffix:semicolon
id|rd-&gt;cmdstat
op_assign
id|cpu_to_dma32
c_func
(paren
id|cmdstat
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nextOut
op_eq
id|gp-&gt;rx_next_out
)paren
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: RxCDP did not increment?&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|gp-&gt;rx_next_out
op_assign
id|nextOut
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|gt96100_tx_complete
id|gt96100_tx_complete
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|nextOut
comma
id|cdp
suffix:semicolon
id|gt96100_td_t
op_star
id|td
suffix:semicolon
id|u32
id|cmdstat
suffix:semicolon
id|cdp
op_assign
(paren
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_CURR_TX_DESC_PTR0
)paren
op_minus
id|gp-&gt;tx_ring_dma
)paren
op_div
r_sizeof
(paren
id|gt96100_td_t
)paren
suffix:semicolon
singleline_comment|// Continue until we reach the current descriptor pointer
r_for
c_loop
(paren
id|nextOut
op_assign
id|gp-&gt;tx_next_out
suffix:semicolon
id|nextOut
op_ne
id|cdp
suffix:semicolon
id|nextOut
op_assign
(paren
id|nextOut
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|gp-&gt;intr_work_done
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|td
op_assign
op_amp
id|gp-&gt;tx_ring
(braket
id|nextOut
)braket
suffix:semicolon
id|cmdstat
op_assign
id|dma32_to_cpu
c_func
(paren
id|td-&gt;cmdstat
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: Tx desc cmdstat=%x, nextOut=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmdstat
comma
id|nextOut
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txOwn
)paren
(brace
singleline_comment|//dump_tx_ring(dev);
singleline_comment|// DMA is not finished writing descriptor???
singleline_comment|// Leave and come back later to pick-up where
singleline_comment|// we left off.
r_break
suffix:semicolon
)brace
singleline_comment|// increment Tx error stats
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txErrorSummary
)paren
(brace
id|dbg
c_func
(paren
l_int|2
comma
l_string|&quot;%s: Tx error, cmdstat = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmdstat
)paren
suffix:semicolon
id|gp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txReTxLimit
)paren
id|gp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txUnderrun
)paren
id|gp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txLateCollision
)paren
id|gp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmdstat
op_amp
(paren
id|u32
)paren
id|txCollision
)paren
id|gp-&gt;stats.collisions
op_add_assign
(paren
id|u32
)paren
(paren
(paren
id|cmdstat
op_amp
id|txReTxCntMask
)paren
op_rshift
id|txReTxCntBit
)paren
suffix:semicolon
singleline_comment|// Wake the queue if the ring was full
r_if
c_cond
(paren
id|gp-&gt;tx_full
)paren
(brace
id|gp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;last_psr
op_amp
id|psrLink
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|2
comma
l_string|&quot;%s: Tx Ring was full, queue waked&bslash;n&quot;
comma
id|__FUNCTION_
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// decrement tx ring buffer count
r_if
c_cond
(paren
id|gp-&gt;tx_count
)paren
id|gp-&gt;tx_count
op_decrement
suffix:semicolon
singleline_comment|// free the skb
r_if
c_cond
(paren
id|gp-&gt;tx_skbuff
(braket
id|nextOut
)braket
)paren
(brace
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: good Tx, skb=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|gp-&gt;tx_skbuff
(braket
id|nextOut
)braket
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|gp-&gt;tx_skbuff
(braket
id|nextOut
)braket
)paren
suffix:semicolon
id|gp-&gt;tx_skbuff
(braket
id|nextOut
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;%s: no skb!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
)brace
id|gp-&gt;tx_next_out
op_assign
id|nextOut
suffix:semicolon
r_if
c_cond
(paren
id|gt96100_check_tx_consistent
c_func
(paren
id|gp
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Tx queue inconsistent!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|icrTxEndLow
)paren
op_logical_and
id|gp-&gt;tx_count
op_ne
l_int|0
)paren
(brace
singleline_comment|// we must restart the DMA
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: Restarting Tx DMA&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|sdcmrERD
op_or
id|sdcmrTXDL
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|gt96100_interrupt
id|gt96100_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|status
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: null dev ptr&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: entry, icr=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gp-&gt;intr_work_done
op_assign
id|max_interrupt_work
suffix:semicolon
r_while
c_loop
(paren
id|gp-&gt;intr_work_done
OG
l_int|0
)paren
(brace
id|status
op_assign
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
)paren
suffix:semicolon
singleline_comment|// ACK interrupts
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
comma
op_complement
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|icrEtherIntSum
)paren
op_eq
l_int|0
op_logical_and
op_logical_neg
(paren
id|status
op_amp
(paren
id|icrTxBufferLow
op_or
id|icrTxBufferHigh
op_or
id|icrRxBuffer
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|icrMIIPhySTC
)paren
(brace
id|u32
id|psr
op_assign
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;last_psr
op_ne
id|psr
)paren
(brace
id|dbg
c_func
(paren
l_int|0
comma
l_string|&quot;port status:&bslash;n&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|0
comma
l_string|&quot;    %s MBit/s, %s-duplex, &quot;
l_string|&quot;flow-control %s, link is %s,&bslash;n&quot;
comma
id|psr
op_amp
id|psrSpeed
ques
c_cond
l_string|&quot;100&quot;
suffix:colon
l_string|&quot;10&quot;
comma
id|psr
op_amp
id|psrDuplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|psr
op_amp
id|psrFctl
ques
c_cond
l_string|&quot;disabled&quot;
suffix:colon
l_string|&quot;enabled&quot;
comma
id|psr
op_amp
id|psrLink
ques
c_cond
l_string|&quot;up&quot;
suffix:colon
l_string|&quot;down&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|0
comma
l_string|&quot;    TxLowQ is %s, TxHighQ is %s, &quot;
l_string|&quot;Transmitter is %s&bslash;n&quot;
comma
id|psr
op_amp
id|psrTxLow
ques
c_cond
l_string|&quot;running&quot;
suffix:colon
l_string|&quot;stopped&quot;
comma
id|psr
op_amp
id|psrTxHigh
ques
c_cond
l_string|&quot;running&quot;
suffix:colon
l_string|&quot;stopped&quot;
comma
id|psr
op_amp
id|psrTxInProg
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|psr
op_amp
id|psrLink
)paren
op_logical_and
op_logical_neg
id|gp-&gt;tx_full
op_logical_and
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
id|dbg
c_func
(paren
l_int|0
comma
l_string|&quot;: Link up, waking queue.&bslash;n&quot;
comma
id|__FUNCTION_
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|psr
op_amp
id|psrLink
)paren
op_logical_and
op_logical_neg
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
id|dbg
c_func
(paren
l_int|0
comma
l_string|&quot;Link down, stopping queue.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|gp-&gt;last_psr
op_assign
id|psr
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|gp-&gt;intr_work_done
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|icrTxBufferLow
op_or
id|icrTxEndLow
)paren
)paren
id|gt96100_tx_complete
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|icrRxBuffer
op_or
id|icrRxError
)paren
)paren
(brace
id|gt96100_rx
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
)brace
singleline_comment|// Now check TX errors (RX errors were handled in gt96100_rx)
r_if
c_cond
(paren
id|status
op_amp
id|icrTxErrorLow
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Tx resource error&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|gp-&gt;intr_work_done
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|icrTxUdr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Tx underrun error&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|gp-&gt;intr_work_done
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|gp-&gt;intr_work_done
op_eq
l_int|0
)paren
(brace
singleline_comment|// ACK any remaining pending interrupts
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
comma
l_int|0
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: hit max work&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: exit, icr=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GT96100ETH_READ
c_func
(paren
id|gp
comma
id|GT96100_ETH_INT_CAUSE
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|gt96100_tx_timeout
id|gt96100_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|gp-&gt;last_psr
op_amp
id|psrLink
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;tx_timeout: link down.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|gt96100_check_tx_consistent
c_func
(paren
id|gp
)paren
)paren
id|err
c_func
(paren
l_string|&quot;tx_timeout: Tx ring error.&bslash;n&quot;
)paren
suffix:semicolon
id|disable_ether_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|enable_ether_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|gt96100_set_rx_mode
id|gt96100_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
singleline_comment|//struct dev_mc_list *mcptr;
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: dev=%p, flags=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
comma
id|dev-&gt;flags
)paren
suffix:semicolon
singleline_comment|// stop the Receiver DMA
m_abort
(paren
id|dev
comma
id|sdcmrAR
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_PORT_CONFIG
comma
id|pcrEN
op_or
id|pcrHS
op_or
id|pcrPM
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n;&t;  FIXME: currently multicast doesn&squot;t work - need to get hash table&n;&t;  working first.&n;&t;*/
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
singleline_comment|// clear hash table
id|memset
c_func
(paren
id|gp-&gt;hash_table
comma
l_int|0
comma
id|RX_HASH_TABLE_SIZE
)paren
suffix:semicolon
singleline_comment|// Add our ethernet address
id|gt96100_add_hash_entry
c_func
(paren
id|dev
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mcptr
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mcptr
suffix:semicolon
id|mcptr
op_assign
id|mcptr-&gt;next
)paren
(brace
id|dump_hw_addr
c_func
(paren
l_int|2
comma
id|dev
comma
id|__FUNCTION__
l_string|&quot;: addr=&quot;
comma
id|mcptr-&gt;dmi_addr
)paren
suffix:semicolon
id|gt96100_add_hash_entry
c_func
(paren
id|dev
comma
id|mcptr-&gt;dmi_addr
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
singleline_comment|// restart Rx DMA
id|GT96100ETH_WRITE
c_func
(paren
id|gp
comma
id|GT96100_ETH_SDMA_COMM
comma
id|sdcmrERD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_struct
id|net_device_stats
op_star
DECL|function|gt96100_get_stats
id|gt96100_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_int|3
comma
l_string|&quot;%s: dev=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|update_stats
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|gp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
op_amp
id|gp-&gt;stats
suffix:semicolon
)brace
DECL|function|gt96100_cleanup_module
r_static
r_void
id|gt96100_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTERFACES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gt96100_if_t
op_star
id|gtif
op_assign
op_amp
id|gt96100_iflist
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|gtif-&gt;dev
op_ne
l_int|NULL
)paren
(brace
r_struct
id|gt96100_private
op_star
id|gp
op_assign
(paren
r_struct
id|gt96100_private
op_star
)paren
id|gtif-&gt;dev-&gt;priv
suffix:semicolon
id|release_region
c_func
(paren
id|gtif-&gt;iobase
comma
id|gp-&gt;io_size
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|gtif-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gtif-&gt;dev-&gt;priv
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|gtif-&gt;dev-&gt;priv
)paren
suffix:semicolon
id|kfree
(paren
id|gtif-&gt;dev
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifndef MODULE
DECL|function|gt96100_setup
r_static
r_int
id|__init
id|gt96100_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mac0:&quot;
comma
l_int|5
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|mac0
comma
id|this_opt
op_plus
l_int|5
comma
l_int|17
)paren
suffix:semicolon
id|mac0
(braket
l_int|17
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mac1:&quot;
comma
l_int|5
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|mac1
comma
id|this_opt
op_plus
l_int|5
comma
l_int|17
)paren
suffix:semicolon
id|mac1
(braket
l_int|17
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;gt96100eth=&quot;
comma
id|gt96100_setup
)paren
suffix:semicolon
macro_line|#endif /* !MODULE */
DECL|variable|gt96100_init_module
id|module_init
c_func
(paren
id|gt96100_init_module
)paren
suffix:semicolon
DECL|variable|gt96100_cleanup_module
id|module_exit
c_func
(paren
id|gt96100_cleanup_module
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Steve Longerbeam &lt;stevel@mvista.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;GT96100 Ethernet driver&quot;
)paren
suffix:semicolon
eof
