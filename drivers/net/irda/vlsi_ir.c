multiline_comment|/*********************************************************************&n; *&n; *&t;vlsi_ir.c:&t;VLSI82C147 PCI IrDA controller driver for Linux&n; *&n; *&t;Copyright (c) 2001-2003 Martin Diehl&n; *&n; *&t;This program is free software; you can redistribute it and/or &n; *&t;modify it under the terms of the GNU General Public License as &n; *&t;published by the Free Software Foundation; either version 2 of &n; *&t;the License, or (at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License &n; *&t;along with this program; if not, write to the Free Software &n; *&t;Foundation, Inc., 59 Temple Place, Suite 330, Boston, &n; *&t;MA 02111-1307 USA&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IrDA SIR/MIR/FIR driver for VLSI 82C147&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Martin Diehl &lt;info@mdiehl.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|DRIVER_NAME
mdefine_line|#define DRIVER_NAME &quot;vlsi_ir&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v0.4a&quot;
multiline_comment|/********************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/vlsi_ir.h&gt;
multiline_comment|/********************************************************/
DECL|variable|drivername
r_static
multiline_comment|/* const */
r_char
id|drivername
(braket
)braket
op_assign
id|DRIVER_NAME
suffix:semicolon
DECL|macro|PCI_CLASS_WIRELESS_IRDA
mdefine_line|#define PCI_CLASS_WIRELESS_IRDA 0x0d00
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|vlsi_irda_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
dot
r_class
op_assign
id|PCI_CLASS_WIRELESS_IRDA
op_lshift
l_int|8
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_VLSI
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_VLSI_82C147
comma
)brace
comma
(brace
multiline_comment|/* all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|vlsi_irda_table
)paren
suffix:semicolon
multiline_comment|/********************************************************/
multiline_comment|/*&t;clksrc: which clock source to be used&n; *&t;&t;0: auto - try PLL, fallback to 40MHz XCLK&n; *&t;&t;1: on-chip 48MHz PLL&n; *&t;&t;2: external 48MHz XCLK&n; *&t;&t;3: external 40MHz XCLK (HP OB-800)&n; */
id|MODULE_PARM
c_func
(paren
id|clksrc
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|clksrc
comma
l_string|&quot;clock input source selection&quot;
)paren
suffix:semicolon
DECL|variable|clksrc
r_static
r_int
id|clksrc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default is 0(auto) */
multiline_comment|/*&t;ringsize: size of the tx and rx descriptor rings&n; *&t;&t;independent for tx and rx&n; *&t;&t;specify as ringsize=tx[,rx]&n; *&t;&t;allowed values: 4, 8, 16, 32, 64&n; *&t;&t;Due to the IrDA 1.x max. allowed window size=7,&n; *&t;&t;there should be no gain when using rings larger than 8&n; */
id|MODULE_PARM
c_func
(paren
id|ringsize
comma
l_string|&quot;1-2i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ringsize
comma
l_string|&quot;TX, RX ring descriptor size&quot;
)paren
suffix:semicolon
DECL|variable|ringsize
r_static
r_int
id|ringsize
(braket
)braket
op_assign
(brace
l_int|8
comma
l_int|8
)brace
suffix:semicolon
multiline_comment|/* default is tx=8 / rx=8 */
multiline_comment|/*&t;sirpulse: tuning of the SIR pulse width within IrPHY 1.3 limits&n; *&t;&t;0: very short, 1.5us (exception: 6us at 2.4 kbaud)&n; *&t;&t;1: nominal 3/16 bittime width&n; *&t;note: IrDA compliant peer devices should be happy regardless&n; *&t;&t;which one is used. Primary goal is to save some power&n; *&t;&t;on the sender&squot;s side - at 9.6kbaud for example the short&n; *&t;&t;pulse width saves more than 90% of the transmitted IR power.&n; */
id|MODULE_PARM
c_func
(paren
id|sirpulse
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|sirpulse
comma
l_string|&quot;SIR pulse width tuning&quot;
)paren
suffix:semicolon
DECL|variable|sirpulse
r_static
r_int
id|sirpulse
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* default is 3/16 bittime */
multiline_comment|/*&t;qos_mtt_bits: encoded min-turn-time value we require the peer device&n; *&t;&t; to use before transmitting to us. &quot;Type 1&quot; (per-station)&n; *&t;&t; bitfield according to IrLAP definition (section 6.6.8)&n; *&t;&t; Don&squot;t know which transceiver is used by my OB800 - the&n; *&t;&t; pretty common HP HDLS-1100 requires 1 msec - so lets use this.&n; */
id|MODULE_PARM
c_func
(paren
id|qos_mtt_bits
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|qos_mtt_bits
comma
l_string|&quot;IrLAP bitfield representing min-turn-time&quot;
)paren
suffix:semicolon
DECL|variable|qos_mtt_bits
r_static
r_int
id|qos_mtt_bits
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* default is 1 ms */
multiline_comment|/********************************************************/
DECL|function|vlsi_reg_debug
r_static
r_void
id|vlsi_reg_debug
c_func
(paren
r_int
id|iobase
comma
r_const
r_char
op_star
id|s
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: &quot;
comma
id|s
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x20
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
(paren
r_int
)paren
id|inb
c_func
(paren
(paren
id|iobase
op_plus
id|i
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|vlsi_ring_debug
r_static
r_void
id|vlsi_ring_debug
c_func
(paren
r_struct
id|vlsi_ring
op_star
id|r
)paren
(brace
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s - ring %p / size %u / mask 0x%04x / len %u / dir %d / hw %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|r
comma
id|r-&gt;size
comma
id|r-&gt;mask
comma
id|r-&gt;len
comma
id|r-&gt;dir
comma
id|r-&gt;rd
(braket
l_int|0
)braket
dot
id|hw
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s - head = %d / tail = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|atomic_read
c_func
(paren
op_amp
id|r-&gt;head
)paren
op_amp
id|r-&gt;mask
comma
id|atomic_read
c_func
(paren
op_amp
id|r-&gt;tail
)paren
op_amp
id|r-&gt;mask
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|r-&gt;size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rd
op_assign
op_amp
id|r-&gt;rd
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s - ring descr %u: &quot;
comma
id|__FUNCTION__
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;skb=%p data=%p hw=%p&bslash;n&quot;
comma
id|rd-&gt;skb
comma
id|rd-&gt;buf
comma
id|rd-&gt;hw
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s - hw: status=%02x count=%u addr=0x%08x&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_int
)paren
id|rd_get_status
c_func
(paren
id|rd
)paren
comma
(paren
r_int
)paren
id|rd_get_count
c_func
(paren
id|rd
)paren
comma
(paren
r_int
)paren
id|rd_get_addr
c_func
(paren
id|rd
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/********************************************************/
multiline_comment|/* needed regardless of CONFIG_PROC_FS */
DECL|variable|vlsi_proc_root
r_static
r_struct
id|proc_dir_entry
op_star
id|vlsi_proc_root
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|vlsi_proc_pdev
r_static
r_int
id|vlsi_proc_pdev
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|out
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|500
)paren
r_return
l_int|0
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;n%s (vid/did: %04x/%04x)&bslash;n&quot;
comma
id|pdev-&gt;dev.name
comma
(paren
r_int
)paren
id|pdev-&gt;vendor
comma
(paren
r_int
)paren
id|pdev-&gt;device
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;pci-power-state: %u&bslash;n&quot;
comma
(paren
r_int
)paren
id|pdev-&gt;current_state
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;resources: irq=%u / io=0x%04x / dma_mask=0x%016Lx&bslash;n&quot;
comma
id|pdev-&gt;irq
comma
(paren
r_int
)paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
(paren
id|u64
)paren
id|pdev-&gt;dma_mask
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;hw registers: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x20
suffix:semicolon
id|i
op_increment
)paren
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;%02x&quot;
comma
(paren
r_int
)paren
id|inb
c_func
(paren
(paren
id|iobase
op_plus
id|i
)paren
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|out
op_minus
id|buf
suffix:semicolon
)brace
DECL|function|vlsi_proc_ndev
r_static
r_int
id|vlsi_proc_ndev
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_char
op_star
id|out
op_assign
id|buf
suffix:semicolon
id|u8
id|byte
suffix:semicolon
id|u16
id|word
suffix:semicolon
r_int
id|delta1
comma
id|delta2
suffix:semicolon
r_struct
id|timeval
id|now
suffix:semicolon
r_int
id|iobase
op_assign
id|ndev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|1000
)paren
r_return
l_int|0
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;n%s link state: %s / %s / %s / %s&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|netif_device_present
c_func
(paren
id|ndev
)paren
ques
c_cond
l_string|&quot;attached&quot;
suffix:colon
l_string|&quot;detached&quot;
comma
id|netif_running
c_func
(paren
id|ndev
)paren
ques
c_cond
l_string|&quot;running&quot;
suffix:colon
l_string|&quot;not running&quot;
comma
id|netif_carrier_ok
c_func
(paren
id|ndev
)paren
ques
c_cond
l_string|&quot;carrier ok&quot;
suffix:colon
l_string|&quot;no carrier&quot;
comma
id|netif_queue_stopped
c_func
(paren
id|ndev
)paren
ques
c_cond
l_string|&quot;queue stopped&quot;
suffix:colon
l_string|&quot;queue running&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|ndev
)paren
)paren
r_return
id|out
op_minus
id|buf
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;nhw-state:&bslash;n&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|idev-&gt;pdev
comma
id|VLSI_PCI_IRMISC
comma
op_amp
id|byte
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;IRMISC:%s%s%s UART%s&quot;
comma
(paren
id|byte
op_amp
id|IRMISC_IRRAIL
)paren
ques
c_cond
l_string|&quot; irrail&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRMISC_IRPD
)paren
ques
c_cond
l_string|&quot; irpd&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRMISC_UARTTST
)paren
ques
c_cond
l_string|&quot; uarttest&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRMISC_UARTEN
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot; disabled&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|byte
op_amp
id|IRMISC_UARTEN
)paren
(brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;@0x%s&bslash;n&quot;
comma
(paren
id|byte
op_amp
l_int|2
)paren
ques
c_cond
(paren
(paren
id|byte
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;3e8&quot;
suffix:colon
l_string|&quot;2e8&quot;
)paren
suffix:colon
(paren
(paren
id|byte
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;3f8&quot;
suffix:colon
l_string|&quot;2f8&quot;
)paren
)paren
suffix:semicolon
)brace
id|pci_read_config_byte
c_func
(paren
id|idev-&gt;pdev
comma
id|VLSI_PCI_CLKCTL
comma
op_amp
id|byte
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;CLKCTL: PLL %s%s%s / clock %s / wakeup %s&bslash;n&quot;
comma
(paren
id|byte
op_amp
id|CLKCTL_PD_INV
)paren
ques
c_cond
l_string|&quot;powered&quot;
suffix:colon
l_string|&quot;down&quot;
comma
(paren
id|byte
op_amp
id|CLKCTL_LOCK
)paren
ques
c_cond
l_string|&quot; locked&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|CLKCTL_EXTCLK
)paren
ques
c_cond
(paren
(paren
id|byte
op_amp
id|CLKCTL_XCKSEL
)paren
ques
c_cond
l_string|&quot; / 40 MHz XCLK&quot;
suffix:colon
l_string|&quot; / 48 MHz XCLK&quot;
)paren
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|CLKCTL_CLKSTP
)paren
ques
c_cond
l_string|&quot;stopped&quot;
suffix:colon
l_string|&quot;running&quot;
comma
(paren
id|byte
op_amp
id|CLKCTL_WAKE
)paren
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|idev-&gt;pdev
comma
id|VLSI_PCI_MSTRPAGE
comma
op_amp
id|byte
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;MSTRPAGE: 0x%02x&bslash;n&quot;
comma
(paren
r_int
)paren
id|byte
)paren
suffix:semicolon
id|byte
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRINTR
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;IRINTR:%s%s%s%s%s%s%s%s&bslash;n&quot;
comma
(paren
id|byte
op_amp
id|IRINTR_ACTEN
)paren
ques
c_cond
l_string|&quot; ACTEN&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRINTR_RPKTEN
)paren
ques
c_cond
l_string|&quot; RPKTEN&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRINTR_TPKTEN
)paren
ques
c_cond
l_string|&quot; TPKTEN&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRINTR_OE_EN
)paren
ques
c_cond
l_string|&quot; OE_EN&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRINTR_ACTIVITY
)paren
ques
c_cond
l_string|&quot; ACTIVITY&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRINTR_RPKTINT
)paren
ques
c_cond
l_string|&quot; RPKTINT&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRINTR_TPKTINT
)paren
ques
c_cond
l_string|&quot; TPKTINT&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|byte
op_amp
id|IRINTR_OE_INT
)paren
ques
c_cond
l_string|&quot; OE_INT&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_RINGPTR
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;RINGPTR: rx=%u / tx=%u&bslash;n&quot;
comma
id|RINGPTR_GET_RX
c_func
(paren
id|word
)paren
comma
id|RINGPTR_GET_TX
c_func
(paren
id|word
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_RINGBASE
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;RINGBASE: busmap=0x%08x&bslash;n&quot;
comma
(paren
(paren
r_int
)paren
id|word
op_lshift
l_int|10
)paren
op_or
(paren
id|MSTRPAGE_VALUE
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_RINGSIZE
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;RINGSIZE: rx=%u / tx=%u&bslash;n&quot;
comma
id|RINGSIZE_TO_RXSIZE
c_func
(paren
id|word
)paren
comma
id|RINGSIZE_TO_TXSIZE
c_func
(paren
id|word
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;IRCFG:%s%s%s%s%s%s%s%s%s%s%s%s%s&bslash;n&quot;
comma
(paren
id|word
op_amp
id|IRCFG_LOOP
)paren
ques
c_cond
l_string|&quot; LOOP&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_ENTX
)paren
ques
c_cond
l_string|&quot; ENTX&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_ENRX
)paren
ques
c_cond
l_string|&quot; ENRX&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_MSTR
)paren
ques
c_cond
l_string|&quot; MSTR&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_RXANY
)paren
ques
c_cond
l_string|&quot; RXANY&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_CRC16
)paren
ques
c_cond
l_string|&quot; CRC16&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_FIR
)paren
ques
c_cond
l_string|&quot; FIR&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_MIR
)paren
ques
c_cond
l_string|&quot; MIR&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_SIR
)paren
ques
c_cond
l_string|&quot; SIR&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_SIRFILT
)paren
ques
c_cond
l_string|&quot; SIRFILT&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_SIRTEST
)paren
ques
c_cond
l_string|&quot; SIRTEST&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_TXPOL
)paren
ques
c_cond
l_string|&quot; TXPOL&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRCFG_RXPOL
)paren
ques
c_cond
l_string|&quot; RXPOL&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRENABLE
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;IRENABLE:%s%s%s%s%s%s%s%s&bslash;n&quot;
comma
(paren
id|word
op_amp
id|IRENABLE_IREN
)paren
ques
c_cond
l_string|&quot; IRENABLE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRENABLE_CFGER
)paren
ques
c_cond
l_string|&quot; CFGERR&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRENABLE_FIR_ON
)paren
ques
c_cond
l_string|&quot; FIR_ON&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRENABLE_MIR_ON
)paren
ques
c_cond
l_string|&quot; MIR_ON&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRENABLE_SIR_ON
)paren
ques
c_cond
l_string|&quot; SIR_ON&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRENABLE_ENTXST
)paren
ques
c_cond
l_string|&quot; ENTXST&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRENABLE_ENRXST
)paren
ques
c_cond
l_string|&quot; ENRXST&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|word
op_amp
id|IRENABLE_CRC16_ON
)paren
ques
c_cond
l_string|&quot; CRC16_ON&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_PHYCTL
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;PHYCTL: baud-divisor=%u / pulsewidth=%u / preamble=%u&bslash;n&quot;
comma
(paren
r_int
)paren
id|PHYCTL_TO_BAUD
c_func
(paren
id|word
)paren
comma
(paren
r_int
)paren
id|PHYCTL_TO_PLSWID
c_func
(paren
id|word
)paren
comma
(paren
r_int
)paren
id|PHYCTL_TO_PREAMB
c_func
(paren
id|word
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_NPHYCTL
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;NPHYCTL: baud-divisor=%u / pulsewidth=%u / preamble=%u&bslash;n&quot;
comma
(paren
r_int
)paren
id|PHYCTL_TO_BAUD
c_func
(paren
id|word
)paren
comma
(paren
r_int
)paren
id|PHYCTL_TO_PLSWID
c_func
(paren
id|word
)paren
comma
(paren
r_int
)paren
id|PHYCTL_TO_PREAMB
c_func
(paren
id|word
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_MAXPKT
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;MAXPKT: max. rx packet size = %u&bslash;n&quot;
comma
id|word
)paren
suffix:semicolon
id|word
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_RCVBCNT
)paren
op_amp
id|RCVBCNT_MASK
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;RCVBCNT: rx-fifo filling level = %u&bslash;n&quot;
comma
id|word
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;nsw-state:&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;IrPHY setup: %d baud - %s encoding&bslash;n&quot;
comma
id|idev-&gt;baud
comma
(paren
id|idev-&gt;mode
op_eq
id|IFF_SIR
)paren
ques
c_cond
l_string|&quot;SIR&quot;
suffix:colon
(paren
(paren
id|idev-&gt;mode
op_eq
id|IFF_MIR
)paren
ques
c_cond
l_string|&quot;MIR&quot;
suffix:colon
l_string|&quot;FIR&quot;
)paren
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
r_if
c_cond
(paren
id|now.tv_usec
op_ge
id|idev-&gt;last_rx.tv_usec
)paren
(brace
id|delta2
op_assign
id|now.tv_usec
op_minus
id|idev-&gt;last_rx.tv_usec
suffix:semicolon
id|delta1
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|delta2
op_assign
l_int|1000000
op_plus
id|now.tv_usec
op_minus
id|idev-&gt;last_rx.tv_usec
suffix:semicolon
id|delta1
op_assign
l_int|1
suffix:semicolon
)brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;last rx: %lu.%06u sec&bslash;n&quot;
comma
id|now.tv_sec
op_minus
id|idev-&gt;last_rx.tv_sec
op_minus
id|delta1
comma
id|delta2
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;RX: packets=%lu / bytes=%lu / errors=%lu / dropped=%lu&quot;
comma
id|idev-&gt;stats.rx_packets
comma
id|idev-&gt;stats.rx_bytes
comma
id|idev-&gt;stats.rx_errors
comma
id|idev-&gt;stats.rx_dropped
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot; / overrun=%lu / length=%lu / frame=%lu / crc=%lu&bslash;n&quot;
comma
id|idev-&gt;stats.rx_over_errors
comma
id|idev-&gt;stats.rx_length_errors
comma
id|idev-&gt;stats.rx_frame_errors
comma
id|idev-&gt;stats.rx_crc_errors
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;TX: packets=%lu / bytes=%lu / errors=%lu / dropped=%lu / fifo=%lu&bslash;n&quot;
comma
id|idev-&gt;stats.tx_packets
comma
id|idev-&gt;stats.tx_bytes
comma
id|idev-&gt;stats.tx_errors
comma
id|idev-&gt;stats.tx_dropped
comma
id|idev-&gt;stats.tx_fifo_errors
)paren
suffix:semicolon
r_return
id|out
op_minus
id|buf
suffix:semicolon
)brace
DECL|function|vlsi_proc_ring
r_static
r_int
id|vlsi_proc_ring
c_func
(paren
r_struct
id|vlsi_ring
op_star
id|r
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|h
comma
id|t
suffix:semicolon
r_char
op_star
id|out
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|3000
)paren
r_return
l_int|0
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;size %u / mask 0x%04x / len %u / dir %d / hw %p&bslash;n&quot;
comma
id|r-&gt;size
comma
id|r-&gt;mask
comma
id|r-&gt;len
comma
id|r-&gt;dir
comma
id|r-&gt;rd
(braket
l_int|0
)braket
dot
id|hw
)paren
suffix:semicolon
id|h
op_assign
id|atomic_read
c_func
(paren
op_amp
id|r-&gt;head
)paren
op_amp
id|r-&gt;mask
suffix:semicolon
id|t
op_assign
id|atomic_read
c_func
(paren
op_amp
id|r-&gt;tail
)paren
op_amp
id|r-&gt;mask
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;head = %d / tail = %d &quot;
comma
id|h
comma
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h
op_eq
id|t
)paren
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;(empty)&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
(paren
(paren
id|t
op_plus
l_int|1
)paren
op_amp
id|r-&gt;mask
)paren
op_eq
id|h
)paren
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;(full)&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;(level = %d)&bslash;n&quot;
comma
(paren
(paren
r_int
)paren
(paren
id|t
op_minus
id|h
)paren
op_amp
id|r-&gt;mask
)paren
)paren
suffix:semicolon
id|rd
op_assign
op_amp
id|r-&gt;rd
(braket
id|h
)braket
suffix:semicolon
id|j
op_assign
(paren
r_int
)paren
id|rd_get_count
c_func
(paren
id|rd
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;current: rd = %d / status = %02x / len = %u&bslash;n&quot;
comma
id|h
comma
(paren
r_int
)paren
id|rd_get_status
c_func
(paren
id|rd
)paren
comma
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
OG
l_int|0
)paren
(brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;   data:&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
OG
l_int|20
)paren
id|j
op_assign
l_int|20
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|j
suffix:semicolon
id|i
op_increment
)paren
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot; %02x&quot;
comma
(paren
r_int
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|rd-&gt;buf
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|r-&gt;size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rd
op_assign
op_amp
id|r-&gt;rd
(braket
id|i
)braket
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&gt; ring descr %u: &quot;
comma
id|i
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;skb=%p data=%p hw=%p&bslash;n&quot;
comma
id|rd-&gt;skb
comma
id|rd-&gt;buf
comma
id|rd-&gt;hw
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;  hw: status=%02x count=%u busaddr=0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|rd_get_status
c_func
(paren
id|rd
)paren
comma
(paren
r_int
)paren
id|rd_get_count
c_func
(paren
id|rd
)paren
comma
(paren
r_int
)paren
id|rd_get_addr
c_func
(paren
id|rd
)paren
)paren
suffix:semicolon
)brace
r_return
id|out
op_minus
id|buf
suffix:semicolon
)brace
DECL|function|vlsi_proc_print
r_static
r_int
id|vlsi_proc_print
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
op_star
id|out
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ndev
op_logical_or
op_logical_neg
id|ndev-&gt;priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid ptr!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|8000
)paren
r_return
l_int|0
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;n%s %s&bslash;n&bslash;n&quot;
comma
id|DRIVER_NAME
comma
id|DRIVER_VERSION
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;clksrc: %s&bslash;n&quot;
comma
(paren
id|clksrc
op_ge
l_int|2
)paren
ques
c_cond
(paren
(paren
id|clksrc
op_eq
l_int|3
)paren
ques
c_cond
l_string|&quot;40MHz XCLK&quot;
suffix:colon
l_string|&quot;48MHz XCLK&quot;
)paren
suffix:colon
(paren
(paren
id|clksrc
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;48MHz PLL&quot;
suffix:colon
l_string|&quot;autodetect&quot;
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;ringsize: tx=%d / rx=%d&bslash;n&quot;
comma
id|ringsize
(braket
l_int|0
)braket
comma
id|ringsize
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;sirpulse: %s&bslash;n&quot;
comma
(paren
id|sirpulse
)paren
ques
c_cond
l_string|&quot;3/16 bittime&quot;
suffix:colon
l_string|&quot;short&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;qos_mtt_bits: 0x%02x&bslash;n&quot;
comma
(paren
r_int
)paren
id|qos_mtt_bits
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;pdev
op_ne
l_int|NULL
)paren
(brace
id|out
op_add_assign
id|vlsi_proc_pdev
c_func
(paren
id|idev-&gt;pdev
comma
id|out
comma
id|len
op_minus
(paren
id|out
op_minus
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;pdev-&gt;current_state
op_eq
l_int|0
)paren
id|out
op_add_assign
id|vlsi_proc_ndev
c_func
(paren
id|ndev
comma
id|out
comma
id|len
op_minus
(paren
id|out
op_minus
id|buf
)paren
)paren
suffix:semicolon
r_else
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;nPCI controller down - resume_ok = %d&bslash;n&quot;
comma
id|idev-&gt;resume_ok
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|ndev
)paren
op_logical_and
id|idev-&gt;rx_ring
op_logical_and
id|idev-&gt;tx_ring
)paren
(brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;n--------- RX ring -----------&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|vlsi_proc_ring
c_func
(paren
id|idev-&gt;rx_ring
comma
id|out
comma
id|len
op_minus
(paren
id|out
op_minus
id|buf
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;n--------- TX ring -----------&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|vlsi_proc_ring
c_func
(paren
id|idev-&gt;tx_ring
comma
id|out
comma
id|len
op_minus
(paren
id|out
op_minus
id|buf
)paren
)paren
suffix:semicolon
)brace
)brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|out
op_minus
id|buf
suffix:semicolon
)brace
DECL|struct|vlsi_proc_data
r_struct
id|vlsi_proc_data
(brace
DECL|member|size
r_int
id|size
suffix:semicolon
DECL|member|data
r_char
op_star
id|data
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* most of the proc-fops code borrowed from usb/uhci */
DECL|function|vlsi_proc_open
r_static
r_int
id|vlsi_proc_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_const
r_struct
id|proc_dir_entry
op_star
id|pde
op_assign
id|PDE
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pde-&gt;data
suffix:semicolon
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_struct
id|vlsi_proc_data
op_star
id|procdata
suffix:semicolon
r_const
r_int
id|maxdata
op_assign
l_int|8000
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|procdata
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|procdata
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|procdata
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|procdata-&gt;data
op_assign
id|kmalloc
c_func
(paren
id|maxdata
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|procdata-&gt;data
)paren
(brace
id|kfree
c_func
(paren
id|procdata
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|procdata-&gt;size
op_assign
id|vlsi_proc_print
c_func
(paren
id|ndev
comma
id|procdata-&gt;data
comma
id|maxdata
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|procdata
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_proc_lseek
r_static
id|loff_t
id|vlsi_proc_lseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|off
comma
r_int
id|whence
)paren
(brace
r_struct
id|vlsi_proc_data
op_star
id|procdata
suffix:semicolon
id|loff_t
r_new
op_assign
op_minus
l_int|1
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|procdata
op_assign
id|file-&gt;private_data
suffix:semicolon
r_switch
c_cond
(paren
id|whence
)paren
(brace
r_case
l_int|0
suffix:colon
r_new
op_assign
id|off
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_new
op_assign
id|file-&gt;f_pos
op_plus
id|off
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
r_new
template_param
id|procdata-&gt;size
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|file-&gt;f_pos
op_assign
r_new
)paren
suffix:semicolon
)brace
DECL|function|vlsi_proc_read
r_static
id|ssize_t
id|vlsi_proc_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|nbytes
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|vlsi_proc_data
op_star
id|procdata
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|pos
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|pos
op_assign
op_star
id|ppos
suffix:semicolon
id|size
op_assign
id|procdata-&gt;size
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_ge
id|size
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nbytes
op_ge
id|size
)paren
id|nbytes
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_plus
id|nbytes
OG
id|size
)paren
id|nbytes
op_assign
id|size
op_minus
id|pos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|nbytes
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buf
comma
id|procdata-&gt;data
op_plus
id|pos
comma
id|nbytes
)paren
suffix:semicolon
op_star
id|ppos
op_add_assign
id|nbytes
suffix:semicolon
r_return
id|nbytes
suffix:semicolon
)brace
DECL|function|vlsi_proc_release
r_static
r_int
id|vlsi_proc_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|vlsi_proc_data
op_star
id|procdata
op_assign
id|file-&gt;private_data
suffix:semicolon
id|kfree
c_func
(paren
id|procdata-&gt;data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|procdata
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|vlsi_proc_fops
r_static
r_struct
id|file_operations
id|vlsi_proc_fops
op_assign
(brace
multiline_comment|/* protect individual procdir file entry against rmmod */
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|vlsi_proc_open
comma
dot
id|llseek
op_assign
id|vlsi_proc_lseek
comma
dot
id|read
op_assign
id|vlsi_proc_read
comma
dot
id|release
op_assign
id|vlsi_proc_release
comma
)brace
suffix:semicolon
DECL|macro|VLSI_PROC_FOPS
mdefine_line|#define VLSI_PROC_FOPS&t;&t;(&amp;vlsi_proc_fops)
macro_line|#else&t;/* CONFIG_PROC_FS */
DECL|macro|VLSI_PROC_FOPS
mdefine_line|#define VLSI_PROC_FOPS&t;&t;NULL
macro_line|#endif
multiline_comment|/********************************************************/
DECL|function|vlsi_alloc_ring
r_static
r_struct
id|vlsi_ring
op_star
id|vlsi_alloc_ring
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|ring_descr_hw
op_star
id|hwmap
comma
r_int
id|size
comma
r_int
id|len
comma
r_int
id|dir
)paren
(brace
r_struct
id|vlsi_ring
op_star
id|r
suffix:semicolon
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|dma_addr_t
id|busaddr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|size
op_logical_or
(paren
(paren
id|size
op_minus
l_int|1
)paren
op_amp
id|size
)paren
op_ne
l_int|0
)paren
multiline_comment|/* must be &gt;0 and power of 2 */
r_return
l_int|NULL
suffix:semicolon
id|r
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|r
)paren
op_plus
id|size
op_star
r_sizeof
(paren
r_struct
id|ring_descr
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|r
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|r
)paren
)paren
suffix:semicolon
id|r-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|r-&gt;dir
op_assign
id|dir
suffix:semicolon
id|r-&gt;len
op_assign
id|len
suffix:semicolon
id|r-&gt;rd
op_assign
(paren
r_struct
id|ring_descr
op_star
)paren
(paren
id|r
op_plus
l_int|1
)paren
suffix:semicolon
id|r-&gt;mask
op_assign
id|size
op_minus
l_int|1
suffix:semicolon
id|r-&gt;size
op_assign
id|size
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|r-&gt;head
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|r-&gt;tail
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rd
op_assign
id|r-&gt;rd
op_plus
id|i
suffix:semicolon
id|memset
c_func
(paren
id|rd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|rd
)paren
)paren
suffix:semicolon
id|rd-&gt;hw
op_assign
id|hwmap
op_plus
id|i
suffix:semicolon
id|rd-&gt;buf
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;buf
op_eq
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
(brace
id|rd
op_assign
id|r-&gt;rd
op_plus
id|j
suffix:semicolon
id|busaddr
op_assign
id|rd_get_addr
c_func
(paren
id|rd
)paren
suffix:semicolon
id|rd_set_addr_status
c_func
(paren
id|rd
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busaddr
)paren
id|pci_unmap_single
c_func
(paren
id|pdev
comma
id|busaddr
comma
id|len
comma
id|dir
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rd-&gt;buf
)paren
suffix:semicolon
id|rd-&gt;buf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|r
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|busaddr
op_assign
id|pci_map_single
c_func
(paren
id|pdev
comma
id|rd-&gt;buf
comma
id|len
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|busaddr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: failed to create PCI-MAP for %p&quot;
comma
id|__FUNCTION__
comma
id|rd-&gt;buf
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|rd_set_addr_status
c_func
(paren
id|rd
comma
id|busaddr
comma
l_int|0
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|pdev
comma
id|busaddr
comma
id|len
comma
id|dir
)paren
suffix:semicolon
multiline_comment|/* initially, the dma buffer is owned by the CPU */
id|rd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|r
suffix:semicolon
)brace
DECL|function|vlsi_free_ring
r_static
r_int
id|vlsi_free_ring
c_func
(paren
r_struct
id|vlsi_ring
op_star
id|r
)paren
(brace
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dma_addr_t
id|busaddr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|r-&gt;size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rd
op_assign
id|r-&gt;rd
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;skb
)paren
id|dev_kfree_skb_any
c_func
(paren
id|rd-&gt;skb
)paren
suffix:semicolon
id|busaddr
op_assign
id|rd_get_addr
c_func
(paren
id|rd
)paren
suffix:semicolon
id|rd_set_addr_status
c_func
(paren
id|rd
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busaddr
)paren
id|pci_unmap_single
c_func
(paren
id|r-&gt;pdev
comma
id|busaddr
comma
id|r-&gt;len
comma
id|r-&gt;dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;buf
)paren
id|kfree
c_func
(paren
id|rd-&gt;buf
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|r
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_create_hwif
r_static
r_int
id|vlsi_create_hwif
c_func
(paren
id|vlsi_irda_dev_t
op_star
id|idev
)paren
(brace
r_char
op_star
id|ringarea
suffix:semicolon
r_struct
id|ring_descr_hw
op_star
id|hwmap
suffix:semicolon
id|idev-&gt;virtaddr
op_assign
l_int|NULL
suffix:semicolon
id|idev-&gt;busaddr
op_assign
l_int|0
suffix:semicolon
id|ringarea
op_assign
id|pci_alloc_consistent
c_func
(paren
id|idev-&gt;pdev
comma
id|HW_RING_AREA_SIZE
comma
op_amp
id|idev-&gt;busaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ringarea
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: insufficient memory for descriptor rings&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ringarea
comma
l_int|0
comma
id|HW_RING_AREA_SIZE
)paren
suffix:semicolon
id|hwmap
op_assign
(paren
r_struct
id|ring_descr_hw
op_star
)paren
id|ringarea
suffix:semicolon
id|idev-&gt;rx_ring
op_assign
id|vlsi_alloc_ring
c_func
(paren
id|idev-&gt;pdev
comma
id|hwmap
comma
id|ringsize
(braket
l_int|1
)braket
comma
id|XFER_BUF_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;rx_ring
op_eq
l_int|NULL
)paren
r_goto
id|out_unmap
suffix:semicolon
id|hwmap
op_add_assign
id|MAX_RING_DESCR
suffix:semicolon
id|idev-&gt;tx_ring
op_assign
id|vlsi_alloc_ring
c_func
(paren
id|idev-&gt;pdev
comma
id|hwmap
comma
id|ringsize
(braket
l_int|0
)braket
comma
id|XFER_BUF_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;tx_ring
op_eq
l_int|NULL
)paren
r_goto
id|out_free_rx
suffix:semicolon
id|idev-&gt;virtaddr
op_assign
id|ringarea
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free_rx
suffix:colon
id|vlsi_free_ring
c_func
(paren
id|idev-&gt;rx_ring
)paren
suffix:semicolon
id|out_unmap
suffix:colon
id|idev-&gt;rx_ring
op_assign
id|idev-&gt;tx_ring
op_assign
l_int|NULL
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|idev-&gt;pdev
comma
id|HW_RING_AREA_SIZE
comma
id|ringarea
comma
id|idev-&gt;busaddr
)paren
suffix:semicolon
id|idev-&gt;busaddr
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|vlsi_destroy_hwif
r_static
r_int
id|vlsi_destroy_hwif
c_func
(paren
id|vlsi_irda_dev_t
op_star
id|idev
)paren
(brace
id|vlsi_free_ring
c_func
(paren
id|idev-&gt;rx_ring
)paren
suffix:semicolon
id|vlsi_free_ring
c_func
(paren
id|idev-&gt;tx_ring
)paren
suffix:semicolon
id|idev-&gt;rx_ring
op_assign
id|idev-&gt;tx_ring
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;busaddr
)paren
id|pci_free_consistent
c_func
(paren
id|idev-&gt;pdev
comma
id|HW_RING_AREA_SIZE
comma
id|idev-&gt;virtaddr
comma
id|idev-&gt;busaddr
)paren
suffix:semicolon
id|idev-&gt;virtaddr
op_assign
l_int|NULL
suffix:semicolon
id|idev-&gt;busaddr
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/********************************************************/
DECL|function|vlsi_process_rx
r_static
r_int
id|vlsi_process_rx
c_func
(paren
r_struct
id|vlsi_ring
op_star
id|r
comma
r_struct
id|ring_descr
op_star
id|rd
)paren
(brace
id|u16
id|status
suffix:semicolon
r_int
id|crclen
comma
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|r-&gt;pdev
)paren
suffix:semicolon
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|r-&gt;pdev
comma
id|rd_get_addr
c_func
(paren
id|rd
)paren
comma
id|r-&gt;len
comma
id|r-&gt;dir
)paren
suffix:semicolon
multiline_comment|/* dma buffer now owned by the CPU */
id|status
op_assign
id|rd_get_status
c_func
(paren
id|rd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RD_RX_ERROR
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|RD_RX_OVER
)paren
id|ret
op_or_assign
id|VLSI_RX_OVER
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RD_RX_LENGTH
)paren
id|ret
op_or_assign
id|VLSI_RX_LENGTH
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RD_RX_PHYERR
)paren
id|ret
op_or_assign
id|VLSI_RX_FRAME
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RD_RX_CRCERR
)paren
id|ret
op_or_assign
id|VLSI_RX_CRC
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|rd_get_count
c_func
(paren
id|rd
)paren
suffix:semicolon
id|crclen
op_assign
(paren
id|idev-&gt;mode
op_eq
id|IFF_FIR
)paren
ques
c_cond
r_sizeof
(paren
id|u32
)paren
suffix:colon
r_sizeof
(paren
id|u16
)paren
suffix:semicolon
id|len
op_sub_assign
id|crclen
suffix:semicolon
multiline_comment|/* remove trailing CRC */
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: strange frame (len=%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
)paren
suffix:semicolon
id|ret
op_or_assign
id|VLSI_RX_DROP
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|rd-&gt;skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: rx packet dropped&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ret
op_or_assign
id|VLSI_RX_DROP
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|rd-&gt;skb
suffix:semicolon
id|rd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|skb-&gt;dev
op_assign
id|ndev
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|rd-&gt;buf
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_else
id|netif_rx_ni
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ndev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
id|rd_set_status
c_func
(paren
id|rd
comma
l_int|0
)paren
suffix:semicolon
id|rd_set_count
c_func
(paren
id|rd
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* buffer still owned by CPU */
r_return
(paren
id|ret
)paren
ques
c_cond
op_minus
id|ret
suffix:colon
id|len
suffix:semicolon
)brace
DECL|function|vlsi_fill_rx
r_static
r_void
id|vlsi_fill_rx
c_func
(paren
r_struct
id|vlsi_ring
op_star
id|r
)paren
(brace
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
id|ring_last
c_func
(paren
id|r
)paren
suffix:semicolon
id|rd
op_ne
l_int|NULL
suffix:semicolon
id|rd
op_assign
id|ring_put
c_func
(paren
id|r
)paren
)paren
(brace
r_if
c_cond
(paren
id|rd_is_active
c_func
(paren
id|rd
)paren
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rd-&gt;skb
)paren
(brace
id|rd-&gt;skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|IRLAP_SKB_ALLOCSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;skb
)paren
(brace
id|skb_reserve
c_func
(paren
id|rd-&gt;skb
comma
l_int|1
)paren
suffix:semicolon
id|rd-&gt;skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
multiline_comment|/* probably not worth logging? */
)brace
multiline_comment|/* give dma buffer back to busmaster */
id|pci_dma_prep_single
c_func
(paren
id|r-&gt;pdev
comma
id|rd_get_addr
c_func
(paren
id|rd
)paren
comma
id|r-&gt;len
comma
id|r-&gt;dir
)paren
suffix:semicolon
id|rd_activate
c_func
(paren
id|rd
)paren
suffix:semicolon
)brace
)brace
DECL|function|vlsi_rx_interrupt
r_static
r_void
id|vlsi_rx_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_struct
id|vlsi_ring
op_star
id|r
op_assign
id|idev-&gt;rx_ring
suffix:semicolon
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
id|ring_first
c_func
(paren
id|r
)paren
suffix:semicolon
id|rd
op_ne
l_int|NULL
suffix:semicolon
id|rd
op_assign
id|ring_get
c_func
(paren
id|r
)paren
)paren
(brace
r_if
c_cond
(paren
id|rd_is_active
c_func
(paren
id|rd
)paren
)paren
r_break
suffix:semicolon
id|ret
op_assign
id|vlsi_process_rx
c_func
(paren
id|r
comma
id|rd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ret
suffix:semicolon
id|idev-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_DROP
)paren
id|idev-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_OVER
)paren
id|idev-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_LENGTH
)paren
id|idev-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_FRAME
)paren
id|idev-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_CRC
)paren
id|idev-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|idev-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|idev-&gt;stats.rx_bytes
op_add_assign
id|ret
suffix:semicolon
)brace
)brace
id|do_gettimeofday
c_func
(paren
op_amp
id|idev-&gt;last_rx
)paren
suffix:semicolon
multiline_comment|/* remember &quot;now&quot; for later mtt delay */
id|vlsi_fill_rx
c_func
(paren
id|r
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring_first
c_func
(paren
id|r
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* we are in big trouble, if this should ever happen */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: rx ring exhausted!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|vlsi_ring_debug
c_func
(paren
id|r
)paren
suffix:semicolon
)brace
r_else
id|outw
c_func
(paren
l_int|0
comma
id|ndev-&gt;base_addr
op_plus
id|VLSI_PIO_PROMPT
)paren
suffix:semicolon
)brace
multiline_comment|/* caller must have stopped the controller from busmastering */
DECL|function|vlsi_unarm_rx
r_static
r_void
id|vlsi_unarm_rx
c_func
(paren
id|vlsi_irda_dev_t
op_star
id|idev
)paren
(brace
r_struct
id|vlsi_ring
op_star
id|r
op_assign
id|idev-&gt;rx_ring
suffix:semicolon
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
id|ring_first
c_func
(paren
id|r
)paren
suffix:semicolon
id|rd
op_ne
l_int|NULL
suffix:semicolon
id|rd
op_assign
id|ring_get
c_func
(paren
id|r
)paren
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rd_is_active
c_func
(paren
id|rd
)paren
)paren
(brace
id|rd_set_status
c_func
(paren
id|rd
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd_get_count
c_func
(paren
id|rd
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s - dropping rx packet&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|VLSI_RX_DROP
suffix:semicolon
)brace
id|rd_set_count
c_func
(paren
id|rd
comma
l_int|0
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|r-&gt;pdev
comma
id|rd_get_addr
c_func
(paren
id|rd
)paren
comma
id|r-&gt;len
comma
id|r-&gt;dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|rd-&gt;skb
)paren
suffix:semicolon
id|rd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
id|ret
op_assign
id|vlsi_process_rx
c_func
(paren
id|r
comma
id|rd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ret
suffix:semicolon
id|idev-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_DROP
)paren
id|idev-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_OVER
)paren
id|idev-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_LENGTH
)paren
id|idev-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_FRAME
)paren
id|idev-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_RX_CRC
)paren
id|idev-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|idev-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|idev-&gt;stats.rx_bytes
op_add_assign
id|ret
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/********************************************************/
DECL|function|vlsi_process_tx
r_static
r_int
id|vlsi_process_tx
c_func
(paren
r_struct
id|vlsi_ring
op_star
id|r
comma
r_struct
id|ring_descr
op_star
id|rd
)paren
(brace
id|u16
id|status
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|r-&gt;pdev
comma
id|rd_get_addr
c_func
(paren
id|rd
)paren
comma
id|r-&gt;len
comma
id|r-&gt;dir
)paren
suffix:semicolon
multiline_comment|/* dma buffer now owned by the CPU */
id|status
op_assign
id|rd_get_status
c_func
(paren
id|rd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RD_TX_UNDRN
)paren
id|ret
op_assign
id|VLSI_TX_FIFO
suffix:semicolon
r_else
id|ret
op_assign
l_int|0
suffix:semicolon
id|rd_set_status
c_func
(paren
id|rd
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;skb
)paren
(brace
id|len
op_assign
id|rd-&gt;skb-&gt;len
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|rd-&gt;skb
)paren
suffix:semicolon
id|rd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
multiline_comment|/* tx-skb already freed? - should never happen */
id|len
op_assign
id|rd_get_count
c_func
(paren
id|rd
)paren
suffix:semicolon
multiline_comment|/* incorrect for SIR! (due to wrapping) */
id|rd_set_count
c_func
(paren
id|rd
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dma buffer still owned by the CPU */
r_return
(paren
id|ret
)paren
ques
c_cond
op_minus
id|ret
suffix:colon
id|len
suffix:semicolon
)brace
DECL|function|vlsi_set_baud
r_static
r_int
id|vlsi_set_baud
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_int
id|dolock
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|nphyctl
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|u16
id|config
suffix:semicolon
r_int
id|mode
suffix:semicolon
r_int
id|idle_retry
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|baudrate
suffix:semicolon
r_int
id|fifocnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Keep compiler happy */
id|baudrate
op_assign
id|idev-&gt;new_baud
suffix:semicolon
id|iobase
op_assign
id|ndev-&gt;base_addr
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d -&gt; %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|idev-&gt;baud
comma
id|idev-&gt;new_baud
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|baudrate
op_eq
l_int|4000000
)paren
(brace
id|mode
op_assign
id|IFF_FIR
suffix:semicolon
id|config
op_assign
id|IRCFG_FIR
suffix:semicolon
id|nphyctl
op_assign
id|PHYCTL_FIR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|baudrate
op_eq
l_int|1152000
)paren
(brace
id|mode
op_assign
id|IFF_MIR
suffix:semicolon
id|config
op_assign
id|IRCFG_MIR
op_or
id|IRCFG_CRC16
suffix:semicolon
id|nphyctl
op_assign
id|PHYCTL_MIR
c_func
(paren
id|clksrc
op_eq
l_int|3
)paren
suffix:semicolon
)brace
r_else
(brace
id|mode
op_assign
id|IFF_SIR
suffix:semicolon
id|config
op_assign
id|IRCFG_SIR
op_or
id|IRCFG_SIRFILT
op_or
id|IRCFG_RXANY
suffix:semicolon
r_switch
c_cond
(paren
id|baudrate
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: undefined baudrate %d - fallback to 9600!&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|baudrate
)paren
suffix:semicolon
id|baudrate
op_assign
l_int|9600
suffix:semicolon
multiline_comment|/* fallthru */
r_case
l_int|2400
suffix:colon
r_case
l_int|9600
suffix:colon
r_case
l_int|19200
suffix:colon
r_case
l_int|38400
suffix:colon
r_case
l_int|57600
suffix:colon
r_case
l_int|115200
suffix:colon
id|nphyctl
op_assign
id|PHYCTL_SIR
c_func
(paren
id|baudrate
comma
id|sirpulse
comma
id|clksrc
op_eq
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dolock
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_else
id|flags
op_assign
l_int|0xdead
suffix:semicolon
multiline_comment|/* prevent bogus warning about possible uninitialized use */
r_for
c_loop
(paren
id|idle_retry
op_assign
l_int|0
suffix:semicolon
id|idle_retry
OL
l_int|100
suffix:semicolon
id|idle_retry
op_increment
)paren
(brace
id|fifocnt
op_assign
id|inw
c_func
(paren
id|ndev-&gt;base_addr
op_plus
id|VLSI_PIO_RCVBCNT
)paren
op_amp
id|RCVBCNT_MASK
suffix:semicolon
r_if
c_cond
(paren
id|fifocnt
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idle_retry
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: waiting for rx fifo to become empty(%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|fifocnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dolock
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fifocnt
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: rx fifo not empty(%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|fifocnt
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|VLSI_PIO_IRENABLE
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|config
op_or_assign
id|IRCFG_MSTR
op_or
id|IRCFG_ENRX
suffix:semicolon
id|outw
c_func
(paren
id|config
comma
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
id|outw
c_func
(paren
id|nphyctl
comma
id|iobase
op_plus
id|VLSI_PIO_NPHYCTL
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IRENABLE_IREN
comma
id|iobase
op_plus
id|VLSI_PIO_IRENABLE
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* chip applies IRCFG on next rising edge of its 8MHz clock */
multiline_comment|/* read back settings for validation */
id|config
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRENABLE
)paren
op_amp
id|IRENABLE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|IFF_FIR
)paren
id|config
op_xor_assign
id|IRENABLE_FIR_ON
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mode
op_eq
id|IFF_MIR
)paren
id|config
op_xor_assign
(paren
id|IRENABLE_MIR_ON
op_or
id|IRENABLE_CRC16_ON
)paren
suffix:semicolon
r_else
id|config
op_xor_assign
id|IRENABLE_SIR_ON
suffix:semicolon
r_if
c_cond
(paren
id|config
op_ne
(paren
id|IRENABLE_IREN
op_or
id|IRENABLE_ENRXST
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: failed to set %s mode!&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
id|mode
op_eq
id|IFF_SIR
)paren
ques
c_cond
l_string|&quot;SIR&quot;
suffix:colon
(paren
(paren
id|mode
op_eq
id|IFF_MIR
)paren
ques
c_cond
l_string|&quot;MIR&quot;
suffix:colon
l_string|&quot;FIR&quot;
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_PHYCTL
)paren
op_ne
id|nphyctl
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: failed to apply baudrate %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|baudrate
)paren
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|idev-&gt;mode
op_assign
id|mode
suffix:semicolon
id|idev-&gt;baud
op_assign
id|baudrate
suffix:semicolon
id|idev-&gt;new_baud
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dolock
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|vlsi_reg_debug
c_func
(paren
id|iobase
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vlsi_set_baud_lock
r_static
r_inline
r_int
id|vlsi_set_baud_lock
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_return
id|vlsi_set_baud
c_func
(paren
id|ndev
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|vlsi_set_baud_nolock
r_static
r_inline
r_int
id|vlsi_set_baud_nolock
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_return
id|vlsi_set_baud
c_func
(paren
id|ndev
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|vlsi_hard_start_xmit
r_static
r_int
id|vlsi_hard_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_struct
id|vlsi_ring
op_star
id|r
op_assign
id|idev-&gt;tx_ring
suffix:semicolon
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|iobase
op_assign
id|ndev-&gt;base_addr
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|u16
id|config
suffix:semicolon
r_int
id|mtt
suffix:semicolon
r_int
id|len
comma
id|speed
suffix:semicolon
r_struct
id|timeval
id|now
comma
id|ready
suffix:semicolon
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_ne
op_minus
l_int|1
op_logical_and
id|speed
op_ne
id|idev-&gt;baud
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|idev-&gt;new_baud
op_assign
id|speed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* due to the completely asynch tx operation we might have&n;&t;&t;&t; * IrLAP racing with the hardware here, f.e. if the controller&n;&t;&t;&t; * is just sending the last packet with current speed while&n;&t;&t;&t; * the LAP is already switching the speed using synchronous&n;&t;&t;&t; * len=0 packet. Immediate execution would lead to hw lockup&n;&t;&t;&t; * requiring a powercycle to reset. Good candidate to trigger&n;&t;&t;&t; * this is the final UA:RSP packet after receiving a DISC:CMD&n;&t;&t;&t; * when getting the LAP down.&n;&t;&t;&t; * Note that we are not protected by the queue_stop approach&n;&t;&t;&t; * because the final UA:RSP arrives _without_ request to apply&n;&t;&t;&t; * new-speed-after-this-packet - hence the driver doesn&squot;t know&n;&t;&t;&t; * this was the last packet and doesn&squot;t stop the queue. So the&n;&t;&t;&t; * forced switch to default speed from LAP gets through as fast&n;&t;&t;&t; * as only some 10 usec later while the UA:RSP is still processed&n;&t;&t;&t; * by the hardware and we would get screwed.&n;&t;&t;&t; * Note: no locking required since we (netdev-&gt;xmit) are the only&n;&t;&t;&t; * supplier for tx and the network layer provides serialization&n;&t;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring_first
c_func
(paren
id|idev-&gt;tx_ring
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no race - tx-ring already empty */
id|vlsi_set_baud_nolock
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
r_else
suffix:semicolon
multiline_comment|/* keep the speed change pending like it would&n;&t;&t;&t;&t;   * for any len&gt;0 packet. tx completion interrupt&n;&t;&t;&t;&t;   * will apply it when the tx ring becomes empty.&n;&t;&t;&t;&t;   */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|status
op_assign
id|RD_TX_CLRENTX
suffix:semicolon
multiline_comment|/* stop tx-ring after this frame */
)brace
r_else
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: dropping len=0 packet&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
multiline_comment|/* sanity checks - should never happen!&n;&t; * simply BUGging the violation and dropping the packet&n;&t; */
id|rd
op_assign
id|ring_last
c_func
(paren
id|r
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rd
)paren
(brace
multiline_comment|/* ring full - queue should have been stopped! */
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rd_is_active
c_func
(paren
id|rd
)paren
)paren
(brace
multiline_comment|/* entry still owned by hw! */
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rd-&gt;buf
)paren
(brace
multiline_comment|/* no memory for this tx entry - weird! */
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rd-&gt;skb
)paren
(brace
multiline_comment|/* hm, associated old skb still there */
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
multiline_comment|/* tx buffer already owned by CPU due to pci_dma_sync_single() either&n;&t; * after initial pci_map_single or after subsequent tx-completion&n;&t; */
r_if
c_cond
(paren
id|idev-&gt;mode
op_eq
id|IFF_SIR
)paren
(brace
id|status
op_or_assign
id|RD_TX_DISCRC
suffix:semicolon
multiline_comment|/* no hw-crc creation */
id|len
op_assign
id|async_wrap_skb
c_func
(paren
id|skb
comma
id|rd-&gt;buf
comma
id|r-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Some rare worst case situation in SIR mode might lead to&n;&t;&t; * potential buffer overflow. The wrapper detects this, returns&n;&t;&t; * with a shortened frame (without FCS/EOF) but doesn&squot;t provide&n;&t;&t; * any error indication about the invalid packet which we are&n;&t;&t; * going to transmit.&n;&t;&t; * Therefore we log if the buffer got filled to the point, where the&n;&t;&t; * wrapper would abort, i.e. when there are less than 5 bytes left to&n;&t;&t; * allow appending the FCS/EOF.&n;&t;&t; */
r_if
c_cond
(paren
id|len
op_ge
id|r-&gt;len
op_minus
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: possible buffer overflow with SIR wrapping!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* hw deals with MIR/FIR mode wrapping */
id|status
op_or_assign
id|RD_TX_PULSE
suffix:semicolon
multiline_comment|/* send 2 us highspeed indication pulse */
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|r-&gt;len
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: no space - skb too big (%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
id|rd-&gt;buf
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* do mtt delay before we need to disable interrupts! */
r_if
c_cond
(paren
(paren
id|mtt
op_assign
id|irda_get_mtt
c_func
(paren
id|skb
)paren
)paren
OG
l_int|0
)paren
(brace
id|ready.tv_usec
op_assign
id|idev-&gt;last_rx.tv_usec
op_plus
id|mtt
suffix:semicolon
id|ready.tv_sec
op_assign
id|idev-&gt;last_rx.tv_sec
suffix:semicolon
r_if
c_cond
(paren
id|ready.tv_usec
op_ge
l_int|1000000
)paren
(brace
id|ready.tv_usec
op_sub_assign
l_int|1000000
suffix:semicolon
id|ready.tv_sec
op_increment
suffix:semicolon
multiline_comment|/* IrLAP 1.1: mtt always &lt; 1 sec */
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|do_gettimeofday
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
r_if
c_cond
(paren
id|now.tv_sec
OG
id|ready.tv_sec
op_logical_or
(paren
id|now.tv_sec
op_eq
id|ready.tv_sec
op_logical_and
id|now.tv_usec
op_ge
id|ready.tv_usec
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* must not sleep here - we are called under xmit_lock! */
)brace
)brace
id|rd-&gt;skb
op_assign
id|skb
suffix:semicolon
multiline_comment|/* remember skb for tx-complete stats */
id|rd_set_count
c_func
(paren
id|rd
comma
id|len
)paren
suffix:semicolon
id|rd_set_status
c_func
(paren
id|rd
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* not yet active! */
multiline_comment|/* give dma buffer back to busmaster-hw (flush caches to make&n;&t; * CPU-driven changes visible from the pci bus).&n;&t; */
id|pci_dma_prep_single
c_func
(paren
id|r-&gt;pdev
comma
id|rd_get_addr
c_func
(paren
id|rd
)paren
comma
id|r-&gt;len
comma
id|r-&gt;dir
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;We need to disable IR output in order to switch to TX mode.&n; *&t;Better not do this blindly anytime we want to transmit something&n; *&t;because TX may already run. However we are racing with the controller&n; *&t;which may stop TX at any time when fetching an inactive descriptor&n; *&t;or one with CLR_ENTX set. So we switch on TX only, if TX was not running&n; *&t;_after_ the new descriptor was activated on the ring. This ensures&n; *&t;we will either find TX already stopped or we can be sure, there&n; *&t;will be a TX-complete interrupt even if the chip stopped doing&n; *&t;TX just after we found it still running. The ISR will then find&n; *&t;the non-empty ring and restart TX processing. The enclosing&n; *&t;spinlock provides the correct serialization to prevent race with isr.&n; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rd_activate
c_func
(paren
id|rd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRENABLE
)paren
op_amp
id|IRENABLE_ENTXST
)paren
)paren
(brace
r_int
id|fifocnt
suffix:semicolon
id|fifocnt
op_assign
id|inw
c_func
(paren
id|ndev-&gt;base_addr
op_plus
id|VLSI_PIO_RCVBCNT
)paren
op_amp
id|RCVBCNT_MASK
suffix:semicolon
r_if
c_cond
(paren
id|fifocnt
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: rx fifo not empty(%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|fifocnt
)paren
suffix:semicolon
id|config
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|config
op_or
id|IRCFG_ENTX
comma
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|VLSI_PIO_PROMPT
)paren
suffix:semicolon
)brace
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|ring_put
c_func
(paren
id|r
)paren
op_eq
l_int|NULL
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: tx ring full - queue stopped&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|drop
suffix:colon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|idev-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|idev-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|vlsi_tx_interrupt
r_static
r_void
id|vlsi_tx_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_struct
id|vlsi_ring
op_star
id|r
op_assign
id|idev-&gt;tx_ring
suffix:semicolon
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u16
id|config
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
id|ring_first
c_func
(paren
id|r
)paren
suffix:semicolon
id|rd
op_ne
l_int|NULL
suffix:semicolon
id|rd
op_assign
id|ring_get
c_func
(paren
id|r
)paren
)paren
(brace
r_if
c_cond
(paren
id|rd_is_active
c_func
(paren
id|rd
)paren
)paren
r_break
suffix:semicolon
id|ret
op_assign
id|vlsi_process_tx
c_func
(paren
id|r
comma
id|rd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ret
suffix:semicolon
id|idev-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_TX_DROP
)paren
id|idev-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_TX_FIFO
)paren
id|idev-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|idev-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|idev-&gt;stats.tx_bytes
op_add_assign
id|ret
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|idev-&gt;new_baud
op_logical_and
id|rd
op_eq
l_int|NULL
)paren
multiline_comment|/* tx ring empty and speed change pending */
id|vlsi_set_baud_lock
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|iobase
op_assign
id|ndev-&gt;base_addr
suffix:semicolon
id|config
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
op_eq
l_int|NULL
)paren
multiline_comment|/* tx ring empty: re-enable rx */
id|outw
c_func
(paren
(paren
id|config
op_amp
op_complement
id|IRCFG_ENTX
)paren
op_or
id|IRCFG_ENRX
comma
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRENABLE
)paren
op_amp
id|IRENABLE_ENTXST
)paren
)paren
(brace
r_int
id|fifocnt
suffix:semicolon
id|fifocnt
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_RCVBCNT
)paren
op_amp
id|RCVBCNT_MASK
suffix:semicolon
r_if
c_cond
(paren
id|fifocnt
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: rx fifo not empty(%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|fifocnt
)paren
suffix:semicolon
id|outw
c_func
(paren
id|config
op_or
id|IRCFG_ENTX
comma
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|VLSI_PIO_PROMPT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|ndev
)paren
op_logical_and
op_logical_neg
id|idev-&gt;new_baud
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: queue awoken&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* caller must have stopped the controller from busmastering */
DECL|function|vlsi_unarm_tx
r_static
r_void
id|vlsi_unarm_tx
c_func
(paren
id|vlsi_irda_dev_t
op_star
id|idev
)paren
(brace
r_struct
id|vlsi_ring
op_star
id|r
op_assign
id|idev-&gt;tx_ring
suffix:semicolon
r_struct
id|ring_descr
op_star
id|rd
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
id|ring_first
c_func
(paren
id|r
)paren
suffix:semicolon
id|rd
op_ne
l_int|NULL
suffix:semicolon
id|rd
op_assign
id|ring_get
c_func
(paren
id|r
)paren
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rd_is_active
c_func
(paren
id|rd
)paren
)paren
(brace
id|rd_set_status
c_func
(paren
id|rd
comma
l_int|0
)paren
suffix:semicolon
id|rd_set_count
c_func
(paren
id|rd
comma
l_int|0
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|r-&gt;pdev
comma
id|rd_get_addr
c_func
(paren
id|rd
)paren
comma
id|r-&gt;len
comma
id|r-&gt;dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd-&gt;skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|rd-&gt;skb
)paren
suffix:semicolon
id|rd-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s - dropping tx packet&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|VLSI_TX_DROP
suffix:semicolon
)brace
r_else
id|ret
op_assign
id|vlsi_process_tx
c_func
(paren
id|r
comma
id|rd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ret
suffix:semicolon
id|idev-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_TX_DROP
)paren
id|idev-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|VLSI_TX_FIFO
)paren
id|idev-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|idev-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|idev-&gt;stats.tx_bytes
op_add_assign
id|ret
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/********************************************************/
DECL|function|vlsi_start_clock
r_static
r_int
id|vlsi_start_clock
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u8
id|clkctl
comma
id|lock
suffix:semicolon
r_int
id|i
comma
id|count
suffix:semicolon
r_if
c_cond
(paren
id|clksrc
OL
l_int|2
)paren
(brace
multiline_comment|/* auto or PLL: try PLL */
id|clkctl
op_assign
id|CLKCTL_PD_INV
op_or
id|CLKCTL_CLKSTP
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
id|clkctl
)paren
suffix:semicolon
multiline_comment|/* procedure to detect PLL lock synchronisation:&n;&t;&t; * after 0.5 msec initial delay we expect to find 3 PLL lock&n;&t;&t; * indications within 10 msec for successful PLL detection.&n;&t;&t; */
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|500
suffix:semicolon
id|i
op_le
l_int|10000
suffix:semicolon
id|i
op_add_assign
l_int|50
)paren
(brace
multiline_comment|/* max 10 msec */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
op_amp
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lock
op_amp
id|CLKCTL_LOCK
)paren
(brace
r_if
c_cond
(paren
op_increment
id|count
op_ge
l_int|3
)paren
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|clksrc
op_eq
l_int|1
)paren
(brace
multiline_comment|/* explicitly asked for PLL hence bail out */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: no PLL or failed to lock!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|clkctl
op_assign
id|CLKCTL_CLKSTP
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
id|clkctl
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
multiline_comment|/* was: clksrc=0(auto) */
id|clksrc
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* fallback to 40MHz XCLK (OB800) */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PLL not locked, fallback to clksrc=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|clksrc
)paren
suffix:semicolon
)brace
r_else
id|clksrc
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* got successful PLL lock */
)brace
r_if
c_cond
(paren
id|clksrc
op_ne
l_int|1
)paren
(brace
multiline_comment|/* we get here if either no PLL detected in auto-mode or&n;&t;&t;   an external clock source was explicitly specified */
id|clkctl
op_assign
id|CLKCTL_EXTCLK
op_or
id|CLKCTL_CLKSTP
suffix:semicolon
r_if
c_cond
(paren
id|clksrc
op_eq
l_int|3
)paren
id|clkctl
op_or_assign
id|CLKCTL_XCKSEL
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
id|clkctl
)paren
suffix:semicolon
multiline_comment|/* no way to test for working XCLK */
)brace
r_else
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
op_amp
id|clkctl
)paren
suffix:semicolon
multiline_comment|/* ok, now going to connect the chip with the clock source */
id|clkctl
op_and_assign
op_complement
id|CLKCTL_CLKSTP
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
id|clkctl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_stop_clock
r_static
r_void
id|vlsi_stop_clock
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u8
id|clkctl
suffix:semicolon
multiline_comment|/* disconnect chip from clock source */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
op_amp
id|clkctl
)paren
suffix:semicolon
id|clkctl
op_or_assign
id|CLKCTL_CLKSTP
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
id|clkctl
)paren
suffix:semicolon
multiline_comment|/* disable all clock sources */
id|clkctl
op_and_assign
op_complement
(paren
id|CLKCTL_EXTCLK
op_or
id|CLKCTL_PD_INV
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_CLKCTL
comma
id|clkctl
)paren
suffix:semicolon
)brace
multiline_comment|/********************************************************/
multiline_comment|/* writing all-zero to the VLSI PCI IO register area seems to prevent&n; * some occasional situations where the hardware fails (symptoms are &n; * what appears as stalled tx/rx state machines, i.e. everything ok for&n; * receive or transmit but hw makes no progress or is unable to access&n; * the bus memory locations).&n; * Best place to call this is immediately after/before the internal clock&n; * gets started/stopped.&n; */
DECL|function|vlsi_clear_regs
r_static
r_inline
r_void
id|vlsi_clear_regs
c_func
(paren
r_int
id|iobase
)paren
(brace
r_int
id|i
suffix:semicolon
r_const
r_int
id|chip_io_extent
op_assign
l_int|32
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|chip_io_extent
suffix:semicolon
id|i
op_add_assign
r_sizeof
(paren
id|u16
)paren
)paren
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|i
)paren
suffix:semicolon
)brace
DECL|function|vlsi_init_chip
r_static
r_int
id|vlsi_init_chip
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|u16
id|ptr
suffix:semicolon
multiline_comment|/* start the clock and clean the registers */
r_if
c_cond
(paren
id|vlsi_start_clock
c_func
(paren
id|pdev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: no valid clock source&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|iobase
op_assign
id|ndev-&gt;base_addr
suffix:semicolon
id|vlsi_clear_regs
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRINTR_INT_MASK
comma
id|iobase
op_plus
id|VLSI_PIO_IRINTR
)paren
suffix:semicolon
multiline_comment|/* w/c pending IRQ, disable all INT */
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|VLSI_PIO_IRENABLE
)paren
suffix:semicolon
multiline_comment|/* disable IrPHY-interface */
multiline_comment|/* disable everything, particularly IRCFG_MSTR - (also resetting the RING_PTR) */
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MAX_PACKET_LENGTH
comma
id|iobase
op_plus
id|VLSI_PIO_MAXPKT
)paren
suffix:semicolon
multiline_comment|/* max possible value=0x0fff */
id|outw
c_func
(paren
id|BUS_TO_RINGBASE
c_func
(paren
id|idev-&gt;busaddr
)paren
comma
id|iobase
op_plus
id|VLSI_PIO_RINGBASE
)paren
suffix:semicolon
id|outw
c_func
(paren
id|TX_RX_TO_RINGSIZE
c_func
(paren
id|idev-&gt;tx_ring-&gt;size
comma
id|idev-&gt;rx_ring-&gt;size
)paren
comma
id|iobase
op_plus
id|VLSI_PIO_RINGSIZE
)paren
suffix:semicolon
id|ptr
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_RINGPTR
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|idev-&gt;rx_ring-&gt;head
comma
id|RINGPTR_GET_RX
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|idev-&gt;rx_ring-&gt;tail
comma
id|RINGPTR_GET_RX
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|idev-&gt;tx_ring-&gt;head
comma
id|RINGPTR_GET_TX
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|idev-&gt;tx_ring-&gt;tail
comma
id|RINGPTR_GET_TX
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
id|vlsi_set_baud_lock
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* idev-&gt;new_baud used as provided by caller */
id|outb
c_func
(paren
id|IRINTR_INT_MASK
comma
id|iobase
op_plus
id|VLSI_PIO_IRINTR
)paren
suffix:semicolon
multiline_comment|/* just in case - w/c pending IRQ&squot;s */
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* DO NOT BLINDLY ENABLE IRINTR_ACTEN!&n;&t; * basically every received pulse fires an ACTIVITY-INT&n;&t; * leading to &gt;&gt;1000 INT&squot;s per second instead of few 10&n;&t; */
id|outb
c_func
(paren
id|IRINTR_RPKTEN
op_or
id|IRINTR_TPKTEN
comma
id|iobase
op_plus
id|VLSI_PIO_IRINTR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_start_hw
r_static
r_int
id|vlsi_start_hw
c_func
(paren
id|vlsi_irda_dev_t
op_star
id|idev
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|idev-&gt;pdev
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_int
id|iobase
op_assign
id|ndev-&gt;base_addr
suffix:semicolon
id|u8
id|byte
suffix:semicolon
multiline_comment|/* we don&squot;t use the legacy UART, disable its address decoding */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_IRMISC
comma
op_amp
id|byte
)paren
suffix:semicolon
id|byte
op_and_assign
op_complement
(paren
id|IRMISC_UARTEN
op_or
id|IRMISC_UARTTST
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_IRMISC
comma
id|byte
)paren
suffix:semicolon
multiline_comment|/* enable PCI busmaster access to our 16MB page */
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|VLSI_PCI_MSTRPAGE
comma
id|MSTRPAGE_VALUE
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|vlsi_init_chip
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|vlsi_fill_rx
c_func
(paren
id|idev-&gt;rx_ring
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|idev-&gt;last_rx
)paren
suffix:semicolon
multiline_comment|/* first mtt may start from now on */
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|VLSI_PIO_PROMPT
)paren
suffix:semicolon
multiline_comment|/* kick hw state machine */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_stop_hw
r_static
r_int
id|vlsi_stop_hw
c_func
(paren
id|vlsi_irda_dev_t
op_star
id|idev
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|idev-&gt;pdev
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_int
id|iobase
op_assign
id|ndev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|VLSI_PIO_IRENABLE
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|VLSI_PIO_IRCFG
)paren
suffix:semicolon
multiline_comment|/* disable everything */
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRINTR_INT_MASK
comma
id|iobase
op_plus
id|VLSI_PIO_IRINTR
)paren
suffix:semicolon
multiline_comment|/* w/c pending + disable further IRQ */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|vlsi_unarm_tx
c_func
(paren
id|idev
)paren
suffix:semicolon
id|vlsi_unarm_rx
c_func
(paren
id|idev
)paren
suffix:semicolon
id|vlsi_clear_regs
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|vlsi_stop_clock
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
DECL|function|vlsi_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|vlsi_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_return
op_amp
id|idev-&gt;stats
suffix:semicolon
)brace
DECL|function|vlsi_tx_timeout
r_static
r_void
id|vlsi_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|vlsi_reg_debug
c_func
(paren
id|ndev-&gt;base_addr
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|vlsi_ring_debug
c_func
(paren
id|idev-&gt;tx_ring
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|ndev
)paren
)paren
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|vlsi_stop_hw
c_func
(paren
id|idev
)paren
suffix:semicolon
multiline_comment|/* now simply restart the whole thing */
r_if
c_cond
(paren
op_logical_neg
id|idev-&gt;new_baud
)paren
id|idev-&gt;new_baud
op_assign
id|idev-&gt;baud
suffix:semicolon
multiline_comment|/* keep current baudrate */
r_if
c_cond
(paren
id|vlsi_start_hw
c_func
(paren
id|idev
)paren
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: failed to restart hw - %s(%s) unusable!&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|idev-&gt;pdev-&gt;dev.name
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_else
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
DECL|function|vlsi_ioctl
r_static
r_int
id|vlsi_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_struct
id|if_irda_req
op_star
id|irq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|rq
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|fifocnt
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|idev-&gt;new_baud
op_assign
id|irq-&gt;ifr_baudrate
suffix:semicolon
multiline_comment|/* when called from userland there might be a minor race window here&n;&t;&t;&t; * if the stack tries to change speed concurrently - which would be&n;&t;&t;&t; * pretty strange anyway with the userland having full control...&n;&t;&t;&t; */
id|vlsi_set_baud_nolock
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|irda_device_set_media_busy
c_func
(paren
id|ndev
comma
id|TRUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
multiline_comment|/* the best we can do: check whether there are any bytes in rx fifo.&n;&t;&t;&t; * The trustable window (in case some data arrives just afterwards)&n;&t;&t;&t; * may be as short as 1usec or so at 4Mbps.&n;&t;&t;&t; */
id|fifocnt
op_assign
id|inw
c_func
(paren
id|ndev-&gt;base_addr
op_plus
id|VLSI_PIO_RCVBCNT
)paren
op_amp
id|RCVBCNT_MASK
suffix:semicolon
id|irq-&gt;ifr_receiving
op_assign
(paren
id|fifocnt
op_ne
l_int|0
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: notsupp - cmd=%04x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmd
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/********************************************************/
DECL|function|vlsi_interrupt
r_static
id|irqreturn_t
id|vlsi_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|dev_instance
suffix:semicolon
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|u8
id|irintr
suffix:semicolon
r_int
id|boguscount
op_assign
l_int|32
suffix:semicolon
r_int
id|got_act
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
id|got_act
op_assign
l_int|0
suffix:semicolon
id|iobase
op_assign
id|ndev-&gt;base_addr
suffix:semicolon
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|irintr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|VLSI_PIO_IRINTR
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|irintr
comma
id|iobase
op_plus
id|VLSI_PIO_IRINTR
)paren
suffix:semicolon
multiline_comment|/* acknowledge asap */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|idev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|irintr
op_and_assign
id|IRINTR_INT_MASK
)paren
)paren
multiline_comment|/* not our INT - probably shared */
r_break
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|irintr
op_amp
id|IRINTR_RPKTINT
)paren
id|vlsi_rx_interrupt
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irintr
op_amp
id|IRINTR_TPKTINT
)paren
id|vlsi_tx_interrupt
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|irintr
op_amp
op_complement
id|IRINTR_ACTIVITY
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* done if only activity remaining */
r_if
c_cond
(paren
id|irintr
op_amp
op_complement
(paren
id|IRINTR_RPKTINT
op_or
id|IRINTR_TPKTINT
op_or
id|IRINTR_ACTIVITY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: IRINTR = %02x&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_int
)paren
id|irintr
)paren
suffix:semicolon
id|vlsi_reg_debug
c_func
(paren
id|iobase
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_decrement
id|boguscount
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|boguscount
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: too much work in interrupt!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
multiline_comment|/********************************************************/
DECL|function|vlsi_open
r_static
r_int
id|vlsi_open
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_char
id|hwname
(braket
l_int|32
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pci_request_regions
c_func
(paren
id|idev-&gt;pdev
comma
id|drivername
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: io resource busy&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
id|ndev-&gt;base_addr
op_assign
id|pci_resource_start
c_func
(paren
id|idev-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
id|ndev-&gt;irq
op_assign
id|idev-&gt;pdev-&gt;irq
suffix:semicolon
multiline_comment|/* under some rare occasions the chip apparently comes up with&n;&t; * IRQ&squot;s pending. We better w/c pending IRQ and disable them all&n;&t; */
id|outb
c_func
(paren
id|IRINTR_INT_MASK
comma
id|ndev-&gt;base_addr
op_plus
id|VLSI_PIO_IRINTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|ndev-&gt;irq
comma
id|vlsi_interrupt
comma
id|SA_SHIRQ
comma
id|drivername
comma
id|ndev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: couldn&squot;t get IRQ: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ndev-&gt;irq
)paren
suffix:semicolon
r_goto
id|errout_io
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vlsi_create_hwif
c_func
(paren
id|idev
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|errout_irq
suffix:semicolon
id|sprintf
c_func
(paren
id|hwname
comma
l_string|&quot;VLSI-FIR @ 0x%04x&quot;
comma
(paren
r_int
)paren
id|ndev-&gt;base_addr
)paren
suffix:semicolon
id|idev-&gt;irlap
op_assign
id|irlap_open
c_func
(paren
id|ndev
comma
op_amp
id|idev-&gt;qos
comma
id|hwname
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev-&gt;irlap
)paren
r_goto
id|errout_free_ring
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|idev-&gt;last_rx
)paren
suffix:semicolon
multiline_comment|/* first mtt may start from now on */
id|idev-&gt;new_baud
op_assign
l_int|9600
suffix:semicolon
multiline_comment|/* start with IrPHY using 9600(SIR) mode */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vlsi_start_hw
c_func
(paren
id|idev
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|errout_close_irlap
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: device %s operational&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|errout_close_irlap
suffix:colon
id|irlap_close
c_func
(paren
id|idev-&gt;irlap
)paren
suffix:semicolon
id|errout_free_ring
suffix:colon
id|vlsi_destroy_hwif
c_func
(paren
id|idev
)paren
suffix:semicolon
id|errout_irq
suffix:colon
id|free_irq
c_func
(paren
id|ndev-&gt;irq
comma
id|ndev
)paren
suffix:semicolon
id|errout_io
suffix:colon
id|pci_release_regions
c_func
(paren
id|idev-&gt;pdev
)paren
suffix:semicolon
id|errout
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|vlsi_close
r_static
r_int
id|vlsi_close
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;irlap
)paren
id|irlap_close
c_func
(paren
id|idev-&gt;irlap
)paren
suffix:semicolon
id|idev-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
id|vlsi_stop_hw
c_func
(paren
id|idev
)paren
suffix:semicolon
id|vlsi_destroy_hwif
c_func
(paren
id|idev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|ndev-&gt;irq
comma
id|ndev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|idev-&gt;pdev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: device %s stopped&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_irda_init
r_static
r_int
id|vlsi_irda_init
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|vlsi_irda_dev_t
op_star
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|idev-&gt;pdev
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|ndev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|ndev-&gt;base_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* PCI busmastering&n;&t; * see include file for details why we need these 2 masks, in this order!&n;&t; */
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_MASK_USED_BY_HW
)paren
op_logical_or
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_MASK_MSTRPAGE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: aborting due to PCI BM-DMA address limitations&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|irda_init_max_qos_capabilies
c_func
(paren
op_amp
id|idev-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* the VLSI82C147 does not support 576000! */
id|idev-&gt;qos.baud_rate.bits
op_assign
id|IR_2400
op_or
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
op_or
id|IR_1152000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
id|idev-&gt;qos.min_turn_time.bits
op_assign
id|qos_mtt_bits
suffix:semicolon
id|irda_qos_bits_to_value
c_func
(paren
op_amp
id|idev-&gt;qos
)paren
suffix:semicolon
id|irda_device_setup
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* currently no public media definitions for IrDA */
id|ndev-&gt;flags
op_or_assign
id|IFF_PORTSEL
op_or
id|IFF_AUTOMEDIA
suffix:semicolon
id|ndev-&gt;if_port
op_assign
id|IF_PORT_UNKNOWN
suffix:semicolon
id|ndev-&gt;open
op_assign
id|vlsi_open
suffix:semicolon
id|ndev-&gt;stop
op_assign
id|vlsi_close
suffix:semicolon
id|ndev-&gt;get_stats
op_assign
id|vlsi_get_stats
suffix:semicolon
id|ndev-&gt;hard_start_xmit
op_assign
id|vlsi_hard_start_xmit
suffix:semicolon
id|ndev-&gt;do_ioctl
op_assign
id|vlsi_ioctl
suffix:semicolon
id|ndev-&gt;tx_timeout
op_assign
id|vlsi_tx_timeout
suffix:semicolon
id|ndev-&gt;watchdog_timeo
op_assign
l_int|500
op_star
id|HZ
op_div
l_int|1000
suffix:semicolon
multiline_comment|/* max. allowed turn time for IrLAP */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
r_static
r_int
id|__devinit
DECL|function|vlsi_irda_probe
id|vlsi_irda_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
suffix:semicolon
id|vlsi_irda_dev_t
op_star
id|idev
suffix:semicolon
r_int
id|alloc_size
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|out
suffix:semicolon
r_else
id|pdev-&gt;current_state
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* hw must be running now */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IrDA PCI controller %s detected&bslash;n&quot;
comma
id|drivername
comma
id|pdev-&gt;dev.name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_logical_or
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_IO
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: bar 0 invalid&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out_disable
suffix:semicolon
)brace
id|alloc_size
op_assign
r_sizeof
(paren
op_star
id|ndev
)paren
op_plus
r_sizeof
(paren
op_star
id|idev
)paren
suffix:semicolon
id|ndev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|kmalloc
(paren
id|alloc_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ndev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to allocate device memory.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out_disable
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ndev
comma
l_int|0
comma
id|alloc_size
)paren
suffix:semicolon
id|idev
op_assign
(paren
id|vlsi_irda_dev_t
op_star
)paren
(paren
id|ndev
op_plus
l_int|1
)paren
suffix:semicolon
id|ndev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|idev
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|idev-&gt;lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|idev-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|ndev-&gt;init
op_assign
id|vlsi_irda_init
suffix:semicolon
id|strcpy
c_func
(paren
id|ndev-&gt;name
comma
l_string|&quot;irda%d&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|ndev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: register_netdev failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out_freedev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vlsi_proc_root
op_ne
l_int|NULL
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
id|ndev-&gt;name
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|vlsi_proc_root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: failed to create proc entry&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out_unregister
suffix:semicolon
)brace
id|ent-&gt;data
op_assign
id|ndev
suffix:semicolon
id|ent-&gt;proc_fops
op_assign
id|VLSI_PROC_FOPS
suffix:semicolon
id|ent-&gt;size
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;proc_entry
op_assign
id|ent
suffix:semicolon
)brace
r_else
id|idev-&gt;proc_entry
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: registered device %s&bslash;n&quot;
comma
id|drivername
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|ndev
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_unregister
suffix:colon
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_goto
id|out_disable
suffix:semicolon
id|out_freedev
suffix:colon
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|out_disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|out
suffix:colon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|vlsi_irda_remove
r_static
r_void
id|__devexit
id|vlsi_irda_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|vlsi_irda_dev_t
op_star
id|idev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ndev
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: lost netdevice?&bslash;n&quot;
comma
id|drivername
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;proc_entry
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|ndev-&gt;name
comma
id|vlsi_proc_root
)paren
suffix:semicolon
id|idev-&gt;proc_entry
op_assign
l_int|NULL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* do not free - async completed by unregister_netdev()&n;&t; * ndev-&gt;destructor called (if present) when going to free&n;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s removed&bslash;n&quot;
comma
id|drivername
comma
id|pdev-&gt;dev.name
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
multiline_comment|/* The Controller doesn&squot;t provide PCI PM capabilities as defined by PCI specs.&n; * Some of the Linux PCI-PM code however depends on this, for example in&n; * pci_set_power_state(). So we have to take care to perform the required&n; * operations on our own (particularly reflecting the pdev-&gt;current_state)&n; * otherwise we might get cheated by pci-pm.&n; */
DECL|function|vlsi_irda_save_state
r_static
r_int
id|vlsi_irda_save_state
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
template_param
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - %s: invalid pm state request: %u&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pdev-&gt;dev.name
comma
id|state
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_irda_suspend
r_static
r_int
id|vlsi_irda_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|vlsi_irda_dev_t
op_star
id|idev
suffix:semicolon
r_if
c_cond
(paren
id|state
template_param
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - %s: invalid pm state request: %u&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pdev-&gt;dev.name
comma
id|state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ndev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - %s: no netdevice &bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pdev-&gt;dev.name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;current_state
op_ne
l_int|0
)paren
(brace
multiline_comment|/* already suspended */
r_if
c_cond
(paren
id|state
OG
id|pdev-&gt;current_state
)paren
(brace
multiline_comment|/* simply go deeper */
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|state
)paren
suffix:semicolon
id|pdev-&gt;current_state
op_assign
id|state
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - %s: invalid suspend request %u -&gt; %u&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pdev-&gt;dev.name
comma
id|pdev-&gt;current_state
comma
id|state
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|ndev
)paren
)paren
(brace
id|netif_device_detach
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|vlsi_stop_hw
c_func
(paren
id|idev
)paren
suffix:semicolon
id|pci_save_state
c_func
(paren
id|pdev
comma
id|idev-&gt;cfg_space
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev-&gt;new_baud
)paren
multiline_comment|/* remember speed settings to restore on resume */
id|idev-&gt;new_baud
op_assign
id|idev-&gt;baud
suffix:semicolon
)brace
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|state
)paren
suffix:semicolon
id|pdev-&gt;current_state
op_assign
id|state
suffix:semicolon
id|idev-&gt;resume_ok
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_irda_resume
r_static
r_int
id|vlsi_irda_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|vlsi_irda_dev_t
op_star
id|idev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ndev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - %s: no netdevice &bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pdev-&gt;dev.name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|idev
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;current_state
op_eq
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - %s: already resumed&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pdev-&gt;dev.name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pci_set_power_state
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|pdev-&gt;current_state
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev-&gt;resume_ok
)paren
(brace
multiline_comment|/* should be obsolete now - but used to happen due to:&n;&t;&t; * - pci layer initially setting pdev-&gt;current_state = 4 (unknown)&n;&t;&t; * - pci layer did not walk the save_state-tree (might be APM problem)&n;&t;&t; *   so we could not refuse to suspend from undefined state&n;&t;&t; * - vlsi_irda_suspend detected invalid state and refused to save&n;&t;&t; *   configuration for resume - but was too late to stop suspending&n;&t;&t; * - vlsi_irda_resume got screwed when trying to resume from garbage&n;&t;&t; *&n;&t;&t; * now we explicitly set pdev-&gt;current_state = 0 after enabling the&n;&t;&t; * device and independently resume_ok should catch any garbage config.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - hm, nothing to resume?&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|ndev
)paren
)paren
(brace
id|pci_restore_state
c_func
(paren
id|pdev
comma
id|idev-&gt;cfg_space
)paren
suffix:semicolon
id|vlsi_start_hw
c_func
(paren
id|idev
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
id|idev-&gt;resume_ok
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idev-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PM */
multiline_comment|/*********************************************************/
DECL|variable|vlsi_irda_driver
r_static
r_struct
id|pci_driver
id|vlsi_irda_driver
op_assign
(brace
dot
id|name
op_assign
id|drivername
comma
dot
id|id_table
op_assign
id|vlsi_irda_table
comma
dot
id|probe
op_assign
id|vlsi_irda_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|vlsi_irda_remove
)paren
comma
macro_line|#ifdef CONFIG_PM
dot
id|save_state
op_assign
id|vlsi_irda_save_state
comma
dot
id|suspend
op_assign
id|vlsi_irda_suspend
comma
dot
id|resume
op_assign
id|vlsi_irda_resume
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|macro|PROC_DIR
mdefine_line|#define PROC_DIR (&quot;driver/&quot; DRIVER_NAME)
DECL|function|vlsi_mod_init
r_static
r_int
id|__init
id|vlsi_mod_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|clksrc
template_param
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid clksrc=%d&bslash;n&quot;
comma
id|drivername
comma
id|clksrc
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|ringsize
(braket
id|i
)braket
)paren
(brace
r_case
l_int|4
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|16
suffix:colon
r_case
l_int|32
suffix:colon
r_case
l_int|64
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: invalid %s ringsize %d&quot;
comma
id|drivername
comma
(paren
id|i
)paren
ques
c_cond
l_string|&quot;rx&quot;
suffix:colon
l_string|&quot;tx&quot;
comma
id|ringsize
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, using default=8&bslash;n&quot;
)paren
suffix:semicolon
id|ringsize
(braket
id|i
)braket
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|sirpulse
op_assign
op_logical_neg
op_logical_neg
id|sirpulse
suffix:semicolon
multiline_comment|/* create_proc_entry returns NULL if !CONFIG_PROC_FS.&n;&t; * Failure to create the procfs entry is handled like running&n;&t; * without procfs - it&squot;s not required for the driver to work.&n;&t; */
id|vlsi_proc_root
op_assign
id|create_proc_entry
c_func
(paren
id|PROC_DIR
comma
id|S_IFDIR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vlsi_proc_root
)paren
(brace
multiline_comment|/* protect registered procdir against module removal.&n;&t;&t; * Because we are in the module init path there&squot;s no race&n;&t;&t; * window after create_proc_entry (and no barrier needed).&n;&t;&t; */
id|vlsi_proc_root-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
)brace
id|ret
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|vlsi_irda_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_and
id|vlsi_proc_root
)paren
id|remove_proc_entry
c_func
(paren
id|PROC_DIR
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vlsi_mod_exit
r_static
r_void
id|__exit
id|vlsi_mod_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|vlsi_irda_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vlsi_proc_root
)paren
id|remove_proc_entry
c_func
(paren
id|PROC_DIR
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|vlsi_mod_init
id|module_init
c_func
(paren
id|vlsi_mod_init
)paren
suffix:semicolon
DECL|variable|vlsi_mod_exit
id|module_exit
c_func
(paren
id|vlsi_mod_exit
)paren
suffix:semicolon
eof
