multiline_comment|/*****************************************************************&n; *&n; * Filename:&t;&t;donauboe.c&n; * Version: &t;&t;2.17&n; * Description:   Driver for the Toshiba OBOE (or type-O or 701)&n; *                FIR Chipset, also supports the DONAUOBOE (type-DO&n; *                or d01) FIR chipset which as far as I know is&n; *                register compatible.&n; * Documentation: http://libxg.free.fr/irda/lib-irda.html&n; * Status:        Experimental.&n; * Author:        James McKenzie &lt;james@fishsoup.dhs.org&gt;&n; * Created at:    Sat May 8  12:35:27 1999&n; * Modified:      Paul Bristow &lt;paul.bristow@technologist.com&gt;&n; * Modified:      Mon Nov 11 19:10:05 1999&n; * Modified:      James McKenzie &lt;james@fishsoup.dhs.org&gt;&n; * Modified:      Thu Mar 16 12:49:00 2000 (Substantial rewrite)&n; * Modified:      Sat Apr 29 00:23:03 2000 (Added DONAUOBOE support)&n; * Modified:      Wed May 24 23:45:02 2000 (Fixed chipio_t structure)&n; * Modified: 2.13 Christian Gennerat &lt;christian.gennerat@polytechnique.org&gt;&n; * Modified: 2.13 dim jan 07 21:57:39 2001 (tested with kernel 2.4 &amp; irnet/ppp)&n; * Modified: 2.14 Christian Gennerat &lt;christian.gennerat@polytechnique.org&gt;&n; * Modified: 2.14 lun fev 05 17:55:59 2001 (adapted to patch-2.4.1-pre8-irda1)&n; * Modified: 2.15 Martin Lucina &lt;mato@kotelna.sk&gt;&n; * Modified: 2.15 Fri Jun 21 20:40:59 2002 (sync with 2.4.18, substantial fixes)&n; * Modified: 2.16 Martin Lucina &lt;mato@kotelna.sk&gt;&n; * Modified: 2.16 Sat Jun 22 18:54:29 2002 (fix freeregion, default to verbose)&n; * Modified: 2.17 Christian Gennerat &lt;christian.gennerat@polytechnique.org&gt;&n; * Modified: 2.17 jeu sep 12 08:50:20 2002 (save_flags();cli(); replaced by spinlocks)&n; * Modified: 2.18 Christian Gennerat &lt;christian.gennerat@polytechnique.org&gt;&n; * Modified: 2.18 ven jan 10 03:14:16 2003 Change probe default options&n; *&n; *     Copyright (c) 1999 James McKenzie, All Rights Reserved.&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     Neither James McKenzie nor Cambridge University admit liability nor&n; *     provide warranty for any of this software. This material is&n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; *     Applicable Models : Libretto 100/110CT and many more.&n; *     Toshiba refers to this chip as the type-O IR port,&n; *     or the type-DO IR port.&n; *&n; ********************************************************************/
multiline_comment|/* Look at toshoboe.h (currently in include/net/irda) for details of */
multiline_comment|/* Where to get documentation on the chip         */
DECL|variable|rcsid
r_static
r_char
op_star
id|rcsid
op_assign
l_string|&quot;$Id: donauboe.c V2.18 ven jan 10 03:14:16 2003$&quot;
suffix:semicolon
multiline_comment|/* See below for a description of the logic in this driver */
multiline_comment|/* User servicable parts */
multiline_comment|/* USE_PROBE Create the code which probes the chip and does a few tests */
multiline_comment|/* do_probe module parameter Enable this code */
multiline_comment|/* Probe code is very useful for understanding how the hardware works */
multiline_comment|/* Use it with various combinations of TT_LEN, RX_LEN */
multiline_comment|/* Strongly recomended, disable if the probe fails on your machine */
multiline_comment|/* and send me &lt;james@fishsoup.dhs.org&gt; the output of dmesg */
DECL|macro|USE_PROBE
mdefine_line|#define USE_PROBE 1
DECL|macro|USE_PROBE
macro_line|#undef  USE_PROBE
multiline_comment|/* Trace Transmit ring, interrupts, Receive ring or not ? */
DECL|macro|PROBE_VERBOSE
mdefine_line|#define PROBE_VERBOSE 1
multiline_comment|/* Debug option, examine sent and received raw data */
multiline_comment|/* Irdadump is better, but does not see all packets. enable it if you want. */
DECL|macro|DUMP_PACKETS
macro_line|#undef DUMP_PACKETS
multiline_comment|/* MIR mode has not been tested. Some behaviour is different */
multiline_comment|/* Seems to work against an Ericsson R520 for me. -Martin */
DECL|macro|USE_MIR
mdefine_line|#define USE_MIR
multiline_comment|/* Schedule back to back hardware transmits wherever possible, otherwise */
multiline_comment|/* we need an interrupt for every frame, unset if oboe works for a bit and */
multiline_comment|/* then hangs */
DECL|macro|OPTIMIZE_TX
mdefine_line|#define OPTIMIZE_TX
multiline_comment|/* Set the number of slots in the rings */
multiline_comment|/* If you get rx/tx fifo overflows at high bitrates, you can try increasing */
multiline_comment|/* these */
DECL|macro|RING_SIZE
mdefine_line|#define RING_SIZE (OBOE_RING_SIZE_RX8 | OBOE_RING_SIZE_TX8)
DECL|macro|TX_SLOTS
mdefine_line|#define TX_SLOTS    8
DECL|macro|RX_SLOTS
mdefine_line|#define RX_SLOTS    8
multiline_comment|/* Less user servicable parts below here */
multiline_comment|/* Test, Transmit and receive buffer sizes, adjust at your peril */
multiline_comment|/* remarks: nfs usually needs 1k blocks */
multiline_comment|/* remarks: in SIR mode, CRC is received, -&gt; RX_LEN=TX_LEN+2 */
multiline_comment|/* remarks: test accepts large blocks. Standard is 0x80 */
multiline_comment|/* When TT_LEN &gt; RX_LEN (SIR mode) data is stored in successive slots. */
multiline_comment|/* When 3 or more slots are needed for each test packet, */
multiline_comment|/* data received in the first slots is overwritten, even */
multiline_comment|/* if OBOE_CTL_RX_HW_OWNS is not set, without any error! */
DECL|macro|TT_LEN
mdefine_line|#define TT_LEN      0x80
DECL|macro|TX_LEN
mdefine_line|#define TX_LEN      0xc00
DECL|macro|RX_LEN
mdefine_line|#define RX_LEN      0xc04
multiline_comment|/* Real transmitted length (SIR mode) is about 14+(2%*TX_LEN) more */
multiline_comment|/* long than user-defined length (see async_wrap_skb) and is less then 4K */
multiline_comment|/* Real received length is (max RX_LEN) differs from user-defined */
multiline_comment|/* length only b the CRC (2 or 4 bytes) */
DECL|macro|BUF_SAFETY
mdefine_line|#define BUF_SAFETY  0x7a
DECL|macro|RX_BUF_SZ
mdefine_line|#define RX_BUF_SZ   (RX_LEN)
DECL|macro|TX_BUF_SZ
mdefine_line|#define TX_BUF_SZ   (TX_LEN+BUF_SAFETY)
multiline_comment|/* Logic of the netdev part of this driver                             */
multiline_comment|/* The RX ring is filled with buffers, when a packet arrives           */
multiline_comment|/* it is DMA&squot;d into the buffer which is marked used and RxDone called  */
multiline_comment|/* RxDone forms an skb (and checks the CRC if in SIR mode) and ships   */
multiline_comment|/* the packet off upstairs */
multiline_comment|/* The transmitter on the oboe chip can work in one of two modes       */
multiline_comment|/* for each ring-&gt;tx[] the transmitter can either                      */
multiline_comment|/* a) transmit the packet, leave the trasmitter enabled and proceed to */
multiline_comment|/*    the next ring                                                    */
multiline_comment|/* OR                                                                  */
multiline_comment|/* b) transmit the packet, switch off the transmitter and issue TxDone */
multiline_comment|/* All packets are entered into the ring in mode b), if the ring was   */
multiline_comment|/* empty the transmitter is started.                                   */
multiline_comment|/* If OPTIMIZE_TX is defined then in TxDone if the ring contains       */
multiline_comment|/* more than one packet, all but the last are set to mode a) [HOWEVER  */
multiline_comment|/* the hardware may not notice this, this is why we start in mode b) ] */
multiline_comment|/* then restart the transmitter                                        */
multiline_comment|/* If OPTIMIZE_TX is not defined then we just restart the transmitter  */
multiline_comment|/* if the ring isn&squot;t empty */
multiline_comment|/* Speed changes are delayed until the TxRing is empty                 */
multiline_comment|/* mtt is handled by generating packets with bad CRCs, before the data */
multiline_comment|/* TODO: */
multiline_comment|/* check the mtt works ok      */
multiline_comment|/* finish the watchdog         */
multiline_comment|/* No user servicable parts below here */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
singleline_comment|//#include &lt;net/irda/irmod.h&gt;
singleline_comment|//#include &lt;net/irda/irlap_frame.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/crc.h&gt;
macro_line|#include &quot;donauboe.h&quot;
DECL|macro|INB
mdefine_line|#define INB(port)       inb_p(port)
DECL|macro|OUTB
mdefine_line|#define OUTB(val,port)  outb_p(val,port)
DECL|macro|OUTBP
mdefine_line|#define OUTBP(val,port) outb_p(val,port)
DECL|macro|PROMPT
mdefine_line|#define PROMPT  OUTB(OBOE_PROMPT_BIT,OBOE_PROMPT);
macro_line|#if PROBE_VERBOSE
DECL|macro|PROBE_DEBUG
mdefine_line|#define PROBE_DEBUG(args...) (printk (args))
macro_line|#else
DECL|macro|PROBE_DEBUG
mdefine_line|#define PROBE_DEBUG(args...) ;
macro_line|#endif
multiline_comment|/* Set the DMA to be byte at a time */
DECL|macro|CONFIG0H_DMA_OFF
mdefine_line|#define CONFIG0H_DMA_OFF OBOE_CONFIG0H_RCVANY
DECL|macro|CONFIG0H_DMA_ON_NORX
mdefine_line|#define CONFIG0H_DMA_ON_NORX CONFIG0H_DMA_OFF| OBOE_CONFIG0H_ENDMAC
DECL|macro|CONFIG0H_DMA_ON
mdefine_line|#define CONFIG0H_DMA_ON CONFIG0H_DMA_ON_NORX | OBOE_CONFIG0H_ENRX
DECL|variable|toshoboe_pci_tbl
r_static
r_struct
id|pci_device_id
id|toshoboe_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_TOSHIBA
comma
id|PCI_DEVICE_ID_FIR701
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
id|PCI_VENDOR_ID_TOSHIBA
comma
id|PCI_DEVICE_ID_FIRD01
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|toshoboe_pci_tbl
)paren
suffix:semicolon
DECL|macro|DRIVER_NAME
mdefine_line|#define DRIVER_NAME &quot;toshoboe&quot;
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
id|DRIVER_NAME
suffix:semicolon
DECL|variable|max_baud
r_static
r_int
id|max_baud
op_assign
l_int|4000000
suffix:semicolon
macro_line|#ifdef USE_PROBE
DECL|variable|do_probe
r_static
r_int
id|do_probe
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/**********************************************************************/
r_static
r_int
DECL|function|toshoboe_checkfcs
id|toshoboe_checkfcs
(paren
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_union
(brace
id|__u16
id|value
suffix:semicolon
id|__u8
id|bytes
(braket
l_int|2
)braket
suffix:semicolon
)brace
id|fcs
suffix:semicolon
id|fcs.value
op_assign
id|INIT_FCS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
op_increment
id|i
)paren
id|fcs.value
op_assign
id|irda_fcs
(paren
id|fcs.value
comma
op_star
(paren
id|buf
op_increment
)paren
)paren
suffix:semicolon
r_return
(paren
id|fcs.value
op_eq
id|GOOD_FCS
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************/
multiline_comment|/* Generic chip handling code */
macro_line|#ifdef DUMP_PACKETS
DECL|variable|dump
r_static
r_int
r_char
id|dump
(braket
l_int|50
)braket
suffix:semicolon
r_static
r_void
DECL|function|_dumpbufs
id|_dumpbufs
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
comma
r_char
id|tete
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_char
id|head
op_assign
id|tete
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_add_assign
l_int|16
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|16
op_logical_and
id|i
op_plus
id|j
OL
id|len
suffix:semicolon
id|j
op_increment
)paren
(brace
id|sprintf
c_func
(paren
op_amp
id|dump
(braket
l_int|3
op_star
id|j
)braket
comma
l_string|&quot;%02x.&quot;
comma
id|data
(braket
id|i
op_plus
id|j
)braket
)paren
suffix:semicolon
)brace
id|dump
(braket
l_int|3
op_star
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|2
comma
l_string|&quot;%c%s&bslash;n&quot;
comma
id|head
comma
id|dump
)paren
suffix:semicolon
id|head
op_assign
l_char|&squot;+&squot;
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifdef USE_PROBE
multiline_comment|/* Dump the registers */
r_static
r_void
DECL|function|toshoboe_dumpregs
id|toshoboe_dumpregs
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|__u32
id|ringbase
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ringbase
op_assign
id|INB
(paren
id|OBOE_RING_BASE0
)paren
op_lshift
l_int|10
suffix:semicolon
id|ringbase
op_or_assign
id|INB
(paren
id|OBOE_RING_BASE1
)paren
op_lshift
l_int|18
suffix:semicolon
id|ringbase
op_or_assign
id|INB
(paren
id|OBOE_RING_BASE2
)paren
op_lshift
l_int|26
suffix:semicolon
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: Register dump:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;Interrupts: Tx:%d Rx:%d TxUnder:%d RxOver:%d Sip:%d&bslash;n&quot;
comma
id|self-&gt;int_tx
comma
id|self-&gt;int_rx
comma
id|self-&gt;int_txunder
comma
id|self-&gt;int_rxover
comma
id|self-&gt;int_sip
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;RX %02x TX %02x RingBase %08x&bslash;n&quot;
comma
id|INB
(paren
id|OBOE_RXSLOT
)paren
comma
id|INB
(paren
id|OBOE_TXSLOT
)paren
comma
id|ringbase
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;RING_SIZE %02x IER %02x ISR %02x&bslash;n&quot;
comma
id|INB
(paren
id|OBOE_RING_SIZE
)paren
comma
id|INB
(paren
id|OBOE_IER
)paren
comma
id|INB
(paren
id|OBOE_ISR
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;CONFIG1 %02x STATUS %02x&bslash;n&quot;
comma
id|INB
(paren
id|OBOE_CONFIG1
)paren
comma
id|INB
(paren
id|OBOE_STATUS
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;CONFIG0 %02x%02x ENABLE %02x%02x&bslash;n&quot;
comma
id|INB
(paren
id|OBOE_CONFIG0H
)paren
comma
id|INB
(paren
id|OBOE_CONFIG0L
)paren
comma
id|INB
(paren
id|OBOE_ENABLEH
)paren
comma
id|INB
(paren
id|OBOE_ENABLEL
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;NEW_PCONFIG %02x%02x CURR_PCONFIG %02x%02x&bslash;n&quot;
comma
id|INB
(paren
id|OBOE_NEW_PCONFIGH
)paren
comma
id|INB
(paren
id|OBOE_NEW_PCONFIGL
)paren
comma
id|INB
(paren
id|OBOE_CURR_PCONFIGH
)paren
comma
id|INB
(paren
id|OBOE_CURR_PCONFIGL
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;MAXLEN %02x%02x RXCOUNT %02x%02x&bslash;n&quot;
comma
id|INB
(paren
id|OBOE_MAXLENH
)paren
comma
id|INB
(paren
id|OBOE_MAXLENL
)paren
comma
id|INB
(paren
id|OBOE_RXCOUNTL
)paren
comma
id|INB
(paren
id|OBOE_RXCOUNTH
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;ring
)paren
(brace
r_int
id|i
suffix:semicolon
id|ringbase
op_assign
id|virt_to_bus
(paren
id|self-&gt;ring
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;Ring at %08x:&bslash;n&quot;
comma
id|ringbase
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;RX:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
id|printk
(paren
l_string|&quot; (%d,%02x)&quot;
comma
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|len
comma
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|control
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;TX:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
id|printk
(paren
l_string|&quot; (%d,%02x)&quot;
comma
id|self-&gt;ring-&gt;tx
(braket
id|i
)braket
dot
id|len
comma
id|self-&gt;ring-&gt;tx
(braket
id|i
)braket
dot
id|control
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*Don&squot;t let the chip look at memory */
r_static
r_void
DECL|function|toshoboe_disablebm
id|toshoboe_disablebm
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|__u8
id|command
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|self-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_and_assign
op_complement
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_byte
(paren
id|self-&gt;pdev
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
)brace
multiline_comment|/* Shutdown the chip and point the taskfile reg somewhere else */
r_static
r_void
DECL|function|toshoboe_stopchip
id|toshoboe_stopchip
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/*Disable interrupts */
id|OUTB
(paren
l_int|0x0
comma
id|OBOE_IER
)paren
suffix:semicolon
multiline_comment|/*Disable DMA, Disable Rx, Disable Tx */
id|OUTB
(paren
id|CONFIG0H_DMA_OFF
comma
id|OBOE_CONFIG0H
)paren
suffix:semicolon
multiline_comment|/*Disable SIR MIR FIR, Tx and Rx */
id|OUTB
(paren
l_int|0x00
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
multiline_comment|/*Point the ring somewhere safe */
id|OUTB
(paren
l_int|0x3f
comma
id|OBOE_RING_BASE2
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0xff
comma
id|OBOE_RING_BASE1
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0xff
comma
id|OBOE_RING_BASE0
)paren
suffix:semicolon
id|OUTB
(paren
id|RX_LEN
op_rshift
l_int|8
comma
id|OBOE_MAXLENH
)paren
suffix:semicolon
id|OUTB
(paren
id|RX_LEN
op_amp
l_int|0xff
comma
id|OBOE_MAXLENL
)paren
suffix:semicolon
multiline_comment|/*Acknoledge any pending interrupts */
id|OUTB
(paren
l_int|0xff
comma
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/*Why */
id|OUTB
(paren
id|OBOE_ENABLEH_PHYANDCLOCK
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
multiline_comment|/*switch it off */
id|OUTB
(paren
id|OBOE_CONFIG1_OFF
comma
id|OBOE_CONFIG1
)paren
suffix:semicolon
id|toshoboe_disablebm
(paren
id|self
)paren
suffix:semicolon
)brace
multiline_comment|/* Transmitter initialization */
r_static
r_void
DECL|function|toshoboe_start_DMA
id|toshoboe_start_DMA
(paren
r_struct
id|toshoboe_cb
op_star
id|self
comma
r_int
id|opts
)paren
(brace
id|OUTB
(paren
l_int|0x0
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
id|OUTB
(paren
id|CONFIG0H_DMA_ON
op_or
id|opts
comma
id|OBOE_CONFIG0H
)paren
suffix:semicolon
id|OUTB
(paren
id|OBOE_ENABLEH_PHYANDCLOCK
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
id|PROMPT
suffix:semicolon
)brace
multiline_comment|/*Set the baud rate */
r_static
r_void
DECL|function|toshoboe_setbaud
id|toshoboe_setbaud
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|__u16
id|pconfig
op_assign
l_int|0
suffix:semicolon
id|__u8
id|config0l
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|2
comma
l_string|&quot;%s(%d/%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;speed
comma
id|self-&gt;io.speed
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|self-&gt;speed
)paren
(brace
r_case
l_int|2400
suffix:colon
r_case
l_int|4800
suffix:colon
r_case
l_int|9600
suffix:colon
r_case
l_int|19200
suffix:colon
r_case
l_int|38400
suffix:colon
r_case
l_int|57600
suffix:colon
r_case
l_int|115200
suffix:colon
macro_line|#ifdef USE_MIR
r_case
l_int|1152000
suffix:colon
macro_line|#endif
r_case
l_int|4000000
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: switch to unsupported baudrate %d&bslash;n&quot;
comma
id|self-&gt;speed
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|self-&gt;speed
)paren
(brace
multiline_comment|/* For SIR the preamble is done by adding XBOFs */
multiline_comment|/* to the packet */
multiline_comment|/* set to filtered SIR mode, filter looks for BOF and EOF */
r_case
l_int|2400
suffix:colon
id|pconfig
op_or_assign
l_int|47
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|25
op_lshift
id|OBOE_PCONFIG_WIDTHSHIFT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|pconfig
op_or_assign
l_int|23
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|25
op_lshift
id|OBOE_PCONFIG_WIDTHSHIFT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|pconfig
op_or_assign
l_int|11
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|25
op_lshift
id|OBOE_PCONFIG_WIDTHSHIFT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|pconfig
op_or_assign
l_int|5
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|25
op_lshift
id|OBOE_PCONFIG_WIDTHSHIFT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|pconfig
op_or_assign
l_int|2
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|25
op_lshift
id|OBOE_PCONFIG_WIDTHSHIFT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|pconfig
op_or_assign
l_int|1
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|25
op_lshift
id|OBOE_PCONFIG_WIDTHSHIFT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|pconfig
op_or_assign
l_int|0
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|25
op_lshift
id|OBOE_PCONFIG_WIDTHSHIFT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*Set to packet based reception */
id|OUTB
(paren
id|RX_LEN
op_rshift
l_int|8
comma
id|OBOE_MAXLENH
)paren
suffix:semicolon
id|OUTB
(paren
id|RX_LEN
op_amp
l_int|0xff
comma
id|OBOE_MAXLENL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|self-&gt;speed
)paren
(brace
r_case
l_int|2400
suffix:colon
r_case
l_int|4800
suffix:colon
r_case
l_int|9600
suffix:colon
r_case
l_int|19200
suffix:colon
r_case
l_int|38400
suffix:colon
r_case
l_int|57600
suffix:colon
r_case
l_int|115200
suffix:colon
id|config0l
op_assign
id|OBOE_CONFIG0L_ENSIR
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;async
)paren
(brace
multiline_comment|/*Set to character based reception */
multiline_comment|/*System will lock if MAXLEN=0 */
multiline_comment|/*so have to be careful */
id|OUTB
(paren
l_int|0x01
comma
id|OBOE_MAXLENH
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0x01
comma
id|OBOE_MAXLENL
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0x00
comma
id|OBOE_MAXLENH
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*Set to packet based reception */
id|config0l
op_or_assign
id|OBOE_CONFIG0L_ENSIRF
suffix:semicolon
id|OUTB
(paren
id|RX_LEN
op_rshift
l_int|8
comma
id|OBOE_MAXLENH
)paren
suffix:semicolon
id|OUTB
(paren
id|RX_LEN
op_amp
l_int|0xff
comma
id|OBOE_MAXLENL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#ifdef USE_MIR
multiline_comment|/* MIR mode */
multiline_comment|/* Set for 16 bit CRC and enable MIR */
multiline_comment|/* Preamble now handled by the chip */
r_case
l_int|1152000
suffix:colon
id|pconfig
op_or_assign
l_int|0
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|8
op_lshift
id|OBOE_PCONFIG_WIDTHSHIFT
suffix:semicolon
id|pconfig
op_or_assign
l_int|1
op_lshift
id|OBOE_PCONFIG_PREAMBLESHIFT
suffix:semicolon
id|config0l
op_assign
id|OBOE_CONFIG0L_CRC16
op_or
id|OBOE_CONFIG0L_ENMIR
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
multiline_comment|/* FIR mode */
multiline_comment|/* Set for 32 bit CRC and enable FIR */
multiline_comment|/* Preamble handled by the chip */
r_case
l_int|4000000
suffix:colon
id|pconfig
op_or_assign
l_int|0
op_lshift
id|OBOE_PCONFIG_BAUDSHIFT
suffix:semicolon
multiline_comment|/* Documentation says 14, but toshiba use 15 in their drivers */
id|pconfig
op_or_assign
l_int|15
op_lshift
id|OBOE_PCONFIG_PREAMBLESHIFT
suffix:semicolon
id|config0l
op_assign
id|OBOE_CONFIG0L_ENFIR
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Copy into new PHY config buffer */
id|OUTBP
(paren
id|pconfig
op_rshift
l_int|8
comma
id|OBOE_NEW_PCONFIGH
)paren
suffix:semicolon
id|OUTB
(paren
id|pconfig
op_amp
l_int|0xff
comma
id|OBOE_NEW_PCONFIGL
)paren
suffix:semicolon
id|OUTB
(paren
id|config0l
comma
id|OBOE_CONFIG0L
)paren
suffix:semicolon
multiline_comment|/* Now make OBOE copy from new PHY to current PHY */
id|OUTB
(paren
l_int|0x0
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
id|OUTB
(paren
id|OBOE_ENABLEH_PHYANDCLOCK
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
id|PROMPT
suffix:semicolon
multiline_comment|/* speed change executed */
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
id|self-&gt;io.speed
op_assign
id|self-&gt;speed
suffix:semicolon
)brace
multiline_comment|/*Let the chip look at memory */
r_static
r_void
DECL|function|toshoboe_enablebm
id|toshoboe_enablebm
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|pci_set_master
(paren
id|self-&gt;pdev
)paren
suffix:semicolon
)brace
multiline_comment|/*setup the ring */
r_static
r_void
DECL|function|toshoboe_initring
id|toshoboe_initring
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;ring-&gt;tx
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|i
)braket
dot
id|control
op_assign
l_int|0x00
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|i
)braket
dot
id|address
op_assign
id|virt_to_bus
(paren
id|self-&gt;tx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|len
op_assign
id|RX_LEN
suffix:semicolon
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|address
op_assign
id|virt_to_bus
(paren
id|self-&gt;rx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|control
op_assign
id|OBOE_CTL_RX_HW_OWNS
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|toshoboe_resetptrs
id|toshoboe_resetptrs
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
multiline_comment|/* Can reset pointers by twidling DMA */
id|OUTB
(paren
l_int|0x0
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
id|OUTBP
(paren
id|CONFIG0H_DMA_OFF
comma
id|OBOE_CONFIG0H
)paren
suffix:semicolon
id|OUTB
(paren
id|OBOE_ENABLEH_PHYANDCLOCK
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
id|self-&gt;rxs
op_assign
id|inb_p
(paren
id|OBOE_RXSLOT
)paren
op_amp
id|OBOE_SLOT_MASK
suffix:semicolon
id|self-&gt;txs
op_assign
id|inb_p
(paren
id|OBOE_TXSLOT
)paren
op_amp
id|OBOE_SLOT_MASK
suffix:semicolon
)brace
multiline_comment|/* Called in locked state */
r_static
r_void
DECL|function|toshoboe_initptrs
id|toshoboe_initptrs
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
multiline_comment|/* spin_lock_irqsave(self-&gt;spinlock, flags); */
multiline_comment|/* save_flags (flags); */
multiline_comment|/* Can reset pointers by twidling DMA */
id|toshoboe_resetptrs
(paren
id|self
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0x0
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
id|OUTB
(paren
id|CONFIG0H_DMA_ON
comma
id|OBOE_CONFIG0H
)paren
suffix:semicolon
id|OUTB
(paren
id|OBOE_ENABLEH_PHYANDCLOCK
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
id|self-&gt;txpending
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* spin_unlock_irqrestore(self-&gt;spinlock, flags); */
multiline_comment|/* restore_flags (flags); */
)brace
multiline_comment|/* Wake the chip up and get it looking at the rings */
multiline_comment|/* Called in locked state */
r_static
r_void
DECL|function|toshoboe_startchip
id|toshoboe_startchip
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
id|__u32
id|physaddr
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|toshoboe_initring
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_enablebm
(paren
id|self
)paren
suffix:semicolon
id|OUTBP
(paren
id|OBOE_CONFIG1_RESET
comma
id|OBOE_CONFIG1
)paren
suffix:semicolon
id|OUTBP
(paren
id|OBOE_CONFIG1_ON
comma
id|OBOE_CONFIG1
)paren
suffix:semicolon
multiline_comment|/* Stop the clocks */
id|OUTB
(paren
l_int|0
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
multiline_comment|/*Set size of rings */
id|OUTB
(paren
id|RING_SIZE
comma
id|OBOE_RING_SIZE
)paren
suffix:semicolon
multiline_comment|/*Acknoledge any pending interrupts */
id|OUTB
(paren
l_int|0xff
comma
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/*Enable ints */
id|OUTB
(paren
id|OBOE_INT_TXDONE
op_or
id|OBOE_INT_RXDONE
op_or
id|OBOE_INT_TXUNDER
op_or
id|OBOE_INT_RXOVER
op_or
id|OBOE_INT_SIP
comma
id|OBOE_IER
)paren
suffix:semicolon
multiline_comment|/*Acknoledge any pending interrupts */
id|OUTB
(paren
l_int|0xff
comma
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/*Set the maximum packet length to 0xfff (4095) */
id|OUTB
(paren
id|RX_LEN
op_rshift
l_int|8
comma
id|OBOE_MAXLENH
)paren
suffix:semicolon
id|OUTB
(paren
id|RX_LEN
op_amp
l_int|0xff
comma
id|OBOE_MAXLENL
)paren
suffix:semicolon
multiline_comment|/*Shutdown DMA */
id|OUTB
(paren
id|CONFIG0H_DMA_OFF
comma
id|OBOE_CONFIG0H
)paren
suffix:semicolon
multiline_comment|/*Find out where the rings live */
id|physaddr
op_assign
id|virt_to_bus
(paren
id|self-&gt;ring
)paren
suffix:semicolon
id|ASSERT
(paren
(paren
id|physaddr
op_amp
l_int|0x3ff
)paren
op_eq
l_int|0
comma
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;ring not correctly aligned&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)paren
suffix:semicolon
id|OUTB
(paren
(paren
id|physaddr
op_rshift
l_int|10
)paren
op_amp
l_int|0xff
comma
id|OBOE_RING_BASE0
)paren
suffix:semicolon
id|OUTB
(paren
(paren
id|physaddr
op_rshift
l_int|18
)paren
op_amp
l_int|0xff
comma
id|OBOE_RING_BASE1
)paren
suffix:semicolon
id|OUTB
(paren
(paren
id|physaddr
op_rshift
l_int|26
)paren
op_amp
l_int|0x3f
comma
id|OBOE_RING_BASE2
)paren
suffix:semicolon
multiline_comment|/*Enable DMA controler in byte mode and RX */
id|OUTB
(paren
id|CONFIG0H_DMA_ON
comma
id|OBOE_CONFIG0H
)paren
suffix:semicolon
multiline_comment|/* Start up the clocks */
id|OUTB
(paren
id|OBOE_ENABLEH_PHYANDCLOCK
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
multiline_comment|/*set to sensible speed */
id|self-&gt;speed
op_assign
l_int|9600
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_initptrs
(paren
id|self
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|toshoboe_isntstuck
id|toshoboe_isntstuck
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
)brace
r_static
r_void
DECL|function|toshoboe_checkstuck
id|toshoboe_checkstuck
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* This will reset the chip completely */
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: Resetting chip&bslash;n&quot;
)paren
suffix:semicolon
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_startchip
(paren
id|self
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*Generate packet of about mtt us long */
r_static
r_int
DECL|function|toshoboe_makemttpacket
id|toshoboe_makemttpacket
(paren
r_struct
id|toshoboe_cb
op_star
id|self
comma
r_void
op_star
id|buf
comma
r_int
id|mtt
)paren
(brace
r_int
id|xbofs
suffix:semicolon
id|xbofs
op_assign
(paren
(paren
r_int
)paren
(paren
id|mtt
op_div
l_int|100
)paren
)paren
op_star
(paren
r_int
)paren
(paren
id|self-&gt;speed
)paren
suffix:semicolon
id|xbofs
op_assign
id|xbofs
op_div
l_int|80000
suffix:semicolon
multiline_comment|/*Eight bits per byte, and mtt is in us*/
id|xbofs
op_increment
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|2
comma
id|DRIVER_NAME
l_string|&quot;: generated mtt of %d bytes for %d us at %d baud&bslash;n&quot;
comma
id|xbofs
comma
id|mtt
comma
id|self-&gt;speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xbofs
OG
id|TX_LEN
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: wanted %d bytes MTT but TX_LEN is %d&bslash;n&quot;
comma
id|xbofs
comma
id|TX_LEN
)paren
suffix:semicolon
id|xbofs
op_assign
id|TX_LEN
suffix:semicolon
)brace
multiline_comment|/*xbofs will do for SIR, MIR and FIR,SIR mode doesn&squot;t generate a checksum anyway */
id|memset
(paren
id|buf
comma
id|XBOF
comma
id|xbofs
)paren
suffix:semicolon
r_return
id|xbofs
suffix:semicolon
)brace
DECL|function|toshoboe_invalid_dev
r_static
r_int
id|toshoboe_invalid_dev
c_func
(paren
r_int
id|irq
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|DRIVER_NAME
l_string|&quot;: irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef USE_PROBE
multiline_comment|/***********************************************************************/
multiline_comment|/* Probe code */
r_static
r_void
DECL|function|toshoboe_dumptx
id|toshoboe_dumptx
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
id|KERN_WARNING
l_string|&quot;TX:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
id|PROBE_DEBUG
c_func
(paren
l_string|&quot; (%d,%02x)&quot;
comma
id|self-&gt;ring-&gt;tx
(braket
id|i
)braket
dot
id|len
comma
id|self-&gt;ring-&gt;tx
(braket
id|i
)braket
dot
id|control
)paren
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot; [%d]&bslash;n&quot;
comma
id|self-&gt;speed
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|toshoboe_dumprx
id|toshoboe_dumprx
(paren
r_struct
id|toshoboe_cb
op_star
id|self
comma
r_int
id|score
)paren
(brace
r_int
id|i
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot; %d&bslash;nRX:&quot;
comma
id|score
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
id|PROBE_DEBUG
c_func
(paren
l_string|&quot; (%d,%02x)&quot;
comma
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|len
comma
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|control
)paren
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|stuff_byte
id|stuff_byte
(paren
id|__u8
id|byte
comma
id|__u8
op_star
id|buf
)paren
(brace
r_switch
c_cond
(paren
id|byte
)paren
(brace
r_case
id|BOF
suffix:colon
multiline_comment|/* FALLTHROUGH */
r_case
id|EOF
suffix:colon
multiline_comment|/* FALLTHROUGH */
r_case
id|CE
suffix:colon
multiline_comment|/* Insert transparently coded */
id|buf
(braket
l_int|0
)braket
op_assign
id|CE
suffix:semicolon
multiline_comment|/* Send link escape */
id|buf
(braket
l_int|1
)braket
op_assign
id|byte
op_xor
id|IRDA_TRANS
suffix:semicolon
multiline_comment|/* Complement bit 5 */
r_return
l_int|2
suffix:semicolon
multiline_comment|/* break; */
r_default
suffix:colon
multiline_comment|/* Non-special value, no transparency required */
id|buf
(braket
l_int|0
)braket
op_assign
id|byte
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* break; */
)brace
)brace
r_static
id|irqreturn_t
DECL|function|toshoboe_probeinterrupt
id|toshoboe_probeinterrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev_id
suffix:semicolon
id|__u8
id|irqstat
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
op_logical_and
id|toshoboe_invalid_dev
c_func
(paren
id|irq
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|irqstat
op_assign
id|INB
(paren
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/* was it us */
r_if
c_cond
(paren
op_logical_neg
(paren
id|irqstat
op_amp
id|OBOE_INT_MASK
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/* Ack all the interrupts */
id|OUTB
(paren
id|irqstat
comma
id|OBOE_ISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_TXDONE
)paren
(brace
r_int
id|txp
suffix:semicolon
id|self-&gt;int_tx
op_increment
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot;T&quot;
)paren
suffix:semicolon
id|txp
op_assign
id|INB
(paren
id|OBOE_TXSLOT
)paren
op_amp
id|OBOE_SLOT_MASK
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;ring-&gt;tx
(braket
id|txp
)braket
dot
id|control
op_amp
id|OBOE_CTL_TX_HW_OWNS
)paren
(brace
id|self-&gt;int_tx
op_add_assign
l_int|100
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot;S&quot;
)paren
suffix:semicolon
id|toshoboe_start_DMA
c_func
(paren
id|self
comma
id|OBOE_CONFIG0H_ENTX
op_or
id|OBOE_CONFIG0H_LOOP
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_RXDONE
)paren
(brace
id|self-&gt;int_rx
op_increment
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot;R&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_TXUNDER
)paren
(brace
id|self-&gt;int_txunder
op_increment
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot;U&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_RXOVER
)paren
(brace
id|self-&gt;int_rxover
op_increment
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot;O&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_SIP
)paren
(brace
id|self-&gt;int_sip
op_increment
suffix:semicolon
id|PROBE_DEBUG
c_func
(paren
l_string|&quot;I&quot;
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_maketestpacket
id|toshoboe_maketestpacket
(paren
r_int
r_char
op_star
id|buf
comma
r_int
id|badcrc
comma
r_int
id|fir
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_union
(brace
id|__u16
id|value
suffix:semicolon
id|__u8
id|bytes
(braket
l_int|2
)braket
suffix:semicolon
)brace
id|fcs
suffix:semicolon
r_if
c_cond
(paren
id|fir
)paren
(brace
id|memset
(paren
id|buf
comma
l_int|0
comma
id|TT_LEN
)paren
suffix:semicolon
r_return
(paren
id|TT_LEN
)paren
suffix:semicolon
)brace
id|fcs.value
op_assign
id|INIT_FCS
suffix:semicolon
id|memset
(paren
id|buf
comma
id|XBOF
comma
l_int|10
)paren
suffix:semicolon
id|len
op_add_assign
l_int|10
suffix:semicolon
id|buf
(braket
id|len
op_increment
)braket
op_assign
id|BOF
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TT_LEN
suffix:semicolon
op_increment
id|i
)paren
(brace
id|len
op_add_assign
id|stuff_byte
(paren
id|i
comma
id|buf
op_plus
id|len
)paren
suffix:semicolon
id|fcs.value
op_assign
id|irda_fcs
(paren
id|fcs.value
comma
id|i
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|stuff_byte
(paren
id|fcs.bytes
(braket
l_int|0
)braket
op_xor
id|badcrc
comma
id|buf
op_plus
id|len
)paren
suffix:semicolon
id|len
op_add_assign
id|stuff_byte
(paren
id|fcs.bytes
(braket
l_int|1
)braket
op_xor
id|badcrc
comma
id|buf
op_plus
id|len
)paren
suffix:semicolon
id|buf
(braket
id|len
op_increment
)braket
op_assign
id|EOF
suffix:semicolon
id|len
op_increment
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_probefail
id|toshoboe_probefail
(paren
r_struct
id|toshoboe_cb
op_star
id|self
comma
r_char
op_star
id|msg
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;probe(%d) failed %s&bslash;n&quot;
comma
id|self
op_member_access_from_pointer
id|speed
comma
id|msg
)paren
suffix:semicolon
id|toshoboe_dumpregs
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|free_irq
(paren
id|self-&gt;io.irq
comma
(paren
r_void
op_star
)paren
id|self
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_numvalidrcvs
id|toshoboe_numvalidrcvs
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
(paren
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|control
op_amp
l_int|0xe0
)paren
op_eq
l_int|0
)paren
id|ret
op_increment
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_numrcvs
id|toshoboe_numrcvs
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|self-&gt;ring-&gt;rx
(braket
id|i
)braket
dot
id|control
op_amp
id|OBOE_CTL_RX_HW_OWNS
)paren
)paren
id|ret
op_increment
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_probe
id|toshoboe_probe
(paren
r_struct
id|toshoboe_cb
op_star
id|self
)paren
(brace
r_int
id|i
comma
id|j
comma
id|n
suffix:semicolon
macro_line|#ifdef USE_MIR
r_int
id|bauds
(braket
)braket
op_assign
(brace
l_int|9600
comma
l_int|115200
comma
l_int|4000000
comma
l_int|1152000
)brace
suffix:semicolon
macro_line|#else
r_int
id|bauds
(braket
)braket
op_assign
(brace
l_int|9600
comma
l_int|115200
comma
l_int|4000000
)brace
suffix:semicolon
macro_line|#endif
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|self-&gt;io.irq
comma
id|toshoboe_probeinterrupt
comma
id|self-&gt;io.irqflags
comma
l_string|&quot;toshoboe&quot;
comma
(paren
r_void
op_star
)paren
id|self
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: probe failed to allocate irq %d&bslash;n&quot;
comma
id|self-&gt;io.irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* test 1: SIR filter and back to back */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
r_sizeof
(paren
id|bauds
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
op_increment
id|j
)paren
(brace
r_int
id|fir
op_assign
(paren
id|j
OG
l_int|1
)paren
suffix:semicolon
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*Address is already setup */
id|toshoboe_startchip
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;int_rx
op_assign
id|self-&gt;int_tx
op_assign
l_int|0
suffix:semicolon
id|self-&gt;speed
op_assign
id|bauds
(braket
id|j
)braket
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_initptrs
(paren
id|self
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
multiline_comment|/*   (FIR only) OBOE_CTL_TX_SIP needed for switching to next slot */
multiline_comment|/*    MIR: all received data is stored in one slot */
(paren
id|fir
)paren
ques
c_cond
id|OBOE_CTL_TX_HW_OWNS
op_or
id|OBOE_CTL_TX_RTCENTX
suffix:colon
id|OBOE_CTL_TX_HW_OWNS
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
id|toshoboe_maketestpacket
(paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
comma
l_int|0
comma
id|fir
)paren
suffix:semicolon
id|self-&gt;txs
op_increment
suffix:semicolon
id|self-&gt;txs
op_mod_assign
id|TX_SLOTS
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
(paren
id|fir
)paren
ques
c_cond
id|OBOE_CTL_TX_HW_OWNS
op_or
id|OBOE_CTL_TX_SIP
suffix:colon
id|OBOE_CTL_TX_HW_OWNS
op_or
id|OBOE_CTL_TX_RTCENTX
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
id|toshoboe_maketestpacket
(paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
comma
l_int|0
comma
id|fir
)paren
suffix:semicolon
id|self-&gt;txs
op_increment
suffix:semicolon
id|self-&gt;txs
op_mod_assign
id|TX_SLOTS
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
(paren
id|fir
)paren
ques
c_cond
id|OBOE_CTL_TX_HW_OWNS
op_or
id|OBOE_CTL_TX_RTCENTX
suffix:colon
id|OBOE_CTL_TX_HW_OWNS
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
id|toshoboe_maketestpacket
(paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
comma
l_int|0
comma
id|fir
)paren
suffix:semicolon
id|self-&gt;txs
op_increment
suffix:semicolon
id|self-&gt;txs
op_mod_assign
id|TX_SLOTS
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
(paren
id|fir
)paren
ques
c_cond
id|OBOE_CTL_TX_HW_OWNS
op_or
id|OBOE_CTL_TX_RTCENTX
op_or
id|OBOE_CTL_TX_SIP
op_or
id|OBOE_CTL_TX_BAD_CRC
suffix:colon
id|OBOE_CTL_TX_HW_OWNS
op_or
id|OBOE_CTL_TX_RTCENTX
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
id|toshoboe_maketestpacket
(paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
comma
l_int|0
comma
id|fir
)paren
suffix:semicolon
id|self-&gt;txs
op_increment
suffix:semicolon
id|self-&gt;txs
op_mod_assign
id|TX_SLOTS
suffix:semicolon
id|toshoboe_dumptx
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Turn on TX and RX and loopback */
id|toshoboe_start_DMA
c_func
(paren
id|self
comma
id|OBOE_CONFIG0H_ENTX
op_or
id|OBOE_CONFIG0H_LOOP
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|n
op_assign
id|fir
ques
c_cond
l_int|1
suffix:colon
l_int|4
suffix:semicolon
r_while
c_loop
(paren
id|toshoboe_numvalidrcvs
(paren
id|self
)paren
op_ne
id|n
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|4800
)paren
r_return
id|toshoboe_probefail
(paren
id|self
comma
l_string|&quot;filter test&quot;
)paren
suffix:semicolon
id|udelay
(paren
(paren
l_int|9600
op_star
(paren
id|TT_LEN
op_plus
l_int|16
)paren
)paren
op_div
id|self-&gt;speed
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|n
op_assign
id|fir
ques
c_cond
l_int|203
suffix:colon
l_int|102
suffix:semicolon
r_while
c_loop
(paren
(paren
id|toshoboe_numrcvs
c_func
(paren
id|self
)paren
op_ne
id|self-&gt;int_rx
)paren
op_logical_or
(paren
id|self-&gt;int_tx
op_ne
id|n
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|4800
)paren
r_return
id|toshoboe_probefail
(paren
id|self
comma
l_string|&quot;interrupt test&quot;
)paren
suffix:semicolon
id|udelay
(paren
(paren
l_int|9600
op_star
(paren
id|TT_LEN
op_plus
l_int|16
)paren
)paren
op_div
id|self-&gt;speed
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|toshoboe_dumprx
(paren
id|self
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* test 2: SIR in char at a time */
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;int_rx
op_assign
id|self-&gt;int_tx
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|toshoboe_startchip
(paren
id|self
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|self-&gt;async
op_assign
l_int|1
suffix:semicolon
id|self-&gt;speed
op_assign
l_int|115200
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
id|OBOE_CTL_TX_RTCENTX
op_or
id|OBOE_CTL_TX_HW_OWNS
suffix:semicolon
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
l_int|4
suffix:semicolon
(paren
(paren
r_int
r_char
op_star
)paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
)paren
(braket
l_int|0
)braket
op_assign
l_char|&squot;f&squot;
suffix:semicolon
(paren
(paren
r_int
r_char
op_star
)paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
)paren
(braket
l_int|1
)braket
op_assign
l_char|&squot;i&squot;
suffix:semicolon
(paren
(paren
r_int
r_char
op_star
)paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
)paren
(braket
l_int|2
)braket
op_assign
l_char|&squot;s&squot;
suffix:semicolon
(paren
(paren
r_int
r_char
op_star
)paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
)paren
(braket
l_int|3
)braket
op_assign
l_char|&squot;h&squot;
suffix:semicolon
id|toshoboe_dumptx
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_start_DMA
c_func
(paren
id|self
comma
id|OBOE_CONFIG0H_ENTX
op_or
id|OBOE_CONFIG0H_LOOP
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|toshoboe_numvalidrcvs
(paren
id|self
)paren
op_ne
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|100
)paren
r_return
id|toshoboe_probefail
(paren
id|self
comma
l_string|&quot;Async test&quot;
)paren
suffix:semicolon
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|toshoboe_numrcvs
(paren
id|self
)paren
op_ne
id|self-&gt;int_rx
)paren
op_logical_or
(paren
id|self-&gt;int_tx
op_ne
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|100
)paren
r_return
id|toshoboe_probefail
(paren
id|self
comma
l_string|&quot;Async interrupt test&quot;
)paren
suffix:semicolon
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|toshoboe_dumprx
(paren
id|self
comma
id|i
)paren
suffix:semicolon
id|self-&gt;async
op_assign
l_int|0
suffix:semicolon
id|self-&gt;speed
op_assign
l_int|9600
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
)paren
suffix:semicolon
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|free_irq
(paren
id|self-&gt;io.irq
comma
(paren
r_void
op_star
)paren
id|self
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|DRIVER_NAME
l_string|&quot;: Self test passed ok&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/******************************************************************/
multiline_comment|/* Netdev style code */
multiline_comment|/* Transmit something */
r_static
r_int
DECL|function|toshoboe_hard_xmit
id|toshoboe_hard_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|__s32
id|speed
suffix:semicolon
r_int
id|mtt
comma
id|len
comma
id|ctl
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|irda_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|irda_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s.tx:%x(%x)%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|skb-&gt;len
comma
id|self-&gt;txpending
comma
id|INB
(paren
id|OBOE_ENABLEH
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cb-&gt;magic
)paren
(brace
id|IRDA_DEBUG
(paren
l_int|2
comma
l_string|&quot;%s.Not IrLAP:%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cb-&gt;magic
)paren
suffix:semicolon
macro_line|#ifdef DUMP_PACKETS
id|_dumpbufs
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_char|&squot;&gt;&squot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* change speed pending, wait for its execution */
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* device stopped (apm) wait for restart */
r_if
c_cond
(paren
id|self-&gt;stopped
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|toshoboe_checkstuck
(paren
id|self
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
multiline_comment|/* But not now. Wait after transmission if mtt not required */
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|speed
op_ne
id|self-&gt;io.speed
)paren
op_logical_and
(paren
id|speed
op_ne
op_minus
l_int|1
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;txpending
op_logical_or
id|skb-&gt;len
)paren
(brace
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s: Queued TxDone scheduled speed change %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|speed
)paren
suffix:semicolon
multiline_comment|/* if no data, that&squot;s all! */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* True packet, go on, but */
multiline_comment|/* do not accept anything before change speed execution */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* ready to process TxDone interrupt */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* idle and no data, change speed now */
id|self-&gt;speed
op_assign
id|speed
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|mtt
op_assign
id|irda_get_mtt
c_func
(paren
id|skb
)paren
)paren
)paren
(brace
multiline_comment|/* This is fair since the queue should be empty anyway */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;txpending
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* If in SIR mode we need to generate a string of XBOFs */
multiline_comment|/* In MIR and FIR we need to generate a string of data */
multiline_comment|/* which we will add a wrong checksum to */
id|mtt
op_assign
id|toshoboe_makemttpacket
(paren
id|self
comma
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
comma
id|mtt
)paren
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s.mtt:%x(%x)%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|skb-&gt;len
comma
id|mtt
comma
id|self-&gt;txpending
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtt
)paren
(brace
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
id|mtt
op_amp
l_int|0xfff
suffix:semicolon
id|ctl
op_assign
id|OBOE_CTL_TX_HW_OWNS
op_or
id|OBOE_CTL_TX_RTCENTX
suffix:semicolon
r_if
c_cond
(paren
id|INB
(paren
id|OBOE_ENABLEH
)paren
op_amp
id|OBOE_ENABLEH_FIRON
)paren
(brace
id|ctl
op_or_assign
id|OBOE_CTL_TX_BAD_CRC
op_or
id|OBOE_CTL_TX_SIP
suffix:semicolon
)brace
macro_line|#ifdef USE_MIR
r_else
r_if
c_cond
(paren
id|INB
(paren
id|OBOE_ENABLEH
)paren
op_amp
id|OBOE_ENABLEH_MIRON
)paren
(brace
id|ctl
op_or_assign
id|OBOE_CTL_TX_BAD_CRC
suffix:semicolon
)brace
macro_line|#endif
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
id|ctl
suffix:semicolon
id|OUTB
(paren
l_int|0x0
comma
id|OBOE_ENABLEH
)paren
suffix:semicolon
multiline_comment|/* It is only a timer. Do not send mtt packet outside! */
id|toshoboe_start_DMA
c_func
(paren
id|self
comma
id|OBOE_CONFIG0H_ENTX
op_or
id|OBOE_CONFIG0H_LOOP
)paren
suffix:semicolon
id|self-&gt;txpending
op_increment
suffix:semicolon
id|self-&gt;txs
op_increment
suffix:semicolon
id|self-&gt;txs
op_mod_assign
id|TX_SLOTS
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: problem with mtt packet - ignored&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef DUMP_PACKETS
id|dumpbufs
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_char|&squot;&gt;&squot;
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
op_amp
id|OBOE_CTL_TX_HW_OWNS
)paren
(brace
id|IRDA_DEBUG
(paren
l_int|0
comma
l_string|&quot;%s.ful:%x(%x)%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|skb-&gt;len
comma
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
comma
id|self-&gt;txpending
)paren
suffix:semicolon
id|toshoboe_start_DMA
c_func
(paren
id|self
comma
id|OBOE_CONFIG0H_ENTX
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|INB
(paren
id|OBOE_ENABLEH
)paren
op_amp
id|OBOE_ENABLEH_SIRON
)paren
(brace
id|len
op_assign
id|async_wrap_skb
(paren
id|skb
comma
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
comma
id|TX_BUF_SZ
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|memcpy
(paren
id|self-&gt;tx_bufs
(braket
id|self-&gt;txs
)braket
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
)brace
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|len
op_assign
id|len
op_amp
l_int|0x0fff
suffix:semicolon
multiline_comment|/*Sometimes the HW doesn&squot;t see us assert RTCENTX in the interrupt code */
multiline_comment|/*later this plays safe, we garuntee the last packet to be transmitted */
multiline_comment|/*has RTCENTX set */
id|ctl
op_assign
id|OBOE_CTL_TX_HW_OWNS
op_or
id|OBOE_CTL_TX_RTCENTX
suffix:semicolon
r_if
c_cond
(paren
id|INB
(paren
id|OBOE_ENABLEH
)paren
op_amp
id|OBOE_ENABLEH_FIRON
)paren
(brace
id|ctl
op_or_assign
id|OBOE_CTL_TX_SIP
suffix:semicolon
)brace
id|self-&gt;ring-&gt;tx
(braket
id|self-&gt;txs
)braket
dot
id|control
op_assign
id|ctl
suffix:semicolon
multiline_comment|/* If transmitter is idle start in one-shot mode */
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;txpending
)paren
id|toshoboe_start_DMA
c_func
(paren
id|self
comma
id|OBOE_CONFIG0H_ENTX
)paren
suffix:semicolon
id|self-&gt;txpending
op_increment
suffix:semicolon
id|self-&gt;txs
op_increment
suffix:semicolon
id|self-&gt;txs
op_mod_assign
id|TX_SLOTS
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*interrupt handler */
r_static
id|irqreturn_t
DECL|function|toshoboe_interrupt
id|toshoboe_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev_id
suffix:semicolon
id|__u8
id|irqstat
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
op_logical_and
id|toshoboe_invalid_dev
c_func
(paren
id|irq
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|irqstat
op_assign
id|INB
(paren
id|OBOE_ISR
)paren
suffix:semicolon
multiline_comment|/* was it us */
r_if
c_cond
(paren
op_logical_neg
(paren
id|irqstat
op_amp
id|OBOE_INT_MASK
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/* Ack all the interrupts */
id|OUTB
(paren
id|irqstat
comma
id|OBOE_ISR
)paren
suffix:semicolon
id|toshoboe_isntstuck
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Txdone */
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_TXDONE
)paren
(brace
r_int
id|txp
comma
id|txpc
suffix:semicolon
r_int
id|i
suffix:semicolon
id|txp
op_assign
id|self-&gt;txpending
suffix:semicolon
id|self-&gt;txpending
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|self-&gt;ring-&gt;tx
(braket
id|i
)braket
dot
id|control
op_amp
id|OBOE_CTL_TX_HW_OWNS
)paren
id|self-&gt;txpending
op_increment
suffix:semicolon
)brace
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s.txd(%x)%x/%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|irqstat
comma
id|txp
comma
id|self-&gt;txpending
)paren
suffix:semicolon
id|txp
op_assign
id|INB
(paren
id|OBOE_TXSLOT
)paren
op_amp
id|OBOE_SLOT_MASK
suffix:semicolon
multiline_comment|/* Got anything queued ? start it together */
r_if
c_cond
(paren
id|self-&gt;ring-&gt;tx
(braket
id|txp
)braket
dot
id|control
op_amp
id|OBOE_CTL_TX_HW_OWNS
)paren
(brace
id|txpc
op_assign
id|txp
suffix:semicolon
macro_line|#ifdef OPTIMIZE_TX
r_while
c_loop
(paren
id|self-&gt;ring-&gt;tx
(braket
id|txpc
)braket
dot
id|control
op_amp
id|OBOE_CTL_TX_HW_OWNS
)paren
(brace
id|txp
op_assign
id|txpc
suffix:semicolon
id|txpc
op_increment
suffix:semicolon
id|txpc
op_mod_assign
id|TX_SLOTS
suffix:semicolon
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;ring-&gt;tx
(braket
id|txpc
)braket
dot
id|control
op_amp
id|OBOE_CTL_TX_HW_OWNS
)paren
id|self-&gt;ring-&gt;tx
(braket
id|txp
)braket
dot
id|control
op_and_assign
op_complement
id|OBOE_CTL_TX_RTCENTX
suffix:semicolon
)brace
id|self-&gt;stats.tx_packets
op_decrement
suffix:semicolon
macro_line|#else
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
macro_line|#endif
id|toshoboe_start_DMA
c_func
(paren
id|self
comma
id|OBOE_CONFIG0H_ENTX
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|self-&gt;txpending
)paren
op_logical_and
(paren
id|self-&gt;new_speed
)paren
)paren
(brace
id|self-&gt;speed
op_assign
id|self-&gt;new_speed
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s: Executed TxDone scheduled speed change %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;speed
)paren
suffix:semicolon
id|toshoboe_setbaud
(paren
id|self
)paren
suffix:semicolon
)brace
multiline_comment|/* Tell network layer that we want more frames */
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;new_speed
)paren
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_RXDONE
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|self-&gt;ring-&gt;rx
(braket
id|self-&gt;rxs
)braket
dot
id|control
op_amp
id|OBOE_CTL_RX_HW_OWNS
)paren
)paren
(brace
r_int
id|len
op_assign
id|self-&gt;ring-&gt;rx
(braket
id|self-&gt;rxs
)braket
dot
id|len
suffix:semicolon
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|3
comma
l_string|&quot;%s.rcv:%x(%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
comma
id|self-&gt;ring-&gt;rx
(braket
id|self-&gt;rxs
)braket
dot
id|control
)paren
suffix:semicolon
macro_line|#ifdef DUMP_PACKETS
id|dumpbufs
c_func
(paren
id|self-&gt;rx_bufs
(braket
id|self-&gt;rxs
)braket
comma
id|len
comma
l_char|&squot;&lt;&squot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|self-&gt;ring-&gt;rx
(braket
id|self-&gt;rxs
)braket
dot
id|control
op_eq
l_int|0
)paren
(brace
id|__u8
id|enable
op_assign
id|INB
(paren
id|OBOE_ENABLEH
)paren
suffix:semicolon
multiline_comment|/* In SIR mode we need to check the CRC as this */
multiline_comment|/* hasn&squot;t been done by the hardware */
r_if
c_cond
(paren
id|enable
op_amp
id|OBOE_ENABLEH_SIRON
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|toshoboe_checkfcs
(paren
id|self-&gt;rx_bufs
(braket
id|self-&gt;rxs
)braket
comma
id|len
)paren
)paren
id|len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*Trim off the CRC */
r_if
c_cond
(paren
id|len
OG
l_int|1
)paren
id|len
op_sub_assign
l_int|2
suffix:semicolon
r_else
id|len
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s.SIR:%x(%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
comma
id|enable
)paren
suffix:semicolon
)brace
macro_line|#ifdef USE_MIR
r_else
r_if
c_cond
(paren
id|enable
op_amp
id|OBOE_ENABLEH_MIRON
)paren
(brace
r_if
c_cond
(paren
id|len
OG
l_int|1
)paren
id|len
op_sub_assign
l_int|2
suffix:semicolon
r_else
id|len
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|2
comma
l_string|&quot;%s.MIR:%x(%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
comma
id|enable
)paren
suffix:semicolon
)brace
macro_line|#endif
r_else
r_if
c_cond
(paren
id|enable
op_amp
id|OBOE_ENABLEH_FIRON
)paren
(brace
r_if
c_cond
(paren
id|len
OG
l_int|3
)paren
id|len
op_sub_assign
l_int|4
suffix:semicolon
multiline_comment|/*FIXME: check this */
r_else
id|len
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s.FIR:%x(%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
comma
id|enable
)paren
suffix:semicolon
)brace
r_else
id|IRDA_DEBUG
(paren
l_int|0
comma
l_string|&quot;%s.?IR:%x(%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
comma
id|enable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb_reserve
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb_put
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_bufs
(braket
id|self-&gt;rxs
)braket
comma
id|len
)paren
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s(), memory squeeze, dropping frame.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* TODO: =========================================== */
multiline_comment|/*  if OBOE_CTL_RX_LENGTH, our buffers are too small */
multiline_comment|/* (MIR or FIR) data is lost. */
multiline_comment|/* (SIR) data is splitted in several slots. */
multiline_comment|/* we have to join all the received buffers received */
multiline_comment|/*in a large buffer before checking CRC. */
id|IRDA_DEBUG
(paren
l_int|0
comma
l_string|&quot;%s.err:%x(%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
comma
id|self-&gt;ring-&gt;rx
(braket
id|self-&gt;rxs
)braket
dot
id|control
)paren
suffix:semicolon
)brace
id|self-&gt;ring-&gt;rx
(braket
id|self-&gt;rxs
)braket
dot
id|len
op_assign
l_int|0x0
suffix:semicolon
id|self-&gt;ring-&gt;rx
(braket
id|self-&gt;rxs
)braket
dot
id|control
op_assign
id|OBOE_CTL_RX_HW_OWNS
suffix:semicolon
id|self-&gt;rxs
op_increment
suffix:semicolon
id|self-&gt;rxs
op_mod_assign
id|RX_SLOTS
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_TXUNDER
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|DRIVER_NAME
l_string|&quot;: tx fifo underflow&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_RXOVER
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|DRIVER_NAME
l_string|&quot;: rx fifo overflow&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* This must be useful for something... */
r_if
c_cond
(paren
id|irqstat
op_amp
id|OBOE_INT_SIP
)paren
(brace
id|self-&gt;int_sip
op_increment
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s.sip:%x(%x)%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;int_sip
comma
id|irqstat
comma
id|self-&gt;txpending
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_net_open
id|toshoboe_net_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;async
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;stopped
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|self-&gt;io.irq
comma
id|toshoboe_interrupt
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
id|dev-&gt;name
comma
(paren
r_void
op_star
)paren
id|self
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|toshoboe_startchip
(paren
id|self
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Ready to play! */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;   * Open new IrLAP layer instance, now that everything should be&n;   * initialized properly&n;   */
id|self-&gt;irlap
op_assign
id|irlap_open
(paren
id|dev
comma
op_amp
id|self-&gt;qos
comma
id|driver_name
)paren
suffix:semicolon
id|self-&gt;irdad
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_net_close
id|toshoboe_net_close
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Stop device */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Stop and remove instance of IrLAP */
r_if
c_cond
(paren
id|self-&gt;irlap
)paren
id|irlap_close
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
id|self-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
id|self-&gt;irdad
op_assign
l_int|0
suffix:semicolon
id|free_irq
(paren
id|self-&gt;io.irq
comma
(paren
r_void
op_star
)paren
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;stopped
)paren
(brace
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function toshoboe_net_ioctl (dev, rq, cmd)&n; *&n; *    Process IOCTL commands for this device&n; *&n; */
r_static
r_int
DECL|function|toshoboe_net_ioctl
id|toshoboe_net_ioctl
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|if_irda_req
op_star
id|irq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|rq
suffix:semicolon
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ASSERT
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|5
comma
l_string|&quot;%s(), %s, (cmd=0x%X)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts &amp; save flags */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
multiline_comment|/* Set bandwidth */
multiline_comment|/* This function will also be used by IrLAP to change the&n;       * speed, so we still must allow for speed change within&n;       * interrupt context.&n;       */
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s(BANDWIDTH), %s, (%X/%ld&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;name
comma
id|INB
(paren
id|OBOE_STATUS
)paren
comma
id|irq-&gt;ifr_baudrate
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
(paren
)paren
op_logical_and
op_logical_neg
id|capable
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* self-&gt;speed=irq-&gt;ifr_baudrate; */
multiline_comment|/* toshoboe_setbaud(self); */
multiline_comment|/* Just change speed once - inserted by Paul Bristow */
id|self-&gt;new_speed
op_assign
id|irq-&gt;ifr_baudrate
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
multiline_comment|/* Set media busy */
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s(MEDIABUSY), %s, (%X/%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;name
comma
id|INB
(paren
id|OBOE_STATUS
)paren
comma
id|capable
(paren
id|CAP_NET_ADMIN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|irda_device_set_media_busy
(paren
id|self-&gt;netdev
comma
id|TRUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
multiline_comment|/* Check if we are receiving right now */
id|irq-&gt;ifr_receiving
op_assign
(paren
id|INB
(paren
id|OBOE_STATUS
)paren
op_amp
id|OBOE_STATUS_RXBUSY
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|3
comma
l_string|&quot;%s(RECEIVING), %s, (%X/%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;name
comma
id|INB
(paren
id|OBOE_STATUS
)paren
comma
id|irq-&gt;ifr_receiving
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
(paren
l_int|1
comma
l_string|&quot;%s(?), %s, (cmd=0x%X)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Toshiba OBOE IrDA Device Driver&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;James McKenzie &lt;james@fishsoup.dhs.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
(paren
id|max_baud
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_baud
comma
l_string|&quot;Maximum baud rate&quot;
)paren
suffix:semicolon
macro_line|#ifdef USE_PROBE
id|module_param
(paren
id|do_probe
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|do_probe
comma
l_string|&quot;Enable/disable chip probing and self-test&quot;
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
DECL|function|toshoboe_close
id|toshoboe_close
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|toshoboe_cb
op_star
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;stopped
)paren
(brace
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
)brace
id|release_region
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|kfree
(paren
id|self-&gt;tx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|self-&gt;tx_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|kfree
(paren
id|self-&gt;rx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|self-&gt;rx_bufs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|unregister_netdev
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|kfree
(paren
id|self-&gt;ringbuf
)paren
suffix:semicolon
id|self-&gt;ringbuf
op_assign
l_int|NULL
suffix:semicolon
id|self-&gt;ring
op_assign
l_int|NULL
suffix:semicolon
id|free_netdev
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_open
id|toshoboe_open
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pdid
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|ok
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|dev
op_assign
id|alloc_irdadev
c_func
(paren
r_sizeof
(paren
r_struct
id|toshoboe_cb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: can&squot;t allocate memory for &quot;
l_string|&quot;IrDA control block&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|self-&gt;netdev
op_assign
id|dev
suffix:semicolon
id|self-&gt;pdev
op_assign
id|pci_dev
suffix:semicolon
id|self-&gt;base
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
suffix:semicolon
id|self-&gt;io.fir_base
op_assign
id|self-&gt;base
suffix:semicolon
id|self-&gt;io.fir_ext
op_assign
id|OBOE_IO_EXTENT
suffix:semicolon
id|self-&gt;io.irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
id|self-&gt;io.irqflags
op_assign
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
suffix:semicolon
id|self-&gt;speed
op_assign
id|self-&gt;io.speed
op_assign
l_int|9600
suffix:semicolon
id|self-&gt;async
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Lock the port that we need */
r_if
c_cond
(paren
l_int|NULL
op_eq
id|request_region
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
comma
id|driver_name
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|freeself
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|self-&gt;spinlock
)paren
suffix:semicolon
id|irda_init_max_qos_capabilies
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|self-&gt;qos.baud_rate.bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|2400
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_2400
suffix:semicolon
multiline_comment|/*if (max_baud&gt;=4800) idev-&gt;qos.baud_rate.bits|=IR_4800; */
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|9600
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_9600
suffix:semicolon
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|19200
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_19200
suffix:semicolon
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|115200
)paren
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_115200
suffix:semicolon
macro_line|#ifdef USE_MIR
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|1152000
)paren
(brace
id|self-&gt;qos.baud_rate.bits
op_or_assign
id|IR_1152000
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|max_baud
op_ge
l_int|4000000
)paren
(brace
id|self-&gt;qos.baud_rate.bits
op_or_assign
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/*FIXME: work this out... */
id|self-&gt;qos.min_turn_time.bits
op_assign
l_int|0xff
suffix:semicolon
id|irda_qos_bits_to_value
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* Allocate twice the size to guarantee alignment */
id|self-&gt;ringbuf
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
(paren
id|OBOE_RING_LEN
op_lshift
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;ringbuf
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: can&squot;t allocate DMA buffers&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|freeregion
suffix:semicolon
)brace
macro_line|#if (BITS_PER_LONG == 64)
macro_line|#error broken on 64-bit:  casts pointer to 32-bit, and then back to pointer.
macro_line|#endif
multiline_comment|/*We need to align the taskfile on a taskfile size boundary */
(brace
r_int
r_int
id|addr
suffix:semicolon
id|addr
op_assign
(paren
id|__u32
)paren
id|self-&gt;ringbuf
suffix:semicolon
id|addr
op_and_assign
op_complement
(paren
id|OBOE_RING_LEN
op_minus
l_int|1
)paren
suffix:semicolon
id|addr
op_add_assign
id|OBOE_RING_LEN
suffix:semicolon
id|self-&gt;ring
op_assign
(paren
r_struct
id|OboeRing
op_star
)paren
id|addr
suffix:semicolon
)brace
id|memset
(paren
id|self-&gt;ring
comma
l_int|0
comma
id|OBOE_RING_LEN
)paren
suffix:semicolon
id|self-&gt;io.mem_base
op_assign
(paren
id|__u32
)paren
id|self-&gt;ring
suffix:semicolon
id|ok
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;tx_bufs
(braket
id|i
)braket
op_assign
id|kmalloc
(paren
id|TX_BUF_SZ
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;tx_bufs
(braket
id|i
)braket
)paren
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|self-&gt;rx_bufs
(braket
id|i
)braket
op_assign
id|kmalloc
(paren
id|RX_BUF_SZ
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;rx_bufs
(braket
id|i
)braket
)paren
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: can&squot;t allocate rx/tx buffers&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|freebufs
suffix:semicolon
)brace
macro_line|#ifdef USE_PROBE
r_if
c_cond
(paren
id|do_probe
)paren
r_if
c_cond
(paren
op_logical_neg
id|toshoboe_probe
(paren
id|self
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|freebufs
suffix:semicolon
)brace
macro_line|#endif
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|pci_dev-&gt;dev
)paren
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|toshoboe_hard_xmit
suffix:semicolon
id|dev-&gt;open
op_assign
id|toshoboe_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|toshoboe_net_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|toshoboe_net_ioctl
suffix:semicolon
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|freebufs
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;IrDA: Registered device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
id|self
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|DRIVER_NAME
l_string|&quot;: Using multiple tasks, version %s&bslash;n&quot;
comma
id|rcsid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|freebufs
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|self-&gt;tx_bufs
(braket
id|i
)braket
)paren
id|kfree
(paren
id|self-&gt;tx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_SLOTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|self-&gt;rx_bufs
(braket
id|i
)braket
)paren
id|kfree
(paren
id|self-&gt;rx_bufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;ringbuf
)paren
suffix:semicolon
id|freeregion
suffix:colon
id|release_region
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
id|freeself
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_gotosleep
id|toshoboe_gotosleep
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
id|u32
id|crap
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
op_assign
l_int|10
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self
op_logical_or
id|self-&gt;stopped
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|self-&gt;irdad
)paren
op_logical_and
(paren
op_logical_neg
id|self-&gt;async
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Flush all packets */
r_while
c_loop
(paren
(paren
id|i
op_decrement
)paren
op_logical_and
(paren
id|self-&gt;txpending
)paren
)paren
id|udelay
(paren
l_int|10000
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|toshoboe_stopchip
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|self-&gt;txpending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|toshoboe_wakeup
id|toshoboe_wakeup
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|toshoboe_cb
op_star
id|self
op_assign
(paren
r_struct
id|toshoboe_cb
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
(paren
l_int|4
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self
op_logical_or
op_logical_neg
id|self-&gt;stopped
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|self-&gt;irdad
)paren
op_logical_and
(paren
op_logical_neg
id|self-&gt;async
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|toshoboe_startchip
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;stopped
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|donauboe_pci_driver
r_static
r_struct
id|pci_driver
id|donauboe_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;donauboe&quot;
comma
dot
id|id_table
op_assign
id|toshoboe_pci_tbl
comma
dot
id|probe
op_assign
id|toshoboe_open
comma
dot
id|remove
op_assign
id|toshoboe_close
comma
dot
id|suspend
op_assign
id|toshoboe_gotosleep
comma
dot
id|resume
op_assign
id|toshoboe_wakeup
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|donauboe_init
id|donauboe_init
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|donauboe_pci_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|donauboe_cleanup
id|donauboe_cleanup
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|donauboe_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|donauboe_init
id|module_init
c_func
(paren
id|donauboe_init
)paren
suffix:semicolon
DECL|variable|donauboe_cleanup
id|module_exit
c_func
(paren
id|donauboe_cleanup
)paren
suffix:semicolon
eof
