multiline_comment|/*&n; *&n; * Alchemy Semi Au1000 IrDA driver&n; *&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: MontaVista Software, Inc.&n; *         &t;ppopov@mvista.com or source@mvista.com&n; *&n; * ########################################################################&n; *&n; *  This program is free software; you can distribute it and/or modify it&n; *  under the terms of the GNU General Public License (Version 2) as&n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; *  for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * ########################################################################&n; *&n; * &n; */
macro_line|#ifndef __mips__
macro_line|#error This driver only works with MIPS architectures!
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/au1000.h&gt;
macro_line|#include &lt;asm/pb1000.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irmod.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &quot;net/irda/au1000_ircc.h&quot;
r_static
r_int
id|au1k_irda_net_init
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1k_irda_start
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1k_irda_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|au1k_irda_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1k_irda_rx
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|au1k_irda_interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|au1k_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|au1k_irda_stats
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1k_irda_ioctl
c_func
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|ifreq
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|au1k_irda_set_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|speed
)paren
suffix:semicolon
r_static
r_void
op_star
id|dma_alloc
c_func
(paren
r_int
comma
id|dma_addr_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|dma_free
c_func
(paren
r_void
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|qos_mtt_bits
r_static
r_int
id|qos_mtt_bits
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* 1 ms or more */
DECL|variable|ir_devs
r_static
r_struct
id|net_device
op_star
id|ir_devs
(braket
id|NUM_IR_IFF
)braket
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;au1k_ircc:1.0 ppopov@mvista.com&bslash;n&quot;
suffix:semicolon
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
DECL|variable|ir_lock
r_static
id|spinlock_t
id|ir_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * IrDA peripheral bug. You have to read the register&n; * twice to get the right value.&n; */
DECL|function|read_ir_reg
id|u32
id|read_ir_reg
c_func
(paren
id|u32
id|addr
)paren
(brace
id|readl
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
id|readl
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Buffer allocation/deallocation routines. The buffer descriptor returned&n; * has the virtual and dma address of a buffer suitable for &n; * both, receive and transmit operations.&n; */
DECL|function|GetFreeDB
r_static
id|db_dest_t
op_star
id|GetFreeDB
c_func
(paren
r_struct
id|au1k_private
op_star
id|aup
)paren
(brace
id|db_dest_t
op_star
id|pDB
suffix:semicolon
id|pDB
op_assign
id|aup-&gt;pDBfree
suffix:semicolon
r_if
c_cond
(paren
id|pDB
)paren
(brace
id|aup-&gt;pDBfree
op_assign
id|pDB-&gt;pnext
suffix:semicolon
)brace
r_return
id|pDB
suffix:semicolon
)brace
DECL|function|ReleaseDB
r_static
r_void
id|ReleaseDB
c_func
(paren
r_struct
id|au1k_private
op_star
id|aup
comma
id|db_dest_t
op_star
id|pDB
)paren
(brace
id|db_dest_t
op_star
id|pDBfree
op_assign
id|aup-&gt;pDBfree
suffix:semicolon
r_if
c_cond
(paren
id|pDBfree
)paren
id|pDBfree-&gt;pnext
op_assign
id|pDB
suffix:semicolon
id|aup-&gt;pDBfree
op_assign
id|pDB
suffix:semicolon
)brace
multiline_comment|/*&n;  DMA memory allocation, derived from pci_alloc_consistent.&n;  However, the Au1000 data cache is coherent (when programmed&n;  so), therefore we return KSEG0 address, not KSEG1.&n;*/
DECL|function|dma_alloc
r_static
r_void
op_star
id|dma_alloc
c_func
(paren
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
r_int
id|gfp
op_assign
id|GFP_ATOMIC
op_or
id|GFP_DMA
suffix:semicolon
id|ret
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|gfp
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|ret
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
op_star
id|dma_handle
op_assign
id|virt_to_bus
c_func
(paren
id|ret
)paren
suffix:semicolon
id|ret
op_assign
id|KSEG0ADDR
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dma_free
r_static
r_void
id|dma_free
c_func
(paren
r_void
op_star
id|vaddr
comma
r_int
id|size
)paren
(brace
id|vaddr
op_assign
id|KSEG0ADDR
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|vaddr
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|setup_hw_rings
id|setup_hw_rings
c_func
(paren
r_struct
id|au1k_private
op_star
id|aup
comma
id|u32
id|rx_base
comma
id|u32
id|tx_base
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_IR_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|aup-&gt;rx_ring
(braket
id|i
)braket
op_assign
(paren
r_volatile
id|ring_dest_t
op_star
)paren
(paren
id|rx_base
op_plus
r_sizeof
(paren
id|ring_dest_t
)paren
op_star
id|i
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_IR_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|aup-&gt;tx_ring
(braket
id|i
)braket
op_assign
(paren
r_volatile
id|ring_dest_t
op_star
)paren
(paren
id|tx_base
op_plus
r_sizeof
(paren
id|ring_dest_t
)paren
op_star
id|i
)paren
suffix:semicolon
)brace
)brace
DECL|function|au1k_irda_init
r_static
r_int
id|au1k_irda_init
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|au1k_private
op_star
id|aup
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|dev
op_assign
id|alloc_irdadev
c_func
(paren
r_sizeof
(paren
r_struct
id|au1k_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;irq
op_assign
id|AU1000_IRDA_RX_INT
suffix:semicolon
multiline_comment|/* TX has its own interrupt */
id|err
op_assign
id|au1k_irda_net_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out1
suffix:semicolon
id|ir_devs
(braket
l_int|0
)braket
op_assign
id|dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IrDA: Registered device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out1
suffix:colon
id|aup
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dma_free
c_func
(paren
(paren
r_void
op_star
)paren
id|aup-&gt;db
(braket
l_int|0
)braket
dot
id|vaddr
comma
id|MAX_BUF_SIZE
op_star
l_int|2
op_star
id|NUM_IR_DESC
)paren
suffix:semicolon
id|dma_free
c_func
(paren
(paren
r_void
op_star
)paren
id|aup-&gt;rx_ring
(braket
l_int|0
)braket
comma
l_int|2
op_star
id|MAX_NUM_IR_DESC
op_star
(paren
r_sizeof
(paren
id|ring_dest_t
)paren
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aup-&gt;rx_buff.head
)paren
suffix:semicolon
id|out
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|au1k_irda_init_iobuf
r_static
r_int
id|au1k_irda_init_iobuf
c_func
(paren
id|iobuff_t
op_star
id|io
comma
r_int
id|size
)paren
(brace
id|io-&gt;head
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;head
op_ne
l_int|NULL
)paren
(brace
id|io-&gt;truesize
op_assign
id|size
suffix:semicolon
id|io-&gt;in_frame
op_assign
id|FALSE
suffix:semicolon
id|io-&gt;state
op_assign
id|OUTSIDE_FRAME
suffix:semicolon
id|io-&gt;data
op_assign
id|io-&gt;head
suffix:semicolon
)brace
r_return
id|io-&gt;head
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|au1k_irda_net_init
r_static
r_int
id|au1k_irda_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|retval
op_assign
l_int|0
comma
id|err
suffix:semicolon
id|db_dest_t
op_star
id|pDB
comma
op_star
id|pDBfree
suffix:semicolon
r_int
r_int
id|temp
suffix:semicolon
id|err
op_assign
id|au1k_irda_init_iobuf
c_func
(paren
op_amp
id|aup-&gt;rx_buff
comma
l_int|14384
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out1
suffix:semicolon
id|dev-&gt;open
op_assign
id|au1k_irda_start
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|au1k_irda_hard_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
id|au1k_irda_stop
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|au1k_irda_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|au1k_irda_ioctl
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|au1k_tx_timeout
suffix:semicolon
id|irda_init_max_qos_capabilies
c_func
(paren
op_amp
id|aup-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* The only value we must override it the baudrate */
id|aup-&gt;qos.baud_rate.bits
op_assign
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
op_or
id|IR_576000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
id|aup-&gt;qos.min_turn_time.bits
op_assign
id|qos_mtt_bits
suffix:semicolon
id|irda_qos_bits_to_value
c_func
(paren
op_amp
id|aup-&gt;qos
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Tx ring follows rx ring + 512 bytes */
multiline_comment|/* we need a 1k aligned buffer */
id|aup-&gt;rx_ring
(braket
l_int|0
)braket
op_assign
(paren
id|ring_dest_t
op_star
)paren
id|dma_alloc
c_func
(paren
l_int|2
op_star
id|MAX_NUM_IR_DESC
op_star
(paren
r_sizeof
(paren
id|ring_dest_t
)paren
)paren
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aup-&gt;rx_ring
(braket
l_int|0
)braket
)paren
r_goto
id|out2
suffix:semicolon
multiline_comment|/* allocate the data buffers */
id|aup-&gt;db
(braket
l_int|0
)braket
dot
id|vaddr
op_assign
(paren
r_void
op_star
)paren
id|dma_alloc
c_func
(paren
id|MAX_BUF_SIZE
op_star
l_int|2
op_star
id|NUM_IR_DESC
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aup-&gt;db
(braket
l_int|0
)braket
dot
id|vaddr
)paren
r_goto
id|out3
suffix:semicolon
id|setup_hw_rings
c_func
(paren
id|aup
comma
(paren
id|u32
)paren
id|aup-&gt;rx_ring
(braket
l_int|0
)braket
comma
(paren
id|u32
)paren
id|aup-&gt;rx_ring
(braket
l_int|0
)braket
op_plus
l_int|512
)paren
suffix:semicolon
id|pDBfree
op_assign
l_int|NULL
suffix:semicolon
id|pDB
op_assign
id|aup-&gt;db
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|2
op_star
id|NUM_IR_DESC
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pDB-&gt;pnext
op_assign
id|pDBfree
suffix:semicolon
id|pDBfree
op_assign
id|pDB
suffix:semicolon
id|pDB-&gt;vaddr
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
r_int
)paren
id|aup-&gt;db
(braket
l_int|0
)braket
dot
id|vaddr
op_plus
id|MAX_BUF_SIZE
op_star
id|i
)paren
suffix:semicolon
id|pDB-&gt;dma_addr
op_assign
(paren
id|dma_addr_t
)paren
id|virt_to_bus
c_func
(paren
id|pDB-&gt;vaddr
)paren
suffix:semicolon
id|pDB
op_increment
suffix:semicolon
)brace
id|aup-&gt;pDBfree
op_assign
id|pDBfree
suffix:semicolon
multiline_comment|/* attach a data buffer to each descriptor */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_IR_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pDB
op_assign
id|GetFreeDB
c_func
(paren
id|aup
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDB
)paren
r_goto
id|out
suffix:semicolon
id|aup-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|addr_0
op_assign
(paren
id|u8
)paren
(paren
id|pDB-&gt;dma_addr
op_amp
l_int|0xff
)paren
suffix:semicolon
id|aup-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|addr_1
op_assign
(paren
id|u8
)paren
(paren
(paren
id|pDB-&gt;dma_addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|aup-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|addr_2
op_assign
(paren
id|u8
)paren
(paren
(paren
id|pDB-&gt;dma_addr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|aup-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|addr_3
op_assign
(paren
id|u8
)paren
(paren
(paren
id|pDB-&gt;dma_addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|aup-&gt;rx_db_inuse
(braket
id|i
)braket
op_assign
id|pDB
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_IR_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pDB
op_assign
id|GetFreeDB
c_func
(paren
id|aup
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDB
)paren
r_goto
id|out
suffix:semicolon
id|aup-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|addr_0
op_assign
(paren
id|u8
)paren
(paren
id|pDB-&gt;dma_addr
op_amp
l_int|0xff
)paren
suffix:semicolon
id|aup-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|addr_1
op_assign
(paren
id|u8
)paren
(paren
(paren
id|pDB-&gt;dma_addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|aup-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|addr_2
op_assign
(paren
id|u8
)paren
(paren
(paren
id|pDB-&gt;dma_addr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|aup-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|addr_3
op_assign
(paren
id|u8
)paren
(paren
(paren
id|pDB-&gt;dma_addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|aup-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|count_0
op_assign
l_int|0
suffix:semicolon
id|aup-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|count_1
op_assign
l_int|0
suffix:semicolon
id|aup-&gt;tx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|flags
op_assign
l_int|0
suffix:semicolon
id|aup-&gt;tx_db_inuse
(braket
id|i
)braket
op_assign
id|pDB
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out3
suffix:colon
id|dma_free
c_func
(paren
(paren
r_void
op_star
)paren
id|aup-&gt;rx_ring
(braket
l_int|0
)braket
comma
l_int|2
op_star
id|MAX_NUM_IR_DESC
op_star
(paren
r_sizeof
(paren
id|ring_dest_t
)paren
)paren
)paren
suffix:semicolon
id|out2
suffix:colon
id|kfree
c_func
(paren
id|aup-&gt;rx_buff.head
)paren
suffix:semicolon
id|out1
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;au1k_init_module failed.  Returns %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|au1k_init
r_static
r_int
id|au1k_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|control
suffix:semicolon
id|u32
id|ring_address
suffix:semicolon
multiline_comment|/* bring the device out of reset */
id|control
op_assign
l_int|0xe
suffix:semicolon
multiline_comment|/* coherent, clock enable, one half system clock */
macro_line|#ifndef CONFIG_CPU_LITTLE_ENDIAN
id|control
op_or_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|aup-&gt;tx_head
op_assign
l_int|0
suffix:semicolon
id|aup-&gt;tx_tail
op_assign
l_int|0
suffix:semicolon
id|aup-&gt;rx_head
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_IR_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|aup-&gt;rx_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|flags
op_assign
id|AU_OWN
suffix:semicolon
)brace
id|writel
c_func
(paren
id|control
comma
id|IR_INTERFACE_CONFIG
)paren
suffix:semicolon
id|au_sync_delay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_ENABLE
)paren
op_amp
op_complement
l_int|0x8000
comma
id|IR_ENABLE
)paren
suffix:semicolon
multiline_comment|/* disable PHY */
id|au_sync_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MAX_BUF_SIZE
comma
id|IR_MAX_PKT_LEN
)paren
suffix:semicolon
id|ring_address
op_assign
(paren
id|u32
)paren
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
id|aup-&gt;rx_ring
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ring_address
op_rshift
l_int|26
comma
id|IR_RING_BASE_ADDR_H
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|ring_address
op_rshift
l_int|10
)paren
op_amp
l_int|0xffff
comma
id|IR_RING_BASE_ADDR_L
)paren
suffix:semicolon
id|writel
c_func
(paren
id|RING_SIZE_64
op_lshift
l_int|8
op_or
id|RING_SIZE_64
op_lshift
l_int|12
comma
id|IR_RING_SIZE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|1
op_lshift
l_int|2
op_or
id|IR_ONE_PIN
comma
id|IR_CONFIG_2
)paren
suffix:semicolon
multiline_comment|/* 48MHz */
id|writel
c_func
(paren
l_int|0
comma
id|IR_RING_ADDR_CMPR
)paren
suffix:semicolon
id|au1k_irda_set_speed
c_func
(paren
id|dev
comma
l_int|9600
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1k_irda_start
r_static
r_int
id|au1k_irda_start
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|retval
suffix:semicolon
r_char
id|hwname
(braket
l_int|32
)braket
suffix:semicolon
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|au1k_init
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: error in au1k_init&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_irq
c_func
(paren
id|AU1000_IRDA_TX_INT
comma
op_amp
id|au1k_irda_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_irq
c_func
(paren
id|AU1000_IRDA_RX_INT
comma
op_amp
id|au1k_irda_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|AU1000_IRDA_TX_INT
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Give self a hardware name */
id|sprintf
c_func
(paren
id|hwname
comma
l_string|&quot;Au1000 SIR/FIR&quot;
)paren
suffix:semicolon
id|aup-&gt;irlap
op_assign
id|irlap_open
c_func
(paren
id|dev
comma
op_amp
id|aup-&gt;qos
comma
id|hwname
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_CONFIG_2
)paren
op_or
l_int|1
op_lshift
l_int|8
comma
id|IR_CONFIG_2
)paren
suffix:semicolon
multiline_comment|/* int enable */
id|aup-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
(paren
l_int|3
op_star
id|HZ
)paren
)paren
suffix:semicolon
id|aup-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1k_irda_stop
r_static
r_int
id|au1k_irda_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* disable interrupts */
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_CONFIG_2
)paren
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|8
)paren
comma
id|IR_CONFIG_2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|IR_INTERFACE_CONFIG
)paren
suffix:semicolon
multiline_comment|/* disable clock */
id|au_sync
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aup-&gt;irlap
)paren
(brace
id|irlap_close
c_func
(paren
id|aup-&gt;irlap
)paren
suffix:semicolon
id|aup-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
)brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|aup-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* disable the interrupt */
id|free_irq
c_func
(paren
id|AU1000_IRDA_TX_INT
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|AU1000_IRDA_RX_INT
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1k_irda_exit
r_static
r_void
id|__exit
id|au1k_irda_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ir_devs
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dma_free
c_func
(paren
(paren
r_void
op_star
)paren
id|aup-&gt;db
(braket
l_int|0
)braket
dot
id|vaddr
comma
id|MAX_BUF_SIZE
op_star
l_int|2
op_star
id|NUM_IR_DESC
)paren
suffix:semicolon
id|dma_free
c_func
(paren
(paren
r_void
op_star
)paren
id|aup-&gt;rx_ring
(braket
l_int|0
)braket
comma
l_int|2
op_star
id|MAX_NUM_IR_DESC
op_star
(paren
r_sizeof
(paren
id|ring_dest_t
)paren
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aup-&gt;rx_buff.head
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|update_tx_stats
id|update_tx_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
comma
id|u32
id|pkt_len
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|ps
op_assign
op_amp
id|aup-&gt;stats
suffix:semicolon
id|ps-&gt;tx_packets
op_increment
suffix:semicolon
id|ps-&gt;tx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IR_TX_ERROR
)paren
(brace
id|ps-&gt;tx_errors
op_increment
suffix:semicolon
id|ps-&gt;tx_aborted_errors
op_increment
suffix:semicolon
)brace
)brace
DECL|function|au1k_tx_ack
r_static
r_void
id|au1k_tx_ack
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|ring_dest_t
op_star
id|ptxd
suffix:semicolon
id|ptxd
op_assign
id|aup-&gt;tx_ring
(braket
id|aup-&gt;tx_tail
)braket
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|ptxd-&gt;flags
op_amp
id|AU_OWN
)paren
op_logical_and
(paren
id|aup-&gt;tx_tail
op_ne
id|aup-&gt;tx_head
)paren
)paren
(brace
id|update_tx_stats
c_func
(paren
id|dev
comma
id|ptxd-&gt;flags
comma
id|ptxd-&gt;count_1
op_lshift
l_int|8
op_or
id|ptxd-&gt;count_0
)paren
suffix:semicolon
id|ptxd-&gt;count_0
op_assign
l_int|0
suffix:semicolon
id|ptxd-&gt;count_1
op_assign
l_int|0
suffix:semicolon
id|au_sync
c_func
(paren
)paren
suffix:semicolon
id|aup-&gt;tx_tail
op_assign
(paren
id|aup-&gt;tx_tail
op_plus
l_int|1
)paren
op_amp
(paren
id|NUM_IR_DESC
op_minus
l_int|1
)paren
suffix:semicolon
id|ptxd
op_assign
id|aup-&gt;tx_ring
(braket
id|aup-&gt;tx_tail
)braket
suffix:semicolon
r_if
c_cond
(paren
id|aup-&gt;tx_full
)paren
(brace
id|aup-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|aup-&gt;tx_tail
op_eq
id|aup-&gt;tx_head
)paren
(brace
r_if
c_cond
(paren
id|aup-&gt;newspeed
)paren
(brace
id|au1k_irda_set_speed
c_func
(paren
id|dev
comma
id|aup-&gt;newspeed
)paren
suffix:semicolon
id|aup-&gt;newspeed
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_CONFIG_1
)paren
op_amp
op_complement
id|IR_TX_ENABLE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
id|au_sync
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_CONFIG_1
)paren
op_or
id|IR_RX_ENABLE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|IR_RING_PROMPT
)paren
suffix:semicolon
id|au_sync
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Au1000 transmit routine.&n; */
DECL|function|au1k_irda_hard_xmit
r_static
r_int
id|au1k_irda_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_volatile
id|ring_dest_t
op_star
id|ptxd
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|u32
id|flags
suffix:semicolon
id|db_dest_t
op_star
id|pDB
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_ne
id|aup-&gt;speed
op_logical_and
id|speed
op_ne
op_minus
l_int|1
)paren
(brace
id|aup-&gt;newspeed
op_assign
id|speed
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|skb-&gt;len
op_eq
l_int|0
)paren
op_logical_and
(paren
id|aup-&gt;newspeed
)paren
)paren
(brace
r_if
c_cond
(paren
id|aup-&gt;tx_tail
op_eq
id|aup-&gt;tx_head
)paren
(brace
id|au1k_irda_set_speed
c_func
(paren
id|dev
comma
id|speed
)paren
suffix:semicolon
id|aup-&gt;newspeed
op_assign
l_int|0
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ptxd
op_assign
id|aup-&gt;tx_ring
(braket
id|aup-&gt;tx_head
)braket
suffix:semicolon
id|flags
op_assign
id|ptxd-&gt;flags
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|AU_OWN
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx_full&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|aup-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
(paren
id|aup-&gt;tx_head
op_plus
l_int|1
)paren
op_amp
(paren
id|NUM_IR_DESC
op_minus
l_int|1
)paren
)paren
op_eq
id|aup-&gt;tx_tail
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx_full&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|aup-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|pDB
op_assign
id|aup-&gt;tx_db_inuse
(braket
id|aup-&gt;tx_head
)braket
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|read_ir_reg
c_func
(paren
id|IR_RX_BYTE_CNT
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tx warning: rx byte cnt %x&bslash;n&quot;
comma
id|read_ir_reg
c_func
(paren
id|IR_RX_BYTE_CNT
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|aup-&gt;speed
op_eq
l_int|4000000
)paren
(brace
multiline_comment|/* FIR */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|pDB-&gt;vaddr
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|ptxd-&gt;count_0
op_assign
id|skb-&gt;len
op_amp
l_int|0xff
suffix:semicolon
id|ptxd-&gt;count_1
op_assign
(paren
id|skb-&gt;len
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* SIR */
id|len
op_assign
id|async_wrap_skb
c_func
(paren
id|skb
comma
(paren
id|u8
op_star
)paren
id|pDB-&gt;vaddr
comma
id|MAX_BUF_SIZE
)paren
suffix:semicolon
id|ptxd-&gt;count_0
op_assign
id|len
op_amp
l_int|0xff
suffix:semicolon
id|ptxd-&gt;count_1
op_assign
(paren
id|len
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ptxd-&gt;flags
op_or_assign
id|IR_DIS_CRC
suffix:semicolon
)brace
id|ptxd-&gt;flags
op_or_assign
id|AU_OWN
suffix:semicolon
id|au_sync
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_CONFIG_1
)paren
op_or
id|IR_TX_ENABLE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|IR_RING_PROMPT
)paren
suffix:semicolon
id|au_sync
c_func
(paren
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|aup-&gt;tx_head
op_assign
(paren
id|aup-&gt;tx_head
op_plus
l_int|1
)paren
op_amp
(paren
id|NUM_IR_DESC
op_minus
l_int|1
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|update_rx_stats
id|update_rx_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
comma
id|u32
id|count
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|ps
op_assign
op_amp
id|aup-&gt;stats
suffix:semicolon
id|ps-&gt;rx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IR_RX_ERROR
)paren
(brace
id|ps-&gt;rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|IR_PHY_ERROR
op_or
id|IR_FIFO_OVER
)paren
)paren
id|ps-&gt;rx_missed_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IR_MAX_LEN
)paren
id|ps-&gt;rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|IR_CRC_ERROR
)paren
id|ps-&gt;rx_crc_errors
op_increment
suffix:semicolon
)brace
r_else
id|ps-&gt;rx_bytes
op_add_assign
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Au1000 receive routine.&n; */
DECL|function|au1k_irda_rx
r_static
r_int
id|au1k_irda_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_volatile
id|ring_dest_t
op_star
id|prxd
suffix:semicolon
id|u32
id|flags
comma
id|count
suffix:semicolon
id|db_dest_t
op_star
id|pDB
suffix:semicolon
id|prxd
op_assign
id|aup-&gt;rx_ring
(braket
id|aup-&gt;rx_head
)braket
suffix:semicolon
id|flags
op_assign
id|prxd-&gt;flags
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|flags
op_amp
id|AU_OWN
)paren
)paren
(brace
id|pDB
op_assign
id|aup-&gt;rx_db_inuse
(braket
id|aup-&gt;rx_head
)braket
suffix:semicolon
id|count
op_assign
id|prxd-&gt;count_1
op_lshift
l_int|8
op_or
id|prxd-&gt;count_0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|IR_RX_ERROR
)paren
)paren
(brace
multiline_comment|/* good frame */
id|update_rx_stats
c_func
(paren
id|dev
comma
id|flags
comma
id|count
)paren
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|count
op_plus
l_int|1
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|aup-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aup-&gt;speed
op_eq
l_int|4000000
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
suffix:semicolon
r_else
id|skb_put
c_func
(paren
id|skb
comma
id|count
op_minus
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
(paren
r_void
op_star
)paren
id|pDB-&gt;vaddr
comma
id|count
op_minus
l_int|2
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|prxd-&gt;count_0
op_assign
l_int|0
suffix:semicolon
id|prxd-&gt;count_1
op_assign
l_int|0
suffix:semicolon
)brace
id|prxd-&gt;flags
op_or_assign
id|AU_OWN
suffix:semicolon
id|aup-&gt;rx_head
op_assign
(paren
id|aup-&gt;rx_head
op_plus
l_int|1
)paren
op_amp
(paren
id|NUM_IR_DESC
op_minus
l_int|1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|IR_RING_PROMPT
)paren
suffix:semicolon
id|au_sync
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* next descriptor */
id|prxd
op_assign
id|aup-&gt;rx_ring
(braket
id|aup-&gt;rx_head
)braket
suffix:semicolon
id|flags
op_assign
id|prxd-&gt;flags
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1k_irda_interrupt
r_void
id|au1k_irda_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: null dev ptr&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0
comma
id|IR_INT_CLEAR
)paren
suffix:semicolon
multiline_comment|/* ack irda interrupts */
id|au1k_irda_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|au1k_tx_ack
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The Tx ring has been full longer than the watchdog timeout&n; * value. The transmitter must be hung?&n; */
DECL|function|au1k_tx_timeout
r_static
r_void
id|au1k_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|u32
id|speed
suffix:semicolon
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: tx timeout&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|speed
op_assign
id|aup-&gt;speed
suffix:semicolon
id|aup-&gt;speed
op_assign
l_int|0
suffix:semicolon
id|au1k_irda_set_speed
c_func
(paren
id|dev
comma
id|speed
)paren
suffix:semicolon
id|aup-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the IrDA communications speed.&n; */
r_static
r_int
DECL|function|au1k_irda_set_speed
id|au1k_irda_set_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|speed
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|control
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
comma
id|timeout
op_assign
l_int|10
comma
id|i
suffix:semicolon
r_volatile
id|ring_dest_t
op_star
id|ptxd
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
id|aup-&gt;speed
)paren
r_return
id|ret
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ir_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* disable PHY first */
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_ENABLE
)paren
op_amp
op_complement
l_int|0x8000
comma
id|IR_ENABLE
)paren
suffix:semicolon
multiline_comment|/* disable RX/TX */
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_CONFIG_1
)paren
op_amp
op_complement
(paren
id|IR_RX_ENABLE
op_or
id|IR_TX_ENABLE
)paren
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
id|au_sync_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|read_ir_reg
c_func
(paren
id|IR_ENABLE
)paren
op_amp
(paren
id|IR_RX_STATUS
op_or
id|IR_TX_STATUS
)paren
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: rx/tx disable timeout&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* disable DMA */
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_CONFIG_1
)paren
op_amp
op_complement
id|IR_DMA_ENABLE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
id|au_sync_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* &n;&t; *  After we disable tx/rx. the index pointers&n; &t; * go back to zero.&n;&t; */
id|aup-&gt;tx_head
op_assign
id|aup-&gt;tx_tail
op_assign
id|aup-&gt;rx_head
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_IR_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ptxd
op_assign
id|aup-&gt;tx_ring
(braket
id|i
)braket
suffix:semicolon
id|ptxd-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ptxd-&gt;count_0
op_assign
l_int|0
suffix:semicolon
id|ptxd-&gt;count_1
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_IR_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ptxd
op_assign
id|aup-&gt;rx_ring
(braket
id|i
)braket
suffix:semicolon
id|ptxd-&gt;count_0
op_assign
l_int|0
suffix:semicolon
id|ptxd-&gt;count_1
op_assign
l_int|0
suffix:semicolon
id|ptxd-&gt;flags
op_assign
id|AU_OWN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|speed
op_eq
l_int|4000000
)paren
id|writel
c_func
(paren
l_int|1
op_lshift
l_int|13
comma
id|CPLD_AUX1
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
id|readl
c_func
(paren
id|CPLD_AUX1
)paren
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|13
)paren
comma
id|CPLD_AUX1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|9600
suffix:colon
id|writel
c_func
(paren
l_int|11
op_lshift
l_int|10
op_or
l_int|12
op_lshift
l_int|5
comma
id|IR_WRITE_PHY_CONFIG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IR_SIR_MODE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|writel
c_func
(paren
l_int|5
op_lshift
l_int|10
op_or
l_int|12
op_lshift
l_int|5
comma
id|IR_WRITE_PHY_CONFIG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IR_SIR_MODE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|writel
c_func
(paren
l_int|2
op_lshift
l_int|10
op_or
l_int|12
op_lshift
l_int|5
comma
id|IR_WRITE_PHY_CONFIG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IR_SIR_MODE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|writel
c_func
(paren
l_int|1
op_lshift
l_int|10
op_or
l_int|12
op_lshift
l_int|5
comma
id|IR_WRITE_PHY_CONFIG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IR_SIR_MODE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|writel
c_func
(paren
l_int|12
op_lshift
l_int|5
comma
id|IR_WRITE_PHY_CONFIG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IR_SIR_MODE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4000000
suffix:colon
id|writel
c_func
(paren
l_int|0xF
comma
id|IR_WRITE_PHY_CONFIG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IR_FIR
op_or
id|IR_DMA_ENABLE
op_or
id|IR_RX_ENABLE
comma
id|IR_CONFIG_1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s unsupported speed %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|speed
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|aup-&gt;speed
op_assign
id|speed
suffix:semicolon
id|writel
c_func
(paren
id|read_ir_reg
c_func
(paren
id|IR_ENABLE
)paren
op_or
l_int|0x8000
comma
id|IR_ENABLE
)paren
suffix:semicolon
id|au_sync
c_func
(paren
)paren
suffix:semicolon
id|control
op_assign
id|read_ir_reg
c_func
(paren
id|IR_ENABLE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|IR_RING_PROMPT
)paren
suffix:semicolon
id|au_sync
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
(paren
l_int|1
op_lshift
l_int|14
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: configuration error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|control
op_amp
(paren
l_int|1
op_lshift
l_int|11
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Valid SIR config&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Valid MIR config&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
(paren
l_int|1
op_lshift
l_int|13
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Valid FIR config&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s TX enabled&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
(paren
l_int|1
op_lshift
l_int|9
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s RX enabled&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ir_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|au1k_irda_ioctl
id|au1k_irda_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifreq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|if_irda_req
op_star
id|rq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|ifreq
suffix:semicolon
r_struct
id|au1k_private
op_star
id|aup
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
r_if
c_cond
(paren
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * We are unable to set the speed if the&n;&t;&t;&t; * device is not running.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|aup-&gt;open
)paren
id|ret
op_assign
id|au1k_irda_set_speed
c_func
(paren
id|dev
comma
id|rq-&gt;ifr_baudrate
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s ioctl: !netif_running&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|irda_device_set_media_busy
c_func
(paren
id|dev
comma
id|TRUE
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
id|rq-&gt;ifr_receiving
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|au1k_irda_stats
r_static
r_struct
id|net_device_stats
op_star
id|au1k_irda_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1k_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1k_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|aup-&gt;stats
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Pete Popov &lt;ppopov@mvista.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Au1000 IrDA Device Driver&quot;
)paren
suffix:semicolon
DECL|variable|au1k_irda_init
id|module_init
c_func
(paren
id|au1k_irda_init
)paren
suffix:semicolon
DECL|variable|au1k_irda_exit
id|module_exit
c_func
(paren
id|au1k_irda_exit
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
eof
