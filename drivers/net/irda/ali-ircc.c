multiline_comment|/*********************************************************************&n; *                &n; * Filename:      ali-ircc.h&n; * Version:       0.5&n; * Description:   Driver for the ALI M1535D and M1543C FIR Controller&n; * Status:        Experimental.&n; * Author:        Benjamin Kong &lt;benjamin_kong@ali.com.tw&gt;&n; * Created at:    2000/10/16 03:46PM&n; * Modified at:   2001/1/3 02:55PM&n; * Modified by:   Benjamin Kong &lt;benjamin_kong@ali.com.tw&gt;&n; * &n; *     Copyright (c) 2000 Benjamin Kong &lt;benjamin_kong@ali.com.tw&gt;&n; *     All Rights Reserved&n; *      &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *  &n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/serial_reg.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/ali-ircc.h&gt;
DECL|macro|CHIP_IO_EXTENT
mdefine_line|#define CHIP_IO_EXTENT 8
DECL|macro|BROKEN_DONGLE_ID
mdefine_line|#define BROKEN_DONGLE_ID
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;ali-ircc&quot;
suffix:semicolon
multiline_comment|/* Module parameters */
DECL|variable|qos_mtt_bits
r_static
r_int
id|qos_mtt_bits
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* 1 ms or more */
multiline_comment|/* Use BIOS settions by default, but user may supply module parameters */
DECL|variable|io
r_static
r_int
r_int
id|io
(braket
)braket
op_assign
(brace
op_complement
l_int|0
comma
op_complement
l_int|0
comma
op_complement
l_int|0
comma
op_complement
l_int|0
)brace
suffix:semicolon
DECL|variable|irq
r_static
r_int
r_int
id|irq
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|dma
r_static
r_int
r_int
id|dma
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_static
r_int
id|ali_ircc_probe_43
c_func
(paren
id|ali_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_probe_53
c_func
(paren
id|ali_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_init_43
c_func
(paren
id|ali_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_init_53
c_func
(paren
id|ali_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/* These are the currently known ALi sourth-bridge chipsets, the only one difference&n; * is that M1543C doesn&squot;t support HP HDSL-3600&n; */
DECL|variable|chips
r_static
id|ali_chip_t
id|chips
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;M1543&quot;
comma
(brace
l_int|0x3f0
comma
l_int|0x370
)brace
comma
l_int|0x51
comma
l_int|0x23
comma
l_int|0x20
comma
l_int|0x43
comma
id|ali_ircc_probe_53
comma
id|ali_ircc_init_43
)brace
comma
(brace
l_string|&quot;M1535&quot;
comma
(brace
l_int|0x3f0
comma
l_int|0x370
)brace
comma
l_int|0x51
comma
l_int|0x23
comma
l_int|0x20
comma
l_int|0x53
comma
id|ali_ircc_probe_53
comma
id|ali_ircc_init_53
)brace
comma
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Max 4 instances for now */
DECL|variable|dev_self
r_static
r_struct
id|ali_ircc_cb
op_star
id|dev_self
(braket
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Dongle Types */
DECL|variable|dongle_types
r_static
r_char
op_star
id|dongle_types
(braket
)braket
op_assign
(brace
l_string|&quot;TFDS6000&quot;
comma
l_string|&quot;HP HSDL-3600&quot;
comma
l_string|&quot;HP HSDL-1100&quot;
comma
l_string|&quot;No dongle connected&quot;
comma
)brace
suffix:semicolon
multiline_comment|/* Some prototypes */
r_static
r_int
id|ali_ircc_open
c_func
(paren
r_int
id|i
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_close
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_setup
c_func
(paren
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_is_receiving
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_pmproc
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_change_speed
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
comma
id|__u32
id|baud
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_suspend
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_wakeup
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|ali_ircc_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* SIR function */
r_static
r_int
id|ali_ircc_sir_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_sir_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|ali_ircc_cb
op_star
id|self
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_sir_receive
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_sir_write_wakeup
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_sir_write
c_func
(paren
r_int
id|iobase
comma
r_int
id|fifo_size
comma
id|__u8
op_star
id|buf
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_sir_change_speed
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|priv
comma
id|__u32
id|speed
)paren
suffix:semicolon
multiline_comment|/* FIR function */
r_static
r_int
id|ali_ircc_fir_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_fir_change_speed
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|priv
comma
id|__u32
id|speed
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_fir_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|ali_ircc_cb
op_star
id|self
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_dma_receive
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_dma_receive_complete
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|ali_ircc_dma_xmit_complete
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_dma_xmit
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
suffix:semicolon
multiline_comment|/* My Function */
r_static
r_int
id|ali_ircc_read_dongle_id
(paren
r_int
id|i
comma
id|chipio_t
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|ali_ircc_change_dongle_speed
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|priv
comma
r_int
id|speed
)paren
suffix:semicolon
multiline_comment|/* ALi chip function */
r_static
r_void
id|SIR2FIR
c_func
(paren
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|FIR2SIR
c_func
(paren
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|SetCOMInterrupts
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
comma
r_int
r_char
id|enable
)paren
suffix:semicolon
multiline_comment|/*&n; * Function ali_ircc_init ()&n; *&n; *    Initialize chip. Find out whay kinds of chips we are dealing with&n; *    and their configuation registers address&n; */
DECL|function|ali_ircc_init
r_int
id|__init
id|ali_ircc_init
c_func
(paren
r_void
)paren
(brace
id|ali_chip_t
op_star
id|chip
suffix:semicolon
id|chipio_t
id|info
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_int
id|cfg
comma
id|cfg_base
suffix:semicolon
r_int
id|reg
comma
id|revision
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Probe for all the ALi chipsets we know about */
r_for
c_loop
(paren
id|chip
op_assign
id|chips
suffix:semicolon
id|chip-&gt;name
suffix:semicolon
id|chip
op_increment
comma
id|i
op_increment
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Probing for %s ...&bslash;n&quot;
comma
id|chip-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Try all config registers for this chip */
r_for
c_loop
(paren
id|cfg
op_assign
l_int|0
suffix:semicolon
id|cfg
OL
l_int|2
suffix:semicolon
id|cfg
op_increment
)paren
(brace
id|cfg_base
op_assign
id|chip-&gt;cfg
(braket
id|cfg
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cfg_base
)paren
r_continue
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|chipio_t
)paren
)paren
suffix:semicolon
id|info.cfg_base
op_assign
id|cfg_base
suffix:semicolon
id|info.fir_base
op_assign
id|io
(braket
id|i
)braket
suffix:semicolon
id|info.dma
op_assign
id|dma
(braket
id|i
)braket
suffix:semicolon
id|info.irq
op_assign
id|irq
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Enter Configuration */
id|outb
c_func
(paren
id|chip-&gt;entr1
comma
id|cfg_base
)paren
suffix:semicolon
id|outb
c_func
(paren
id|chip-&gt;entr2
comma
id|cfg_base
)paren
suffix:semicolon
multiline_comment|/* Select Logical Device 5 Registers (UART2) */
id|outb
c_func
(paren
l_int|0x07
comma
id|cfg_base
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x05
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Read Chip Identification Register */
id|outb
c_func
(paren
id|chip-&gt;cid_index
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_eq
id|chip-&gt;cid_value
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Chip found at 0x%03x&bslash;n&quot;
comma
id|cfg_base
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x1F
comma
id|cfg_base
)paren
suffix:semicolon
id|revision
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), Found %s chip, revision=%d&bslash;n&quot;
comma
id|chip-&gt;name
comma
id|revision
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;&t; * If the user supplies the base address, then&n;&t;&t;&t;&t; * we init the chip, if not we probe the values&n;&t;&t;&t;&t; * set by the BIOS&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|io
(braket
id|i
)braket
OL
l_int|2000
)paren
(brace
id|chip
op_member_access_from_pointer
id|init
c_func
(paren
id|chip
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
id|chip
op_member_access_from_pointer
id|probe
c_func
(paren
id|chip
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ali_ircc_open
c_func
(paren
id|i
comma
op_amp
id|info
)paren
op_eq
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), No %s chip at 0x%03x&bslash;n&quot;
comma
id|chip-&gt;name
comma
id|cfg_base
)paren
suffix:semicolon
)brace
multiline_comment|/* Exit configuration */
id|outb
c_func
(paren
l_int|0xbb
comma
id|cfg_base
)paren
suffix:semicolon
)brace
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End -----------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_cleanup ()&n; *&n; *    Close all configured chips&n; *&n; */
DECL|function|ali_ircc_cleanup
r_static
r_void
id|__exit
id|ali_ircc_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|pm_unregister_all
c_func
(paren
id|ali_ircc_pmproc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|ali_ircc_close
c_func
(paren
id|dev_self
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End -----------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_open (int i, chipio_t *inf)&n; *&n; *    Open driver instance&n; *&n; */
DECL|function|ali_ircc_open
r_static
r_int
id|ali_ircc_open
c_func
(paren
r_int
id|i
comma
id|chipio_t
op_star
id|info
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|ali_ircc_cb
op_star
id|self
suffix:semicolon
r_struct
id|pm_dev
op_star
id|pmdev
suffix:semicolon
r_int
id|dongle_id
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|err
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set FIR FIFO and DMA Threshold */
r_if
c_cond
(paren
(paren
id|ali_ircc_setup
c_func
(paren
id|info
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Allocate new instance of the driver */
id|self
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ali_ircc_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), can&squot;t allocate memory for control block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ali_ircc_cb
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Need to store self somewhere */
id|dev_self
(braket
id|i
)braket
op_assign
id|self
suffix:semicolon
id|self-&gt;index
op_assign
id|i
suffix:semicolon
multiline_comment|/* Initialize IO */
id|self-&gt;io.cfg_base
op_assign
id|info-&gt;cfg_base
suffix:semicolon
multiline_comment|/* In ali_ircc_probe_53 assign &t;&t;*/
id|self-&gt;io.fir_base
op_assign
id|info-&gt;fir_base
suffix:semicolon
multiline_comment|/* info-&gt;sir_base = info-&gt;fir_base &t;*/
id|self-&gt;io.sir_base
op_assign
id|info-&gt;sir_base
suffix:semicolon
multiline_comment|/* ALi SIR and FIR use the same address */
id|self-&gt;io.irq
op_assign
id|info-&gt;irq
suffix:semicolon
id|self-&gt;io.fir_ext
op_assign
id|CHIP_IO_EXTENT
suffix:semicolon
id|self-&gt;io.dma
op_assign
id|info-&gt;dma
suffix:semicolon
id|self-&gt;io.fifo_size
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* SIR: 16, FIR: 32 Benjamin 2000/11/1 */
multiline_comment|/* Reserve the ioports that we need */
id|ret
op_assign
id|check_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|dev_self
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
comma
id|driver_name
)paren
suffix:semicolon
multiline_comment|/* Initialize QoS for this device */
id|irda_init_max_qos_capabilies
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* The only value we must override it the baudrate */
id|self-&gt;qos.baud_rate.bits
op_assign
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
op_or
id|IR_576000
op_or
id|IR_1152000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
singleline_comment|// benjamin 2000/11/8 05:27PM
id|self-&gt;qos.min_turn_time.bits
op_assign
id|qos_mtt_bits
suffix:semicolon
id|irda_qos_bits_to_value
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|self-&gt;flags
op_assign
id|IFF_FIR
op_or
id|IFF_MIR
op_or
id|IFF_SIR
op_or
id|IFF_DMA
op_or
id|IFF_PIO
suffix:semicolon
singleline_comment|// benjamin 2000/11/8 05:27PM&t;
multiline_comment|/* Max DMA buffer size needed = (data_size + 6) * (window_size) + 6; */
id|self-&gt;rx_buff.truesize
op_assign
l_int|14384
suffix:semicolon
id|self-&gt;tx_buff.truesize
op_assign
l_int|14384
suffix:semicolon
multiline_comment|/* Allocate memory if needed */
id|self-&gt;rx_buff.head
op_assign
(paren
id|__u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;rx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;rx_buff.head
comma
l_int|0
comma
id|self-&gt;rx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;tx_buff.head
op_assign
(paren
id|__u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;tx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;tx_buff.head
comma
l_int|0
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;rx_buff.in_frame
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;rx_buff.state
op_assign
id|OUTSIDE_FRAME
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
multiline_comment|/* Reset Tx queue info */
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|dev_alloc
c_func
(paren
l_string|&quot;irda%d&quot;
comma
op_amp
id|err
)paren
)paren
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), dev_alloc() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|self
suffix:semicolon
id|self-&gt;netdev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Override the network functions we need to use */
id|dev-&gt;init
op_assign
id|ali_ircc_net_init
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ali_ircc_sir_hard_xmit
suffix:semicolon
id|dev-&gt;open
op_assign
id|ali_ircc_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ali_ircc_net_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|ali_ircc_net_ioctl
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ali_ircc_net_get_stats
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|register_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), register_netdev() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|MESSAGE
c_func
(paren
l_string|&quot;IrDA: Registered device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Check dongle id */
id|dongle_id
op_assign
id|ali_ircc_read_dongle_id
c_func
(paren
id|i
comma
id|info
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), %s, Found dongle: %s&bslash;n&quot;
comma
id|driver_name
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
id|self-&gt;io.dongle_id
op_assign
id|dongle_id
suffix:semicolon
id|pmdev
op_assign
id|pm_register
c_func
(paren
id|PM_SYS_DEV
comma
id|PM_SYS_IRDA
comma
id|ali_ircc_pmproc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmdev
)paren
id|pmdev-&gt;data
op_assign
id|self
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End -----------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_close (self)&n; *&n; *    Close driver instance&n; *&n; */
DECL|function|ali_ircc_close
r_static
r_int
id|__exit
id|ali_ircc_close
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Remove netdevice */
r_if
c_cond
(paren
id|self-&gt;netdev
)paren
(brace
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|unregister_netdevice
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Release the PORT that this driver is using */
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), Releasing Region %03x&bslash;n&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|dev_self
(braket
id|self-&gt;index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End -----------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_init_43 (chip, info)&n; *&n; *    Initialize the ALi M1543 chip. &n; */
DECL|function|ali_ircc_init_43
r_static
r_int
id|ali_ircc_init_43
c_func
(paren
id|ali_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
(brace
multiline_comment|/* All controller information like I/O address, DMA channel, IRQ&n;&t; * are set by BIOS&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_init_53 (chip, info)&n; *&n; *    Initialize the ALi M1535 chip. &n; */
DECL|function|ali_ircc_init_53
r_static
r_int
id|ali_ircc_init_53
c_func
(paren
id|ali_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
(brace
multiline_comment|/* All controller information like I/O address, DMA channel, IRQ&n;&t; * are set by BIOS&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_probe_43 (chip, info)&n; *    &t;&n; *&t;Probes for the ALi M1543&n; */
DECL|function|ali_ircc_probe_43
r_static
r_int
id|ali_ircc_probe_43
c_func
(paren
id|ali_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_probe_53 (chip, info)&n; *    &t;&n; *&t;Probes for the ALi M1535D or M1535&n; */
DECL|function|ali_ircc_probe_53
r_static
r_int
id|ali_ircc_probe_53
c_func
(paren
id|ali_chip_t
op_star
id|chip
comma
id|chipio_t
op_star
id|info
)paren
(brace
r_int
id|cfg_base
op_assign
id|info-&gt;cfg_base
suffix:semicolon
r_int
id|hi
comma
id|low
comma
id|reg
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Enter Configuration */
id|outb
c_func
(paren
id|chip-&gt;entr1
comma
id|cfg_base
)paren
suffix:semicolon
id|outb
c_func
(paren
id|chip-&gt;entr2
comma
id|cfg_base
)paren
suffix:semicolon
multiline_comment|/* Select Logical Device 5 Registers (UART2) */
id|outb
c_func
(paren
l_int|0x07
comma
id|cfg_base
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x05
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Read address control register */
id|outb
c_func
(paren
l_int|0x60
comma
id|cfg_base
)paren
suffix:semicolon
id|hi
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x61
comma
id|cfg_base
)paren
suffix:semicolon
id|low
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;fir_base
op_assign
(paren
id|hi
op_lshift
l_int|8
)paren
op_plus
id|low
suffix:semicolon
id|info-&gt;sir_base
op_assign
id|info-&gt;fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing fir_base=0x%03x&bslash;n&quot;
comma
id|info-&gt;fir_base
)paren
suffix:semicolon
multiline_comment|/* Read IRQ control register */
id|outb
c_func
(paren
l_int|0x70
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;irq
op_assign
id|reg
op_amp
l_int|0x0f
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing irq=%d&bslash;n&quot;
comma
id|info-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Read DMA channel */
id|outb
c_func
(paren
l_int|0x74
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;dma
op_assign
id|reg
op_amp
l_int|0x07
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dma
op_eq
l_int|0x04
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), No DMA channel assigned !&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing dma=%d&bslash;n&quot;
comma
id|info-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* Read Enabled Status */
id|outb
c_func
(paren
l_int|0x30
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;enabled
op_assign
(paren
id|reg
op_amp
l_int|0x80
)paren
op_logical_and
(paren
id|reg
op_amp
l_int|0x01
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing enabled=%d&bslash;n&quot;
comma
id|info-&gt;enabled
)paren
suffix:semicolon
multiline_comment|/* Read Power Status */
id|outb
c_func
(paren
l_int|0x22
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;suspended
op_assign
(paren
id|reg
op_amp
l_int|0x20
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing suspended=%d&bslash;n&quot;
comma
id|info-&gt;suspended
)paren
suffix:semicolon
multiline_comment|/* Exit configuration */
id|outb
c_func
(paren
l_int|0xbb
comma
id|cfg_base
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End -----------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_setup (info)&n; *&n; *    &t;Set FIR FIFO and DMA Threshold&n; *&t;Returns non-negative on success.&n; *&n; */
DECL|function|ali_ircc_setup
r_static
r_int
id|ali_ircc_setup
c_func
(paren
id|chipio_t
op_star
id|info
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_int
id|version
suffix:semicolon
r_int
id|iobase
op_assign
id|info-&gt;fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Switch to FIR space */
id|SIR2FIR
c_func
(paren
id|iobase
)paren
suffix:semicolon
multiline_comment|/* Master Reset */
id|outb
c_func
(paren
l_int|0x40
comma
id|iobase
op_plus
id|FIR_MCR
)paren
suffix:semicolon
singleline_comment|// benjamin 2000/11/30 11:45AM
multiline_comment|/* Read FIR ID Version Register */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK3
)paren
suffix:semicolon
id|version
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_ID_VR
)paren
suffix:semicolon
multiline_comment|/* Should be 0x00 in the M1535/M1535D */
r_if
c_cond
(paren
id|version
op_ne
l_int|0x00
)paren
(brace
id|ERROR
c_func
(paren
l_string|&quot;%s, Wrong chip version %02x&bslash;n&quot;
comma
id|driver_name
comma
id|version
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
singleline_comment|// MESSAGE(&quot;%s, Found chip at base=0x%03x&bslash;n&quot;, driver_name, info-&gt;cfg_base);
multiline_comment|/* Set FIR FIFO Threshold Register */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RX_FIFO_Threshold
comma
id|iobase
op_plus
id|FIR_FIFO_TR
)paren
suffix:semicolon
multiline_comment|/* Set FIR DMA Threshold Register */
id|outb
c_func
(paren
id|RX_DMA_Threshold
comma
id|iobase
op_plus
id|FIR_DMA_TR
)paren
suffix:semicolon
multiline_comment|/* CRC enable */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
op_or
id|IRDA_CR_CRC
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
multiline_comment|/* NDIS driver set TX Length here BANK2 Alias 3, Alias4*/
multiline_comment|/* Switch to Bank 0 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LCR_B
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
l_int|0x20
suffix:semicolon
singleline_comment|// disable SIP
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
singleline_comment|// these two steps make RX mode
id|tmp
op_and_assign
l_int|0xbf
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_LCR_B
)paren
suffix:semicolon
multiline_comment|/* Disable Interrupt */
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|FIR_IER
)paren
suffix:semicolon
multiline_comment|/* Switch to SIR space */
id|FIR2SIR
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;%s, driver loaded (Benjamin Kong)&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
multiline_comment|/* Enable receive interrupts */
singleline_comment|// outb(UART_IER_RDI, iobase+UART_IER); //benjamin 2000/11/23 01:25PM
singleline_comment|// Turn on the interrupts in ali_ircc_net_open
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_read_dongle_id (int index, info)&n; *&n; * Try to read dongle indentification. This procedure needs to be executed&n; * once after power-on/reset. It also needs to be used whenever you suspect&n; * that the user may have plugged/unplugged the IrDA Dongle.&n; */
DECL|function|ali_ircc_read_dongle_id
r_static
r_int
id|ali_ircc_read_dongle_id
(paren
r_int
id|i
comma
id|chipio_t
op_star
id|info
)paren
(brace
r_int
id|dongle_id
comma
id|reg
suffix:semicolon
r_int
id|cfg_base
op_assign
id|info-&gt;cfg_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Enter Configuration */
id|outb
c_func
(paren
id|chips
(braket
id|i
)braket
dot
id|entr1
comma
id|cfg_base
)paren
suffix:semicolon
id|outb
c_func
(paren
id|chips
(braket
id|i
)braket
dot
id|entr2
comma
id|cfg_base
)paren
suffix:semicolon
multiline_comment|/* Select Logical Device 5 Registers (UART2) */
id|outb
c_func
(paren
l_int|0x07
comma
id|cfg_base
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x05
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Read Dongle ID */
id|outb
c_func
(paren
l_int|0xf0
comma
id|cfg_base
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|dongle_id
op_assign
(paren
(paren
id|reg
op_rshift
l_int|6
)paren
op_amp
l_int|0x02
)paren
op_or
(paren
(paren
id|reg
op_rshift
l_int|5
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), probing dongle_id=%d, dongle_types=%s&bslash;n&quot;
comma
id|dongle_id
comma
id|dongle_types
(braket
id|dongle_id
)braket
)paren
suffix:semicolon
multiline_comment|/* Exit configuration */
id|outb
c_func
(paren
l_int|0xbb
comma
id|cfg_base
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|dongle_id
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_interrupt (irq, dev_id, regs)&n; *&n; *    An interrupt from the chip has arrived. Time to do some work&n; *&n; */
DECL|function|ali_ircc_interrupt
r_static
r_void
id|ali_ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|ali_ircc_cb
op_star
id|self
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Dispatch interrupt handler for the current speed */
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
id|ali_ircc_fir_interrupt
c_func
(paren
id|irq
comma
id|self
comma
id|regs
)paren
suffix:semicolon
r_else
id|ali_ircc_sir_interrupt
c_func
(paren
id|irq
comma
id|self
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_fir_interrupt(irq, struct ali_ircc_cb *self, regs)&n; *&n; *    Handle MIR/FIR interrupt&n; *&n; */
DECL|function|ali_ircc_fir_interrupt
r_static
r_void
id|ali_ircc_fir_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|ali_ircc_cb
op_star
id|self
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|__u8
id|eir
comma
id|OldMessageCount
suffix:semicolon
r_int
id|iobase
comma
id|tmp
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|self-&gt;InterruptID
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_IIR
)paren
suffix:semicolon
id|self-&gt;BusStatus
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_BSR
)paren
suffix:semicolon
id|OldMessageCount
op_assign
(paren
id|self-&gt;LineStatus
op_plus
l_int|1
)paren
op_amp
l_int|0x07
suffix:semicolon
id|self-&gt;LineStatus
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LSR
)paren
suffix:semicolon
singleline_comment|//self-&gt;ier = inb(iobase+FIR_IER); &t;&t;2000/12/1 04:32PM
id|eir
op_assign
id|self-&gt;InterruptID
op_amp
id|self-&gt;ier
suffix:semicolon
multiline_comment|/* Mask out the interesting ones */
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), self-&gt;InterruptID = %x&bslash;n&quot;
comma
id|self-&gt;InterruptID
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), self-&gt;LineStatus = %x&bslash;n&quot;
comma
id|self-&gt;LineStatus
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), self-&gt;ier = %x&bslash;n&quot;
comma
id|self-&gt;ier
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), eir = %x&bslash;n&quot;
comma
id|eir
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|SetCOMInterrupts
c_func
(paren
id|self
comma
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* Tx or Rx Interrupt */
r_if
c_cond
(paren
id|eir
op_amp
id|IIR_EOM
)paren
(brace
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_XMIT
)paren
multiline_comment|/* TX */
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ******* IIR_EOM (Tx) *******&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ali_ircc_dma_xmit_complete
c_func
(paren
id|self
)paren
)paren
(brace
r_if
c_cond
(paren
id|irda_device_txqueue_empty
c_func
(paren
id|self-&gt;netdev
)paren
)paren
(brace
multiline_comment|/* Prepare for receive */
id|ali_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;ier
op_assign
id|IER_EOM
suffix:semicolon
)brace
)brace
r_else
(brace
id|self-&gt;ier
op_assign
id|IER_EOM
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* RX */
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ******* IIR_EOM (Rx) *******&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|OldMessageCount
OG
(paren
(paren
id|self-&gt;LineStatus
op_plus
l_int|1
)paren
op_amp
l_int|0x07
)paren
)paren
(brace
id|self-&gt;rcvFramesOverflow
op_assign
id|TRUE
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ******* self-&gt;rcvFramesOverflow = TRUE ******** &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ali_ircc_dma_receive_complete
c_func
(paren
id|self
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ******* receive complete ******** &bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;ier
op_assign
id|IER_EOM
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ******* Not receive complete ******** &bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;ier
op_assign
id|IER_EOM
op_or
id|IER_TIMER
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Timer Interrupt */
r_else
r_if
c_cond
(paren
id|eir
op_amp
id|IIR_TIMER
)paren
(brace
r_if
c_cond
(paren
id|OldMessageCount
OG
(paren
(paren
id|self-&gt;LineStatus
op_plus
l_int|1
)paren
op_amp
l_int|0x07
)paren
)paren
(brace
id|self-&gt;rcvFramesOverflow
op_assign
id|TRUE
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ******* self-&gt;rcvFramesOverflow = TRUE ******* &bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable Timer */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tmp
op_amp
op_complement
id|CR_TIMER_EN
comma
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
multiline_comment|/* Check if this is a Tx timer interrupt */
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_XMIT
)paren
(brace
id|ali_ircc_dma_xmit
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Interrupt on EOM */
id|self-&gt;ier
op_assign
id|IER_EOM
suffix:semicolon
)brace
r_else
multiline_comment|/* Rx */
(brace
r_if
c_cond
(paren
id|ali_ircc_dma_receive_complete
c_func
(paren
id|self
)paren
)paren
(brace
id|self-&gt;ier
op_assign
id|IER_EOM
suffix:semicolon
)brace
r_else
(brace
id|self-&gt;ier
op_assign
id|IER_EOM
op_or
id|IER_TIMER
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Restore Interrupt */
id|SetCOMInterrupts
c_func
(paren
id|self
comma
id|TRUE
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ---------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_sir_interrupt (irq, self, eir)&n; *&n; *    Handle SIR interrupt&n; *&n; */
DECL|function|ali_ircc_sir_interrupt
r_static
r_void
id|ali_ircc_sir_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|ali_ircc_cb
op_star
id|self
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|iobase
suffix:semicolon
r_int
id|iir
comma
id|lsr
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
id|iir
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_IIR
)paren
op_amp
id|UART_IIR_ID
suffix:semicolon
r_if
c_cond
(paren
id|iir
)paren
(brace
multiline_comment|/* Clear interrupt */
id|lsr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), iir=%02x, lsr=%02x, iobase=%#x&bslash;n&quot;
comma
id|iir
comma
id|lsr
comma
id|iobase
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|iir
)paren
(brace
r_case
id|UART_IIR_RLSI
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), RLSI&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UART_IIR_RDI
suffix:colon
multiline_comment|/* Receive interrupt */
id|ali_ircc_sir_receive
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UART_IIR_THRI
suffix:colon
r_if
c_cond
(paren
id|lsr
op_amp
id|UART_LSR_THRE
)paren
(brace
multiline_comment|/* Transmitter ready for data */
id|ali_ircc_sir_write_wakeup
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), unhandled IIR=%#x&bslash;n&quot;
comma
id|iir
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_sir_receive (self)&n; *&n; *    Receive one frame from the infrared port&n; *&n; */
DECL|function|ali_ircc_sir_receive
r_static
r_void
id|ali_ircc_sir_receive
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|boguscount
op_assign
l_int|0
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/*  &n;&t; * Receive all characters in Rx FIFO, unwrap and unstuff them. &n;         * async_unwrap_char will deliver all found frames  &n;&t; */
r_do
(brace
id|async_unwrap_char
c_func
(paren
id|self-&gt;netdev
comma
op_amp
id|self-&gt;stats
comma
op_amp
id|self-&gt;rx_buff
comma
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_RX
)paren
)paren
suffix:semicolon
multiline_comment|/* Make sure we don&squot;t stay here to long */
r_if
c_cond
(paren
id|boguscount
op_increment
OG
l_int|32
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), breaking!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
op_amp
id|UART_LSR_DR
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_sir_write_wakeup (tty)&n; *&n; *    Called by the driver when there&squot;s room for more data.  If we have&n; *    more packets to send, we send them here.&n; *&n; */
DECL|function|ali_ircc_sir_write_wakeup
r_static
r_void
id|ali_ircc_sir_write_wakeup
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|actual
op_assign
l_int|0
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/* Finished with frame?  */
r_if
c_cond
(paren
id|self-&gt;tx_buff.len
OG
l_int|0
)paren
(brace
multiline_comment|/* Write data left in transmit buffer */
id|actual
op_assign
id|ali_ircc_sir_write
c_func
(paren
id|iobase
comma
id|self-&gt;io.fifo_size
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.len
)paren
suffix:semicolon
id|self-&gt;tx_buff.data
op_add_assign
id|actual
suffix:semicolon
id|self-&gt;tx_buff.len
op_sub_assign
id|actual
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
multiline_comment|/* We must wait until all data are gone */
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
op_amp
id|UART_LSR_TEMT
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), UART_LSR_THRE&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), Changing speed! self-&gt;new_speed = %d&bslash;n&quot;
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|ali_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
singleline_comment|// benjamin 2000/11/10 06:32PM
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ali_ircc_change_speed from UART_LSR_TEMT &bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;ier
op_assign
id|IER_EOM
suffix:semicolon
singleline_comment|// SetCOMInterrupts(self, TRUE);&t;&t;&t;&t;&t;&t;&t;
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
)brace
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
multiline_comment|/* Turn on receive interrupts */
id|outb
c_func
(paren
id|UART_IER_RDI
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ali_ircc_change_speed
r_static
r_void
id|ali_ircc_change_speed
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
comma
id|__u32
id|baud
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|self-&gt;netdev
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), setting speed = %d &bslash;n&quot;
comma
id|baud
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|SetCOMInterrupts
c_func
(paren
id|self
comma
id|FALSE
)paren
suffix:semicolon
singleline_comment|// 2000/11/24 11:43AM
multiline_comment|/* Go to MIR, FIR Speed */
r_if
c_cond
(paren
id|baud
OG
l_int|115200
)paren
(brace
id|ali_ircc_fir_change_speed
c_func
(paren
id|self
comma
id|baud
)paren
suffix:semicolon
multiline_comment|/* Install FIR xmit handler*/
id|dev-&gt;hard_start_xmit
op_assign
id|ali_ircc_fir_hard_xmit
suffix:semicolon
multiline_comment|/* Enable Interuupt */
id|self-&gt;ier
op_assign
id|IER_EOM
suffix:semicolon
singleline_comment|// benjamin 2000/11/20 07:24PM&t;&t;&t;&t;&t;
multiline_comment|/* Be ready for incomming frames */
id|ali_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
singleline_comment|// benajmin 2000/11/8 07:46PM not complete
)brace
multiline_comment|/* Go to SIR Speed */
r_else
(brace
id|ali_ircc_sir_change_speed
c_func
(paren
id|self
comma
id|baud
)paren
suffix:semicolon
multiline_comment|/* Install SIR xmit handler*/
id|dev-&gt;hard_start_xmit
op_assign
id|ali_ircc_sir_hard_xmit
suffix:semicolon
)brace
id|SetCOMInterrupts
c_func
(paren
id|self
comma
id|TRUE
)paren
suffix:semicolon
singleline_comment|// 2000/11/24 11:43AM
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ali_ircc_fir_change_speed
r_static
r_void
id|ali_ircc_fir_change_speed
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|priv
comma
id|__u32
id|baud
)paren
(brace
r_int
id|iobase
suffix:semicolon
r_struct
id|ali_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), self-&gt;io.speed = %d, change to speed = %d&bslash;n&quot;
comma
id|self-&gt;io.speed
comma
id|baud
)paren
suffix:semicolon
multiline_comment|/* Come from SIR speed */
r_if
c_cond
(paren
id|self-&gt;io.speed
op_le
l_int|115200
)paren
(brace
id|SIR2FIR
c_func
(paren
id|iobase
)paren
suffix:semicolon
)brace
multiline_comment|/* Update accounting for new speed */
id|self-&gt;io.speed
op_assign
id|baud
suffix:semicolon
singleline_comment|// Set Dongle Speed mode
id|ali_ircc_change_dongle_speed
c_func
(paren
id|self
comma
id|baud
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_sir_change_speed (self, speed)&n; *&n; *    Set speed of IrDA port to specified baudrate&n; *&n; */
DECL|function|ali_ircc_sir_change_speed
r_static
r_void
id|ali_ircc_sir_change_speed
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|priv
comma
id|__u32
id|speed
)paren
(brace
r_struct
id|ali_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|fcr
suffix:semicolon
multiline_comment|/* FIFO control reg */
r_int
id|lcr
suffix:semicolon
multiline_comment|/* Line control reg */
r_int
id|divisor
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), Setting speed to: %d&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/* Come from MIR or FIR speed */
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
(brace
singleline_comment|// Set Dongle Speed mode first
id|ali_ircc_change_dongle_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
id|FIR2SIR
c_func
(paren
id|iobase
)paren
suffix:semicolon
)brace
singleline_comment|// Clear Line and Auxiluary status registers 2000/11/24 11:47AM
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
suffix:semicolon
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_SCR
)paren
suffix:semicolon
multiline_comment|/* Update accounting for new speed */
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|divisor
op_assign
l_int|115200
op_div
id|speed
suffix:semicolon
id|fcr
op_assign
id|UART_FCR_ENABLE_FIFO
suffix:semicolon
multiline_comment|/* &n;&t; * Use trigger level 1 to avoid 3 ms. timeout delay at 9600 bps, and&n;&t; * almost 1,7 ms at 19200 bps. At speeds above that we can just forget&n;&t; * about this timeout since it will always be fast enough. &n;&t; */
r_if
c_cond
(paren
id|self-&gt;io.speed
OL
l_int|38400
)paren
id|fcr
op_or_assign
id|UART_FCR_TRIGGER_1
suffix:semicolon
r_else
id|fcr
op_or_assign
id|UART_FCR_TRIGGER_14
suffix:semicolon
multiline_comment|/* IrDA ports use 8N1 */
id|lcr
op_assign
id|UART_LCR_WLEN8
suffix:semicolon
id|outb
c_func
(paren
id|UART_LCR_DLAB
op_or
id|lcr
comma
id|iobase
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Set DLAB */
id|outb
c_func
(paren
id|divisor
op_amp
l_int|0xff
comma
id|iobase
op_plus
id|UART_DLL
)paren
suffix:semicolon
multiline_comment|/* Set speed */
id|outb
c_func
(paren
id|divisor
op_rshift
l_int|8
comma
id|iobase
op_plus
id|UART_DLM
)paren
suffix:semicolon
id|outb
c_func
(paren
id|lcr
comma
id|iobase
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Set 8N1&t;*/
id|outb
c_func
(paren
id|fcr
comma
id|iobase
op_plus
id|UART_FCR
)paren
suffix:semicolon
multiline_comment|/* Enable FIFO&squot;s */
multiline_comment|/* without this, the conection will be broken after come back from FIR speed,&n;&t;   but with this, the SIR connection is harder to established */
id|outb
c_func
(paren
(paren
id|UART_MCR_DTR
op_or
id|UART_MCR_RTS
op_or
id|UART_MCR_OUT2
)paren
comma
id|iobase
op_plus
id|UART_MCR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ali_ircc_change_dongle_speed
r_static
r_void
id|ali_ircc_change_dongle_speed
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|priv
comma
r_int
id|speed
)paren
(brace
r_struct
id|ali_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|priv
suffix:semicolon
r_int
id|iobase
comma
id|dongle_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|tmp
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* or iobase = self-&gt;io.sir_base; */
id|dongle_id
op_assign
id|self-&gt;io.dongle_id
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), Set Speed for %s , Speed = %d&bslash;n&quot;
comma
id|dongle_types
(braket
id|dongle_id
)braket
comma
id|speed
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
multiline_comment|/* IBM type dongle */
r_if
c_cond
(paren
id|dongle_id
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|speed
op_eq
l_int|4000000
)paren
(brace
singleline_comment|//&t;      __ __&t;
singleline_comment|// SD/MODE __|     |__ __
singleline_comment|//               __ __ 
singleline_comment|// IRTX    __ __|     |__
singleline_comment|//         T1 T2 T3 T4 T5
id|tmp
op_and_assign
op_complement
id|IRDA_CR_HDLC
suffix:semicolon
singleline_comment|// HDLC=0
id|tmp
op_or_assign
id|IRDA_CR_CRC
suffix:semicolon
singleline_comment|// CRC=1
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
singleline_comment|// T1 -&gt; SD/MODE:0 IRTX:0
id|tmp
op_and_assign
op_complement
l_int|0x09
suffix:semicolon
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
singleline_comment|// T2 -&gt; SD/MODE:1 IRTX:0
id|tmp
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
id|tmp
op_or_assign
l_int|0x0a
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
singleline_comment|// T3 -&gt; SD/MODE:1 IRTX:1
id|tmp
op_or_assign
l_int|0x0b
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
singleline_comment|// T4 -&gt; SD/MODE:0 IRTX:1
id|tmp
op_and_assign
op_complement
l_int|0x08
suffix:semicolon
id|tmp
op_or_assign
l_int|0x03
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
singleline_comment|// T5 -&gt; SD/MODE:0 IRTX:0
id|tmp
op_and_assign
op_complement
l_int|0x09
suffix:semicolon
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset -&gt; Normal TX output Signal
id|outb
c_func
(paren
id|tmp
op_amp
op_complement
l_int|0x02
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* speed &lt;=1152000 */
(brace
singleline_comment|//&t;      __&t;
singleline_comment|// SD/MODE __|  |__
singleline_comment|//
singleline_comment|// IRTX    ________
singleline_comment|//         T1 T2 T3  
multiline_comment|/* MIR 115200, 57600 */
r_if
c_cond
(paren
id|speed
op_eq
l_int|1152000
)paren
(brace
id|tmp
op_or_assign
l_int|0xA0
suffix:semicolon
singleline_comment|//HDLC=1, 1.152Mbps=1
)brace
r_else
(brace
id|tmp
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
singleline_comment|//HDLC 0.576Mbps
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
singleline_comment|//HDLC=1,
)brace
id|tmp
op_or_assign
id|IRDA_CR_CRC
suffix:semicolon
singleline_comment|// CRC=1
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
multiline_comment|/* MIR 115200, 57600 */
singleline_comment|//switch_bank(iobase, BANK2);&t;&t;&t;
singleline_comment|// T1 -&gt; SD/MODE:0 IRTX:0
id|tmp
op_and_assign
op_complement
l_int|0x09
suffix:semicolon
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
singleline_comment|// T2 -&gt; SD/MODE:1 IRTX:0
id|tmp
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
id|tmp
op_or_assign
l_int|0x0a
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
singleline_comment|// T3 -&gt; SD/MODE:0 IRTX:0
id|tmp
op_and_assign
op_complement
l_int|0x09
suffix:semicolon
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset -&gt; Normal TX output Signal
id|outb
c_func
(paren
id|tmp
op_amp
op_complement
l_int|0x02
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dongle_id
op_eq
l_int|1
)paren
multiline_comment|/* HP HDSL-3600 */
(brace
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|4000000
suffix:colon
id|tmp
op_and_assign
op_complement
id|IRDA_CR_HDLC
suffix:semicolon
singleline_comment|// HDLC=0
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|tmp
op_or_assign
l_int|0xA0
suffix:semicolon
singleline_comment|// HDLC=1, 1.152Mbps=1
r_break
suffix:semicolon
r_case
l_int|576000
suffix:colon
id|tmp
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
singleline_comment|// HDLC 0.576Mbps
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
singleline_comment|// HDLC=1,
r_break
suffix:semicolon
)brace
id|tmp
op_or_assign
id|IRDA_CR_CRC
suffix:semicolon
singleline_comment|// CRC=1
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* HP HDSL-1100 */
(brace
r_if
c_cond
(paren
id|speed
op_le
l_int|115200
)paren
multiline_comment|/* SIR */
(brace
id|tmp
op_and_assign
op_complement
id|IRDA_CR_FIR_SIN
suffix:semicolon
singleline_comment|// HP sin select = 0
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* MIR FIR */
(brace
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|4000000
suffix:colon
id|tmp
op_and_assign
op_complement
id|IRDA_CR_HDLC
suffix:semicolon
singleline_comment|// HDLC=0
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|tmp
op_or_assign
l_int|0xA0
suffix:semicolon
singleline_comment|// HDLC=1, 1.152Mbps=1
r_break
suffix:semicolon
r_case
l_int|576000
suffix:colon
id|tmp
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
singleline_comment|// HDLC 0.576Mbps
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
singleline_comment|// HDLC=1,
r_break
suffix:semicolon
)brace
id|tmp
op_or_assign
id|IRDA_CR_CRC
suffix:semicolon
singleline_comment|// CRC=1
id|tmp
op_or_assign
id|IRDA_CR_FIR_SIN
suffix:semicolon
singleline_comment|// HP sin select = 1
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tmp
comma
id|iobase
op_plus
id|FIR_IRDA_CR
)paren
suffix:semicolon
)brace
)brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_sir_write (driver)&n; *&n; *    Fill Tx FIFO with transmit data&n; *&n; */
DECL|function|ali_ircc_sir_write
r_static
r_int
id|ali_ircc_sir_write
c_func
(paren
r_int
id|iobase
comma
r_int
id|fifo_size
comma
id|__u8
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|actual
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Tx FIFO should be empty! */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
op_amp
id|UART_LSR_THRE
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), failed, fifo not empty!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fill FIFO with current frame */
r_while
c_loop
(paren
(paren
id|fifo_size
op_decrement
OG
l_int|0
)paren
op_logical_and
(paren
id|actual
OL
id|len
)paren
)paren
(brace
multiline_comment|/* Transmit next byte */
id|outb
c_func
(paren
id|buf
(braket
id|actual
)braket
comma
id|iobase
op_plus
id|UART_TX
)paren
suffix:semicolon
id|actual
op_increment
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|actual
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_net_init (dev)&n; *&n; *    Initialize network device&n; *&n; */
DECL|function|ali_ircc_net_init
r_static
r_int
id|ali_ircc_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Setup to be a normal IrDA network device driver */
id|irda_device_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Insert overrides below this line! */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_net_open (dev)&n; *&n; *    Start the device&n; *&n; */
DECL|function|ali_ircc_net_open
r_static
r_int
id|ali_ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ali_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_char
id|hwname
(braket
l_int|32
)braket
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Request IRQ and install Interrupt Handler */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|ali_ircc_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s, unable to allocate irq=%d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Always allocate the DMA channel after the IRQ, and clean up on &n;&t; * failure.&n;&t; */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|dev-&gt;name
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s, unable to allocate dma=%d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|self
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Turn on interrups */
id|outb
c_func
(paren
id|UART_IER_RLSI
op_or
id|UART_IER_RDI
op_or
id|UART_IER_THRI
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
multiline_comment|/* Ready to play! */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|//benjamin by irport
multiline_comment|/* Give self a hardware name */
id|sprintf
c_func
(paren
id|hwname
comma
l_string|&quot;ALI-FIR @ 0x%03x&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Open new IrLAP layer instance, now that everything should be&n;&t; * initialized properly &n;&t; */
id|self-&gt;irlap
op_assign
id|irlap_open
c_func
(paren
id|dev
comma
op_amp
id|self-&gt;qos
comma
id|hwname
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_net_close (dev)&n; *&n; *    Stop the device&n; *&n; */
DECL|function|ali_ircc_net_close
r_static
r_int
id|ali_ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ali_ircc_cb
op_star
id|self
suffix:semicolon
singleline_comment|//int iobase;
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Stop device */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Stop and remove instance of IrLAP */
r_if
c_cond
(paren
id|self-&gt;irlap
)paren
id|irlap_close
c_func
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
id|self-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
id|disable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|SetCOMInterrupts
c_func
(paren
id|self
comma
id|FALSE
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_fir_hard_xmit (skb, dev)&n; *&n; *    Transmit the frame&n; *&n; */
DECL|function|ali_ircc_fir_hard_xmit
r_static
r_int
id|ali_ircc_fir_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ali_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
r_int
id|mtt
comma
id|diff
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start -----------------&bslash;n&quot;
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|speed
op_ne
id|self-&gt;io.speed
)paren
op_logical_and
(paren
id|speed
op_ne
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|ali_ircc_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Register and copy this frame to DMA memory */
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|start
op_assign
id|self-&gt;tx_fifo.tail
suffix:semicolon
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|start
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|self-&gt;tx_fifo.len
op_increment
suffix:semicolon
id|self-&gt;tx_fifo.free
op_increment
suffix:semicolon
multiline_comment|/* Start transmit only if there is currently no transmit going on */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.len
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Check if we must wait the min turn time or not */
id|mtt
op_assign
id|irda_get_mtt
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtt
)paren
(brace
multiline_comment|/* Check how much time we have used already */
id|do_gettimeofday
c_func
(paren
op_amp
id|self-&gt;now
)paren
suffix:semicolon
id|diff
op_assign
id|self-&gt;now.tv_usec
op_minus
id|self-&gt;stamp.tv_usec
suffix:semicolon
multiline_comment|/* self-&gt;stamp is set from ali_ircc_dma_receive_complete() */
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ******* diff = %d ******* &bslash;n&quot;
comma
id|diff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
l_int|0
)paren
id|diff
op_add_assign
l_int|1000000
suffix:semicolon
multiline_comment|/* Check if the mtt is larger than the time we have&n;&t;&t;&t; * already used by all the protocol processing&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mtt
OG
id|diff
)paren
(brace
id|mtt
op_sub_assign
id|diff
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;&t; * Use timer if delay larger than 1000 us, and&n;&t;&t;&t;&t; * use udelay for smaller values which should&n;&t;&t;&t;&t; * be acceptable&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|mtt
OG
l_int|500
)paren
(brace
multiline_comment|/* Adjust for timer resolution */
id|mtt
op_assign
(paren
id|mtt
op_plus
l_int|250
)paren
op_div
l_int|500
suffix:semicolon
multiline_comment|/* 4 discard, 5 get advanced, Let&squot;s round off */
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ************** mtt = %d ***********&bslash;n&quot;
comma
id|mtt
)paren
suffix:semicolon
multiline_comment|/* Setup timer */
r_if
c_cond
(paren
id|mtt
op_eq
l_int|1
)paren
multiline_comment|/* 500 us */
(brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|TIMER_IIR_500
comma
id|iobase
op_plus
id|FIR_TIMER_IIR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mtt
op_eq
l_int|2
)paren
multiline_comment|/* 1 ms */
(brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|TIMER_IIR_1ms
comma
id|iobase
op_plus
id|FIR_TIMER_IIR
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* &gt; 2ms -&gt; 4ms */
(brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|TIMER_IIR_2ms
comma
id|iobase
op_plus
id|FIR_TIMER_IIR
)paren
suffix:semicolon
)brace
multiline_comment|/* Start timer */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_CR
)paren
op_or
id|CR_TIMER_EN
comma
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
multiline_comment|/* Enable timer interrupt */
id|self-&gt;ier
op_assign
id|IER_TIMER
suffix:semicolon
id|SetCOMInterrupts
c_func
(paren
id|self
comma
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* Timer will take care of the rest */
r_goto
id|out
suffix:semicolon
)brace
r_else
id|udelay
c_func
(paren
id|mtt
)paren
suffix:semicolon
)brace
singleline_comment|// if (if (mtt &gt; diff)
)brace
singleline_comment|// if (mtt) 
multiline_comment|/* Enable EOM interrupt */
id|self-&gt;ier
op_assign
id|IER_EOM
suffix:semicolon
id|SetCOMInterrupts
c_func
(paren
id|self
comma
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* Transmit frame */
id|ali_ircc_dma_xmit
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
singleline_comment|// if (self-&gt;tx_fifo.len == 1) 
id|out
suffix:colon
multiline_comment|/* Not busy transmitting anymore if window is not full */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.free
OL
id|MAX_TX_WINDOW
)paren
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
multiline_comment|/* Restore bank register */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ali_ircc_dma_xmit
r_static
r_void
id|ali_ircc_dma_xmit
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
comma
id|tmp
suffix:semicolon
r_int
r_char
id|FIFO_OPTI
comma
id|Hi
comma
id|Lo
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start -----------------&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* FIFO threshold , this method comes from NDIS5 code */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
OL
id|TX_FIFO_Threshold
)paren
(brace
id|FIFO_OPTI
op_assign
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|FIFO_OPTI
op_assign
id|TX_FIFO_Threshold
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_CR
)paren
op_amp
op_complement
id|CR_DMA_EN
comma
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|start
comma
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
comma
id|DMA_TX_MODE
)paren
suffix:semicolon
multiline_comment|/* Reset Tx FIFO */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|LCR_A_FIFO_RESET
comma
id|iobase
op_plus
id|FIR_LCR_A
)paren
suffix:semicolon
multiline_comment|/* Set Tx FIFO threshold */
r_if
c_cond
(paren
id|self-&gt;fifo_opti_buf
op_ne
id|FIFO_OPTI
)paren
(brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FIFO_OPTI
comma
id|iobase
op_plus
id|FIR_FIFO_TR
)paren
suffix:semicolon
id|self-&gt;fifo_opti_buf
op_assign
id|FIFO_OPTI
suffix:semicolon
)brace
multiline_comment|/* Set Tx DMA threshold */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|TX_DMA_Threshold
comma
id|iobase
op_plus
id|FIR_DMA_TR
)paren
suffix:semicolon
multiline_comment|/* Set max Tx frame size */
id|Hi
op_assign
(paren
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|Lo
op_assign
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
op_amp
l_int|0xff
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|outb
c_func
(paren
id|Hi
comma
id|iobase
op_plus
id|FIR_TX_DSR_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
id|Lo
comma
id|iobase
op_plus
id|FIR_TX_DSR_LO
)paren
suffix:semicolon
multiline_comment|/* Disable SIP , Disable Brick Wall (we don&squot;t support in TX mode), Change to TX mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LCR_B
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
l_int|0x20
suffix:semicolon
singleline_comment|// Disable SIP
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_or
id|LCR_B_TX_MODE
)paren
op_amp
op_complement
id|LCR_B_BW
comma
id|iobase
op_plus
id|FIR_LCR_B
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ******* Change to TX mode: FIR_LCR_B = 0x%x ******* &bslash;n&quot;
comma
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LCR_B
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|FIR_LSR
)paren
suffix:semicolon
multiline_comment|/* Enable DMA and Burst Mode */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_CR
)paren
op_or
id|CR_DMA_EN
op_or
id|CR_DMA_BURST
comma
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ali_ircc_dma_xmit_complete
r_static
r_int
id|ali_ircc_dma_xmit_complete
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
r_int
id|ret
op_assign
id|TRUE
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start -----------------&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_CR
)paren
op_amp
op_complement
id|CR_DMA_EN
comma
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
multiline_comment|/* Check for underrun! */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LSR
)paren
op_amp
id|LSR_FRAME_ABORT
)paren
op_eq
id|LSR_FRAME_ABORT
)paren
(brace
id|ERROR
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), ********* LSR_FRAME_ABORT *********&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|self-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Check if we need to change the speed */
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|ali_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Finished with this frame, so prepare for next */
id|self-&gt;tx_fifo.ptr
op_increment
suffix:semicolon
id|self-&gt;tx_fifo.len
op_decrement
suffix:semicolon
multiline_comment|/* Any frames to be sent back-to-back? */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.len
)paren
(brace
id|ali_ircc_dma_xmit
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Not finished yet! */
id|ret
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Reset Tx FIFO info */
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
)brace
multiline_comment|/* Make sure we have room for more frames */
r_if
c_cond
(paren
id|self-&gt;tx_fifo.free
OL
id|MAX_TX_WINDOW
)paren
(brace
multiline_comment|/* Not busy transmitting anymore */
multiline_comment|/* Tell the network layer, that we can accept more frames */
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
)brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_dma_receive (self)&n; *&n; *    Get ready for receiving a frame. The device will initiate a DMA&n; *    if it starts to receive a frame.&n; *&n; */
DECL|function|ali_ircc_dma_receive
r_static
r_int
id|ali_ircc_dma_receive
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
comma
id|tmp
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start -----------------&bslash;n&quot;
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Reset Tx FIFO info */
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
multiline_comment|/* Disable DMA */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_CR
)paren
op_amp
op_complement
id|CR_DMA_EN
comma
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
multiline_comment|/* Reset Message Count */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x07
comma
id|iobase
op_plus
id|FIR_LSR
)paren
suffix:semicolon
id|self-&gt;rcvFramesOverflow
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;LineStatus
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LSR
)paren
suffix:semicolon
multiline_comment|/* Reset Rx FIFO info */
id|self-&gt;io.direction
op_assign
id|IO_RECV
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
multiline_comment|/* Reset Rx FIFO */
singleline_comment|// switch_bank(iobase, BANK0);
id|outb
c_func
(paren
id|LCR_A_FIFO_RESET
comma
id|iobase
op_plus
id|FIR_LCR_A
)paren
suffix:semicolon
id|self-&gt;st_fifo.len
op_assign
id|self-&gt;st_fifo.pending_bytes
op_assign
l_int|0
suffix:semicolon
id|self-&gt;st_fifo.tail
op_assign
id|self-&gt;st_fifo.head
op_assign
l_int|0
suffix:semicolon
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;rx_buff.data
comma
id|self-&gt;rx_buff.truesize
comma
id|DMA_RX_MODE
)paren
suffix:semicolon
multiline_comment|/* Set Receive Mode,Brick Wall */
singleline_comment|//switch_bank(iobase, BANK0);
id|tmp
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LCR_B
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_int
r_char
)paren
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_or
id|LCR_B_RX_MODE
op_or
id|LCR_B_BW
comma
id|iobase
op_plus
id|FIR_LCR_B
)paren
suffix:semicolon
singleline_comment|// 2000/12/1 05:16PM
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), *** Change To RX mode: FIR_LCR_B = 0x%x *** &bslash;n&quot;
comma
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LCR_B
)paren
)paren
suffix:semicolon
multiline_comment|/* Set Rx Threshold */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RX_FIFO_Threshold
comma
id|iobase
op_plus
id|FIR_FIFO_TR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RX_DMA_Threshold
comma
id|iobase
op_plus
id|FIR_DMA_TR
)paren
suffix:semicolon
multiline_comment|/* Enable DMA and Burst Mode */
singleline_comment|// switch_bank(iobase, BANK1);
id|outb
c_func
(paren
id|CR_DMA_EN
op_or
id|CR_DMA_BURST
comma
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ali_ircc_dma_receive_complete
r_static
r_int
id|ali_ircc_dma_receive_complete
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
r_struct
id|st_fifo
op_star
id|st_fifo
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u8
id|status
comma
id|MessageCount
suffix:semicolon
r_int
id|len
comma
id|i
comma
id|iobase
comma
id|val
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start -----------------&bslash;n&quot;
)paren
suffix:semicolon
id|st_fifo
op_assign
op_amp
id|self-&gt;st_fifo
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|MessageCount
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LSR
)paren
op_amp
l_int|0x07
suffix:semicolon
r_if
c_cond
(paren
id|MessageCount
OG
l_int|0
)paren
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), Messsage count = %d,&bslash;n&quot;
comma
id|MessageCount
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MessageCount
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Bank 0 */
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_LSR
)paren
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK2
)paren
suffix:semicolon
id|len
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_RX_DSR_HI
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|len
op_assign
id|len
op_lshift
l_int|8
suffix:semicolon
id|len
op_or_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_RX_DSR_LO
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), RX Length = 0x%.2x,&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), RX Status = 0x%.2x,&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_fifo-&gt;tail
op_ge
id|MAX_RX_WINDOW
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), window is full!&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|status
op_assign
id|status
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
id|st_fifo-&gt;pending_bytes
op_add_assign
id|len
suffix:semicolon
id|st_fifo-&gt;tail
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MessageCount
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Get first entry */
id|status
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|status
suffix:semicolon
id|len
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|len
suffix:semicolon
id|st_fifo-&gt;pending_bytes
op_sub_assign
id|len
suffix:semicolon
id|st_fifo-&gt;head
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_decrement
suffix:semicolon
multiline_comment|/* Check for errors */
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xd8
)paren
op_logical_or
id|self-&gt;rcvFramesOverflow
op_logical_or
(paren
id|len
op_eq
l_int|0
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), ************* RX Errors ************ &bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Skip frame */
id|self-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|LSR_FIFO_UR
)paren
(brace
id|self-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), ************* FIFO Errors ************ &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|LSR_FRAME_ERROR
)paren
(brace
id|self-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), ************* FRAME Errors ************ &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|LSR_CRC_ERROR
)paren
(brace
id|self-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), ************* CRC Errors ************ &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;rcvFramesOverflow
)paren
(brace
id|self-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), ************* Overran DMA buffer ************ &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
id|self-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), ********** Receive Frame Size = 0 ********* &bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|st_fifo-&gt;pending_bytes
OL
l_int|32
)paren
(brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_BSR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
id|BSR_FIFO_NOT_EMPTY
)paren
op_eq
l_int|0x80
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;(), ************* BSR_FIFO_NOT_EMPTY ************ &bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Put this entry back in fifo */
id|st_fifo-&gt;head
op_decrement
suffix:semicolon
id|st_fifo-&gt;len
op_increment
suffix:semicolon
id|st_fifo-&gt;pending_bytes
op_add_assign
id|len
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|status
op_assign
id|status
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
multiline_comment|/*  &n;&t;&t; &t;&t;&t;* DMA not finished yet, so try again &n;&t;&t; &t;&t;&t;* later, set timer value, resolution &n;&t;&t; &t;&t;&t;* 500 us &n;&t;&t; &t;&t;&t;*/
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|TIMER_IIR_500
comma
id|iobase
op_plus
id|FIR_TIMER_IIR
)paren
suffix:semicolon
singleline_comment|// 2001/1/2 05:07PM
multiline_comment|/* Enable Timer */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_CR
)paren
op_or
id|CR_TIMER_EN
comma
id|iobase
op_plus
id|FIR_CR
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
multiline_comment|/* I&squot;ll be back! */
)brace
)brace
multiline_comment|/* &n;&t;&t;&t; * Remember the time we received this frame, so we can&n;&t;&t;&t; * reduce the min turn time a bit since we will know&n;&t;&t;&t; * how much time we have used for protocol processing&n;&t;&t;&t; */
id|do_gettimeofday
c_func
(paren
op_amp
id|self-&gt;stamp
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|WARNING
c_func
(paren
id|__FUNCTION__
l_string|&quot;(), memory squeeze, &quot;
l_string|&quot;dropping frame.&bslash;n&quot;
)paren
suffix:semicolon
id|self-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* Make sure IP header gets aligned */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Copy frame without CRC, CRC is removed by hardware*/
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Move to next frame */
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|self-&gt;netdev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_sir_hard_xmit (skb, dev)&n; *&n; *    Transmit the frame!&n; *&n; */
DECL|function|ali_ircc_sir_hard_xmit
r_static
r_int
id|ali_ircc_sir_hard_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ali_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|speed
op_ne
id|self-&gt;io.speed
)paren
op_logical_and
(paren
id|speed
op_ne
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|ali_ircc_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Init tx buffer */
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
multiline_comment|/* Copy skb to tx_buff while wrapping, stuffing and making CRC */
id|self-&gt;tx_buff.len
op_assign
id|async_wrap_skb
c_func
(paren
id|skb
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|self-&gt;tx_buff.len
suffix:semicolon
multiline_comment|/* Turn on transmit finished interrupt. Will fire immediately!  */
id|outb
c_func
(paren
id|UART_IER_THRI
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_net_ioctl (dev, rq, cmd)&n; *&n; *    Process IOCTL commands for this device&n; *&n; */
DECL|function|ali_ircc_net_ioctl
r_static
r_int
id|ali_ircc_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|if_irda_req
op_star
id|irq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|rq
suffix:semicolon
r_struct
id|ali_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), %s, (cmd=0x%X)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts &amp; save flags */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
multiline_comment|/* Set bandwidth */
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), SIOCSBANDWIDTH&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This function will also be used by IrLAP to change the&n;&t;&t; * speed, so we still must allow for speed change within&n;&t;&t; * interrupt context.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|ali_ircc_change_speed
c_func
(paren
id|self
comma
id|irq-&gt;ifr_baudrate
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
multiline_comment|/* Set media busy */
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), SIOCSMEDIABUSY&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|irda_device_set_media_busy
c_func
(paren
id|self-&gt;netdev
comma
id|TRUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
multiline_comment|/* Check if we are receiving right now */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), SIOCGRECEIVING&bslash;n&quot;
)paren
suffix:semicolon
id|irq-&gt;ifr_receiving
op_assign
id|ali_ircc_is_receiving
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function ali_ircc_is_receiving (self)&n; *&n; *    Return TRUE is we are currently receiving a frame&n; *&n; */
DECL|function|ali_ircc_is_receiving
r_static
r_int
id|ali_ircc_is_receiving
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|status
op_assign
id|FALSE
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start -----------------&bslash;n&quot;
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
id|FALSE
suffix:semicolon
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
(brace
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|FIR_FIFO_FR
)paren
op_amp
l_int|0x3f
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* We are receiving something */
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), We are receiving something&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
id|TRUE
suffix:semicolon
)brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
(paren
id|self-&gt;rx_buff.state
op_ne
id|OUTSIDE_FRAME
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ali_ircc_net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ali_ircc_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ali_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_amp
id|self-&gt;stats
suffix:semicolon
)brace
DECL|function|ali_ircc_suspend
r_static
r_void
id|ali_ircc_suspend
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Suspending&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.suspended
)paren
r_return
suffix:semicolon
id|ali_ircc_net_close
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|self-&gt;io.suspended
op_assign
l_int|1
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ali_ircc_wakeup
r_static
r_void
id|ali_ircc_wakeup
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;io.suspended
)paren
r_return
suffix:semicolon
id|ali_ircc_net_open
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Waking up&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
id|self-&gt;io.suspended
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ali_ircc_pmproc
r_static
r_int
id|ali_ircc_pmproc
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|ali_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|ali_ircc_cb
op_star
)paren
id|dev-&gt;data
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
)paren
(brace
r_switch
c_cond
(paren
id|rqst
)paren
(brace
r_case
id|PM_SUSPEND
suffix:colon
id|ali_ircc_suspend
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_RESUME
suffix:colon
id|ali_ircc_wakeup
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ALi Chip Function */
DECL|function|SetCOMInterrupts
r_static
r_void
id|SetCOMInterrupts
c_func
(paren
r_struct
id|ali_ircc_cb
op_star
id|self
comma
r_int
r_char
id|enable
)paren
(brace
r_int
r_char
id|newMask
suffix:semicolon
r_int
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* or sir_base */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), -------- Start -------- ( Enable = %d )&bslash;n&quot;
comma
id|enable
)paren
suffix:semicolon
multiline_comment|/* Enable the interrupt which we wish to */
r_if
c_cond
(paren
id|enable
)paren
(brace
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_XMIT
)paren
(brace
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
multiline_comment|/* FIR, MIR */
(brace
id|newMask
op_assign
id|self-&gt;ier
suffix:semicolon
)brace
r_else
multiline_comment|/* SIR */
(brace
id|newMask
op_assign
id|UART_IER_THRI
op_or
id|UART_IER_RDI
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
multiline_comment|/* FIR, MIR */
(brace
id|newMask
op_assign
id|self-&gt;ier
suffix:semicolon
)brace
r_else
multiline_comment|/* SIR */
(brace
id|newMask
op_assign
id|UART_IER_RDI
suffix:semicolon
)brace
)brace
)brace
r_else
multiline_comment|/* Disable all the interrupts */
(brace
id|newMask
op_assign
l_int|0x00
suffix:semicolon
)brace
singleline_comment|//SIR and FIR has different registers
r_if
c_cond
(paren
id|self-&gt;io.speed
OG
l_int|115200
)paren
(brace
id|switch_bank
c_func
(paren
id|iobase
comma
id|BANK0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|newMask
comma
id|iobase
op_plus
id|FIR_IER
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|newMask
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|SIR2FIR
r_static
r_void
id|SIR2FIR
c_func
(paren
r_int
id|iobase
)paren
(brace
singleline_comment|//unsigned char tmp;
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x28
comma
id|iobase
op_plus
id|UART_MCR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x68
comma
id|iobase
op_plus
id|UART_MCR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x88
comma
id|iobase
op_plus
id|UART_MCR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x60
comma
id|iobase
op_plus
id|FIR_MCR
)paren
suffix:semicolon
multiline_comment|/*  Master Reset */
id|outb
c_func
(paren
l_int|0x20
comma
id|iobase
op_plus
id|FIR_MCR
)paren
suffix:semicolon
multiline_comment|/*  Master Interrupt Enable */
singleline_comment|//tmp = inb(iobase+FIR_LCR_B);&t;/* SIP enable */
singleline_comment|//tmp |= 0x20;
singleline_comment|//outb(tmp, iobase+FIR_LCR_B);&t;
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|FIR2SIR
r_static
r_void
id|FIR2SIR
c_func
(paren
r_int
id|iobase
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ---------------- Start ----------------&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x20
comma
id|iobase
op_plus
id|FIR_MCR
)paren
suffix:semicolon
multiline_comment|/* IRQ to low */
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xA0
comma
id|iobase
op_plus
id|FIR_MCR
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t set master reset */
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|UART_FCR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x07
comma
id|iobase
op_plus
id|UART_FCR
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_RX
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_MSR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
id|__FUNCTION__
l_string|&quot;(), ----------------- End ------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Benjamin Kong &lt;benjamin_kong@ali.com.tw&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ALi FIR Controller Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|io
comma
l_string|&quot;Base I/O addresses&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;IRQ lines&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dma
comma
l_string|&quot;DMA channels&quot;
)paren
suffix:semicolon
DECL|variable|ali_ircc_init
id|module_init
c_func
(paren
id|ali_ircc_init
)paren
suffix:semicolon
DECL|variable|ali_ircc_cleanup
id|module_exit
c_func
(paren
id|ali_ircc_cleanup
)paren
suffix:semicolon
eof
