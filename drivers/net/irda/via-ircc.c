multiline_comment|/********************************************************************&n; Filename:      via-ircc.c&n; Version:       1.0 &n; Description:   Driver for the VIA VT8231/VT8233 IrDA chipsets&n; Author:        VIA Technologies,inc&n; Date  :&t;08/06/2003&n;&n;Copyright (c) 1998-2003 VIA Technologies, Inc.&n;&n;This program is free software; you can redistribute it and/or modify it under&n;the terms of the GNU General Public License as published by the Free Software&n;Foundation; either version 2, or (at your option) any later version.&n;&n;This program is distributed in the hope that it will be useful, but WITHOUT&n;ANY WARRANTIES OR REPRESENTATIONS; without even the implied warranty of&n;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n;See the GNU General Public License for more details.&n;&n;You should have received a copy of the GNU General Public License along with&n;this program; if not, write to the Free Software Foundation, Inc.,&n;59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n;&n;F01 Oct/02/02: Modify code for V0.11(move out back to back transfer)&n;F02 Oct/28/02: Add SB device ID for 3147 and 3177.&n; Comment :&n;       jul/09/2002 : only implement two kind of dongle currently.&n;       Oct/02/2002 : work on VT8231 and VT8233 .&n;       Aug/06/2003 : change driver format to pci driver .&n;&n;2004-02-16: &lt;sda@bdit.de&gt;&n;- Removed unneeded &squot;legacy&squot; pci stuff.&n;- Make sure SIR mode is set (hw_init()) before calling mode-dependant stuff.&n;- On speed change from core, don&squot;t send SIR frame with new speed. &n;  Use current speed and change speeds later.&n;- Make module-param dongle_id actually work.&n;- New dongle_id 17 (0x11): TDFS4500. Single-ended SIR only. &n;  Tested with home-grown PCB on EPIA boards.&n;- Code cleanup.&n;       &n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &quot;via-ircc.h&quot;
DECL|macro|VIA_MODULE_NAME
mdefine_line|#define VIA_MODULE_NAME &quot;via-ircc&quot;
DECL|macro|CHIP_IO_EXTENT
mdefine_line|#define CHIP_IO_EXTENT 0x40
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
id|VIA_MODULE_NAME
suffix:semicolon
multiline_comment|/* Module parameters */
DECL|variable|qos_mtt_bits
r_static
r_int
id|qos_mtt_bits
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* 1 ms or more */
DECL|variable|dongle_id
r_static
r_int
id|dongle_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default: probe */
multiline_comment|/* We can&squot;t guess the type of connected dongle, user *must* supply it. */
id|module_param
c_func
(paren
id|dongle_id
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* FIXME : we should not need this, because instances should be automatically&n; * managed by the PCI layer. Especially that we seem to only be using the&n; * first entry. Jean II */
multiline_comment|/* Max 4 instances for now */
DECL|variable|dev_self
r_static
r_struct
id|via_ircc_cb
op_star
id|dev_self
(braket
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Some prototypes */
r_static
r_int
id|via_ircc_open
c_func
(paren
r_int
id|i
comma
id|chipio_t
op_star
id|info
comma
r_int
r_int
id|id
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_close
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_dma_receive
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_dma_receive_complete
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_hard_xmit_sir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_hard_xmit_fir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|via_hw_init
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|via_ircc_change_speed
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
id|__u32
id|baud
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|via_ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_is_receiving
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_read_dongle_id
c_func
(paren
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|via_ircc_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|via_ircc_change_dongle_speed
c_func
(paren
r_int
id|iobase
comma
r_int
id|speed
comma
r_int
id|dongle_id
)paren
suffix:semicolon
r_static
r_int
id|RxTimerHandler
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|hwreset
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|via_ircc_dma_xmit
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
id|u16
id|iobase
)paren
suffix:semicolon
r_static
r_int
id|upload_rxdata
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_int
id|__devinit
id|via_init_one
(paren
r_struct
id|pci_dev
op_star
id|pcidev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_void
id|__devexit
id|via_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
multiline_comment|/* FIXME : Should use udelay() instead, even if we are x86 only - Jean II */
DECL|function|iodelay
r_static
r_void
id|iodelay
c_func
(paren
r_int
id|udelay
)paren
(brace
id|u8
id|data
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|udelay
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
op_assign
id|inb
c_func
(paren
l_int|0x80
)paren
suffix:semicolon
)brace
)brace
DECL|variable|via_pci_tbl
r_static
r_struct
id|pci_device_id
id|via_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_VIA
comma
l_int|0x8231
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_VIA
comma
l_int|0x3109
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
comma
(brace
id|PCI_VENDOR_ID_VIA
comma
l_int|0x3074
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|2
)brace
comma
(brace
id|PCI_VENDOR_ID_VIA
comma
l_int|0x3147
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|3
)brace
comma
(brace
id|PCI_VENDOR_ID_VIA
comma
l_int|0x3177
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|4
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|via_pci_tbl
)paren
suffix:semicolon
DECL|variable|via_driver
r_static
r_struct
id|pci_driver
id|via_driver
op_assign
(brace
dot
id|name
op_assign
id|VIA_MODULE_NAME
comma
dot
id|id_table
op_assign
id|via_pci_tbl
comma
dot
id|probe
op_assign
id|via_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|via_remove_one
)paren
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Function via_ircc_init ()&n; *&n; *    Initialize chip. Just find out chip type and resource.&n; */
DECL|function|via_ircc_init
r_static
r_int
id|__init
id|via_ircc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|rc
op_assign
id|pci_register_driver
c_func
(paren
op_amp
id|via_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(): error rc = %d, returning  -ENODEV...&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_init_one
r_static
r_int
id|__devinit
id|via_init_one
(paren
r_struct
id|pci_dev
op_star
id|pcidev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u8
id|temp
comma
id|oldPCI_40
comma
id|oldPCI_44
comma
id|bTmp
comma
id|bTmp1
suffix:semicolon
id|u16
id|Chipset
comma
id|FirDRQ1
comma
id|FirDRQ0
comma
id|FirIRQ
comma
id|FirIOBase
suffix:semicolon
id|chipio_t
id|info
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): Device ID=(0X%X)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|id-&gt;device
)paren
suffix:semicolon
id|rc
op_assign
id|pci_enable_device
(paren
id|pcidev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(): error rc = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
singleline_comment|// South Bridge exist
r_if
c_cond
(paren
id|ReadLPCReg
c_func
(paren
l_int|0x20
)paren
op_ne
l_int|0x3C
)paren
id|Chipset
op_assign
l_int|0x3096
suffix:semicolon
r_else
id|Chipset
op_assign
l_int|0x3076
suffix:semicolon
r_if
c_cond
(paren
id|Chipset
op_eq
l_int|0x3076
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): Chipset = 3076&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|WriteLPCReg
c_func
(paren
l_int|7
comma
l_int|0x0c
)paren
suffix:semicolon
id|temp
op_assign
id|ReadLPCReg
c_func
(paren
l_int|0x30
)paren
suffix:semicolon
singleline_comment|//check if BIOS Enable Fir
r_if
c_cond
(paren
(paren
id|temp
op_amp
l_int|0x01
)paren
op_eq
l_int|1
)paren
(brace
singleline_comment|// BIOS close or no FIR
id|WriteLPCReg
c_func
(paren
l_int|0x1d
comma
l_int|0x82
)paren
suffix:semicolon
id|WriteLPCReg
c_func
(paren
l_int|0x23
comma
l_int|0x18
)paren
suffix:semicolon
id|temp
op_assign
id|ReadLPCReg
c_func
(paren
l_int|0xF0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
(brace
id|temp
op_assign
(paren
id|ReadLPCReg
c_func
(paren
l_int|0x74
)paren
op_amp
l_int|0x03
)paren
suffix:semicolon
singleline_comment|//DMA
id|FirDRQ0
op_assign
id|temp
op_plus
l_int|4
suffix:semicolon
id|temp
op_assign
(paren
id|ReadLPCReg
c_func
(paren
l_int|0x74
)paren
op_amp
l_int|0x0C
)paren
op_rshift
l_int|2
suffix:semicolon
id|FirDRQ1
op_assign
id|temp
op_plus
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|temp
op_assign
(paren
id|ReadLPCReg
c_func
(paren
l_int|0x74
)paren
op_amp
l_int|0x0C
)paren
op_rshift
l_int|2
suffix:semicolon
singleline_comment|//DMA
id|FirDRQ0
op_assign
id|temp
op_plus
l_int|4
suffix:semicolon
id|FirDRQ1
op_assign
id|FirDRQ0
suffix:semicolon
)brace
id|FirIRQ
op_assign
(paren
id|ReadLPCReg
c_func
(paren
l_int|0x70
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
singleline_comment|//IRQ
id|FirIOBase
op_assign
id|ReadLPCReg
c_func
(paren
l_int|0x60
)paren
op_lshift
l_int|8
suffix:semicolon
singleline_comment|//IO Space :high byte
id|FirIOBase
op_assign
id|FirIOBase
op_or
id|ReadLPCReg
c_func
(paren
l_int|0x61
)paren
suffix:semicolon
singleline_comment|//low byte
id|FirIOBase
op_assign
id|FirIOBase
suffix:semicolon
id|info.fir_base
op_assign
id|FirIOBase
suffix:semicolon
id|info.irq
op_assign
id|FirIRQ
suffix:semicolon
id|info.dma
op_assign
id|FirDRQ1
suffix:semicolon
id|info.dma2
op_assign
id|FirDRQ0
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x40
comma
op_amp
id|bTmp
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x40
comma
(paren
(paren
id|bTmp
op_or
l_int|0x08
)paren
op_amp
l_int|0xfe
)paren
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x42
comma
op_amp
id|bTmp
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x42
comma
(paren
id|bTmp
op_or
l_int|0xf0
)paren
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x5a
comma
l_int|0xc0
)paren
suffix:semicolon
id|WriteLPCReg
c_func
(paren
l_int|0x28
comma
l_int|0x70
)paren
suffix:semicolon
r_if
c_cond
(paren
id|via_ircc_open
c_func
(paren
l_int|0
comma
op_amp
id|info
comma
l_int|0x3076
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
singleline_comment|//IR not turn on&t; 
)brace
r_else
(brace
singleline_comment|//Not VT1211
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): Chipset = 3096&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x67
comma
op_amp
id|bTmp
)paren
suffix:semicolon
singleline_comment|//check if BIOS Enable Fir
r_if
c_cond
(paren
(paren
id|bTmp
op_amp
l_int|0x01
)paren
op_eq
l_int|1
)paren
(brace
singleline_comment|// BIOS enable FIR
singleline_comment|//Enable Double DMA clock
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x42
comma
op_amp
id|oldPCI_40
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x42
comma
id|oldPCI_40
op_or
l_int|0x80
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x40
comma
op_amp
id|oldPCI_40
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x40
comma
id|oldPCI_40
op_amp
l_int|0xf7
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x44
comma
op_amp
id|oldPCI_44
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x44
comma
l_int|0x4e
)paren
suffix:semicolon
singleline_comment|//---------- read configuration from Function0 of south bridge
r_if
c_cond
(paren
(paren
id|bTmp
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x44
comma
op_amp
id|bTmp1
)paren
suffix:semicolon
singleline_comment|//DMA
id|FirDRQ0
op_assign
(paren
id|bTmp1
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x44
comma
op_amp
id|bTmp1
)paren
suffix:semicolon
id|FirDRQ1
op_assign
(paren
id|bTmp1
op_amp
l_int|0xc0
)paren
op_rshift
l_int|6
suffix:semicolon
)brace
r_else
(brace
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x44
comma
op_amp
id|bTmp1
)paren
suffix:semicolon
singleline_comment|//DMA
id|FirDRQ0
op_assign
(paren
id|bTmp1
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
suffix:semicolon
id|FirDRQ1
op_assign
l_int|0
suffix:semicolon
)brace
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x47
comma
op_amp
id|bTmp1
)paren
suffix:semicolon
singleline_comment|//IRQ
id|FirIRQ
op_assign
id|bTmp1
op_amp
l_int|0x0f
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x69
comma
op_amp
id|bTmp
)paren
suffix:semicolon
id|FirIOBase
op_assign
id|bTmp
op_lshift
l_int|8
suffix:semicolon
singleline_comment|//hight byte
id|pci_read_config_byte
c_func
(paren
id|pcidev
comma
l_int|0x68
comma
op_amp
id|bTmp
)paren
suffix:semicolon
id|FirIOBase
op_assign
(paren
id|FirIOBase
op_or
id|bTmp
)paren
op_amp
l_int|0xfff0
suffix:semicolon
singleline_comment|//-------------------------
id|info.fir_base
op_assign
id|FirIOBase
suffix:semicolon
id|info.irq
op_assign
id|FirIRQ
suffix:semicolon
id|info.dma
op_assign
id|FirDRQ1
suffix:semicolon
id|info.dma2
op_assign
id|FirDRQ0
suffix:semicolon
r_if
c_cond
(paren
id|via_ircc_open
c_func
(paren
l_int|0
comma
op_amp
id|info
comma
l_int|0x3096
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
singleline_comment|//IR not turn on !!!!!
)brace
singleline_comment|//Not VT1211
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): End - rc = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_clean ()&n; *&n; *    Close all configured chips&n; *&n; */
DECL|function|via_ircc_clean
r_static
r_void
id|via_ircc_clean
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|via_ircc_close
c_func
(paren
id|dev_self
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|via_remove_one
r_static
r_void
id|__devexit
id|via_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* FIXME : This is ugly. We should use pci_get_drvdata(pdev);&n;&t; * to get our driver instance and call directly via_ircc_close().&n;&t; * See vlsi_ir for details...&n;&t; * Jean II */
id|via_ircc_clean
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* FIXME : This should be in via_ircc_close(), because here we may&n;&t; * theoritically disable still configured devices :-( - Jean II */
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
DECL|function|via_ircc_cleanup
r_static
r_void
id|__exit
id|via_ircc_cleanup
c_func
(paren
r_void
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* FIXME : This should be redundant, as pci_unregister_driver()&n;&t; * should call via_remove_one() on each device.&n;&t; * Jean II */
id|via_ircc_clean
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Cleanup all instances of the driver */
id|pci_unregister_driver
(paren
op_amp
id|via_driver
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_open (iobase, irq)&n; *&n; *    Open driver instance&n; *&n; */
DECL|function|via_ircc_open
r_static
id|__devinit
r_int
id|via_ircc_open
c_func
(paren
r_int
id|i
comma
id|chipio_t
op_star
id|info
comma
r_int
r_int
id|id
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|via_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|err
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Allocate new instance of the driver */
id|dev
op_assign
id|alloc_irdadev
c_func
(paren
r_sizeof
(paren
r_struct
id|via_ircc_cb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|self-&gt;netdev
op_assign
id|dev
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* FIXME : We should store our driver instance in the PCI layer,&n;&t; * using pci_set_drvdata(), not in this array.&n;&t; * See vlsi_ir for details... - Jean II */
multiline_comment|/* FIXME : &squot;i&squot; is always 0 (see via_init_one()) :-( - Jean II */
multiline_comment|/* Need to store self somewhere */
id|dev_self
(braket
id|i
)braket
op_assign
id|self
suffix:semicolon
id|self-&gt;index
op_assign
id|i
suffix:semicolon
multiline_comment|/* Initialize Resource */
id|self-&gt;io.cfg_base
op_assign
id|info-&gt;cfg_base
suffix:semicolon
id|self-&gt;io.fir_base
op_assign
id|info-&gt;fir_base
suffix:semicolon
id|self-&gt;io.irq
op_assign
id|info-&gt;irq
suffix:semicolon
id|self-&gt;io.fir_ext
op_assign
id|CHIP_IO_EXTENT
suffix:semicolon
id|self-&gt;io.dma
op_assign
id|info-&gt;dma
suffix:semicolon
id|self-&gt;io.dma2
op_assign
id|info-&gt;dma2
suffix:semicolon
id|self-&gt;io.fifo_size
op_assign
l_int|32
suffix:semicolon
id|self-&gt;chip_id
op_assign
id|id
suffix:semicolon
id|self-&gt;st_fifo.len
op_assign
l_int|0
suffix:semicolon
id|self-&gt;RxDataReady
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserve the ioports that we need */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
comma
id|driver_name
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out1
suffix:semicolon
)brace
multiline_comment|/* Initialize QoS for this device */
id|irda_init_max_qos_capabilies
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* Check if user has supplied the dongle id or not */
r_if
c_cond
(paren
op_logical_neg
id|dongle_id
)paren
id|dongle_id
op_assign
id|via_ircc_read_dongle_id
c_func
(paren
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|self-&gt;io.dongle_id
op_assign
id|dongle_id
suffix:semicolon
multiline_comment|/* The only value we must override it the baudrate */
multiline_comment|/* Maximum speeds and capabilities are dongle-dependant. */
r_switch
c_cond
(paren
id|self-&gt;io.dongle_id
)paren
(brace
r_case
l_int|0x0d
suffix:colon
id|self-&gt;qos.baud_rate.bits
op_assign
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
op_or
id|IR_576000
op_or
id|IR_1152000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|self-&gt;qos.baud_rate.bits
op_assign
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Following was used for testing:&n;&t; *&n;&t; *   self-&gt;qos.baud_rate.bits = IR_9600;&n;&t; *&n;&t; * Is is no good, as it prohibits (error-prone) speed-changes.&n;&t; */
id|self-&gt;qos.min_turn_time.bits
op_assign
id|qos_mtt_bits
suffix:semicolon
id|irda_qos_bits_to_value
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
multiline_comment|/* Max DMA buffer size needed = (data_size + 6) * (window_size) + 6; */
id|self-&gt;rx_buff.truesize
op_assign
l_int|14384
op_plus
l_int|2048
suffix:semicolon
id|self-&gt;tx_buff.truesize
op_assign
l_int|14384
op_plus
l_int|2048
suffix:semicolon
multiline_comment|/* Allocate memory if needed */
id|self-&gt;rx_buff.head
op_assign
id|dma_alloc_coherent
c_func
(paren
l_int|NULL
comma
id|self-&gt;rx_buff.truesize
comma
op_amp
id|self-&gt;rx_buff_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out2
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;rx_buff.head
comma
l_int|0
comma
id|self-&gt;rx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;tx_buff.head
op_assign
id|dma_alloc_coherent
c_func
(paren
l_int|NULL
comma
id|self-&gt;tx_buff.truesize
comma
op_amp
id|self-&gt;tx_buff_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out3
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;tx_buff.head
comma
l_int|0
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;rx_buff.in_frame
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;rx_buff.state
op_assign
id|OUTSIDE_FRAME
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
multiline_comment|/* Reset Tx queue info */
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
multiline_comment|/* Keep track of module usage */
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Override the network functions we need to use */
id|dev-&gt;hard_start_xmit
op_assign
id|via_ircc_hard_xmit_sir
suffix:semicolon
id|dev-&gt;open
op_assign
id|via_ircc_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|via_ircc_net_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|via_ircc_net_ioctl
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|via_ircc_net_get_stats
suffix:semicolon
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out4
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;IrDA: Registered device %s (via-ircc)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Initialise the hardware..&n;&t;*/
id|self-&gt;io.speed
op_assign
l_int|9600
suffix:semicolon
id|via_hw_init
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out4
suffix:colon
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|self-&gt;tx_buff.truesize
comma
id|self-&gt;tx_buff.head
comma
id|self-&gt;tx_buff_dma
)paren
suffix:semicolon
id|err_out3
suffix:colon
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|self-&gt;rx_buff.truesize
comma
id|self-&gt;rx_buff.head
comma
id|self-&gt;rx_buff_dma
)paren
suffix:semicolon
id|err_out2
suffix:colon
id|release_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
id|err_out1
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev_self
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_close (self)&n; *&n; *    Close driver instance&n; *&n; */
DECL|function|via_ircc_close
r_static
r_int
id|via_ircc_close
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|5
)paren
suffix:semicolon
singleline_comment|//hardware reset.
multiline_comment|/* Remove netdevice */
id|unregister_netdev
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
multiline_comment|/* Release the PORT that this driver is using */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(), Releasing Region %03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
)paren
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|self-&gt;tx_buff.truesize
comma
id|self-&gt;tx_buff.head
comma
id|self-&gt;tx_buff_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
)paren
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|self-&gt;rx_buff.truesize
comma
id|self-&gt;rx_buff.head
comma
id|self-&gt;rx_buff_dma
)paren
suffix:semicolon
id|dev_self
(braket
id|self-&gt;index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|free_netdev
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_hw_init(self)&n; *&n; *    Returns non-negative on success.&n; *&n; * Formerly via_ircc_setup &n; */
DECL|function|via_hw_init
r_static
r_void
id|via_hw_init
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|SetMaxRxPacketSize
c_func
(paren
id|iobase
comma
l_int|0x0fff
)paren
suffix:semicolon
singleline_comment|//set to max:4095
singleline_comment|// FIFO Init
id|EnRXFIFOReadyInt
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRXFIFOHalfLevelInt
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnTXFIFOHalfLevelInt
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnTXFIFOUnderrunEOMInt
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnTXFIFOReadyInt
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|InvertTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|InvertRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ReadLPCReg
c_func
(paren
l_int|0x20
)paren
op_eq
l_int|0x3c
)paren
id|WriteLPCReg
c_func
(paren
l_int|0xF0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// for VT1211
multiline_comment|/* Int Init */
id|EnRXSpecInt
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* The following is basically hwreset */
multiline_comment|/* If this is the case, why not just call hwreset() ? Jean II */
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|5
)paren
suffix:semicolon
id|EnableDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnableTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnableRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnTXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|RXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|TXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|InitCard
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|CommonInit
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|SIRFilter
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|SetSIR
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|CRC16
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnTXCRC
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_ST_CT_0
comma
l_int|0x00
)paren
suffix:semicolon
id|SetBaudRate
c_func
(paren
id|iobase
comma
l_int|9600
)paren
suffix:semicolon
id|SetPulseWidth
c_func
(paren
id|iobase
comma
l_int|12
)paren
suffix:semicolon
id|SetSendPreambleCount
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|self-&gt;io.speed
op_assign
l_int|9600
suffix:semicolon
id|self-&gt;st_fifo.len
op_assign
l_int|0
suffix:semicolon
id|via_ircc_change_dongle_speed
c_func
(paren
id|iobase
comma
id|self-&gt;io.speed
comma
id|self-&gt;io.dongle_id
)paren
suffix:semicolon
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_ST_CT_0
comma
l_int|0x80
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_read_dongle_id (void)&n; *&n; */
DECL|function|via_ircc_read_dongle_id
r_static
r_int
id|via_ircc_read_dongle_id
c_func
(paren
r_int
id|iobase
)paren
(brace
r_int
id|dongle_id
op_assign
l_int|9
suffix:semicolon
multiline_comment|/* Default to IBM */
id|ERROR
c_func
(paren
l_string|&quot;via-ircc: dongle probing not supported, please specify dongle_id module parameter.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|dongle_id
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_change_dongle_speed (iobase, speed, dongle_id)&n; *    Change speed of the attach dongle&n; *    only implement two type of dongle currently.&n; */
DECL|function|via_ircc_change_dongle_speed
r_static
r_void
id|via_ircc_change_dongle_speed
c_func
(paren
r_int
id|iobase
comma
r_int
id|speed
comma
r_int
id|dongle_id
)paren
(brace
id|u8
id|mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* speed is unused, as we use IsSIROn()/IsMIROn() */
id|speed
op_assign
id|speed
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s(): change_dongle_speed to %d for 0x%x, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|speed
comma
id|iobase
comma
id|dongle_id
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dongle_id
)paren
(brace
multiline_comment|/* Note: The dongle_id&squot;s listed here are derived from&n;&t;&t; * nsc-ircc.c */
r_case
l_int|0x08
suffix:colon
multiline_comment|/* HP HSDL-2300, HP HSDL-3600/HSDL-3610 */
id|UseOneRX
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
singleline_comment|// use one RX pin   RX1,RX2
id|InvertTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|InvertRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRX2
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
singleline_comment|//sir to rx2
id|EnGPIOtoRX2
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IsSIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
singleline_comment|//sir
singleline_comment|// Mode select Off
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|IsMIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
singleline_comment|//mir
singleline_comment|// Mode select On
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// fir
r_if
c_cond
(paren
id|IsFIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
singleline_comment|//fir
singleline_comment|// Mode select On
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
multiline_comment|/* IBM31T1100 or Temic TFDS6000/TFDS6500 */
id|UseOneRX
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
singleline_comment|//use ONE RX....RX1
id|InvertTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|InvertRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
singleline_comment|// invert RX pin
id|EnRX2
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnGPIOtoRX2
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IsSIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
singleline_comment|//sir
singleline_comment|// Mode select On
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
singleline_comment|// Mode select Off
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IsMIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
singleline_comment|//mir
singleline_comment|// Mode select On
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
singleline_comment|// Mode select Off
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// fir
r_if
c_cond
(paren
id|IsFIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
singleline_comment|//fir
singleline_comment|// Mode select On
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
singleline_comment|// TX On
id|WriteTX
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
singleline_comment|// Mode select OFF
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
singleline_comment|// TX Off
id|WriteTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x0d
suffix:colon
id|UseOneRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
singleline_comment|// use two RX pin   RX1,RX2
id|InvertTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|InvertRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IsSIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
singleline_comment|//sir
id|EnGPIOtoRX2
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|WriteGIO
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRX2
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
singleline_comment|//sir to rx2
)brace
r_else
(brace
singleline_comment|// fir mir
id|EnGPIOtoRX2
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|WriteGIO
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRX2
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
singleline_comment|//fir to rx
)brace
r_break
suffix:semicolon
r_case
l_int|0x11
suffix:colon
multiline_comment|/* Temic TFDS4500 */
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: Temic TFDS4500: One RX pin, TX normal, RX inverted.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|UseOneRX
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
singleline_comment|//use ONE RX....RX1
id|InvertTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|InvertRX
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
singleline_comment|// invert RX pin
id|EnRX2
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
singleline_comment|//sir to rx2
id|EnGPIOtoRX2
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IsSIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
singleline_comment|//sir
singleline_comment|// Mode select On
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
singleline_comment|// Mode select Off
id|SlowIRRXLowActive
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
)brace
r_else
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: Warning: TFDS4500 not running in SIR mode !&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x0ff
suffix:colon
multiline_comment|/* Vishay */
r_if
c_cond
(paren
id|IsSIROn
c_func
(paren
id|iobase
)paren
)paren
id|mode
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IsMIROn
c_func
(paren
id|iobase
)paren
)paren
id|mode
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IsFIROn
c_func
(paren
id|iobase
)paren
)paren
id|mode
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IsVFIROn
c_func
(paren
id|iobase
)paren
)paren
id|mode
op_assign
l_int|5
suffix:semicolon
singleline_comment|//VFIR-16
id|SI_SetMode
c_func
(paren
id|iobase
comma
id|mode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ERROR
c_func
(paren
l_string|&quot;%s: Error: dongle_id %d unsupported !&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dongle_id
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function via_ircc_change_speed (self, baud)&n; *&n; *    Change the speed of the device&n; *&n; */
DECL|function|via_ircc_change_speed
r_static
r_void
id|via_ircc_change_speed
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
id|__u32
id|speed
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|u16
id|iobase
suffix:semicolon
id|u8
id|value
op_assign
l_int|0
comma
id|bTmp
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Update accounting for new speed */
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: change_speed to %d bps.&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|speed
)paren
suffix:semicolon
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_ST_CT_0
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* Controller mode sellection */
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
l_int|2400
suffix:colon
r_case
l_int|9600
suffix:colon
r_case
l_int|19200
suffix:colon
r_case
l_int|38400
suffix:colon
r_case
l_int|57600
suffix:colon
r_case
l_int|115200
suffix:colon
id|value
op_assign
(paren
l_int|115200
op_div
id|speed
)paren
op_minus
l_int|1
suffix:semicolon
id|SetSIR
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|CRC16
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|576000
suffix:colon
multiline_comment|/* FIXME: this can&squot;t be right, as it&squot;s the same as 115200,&n;&t;&t; * and 576000 is MIR, not SIR. */
id|value
op_assign
l_int|0
suffix:semicolon
id|SetSIR
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|CRC16
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|value
op_assign
l_int|0
suffix:semicolon
id|SetMIR
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* FIXME: CRC ??? */
r_break
suffix:semicolon
r_case
l_int|4000000
suffix:colon
id|value
op_assign
l_int|0
suffix:semicolon
id|SetFIR
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|SetPulseWidth
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|SetSendPreambleCount
c_func
(paren
id|iobase
comma
l_int|14
)paren
suffix:semicolon
id|CRC16
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnTXCRC
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16000000
suffix:colon
id|value
op_assign
l_int|0
suffix:semicolon
id|SetVFIR
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
multiline_comment|/* FIXME: CRC ??? */
r_break
suffix:semicolon
r_default
suffix:colon
id|value
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Set baudrate to 0x19[2..7] */
id|bTmp
op_assign
(paren
id|ReadReg
c_func
(paren
id|iobase
comma
id|I_CF_H_1
)paren
op_amp
l_int|0x03
)paren
suffix:semicolon
id|bTmp
op_or_assign
id|value
op_lshift
l_int|2
suffix:semicolon
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_CF_H_1
comma
id|bTmp
)paren
suffix:semicolon
multiline_comment|/* Some dongles may need to be informed about speed changes. */
id|via_ircc_change_dongle_speed
c_func
(paren
id|iobase
comma
id|speed
comma
id|self-&gt;io.dongle_id
)paren
suffix:semicolon
multiline_comment|/* Set FIFO size to 64 */
id|SetFIFO
c_func
(paren
id|iobase
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* Enable IR */
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_ST_CT_0
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// EnTXFIFOHalfLevelInt(iobase,ON);
multiline_comment|/* Enable some interrupts so we can receive frames */
singleline_comment|//EnAllInt(iobase,ON);
r_if
c_cond
(paren
id|IsSIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
id|SIRFilter
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|SIRRecvAny
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
)brace
r_else
(brace
id|SIRFilter
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|SIRRecvAny
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|speed
OG
l_int|115200
)paren
(brace
multiline_comment|/* Install FIR xmit handler */
id|dev-&gt;hard_start_xmit
op_assign
id|via_ircc_hard_xmit_fir
suffix:semicolon
id|via_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Install SIR xmit handler */
id|dev-&gt;hard_start_xmit
op_assign
id|via_ircc_hard_xmit_sir
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_hard_xmit (skb, dev)&n; *&n; *    Transmit the frame!&n; *&n; */
DECL|function|via_ircc_hard_xmit_sir
r_static
r_int
id|via_ircc_hard_xmit_sir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|via_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|iobase
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|via_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|speed
op_ne
id|self-&gt;io.speed
)paren
op_logical_and
(paren
id|speed
op_ne
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|via_ircc_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
id|InitCard
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|CommonInit
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|SIRFilter
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|SetSIR
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|CRC16
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnTXCRC
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_ST_CT_0
comma
l_int|0x00
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;tx_buff.len
op_assign
id|async_wrap_skb
c_func
(paren
id|skb
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|self-&gt;tx_buff.len
suffix:semicolon
multiline_comment|/* Send this frame with old speed */
id|SetBaudRate
c_func
(paren
id|iobase
comma
id|self-&gt;io.speed
)paren
suffix:semicolon
id|SetPulseWidth
c_func
(paren
id|iobase
comma
l_int|12
)paren
suffix:semicolon
id|SetSendPreambleCount
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_ST_CT_0
comma
l_int|0x80
)paren
suffix:semicolon
id|EnableTX
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnableRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|2
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|3
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|EnAllInt
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnTXDMA
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnRXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|irda_setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;tx_buff_dma
comma
id|self-&gt;tx_buff.len
comma
id|DMA_TX_MODE
)paren
suffix:semicolon
id|SetSendByte
c_func
(paren
id|iobase
comma
id|self-&gt;tx_buff.len
)paren
suffix:semicolon
id|RXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|TXStart
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_ircc_hard_xmit_fir
r_static
r_int
id|via_ircc_hard_xmit_fir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|via_ircc_cb
op_star
id|self
suffix:semicolon
id|u16
id|iobase
suffix:semicolon
id|__u32
id|speed
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|via_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;st_fifo.len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;chip_id
op_eq
l_int|0x3076
)paren
id|iodelay
c_func
(paren
l_int|1500
)paren
suffix:semicolon
r_else
id|udelay
c_func
(paren
l_int|1500
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|speed
op_ne
id|self-&gt;io.speed
)paren
op_logical_and
(paren
id|speed
op_ne
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|via_ircc_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|start
op_assign
id|self-&gt;tx_fifo.tail
suffix:semicolon
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.free
)braket
dot
id|start
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|self-&gt;tx_fifo.len
op_increment
suffix:semicolon
id|self-&gt;tx_fifo.free
op_increment
suffix:semicolon
singleline_comment|//F01   if (self-&gt;tx_fifo.len == 1) {
id|via_ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
singleline_comment|//F01   }
singleline_comment|//F01   if (self-&gt;tx_fifo.free &lt; (MAX_TX_WINDOW -1 )) netif_wake_queue(self-&gt;netdev);
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_ircc_dma_xmit
r_static
r_int
id|via_ircc_dma_xmit
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
id|u16
id|iobase
)paren
(brace
id|EnTXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
id|EnPhys
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnableTX
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnableRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|2
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|3
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|EnAllInt
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnTXDMA
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnRXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|irda_setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
(paren
(paren
id|u8
op_star
)paren
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|start
op_minus
id|self-&gt;tx_buff.head
)paren
op_plus
id|self-&gt;tx_buff_dma
comma
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
comma
id|DMA_TX_MODE
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: tx_fifo.ptr=%x,len=%x,tx_fifo.len=%x..&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;tx_fifo.ptr
comma
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
comma
id|self-&gt;tx_fifo.len
)paren
suffix:semicolon
id|SetSendByte
c_func
(paren
id|iobase
comma
id|self-&gt;tx_fifo.queue
(braket
id|self-&gt;tx_fifo.ptr
)braket
dot
id|len
)paren
suffix:semicolon
id|RXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|TXStart
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_dma_xmit_complete (self)&n; *&n; *    The transfer of a frame in finished. This function will only be called &n; *    by the interrupt handler&n; *&n; */
DECL|function|via_ircc_dma_xmit_complete
r_static
r_int
id|via_ircc_dma_xmit_complete
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
r_int
id|ret
op_assign
id|TRUE
suffix:semicolon
id|u8
id|Tx_status
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Disable DMA */
singleline_comment|//      DisableDmaChannel(self-&gt;io.dma);
multiline_comment|/* Check for underrrun! */
multiline_comment|/* Clear bit, by writing 1 into it */
id|Tx_status
op_assign
id|GetTXStatus
c_func
(paren
id|iobase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Tx_status
op_amp
l_int|0x08
)paren
(brace
id|self-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|self-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|hwreset
c_func
(paren
id|self
)paren
suffix:semicolon
singleline_comment|// how to clear underrrun ?
)brace
r_else
(brace
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|3
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* Check if we need to change the speed */
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|via_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Finished with this frame, so prepare for next */
r_if
c_cond
(paren
id|IsFIROn
c_func
(paren
id|iobase
)paren
)paren
(brace
r_if
c_cond
(paren
id|self-&gt;tx_fifo.len
)paren
(brace
id|self-&gt;tx_fifo.len
op_decrement
suffix:semicolon
id|self-&gt;tx_fifo.ptr
op_increment
suffix:semicolon
)brace
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s: tx_fifo.len=%x ,tx_fifo.ptr=%x,tx_fifo.free=%x...&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;tx_fifo.len
comma
id|self-&gt;tx_fifo.ptr
comma
id|self-&gt;tx_fifo.free
)paren
suffix:semicolon
multiline_comment|/* F01_S&n;&t;// Any frames to be sent back-to-back? &n;&t;if (self-&gt;tx_fifo.len) {&n;&t;&t;// Not finished yet! &n;&t;  &t;via_ircc_dma_xmit(self, iobase);&n;&t;&t;ret = FALSE;&n;&t;} else { &n;F01_E*/
singleline_comment|// Reset Tx FIFO info 
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
singleline_comment|//F01   }
singleline_comment|// Make sure we have room for more frames 
singleline_comment|//F01   if (self-&gt;tx_fifo.free &lt; (MAX_TX_WINDOW -1 )) {
singleline_comment|// Not busy transmitting anymore 
singleline_comment|// Tell the network layer, that we can accept more frames 
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
singleline_comment|//F01   }
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_dma_receive (self)&n; *&n; *    Set configuration for receive a frame.&n; *&n; */
DECL|function|via_ircc_dma_receive
r_static
r_int
id|via_ircc_dma_receive
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|self-&gt;tx_fifo.len
op_assign
id|self-&gt;tx_fifo.ptr
op_assign
id|self-&gt;tx_fifo.free
op_assign
l_int|0
suffix:semicolon
id|self-&gt;tx_fifo.tail
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;RxDataReady
op_assign
l_int|0
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_RECV
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
id|self-&gt;st_fifo.len
op_assign
id|self-&gt;st_fifo.pending_bytes
op_assign
l_int|0
suffix:semicolon
id|self-&gt;st_fifo.tail
op_assign
id|self-&gt;st_fifo.head
op_assign
l_int|0
suffix:semicolon
id|EnPhys
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnableTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnableRX
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|2
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|3
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|EnAllInt
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnTXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRXDMA
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|irda_setup_dma
c_func
(paren
id|self-&gt;io.dma2
comma
id|self-&gt;rx_buff_dma
comma
id|self-&gt;rx_buff.truesize
comma
id|DMA_RX_MODE
)paren
suffix:semicolon
id|TXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|RXStart
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_dma_receive_complete (self)&n; *&n; *    Controller Finished with receiving frames,&n; *    and this routine is call by ISR&n; *    &n; */
DECL|function|via_ircc_dma_receive_complete
r_static
r_int
id|via_ircc_dma_receive_complete
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
r_struct
id|st_fifo
op_star
id|st_fifo
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
comma
id|i
suffix:semicolon
id|u8
id|status
op_assign
l_int|0
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|st_fifo
op_assign
op_amp
id|self-&gt;st_fifo
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.speed
OL
l_int|4000000
)paren
(brace
singleline_comment|//Speed below FIR
id|len
op_assign
id|GetRecvByte
c_func
(paren
id|iobase
comma
id|self
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
id|FALSE
suffix:semicolon
singleline_comment|// Make sure IP header gets aligned 
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;chip_id
op_eq
l_int|0x3076
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_minus
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|skb-&gt;data
(braket
id|i
)braket
op_assign
id|self-&gt;rx_buff.data
(braket
id|i
op_star
l_int|2
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|self-&gt;chip_id
op_eq
l_int|0x3096
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_minus
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|skb-&gt;data
(braket
id|i
)braket
op_assign
id|self-&gt;rx_buff.data
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
singleline_comment|// Move to next frame 
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//FIR mode
id|len
op_assign
id|GetRecvByte
c_func
(paren
id|iobase
comma
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_return
id|TRUE
suffix:semicolon
singleline_comment|//interrupt only, data maybe move by RxT  
r_if
c_cond
(paren
(paren
(paren
id|len
op_minus
l_int|4
)paren
OL
l_int|2
)paren
op_logical_or
(paren
(paren
id|len
op_minus
l_int|4
)paren
OG
l_int|2048
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s(): Trouble:len=%x,CurCount=%x,LastCount=%x..&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
comma
id|RxCurCount
c_func
(paren
id|iobase
comma
id|self
)paren
comma
id|self-&gt;RxLastCount
)paren
suffix:semicolon
id|hwreset
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): fifo.len=%x,len=%x,CurCount=%x..&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|st_fifo-&gt;len
comma
id|len
op_minus
l_int|4
comma
id|RxCurCount
c_func
(paren
id|iobase
comma
id|self
)paren
)paren
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|status
op_assign
id|status
suffix:semicolon
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;tail
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
id|st_fifo-&gt;pending_bytes
op_add_assign
id|len
suffix:semicolon
id|st_fifo-&gt;tail
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|st_fifo-&gt;tail
OG
id|MAX_RX_WINDOW
)paren
id|st_fifo-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|self-&gt;RxDataReady
op_assign
l_int|0
suffix:semicolon
singleline_comment|// It maybe have MAX_RX_WINDOW package receive by
singleline_comment|// receive_complete before Timer IRQ
multiline_comment|/* F01_S&n;          if (st_fifo-&gt;len &lt; (MAX_RX_WINDOW+2 )) { &n;&t;&t;  RXStart(iobase,ON);&n;&t;  &t;  SetTimer(iobase,4);&n;&t;  }&n;&t;  else&t;  { &n;F01_E */
id|EnableRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|RXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
singleline_comment|//F01_S
singleline_comment|// Put this entry back in fifo 
r_if
c_cond
(paren
id|st_fifo-&gt;head
OG
id|MAX_RX_WINDOW
)paren
id|st_fifo-&gt;head
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|status
suffix:semicolon
id|len
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|len
suffix:semicolon
id|st_fifo-&gt;head
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_decrement
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
op_minus
l_int|4
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * if frame size,data ptr,or skb ptr are wrong ,the get next&n;&t;&t; * entry.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|skb
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|skb-&gt;data
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|self-&gt;rx_buff.data
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|len
OL
l_int|6
)paren
)paren
(brace
id|self-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): len=%x.rx_buff=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
op_minus
l_int|4
comma
id|self-&gt;rx_buff.data
)paren
suffix:semicolon
singleline_comment|// Move to next frame 
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
singleline_comment|//F01_E
)brace
singleline_comment|//FIR
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * if frame is received , but no INT ,then use this routine to upload frame.&n; */
DECL|function|upload_rxdata
r_static
r_int
id|upload_rxdata
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|st_fifo
op_star
id|st_fifo
suffix:semicolon
id|st_fifo
op_assign
op_amp
id|self-&gt;st_fifo
suffix:semicolon
id|len
op_assign
id|GetRecvByte
c_func
(paren
id|iobase
comma
id|self
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): len=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|len
op_minus
l_int|4
)paren
OL
l_int|2
)paren
)paren
(brace
id|self-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
l_int|4
op_plus
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
op_minus
l_int|4
op_plus
l_int|1
)paren
suffix:semicolon
id|st_fifo-&gt;tail
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|st_fifo-&gt;tail
OG
id|MAX_RX_WINDOW
)paren
id|st_fifo-&gt;tail
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Move to next frame 
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_fifo-&gt;len
OL
(paren
id|MAX_RX_WINDOW
op_plus
l_int|2
)paren
)paren
(brace
id|RXStart
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
)brace
r_else
(brace
id|EnableRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|RXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * Implement back to back receive , use this routine to upload data.&n; */
DECL|function|RxTimerHandler
r_static
r_int
id|RxTimerHandler
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
r_struct
id|st_fifo
op_star
id|st_fifo
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|st_fifo
op_assign
op_amp
id|self-&gt;st_fifo
suffix:semicolon
r_if
c_cond
(paren
id|CkRxRecv
c_func
(paren
id|iobase
comma
id|self
)paren
)paren
(brace
singleline_comment|// if still receiving ,then return ,don&squot;t upload frame 
id|self-&gt;RetryCount
op_assign
l_int|0
suffix:semicolon
id|SetTimer
c_func
(paren
id|iobase
comma
l_int|20
)paren
suffix:semicolon
id|self-&gt;RxDataReady
op_increment
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_else
id|self-&gt;RetryCount
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|self-&gt;RetryCount
op_ge
l_int|1
)paren
op_logical_or
(paren
(paren
id|st_fifo-&gt;pending_bytes
op_plus
l_int|2048
)paren
OG
id|self-&gt;rx_buff.truesize
)paren
op_logical_or
(paren
id|st_fifo-&gt;len
op_ge
(paren
id|MAX_RX_WINDOW
)paren
)paren
)paren
(brace
r_while
c_loop
(paren
id|st_fifo-&gt;len
OG
l_int|0
)paren
(brace
singleline_comment|//upload frame
singleline_comment|// Put this entry back in fifo 
r_if
c_cond
(paren
id|st_fifo-&gt;head
OG
id|MAX_RX_WINDOW
)paren
id|st_fifo-&gt;head
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|status
suffix:semicolon
id|len
op_assign
id|st_fifo-&gt;entries
(braket
id|st_fifo-&gt;head
)braket
dot
id|len
suffix:semicolon
id|st_fifo-&gt;head
op_increment
suffix:semicolon
id|st_fifo-&gt;len
op_decrement
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
op_minus
l_int|4
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if frame size, data ptr, or skb ptr are wrong,&n;&t;&t;&t; * then get next entry.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|skb
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|skb-&gt;data
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|self-&gt;rx_buff.data
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|len
OL
l_int|6
)paren
)paren
(brace
id|self-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|self-&gt;rx_buff.data
comma
id|len
op_minus
l_int|4
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): len=%x.head=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
op_minus
l_int|4
comma
id|st_fifo-&gt;head
)paren
suffix:semicolon
singleline_comment|// Move to next frame 
id|self-&gt;rx_buff.data
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
singleline_comment|//while
id|self-&gt;RetryCount
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): End of upload HostStatus=%x,RxStatus=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|GetHostStatus
c_func
(paren
id|iobase
)paren
comma
id|GetRXStatus
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * if frame is receive complete at this routine ,then upload&n;&t;&t; * frame.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|GetRXStatus
c_func
(paren
id|iobase
)paren
op_amp
l_int|0x10
)paren
op_logical_and
(paren
id|RxCurCount
c_func
(paren
id|iobase
comma
id|self
)paren
op_ne
id|self-&gt;RxLastCount
)paren
)paren
(brace
id|upload_rxdata
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irda_device_txqueue_empty
c_func
(paren
id|self-&gt;netdev
)paren
)paren
id|via_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// timer detect complete
r_else
id|SetTimer
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_interrupt (irq, dev_id, regs)&n; *&n; *    An interrupt from the chip has arrived. Time to do some work&n; *&n; */
DECL|function|via_ircc_interrupt
r_static
id|irqreturn_t
id|via_ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|via_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|u8
id|iHostIntType
comma
id|iRxIntType
comma
id|iTxIntType
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|self
op_assign
(paren
r_struct
id|via_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
id|iHostIntType
op_assign
id|GetHostStatus
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s(): iHostIntType %02x:  %s %s %s  %02x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|iHostIntType
comma
(paren
id|iHostIntType
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;Timer&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iHostIntType
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;Tx&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iHostIntType
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;Rx&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iHostIntType
op_amp
l_int|0x0e
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iHostIntType
op_amp
l_int|0x40
)paren
op_ne
l_int|0
)paren
(brace
singleline_comment|//Timer Event
id|self-&gt;EventFlag.TimeOut
op_increment
suffix:semicolon
id|ClearTimerInt
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_XMIT
)paren
(brace
id|via_ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_RECV
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * frame ready hold too long, must reset.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|self-&gt;RxDataReady
OG
l_int|30
)paren
(brace
id|hwreset
c_func
(paren
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irda_device_txqueue_empty
c_func
(paren
id|self-&gt;netdev
)paren
)paren
(brace
id|via_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// call this to upload frame.
id|RxTimerHandler
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//RECV
)brace
singleline_comment|//Timer Event
r_if
c_cond
(paren
(paren
id|iHostIntType
op_amp
l_int|0x20
)paren
op_ne
l_int|0
)paren
(brace
singleline_comment|//Tx Event
id|iTxIntType
op_assign
id|GetTXStatus
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s(): iTxIntType %02x:  %s %s %s %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|iTxIntType
comma
(paren
id|iTxIntType
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot;FIFO underr.&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iTxIntType
op_amp
l_int|0x04
)paren
ques
c_cond
l_string|&quot;EOM&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iTxIntType
op_amp
l_int|0x02
)paren
ques
c_cond
l_string|&quot;FIFO ready&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iTxIntType
op_amp
l_int|0x01
)paren
ques
c_cond
l_string|&quot;Early EOM&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iTxIntType
op_amp
l_int|0x4
)paren
(brace
id|self-&gt;EventFlag.EOMessage
op_increment
suffix:semicolon
singleline_comment|// read and will auto clean
r_if
c_cond
(paren
id|via_ircc_dma_xmit_complete
c_func
(paren
id|self
)paren
)paren
(brace
r_if
c_cond
(paren
id|irda_device_txqueue_empty
(paren
id|self-&gt;netdev
)paren
)paren
(brace
id|via_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|self-&gt;EventFlag.Unknown
op_increment
suffix:semicolon
)brace
)brace
singleline_comment|//EOP
)brace
singleline_comment|//Tx Event
singleline_comment|//----------------------------------------
r_if
c_cond
(paren
(paren
id|iHostIntType
op_amp
l_int|0x10
)paren
op_ne
l_int|0
)paren
(brace
singleline_comment|//Rx Event
multiline_comment|/* Check if DMA has finished */
id|iRxIntType
op_assign
id|GetRXStatus
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s(): iRxIntType %02x:  %s %s %s %s %s %s %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|iRxIntType
comma
(paren
id|iRxIntType
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;PHY err.&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iRxIntType
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;CRC err&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iRxIntType
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot;FIFO overr.&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iRxIntType
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;EOF&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iRxIntType
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot;RxData&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iRxIntType
op_amp
l_int|0x02
)paren
ques
c_cond
l_string|&quot;RxMaxLen&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|iRxIntType
op_amp
l_int|0x01
)paren
ques
c_cond
l_string|&quot;SIR bad&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iRxIntType
)paren
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s(): RxIRQ =0&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iRxIntType
op_amp
l_int|0x10
)paren
(brace
r_if
c_cond
(paren
id|via_ircc_dma_receive_complete
c_func
(paren
id|self
comma
id|iobase
)paren
)paren
(brace
singleline_comment|//F01       if(!(IsFIROn(iobase)))  via_ircc_dma_receive(self);
id|via_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// No ERR     
r_else
(brace
singleline_comment|//ERR
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s(): RxIRQ ERR:iRxIntType=%x,HostIntType=%x,CurCount=%x,RxLastCount=%x_____&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|iRxIntType
comma
id|iHostIntType
comma
id|RxCurCount
c_func
(paren
id|iobase
comma
id|self
)paren
comma
id|self-&gt;RxLastCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iRxIntType
op_amp
l_int|0x20
)paren
(brace
singleline_comment|//FIFO OverRun ERR
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//PHY,CRC ERR
r_if
c_cond
(paren
id|iRxIntType
op_ne
l_int|0x08
)paren
id|hwreset
c_func
(paren
id|self
)paren
suffix:semicolon
singleline_comment|//F01
)brace
id|via_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
singleline_comment|//ERR
)brace
singleline_comment|//Rx Event
id|spin_unlock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|iHostIntType
)paren
suffix:semicolon
)brace
DECL|function|hwreset
r_static
r_void
id|hwreset
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ResetChip
c_func
(paren
id|iobase
comma
l_int|5
)paren
suffix:semicolon
id|EnableDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnableTX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnableRX
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnTXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|RXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|TXStart
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|InitCard
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|CommonInit
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|SIRFilter
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|SetSIR
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|CRC16
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnTXCRC
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_ST_CT_0
comma
l_int|0x00
)paren
suffix:semicolon
id|SetBaudRate
c_func
(paren
id|iobase
comma
l_int|9600
)paren
suffix:semicolon
id|SetPulseWidth
c_func
(paren
id|iobase
comma
l_int|12
)paren
suffix:semicolon
id|SetSendPreambleCount
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|WriteReg
c_func
(paren
id|iobase
comma
id|I_ST_CT_0
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* Restore speed. */
id|via_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;io.speed
)paren
suffix:semicolon
id|self-&gt;st_fifo.len
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_is_receiving (self)&n; *&n; *    Return TRUE is we are currently receiving a frame&n; *&n; */
DECL|function|via_ircc_is_receiving
r_static
r_int
id|via_ircc_is_receiving
c_func
(paren
r_struct
id|via_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|status
op_assign
id|FALSE
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
id|FALSE
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
r_if
c_cond
(paren
id|CkRxRecv
c_func
(paren
id|iobase
comma
id|self
)paren
)paren
id|status
op_assign
id|TRUE
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(): status=%x....&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_net_open (dev)&n; *&n; *    Start the device&n; *&n; */
DECL|function|via_ircc_net_open
r_static
r_int
id|via_ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|via_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_char
id|hwname
(braket
l_int|32
)braket
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|via_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|self-&gt;stats.rx_packets
op_assign
l_int|0
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|via_ircc_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s, unable to allocate irq=%d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Always allocate the DMA channel after the IRQ, and clean up on &n;&t; * failure.&n;&t; */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|dev-&gt;name
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s, unable to allocate dma=%d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|self
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|self-&gt;io.dma2
op_ne
id|self-&gt;io.dma
)paren
(brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|self-&gt;io.dma2
comma
id|dev-&gt;name
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s, unable to allocate dma2=%d&bslash;n&quot;
comma
id|driver_name
comma
id|self-&gt;io.dma2
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|self
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
multiline_comment|/* turn on interrupts */
id|EnAllInt
c_func
(paren
id|iobase
comma
id|ON
)paren
suffix:semicolon
id|EnInternalLoop
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnExternalLoop
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
multiline_comment|/* */
id|via_ircc_dma_receive
c_func
(paren
id|self
)paren
suffix:semicolon
multiline_comment|/* Ready to play! */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Open new IrLAP layer instance, now that everything should be&n;&t; * initialized properly &n;&t; */
id|sprintf
c_func
(paren
id|hwname
comma
l_string|&quot;VIA @ 0x%x&quot;
comma
id|iobase
)paren
suffix:semicolon
id|self-&gt;irlap
op_assign
id|irlap_open
c_func
(paren
id|dev
comma
op_amp
id|self-&gt;qos
comma
id|hwname
)paren
suffix:semicolon
id|self-&gt;RxLastCount
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_net_close (dev)&n; *&n; *    Stop the device&n; *&n; */
DECL|function|via_ircc_net_close
r_static
r_int
id|via_ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|via_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|via_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Stop device */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Stop and remove instance of IrLAP */
r_if
c_cond
(paren
id|self-&gt;irlap
)paren
id|irlap_close
c_func
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
id|self-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|EnTXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|EnRXDMA
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|DisableDmaChannel
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|EnAllInt
c_func
(paren
id|iobase
comma
id|OFF
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|dev
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function via_ircc_net_ioctl (dev, rq, cmd)&n; *&n; *    Process IOCTL commands for this device&n; *&n; */
DECL|function|via_ircc_net_ioctl
r_static
r_int
id|via_ircc_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|if_irda_req
op_star
id|irq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|rq
suffix:semicolon
r_struct
id|via_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s(), %s, (cmd=0x%X)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts &amp; save flags */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
multiline_comment|/* Set bandwidth */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|via_ircc_change_speed
c_func
(paren
id|self
comma
id|irq-&gt;ifr_baudrate
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
multiline_comment|/* Set media busy */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|irda_device_set_media_busy
c_func
(paren
id|self-&gt;netdev
comma
id|TRUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
multiline_comment|/* Check if we are receiving right now */
id|irq-&gt;ifr_receiving
op_assign
id|via_ircc_is_receiving
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|via_ircc_net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|via_ircc_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|via_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|via_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|self-&gt;stats
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;VIA Technologies,inc&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;VIA IrDA Device Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|via_ircc_init
id|module_init
c_func
(paren
id|via_ircc_init
)paren
suffix:semicolon
DECL|variable|via_ircc_cleanup
id|module_exit
c_func
(paren
id|via_ircc_cleanup
)paren
suffix:semicolon
eof
