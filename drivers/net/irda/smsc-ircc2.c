multiline_comment|/*********************************************************************&n; * $Id: smsc-ircc2.c,v 1.19.2.5 2002/10/27 11:34:26 dip Exp $&n; *&n; * Description:   Driver for the SMC Infrared Communications Controller&n; * Status:        Experimental.&n; * Author:        Daniele Peri (peri@csai.unipa.it)&n; * Created at:    &n; * Modified at:   &n; * Modified by:   &n; * &n; *     Copyright (c) 2002      Daniele Peri&n; *     All Rights Reserved.&n; *     Copyright (c) 2002      Jean Tourrilhes&n; *&n; *&n; * Based on smc-ircc.c:&n; *&n; *     Copyright (c) 2001      Stefani Seibold&n; *     Copyright (c) 1999-2001 Dag Brattli&n; *     Copyright (c) 1998-1999 Thomas Davis, &n; *&n; *&t;and irport.c:&n; *&n; *     Copyright (c) 1997, 1998, 1999-2000 Dag Brattli, All Rights Reserved.&n; *&n; * &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; * &n; *     This program is distributed in the hope that it will be useful,&n; *     but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the&n; *     GNU General Public License for more details.&n; * &n; *     You should have received a copy of the GNU General Public License &n; *     along with this program; if not, write to the Free Software &n; *     Foundation, Inc., 59 Temple Place, Suite 330, Boston, &n; *     MA 02111-1307 USA&n; *&n; ********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/serial_reg.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;net/irda/wrapper.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &quot;smsc-ircc2.h&quot;
macro_line|#include &quot;smsc-sio.h&quot;
multiline_comment|/* Types */
DECL|struct|smsc_transceiver
r_struct
id|smsc_transceiver
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|set_for_speed
r_void
(paren
op_star
id|set_for_speed
)paren
(paren
r_int
id|fir_base
comma
id|u32
id|speed
)paren
suffix:semicolon
DECL|member|probe
r_int
(paren
op_star
id|probe
)paren
(paren
r_int
id|fir_base
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|typedef|smsc_transceiver_t
r_typedef
r_struct
id|smsc_transceiver
id|smsc_transceiver_t
suffix:semicolon
macro_line|#if 0
r_struct
id|smc_chip
(brace
r_char
op_star
id|name
suffix:semicolon
id|u16
id|flags
suffix:semicolon
id|u8
id|devid
suffix:semicolon
id|u8
id|rev
suffix:semicolon
)brace
suffix:semicolon
r_typedef
r_struct
id|smc_chip
id|smc_chip_t
suffix:semicolon
macro_line|#endif
DECL|struct|smsc_chip
r_struct
id|smsc_chip
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
macro_line|#if 0
id|u8
id|type
suffix:semicolon
macro_line|#endif
DECL|member|flags
id|u16
id|flags
suffix:semicolon
DECL|member|devid
id|u8
id|devid
suffix:semicolon
DECL|member|rev
id|u8
id|rev
suffix:semicolon
)brace
suffix:semicolon
DECL|typedef|smsc_chip_t
r_typedef
r_struct
id|smsc_chip
id|smsc_chip_t
suffix:semicolon
DECL|struct|smsc_chip_address
r_struct
id|smsc_chip_address
(brace
DECL|member|cfg_base
r_int
r_int
id|cfg_base
suffix:semicolon
DECL|member|type
r_int
r_int
id|type
suffix:semicolon
)brace
suffix:semicolon
DECL|typedef|smsc_chip_address_t
r_typedef
r_struct
id|smsc_chip_address
id|smsc_chip_address_t
suffix:semicolon
multiline_comment|/* Private data for each instance */
DECL|struct|smsc_ircc_cb
r_struct
id|smsc_ircc_cb
(brace
DECL|member|netdev
r_struct
id|net_device
op_star
id|netdev
suffix:semicolon
multiline_comment|/* Yes! we are some kind of netdevice */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|irlap
r_struct
id|irlap_cb
op_star
id|irlap
suffix:semicolon
multiline_comment|/* The link layer we are binded to */
DECL|member|io
id|chipio_t
id|io
suffix:semicolon
multiline_comment|/* IrDA controller information */
DECL|member|tx_buff
id|iobuff_t
id|tx_buff
suffix:semicolon
multiline_comment|/* Transmit buffer */
DECL|member|rx_buff
id|iobuff_t
id|rx_buff
suffix:semicolon
multiline_comment|/* Receive buffer */
DECL|member|qos
r_struct
id|qos_info
id|qos
suffix:semicolon
multiline_comment|/* QoS capabilities for this device */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* For serializing operations */
DECL|member|new_speed
id|__u32
id|new_speed
suffix:semicolon
DECL|member|flags
id|__u32
id|flags
suffix:semicolon
multiline_comment|/* Interface flags */
DECL|member|tx_buff_offsets
r_int
id|tx_buff_offsets
(braket
l_int|10
)braket
suffix:semicolon
multiline_comment|/* Offsets between frames in tx_buff */
DECL|member|tx_len
r_int
id|tx_len
suffix:semicolon
multiline_comment|/* Number of frames in tx_buff */
DECL|member|transceiver
r_int
id|transceiver
suffix:semicolon
DECL|member|pmdev
r_struct
id|pm_dev
op_star
id|pmdev
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Constants */
DECL|variable|driver_name
r_static
r_const
r_char
op_star
id|driver_name
op_assign
l_string|&quot;smsc-ircc2&quot;
suffix:semicolon
DECL|macro|DIM
mdefine_line|#define&t;DIM(x)&t;(sizeof(x)/(sizeof(*(x))))
DECL|macro|SMSC_IRCC2_C_IRDA_FALLBACK_SPEED
mdefine_line|#define SMSC_IRCC2_C_IRDA_FALLBACK_SPEED&t;9600
DECL|macro|SMSC_IRCC2_C_DEFAULT_TRANSCEIVER
mdefine_line|#define SMSC_IRCC2_C_DEFAULT_TRANSCEIVER&t;1
DECL|macro|SMSC_IRCC2_C_NET_TIMEOUT
mdefine_line|#define SMSC_IRCC2_C_NET_TIMEOUT&t;&t;&t;0
DECL|macro|SMSC_IRCC2_C_SIR_STOP
mdefine_line|#define SMSC_IRCC2_C_SIR_STOP&t;&t;&t;0
multiline_comment|/* Prototypes */
r_static
r_int
id|smsc_ircc_open
c_func
(paren
r_int
r_int
id|firbase
comma
r_int
r_int
id|sirbase
comma
id|u8
id|dma
comma
id|u8
id|irq
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_present
c_func
(paren
r_int
r_int
id|fir_base
comma
r_int
r_int
id|sir_base
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_setup_io
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
r_int
id|fir_base
comma
r_int
r_int
id|sir_base
comma
id|u8
id|dma
comma
id|u8
id|irq
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_setup_buffers
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_setup_qos
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_setup_netdev
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_init_chip
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|__exit
id|smsc_ircc_close
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_dma_receive
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_dma_receive_complete
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_sir_receive
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_hard_xmit_sir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_hard_xmit_fir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_dma_xmit
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
comma
r_int
id|bofs
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_dma_xmit_complete
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_change_speed
c_func
(paren
r_void
op_star
id|priv
comma
id|u32
id|speed
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_set_sir_speed
c_func
(paren
r_void
op_star
id|priv
comma
id|u32
id|speed
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|smsc_ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_interrupt_sir
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_sir_start
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
macro_line|#if SMSC_IRCC2_C_SIR_STOP
r_static
r_void
id|smsc_ircc_sir_stop
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|smsc_ircc_sir_write_wakeup
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_sir_write
c_func
(paren
r_int
id|iobase
comma
r_int
id|fifo_size
comma
id|__u8
op_star
id|buf
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
macro_line|#if SMSC_IRCC2_C_NET_TIMEOUT
r_static
r_void
id|smsc_ircc_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_static
r_struct
id|net_device_stats
op_star
id|smsc_ircc_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_pmproc
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_is_receiving
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_probe_transceiver
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_set_transceiver_for_speed
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
id|u32
id|speed
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_sir_wait_hw_transmitter_finish
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
multiline_comment|/* Probing */
r_static
r_int
id|__init
id|smsc_ircc_look_for_chips
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_const
id|smsc_chip_t
op_star
id|__init
id|smsc_ircc_probe
c_func
(paren
r_int
r_int
id|cfg_base
comma
id|u8
id|reg
comma
r_const
id|smsc_chip_t
op_star
id|chip
comma
r_char
op_star
id|type
)paren
suffix:semicolon
r_static
r_int
id|__init
id|smsc_superio_flat
c_func
(paren
r_const
id|smsc_chip_t
op_star
id|chips
comma
r_int
r_int
id|cfg_base
comma
r_char
op_star
id|type
)paren
suffix:semicolon
r_static
r_int
id|__init
id|smsc_superio_paged
c_func
(paren
r_const
id|smsc_chip_t
op_star
id|chips
comma
r_int
r_int
id|cfg_base
comma
r_char
op_star
id|type
)paren
suffix:semicolon
r_static
r_int
id|__init
id|smsc_superio_fdc
c_func
(paren
r_int
r_int
id|cfg_base
)paren
suffix:semicolon
r_static
r_int
id|__init
id|smsc_superio_lpc
c_func
(paren
r_int
r_int
id|cfg_base
)paren
suffix:semicolon
multiline_comment|/* Transceivers specific functions */
r_static
r_void
id|smsc_ircc_set_transceiver_toshiba_sat1800
c_func
(paren
r_int
id|fir_base
comma
id|u32
id|speed
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_probe_transceiver_toshiba_sat1800
c_func
(paren
r_int
id|fir_base
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_set_transceiver_smsc_ircc_fast_pin_select
c_func
(paren
r_int
id|fir_base
comma
id|u32
id|speed
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_probe_transceiver_smsc_ircc_fast_pin_select
c_func
(paren
r_int
id|fir_base
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_set_transceiver_smsc_ircc_atc
c_func
(paren
r_int
id|fir_base
comma
id|u32
id|speed
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_probe_transceiver_smsc_ircc_atc
c_func
(paren
r_int
id|fir_base
)paren
suffix:semicolon
multiline_comment|/* Power Management */
r_static
r_void
id|smsc_ircc_suspend
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_void
id|smsc_ircc_wakeup
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
suffix:semicolon
r_static
r_int
id|smsc_ircc_pmproc
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
suffix:semicolon
multiline_comment|/* Transceivers for SMSC-ircc */
DECL|variable|smsc_transceivers
id|smsc_transceiver_t
id|smsc_transceivers
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Toshiba Satellite 1800 (GP data pin select)&quot;
comma
id|smsc_ircc_set_transceiver_toshiba_sat1800
comma
id|smsc_ircc_probe_transceiver_toshiba_sat1800
)brace
comma
(brace
l_string|&quot;Fast pin select&quot;
comma
id|smsc_ircc_set_transceiver_smsc_ircc_fast_pin_select
comma
id|smsc_ircc_probe_transceiver_smsc_ircc_fast_pin_select
)brace
comma
(brace
l_string|&quot;ATC IRMode&quot;
comma
id|smsc_ircc_set_transceiver_smsc_ircc_atc
comma
id|smsc_ircc_probe_transceiver_smsc_ircc_atc
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|macro|SMSC_IRCC2_C_NUMBER_OF_TRANSCEIVERS
mdefine_line|#define SMSC_IRCC2_C_NUMBER_OF_TRANSCEIVERS (DIM(smsc_transceivers)-1)
multiline_comment|/*  SMC SuperIO chipsets definitions */
DECL|macro|KEY55_1
mdefine_line|#define&t;KEY55_1&t;0&t;/* SuperIO Configuration mode with Key &lt;0x55&gt; */
DECL|macro|KEY55_2
mdefine_line|#define&t;KEY55_2&t;1&t;/* SuperIO Configuration mode with Key &lt;0x55,0x55&gt; */
DECL|macro|NoIRDA
mdefine_line|#define&t;NoIRDA&t;2&t;/* SuperIO Chip has no IRDA Port */
DECL|macro|SIR
mdefine_line|#define&t;SIR&t;0&t;/* SuperIO Chip has only slow IRDA */
DECL|macro|FIR
mdefine_line|#define&t;FIR&t;4&t;/* SuperIO Chip has fast IRDA */
DECL|macro|SERx4
mdefine_line|#define&t;SERx4&t;8&t;/* SuperIO Chip supports 115,2 KBaud * 4=460,8 KBaud */
DECL|variable|fdc_chips_flat
r_static
id|smsc_chip_t
id|__initdata
id|fdc_chips_flat
(braket
)braket
op_assign
(brace
multiline_comment|/* Base address 0x3f0 or 0x370 */
(brace
l_string|&quot;37C44&quot;
comma
id|KEY55_1
op_or
id|NoIRDA
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
multiline_comment|/* This chip cannot be detected */
(brace
l_string|&quot;37C665GT&quot;
comma
id|KEY55_2
op_or
id|NoIRDA
comma
l_int|0x65
comma
l_int|0x01
)brace
comma
(brace
l_string|&quot;37C665GT&quot;
comma
id|KEY55_2
op_or
id|NoIRDA
comma
l_int|0x66
comma
l_int|0x01
)brace
comma
(brace
l_string|&quot;37C669&quot;
comma
id|KEY55_2
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x03
comma
l_int|0x02
)brace
comma
(brace
l_string|&quot;37C669&quot;
comma
id|KEY55_2
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x04
comma
l_int|0x02
)brace
comma
multiline_comment|/* ID? */
(brace
l_string|&quot;37C78&quot;
comma
id|KEY55_2
op_or
id|NoIRDA
comma
l_int|0x78
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37N769&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x28
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37N869&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x29
comma
l_int|0x00
)brace
comma
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|fdc_chips_paged
r_static
id|smsc_chip_t
id|__initdata
id|fdc_chips_paged
(braket
)braket
op_assign
(brace
multiline_comment|/* Base address 0x3f0 or 0x370 */
(brace
l_string|&quot;37B72X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x4c
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37B77X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x43
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37B78X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x44
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37B80X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x42
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37C67X&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x40
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37C93X&quot;
comma
id|KEY55_2
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x02
comma
l_int|0x01
)brace
comma
(brace
l_string|&quot;37C93XAPM&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x30
comma
l_int|0x01
)brace
comma
(brace
l_string|&quot;37C93XFR&quot;
comma
id|KEY55_2
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x03
comma
l_int|0x01
)brace
comma
(brace
l_string|&quot;37M707&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x42
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37M81X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x4d
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37N958FR&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x09
comma
l_int|0x04
)brace
comma
(brace
l_string|&quot;37N971&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x0a
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;37N972&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x0b
comma
l_int|0x00
)brace
comma
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|lpc_chips_flat
r_static
id|smsc_chip_t
id|__initdata
id|lpc_chips_flat
(braket
)braket
op_assign
(brace
multiline_comment|/* Base address 0x2E or 0x4E */
(brace
l_string|&quot;47N227&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x5a
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;47N267&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x5e
comma
l_int|0x00
)brace
comma
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|lpc_chips_paged
r_static
id|smsc_chip_t
id|__initdata
id|lpc_chips_paged
(braket
)braket
op_assign
(brace
multiline_comment|/* Base address 0x2E or 0x4E */
(brace
l_string|&quot;47B27X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x51
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;47B37X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x52
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;47M10X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x59
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;47M120&quot;
comma
id|KEY55_1
op_or
id|NoIRDA
op_or
id|SERx4
comma
l_int|0x5c
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;47M13X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x59
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;47M14X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x5f
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;47N252&quot;
comma
id|KEY55_1
op_or
id|FIR
op_or
id|SERx4
comma
l_int|0x0e
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;47S42X&quot;
comma
id|KEY55_1
op_or
id|SIR
op_or
id|SERx4
comma
l_int|0x57
comma
l_int|0x00
)brace
comma
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|macro|SMSCSIO_TYPE_FDC
mdefine_line|#define SMSCSIO_TYPE_FDC&t;1
DECL|macro|SMSCSIO_TYPE_LPC
mdefine_line|#define SMSCSIO_TYPE_LPC&t;2
DECL|macro|SMSCSIO_TYPE_FLAT
mdefine_line|#define SMSCSIO_TYPE_FLAT&t;4
DECL|macro|SMSCSIO_TYPE_PAGED
mdefine_line|#define SMSCSIO_TYPE_PAGED&t;8
DECL|variable|possible_addresses
r_static
id|smsc_chip_address_t
id|__initdata
id|possible_addresses
(braket
)braket
op_assign
(brace
(brace
l_int|0x3f0
comma
id|SMSCSIO_TYPE_FDC
op_or
id|SMSCSIO_TYPE_FLAT
op_or
id|SMSCSIO_TYPE_PAGED
)brace
comma
(brace
l_int|0x370
comma
id|SMSCSIO_TYPE_FDC
op_or
id|SMSCSIO_TYPE_FLAT
op_or
id|SMSCSIO_TYPE_PAGED
)brace
comma
(brace
l_int|0xe0
comma
id|SMSCSIO_TYPE_FDC
op_or
id|SMSCSIO_TYPE_FLAT
op_or
id|SMSCSIO_TYPE_PAGED
)brace
comma
(brace
l_int|0x2e
comma
id|SMSCSIO_TYPE_LPC
op_or
id|SMSCSIO_TYPE_FLAT
op_or
id|SMSCSIO_TYPE_PAGED
)brace
comma
(brace
l_int|0x4e
comma
id|SMSCSIO_TYPE_LPC
op_or
id|SMSCSIO_TYPE_FLAT
op_or
id|SMSCSIO_TYPE_PAGED
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Globals */
DECL|variable|dev_self
r_static
r_struct
id|smsc_ircc_cb
op_star
id|dev_self
(braket
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|ircc_irq
r_static
r_int
id|ircc_irq
op_assign
l_int|255
suffix:semicolon
DECL|variable|ircc_dma
r_static
r_int
id|ircc_dma
op_assign
l_int|255
suffix:semicolon
DECL|variable|ircc_fir
r_static
r_int
id|ircc_fir
op_assign
l_int|0
suffix:semicolon
DECL|variable|ircc_sir
r_static
r_int
id|ircc_sir
op_assign
l_int|0
suffix:semicolon
DECL|variable|ircc_cfg
r_static
r_int
id|ircc_cfg
op_assign
l_int|0
suffix:semicolon
DECL|variable|ircc_transceiver
r_static
r_int
id|ircc_transceiver
op_assign
l_int|0
suffix:semicolon
DECL|variable|dev_count
r_static
r_int
r_int
id|dev_count
op_assign
l_int|0
suffix:semicolon
DECL|function|register_bank
r_static
r_inline
r_void
id|register_bank
c_func
(paren
r_int
id|iobase
comma
r_int
id|bank
)paren
(brace
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_MASTER
)paren
op_amp
l_int|0xf0
)paren
op_or
(paren
id|bank
op_amp
l_int|0x07
)paren
)paren
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; *&n; * SMSC-ircc stuff&n; *&n; *&n; *******************************************************************************/
multiline_comment|/*&n; * Function smsc_ircc_init ()&n; *&n; *    Initialize chip. Just try to find out how many chips we are dealing with&n; *    and where they are&n; */
DECL|function|smsc_ircc_init
r_int
id|__init
id|smsc_ircc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dev_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ircc_fir
OG
l_int|0
)paren
op_logical_and
(paren
id|ircc_sir
OG
l_int|0
)paren
)paren
(brace
id|MESSAGE
c_func
(paren
l_string|&quot; Overriding FIR address 0x%04x&bslash;n&quot;
comma
id|ircc_fir
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot; Overriding SIR address 0x%04x&bslash;n&quot;
comma
id|ircc_sir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smsc_ircc_open
c_func
(paren
id|ircc_fir
comma
id|ircc_sir
comma
id|ircc_dma
comma
id|ircc_irq
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* try user provided configuration register base address */
r_if
c_cond
(paren
id|ircc_cfg
OG
l_int|0
)paren
(brace
id|MESSAGE
c_func
(paren
l_string|&quot; Overriding configuration address 0x%04x&bslash;n&quot;
comma
id|ircc_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smsc_superio_fdc
c_func
(paren
id|ircc_cfg
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smsc_superio_lpc
c_func
(paren
id|ircc_cfg
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smsc_ircc_look_for_chips
c_func
(paren
)paren
OG
l_int|0
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_open (firbase, sirbase, dma, irq)&n; *&n; *    Try to open driver instance&n; *&n; */
DECL|function|smsc_ircc_open
r_static
r_int
id|__init
id|smsc_ircc_open
c_func
(paren
r_int
r_int
id|fir_base
comma
r_int
r_int
id|sir_base
comma
id|u8
id|dma
comma
id|u8
id|irq
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|err
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|err
op_assign
id|smsc_ircc_present
c_func
(paren
id|fir_base
comma
id|sir_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_count
OG
id|DIM
c_func
(paren
id|dev_self
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(), too many devices!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Allocate new instance of the driver&n;&t; */
id|self
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|smsc_ircc_cb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
l_string|&quot;%s, Can&squot;t allocate memory for control block!&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|smsc_ircc_cb
)paren
)paren
suffix:semicolon
multiline_comment|/* Need to store self somewhere */
id|dev_self
(braket
id|dev_count
op_increment
)braket
op_assign
id|self
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
id|err
op_assign
id|smsc_ircc_setup_buffers
c_func
(paren
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|smsc_ircc_setup_io
c_func
(paren
id|self
comma
id|fir_base
comma
id|sir_base
comma
id|dma
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|smsc_ircc_setup_qos
c_func
(paren
id|self
)paren
suffix:semicolon
id|self-&gt;flags
op_assign
id|IFF_FIR
op_or
id|IFF_MIR
op_or
id|IFF_SIR
op_or
id|IFF_DMA
op_or
id|IFF_PIO
suffix:semicolon
id|smsc_ircc_init_chip
c_func
(paren
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ircc_transceiver
OG
l_int|0
op_logical_and
id|ircc_transceiver
OL
id|SMSC_IRCC2_C_NUMBER_OF_TRANSCEIVERS
)paren
(brace
id|self-&gt;transceiver
op_assign
id|ircc_transceiver
suffix:semicolon
)brace
r_else
id|smsc_ircc_probe_transceiver
c_func
(paren
id|self
)paren
suffix:semicolon
id|err
op_assign
id|smsc_ircc_setup_netdev
c_func
(paren
id|self
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|self-&gt;pmdev
op_assign
id|pm_register
c_func
(paren
id|PM_SYS_DEV
comma
id|PM_SYS_IRDA
comma
id|smsc_ircc_pmproc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;pmdev
)paren
id|self-&gt;pmdev-&gt;data
op_assign
id|self
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_present(fir_base, sir_base)&n; *&n; *    Check the smsc-ircc chip presence&n; *&n; */
DECL|function|smsc_ircc_present
r_static
r_int
id|smsc_ircc_present
c_func
(paren
r_int
r_int
id|fir_base
comma
r_int
r_int
id|sir_base
)paren
(brace
r_int
r_char
id|low
comma
id|high
comma
id|chip
comma
id|config
comma
id|dma
comma
id|irq
comma
id|version
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|fir_base
comma
id|SMSC_IRCC2_FIR_CHIP_IO_EXTENT
)paren
OL
l_int|0
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s: can&squot;t get fir_base of 0x%03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|fir_base
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#if POSSIBLE_USED_BY_SERIAL_DRIVER
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|sir_base
comma
id|SMSC_IRCC2_SIR_CHIP_IO_EXTENT
)paren
OL
l_int|0
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s: can&squot;t get sir_base of 0x%03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|sir_base
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#endif
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|3
)paren
suffix:semicolon
id|high
op_assign
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_ID_HIGH
)paren
suffix:semicolon
id|low
op_assign
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_ID_LOW
)paren
suffix:semicolon
id|chip
op_assign
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_CHIP_ID
)paren
suffix:semicolon
id|version
op_assign
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_VERSION
)paren
suffix:semicolon
id|config
op_assign
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_INTERFACE
)paren
suffix:semicolon
id|dma
op_assign
id|config
op_amp
id|IRCC_INTERFACE_DMA_MASK
suffix:semicolon
id|irq
op_assign
(paren
id|config
op_amp
id|IRCC_INTERFACE_IRQ_MASK
)paren
op_rshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|high
op_ne
l_int|0x10
op_logical_or
id|low
op_ne
l_int|0xb8
op_logical_or
(paren
id|chip
op_ne
l_int|0xf1
op_logical_and
id|chip
op_ne
l_int|0xf2
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(), addr 0x%04x - no device found!&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|fir_base
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|MESSAGE
c_func
(paren
l_string|&quot;SMsC IrDA Controller found&bslash;n IrCC version %d.%d, &quot;
l_string|&quot;firport 0x%03x, sirport 0x%03x dma=%d, irq=%d&bslash;n&quot;
comma
id|chip
op_amp
l_int|0x0f
comma
id|version
comma
id|fir_base
comma
id|sir_base
comma
id|dma
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_setup_buffers(self)&n; *&n; *    Setup RX/TX buffers&n; *&n; */
DECL|function|smsc_ircc_setup_buffers
r_static
r_int
id|smsc_ircc_setup_buffers
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
id|self-&gt;rx_buff.truesize
op_assign
id|SMSC_IRCC2_RX_BUFF_TRUESIZE
suffix:semicolon
id|self-&gt;tx_buff.truesize
op_assign
id|SMSC_IRCC2_TX_BUFF_TRUESIZE
suffix:semicolon
id|self-&gt;rx_buff.head
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;rx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
l_string|&quot;%s, Can&squot;t allocate memory for receive buffer!&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|self-&gt;tx_buff.head
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
id|self-&gt;tx_buff.truesize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
l_string|&quot;%s, Can&squot;t allocate memory for transmit buffer!&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|self-&gt;rx_buff.head
comma
l_int|0
comma
id|self-&gt;rx_buff.truesize
)paren
suffix:semicolon
id|memset
c_func
(paren
id|self-&gt;tx_buff.head
comma
l_int|0
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;rx_buff.in_frame
op_assign
id|FALSE
suffix:semicolon
id|self-&gt;rx_buff.state
op_assign
id|OUTSIDE_FRAME
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_setup_io(self, fir_base, sir_base, dma, irq)&n; *&n; *    Setup I/O&n; *&n; */
DECL|function|smsc_ircc_setup_io
r_static
r_int
id|smsc_ircc_setup_io
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
r_int
id|fir_base
comma
r_int
r_int
id|sir_base
comma
id|u8
id|dma
comma
id|u8
id|irq
)paren
(brace
r_int
r_char
id|config
comma
id|chip_dma
comma
id|chip_irq
suffix:semicolon
r_void
op_star
id|ret
suffix:semicolon
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|3
)paren
suffix:semicolon
id|config
op_assign
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_INTERFACE
)paren
suffix:semicolon
id|chip_dma
op_assign
id|config
op_amp
id|IRCC_INTERFACE_DMA_MASK
suffix:semicolon
id|chip_irq
op_assign
(paren
id|config
op_amp
id|IRCC_INTERFACE_IRQ_MASK
)paren
op_rshift
l_int|4
suffix:semicolon
id|self-&gt;io.fir_base
op_assign
id|fir_base
suffix:semicolon
id|self-&gt;io.sir_base
op_assign
id|sir_base
suffix:semicolon
id|self-&gt;io.fir_ext
op_assign
id|SMSC_IRCC2_FIR_CHIP_IO_EXTENT
suffix:semicolon
id|self-&gt;io.sir_ext
op_assign
id|SMSC_IRCC2_SIR_CHIP_IO_EXTENT
suffix:semicolon
id|self-&gt;io.fifo_size
op_assign
id|SMSC_IRCC2_FIFO_SIZE
suffix:semicolon
id|self-&gt;io.speed
op_assign
id|SMSC_IRCC2_C_IRDA_FALLBACK_SPEED
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|255
)paren
(brace
r_if
c_cond
(paren
id|irq
op_ne
id|chip_irq
)paren
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Overriding IRQ - chip says %d, using %d&bslash;n&quot;
comma
id|driver_name
comma
id|chip_irq
comma
id|irq
)paren
suffix:semicolon
id|self-&gt;io.irq
op_assign
id|irq
suffix:semicolon
)brace
r_else
id|self-&gt;io.irq
op_assign
id|chip_irq
suffix:semicolon
r_if
c_cond
(paren
id|dma
OL
l_int|255
)paren
(brace
r_if
c_cond
(paren
id|dma
op_ne
id|chip_dma
)paren
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Overriding DMA - chip says %d, using %d&bslash;n&quot;
comma
id|driver_name
comma
id|chip_dma
comma
id|dma
)paren
suffix:semicolon
id|self-&gt;io.dma
op_assign
id|dma
suffix:semicolon
)brace
r_else
id|self-&gt;io.dma
op_assign
id|chip_dma
suffix:semicolon
id|ret
op_assign
id|request_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
comma
id|driver_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(), can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ret
op_assign
id|request_region
c_func
(paren
id|self-&gt;io.sir_base
comma
id|self-&gt;io.sir_ext
comma
id|driver_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(), can&squot;t get iobase of 0x%03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;io.sir_base
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_setup_qos(self)&n; *&n; *    Setup qos&n; *&n; */
DECL|function|smsc_ircc_setup_qos
r_static
r_void
id|smsc_ircc_setup_qos
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
multiline_comment|/* Initialize QoS for this device */
id|irda_init_max_qos_capabilies
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
id|self-&gt;qos.baud_rate.bits
op_assign
id|IR_9600
op_or
id|IR_19200
op_or
id|IR_38400
op_or
id|IR_57600
op_or
id|IR_115200
op_or
id|IR_576000
op_or
id|IR_1152000
op_or
(paren
id|IR_4000000
op_lshift
l_int|8
)paren
suffix:semicolon
id|self-&gt;qos.min_turn_time.bits
op_assign
id|SMSC_IRCC2_MIN_TURN_TIME
suffix:semicolon
id|self-&gt;qos.window_size.bits
op_assign
id|SMSC_IRCC2_WINDOW_SIZE
suffix:semicolon
id|irda_qos_bits_to_value
c_func
(paren
op_amp
id|self-&gt;qos
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_init_chip(self)&n; *&n; *    Init chip&n; *&n; */
DECL|function|smsc_ircc_init_chip
r_static
r_void
id|smsc_ircc_init_chip
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
comma
id|ir_mode
comma
id|ctrl
comma
id|fast
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|ir_mode
op_assign
id|IRCC_CFGA_IRDA_SIR_A
suffix:semicolon
id|ctrl
op_assign
l_int|0
suffix:semicolon
id|fast
op_assign
l_int|0
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_RESET
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGA
)paren
op_amp
l_int|0x87
)paren
op_or
id|ir_mode
)paren
comma
id|iobase
op_plus
id|IRCC_SCE_CFGA
)paren
suffix:semicolon
macro_line|#ifdef smsc_669 /* Uses pin 88/89 for Rx/Tx */
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
l_int|0x3f
)paren
op_or
id|IRCC_CFGB_MUX_COM
)paren
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
macro_line|#else&t;
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
l_int|0x3f
)paren
op_or
id|IRCC_CFGB_MUX_IR
)paren
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
macro_line|#endif&t;
(paren
r_void
)paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_FIFO_THRESHOLD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SMSC_IRCC2_FIFO_THRESHOLD
comma
id|iobase
op_plus
id|IRCC_FIFO_THRESHOLD
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_CONTROL
)paren
op_amp
l_int|0x30
)paren
op_or
id|ctrl
comma
id|iobase
op_plus
id|IRCC_CONTROL
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|fast
comma
id|iobase
op_plus
id|IRCC_LCR_A
)paren
suffix:semicolon
id|smsc_ircc_set_sir_speed
c_func
(paren
id|self
comma
id|SMSC_IRCC2_C_IRDA_FALLBACK_SPEED
)paren
suffix:semicolon
multiline_comment|/* Power on device */
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_setup_netdev(self)&n; *&n; *    Alloc and setup network device&n; *&n; */
DECL|function|smsc_ircc_setup_netdev
r_static
r_int
id|smsc_ircc_setup_netdev
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Alloc netdev */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|dev_alloc
c_func
(paren
l_string|&quot;irda%d&quot;
comma
op_amp
id|err
)paren
)paren
)paren
(brace
id|ERROR
c_func
(paren
l_string|&quot;%s(), dev_alloc() failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
(paren
r_void
op_star
)paren
id|self
suffix:semicolon
id|self-&gt;netdev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;init
op_assign
id|smsc_ircc_net_init
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|smsc_ircc_hard_xmit_sir
suffix:semicolon
macro_line|#if SMSC_IRCC2_C_NET_TIMEOUT
id|dev-&gt;tx_timeout
op_assign
id|smsc_ircc_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|HZ
op_star
l_int|2
suffix:semicolon
multiline_comment|/* Allow enough time for speed change */
macro_line|#endif
id|dev-&gt;open
op_assign
id|smsc_ircc_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|smsc_ircc_net_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|smsc_ircc_net_ioctl
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|smsc_ircc_net_get_stats
suffix:semicolon
multiline_comment|/* Make ifconfig display some details */
id|dev-&gt;base_addr
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|dev-&gt;irq
op_assign
id|self-&gt;io.irq
suffix:semicolon
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ERROR
c_func
(paren
l_string|&quot;%s(), register_netdev() failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|MESSAGE
c_func
(paren
l_string|&quot;IrDA: Registered device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_net_ioctl (dev, rq, cmd)&n; *&n; *    Process IOCTL commands for this device&n; *&n; */
DECL|function|smsc_ircc_net_ioctl
r_static
r_int
id|smsc_ircc_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|if_irda_req
op_star
id|irq
op_assign
(paren
r_struct
id|if_irda_req
op_star
)paren
id|rq
suffix:semicolon
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(), %s, (cmd=0x%X)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSBANDWIDTH
suffix:colon
multiline_comment|/* Set bandwidth */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
r_else
(brace
multiline_comment|/* Make sure we are the only one touching&n;&t;&t;&t; * self-&gt;io.speed and the hardware - Jean II */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|smsc_ircc_change_speed
c_func
(paren
id|self
comma
id|irq-&gt;ifr_baudrate
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCSMEDIABUSY
suffix:colon
multiline_comment|/* Set media busy */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|irda_device_set_media_busy
c_func
(paren
id|self-&gt;netdev
comma
id|TRUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGRECEIVING
suffix:colon
multiline_comment|/* Check if we are receiving right now */
id|irq-&gt;ifr_receiving
op_assign
id|smsc_ircc_is_receiving
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#if 0
r_case
id|SIOCSDTRRTS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|smsc_ircc_sir_set_dtr_rts
c_func
(paren
id|dev
comma
id|irq-&gt;ifr_dtr
comma
id|irq-&gt;ifr_rts
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|smsc_ircc_net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|smsc_ircc_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|self-&gt;stats
suffix:semicolon
)brace
macro_line|#if SMSC_IRCC2_C_NET_TIMEOUT
multiline_comment|/*&n; * Function smsc_ircc_timeout (struct net_device *dev)&n; *&n; *    The networking timeout management.&n; *&n; */
DECL|function|smsc_ircc_timeout
r_static
r_void
id|smsc_ircc_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|WARNING
c_func
(paren
l_string|&quot;%s: transmit timed out, changing speed to: %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|self-&gt;io.speed
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|smsc_ircc_sir_start
c_func
(paren
id|self
)paren
suffix:semicolon
id|smsc_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;io.speed
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Function smsc_ircc_hard_xmit_sir (struct sk_buff *skb, struct net_device *dev)&n; *&n; *    Transmits the current frame until FIFO is full, then&n; *    waits until the next transmit interrupt, and continues until the&n; *    frame is transmitted.&n; */
DECL|function|smsc_ircc_hard_xmit_sir
r_int
id|smsc_ircc_hard_xmit_sir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|s32
id|speed
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Make sure test of self-&gt;io.speed &amp; speed change are atomic */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed */
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|speed
op_ne
id|self-&gt;io.speed
)paren
op_logical_and
(paren
id|speed
op_ne
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * We send frames one by one in SIR mode (no&n;&t;&t;&t; * pipelining), so at this point, if we were sending&n;&t;&t;&t; * a previous frame, we just received the interrupt&n;&t;&t;&t; * telling us it is finished (UART_IIR_THRI).&n;&t;&t;&t; * Therefore, waiting for the transmitter to really&n;&t;&t;&t; * finish draining the fifo won&squot;t take too long.&n;&t;&t;&t; * And the interrupt handler is not expected to run.&n;&t;&t;&t; * - Jean II */
id|smsc_ircc_sir_wait_hw_transmitter_finish
c_func
(paren
id|self
)paren
suffix:semicolon
id|smsc_ircc_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
)brace
multiline_comment|/* Init tx buffer */
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
multiline_comment|/* Copy skb to tx_buff while wrapping, stuffing and making CRC */
id|self-&gt;tx_buff.len
op_assign
id|async_wrap_skb
c_func
(paren
id|skb
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.truesize
)paren
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|self-&gt;tx_buff.len
suffix:semicolon
multiline_comment|/* Turn on transmit finished interrupt. Will fire immediately!  */
id|outb
c_func
(paren
id|UART_IER_THRI
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_set_fir_speed (self, baud)&n; *&n; *    Change the speed of the device&n; *&n; */
DECL|function|smsc_ircc_set_fir_speed
r_static
r_void
id|smsc_ircc_set_fir_speed
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
id|u32
id|speed
)paren
(brace
r_int
id|fir_base
comma
id|ir_mode
comma
id|ctrl
comma
id|fast
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|fir_base
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_default
suffix:colon
r_case
l_int|576000
suffix:colon
id|ir_mode
op_assign
id|IRCC_CFGA_IRDA_HDLC
suffix:semicolon
id|ctrl
op_assign
id|IRCC_CRC
suffix:semicolon
id|fast
op_assign
l_int|0
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), handling baud of 576000&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
id|ir_mode
op_assign
id|IRCC_CFGA_IRDA_HDLC
suffix:semicolon
id|ctrl
op_assign
id|IRCC_1152
op_or
id|IRCC_CRC
suffix:semicolon
id|fast
op_assign
id|IRCC_LCR_A_FAST
op_or
id|IRCC_LCR_A_GP_DATA
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), handling baud of 1152000&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4000000
suffix:colon
id|ir_mode
op_assign
id|IRCC_CFGA_IRDA_4PPM
suffix:semicolon
id|ctrl
op_assign
id|IRCC_CRC
suffix:semicolon
id|fast
op_assign
id|IRCC_LCR_A_FAST
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), handling baud of 4000000&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if 0
id|Now
id|in
id|tranceiver
op_logical_neg
multiline_comment|/* This causes an interrupt */
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_LCR_A
)paren
op_amp
l_int|0xbf
)paren
op_or
id|fast
comma
id|fir_base
op_plus
id|IRCC_LCR_A
)paren
suffix:semicolon
macro_line|#endif
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_SCE_CFGA
)paren
op_amp
id|IRCC_SCE_CFGA_BLOCK_CTRL_BITS_MASK
)paren
op_or
id|ir_mode
)paren
comma
id|fir_base
op_plus
id|IRCC_SCE_CFGA
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_CONTROL
)paren
op_amp
l_int|0x30
)paren
op_or
id|ctrl
comma
id|fir_base
op_plus
id|IRCC_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_fir_start(self)&n; *&n; *    Change the speed of the device&n; *&n; */
DECL|function|smsc_ircc_fir_start
r_static
r_void
id|smsc_ircc_fir_start
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|fir_base
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Reset everything */
multiline_comment|/* Install FIR transmit handler */
id|dev-&gt;hard_start_xmit
op_assign
id|smsc_ircc_hard_xmit_fir
suffix:semicolon
multiline_comment|/* Clear FIFO */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_LCR_A
)paren
op_or
id|IRCC_LCR_A_FIFO_RESET
comma
id|fir_base
op_plus
id|IRCC_LCR_A
)paren
suffix:semicolon
multiline_comment|/* Enable interrupt */
multiline_comment|/*outb(IRCC_IER_ACTIVE_FRAME|IRCC_IER_EOM, fir_base+IRCC_IER);*/
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Select the TX/RX interface */
macro_line|#ifdef SMSC_669 /* Uses pin 88/89 for Rx/Tx */
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
l_int|0x3f
)paren
op_or
id|IRCC_CFGB_MUX_COM
)paren
comma
id|fir_base
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
macro_line|#else&t;
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
l_int|0x3f
)paren
op_or
id|IRCC_CFGB_MUX_IR
)paren
comma
id|fir_base
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
macro_line|#endif&t;
(paren
r_void
)paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_FIFO_THRESHOLD
)paren
suffix:semicolon
multiline_comment|/* Enable SCE interrupts */
id|outb
c_func
(paren
l_int|0
comma
id|fir_base
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_IER_ACTIVE_FRAME
op_or
id|IRCC_IER_EOM
comma
id|fir_base
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_INT_EN
comma
id|fir_base
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_fir_stop(self, baud)&n; *&n; *    Change the speed of the device&n; *&n; */
DECL|function|smsc_ircc_fir_stop
r_static
r_void
id|smsc_ircc_fir_stop
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|fir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|fir_base
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*outb(IRCC_MASTER_RESET, fir_base+IRCC_MASTER);*/
id|outb
c_func
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_LCR_B
)paren
op_amp
id|IRCC_LCR_B_SIP_ENABLE
comma
id|fir_base
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_change_speed(self, baud)&n; *&n; *    Change the speed of the device&n; *&n; * This function *must* be called with spinlock held, because it may&n; * be called from the irq handler. - Jean II&n; */
DECL|function|smsc_ircc_change_speed
r_static
r_void
id|smsc_ircc_change_speed
c_func
(paren
r_void
op_star
id|priv
comma
id|u32
id|speed
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|last_speed_was_sir
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s() changing speed to: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|speed
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|last_speed_was_sir
op_assign
id|self-&gt;io.speed
op_le
id|SMSC_IRCC2_MAX_SIR_SPEED
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Temp Hack */
id|speed
op_assign
l_int|1152000
suffix:semicolon
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
id|last_speed_was_sir
op_assign
l_int|0
suffix:semicolon
id|smsc_ircc_fir_start
c_func
(paren
id|self
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|self-&gt;io.speed
op_eq
l_int|0
)paren
(brace
id|smsc_ircc_sir_start
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|last_speed_was_sir
)paren
(brace
id|speed
op_assign
id|self-&gt;io.speed
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|self-&gt;io.speed
op_ne
id|speed
)paren
(brace
id|smsc_ircc_set_transceiver_for_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
)brace
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_le
id|SMSC_IRCC2_MAX_SIR_SPEED
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|last_speed_was_sir
)paren
(brace
id|smsc_ircc_fir_stop
c_func
(paren
id|self
)paren
suffix:semicolon
id|smsc_ircc_sir_start
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
id|smsc_ircc_set_sir_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|last_speed_was_sir
)paren
(brace
macro_line|#if SMSC_IRCC2_C_SIR_STOP&t;&t;
id|smsc_ircc_sir_stop
c_func
(paren
id|self
)paren
suffix:semicolon
macro_line|#endif
id|smsc_ircc_fir_start
c_func
(paren
id|self
)paren
suffix:semicolon
)brace
id|smsc_ircc_set_fir_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
macro_line|#if 0
id|self-&gt;tx_buff.len
op_assign
l_int|10
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|smsc_ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
comma
l_int|4000
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Be ready for incoming frames */
id|smsc_ircc_dma_receive
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_set_sir_speed (self, speed)&n; *&n; *    Set speed of IrDA port to specified baudrate&n; *&n; */
DECL|function|smsc_ircc_set_sir_speed
r_void
id|smsc_ircc_set_sir_speed
c_func
(paren
r_void
op_star
id|priv
comma
id|__u32
id|speed
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|priv
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|fcr
suffix:semicolon
multiline_comment|/* FIFO control reg */
r_int
id|lcr
suffix:semicolon
multiline_comment|/* Line control reg */
r_int
id|divisor
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), Setting speed to: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|speed
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/* Update accounting for new speed */
id|self-&gt;io.speed
op_assign
id|speed
suffix:semicolon
multiline_comment|/* Turn off interrupts */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
id|divisor
op_assign
id|SMSC_IRCC2_MAX_SIR_SPEED
op_div
id|speed
suffix:semicolon
id|fcr
op_assign
id|UART_FCR_ENABLE_FIFO
suffix:semicolon
multiline_comment|/* &n;&t; * Use trigger level 1 to avoid 3 ms. timeout delay at 9600 bps, and&n;&t; * almost 1,7 ms at 19200 bps. At speeds above that we can just forget&n;&t; * about this timeout since it will always be fast enough. &n;&t; */
r_if
c_cond
(paren
id|self-&gt;io.speed
OL
l_int|38400
)paren
id|fcr
op_or_assign
id|UART_FCR_TRIGGER_1
suffix:semicolon
r_else
id|fcr
op_or_assign
id|UART_FCR_TRIGGER_14
suffix:semicolon
multiline_comment|/* IrDA ports use 8N1 */
id|lcr
op_assign
id|UART_LCR_WLEN8
suffix:semicolon
id|outb
c_func
(paren
id|UART_LCR_DLAB
op_or
id|lcr
comma
id|iobase
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Set DLAB */
id|outb
c_func
(paren
id|divisor
op_amp
l_int|0xff
comma
id|iobase
op_plus
id|UART_DLL
)paren
suffix:semicolon
multiline_comment|/* Set speed */
id|outb
c_func
(paren
id|divisor
op_rshift
l_int|8
comma
id|iobase
op_plus
id|UART_DLM
)paren
suffix:semicolon
id|outb
c_func
(paren
id|lcr
comma
id|iobase
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Set 8N1&t;*/
id|outb
c_func
(paren
id|fcr
comma
id|iobase
op_plus
id|UART_FCR
)paren
suffix:semicolon
multiline_comment|/* Enable FIFO&squot;s */
multiline_comment|/* Turn on interrups */
id|outb
c_func
(paren
id|UART_IER_RLSI
op_or
id|UART_IER_RDI
op_or
id|UART_IER_THRI
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s() speed changed to: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|speed
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_hard_xmit_fir (skb, dev)&n; *&n; *    Transmit the frame!&n; *&n; */
DECL|function|smsc_ircc_hard_xmit_fir
r_static
r_int
id|smsc_ircc_hard_xmit_fir
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|s32
id|speed
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|mtt
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Make sure test of self-&gt;io.speed &amp; speed change are atomic */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Check if we need to change the speed after this frame */
id|speed
op_assign
id|irda_get_next_speed
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|speed
op_ne
id|self-&gt;io.speed
)paren
op_logical_and
(paren
id|speed
op_ne
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Check for empty frame */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
multiline_comment|/* Note : you should make sure that speed changes&n;&t;&t;&t; * are not going to corrupt any outgoing frame.&n;&t;&t;&t; * Look at nsc-ircc for the gory details - Jean II */
id|smsc_ircc_change_speed
c_func
(paren
id|self
comma
id|speed
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|self-&gt;new_speed
op_assign
id|speed
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|self-&gt;tx_buff.head
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|self-&gt;tx_buff.len
op_assign
id|skb-&gt;len
suffix:semicolon
id|self-&gt;tx_buff.data
op_assign
id|self-&gt;tx_buff.head
suffix:semicolon
id|mtt
op_assign
id|irda_get_mtt
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtt
)paren
(brace
r_int
id|bofs
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Compute how many BOFs (STA or PA&squot;s) we need to waste the&n;&t;&t; * min turn time given the speed of the link.&n;&t;&t; */
id|bofs
op_assign
id|mtt
op_star
(paren
id|self-&gt;io.speed
op_div
l_int|1000
)paren
op_div
l_int|8000
suffix:semicolon
r_if
c_cond
(paren
id|bofs
OG
l_int|4095
)paren
id|bofs
op_assign
l_int|4095
suffix:semicolon
id|smsc_ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
comma
id|bofs
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Transmit frame */
id|smsc_ircc_dma_xmit
c_func
(paren
id|self
comma
id|iobase
comma
l_int|0
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_dma_xmit (self, iobase)&n; *&n; *    Transmit data using DMA&n; *&n; */
DECL|function|smsc_ircc_dma_xmit
r_static
r_void
id|smsc_ircc_dma_xmit
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
comma
r_int
id|bofs
)paren
(brace
id|u8
id|ctrl
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#if 1
multiline_comment|/* Disable Rx */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
macro_line|#endif
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
op_complement
id|IRCC_CFGB_DMA_ENABLE
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_XMIT
suffix:semicolon
multiline_comment|/* Set BOF additional count for generating the min turn time */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bofs
op_amp
l_int|0xff
comma
id|iobase
op_plus
id|IRCC_BOF_COUNT_LO
)paren
suffix:semicolon
id|ctrl
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_CONTROL
)paren
op_amp
l_int|0xf0
suffix:semicolon
id|outb
c_func
(paren
id|ctrl
op_or
(paren
(paren
id|bofs
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
)paren
comma
id|iobase
op_plus
id|IRCC_BOF_COUNT_HI
)paren
suffix:semicolon
multiline_comment|/* Set max Tx frame size */
id|outb
c_func
(paren
id|self-&gt;tx_buff.len
op_rshift
l_int|8
comma
id|iobase
op_plus
id|IRCC_TX_SIZE_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
id|self-&gt;tx_buff.len
op_amp
l_int|0xff
comma
id|iobase
op_plus
id|IRCC_TX_SIZE_LO
)paren
suffix:semicolon
multiline_comment|/*outb(UART_MCR_OUT2, self-&gt;io.sir_base + UART_MCR);*/
multiline_comment|/* Enable burst mode chip Tx DMA */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_or
id|IRCC_CFGB_DMA_ENABLE
op_or
id|IRCC_CFGB_DMA_BURST
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
multiline_comment|/* Setup DMA controller (must be done after enabling chip DMA) */
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.len
comma
id|DMA_TX_MODE
)paren
suffix:semicolon
multiline_comment|/* Enable interrupt */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_IER_ACTIVE_FRAME
op_or
id|IRCC_IER_EOM
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_INT_EN
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
multiline_comment|/* Enable transmit */
id|outb
c_func
(paren
id|IRCC_LCR_B_SCE_TRANSMIT
op_or
id|IRCC_LCR_B_SIP_ENABLE
comma
id|iobase
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_dma_xmit_complete (self)&n; *&n; *    The transfer of a frame in finished. This function will only be called &n; *    by the interrupt handler&n; *&n; */
DECL|function|smsc_ircc_dma_xmit_complete
r_static
r_void
id|smsc_ircc_dma_xmit_complete
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Disable Tx */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
macro_line|#endif
id|register_bank
c_func
(paren
id|self-&gt;io.fir_base
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|self-&gt;io.fir_base
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
op_complement
id|IRCC_CFGB_DMA_ENABLE
comma
id|self-&gt;io.fir_base
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
multiline_comment|/* Check for underrun! */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_LSR
)paren
op_amp
id|IRCC_LSR_UNDERRUN
)paren
(brace
id|self-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|self-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
multiline_comment|/* Reset error condition */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_ERROR_RESET
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
)brace
r_else
(brace
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|self-&gt;stats.tx_bytes
op_add_assign
id|self-&gt;tx_buff.len
suffix:semicolon
)brace
multiline_comment|/* Check if it&squot;s time to change the speed */
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|smsc_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_dma_receive(self)&n; *&n; *    Get ready for receiving a frame. The device will initiate a DMA&n; *    if it starts to receive a frame.&n; *&n; */
DECL|function|smsc_ircc_dma_receive
r_static
r_int
id|smsc_ircc_dma_receive
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
macro_line|#if 0
multiline_comment|/* Turn off chip DMA */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
op_complement
id|IRCC_CFGB_DMA_ENABLE
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Disable Tx */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
multiline_comment|/* Turn off chip DMA */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_amp
op_complement
id|IRCC_CFGB_DMA_ENABLE
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
id|self-&gt;io.direction
op_assign
id|IO_RECV
suffix:semicolon
id|self-&gt;rx_buff.data
op_assign
id|self-&gt;rx_buff.head
suffix:semicolon
multiline_comment|/* Set max Rx frame size */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|2050
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
comma
id|iobase
op_plus
id|IRCC_RX_SIZE_HI
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|2050
op_amp
l_int|0xff
comma
id|iobase
op_plus
id|IRCC_RX_SIZE_LO
)paren
suffix:semicolon
multiline_comment|/* Setup DMA controller */
id|setup_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|self-&gt;rx_buff.data
comma
id|self-&gt;rx_buff.truesize
comma
id|DMA_RX_MODE
)paren
suffix:semicolon
multiline_comment|/* Enable burst mode chip Rx DMA */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
op_or
id|IRCC_CFGB_DMA_ENABLE
op_or
id|IRCC_CFGB_DMA_BURST
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
multiline_comment|/* Enable interrupt */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_IER_ACTIVE_FRAME
op_or
id|IRCC_IER_EOM
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_INT_EN
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
multiline_comment|/* Enable receiver */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_LCR_B_SCE_RECEIVE
op_or
id|IRCC_LCR_B_SIP_ENABLE
comma
id|iobase
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_dma_receive_complete(self, iobase)&n; *&n; *    Finished with receiving frames&n; *&n; */
DECL|function|smsc_ircc_dma_receive_complete
r_static
r_void
id|smsc_ircc_dma_receive_complete
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
r_int
id|iobase
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
comma
id|msgcnt
comma
id|lsr
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Disable Rx */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|IRCC_LCR_B
)paren
suffix:semicolon
macro_line|#endif
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_LSAR
)paren
op_amp
op_complement
id|IRCC_LSAR_ADDRESS_MASK
comma
id|iobase
op_plus
id|IRCC_LSAR
)paren
suffix:semicolon
id|lsr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_LSR
)paren
suffix:semicolon
id|msgcnt
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_LCR_B
)paren
op_amp
l_int|0x08
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: dma count = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|get_dma_residue
c_func
(paren
id|self-&gt;io.dma
)paren
)paren
suffix:semicolon
id|len
op_assign
id|self-&gt;rx_buff.truesize
op_minus
id|get_dma_residue
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
multiline_comment|/* Look for errors &n;&t; */
r_if
c_cond
(paren
id|lsr
op_amp
(paren
id|IRCC_LSR_FRAME_ERROR
op_or
id|IRCC_LSR_CRC_ERROR
op_or
id|IRCC_LSR_SIZE_ERROR
)paren
)paren
(brace
id|self-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lsr
op_amp
id|IRCC_LSR_FRAME_ERROR
)paren
(brace
id|self-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lsr
op_amp
id|IRCC_LSR_CRC_ERROR
)paren
(brace
id|self-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lsr
op_amp
id|IRCC_LSR_SIZE_ERROR
)paren
(brace
id|self-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lsr
op_amp
(paren
id|IRCC_LSR_UNDERRUN
op_or
id|IRCC_LSR_OVERRUN
)paren
)paren
(brace
id|self-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Remove CRC */
r_if
c_cond
(paren
id|self-&gt;io.speed
OL
l_int|4000000
)paren
id|len
op_sub_assign
l_int|2
suffix:semicolon
r_else
id|len
op_sub_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
OL
l_int|2
)paren
op_logical_or
(paren
id|len
OG
l_int|2050
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(), bogus len=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s: msgcnt = %d, len=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|msgcnt
comma
id|len
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(), memory squeeze, dropping frame.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Make sure IP header gets aligned */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|self-&gt;rx_buff.data
comma
id|len
)paren
suffix:semicolon
id|self-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|self-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|skb-&gt;dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IRDA
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_sir_receive (self)&n; *&n; *    Receive one frame from the infrared port&n; *&n; */
DECL|function|smsc_ircc_sir_receive
r_static
r_void
id|smsc_ircc_sir_receive
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|boguscount
op_assign
l_int|0
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/*  &n;&t; * Receive all characters in Rx FIFO, unwrap and unstuff them. &n;         * async_unwrap_char will deliver all found frames  &n;&t; */
r_do
(brace
id|async_unwrap_char
c_func
(paren
id|self-&gt;netdev
comma
op_amp
id|self-&gt;stats
comma
op_amp
id|self-&gt;rx_buff
comma
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_RX
)paren
)paren
suffix:semicolon
multiline_comment|/* Make sure we don&squot;t stay here to long */
r_if
c_cond
(paren
id|boguscount
op_increment
OG
l_int|32
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(), breaking!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
op_amp
id|UART_LSR_DR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_interrupt (irq, dev_id, regs)&n; *&n; *    An interrupt from the chip has arrived. Time to do some work&n; *&n; */
DECL|function|smsc_ircc_interrupt
r_static
id|irqreturn_t
id|smsc_ircc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
comma
id|iir
comma
id|lcra
comma
id|lsr
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: irq %d for unknown device.&bslash;n&quot;
comma
id|driver_name
comma
id|irq
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
id|IRQ_NONE
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Serialise the interrupt handler in various CPUs, stop Tx path */
id|spin_lock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Check if we should use the SIR interrupt handler */
r_if
c_cond
(paren
id|self-&gt;io.speed
op_le
id|SMSC_IRCC2_MAX_SIR_SPEED
)paren
(brace
id|smsc_ircc_interrupt_sir
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|iir
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_IIR
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|lcra
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_LCR_A
)paren
suffix:semicolon
id|lsr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|IRCC_LSR
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(), iir = 0x%02x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|iir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iir
op_amp
id|IRCC_IIR_EOM
)paren
(brace
r_if
c_cond
(paren
id|self-&gt;io.direction
op_eq
id|IO_RECV
)paren
id|smsc_ircc_dma_receive_complete
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
r_else
id|smsc_ircc_dma_xmit_complete
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
id|smsc_ircc_dma_receive
c_func
(paren
id|self
comma
id|iobase
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iir
op_amp
id|IRCC_IIR_ACTIVE_FRAME
)paren
(brace
multiline_comment|/*printk(KERN_WARNING __FUNCTION__ &quot;(): Active Frame&bslash;n&quot;);*/
)brace
multiline_comment|/* Enable interrupts again */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_IER_ACTIVE_FRAME
op_or
id|IRCC_IER_EOM
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|self-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irport_interrupt_sir (irq, dev_id, regs)&n; *&n; *    Interrupt handler for SIR modes&n; */
DECL|function|smsc_ircc_interrupt_sir
r_void
id|smsc_ircc_interrupt_sir
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|boguscount
op_assign
l_int|0
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|iir
comma
id|lsr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s() irq %d for unknown device.&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Already locked comming here in smsc_ircc_interrupt() */
multiline_comment|/*spin_lock(&amp;self-&gt;lock);*/
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
id|iir
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_IIR
)paren
op_amp
id|UART_IIR_ID
suffix:semicolon
r_while
c_loop
(paren
id|iir
)paren
(brace
multiline_comment|/* Clear interrupt */
id|lsr
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s(), iir=%02x, lsr=%02x, iobase=%#x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|iir
comma
id|lsr
comma
id|iobase
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|iir
)paren
(brace
r_case
id|UART_IIR_RLSI
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;%s(), RLSI&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UART_IIR_RDI
suffix:colon
multiline_comment|/* Receive interrupt */
id|smsc_ircc_sir_receive
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UART_IIR_THRI
suffix:colon
r_if
c_cond
(paren
id|lsr
op_amp
id|UART_LSR_THRE
)paren
multiline_comment|/* Transmitter ready for data */
id|smsc_ircc_sir_write_wakeup
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), unhandled IIR=%#x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|iir
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Make sure we don&squot;t stay here to long */
r_if
c_cond
(paren
id|boguscount
op_increment
OG
l_int|100
)paren
r_break
suffix:semicolon
id|iir
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_IIR
)paren
op_amp
id|UART_IIR_ID
suffix:semicolon
)brace
multiline_comment|/*spin_unlock(&amp;self-&gt;lock);*/
)brace
macro_line|#if 0 /* unused */
multiline_comment|/*&n; * Function ircc_is_receiving (self)&n; *&n; *    Return TRUE is we are currently receiving a frame&n; *&n; */
r_static
r_int
id|ircc_is_receiving
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|status
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* int iobase; */
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
id|FALSE
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s: dma count = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|get_dma_residue
c_func
(paren
id|self-&gt;io.dma
)paren
)paren
suffix:semicolon
id|status
op_assign
(paren
id|self-&gt;rx_buff.state
op_ne
id|OUTSIDE_FRAME
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif /* unused */
DECL|function|smsc_ircc_net_init
r_static
r_int
id|smsc_ircc_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* Keep track of module usage */
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Set up to be a normal IrDA network device driver */
id|irda_device_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Insert overrides below this line! */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_net_open (dev)&n; *&n; *    Start the device&n; *&n; */
DECL|function|smsc_ircc_net_open
r_static
r_int
id|smsc_ircc_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_char
id|hwname
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|smsc_ircc_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), unable to allocate irq=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;io.irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*smsc_ircc_sir_start(self);*/
id|self-&gt;io.speed
op_assign
l_int|0
suffix:semicolon
id|smsc_ircc_change_speed
c_func
(paren
id|self
comma
id|SMSC_IRCC2_C_IRDA_FALLBACK_SPEED
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Give self a hardware name */
multiline_comment|/* It would be cool to offer the chip revision here - Jean II */
id|sprintf
c_func
(paren
id|hwname
comma
l_string|&quot;SMSC @ 0x%03x&quot;
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Open new IrLAP layer instance, now that everything should be&n;&t; * initialized properly &n;&t; */
id|self-&gt;irlap
op_assign
id|irlap_open
c_func
(paren
id|dev
comma
op_amp
id|self-&gt;qos
comma
id|hwname
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Always allocate the DMA channel after the IRQ,&n;&t; * and clean up on failure.&n;&t; */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|self-&gt;io.dma
comma
id|dev-&gt;name
)paren
)paren
(brace
id|smsc_ircc_net_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|WARNING
c_func
(paren
l_string|&quot;%s(), unable to allocate DMA=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;io.dma
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_net_close (dev)&n; *&n; *    Stop the device&n; *&n; */
DECL|function|smsc_ircc_net_close
r_static
r_int
id|smsc_ircc_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
suffix:semicolon
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
l_int|0
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
multiline_comment|/* Stop device */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Stop and remove instance of IrLAP */
r_if
c_cond
(paren
id|self-&gt;irlap
)paren
id|irlap_close
c_func
(paren
id|self-&gt;irlap
)paren
suffix:semicolon
id|self-&gt;irlap
op_assign
l_int|NULL
suffix:semicolon
id|free_irq
c_func
(paren
id|self-&gt;io.irq
comma
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|self-&gt;io.dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|smsc_ircc_suspend
r_static
r_void
id|smsc_ircc_suspend
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Suspending&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.suspended
)paren
r_return
suffix:semicolon
id|smsc_ircc_net_close
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|self-&gt;io.suspended
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|smsc_ircc_wakeup
r_static
r_void
id|smsc_ircc_wakeup
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|self-&gt;io.suspended
)paren
r_return
suffix:semicolon
multiline_comment|/* The code was doing a &quot;cli()&quot; here, but this can&squot;t be right.&n;&t; * If you need protection, do it in net_open with a spinlock&n;&t; * or give a good reason. - Jean II */
id|smsc_ircc_net_open
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;%s, Waking up&bslash;n&quot;
comma
id|driver_name
)paren
suffix:semicolon
)brace
DECL|function|smsc_ircc_pmproc
r_static
r_int
id|smsc_ircc_pmproc
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|smsc_ircc_cb
op_star
id|self
op_assign
(paren
r_struct
id|smsc_ircc_cb
op_star
)paren
id|dev-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|self
)paren
(brace
r_switch
c_cond
(paren
id|rqst
)paren
(brace
r_case
id|PM_SUSPEND
suffix:colon
id|smsc_ircc_suspend
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_RESUME
suffix:colon
id|smsc_ircc_wakeup
c_func
(paren
id|self
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_close (self)&n; *&n; *    Close driver instance&n; *&n; */
DECL|function|smsc_ircc_close
r_static
r_int
id|__exit
id|smsc_ircc_close
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
op_minus
l_int|1
suffix:semicolon
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;pmdev
)paren
id|pm_unregister
c_func
(paren
id|self-&gt;pmdev
)paren
suffix:semicolon
multiline_comment|/* Remove netdevice */
r_if
c_cond
(paren
id|self-&gt;netdev
)paren
id|unregister_netdev
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
multiline_comment|/* Make sure the irq handler is not exectuting */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Stop interrupts */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|IRCC_IER
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_MASTER_RESET
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|iobase
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Reset to SIR mode */
id|register_bank
c_func
(paren
id|iobase
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_CFGA_IRDA_SIR_A
op_or
id|IRCC_CFGA_TX_POLARITY
comma
id|iobase
op_plus
id|IRCC_SCE_CFGA
)paren
suffix:semicolon
id|outb
c_func
(paren
id|IRCC_CFGB_IR
comma
id|iobase
op_plus
id|IRCC_SCE_CFGB
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|self-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Release the PORTS that this driver is using */
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), releasing 0x%03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;io.fir_base
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|self-&gt;io.fir_base
comma
id|self-&gt;io.fir_ext
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(), releasing 0x%03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;io.sir_base
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|self-&gt;io.sir_base
comma
id|self-&gt;io.sir_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;tx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;tx_buff.head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;rx_buff.head
)paren
id|kfree
c_func
(paren
id|self-&gt;rx_buff.head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|self
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|smsc_ircc_cleanup
r_void
id|__exit
id|smsc_ircc_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_self
(braket
id|i
)braket
)paren
id|smsc_ircc_close
c_func
(paren
id|dev_self
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Start SIR operations&n; *&n; * This function *must* be called with spinlock held, because it may&n; * be called from the irq handler (via smsc_ircc_change_speed()). - Jean II&n; */
DECL|function|smsc_ircc_sir_start
r_void
id|smsc_ircc_sir_start
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|fir_base
comma
id|sir_base
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|dev
op_assign
id|self-&gt;netdev
suffix:semicolon
id|ASSERT
c_func
(paren
id|dev
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|smsc_ircc_hard_xmit_sir
suffix:semicolon
id|fir_base
op_assign
id|self-&gt;io.fir_base
suffix:semicolon
id|sir_base
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/* Reset everything */
id|outb
c_func
(paren
id|IRCC_MASTER_RESET
comma
id|fir_base
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
macro_line|#if SMSC_IRCC2_C_SIR_STOP
multiline_comment|/*smsc_ircc_sir_stop(self);*/
macro_line|#endif
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_SCE_CFGA
)paren
op_amp
id|IRCC_SCE_CFGA_BLOCK_CTRL_BITS_MASK
)paren
op_or
id|IRCC_CFGA_IRDA_SIR_A
)paren
comma
id|fir_base
op_plus
id|IRCC_SCE_CFGA
)paren
suffix:semicolon
multiline_comment|/* Initialize UART */
id|outb
c_func
(paren
id|UART_LCR_WLEN8
comma
id|sir_base
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Reset DLAB */
id|outb
c_func
(paren
(paren
id|UART_MCR_DTR
op_or
id|UART_MCR_RTS
op_or
id|UART_MCR_OUT2
)paren
comma
id|sir_base
op_plus
id|UART_MCR
)paren
suffix:semicolon
multiline_comment|/* Turn on interrups */
id|outb
c_func
(paren
id|UART_IER_RLSI
op_or
id|UART_IER_RDI
op_or
id|UART_IER_THRI
comma
id|sir_base
op_plus
id|UART_IER
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s() - exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|fir_base
op_plus
id|IRCC_MASTER
)paren
suffix:semicolon
)brace
macro_line|#if SMSC_IRCC2_C_SIR_STOP
DECL|function|smsc_ircc_sir_stop
r_void
id|smsc_ircc_sir_stop
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/* Reset UART */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|UART_MCR
)paren
suffix:semicolon
multiline_comment|/* Turn off interrupts */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Function smsc_sir_write_wakeup (self)&n; *&n; *    Called by the SIR interrupt handler when there&squot;s room for more data.&n; *    If we have more packets to send, we send them here.&n; *&n; */
DECL|function|smsc_ircc_sir_write_wakeup
r_static
r_void
id|smsc_ircc_sir_write_wakeup
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|actual
op_assign
l_int|0
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|fcr
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/* Finished with frame?  */
r_if
c_cond
(paren
id|self-&gt;tx_buff.len
OG
l_int|0
)paren
(brace
multiline_comment|/* Write data left in transmit buffer */
id|actual
op_assign
id|smsc_ircc_sir_write
c_func
(paren
id|iobase
comma
id|self-&gt;io.fifo_size
comma
id|self-&gt;tx_buff.data
comma
id|self-&gt;tx_buff.len
)paren
suffix:semicolon
id|self-&gt;tx_buff.data
op_add_assign
id|actual
suffix:semicolon
id|self-&gt;tx_buff.len
op_sub_assign
id|actual
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*if (self-&gt;tx_buff.len ==0)  {*/
multiline_comment|/* &n;&t;&t; *  Now serial buffer is almost free &amp; we can start &n;&t;&t; *  transmission of another packet. But first we must check&n;&t;&t; *  if we need to change the speed of the hardware&n;&t;&t; */
r_if
c_cond
(paren
id|self-&gt;new_speed
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;%s(), Changing speed to %d.&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|smsc_ircc_sir_wait_hw_transmitter_finish
c_func
(paren
id|self
)paren
suffix:semicolon
id|smsc_ircc_change_speed
c_func
(paren
id|self
comma
id|self-&gt;new_speed
)paren
suffix:semicolon
id|self-&gt;new_speed
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Tell network layer that we want more frames */
id|netif_wake_queue
c_func
(paren
id|self-&gt;netdev
)paren
suffix:semicolon
)brace
id|self-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.speed
op_le
l_int|115200
)paren
(brace
multiline_comment|/* &n;&t;&t; * Reset Rx FIFO to make sure that all reflected transmit data&n;&t;&t; * is discarded. This is needed for half duplex operation&n;&t;&t; */
id|fcr
op_assign
id|UART_FCR_ENABLE_FIFO
op_or
id|UART_FCR_CLEAR_RCVR
suffix:semicolon
r_if
c_cond
(paren
id|self-&gt;io.speed
OL
l_int|38400
)paren
id|fcr
op_or_assign
id|UART_FCR_TRIGGER_1
suffix:semicolon
r_else
id|fcr
op_or_assign
id|UART_FCR_TRIGGER_14
suffix:semicolon
id|outb
c_func
(paren
id|fcr
comma
id|iobase
op_plus
id|UART_FCR
)paren
suffix:semicolon
multiline_comment|/* Turn on receive interrupts */
id|outb
c_func
(paren
id|UART_IER_RDI
comma
id|iobase
op_plus
id|UART_IER
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Function smsc_ircc_sir_write (iobase, fifo_size, buf, len)&n; *&n; *    Fill Tx FIFO with transmit data&n; *&n; */
DECL|function|smsc_ircc_sir_write
r_static
r_int
id|smsc_ircc_sir_write
c_func
(paren
r_int
id|iobase
comma
r_int
id|fifo_size
comma
id|__u8
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|actual
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Tx FIFO should be empty! */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
op_amp
id|UART_LSR_THRE
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(), failed, fifo not empty!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fill FIFO with current frame */
r_while
c_loop
(paren
(paren
id|fifo_size
op_decrement
OG
l_int|0
)paren
op_logical_and
(paren
id|actual
OL
id|len
)paren
)paren
(brace
multiline_comment|/* Transmit next byte */
id|outb
c_func
(paren
id|buf
(braket
id|actual
)braket
comma
id|iobase
op_plus
id|UART_TX
)paren
suffix:semicolon
id|actual
op_increment
suffix:semicolon
)brace
r_return
id|actual
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_is_receiving (self)&n; *&n; *    Returns true is we are currently receiving data&n; *&n; */
DECL|function|smsc_ircc_is_receiving
r_static
r_int
id|smsc_ircc_is_receiving
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_return
(paren
id|self-&gt;rx_buff.state
op_ne
id|OUTSIDE_FRAME
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_probe_transceiver(self)&n; *&n; *    Tries to find the used Transceiver&n; *&n; */
DECL|function|smsc_ircc_probe_transceiver
r_static
r_void
id|smsc_ircc_probe_transceiver
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|smsc_transceivers
(braket
id|i
)braket
dot
id|name
op_ne
l_int|NULL
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|smsc_transceivers
(braket
id|i
)braket
dot
id|probe
)paren
(paren
id|self-&gt;io.fir_base
)paren
)paren
(brace
id|MESSAGE
c_func
(paren
l_string|&quot; %s transceiver found&bslash;n&quot;
comma
id|smsc_transceivers
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
id|self-&gt;transceiver
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
id|MESSAGE
c_func
(paren
l_string|&quot;No transceiver found. Defaulting to %s&bslash;n&quot;
comma
id|smsc_transceivers
(braket
id|SMSC_IRCC2_C_DEFAULT_TRANSCEIVER
)braket
dot
id|name
)paren
suffix:semicolon
id|self-&gt;transceiver
op_assign
id|SMSC_IRCC2_C_DEFAULT_TRANSCEIVER
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_set_transceiver_for_speed(self, speed)&n; *&n; *    Set the transceiver according to the speed&n; *&n; */
DECL|function|smsc_ircc_set_transceiver_for_speed
r_static
r_void
id|smsc_ircc_set_transceiver_for_speed
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
comma
id|u32
id|speed
)paren
(brace
r_int
r_int
id|trx
suffix:semicolon
id|trx
op_assign
id|self-&gt;transceiver
suffix:semicolon
r_if
c_cond
(paren
id|trx
OG
l_int|0
)paren
(brace
(paren
op_star
id|smsc_transceivers
(braket
id|trx
op_minus
l_int|1
)braket
dot
id|set_for_speed
)paren
(paren
id|self-&gt;io.fir_base
comma
id|speed
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function smsc_ircc_wait_hw_transmitter_finish ()&n; *&n; *    Wait for the real end of HW transmission&n; *&n; * The UART is a strict FIFO, and we get called only when we have finished&n; * pushing data to the FIFO, so the maximum amount of time we must wait&n; * is only for the FIFO to drain out.&n; *&n; * We use a simple calibrated loop. We may need to adjust the loop&n; * delay (udelay) to balance I/O traffic and latency. And we also need to&n; * adjust the maximum timeout.&n; * It would probably be better to wait for the proper interrupt,&n; * but it doesn&squot;t seem to be available.&n; *&n; * We can&squot;t use jiffies or kernel timers because :&n; * 1) We are called from the interrupt handler, which disable softirqs,&n; * so jiffies won&squot;t be increased&n; * 2) Jiffies granularity is usually very coarse (10ms), and we don&squot;t&n; * want to wait that long to detect stuck hardware.&n; * Jean II&n; */
DECL|function|smsc_ircc_sir_wait_hw_transmitter_finish
r_static
r_void
id|smsc_ircc_sir_wait_hw_transmitter_finish
c_func
(paren
r_struct
id|smsc_ircc_cb
op_star
id|self
)paren
(brace
r_int
id|iobase
suffix:semicolon
r_int
id|count
op_assign
id|SMSC_IRCC2_HW_TRANSMITTER_TIMEOUT_US
suffix:semicolon
id|iobase
op_assign
id|self-&gt;io.sir_base
suffix:semicolon
multiline_comment|/* Calibrated busy loop */
r_while
c_loop
(paren
(paren
id|count
op_decrement
OG
l_int|0
)paren
op_logical_and
op_logical_neg
(paren
id|inb
c_func
(paren
id|iobase
op_plus
id|UART_LSR
)paren
op_amp
id|UART_LSR_TEMT
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s(): stuck transmitter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* PROBING&n; *&n; *&n; */
DECL|function|smsc_ircc_look_for_chips
r_static
r_int
id|__init
id|smsc_ircc_look_for_chips
c_func
(paren
r_void
)paren
(brace
id|smsc_chip_address_t
op_star
id|address
suffix:semicolon
r_char
op_star
id|type
suffix:semicolon
r_int
r_int
id|cfg_base
comma
id|found
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
id|address
op_assign
id|possible_addresses
suffix:semicolon
r_while
c_loop
(paren
id|address-&gt;cfg_base
)paren
(brace
id|cfg_base
op_assign
id|address-&gt;cfg_base
suffix:semicolon
multiline_comment|/*printk(KERN_WARNING __FUNCTION__ &quot;(): probing: 0x%02x for: 0x%02x&bslash;n&quot;, cfg_base, address-&gt;type);*/
r_if
c_cond
(paren
id|address-&gt;type
op_amp
id|SMSCSIO_TYPE_FDC
)paren
(brace
id|type
op_assign
l_string|&quot;FDC&quot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|address-&gt;type
)paren
op_amp
id|SMSCSIO_TYPE_FLAT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|smsc_superio_flat
c_func
(paren
id|fdc_chips_flat
comma
id|cfg_base
comma
id|type
)paren
)paren
(brace
id|found
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|address-&gt;type
)paren
op_amp
id|SMSCSIO_TYPE_PAGED
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|smsc_superio_paged
c_func
(paren
id|fdc_chips_paged
comma
id|cfg_base
comma
id|type
)paren
)paren
(brace
id|found
op_increment
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|address-&gt;type
op_amp
id|SMSCSIO_TYPE_LPC
)paren
(brace
id|type
op_assign
l_string|&quot;LPC&quot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|address-&gt;type
)paren
op_amp
id|SMSCSIO_TYPE_FLAT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|smsc_superio_flat
c_func
(paren
id|lpc_chips_flat
comma
id|cfg_base
comma
id|type
)paren
)paren
(brace
id|found
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|address-&gt;type
)paren
op_amp
id|SMSCSIO_TYPE_PAGED
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|smsc_superio_paged
c_func
(paren
id|lpc_chips_paged
comma
id|cfg_base
comma
l_string|&quot;LPC&quot;
)paren
)paren
(brace
id|found
op_increment
suffix:semicolon
)brace
)brace
)brace
id|address
op_increment
suffix:semicolon
)brace
r_return
id|found
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_superio_flat (chip, base, type)&n; *&n; *    Try to get configuration of a smc SuperIO chip with flat register model&n; *&n; */
DECL|function|smsc_superio_flat
r_static
r_int
id|__init
id|smsc_superio_flat
c_func
(paren
r_const
id|smsc_chip_t
op_star
id|chips
comma
r_int
r_int
id|cfgbase
comma
r_char
op_star
id|type
)paren
(brace
r_int
r_int
id|firbase
comma
id|sirbase
suffix:semicolon
id|u8
id|mode
comma
id|dma
comma
id|irq
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smsc_ircc_probe
c_func
(paren
id|cfgbase
comma
id|SMSCSIOFLAT_DEVICEID_REG
comma
id|chips
comma
id|type
)paren
op_eq
l_int|NULL
)paren
r_return
id|ret
suffix:semicolon
id|outb
c_func
(paren
id|SMSCSIOFLAT_UARTMODE0C_REG
comma
id|cfgbase
)paren
suffix:semicolon
id|mode
op_assign
id|inb
c_func
(paren
id|cfgbase
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*printk(KERN_WARNING __FUNCTION__ &quot;(): mode: 0x%02x&bslash;n&quot;, mode);*/
r_if
c_cond
(paren
op_logical_neg
(paren
id|mode
op_amp
id|SMSCSIOFLAT_UART2MODE_VAL_IRDA
)paren
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(): IrDA not enabled&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|SMSCSIOFLAT_UART2BASEADDR_REG
comma
id|cfgbase
)paren
suffix:semicolon
id|sirbase
op_assign
id|inb
c_func
(paren
id|cfgbase
op_plus
l_int|1
)paren
op_lshift
l_int|2
suffix:semicolon
multiline_comment|/* FIR iobase */
id|outb
c_func
(paren
id|SMSCSIOFLAT_FIRBASEADDR_REG
comma
id|cfgbase
)paren
suffix:semicolon
id|firbase
op_assign
id|inb
c_func
(paren
id|cfgbase
op_plus
l_int|1
)paren
op_lshift
l_int|3
suffix:semicolon
multiline_comment|/* DMA */
id|outb
c_func
(paren
id|SMSCSIOFLAT_FIRDMASELECT_REG
comma
id|cfgbase
)paren
suffix:semicolon
id|dma
op_assign
id|inb
c_func
(paren
id|cfgbase
op_plus
l_int|1
)paren
op_amp
id|SMSCSIOFLAT_FIRDMASELECT_MASK
suffix:semicolon
multiline_comment|/* IRQ */
id|outb
c_func
(paren
id|SMSCSIOFLAT_UARTIRQSELECT_REG
comma
id|cfgbase
)paren
suffix:semicolon
id|irq
op_assign
id|inb
c_func
(paren
id|cfgbase
op_plus
l_int|1
)paren
op_amp
id|SMSCSIOFLAT_UART2IRQSELECT_MASK
suffix:semicolon
id|MESSAGE
c_func
(paren
l_string|&quot;%s(): fir: 0x%02x, sir: 0x%02x, dma: %02d, irq: %d, mode: 0x%02x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|firbase
comma
id|sirbase
comma
id|dma
comma
id|irq
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|firbase
)paren
(brace
r_if
c_cond
(paren
id|smsc_ircc_open
c_func
(paren
id|firbase
comma
id|sirbase
comma
id|dma
comma
id|irq
)paren
op_eq
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Exit configuration */
id|outb
c_func
(paren
id|SMSCSIO_CFGEXITKEY
comma
id|cfgbase
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_superio_paged (chip, base, type)&n; *&n; *    Try  to get configuration of a smc SuperIO chip with paged register model&n; *&n; */
DECL|function|smsc_superio_paged
r_static
r_int
id|__init
id|smsc_superio_paged
c_func
(paren
r_const
id|smsc_chip_t
op_star
id|chips
comma
r_int
r_int
id|cfg_base
comma
r_char
op_star
id|type
)paren
(brace
r_int
r_int
id|fir_io
comma
id|sir_io
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smsc_ircc_probe
c_func
(paren
id|cfg_base
comma
l_int|0x20
comma
id|chips
comma
id|type
)paren
op_eq
l_int|NULL
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* Select logical device (UART2) */
id|outb
c_func
(paren
l_int|0x07
comma
id|cfg_base
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x05
comma
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* SIR iobase */
id|outb
c_func
(paren
l_int|0x60
comma
id|cfg_base
)paren
suffix:semicolon
id|sir_io
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|outb
c_func
(paren
l_int|0x61
comma
id|cfg_base
)paren
suffix:semicolon
id|sir_io
op_or_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Read FIR base */
id|outb
c_func
(paren
l_int|0x62
comma
id|cfg_base
)paren
suffix:semicolon
id|fir_io
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|outb
c_func
(paren
l_int|0x63
comma
id|cfg_base
)paren
suffix:semicolon
id|fir_io
op_or_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x2b
comma
id|cfg_base
)paren
suffix:semicolon
multiline_comment|/* ??? */
r_if
c_cond
(paren
id|fir_io
)paren
(brace
r_if
c_cond
(paren
id|smsc_ircc_open
c_func
(paren
id|fir_io
comma
id|sir_io
comma
id|ircc_dma
comma
id|ircc_irq
)paren
op_eq
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Exit configuration */
id|outb
c_func
(paren
id|SMSCSIO_CFGEXITKEY
comma
id|cfg_base
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|smsc_access
r_static
r_int
id|__init
id|smsc_access
c_func
(paren
r_int
r_int
id|cfg_base
comma
r_int
r_char
id|reg
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|cfg_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|cfg_base
)paren
op_ne
id|reg
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|smsc_ircc_probe
r_static
r_const
id|smsc_chip_t
op_star
id|__init
id|smsc_ircc_probe
c_func
(paren
r_int
r_int
id|cfg_base
comma
id|u8
id|reg
comma
r_const
id|smsc_chip_t
op_star
id|chip
comma
r_char
op_star
id|type
)paren
(brace
id|u8
id|devid
comma
id|xdevid
comma
id|rev
suffix:semicolon
id|IRDA_DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Leave configuration */
id|outb
c_func
(paren
id|SMSCSIO_CFGEXITKEY
comma
id|cfg_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|cfg_base
)paren
op_eq
id|SMSCSIO_CFGEXITKEY
)paren
multiline_comment|/* not a smc superio chip */
r_return
l_int|NULL
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|cfg_base
)paren
suffix:semicolon
id|xdevid
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Enter configuration */
id|outb
c_func
(paren
id|SMSCSIO_CFGACCESSKEY
comma
id|cfg_base
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|smsc_access
c_func
(paren
id|cfg_base
comma
l_int|0x55
)paren
)paren
multiline_comment|/* send second key and check */
r_return
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* probe device ID */
r_if
c_cond
(paren
id|smsc_access
c_func
(paren
id|cfg_base
comma
id|reg
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|devid
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devid
op_eq
l_int|0
)paren
multiline_comment|/* typical value for unused port */
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|devid
op_eq
l_int|0xff
)paren
multiline_comment|/* typical value for unused port */
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* probe revision ID */
r_if
c_cond
(paren
id|smsc_access
c_func
(paren
id|cfg_base
comma
id|reg
op_plus
l_int|1
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|rev
op_assign
id|inb
c_func
(paren
id|cfg_base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
op_ge
l_int|128
)paren
multiline_comment|/* i think this will make no sense */
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|devid
op_eq
id|xdevid
)paren
multiline_comment|/* protection against false positives */
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Check for expected device ID; are there others? */
r_while
c_loop
(paren
id|chip-&gt;devid
op_ne
id|devid
)paren
(brace
id|chip
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;name
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
id|MESSAGE
c_func
(paren
l_string|&quot;found SMC SuperIO Chip (devid=0x%02x rev=%02X base=0x%04x): %s%s&bslash;n&quot;
comma
id|devid
comma
id|rev
comma
id|cfg_base
comma
id|type
comma
id|chip-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;rev
OG
id|rev
)paren
(brace
id|MESSAGE
c_func
(paren
l_string|&quot;Revision higher than expected&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chip-&gt;flags
op_amp
id|NoIRDA
)paren
id|MESSAGE
c_func
(paren
l_string|&quot;chipset does not support IRDA&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|chip
suffix:semicolon
)brace
DECL|function|smsc_superio_fdc
r_static
r_int
id|__init
id|smsc_superio_fdc
c_func
(paren
r_int
r_int
id|cfg_base
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|cfg_base
comma
l_int|2
)paren
OL
l_int|0
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s: can&squot;t get cfg_base of 0x%03x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cfg_base
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|smsc_superio_flat
c_func
(paren
id|fdc_chips_flat
comma
id|cfg_base
comma
l_string|&quot;FDC&quot;
)paren
op_logical_or
op_logical_neg
id|smsc_superio_paged
c_func
(paren
id|fdc_chips_paged
comma
id|cfg_base
comma
l_string|&quot;FDC&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|smsc_superio_lpc
r_static
r_int
id|__init
id|smsc_superio_lpc
c_func
(paren
r_int
r_int
id|cfg_base
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|cfg_base
comma
l_int|2
)paren
OL
l_int|0
)paren
(brace
id|IRDA_DEBUG
c_func
(paren
l_int|0
comma
id|__FUNCTION__
l_string|&quot;: can&squot;t get cfg_base of 0x%03x&bslash;n&quot;
comma
id|cfg_base
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|smsc_superio_flat
c_func
(paren
id|lpc_chips_flat
comma
id|cfg_base
comma
l_string|&quot;LPC&quot;
)paren
op_logical_or
op_logical_neg
id|smsc_superio_paged
c_func
(paren
id|lpc_chips_paged
comma
id|cfg_base
comma
l_string|&quot;LPC&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/************************************************&n; *&n; * Transceivers specific functions&n; *&n; ************************************************/
multiline_comment|/*&n; * Function smsc_ircc_set_transceiver_smsc_ircc_atc(fir_base, speed)&n; *&n; *    Program transceiver through smsc-ircc ATC circuitry&n; *&n; */
DECL|function|smsc_ircc_set_transceiver_smsc_ircc_atc
r_static
r_void
id|smsc_ircc_set_transceiver_smsc_ircc_atc
c_func
(paren
r_int
id|fir_base
comma
id|u32
id|speed
)paren
(brace
r_int
r_int
id|jiffies_now
comma
id|jiffies_timeout
suffix:semicolon
id|u8
id|val
suffix:semicolon
id|jiffies_now
op_assign
id|jiffies
suffix:semicolon
id|jiffies_timeout
op_assign
id|jiffies
op_plus
id|SMSC_IRCC2_ATC_PROGRAMMING_TIMEOUT_JIFFIES
suffix:semicolon
multiline_comment|/* ATC */
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_ATC
)paren
op_amp
id|IRCC_ATC_MASK
)paren
op_or
id|IRCC_ATC_nPROGREADY
op_or
id|IRCC_ATC_ENABLE
comma
id|fir_base
op_plus
id|IRCC_ATC
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|val
op_assign
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_ATC
)paren
op_amp
id|IRCC_ATC_nPROGREADY
)paren
)paren
op_logical_and
op_logical_neg
id|time_after
c_func
(paren
id|jiffies
comma
id|jiffies_timeout
)paren
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
)paren
(brace
id|WARNING
c_func
(paren
l_string|&quot;%s(): ATC: 0x%02x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_ATC
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function smsc_ircc_probe_transceiver_smsc_ircc_atc(fir_base)&n; *&n; *    Probe transceiver smsc-ircc ATC circuitry&n; *&n; */
DECL|function|smsc_ircc_probe_transceiver_smsc_ircc_atc
r_static
r_int
id|smsc_ircc_probe_transceiver_smsc_ircc_atc
c_func
(paren
r_int
id|fir_base
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_set_transceiver_smsc_ircc_fast_pin_select(self, speed)&n; *&n; *    Set transceiver &n; *&n; */
DECL|function|smsc_ircc_set_transceiver_smsc_ircc_fast_pin_select
r_static
r_void
id|smsc_ircc_set_transceiver_smsc_ircc_fast_pin_select
c_func
(paren
r_int
id|fir_base
comma
id|u32
id|speed
)paren
(brace
id|u8
id|fast_mode
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_default
suffix:colon
r_case
l_int|576000
suffix:colon
id|fast_mode
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
r_case
l_int|4000000
suffix:colon
id|fast_mode
op_assign
id|IRCC_LCR_A_FAST
suffix:semicolon
r_break
suffix:semicolon
)brace
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_LCR_A
)paren
op_amp
l_int|0xbf
)paren
op_or
id|fast_mode
comma
id|fir_base
op_plus
id|IRCC_LCR_A
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_probe_transceiver_smsc_ircc_fast_pin_select(fir_base)&n; *&n; *    Probe transceiver &n; *&n; */
DECL|function|smsc_ircc_probe_transceiver_smsc_ircc_fast_pin_select
r_static
r_int
id|smsc_ircc_probe_transceiver_smsc_ircc_fast_pin_select
c_func
(paren
r_int
id|fir_base
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_set_transceiver_toshiba_sat1800(fir_base, speed)&n; *&n; *    Set transceiver &n; *&n; */
DECL|function|smsc_ircc_set_transceiver_toshiba_sat1800
r_static
r_void
id|smsc_ircc_set_transceiver_toshiba_sat1800
c_func
(paren
r_int
id|fir_base
comma
id|u32
id|speed
)paren
(brace
id|u8
id|fast_mode
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_default
suffix:colon
r_case
l_int|576000
suffix:colon
id|fast_mode
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1152000
suffix:colon
r_case
l_int|4000000
suffix:colon
id|fast_mode
op_assign
multiline_comment|/*IRCC_LCR_A_FAST |*/
id|IRCC_LCR_A_GP_DATA
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* This causes an interrupt */
id|register_bank
c_func
(paren
id|fir_base
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|fir_base
op_plus
id|IRCC_LCR_A
)paren
op_amp
l_int|0xbf
)paren
op_or
id|fast_mode
comma
id|fir_base
op_plus
id|IRCC_LCR_A
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function smsc_ircc_probe_transceiver_toshiba_sat1800(fir_base)&n; *&n; *    Probe transceiver &n; *&n; */
DECL|function|smsc_ircc_probe_transceiver_toshiba_sat1800
r_static
r_int
id|smsc_ircc_probe_transceiver_toshiba_sat1800
c_func
(paren
r_int
id|fir_base
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|smsc_ircc_init
id|module_init
c_func
(paren
id|smsc_ircc_init
)paren
suffix:semicolon
DECL|variable|smsc_ircc_cleanup
id|module_exit
c_func
(paren
id|smsc_ircc_cleanup
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Daniele Peri &lt;peri@csai.unipa.it&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SMC IrCC SIR/FIR controller driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ircc_dma
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ircc_dma
comma
l_string|&quot;DMA channel&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ircc_irq
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ircc_irq
comma
l_string|&quot;IRQ line&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ircc_fir
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ircc_fir
comma
l_string|&quot;FIR Base Address&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ircc_sir
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ircc_sir
comma
l_string|&quot;SIR Base Address&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ircc_cfg
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ircc_cfg
comma
l_string|&quot;Configuration register base address&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ircc_transceiver
comma
l_string|&quot;1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ircc_transceiver
comma
l_string|&quot;Transceiver type&quot;
)paren
suffix:semicolon
eof
