multiline_comment|/*&n; *&n; * Alchemy Semi Au1000 ethernet driver&n; *&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: MontaVista Software, Inc.&n; *         &t;ppopov@mvista.com or source@mvista.com&n; *&n; * ########################################################################&n; *&n; *  This program is free software; you can distribute it and/or modify it&n; *  under the terms of the GNU General Public License (Version 2) as&n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; *  for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * ########################################################################&n; *&n; * &n; */
macro_line|#ifndef __mips__
macro_line|#error This driver only works with MIPS architectures!
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/au1000.h&gt;
macro_line|#include &quot;au1000_eth.h&quot;
macro_line|#ifdef AU1000_ETH_DEBUG
DECL|variable|au1000_debug
r_static
r_int
id|au1000_debug
op_assign
l_int|10
suffix:semicolon
macro_line|#else
DECL|variable|au1000_debug
r_static
r_int
id|au1000_debug
op_assign
l_int|3
suffix:semicolon
macro_line|#endif
singleline_comment|// prototypes
r_static
r_void
op_star
id|dma_alloc
c_func
(paren
r_int
comma
id|dma_addr_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|dma_free
c_func
(paren
r_void
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|hard_stop
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|__init
id|au1000_probe1
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|au1000_init
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1000_open
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1000_close
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1000_tx
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1000_rx
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|au1000_interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|au1000_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1000_set_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|au1000_get_stats
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|update_tx_stats
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u32
comma
id|u32
)paren
suffix:semicolon
r_static
r_inline
r_void
id|update_rx_stats
c_func
(paren
r_struct
id|net_device
op_star
comma
id|u32
)paren
suffix:semicolon
r_static
r_void
id|au1000_timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|cleanup_buffers
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|au1000_ioctl
c_func
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|ifreq
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
comma
r_int
comma
id|u16
)paren
suffix:semicolon
r_static
r_inline
r_void
id|sync
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ack_rise_edge_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
DECL|variable|next_dev
r_static
r_int
id|next_dev
suffix:semicolon
multiline_comment|/*&n; * Theory of operation&n; *&n; * The Au1000 MACs use a simple rx and tx descriptor ring scheme. &n; * There are four receive and four transmit descriptors.  These &n; * descriptors are not in memory; rather, they are just a set of &n; * hardware registers.&n; *&n; * Since the Au1000 has a coherent data cache, the receive and&n; * transmit buffers are allocated from the KSEG0 segment. The &n; * hardware registers, however, are still mapped at KSEG1 to&n; * make sure there&squot;s no out-of-order writes, and that all writes&n; * complete immediately.&n; */
multiline_comment|/*&n; * Base address and interupt of the Au1000 ethernet macs&n; */
r_static
r_struct
(brace
DECL|member|port
r_int
r_int
id|port
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|variable|au1000_iflist
)brace
id|au1000_iflist
(braket
id|NUM_INTERFACES
)braket
op_assign
(brace
(brace
id|AU1000_ETH0_BASE
comma
id|AU1000_ETH0_IRQ
)brace
comma
(brace
id|AU1000_ETH1_BASE
comma
id|AU1000_ETH1_IRQ
)brace
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;au1000eth.c:0.1 ppopov@mvista.com&bslash;n&quot;
suffix:semicolon
singleline_comment|// FIX! Need real Ethernet addresses
DECL|variable|__devinitdata
r_static
r_int
r_char
id|au1000_mac_addr
(braket
l_int|2
)braket
(braket
l_int|6
)braket
id|__devinitdata
op_assign
(brace
(brace
l_int|0x00
comma
l_int|0x50
comma
l_int|0xc2
comma
l_int|0x0c
comma
l_int|0x30
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x50
comma
l_int|0xc2
comma
l_int|0x0c
comma
l_int|0x40
comma
l_int|0x00
)brace
)brace
suffix:semicolon
DECL|macro|nibswap
mdefine_line|#define nibswap(x) ((((x) &gt;&gt; 4) &amp; 0x0f) | (((x) &lt;&lt; 4) &amp; 0xf0))
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
singleline_comment|// For reading/writing 32-bit words from/to DMA memory
DECL|macro|cpu_to_dma32
mdefine_line|#define cpu_to_dma32 cpu_to_be32
DECL|macro|dma32_to_cpu
mdefine_line|#define dma32_to_cpu be32_to_cpu
multiline_comment|/* CPU pipeline flush */
DECL|function|sync
r_static
r_inline
r_void
id|sync
c_func
(paren
r_void
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;sync&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME &n; * All of the PHY code really should be detached from the MAC &n; * code.&n; */
DECL|variable|phy_link
r_static
r_char
op_star
id|phy_link
(braket
)braket
op_assign
(brace
l_string|&quot;unknown&quot;
comma
l_string|&quot;10Base2&quot;
comma
l_string|&quot;10BaseT&quot;
comma
l_string|&quot;AUI&quot;
comma
l_string|&quot;100BaseT&quot;
comma
l_string|&quot;100BaseTX&quot;
comma
l_string|&quot;100BaseFX&quot;
)brace
suffix:semicolon
DECL|function|bcm_5201_init
r_int
id|bcm_5201_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_addr
)paren
(brace
id|s16
id|data
suffix:semicolon
multiline_comment|/* Stop auto-negotiation */
singleline_comment|//printk(&quot;bcm_5201_init&bslash;n&quot;);
id|data
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_CONTROL
comma
id|data
op_amp
op_complement
id|MII_CNTL_AUTO
)paren
suffix:semicolon
multiline_comment|/* Set advertisement to 10/100 and Half/Full duplex&n;&t; * (full capabilities) */
id|data
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_ANADV
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_NWAY_TX
op_or
id|MII_NWAY_TX_FDX
op_or
id|MII_NWAY_T_FDX
op_or
id|MII_NWAY_T
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_ANADV
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Restart auto-negotiation */
id|data
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_CNTL_RST_AUTO
op_or
id|MII_CNTL_AUTO
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_CONTROL
comma
id|data
)paren
suffix:semicolon
singleline_comment|//dump_mii(dev, phy_addr);
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bcm_5201_reset
r_int
id|bcm_5201_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_addr
)paren
(brace
id|s16
id|mii_control
comma
id|timeout
suffix:semicolon
singleline_comment|//printk(&quot;bcm_5201_reset&bslash;n&quot;);
id|mii_control
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_CONTROL
comma
id|mii_control
op_or
id|MII_CNTL_RESET
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|100
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
id|mii_control
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mii_control
op_amp
id|MII_CNTL_RESET
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mii_control
op_amp
id|MII_CNTL_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s PHY reset timeout !&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|bcm_5201_status
id|bcm_5201_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_addr
comma
id|u16
op_star
id|link
comma
id|u16
op_star
id|speed
)paren
(brace
id|u16
id|mii_data
suffix:semicolon
r_struct
id|au1000_private
op_star
id|aup
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bcm_5201_status error: NULL dev&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|mii_data
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_data
op_amp
id|MII_STAT_LINK
)paren
(brace
op_star
id|link
op_assign
l_int|1
suffix:semicolon
id|mii_data
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_AUX_CNTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_data
op_amp
id|MII_AUX_100
)paren
(brace
r_if
c_cond
(paren
id|mii_data
op_amp
id|MII_AUX_FDX
)paren
(brace
op_star
id|speed
op_assign
id|IF_PORT_100BASEFX
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|IF_PORT_100BASEFX
suffix:semicolon
)brace
r_else
(brace
op_star
id|speed
op_assign
id|IF_PORT_100BASETX
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|IF_PORT_100BASETX
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|speed
op_assign
id|IF_PORT_10BASET
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|IF_PORT_10BASET
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|link
op_assign
l_int|0
suffix:semicolon
op_star
id|speed
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|am79c901_init
r_int
id|am79c901_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_addr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;am79c901_init&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|am79c901_reset
r_int
id|am79c901_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_addr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;am79c901_reset&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|am79c901_status
id|am79c901_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_addr
comma
id|u16
op_star
id|link
comma
id|u16
op_star
id|speed
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|bcm_5201_ops
r_struct
id|phy_ops
id|bcm_5201_ops
op_assign
(brace
id|bcm_5201_init
comma
id|bcm_5201_reset
comma
id|bcm_5201_status
comma
)brace
suffix:semicolon
DECL|variable|am79c901_ops
r_struct
id|phy_ops
id|am79c901_ops
op_assign
(brace
id|am79c901_init
comma
id|am79c901_reset
comma
id|am79c901_status
comma
)brace
suffix:semicolon
DECL|struct|mii_chip_info
r_static
r_struct
id|mii_chip_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|phy_id0
id|u16
id|phy_id0
suffix:semicolon
DECL|member|phy_id1
id|u16
id|phy_id1
suffix:semicolon
DECL|member|phy_ops
r_struct
id|phy_ops
op_star
id|phy_ops
suffix:semicolon
DECL|variable|mii_chip_table
)brace
id|mii_chip_table
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Broadcom BCM5201 10/100 BaseT PHY&quot;
comma
l_int|0x0040
comma
l_int|0x6212
comma
op_amp
id|bcm_5201_ops
)brace
comma
(brace
l_string|&quot;AMD 79C901 HomePNA PHY&quot;
comma
l_int|0x0000
comma
l_int|0x35c8
comma
op_amp
id|am79c901_ops
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|reg
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|timedout
op_assign
l_int|20
suffix:semicolon
id|u32
id|mii_control
suffix:semicolon
r_while
c_loop
(paren
id|aup-&gt;mac-&gt;mii_control
op_amp
id|MAC_MII_BUSY
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: read_MII busy timeout!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|mii_control
op_assign
id|MAC_SET_MII_SELECT_REG
c_func
(paren
id|reg
)paren
op_or
id|MAC_SET_MII_SELECT_PHY
c_func
(paren
id|phy_id
)paren
op_or
id|MAC_MII_READ
suffix:semicolon
id|aup-&gt;mac-&gt;mii_control
op_assign
id|mii_control
suffix:semicolon
id|timedout
op_assign
l_int|20
suffix:semicolon
r_while
c_loop
(paren
id|aup-&gt;mac-&gt;mii_control
op_amp
id|MAC_MII_BUSY
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: mdio_read busy timeout!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
(paren
r_int
)paren
id|aup-&gt;mac-&gt;mii_data
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|reg
comma
id|u16
id|value
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|timedout
op_assign
l_int|20
suffix:semicolon
id|u32
id|mii_control
suffix:semicolon
r_while
c_loop
(paren
id|aup-&gt;mac-&gt;mii_control
op_amp
id|MAC_MII_BUSY
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|timedout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: mdio_write busy timeout!!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|mii_control
op_assign
id|MAC_SET_MII_SELECT_REG
c_func
(paren
id|reg
)paren
op_or
id|MAC_SET_MII_SELECT_PHY
c_func
(paren
id|phy_id
)paren
op_or
id|MAC_MII_WRITE
suffix:semicolon
id|aup-&gt;mac-&gt;mii_data
op_assign
id|value
suffix:semicolon
id|aup-&gt;mac-&gt;mii_control
op_assign
id|mii_control
suffix:semicolon
)brace
DECL|function|dump_mii
r_static
r_void
id|dump_mii
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
)paren
(brace
r_int
id|i
comma
id|val
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_id
comma
id|i
)paren
)paren
op_ge
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: MII Reg %d=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|val
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|25
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_id
comma
id|i
)paren
)paren
op_ge
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%s: MII Reg %d=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|val
)paren
suffix:semicolon
)brace
)brace
DECL|function|mii_probe
r_static
r_int
id|__init
id|mii_probe
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|phy_addr
suffix:semicolon
id|aup-&gt;mii
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* search for total of 32 possible mii phy addresses */
r_for
c_loop
(paren
id|phy_addr
op_assign
l_int|0
suffix:semicolon
id|phy_addr
OL
l_int|32
suffix:semicolon
id|phy_addr
op_increment
)paren
(brace
id|u16
id|mii_status
suffix:semicolon
id|u16
id|phy_id0
comma
id|phy_id1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_eq
l_int|0xffff
op_logical_or
id|mii_status
op_eq
l_int|0x0000
)paren
multiline_comment|/* the mii is not accessable, try next one */
r_continue
suffix:semicolon
id|phy_id0
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_PHY_ID0
)paren
suffix:semicolon
id|phy_id1
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_addr
comma
id|MII_PHY_ID1
)paren
suffix:semicolon
multiline_comment|/* search our mii table for the current mii */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|mii_chip_table
(braket
id|i
)braket
dot
id|phy_id1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|phy_id0
op_eq
id|mii_chip_table
(braket
id|i
)braket
dot
id|phy_id0
op_logical_and
id|phy_id1
op_eq
id|mii_chip_table
(braket
id|i
)braket
dot
id|phy_id1
)paren
(brace
r_struct
id|mii_phy
op_star
id|mii_phy
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s found at phy address %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|mii_chip_table
(braket
id|i
)braket
dot
id|name
comma
id|phy_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mii_phy
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mii_phy
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|mii_phy-&gt;chip_info
op_assign
id|mii_chip_table
op_plus
id|i
suffix:semicolon
id|mii_phy-&gt;phy_addr
op_assign
id|phy_addr
suffix:semicolon
singleline_comment|//mii_phy-&gt;status = mdio_read(dev, phy_addr, MII_STATUS);
id|mii_phy-&gt;next
op_assign
id|aup-&gt;mii
suffix:semicolon
id|aup-&gt;phy_ops
op_assign
id|mii_chip_table
(braket
id|i
)braket
dot
id|phy_ops
suffix:semicolon
id|aup-&gt;mii
op_assign
id|mii_phy
suffix:semicolon
)brace
multiline_comment|/* the current mii is on our mii_info_table,&n;&t;&t;&t;&t;   try next address */
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|aup-&gt;mii
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: No MII transceivers found!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* use last PHY */
id|aup-&gt;phy_addr
op_assign
id|aup-&gt;mii-&gt;phy_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Using %s as default&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|aup-&gt;mii-&gt;chip_info-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Buffer allocation/deallocation routines. The buffer descriptor returned&n; * has the virtual and dma address of a buffer suitable for &n; * both, receive and transmit operations.&n; */
DECL|function|GetFreeDB
r_static
id|db_dest_t
op_star
id|GetFreeDB
c_func
(paren
r_struct
id|au1000_private
op_star
id|aup
)paren
(brace
id|db_dest_t
op_star
id|pDB
suffix:semicolon
id|pDB
op_assign
id|aup-&gt;pDBfree
suffix:semicolon
r_if
c_cond
(paren
id|pDB
)paren
(brace
id|aup-&gt;pDBfree
op_assign
id|pDB-&gt;pnext
suffix:semicolon
)brace
singleline_comment|//printk(&quot;GetFreeDB: %x&bslash;n&quot;, pDB);
r_return
id|pDB
suffix:semicolon
)brace
DECL|function|ReleaseDB
r_void
id|ReleaseDB
c_func
(paren
r_struct
id|au1000_private
op_star
id|aup
comma
id|db_dest_t
op_star
id|pDB
)paren
(brace
id|db_dest_t
op_star
id|pDBfree
op_assign
id|aup-&gt;pDBfree
suffix:semicolon
r_if
c_cond
(paren
id|pDBfree
)paren
id|pDBfree-&gt;pnext
op_assign
id|pDB
suffix:semicolon
id|aup-&gt;pDBfree
op_assign
id|pDB
suffix:semicolon
)brace
multiline_comment|/*&n;  DMA memory allocation, derived from pci_alloc_consistent.&n;  However, the Au1000 data cache is coherent (when programmed&n;  so), therefore we return KSEG0 address, not KSEG1.&n;*/
DECL|function|dma_alloc
r_static
r_void
op_star
id|dma_alloc
c_func
(paren
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
r_int
id|gfp
op_assign
id|GFP_ATOMIC
op_or
id|GFP_DMA
suffix:semicolon
id|ret
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|gfp
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|ret
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
op_star
id|dma_handle
op_assign
id|virt_to_bus
c_func
(paren
id|ret
)paren
suffix:semicolon
id|ret
op_assign
id|KSEG0ADDR
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dma_free
r_static
r_void
id|dma_free
c_func
(paren
r_void
op_star
id|vaddr
comma
r_int
id|size
)paren
(brace
id|vaddr
op_assign
id|KSEG0ADDR
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|vaddr
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
)brace
DECL|function|hard_stop
r_static
r_void
id|hard_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: hard stop&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|aup-&gt;mac-&gt;control
op_and_assign
op_complement
(paren
id|MAC_RX_ENABLE
op_or
id|MAC_TX_ENABLE
)paren
suffix:semicolon
id|sync
c_func
(paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
DECL|function|reset_mac
r_static
r_void
id|reset_mac
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|u32
id|flags
suffix:semicolon
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: reset mac, aup %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|aup
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|aup-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|aup-&gt;timer
)paren
suffix:semicolon
id|hard_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
op_star
id|aup-&gt;enable
op_or_assign
id|MAC_DMA_RESET
suffix:semicolon
id|sync
c_func
(paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|aup-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|aup-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|cleanup_buffers
r_static
r_void
id|cleanup_buffers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DMA
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|aup-&gt;rx_db_inuse
(braket
id|i
)braket
)paren
(brace
id|ReleaseDB
c_func
(paren
id|aup
comma
id|aup-&gt;rx_db_inuse
(braket
id|i
)braket
)paren
suffix:semicolon
id|aup-&gt;rx_db_inuse
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DMA
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|aup-&gt;tx_db_inuse
(braket
id|i
)braket
)paren
(brace
id|ReleaseDB
c_func
(paren
id|aup
comma
id|aup-&gt;tx_db_inuse
(braket
id|i
)braket
)paren
suffix:semicolon
id|aup-&gt;tx_db_inuse
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* &n; * Setup the receive and transmit &quot;rings&quot;.  These pointers are the addresses&n; * of the rx and tx MAC DMA registers so they are fixed by the hardware --&n; * these are not descriptors sitting in memory.&n; */
r_static
r_void
DECL|function|setup_hw_rings
id|setup_hw_rings
c_func
(paren
r_struct
id|au1000_private
op_star
id|aup
comma
id|u32
id|rx_base
comma
id|u32
id|tx_base
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DMA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|aup-&gt;rx_dma_ring
(braket
id|i
)braket
op_assign
(paren
r_volatile
id|rx_dma_t
op_star
)paren
id|ioremap_nocache
c_func
(paren
(paren
r_int
r_int
)paren
(paren
id|rx_base
op_plus
r_sizeof
(paren
id|rx_dma_t
)paren
op_star
id|i
)paren
comma
r_sizeof
(paren
id|rx_dma_t
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DMA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|aup-&gt;tx_dma_ring
(braket
id|i
)braket
op_assign
(paren
r_volatile
id|tx_dma_t
op_star
)paren
id|ioremap_nocache
c_func
(paren
(paren
r_int
r_int
)paren
(paren
id|tx_base
op_plus
r_sizeof
(paren
id|tx_dma_t
)paren
op_star
id|i
)paren
comma
r_sizeof
(paren
id|tx_dma_t
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Probe for a AU1000 ethernet controller.&n; */
DECL|function|au1000_probe
r_int
id|__init
id|au1000_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|base_addr
op_assign
id|au1000_iflist
(braket
id|next_dev
)braket
dot
id|port
suffix:semicolon
r_int
id|irq
op_assign
id|au1000_iflist
(braket
id|next_dev
)braket
dot
id|irq
suffix:semicolon
macro_line|#ifndef CONFIG_MIPS_AU1000_ENET
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: au1000_probe base_addr %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_dev
op_ge
id|NUM_INTERFACES
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|au1000_probe1
c_func
(paren
id|dev
comma
id|base_addr
comma
id|irq
comma
id|next_dev
)paren
op_eq
l_int|0
)paren
(brace
id|next_dev
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|next_dev
op_increment
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|au1000_probe1
id|au1000_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
comma
r_int
id|port_num
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|au1000_private
op_star
id|aup
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|retval
op_assign
l_int|0
suffix:semicolon
id|db_dest_t
op_star
id|pDB
comma
op_star
id|pDBfree
suffix:semicolon
id|u16
id|link
comma
id|speed
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioaddr
op_ne
id|AU1000_ETH0_BASE
)paren
op_logical_and
(paren
id|ioaddr
op_ne
id|AU1000_ETH1_BASE
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|ioaddr
comma
id|MAC_IOSIZE
comma
l_string|&quot;Au1000 ENET&quot;
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
r_sizeof
(paren
r_struct
id|au1000_private
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;au1000 eth: init_etherdev failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: Au1000 ethernet found at 0x%lx, irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ioaddr
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* Initialize our private structure */
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|aup
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aup
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
id|aup
suffix:semicolon
)brace
id|aup
op_assign
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|aup
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|aup
)paren
)paren
suffix:semicolon
multiline_comment|/* Allocate the data buffers */
id|aup-&gt;vaddr
op_assign
(paren
id|u32
)paren
id|dma_alloc
c_func
(paren
id|MAX_BUF_SIZE
op_star
(paren
id|NUM_TX_BUFFS
op_plus
id|NUM_RX_BUFFS
)paren
comma
op_amp
id|aup-&gt;dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aup-&gt;vaddr
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
multiline_comment|/* aup-&gt;mac is the base address of the MAC&squot;s registers */
id|aup-&gt;mac
op_assign
(paren
r_volatile
id|mac_reg_t
op_star
)paren
id|ioremap_nocache
c_func
(paren
(paren
r_int
r_int
)paren
id|ioaddr
comma
r_sizeof
(paren
op_star
id|aup-&gt;mac
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup some variables for quick register address access */
r_if
c_cond
(paren
id|ioaddr
op_eq
id|AU1000_ETH0_BASE
)paren
(brace
id|aup-&gt;enable
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ioremap_nocache
c_func
(paren
(paren
r_int
r_int
)paren
id|MAC0_ENABLE
comma
r_sizeof
(paren
op_star
id|aup-&gt;enable
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|au1000_mac_addr
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|dev-&gt;dev_addr
)paren
)paren
suffix:semicolon
id|setup_hw_rings
c_func
(paren
id|aup
comma
id|MAC0_RX_DMA_ADDR
comma
id|MAC0_TX_DMA_ADDR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioaddr
op_eq
id|AU1000_ETH1_BASE
)paren
(brace
id|aup-&gt;enable
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ioremap_nocache
c_func
(paren
(paren
r_int
r_int
)paren
id|MAC1_ENABLE
comma
r_sizeof
(paren
op_star
id|aup-&gt;enable
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|au1000_mac_addr
(braket
l_int|1
)braket
comma
r_sizeof
(paren
id|dev-&gt;dev_addr
)paren
)paren
suffix:semicolon
id|setup_hw_rings
c_func
(paren
id|aup
comma
id|MAC1_RX_DMA_ADDR
comma
id|MAC1_TX_DMA_ADDR
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* should never happen */
id|printk
(paren
id|KERN_ERR
l_string|&quot;au1000 eth: bad ioaddr %x&bslash;n&quot;
comma
(paren
r_int
)paren
id|ioaddr
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_region
suffix:semicolon
)brace
id|aup-&gt;phy_addr
op_assign
id|PHY_ADDRESS
suffix:semicolon
multiline_comment|/* bring the device out of reset, otherwise probing the mii&n;&t; * will hang */
op_star
id|aup-&gt;enable
op_assign
id|MAC_EN_RESET0
op_or
id|MAC_EN_RESET1
op_or
id|MAC_EN_RESET2
op_or
id|MAC_EN_CLOCK_ENABLE
op_or
id|MAC_EN_TOSS
suffix:semicolon
id|sync
c_func
(paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_probe
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
r_goto
id|free_region
suffix:semicolon
)brace
id|aup-&gt;phy_ops
op_member_access_from_pointer
id|phy_status
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
op_amp
id|link
comma
op_amp
id|speed
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link down resetting...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|aup-&gt;phy_ops
op_member_access_from_pointer
id|phy_reset
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
)paren
suffix:semicolon
id|aup-&gt;phy_ops
op_member_access_from_pointer
id|phy_init
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link up (%s)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy_link
(braket
id|speed
)braket
)paren
suffix:semicolon
)brace
id|pDBfree
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* setup the data buffer descriptors and attach a buffer to each one */
id|pDB
op_assign
id|aup-&gt;db
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|NUM_TX_BUFFS
op_plus
id|NUM_RX_BUFFS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pDB-&gt;pnext
op_assign
id|pDBfree
suffix:semicolon
id|pDBfree
op_assign
id|pDB
suffix:semicolon
id|pDB-&gt;vaddr
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
r_int
)paren
id|aup-&gt;vaddr
op_plus
id|MAX_BUF_SIZE
op_star
id|i
)paren
suffix:semicolon
id|pDB-&gt;dma_addr
op_assign
(paren
id|dma_addr_t
)paren
id|virt_to_bus
c_func
(paren
id|pDB-&gt;vaddr
)paren
suffix:semicolon
id|pDB
op_increment
suffix:semicolon
)brace
id|aup-&gt;pDBfree
op_assign
id|pDBfree
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DMA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pDB
op_assign
id|GetFreeDB
c_func
(paren
id|aup
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDB
)paren
r_goto
id|free_region
suffix:semicolon
id|aup-&gt;rx_dma_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|buff_stat
op_assign
(paren
r_int
)paren
id|pDB-&gt;dma_addr
suffix:semicolon
id|aup-&gt;rx_db_inuse
(braket
id|i
)braket
op_assign
id|pDB
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_DMA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pDB
op_assign
id|GetFreeDB
c_func
(paren
id|aup
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDB
)paren
r_goto
id|free_region
suffix:semicolon
id|aup-&gt;tx_dma_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|buff_stat
op_assign
(paren
r_int
)paren
id|pDB-&gt;dma_addr
suffix:semicolon
id|aup-&gt;tx_dma_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|len
op_assign
l_int|0
suffix:semicolon
id|aup-&gt;tx_db_inuse
(braket
id|i
)braket
op_assign
id|pDB
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|aup-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;open
op_assign
id|au1000_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|au1000_tx
suffix:semicolon
id|dev-&gt;stop
op_assign
id|au1000_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|au1000_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|au1000_ioctl
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|au1000_set_config
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|au1000_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|ETH_TX_TIMEOUT
suffix:semicolon
multiline_comment|/* Fill in the fields of the device structure with ethernet values. */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * The boot code uses the ethernet controller, so reset it to start fresh.&n;&t; * au1000_init() expects that the device is in reset state.&n;&t; */
id|reset_mac
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|free_region
suffix:colon
id|release_region
c_func
(paren
id|ioaddr
comma
id|MAC_IOSIZE
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aup-&gt;vaddr
)paren
id|dma_free
c_func
(paren
(paren
r_void
op_star
)paren
id|aup-&gt;vaddr
comma
id|MAX_BUF_SIZE
op_star
(paren
id|NUM_TX_BUFFS
op_plus
id|NUM_RX_BUFFS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: au1000_probe1 failed.  Returns %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* &n; * Initialize the interface.&n; *&n; * When the device powers up, the clocks are disabled and the&n; * mac is in reset state.  When the interface is closed, we&n; * do the same -- reset the device and disable the clocks to&n; * conserve power. Thus, whenever au1000_init() is called,&n; * the device should already be in reset state.&n; */
DECL|function|au1000_init
r_static
r_int
id|au1000_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|value
comma
id|control
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: au1000_init&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|aup-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* bring the device out of reset */
id|value
op_assign
id|MAC_EN_RESET0
op_or
id|MAC_EN_RESET1
op_or
id|MAC_EN_RESET2
op_or
id|MAC_EN_CLOCK_ENABLE
op_or
id|MAC_EN_TOSS
suffix:semicolon
op_star
id|aup-&gt;enable
op_assign
id|value
suffix:semicolon
id|sync
c_func
(paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|aup-&gt;mac-&gt;control
op_assign
l_int|0
suffix:semicolon
id|aup-&gt;tx_head
op_assign
(paren
id|aup-&gt;tx_dma_ring
(braket
l_int|0
)braket
op_member_access_from_pointer
id|buff_stat
op_amp
l_int|0xC
)paren
op_rshift
l_int|2
suffix:semicolon
id|aup-&gt;tx_tail
op_assign
id|aup-&gt;tx_head
suffix:semicolon
id|aup-&gt;rx_head
op_assign
(paren
id|aup-&gt;rx_dma_ring
(braket
l_int|0
)braket
op_member_access_from_pointer
id|buff_stat
op_amp
l_int|0xC
)paren
op_rshift
l_int|2
suffix:semicolon
id|aup-&gt;mac-&gt;mac_addr_high
op_assign
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|8
op_or
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
suffix:semicolon
id|aup-&gt;mac-&gt;mac_addr_low
op_assign
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_lshift
l_int|24
op_or
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|16
op_or
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_DMA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|aup-&gt;rx_dma_ring
(braket
id|i
)braket
op_member_access_from_pointer
id|buff_stat
op_or_assign
id|RX_DMA_ENABLE
suffix:semicolon
)brace
id|sync
c_func
(paren
)paren
suffix:semicolon
id|control
op_assign
id|MAC_DISABLE_RX_OWN
op_or
id|MAC_RX_ENABLE
op_or
id|MAC_TX_ENABLE
suffix:semicolon
macro_line|#ifndef CONFIG_CPU_LITTLE_ENDIAN
id|control
op_or_assign
id|MAC_BIG_ENDIAN
suffix:semicolon
macro_line|#endif
id|aup-&gt;mac-&gt;control
op_assign
id|control
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|aup-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1000_timer
r_static
r_void
id|au1000_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|mii_data
comma
id|link
comma
id|speed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
multiline_comment|/* fatal error, don&squot;t restart the timer */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;au1000_timer error: NULL dev&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
r_goto
id|set_timer
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aup-&gt;phy_ops
op_member_access_from_pointer
id|phy_status
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
op_amp
id|link
comma
op_amp
id|speed
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|link
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_RUNNING
)paren
)paren
(brace
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_RUNNING
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: link up&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_RUNNING
)paren
(brace
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: link down&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
id|set_timer
suffix:colon
id|aup-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
(paren
l_int|1
op_star
id|HZ
)paren
)paren
suffix:semicolon
id|aup-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|aup-&gt;timer.function
op_assign
op_amp
id|au1000_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|aup-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|au1000_open
r_static
r_int
id|au1000_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: open: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|au1000_init
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: error in au1000_init&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|au1000_interrupt
comma
l_int|0
comma
id|dev-&gt;name
comma
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|aup-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
(paren
l_int|3
op_star
id|HZ
)paren
)paren
suffix:semicolon
id|aup-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|aup-&gt;timer.function
op_assign
op_amp
id|au1000_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|aup-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: open: Initialization done.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1000_close
r_static
r_int
id|au1000_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|u32
id|flags
suffix:semicolon
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: close: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|aup-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* stop the device */
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* disable the interrupt */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|aup-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_mac
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|update_tx_stats
r_static
r_inline
r_void
id|update_tx_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
comma
id|u32
id|pkt_len
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|ps
op_assign
op_amp
id|aup-&gt;stats
suffix:semicolon
id|ps-&gt;tx_packets
op_increment
suffix:semicolon
id|ps-&gt;tx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TX_FRAME_ABORTED
)paren
(brace
id|ps-&gt;tx_errors
op_increment
suffix:semicolon
id|ps-&gt;tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|TX_NO_CARRIER
op_or
id|TX_LOSS_CARRIER
)paren
)paren
id|ps-&gt;tx_carrier_errors
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Called from the interrupt service routine to acknowledge&n; * the TX DONE bits.  This is a must if the irq is setup as&n; * edge triggered.&n; */
DECL|function|au1000_tx_ack
r_static
r_void
id|au1000_tx_ack
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|tx_dma_t
op_star
id|ptxd
suffix:semicolon
id|ptxd
op_assign
id|aup-&gt;tx_dma_ring
(braket
id|aup-&gt;tx_tail
)braket
suffix:semicolon
r_while
c_loop
(paren
id|ptxd-&gt;buff_stat
op_amp
id|TX_T_DONE
)paren
(brace
id|update_tx_stats
c_func
(paren
id|dev
comma
id|ptxd-&gt;status
comma
id|ptxd-&gt;len
op_amp
l_int|0x3ff
)paren
suffix:semicolon
id|ptxd-&gt;buff_stat
op_and_assign
op_complement
id|TX_T_DONE
suffix:semicolon
id|ptxd-&gt;len
op_assign
l_int|0
suffix:semicolon
id|sync
c_func
(paren
)paren
suffix:semicolon
id|aup-&gt;tx_tail
op_assign
(paren
id|aup-&gt;tx_tail
op_plus
l_int|1
)paren
op_amp
(paren
id|NUM_TX_DMA
op_minus
l_int|1
)paren
suffix:semicolon
id|ptxd
op_assign
id|aup-&gt;tx_dma_ring
(braket
id|aup-&gt;tx_tail
)braket
suffix:semicolon
r_if
c_cond
(paren
id|aup-&gt;tx_full
)paren
(brace
id|aup-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Au1000 transmit routine.&n; */
DECL|function|au1000_tx
r_static
r_int
id|au1000_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
singleline_comment|//unsigned long flags;
r_volatile
id|tx_dma_t
op_star
id|ptxd
suffix:semicolon
id|u32
id|buff_stat
suffix:semicolon
id|db_dest_t
op_star
id|pDB
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: tx: aup %x len=%d, data=%p, head %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|aup
comma
id|skb-&gt;len
comma
id|skb-&gt;data
comma
id|aup-&gt;tx_head
)paren
suffix:semicolon
multiline_comment|/* Prevent interrupts from changing the Tx ring */
singleline_comment|//spin_lock_irqsave(&amp;aup-&gt;lock, flags);
id|ptxd
op_assign
id|aup-&gt;tx_dma_ring
(braket
id|aup-&gt;tx_head
)braket
suffix:semicolon
id|buff_stat
op_assign
id|ptxd-&gt;buff_stat
suffix:semicolon
r_if
c_cond
(paren
id|buff_stat
op_amp
id|TX_DMA_ENABLE
)paren
(brace
multiline_comment|/* We&squot;ve wrapped around and the transmitter is still busy */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|aup-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
singleline_comment|//spin_unlock_irqrestore(&amp;aup-&gt;lock, flags);
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|buff_stat
op_amp
id|TX_T_DONE
)paren
(brace
id|update_tx_stats
c_func
(paren
id|dev
comma
id|ptxd-&gt;status
comma
id|ptxd-&gt;len
op_amp
l_int|0x3ff
)paren
suffix:semicolon
id|ptxd-&gt;len
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aup-&gt;tx_full
)paren
(brace
id|aup-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|pDB
op_assign
id|aup-&gt;tx_db_inuse
(braket
id|aup-&gt;tx_head
)braket
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|pDB-&gt;vaddr
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
id|MAC_MIN_PKT_SIZE
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|skb-&gt;len
suffix:semicolon
id|i
OL
id|MAC_MIN_PKT_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
(paren
(paren
r_char
op_star
)paren
id|pDB-&gt;vaddr
)paren
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|ptxd-&gt;len
op_assign
id|MAC_MIN_PKT_SIZE
suffix:semicolon
)brace
r_else
id|ptxd-&gt;len
op_assign
id|skb-&gt;len
suffix:semicolon
id|ptxd-&gt;buff_stat
op_assign
id|pDB-&gt;dma_addr
op_or
id|TX_DMA_ENABLE
suffix:semicolon
id|sync
c_func
(paren
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|aup-&gt;tx_head
op_assign
(paren
id|aup-&gt;tx_head
op_plus
l_int|1
)paren
op_amp
(paren
id|NUM_TX_DMA
op_minus
l_int|1
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
singleline_comment|//spin_unlock_irqrestore(&amp;aup-&gt;lock, flags);
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|update_rx_stats
r_static
r_inline
r_void
id|update_rx_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|status
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|ps
op_assign
op_amp
id|aup-&gt;stats
suffix:semicolon
id|ps-&gt;rx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_MCAST_FRAME
)paren
id|ps-&gt;multicast
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_ERROR
)paren
(brace
id|ps-&gt;rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_MISSED_FRAME
)paren
id|ps-&gt;rx_missed_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|RX_OVERLEN
op_or
id|RX_OVERLEN
op_or
id|RX_LEN_ERROR
)paren
)paren
id|ps-&gt;rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_CRC_ERROR
)paren
id|ps-&gt;rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_COLL
)paren
id|ps-&gt;collisions
op_increment
suffix:semicolon
)brace
r_else
id|ps-&gt;rx_bytes
op_add_assign
id|status
op_amp
id|RX_FRAME_LEN_MASK
suffix:semicolon
)brace
multiline_comment|/*&n; * Au1000 receive routine.&n; */
DECL|function|au1000_rx
r_static
r_int
id|au1000_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_volatile
id|rx_dma_t
op_star
id|prxd
suffix:semicolon
id|u32
id|buff_stat
comma
id|status
suffix:semicolon
id|db_dest_t
op_star
id|pDB
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: au1000_rx head %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|aup-&gt;rx_head
)paren
suffix:semicolon
id|prxd
op_assign
id|aup-&gt;rx_dma_ring
(braket
id|aup-&gt;rx_head
)braket
suffix:semicolon
id|buff_stat
op_assign
id|prxd-&gt;buff_stat
suffix:semicolon
r_while
c_loop
(paren
id|buff_stat
op_amp
id|RX_T_DONE
)paren
(brace
id|status
op_assign
id|prxd-&gt;status
suffix:semicolon
id|pDB
op_assign
id|aup-&gt;rx_db_inuse
(braket
id|aup-&gt;rx_head
)braket
suffix:semicolon
id|update_rx_stats
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|RX_ERROR
)paren
)paren
(brace
multiline_comment|/* good frame */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
(paren
id|status
op_amp
id|RX_FRAME_LEN_MASK
)paren
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|aup-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte IP header align */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
id|pDB-&gt;vaddr
comma
id|status
op_amp
id|RX_FRAME_LEN_MASK
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|status
op_amp
id|RX_FRAME_LEN_MASK
)paren
suffix:semicolon
multiline_comment|/* Make room */
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* pass the packet to upper layers */
)brace
r_else
(brace
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|RX_MISSED_FRAME
)paren
id|printk
c_func
(paren
l_string|&quot;rx miss&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_WDOG_TIMER
)paren
id|printk
c_func
(paren
l_string|&quot;rx wdog&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_RUNT
)paren
id|printk
c_func
(paren
l_string|&quot;rx runt&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_OVERLEN
)paren
id|printk
c_func
(paren
l_string|&quot;rx overlen&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_COLL
)paren
id|printk
c_func
(paren
l_string|&quot;rx coll&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_MII_ERROR
)paren
id|printk
c_func
(paren
l_string|&quot;rx mii error&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_CRC_ERROR
)paren
id|printk
c_func
(paren
l_string|&quot;rx crc error&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_LEN_ERROR
)paren
id|printk
c_func
(paren
l_string|&quot;rx len error&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_U_CNTRL_FRAME
)paren
id|printk
c_func
(paren
l_string|&quot;rx u control frame&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_MISSED_FRAME
)paren
id|printk
c_func
(paren
l_string|&quot;rx miss&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|prxd-&gt;buff_stat
op_assign
(paren
id|u32
)paren
(paren
id|pDB-&gt;dma_addr
op_or
id|RX_DMA_ENABLE
)paren
suffix:semicolon
id|aup-&gt;rx_head
op_assign
(paren
id|aup-&gt;rx_head
op_plus
l_int|1
)paren
op_amp
(paren
id|NUM_RX_DMA
op_minus
l_int|1
)paren
suffix:semicolon
id|sync
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* next descriptor */
id|prxd
op_assign
id|aup-&gt;rx_dma_ring
(braket
id|aup-&gt;rx_head
)braket
suffix:semicolon
id|buff_stat
op_assign
id|prxd-&gt;buff_stat
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Au1000 interrupt service routine.&n; */
DECL|function|au1000_interrupt
r_void
id|au1000_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: isr: null dev ptr&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|au1000_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|au1000_tx_ack
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The Tx ring has been full longer than the watchdog timeout&n; * value. The transmitter must be hung?&n; */
DECL|function|au1000_tx_timeout
r_static
r_void
id|au1000_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: au1000_tx_timeout: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
id|reset_mac
c_func
(paren
id|dev
)paren
suffix:semicolon
id|au1000_init
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* fixme */
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: set_multicast: flags=%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
id|aup-&gt;mac-&gt;control
op_or_assign
id|MAC_PROMISCUOUS
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
id|dev-&gt;mc_count
OG
id|MULTICAST_FILTER_LIMIT
)paren
(brace
id|aup-&gt;mac-&gt;control
op_or_assign
id|MAC_PASS_ALL_MULTI
suffix:semicolon
id|aup-&gt;mac-&gt;control
op_and_assign
op_complement
id|MAC_PROMISCUOUS
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Pass all multicast&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|u32
id|mc_filter
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Multicast hash filter */
id|mc_filter
(braket
l_int|1
)braket
op_assign
id|mc_filter
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
id|set_bit
c_func
(paren
id|ether_crc
c_func
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|26
comma
id|mc_filter
)paren
suffix:semicolon
)brace
id|aup-&gt;mac-&gt;multi_hash_high
op_assign
id|mc_filter
(braket
l_int|1
)braket
suffix:semicolon
id|aup-&gt;mac-&gt;multi_hash_low
op_assign
id|mc_filter
(braket
l_int|0
)braket
suffix:semicolon
id|aup-&gt;mac-&gt;control
op_or_assign
id|MAC_HASH_MODE
suffix:semicolon
)brace
)brace
DECL|function|au1000_ioctl
r_static
r_int
id|au1000_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
singleline_comment|//struct au1000_private *aup = (struct au1000_private *) dev-&gt;priv;
id|u16
op_star
id|data
op_assign
(paren
id|u16
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
multiline_comment|/* fixme */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* Get the address of the PHY in use. */
id|data
(braket
l_int|0
)braket
op_assign
id|PHY_ADDRESS
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* Read the specified MII register. */
singleline_comment|//data[3] = mdio_read(ioaddr, data[0], data[1]); 
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* Write the specified MII register */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
singleline_comment|//mdio_write(ioaddr, data[0], data[1], data[2]);
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|au1000_set_config
r_static
r_int
id|au1000_set_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|control
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: set_config called: dev-&gt;if_port %d map-&gt;port %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;if_port
comma
id|map-&gt;port
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|map-&gt;port
)paren
(brace
r_case
id|IF_PORT_UNKNOWN
suffix:colon
multiline_comment|/* use auto here */
id|printk
c_func
(paren
l_string|&quot;auto&bslash;&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|map-&gt;port
suffix:semicolon
multiline_comment|/* Link Down: the timer will bring it up */
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* read current control */
id|control
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|control
op_and_assign
op_complement
(paren
id|MII_CNTL_FDX
op_or
id|MII_CNTL_F100
)paren
suffix:semicolon
multiline_comment|/* enable auto negotiation and reset the negotiation */
id|mdio_write
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_CONTROL
comma
id|control
op_or
id|MII_CNTL_AUTO
op_or
id|MII_CNTL_RST_AUTO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_PORT_10BASET
suffix:colon
multiline_comment|/* 10BaseT */
id|printk
c_func
(paren
l_string|&quot;10baseT&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|map-&gt;port
suffix:semicolon
multiline_comment|/* Link Down: the timer will bring it up */
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* set Speed to 10Mbps, Half Duplex */
id|control
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;read control %x&bslash;n&quot;
comma
id|control
)paren
suffix:semicolon
id|control
op_and_assign
op_complement
(paren
id|MII_CNTL_F100
op_or
id|MII_CNTL_AUTO
op_or
id|MII_CNTL_FDX
)paren
suffix:semicolon
multiline_comment|/* disable auto negotiation and force 10M/HD mode*/
id|mdio_write
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_CONTROL
comma
id|control
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_PORT_100BASET
suffix:colon
multiline_comment|/* 100BaseT */
r_case
id|IF_PORT_100BASETX
suffix:colon
multiline_comment|/* 100BaseTx */
id|printk
c_func
(paren
l_string|&quot;100 base T/TX&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|map-&gt;port
suffix:semicolon
multiline_comment|/* Link Down: the timer will bring it up */
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* set Speed to 100Mbps, Half Duplex */
multiline_comment|/* disable auto negotiation and enable 100MBit Mode */
id|control
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;read control %x&bslash;n&quot;
comma
id|control
)paren
suffix:semicolon
id|control
op_and_assign
op_complement
(paren
id|MII_CNTL_AUTO
op_or
id|MII_CNTL_FDX
)paren
suffix:semicolon
id|control
op_or_assign
id|MII_CNTL_F100
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_CONTROL
comma
id|control
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_PORT_100BASEFX
suffix:colon
multiline_comment|/* 100BaseFx */
id|printk
c_func
(paren
l_string|&quot;100 Base FX&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;if_port
op_assign
id|map-&gt;port
suffix:semicolon
multiline_comment|/* Link Down: the timer will bring it up */
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* set Speed to 100Mbps, Full Duplex */
multiline_comment|/* disable auto negotiation and enable 100MBit Mode */
id|control
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_CONTROL
)paren
suffix:semicolon
id|control
op_and_assign
op_complement
id|MII_CNTL_AUTO
suffix:semicolon
id|control
op_or_assign
id|MII_CNTL_F100
op_or
id|MII_CNTL_FDX
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|aup-&gt;phy_addr
comma
id|MII_CONTROL
comma
id|control
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_PORT_10BASE2
suffix:colon
multiline_comment|/* 10Base2 */
r_case
id|IF_PORT_AUI
suffix:colon
multiline_comment|/* AUI */
multiline_comment|/* These Modes are not supported (are they?)*/
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Not supported&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Invalid&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1000_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|au1000_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|au1000_private
op_star
id|aup
op_assign
(paren
r_struct
id|au1000_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|au1000_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;%s: au1000_get_stats: dev=%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
r_return
op_amp
id|aup-&gt;stats
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
