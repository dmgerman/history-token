multiline_comment|/* airport.c 0.13e&n; *&n; * A driver for &quot;Hermes&quot; chipset based Apple Airport wireless&n; * card.&n; *&n; * Copyright notice &amp; release notes in file orinoco.c&n; * &n; * Note specific to airport stub:&n; * &n; *  0.05 : first version of the new split driver&n; *  0.06 : fix possible hang on powerup, add sleep support&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/wireless.h&gt;
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/current.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;orinoco.h&quot;
DECL|macro|AIRPORT_IO_LEN
mdefine_line|#define AIRPORT_IO_LEN&t;(0x1000)&t;/* one page */
DECL|struct|airport
r_struct
id|airport
(brace
DECL|member|node
r_struct
id|device_node
op_star
id|node
suffix:semicolon
DECL|member|vaddr
r_void
op_star
id|vaddr
suffix:semicolon
DECL|member|irq_requested
r_int
id|irq_requested
suffix:semicolon
DECL|member|ndev_registered
r_int
id|ndev_registered
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_static
r_int
id|airport_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
suffix:semicolon
DECL|variable|airport_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|airport_sleep_notifier
op_assign
(brace
id|airport_sleep_notify
comma
id|SLEEP_LEVEL_NET
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Function prototypes&n; */
r_static
r_struct
id|net_device
op_star
id|airport_attach
c_func
(paren
r_struct
id|device_node
op_star
id|of_node
)paren
suffix:semicolon
r_static
r_void
id|airport_detach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|airport_dev
r_static
r_struct
id|net_device
op_star
id|airport_dev
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_static
r_int
DECL|function|airport_sleep_notify
id|airport_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|airport_dev
suffix:semicolon
r_struct
id|orinoco_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|airport
op_star
id|card
op_assign
id|priv-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|airport_dev
)paren
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Airport entering sleep mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|err
op_assign
id|orinoco_lock
c_func
(paren
id|priv
comma
op_amp
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: hw_unavailable on PBOOK_SLEEP_NOW&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|err
op_assign
id|__orinoco_down
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PBOOK_SLEEP_NOW: Error %d downing interface&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|err
)paren
suffix:semicolon
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;hw_unavailable
op_increment
suffix:semicolon
id|orinoco_unlock
c_func
(paren
id|priv
comma
op_amp
id|flags
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_AIRPORT_ENABLE
comma
id|card-&gt;node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Airport waking up&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_AIRPORT_ENABLE
comma
id|card-&gt;node
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|err
op_assign
id|orinoco_reinit_firmware
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Error %d re-initializing firmware on PBOOK_WAKE&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|err
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;hw_unavailable
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;open
op_logical_and
(paren
op_logical_neg
id|priv-&gt;hw_unavailable
)paren
)paren
(brace
id|err
op_assign
id|__orinoco_up
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Error %d restarting card on PBOOK_WAKE&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|err
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
DECL|function|airport_hard_reset
r_static
r_int
id|airport_hard_reset
c_func
(paren
r_struct
id|orinoco_private
op_star
id|priv
)paren
(brace
multiline_comment|/* It would be nice to power cycle the Airport for a real hard&n;&t; * reset, but for some reason although it appears to&n;&t; * re-initialize properly, it falls in a screaming heap&n;&t; * shortly afterwards. */
macro_line|#if 0
r_struct
id|net_device
op_star
id|dev
op_assign
id|priv-&gt;ndev
suffix:semicolon
r_struct
id|airport
op_star
id|card
op_assign
id|priv-&gt;card
suffix:semicolon
multiline_comment|/* Vitally important.  If we don&squot;t do this it seems we get an&n;&t; * interrupt somewhere during the power cycle, since&n;&t; * hw_unavailable is already set it doesn&squot;t get ACKed, we get&n;&t; * into an interrupt loop and the the PMU decides to turn us&n;&t; * off. */
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_AIRPORT_ENABLE
comma
id|card-&gt;node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_AIRPORT_ENABLE
comma
id|card-&gt;node
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|net_device
op_star
DECL|function|airport_attach
id|airport_attach
c_func
(paren
r_struct
id|device_node
op_star
id|of_node
)paren
(brace
r_struct
id|orinoco_private
op_star
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|airport
op_star
id|card
suffix:semicolon
r_int
r_int
id|phys_addr
suffix:semicolon
id|hermes_t
op_star
id|hw
suffix:semicolon
r_if
c_cond
(paren
id|of_node-&gt;n_addrs
OL
l_int|1
op_logical_or
id|of_node-&gt;n_intrs
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: wrong interrupt/addresses in OF tree&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Allocate space for private device-specific data */
id|dev
op_assign
id|alloc_orinocodev
c_func
(paren
r_sizeof
(paren
op_star
id|card
)paren
comma
id|airport_hard_reset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: can&squot;t allocate device datas&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|card
op_assign
id|priv-&gt;card
suffix:semicolon
id|hw
op_assign
op_amp
id|priv-&gt;hw
suffix:semicolon
id|card-&gt;node
op_assign
id|of_node
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_OF_resource
c_func
(paren
id|of_node
comma
l_int|0
comma
l_string|&quot; (airport)&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: can&squot;t request IO resource !&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;name
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* register_netdev will give us an ethX name */
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Setup interrupts &amp; base address */
id|dev-&gt;irq
op_assign
id|of_node-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
id|phys_addr
op_assign
id|of_node-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
multiline_comment|/* Physical address */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Airport at physical address %lx&bslash;n&quot;
comma
id|phys_addr
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|phys_addr
suffix:semicolon
id|card-&gt;vaddr
op_assign
id|ioremap
c_func
(paren
id|phys_addr
comma
id|AIRPORT_IO_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;vaddr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;airport: ioremap() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|hermes_struct_init
c_func
(paren
id|hw
comma
(paren
id|ulong
)paren
id|card-&gt;vaddr
comma
id|HERMES_MEM
comma
id|HERMES_16BIT_REGSPACING
)paren
suffix:semicolon
multiline_comment|/* Power up card */
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_AIRPORT_ENABLE
comma
id|card-&gt;node
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
multiline_comment|/* Reset it before we get the interrupt */
id|hermes_init
c_func
(paren
id|hw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|orinoco_interrupt
comma
l_int|0
comma
l_string|&quot;Airport&quot;
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: Couldn&squot;t get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|card-&gt;irq_requested
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Tell the stack we exist */
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;airport: card registered for interface %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|card-&gt;ndev_registered
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_register_sleep_notifier
c_func
(paren
op_amp
id|airport_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif
r_return
id|dev
suffix:semicolon
id|failed
suffix:colon
id|airport_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* airport_attach */
multiline_comment|/*======================================================================&n;  This deletes a driver &quot;instance&quot;.  &n;  ======================================================================*/
r_static
r_void
DECL|function|airport_detach
id|airport_detach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|orinoco_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|airport
op_star
id|card
op_assign
id|priv-&gt;card
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_unregister_sleep_notifier
c_func
(paren
op_amp
id|airport_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|card-&gt;ndev_registered
)paren
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|card-&gt;ndev_registered
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;irq_requested
)paren
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|card-&gt;irq_requested
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;vaddr
)paren
id|iounmap
c_func
(paren
id|card-&gt;vaddr
)paren
suffix:semicolon
id|card-&gt;vaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;base_addr
op_assign
l_int|0
suffix:semicolon
id|release_OF_resource
c_func
(paren
id|card-&gt;node
comma
l_int|0
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_AIRPORT_ENABLE
comma
id|card-&gt;node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* airport_detach */
DECL|variable|__initdata
r_static
r_char
id|version
(braket
)braket
id|__initdata
op_assign
l_string|&quot;airport.c 0.13e (Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;)&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for the Apple Airport wireless card.&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual MPL/GPL&quot;
)paren
suffix:semicolon
r_static
r_int
id|__init
DECL|function|init_airport
id|init_airport
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|airport_node
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* Lookup card in device tree */
id|airport_node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;radio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|airport_node
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|airport_node-&gt;parent-&gt;name
comma
l_string|&quot;mac-io&quot;
)paren
)paren
id|airport_dev
op_assign
id|airport_attach
c_func
(paren
id|airport_node
)paren
suffix:semicolon
r_return
id|airport_dev
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|exit_airport
id|exit_airport
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|airport_dev
)paren
id|airport_detach
c_func
(paren
id|airport_dev
)paren
suffix:semicolon
id|airport_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|variable|init_airport
id|module_init
c_func
(paren
id|init_airport
)paren
suffix:semicolon
DECL|variable|exit_airport
id|module_exit
c_func
(paren
id|exit_airport
)paren
suffix:semicolon
eof
