multiline_comment|/* airport.c 0.05&n; *&n; * A driver for &quot;Hermes&quot; chipset based Apple Airport wireless&n; * card.&n; *&n; * Copyright notice &amp; release notes in file orinoco.c&n; * &n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/wireless.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/feature.h&gt;
macro_line|#include &quot;hermes.h&quot;
macro_line|#include &quot;orinoco.h&quot;
DECL|struct|dldwd_card
r_typedef
r_struct
id|dldwd_card
(brace
DECL|member|node
r_struct
id|device_node
op_star
id|node
suffix:semicolon
DECL|member|irq_requested
r_int
id|irq_requested
suffix:semicolon
DECL|member|ndev_registered
r_int
id|ndev_registered
suffix:semicolon
multiline_comment|/* Common structure (fully included), see orinoco.h */
DECL|member|priv
r_struct
id|dldwd_priv
id|priv
suffix:semicolon
DECL|typedef|dldwd_card_t
)brace
id|dldwd_card_t
suffix:semicolon
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;airport.c 0.05 (Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;)&quot;
suffix:semicolon
multiline_comment|/*&n; * Function prototypes&n; */
r_static
id|dldwd_priv_t
op_star
id|airport_attach
c_func
(paren
r_struct
id|device_node
op_star
id|of_node
)paren
suffix:semicolon
r_static
r_void
id|airport_detach
c_func
(paren
id|dldwd_priv_t
op_star
id|priv
)paren
suffix:semicolon
r_static
r_int
id|airport_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|airport_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|airport_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;   A linked list of &quot;instances&quot; of the dummy device.  Each actual&n;   PCMCIA card corresponds to one device instance, and is described&n;   by one dev_link_t structure (defined in ds.h).&n;&n;   You may not want to use a linked list for this -- for example, the&n;   memory card driver uses an array of dev_link_t pointers, where minor&n;   device numbers are used to derive the corresponding array index.&n;*/
DECL|variable|airport_dev
r_static
id|dldwd_priv_t
op_star
id|airport_dev
suffix:semicolon
DECL|function|airport_init
r_static
r_int
id|airport_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dldwd_priv_t
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dldwd_card_t
op_star
id|card
op_assign
(paren
id|dldwd_card_t
op_star
)paren
id|priv-&gt;card
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|TRACE_ENTER
c_func
(paren
id|priv-&gt;ndev.name
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|feature_set_airport_power
c_func
(paren
id|card-&gt;node
comma
l_int|1
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
id|rc
op_assign
id|dldwd_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|feature_set_airport_power
c_func
(paren
id|card-&gt;node
comma
l_int|0
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
)brace
id|priv-&gt;hw_ready
op_assign
l_int|1
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|airport_open
id|airport_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dldwd_priv_t
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|TRACE_ENTER
c_func
(paren
id|priv-&gt;ndev.name
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rc
op_assign
id|dldwd_reset
c_func
(paren
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|airport_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|TRACE_EXIT
c_func
(paren
id|priv-&gt;ndev.name
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|airport_stop
id|airport_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dldwd_priv_t
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|TRACE_ENTER
c_func
(paren
id|priv-&gt;ndev.name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dldwd_shutdown
c_func
(paren
id|priv
)paren
suffix:semicolon
id|TRACE_EXIT
c_func
(paren
id|priv-&gt;ndev.name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|dldwd_priv_t
op_star
DECL|function|airport_attach
id|airport_attach
c_func
(paren
r_struct
id|device_node
op_star
id|of_node
)paren
(brace
id|dldwd_priv_t
op_star
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
suffix:semicolon
id|dldwd_card_t
op_star
id|card
suffix:semicolon
id|hermes_t
op_star
id|hw
suffix:semicolon
id|TRACE_ENTER
c_func
(paren
l_string|&quot;dldwd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|of_node-&gt;n_addrs
OL
l_int|1
op_logical_or
id|of_node-&gt;n_intrs
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: wrong interrupt/addresses in OF tree&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Allocate space for private device-specific data */
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|card
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: can&squot;t allocate device datas&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
id|priv
op_assign
op_amp
(paren
id|card-&gt;priv
)paren
suffix:semicolon
id|priv-&gt;card
op_assign
id|card
suffix:semicolon
id|ndev
op_assign
op_amp
id|priv-&gt;ndev
suffix:semicolon
id|hw
op_assign
op_amp
id|priv-&gt;hw
suffix:semicolon
id|card-&gt;node
op_assign
id|of_node
suffix:semicolon
multiline_comment|/* Setup the common part */
r_if
c_cond
(paren
id|dldwd_setup
c_func
(paren
id|priv
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Overrides */
id|ndev-&gt;init
op_assign
id|airport_init
suffix:semicolon
id|ndev-&gt;open
op_assign
id|airport_open
suffix:semicolon
id|ndev-&gt;stop
op_assign
id|airport_stop
suffix:semicolon
multiline_comment|/* Setup interrupts &amp; base address */
id|ndev-&gt;irq
op_assign
id|of_node-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
id|ndev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|of_node-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x1000
)paren
op_minus
id|_IO_BASE
suffix:semicolon
id|hermes_struct_init
c_func
(paren
id|hw
comma
id|ndev-&gt;base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|ndev-&gt;irq
comma
id|dldwd_interrupt
comma
l_int|0
comma
l_string|&quot;Airport&quot;
comma
(paren
r_void
op_star
)paren
id|priv
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: Couldn&squot;t get IRQ %d&bslash;n&quot;
comma
id|ndev-&gt;irq
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|card-&gt;irq_requested
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* register_netdev will give us an ethX name */
id|ndev-&gt;name
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* Tell the stack we exist */
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|ndev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: register_netdev() failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;airport: card registered for interface %s&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|card-&gt;ndev_registered
op_assign
l_int|1
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* And give us the proc nodes for debugging */
r_if
c_cond
(paren
id|dldwd_proc_dev_init
c_func
(paren
id|priv
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;airport: Failed to create /proc node for %s&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_return
id|priv
suffix:semicolon
id|failed
suffix:colon
id|airport_detach
c_func
(paren
id|priv
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* airport_attach */
multiline_comment|/*======================================================================&n;  This deletes a driver &quot;instance&quot;.  &n;  ======================================================================*/
r_static
r_void
DECL|function|airport_detach
id|airport_detach
c_func
(paren
id|dldwd_priv_t
op_star
id|priv
)paren
(brace
id|dldwd_card_t
op_star
id|card
op_assign
(paren
id|dldwd_card_t
op_star
)paren
id|priv-&gt;card
suffix:semicolon
id|priv-&gt;hw_ready
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unregister proc entry */
id|dldwd_proc_dev_cleanup
c_func
(paren
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ndev_registered
)paren
id|unregister_netdev
c_func
(paren
op_amp
id|priv-&gt;ndev
)paren
suffix:semicolon
id|card-&gt;ndev_registered
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;irq_requested
)paren
id|free_irq
c_func
(paren
id|priv-&gt;ndev.irq
comma
id|priv
)paren
suffix:semicolon
id|card-&gt;irq_requested
op_assign
l_int|0
suffix:semicolon
singleline_comment|// FIXME
singleline_comment|//&t;if (ndev-&gt;base_addr)
singleline_comment|//&t;&t;iounmap(ndev-&gt;base_addr + _IO_BASE);
singleline_comment|//&t;ndev-&gt;base_addr = 0;
id|feature_set_airport_power
c_func
(paren
id|card-&gt;node
comma
l_int|0
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* airport_detach */
r_static
r_int
id|__init
DECL|function|init_airport
id|init_airport
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|airport_node
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/* Lookup card in device tree */
id|airport_node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;radio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|airport_node
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|airport_node-&gt;parent-&gt;name
comma
l_string|&quot;mac-io&quot;
)paren
)paren
id|airport_dev
op_assign
id|airport_attach
c_func
(paren
id|airport_node
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|airport_dev
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|exit_airport
id|exit_airport
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|airport_dev
)paren
id|airport_detach
c_func
(paren
id|airport_dev
)paren
suffix:semicolon
id|airport_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Apple Airport driver&quot;
)paren
suffix:semicolon
DECL|variable|init_airport
id|module_init
c_func
(paren
id|init_airport
)paren
suffix:semicolon
DECL|variable|exit_airport
id|module_exit
c_func
(paren
id|exit_airport
)paren
suffix:semicolon
eof
