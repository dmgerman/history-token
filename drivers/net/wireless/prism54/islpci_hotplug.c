multiline_comment|/*&n; *  &n; *  Copyright (C) 2002 Intersil Americas Inc.&n; *  Copyright (C) 2003 Herbert Valerio Riedel &lt;hvr@gnu.org&gt;&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt; /* For __init, __exit */
macro_line|#include &quot;prismcompat.h&quot;
macro_line|#include &quot;islpci_dev.h&quot;
macro_line|#include &quot;islpci_mgt.h&quot;&t;&t;/* for pc_debug */
macro_line|#include &quot;isl_oid.h&quot;
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;prism54&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;1.2&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;[Intersil] R.Bastings and W.Termorshuizen, The prism54.org Development Team &lt;prism54-devel@prism54.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;The Prism54 802.11 Wireless LAN adapter&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|init_pcitm
r_static
r_int
id|init_pcitm
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|init_pcitm
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* In this order: vendor, device, subvendor, subdevice, class, class_mask,&n; * driver_data &n; * If you have an update for this please contact prism54-devel@prism54.org &n; * The latest list can be found at http://prism54.org/supported_cards.php */
DECL|variable|prism54_id_tbl
r_static
r_const
r_struct
id|pci_device_id
id|prism54_id_tbl
(braket
)braket
op_assign
(brace
multiline_comment|/* Intersil PRISM Duette/Prism GT Wireless LAN adapter */
(brace
l_int|0x1260
comma
l_int|0x3890
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 3COM 3CRWE154G72 Wireless LAN adapter */
(brace
l_int|0x10b7
comma
l_int|0x6001
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* Intersil PRISM Indigo Wireless LAN adapter */
(brace
l_int|0x1260
comma
l_int|0x3877
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* Intersil PRISM Javelin/Xbow Wireless LAN adapter */
(brace
l_int|0x1260
comma
l_int|0x3886
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* End of list */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* register the device with the Hotplug facilities of the kernel */
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|prism54_id_tbl
)paren
suffix:semicolon
r_static
r_int
id|prism54_probe
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_const
r_struct
id|pci_device_id
op_star
)paren
suffix:semicolon
r_static
r_void
id|prism54_remove
c_func
(paren
r_struct
id|pci_dev
op_star
)paren
suffix:semicolon
r_static
r_int
id|prism54_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
comma
id|u32
id|state
)paren
suffix:semicolon
r_static
r_int
id|prism54_resume
c_func
(paren
r_struct
id|pci_dev
op_star
)paren
suffix:semicolon
DECL|variable|prism54_driver
r_static
r_struct
id|pci_driver
id|prism54_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|id_table
op_assign
id|prism54_id_tbl
comma
dot
id|probe
op_assign
id|prism54_probe
comma
dot
id|remove
op_assign
id|prism54_remove
comma
dot
id|suspend
op_assign
id|prism54_suspend
comma
dot
id|resume
op_assign
id|prism54_resume
comma
multiline_comment|/* .enable_wake ; we don&squot;t support this yet */
)brace
suffix:semicolon
multiline_comment|/******************************************************************************&n;    Module initialization functions&n;******************************************************************************/
r_int
DECL|function|prism54_probe
id|prism54_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
suffix:semicolon
id|u8
id|latency_tmr
suffix:semicolon
id|u32
id|mem_addr
suffix:semicolon
id|islpci_private
op_star
id|priv
suffix:semicolon
r_int
id|rvalue
suffix:semicolon
multiline_comment|/* Enable the pci device */
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: pci_enable_device() failed.&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* check whether the latency timer is set correctly */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|latency_tmr
)paren
suffix:semicolon
macro_line|#if VERBOSE &gt; SHOW_ERROR_MESSAGES
id|DEBUG
c_func
(paren
id|SHOW_TRACING
comma
l_string|&quot;latency timer: %x&bslash;n&quot;
comma
id|latency_tmr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|latency_tmr
OL
id|PCIDEVICE_LATENCY_TIMER_MIN
)paren
(brace
multiline_comment|/* set the latency timer */
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
id|PCIDEVICE_LATENCY_TIMER_VAL
)paren
suffix:semicolon
)brace
multiline_comment|/* enable PCI DMA */
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffff
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 32-bit PCI DMA not supported&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_goto
id|do_pci_disable_device
suffix:semicolon
)brace
multiline_comment|/* 0x40 is the programmable timer to configure the response timeout (TRDY_TIMEOUT)&n;&t; * 0x41 is the programmable timer to configure the retry timeout (RETRY_TIMEOUT)&n;&t; * &t;The RETRY_TIMEOUT is used to set the number of retries that the core, as a&n;&t; * &t;Master, will perform before abandoning a cycle. The default value for&n;&t; * &t;RETRY_TIMEOUT is 0x80, which far exceeds the PCI 2.1 requirement for new&n;&t; * &t;devices. A write of zero to the RETRY_TIMEOUT register disables this&n;&t; * &t;function to allow use with any non-compliant legacy devices that may&n;&t; * &t;execute more retries.&n;&t; *&n;&t; * &t;Writing zero to both these two registers will disable both timeouts and&n;&t; * &t;*can* solve problems caused by devices that are slow to respond.&n;&t; *&t;Make this configurable - MSW&n;&t; */
r_if
c_cond
(paren
id|init_pcitm
op_ge
l_int|0
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x40
comma
(paren
id|u8
)paren
id|init_pcitm
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x41
comma
(paren
id|u8
)paren
id|init_pcitm
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI TRDY/RETRY unchanged&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* request the pci device I/O regions */
id|rvalue
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rvalue
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: pci_request_regions failure (rc=%d)&bslash;n&quot;
comma
id|DRV_NAME
comma
id|rvalue
)paren
suffix:semicolon
r_goto
id|do_pci_disable_device
suffix:semicolon
)brace
multiline_comment|/* check if the memory window is indeed set */
id|rvalue
op_assign
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|mem_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rvalue
op_logical_or
op_logical_neg
id|mem_addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI device memory region not configured; fix your BIOS or CardBus bridge/drivers&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_goto
id|do_pci_disable_device
suffix:semicolon
)brace
multiline_comment|/* enable PCI bus-mastering */
id|DEBUG
c_func
(paren
id|SHOW_TRACING
comma
l_string|&quot;%s: pci_set_master(pdev)&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* enable MWI */
id|pci_set_mwi
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* setup the network device interface and its structure */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ndev
op_assign
id|islpci_setup
c_func
(paren
id|pdev
)paren
)paren
)paren
(brace
multiline_comment|/* error configuring the driver as a network device */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: could not configure network device&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_goto
id|do_pci_release_regions
suffix:semicolon
)brace
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|islpci_set_state
c_func
(paren
id|priv
comma
id|PRV_STATE_PREBOOT
)paren
suffix:semicolon
multiline_comment|/* we are attempting to boot */
multiline_comment|/* card is in unknown state yet, might have some interrupts pending */
id|isl38xx_disable_interrupts
c_func
(paren
id|priv-&gt;device_base
)paren
suffix:semicolon
multiline_comment|/* request for the interrupt before uploading the firmware */
id|rvalue
op_assign
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
op_amp
id|islpci_interrupt
comma
id|SA_SHIRQ
comma
id|ndev-&gt;name
comma
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rvalue
)paren
(brace
multiline_comment|/* error, could not hook the handler to the irq */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: could not install IRQ handler&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_goto
id|do_unregister_netdev
suffix:semicolon
)brace
multiline_comment|/* firmware upload is triggered in islpci_open */
r_return
l_int|0
suffix:semicolon
id|do_unregister_netdev
suffix:colon
id|unregister_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|islpci_free_memory
c_func
(paren
id|priv
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|priv
op_assign
l_int|NULL
suffix:semicolon
id|do_pci_release_regions
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|do_pci_disable_device
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* set by cleanup_module */
DECL|variable|__in_cleanup_module
r_static
r_volatile
r_int
id|__in_cleanup_module
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this one removes one(!!) instance only */
r_void
DECL|function|prism54_remove
id|prism54_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|islpci_private
op_star
id|priv
op_assign
id|ndev
ques
c_cond
id|netdev_priv
c_func
(paren
id|ndev
)paren
suffix:colon
l_int|NULL
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|__in_cleanup_module
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: hot unplug detected&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|islpci_set_state
c_func
(paren
id|priv
comma
id|PRV_STATE_OFF
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: removing device&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* free the interrupt request */
r_if
c_cond
(paren
id|islpci_get_state
c_func
(paren
id|priv
)paren
op_ne
id|PRV_STATE_OFF
)paren
(brace
id|isl38xx_disable_interrupts
c_func
(paren
id|priv-&gt;device_base
)paren
suffix:semicolon
id|islpci_set_state
c_func
(paren
id|priv
comma
id|PRV_STATE_OFF
)paren
suffix:semicolon
multiline_comment|/* This bellow causes a lockup at rmmod time. It might be&n;&t;&t; * because some interrupts still linger after rmmod time, &n;&t;&t; * see bug #17 */
multiline_comment|/* pci_set_power_state(pdev, 3);*/
multiline_comment|/* try to power-off */
)brace
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|priv
)paren
suffix:semicolon
multiline_comment|/* free the PCI memory and unmap the remapped page */
id|islpci_free_memory
c_func
(paren
id|priv
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|priv
op_assign
l_int|NULL
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
r_int
DECL|function|prism54_suspend
id|prism54_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|islpci_private
op_star
id|priv
op_assign
id|ndev
ques
c_cond
id|netdev_priv
c_func
(paren
id|ndev
)paren
suffix:colon
l_int|NULL
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|priv
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: got suspend request (state %d)&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|state
)paren
suffix:semicolon
id|pci_save_state
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* tell the device not to trigger interrupts for now... */
id|isl38xx_disable_interrupts
c_func
(paren
id|priv-&gt;device_base
)paren
suffix:semicolon
multiline_comment|/* from now on assume the hardware was already powered down&n;&t;   and don&squot;t touch it anymore */
id|islpci_set_state
c_func
(paren
id|priv
comma
id|PRV_STATE_OFF
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|netif_device_detach
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|prism54_resume
id|prism54_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|islpci_private
op_star
id|priv
op_assign
id|ndev
ques
c_cond
id|netdev_priv
c_func
(paren
id|ndev
)paren
suffix:colon
l_int|NULL
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|priv
)paren
suffix:semicolon
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: got resume request&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|pci_restore_state
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* alright let&squot;s go into the PREBOOT state */
id|islpci_reset
c_func
(paren
id|priv
comma
l_int|1
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|prism54_module_init
id|prism54_module_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Loaded %s driver, version %s&bslash;n&quot;
comma
id|DRV_NAME
comma
id|DRV_VERSION
)paren
suffix:semicolon
id|__bug_on_wrong_struct_sizes
(paren
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|prism54_driver
)paren
suffix:semicolon
)brace
multiline_comment|/* by the time prism54_module_exit() terminates, as a postcondition&n; * all instances will have been destroyed by calls to&n; * prism54_remove() */
r_static
r_void
id|__exit
DECL|function|prism54_module_exit
id|prism54_module_exit
c_func
(paren
r_void
)paren
(brace
id|__in_cleanup_module
op_assign
l_int|1
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|prism54_driver
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unloaded %s driver&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
id|__in_cleanup_module
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* register entry points */
DECL|variable|prism54_module_init
id|module_init
c_func
(paren
id|prism54_module_init
)paren
suffix:semicolon
DECL|variable|prism54_module_exit
id|module_exit
c_func
(paren
id|prism54_module_exit
)paren
suffix:semicolon
multiline_comment|/* EOF */
eof
