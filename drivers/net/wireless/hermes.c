multiline_comment|/* hermes.c&n; *&n; * Driver core for the &quot;Hermes&quot; wireless MAC controller, as used in&n; * the Lucent Orinoco and Cabletron RoamAbout cards. It should also&n; * work on the hfa3841 and hfa3842 MAC controller chips used in the&n; * Prism II chipsets.&n; *&n; * This is not a complete driver, just low-level access routines for&n; * the MAC controller itself.&n; *&n; * Based on the prism2 driver from Absolute Value Systems&squot; linux-wlan&n; * project, the Linux wvlan_cs driver, Lucent&squot;s HCF-Light&n; * (wvlan_hcf.c) library, and the NetBSD wireless driver (in no&n; * particular order).&n; *&n; * Copyright (C) 2000, David Gibson, Linuxcare Australia.&n; * (C) Copyright David Gibson, IBM Corp. 2001-2003.&n; * &n; * The contents of this file are subject to the Mozilla Public License&n; * Version 1.1 (the &quot;License&quot;); you may not use this file except in&n; * compliance with the License. You may obtain a copy of the License&n; * at http://www.mozilla.org/MPL/&n; *&n; * Software distributed under the License is distributed on an &quot;AS IS&quot;&n; * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See&n; * the License for the specific language governing rights and&n; * limitations under the License.&n; *&n; * Alternatively, the contents of this file may be used under the&n; * terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in&n; * which case the provisions of the GPL are applicable instead of the&n; * above.  If you wish to allow the use of your version of this file&n; * only under the terms of the GPL and not to allow others to use your&n; * version of this file under the MPL, indicate your decision by&n; * deleting the provisions above and replace them with the notice and&n; * other provisions required by the GPL.  If you do not delete the&n; * provisions above, a recipient may use your version of this file&n; * under either the MPL or the GPL.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/threads.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &quot;hermes.h&quot;
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Low-level driver helper for Lucent Hermes chipset and Prism II HFA384x wireless MAC controller&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Pavel Roskin &lt;proski@gnu.org&gt;&quot;
l_string|&quot; &amp; David Gibson &lt;hermes@gibson.dropbear.id.au&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual MPL/GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* These are maximum timeouts. Most often, card wil react much faster */
DECL|macro|CMD_BUSY_TIMEOUT
mdefine_line|#define CMD_BUSY_TIMEOUT (100) /* In iterations of ~1us */
DECL|macro|CMD_INIT_TIMEOUT
mdefine_line|#define CMD_INIT_TIMEOUT (50000) /* in iterations of ~10us */
DECL|macro|CMD_COMPL_TIMEOUT
mdefine_line|#define CMD_COMPL_TIMEOUT (20000) /* in iterations of ~10us */
DECL|macro|ALLOC_COMPL_TIMEOUT
mdefine_line|#define ALLOC_COMPL_TIMEOUT (1000) /* in iterations of ~10us */
multiline_comment|/*&n; * Debugging helpers&n; */
DECL|macro|DMSG
mdefine_line|#define DMSG(stuff...) do {printk(KERN_DEBUG &quot;hermes @ %p: &quot; , hw-&gt;iobase); &bslash;&n;&t;&t;&t;printk(stuff);} while (0)
DECL|macro|HERMES_DEBUG
macro_line|#undef HERMES_DEBUG
macro_line|#ifdef HERMES_DEBUG
macro_line|#include &lt;stdarg.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG(lvl, stuff...) if ( (lvl) &lt;= HERMES_DEBUG) DMSG(stuff)
macro_line|#else /* ! HERMES_DEBUG */
DECL|macro|DEBUG
mdefine_line|#define DEBUG(lvl, stuff...) do { } while (0)
macro_line|#endif /* ! HERMES_DEBUG */
multiline_comment|/*&n; * Internal functions&n; */
multiline_comment|/* Issue a command to the chip. Waiting for it to complete is the caller&squot;s&n;   problem.&n;&n;   Returns -EBUSY if the command register is busy, 0 on success.&n;&n;   Callable from any context.&n;*/
DECL|function|hermes_issue_cmd
r_static
r_int
id|hermes_issue_cmd
c_func
(paren
id|hermes_t
op_star
id|hw
comma
id|u16
id|cmd
comma
id|u16
id|param0
)paren
(brace
r_int
id|k
op_assign
id|CMD_BUSY_TIMEOUT
suffix:semicolon
id|u16
id|reg
suffix:semicolon
multiline_comment|/* First wait for the command register to unbusy */
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|reg
op_amp
id|HERMES_CMD_BUSY
)paren
op_logical_and
id|k
)paren
(brace
id|k
op_decrement
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|CMD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg
op_amp
id|HERMES_CMD_BUSY
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|PARAM2
comma
l_int|0
)paren
suffix:semicolon
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|PARAM1
comma
l_int|0
)paren
suffix:semicolon
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|PARAM0
comma
id|param0
)paren
suffix:semicolon
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|CMD
comma
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function definitions&n; */
DECL|function|hermes_struct_init
r_void
id|hermes_struct_init
c_func
(paren
id|hermes_t
op_star
id|hw
comma
r_void
id|__iomem
op_star
id|address
comma
r_int
id|reg_spacing
)paren
(brace
id|hw-&gt;iobase
op_assign
id|address
suffix:semicolon
id|hw-&gt;reg_spacing
op_assign
id|reg_spacing
suffix:semicolon
id|hw-&gt;inten
op_assign
l_int|0x0
suffix:semicolon
macro_line|#ifdef HERMES_DEBUG_BUFFER
id|hw-&gt;dbufp
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hw-&gt;dbuf
comma
l_int|0xff
comma
r_sizeof
(paren
id|hw-&gt;dbuf
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hw-&gt;profile
comma
l_int|0
comma
r_sizeof
(paren
id|hw-&gt;profile
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|hermes_init
r_int
id|hermes_init
c_func
(paren
id|hermes_t
op_star
id|hw
)paren
(brace
id|u16
id|status
comma
id|reg
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|k
suffix:semicolon
multiline_comment|/* We don&squot;t want to be interrupted while resetting the chipset */
id|hw-&gt;inten
op_assign
l_int|0x0
suffix:semicolon
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|INTEN
comma
l_int|0
)paren
suffix:semicolon
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|EVACK
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Normally it&squot;s a &quot;can&squot;t happen&quot; for the command register to&n;           be busy when we go to issue a command because we are&n;           serializing all commands.  However we want to have some&n;           chance of resetting the card even if it gets into a stupid&n;           state, so we actually wait to see if the command register&n;           will unbusy itself here. */
id|k
op_assign
id|CMD_BUSY_TIMEOUT
suffix:semicolon
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|k
op_logical_and
(paren
id|reg
op_amp
id|HERMES_CMD_BUSY
)paren
)paren
(brace
r_if
c_cond
(paren
id|reg
op_eq
l_int|0xffff
)paren
multiline_comment|/* Special case - the card has probably been removed,&n;&t;&t;&t;&t;      so don&squot;t wait for the timeout */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|k
op_decrement
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|CMD
)paren
suffix:semicolon
)brace
multiline_comment|/* No need to explicitly handle the timeout - if we&squot;ve timed&n;&t;   out hermes_issue_cmd() will probably return -EBUSY below */
multiline_comment|/* According to the documentation, EVSTAT may contain&n;&t;   obsolete event occurrence information.  We have to acknowledge&n;&t;   it by writing EVACK. */
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|EVSTAT
)paren
suffix:semicolon
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|EVACK
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t use hermes_docmd_wait here, because the reset wipes&n;&t;   the magic constant in SWSUPPORT0 away, and it gets confused */
id|err
op_assign
id|hermes_issue_cmd
c_func
(paren
id|hw
comma
id|HERMES_CMD_INIT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|EVSTAT
)paren
suffix:semicolon
id|k
op_assign
id|CMD_INIT_TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
(paren
id|reg
op_amp
id|HERMES_EV_CMD
)paren
)paren
op_logical_and
id|k
)paren
(brace
id|k
op_decrement
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|EVSTAT
)paren
suffix:semicolon
)brace
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|SWSUPPORT0
comma
id|HERMES_MAGIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hermes_present
c_func
(paren
id|hw
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;hermes @ 0x%x: Card removed during reset.&bslash;n&quot;
comma
id|hw-&gt;iobase
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg
op_amp
id|HERMES_EV_CMD
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hermes @ %p: &quot;
l_string|&quot;Timeout waiting for card to reset (reg=0x%04x)!&bslash;n&quot;
comma
id|hw-&gt;iobase
comma
id|reg
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|status
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|STATUS
)paren
suffix:semicolon
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|EVACK
comma
id|HERMES_EV_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|HERMES_STATUS_RESULT
)paren
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Issue a command to the chip, and (busy!) wait for it to&n; * complete.&n; *&n; * Returns: &lt; 0 on internal error, 0 on success, &gt; 0 on error returned by the firmware&n; *&n; * Callable from any context, but locking is your problem. */
DECL|function|hermes_docmd_wait
r_int
id|hermes_docmd_wait
c_func
(paren
id|hermes_t
op_star
id|hw
comma
id|u16
id|cmd
comma
id|u16
id|parm0
comma
r_struct
id|hermes_response
op_star
id|resp
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|k
suffix:semicolon
id|u16
id|reg
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|err
op_assign
id|hermes_issue_cmd
c_func
(paren
id|hw
comma
id|cmd
comma
id|parm0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hermes_present
c_func
(paren
id|hw
)paren
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;hermes @ %p: &quot;
l_string|&quot;Card removed while issuing command &quot;
l_string|&quot;0x%04x.&bslash;n&quot;
comma
id|hw-&gt;iobase
comma
id|cmd
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hermes @ %p: &quot;
l_string|&quot;Error %d issuing command 0x%04x.&bslash;n&quot;
comma
id|hw-&gt;iobase
comma
id|err
comma
id|cmd
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|EVSTAT
)paren
suffix:semicolon
id|k
op_assign
id|CMD_COMPL_TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
(paren
id|reg
op_amp
id|HERMES_EV_CMD
)paren
)paren
op_logical_and
id|k
)paren
(brace
id|k
op_decrement
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|EVSTAT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hermes_present
c_func
(paren
id|hw
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;hermes @ %p: Card removed &quot;
l_string|&quot;while waiting for command 0x%04x completion.&bslash;n&quot;
comma
id|hw-&gt;iobase
comma
id|cmd
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg
op_amp
id|HERMES_EV_CMD
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hermes @ %p: Timeout waiting for &quot;
l_string|&quot;command 0x%04x completion.&bslash;n&quot;
comma
id|hw-&gt;iobase
comma
id|cmd
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|status
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resp
)paren
(brace
id|resp-&gt;status
op_assign
id|status
suffix:semicolon
id|resp-&gt;resp0
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|RESP0
)paren
suffix:semicolon
id|resp-&gt;resp1
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|RESP1
)paren
suffix:semicolon
id|resp-&gt;resp2
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|RESP2
)paren
suffix:semicolon
)brace
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|EVACK
comma
id|HERMES_EV_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|HERMES_STATUS_RESULT
)paren
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|hermes_allocate
r_int
id|hermes_allocate
c_func
(paren
id|hermes_t
op_star
id|hw
comma
id|u16
id|size
comma
id|u16
op_star
id|fid
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|k
suffix:semicolon
id|u16
id|reg
suffix:semicolon
r_if
c_cond
(paren
(paren
id|size
OL
id|HERMES_ALLOC_LEN_MIN
)paren
op_logical_or
(paren
id|size
OG
id|HERMES_ALLOC_LEN_MAX
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|hermes_docmd_wait
c_func
(paren
id|hw
comma
id|HERMES_CMD_ALLOC
comma
id|size
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|EVSTAT
)paren
suffix:semicolon
id|k
op_assign
id|ALLOC_COMPL_TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
(paren
id|reg
op_amp
id|HERMES_EV_ALLOC
)paren
)paren
op_logical_and
id|k
)paren
(brace
id|k
op_decrement
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|reg
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|EVSTAT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hermes_present
c_func
(paren
id|hw
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;hermes @ %p: &quot;
l_string|&quot;Card removed waiting for frame allocation.&bslash;n&quot;
comma
id|hw-&gt;iobase
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg
op_amp
id|HERMES_EV_ALLOC
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hermes @ %p: &quot;
l_string|&quot;Timeout waiting for frame allocation&bslash;n&quot;
comma
id|hw-&gt;iobase
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
op_star
id|fid
op_assign
id|hermes_read_regn
c_func
(paren
id|hw
comma
id|ALLOCFID
)paren
suffix:semicolon
id|hermes_write_regn
c_func
(paren
id|hw
comma
id|EVACK
comma
id|HERMES_EV_ALLOC
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set up a BAP to read a particular chunk of data from card&squot;s internal buffer.&n; *&n; * Returns: &lt; 0 on internal failure (errno), 0 on success, &gt;0 on error&n; * from firmware&n; *&n; * Callable from any context */
DECL|function|hermes_bap_seek
r_static
r_int
id|hermes_bap_seek
c_func
(paren
id|hermes_t
op_star
id|hw
comma
r_int
id|bap
comma
id|u16
id|id
comma
id|u16
id|offset
)paren
(brace
r_int
id|sreg
op_assign
id|bap
ques
c_cond
id|HERMES_SELECT1
suffix:colon
id|HERMES_SELECT0
suffix:semicolon
r_int
id|oreg
op_assign
id|bap
ques
c_cond
id|HERMES_OFFSET1
suffix:colon
id|HERMES_OFFSET0
suffix:semicolon
r_int
id|k
suffix:semicolon
id|u16
id|reg
suffix:semicolon
multiline_comment|/* Paranoia.. */
r_if
c_cond
(paren
(paren
id|offset
OG
id|HERMES_BAP_OFFSET_MAX
)paren
op_logical_or
(paren
id|offset
op_mod
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|k
op_assign
id|HERMES_BAP_BUSY_TIMEOUT
suffix:semicolon
id|reg
op_assign
id|hermes_read_reg
c_func
(paren
id|hw
comma
id|oreg
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|reg
op_amp
id|HERMES_OFFSET_BUSY
)paren
op_logical_and
id|k
)paren
(brace
id|k
op_decrement
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|reg
op_assign
id|hermes_read_reg
c_func
(paren
id|hw
comma
id|oreg
)paren
suffix:semicolon
)brace
macro_line|#ifdef HERMES_DEBUG_BUFFER
id|hw-&gt;profile
(braket
id|HERMES_BAP_BUSY_TIMEOUT
op_minus
id|k
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|k
OL
id|HERMES_BAP_BUSY_TIMEOUT
)paren
(brace
r_struct
id|hermes_debug_entry
op_star
id|e
op_assign
op_amp
id|hw-&gt;dbuf
(braket
(paren
id|hw-&gt;dbufp
op_increment
)paren
op_mod
id|HERMES_DEBUG_BUFSIZE
)braket
suffix:semicolon
id|e-&gt;bap
op_assign
id|bap
suffix:semicolon
id|e-&gt;id
op_assign
id|id
suffix:semicolon
id|e-&gt;offset
op_assign
id|offset
suffix:semicolon
id|e-&gt;cycles
op_assign
id|HERMES_BAP_BUSY_TIMEOUT
op_minus
id|k
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|reg
op_amp
id|HERMES_OFFSET_BUSY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
multiline_comment|/* Now we actually set up the transfer */
id|hermes_write_reg
c_func
(paren
id|hw
comma
id|sreg
comma
id|id
)paren
suffix:semicolon
id|hermes_write_reg
c_func
(paren
id|hw
comma
id|oreg
comma
id|offset
)paren
suffix:semicolon
multiline_comment|/* Wait for the BAP to be ready */
id|k
op_assign
id|HERMES_BAP_BUSY_TIMEOUT
suffix:semicolon
id|reg
op_assign
id|hermes_read_reg
c_func
(paren
id|hw
comma
id|oreg
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|reg
op_amp
(paren
id|HERMES_OFFSET_BUSY
op_or
id|HERMES_OFFSET_ERR
)paren
)paren
op_logical_and
id|k
)paren
(brace
id|k
op_decrement
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|reg
op_assign
id|hermes_read_reg
c_func
(paren
id|hw
comma
id|oreg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg
op_ne
id|offset
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hermes @ %p: BAP%d offset %s: &quot;
l_string|&quot;reg=0x%x id=0x%x offset=0x%x&bslash;n&quot;
comma
id|hw-&gt;iobase
comma
id|bap
comma
(paren
id|reg
op_amp
id|HERMES_OFFSET_BUSY
)paren
ques
c_cond
l_string|&quot;timeout&quot;
suffix:colon
l_string|&quot;error&quot;
comma
id|reg
comma
id|id
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|HERMES_OFFSET_BUSY
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* error or wrong offset */
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read a block of data from the chip&squot;s buffer, via the&n; * BAP. Synchronization/serialization is the caller&squot;s problem.  len&n; * must be even.&n; *&n; * Returns: &lt; 0 on internal failure (errno), 0 on success, &gt; 0 on error from firmware&n; */
DECL|function|hermes_bap_pread
r_int
id|hermes_bap_pread
c_func
(paren
id|hermes_t
op_star
id|hw
comma
r_int
id|bap
comma
r_void
op_star
id|buf
comma
r_int
id|len
comma
id|u16
id|id
comma
id|u16
id|offset
)paren
(brace
r_int
id|dreg
op_assign
id|bap
ques
c_cond
id|HERMES_DATA1
suffix:colon
id|HERMES_DATA0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
OL
l_int|0
)paren
op_logical_or
(paren
id|len
op_mod
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|hermes_bap_seek
c_func
(paren
id|hw
comma
id|bap
comma
id|id
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Actually do the transfer */
id|hermes_read_words
c_func
(paren
id|hw
comma
id|dreg
comma
id|buf
comma
id|len
op_div
l_int|2
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Write a block of data to the chip&squot;s buffer, via the&n; * BAP. Synchronization/serialization is the caller&squot;s problem. len&n; * must be even.&n; *&n; * Returns: &lt; 0 on internal failure (errno), 0 on success, &gt; 0 on error from firmware&n; */
DECL|function|hermes_bap_pwrite
r_int
id|hermes_bap_pwrite
c_func
(paren
id|hermes_t
op_star
id|hw
comma
r_int
id|bap
comma
r_const
r_void
op_star
id|buf
comma
r_int
id|len
comma
id|u16
id|id
comma
id|u16
id|offset
)paren
(brace
r_int
id|dreg
op_assign
id|bap
ques
c_cond
id|HERMES_DATA1
suffix:colon
id|HERMES_DATA0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
OL
l_int|0
)paren
op_logical_or
(paren
id|len
op_mod
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|hermes_bap_seek
c_func
(paren
id|hw
comma
id|bap
comma
id|id
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Actually do the transfer */
id|hermes_write_words
c_func
(paren
id|hw
comma
id|dreg
comma
id|buf
comma
id|len
op_div
l_int|2
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Read a Length-Type-Value record from the card.&n; *&n; * If length is NULL, we ignore the length read from the card, and&n; * read the entire buffer regardless. This is useful because some of&n; * the configuration records appear to have incorrect lengths in&n; * practice.&n; *&n; * Callable from user or bh context.  */
DECL|function|hermes_read_ltv
r_int
id|hermes_read_ltv
c_func
(paren
id|hermes_t
op_star
id|hw
comma
r_int
id|bap
comma
id|u16
id|rid
comma
r_int
id|bufsize
comma
id|u16
op_star
id|length
comma
r_void
op_star
id|buf
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|dreg
op_assign
id|bap
ques
c_cond
id|HERMES_DATA1
suffix:colon
id|HERMES_DATA0
suffix:semicolon
id|u16
id|rlength
comma
id|rtype
suffix:semicolon
r_int
id|nwords
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bufsize
OL
l_int|0
)paren
op_logical_or
(paren
id|bufsize
op_mod
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|hermes_docmd_wait
c_func
(paren
id|hw
comma
id|HERMES_CMD_ACCESS
comma
id|rid
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|err
op_assign
id|hermes_bap_seek
c_func
(paren
id|hw
comma
id|bap
comma
id|rid
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|rlength
op_assign
id|hermes_read_reg
c_func
(paren
id|hw
comma
id|dreg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rlength
)paren
r_return
op_minus
id|ENODATA
suffix:semicolon
id|rtype
op_assign
id|hermes_read_reg
c_func
(paren
id|hw
comma
id|dreg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
op_star
id|length
op_assign
id|rlength
suffix:semicolon
r_if
c_cond
(paren
id|rtype
op_ne
id|rid
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;hermes @ %p: %s(): &quot;
l_string|&quot;rid (0x%04x) does not match type (0x%04x)&bslash;n&quot;
comma
id|hw-&gt;iobase
comma
id|__FUNCTION__
comma
id|rid
comma
id|rtype
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HERMES_RECLEN_TO_BYTES
c_func
(paren
id|rlength
)paren
OG
id|bufsize
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;hermes @ %p: &quot;
l_string|&quot;Truncating LTV record from %d to %d bytes. &quot;
l_string|&quot;(rid=0x%04x, len=0x%04x)&bslash;n&quot;
comma
id|hw-&gt;iobase
comma
id|HERMES_RECLEN_TO_BYTES
c_func
(paren
id|rlength
)paren
comma
id|bufsize
comma
id|rid
comma
id|rlength
)paren
suffix:semicolon
id|nwords
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
id|rlength
op_minus
l_int|1
comma
id|bufsize
op_div
l_int|2
)paren
suffix:semicolon
id|hermes_read_words
c_func
(paren
id|hw
comma
id|dreg
comma
id|buf
comma
id|nwords
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hermes_write_ltv
r_int
id|hermes_write_ltv
c_func
(paren
id|hermes_t
op_star
id|hw
comma
r_int
id|bap
comma
id|u16
id|rid
comma
id|u16
id|length
comma
r_const
r_void
op_star
id|value
)paren
(brace
r_int
id|dreg
op_assign
id|bap
ques
c_cond
id|HERMES_DATA1
suffix:colon
id|HERMES_DATA0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|count
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|hermes_bap_seek
c_func
(paren
id|hw
comma
id|bap
comma
id|rid
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|hermes_write_reg
c_func
(paren
id|hw
comma
id|dreg
comma
id|length
)paren
suffix:semicolon
id|hermes_write_reg
c_func
(paren
id|hw
comma
id|dreg
comma
id|rid
)paren
suffix:semicolon
id|count
op_assign
id|length
op_minus
l_int|1
suffix:semicolon
id|hermes_write_words
c_func
(paren
id|hw
comma
id|dreg
comma
id|value
comma
id|count
)paren
suffix:semicolon
id|err
op_assign
id|hermes_docmd_wait
c_func
(paren
id|hw
comma
id|HERMES_CMD_ACCESS
op_or
id|HERMES_CMD_WRITE
comma
id|rid
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|hermes_struct_init
id|EXPORT_SYMBOL
c_func
(paren
id|hermes_struct_init
)paren
suffix:semicolon
DECL|variable|hermes_init
id|EXPORT_SYMBOL
c_func
(paren
id|hermes_init
)paren
suffix:semicolon
DECL|variable|hermes_docmd_wait
id|EXPORT_SYMBOL
c_func
(paren
id|hermes_docmd_wait
)paren
suffix:semicolon
DECL|variable|hermes_allocate
id|EXPORT_SYMBOL
c_func
(paren
id|hermes_allocate
)paren
suffix:semicolon
DECL|variable|hermes_bap_pread
id|EXPORT_SYMBOL
c_func
(paren
id|hermes_bap_pread
)paren
suffix:semicolon
DECL|variable|hermes_bap_pwrite
id|EXPORT_SYMBOL
c_func
(paren
id|hermes_bap_pwrite
)paren
suffix:semicolon
DECL|variable|hermes_read_ltv
id|EXPORT_SYMBOL
c_func
(paren
id|hermes_read_ltv
)paren
suffix:semicolon
DECL|variable|hermes_write_ltv
id|EXPORT_SYMBOL
c_func
(paren
id|hermes_write_ltv
)paren
suffix:semicolon
DECL|function|init_hermes
r_static
r_int
id|__init
id|init_hermes
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_hermes
r_static
r_void
id|__exit
id|exit_hermes
c_func
(paren
r_void
)paren
(brace
)brace
DECL|variable|init_hermes
id|module_init
c_func
(paren
id|init_hermes
)paren
suffix:semicolon
DECL|variable|exit_hermes
id|module_exit
c_func
(paren
id|exit_hermes
)paren
suffix:semicolon
eof
