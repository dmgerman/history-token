multiline_comment|/* orinoco_plx.c 0.01&n; * &n; * Driver for Prism II devices which would usually be driven by orinoco_cs,&n; * but are connected to the PCI bus by a PLX9052. &n; *&n; * Specifically here we&squot;re talking about the SMC2602W (EZConnect&n; * Wireless PCI Adaptor)&n; *&n; * The actual driving is done by orinoco.c, this is just resource&n; * allocation stuff.  The explanation below is courtesy of Ryan Niemi&n; * on the linux-wlan-ng list at&n; * http://archives.neohapsis.com/archives/dev/linux-wlan/2001-q1/0026.html&n; *&n; * Copyright (C) 2001 Daniel Barlow &lt;dan@telent.net&gt;&n; *&n; * The contents of this file are subject to the Mozilla Public License&n; * Version 1.1 (the &quot;License&quot;); you may not use this file except in&n; * compliance with the License. You may obtain a copy of the License&n; * at http://www.mozilla.org/MPL/&n; *&n; * Software distributed under the License is distributed on an &quot;AS IS&quot;&n; * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See&n; * the License for the specific language governing rights and&n; * limitations under the License.&n; *&n; * Alternatively, the contents of this file may be used under the&n; * terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in&n; * which case the provisions of the GPL are applicable instead of the&n; * above.  If you wish to allow the use of your version of this file&n; * only under the terms of the GPL and not to allow others to use your&n; * version of this file under the MPL, indicate your decision by&n; * deleting the provisions above and replace them with the notice and&n; * other provisions required by the GPL.  If you do not delete the&n; * provisions above, a recipient may use your version of this file&n; * under either the MPL or the GPL.&n;&n;The PLX9052-based cards (WL11000 and several others) are a different&n;beast than the usual PCMCIA-based PRISM2 configuration expected by&n;wlan-ng. Here&squot;s the general details on how the WL11000 PCI adapter&n;works:&n;&n; - Two PCI I/O address spaces, one 0x80 long which contains the PLX9052&n;   registers, and one that&squot;s 0x40 long mapped to the PCMCIA slot I/O&n;   address space.&n;&n; - One PCI memory address space, mapped to the PCMCIA memory space&n;   (containing the CIS).&n;&n;After identifying the I/O and memory space, you can read through the&n;memory space to confirm the CIS&squot;s device ID or manufacturer ID to make&n;sure it&squot;s the expected card. Keep in mind that the PCMCIA spec specifies&n;the CIS as the lower 8 bits of each word read from the CIS, so to read the&n;bytes of the CIS, read every other byte (0,2,4,...). Passing that test,&n;you need to enable the I/O address space on the PCMCIA card via the PCMCIA&n;COR register. This is the first byte following the CIS. In my case&n;(which may not have any relation to what&squot;s on the PRISM2 cards), COR was&n;at offset 0x800 within the PCI memory space. Write 0x41 to the COR&n;register to enable I/O mode and to select level triggered interrupts. To&n;confirm you actually succeeded, read the COR register back and make sure&n;it actually got set to 0x41, incase you have an unexpected card inserted.&n;&n;Following that, you can treat the second PCI I/O address space (the one&n;that&squot;s not 0x80 in length) as the PCMCIA I/O space.&n;&n;Note that in the Eumitcom&squot;s source for their drivers, they register the&n;interrupt as edge triggered when registering it with the Windows kernel. I&n;don&squot;t recall how to register edge triggered on Linux (if it can be done at&n;all). But in some experimentation, I don&squot;t see much operational&n;difference between using either interrupt mode. Don&squot;t mess with the&n;interrupt mode in the COR register though, as the PLX9052 wants level&n;triggers with the way the serial EEPROM configures it on the WL11000.&n;&n;There&squot;s some other little quirks related to timing that I bumped into, but&n;I don&squot;t recall right now. Also, there&squot;s two variants of the WL11000 I&squot;ve&n;seen, revision A1 and T2. These seem to differ slightly in the timings&n;configured in the wait-state generator in the PLX9052. There have also&n;been some comments from Eumitcom that cards shouldn&squot;t be hot swapped,&n;apparently due to risk of cooking the PLX9052. I&squot;m unsure why they&n;believe this, as I can&squot;t see anything in the design that would really&n;cause a problem, except for crashing drivers not written to expect it. And&n;having developed drivers for the WL11000, I&squot;d say it&squot;s quite tricky to&n;write code that will successfully deal with a hot unplug. Very odd things&n;happen on the I/O side of things. But anyway, be warned. Despite that,&n;I&squot;ve hot-swapped a number of times during debugging and driver development&n;for various reasons (stuck WAIT# line after the radio card&squot;s firmware&n;locks up).&n;&n;Hope this is enough info for someone to add PLX9052 support to the wlan-ng&n;card. In the case of the WL11000, the PCI ID&squot;s are 0x1639/0x0200, with&n;matching subsystem ID&squot;s. Other PLX9052-based manufacturers other than&n;Eumitcom (or on cards other than the WL11000) may have different PCI ID&squot;s.&n;&n;If anyone needs any more specific info, let me know. I haven&squot;t had time&n;to implement support myself yet, and with the way things are going, might&n;not have time for a while..&n;&n;---end of mail---&n;&n;  Bus  0, device   4, function  0:&n;    Network controller: Unknown vendor Unknown device (rev 2).&n;      Vendor id=1638. Device id=1100.&n;      Medium devsel.  Fast back-to-back capable.  IRQ 10.  &n;      I/O at 0x1000 [0x1001].&n;      Non-prefetchable 32 bit memory at 0x40000000 [0x40000000].&n;      I/O at 0x10c0 [0x10c1].&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/wireless.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/wireless.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#include &lt;pcmcia/bus_ops.h&gt;
macro_line|#include &quot;hermes.h&quot;
macro_line|#include &quot;orinoco.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Daniel Barlow &lt;dan@telent.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for wireless LAN cards using the PLX9052 PCI bridge&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual MPL/GPL&quot;
)paren
suffix:semicolon
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;orinoco_plx&quot;
suffix:semicolon
DECL|macro|COR_OFFSET
mdefine_line|#define COR_OFFSET    0x3e0&t;/* COR attribute offset of Prism2 PC card */
DECL|macro|COR_VALUE
mdefine_line|#define COR_VALUE     0x41&t;/* Enable PC card with interrupt in level trigger */
DECL|function|orinoco_plx_open
r_static
r_int
id|orinoco_plx_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dldwd_priv_t
op_star
id|priv
op_assign
(paren
id|dldwd_priv_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|err
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err
op_assign
id|dldwd_reset
c_func
(paren
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: dldwd_reset failed in orinoco_plx_open()&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|orinoco_plx_stop
r_static
r_int
id|orinoco_plx_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dldwd_priv_t
op_star
id|priv
op_assign
(paren
id|dldwd_priv_t
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dldwd_shutdown
c_func
(paren
id|priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|orinoco_plx_interrupt
id|orinoco_plx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|dldwd_interrupt
c_func
(paren
id|irq
comma
(paren
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
)paren
op_member_access_from_pointer
id|priv
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|orinoco_plx_init_one
r_static
r_int
id|orinoco_plx_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
r_int
id|pccard_ioaddr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|reg
suffix:semicolon
r_int
r_char
op_star
id|attr_mem
suffix:semicolon
id|dldwd_priv_t
op_star
id|priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Resource 2 is mapped to the PCMCIA space */
id|attr_mem
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
comma
l_int|0x1000
)paren
suffix:semicolon
multiline_comment|/* and 3 to the PCMCIA slot I/O address space */
id|pccard_ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Verify whether PC card is present */
r_if
c_cond
(paren
id|attr_mem
(braket
l_int|0
)braket
op_ne
l_int|0x01
op_logical_or
id|attr_mem
(braket
l_int|2
)braket
op_ne
l_int|0x03
op_logical_or
id|attr_mem
(braket
l_int|4
)braket
op_ne
l_int|0x00
op_logical_or
id|attr_mem
(braket
l_int|6
)braket
op_ne
l_int|0x00
op_logical_or
id|attr_mem
(braket
l_int|8
)braket
op_ne
l_int|0xFF
op_logical_or
id|attr_mem
(braket
l_int|10
)braket
op_ne
l_int|0x17
op_logical_or
id|attr_mem
(braket
l_int|12
)braket
op_ne
l_int|0x04
op_logical_or
id|attr_mem
(braket
l_int|14
)braket
op_ne
l_int|0x67
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;orinoco_plx: The CIS value of Prism2 PC card is invalid.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* PCMCIA COR is the first byte following CIS: this write should&n;&t; * enable I/O mode and select level-triggered interrupts */
id|attr_mem
(braket
id|COR_OFFSET
)braket
op_assign
id|COR_VALUE
suffix:semicolon
id|reg
op_assign
id|attr_mem
(braket
id|COR_OFFSET
)braket
suffix:semicolon
multiline_comment|/* assert(reg==COR_VALUE); doesn&squot;t work */
id|iounmap
c_func
(paren
id|attr_mem
)paren
suffix:semicolon
multiline_comment|/* done with this now, it seems */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|pccard_ioaddr
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|3
)paren
comma
id|dev_info
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;orinoco_plx: I/O resource 0x%lx @ 0x%lx busy&bslash;n&quot;
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|3
)paren
comma
id|pccard_ioaddr
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|priv
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|priv
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|priv
)paren
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|priv-&gt;ndev
suffix:semicolon
id|dldwd_setup
c_func
(paren
id|priv
)paren
suffix:semicolon
multiline_comment|/* XXX clean up if &lt;0 */
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|pccard_ioaddr
suffix:semicolon
id|dev-&gt;open
op_assign
id|orinoco_plx_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|orinoco_plx_stop
suffix:semicolon
id|priv-&gt;card_reset_handler
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* We have no reset handler */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Detected Orinoco/Prism2 PCI device at %s, mem:0x%lx, irq:%d, io addr:0x%lx&bslash;n&quot;
comma
id|pdev-&gt;slot_name
comma
(paren
r_int
)paren
id|attr_mem
comma
id|pdev-&gt;irq
comma
id|pccard_ioaddr
)paren
suffix:semicolon
id|hermes_struct_init
c_func
(paren
op_amp
(paren
id|priv-&gt;hw
)paren
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* XXX */
id|dev-&gt;name
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* name defaults to ethX */
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|orinoco_plx_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dldwd_proc_dev_init
c_func
(paren
id|priv
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Failed to create /proc node&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;hw_ready
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* if(reset_cor) dldwd_cs_cor_reset(priv); */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* succeeded */
)brace
DECL|function|orinoco_plx_remove_one
r_static
r_void
id|__devexit
id|orinoco_plx_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|dldwd_priv_t
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|dldwd_proc_dev_cleanup
c_func
(paren
id|priv
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;base_addr
comma
l_int|0x40
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|orinoco_plx_pci_id_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_int|0x1638
comma
l_int|0x1100
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|orinoco_plx_pci_id_table
)paren
suffix:semicolon
DECL|variable|orinoco_plx_driver
r_static
r_struct
id|pci_driver
id|orinoco_plx_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;orinoco_plx&quot;
comma
id|id_table
suffix:colon
id|orinoco_plx_pci_id_table
comma
id|probe
suffix:colon
id|orinoco_plx_init_one
comma
id|remove
suffix:colon
id|orinoco_plx_remove_one
comma
id|suspend
suffix:colon
l_int|0
comma
id|resume
suffix:colon
l_int|0
)brace
suffix:semicolon
DECL|function|orinoco_plx_init
r_static
r_int
id|__init
id|orinoco_plx_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|orinoco_plx_driver
)paren
suffix:semicolon
)brace
DECL|function|orinoco_plx_exit
r_extern
r_void
id|__exit
id|orinoco_plx_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|orinoco_plx_driver
)paren
suffix:semicolon
)brace
DECL|variable|orinoco_plx_init
id|module_init
c_func
(paren
id|orinoco_plx_init
)paren
suffix:semicolon
DECL|variable|orinoco_plx_exit
id|module_exit
c_func
(paren
id|orinoco_plx_exit
)paren
suffix:semicolon
multiline_comment|/*&n; * Local variables:&n; *  c-indent-level: 8&n; *  c-basic-offset: 8&n; *  tab-width: 8&n; * End:&n; */
eof
