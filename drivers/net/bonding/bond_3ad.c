multiline_comment|/*&n; * Copyright(c) 1999 - 2003 Intel Corporation. All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the Free&n; * Software Foundation; either version 2 of the License, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but WITHOUT&n; * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for&n; * more details.&n; *&n; * You should have received a copy of the GNU General Public License along with&n; * this program; if not, write to the Free Software Foundation, Inc., 59&n; * Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n; *&n; * The full GNU General Public License is included in this distribution in the&n; * file called LICENSE.&n; *&n; *&n; * Changes:&n; *&n; * 2003/05/01 - Tsippy Mendelson &lt;tsippy.mendelson at intel dot com&gt; and&n; *&t;&t;Amir Noam &lt;amir.noam at intel dot com&gt;&n; *&t;- Added support for lacp_rate module param.&n; *&n; * 2003/05/01 - Shmulik Hen &lt;shmulik.hen at intel dot com&gt;&n; *&t;- Based on discussion on mailing list, changed locking scheme&n; *&t;  to use lock/unlock or lock_bh/unlock_bh appropriately instead&n; *&t;  of lock_irqsave/unlock_irqrestore. The new scheme helps exposing&n; *&t;  hidden bugs and solves system hangs that occurred due to the fact&n; *&t;  that holding lock_irqsave doesn&squot;t prevent softirqs from running.&n; *&t;  This also increases total throughput since interrupts are not&n; *&t;  blocked on each transmitted packets or monitor timeout.&n; *&n; * 2003/05/01 - Shmulik Hen &lt;shmulik.hen at intel dot com&gt;&n; *&t;- Renamed bond_3ad_link_status_changed() to&n; *&t;  bond_3ad_handle_link_change() for compatibility with TLB.&n; *&n; * 2003/05/20 - Amir Noam &lt;amir.noam at intel dot com&gt;&n; *&t;- Fix long fail over time when releasing last slave of an active&n; *&t;  aggregator - send LACPDU on unbind of slave to tell partner this&n; *&t;  port is no longer aggregatable.&n; *&n; * 2003/06/25 - Tsippy Mendelson &lt;tsippy.mendelson at intel dot com&gt;&n; *&t;- Send LACPDU as highest priority packet to further fix the above&n; *&t;  problem on very high Tx traffic load where packets may get dropped&n; *&t;  by the slave.&n; */
singleline_comment|//#define BONDING_DEBUG 1
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/if_bonding.h&gt;
macro_line|#include &lt;linux/pkt_sched.h&gt;
macro_line|#include &quot;bonding.h&quot;
macro_line|#include &quot;bond_3ad.h&quot;
singleline_comment|// General definitions
DECL|macro|AD_SHORT_TIMEOUT
mdefine_line|#define AD_SHORT_TIMEOUT           1
DECL|macro|AD_LONG_TIMEOUT
mdefine_line|#define AD_LONG_TIMEOUT            0
DECL|macro|AD_STANDBY
mdefine_line|#define AD_STANDBY                 0x2
DECL|macro|AD_MAX_TX_IN_SECOND
mdefine_line|#define AD_MAX_TX_IN_SECOND        3
DECL|macro|AD_COLLECTOR_MAX_DELAY
mdefine_line|#define AD_COLLECTOR_MAX_DELAY     0
singleline_comment|// Timer definitions(43.4.4 in the 802.3ad standard)
DECL|macro|AD_FAST_PERIODIC_TIME
mdefine_line|#define AD_FAST_PERIODIC_TIME      1
DECL|macro|AD_SLOW_PERIODIC_TIME
mdefine_line|#define AD_SLOW_PERIODIC_TIME      30
DECL|macro|AD_SHORT_TIMEOUT_TIME
mdefine_line|#define AD_SHORT_TIMEOUT_TIME      (3*AD_FAST_PERIODIC_TIME)
DECL|macro|AD_LONG_TIMEOUT_TIME
mdefine_line|#define AD_LONG_TIMEOUT_TIME       (3*AD_SLOW_PERIODIC_TIME)
DECL|macro|AD_CHURN_DETECTION_TIME
mdefine_line|#define AD_CHURN_DETECTION_TIME    60
DECL|macro|AD_AGGREGATE_WAIT_TIME
mdefine_line|#define AD_AGGREGATE_WAIT_TIME     2
singleline_comment|// Port state definitions(43.4.2.2 in the 802.3ad standard)
DECL|macro|AD_STATE_LACP_ACTIVITY
mdefine_line|#define AD_STATE_LACP_ACTIVITY   0x1
DECL|macro|AD_STATE_LACP_TIMEOUT
mdefine_line|#define AD_STATE_LACP_TIMEOUT    0x2
DECL|macro|AD_STATE_AGGREGATION
mdefine_line|#define AD_STATE_AGGREGATION     0x4
DECL|macro|AD_STATE_SYNCHRONIZATION
mdefine_line|#define AD_STATE_SYNCHRONIZATION 0x8
DECL|macro|AD_STATE_COLLECTING
mdefine_line|#define AD_STATE_COLLECTING      0x10
DECL|macro|AD_STATE_DISTRIBUTING
mdefine_line|#define AD_STATE_DISTRIBUTING    0x20
DECL|macro|AD_STATE_DEFAULTED
mdefine_line|#define AD_STATE_DEFAULTED       0x40
DECL|macro|AD_STATE_EXPIRED
mdefine_line|#define AD_STATE_EXPIRED         0x80
singleline_comment|// Port Variables definitions used by the State Machines(43.4.7 in the 802.3ad standard)
DECL|macro|AD_PORT_BEGIN
mdefine_line|#define AD_PORT_BEGIN           0x1
DECL|macro|AD_PORT_LACP_ENABLED
mdefine_line|#define AD_PORT_LACP_ENABLED    0x2
DECL|macro|AD_PORT_ACTOR_CHURN
mdefine_line|#define AD_PORT_ACTOR_CHURN     0x4
DECL|macro|AD_PORT_PARTNER_CHURN
mdefine_line|#define AD_PORT_PARTNER_CHURN   0x8
DECL|macro|AD_PORT_READY
mdefine_line|#define AD_PORT_READY           0x10
DECL|macro|AD_PORT_READY_N
mdefine_line|#define AD_PORT_READY_N         0x20
DECL|macro|AD_PORT_MATCHED
mdefine_line|#define AD_PORT_MATCHED         0x40
DECL|macro|AD_PORT_STANDBY
mdefine_line|#define AD_PORT_STANDBY         0x80
DECL|macro|AD_PORT_SELECTED
mdefine_line|#define AD_PORT_SELECTED        0x100
DECL|macro|AD_PORT_MOVED
mdefine_line|#define AD_PORT_MOVED           0x200
singleline_comment|// Port Key definitions
singleline_comment|// key is determined according to the link speed, duplex and
singleline_comment|// user key(which is yet not supported)
singleline_comment|//              ------------------------------------------------------------
singleline_comment|// Port key :   | User key                       |      Speed       |Duplex|
singleline_comment|//              ------------------------------------------------------------
singleline_comment|//              16                               6               1 0
DECL|macro|AD_DUPLEX_KEY_BITS
mdefine_line|#define  AD_DUPLEX_KEY_BITS    0x1
DECL|macro|AD_SPEED_KEY_BITS
mdefine_line|#define  AD_SPEED_KEY_BITS     0x3E
DECL|macro|AD_USER_KEY_BITS
mdefine_line|#define  AD_USER_KEY_BITS      0xFFC0
singleline_comment|//dalloun
DECL|macro|AD_LINK_SPEED_BITMASK_1MBPS
mdefine_line|#define     AD_LINK_SPEED_BITMASK_1MBPS       0x1
DECL|macro|AD_LINK_SPEED_BITMASK_10MBPS
mdefine_line|#define     AD_LINK_SPEED_BITMASK_10MBPS      0x2
DECL|macro|AD_LINK_SPEED_BITMASK_100MBPS
mdefine_line|#define     AD_LINK_SPEED_BITMASK_100MBPS     0x4
DECL|macro|AD_LINK_SPEED_BITMASK_1000MBPS
mdefine_line|#define     AD_LINK_SPEED_BITMASK_1000MBPS    0x8
singleline_comment|//endalloun
singleline_comment|// compare MAC addresses
DECL|macro|MAC_ADDRESS_COMPARE
mdefine_line|#define MAC_ADDRESS_COMPARE(A, B) memcmp(A, B, ETH_ALEN)
DECL|variable|null_mac_addr
r_static
r_struct
id|mac_addr
id|null_mac_addr
op_assign
(brace
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|ad_ticks_per_sec
r_static
id|u16
id|ad_ticks_per_sec
suffix:semicolon
singleline_comment|// ================= 3AD api to bonding and kernel code ==================
r_static
id|u16
id|__get_link_speed
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
id|u8
id|__get_duplex
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_inline
r_void
id|__initialize_port_locks
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_inline
r_void
id|__deinitialize_port_locks
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
singleline_comment|//conversions
r_static
r_void
id|__ntohs_lacpdu
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
)paren
suffix:semicolon
r_static
id|u16
id|__ad_timer_to_ticks
c_func
(paren
id|u16
id|timer_type
comma
id|u16
id|Par
)paren
suffix:semicolon
singleline_comment|// ================= ad code helper functions ==================
singleline_comment|//needed by ad_rx_machine(...)
r_static
r_void
id|__record_pdu
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|__record_default
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|__update_selected
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|__update_default_selected
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|__choose_matched
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|__update_ntt
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
singleline_comment|//needed for ad_mux_machine(..)
r_static
r_void
id|__attach_bond_to_agg
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|__detach_bond_from_agg
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|__agg_ports_are_ready
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
suffix:semicolon
r_static
r_void
id|__set_agg_ports_ready
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
comma
r_int
id|val
)paren
suffix:semicolon
singleline_comment|//needed for ad_agg_selection_logic(...)
r_static
id|u32
id|__get_agg_bandwidth
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
suffix:semicolon
r_static
r_struct
id|aggregator
op_star
id|__get_active_agg
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
suffix:semicolon
singleline_comment|// ================= main 802.3ad protocol functions ==================
r_static
r_int
id|ad_lacpdu_send
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|ad_marker_send
c_func
(paren
r_struct
id|port
op_star
id|port
comma
r_struct
id|marker
op_star
id|marker
)paren
suffix:semicolon
r_static
r_void
id|ad_mux_machine
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ad_rx_machine
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ad_tx_machine
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ad_periodic_machine
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ad_port_selection_logic
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ad_agg_selection_logic
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
suffix:semicolon
r_static
r_void
id|ad_clear_agg
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
suffix:semicolon
r_static
r_void
id|ad_initialize_agg
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
suffix:semicolon
r_static
r_void
id|ad_initialize_port
c_func
(paren
r_struct
id|port
op_star
id|port
comma
r_int
id|lacp_fast
)paren
suffix:semicolon
r_static
r_void
id|ad_initialize_lacpdu
c_func
(paren
r_struct
id|lacpdu
op_star
id|Lacpdu
)paren
suffix:semicolon
r_static
r_void
id|ad_enable_collecting_distributing
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ad_disable_collecting_distributing
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ad_marker_info_received
c_func
(paren
r_struct
id|marker
op_star
id|marker_info
comma
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ad_marker_response_received
c_func
(paren
r_struct
id|marker
op_star
id|marker
comma
r_struct
id|port
op_star
id|port
)paren
suffix:semicolon
singleline_comment|/////////////////////////////////////////////////////////////////////////////////
singleline_comment|// ================= api to bonding and kernel code ==================
singleline_comment|/////////////////////////////////////////////////////////////////////////////////
multiline_comment|/**&n; * __get_bond_by_port - get the port&squot;s bonding struct&n; * @port: the port we&squot;re looking at&n; *&n; * Return @port&squot;s bonding struct, or %NULL if it can&squot;t be found.&n; */
DECL|function|__get_bond_by_port
r_static
r_inline
r_struct
id|bonding
op_star
id|__get_bond_by_port
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;slave
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|bond_get_bond_by_slave
c_func
(paren
id|port-&gt;slave
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_first_port - get the first port in the bond&n; * @bond: the bond we&squot;re looking at&n; *&n; * Return the port of the first slave in @bond, or %NULL if it can&squot;t be found.&n; */
DECL|function|__get_first_port
r_static
r_inline
r_struct
id|port
op_star
id|__get_first_port
c_func
(paren
r_struct
id|bonding
op_star
id|bond
)paren
(brace
r_if
c_cond
(paren
id|bond-&gt;slave_cnt
op_eq
l_int|0
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|bond-&gt;first_slave
)paren
dot
id|port
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_next_port - get the next port in the bond&n; * @port: the port we&squot;re looking at&n; *&n; * Return the port of the slave that is next in line of @port&squot;s slave in the&n; * bond, or %NULL if it can&squot;t be found.&n; */
DECL|function|__get_next_port
r_static
r_inline
r_struct
id|port
op_star
id|__get_next_port
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|bonding
op_star
id|bond
op_assign
id|__get_bond_by_port
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|slave
op_star
id|slave
op_assign
id|port-&gt;slave
suffix:semicolon
singleline_comment|// If there&squot;s no bond for this port, or this is the last slave
r_if
c_cond
(paren
(paren
id|bond
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|slave-&gt;next
op_eq
id|bond-&gt;first_slave
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave-&gt;next
)paren
dot
id|port
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_first_agg - get the first aggregator in the bond&n; * @bond: the bond we&squot;re looking at&n; *&n; * Return the aggregator of the first slave in @bond, or %NULL if it can&squot;t be&n; * found.&n; */
DECL|function|__get_first_agg
r_static
r_inline
r_struct
id|aggregator
op_star
id|__get_first_agg
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|bonding
op_star
id|bond
op_assign
id|__get_bond_by_port
c_func
(paren
id|port
)paren
suffix:semicolon
singleline_comment|// If there&squot;s no bond for this port, or bond has no slaves
r_if
c_cond
(paren
(paren
id|bond
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|bond-&gt;slave_cnt
op_eq
l_int|0
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|bond-&gt;first_slave
)paren
dot
id|aggregator
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_next_agg - get the next aggregator in the bond&n; * @aggregator: the aggregator we&squot;re looking at&n; *&n; * Return the aggregator of the slave that is next in line of @aggregator&squot;s&n; * slave in the bond, or %NULL if it can&squot;t be found.&n; */
DECL|function|__get_next_agg
r_static
r_inline
r_struct
id|aggregator
op_star
id|__get_next_agg
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
(brace
r_struct
id|slave
op_star
id|slave
op_assign
id|aggregator-&gt;slave
suffix:semicolon
r_struct
id|bonding
op_star
id|bond
op_assign
id|bond_get_bond_by_slave
c_func
(paren
id|slave
)paren
suffix:semicolon
singleline_comment|// If there&squot;s no bond for this aggregator, or this is the last slave
r_if
c_cond
(paren
(paren
id|bond
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|slave-&gt;next
op_eq
id|bond-&gt;first_slave
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave-&gt;next
)paren
dot
id|aggregator
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __disable_port - disable the port&squot;s slave&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__disable_port
r_static
r_inline
r_void
id|__disable_port
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
id|bond_set_slave_inactive_flags
c_func
(paren
id|port-&gt;slave
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __enable_port - enable the port&squot;s slave, if it&squot;s up&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__enable_port
r_static
r_inline
r_void
id|__enable_port
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|slave
op_star
id|slave
op_assign
id|port-&gt;slave
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slave-&gt;link
op_eq
id|BOND_LINK_UP
)paren
op_logical_and
id|IS_UP
c_func
(paren
id|slave-&gt;dev
)paren
)paren
(brace
id|bond_set_slave_active_flags
c_func
(paren
id|slave
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * __port_is_enabled - check if the port&squot;s slave is in active state&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__port_is_enabled
r_static
r_inline
r_int
id|__port_is_enabled
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_return
id|port-&gt;slave-&gt;state
op_eq
id|BOND_STATE_ACTIVE
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_agg_selection_mode - get the aggregator selection mode&n; * @port: the port we&squot;re looking at&n; *&n; * Get the aggregator selection mode. Can be %BANDWIDTH or %COUNT.&n; */
DECL|function|__get_agg_selection_mode
r_static
r_inline
id|u32
id|__get_agg_selection_mode
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|bonding
op_star
id|bond
op_assign
id|__get_bond_by_port
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bond
op_eq
l_int|NULL
)paren
(brace
r_return
id|AD_BANDWIDTH
suffix:semicolon
)brace
r_return
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|agg_select_mode
suffix:semicolon
)brace
multiline_comment|/**&n; * __check_agg_selection_timer - check if the selection timer has expired&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__check_agg_selection_timer
r_static
r_inline
r_int
id|__check_agg_selection_timer
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|bonding
op_star
id|bond
op_assign
id|__get_bond_by_port
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bond
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|agg_select_timer
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_rx_machine_lock - lock the port&squot;s RX machine&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__get_rx_machine_lock
r_static
r_inline
r_void
id|__get_rx_machine_lock
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|port-&gt;slave
)paren
dot
id|rx_machine_lock
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __release_rx_machine_lock - unlock the port&squot;s RX machine&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__release_rx_machine_lock
r_static
r_inline
r_void
id|__release_rx_machine_lock
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|port-&gt;slave
)paren
dot
id|rx_machine_lock
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_link_speed - get a port&squot;s speed&n; * @port: the port we&squot;re looking at&n; *&n; * Return @port&squot;s speed in 802.3ad bitmask format. i.e. one of:&n; *     0,&n; *     %AD_LINK_SPEED_BITMASK_10MBPS,&n; *     %AD_LINK_SPEED_BITMASK_100MBPS,&n; *     %AD_LINK_SPEED_BITMASK_1000MBPS&n; */
DECL|function|__get_link_speed
r_static
id|u16
id|__get_link_speed
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|slave
op_star
id|slave
op_assign
id|port-&gt;slave
suffix:semicolon
id|u16
id|speed
suffix:semicolon
multiline_comment|/* this if covers only a special case: when the configuration starts with&n;&t; * link down, it sets the speed to 0.&n;&t; * This is done in spite of the fact that the e100 driver reports 0 to be&n;&t; * compatible with MVT in the future.*/
r_if
c_cond
(paren
id|slave-&gt;link
op_ne
id|BOND_LINK_UP
)paren
(brace
id|speed
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|slave-&gt;speed
)paren
(brace
r_case
id|SPEED_10
suffix:colon
id|speed
op_assign
id|AD_LINK_SPEED_BITMASK_10MBPS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPEED_100
suffix:colon
id|speed
op_assign
id|AD_LINK_SPEED_BITMASK_100MBPS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPEED_1000
suffix:colon
id|speed
op_assign
id|AD_LINK_SPEED_BITMASK_1000MBPS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|speed
op_assign
l_int|0
suffix:semicolon
singleline_comment|// unknown speed value from ethtool. shouldn&squot;t happen
r_break
suffix:semicolon
)brace
)brace
id|dprintk
c_func
(paren
l_string|&quot;Port %d Received link speed %d update from adapter&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|speed
)paren
suffix:semicolon
r_return
id|speed
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_duplex - get a port&squot;s duplex&n; * @port: the port we&squot;re looking at&n; *&n; * Return @port&squot;s duplex in 802.3ad bitmask format. i.e.:&n; *     0x01 if in full duplex&n; *     0x00 otherwise&n; */
DECL|function|__get_duplex
r_static
id|u8
id|__get_duplex
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|slave
op_star
id|slave
op_assign
id|port-&gt;slave
suffix:semicolon
id|u8
id|retval
suffix:semicolon
singleline_comment|//  handling a special case: when the configuration starts with
singleline_comment|// link down, it sets the duplex to 0.
r_if
c_cond
(paren
id|slave-&gt;link
op_ne
id|BOND_LINK_UP
)paren
(brace
id|retval
op_assign
l_int|0x0
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|slave-&gt;duplex
)paren
(brace
r_case
id|DUPLEX_FULL
suffix:colon
id|retval
op_assign
l_int|0x1
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Port %d Received status full duplex update from adapter&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DUPLEX_HALF
suffix:colon
r_default
suffix:colon
id|retval
op_assign
l_int|0x0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Port %d Received status NOT full duplex update from adapter&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * __initialize_port_locks - initialize a port&squot;s RX machine spinlock&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__initialize_port_locks
r_static
r_inline
r_void
id|__initialize_port_locks
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
singleline_comment|// make sure it isn&squot;t called twice
id|spin_lock_init
c_func
(paren
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|port-&gt;slave
)paren
dot
id|rx_machine_lock
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * __deinitialize_port_locks - deinitialize a port&squot;s RX machine spinlock&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__deinitialize_port_locks
r_static
r_inline
r_void
id|__deinitialize_port_locks
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
)brace
singleline_comment|//conversions
multiline_comment|/**&n; * __ntohs_lacpdu - convert the contents of a LACPDU to host byte order&n; * @lacpdu: the speicifed lacpdu&n; *&n; * For each multi-byte field in the lacpdu, convert its content&n; */
DECL|function|__ntohs_lacpdu
r_static
r_void
id|__ntohs_lacpdu
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
)paren
(brace
r_if
c_cond
(paren
id|lacpdu
)paren
(brace
id|lacpdu-&gt;actor_system_priority
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;actor_system_priority
)paren
suffix:semicolon
id|lacpdu-&gt;actor_key
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;actor_key
)paren
suffix:semicolon
id|lacpdu-&gt;actor_port_priority
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;actor_port_priority
)paren
suffix:semicolon
id|lacpdu-&gt;actor_port
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;actor_port
)paren
suffix:semicolon
id|lacpdu-&gt;partner_system_priority
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;partner_system_priority
)paren
suffix:semicolon
id|lacpdu-&gt;partner_key
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;partner_key
)paren
suffix:semicolon
id|lacpdu-&gt;partner_port_priority
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;partner_port_priority
)paren
suffix:semicolon
id|lacpdu-&gt;partner_port
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;partner_port
)paren
suffix:semicolon
id|lacpdu-&gt;collector_max_delay
op_assign
id|ntohs
c_func
(paren
id|lacpdu-&gt;collector_max_delay
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * __ad_timer_to_ticks - convert a given timer type to AD module ticks&n; * @timer_type:&t;which timer to operate&n; * @par: timer parameter. see below&n; *&n; * If @timer_type is %current_while_timer, @par indicates long/short timer.&n; * If @timer_type is %periodic_timer, @par is one of %FAST_PERIODIC_TIME,&n; *&t;&t;&t;&t;&t;&t;    %SLOW_PERIODIC_TIME.&n; */
DECL|function|__ad_timer_to_ticks
r_static
id|u16
id|__ad_timer_to_ticks
c_func
(paren
id|u16
id|timer_type
comma
id|u16
id|par
)paren
(brace
id|u16
id|retval
op_assign
l_int|0
suffix:semicolon
singleline_comment|//to silence the compiler
r_switch
c_cond
(paren
id|timer_type
)paren
(brace
r_case
id|AD_CURRENT_WHILE_TIMER
suffix:colon
singleline_comment|// for rx machine usage
r_if
c_cond
(paren
id|par
)paren
(brace
singleline_comment|// for short or long timeout
id|retval
op_assign
(paren
id|AD_SHORT_TIMEOUT_TIME
op_star
id|ad_ticks_per_sec
)paren
suffix:semicolon
singleline_comment|// short timeout
)brace
r_else
(brace
id|retval
op_assign
(paren
id|AD_LONG_TIMEOUT_TIME
op_star
id|ad_ticks_per_sec
)paren
suffix:semicolon
singleline_comment|// long timeout
)brace
r_break
suffix:semicolon
r_case
id|AD_ACTOR_CHURN_TIMER
suffix:colon
singleline_comment|// for local churn machine
id|retval
op_assign
(paren
id|AD_CHURN_DETECTION_TIME
op_star
id|ad_ticks_per_sec
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_PERIODIC_TIMER
suffix:colon
singleline_comment|// for periodic machine
id|retval
op_assign
(paren
id|par
op_star
id|ad_ticks_per_sec
)paren
suffix:semicolon
singleline_comment|// long timeout
r_break
suffix:semicolon
r_case
id|AD_PARTNER_CHURN_TIMER
suffix:colon
singleline_comment|// for remote churn machine
id|retval
op_assign
(paren
id|AD_CHURN_DETECTION_TIME
op_star
id|ad_ticks_per_sec
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_WAIT_WHILE_TIMER
suffix:colon
singleline_comment|// for selection machine
id|retval
op_assign
(paren
id|AD_AGGREGATE_WAIT_TIME
op_star
id|ad_ticks_per_sec
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
singleline_comment|/////////////////////////////////////////////////////////////////////////////////
singleline_comment|// ================= ad_rx_machine helper functions ==================
singleline_comment|/////////////////////////////////////////////////////////////////////////////////
multiline_comment|/**&n; * __record_pdu - record parameters from a received lacpdu&n; * @lacpdu: the lacpdu we&squot;ve received&n; * @port: the port we&squot;re looking at&n; *&n; * Record the parameter values for the Actor carried in a received lacpdu as&n; * the current partner operational parameter values and sets&n; * actor_oper_port_state.defaulted to FALSE.&n; */
DECL|function|__record_pdu
r_static
r_void
id|__record_pdu
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
(brace
singleline_comment|// validate lacpdu and port
r_if
c_cond
(paren
id|lacpdu
op_logical_and
id|port
)paren
(brace
singleline_comment|// record the new parameter values for the partner operational
id|port-&gt;partner_oper_port_number
op_assign
id|lacpdu-&gt;actor_port
suffix:semicolon
id|port-&gt;partner_oper_port_priority
op_assign
id|lacpdu-&gt;actor_port_priority
suffix:semicolon
id|port-&gt;partner_oper_system
op_assign
id|lacpdu-&gt;actor_system
suffix:semicolon
id|port-&gt;partner_oper_system_priority
op_assign
id|lacpdu-&gt;actor_system_priority
suffix:semicolon
id|port-&gt;partner_oper_key
op_assign
id|lacpdu-&gt;actor_key
suffix:semicolon
singleline_comment|// zero partener&squot;s lase states
id|port-&gt;partner_oper_port_state
op_assign
l_int|0
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_LACP_ACTIVITY
)paren
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_LACP_TIMEOUT
)paren
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_AGGREGATION
)paren
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_SYNCHRONIZATION
)paren
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_COLLECTING
)paren
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_DISTRIBUTING
)paren
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_DEFAULTED
)paren
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_EXPIRED
)paren
suffix:semicolon
singleline_comment|// set actor_oper_port_state.defaulted to FALSE
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_DEFAULTED
suffix:semicolon
singleline_comment|// set the partner sync. to on if the partner is sync. and the port is matched
r_if
c_cond
(paren
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_MATCHED
)paren
op_logical_and
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_SYNCHRONIZATION
)paren
)paren
(brace
id|port-&gt;partner_oper_port_state
op_or_assign
id|AD_STATE_SYNCHRONIZATION
suffix:semicolon
)brace
r_else
(brace
id|port-&gt;partner_oper_port_state
op_and_assign
op_complement
id|AD_STATE_SYNCHRONIZATION
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * __record_default - record default parameters&n; * @port: the port we&squot;re looking at&n; *&n; * This function records the default parameter values for the partner carried&n; * in the Partner Admin parameters as the current partner operational parameter&n; * values and sets actor_oper_port_state.defaulted to TRUE.&n; */
DECL|function|__record_default
r_static
r_void
id|__record_default
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
singleline_comment|// validate the port
r_if
c_cond
(paren
id|port
)paren
(brace
singleline_comment|// record the partner admin parameters
id|port-&gt;partner_oper_port_number
op_assign
id|port-&gt;partner_admin_port_number
suffix:semicolon
id|port-&gt;partner_oper_port_priority
op_assign
id|port-&gt;partner_admin_port_priority
suffix:semicolon
id|port-&gt;partner_oper_system
op_assign
id|port-&gt;partner_admin_system
suffix:semicolon
id|port-&gt;partner_oper_system_priority
op_assign
id|port-&gt;partner_admin_system_priority
suffix:semicolon
id|port-&gt;partner_oper_key
op_assign
id|port-&gt;partner_admin_key
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_assign
id|port-&gt;partner_admin_port_state
suffix:semicolon
singleline_comment|// set actor_oper_port_state.defaulted to true
id|port-&gt;actor_oper_port_state
op_or_assign
id|AD_STATE_DEFAULTED
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * __update_selected - update a port&squot;s Selected variable from a received lacpdu&n; * @lacpdu: the lacpdu we&squot;ve received&n; * @port: the port we&squot;re looking at&n; *&n; * Update the value of the selected variable, using parameter values from a&n; * newly received lacpdu. The parameter values for the Actor carried in the&n; * received PDU are compared with the corresponding operational parameter&n; * values for the ports partner. If one or more of the comparisons shows that&n; * the value(s) received in the PDU differ from the current operational values,&n; * then selected is set to FALSE and actor_oper_port_state.synchronization is&n; * set to out_of_sync. Otherwise, selected remains unchanged.&n; */
DECL|function|__update_selected
r_static
r_void
id|__update_selected
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
(brace
singleline_comment|// validate lacpdu and port
r_if
c_cond
(paren
id|lacpdu
op_logical_and
id|port
)paren
(brace
singleline_comment|// check if any parameter is different
r_if
c_cond
(paren
(paren
id|lacpdu-&gt;actor_port
op_ne
id|port-&gt;partner_oper_port_number
)paren
op_logical_or
(paren
id|lacpdu-&gt;actor_port_priority
op_ne
id|port-&gt;partner_oper_port_priority
)paren
op_logical_or
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|lacpdu-&gt;actor_system
)paren
comma
op_amp
(paren
id|port-&gt;partner_oper_system
)paren
)paren
op_logical_or
(paren
id|lacpdu-&gt;actor_system_priority
op_ne
id|port-&gt;partner_oper_system_priority
)paren
op_logical_or
(paren
id|lacpdu-&gt;actor_key
op_ne
id|port-&gt;partner_oper_key
)paren
op_logical_or
(paren
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_AGGREGATION
)paren
op_ne
(paren
id|port-&gt;partner_oper_port_state
op_amp
id|AD_STATE_AGGREGATION
)paren
)paren
)paren
(brace
singleline_comment|// update the state machine Selected variable
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_SELECTED
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * __update_default_selected - update a port&squot;s Selected variable from Partner&n; * @port: the port we&squot;re looking at&n; *&n; * This function updates the value of the selected variable, using the partner&n; * administrative parameter values. The administrative values are compared with&n; * the corresponding operational parameter values for the partner. If one or&n; * more of the comparisons shows that the administrative value(s) differ from&n; * the current operational values, then Selected is set to FALSE and&n; * actor_oper_port_state.synchronization is set to OUT_OF_SYNC. Otherwise,&n; * Selected remains unchanged.&n; */
DECL|function|__update_default_selected
r_static
r_void
id|__update_default_selected
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
singleline_comment|// validate the port
r_if
c_cond
(paren
id|port
)paren
(brace
singleline_comment|// check if any parameter is different
r_if
c_cond
(paren
(paren
id|port-&gt;partner_admin_port_number
op_ne
id|port-&gt;partner_oper_port_number
)paren
op_logical_or
(paren
id|port-&gt;partner_admin_port_priority
op_ne
id|port-&gt;partner_oper_port_priority
)paren
op_logical_or
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|port-&gt;partner_admin_system
)paren
comma
op_amp
(paren
id|port-&gt;partner_oper_system
)paren
)paren
op_logical_or
(paren
id|port-&gt;partner_admin_system_priority
op_ne
id|port-&gt;partner_oper_system_priority
)paren
op_logical_or
(paren
id|port-&gt;partner_admin_key
op_ne
id|port-&gt;partner_oper_key
)paren
op_logical_or
(paren
(paren
id|port-&gt;partner_admin_port_state
op_amp
id|AD_STATE_AGGREGATION
)paren
op_ne
(paren
id|port-&gt;partner_oper_port_state
op_amp
id|AD_STATE_AGGREGATION
)paren
)paren
)paren
(brace
singleline_comment|// update the state machine Selected variable
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_SELECTED
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * __choose_matched - update a port&squot;s matched variable from a received lacpdu&n; * @lacpdu: the lacpdu we&squot;ve received&n; * @port: the port we&squot;re looking at&n; *&n; * Update the value of the matched variable, using parameter values from a&n; * newly received lacpdu. Parameter values for the partner carried in the&n; * received PDU are compared with the corresponding operational parameter&n; * values for the actor. Matched is set to TRUE if all of these parameters&n; * match and the PDU parameter partner_state.aggregation has the same value as&n; * actor_oper_port_state.aggregation and lacp will actively maintain the link&n; * in the aggregation. Matched is also set to TRUE if the value of&n; * actor_state.aggregation in the received PDU is set to FALSE, i.e., indicates&n; * an individual link and lacp will actively maintain the link. Otherwise,&n; * matched is set to FALSE. LACP is considered to be actively maintaining the&n; * link if either the PDU&squot;s actor_state.lacp_activity variable is TRUE or both&n; * the actor&squot;s actor_oper_port_state.lacp_activity and the PDU&squot;s&n; * partner_state.lacp_activity variables are TRUE.&n; */
DECL|function|__choose_matched
r_static
r_void
id|__choose_matched
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
(brace
singleline_comment|// validate lacpdu and port
r_if
c_cond
(paren
id|lacpdu
op_logical_and
id|port
)paren
(brace
singleline_comment|// check if all parameters are alike
r_if
c_cond
(paren
(paren
(paren
id|lacpdu-&gt;partner_port
op_eq
id|port-&gt;actor_port_number
)paren
op_logical_and
(paren
id|lacpdu-&gt;partner_port_priority
op_eq
id|port-&gt;actor_port_priority
)paren
op_logical_and
op_logical_neg
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|lacpdu-&gt;partner_system
)paren
comma
op_amp
(paren
id|port-&gt;actor_system
)paren
)paren
op_logical_and
(paren
id|lacpdu-&gt;partner_system_priority
op_eq
id|port-&gt;actor_system_priority
)paren
op_logical_and
(paren
id|lacpdu-&gt;partner_key
op_eq
id|port-&gt;actor_oper_port_key
)paren
op_logical_and
(paren
(paren
id|lacpdu-&gt;partner_state
op_amp
id|AD_STATE_AGGREGATION
)paren
op_eq
(paren
id|port-&gt;actor_oper_port_state
op_amp
id|AD_STATE_AGGREGATION
)paren
)paren
)paren
op_logical_or
singleline_comment|// or this is individual link(aggregation == FALSE)
(paren
(paren
id|lacpdu-&gt;actor_state
op_amp
id|AD_STATE_AGGREGATION
)paren
op_eq
l_int|0
)paren
)paren
(brace
singleline_comment|// update the state machine Matched variable
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_MATCHED
suffix:semicolon
)brace
r_else
(brace
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_MATCHED
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * __update_ntt - update a port&squot;s ntt variable from a received lacpdu&n; * @lacpdu: the lacpdu we&squot;ve received&n; * @port: the port we&squot;re looking at&n; *&n; * Updates the value of the ntt variable, using parameter values from a newly&n; * received lacpdu. The parameter values for the partner carried in the&n; * received PDU are compared with the corresponding operational parameter&n; * values for the Actor. If one or more of the comparisons shows that the&n; * value(s) received in the PDU differ from the current operational values,&n; * then ntt is set to TRUE. Otherwise, ntt remains unchanged.&n; */
DECL|function|__update_ntt
r_static
r_void
id|__update_ntt
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
(brace
singleline_comment|// validate lacpdu and port
r_if
c_cond
(paren
id|lacpdu
op_logical_and
id|port
)paren
(brace
singleline_comment|// check if any parameter is different
r_if
c_cond
(paren
(paren
id|lacpdu-&gt;partner_port
op_ne
id|port-&gt;actor_port_number
)paren
op_logical_or
(paren
id|lacpdu-&gt;partner_port_priority
op_ne
id|port-&gt;actor_port_priority
)paren
op_logical_or
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|lacpdu-&gt;partner_system
)paren
comma
op_amp
(paren
id|port-&gt;actor_system
)paren
)paren
op_logical_or
(paren
id|lacpdu-&gt;partner_system_priority
op_ne
id|port-&gt;actor_system_priority
)paren
op_logical_or
(paren
id|lacpdu-&gt;partner_key
op_ne
id|port-&gt;actor_oper_port_key
)paren
op_logical_or
(paren
(paren
id|lacpdu-&gt;partner_state
op_amp
id|AD_STATE_LACP_ACTIVITY
)paren
op_ne
(paren
id|port-&gt;actor_oper_port_state
op_amp
id|AD_STATE_LACP_ACTIVITY
)paren
)paren
op_logical_or
(paren
(paren
id|lacpdu-&gt;partner_state
op_amp
id|AD_STATE_LACP_TIMEOUT
)paren
op_ne
(paren
id|port-&gt;actor_oper_port_state
op_amp
id|AD_STATE_LACP_TIMEOUT
)paren
)paren
op_logical_or
(paren
(paren
id|lacpdu-&gt;partner_state
op_amp
id|AD_STATE_SYNCHRONIZATION
)paren
op_ne
(paren
id|port-&gt;actor_oper_port_state
op_amp
id|AD_STATE_SYNCHRONIZATION
)paren
)paren
op_logical_or
(paren
(paren
id|lacpdu-&gt;partner_state
op_amp
id|AD_STATE_AGGREGATION
)paren
op_ne
(paren
id|port-&gt;actor_oper_port_state
op_amp
id|AD_STATE_AGGREGATION
)paren
)paren
)paren
(brace
singleline_comment|// set ntt to be TRUE
id|port-&gt;ntt
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * __attach_bond_to_agg&n; * @port: the port we&squot;re looking at&n; *&n; * Handle the attaching of the port&squot;s control parser/multiplexer and the&n; * aggregator. This function does nothing since the parser/multiplexer of the&n; * receive and the parser/multiplexer of the aggregator are already combined.&n; */
DECL|function|__attach_bond_to_agg
r_static
r_void
id|__attach_bond_to_agg
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
id|port
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// just to satisfy the compiler
singleline_comment|// This function does nothing since the parser/multiplexer of the receive
singleline_comment|// and the parser/multiplexer of the aggregator are already combined
)brace
multiline_comment|/**&n; * __detach_bond_from_agg&n; * @port: the port we&squot;re looking at&n; *&n; * Handle the detaching of the port&squot;s control parser/multiplexer from the&n; * aggregator. This function does nothing since the parser/multiplexer of the&n; * receive and the parser/multiplexer of the aggregator are already combined.&n; */
DECL|function|__detach_bond_from_agg
r_static
r_void
id|__detach_bond_from_agg
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
id|port
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// just to satisfy the compiler
singleline_comment|// This function does nothing sience the parser/multiplexer of the receive
singleline_comment|// and the parser/multiplexer of the aggregator are already combined
)brace
multiline_comment|/**&n; * __agg_ports_are_ready - check if all ports in an aggregator are ready&n; * @aggregator: the aggregator we&squot;re looking at&n; *&n; */
DECL|function|__agg_ports_are_ready
r_static
r_int
id|__agg_ports_are_ready
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
(brace
r_struct
id|port
op_star
id|port
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|aggregator
)paren
(brace
singleline_comment|// scan all ports in this aggregator to verfy if they are all ready
r_for
c_loop
(paren
id|port
op_assign
id|aggregator-&gt;lag_ports
suffix:semicolon
id|port
suffix:semicolon
id|port
op_assign
id|port-&gt;next_port_in_aggregator
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_READY_N
)paren
)paren
(brace
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * __set_agg_ports_ready - set value of Ready bit in all ports of an aggregator&n; * @aggregator: the aggregator we&squot;re looking at&n; * @val: Should the ports&squot; ready bit be set on or off&n; *&n; */
DECL|function|__set_agg_ports_ready
r_static
r_void
id|__set_agg_ports_ready
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
comma
r_int
id|val
)paren
(brace
r_struct
id|port
op_star
id|port
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|aggregator-&gt;lag_ports
suffix:semicolon
id|port
suffix:semicolon
id|port
op_assign
id|port-&gt;next_port_in_aggregator
)paren
(brace
r_if
c_cond
(paren
id|val
)paren
(brace
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_READY
suffix:semicolon
)brace
r_else
(brace
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_READY
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * __get_agg_bandwidth - get the total bandwidth of an aggregator&n; * @aggregator: the aggregator we&squot;re looking at&n; *&n; */
DECL|function|__get_agg_bandwidth
r_static
id|u32
id|__get_agg_bandwidth
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
(brace
id|u32
id|bandwidth
op_assign
l_int|0
suffix:semicolon
id|u32
id|basic_speed
suffix:semicolon
r_if
c_cond
(paren
id|aggregator-&gt;num_of_ports
)paren
(brace
id|basic_speed
op_assign
id|__get_link_speed
c_func
(paren
id|aggregator-&gt;lag_ports
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|basic_speed
)paren
(brace
r_case
id|AD_LINK_SPEED_BITMASK_1MBPS
suffix:colon
id|bandwidth
op_assign
id|aggregator-&gt;num_of_ports
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_LINK_SPEED_BITMASK_10MBPS
suffix:colon
id|bandwidth
op_assign
id|aggregator-&gt;num_of_ports
op_star
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_LINK_SPEED_BITMASK_100MBPS
suffix:colon
id|bandwidth
op_assign
id|aggregator-&gt;num_of_ports
op_star
l_int|100
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_LINK_SPEED_BITMASK_1000MBPS
suffix:colon
id|bandwidth
op_assign
id|aggregator-&gt;num_of_ports
op_star
l_int|1000
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|bandwidth
op_assign
l_int|0
suffix:semicolon
singleline_comment|// to silent the compilor ....
)brace
)brace
r_return
id|bandwidth
suffix:semicolon
)brace
multiline_comment|/**&n; * __get_active_agg - get the current active aggregator&n; * @aggregator: the aggregator we&squot;re looking at&n; *&n; */
DECL|function|__get_active_agg
r_static
r_struct
id|aggregator
op_star
id|__get_active_agg
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
(brace
r_struct
id|aggregator
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|aggregator
suffix:semicolon
id|aggregator
op_assign
id|__get_next_agg
c_func
(paren
id|aggregator
)paren
)paren
(brace
r_if
c_cond
(paren
id|aggregator-&gt;is_active
)paren
(brace
id|retval
op_assign
id|aggregator
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * __update_lacpdu_from_port - update a port&squot;s lacpdu fields&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|__update_lacpdu_from_port
r_static
r_inline
r_void
id|__update_lacpdu_from_port
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|lacpdu
op_star
id|lacpdu
op_assign
op_amp
id|port-&gt;lacpdu
suffix:semicolon
multiline_comment|/* update current actual Actor parameters */
multiline_comment|/* lacpdu-&gt;subtype                   initialized&n;&t; * lacpdu-&gt;version_number            initialized&n;&t; * lacpdu-&gt;tlv_type_actor_info       initialized&n;&t; * lacpdu-&gt;actor_information_length  initialized&n;&t; */
id|lacpdu-&gt;actor_system_priority
op_assign
id|port-&gt;actor_system_priority
suffix:semicolon
id|lacpdu-&gt;actor_system
op_assign
id|port-&gt;actor_system
suffix:semicolon
id|lacpdu-&gt;actor_key
op_assign
id|port-&gt;actor_oper_port_key
suffix:semicolon
id|lacpdu-&gt;actor_port_priority
op_assign
id|port-&gt;actor_port_priority
suffix:semicolon
id|lacpdu-&gt;actor_port
op_assign
id|port-&gt;actor_port_number
suffix:semicolon
id|lacpdu-&gt;actor_state
op_assign
id|port-&gt;actor_oper_port_state
suffix:semicolon
multiline_comment|/* lacpdu-&gt;reserved_3_1              initialized&n;&t; * lacpdu-&gt;tlv_type_partner_info     initialized&n;&t; * lacpdu-&gt;partner_information_length initialized&n;&t; */
id|lacpdu-&gt;partner_system_priority
op_assign
id|port-&gt;partner_oper_system_priority
suffix:semicolon
id|lacpdu-&gt;partner_system
op_assign
id|port-&gt;partner_oper_system
suffix:semicolon
id|lacpdu-&gt;partner_key
op_assign
id|port-&gt;partner_oper_key
suffix:semicolon
id|lacpdu-&gt;partner_port_priority
op_assign
id|port-&gt;partner_oper_port_priority
suffix:semicolon
id|lacpdu-&gt;partner_port
op_assign
id|port-&gt;partner_oper_port_number
suffix:semicolon
id|lacpdu-&gt;partner_state
op_assign
id|port-&gt;partner_oper_port_state
suffix:semicolon
multiline_comment|/* lacpdu-&gt;reserved_3_2              initialized&n;&t; * lacpdu-&gt;tlv_type_collector_info   initialized&n;&t; * lacpdu-&gt;collector_information_length initialized&n;&t; * collector_max_delay                initialized&n;&t; * reserved_12[12]                   initialized&n;&t; * tlv_type_terminator               initialized&n;&t; * terminator_length                 initialized&n;&t; * reserved_50[50]                   initialized&n;&t; */
multiline_comment|/* Convert all non u8 parameters to Big Endian for transmit */
id|__ntohs_lacpdu
c_func
(paren
id|lacpdu
)paren
suffix:semicolon
)brace
singleline_comment|//////////////////////////////////////////////////////////////////////////////////////
singleline_comment|// ================= main 802.3ad protocol code ======================================
singleline_comment|//////////////////////////////////////////////////////////////////////////////////////
multiline_comment|/**&n; * ad_lacpdu_send - send out a lacpdu packet on a given port&n; * @port: the port we&squot;re looking at&n; *&n; * Returns:   0 on success&n; *          &lt; 0 on error&n; */
DECL|function|ad_lacpdu_send
r_static
r_int
id|ad_lacpdu_send
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|slave
op_star
id|slave
op_assign
id|port-&gt;slave
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|lacpdu_header
op_star
id|lacpdu_header
suffix:semicolon
r_int
id|length
op_assign
r_sizeof
(paren
r_struct
id|lacpdu_header
)paren
suffix:semicolon
r_struct
id|mac_addr
id|lacpdu_multicast_address
op_assign
id|AD_MULTICAST_LACPDU_ADDR
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|slave-&gt;dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|skb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|PKT_TYPE_LACPDU
suffix:semicolon
id|skb-&gt;priority
op_assign
id|TC_PRIO_CONTROL
suffix:semicolon
id|lacpdu_header
op_assign
(paren
r_struct
id|lacpdu_header
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|lacpdu_header-&gt;ad_header.destination_address
op_assign
id|lacpdu_multicast_address
suffix:semicolon
multiline_comment|/* Note: source addres is set to be the member&squot;s PERMANENT address, because we use it&n;&t;   to identify loopback lacpdus in receive. */
id|lacpdu_header-&gt;ad_header.source_address
op_assign
op_star
(paren
(paren
r_struct
id|mac_addr
op_star
)paren
(paren
id|slave-&gt;perm_hwaddr
)paren
)paren
suffix:semicolon
id|lacpdu_header-&gt;ad_header.length_type
op_assign
id|PKT_TYPE_LACPDU
suffix:semicolon
id|lacpdu_header-&gt;lacpdu
op_assign
id|port-&gt;lacpdu
suffix:semicolon
singleline_comment|// struct copy
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ad_marker_send - send marker information/response on a given port&n; * @port: the port we&squot;re looking at&n; * @marker: marker data to send&n; *&n; * Returns:   0 on success&n; *          &lt; 0 on error&n; */
DECL|function|ad_marker_send
r_static
r_int
id|ad_marker_send
c_func
(paren
r_struct
id|port
op_star
id|port
comma
r_struct
id|marker
op_star
id|marker
)paren
(brace
r_struct
id|slave
op_star
id|slave
op_assign
id|port-&gt;slave
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|marker_header
op_star
id|marker_header
suffix:semicolon
r_int
id|length
op_assign
r_sizeof
(paren
r_struct
id|marker_header
)paren
suffix:semicolon
r_struct
id|mac_addr
id|lacpdu_multicast_address
op_assign
id|AD_MULTICAST_LACPDU_ADDR
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|length
op_plus
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|16
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|slave-&gt;dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|skb-&gt;data
op_plus
id|ETH_HLEN
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|PKT_TYPE_LACPDU
suffix:semicolon
id|marker_header
op_assign
(paren
r_struct
id|marker_header
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|marker_header-&gt;ad_header.destination_address
op_assign
id|lacpdu_multicast_address
suffix:semicolon
multiline_comment|/* Note: source addres is set to be the member&squot;s PERMANENT address, because we use it&n;&t;   to identify loopback MARKERs in receive. */
id|marker_header-&gt;ad_header.source_address
op_assign
op_star
(paren
(paren
r_struct
id|mac_addr
op_star
)paren
(paren
id|slave-&gt;perm_hwaddr
)paren
)paren
suffix:semicolon
id|marker_header-&gt;ad_header.length_type
op_assign
id|PKT_TYPE_LACPDU
suffix:semicolon
id|marker_header-&gt;marker
op_assign
op_star
id|marker
suffix:semicolon
singleline_comment|// struct copy
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ad_mux_machine - handle a port&squot;s mux state machine&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|ad_mux_machine
r_static
r_void
id|ad_mux_machine
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
id|mux_states_t
id|last_state
suffix:semicolon
singleline_comment|// keep current State Machine state to compare later if it was changed
id|last_state
op_assign
id|port-&gt;sm_mux_state
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_BEGIN
)paren
(brace
id|port-&gt;sm_mux_state
op_assign
id|AD_MUX_DETACHED
suffix:semicolon
singleline_comment|// next state
)brace
r_else
(brace
r_switch
c_cond
(paren
id|port-&gt;sm_mux_state
)paren
(brace
r_case
id|AD_MUX_DETACHED
suffix:colon
r_if
c_cond
(paren
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_SELECTED
)paren
op_logical_or
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_STANDBY
)paren
)paren
(brace
singleline_comment|// if SELECTED or STANDBY
id|port-&gt;sm_mux_state
op_assign
id|AD_MUX_WAITING
suffix:semicolon
singleline_comment|// next state
)brace
r_break
suffix:semicolon
r_case
id|AD_MUX_WAITING
suffix:colon
singleline_comment|// if SELECTED == FALSE return to DETACH state
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_SELECTED
)paren
)paren
(brace
singleline_comment|// if UNSELECTED
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_READY_N
suffix:semicolon
singleline_comment|// in order to withhold the Selection Logic to check all ports READY_N value
singleline_comment|// every callback cycle to update ready variable, we check READY_N and update READY here
id|__set_agg_ports_ready
c_func
(paren
id|port-&gt;aggregator
comma
id|__agg_ports_are_ready
c_func
(paren
id|port-&gt;aggregator
)paren
)paren
suffix:semicolon
id|port-&gt;sm_mux_state
op_assign
id|AD_MUX_DETACHED
suffix:semicolon
singleline_comment|// next state
r_break
suffix:semicolon
)brace
singleline_comment|// check if the wait_while_timer expired
r_if
c_cond
(paren
id|port-&gt;sm_mux_timer_counter
op_logical_and
op_logical_neg
(paren
op_decrement
id|port-&gt;sm_mux_timer_counter
)paren
)paren
(brace
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_READY_N
suffix:semicolon
)brace
singleline_comment|// in order to withhold the selection logic to check all ports READY_N value
singleline_comment|// every callback cycle to update ready variable, we check READY_N and update READY here
id|__set_agg_ports_ready
c_func
(paren
id|port-&gt;aggregator
comma
id|__agg_ports_are_ready
c_func
(paren
id|port-&gt;aggregator
)paren
)paren
suffix:semicolon
singleline_comment|// if the wait_while_timer expired, and the port is in READY state, move to ATTACHED state
r_if
c_cond
(paren
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_READY
)paren
op_logical_and
op_logical_neg
id|port-&gt;sm_mux_timer_counter
)paren
(brace
id|port-&gt;sm_mux_state
op_assign
id|AD_MUX_ATTACHED
suffix:semicolon
singleline_comment|// next state
)brace
r_break
suffix:semicolon
r_case
id|AD_MUX_ATTACHED
suffix:colon
singleline_comment|// check also if agg_select_timer expired(so the edable port will take place only after this timer)
r_if
c_cond
(paren
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_SELECTED
)paren
op_logical_and
(paren
id|port-&gt;partner_oper_port_state
op_amp
id|AD_STATE_SYNCHRONIZATION
)paren
op_logical_and
op_logical_neg
id|__check_agg_selection_timer
c_func
(paren
id|port
)paren
)paren
(brace
id|port-&gt;sm_mux_state
op_assign
id|AD_MUX_COLLECTING_DISTRIBUTING
suffix:semicolon
singleline_comment|// next state
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_SELECTED
)paren
op_logical_or
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_STANDBY
)paren
)paren
(brace
singleline_comment|// if UNSELECTED or STANDBY
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_READY_N
suffix:semicolon
singleline_comment|// in order to withhold the selection logic to check all ports READY_N value
singleline_comment|// every callback cycle to update ready variable, we check READY_N and update READY here
id|__set_agg_ports_ready
c_func
(paren
id|port-&gt;aggregator
comma
id|__agg_ports_are_ready
c_func
(paren
id|port-&gt;aggregator
)paren
)paren
suffix:semicolon
id|port-&gt;sm_mux_state
op_assign
id|AD_MUX_DETACHED
suffix:semicolon
singleline_comment|// next state
)brace
r_break
suffix:semicolon
r_case
id|AD_MUX_COLLECTING_DISTRIBUTING
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_SELECTED
)paren
op_logical_or
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_STANDBY
)paren
op_logical_or
op_logical_neg
(paren
id|port-&gt;partner_oper_port_state
op_amp
id|AD_STATE_SYNCHRONIZATION
)paren
)paren
(brace
id|port-&gt;sm_mux_state
op_assign
id|AD_MUX_ATTACHED
suffix:semicolon
singleline_comment|// next state
)brace
r_else
(brace
singleline_comment|// if port state hasn&squot;t changed make
singleline_comment|// sure that a collecting distributing
singleline_comment|// port in an active aggregator is enabled
r_if
c_cond
(paren
id|port-&gt;aggregator
op_logical_and
id|port-&gt;aggregator-&gt;is_active
op_logical_and
op_logical_neg
id|__port_is_enabled
c_func
(paren
id|port
)paren
)paren
(brace
id|__enable_port
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|//to silence the compiler
r_break
suffix:semicolon
)brace
)brace
singleline_comment|// check if the state machine was changed
r_if
c_cond
(paren
id|port-&gt;sm_mux_state
op_ne
id|last_state
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Mux Machine: Port=%d, Last State=%d, Curr State=%d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|last_state
comma
id|port-&gt;sm_mux_state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;sm_mux_state
)paren
(brace
r_case
id|AD_MUX_DETACHED
suffix:colon
id|__detach_bond_from_agg
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_SYNCHRONIZATION
suffix:semicolon
id|ad_disable_collecting_distributing
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_COLLECTING
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_DISTRIBUTING
suffix:semicolon
id|port-&gt;ntt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_MUX_WAITING
suffix:colon
id|port-&gt;sm_mux_timer_counter
op_assign
id|__ad_timer_to_ticks
c_func
(paren
id|AD_WAIT_WHILE_TIMER
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_MUX_ATTACHED
suffix:colon
id|__attach_bond_to_agg
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_or_assign
id|AD_STATE_SYNCHRONIZATION
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_COLLECTING
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_DISTRIBUTING
suffix:semicolon
id|ad_disable_collecting_distributing
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;ntt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_MUX_COLLECTING_DISTRIBUTING
suffix:colon
id|port-&gt;actor_oper_port_state
op_or_assign
id|AD_STATE_COLLECTING
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_or_assign
id|AD_STATE_DISTRIBUTING
suffix:semicolon
id|ad_enable_collecting_distributing
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;ntt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|//to silence the compiler
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * ad_rx_machine - handle a port&squot;s rx State Machine&n; * @lacpdu: the lacpdu we&squot;ve received&n; * @port: the port we&squot;re looking at&n; *&n; * If lacpdu arrived, stop previous timer (if exists) and set the next state as&n; * CURRENT. If timer expired set the state machine in the proper state.&n; * In other cases, this function checks if we need to switch to other state.&n; */
DECL|function|ad_rx_machine
r_static
r_void
id|ad_rx_machine
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|port
op_star
id|port
)paren
(brace
id|rx_states_t
id|last_state
suffix:semicolon
singleline_comment|// Lock to prevent 2 instances of this function to run simultaneously(rx interrupt and periodic machine callback)
id|__get_rx_machine_lock
c_func
(paren
id|port
)paren
suffix:semicolon
singleline_comment|// keep current State Machine state to compare later if it was changed
id|last_state
op_assign
id|port-&gt;sm_rx_state
suffix:semicolon
singleline_comment|// check if state machine should change state
singleline_comment|// first, check if port was reinitialized
r_if
c_cond
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_BEGIN
)paren
(brace
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_INITIALIZE
suffix:semicolon
singleline_comment|// next state
)brace
singleline_comment|// check if port is not enabled
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_BEGIN
)paren
op_logical_and
op_logical_neg
id|port-&gt;is_enabled
op_logical_and
op_logical_neg
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_MOVED
)paren
)paren
(brace
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_PORT_DISABLED
suffix:semicolon
singleline_comment|// next state
)brace
singleline_comment|// check if new lacpdu arrived
r_else
r_if
c_cond
(paren
id|lacpdu
op_logical_and
(paren
(paren
id|port-&gt;sm_rx_state
op_eq
id|AD_RX_EXPIRED
)paren
op_logical_or
(paren
id|port-&gt;sm_rx_state
op_eq
id|AD_RX_DEFAULTED
)paren
op_logical_or
(paren
id|port-&gt;sm_rx_state
op_eq
id|AD_RX_CURRENT
)paren
)paren
)paren
(brace
id|port-&gt;sm_rx_timer_counter
op_assign
l_int|0
suffix:semicolon
singleline_comment|// zero timer
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_CURRENT
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// if timer is on, and if it is expired
r_if
c_cond
(paren
id|port-&gt;sm_rx_timer_counter
op_logical_and
op_logical_neg
(paren
op_decrement
id|port-&gt;sm_rx_timer_counter
)paren
)paren
(brace
r_switch
c_cond
(paren
id|port-&gt;sm_rx_state
)paren
(brace
r_case
id|AD_RX_EXPIRED
suffix:colon
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_DEFAULTED
suffix:semicolon
singleline_comment|// next state
r_break
suffix:semicolon
r_case
id|AD_RX_CURRENT
suffix:colon
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_EXPIRED
suffix:semicolon
singleline_comment|// next state
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|//to silence the compiler
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// if no lacpdu arrived and no timer is on
r_switch
c_cond
(paren
id|port-&gt;sm_rx_state
)paren
(brace
r_case
id|AD_RX_PORT_DISABLED
suffix:colon
r_if
c_cond
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_MOVED
)paren
(brace
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_INITIALIZE
suffix:semicolon
singleline_comment|// next state
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;is_enabled
op_logical_and
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_LACP_ENABLED
)paren
)paren
(brace
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_EXPIRED
suffix:semicolon
singleline_comment|// next state
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;is_enabled
op_logical_and
(paren
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_LACP_ENABLED
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_LACP_DISABLED
suffix:semicolon
singleline_comment|// next state
)brace
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|//to silence the compiler
r_break
suffix:semicolon
)brace
)brace
)brace
singleline_comment|// check if the State machine was changed or new lacpdu arrived
r_if
c_cond
(paren
(paren
id|port-&gt;sm_rx_state
op_ne
id|last_state
)paren
op_logical_or
(paren
id|lacpdu
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Rx Machine: Port=%d, Last State=%d, Curr State=%d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|last_state
comma
id|port-&gt;sm_rx_state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;sm_rx_state
)paren
(brace
r_case
id|AD_RX_INITIALIZE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;actor_oper_port_key
op_amp
id|AD_DUPLEX_KEY_BITS
)paren
)paren
(brace
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_LACP_ENABLED
suffix:semicolon
)brace
r_else
(brace
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_LACP_ENABLED
suffix:semicolon
)brace
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_SELECTED
suffix:semicolon
id|__record_default
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_EXPIRED
suffix:semicolon
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_MOVED
suffix:semicolon
id|port-&gt;sm_rx_state
op_assign
id|AD_RX_PORT_DISABLED
suffix:semicolon
singleline_comment|// next state
multiline_comment|/*- Fall Through -*/
r_case
id|AD_RX_PORT_DISABLED
suffix:colon
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_MATCHED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_RX_LACP_DISABLED
suffix:colon
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_SELECTED
suffix:semicolon
id|__record_default
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_and_assign
op_complement
id|AD_STATE_AGGREGATION
suffix:semicolon
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_MATCHED
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_EXPIRED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_RX_EXPIRED
suffix:colon
singleline_comment|//Reset of the Synchronization flag. (Standard 43.4.12)
singleline_comment|//This reset cause to disable this port in the COLLECTING_DISTRIBUTING state of the
singleline_comment|//mux machine in case of EXPIRED even if LINK_DOWN didn&squot;t arrive for the port.
id|port-&gt;partner_oper_port_state
op_and_assign
op_complement
id|AD_STATE_SYNCHRONIZATION
suffix:semicolon
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_MATCHED
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_or_assign
id|AD_SHORT_TIMEOUT
suffix:semicolon
id|port-&gt;sm_rx_timer_counter
op_assign
id|__ad_timer_to_ticks
c_func
(paren
id|AD_CURRENT_WHILE_TIMER
comma
(paren
id|u16
)paren
(paren
id|AD_SHORT_TIMEOUT
)paren
)paren
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_or_assign
id|AD_STATE_EXPIRED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_RX_DEFAULTED
suffix:colon
id|__update_default_selected
c_func
(paren
id|port
)paren
suffix:semicolon
id|__record_default
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_MATCHED
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_EXPIRED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_RX_CURRENT
suffix:colon
singleline_comment|// detect loopback situation
r_if
c_cond
(paren
op_logical_neg
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|lacpdu-&gt;actor_system
)paren
comma
op_amp
(paren
id|port-&gt;actor_system
)paren
)paren
)paren
(brace
singleline_comment|// INFO_RECEIVED_LOOPBACK_FRAMES
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: An illegal loopback occurred on adapter (%s)&bslash;n&quot;
comma
id|port-&gt;slave-&gt;dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Check the configuration to verify that all Adapters &quot;
l_string|&quot;are connected to 802.3ad compliant switch ports&bslash;n&quot;
)paren
suffix:semicolon
id|__release_rx_machine_lock
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|__update_selected
c_func
(paren
id|lacpdu
comma
id|port
)paren
suffix:semicolon
id|__update_ntt
c_func
(paren
id|lacpdu
comma
id|port
)paren
suffix:semicolon
id|__record_pdu
c_func
(paren
id|lacpdu
comma
id|port
)paren
suffix:semicolon
id|__choose_matched
c_func
(paren
id|lacpdu
comma
id|port
)paren
suffix:semicolon
id|port-&gt;sm_rx_timer_counter
op_assign
id|__ad_timer_to_ticks
c_func
(paren
id|AD_CURRENT_WHILE_TIMER
comma
(paren
id|u16
)paren
(paren
id|port-&gt;actor_oper_port_state
op_amp
id|AD_STATE_LACP_TIMEOUT
)paren
)paren
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_EXPIRED
suffix:semicolon
singleline_comment|// verify that if the aggregator is enabled, the port is enabled too.
singleline_comment|//(because if the link goes down for a short time, the 802.3ad will not
singleline_comment|// catch it, and the port will continue to be disabled)
r_if
c_cond
(paren
id|port-&gt;aggregator
op_logical_and
id|port-&gt;aggregator-&gt;is_active
op_logical_and
op_logical_neg
id|__port_is_enabled
c_func
(paren
id|port
)paren
)paren
(brace
id|__enable_port
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|//to silence the compiler
r_break
suffix:semicolon
)brace
)brace
id|__release_rx_machine_lock
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ad_tx_machine - handle a port&squot;s tx state machine&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|ad_tx_machine
r_static
r_void
id|ad_tx_machine
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
singleline_comment|// check if tx timer expired, to verify that we do not send more than 3 packets per second
r_if
c_cond
(paren
id|port-&gt;sm_tx_timer_counter
op_logical_and
op_logical_neg
(paren
op_decrement
id|port-&gt;sm_tx_timer_counter
)paren
)paren
(brace
singleline_comment|// check if there is something to send
r_if
c_cond
(paren
id|port-&gt;ntt
op_logical_and
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_LACP_ENABLED
)paren
)paren
(brace
id|__update_lacpdu_from_port
c_func
(paren
id|port
)paren
suffix:semicolon
singleline_comment|// send the lacpdu
r_if
c_cond
(paren
id|ad_lacpdu_send
c_func
(paren
id|port
)paren
op_ge
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Sent LACPDU on port %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
singleline_comment|// mark ntt as false, so it will not be sent again until demanded
id|port-&gt;ntt
op_assign
l_int|0
suffix:semicolon
)brace
)brace
singleline_comment|// restart tx timer(to verify that we will not exceed AD_MAX_TX_IN_SECOND
id|port-&gt;sm_tx_timer_counter
op_assign
id|ad_ticks_per_sec
op_div
id|AD_MAX_TX_IN_SECOND
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ad_periodic_machine - handle a port&squot;s periodic state machine&n; * @port: the port we&squot;re looking at&n; *&n; * Turn ntt flag on priodically to perform periodic transmission of lacpdu&squot;s.&n; */
DECL|function|ad_periodic_machine
r_static
r_void
id|ad_periodic_machine
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
id|periodic_states_t
id|last_state
suffix:semicolon
singleline_comment|// keep current state machine state to compare later if it was changed
id|last_state
op_assign
id|port-&gt;sm_periodic_state
suffix:semicolon
singleline_comment|// check if port was reinitialized
r_if
c_cond
(paren
(paren
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_BEGIN
)paren
op_logical_or
op_logical_neg
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_LACP_ENABLED
)paren
op_logical_or
op_logical_neg
id|port-&gt;is_enabled
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|port-&gt;actor_oper_port_state
op_amp
id|AD_STATE_LACP_ACTIVITY
)paren
op_logical_and
op_logical_neg
(paren
id|port-&gt;partner_oper_port_state
op_amp
id|AD_STATE_LACP_ACTIVITY
)paren
)paren
)paren
(brace
id|port-&gt;sm_periodic_state
op_assign
id|AD_NO_PERIODIC
suffix:semicolon
singleline_comment|// next state
)brace
singleline_comment|// check if state machine should change state
r_else
r_if
c_cond
(paren
id|port-&gt;sm_periodic_timer_counter
)paren
(brace
singleline_comment|// check if periodic state machine expired
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|port-&gt;sm_periodic_timer_counter
)paren
)paren
(brace
singleline_comment|// if expired then do tx
id|port-&gt;sm_periodic_state
op_assign
id|AD_PERIODIC_TX
suffix:semicolon
singleline_comment|// next state
)brace
r_else
(brace
singleline_comment|// If not expired, check if there is some new timeout parameter from the partner state
r_switch
c_cond
(paren
id|port-&gt;sm_periodic_state
)paren
(brace
r_case
id|AD_FAST_PERIODIC
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;partner_oper_port_state
op_amp
id|AD_STATE_LACP_TIMEOUT
)paren
)paren
(brace
id|port-&gt;sm_periodic_state
op_assign
id|AD_SLOW_PERIODIC
suffix:semicolon
singleline_comment|// next state
)brace
r_break
suffix:semicolon
r_case
id|AD_SLOW_PERIODIC
suffix:colon
r_if
c_cond
(paren
(paren
id|port-&gt;partner_oper_port_state
op_amp
id|AD_STATE_LACP_TIMEOUT
)paren
)paren
(brace
singleline_comment|// stop current timer
id|port-&gt;sm_periodic_timer_counter
op_assign
l_int|0
suffix:semicolon
id|port-&gt;sm_periodic_state
op_assign
id|AD_PERIODIC_TX
suffix:semicolon
singleline_comment|// next state
)brace
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|//to silence the compiler
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|port-&gt;sm_periodic_state
)paren
(brace
r_case
id|AD_NO_PERIODIC
suffix:colon
id|port-&gt;sm_periodic_state
op_assign
id|AD_FAST_PERIODIC
suffix:semicolon
singleline_comment|// next state
r_break
suffix:semicolon
r_case
id|AD_PERIODIC_TX
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;partner_oper_port_state
op_amp
id|AD_STATE_LACP_TIMEOUT
)paren
)paren
(brace
id|port-&gt;sm_periodic_state
op_assign
id|AD_SLOW_PERIODIC
suffix:semicolon
singleline_comment|// next state
)brace
r_else
(brace
id|port-&gt;sm_periodic_state
op_assign
id|AD_FAST_PERIODIC
suffix:semicolon
singleline_comment|// next state
)brace
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|//to silence the compiler
r_break
suffix:semicolon
)brace
)brace
singleline_comment|// check if the state machine was changed
r_if
c_cond
(paren
id|port-&gt;sm_periodic_state
op_ne
id|last_state
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Periodic Machine: Port=%d, Last State=%d, Curr State=%d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|last_state
comma
id|port-&gt;sm_periodic_state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;sm_periodic_state
)paren
(brace
r_case
id|AD_NO_PERIODIC
suffix:colon
id|port-&gt;sm_periodic_timer_counter
op_assign
l_int|0
suffix:semicolon
singleline_comment|// zero timer
r_break
suffix:semicolon
r_case
id|AD_FAST_PERIODIC
suffix:colon
id|port-&gt;sm_periodic_timer_counter
op_assign
id|__ad_timer_to_ticks
c_func
(paren
id|AD_PERIODIC_TIMER
comma
(paren
id|u16
)paren
(paren
id|AD_FAST_PERIODIC_TIME
)paren
)paren
op_minus
l_int|1
suffix:semicolon
singleline_comment|// decrement 1 tick we lost in the PERIODIC_TX cycle
r_break
suffix:semicolon
r_case
id|AD_SLOW_PERIODIC
suffix:colon
id|port-&gt;sm_periodic_timer_counter
op_assign
id|__ad_timer_to_ticks
c_func
(paren
id|AD_PERIODIC_TIMER
comma
(paren
id|u16
)paren
(paren
id|AD_SLOW_PERIODIC_TIME
)paren
)paren
op_minus
l_int|1
suffix:semicolon
singleline_comment|// decrement 1 tick we lost in the PERIODIC_TX cycle
r_break
suffix:semicolon
r_case
id|AD_PERIODIC_TX
suffix:colon
id|port-&gt;ntt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|//to silence the compiler
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * ad_port_selection_logic - select aggregation groups&n; * @port: the port we&squot;re looking at&n; *&n; * Select aggregation groups, and assign each port for it&squot;s aggregetor. The&n; * selection logic is called in the inititalization (after all the handshkes),&n; * and after every lacpdu receive (if selected is off).&n; */
DECL|function|ad_port_selection_logic
r_static
r_void
id|ad_port_selection_logic
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|aggregator
op_star
id|aggregator
comma
op_star
id|free_aggregator
op_assign
l_int|NULL
comma
op_star
id|temp_aggregator
suffix:semicolon
r_struct
id|port
op_star
id|last_port
op_assign
l_int|NULL
comma
op_star
id|curr_port
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
singleline_comment|// if the port is already Selected, do nothing
r_if
c_cond
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_SELECTED
)paren
(brace
r_return
suffix:semicolon
)brace
singleline_comment|// if the port is connected to other aggregator, detach it
r_if
c_cond
(paren
id|port-&gt;aggregator
)paren
(brace
singleline_comment|// detach the port from its former aggregator
id|temp_aggregator
op_assign
id|port-&gt;aggregator
suffix:semicolon
r_for
c_loop
(paren
id|curr_port
op_assign
id|temp_aggregator-&gt;lag_ports
suffix:semicolon
id|curr_port
suffix:semicolon
id|last_port
op_assign
id|curr_port
comma
id|curr_port
op_assign
id|curr_port-&gt;next_port_in_aggregator
)paren
(brace
r_if
c_cond
(paren
id|curr_port
op_eq
id|port
)paren
(brace
id|temp_aggregator-&gt;num_of_ports
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|last_port
)paren
(brace
singleline_comment|// if it is the first port attached to the aggregator
id|temp_aggregator-&gt;lag_ports
op_assign
id|port-&gt;next_port_in_aggregator
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// not the first port attached to the aggregator
id|last_port-&gt;next_port_in_aggregator
op_assign
id|port-&gt;next_port_in_aggregator
suffix:semicolon
)brace
singleline_comment|// clear the port&squot;s relations to this aggregator
id|port-&gt;aggregator
op_assign
l_int|NULL
suffix:semicolon
id|port-&gt;next_port_in_aggregator
op_assign
l_int|NULL
suffix:semicolon
id|port-&gt;actor_port_aggregator_identifier
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Port %d left LAG %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|temp_aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
singleline_comment|// if the aggregator is empty, clear its parameters, and set it ready to be attached
r_if
c_cond
(paren
op_logical_neg
id|temp_aggregator-&gt;lag_ports
)paren
(brace
id|ad_clear_agg
c_func
(paren
id|temp_aggregator
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|curr_port
)paren
(brace
singleline_comment|// meaning: the port was related to an aggregator but was not on the aggregator port list
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: Port %d (on %s) was &quot;
l_string|&quot;related to aggregator %d but was not on its port list&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|port-&gt;slave-&gt;dev-&gt;name
comma
id|port-&gt;aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// search on all aggregators for a suitable aggregator for this port
r_for
c_loop
(paren
id|aggregator
op_assign
id|__get_first_agg
c_func
(paren
id|port
)paren
suffix:semicolon
id|aggregator
suffix:semicolon
id|aggregator
op_assign
id|__get_next_agg
c_func
(paren
id|aggregator
)paren
)paren
(brace
singleline_comment|// keep a free aggregator for later use(if needed)
r_if
c_cond
(paren
op_logical_neg
id|aggregator-&gt;lag_ports
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|free_aggregator
)paren
(brace
id|free_aggregator
op_assign
id|aggregator
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
singleline_comment|// check if current aggregator suits us
r_if
c_cond
(paren
(paren
(paren
id|aggregator-&gt;actor_oper_aggregator_key
op_eq
id|port-&gt;actor_oper_port_key
)paren
op_logical_and
singleline_comment|// if all parameters match AND
op_logical_neg
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|port-&gt;partner_oper_system
)paren
)paren
op_logical_and
(paren
id|aggregator-&gt;partner_system_priority
op_eq
id|port-&gt;partner_oper_system_priority
)paren
op_logical_and
(paren
id|aggregator-&gt;partner_oper_aggregator_key
op_eq
id|port-&gt;partner_oper_key
)paren
)paren
op_logical_and
(paren
(paren
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|port-&gt;partner_oper_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
op_logical_and
singleline_comment|// partner answers
op_logical_neg
id|aggregator-&gt;is_individual
)paren
singleline_comment|// but is not individual OR
)paren
)paren
(brace
singleline_comment|// attach to the founded aggregator
id|port-&gt;aggregator
op_assign
id|aggregator
suffix:semicolon
id|port-&gt;actor_port_aggregator_identifier
op_assign
id|port-&gt;aggregator-&gt;aggregator_identifier
suffix:semicolon
id|port-&gt;next_port_in_aggregator
op_assign
id|aggregator-&gt;lag_ports
suffix:semicolon
id|port-&gt;aggregator-&gt;num_of_ports
op_increment
suffix:semicolon
id|aggregator-&gt;lag_ports
op_assign
id|port
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Port %d joined LAG %d(existing LAG)&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|port-&gt;aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
singleline_comment|// mark this port as selected
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_SELECTED
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|// the port couldn&squot;t find an aggregator - attach it to a new aggregator
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
r_if
c_cond
(paren
id|free_aggregator
)paren
(brace
singleline_comment|// assign port a new aggregator
id|port-&gt;aggregator
op_assign
id|free_aggregator
suffix:semicolon
id|port-&gt;actor_port_aggregator_identifier
op_assign
id|port-&gt;aggregator-&gt;aggregator_identifier
suffix:semicolon
singleline_comment|// update the new aggregator&squot;s parameters
singleline_comment|// if port was responsed from the end-user
r_if
c_cond
(paren
id|port-&gt;actor_oper_port_key
op_amp
id|AD_DUPLEX_KEY_BITS
)paren
(brace
singleline_comment|// if port is full duplex
id|port-&gt;aggregator-&gt;is_individual
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|port-&gt;aggregator-&gt;is_individual
op_assign
l_int|1
suffix:semicolon
)brace
id|port-&gt;aggregator-&gt;actor_admin_aggregator_key
op_assign
id|port-&gt;actor_admin_port_key
suffix:semicolon
id|port-&gt;aggregator-&gt;actor_oper_aggregator_key
op_assign
id|port-&gt;actor_oper_port_key
suffix:semicolon
id|port-&gt;aggregator-&gt;partner_system
op_assign
id|port-&gt;partner_oper_system
suffix:semicolon
id|port-&gt;aggregator-&gt;partner_system_priority
op_assign
id|port-&gt;partner_oper_system_priority
suffix:semicolon
id|port-&gt;aggregator-&gt;partner_oper_aggregator_key
op_assign
id|port-&gt;partner_oper_key
suffix:semicolon
id|port-&gt;aggregator-&gt;receive_state
op_assign
l_int|1
suffix:semicolon
id|port-&gt;aggregator-&gt;transmit_state
op_assign
l_int|1
suffix:semicolon
id|port-&gt;aggregator-&gt;lag_ports
op_assign
id|port
suffix:semicolon
id|port-&gt;aggregator-&gt;num_of_ports
op_increment
suffix:semicolon
singleline_comment|// mark this port as selected
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_SELECTED
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Port %d joined LAG %d(new LAG)&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|port-&gt;aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: Port %d (on %s) did not find a suitable aggregator&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|port-&gt;slave-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// if all aggregator&squot;s ports are READY_N == TRUE, set ready=TRUE in all aggregator&squot;s ports
singleline_comment|// else set ready=FALSE in all aggregator&squot;s ports
id|__set_agg_ports_ready
c_func
(paren
id|port-&gt;aggregator
comma
id|__agg_ports_are_ready
c_func
(paren
id|port-&gt;aggregator
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|__check_agg_selection_timer
c_func
(paren
id|port
)paren
op_logical_and
(paren
id|aggregator
op_assign
id|__get_first_agg
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|ad_agg_selection_logic
c_func
(paren
id|aggregator
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ad_agg_selection_logic - select an aggregation group for a team&n; * @aggregator: the aggregator we&squot;re looking at&n; *&n; * It is assumed that only one aggregator may be selected for a team.&n; * The logic of this function is to select (at first time) the aggregator with&n; * the most ports attached to it, and to reselect the active aggregator only if&n; * the previous aggregator has no more ports related to it.&n; *&n; * FIXME: this function MUST be called with the first agg in the bond, or&n; * __get_active_agg() won&squot;t work correctly. This function should be better&n; * called with the bond itself, and retrieve the first agg from it.&n; */
DECL|function|ad_agg_selection_logic
r_static
r_void
id|ad_agg_selection_logic
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
(brace
r_struct
id|aggregator
op_star
id|best_aggregator
op_assign
l_int|NULL
comma
op_star
id|active_aggregator
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|aggregator
op_star
id|last_active_aggregator
op_assign
l_int|NULL
comma
op_star
id|origin_aggregator
suffix:semicolon
r_struct
id|port
op_star
id|port
suffix:semicolon
id|u16
id|num_of_aggs
op_assign
l_int|0
suffix:semicolon
id|origin_aggregator
op_assign
id|aggregator
suffix:semicolon
singleline_comment|//get current active aggregator
id|last_active_aggregator
op_assign
id|__get_active_agg
c_func
(paren
id|aggregator
)paren
suffix:semicolon
singleline_comment|// search for the aggregator with the most ports attached to it.
r_do
(brace
singleline_comment|// count how many candidate lag&squot;s we have
r_if
c_cond
(paren
id|aggregator-&gt;lag_ports
)paren
(brace
id|num_of_aggs
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aggregator-&gt;is_active
op_logical_and
op_logical_neg
id|aggregator-&gt;is_individual
op_logical_and
singleline_comment|// if current aggregator is the active aggregator
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
)paren
(brace
singleline_comment|// and partner answers to 802.3ad PDUs
r_if
c_cond
(paren
id|aggregator-&gt;num_of_ports
)paren
(brace
singleline_comment|// if any ports attached to the current aggregator
id|best_aggregator
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// disregard the best aggregator that was chosen by now
r_break
suffix:semicolon
singleline_comment|// stop the selection of other aggregator if there are any ports attached to this active aggregator
)brace
r_else
(brace
singleline_comment|// no ports attached to this active aggregator
id|aggregator-&gt;is_active
op_assign
l_int|0
suffix:semicolon
singleline_comment|// mark this aggregator as not active anymore
)brace
)brace
r_if
c_cond
(paren
id|aggregator-&gt;num_of_ports
)paren
(brace
singleline_comment|// if any ports attached
r_if
c_cond
(paren
id|best_aggregator
)paren
(brace
singleline_comment|// if there is a candidte aggregator
singleline_comment|//The reasons for choosing new best aggregator:
singleline_comment|// 1. if current agg is NOT individual and the best agg chosen so far is individual OR
singleline_comment|// current and best aggs are both individual or both not individual, AND
singleline_comment|// 2a.  current agg partner reply but best agg partner do not reply OR
singleline_comment|// 2b.  current agg partner reply OR current agg partner do not reply AND best agg partner also do not reply AND
singleline_comment|//      current has more ports/bandwidth, or same amount of ports but current has faster ports, THEN
singleline_comment|//      current agg become best agg so far
singleline_comment|//if current agg is NOT individual and the best agg chosen so far is individual change best_aggregator
r_if
c_cond
(paren
op_logical_neg
id|aggregator-&gt;is_individual
op_logical_and
id|best_aggregator-&gt;is_individual
)paren
(brace
id|best_aggregator
op_assign
id|aggregator
suffix:semicolon
)brace
singleline_comment|// current and best aggs are both individual or both not individual
r_else
r_if
c_cond
(paren
(paren
id|aggregator-&gt;is_individual
op_logical_and
id|best_aggregator-&gt;is_individual
)paren
op_logical_or
(paren
op_logical_neg
id|aggregator-&gt;is_individual
op_logical_and
op_logical_neg
id|best_aggregator-&gt;is_individual
)paren
)paren
(brace
singleline_comment|//  current and best aggs are both individual or both not individual AND
singleline_comment|//  current agg partner reply but best agg partner do not reply
r_if
c_cond
(paren
(paren
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
op_logical_and
op_logical_neg
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|best_aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
)paren
)paren
(brace
id|best_aggregator
op_assign
id|aggregator
suffix:semicolon
)brace
singleline_comment|//  current agg partner reply OR current agg partner do not reply AND best agg partner also do not reply
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
op_logical_neg
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
op_logical_and
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|best_aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|__get_agg_selection_mode
c_func
(paren
id|aggregator-&gt;lag_ports
)paren
op_eq
id|AD_BANDWIDTH
)paren
op_logical_and
(paren
id|__get_agg_bandwidth
c_func
(paren
id|aggregator
)paren
OG
id|__get_agg_bandwidth
c_func
(paren
id|best_aggregator
)paren
)paren
)paren
(brace
id|best_aggregator
op_assign
id|aggregator
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|__get_agg_selection_mode
c_func
(paren
id|aggregator-&gt;lag_ports
)paren
op_eq
id|AD_COUNT
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|aggregator-&gt;num_of_ports
OG
id|best_aggregator-&gt;num_of_ports
)paren
op_logical_and
(paren
id|aggregator-&gt;actor_oper_aggregator_key
op_amp
id|AD_SPEED_KEY_BITS
)paren
)paren
op_logical_or
(paren
(paren
id|aggregator-&gt;num_of_ports
op_eq
id|best_aggregator-&gt;num_of_ports
)paren
op_logical_and
(paren
(paren
id|u16
)paren
(paren
id|aggregator-&gt;actor_oper_aggregator_key
op_amp
id|AD_SPEED_KEY_BITS
)paren
OG
(paren
id|u16
)paren
(paren
id|best_aggregator-&gt;actor_oper_aggregator_key
op_amp
id|AD_SPEED_KEY_BITS
)paren
)paren
)paren
)paren
(brace
id|best_aggregator
op_assign
id|aggregator
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
r_else
(brace
id|best_aggregator
op_assign
id|aggregator
suffix:semicolon
)brace
)brace
id|aggregator-&gt;is_active
op_assign
l_int|0
suffix:semicolon
singleline_comment|// mark all aggregators as not active anymore
)brace
r_while
c_loop
(paren
(paren
id|aggregator
op_assign
id|__get_next_agg
c_func
(paren
id|aggregator
)paren
)paren
)paren
suffix:semicolon
singleline_comment|// if we have new aggregator selected, don&squot;t replace the old aggregator if it has an answering partner,
singleline_comment|// or if both old aggregator and new aggregator don&squot;t have answering partner
r_if
c_cond
(paren
id|best_aggregator
)paren
(brace
r_if
c_cond
(paren
id|last_active_aggregator
op_logical_and
id|last_active_aggregator-&gt;lag_ports
op_logical_and
id|last_active_aggregator-&gt;lag_ports-&gt;is_enabled
op_logical_and
(paren
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|last_active_aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
op_logical_or
singleline_comment|// partner answers OR
(paren
op_logical_neg
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|last_active_aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
op_logical_and
singleline_comment|// both old and new
op_logical_neg
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|best_aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
)paren
)paren
singleline_comment|// partner do not answer
)paren
(brace
singleline_comment|// if new aggregator has link, and old aggregator does not, replace old aggregator.(do nothing)
singleline_comment|// -&gt; don&squot;t replace otherwise.
r_if
c_cond
(paren
op_logical_neg
(paren
op_logical_neg
id|last_active_aggregator-&gt;actor_oper_aggregator_key
op_logical_and
id|best_aggregator-&gt;actor_oper_aggregator_key
)paren
)paren
(brace
id|best_aggregator
op_assign
l_int|NULL
suffix:semicolon
id|last_active_aggregator-&gt;is_active
op_assign
l_int|1
suffix:semicolon
singleline_comment|// don&squot;t replace good old aggregator
)brace
)brace
)brace
singleline_comment|// if there is new best aggregator, activate it
r_if
c_cond
(paren
id|best_aggregator
)paren
(brace
r_for
c_loop
(paren
id|aggregator
op_assign
id|__get_first_agg
c_func
(paren
id|best_aggregator-&gt;lag_ports
)paren
suffix:semicolon
id|aggregator
suffix:semicolon
id|aggregator
op_assign
id|__get_next_agg
c_func
(paren
id|aggregator
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Agg=%d; Ports=%d; a key=%d; p key=%d; Indiv=%d; Active=%d&bslash;n&quot;
comma
id|aggregator-&gt;aggregator_identifier
comma
id|aggregator-&gt;num_of_ports
comma
id|aggregator-&gt;actor_oper_aggregator_key
comma
id|aggregator-&gt;partner_oper_aggregator_key
comma
id|aggregator-&gt;is_individual
comma
id|aggregator-&gt;is_active
)paren
suffix:semicolon
)brace
singleline_comment|// check if any partner replys
r_if
c_cond
(paren
id|best_aggregator-&gt;is_individual
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: No 802.3ad response from the link partner &quot;
l_string|&quot;for any adapters in the bond&bslash;n&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// check if there are more than one aggregator
r_if
c_cond
(paren
id|num_of_aggs
OG
l_int|1
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Warning: More than one Link Aggregation Group was &quot;
l_string|&quot;found in the bond. Only one group will function in the bond&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|best_aggregator-&gt;is_active
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;LAG %d choosed as the active LAG&bslash;n&quot;
comma
id|best_aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Agg=%d; Ports=%d; a key=%d; p key=%d; Indiv=%d; Active=%d&bslash;n&quot;
comma
id|best_aggregator-&gt;aggregator_identifier
comma
id|best_aggregator-&gt;num_of_ports
comma
id|best_aggregator-&gt;actor_oper_aggregator_key
comma
id|best_aggregator-&gt;partner_oper_aggregator_key
comma
id|best_aggregator-&gt;is_individual
comma
id|best_aggregator-&gt;is_active
)paren
suffix:semicolon
singleline_comment|// disable the ports that were related to the former active_aggregator
r_if
c_cond
(paren
id|last_active_aggregator
)paren
(brace
r_for
c_loop
(paren
id|port
op_assign
id|last_active_aggregator-&gt;lag_ports
suffix:semicolon
id|port
suffix:semicolon
id|port
op_assign
id|port-&gt;next_port_in_aggregator
)paren
(brace
id|__disable_port
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
)brace
singleline_comment|// if the selected aggregator is of join individuals(partner_system is NULL), enable their ports
id|active_aggregator
op_assign
id|__get_active_agg
c_func
(paren
id|origin_aggregator
)paren
suffix:semicolon
r_if
c_cond
(paren
id|active_aggregator
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|active_aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|port
op_assign
id|active_aggregator-&gt;lag_ports
suffix:semicolon
id|port
suffix:semicolon
id|port
op_assign
id|port-&gt;next_port_in_aggregator
)paren
(brace
id|__enable_port
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/**&n; * ad_clear_agg - clear a given aggregator&squot;s parameters&n; * @aggregator: the aggregator we&squot;re looking at&n; *&n; */
DECL|function|ad_clear_agg
r_static
r_void
id|ad_clear_agg
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
(brace
r_if
c_cond
(paren
id|aggregator
)paren
(brace
id|aggregator-&gt;is_individual
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;actor_admin_aggregator_key
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;actor_oper_aggregator_key
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;partner_system
op_assign
id|null_mac_addr
suffix:semicolon
id|aggregator-&gt;partner_system_priority
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;partner_oper_aggregator_key
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;receive_state
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;transmit_state
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;lag_ports
op_assign
l_int|NULL
suffix:semicolon
id|aggregator-&gt;is_active
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;num_of_ports
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;LAG %d was cleared&bslash;n&quot;
comma
id|aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ad_initialize_agg - initialize a given aggregator&squot;s parameters&n; * @aggregator: the aggregator we&squot;re looking at&n; *&n; */
DECL|function|ad_initialize_agg
r_static
r_void
id|ad_initialize_agg
c_func
(paren
r_struct
id|aggregator
op_star
id|aggregator
)paren
(brace
r_if
c_cond
(paren
id|aggregator
)paren
(brace
id|ad_clear_agg
c_func
(paren
id|aggregator
)paren
suffix:semicolon
id|aggregator-&gt;aggregator_mac_address
op_assign
id|null_mac_addr
suffix:semicolon
id|aggregator-&gt;aggregator_identifier
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;slave
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ad_initialize_port - initialize a given port&squot;s parameters&n; * @aggregator: the aggregator we&squot;re looking at&n; * @lacp_fast: boolean. whether fast periodic should be used&n; *&n; */
DECL|function|ad_initialize_port
r_static
r_void
id|ad_initialize_port
c_func
(paren
r_struct
id|port
op_star
id|port
comma
r_int
id|lacp_fast
)paren
(brace
r_if
c_cond
(paren
id|port
)paren
(brace
id|port-&gt;actor_port_number
op_assign
l_int|1
suffix:semicolon
id|port-&gt;actor_port_priority
op_assign
l_int|0xff
suffix:semicolon
id|port-&gt;actor_system
op_assign
id|null_mac_addr
suffix:semicolon
id|port-&gt;actor_system_priority
op_assign
l_int|0xffff
suffix:semicolon
id|port-&gt;actor_port_aggregator_identifier
op_assign
l_int|0
suffix:semicolon
id|port-&gt;ntt
op_assign
l_int|0
suffix:semicolon
id|port-&gt;actor_admin_port_key
op_assign
l_int|1
suffix:semicolon
id|port-&gt;actor_oper_port_key
op_assign
l_int|1
suffix:semicolon
id|port-&gt;actor_admin_port_state
op_assign
id|AD_STATE_AGGREGATION
op_or
id|AD_STATE_LACP_ACTIVITY
suffix:semicolon
id|port-&gt;actor_oper_port_state
op_assign
id|AD_STATE_AGGREGATION
op_or
id|AD_STATE_LACP_ACTIVITY
suffix:semicolon
r_if
c_cond
(paren
id|lacp_fast
)paren
(brace
id|port-&gt;actor_oper_port_state
op_or_assign
id|AD_STATE_LACP_TIMEOUT
suffix:semicolon
)brace
id|port-&gt;partner_admin_system
op_assign
id|null_mac_addr
suffix:semicolon
id|port-&gt;partner_oper_system
op_assign
id|null_mac_addr
suffix:semicolon
id|port-&gt;partner_admin_system_priority
op_assign
l_int|0xffff
suffix:semicolon
id|port-&gt;partner_oper_system_priority
op_assign
l_int|0xffff
suffix:semicolon
id|port-&gt;partner_admin_key
op_assign
l_int|1
suffix:semicolon
id|port-&gt;partner_oper_key
op_assign
l_int|1
suffix:semicolon
id|port-&gt;partner_admin_port_number
op_assign
l_int|1
suffix:semicolon
id|port-&gt;partner_oper_port_number
op_assign
l_int|1
suffix:semicolon
id|port-&gt;partner_admin_port_priority
op_assign
l_int|0xff
suffix:semicolon
id|port-&gt;partner_oper_port_priority
op_assign
l_int|0xff
suffix:semicolon
id|port-&gt;partner_admin_port_state
op_assign
l_int|1
suffix:semicolon
id|port-&gt;partner_oper_port_state
op_assign
l_int|1
suffix:semicolon
id|port-&gt;is_enabled
op_assign
l_int|1
suffix:semicolon
singleline_comment|// ****** private parameters ******
id|port-&gt;sm_vars
op_assign
l_int|0x3
suffix:semicolon
id|port-&gt;sm_rx_state
op_assign
l_int|0
suffix:semicolon
id|port-&gt;sm_rx_timer_counter
op_assign
l_int|0
suffix:semicolon
id|port-&gt;sm_periodic_state
op_assign
l_int|0
suffix:semicolon
id|port-&gt;sm_periodic_timer_counter
op_assign
l_int|0
suffix:semicolon
id|port-&gt;sm_mux_state
op_assign
l_int|0
suffix:semicolon
id|port-&gt;sm_mux_timer_counter
op_assign
l_int|0
suffix:semicolon
id|port-&gt;sm_tx_state
op_assign
l_int|0
suffix:semicolon
id|port-&gt;sm_tx_timer_counter
op_assign
l_int|0
suffix:semicolon
id|port-&gt;slave
op_assign
l_int|NULL
suffix:semicolon
id|port-&gt;aggregator
op_assign
l_int|NULL
suffix:semicolon
id|port-&gt;next_port_in_aggregator
op_assign
l_int|NULL
suffix:semicolon
id|port-&gt;transaction_id
op_assign
l_int|0
suffix:semicolon
id|ad_initialize_lacpdu
c_func
(paren
op_amp
(paren
id|port-&gt;lacpdu
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ad_enable_collecting_distributing - enable a port&squot;s transmit/receive&n; * @port: the port we&squot;re looking at&n; *&n; * Enable @port if it&squot;s in an active aggregator&n; */
DECL|function|ad_enable_collecting_distributing
r_static
r_void
id|ad_enable_collecting_distributing
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;aggregator-&gt;is_active
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Enabling port %d(LAG %d)&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|port-&gt;aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
id|__enable_port
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ad_disable_collecting_distributing - disable a port&squot;s transmit/receive&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|ad_disable_collecting_distributing
r_static
r_void
id|ad_disable_collecting_distributing
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;aggregator
op_logical_and
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|port-&gt;aggregator-&gt;partner_system
)paren
comma
op_amp
(paren
id|null_mac_addr
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Disabling port %d(LAG %d)&bslash;n&quot;
comma
id|port-&gt;actor_port_number
comma
id|port-&gt;aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
id|__disable_port
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
multiline_comment|/**&n; * ad_marker_info_send - send a marker information frame&n; * @port: the port we&squot;re looking at&n; *&n; * This function does nothing since we decided not to implement send and handle&n; * response for marker PDU&squot;s, in this stage, but only to respond to marker&n; * information.&n; */
r_static
r_void
id|ad_marker_info_send
c_func
(paren
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|marker
id|marker
suffix:semicolon
id|u16
id|index
suffix:semicolon
singleline_comment|// fill the marker PDU with the appropriate values
id|marker.subtype
op_assign
l_int|0x02
suffix:semicolon
id|marker.version_number
op_assign
l_int|0x01
suffix:semicolon
id|marker.tlv_type
op_assign
id|AD_MARKER_INFORMATION_SUBTYPE
suffix:semicolon
id|marker.marker_length
op_assign
l_int|0x16
suffix:semicolon
singleline_comment|// convert requester_port to Big Endian
id|marker.requester_port
op_assign
(paren
(paren
(paren
id|port-&gt;actor_port_number
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|u16
)paren
(paren
id|port-&gt;actor_port_number
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
id|marker.requester_system
op_assign
id|port-&gt;actor_system
suffix:semicolon
singleline_comment|// convert requester_port(u32) to Big Endian
id|marker.requester_transaction_id
op_assign
(paren
(paren
(paren
op_increment
id|port-&gt;transaction_id
op_amp
l_int|0xFF
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|port-&gt;transaction_id
op_amp
l_int|0xFF00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|port-&gt;transaction_id
op_amp
l_int|0xFF0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|port-&gt;transaction_id
op_amp
l_int|0xFF000000
)paren
op_rshift
l_int|24
)paren
)paren
suffix:semicolon
id|marker.pad
op_assign
l_int|0
suffix:semicolon
id|marker.tlv_type_terminator
op_assign
l_int|0x00
suffix:semicolon
id|marker.terminator_length
op_assign
l_int|0x00
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
l_int|90
suffix:semicolon
id|index
op_increment
)paren
(brace
id|marker.reserved_90
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|// send the marker information
r_if
c_cond
(paren
id|ad_marker_send
c_func
(paren
id|port
comma
op_amp
id|marker
)paren
op_ge
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Sent Marker Information on port %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/**&n; * ad_marker_info_received - handle receive of a Marker information frame&n; * @marker_info: Marker info received&n; * @port: the port we&squot;re looking at&n; *&n; */
DECL|function|ad_marker_info_received
r_static
r_void
id|ad_marker_info_received
c_func
(paren
r_struct
id|marker
op_star
id|marker_info
comma
r_struct
id|port
op_star
id|port
)paren
(brace
r_struct
id|marker
id|marker
suffix:semicolon
singleline_comment|// copy the received marker data to the response marker
singleline_comment|//marker = *marker_info;
id|memcpy
c_func
(paren
op_amp
id|marker
comma
id|marker_info
comma
r_sizeof
(paren
r_struct
id|marker
)paren
)paren
suffix:semicolon
singleline_comment|// change the marker subtype to marker response
id|marker.tlv_type
op_assign
id|AD_MARKER_RESPONSE_SUBTYPE
suffix:semicolon
singleline_comment|// send the marker response
r_if
c_cond
(paren
id|ad_marker_send
c_func
(paren
id|port
comma
op_amp
id|marker
)paren
op_ge
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Sent Marker Response on port %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ad_marker_response_received - handle receive of a marker response frame&n; * @marker: marker PDU received&n; * @port: the port we&squot;re looking at&n; *&n; * This function does nothing since we decided not to implement send and handle&n; * response for marker PDU&squot;s, in this stage, but only to respond to marker&n; * information.&n; */
DECL|function|ad_marker_response_received
r_static
r_void
id|ad_marker_response_received
c_func
(paren
r_struct
id|marker
op_star
id|marker
comma
r_struct
id|port
op_star
id|port
)paren
(brace
id|marker
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// just to satisfy the compiler
id|port
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// just to satisfy the compiler
singleline_comment|// DO NOTHING, SINCE WE DECIDED NOT TO IMPLEMENT THIS FEATURE FOR NOW
)brace
multiline_comment|/**&n; * ad_initialize_lacpdu - initialize a given lacpdu structure&n; * @lacpdu: lacpdu structure to initialize&n; *&n; */
DECL|function|ad_initialize_lacpdu
r_static
r_void
id|ad_initialize_lacpdu
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
)paren
(brace
id|u16
id|index
suffix:semicolon
singleline_comment|// initialize lacpdu data
id|lacpdu-&gt;subtype
op_assign
l_int|0x01
suffix:semicolon
id|lacpdu-&gt;version_number
op_assign
l_int|0x01
suffix:semicolon
id|lacpdu-&gt;tlv_type_actor_info
op_assign
l_int|0x01
suffix:semicolon
id|lacpdu-&gt;actor_information_length
op_assign
l_int|0x14
suffix:semicolon
singleline_comment|// lacpdu-&gt;actor_system_priority    updated on send
singleline_comment|// lacpdu-&gt;actor_system             updated on send
singleline_comment|// lacpdu-&gt;actor_key                updated on send
singleline_comment|// lacpdu-&gt;actor_port_priority      updated on send
singleline_comment|// lacpdu-&gt;actor_port               updated on send
singleline_comment|// lacpdu-&gt;actor_state              updated on send
id|lacpdu-&gt;tlv_type_partner_info
op_assign
l_int|0x02
suffix:semicolon
id|lacpdu-&gt;partner_information_length
op_assign
l_int|0x14
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
op_le
l_int|2
suffix:semicolon
id|index
op_increment
)paren
(brace
id|lacpdu-&gt;reserved_3_1
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|// lacpdu-&gt;partner_system_priority  updated on send
singleline_comment|// lacpdu-&gt;partner_system           updated on send
singleline_comment|// lacpdu-&gt;partner_key              updated on send
singleline_comment|// lacpdu-&gt;partner_port_priority    updated on send
singleline_comment|// lacpdu-&gt;partner_port             updated on send
singleline_comment|// lacpdu-&gt;partner_state            updated on send
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
op_le
l_int|2
suffix:semicolon
id|index
op_increment
)paren
(brace
id|lacpdu-&gt;reserved_3_2
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|lacpdu-&gt;tlv_type_collector_info
op_assign
l_int|0x03
suffix:semicolon
id|lacpdu-&gt;collector_information_length
op_assign
l_int|0x10
suffix:semicolon
id|lacpdu-&gt;collector_max_delay
op_assign
id|AD_COLLECTOR_MAX_DELAY
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
op_le
l_int|11
suffix:semicolon
id|index
op_increment
)paren
(brace
id|lacpdu-&gt;reserved_12
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|lacpdu-&gt;tlv_type_terminator
op_assign
l_int|0x00
suffix:semicolon
id|lacpdu-&gt;terminator_length
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
op_le
l_int|49
suffix:semicolon
id|index
op_increment
)paren
(brace
id|lacpdu-&gt;reserved_50
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
singleline_comment|//////////////////////////////////////////////////////////////////////////////////////
singleline_comment|// ================= AD exported functions to the main bonding code ==================
singleline_comment|//////////////////////////////////////////////////////////////////////////////////////
singleline_comment|// Check aggregators status in team every T seconds
DECL|macro|AD_AGGREGATOR_SELECTION_TIMER
mdefine_line|#define AD_AGGREGATOR_SELECTION_TIMER  8
DECL|variable|aggregator_identifier
r_static
id|u16
id|aggregator_identifier
suffix:semicolon
multiline_comment|/**&n; * bond_3ad_initialize - initialize a bond&squot;s 802.3ad parameters and structures&n; * @bond: bonding struct to work on&n; * @tick_resolution: tick duration (millisecond resolution)&n; * @lacp_fast: boolean. whether fast periodic should be used&n; *&n; * Can be called only after the mac address of the bond is set.&n; */
DECL|function|bond_3ad_initialize
r_void
id|bond_3ad_initialize
c_func
(paren
r_struct
id|bonding
op_star
id|bond
comma
id|u16
id|tick_resolution
comma
r_int
id|lacp_fast
)paren
(brace
singleline_comment|// check that the bond is not initialized yet
r_if
c_cond
(paren
id|MAC_ADDRESS_COMPARE
c_func
(paren
op_amp
(paren
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|system.sys_mac_addr
)paren
comma
op_amp
(paren
id|bond-&gt;device-&gt;dev_addr
)paren
)paren
)paren
(brace
id|aggregator_identifier
op_assign
l_int|0
suffix:semicolon
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|lacp_fast
op_assign
id|lacp_fast
suffix:semicolon
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|system.sys_priority
op_assign
l_int|0xFFFF
suffix:semicolon
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|system.sys_mac_addr
op_assign
op_star
(paren
(paren
r_struct
id|mac_addr
op_star
)paren
id|bond-&gt;device-&gt;dev_addr
)paren
suffix:semicolon
singleline_comment|// initialize how many times this module is called in one second(should be about every 100ms)
id|ad_ticks_per_sec
op_assign
id|tick_resolution
suffix:semicolon
singleline_comment|// initialize the aggregator selection timer(to activate an aggregation selection after initialize)
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|agg_select_timer
op_assign
(paren
id|AD_AGGREGATOR_SELECTION_TIMER
op_star
id|ad_ticks_per_sec
)paren
suffix:semicolon
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|agg_select_mode
op_assign
id|AD_BANDWIDTH
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * bond_3ad_bind_slave - initialize a slave&squot;s port&n; * @slave: slave struct to work on&n; *&n; * Returns:   0 on success&n; *          &lt; 0 on error&n; */
DECL|function|bond_3ad_bind_slave
r_int
id|bond_3ad_bind_slave
c_func
(paren
r_struct
id|slave
op_star
id|slave
)paren
(brace
r_struct
id|bonding
op_star
id|bond
op_assign
id|bond_get_bond_by_slave
c_func
(paren
id|slave
)paren
suffix:semicolon
r_struct
id|port
op_star
id|port
suffix:semicolon
r_struct
id|aggregator
op_star
id|aggregator
suffix:semicolon
r_if
c_cond
(paren
id|bond
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;The slave %s is not attached to its bond&bslash;n&quot;
comma
id|slave-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
singleline_comment|//check that the slave has not been intialized yet.
r_if
c_cond
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port.slave
op_ne
id|slave
)paren
(brace
singleline_comment|// port initialization
id|port
op_assign
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port
)paren
suffix:semicolon
id|ad_initialize_port
c_func
(paren
id|port
comma
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|lacp_fast
)paren
suffix:semicolon
id|port-&gt;slave
op_assign
id|slave
suffix:semicolon
id|port-&gt;actor_port_number
op_assign
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|id
suffix:semicolon
singleline_comment|// key is determined according to the link speed, duplex and user key(which is yet not supported)
singleline_comment|//              ------------------------------------------------------------
singleline_comment|// Port key :   | User key                       |      Speed       |Duplex|
singleline_comment|//              ------------------------------------------------------------
singleline_comment|//              16                               6               1 0
id|port-&gt;actor_admin_port_key
op_assign
l_int|0
suffix:semicolon
singleline_comment|// initialize this parameter
id|port-&gt;actor_admin_port_key
op_or_assign
id|__get_duplex
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;actor_admin_port_key
op_or_assign
(paren
id|__get_link_speed
c_func
(paren
id|port
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|port-&gt;actor_oper_port_key
op_assign
id|port-&gt;actor_admin_port_key
suffix:semicolon
singleline_comment|// if the port is not full duplex, then the port should be not lacp Enabled
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;actor_oper_port_key
op_amp
id|AD_DUPLEX_KEY_BITS
)paren
)paren
(brace
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_LACP_ENABLED
suffix:semicolon
)brace
singleline_comment|// actor system is the bond&squot;s system
id|port-&gt;actor_system
op_assign
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|system.sys_mac_addr
suffix:semicolon
singleline_comment|// tx timer(to verify that no more than MAX_TX_IN_SECOND lacpdu&squot;s are sent in one second)
id|port-&gt;sm_tx_timer_counter
op_assign
id|ad_ticks_per_sec
op_div
id|AD_MAX_TX_IN_SECOND
suffix:semicolon
id|port-&gt;aggregator
op_assign
l_int|NULL
suffix:semicolon
id|port-&gt;next_port_in_aggregator
op_assign
l_int|NULL
suffix:semicolon
id|__disable_port
c_func
(paren
id|port
)paren
suffix:semicolon
id|__initialize_port_locks
c_func
(paren
id|port
)paren
suffix:semicolon
singleline_comment|// aggregator initialization
id|aggregator
op_assign
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|aggregator
)paren
suffix:semicolon
id|ad_initialize_agg
c_func
(paren
id|aggregator
)paren
suffix:semicolon
id|aggregator-&gt;aggregator_mac_address
op_assign
op_star
(paren
(paren
r_struct
id|mac_addr
op_star
)paren
id|bond-&gt;device-&gt;dev_addr
)paren
suffix:semicolon
id|aggregator-&gt;aggregator_identifier
op_assign
(paren
op_increment
id|aggregator_identifier
)paren
suffix:semicolon
id|aggregator-&gt;slave
op_assign
id|slave
suffix:semicolon
id|aggregator-&gt;is_active
op_assign
l_int|0
suffix:semicolon
id|aggregator-&gt;num_of_ports
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * bond_3ad_unbind_slave - deinitialize a slave&squot;s port&n; * @slave: slave struct to work on&n; *&n; * Search for the aggregator that is related to this port, remove the&n; * aggregator and assign another aggregator for other port related to it&n; * (if any), and remove the port.&n; */
DECL|function|bond_3ad_unbind_slave
r_void
id|bond_3ad_unbind_slave
c_func
(paren
r_struct
id|slave
op_star
id|slave
)paren
(brace
r_struct
id|port
op_star
id|port
comma
op_star
id|prev_port
comma
op_star
id|temp_port
suffix:semicolon
r_struct
id|aggregator
op_star
id|aggregator
comma
op_star
id|new_aggregator
comma
op_star
id|temp_aggregator
suffix:semicolon
r_int
id|select_new_active_agg
op_assign
l_int|0
suffix:semicolon
singleline_comment|// find the aggregator related to this slave
id|aggregator
op_assign
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|aggregator
)paren
suffix:semicolon
singleline_comment|// find the port related to this slave
id|port
op_assign
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port
)paren
suffix:semicolon
singleline_comment|// if slave is null, the whole port is not initialized
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;slave
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Trying to unbind an uninitialized port on %s&bslash;n&quot;
comma
id|slave-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;Unbinding Link Aggregation Group %d&bslash;n&quot;
comma
id|aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
multiline_comment|/* Tell the partner that this port is not suitable for aggregation */
id|port-&gt;actor_oper_port_state
op_and_assign
op_complement
id|AD_STATE_AGGREGATION
suffix:semicolon
id|__update_lacpdu_from_port
c_func
(paren
id|port
)paren
suffix:semicolon
id|ad_lacpdu_send
c_func
(paren
id|port
)paren
suffix:semicolon
singleline_comment|// check if this aggregator is occupied
r_if
c_cond
(paren
id|aggregator-&gt;lag_ports
)paren
(brace
singleline_comment|// check if there are other ports related to this aggregator except
singleline_comment|// the port related to this slave(thats ensure us that there is a
singleline_comment|// reason to search for new aggregator, and that we will find one
r_if
c_cond
(paren
(paren
id|aggregator-&gt;lag_ports
op_ne
id|port
)paren
op_logical_or
(paren
id|aggregator-&gt;lag_ports-&gt;next_port_in_aggregator
)paren
)paren
(brace
singleline_comment|// find new aggregator for the related port(s)
id|new_aggregator
op_assign
id|__get_first_agg
c_func
(paren
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|new_aggregator
suffix:semicolon
id|new_aggregator
op_assign
id|__get_next_agg
c_func
(paren
id|new_aggregator
)paren
)paren
(brace
singleline_comment|// if the new aggregator is empty, or it connected to to our port only
r_if
c_cond
(paren
op_logical_neg
id|new_aggregator-&gt;lag_ports
op_logical_or
(paren
(paren
id|new_aggregator-&gt;lag_ports
op_eq
id|port
)paren
op_logical_and
op_logical_neg
id|new_aggregator-&gt;lag_ports-&gt;next_port_in_aggregator
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
singleline_comment|// if new aggregator found, copy the aggregator&squot;s parameters
singleline_comment|// and connect the related lag_ports to the new aggregator
r_if
c_cond
(paren
(paren
id|new_aggregator
)paren
op_logical_and
(paren
(paren
op_logical_neg
id|new_aggregator-&gt;lag_ports
)paren
op_logical_or
(paren
(paren
id|new_aggregator-&gt;lag_ports
op_eq
id|port
)paren
op_logical_and
op_logical_neg
id|new_aggregator-&gt;lag_ports-&gt;next_port_in_aggregator
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Some port(s) related to LAG %d - replaceing with LAG %d&bslash;n&quot;
comma
id|aggregator-&gt;aggregator_identifier
comma
id|new_aggregator-&gt;aggregator_identifier
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_aggregator-&gt;lag_ports
op_eq
id|port
)paren
op_logical_and
id|new_aggregator-&gt;is_active
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_NAME
l_string|&quot;: Removing an active aggregator&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// select new active aggregator
id|select_new_active_agg
op_assign
l_int|1
suffix:semicolon
)brace
id|new_aggregator-&gt;is_individual
op_assign
id|aggregator-&gt;is_individual
suffix:semicolon
id|new_aggregator-&gt;actor_admin_aggregator_key
op_assign
id|aggregator-&gt;actor_admin_aggregator_key
suffix:semicolon
id|new_aggregator-&gt;actor_oper_aggregator_key
op_assign
id|aggregator-&gt;actor_oper_aggregator_key
suffix:semicolon
id|new_aggregator-&gt;partner_system
op_assign
id|aggregator-&gt;partner_system
suffix:semicolon
id|new_aggregator-&gt;partner_system_priority
op_assign
id|aggregator-&gt;partner_system_priority
suffix:semicolon
id|new_aggregator-&gt;partner_oper_aggregator_key
op_assign
id|aggregator-&gt;partner_oper_aggregator_key
suffix:semicolon
id|new_aggregator-&gt;receive_state
op_assign
id|aggregator-&gt;receive_state
suffix:semicolon
id|new_aggregator-&gt;transmit_state
op_assign
id|aggregator-&gt;transmit_state
suffix:semicolon
id|new_aggregator-&gt;lag_ports
op_assign
id|aggregator-&gt;lag_ports
suffix:semicolon
id|new_aggregator-&gt;is_active
op_assign
id|aggregator-&gt;is_active
suffix:semicolon
id|new_aggregator-&gt;num_of_ports
op_assign
id|aggregator-&gt;num_of_ports
suffix:semicolon
singleline_comment|// update the information that is written on the ports about the aggregator
r_for
c_loop
(paren
id|temp_port
op_assign
id|aggregator-&gt;lag_ports
suffix:semicolon
id|temp_port
suffix:semicolon
id|temp_port
op_assign
id|temp_port-&gt;next_port_in_aggregator
)paren
(brace
id|temp_port-&gt;aggregator
op_assign
id|new_aggregator
suffix:semicolon
id|temp_port-&gt;actor_port_aggregator_identifier
op_assign
id|new_aggregator-&gt;aggregator_identifier
suffix:semicolon
)brace
singleline_comment|// clear the aggregator
id|ad_clear_agg
c_func
(paren
id|aggregator
)paren
suffix:semicolon
r_if
c_cond
(paren
id|select_new_active_agg
)paren
(brace
id|ad_agg_selection_logic
c_func
(paren
id|__get_first_agg
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: unbinding aggregator, &quot;
l_string|&quot;and could not find a new aggregator for its ports&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// in case that the only port related to this aggregator is the one we want to remove
id|select_new_active_agg
op_assign
id|aggregator-&gt;is_active
suffix:semicolon
singleline_comment|// clear the aggregator
id|ad_clear_agg
c_func
(paren
id|aggregator
)paren
suffix:semicolon
r_if
c_cond
(paren
id|select_new_active_agg
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Removing an active aggregator&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// select new active aggregator
id|ad_agg_selection_logic
c_func
(paren
id|__get_first_agg
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|dprintk
c_func
(paren
l_string|&quot;Unbinding port %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
singleline_comment|// find the aggregator that this port is connected to
id|temp_aggregator
op_assign
id|__get_first_agg
c_func
(paren
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|temp_aggregator
suffix:semicolon
id|temp_aggregator
op_assign
id|__get_next_agg
c_func
(paren
id|temp_aggregator
)paren
)paren
(brace
id|prev_port
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// search the port in the aggregator&squot;s related ports
r_for
c_loop
(paren
id|temp_port
op_assign
id|temp_aggregator-&gt;lag_ports
suffix:semicolon
id|temp_port
suffix:semicolon
id|prev_port
op_assign
id|temp_port
comma
id|temp_port
op_assign
id|temp_port-&gt;next_port_in_aggregator
)paren
(brace
r_if
c_cond
(paren
id|temp_port
op_eq
id|port
)paren
(brace
singleline_comment|// the aggregator found - detach the port from this aggregator
r_if
c_cond
(paren
id|prev_port
)paren
(brace
id|prev_port-&gt;next_port_in_aggregator
op_assign
id|temp_port-&gt;next_port_in_aggregator
suffix:semicolon
)brace
r_else
(brace
id|temp_aggregator-&gt;lag_ports
op_assign
id|temp_port-&gt;next_port_in_aggregator
suffix:semicolon
)brace
id|temp_aggregator-&gt;num_of_ports
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|temp_aggregator-&gt;num_of_ports
op_eq
l_int|0
)paren
(brace
id|select_new_active_agg
op_assign
id|temp_aggregator-&gt;is_active
suffix:semicolon
singleline_comment|// clear the aggregator
id|ad_clear_agg
c_func
(paren
id|temp_aggregator
)paren
suffix:semicolon
r_if
c_cond
(paren
id|select_new_active_agg
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Removing an active aggregator&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// select new active aggregator
id|ad_agg_selection_logic
c_func
(paren
id|__get_first_agg
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
id|port-&gt;slave
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * bond_3ad_state_machine_handler - handle state machines timeout&n; * @bond: bonding struct to work on&n; *&n; * The state machine handling concept in this module is to check every tick&n; * which state machine should operate any function. The execution order is&n; * round robin, so when we have an interaction between state machines, the&n; * reply of one to each other might be delayed until next tick.&n; *&n; * This function also complete the initialization when the agg_select_timer&n; * times out, and it selects an aggregator for the ports that are yet not&n; * related to any aggregator, and selects the active aggregator for a bond.&n; */
DECL|function|bond_3ad_state_machine_handler
r_void
id|bond_3ad_state_machine_handler
c_func
(paren
r_struct
id|bonding
op_star
id|bond
)paren
(brace
r_struct
id|port
op_star
id|port
suffix:semicolon
r_struct
id|aggregator
op_star
id|aggregator
suffix:semicolon
r_int
id|delta_in_ticks
op_assign
id|AD_TIMER_INTERVAL
op_star
id|HZ
op_div
l_int|1000
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bond-&gt;kill_timers
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
singleline_comment|//check if there are any slaves
r_if
c_cond
(paren
id|bond-&gt;slave_cnt
op_eq
l_int|0
)paren
(brace
r_goto
id|re_arm
suffix:semicolon
)brace
singleline_comment|// check if agg_select_timer timer after initialize is timed out
r_if
c_cond
(paren
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|agg_select_timer
op_logical_and
op_logical_neg
(paren
op_decrement
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|agg_select_timer
)paren
)paren
(brace
singleline_comment|// select the active aggregator for the bond
r_if
c_cond
(paren
(paren
id|port
op_assign
id|__get_first_port
c_func
(paren
id|bond
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;slave
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: bond&squot;s first port is uninitialized&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|re_arm
suffix:semicolon
)brace
id|aggregator
op_assign
id|__get_first_agg
c_func
(paren
id|port
)paren
suffix:semicolon
id|ad_agg_selection_logic
c_func
(paren
id|aggregator
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// for each port run the state machines
r_for
c_loop
(paren
id|port
op_assign
id|__get_first_port
c_func
(paren
id|bond
)paren
suffix:semicolon
id|port
suffix:semicolon
id|port
op_assign
id|__get_next_port
c_func
(paren
id|port
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;slave
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: Found an uninitialized port&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|re_arm
suffix:semicolon
)brace
id|ad_rx_machine
c_func
(paren
l_int|NULL
comma
id|port
)paren
suffix:semicolon
id|ad_periodic_machine
c_func
(paren
id|port
)paren
suffix:semicolon
id|ad_port_selection_logic
c_func
(paren
id|port
)paren
suffix:semicolon
id|ad_mux_machine
c_func
(paren
id|port
)paren
suffix:semicolon
id|ad_tx_machine
c_func
(paren
id|port
)paren
suffix:semicolon
singleline_comment|// turn off the BEGIN bit, since we already handled it
r_if
c_cond
(paren
id|port-&gt;sm_vars
op_amp
id|AD_PORT_BEGIN
)paren
(brace
id|port-&gt;sm_vars
op_and_assign
op_complement
id|AD_PORT_BEGIN
suffix:semicolon
)brace
)brace
id|re_arm
suffix:colon
id|mod_timer
c_func
(paren
op_amp
(paren
id|BOND_AD_INFO
c_func
(paren
id|bond
)paren
dot
id|ad_timer
)paren
comma
id|jiffies
op_plus
id|delta_in_ticks
)paren
suffix:semicolon
id|out
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * bond_3ad_rx_indication - handle a received frame&n; * @lacpdu: received lacpdu&n; * @slave: slave struct to work on&n; * @length: length of the data received&n; *&n; * It is assumed that frames that were sent on this NIC don&squot;t returned as new&n; * received frames (loopback). Since only the payload is given to this&n; * function, it check for loopback.&n; */
DECL|function|bond_3ad_rx_indication
r_void
id|bond_3ad_rx_indication
c_func
(paren
r_struct
id|lacpdu
op_star
id|lacpdu
comma
r_struct
id|slave
op_star
id|slave
comma
id|u16
id|length
)paren
(brace
r_struct
id|port
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|length
op_ge
r_sizeof
(paren
r_struct
id|lacpdu
)paren
)paren
(brace
id|port
op_assign
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;slave
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: port of slave %s is uninitialized&bslash;n&quot;
comma
id|slave-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|lacpdu-&gt;subtype
)paren
(brace
r_case
id|AD_TYPE_LACPDU
suffix:colon
id|__ntohs_lacpdu
c_func
(paren
id|lacpdu
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Received LACPDU on port %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
id|ad_rx_machine
c_func
(paren
id|lacpdu
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_TYPE_MARKER
suffix:colon
singleline_comment|// No need to convert fields to Little Endian since we don&squot;t use the marker&squot;s fields.
r_switch
c_cond
(paren
(paren
(paren
r_struct
id|marker
op_star
)paren
id|lacpdu
)paren
op_member_access_from_pointer
id|tlv_type
)paren
(brace
r_case
id|AD_MARKER_INFORMATION_SUBTYPE
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;Received Marker Information on port %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
id|ad_marker_info_received
c_func
(paren
(paren
r_struct
id|marker
op_star
)paren
id|lacpdu
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD_MARKER_RESPONSE_SUBTYPE
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;Received Marker Response on port %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
id|ad_marker_response_received
c_func
(paren
(paren
r_struct
id|marker
op_star
)paren
id|lacpdu
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;Received an unknown Marker subtype on slot %d&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/**&n; * bond_3ad_adapter_speed_changed - handle a slave&squot;s speed change indication&n; * @slave: slave struct to work on&n; *&n; * Handle reselection of aggregator (if needed) for this port.&n; */
DECL|function|bond_3ad_adapter_speed_changed
r_void
id|bond_3ad_adapter_speed_changed
c_func
(paren
r_struct
id|slave
op_star
id|slave
)paren
(brace
r_struct
id|port
op_star
id|port
suffix:semicolon
id|port
op_assign
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port
)paren
suffix:semicolon
singleline_comment|// if slave is null, the whole port is not initialized
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;slave
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: speed changed for uninitialized port on %s&bslash;n&quot;
comma
id|slave-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|port-&gt;actor_admin_port_key
op_and_assign
op_complement
id|AD_SPEED_KEY_BITS
suffix:semicolon
id|port-&gt;actor_oper_port_key
op_assign
id|port-&gt;actor_admin_port_key
op_or_assign
(paren
id|__get_link_speed
c_func
(paren
id|port
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Port %d changed speed&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
singleline_comment|// there is no need to reselect a new aggregator, just signal the
singleline_comment|// state machines to reinitialize
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_BEGIN
suffix:semicolon
)brace
multiline_comment|/**&n; * bond_3ad_adapter_duplex_changed - handle a slave&squot;s duplex change indication&n; * @slave: slave struct to work on&n; *&n; * Handle reselection of aggregator (if needed) for this port.&n; */
DECL|function|bond_3ad_adapter_duplex_changed
r_void
id|bond_3ad_adapter_duplex_changed
c_func
(paren
r_struct
id|slave
op_star
id|slave
)paren
(brace
r_struct
id|port
op_star
id|port
suffix:semicolon
id|port
op_assign
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port
)paren
suffix:semicolon
singleline_comment|// if slave is null, the whole port is not initialized
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;slave
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: duplex changed for uninitialized port on %s&bslash;n&quot;
comma
id|slave-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|port-&gt;actor_admin_port_key
op_and_assign
op_complement
id|AD_DUPLEX_KEY_BITS
suffix:semicolon
id|port-&gt;actor_oper_port_key
op_assign
id|port-&gt;actor_admin_port_key
op_or_assign
id|__get_duplex
c_func
(paren
id|port
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Port %d changed duplex&bslash;n&quot;
comma
id|port-&gt;actor_port_number
)paren
suffix:semicolon
singleline_comment|// there is no need to reselect a new aggregator, just signal the
singleline_comment|// state machines to reinitialize
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_BEGIN
suffix:semicolon
)brace
multiline_comment|/**&n; * bond_3ad_handle_link_change - handle a slave&squot;s link status change indication&n; * @slave: slave struct to work on&n; * @status: whether the link is now up or down&n; *&n; * Handle reselection of aggregator (if needed) for this port.&n; */
DECL|function|bond_3ad_handle_link_change
r_void
id|bond_3ad_handle_link_change
c_func
(paren
r_struct
id|slave
op_star
id|slave
comma
r_char
id|link
)paren
(brace
r_struct
id|port
op_star
id|port
suffix:semicolon
id|port
op_assign
op_amp
(paren
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port
)paren
suffix:semicolon
singleline_comment|// if slave is null, the whole port is not initialized
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;slave
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: Warning: link status changed for uninitialized port on %s&bslash;n&quot;
comma
id|slave-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// on link down we are zeroing duplex and speed since some of the adaptors(ce1000.lan) report full duplex/speed instead of N/A(duplex) / 0(speed)
singleline_comment|// on link up we are forcing recheck on the duplex and speed since some of he adaptors(ce1000.lan) report
r_if
c_cond
(paren
id|link
op_eq
id|BOND_LINK_UP
)paren
(brace
id|port-&gt;is_enabled
op_assign
l_int|1
suffix:semicolon
id|port-&gt;actor_admin_port_key
op_and_assign
op_complement
id|AD_DUPLEX_KEY_BITS
suffix:semicolon
id|port-&gt;actor_oper_port_key
op_assign
id|port-&gt;actor_admin_port_key
op_or_assign
id|__get_duplex
c_func
(paren
id|port
)paren
suffix:semicolon
id|port-&gt;actor_admin_port_key
op_and_assign
op_complement
id|AD_SPEED_KEY_BITS
suffix:semicolon
id|port-&gt;actor_oper_port_key
op_assign
id|port-&gt;actor_admin_port_key
op_or_assign
(paren
id|__get_link_speed
c_func
(paren
id|port
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* link has failed */
id|port-&gt;is_enabled
op_assign
l_int|0
suffix:semicolon
id|port-&gt;actor_admin_port_key
op_and_assign
op_complement
id|AD_DUPLEX_KEY_BITS
suffix:semicolon
id|port-&gt;actor_oper_port_key
op_assign
(paren
id|port-&gt;actor_admin_port_key
op_and_assign
op_complement
id|AD_SPEED_KEY_BITS
)paren
suffix:semicolon
)brace
singleline_comment|//BOND_PRINT_DBG((&quot;Port %d changed link status to %s&quot;, port-&gt;actor_port_number, ((link == BOND_LINK_UP)?&quot;UP&quot;:&quot;DOWN&quot;)));
singleline_comment|// there is no need to reselect a new aggregator, just signal the
singleline_comment|// state machines to reinitialize
id|port-&gt;sm_vars
op_or_assign
id|AD_PORT_BEGIN
suffix:semicolon
)brace
multiline_comment|/**&n; * bond_3ad_get_active_agg_info - get information of the active aggregator&n; * @bond: bonding struct to work on&n; * @ad_info: ad_info struct to fill with the bond&squot;s info&n; *&n; * Returns:   0 on success&n; *          &lt; 0 on error&n; */
DECL|function|bond_3ad_get_active_agg_info
r_int
id|bond_3ad_get_active_agg_info
c_func
(paren
r_struct
id|bonding
op_star
id|bond
comma
r_struct
id|ad_info
op_star
id|ad_info
)paren
(brace
r_struct
id|aggregator
op_star
id|aggregator
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|port
op_star
id|port
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|__get_first_port
c_func
(paren
id|bond
)paren
suffix:semicolon
id|port
suffix:semicolon
id|port
op_assign
id|__get_next_port
c_func
(paren
id|port
)paren
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;aggregator
op_logical_and
id|port-&gt;aggregator-&gt;is_active
)paren
(brace
id|aggregator
op_assign
id|port-&gt;aggregator
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|aggregator
)paren
(brace
id|ad_info-&gt;aggregator_id
op_assign
id|aggregator-&gt;aggregator_identifier
suffix:semicolon
id|ad_info-&gt;ports
op_assign
id|aggregator-&gt;num_of_ports
suffix:semicolon
id|ad_info-&gt;actor_key
op_assign
id|aggregator-&gt;actor_oper_aggregator_key
suffix:semicolon
id|ad_info-&gt;partner_key
op_assign
id|aggregator-&gt;partner_oper_aggregator_key
suffix:semicolon
id|memcpy
c_func
(paren
id|ad_info-&gt;partner_system
comma
id|aggregator-&gt;partner_system.mac_addr_value
comma
id|ETH_ALEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|bond_3ad_xmit_xor
r_int
id|bond_3ad_xmit_xor
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|slave
op_star
id|slave
comma
op_star
id|start_at
suffix:semicolon
r_struct
id|bonding
op_star
id|bond
op_assign
(paren
r_struct
id|bonding
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ethhdr
op_star
id|data
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
id|slave_agg_no
suffix:semicolon
r_int
id|slaves_in_agg
suffix:semicolon
r_int
id|agg_id
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|ad_info
id|ad_info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_UP
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* bond down */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bond
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: Error: bond is NULL on device %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|read_lock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* check if bond is empty */
r_if
c_cond
(paren
id|bond-&gt;slave_cnt
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|DRV_NAME
l_string|&quot;: Error: bond is empty&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bond_3ad_get_active_agg_info
c_func
(paren
id|bond
comma
op_amp
id|ad_info
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ERROR: bond_3ad_get_active_agg_info failed&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|slaves_in_agg
op_assign
id|ad_info.ports
suffix:semicolon
id|agg_id
op_assign
id|ad_info.aggregator_id
suffix:semicolon
r_if
c_cond
(paren
id|slaves_in_agg
op_eq
l_int|0
)paren
(brace
multiline_comment|/*the aggregator is empty*/
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ERROR: active aggregator is empty&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|slave_agg_no
op_assign
(paren
id|data-&gt;h_dest
(braket
l_int|5
)braket
op_xor
id|bond-&gt;device-&gt;dev_addr
(braket
l_int|5
)braket
)paren
op_mod
id|slaves_in_agg
suffix:semicolon
id|bond_for_each_slave
c_func
(paren
id|bond
comma
id|slave
comma
id|i
)paren
(brace
r_struct
id|aggregator
op_star
id|agg
op_assign
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port.aggregator
suffix:semicolon
r_if
c_cond
(paren
id|agg
op_logical_and
(paren
id|agg-&gt;aggregator_identifier
op_eq
id|agg_id
)paren
)paren
(brace
id|slave_agg_no
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|slave_agg_no
OL
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|slave_agg_no
op_ge
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: Error: Couldn&squot;t find a slave to tx on for aggregator ID %d&bslash;n&quot;
comma
id|agg_id
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|start_at
op_assign
id|slave
suffix:semicolon
id|bond_for_each_slave_from
c_func
(paren
id|bond
comma
id|slave
comma
id|i
comma
id|start_at
)paren
(brace
r_int
id|slave_agg_id
op_assign
l_int|0
suffix:semicolon
r_struct
id|aggregator
op_star
id|agg
op_assign
id|SLAVE_AD_INFO
c_func
(paren
id|slave
)paren
dot
id|port.aggregator
suffix:semicolon
r_if
c_cond
(paren
id|agg
)paren
(brace
id|slave_agg_id
op_assign
id|agg-&gt;aggregator_identifier
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SLAVE_IS_OK
c_func
(paren
id|slave
)paren
op_logical_and
id|agg
op_logical_and
(paren
id|slave_agg_id
op_eq
id|agg_id
)paren
)paren
(brace
id|skb-&gt;dev
op_assign
id|slave-&gt;dev
suffix:semicolon
id|skb-&gt;priority
op_assign
l_int|1
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* no suitable interface, frame not sent */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bond_3ad_lacpdu_recv
r_int
id|bond_3ad_lacpdu_recv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|ptype
)paren
(brace
r_struct
id|bonding
op_star
id|bond
op_assign
(paren
r_struct
id|bonding
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slave
op_star
id|slave
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
op_assign
id|NET_RX_DROP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_MASTER
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|read_lock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
id|slave
op_assign
id|bond_get_slave_by_dev
c_func
(paren
(paren
r_struct
id|bonding
op_star
)paren
id|dev-&gt;priv
comma
id|skb-&gt;real_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slave
op_eq
l_int|NULL
)paren
(brace
r_goto
id|out_unlock
suffix:semicolon
)brace
id|bond_3ad_rx_indication
c_func
(paren
(paren
r_struct
id|lacpdu
op_star
)paren
id|skb-&gt;data
comma
id|slave
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|ret
op_assign
id|NET_RX_SUCCESS
suffix:semicolon
id|out_unlock
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|bond-&gt;lock
)paren
suffix:semicolon
id|out
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
