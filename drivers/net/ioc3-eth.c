multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Driver for SGI&squot;s IOC3 based Ethernet cards as found in the PCI card.&n; *&n; * Copyright (C) 1999, 2000, 2001, 2003 Ralf Baechle&n; * Copyright (C) 1995, 1999, 2000, 2001 by Silicon Graphics, Inc.&n; *&n; * References:&n; *  o IOC3 ASIC specification 4.51, 1996-04-18&n; *  o IEEE 802.3 specification, 2000 edition&n; *  o DP38840A Specification, National Semiconductor, March 1997&n; *&n; * To do:&n; *&n; *  o Handle allocation failures in ioc3_alloc_skb() more gracefully.&n; *  o Handle allocation failures in ioc3_init_rings().&n; *  o Use prefetching for large packets.  What is a good lower limit for&n; *    prefetching?&n; *  o We&squot;re probably allocating a bit too much memory.&n; *  o Use hardware checksums.&n; *  o Convert to using a IOC3 meta driver.&n; *  o Which PHYs might possibly be attached to the IOC3 in real live,&n; *    which workarounds are required for them?  Do we ever have Lucent&squot;s?&n; *  o For the 2.5 branch kill the mii-tool ioctls.&n; */
DECL|macro|IOC3_NAME
mdefine_line|#define IOC3_NAME&t;&quot;ioc3-eth&quot;
DECL|macro|IOC3_VERSION
mdefine_line|#define IOC3_VERSION&t;&quot;2.6.3-3&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#ifdef CONFIG_SERIAL_8250
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;asm/serial.h&gt;
DECL|macro|IOC3_BAUD
mdefine_line|#define IOC3_BAUD (22000000 / (3*16))
DECL|macro|IOC3_COM_FLAGS
mdefine_line|#define IOC3_COM_FLAGS (ASYNC_BOOT_AUTOCONF | ASYNC_SKIP_TEST)
macro_line|#endif
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/dp83840.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/sn/types.h&gt;
macro_line|#include &lt;asm/sn/sn0/addrs.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubni.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubio.h&gt;
macro_line|#include &lt;asm/sn/klconfig.h&gt;
macro_line|#include &lt;asm/sn/ioc3.h&gt;
macro_line|#include &lt;asm/sn/sn0/ip27.h&gt;
macro_line|#include &lt;asm/pci/bridge.h&gt;
multiline_comment|/*&n; * 64 RX buffers.  This is tunable in the range of 16 &lt;= x &lt; 512.  The&n; * value must be a power of two.&n; */
DECL|macro|RX_BUFFS
mdefine_line|#define RX_BUFFS 64
DECL|macro|ETCSR_FD
mdefine_line|#define ETCSR_FD&t;((17&lt;&lt;ETCSR_IPGR2_SHIFT) | (11&lt;&lt;ETCSR_IPGR1_SHIFT) | 21)
DECL|macro|ETCSR_HD
mdefine_line|#define ETCSR_HD&t;((21&lt;&lt;ETCSR_IPGR2_SHIFT) | (21&lt;&lt;ETCSR_IPGR1_SHIFT) | 21)
multiline_comment|/* Private per NIC data of the driver.  */
DECL|struct|ioc3_private
r_struct
id|ioc3_private
(brace
DECL|member|regs
r_struct
id|ioc3
op_star
id|regs
suffix:semicolon
DECL|member|rxr
r_int
r_int
op_star
id|rxr
suffix:semicolon
multiline_comment|/* pointer to receiver ring */
DECL|member|txr
r_struct
id|ioc3_etxd
op_star
id|txr
suffix:semicolon
DECL|member|rx_skbs
r_struct
id|sk_buff
op_star
id|rx_skbs
(braket
l_int|512
)braket
suffix:semicolon
DECL|member|tx_skbs
r_struct
id|sk_buff
op_star
id|tx_skbs
(braket
l_int|128
)braket
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|rx_ci
r_int
id|rx_ci
suffix:semicolon
multiline_comment|/* RX consumer index */
DECL|member|rx_pi
r_int
id|rx_pi
suffix:semicolon
multiline_comment|/* RX producer index */
DECL|member|tx_ci
r_int
id|tx_ci
suffix:semicolon
multiline_comment|/* TX consumer index */
DECL|member|tx_pi
r_int
id|tx_pi
suffix:semicolon
multiline_comment|/* TX producer index */
DECL|member|txqlen
r_int
id|txqlen
suffix:semicolon
DECL|member|emcr
DECL|member|ehar_h
DECL|member|ehar_l
id|u32
id|emcr
comma
id|ehar_h
comma
id|ehar_l
suffix:semicolon
DECL|member|ioc3_lock
id|spinlock_t
id|ioc3_lock
suffix:semicolon
DECL|member|mii
r_struct
id|mii_if_info
id|mii
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
multiline_comment|/* Members used by autonegotiation  */
DECL|member|ioc3_timer
r_struct
id|timer_list
id|ioc3_timer
suffix:semicolon
)brace
suffix:semicolon
DECL|function|priv_netdev
r_static
r_inline
r_struct
id|net_device
op_star
id|priv_netdev
c_func
(paren
r_struct
id|ioc3_private
op_star
id|dev
)paren
(brace
r_return
(paren
r_void
op_star
)paren
id|dev
op_minus
(paren
(paren
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
l_int|31
)paren
op_amp
op_complement
l_int|31
)paren
suffix:semicolon
)brace
r_static
r_int
id|ioc3_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|ioc3_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ioc3_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ioc3_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_inline
r_int
r_int
id|ioc3_hash
c_func
(paren
r_const
r_int
r_char
op_star
id|addr
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ioc3_stop
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
suffix:semicolon
r_static
r_void
id|ioc3_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|ioc3_str
r_static
r_const
r_char
id|ioc3_str
(braket
)braket
op_assign
l_string|&quot;IOC3 Ethernet&quot;
suffix:semicolon
DECL|variable|ioc3_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|ioc3_ethtool_ops
suffix:semicolon
multiline_comment|/* We use this to acquire receive skb&squot;s that we can DMA directly into. */
DECL|macro|IOC3_CACHELINE
mdefine_line|#define IOC3_CACHELINE&t;128UL
DECL|function|aligned_rx_skb_addr
r_static
r_inline
r_int
r_int
id|aligned_rx_skb_addr
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
(paren
op_complement
id|addr
op_plus
l_int|1
)paren
op_amp
(paren
id|IOC3_CACHELINE
op_minus
l_int|1UL
)paren
suffix:semicolon
)brace
DECL|function|ioc3_alloc_skb
r_static
r_inline
r_struct
id|sk_buff
op_star
id|ioc3_alloc_skb
c_func
(paren
r_int
r_int
id|length
comma
r_int
r_int
id|gfp_mask
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
op_plus
id|IOC3_CACHELINE
op_minus
l_int|1
comma
id|gfp_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|skb
)paren
)paren
(brace
r_int
id|offset
op_assign
id|aligned_rx_skb_addr
c_func
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
)paren
id|skb_reserve
c_func
(paren
id|skb
comma
id|offset
)paren
suffix:semicolon
)brace
r_return
id|skb
suffix:semicolon
)brace
DECL|function|ioc3_map
r_static
r_inline
r_int
r_int
id|ioc3_map
c_func
(paren
r_void
op_star
id|ptr
comma
r_int
r_int
id|vdev
)paren
(brace
macro_line|#ifdef CONFIG_SGI_IP27
id|vdev
op_lshift_assign
l_int|58
suffix:semicolon
multiline_comment|/* Shift to PCI64_ATTR_VIRTUAL */
r_return
id|vdev
op_or
(paren
l_int|0xaUL
op_lshift
id|PCI64_ATTR_TARG_SHFT
)paren
op_or
id|PCI64_ATTR_PREF
op_or
(paren
(paren
r_int
r_int
)paren
id|ptr
op_amp
id|TO_PHYS_MASK
)paren
suffix:semicolon
macro_line|#else
r_return
id|virt_to_bus
c_func
(paren
id|ptr
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* BEWARE: The IOC3 documentation documents the size of rx buffers as&n;   1644 while it&squot;s actually 1664.  This one was nasty to track down ...  */
DECL|macro|RX_OFFSET
mdefine_line|#define RX_OFFSET&t;&t;10
DECL|macro|RX_BUF_ALLOC_SIZE
mdefine_line|#define RX_BUF_ALLOC_SIZE&t;(1664 + RX_OFFSET + IOC3_CACHELINE)
multiline_comment|/* DMA barrier to separate cached and uncached accesses.  */
DECL|macro|BARRIER
mdefine_line|#define BARRIER()&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;__asm__(&quot;sync&quot; ::: &quot;memory&quot;)
DECL|macro|IOC3_SIZE
mdefine_line|#define IOC3_SIZE 0x100000
multiline_comment|/*&n; * IOC3 is a big endian device&n; *&n; * Unorthodox but makes the users of these macros more readable - the pointer&n; * to the IOC3&squot;s memory mapped registers is expected as struct ioc3 * ioc3&n; * in the environment.&n; */
DECL|macro|ioc3_r_mcr
mdefine_line|#define ioc3_r_mcr()&t;&t;be32_to_cpu(ioc3-&gt;mcr)
DECL|macro|ioc3_w_mcr
mdefine_line|#define ioc3_w_mcr(v)&t;&t;do { ioc3-&gt;mcr = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_w_gpcr_s
mdefine_line|#define ioc3_w_gpcr_s(v)&t;do { ioc3-&gt;gpcr_s = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_emcr
mdefine_line|#define ioc3_r_emcr()&t;&t;be32_to_cpu(ioc3-&gt;emcr)
DECL|macro|ioc3_w_emcr
mdefine_line|#define ioc3_w_emcr(v)&t;&t;do { ioc3-&gt;emcr = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_eisr
mdefine_line|#define ioc3_r_eisr()&t;&t;be32_to_cpu(ioc3-&gt;eisr)
DECL|macro|ioc3_w_eisr
mdefine_line|#define ioc3_w_eisr(v)&t;&t;do { ioc3-&gt;eisr = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_eier
mdefine_line|#define ioc3_r_eier()&t;&t;be32_to_cpu(ioc3-&gt;eier)
DECL|macro|ioc3_w_eier
mdefine_line|#define ioc3_w_eier(v)&t;&t;do { ioc3-&gt;eier = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_ercsr
mdefine_line|#define ioc3_r_ercsr()&t;&t;be32_to_cpu(ioc3-&gt;ercsr)
DECL|macro|ioc3_w_ercsr
mdefine_line|#define ioc3_w_ercsr(v)&t;&t;do { ioc3-&gt;ercsr = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_erbr_h
mdefine_line|#define ioc3_r_erbr_h()&t;&t;be32_to_cpu(ioc3-&gt;erbr_h)
DECL|macro|ioc3_w_erbr_h
mdefine_line|#define ioc3_w_erbr_h(v)&t;do { ioc3-&gt;erbr_h = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_erbr_l
mdefine_line|#define ioc3_r_erbr_l()&t;&t;be32_to_cpu(ioc3-&gt;erbr_l)
DECL|macro|ioc3_w_erbr_l
mdefine_line|#define ioc3_w_erbr_l(v)&t;do { ioc3-&gt;erbr_l = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_erbar
mdefine_line|#define ioc3_r_erbar()&t;&t;be32_to_cpu(ioc3-&gt;erbar)
DECL|macro|ioc3_w_erbar
mdefine_line|#define ioc3_w_erbar(v)&t;&t;do { ioc3-&gt;erbar = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_ercir
mdefine_line|#define ioc3_r_ercir()&t;&t;be32_to_cpu(ioc3-&gt;ercir)
DECL|macro|ioc3_w_ercir
mdefine_line|#define ioc3_w_ercir(v)&t;&t;do { ioc3-&gt;ercir = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_erpir
mdefine_line|#define ioc3_r_erpir()&t;&t;be32_to_cpu(ioc3-&gt;erpir)
DECL|macro|ioc3_w_erpir
mdefine_line|#define ioc3_w_erpir(v)&t;&t;do { ioc3-&gt;erpir = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_ertr
mdefine_line|#define ioc3_r_ertr()&t;&t;be32_to_cpu(ioc3-&gt;ertr)
DECL|macro|ioc3_w_ertr
mdefine_line|#define ioc3_w_ertr(v)&t;&t;do { ioc3-&gt;ertr = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_etcsr
mdefine_line|#define ioc3_r_etcsr()&t;&t;be32_to_cpu(ioc3-&gt;etcsr)
DECL|macro|ioc3_w_etcsr
mdefine_line|#define ioc3_w_etcsr(v)&t;&t;do { ioc3-&gt;etcsr = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_ersr
mdefine_line|#define ioc3_r_ersr()&t;&t;be32_to_cpu(ioc3-&gt;ersr)
DECL|macro|ioc3_w_ersr
mdefine_line|#define ioc3_w_ersr(v)&t;&t;do { ioc3-&gt;ersr = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_etcdc
mdefine_line|#define ioc3_r_etcdc()&t;&t;be32_to_cpu(ioc3-&gt;etcdc)
DECL|macro|ioc3_w_etcdc
mdefine_line|#define ioc3_w_etcdc(v)&t;&t;do { ioc3-&gt;etcdc = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_ebir
mdefine_line|#define ioc3_r_ebir()&t;&t;be32_to_cpu(ioc3-&gt;ebir)
DECL|macro|ioc3_w_ebir
mdefine_line|#define ioc3_w_ebir(v)&t;&t;do { ioc3-&gt;ebir = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_etbr_h
mdefine_line|#define ioc3_r_etbr_h()&t;&t;be32_to_cpu(ioc3-&gt;etbr_h)
DECL|macro|ioc3_w_etbr_h
mdefine_line|#define ioc3_w_etbr_h(v)&t;do { ioc3-&gt;etbr_h = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_etbr_l
mdefine_line|#define ioc3_r_etbr_l()&t;&t;be32_to_cpu(ioc3-&gt;etbr_l)
DECL|macro|ioc3_w_etbr_l
mdefine_line|#define ioc3_w_etbr_l(v)&t;do { ioc3-&gt;etbr_l = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_etcir
mdefine_line|#define ioc3_r_etcir()&t;&t;be32_to_cpu(ioc3-&gt;etcir)
DECL|macro|ioc3_w_etcir
mdefine_line|#define ioc3_w_etcir(v)&t;&t;do { ioc3-&gt;etcir = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_etpir
mdefine_line|#define ioc3_r_etpir()&t;&t;be32_to_cpu(ioc3-&gt;etpir)
DECL|macro|ioc3_w_etpir
mdefine_line|#define ioc3_w_etpir(v)&t;&t;do { ioc3-&gt;etpir = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_emar_h
mdefine_line|#define ioc3_r_emar_h()&t;&t;be32_to_cpu(ioc3-&gt;emar_h)
DECL|macro|ioc3_w_emar_h
mdefine_line|#define ioc3_w_emar_h(v)&t;do { ioc3-&gt;emar_h = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_emar_l
mdefine_line|#define ioc3_r_emar_l()&t;&t;be32_to_cpu(ioc3-&gt;emar_l)
DECL|macro|ioc3_w_emar_l
mdefine_line|#define ioc3_w_emar_l(v)&t;do { ioc3-&gt;emar_l = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_ehar_h
mdefine_line|#define ioc3_r_ehar_h()&t;&t;be32_to_cpu(ioc3-&gt;ehar_h)
DECL|macro|ioc3_w_ehar_h
mdefine_line|#define ioc3_w_ehar_h(v)&t;do { ioc3-&gt;ehar_h = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_ehar_l
mdefine_line|#define ioc3_r_ehar_l()&t;&t;be32_to_cpu(ioc3-&gt;ehar_l)
DECL|macro|ioc3_w_ehar_l
mdefine_line|#define ioc3_w_ehar_l(v)&t;do { ioc3-&gt;ehar_l = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_micr
mdefine_line|#define ioc3_r_micr()&t;&t;be32_to_cpu(ioc3-&gt;micr)
DECL|macro|ioc3_w_micr
mdefine_line|#define ioc3_w_micr(v)&t;&t;do { ioc3-&gt;micr = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_midr_r
mdefine_line|#define ioc3_r_midr_r()&t;&t;be32_to_cpu(ioc3-&gt;midr_r)
DECL|macro|ioc3_w_midr_r
mdefine_line|#define ioc3_w_midr_r(v)&t;do { ioc3-&gt;midr_r = cpu_to_be32(v); } while (0)
DECL|macro|ioc3_r_midr_w
mdefine_line|#define ioc3_r_midr_w()&t;&t;be32_to_cpu(ioc3-&gt;midr_w)
DECL|macro|ioc3_w_midr_w
mdefine_line|#define ioc3_w_midr_w(v)&t;do { ioc3-&gt;midr_w = cpu_to_be32(v); } while (0)
DECL|function|mcr_pack
r_static
r_inline
id|u32
id|mcr_pack
c_func
(paren
id|u32
id|pulse
comma
id|u32
id|sample
)paren
(brace
r_return
(paren
id|pulse
op_lshift
l_int|10
)paren
op_or
(paren
id|sample
op_lshift
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|nic_wait
r_static
r_int
id|nic_wait
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
id|u32
id|mcr
suffix:semicolon
r_do
(brace
id|mcr
op_assign
id|ioc3_r_mcr
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|mcr
op_amp
l_int|2
)paren
)paren
suffix:semicolon
r_return
id|mcr
op_amp
l_int|1
suffix:semicolon
)brace
DECL|function|nic_reset
r_static
r_int
id|nic_reset
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_int
id|presence
suffix:semicolon
id|ioc3_w_mcr
c_func
(paren
id|mcr_pack
c_func
(paren
l_int|500
comma
l_int|65
)paren
)paren
suffix:semicolon
id|presence
op_assign
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
id|ioc3_w_mcr
c_func
(paren
id|mcr_pack
c_func
(paren
l_int|0
comma
l_int|500
)paren
)paren
suffix:semicolon
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
r_return
id|presence
suffix:semicolon
)brace
DECL|function|nic_read_bit
r_static
r_inline
r_int
id|nic_read_bit
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_int
id|result
suffix:semicolon
id|ioc3_w_mcr
c_func
(paren
id|mcr_pack
c_func
(paren
l_int|6
comma
l_int|13
)paren
)paren
suffix:semicolon
id|result
op_assign
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
id|ioc3_w_mcr
c_func
(paren
id|mcr_pack
c_func
(paren
l_int|0
comma
l_int|100
)paren
)paren
suffix:semicolon
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|nic_write_bit
r_static
r_inline
r_void
id|nic_write_bit
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
comma
r_int
id|bit
)paren
(brace
r_if
c_cond
(paren
id|bit
)paren
id|ioc3_w_mcr
c_func
(paren
id|mcr_pack
c_func
(paren
l_int|6
comma
l_int|110
)paren
)paren
suffix:semicolon
r_else
id|ioc3_w_mcr
c_func
(paren
id|mcr_pack
c_func
(paren
l_int|80
comma
l_int|30
)paren
)paren
suffix:semicolon
id|nic_wait
c_func
(paren
id|ioc3
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Read a byte from an iButton device&n; */
DECL|function|nic_read_byte
r_static
id|u32
id|nic_read_byte
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
id|u32
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|result
op_assign
(paren
id|result
op_rshift
l_int|1
)paren
op_or
(paren
id|nic_read_bit
c_func
(paren
id|ioc3
)paren
op_lshift
l_int|7
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Write a byte to an iButton device&n; */
DECL|function|nic_write_byte
r_static
r_void
id|nic_write_byte
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
comma
r_int
id|byte
)paren
(brace
r_int
id|i
comma
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|8
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|bit
op_assign
id|byte
op_amp
l_int|1
suffix:semicolon
id|byte
op_rshift_assign
l_int|1
suffix:semicolon
id|nic_write_bit
c_func
(paren
id|ioc3
comma
id|bit
)paren
suffix:semicolon
)brace
)brace
DECL|function|nic_find
r_static
id|u64
id|nic_find
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
comma
r_int
op_star
id|last
)paren
(brace
r_int
id|a
comma
id|b
comma
id|index
comma
id|disc
suffix:semicolon
id|u64
id|address
op_assign
l_int|0
suffix:semicolon
id|nic_reset
c_func
(paren
id|ioc3
)paren
suffix:semicolon
multiline_comment|/* Search ROM.  */
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0xf0
)paren
suffix:semicolon
multiline_comment|/* Algorithm from ``Book of iButton Standards&squot;&squot;.  */
r_for
c_loop
(paren
id|index
op_assign
l_int|0
comma
id|disc
op_assign
l_int|0
suffix:semicolon
id|index
OL
l_int|64
suffix:semicolon
id|index
op_increment
)paren
(brace
id|a
op_assign
id|nic_read_bit
c_func
(paren
id|ioc3
)paren
suffix:semicolon
id|b
op_assign
id|nic_read_bit
c_func
(paren
id|ioc3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
op_logical_and
id|b
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NIC search failed (not fatal).&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|last
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|a
op_logical_and
op_logical_neg
id|b
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
op_star
id|last
)paren
(brace
id|address
op_or_assign
l_int|1UL
op_lshift
id|index
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|index
OG
op_star
id|last
)paren
(brace
id|address
op_and_assign
op_complement
(paren
l_int|1UL
op_lshift
id|index
)paren
suffix:semicolon
id|disc
op_assign
id|index
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|address
op_amp
(paren
l_int|1UL
op_lshift
id|index
)paren
)paren
op_eq
l_int|0
)paren
id|disc
op_assign
id|index
suffix:semicolon
id|nic_write_bit
c_func
(paren
id|ioc3
comma
id|address
op_amp
(paren
l_int|1UL
op_lshift
id|index
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|a
)paren
id|address
op_or_assign
l_int|1UL
op_lshift
id|index
suffix:semicolon
r_else
id|address
op_and_assign
op_complement
(paren
l_int|1UL
op_lshift
id|index
)paren
suffix:semicolon
id|nic_write_bit
c_func
(paren
id|ioc3
comma
id|a
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
op_star
id|last
op_assign
id|disc
suffix:semicolon
r_return
id|address
suffix:semicolon
)brace
DECL|function|nic_init
r_static
r_int
id|nic_init
c_func
(paren
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_const
r_char
op_star
id|type
suffix:semicolon
id|u8
id|crc
suffix:semicolon
id|u8
id|serial
(braket
l_int|6
)braket
suffix:semicolon
r_int
id|save
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|type
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|u64
id|reg
suffix:semicolon
id|reg
op_assign
id|nic_find
c_func
(paren
id|ioc3
comma
op_amp
id|save
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reg
op_amp
l_int|0xff
)paren
(brace
r_case
l_int|0x91
suffix:colon
id|type
op_assign
l_string|&quot;DS1981U&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|save
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Let the caller try again.  */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
id|nic_reset
c_func
(paren
id|ioc3
)paren
suffix:semicolon
multiline_comment|/* Match ROM.  */
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0x55
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|nic_write_byte
c_func
(paren
id|ioc3
comma
(paren
id|reg
op_rshift
(paren
id|i
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|reg
op_rshift_assign
l_int|8
suffix:semicolon
multiline_comment|/* Shift out type.  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|serial
(braket
id|i
)braket
op_assign
id|reg
op_amp
l_int|0xff
suffix:semicolon
id|reg
op_rshift_assign
l_int|8
suffix:semicolon
)brace
id|crc
op_assign
id|reg
op_amp
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Found %s NIC&quot;
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
l_string|&quot;unknown&quot;
)paren
(brace
id|printk
(paren
l_string|&quot; registration number %02x:%02x:%02x:%02x:%02x:%02x,&quot;
l_string|&quot; CRC %02x&quot;
comma
id|serial
(braket
l_int|0
)braket
comma
id|serial
(braket
l_int|1
)braket
comma
id|serial
(braket
l_int|2
)braket
comma
id|serial
(braket
l_int|3
)braket
comma
id|serial
(braket
l_int|4
)braket
comma
id|serial
(braket
l_int|5
)braket
comma
id|crc
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Read the NIC (Number-In-a-Can) device used to store the MAC address on&n; * SN0 / SN00 nodeboards and PCI cards.&n; */
DECL|function|ioc3_get_eaddr_nic
r_static
r_void
id|ioc3_get_eaddr_nic
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|u8
id|nic
(braket
l_int|14
)braket
suffix:semicolon
r_int
id|tries
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* There may be some problem with the battery?  */
r_int
id|i
suffix:semicolon
id|ioc3_w_gpcr_s
c_func
(paren
l_int|1
op_lshift
l_int|21
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tries
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nic_init
c_func
(paren
id|ioc3
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to read MAC address&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Read Memory.  */
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0xf0
)paren
suffix:semicolon
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0x00
)paren
suffix:semicolon
id|nic_write_byte
c_func
(paren
id|ioc3
comma
l_int|0x00
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|13
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|nic
(braket
id|i
)braket
op_assign
id|nic_read_byte
c_func
(paren
id|ioc3
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|priv_netdev
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|dev_addr
(braket
id|i
op_minus
l_int|2
)braket
op_assign
id|nic
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; * Ok, this is hosed by design.  It&squot;s necessary to know what machine the&n; * NIC is in in order to know how to read the NIC address.  We also have&n; * to know if it&squot;s a PCI card or a NIC in on the node board ...&n; */
DECL|function|ioc3_get_eaddr
r_static
r_void
id|ioc3_get_eaddr
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_int
id|i
suffix:semicolon
id|ioc3_get_eaddr_nic
c_func
(paren
id|ip
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ethernet address is &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|priv_netdev
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;:&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Caller must hold the ioc3_lock ever for MII readers.  This is also&n; * used to protect the transmitter side but it&squot;s low contention.&n; */
DECL|function|ioc3_mdio_read
r_static
r_int
id|ioc3_mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy
comma
r_int
id|reg
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_while
c_loop
(paren
id|ioc3_r_micr
c_func
(paren
)paren
op_amp
id|MICR_BUSY
)paren
suffix:semicolon
id|ioc3_w_micr
c_func
(paren
(paren
id|phy
op_lshift
id|MICR_PHYADDR_SHIFT
)paren
op_or
id|reg
op_or
id|MICR_READTRIG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ioc3_r_micr
c_func
(paren
)paren
op_amp
id|MICR_BUSY
)paren
suffix:semicolon
r_return
id|ioc3_r_micr
c_func
(paren
)paren
op_amp
id|MIDR_DATA_MASK
suffix:semicolon
)brace
DECL|function|ioc3_mdio_write
r_static
r_void
id|ioc3_mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_while
c_loop
(paren
id|ioc3_r_micr
c_func
(paren
)paren
op_amp
id|MICR_BUSY
)paren
suffix:semicolon
id|ioc3_w_midr_w
c_func
(paren
id|data
)paren
suffix:semicolon
id|ioc3_w_micr
c_func
(paren
(paren
id|phy
op_lshift
id|MICR_PHYADDR_SHIFT
)paren
op_or
id|reg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ioc3_r_micr
c_func
(paren
)paren
op_amp
id|MICR_BUSY
)paren
suffix:semicolon
)brace
r_static
r_int
id|ioc3_mii_init
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
suffix:semicolon
DECL|function|ioc3_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ioc3_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|ip-&gt;stats.collisions
op_add_assign
(paren
id|ioc3_r_etcdc
c_func
(paren
)paren
op_amp
id|ETCDC_COLLCNT_MASK
)paren
suffix:semicolon
r_return
op_amp
id|ip-&gt;stats
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SGI_IOC3_ETH_HW_RX_CSUM
DECL|function|ioc3_tcpudp_checksum
r_static
r_void
id|ioc3_tcpudp_checksum
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_uint32
id|hwsum
comma
r_int
id|len
)paren
(brace
r_struct
id|ethhdr
op_star
id|eh
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
r_uint32
id|csum
comma
id|ehsum
suffix:semicolon
r_int
r_int
id|proto
suffix:semicolon
r_struct
id|iphdr
op_star
id|ih
suffix:semicolon
r_uint16
op_star
id|ew
suffix:semicolon
r_int
r_char
op_star
id|cp
suffix:semicolon
multiline_comment|/*&n;&t; * Did hardware handle the checksum at all?  The cases we can handle&n;&t; * are:&n;&t; *&n;&t; * - TCP and UDP checksums of IPv4 only.&n;&t; * - IPv6 would be doable but we keep that for later ...&n;&t; * - Only unfragmented packets.  Did somebody already tell you&n;&t; *   fragmentation is evil?&n;&t; * - don&squot;t care about packet size.  Worst case when processing a&n;&t; *   malformed packet we&squot;ll try to access the packet at ip header +&n;&t; *   64 bytes which is still inside the skb.  Even in the unlikely&n;&t; *   case where the checksum is right the higher layers will still&n;&t; *   drop the packet as appropriate.&n;&t; */
r_if
c_cond
(paren
id|eh-&gt;h_proto
op_ne
id|ntohs
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
suffix:semicolon
id|ih
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|eh
op_plus
id|ETH_HLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ih-&gt;frag_off
op_amp
id|htons
c_func
(paren
id|IP_MF
op_or
id|IP_OFFSET
)paren
)paren
r_return
suffix:semicolon
id|proto
op_assign
id|ih-&gt;protocol
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_ne
id|IPPROTO_TCP
op_logical_and
id|proto
op_ne
id|IPPROTO_UDP
)paren
r_return
suffix:semicolon
multiline_comment|/* Same as tx - compute csum of pseudo header  */
id|csum
op_assign
id|hwsum
op_plus
(paren
id|ih-&gt;tot_len
op_minus
(paren
id|ih-&gt;ihl
op_lshift
l_int|2
)paren
)paren
op_plus
id|htons
c_func
(paren
(paren
r_uint16
)paren
id|ih-&gt;protocol
)paren
op_plus
(paren
id|ih-&gt;saddr
op_rshift
l_int|16
)paren
op_plus
(paren
id|ih-&gt;saddr
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|ih-&gt;daddr
op_rshift
l_int|16
)paren
op_plus
(paren
id|ih-&gt;daddr
op_amp
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Sum up ethernet dest addr, src addr and protocol  */
id|ew
op_assign
(paren
r_uint16
op_star
)paren
id|eh
suffix:semicolon
id|ehsum
op_assign
id|ew
(braket
l_int|0
)braket
op_plus
id|ew
(braket
l_int|1
)braket
op_plus
id|ew
(braket
l_int|2
)braket
op_plus
id|ew
(braket
l_int|3
)braket
op_plus
id|ew
(braket
l_int|4
)braket
op_plus
id|ew
(braket
l_int|5
)braket
op_plus
id|ew
(braket
l_int|6
)braket
suffix:semicolon
id|ehsum
op_assign
(paren
id|ehsum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|ehsum
op_rshift
l_int|16
)paren
suffix:semicolon
id|ehsum
op_assign
(paren
id|ehsum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|ehsum
op_rshift
l_int|16
)paren
suffix:semicolon
id|csum
op_add_assign
l_int|0xffff
op_xor
id|ehsum
suffix:semicolon
multiline_comment|/* In the next step we also subtract the 1&squot;s complement&n;&t;   checksum of the trailing ethernet CRC.  */
id|cp
op_assign
(paren
r_char
op_star
)paren
id|eh
op_plus
id|len
suffix:semicolon
multiline_comment|/* points at trailing CRC */
r_if
c_cond
(paren
id|len
op_amp
l_int|1
)paren
(brace
id|csum
op_add_assign
l_int|0xffff
op_xor
(paren
r_uint16
)paren
(paren
(paren
id|cp
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|cp
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|csum
op_add_assign
l_int|0xffff
op_xor
(paren
r_uint16
)paren
(paren
(paren
id|cp
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|cp
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|csum
op_add_assign
l_int|0xffff
op_xor
(paren
r_uint16
)paren
(paren
(paren
id|cp
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|cp
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|csum
op_add_assign
l_int|0xffff
op_xor
(paren
r_uint16
)paren
(paren
(paren
id|cp
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|cp
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
id|csum
op_assign
(paren
id|csum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|csum
op_rshift
l_int|16
)paren
suffix:semicolon
id|csum
op_assign
(paren
id|csum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|csum
op_rshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csum
op_eq
l_int|0xffff
)paren
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SGI_IOC3_ETH_HW_RX_CSUM */
DECL|function|ioc3_rx
r_static
r_inline
r_void
id|ioc3_rx
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|new_skb
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_int
id|rx_entry
comma
id|n_entry
comma
id|len
suffix:semicolon
r_struct
id|ioc3_erxbuf
op_star
id|rxb
suffix:semicolon
r_int
r_int
op_star
id|rxr
suffix:semicolon
id|u32
id|w0
comma
id|err
suffix:semicolon
id|rxr
op_assign
(paren
r_int
r_int
op_star
)paren
id|ip-&gt;rxr
suffix:semicolon
multiline_comment|/* Ring base */
id|rx_entry
op_assign
id|ip-&gt;rx_ci
suffix:semicolon
multiline_comment|/* RX consume index */
id|n_entry
op_assign
id|ip-&gt;rx_pi
suffix:semicolon
id|skb
op_assign
id|ip-&gt;rx_skbs
(braket
id|rx_entry
)braket
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
(paren
id|skb-&gt;data
op_minus
id|RX_OFFSET
)paren
suffix:semicolon
id|w0
op_assign
id|be32_to_cpu
c_func
(paren
id|rxb-&gt;w0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|w0
op_amp
id|ERXBUF_V
)paren
(brace
id|err
op_assign
id|be32_to_cpu
c_func
(paren
id|rxb-&gt;err
)paren
suffix:semicolon
multiline_comment|/* It&squot;s valid ...  */
r_if
c_cond
(paren
id|err
op_amp
id|ERXBUF_GOODPKT
)paren
(brace
id|len
op_assign
(paren
(paren
id|w0
op_rshift
id|ERXBUF_BYTECNT_SHIFT
)paren
op_amp
l_int|0x7ff
)paren
op_minus
l_int|4
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|priv_netdev
c_func
(paren
id|ip
)paren
)paren
suffix:semicolon
id|new_skb
op_assign
id|ioc3_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_skb
)paren
(brace
multiline_comment|/* Ouch, drop packet and just recycle packet&n;&t;&t;&t;&t;   to keep the ring filled.  */
id|ip-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|new_skb
op_assign
id|skb
suffix:semicolon
r_goto
id|next
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SGI_IOC3_ETH_HW_RX_CSUM
id|ioc3_tcpudp_checksum
c_func
(paren
id|skb
comma
id|w0
op_amp
id|ERXBUF_IPCKSUM_MASK
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ip-&gt;rx_skbs
(braket
id|rx_entry
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Poison  */
id|new_skb-&gt;dev
op_assign
id|priv_netdev
c_func
(paren
id|ip
)paren
suffix:semicolon
multiline_comment|/* Because we reserve afterwards. */
id|skb_put
c_func
(paren
id|new_skb
comma
(paren
l_int|1664
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
id|new_skb-&gt;data
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
id|priv_netdev
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|last_rx
op_assign
id|jiffies
suffix:semicolon
id|ip-&gt;stats.rx_packets
op_increment
suffix:semicolon
multiline_comment|/* Statistics */
id|ip-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The frame is invalid and the skb never&n;                           reached the network layer so we can just&n;                           recycle it.  */
id|new_skb
op_assign
id|skb
suffix:semicolon
id|ip-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_amp
id|ERXBUF_CRCERR
)paren
multiline_comment|/* Statistics */
id|ip-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|err
op_amp
id|ERXBUF_FRAMERR
)paren
id|ip-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
id|next
suffix:colon
id|ip-&gt;rx_skbs
(braket
id|n_entry
)braket
op_assign
id|new_skb
suffix:semicolon
id|rxr
(braket
id|n_entry
)braket
op_assign
id|cpu_to_be64
c_func
(paren
id|ioc3_map
c_func
(paren
id|rxb
comma
l_int|1
)paren
)paren
suffix:semicolon
id|rxb-&gt;w0
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear valid flag */
id|n_entry
op_assign
(paren
id|n_entry
op_plus
l_int|1
)paren
op_amp
l_int|511
suffix:semicolon
multiline_comment|/* Update erpir */
multiline_comment|/* Now go on to the next ring entry.  */
id|rx_entry
op_assign
(paren
id|rx_entry
op_plus
l_int|1
)paren
op_amp
l_int|511
suffix:semicolon
id|skb
op_assign
id|ip-&gt;rx_skbs
(braket
id|rx_entry
)braket
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
(paren
id|skb-&gt;data
op_minus
id|RX_OFFSET
)paren
suffix:semicolon
id|w0
op_assign
id|be32_to_cpu
c_func
(paren
id|rxb-&gt;w0
)paren
suffix:semicolon
)brace
id|ioc3_w_erpir
c_func
(paren
(paren
id|n_entry
op_lshift
l_int|3
)paren
op_or
id|ERPIR_ARM
)paren
suffix:semicolon
id|ip-&gt;rx_pi
op_assign
id|n_entry
suffix:semicolon
id|ip-&gt;rx_ci
op_assign
id|rx_entry
suffix:semicolon
)brace
DECL|function|ioc3_tx
r_static
r_inline
r_void
id|ioc3_tx
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_int
r_int
id|packets
comma
id|bytes
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_int
id|tx_entry
comma
id|o_entry
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u32
id|etcir
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|etcir
op_assign
id|ioc3_r_etcir
c_func
(paren
)paren
suffix:semicolon
id|tx_entry
op_assign
(paren
id|etcir
op_rshift
l_int|7
)paren
op_amp
l_int|127
suffix:semicolon
id|o_entry
op_assign
id|ip-&gt;tx_ci
suffix:semicolon
id|packets
op_assign
l_int|0
suffix:semicolon
id|bytes
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|o_entry
op_ne
id|tx_entry
)paren
(brace
id|packets
op_increment
suffix:semicolon
id|skb
op_assign
id|ip-&gt;tx_skbs
(braket
id|o_entry
)braket
suffix:semicolon
id|bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ip-&gt;tx_skbs
(braket
id|o_entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|o_entry
op_assign
(paren
id|o_entry
op_plus
l_int|1
)paren
op_amp
l_int|127
suffix:semicolon
multiline_comment|/* Next */
id|etcir
op_assign
id|ioc3_r_etcir
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* More pkts sent?  */
id|tx_entry
op_assign
(paren
id|etcir
op_rshift
l_int|7
)paren
op_amp
l_int|127
suffix:semicolon
)brace
id|ip-&gt;stats.tx_packets
op_add_assign
id|packets
suffix:semicolon
id|ip-&gt;stats.tx_bytes
op_add_assign
id|bytes
suffix:semicolon
id|ip-&gt;txqlen
op_sub_assign
id|packets
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;txqlen
OL
l_int|128
)paren
id|netif_wake_queue
c_func
(paren
id|priv_netdev
c_func
(paren
id|ip
)paren
)paren
suffix:semicolon
id|ip-&gt;tx_ci
op_assign
id|o_entry
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Deal with fatal IOC3 errors.  This condition might be caused by a hard or&n; * software problems, so we should try to recover&n; * more gracefully if this ever happens.  In theory we might be flooded&n; * with such error interrupts if something really goes wrong, so we might&n; * also consider to take the interface down.&n; */
DECL|function|ioc3_error
r_static
r_void
id|ioc3_error
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
comma
id|u32
id|eisr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|priv_netdev
c_func
(paren
id|ip
)paren
suffix:semicolon
r_int
r_char
op_star
id|iface
op_assign
id|dev-&gt;name
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXOFLO
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX overflow.&bslash;n&quot;
comma
id|iface
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXBUFOFLO
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX buffer overflow.&bslash;n&quot;
comma
id|iface
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXMEMERR
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX PCI error.&bslash;n&quot;
comma
id|iface
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXPARERR
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX SSRAM parity error.&bslash;n&quot;
comma
id|iface
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_TXBUFUFLO
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: TX buffer underflow.&bslash;n&quot;
comma
id|iface
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_TXMEMERR
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: TX PCI error.&bslash;n&quot;
comma
id|iface
)paren
suffix:semicolon
id|ioc3_stop
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_mii_init
c_func
(paren
id|ip
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread.  */
DECL|function|ioc3_interrupt
r_static
id|irqreturn_t
id|ioc3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|_dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|_dev
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_const
id|u32
id|enabled
op_assign
id|EISR_RXTIMERINT
op_or
id|EISR_RXOFLO
op_or
id|EISR_RXBUFOFLO
op_or
id|EISR_RXMEMERR
op_or
id|EISR_RXPARERR
op_or
id|EISR_TXBUFUFLO
op_or
id|EISR_TXEXPLICIT
op_or
id|EISR_TXMEMERR
suffix:semicolon
id|u32
id|eisr
suffix:semicolon
id|eisr
op_assign
id|ioc3_r_eisr
c_func
(paren
)paren
op_amp
id|enabled
suffix:semicolon
id|ioc3_w_eisr
c_func
(paren
id|eisr
)paren
suffix:semicolon
(paren
r_void
)paren
id|ioc3_r_eisr
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Flush */
r_if
c_cond
(paren
id|eisr
op_amp
(paren
id|EISR_RXOFLO
op_or
id|EISR_RXBUFOFLO
op_or
id|EISR_RXMEMERR
op_or
id|EISR_RXPARERR
op_or
id|EISR_TXBUFUFLO
op_or
id|EISR_TXMEMERR
)paren
)paren
id|ioc3_error
c_func
(paren
id|ip
comma
id|eisr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_RXTIMERINT
)paren
id|ioc3_rx
c_func
(paren
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eisr
op_amp
id|EISR_TXEXPLICIT
)paren
id|ioc3_tx
c_func
(paren
id|ip
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|ioc3_setup_duplex
r_static
r_inline
r_void
id|ioc3_setup_duplex
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;mii.full_duplex
)paren
(brace
id|ioc3_w_etcsr
c_func
(paren
id|ETCSR_FD
)paren
suffix:semicolon
id|ip-&gt;emcr
op_or_assign
id|EMCR_DUPLEX
suffix:semicolon
)brace
r_else
(brace
id|ioc3_w_etcsr
c_func
(paren
id|ETCSR_HD
)paren
suffix:semicolon
id|ip-&gt;emcr
op_and_assign
op_complement
id|EMCR_DUPLEX
suffix:semicolon
)brace
id|ioc3_w_emcr
c_func
(paren
id|ip-&gt;emcr
)paren
suffix:semicolon
)brace
DECL|function|ioc3_timer
r_static
r_void
id|ioc3_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
(paren
r_struct
id|ioc3_private
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* Print the link status if it has changed */
id|mii_check_media
c_func
(paren
op_amp
id|ip-&gt;mii
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|ioc3_setup_duplex
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ip-&gt;ioc3_timer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 1.2s */
id|add_timer
c_func
(paren
op_amp
id|ip-&gt;ioc3_timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Try to find a PHY.  There is no apparent relation between the MII addresses&n; * in the SGI documentation and what we find in reality, so we simply probe&n; * for the PHY.  It seems IOC3 PHYs usually live on address 31.  One of my&n; * onboard IOC3s has the special oddity that probing doesn&squot;t seem to find it&n; * yet the interface seems to work fine, so if probing fails we for now will&n; * simply default to PHY 31 instead of bailing out.&n; */
DECL|function|ioc3_mii_init
r_static
r_int
id|ioc3_mii_init
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|priv_netdev
c_func
(paren
id|ip
)paren
suffix:semicolon
r_int
id|i
comma
id|found
op_assign
l_int|0
comma
id|res
op_assign
l_int|0
suffix:semicolon
r_int
id|ioc3_phy_workaround
op_assign
l_int|1
suffix:semicolon
id|u16
id|word
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|word
op_assign
id|ioc3_mdio_read
c_func
(paren
id|dev
comma
id|i
comma
id|MII_PHYSID1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|word
op_ne
l_int|0xffff
op_logical_and
id|word
op_ne
l_int|0x0000
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Found a PHY&t;&t;*/
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
r_if
c_cond
(paren
id|ioc3_phy_workaround
)paren
id|i
op_assign
l_int|31
suffix:semicolon
r_else
(brace
id|ip-&gt;mii.phy_id
op_assign
op_minus
l_int|1
suffix:semicolon
id|res
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|ip-&gt;mii.phy_id
op_assign
id|i
suffix:semicolon
id|ip-&gt;ioc3_timer.expires
op_assign
id|jiffies
op_plus
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
suffix:semicolon
multiline_comment|/* 1.2 sec. */
id|ip-&gt;ioc3_timer.data
op_assign
(paren
r_int
r_int
)paren
id|ip
suffix:semicolon
id|ip-&gt;ioc3_timer.function
op_assign
op_amp
id|ioc3_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ip-&gt;ioc3_timer
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|res
suffix:semicolon
)brace
DECL|function|ioc3_clean_rx_ring
r_static
r_inline
r_void
id|ioc3_clean_rx_ring
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ip-&gt;rx_ci
suffix:semicolon
id|i
op_amp
l_int|15
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ip-&gt;rx_skbs
(braket
id|ip-&gt;rx_pi
)braket
op_assign
id|ip-&gt;rx_skbs
(braket
id|ip-&gt;rx_ci
)braket
suffix:semicolon
id|ip-&gt;rxr
(braket
id|ip-&gt;rx_pi
op_increment
)braket
op_assign
id|ip-&gt;rxr
(braket
id|ip-&gt;rx_ci
op_increment
)braket
suffix:semicolon
)brace
id|ip-&gt;rx_pi
op_and_assign
l_int|511
suffix:semicolon
id|ip-&gt;rx_ci
op_and_assign
l_int|511
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ip-&gt;rx_ci
suffix:semicolon
id|i
op_ne
id|ip-&gt;rx_pi
suffix:semicolon
id|i
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_amp
l_int|511
)paren
(brace
r_struct
id|ioc3_erxbuf
op_star
id|rxb
suffix:semicolon
id|skb
op_assign
id|ip-&gt;rx_skbs
(braket
id|i
)braket
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
(paren
id|skb-&gt;data
op_minus
id|RX_OFFSET
)paren
suffix:semicolon
id|rxb-&gt;w0
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ioc3_clean_tx_ring
r_static
r_inline
r_void
id|ioc3_clean_tx_ring
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
id|ip-&gt;tx_skbs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|ip-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|ip-&gt;txr
(braket
id|i
)braket
dot
id|cmd
op_assign
l_int|0
suffix:semicolon
)brace
id|ip-&gt;tx_pi
op_assign
l_int|0
suffix:semicolon
id|ip-&gt;tx_ci
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ioc3_free_rings
r_static
r_void
id|ioc3_free_rings
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|rx_entry
comma
id|n_entry
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;txr
)paren
(brace
id|ioc3_clean_tx_ring
c_func
(paren
id|ip
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ip-&gt;txr
comma
l_int|2
)paren
suffix:semicolon
id|ip-&gt;txr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip-&gt;rxr
)paren
(brace
id|n_entry
op_assign
id|ip-&gt;rx_ci
suffix:semicolon
id|rx_entry
op_assign
id|ip-&gt;rx_pi
suffix:semicolon
r_while
c_loop
(paren
id|n_entry
op_ne
id|rx_entry
)paren
(brace
id|skb
op_assign
id|ip-&gt;rx_skbs
(braket
id|n_entry
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|n_entry
op_assign
(paren
id|n_entry
op_plus
l_int|1
)paren
op_amp
l_int|511
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|ip-&gt;rxr
)paren
suffix:semicolon
id|ip-&gt;rxr
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|ioc3_alloc_rings
r_static
r_void
id|ioc3_alloc_rings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3_erxbuf
op_star
id|rxb
suffix:semicolon
r_int
r_int
op_star
id|rxr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;rxr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Allocate and initialize rx ring.  4kb = 512 entries  */
id|ip-&gt;rxr
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
id|rxr
op_assign
(paren
r_int
r_int
op_star
)paren
id|ip-&gt;rxr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rxr
)paren
id|printk
c_func
(paren
l_string|&quot;ioc3_alloc_rings(): get_zeroed_page() failed!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Now the rx buffers.  The RX ring may be larger but&n;&t;&t;   we only allocate 16 buffers for now.  Need to tune&n;&t;&t;   this for performance and memory later.  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_BUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|ioc3_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|show_free_areas
c_func
(paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ip-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Because we reserve afterwards. */
id|skb_put
c_func
(paren
id|skb
comma
(paren
l_int|1664
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|rxb
op_assign
(paren
r_struct
id|ioc3_erxbuf
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|rxr
(braket
id|i
)braket
op_assign
id|cpu_to_be64
c_func
(paren
id|ioc3_map
c_func
(paren
id|rxb
comma
l_int|1
)paren
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
)brace
id|ip-&gt;rx_ci
op_assign
l_int|0
suffix:semicolon
id|ip-&gt;rx_pi
op_assign
id|RX_BUFFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip-&gt;txr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Allocate and initialize tx rings.  16kb = 128 bufs.  */
id|ip-&gt;txr
op_assign
(paren
r_struct
id|ioc3_etxd
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip-&gt;txr
)paren
id|printk
c_func
(paren
l_string|&quot;ioc3_alloc_rings(): __get_free_pages() failed!&bslash;n&quot;
)paren
suffix:semicolon
id|ip-&gt;tx_pi
op_assign
l_int|0
suffix:semicolon
id|ip-&gt;tx_ci
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ioc3_init_rings
r_static
r_void
id|ioc3_init_rings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_int
r_int
id|ring
suffix:semicolon
id|ioc3_free_rings
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_alloc_rings
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_clean_rx_ring
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_clean_tx_ring
c_func
(paren
id|ip
)paren
suffix:semicolon
multiline_comment|/* Now the rx ring base, consume &amp; produce registers.  */
id|ring
op_assign
id|ioc3_map
c_func
(paren
id|ip-&gt;rxr
comma
l_int|0
)paren
suffix:semicolon
id|ioc3_w_erbr_h
c_func
(paren
id|ring
op_rshift
l_int|32
)paren
suffix:semicolon
id|ioc3_w_erbr_l
c_func
(paren
id|ring
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|ioc3_w_ercir
c_func
(paren
id|ip-&gt;rx_ci
op_lshift
l_int|3
)paren
suffix:semicolon
id|ioc3_w_erpir
c_func
(paren
(paren
id|ip-&gt;rx_pi
op_lshift
l_int|3
)paren
op_or
id|ERPIR_ARM
)paren
suffix:semicolon
id|ring
op_assign
id|ioc3_map
c_func
(paren
id|ip-&gt;txr
comma
l_int|0
)paren
suffix:semicolon
id|ip-&gt;txqlen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* nothing queued  */
multiline_comment|/* Now the tx ring base, consume &amp; produce registers.  */
id|ioc3_w_etbr_h
c_func
(paren
id|ring
op_rshift
l_int|32
)paren
suffix:semicolon
id|ioc3_w_etbr_l
c_func
(paren
id|ring
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|ioc3_w_etpir
c_func
(paren
id|ip-&gt;tx_pi
op_lshift
l_int|7
)paren
suffix:semicolon
id|ioc3_w_etcir
c_func
(paren
id|ip-&gt;tx_ci
op_lshift
l_int|7
)paren
suffix:semicolon
(paren
r_void
)paren
id|ioc3_r_etcir
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Flush */
)brace
DECL|function|ioc3_ssram_disc
r_static
r_inline
r_void
id|ioc3_ssram_disc
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_volatile
id|u32
op_star
id|ssram0
op_assign
op_amp
id|ioc3-&gt;ssram
(braket
l_int|0x0000
)braket
suffix:semicolon
r_volatile
id|u32
op_star
id|ssram1
op_assign
op_amp
id|ioc3-&gt;ssram
(braket
l_int|0x4000
)braket
suffix:semicolon
r_int
r_int
id|pattern
op_assign
l_int|0x5555
suffix:semicolon
multiline_comment|/* Assume the larger size SSRAM and enable parity checking */
id|ioc3_w_emcr
c_func
(paren
id|ioc3_r_emcr
c_func
(paren
)paren
op_or
(paren
id|EMCR_BUFSIZ
op_or
id|EMCR_RAMPAR
)paren
)paren
suffix:semicolon
op_star
id|ssram0
op_assign
id|pattern
suffix:semicolon
op_star
id|ssram1
op_assign
op_complement
id|pattern
op_amp
id|IOC3_SSRAM_DM
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|ssram0
op_amp
id|IOC3_SSRAM_DM
)paren
op_ne
id|pattern
op_logical_or
(paren
op_star
id|ssram1
op_amp
id|IOC3_SSRAM_DM
)paren
op_ne
(paren
op_complement
id|pattern
op_amp
id|IOC3_SSRAM_DM
)paren
)paren
(brace
multiline_comment|/* set ssram size to 64 KB */
id|ip-&gt;emcr
op_assign
id|EMCR_RAMPAR
suffix:semicolon
id|ioc3_w_emcr
c_func
(paren
id|ioc3_r_emcr
c_func
(paren
)paren
op_amp
op_complement
id|EMCR_BUFSIZ
)paren
suffix:semicolon
)brace
r_else
id|ip-&gt;emcr
op_assign
id|EMCR_BUFSIZ
op_or
id|EMCR_RAMPAR
suffix:semicolon
)brace
DECL|function|ioc3_init
r_static
r_void
id|ioc3_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ip-&gt;ioc3_timer
)paren
suffix:semicolon
multiline_comment|/* Kill if running&t;*/
id|ioc3_w_emcr
c_func
(paren
id|EMCR_RST
)paren
suffix:semicolon
multiline_comment|/* Reset&t;&t;*/
(paren
r_void
)paren
id|ioc3_r_emcr
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Flush WB&t;&t;*/
id|udelay
c_func
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Give it time ...&t;*/
id|ioc3_w_emcr
c_func
(paren
l_int|0
)paren
suffix:semicolon
(paren
r_void
)paren
id|ioc3_r_emcr
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Misc registers  */
macro_line|#ifdef CONFIG_SGI_IP27
id|ioc3_w_erbar
c_func
(paren
id|PCI64_ATTR_BAR
op_rshift
l_int|32
)paren
suffix:semicolon
multiline_comment|/* Barrier on last store */
macro_line|#else
id|ioc3_w_erbar
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Let PCI API get it right */
macro_line|#endif
(paren
r_void
)paren
id|ioc3_r_etcdc
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clear on read */
id|ioc3_w_ercsr
c_func
(paren
l_int|15
)paren
suffix:semicolon
multiline_comment|/* RX low watermark  */
id|ioc3_w_ertr
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Interrupt immediately */
id|ioc3_w_emar_h
c_func
(paren
(paren
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|ioc3_w_emar_l
c_func
(paren
(paren
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ioc3_w_ehar_h
c_func
(paren
id|ip-&gt;ehar_h
)paren
suffix:semicolon
id|ioc3_w_ehar_l
c_func
(paren
id|ip-&gt;ehar_l
)paren
suffix:semicolon
id|ioc3_w_ersr
c_func
(paren
l_int|42
)paren
suffix:semicolon
multiline_comment|/* XXX should be random */
id|ioc3_init_rings
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ip-&gt;emcr
op_or_assign
(paren
(paren
id|RX_OFFSET
op_div
l_int|2
)paren
op_lshift
id|EMCR_RXOFF_SHIFT
)paren
op_or
id|EMCR_TXDMAEN
op_or
id|EMCR_TXEN
op_or
id|EMCR_RXDMAEN
op_or
id|EMCR_RXEN
op_or
id|EMCR_PADEN
suffix:semicolon
id|ioc3_w_emcr
c_func
(paren
id|ip-&gt;emcr
)paren
suffix:semicolon
id|ioc3_w_eier
c_func
(paren
id|EISR_RXTIMERINT
op_or
id|EISR_RXOFLO
op_or
id|EISR_RXBUFOFLO
op_or
id|EISR_RXMEMERR
op_or
id|EISR_RXPARERR
op_or
id|EISR_TXBUFUFLO
op_or
id|EISR_TXEXPLICIT
op_or
id|EISR_TXMEMERR
)paren
suffix:semicolon
(paren
r_void
)paren
id|ioc3_r_eier
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|ioc3_stop
r_static
r_inline
r_void
id|ioc3_stop
c_func
(paren
r_struct
id|ioc3_private
op_star
id|ip
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|ioc3_w_emcr
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Shutup */
id|ioc3_w_eier
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
(paren
r_void
)paren
id|ioc3_r_eier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Flush */
)brace
DECL|function|ioc3_open
r_static
r_int
id|ioc3_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ioc3_interrupt
comma
id|SA_SHIRQ
comma
id|ioc3_str
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|ip-&gt;ehar_h
op_assign
l_int|0
suffix:semicolon
id|ip-&gt;ehar_l
op_assign
l_int|0
suffix:semicolon
id|ioc3_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioc3_close
r_static
r_int
id|ioc3_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ip-&gt;ioc3_timer
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_stop
c_func
(paren
id|ip
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|ioc3_free_rings
c_func
(paren
id|ip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * MENET cards have four IOC3 chips, which are attached to two sets of&n; * PCI slot resources each: the primary connections are on slots&n; * 0..3 and the secondaries are on 4..7&n; *&n; * All four ethernets are brought out to connectors; six serial ports&n; * (a pair from each of the first three IOC3s) are brought out to&n; * MiniDINs; all other subdevices are left swinging in the wind, leave&n; * them disabled.&n; */
DECL|function|ioc3_is_menet
r_static
r_inline
r_int
id|ioc3_is_menet
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_return
id|pdev-&gt;bus-&gt;parent
op_eq
l_int|NULL
op_logical_and
(paren
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|pdev-&gt;bus-&gt;number
comma
id|PCI_DEVFN
c_func
(paren
l_int|0
comma
l_int|0
)paren
)paren
)paren
op_logical_and
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SGI
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_SGI_IOC3
op_logical_and
(paren
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|pdev-&gt;bus-&gt;number
comma
id|PCI_DEVFN
c_func
(paren
l_int|1
comma
l_int|0
)paren
)paren
)paren
op_logical_and
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SGI
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_SGI_IOC3
op_logical_and
(paren
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|pdev-&gt;bus-&gt;number
comma
id|PCI_DEVFN
c_func
(paren
l_int|2
comma
l_int|0
)paren
)paren
)paren
op_logical_and
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SGI
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_SGI_IOC3
suffix:semicolon
)brace
multiline_comment|/*&n; * Note about serial ports and consoles:&n; * For console output, everyone uses the IOC3 UARTA (offset 0x178)&n; * connected to the master node (look in ip27_setup_console() and&n; * ip27prom_console_write()).&n; *&n; * For serial (/dev/ttyS0 etc), we can not have hardcoded serial port&n; * addresses on a partitioned machine. Since we currently use the ioc3&n; * serial ports, we use dynamic serial port discovery that the serial.c&n; * driver uses for pci/pnp ports (there is an entry for the SGI ioc3&n; * boards in pci_boards[]). Unfortunately, UARTA&squot;s pio address is greater&n; * than UARTB&squot;s, although UARTA on o200s has traditionally been known as&n; * port 0. So, we just use one serial port from each ioc3 (since the&n; * serial driver adds addresses to get to higher ports).&n; *&n; * The first one to do a register_console becomes the preferred console&n; * (if there is no kernel command line console= directive). /dev/console&n; * (ie 5, 1) is then &quot;aliased&quot; into the device number returned by the&n; * &quot;device&quot; routine referred to in this console structure&n; * (ip27prom_console_dev).&n; *&n; * Also look in ip27-pci.c:pci_fixuop_ioc3() for some comments on working&n; * around ioc3 oddities in this respect.&n; *&n; * The IOC3 serials use a 22MHz clock rate with an additional divider by 3.&n; * (IOC3_BAUD = (22000000 / (3*16)))&n; */
DECL|function|ioc3_serial_probe
r_static
r_inline
r_void
id|ioc3_serial_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|ioc3
op_star
id|ioc3
)paren
(brace
r_struct
id|serial_struct
id|req
suffix:semicolon
multiline_comment|/*&n;&t; * We need to recognice and treat the fourth MENET serial as it&n;&t; * does not have an SuperIO chip attached to it, therefore attempting&n;&t; * to access it will result in bus errors.  We call something an&n;&t; * MENET if PCI slot 0, 1, 2 and 3 of a master PCI bus all have an IOC3&n;&t; * in it.  This is paranoid but we want to avoid blowing up on a&n;&t; * showhorn PCI box that happens to have 4 IOC3 cards in it so it&squot;s&n;&t; * not paranoid enough ...&n;&t; */
r_if
c_cond
(paren
id|ioc3_is_menet
c_func
(paren
id|pdev
)paren
op_logical_and
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
op_eq
l_int|3
)paren
r_return
suffix:semicolon
multiline_comment|/* Register to interrupt zero because we share the interrupt with&n;&t;   the serial driver which we don&squot;t properly support yet.  */
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|req.irq
op_assign
l_int|0
suffix:semicolon
id|req.flags
op_assign
id|IOC3_COM_FLAGS
suffix:semicolon
id|req.io_type
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
id|req.iomem_reg_shift
op_assign
l_int|0
suffix:semicolon
id|req.baud_base
op_assign
id|IOC3_BAUD
suffix:semicolon
id|req.iomem_base
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|ioc3-&gt;sregs.uarta
suffix:semicolon
id|register_serial
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|req.iomem_base
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|ioc3-&gt;sregs.uartb
suffix:semicolon
id|register_serial
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
)brace
DECL|function|ioc3_probe
r_static
r_int
id|__devinit
id|ioc3_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_int
r_int
id|sw_physid1
comma
id|sw_physid2
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
r_int
r_int
id|ioc3_base
comma
id|ioc3_size
suffix:semicolon
id|u32
id|vendor
comma
id|model
comma
id|rev
suffix:semicolon
r_int
id|err
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|ioc3_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|err
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;ioc3&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_free
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|ioc3_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|ioc3_size
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|ioc3
op_assign
(paren
r_struct
id|ioc3
op_star
)paren
id|ioremap
c_func
(paren
id|ioc3_base
comma
id|ioc3_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioc3
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;ioc3eth(%s): ioremap failed, goodbye.&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_res
suffix:semicolon
)brace
id|ip-&gt;regs
op_assign
id|ioc3
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_8250
id|ioc3_serial_probe
c_func
(paren
id|pdev
comma
id|ioc3
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_init
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ip-&gt;ioc3_timer
)paren
suffix:semicolon
id|ioc3_stop
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ip-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|ip-&gt;mii.phy_id_mask
op_assign
l_int|0x1f
suffix:semicolon
id|ip-&gt;mii.reg_num_mask
op_assign
l_int|0x1f
suffix:semicolon
id|ip-&gt;mii.dev
op_assign
id|dev
suffix:semicolon
id|ip-&gt;mii.mdio_read
op_assign
id|ioc3_mdio_read
suffix:semicolon
id|ip-&gt;mii.mdio_write
op_assign
id|ioc3_mdio_write
suffix:semicolon
id|ioc3_mii_init
c_func
(paren
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;mii.phy_id
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;ioc3-eth(%s): Didn&squot;t find a PHY, goodbye.&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out_stop
suffix:semicolon
)brace
id|ioc3_ssram_disc
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_get_eaddr
c_func
(paren
id|ip
)paren
suffix:semicolon
multiline_comment|/* The IOC3-specific entries in the device structure. */
id|dev-&gt;open
op_assign
id|ioc3_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ioc3_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|ioc3_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ioc3_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ioc3_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|ioc3_ioctl
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|ioc3_set_multicast_list
suffix:semicolon
id|dev-&gt;ethtool_ops
op_assign
op_amp
id|ioc3_ethtool_ops
suffix:semicolon
macro_line|#ifdef CONFIG_SGI_IOC3_ETH_HW_TX_CSUM
id|dev-&gt;features
op_assign
id|NETIF_F_IP_CSUM
suffix:semicolon
macro_line|#endif
id|ioc3_setup_duplex
c_func
(paren
id|ip
)paren
suffix:semicolon
id|sw_physid1
op_assign
id|ioc3_mdio_read
c_func
(paren
id|dev
comma
id|ip-&gt;mii.phy_id
comma
id|MII_PHYSID1
)paren
suffix:semicolon
id|sw_physid2
op_assign
id|ioc3_mdio_read
c_func
(paren
id|dev
comma
id|ip-&gt;mii.phy_id
comma
id|MII_PHYSID2
)paren
suffix:semicolon
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_stop
suffix:semicolon
id|mii_check_media
c_func
(paren
op_amp
id|ip-&gt;mii
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|vendor
op_assign
(paren
id|sw_physid1
op_lshift
l_int|12
)paren
op_or
(paren
id|sw_physid2
op_rshift
l_int|4
)paren
suffix:semicolon
id|model
op_assign
(paren
id|sw_physid2
op_rshift
l_int|4
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|rev
op_assign
id|sw_physid2
op_amp
l_int|0xf
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Using PHY %d, vendor 0x%x, model %d, &quot;
l_string|&quot;rev %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ip-&gt;mii.phy_id
comma
id|vendor
comma
id|model
comma
id|rev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IOC3 SSRAM has %d kbyte.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ip-&gt;emcr
op_amp
id|EMCR_BUFSIZ
ques
c_cond
l_int|128
suffix:colon
l_int|64
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_stop
suffix:colon
id|ioc3_stop
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_free_rings
c_func
(paren
id|ip
)paren
suffix:semicolon
id|out_res
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|out_free
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ioc3_remove_one
r_static
r_void
id|__devexit
id|ioc3_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|ioc3
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|variable|ioc3_pci_tbl
r_static
r_struct
id|pci_device_id
id|ioc3_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_SGI
comma
id|PCI_DEVICE_ID_SGI_IOC3
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ioc3_pci_tbl
)paren
suffix:semicolon
DECL|variable|ioc3_driver
r_static
r_struct
id|pci_driver
id|ioc3_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ioc3-eth&quot;
comma
dot
id|id_table
op_assign
id|ioc3_pci_tbl
comma
dot
id|probe
op_assign
id|ioc3_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|ioc3_remove_one
)paren
comma
)brace
suffix:semicolon
DECL|function|ioc3_init_module
r_static
r_int
id|__init
id|ioc3_init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|ioc3_driver
)paren
suffix:semicolon
)brace
DECL|function|ioc3_cleanup_module
r_static
r_void
id|__exit
id|ioc3_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|ioc3_driver
)paren
suffix:semicolon
)brace
DECL|function|ioc3_start_xmit
r_static
r_int
id|ioc3_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_struct
id|ioc3_etxd
op_star
id|desc
suffix:semicolon
r_uint32
id|w0
op_assign
l_int|0
suffix:semicolon
r_int
id|produce
suffix:semicolon
macro_line|#ifdef CONFIG_SGI_IOC3_ETH_HW_TX_CSUM
multiline_comment|/*&n;&t; * IOC3 has a fairly simple minded checksumming hardware which simply&n;&t; * adds up the 1&squot;s complement checksum for the entire packet and&n;&t; * inserts it at an offset which can be specified in the descriptor&n;&t; * into the transmit packet.  This means we have to compensate for the&n;&t; * MAC header which should not be summed and the TCP/UDP pseudo headers&n;&t; * manually.&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
(brace
r_int
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;nh.iph-&gt;protocol
)paren
suffix:semicolon
r_int
r_int
id|csoff
suffix:semicolon
r_struct
id|iphdr
op_star
id|ih
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_uint32
id|csum
comma
id|ehsum
suffix:semicolon
r_uint16
op_star
id|eh
suffix:semicolon
multiline_comment|/* The MAC header.  skb-&gt;mac.ethernet seem the logic approach&n;&t;&t;   to find the MAC header - except it&squot;s a NULL pointer ...  */
id|eh
op_assign
(paren
r_uint16
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Sum up dest addr, src addr and protocol  */
id|ehsum
op_assign
id|eh
(braket
l_int|0
)braket
op_plus
id|eh
(braket
l_int|1
)braket
op_plus
id|eh
(braket
l_int|2
)braket
op_plus
id|eh
(braket
l_int|3
)braket
op_plus
id|eh
(braket
l_int|4
)braket
op_plus
id|eh
(braket
l_int|5
)braket
op_plus
id|eh
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* Fold ehsum.  can&squot;t use csum_fold which negates also ...  */
id|ehsum
op_assign
(paren
id|ehsum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|ehsum
op_rshift
l_int|16
)paren
suffix:semicolon
id|ehsum
op_assign
(paren
id|ehsum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|ehsum
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Skip IP header; it&squot;s sum is always zero and was&n;&t;&t;   already filled in by ip_output.c */
id|csum
op_assign
id|csum_tcpudp_nofold
c_func
(paren
id|ih-&gt;saddr
comma
id|ih-&gt;daddr
comma
id|ih-&gt;tot_len
op_minus
(paren
id|ih-&gt;ihl
op_lshift
l_int|2
)paren
comma
id|proto
comma
l_int|0xffff
op_xor
id|ehsum
)paren
suffix:semicolon
id|csum
op_assign
(paren
id|csum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|csum
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Fold again */
id|csum
op_assign
(paren
id|csum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|csum
op_rshift
l_int|16
)paren
suffix:semicolon
id|csoff
op_assign
id|ETH_HLEN
op_plus
(paren
id|ih-&gt;ihl
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|IPPROTO_UDP
)paren
(brace
id|csoff
op_add_assign
m_offsetof
(paren
r_struct
id|udphdr
comma
id|check
)paren
suffix:semicolon
id|skb-&gt;h.uh-&gt;check
op_assign
id|csum
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proto
op_eq
id|IPPROTO_TCP
)paren
(brace
id|csoff
op_add_assign
m_offsetof
(paren
r_struct
id|tcphdr
comma
id|check
)paren
suffix:semicolon
id|skb-&gt;h.th-&gt;check
op_assign
id|csum
suffix:semicolon
)brace
id|w0
op_assign
id|ETXD_DOCHECKSUM
op_or
(paren
id|csoff
op_lshift
id|ETXD_CHKOFF_SHIFT
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SGI_IOC3_ETH_HW_TX_CSUM */
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|data
op_assign
(paren
r_int
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|produce
op_assign
id|ip-&gt;tx_pi
suffix:semicolon
id|desc
op_assign
op_amp
id|ip-&gt;txr
(braket
id|produce
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|104
)paren
(brace
multiline_comment|/* Short packet, let&squot;s copy it directly into the ring.  */
id|memcpy
c_func
(paren
id|desc-&gt;data
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
(brace
multiline_comment|/* Very short packet, pad with zeros at the end. */
id|memset
c_func
(paren
id|desc-&gt;data
op_plus
id|len
comma
l_int|0
comma
id|ETH_ZLEN
op_minus
id|len
)paren
suffix:semicolon
id|len
op_assign
id|ETH_ZLEN
suffix:semicolon
)brace
id|desc-&gt;cmd
op_assign
id|cpu_to_be32
c_func
(paren
id|len
op_or
id|ETXD_INTWHENDONE
op_or
id|ETXD_D0V
op_or
id|w0
)paren
suffix:semicolon
id|desc-&gt;bufcnt
op_assign
id|cpu_to_be32
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|data
op_xor
(paren
id|data
op_plus
id|len
op_minus
l_int|1
)paren
)paren
op_amp
l_int|0x4000
)paren
(brace
r_int
r_int
id|b2
op_assign
(paren
id|data
op_or
l_int|0x3fffUL
)paren
op_plus
l_int|1UL
suffix:semicolon
r_int
r_int
id|s1
op_assign
id|b2
op_minus
id|data
suffix:semicolon
r_int
r_int
id|s2
op_assign
id|data
op_plus
id|len
op_minus
id|b2
suffix:semicolon
id|desc-&gt;cmd
op_assign
id|cpu_to_be32
c_func
(paren
id|len
op_or
id|ETXD_INTWHENDONE
op_or
id|ETXD_B1V
op_or
id|ETXD_B2V
op_or
id|w0
)paren
suffix:semicolon
id|desc-&gt;bufcnt
op_assign
id|cpu_to_be32
c_func
(paren
(paren
id|s1
op_lshift
id|ETXD_B1CNT_SHIFT
)paren
op_or
(paren
id|s2
op_lshift
id|ETXD_B2CNT_SHIFT
)paren
)paren
suffix:semicolon
id|desc-&gt;p1
op_assign
id|cpu_to_be64
c_func
(paren
id|ioc3_map
c_func
(paren
id|skb-&gt;data
comma
l_int|1
)paren
)paren
suffix:semicolon
id|desc-&gt;p2
op_assign
id|cpu_to_be64
c_func
(paren
id|ioc3_map
c_func
(paren
(paren
r_void
op_star
)paren
id|b2
comma
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal sized packet that doesn&squot;t cross a page boundary. */
id|desc-&gt;cmd
op_assign
id|cpu_to_be32
c_func
(paren
id|len
op_or
id|ETXD_INTWHENDONE
op_or
id|ETXD_B1V
op_or
id|w0
)paren
suffix:semicolon
id|desc-&gt;bufcnt
op_assign
id|cpu_to_be32
c_func
(paren
id|len
op_lshift
id|ETXD_B1CNT_SHIFT
)paren
suffix:semicolon
id|desc-&gt;p1
op_assign
id|cpu_to_be64
c_func
(paren
id|ioc3_map
c_func
(paren
id|skb-&gt;data
comma
l_int|1
)paren
)paren
suffix:semicolon
)brace
id|BARRIER
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|ip-&gt;tx_skbs
(braket
id|produce
)braket
op_assign
id|skb
suffix:semicolon
multiline_comment|/* Remember skb */
id|produce
op_assign
(paren
id|produce
op_plus
l_int|1
)paren
op_amp
l_int|127
suffix:semicolon
id|ip-&gt;tx_pi
op_assign
id|produce
suffix:semicolon
id|ioc3_w_etpir
c_func
(paren
id|produce
op_lshift
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Fire ... */
id|ip-&gt;txqlen
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;txqlen
op_ge
l_int|127
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ioc3_timeout
r_static
r_void
id|ioc3_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|ioc3_stop
c_func
(paren
id|ip
)paren
suffix:semicolon
id|ioc3_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ioc3_mii_init
c_func
(paren
id|ip
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Given a multicast ethernet address, this routine calculates the&n; * address&squot;s bit index in the logical address filter mask&n; */
DECL|function|ioc3_hash
r_static
r_inline
r_int
r_int
id|ioc3_hash
c_func
(paren
r_const
r_int
r_char
op_star
id|addr
)paren
(brace
r_int
r_int
id|temp
op_assign
l_int|0
suffix:semicolon
id|u32
id|crc
suffix:semicolon
r_int
id|bits
suffix:semicolon
id|crc
op_assign
id|ether_crc_le
c_func
(paren
id|ETH_ALEN
comma
id|addr
)paren
suffix:semicolon
id|crc
op_and_assign
l_int|0x3f
suffix:semicolon
multiline_comment|/* bit reverse lowest 6 bits for hash index */
r_for
c_loop
(paren
id|bits
op_assign
l_int|6
suffix:semicolon
op_decrement
id|bits
op_ge
l_int|0
suffix:semicolon
)paren
(brace
id|temp
op_lshift_assign
l_int|1
suffix:semicolon
id|temp
op_or_assign
(paren
id|crc
op_amp
l_int|0x1
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
id|temp
suffix:semicolon
)brace
DECL|function|ioc3_get_drvinfo
r_static
r_void
id|ioc3_get_drvinfo
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|strcpy
(paren
id|info-&gt;driver
comma
id|IOC3_NAME
)paren
suffix:semicolon
id|strcpy
(paren
id|info-&gt;version
comma
id|IOC3_VERSION
)paren
suffix:semicolon
id|strcpy
(paren
id|info-&gt;bus_info
comma
id|pci_name
c_func
(paren
id|ip-&gt;pdev
)paren
)paren
suffix:semicolon
)brace
DECL|function|ioc3_get_settings
r_static
r_int
id|ioc3_get_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|rc
op_assign
id|mii_ethtool_gset
c_func
(paren
op_amp
id|ip-&gt;mii
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ioc3_set_settings
r_static
r_int
id|ioc3_set_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|rc
op_assign
id|mii_ethtool_sset
c_func
(paren
op_amp
id|ip-&gt;mii
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ioc3_nway_reset
r_static
r_int
id|ioc3_nway_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|rc
op_assign
id|mii_nway_restart
c_func
(paren
op_amp
id|ip-&gt;mii
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ioc3_get_link
r_static
id|u32
id|ioc3_get_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|rc
op_assign
id|mii_link_ok
c_func
(paren
op_amp
id|ip-&gt;mii
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|ioc3_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|ioc3_ethtool_ops
op_assign
(brace
dot
id|get_drvinfo
op_assign
id|ioc3_get_drvinfo
comma
dot
id|get_settings
op_assign
id|ioc3_get_settings
comma
dot
id|set_settings
op_assign
id|ioc3_set_settings
comma
dot
id|nway_reset
op_assign
id|ioc3_nway_reset
comma
dot
id|get_link
op_assign
id|ioc3_get_link
comma
)brace
suffix:semicolon
DECL|function|ioc3_ioctl
r_static
r_int
id|ioc3_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|mii_ioctl_data
op_star
id|data
op_assign
(paren
r_struct
id|mii_ioctl_data
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
id|rc
op_assign
id|generic_mii_ioctl
c_func
(paren
op_amp
id|ip-&gt;mii
comma
id|data
comma
id|cmd
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|ip-&gt;ioc3_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ioc3_set_multicast_list
r_static
r_void
id|ioc3_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_struct
id|ioc3_private
op_star
id|ip
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ioc3
op_star
id|ioc3
op_assign
id|ip-&gt;regs
suffix:semicolon
id|u64
id|ehar
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Lock out others. */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous.  */
multiline_comment|/* Unconditionally log net taps.  */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ip-&gt;emcr
op_or_assign
id|EMCR_PROMISC
suffix:semicolon
id|ioc3_w_emcr
c_func
(paren
id|ip-&gt;emcr
)paren
suffix:semicolon
(paren
r_void
)paren
id|ioc3_r_emcr
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ip-&gt;emcr
op_and_assign
op_complement
id|EMCR_PROMISC
suffix:semicolon
id|ioc3_w_emcr
c_func
(paren
id|ip-&gt;emcr
)paren
suffix:semicolon
multiline_comment|/* Clear promiscuous. */
(paren
r_void
)paren
id|ioc3_r_emcr
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
)paren
(brace
multiline_comment|/* Too many for hashing to make sense or we want all&n;&t;&t;&t;   multicast packets anyway,  so skip computing all the&n;&t;&t;&t;   hashes and just accept all packets.  */
id|ip-&gt;ehar_h
op_assign
l_int|0xffffffff
suffix:semicolon
id|ip-&gt;ehar_l
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|addr
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addr
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|ehar
op_or_assign
(paren
l_int|1UL
op_lshift
id|ioc3_hash
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
)brace
id|ip-&gt;ehar_h
op_assign
id|ehar
op_rshift
l_int|32
suffix:semicolon
id|ip-&gt;ehar_l
op_assign
id|ehar
op_amp
l_int|0xffffffff
suffix:semicolon
)brace
id|ioc3_w_ehar_h
c_func
(paren
id|ip-&gt;ehar_h
)paren
suffix:semicolon
id|ioc3_w_ehar_l
c_func
(paren
id|ip-&gt;ehar_l
)paren
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Let us get going again. */
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ralf Baechle &lt;ralf@linux-mips.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SGI IOC3 Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|ioc3_init_module
id|module_init
c_func
(paren
id|ioc3_init_module
)paren
suffix:semicolon
DECL|variable|ioc3_cleanup_module
id|module_exit
c_func
(paren
id|ioc3_cleanup_module
)paren
suffix:semicolon
eof
