multiline_comment|/* yellowfin.c: A Packet Engines G-NIC ethernet driver for linux. */
multiline_comment|/*&n;&t;Written 1997-2001 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms of&n;&t;the GNU General Public License (GPL), incorporated herein by reference.&n;&t;Drivers based on or derived from this code fall under the GPL and must&n;&t;retain the authorship, copyright and license notice.  This file is not&n;&t;a complete program and may only be used when the entire operating&n;&t;system is licensed under the GPL.&n;&n;&t;This driver is for the Packet Engines G-NIC PCI Gigabit Ethernet adapter.&n;&t;It also supports the Symbios Logic version of the same chip core.&n;&n;&t;The author may be reached as becker@scyld.com, or C/O&n;&t;Scyld Computing Corporation&n;&t;410 Severn Ave., Suite 210&n;&t;Annapolis MD 21403&n;&n;&t;Support and updates available at&n;&t;http://www.scyld.com/network/yellowfin.html&n;&n;&n;&t;Linux kernel changelog:&n;&t;-----------------------&n;&n;&t;LK1.1.1 (jgarzik): Port to 2.4 kernel&n;&n;&t;LK1.1.2 (jgarzik):&n;&t;* Merge in becker version 1.05&n;&n;&t;LK1.1.3 (jgarzik):&n;&t;* Various cleanups&n;&t;* Update yellowfin_timer to correctly calculate duplex.&n;&t;(suggested by Manfred Spraul)&n;&n;&t;LK1.1.4 (val@nmt.edu):&n;&t;* Fix three endian-ness bugs&n;&t;* Support dual function SYM53C885E ethernet chip&n;&t;&n;*/
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;yellowfin&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;1.05+LK1.1.3&quot;
DECL|macro|DRV_RELDATE
mdefine_line|#define DRV_RELDATE&t;&quot;May 10, 2001&quot;
DECL|macro|PFX
mdefine_line|#define PFX DRV_NAME &quot;: &quot;
multiline_comment|/* The user-configurable values.&n;   These may be modified when a driver module is loaded.*/
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 normal messages, 0 quiet .. 7 verbose. */
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
DECL|variable|mtu
r_static
r_int
id|mtu
suffix:semicolon
macro_line|#ifdef YF_PROTOTYPE&t;&t;&t;/* Support for prototype hardware errata. */
multiline_comment|/* System-wide count of bogus-rx frames. */
DECL|variable|bogus_rx
r_static
r_int
id|bogus_rx
suffix:semicolon
DECL|variable|dma_ctrl
r_static
r_int
id|dma_ctrl
op_assign
l_int|0x004A0263
suffix:semicolon
multiline_comment|/* Constrained by errata */
DECL|variable|fifo_cfg
r_static
r_int
id|fifo_cfg
op_assign
l_int|0x0020
suffix:semicolon
multiline_comment|/* Bypass external Tx FIFO. */
macro_line|#elif YF_NEW&t;&t;&t;&t;&t;/* A future perfect board :-&gt;.  */
DECL|variable|dma_ctrl
r_static
r_int
id|dma_ctrl
op_assign
l_int|0x00CAC277
suffix:semicolon
multiline_comment|/* Override when loading module! */
DECL|variable|fifo_cfg
r_static
r_int
id|fifo_cfg
op_assign
l_int|0x0028
suffix:semicolon
macro_line|#else
DECL|variable|dma_ctrl
r_static
r_int
id|dma_ctrl
op_assign
l_int|0x004A0263
suffix:semicolon
multiline_comment|/* Constrained by errata */
DECL|variable|fifo_cfg
r_static
r_int
id|fifo_cfg
op_assign
l_int|0x0020
suffix:semicolon
multiline_comment|/* Bypass external Tx FIFO. */
macro_line|#endif
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-frames scheme.&n;   Setting to &gt; 1514 effectively disables this feature. */
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
suffix:semicolon
multiline_comment|/* Used to pass the media type, etc.&n;   No media types are currently defined.  These exist for driver&n;   interoperability.&n;*/
DECL|macro|MAX_UNITS
mdefine_line|#define MAX_UNITS 8&t;&t;&t;&t;/* More are supported, limit only on options */
DECL|variable|options
r_static
r_int
id|options
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
(braket
id|MAX_UNITS
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* Do ugly workaround for GX server chipset errata. */
DECL|variable|gx_fix
r_static
r_int
id|gx_fix
suffix:semicolon
multiline_comment|/* Operational parameters that are set at compile time. */
multiline_comment|/* Keep the ring sizes a power of two for efficiency.&n;   Making the Tx ring too long decreases the effectiveness of channel&n;   bonding and packet priority.&n;   There are no ill effects from too-large receive rings. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;16
DECL|macro|TX_QUEUE_SIZE
mdefine_line|#define TX_QUEUE_SIZE&t;12&t;&t;/* Must be &gt; 4 &amp;&amp; &lt;= TX_RING_SIZE */
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;64
DECL|macro|STATUS_TOTAL_SIZE
mdefine_line|#define STATUS_TOTAL_SIZE&t;TX_RING_SIZE*sizeof(struct tx_status_words)
DECL|macro|TX_TOTAL_SIZE
mdefine_line|#define TX_TOTAL_SIZE&t;&t;2*TX_RING_SIZE*sizeof(struct yellowfin_desc)
DECL|macro|RX_TOTAL_SIZE
mdefine_line|#define RX_TOTAL_SIZE&t;&t;RX_RING_SIZE*sizeof(struct yellowfin_desc)
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  (2*HZ)
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536&t;&t;&t;/* Size of each temporary Rx buffer.*/
DECL|macro|yellowfin_debug
mdefine_line|#define yellowfin_debug debug
macro_line|#if !defined(__OPTIMIZE__)
macro_line|#warning  You must compile this file with the correct options!
macro_line|#warning  See the last lines of the source file.
macro_line|#error You must compile this driver with &quot;-O&quot;.
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/processor.h&gt;&t;&t;/* Processor type for cache alignment. */
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* These identify the driver base version and may not be removed. */
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
id|KERN_INFO
id|DRV_NAME
l_string|&quot;.c:v1.05  1/09/2001  Written by Donald Becker &lt;becker@scyld.com&gt;&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  http://www.scyld.com/network/yellowfin.html&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  (unofficial 2.4.x port, &quot;
id|DRV_VERSION
l_string|&quot;, &quot;
id|DRV_RELDATE
l_string|&quot;)&bslash;n&quot;
suffix:semicolon
macro_line|#ifndef USE_IO_OPS
DECL|macro|inb
macro_line|#undef inb
DECL|macro|inw
macro_line|#undef inw
DECL|macro|inl
macro_line|#undef inl
DECL|macro|outb
macro_line|#undef outb
DECL|macro|outw
macro_line|#undef outw
DECL|macro|outl
macro_line|#undef outl
DECL|macro|inb
mdefine_line|#define inb readb
DECL|macro|inw
mdefine_line|#define inw readw
DECL|macro|inl
mdefine_line|#define inl readl
DECL|macro|outb
mdefine_line|#define outb writeb
DECL|macro|outw
mdefine_line|#define outw writew
DECL|macro|outl
mdefine_line|#define outl writel
macro_line|#endif /* !USE_IO_OPS */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@scyld.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Packet Engines Yellowfin G-NIC Gigabit Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mtu
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|full_duplex
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|gx_fix
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;G-NIC maximum events handled per interrupt&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mtu
comma
l_string|&quot;G-NIC MTU (all boards)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;G-NIC debug level (0-7)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;G-NIC copy breakpoint for copy-only-tiny-frames&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|options
comma
l_string|&quot;G-NIC: Bits 0-3: media type, bit 17: full duplex&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|full_duplex
comma
l_string|&quot;G-NIC full duplex setting(s) (1)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|gx_fix
comma
l_string|&quot;G-NIC: enable GX server chipset bug workaround (0-1)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This device driver is designed for the Packet Engines &quot;Yellowfin&quot; Gigabit&n;Ethernet adapter.  The only PCA currently supported is the G-NIC 64-bit&n;PCI card.&n;&n;II. Board-specific settings&n;&n;PCI bus devices are configured by the system at boot time, so no jumpers&n;need to be set on the board.  The system BIOS preferably should assign the&n;PCI INTA signal to an otherwise unused system IRQ line.&n;Note: Kernel versions earlier than 1.3.73 do not support shared PCI&n;interrupt lines.&n;&n;III. Driver operation&n;&n;IIIa. Ring buffers&n;&n;The Yellowfin uses the Descriptor Based DMA Architecture specified by Apple.&n;This is a descriptor list scheme similar to that used by the EEPro100 and&n;Tulip.  This driver uses two statically allocated fixed-size descriptor lists&n;formed into rings by a branch from the final descriptor to the beginning of&n;the list.  The ring sizes are set at compile time by RX/TX_RING_SIZE.&n;&n;The driver allocates full frame size skbuffs for the Rx ring buffers at&n;open() time and passes the skb-&gt;data field to the Yellowfin as receive data&n;buffers.  When an incoming frame is less than RX_COPYBREAK bytes long,&n;a fresh skbuff is allocated and the frame is copied to the new skbuff.&n;When the incoming frame is larger, the skbuff is passed directly up the&n;protocol stack and replaced by a newly allocated skbuff.&n;&n;The RX_COPYBREAK value is chosen to trade-off the memory wasted by&n;using a full-sized skbuff for small frames vs. the copying costs of larger&n;frames.  For small frames the copying cost is negligible (esp. considering&n;that we are pre-loading the cache with immediately useful header&n;information).  For large frames the copying cost is non-trivial, and the&n;larger copy might flush the cache of useful data.&n;&n;IIIC. Synchronization&n;&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and other software.&n;&n;The send packet thread has partial control over the Tx ring and &squot;dev-&gt;tbusy&squot;&n;flag.  It sets the tbusy flag whenever it&squot;s queuing a Tx packet. If the next&n;queue slot is empty, it clears the tbusy flag when finished otherwise it sets&n;the &squot;yp-&gt;tx_full&squot; flag.&n;&n;The interrupt handler has exclusive control over the Rx ring and records stats&n;from the Tx ring.  After reaping the stats, it marks the Tx queue entry as&n;empty by incrementing the dirty_tx mark. Iff the &squot;yp-&gt;tx_full&squot; flag is set, it&n;clears both the tx_full and tbusy flags.&n;&n;IV. Notes&n;&n;Thanks to Kim Stearns of Packet Engines for providing a pair of G-NIC boards.&n;Thanks to Bruce Faust of Digitalscape for providing both their SYM53C885 board&n;and an AlphaStation to verifty the Alpha port!&n;&n;IVb. References&n;&n;Yellowfin Engineering Design Specification, 4/23/97 Preliminary/Confidential&n;Symbios SYM53C885 PCI-SCSI/Fast Ethernet Multifunction Controller Preliminary&n;   Data Manual v3.0&n;http://cesdis.gsfc.nasa.gov/linux/misc/NWay.html&n;http://cesdis.gsfc.nasa.gov/linux/misc/100mbps.html&n;&n;IVc. Errata&n;&n;See Packet Engines confidential appendix (prototype chips only).&n;*/
"&f;"
DECL|enum|pci_id_flags_bits
r_enum
id|pci_id_flags_bits
(brace
multiline_comment|/* Set PCI command register bits before calling probe1(). */
DECL|enumerator|PCI_USES_IO
DECL|enumerator|PCI_USES_MEM
DECL|enumerator|PCI_USES_MASTER
id|PCI_USES_IO
op_assign
l_int|1
comma
id|PCI_USES_MEM
op_assign
l_int|2
comma
id|PCI_USES_MASTER
op_assign
l_int|4
comma
multiline_comment|/* Read and map the single following PCI BAR. */
DECL|enumerator|PCI_ADDR0
DECL|enumerator|PCI_ADDR1
DECL|enumerator|PCI_ADDR2
DECL|enumerator|PCI_ADDR3
id|PCI_ADDR0
op_assign
l_int|0
op_lshift
l_int|4
comma
id|PCI_ADDR1
op_assign
l_int|1
op_lshift
l_int|4
comma
id|PCI_ADDR2
op_assign
l_int|2
op_lshift
l_int|4
comma
id|PCI_ADDR3
op_assign
l_int|3
op_lshift
l_int|4
comma
DECL|enumerator|PCI_ADDR_64BITS
DECL|enumerator|PCI_NO_ACPI_WAKE
DECL|enumerator|PCI_NO_MIN_LATENCY
id|PCI_ADDR_64BITS
op_assign
l_int|0x100
comma
id|PCI_NO_ACPI_WAKE
op_assign
l_int|0x200
comma
id|PCI_NO_MIN_LATENCY
op_assign
l_int|0x400
comma
DECL|enumerator|PCI_UNUSED_IRQ
id|PCI_UNUSED_IRQ
op_assign
l_int|0x800
comma
)brace
suffix:semicolon
DECL|enum|capability_flags
r_enum
id|capability_flags
(brace
DECL|enumerator|HasMII
DECL|enumerator|FullTxStatus
DECL|enumerator|IsGigabit
DECL|enumerator|HasMulticastBug
DECL|enumerator|FullRxStatus
id|HasMII
op_assign
l_int|1
comma
id|FullTxStatus
op_assign
l_int|2
comma
id|IsGigabit
op_assign
l_int|4
comma
id|HasMulticastBug
op_assign
l_int|8
comma
id|FullRxStatus
op_assign
l_int|16
comma
DECL|enumerator|HasMACAddrBug
id|HasMACAddrBug
op_assign
l_int|32
comma
multiline_comment|/* Only on early revs.  */
)brace
suffix:semicolon
multiline_comment|/* The PCI I/O space extent. */
DECL|macro|YELLOWFIN_SIZE
mdefine_line|#define YELLOWFIN_SIZE 0x100
macro_line|#ifdef USE_IO_OPS
DECL|macro|PCI_IOTYPE
mdefine_line|#define PCI_IOTYPE (PCI_USES_MASTER | PCI_USES_IO  | PCI_ADDR0)
macro_line|#else
DECL|macro|PCI_IOTYPE
mdefine_line|#define PCI_IOTYPE (PCI_USES_MASTER | PCI_USES_MEM | PCI_ADDR1)
macro_line|#endif
DECL|struct|pci_id_info
r_struct
id|pci_id_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|struct|match_info
r_struct
id|match_info
(brace
DECL|member|pci
DECL|member|pci_mask
DECL|member|subsystem
DECL|member|subsystem_mask
r_int
id|pci
comma
id|pci_mask
comma
id|subsystem
comma
id|subsystem_mask
suffix:semicolon
DECL|member|revision
DECL|member|revision_mask
r_int
id|revision
comma
id|revision_mask
suffix:semicolon
multiline_comment|/* Only 8 bits. */
DECL|member|id
)brace
id|id
suffix:semicolon
DECL|member|pci_flags
r_enum
id|pci_id_flags_bits
id|pci_flags
suffix:semicolon
DECL|member|io_size
r_int
id|io_size
suffix:semicolon
multiline_comment|/* Needed for I/O region check or ioremap(). */
DECL|member|drv_flags
r_int
id|drv_flags
suffix:semicolon
multiline_comment|/* Driver use, intended as capability flags. */
)brace
suffix:semicolon
DECL|variable|pci_id_tbl
r_static
r_struct
id|pci_id_info
id|pci_id_tbl
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Yellowfin G-NIC Gigabit Ethernet&quot;
comma
(brace
l_int|0x07021000
comma
l_int|0xffffffff
)brace
comma
id|PCI_IOTYPE
comma
id|YELLOWFIN_SIZE
comma
id|FullTxStatus
op_or
id|IsGigabit
op_or
id|HasMulticastBug
op_or
id|HasMACAddrBug
)brace
comma
(brace
l_string|&quot;Symbios SYM83C885&quot;
comma
(brace
l_int|0x07011000
comma
l_int|0xffffffff
)brace
comma
id|PCI_IOTYPE
comma
id|YELLOWFIN_SIZE
comma
id|HasMII
op_or
id|IsGigabit
op_or
id|FullTxStatus
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|yellowfin_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_int|0x1000
comma
l_int|0x0702
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0x1000
comma
l_int|0x0701
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|yellowfin_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* Offsets to the Yellowfin registers.  Various sizes and alignments. */
DECL|enum|yellowfin_offsets
r_enum
id|yellowfin_offsets
(brace
DECL|enumerator|TxCtrl
DECL|enumerator|TxStatus
DECL|enumerator|TxPtr
id|TxCtrl
op_assign
l_int|0x00
comma
id|TxStatus
op_assign
l_int|0x04
comma
id|TxPtr
op_assign
l_int|0x0C
comma
DECL|enumerator|TxIntrSel
DECL|enumerator|TxBranchSel
DECL|enumerator|TxWaitSel
id|TxIntrSel
op_assign
l_int|0x10
comma
id|TxBranchSel
op_assign
l_int|0x14
comma
id|TxWaitSel
op_assign
l_int|0x18
comma
DECL|enumerator|RxCtrl
DECL|enumerator|RxStatus
DECL|enumerator|RxPtr
id|RxCtrl
op_assign
l_int|0x40
comma
id|RxStatus
op_assign
l_int|0x44
comma
id|RxPtr
op_assign
l_int|0x4C
comma
DECL|enumerator|RxIntrSel
DECL|enumerator|RxBranchSel
DECL|enumerator|RxWaitSel
id|RxIntrSel
op_assign
l_int|0x50
comma
id|RxBranchSel
op_assign
l_int|0x54
comma
id|RxWaitSel
op_assign
l_int|0x58
comma
DECL|enumerator|EventStatus
DECL|enumerator|IntrEnb
DECL|enumerator|IntrClear
DECL|enumerator|IntrStatus
id|EventStatus
op_assign
l_int|0x80
comma
id|IntrEnb
op_assign
l_int|0x82
comma
id|IntrClear
op_assign
l_int|0x84
comma
id|IntrStatus
op_assign
l_int|0x86
comma
DECL|enumerator|ChipRev
DECL|enumerator|DMACtrl
DECL|enumerator|TxThreshold
id|ChipRev
op_assign
l_int|0x8C
comma
id|DMACtrl
op_assign
l_int|0x90
comma
id|TxThreshold
op_assign
l_int|0x94
comma
DECL|enumerator|Cnfg
DECL|enumerator|FrameGap0
DECL|enumerator|FrameGap1
id|Cnfg
op_assign
l_int|0xA0
comma
id|FrameGap0
op_assign
l_int|0xA2
comma
id|FrameGap1
op_assign
l_int|0xA4
comma
DECL|enumerator|MII_Cmd
DECL|enumerator|MII_Addr
DECL|enumerator|MII_Wr_Data
DECL|enumerator|MII_Rd_Data
id|MII_Cmd
op_assign
l_int|0xA6
comma
id|MII_Addr
op_assign
l_int|0xA8
comma
id|MII_Wr_Data
op_assign
l_int|0xAA
comma
id|MII_Rd_Data
op_assign
l_int|0xAC
comma
DECL|enumerator|MII_Status
id|MII_Status
op_assign
l_int|0xAE
comma
DECL|enumerator|RxDepth
DECL|enumerator|FlowCtrl
id|RxDepth
op_assign
l_int|0xB8
comma
id|FlowCtrl
op_assign
l_int|0xBC
comma
DECL|enumerator|AddrMode
DECL|enumerator|StnAddr
DECL|enumerator|HashTbl
DECL|enumerator|FIFOcfg
id|AddrMode
op_assign
l_int|0xD0
comma
id|StnAddr
op_assign
l_int|0xD2
comma
id|HashTbl
op_assign
l_int|0xD8
comma
id|FIFOcfg
op_assign
l_int|0xF8
comma
DECL|enumerator|EEStatus
DECL|enumerator|EECtrl
DECL|enumerator|EEAddr
DECL|enumerator|EERead
DECL|enumerator|EEWrite
id|EEStatus
op_assign
l_int|0xF0
comma
id|EECtrl
op_assign
l_int|0xF1
comma
id|EEAddr
op_assign
l_int|0xF2
comma
id|EERead
op_assign
l_int|0xF3
comma
id|EEWrite
op_assign
l_int|0xF4
comma
DECL|enumerator|EEFeature
id|EEFeature
op_assign
l_int|0xF5
comma
)brace
suffix:semicolon
multiline_comment|/* The Yellowfin Rx and Tx buffer descriptors.&n;   Elements are written as 32 bit for endian portability. */
DECL|struct|yellowfin_desc
r_struct
id|yellowfin_desc
(brace
DECL|member|dbdma_cmd
id|u32
id|dbdma_cmd
suffix:semicolon
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|branch_addr
id|u32
id|branch_addr
suffix:semicolon
DECL|member|result_status
id|u32
id|result_status
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tx_status_words
r_struct
id|tx_status_words
(brace
macro_line|#ifdef __BIG_ENDIAN
DECL|member|tx_errs
id|u16
id|tx_errs
suffix:semicolon
DECL|member|tx_cnt
id|u16
id|tx_cnt
suffix:semicolon
DECL|member|paused
id|u16
id|paused
suffix:semicolon
DECL|member|total_tx_cnt
id|u16
id|total_tx_cnt
suffix:semicolon
macro_line|#else  /* Little endian chips. */
id|u16
id|tx_cnt
suffix:semicolon
id|u16
id|tx_errs
suffix:semicolon
id|u16
id|total_tx_cnt
suffix:semicolon
id|u16
id|paused
suffix:semicolon
macro_line|#endif /* __BIG_ENDIAN */
)brace
suffix:semicolon
multiline_comment|/* Bits in yellowfin_desc.cmd */
DECL|enum|desc_cmd_bits
r_enum
id|desc_cmd_bits
(brace
DECL|enumerator|CMD_TX_PKT
DECL|enumerator|CMD_RX_BUF
DECL|enumerator|CMD_TXSTATUS
id|CMD_TX_PKT
op_assign
l_int|0x10000000
comma
id|CMD_RX_BUF
op_assign
l_int|0x20000000
comma
id|CMD_TXSTATUS
op_assign
l_int|0x30000000
comma
DECL|enumerator|CMD_NOP
DECL|enumerator|CMD_STOP
id|CMD_NOP
op_assign
l_int|0x60000000
comma
id|CMD_STOP
op_assign
l_int|0x70000000
comma
DECL|enumerator|BRANCH_ALWAYS
DECL|enumerator|INTR_ALWAYS
DECL|enumerator|WAIT_ALWAYS
id|BRANCH_ALWAYS
op_assign
l_int|0x0C0000
comma
id|INTR_ALWAYS
op_assign
l_int|0x300000
comma
id|WAIT_ALWAYS
op_assign
l_int|0x030000
comma
DECL|enumerator|BRANCH_IFTRUE
id|BRANCH_IFTRUE
op_assign
l_int|0x040000
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in yellowfin_desc.status */
DECL|enum|desc_status_bits
DECL|enumerator|RX_EOP
r_enum
id|desc_status_bits
(brace
id|RX_EOP
op_assign
l_int|0x0040
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in the interrupt status/mask registers. */
DECL|enum|intr_status_bits
r_enum
id|intr_status_bits
(brace
DECL|enumerator|IntrRxDone
DECL|enumerator|IntrRxInvalid
DECL|enumerator|IntrRxPCIFault
DECL|enumerator|IntrRxPCIErr
id|IntrRxDone
op_assign
l_int|0x01
comma
id|IntrRxInvalid
op_assign
l_int|0x02
comma
id|IntrRxPCIFault
op_assign
l_int|0x04
comma
id|IntrRxPCIErr
op_assign
l_int|0x08
comma
DECL|enumerator|IntrTxDone
DECL|enumerator|IntrTxInvalid
DECL|enumerator|IntrTxPCIFault
DECL|enumerator|IntrTxPCIErr
id|IntrTxDone
op_assign
l_int|0x10
comma
id|IntrTxInvalid
op_assign
l_int|0x20
comma
id|IntrTxPCIFault
op_assign
l_int|0x40
comma
id|IntrTxPCIErr
op_assign
l_int|0x80
comma
DECL|enumerator|IntrEarlyRx
DECL|enumerator|IntrWakeup
id|IntrEarlyRx
op_assign
l_int|0x100
comma
id|IntrWakeup
op_assign
l_int|0x200
comma
)brace
suffix:semicolon
DECL|macro|PRIV_ALIGN
mdefine_line|#define PRIV_ALIGN&t;31 &t;/* Required alignment mask */
DECL|macro|MII_CNT
mdefine_line|#define MII_CNT&t;&t;4
DECL|struct|yellowfin_private
r_struct
id|yellowfin_private
(brace
multiline_comment|/* Descriptor rings first for alignment.&n;&t;   Tx requires a second descriptor for status. */
DECL|member|rx_ring
r_struct
id|yellowfin_desc
op_star
id|rx_ring
suffix:semicolon
DECL|member|tx_ring
r_struct
id|yellowfin_desc
op_star
id|tx_ring
suffix:semicolon
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_ring_dma
id|dma_addr_t
id|rx_ring_dma
suffix:semicolon
DECL|member|tx_ring_dma
id|dma_addr_t
id|tx_ring_dma
suffix:semicolon
DECL|member|tx_status
r_struct
id|tx_status_words
op_star
id|tx_status
suffix:semicolon
DECL|member|tx_status_dma
id|dma_addr_t
id|tx_status_dma
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media selection timer. */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
multiline_comment|/* Frequently used and paired value: keep adjacent for cache effect. */
DECL|member|chip_id
DECL|member|drv_flags
r_int
id|chip_id
comma
id|drv_flags
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|cur_rx
DECL|member|dirty_rx
r_int
r_int
id|cur_rx
comma
id|dirty_rx
suffix:semicolon
multiline_comment|/* Producer/consumer ring indices */
DECL|member|rx_buf_sz
r_int
r_int
id|rx_buf_sz
suffix:semicolon
multiline_comment|/* Based on MTU+slack. */
DECL|member|tx_tail_desc
r_struct
id|tx_status_words
op_star
id|tx_tail_desc
suffix:semicolon
DECL|member|cur_tx
DECL|member|dirty_tx
r_int
r_int
id|cur_tx
comma
id|dirty_tx
suffix:semicolon
DECL|member|tx_threshold
r_int
id|tx_threshold
suffix:semicolon
DECL|member|tx_full
r_int
r_int
id|tx_full
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The Tx queue is full. */
DECL|member|full_duplex
r_int
r_int
id|full_duplex
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Full-duplex operation requested. */
DECL|member|duplex_lock
r_int
r_int
id|duplex_lock
suffix:colon
l_int|1
suffix:semicolon
DECL|member|medialock
r_int
r_int
id|medialock
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Do not sense media. */
DECL|member|default_port
r_int
r_int
id|default_port
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Last dev-&gt;if_port value. */
multiline_comment|/* MII transceiver section. */
DECL|member|mii_cnt
r_int
id|mii_cnt
suffix:semicolon
multiline_comment|/* MII device addresses. */
DECL|member|advertising
id|u16
id|advertising
suffix:semicolon
multiline_comment|/* NWay media advertisement */
DECL|member|phys
r_int
r_char
id|phys
(braket
id|MII_CNT
)braket
suffix:semicolon
multiline_comment|/* MII device addresses, only first one used */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|netdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|yellowfin_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|yellowfin_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|yellowfin_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|yellowfin_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|yellowfin_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|yellowfin_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|yellowfin_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|yellowfin_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
suffix:semicolon
r_static
r_int
id|yellowfin_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|yellowfin_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|yellowfin_init_one
r_static
r_int
id|__devinit
id|yellowfin_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|yellowfin_private
op_star
id|np
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_int
id|chip_idx
op_assign
id|ent-&gt;driver_data
suffix:semicolon
r_static
r_int
id|find_cnt
suffix:semicolon
r_int
id|ioaddr
comma
id|real_ioaddr
suffix:semicolon
r_int
id|i
comma
id|option
op_assign
id|find_cnt
OL
id|MAX_UNITS
ques
c_cond
id|options
(braket
id|find_cnt
)braket
suffix:colon
l_int|0
suffix:semicolon
r_int
id|drv_flags
op_assign
id|pci_id_tbl
(braket
id|chip_idx
)braket
dot
id|drv_flags
suffix:semicolon
r_void
op_star
id|ring_space
suffix:semicolon
id|dma_addr_t
id|ring_dma
suffix:semicolon
multiline_comment|/* when built into the kernel, we only print version if device is found */
macro_line|#ifndef MODULE
r_static
r_int
id|printed_version
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#endif
id|i
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
op_star
id|np
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot allocate ethernet device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|dev-&gt;name
)paren
)paren
r_goto
id|err_out_free_netdev
suffix:semicolon
id|pci_set_master
(paren
id|pdev
)paren
suffix:semicolon
macro_line|#ifdef USE_IO_OPS
id|real_ioaddr
op_assign
id|ioaddr
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
macro_line|#else
id|real_ioaddr
op_assign
id|ioaddr
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|ioaddr
op_assign
(paren
r_int
)paren
id|ioremap
c_func
(paren
id|ioaddr
comma
id|YELLOWFIN_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr
)paren
r_goto
id|err_out_free_res
suffix:semicolon
macro_line|#endif
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|drv_flags
op_amp
id|IsGigabit
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|StnAddr
op_plus
id|i
)paren
suffix:semicolon
r_else
(brace
r_int
id|ee_offset
op_assign
(paren
id|read_eeprom
c_func
(paren
id|ioaddr
comma
l_int|6
)paren
op_eq
l_int|0xff
ques
c_cond
l_int|0x100
suffix:colon
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|read_eeprom
c_func
(paren
id|ioaddr
comma
id|ee_offset
op_plus
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset the chip. */
id|outl
c_func
(paren
l_int|0x80000000
comma
id|ioaddr
op_plus
id|DMACtrl
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|np-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
id|np-&gt;chip_id
op_assign
id|chip_idx
suffix:semicolon
id|np-&gt;drv_flags
op_assign
id|drv_flags
suffix:semicolon
id|ring_space
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
op_amp
id|ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ring_space
)paren
r_goto
id|err_out_cleardev
suffix:semicolon
id|np-&gt;tx_ring
op_assign
(paren
r_struct
id|yellowfin_desc
op_star
)paren
id|ring_space
suffix:semicolon
id|np-&gt;tx_ring_dma
op_assign
id|ring_dma
suffix:semicolon
id|ring_space
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
op_amp
id|ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ring_space
)paren
r_goto
id|err_out_unmap_tx
suffix:semicolon
id|np-&gt;rx_ring
op_assign
(paren
r_struct
id|yellowfin_desc
op_star
)paren
id|ring_space
suffix:semicolon
id|np-&gt;rx_ring_dma
op_assign
id|ring_dma
suffix:semicolon
id|ring_space
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|STATUS_TOTAL_SIZE
comma
op_amp
id|ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ring_space
)paren
r_goto
id|err_out_unmap_rx
suffix:semicolon
id|np-&gt;tx_status
op_assign
(paren
r_struct
id|tx_status_words
op_star
)paren
id|ring_space
suffix:semicolon
id|np-&gt;tx_status_dma
op_assign
id|ring_dma
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mem_start
)paren
id|option
op_assign
id|dev-&gt;mem_start
suffix:semicolon
multiline_comment|/* The lower four bits are the media type. */
r_if
c_cond
(paren
id|option
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|option
op_amp
l_int|0x200
)paren
id|np-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
id|np-&gt;default_port
op_assign
id|option
op_amp
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;default_port
)paren
id|np-&gt;medialock
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|find_cnt
template_param
l_int|0
)paren
id|np-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;full_duplex
)paren
id|np-&gt;duplex_lock
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* The Yellowfin-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|yellowfin_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|yellowfin_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|yellowfin_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|yellowfin_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|netdev_ioctl
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|yellowfin_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|mtu
)paren
id|dev-&gt;mtu
op_assign
id|mtu
suffix:semicolon
id|i
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_goto
id|err_out_unmap_status
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s type %8x at 0x%lx, &quot;
comma
id|dev-&gt;name
comma
id|pci_id_tbl
(braket
id|chip_idx
)braket
dot
id|name
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|ChipRev
)paren
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2x, IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;drv_flags
op_amp
id|HasMII
)paren
(brace
r_int
id|phy
comma
id|phy_idx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|phy
op_assign
l_int|0
suffix:semicolon
id|phy
OL
l_int|32
op_logical_and
id|phy_idx
OL
id|MII_CNT
suffix:semicolon
id|phy
op_increment
)paren
(brace
r_int
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_ne
l_int|0xffff
op_logical_and
id|mii_status
op_ne
l_int|0x0000
)paren
(brace
id|np-&gt;phys
(braket
id|phy_idx
op_increment
)braket
op_assign
id|phy
suffix:semicolon
id|np-&gt;advertising
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|phy
comma
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MII PHY found at address %d, status &quot;
l_string|&quot;0x%4.4x advertising %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
comma
id|mii_status
comma
id|np-&gt;advertising
)paren
suffix:semicolon
)brace
)brace
id|np-&gt;mii_cnt
op_assign
id|phy_idx
suffix:semicolon
)brace
id|find_cnt
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_unmap_status
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|STATUS_TOTAL_SIZE
comma
id|np-&gt;tx_status
comma
id|np-&gt;tx_status_dma
)paren
suffix:semicolon
id|err_out_unmap_rx
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
id|np-&gt;rx_ring
comma
id|np-&gt;rx_ring_dma
)paren
suffix:semicolon
id|err_out_unmap_tx
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
id|np-&gt;tx_ring
comma
id|np-&gt;tx_ring_dma
)paren
suffix:semicolon
id|err_out_cleardev
suffix:colon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifndef USE_IO_OPS
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr
)paren
suffix:semicolon
id|err_out_free_res
suffix:colon
macro_line|#endif
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_free_netdev
suffix:colon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|read_eeprom
r_static
r_int
id|__devinit
id|read_eeprom
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
(brace
r_int
id|bogus_cnt
op_assign
l_int|10000
suffix:semicolon
multiline_comment|/* Typical 33Mhz: 1050 ticks */
id|outb
c_func
(paren
id|location
comma
id|ioaddr
op_plus
id|EEAddr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x30
op_or
(paren
(paren
id|location
op_rshift
l_int|8
)paren
op_amp
l_int|7
)paren
comma
id|ioaddr
op_plus
id|EECtrl
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EEStatus
)paren
op_amp
l_int|0x80
)paren
op_logical_and
op_decrement
id|bogus_cnt
OG
l_int|0
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EERead
)paren
suffix:semicolon
)brace
multiline_comment|/* MII Managemen Data I/O accesses.&n;   These routines assume the MDIO controller is idle, and do not exit until&n;   the command is finished. */
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_int
id|i
suffix:semicolon
id|outw
c_func
(paren
(paren
id|phy_id
op_lshift
l_int|8
)paren
op_plus
id|location
comma
id|ioaddr
op_plus
id|MII_Addr
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|1
comma
id|ioaddr
op_plus
id|MII_Cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|10000
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MII_Status
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_return
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MII_Rd_Data
)paren
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_int
id|i
suffix:semicolon
id|outw
c_func
(paren
(paren
id|phy_id
op_lshift
l_int|8
)paren
op_plus
id|location
comma
id|ioaddr
op_plus
id|MII_Addr
)paren
suffix:semicolon
id|outw
c_func
(paren
id|value
comma
id|ioaddr
op_plus
id|MII_Wr_Data
)paren
suffix:semicolon
multiline_comment|/* Wait for the command to finish. */
r_for
c_loop
(paren
id|i
op_assign
l_int|10000
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
id|MII_Status
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_return
suffix:semicolon
)brace
"&f;"
DECL|function|yellowfin_open
r_static
r_int
id|yellowfin_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Reset the chip. */
id|outl
c_func
(paren
l_int|0x80000000
comma
id|ioaddr
op_plus
id|DMACtrl
)paren
suffix:semicolon
id|i
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|yellowfin_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: yellowfin_open() irq %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|yellowfin_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outl
c_func
(paren
id|yp-&gt;rx_ring_dma
comma
id|ioaddr
op_plus
id|RxPtr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|yp-&gt;tx_ring_dma
comma
id|ioaddr
op_plus
id|TxPtr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|StnAddr
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Set up various condition &squot;select&squot; registers.&n;&t;   There are no options here. */
id|outl
c_func
(paren
l_int|0x00800080
comma
id|ioaddr
op_plus
id|TxIntrSel
)paren
suffix:semicolon
multiline_comment|/* Interrupt on Tx abort */
id|outl
c_func
(paren
l_int|0x00800080
comma
id|ioaddr
op_plus
id|TxBranchSel
)paren
suffix:semicolon
multiline_comment|/* Branch on Tx abort */
id|outl
c_func
(paren
l_int|0x00400040
comma
id|ioaddr
op_plus
id|TxWaitSel
)paren
suffix:semicolon
multiline_comment|/* Wait on Tx status */
id|outl
c_func
(paren
l_int|0x00400040
comma
id|ioaddr
op_plus
id|RxIntrSel
)paren
suffix:semicolon
multiline_comment|/* Interrupt on Rx done */
id|outl
c_func
(paren
l_int|0x00400040
comma
id|ioaddr
op_plus
id|RxBranchSel
)paren
suffix:semicolon
multiline_comment|/* Branch on Rx error */
id|outl
c_func
(paren
l_int|0x00400040
comma
id|ioaddr
op_plus
id|RxWaitSel
)paren
suffix:semicolon
multiline_comment|/* Wait on Rx done */
multiline_comment|/* Initialize other registers: with so many this eventually this will&n;&t;   converted to an offset/value list. */
id|outl
c_func
(paren
id|dma_ctrl
comma
id|ioaddr
op_plus
id|DMACtrl
)paren
suffix:semicolon
id|outw
c_func
(paren
id|fifo_cfg
comma
id|ioaddr
op_plus
id|FIFOcfg
)paren
suffix:semicolon
multiline_comment|/* Enable automatic generation of flow control frames, period 0xffff. */
id|outl
c_func
(paren
l_int|0x0030FFFF
comma
id|ioaddr
op_plus
id|FlowCtrl
)paren
suffix:semicolon
id|yp-&gt;tx_threshold
op_assign
l_int|32
suffix:semicolon
id|outl
c_func
(paren
id|yp-&gt;tx_threshold
comma
id|ioaddr
op_plus
id|TxThreshold
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
id|dev-&gt;if_port
op_assign
id|yp-&gt;default_port
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Setting the Rx mode will start the Rx process. */
r_if
c_cond
(paren
id|yp-&gt;drv_flags
op_amp
id|IsGigabit
)paren
(brace
multiline_comment|/* We are always in full-duplex mode with gigabit! */
id|yp-&gt;full_duplex
op_assign
l_int|1
suffix:semicolon
id|outw
c_func
(paren
l_int|0x01CF
comma
id|ioaddr
op_plus
id|Cnfg
)paren
suffix:semicolon
)brace
r_else
(brace
id|outw
c_func
(paren
l_int|0x0018
comma
id|ioaddr
op_plus
id|FrameGap0
)paren
suffix:semicolon
multiline_comment|/* 0060/4060 for non-MII 10baseT */
id|outw
c_func
(paren
l_int|0x1018
comma
id|ioaddr
op_plus
id|FrameGap1
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x101C
op_or
(paren
id|yp-&gt;full_duplex
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
comma
id|ioaddr
op_plus
id|Cnfg
)paren
suffix:semicolon
)brace
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts by setting the interrupt mask. */
id|outw
c_func
(paren
l_int|0x81ff
comma
id|ioaddr
op_plus
id|IntrEnb
)paren
suffix:semicolon
multiline_comment|/* See enum intr_status_bits */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|EventStatus
)paren
suffix:semicolon
multiline_comment|/* Clear non-interrupting events */
id|outl
c_func
(paren
l_int|0x80008000
comma
id|ioaddr
op_plus
id|RxCtrl
)paren
suffix:semicolon
multiline_comment|/* Start Rx and Tx channels. */
id|outl
c_func
(paren
l_int|0x80008000
comma
id|ioaddr
op_plus
id|TxCtrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Done yellowfin_open().&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the timer to check for link beat. */
id|init_timer
c_func
(paren
op_amp
id|yp-&gt;timer
)paren
suffix:semicolon
id|yp-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
suffix:semicolon
id|yp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|yp-&gt;timer.function
op_assign
op_amp
id|yellowfin_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|yp-&gt;timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yellowfin_timer
r_static
r_void
id|yellowfin_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Yellowfin timer tick, status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|yp-&gt;mii_cnt
)paren
(brace
r_int
id|bmsr
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|yp-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_BMSR
)paren
suffix:semicolon
r_int
id|lpa
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|yp-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_LPA
)paren
suffix:semicolon
r_int
id|negotiated
op_assign
id|lpa
op_amp
id|yp-&gt;advertising
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: MII #%d status register is %4.4x, &quot;
l_string|&quot;link partner capability %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|yp-&gt;phys
(braket
l_int|0
)braket
comma
id|bmsr
comma
id|lpa
)paren
suffix:semicolon
id|yp-&gt;full_duplex
op_assign
id|mii_duplex
c_func
(paren
id|yp-&gt;duplex_lock
comma
id|negotiated
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x101C
op_or
(paren
id|yp-&gt;full_duplex
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
comma
id|ioaddr
op_plus
id|Cnfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bmsr
op_amp
id|BMSR_LSTATUS
)paren
id|next_tick
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
r_else
id|next_tick
op_assign
l_int|3
op_star
id|HZ
suffix:semicolon
)brace
id|yp-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|next_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|yp-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|yellowfin_tx_timeout
r_static
r_void
id|yellowfin_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Yellowfin transmit timed out at %d/%d Tx &quot;
l_string|&quot;status %4.4x, Rx status %4.4x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|yp-&gt;cur_tx
comma
id|yp-&gt;dirty_tx
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
suffix:semicolon
multiline_comment|/* Note: these should be KERN_DEBUG. */
r_if
c_cond
(paren
id|yellowfin_debug
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;  Rx ring %p: &quot;
comma
id|yp-&gt;rx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %8.8x&quot;
comma
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|result_status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_WARNING
l_string|&quot;  Tx ring %p: &quot;
comma
id|yp-&gt;tx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %4.4x /%8.8x&quot;
comma
id|yp-&gt;tx_status
(braket
id|i
)braket
dot
id|tx_errs
comma
id|yp-&gt;tx_ring
(braket
id|i
)braket
dot
id|result_status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* If the hardware is found to hang regularly, we will update the code&n;&t;   to reinitialize the chip here. */
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Wake the potentially-idle transmit channel. */
id|outl
c_func
(paren
l_int|0x10001000
comma
id|dev-&gt;base_addr
op_plus
id|TxCtrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yp-&gt;cur_tx
op_minus
id|yp-&gt;dirty_tx
OL
id|TX_QUEUE_SIZE
)paren
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Typical path */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|yp-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Initialize the Rx and Tx rings, along with various &squot;dev&squot; bits. */
DECL|function|yellowfin_init_ring
r_static
r_void
id|yellowfin_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|yp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|yp-&gt;cur_rx
op_assign
id|yp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|yp-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|yp-&gt;rx_buf_sz
op_assign
(paren
id|dev-&gt;mtu
op_le
l_int|1500
ques
c_cond
id|PKT_BUF_SZ
suffix:colon
id|dev-&gt;mtu
op_plus
l_int|32
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_RX_BUF
op_or
id|INTR_ALWAYS
op_or
id|yp-&gt;rx_buf_sz
)paren
suffix:semicolon
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|branch_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|yp-&gt;rx_ring_dma
op_plus
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|RX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|yellowfin_desc
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|yp-&gt;rx_buf_sz
)paren
suffix:semicolon
id|yp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the IP header. */
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|yp-&gt;pci_dev
comma
id|skb-&gt;tail
comma
id|yp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
)brace
id|yp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
id|yp-&gt;dirty_rx
op_assign
(paren
r_int
r_int
)paren
(paren
id|i
op_minus
id|RX_RING_SIZE
)paren
suffix:semicolon
DECL|macro|NO_TXSTATS
mdefine_line|#define NO_TXSTATS
macro_line|#ifdef NO_TXSTATS
multiline_comment|/* In this mode the Tx ring needs only a single descriptor. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|yp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|i
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|i
)braket
dot
id|branch_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|yp-&gt;tx_ring_dma
op_plus
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|yellowfin_desc
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Wrap ring */
id|yp-&gt;tx_ring
(braket
op_decrement
id|i
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
op_or
id|BRANCH_ALWAYS
)paren
suffix:semicolon
macro_line|#else
(brace
r_int
id|j
suffix:semicolon
multiline_comment|/* Tx ring needs a pair of descriptors, the second for the status. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
l_int|2
op_star
id|i
suffix:semicolon
id|yp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Branch on Tx error. */
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|branch_addr
op_assign
id|cpu_to_le32
(paren
id|yp-&gt;tx_ring_dma
op_plus
(paren
id|j
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|yellowfin_desc
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|yp-&gt;flags
op_amp
id|FullTxStatus
)paren
(brace
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_TXSTATUS
op_or
r_sizeof
(paren
op_star
id|yp-&gt;tx_status
)paren
)paren
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|request_cnt
op_assign
r_sizeof
(paren
op_star
id|yp-&gt;tx_status
)paren
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|addr
op_assign
id|cpu_to_le32
(paren
id|yp-&gt;tx_status_dma
op_plus
id|i
op_star
r_sizeof
(paren
r_struct
id|tx_status_words
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Symbios chips write only tx_errs word. */
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_TXSTATUS
op_or
id|INTR_ALWAYS
op_or
l_int|2
)paren
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|request_cnt
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Om pade ummmmm... */
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|yp-&gt;tx_status_dma
op_plus
id|i
op_star
r_sizeof
(paren
r_struct
id|tx_status_words
)paren
op_plus
op_amp
(paren
id|yp-&gt;tx_status
(braket
l_int|0
)braket
dot
id|tx_errs
)paren
op_minus
op_amp
(paren
id|yp-&gt;tx_status
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
id|yp-&gt;tx_ring
(braket
id|j
)braket
dot
id|branch_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|yp-&gt;tx_ring_dma
op_plus
(paren
(paren
id|j
op_plus
l_int|1
)paren
op_mod
(paren
l_int|2
op_star
id|TX_RING_SIZE
)paren
)paren
op_star
r_sizeof
(paren
r_struct
id|yellowfin_desc
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Wrap ring */
id|yp-&gt;tx_ring
(braket
op_increment
id|j
)braket
dot
id|dbdma_cmd
op_or_assign
id|cpu_to_le32
c_func
(paren
id|BRANCH_ALWAYS
op_or
id|INTR_ALWAYS
)paren
suffix:semicolon
)brace
macro_line|#endif
id|yp-&gt;tx_tail_desc
op_assign
op_amp
id|yp-&gt;tx_status
(braket
l_int|0
)braket
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|yellowfin_start_xmit
r_static
r_int
id|yellowfin_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Note: Ordering is important here, set the field with the&n;&t;   &quot;ownership&quot; bit last, and only then increment cur_tx. */
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|yp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|yp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|gx_fix
)paren
(brace
multiline_comment|/* Note: only works for paddable protocols e.g.  IP. */
r_int
id|cacheline_end
op_assign
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
)paren
op_mod
l_int|32
suffix:semicolon
multiline_comment|/* Fix GX chipset errata. */
r_if
c_cond
(paren
id|cacheline_end
OG
l_int|24
op_logical_or
id|cacheline_end
op_eq
l_int|0
)paren
id|skb-&gt;len
op_add_assign
l_int|32
op_minus
id|cacheline_end
op_plus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef NO_TXSTATS
id|yp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|yp-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
)paren
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|result_status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_ge
id|TX_RING_SIZE
op_minus
l_int|1
)paren
(brace
multiline_comment|/* New stop command. */
id|yp-&gt;tx_ring
(braket
l_int|0
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|TX_RING_SIZE
op_minus
l_int|1
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_TX_PKT
op_or
id|BRANCH_ALWAYS
op_or
id|skb-&gt;len
)paren
suffix:semicolon
)brace
r_else
(brace
id|yp-&gt;tx_ring
(braket
id|entry
op_plus
l_int|1
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_TX_PKT
op_or
id|BRANCH_IFTRUE
op_or
id|skb-&gt;len
)paren
suffix:semicolon
)brace
id|yp-&gt;cur_tx
op_increment
suffix:semicolon
macro_line|#else
id|yp-&gt;tx_ring
(braket
id|entry
op_lshift
l_int|1
)braket
dot
id|request_cnt
op_assign
id|skb-&gt;len
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|entry
op_lshift
l_int|1
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|yp-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
)paren
suffix:semicolon
multiline_comment|/* The input_last (status-write) command is constant, but we must &n;&t;   rewrite the subsequent &squot;stop&squot; command. */
id|yp-&gt;cur_tx
op_increment
suffix:semicolon
(brace
r_int
id|next_entry
op_assign
id|yp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|yp-&gt;tx_ring
(braket
id|next_entry
op_lshift
l_int|1
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
)brace
multiline_comment|/* Final step -- overwrite the old &squot;stop&squot; command. */
id|yp-&gt;tx_ring
(braket
id|entry
op_lshift
l_int|1
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
id|entry
op_mod
l_int|6
)paren
op_eq
l_int|0
ques
c_cond
id|CMD_TX_PKT
op_or
id|INTR_ALWAYS
op_or
id|BRANCH_IFTRUE
suffix:colon
id|CMD_TX_PKT
op_or
id|BRANCH_IFTRUE
)paren
op_or
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Non-x86 Todo: explicitly flush cache lines here. */
multiline_comment|/* Wake the potentially-idle transmit channel. */
id|outl
c_func
(paren
l_int|0x10001000
comma
id|dev-&gt;base_addr
op_plus
id|TxCtrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yp-&gt;cur_tx
op_minus
id|yp-&gt;dirty_tx
OL
id|TX_QUEUE_SIZE
)paren
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Typical path */
r_else
id|yp-&gt;tx_full
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Yellowfin transmit frame #%d queued in slot %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|yp-&gt;cur_tx
comma
id|entry
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|yellowfin_interrupt
r_static
r_void
id|yellowfin_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|yellowfin_private
op_star
id|yp
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_int
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
macro_line|#ifndef final_version&t;&t;&t;/* Can never occur. */
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;yellowfin_interrupt(): irq %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
(paren
op_amp
id|yp-&gt;lock
)paren
suffix:semicolon
r_do
(brace
id|u16
id|intr_status
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrClear
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Yellowfin interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrRxDone
op_or
id|IntrEarlyRx
)paren
)paren
(brace
id|yellowfin_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x10001000
comma
id|ioaddr
op_plus
id|RxCtrl
)paren
suffix:semicolon
multiline_comment|/* Wake Rx engine. */
)brace
macro_line|#ifdef NO_TXSTATS
r_for
c_loop
(paren
suffix:semicolon
id|yp-&gt;cur_tx
op_minus
id|yp-&gt;dirty_tx
OG
l_int|0
suffix:semicolon
id|yp-&gt;dirty_tx
op_increment
)paren
(brace
r_int
id|entry
op_assign
id|yp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|yp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|result_status
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|yp-&gt;tx_skbuff
(braket
id|entry
)braket
suffix:semicolon
id|yp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|yp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Free the original skb. */
id|pci_unmap_single
c_func
(paren
id|yp-&gt;pci_dev
comma
id|yp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|yp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|yp-&gt;tx_full
op_logical_and
id|yp-&gt;cur_tx
op_minus
id|yp-&gt;dirty_tx
OL
id|TX_QUEUE_SIZE
op_minus
l_int|4
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|yp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
(paren
id|intr_status
op_amp
id|IntrTxDone
)paren
op_logical_or
(paren
id|yp-&gt;tx_tail_desc-&gt;tx_errs
)paren
)paren
(brace
r_int
id|dirty_tx
op_assign
id|yp-&gt;dirty_tx
suffix:semicolon
r_for
c_loop
(paren
id|dirty_tx
op_assign
id|yp-&gt;dirty_tx
suffix:semicolon
id|yp-&gt;cur_tx
op_minus
id|dirty_tx
OG
l_int|0
suffix:semicolon
id|dirty_tx
op_increment
)paren
(brace
multiline_comment|/* Todo: optimize this. */
r_int
id|entry
op_assign
id|dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|u16
id|tx_errs
op_assign
id|yp-&gt;tx_status
(braket
id|entry
)braket
dot
id|tx_errs
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Tx queue %d check, Tx status &quot;
l_string|&quot;%4.4x %4.4x %4.4x %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|entry
comma
id|yp-&gt;tx_status
(braket
id|entry
)braket
dot
id|tx_cnt
comma
id|yp-&gt;tx_status
(braket
id|entry
)braket
dot
id|tx_errs
comma
id|yp-&gt;tx_status
(braket
id|entry
)braket
dot
id|total_tx_cnt
comma
id|yp-&gt;tx_status
(braket
id|entry
)braket
dot
id|paused
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tx_errs
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* It still hasn&squot;t been Txed */
id|skb
op_assign
id|yp-&gt;tx_skbuff
(braket
id|entry
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tx_errs
op_amp
l_int|0xF810
)paren
(brace
multiline_comment|/* There was an major error, log it. */
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit error, Tx status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_errs
)paren
suffix:semicolon
macro_line|#endif
id|yp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_errs
op_amp
l_int|0xF800
)paren
id|yp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_errs
op_amp
l_int|0x0800
)paren
id|yp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_errs
op_amp
l_int|0x2000
)paren
id|yp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_errs
op_amp
l_int|0x8000
)paren
id|yp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
id|tx_errs
op_amp
l_int|0x1000
)paren
id|yp-&gt;stats.collisions16
op_increment
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Normal transmit, Tx status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_errs
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ETHER_STATS
r_if
c_cond
(paren
id|tx_errs
op_amp
l_int|0x0400
)paren
id|yp-&gt;stats.tx_deferred
op_increment
suffix:semicolon
macro_line|#endif
id|yp-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|yp-&gt;stats.collisions
op_add_assign
id|tx_errs
op_amp
l_int|15
suffix:semicolon
id|yp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Free the original skb. */
id|pci_unmap_single
c_func
(paren
id|yp-&gt;pci_dev
comma
id|yp-&gt;tx_ring
(braket
id|entry
op_lshift
l_int|1
)braket
dot
id|addr
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|yp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Mark status as empty. */
id|yp-&gt;tx_status
(braket
id|entry
)braket
dot
id|tx_errs
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|yp-&gt;cur_tx
op_minus
id|dirty_tx
OG
id|TX_RING_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Out-of-sync dirty pointer, %d vs. %d, full=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dirty_tx
comma
id|yp-&gt;cur_tx
comma
id|yp-&gt;tx_full
)paren
suffix:semicolon
id|dirty_tx
op_add_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|yp-&gt;tx_full
op_logical_and
id|yp-&gt;cur_tx
op_minus
id|dirty_tx
OL
id|TX_QUEUE_SIZE
op_minus
l_int|2
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|yp-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|yp-&gt;dirty_tx
op_assign
id|dirty_tx
suffix:semicolon
id|yp-&gt;tx_tail_desc
op_assign
op_amp
id|yp-&gt;tx_status
(braket
id|dirty_tx
op_mod
id|TX_RING_SIZE
)braket
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Log errors and other uncommon events. */
r_if
c_cond
(paren
id|intr_status
op_amp
l_int|0x2ee
)paren
multiline_comment|/* Abnormal error summary. */
id|yellowfin_error
c_func
(paren
id|dev
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work at interrupt, &quot;
l_string|&quot;status=0x%4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt, status=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|yp-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* This routine is logically part of the interrupt handler, but separated&n;   for clarity and better register allocation. */
DECL|function|yellowfin_rx
r_static
r_int
id|yellowfin_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|yp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|boguscnt
op_assign
id|yp-&gt;dirty_rx
op_plus
id|RX_RING_SIZE
op_minus
id|yp-&gt;cur_rx
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; In yellowfin_rx(), entry %d status %8.8x.&bslash;n&quot;
comma
id|entry
comma
id|yp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|result_status
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;   #%d desc. %8.8x %8.8x %8.8x.&bslash;n&quot;
comma
id|entry
comma
id|yp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|dbdma_cmd
comma
id|yp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
comma
id|yp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|result_status
)paren
suffix:semicolon
)brace
multiline_comment|/* If EOP is set on the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_struct
id|yellowfin_desc
op_star
id|desc
op_assign
op_amp
id|yp-&gt;rx_ring
(braket
id|entry
)braket
suffix:semicolon
r_struct
id|sk_buff
op_star
id|rx_skb
op_assign
id|yp-&gt;rx_skbuff
(braket
id|entry
)braket
suffix:semicolon
id|s16
id|frame_status
suffix:semicolon
id|u16
id|desc_status
suffix:semicolon
r_int
id|data_size
suffix:semicolon
id|u8
op_star
id|buf_addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|desc-&gt;result_status
)paren
(brace
r_break
suffix:semicolon
)brace
id|pci_dma_sync_single
c_func
(paren
id|yp-&gt;pci_dev
comma
id|desc-&gt;addr
comma
id|yp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|desc_status
op_assign
id|le32_to_cpu
c_func
(paren
id|desc-&gt;result_status
)paren
op_rshift
l_int|16
suffix:semicolon
id|buf_addr
op_assign
id|rx_skb-&gt;tail
suffix:semicolon
id|data_size
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|desc-&gt;dbdma_cmd
)paren
op_minus
id|le32_to_cpu
c_func
(paren
id|desc-&gt;result_status
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|frame_status
op_assign
id|le16_to_cpu
c_func
(paren
id|get_unaligned
c_func
(paren
(paren
id|s16
op_star
)paren
op_amp
(paren
id|buf_addr
(braket
id|data_size
op_minus
l_int|2
)braket
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  yellowfin_rx() status was %4.4x.&bslash;n&quot;
comma
id|frame_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|desc_status
op_amp
id|RX_EOP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Oversized Ethernet frame spanned multiple buffers,&quot;
l_string|&quot; status %4.4x!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|desc_status
)paren
suffix:semicolon
id|yp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|yp-&gt;drv_flags
op_amp
id|IsGigabit
)paren
op_logical_and
(paren
id|frame_status
op_amp
l_int|0x0038
)paren
)paren
(brace
multiline_comment|/* There was a error. */
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  yellowfin_rx() Rx error was %4.4x.&bslash;n&quot;
comma
id|frame_status
)paren
suffix:semicolon
id|yp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x0060
)paren
id|yp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x0008
)paren
id|yp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x0010
)paren
id|yp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
OL
l_int|0
)paren
id|yp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|yp-&gt;drv_flags
op_amp
id|IsGigabit
)paren
op_logical_and
(paren
(paren
id|buf_addr
(braket
id|data_size
op_minus
l_int|1
)braket
op_amp
l_int|0x85
)paren
op_logical_or
id|buf_addr
(braket
id|data_size
op_minus
l_int|2
)braket
op_amp
l_int|0xC0
)paren
)paren
(brace
id|u8
id|status1
op_assign
id|buf_addr
(braket
id|data_size
op_minus
l_int|2
)braket
suffix:semicolon
id|u8
id|status2
op_assign
id|buf_addr
(braket
id|data_size
op_minus
l_int|1
)braket
suffix:semicolon
id|yp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status1
op_amp
l_int|0xC0
)paren
id|yp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
l_int|0x03
)paren
id|yp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
l_int|0x04
)paren
id|yp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status2
op_amp
l_int|0x80
)paren
id|yp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
macro_line|#ifdef YF_PROTOTYPE&t;&t;/* Support for prototype hardware errata. */
)brace
r_else
r_if
c_cond
(paren
(paren
id|yp-&gt;flags
op_amp
id|HasMACAddrBug
)paren
op_logical_and
id|memcmp
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|yp-&gt;rx_ring_dma
op_plus
id|entry
op_star
r_sizeof
(paren
r_struct
id|yellowfin_desc
)paren
)paren
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
op_ne
l_int|0
op_logical_and
id|memcmp
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|yp-&gt;rx_ring_dma
op_plus
id|entry
op_star
r_sizeof
(paren
r_struct
id|yellowfin_desc
)paren
)paren
comma
l_string|&quot;&bslash;377&bslash;377&bslash;377&bslash;377&bslash;377&bslash;377&quot;
comma
l_int|6
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|bogus_rx
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Bad frame to %2.2x:%2.2x:%2.2x:%2.2x:&quot;
l_string|&quot;%2.2x:%2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|buf_addr
(braket
l_int|0
)braket
comma
id|buf_addr
(braket
l_int|1
)braket
comma
id|buf_addr
(braket
l_int|2
)braket
comma
id|buf_addr
(braket
l_int|3
)braket
comma
id|buf_addr
(braket
l_int|4
)braket
comma
id|buf_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_len
op_assign
id|data_size
op_minus
(paren
id|yp-&gt;chip_id
ques
c_cond
l_int|7
suffix:colon
l_int|8
op_plus
id|buf_addr
(braket
id|data_size
op_minus
l_int|8
)braket
)paren
suffix:semicolon
multiline_comment|/* To verify: Yellowfin Length should omit the CRC! */
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  yellowfin_rx() normal Rx pkt length %d&quot;
l_string|&quot; of %d, bogus_cnt %d.&bslash;n&quot;
comma
id|pkt_len
comma
id|data_size
comma
id|boguscnt
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check if the packet is long enough to just pass up the skbuff&n;&t;&t;&t;   without copying to a properly sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OG
id|rx_copybreak
)paren
(brace
id|skb_put
c_func
(paren
id|skb
op_assign
id|rx_skb
comma
id|pkt_len
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|yp-&gt;pci_dev
comma
id|yp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
comma
id|yp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|yp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the IP header */
macro_line|#if HAS_IP_COPYSUM
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|rx_skb-&gt;tail
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#else
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|rx_skb-&gt;tail
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#endif
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|yp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|yp-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
)brace
id|entry
op_assign
(paren
op_increment
id|yp-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
)brace
multiline_comment|/* Refill the Rx ring buffers. */
r_for
c_loop
(paren
suffix:semicolon
id|yp-&gt;cur_rx
op_minus
id|yp-&gt;dirty_rx
OG
l_int|0
suffix:semicolon
id|yp-&gt;dirty_rx
op_increment
)paren
(brace
id|entry
op_assign
id|yp-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|yp-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|yp-&gt;rx_buf_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Better luck next round. */
id|yp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
id|yp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|yp-&gt;pci_dev
comma
id|skb-&gt;tail
comma
id|yp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
)brace
id|yp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
id|yp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|result_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear complete bit. */
r_if
c_cond
(paren
id|entry
op_ne
l_int|0
)paren
id|yp-&gt;rx_ring
(braket
id|entry
op_minus
l_int|1
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_RX_BUF
op_or
id|INTR_ALWAYS
op_or
id|yp-&gt;rx_buf_sz
)paren
suffix:semicolon
r_else
id|yp-&gt;rx_ring
(braket
id|RX_RING_SIZE
op_minus
l_int|1
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_RX_BUF
op_or
id|INTR_ALWAYS
op_or
id|BRANCH_ALWAYS
op_or
id|yp-&gt;rx_buf_sz
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yellowfin_error
r_static
r_void
id|yellowfin_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Something Wicked happened! %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
multiline_comment|/* Hmmmmm, it&squot;s not clear what to do here. */
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrTxPCIErr
op_or
id|IntrTxPCIFault
)paren
)paren
id|yp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrRxPCIErr
op_or
id|IntrRxPCIFault
)paren
)paren
id|yp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
DECL|function|yellowfin_close
r_static
r_int
id|yellowfin_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard, status was Tx %4.4x &quot;
l_string|&quot;Rx %4.4x Int %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
comma
id|inw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Queue pointers were Tx %d / %d,  Rx %d / %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|yp-&gt;cur_tx
comma
id|yp-&gt;dirty_tx
comma
id|yp-&gt;cur_rx
comma
id|yp-&gt;dirty_rx
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|IntrEnb
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|outl
c_func
(paren
l_int|0x80000000
comma
id|ioaddr
op_plus
id|RxCtrl
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x80000000
comma
id|ioaddr
op_plus
id|TxCtrl
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|yp-&gt;timer
)paren
suffix:semicolon
macro_line|#if defined(__i386__)
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;  Tx ring at %8.8x:&bslash;n&quot;
comma
id|yp-&gt;tx_ring_dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
op_star
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %c #%d desc. %8.8x %8.8x %8.8x %8.8x.&bslash;n&quot;
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|TxPtr
)paren
op_eq
(paren
r_int
)paren
op_amp
id|yp-&gt;tx_ring
(braket
id|i
)braket
ques
c_cond
l_char|&squot;&gt;&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|i
comma
id|yp-&gt;tx_ring
(braket
id|i
)braket
dot
id|dbdma_cmd
comma
id|yp-&gt;tx_ring
(braket
id|i
)braket
dot
id|addr
comma
id|yp-&gt;tx_ring
(braket
id|i
)braket
dot
id|branch_addr
comma
id|yp-&gt;tx_ring
(braket
id|i
)braket
dot
id|result_status
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  Tx status %p:&bslash;n&quot;
comma
id|yp-&gt;tx_status
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;   #%d status %4.4x %4.4x %4.4x %4.4x.&bslash;n&quot;
comma
id|i
comma
id|yp-&gt;tx_status
(braket
id|i
)braket
dot
id|tx_cnt
comma
id|yp-&gt;tx_status
(braket
id|i
)braket
dot
id|tx_errs
comma
id|yp-&gt;tx_status
(braket
id|i
)braket
dot
id|total_tx_cnt
comma
id|yp-&gt;tx_status
(braket
id|i
)braket
dot
id|paused
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;  Rx ring %8.8x:&bslash;n&quot;
comma
id|yp-&gt;rx_ring_dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; %c #%d desc. %8.8x %8.8x %8.8x&bslash;n&quot;
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
id|RxPtr
)paren
op_eq
(paren
r_int
)paren
op_amp
id|yp-&gt;rx_ring
(braket
id|i
)braket
ques
c_cond
l_char|&squot;&gt;&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|i
comma
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|dbdma_cmd
comma
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
comma
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|result_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|6
)paren
(brace
r_if
c_cond
(paren
id|get_unaligned
c_func
(paren
(paren
id|u8
op_star
)paren
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
)paren
op_ne
l_int|0x69
)paren
(brace
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|0x50
suffix:semicolon
id|j
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %4.4x&quot;
comma
id|get_unaligned
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
)paren
op_plus
id|j
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif /* __i386__ debugging only */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Free all the skbuffs in the Rx queue. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|dbdma_cmd
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
id|yp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
l_int|0xBADF00D0
suffix:semicolon
multiline_comment|/* An invalid address. */
r_if
c_cond
(paren
id|yp-&gt;rx_skbuff
(braket
id|i
)braket
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|yp-&gt;rx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|yp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|yp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
id|dev_kfree_skb
c_func
(paren
id|yp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|yp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef YF_PROTOTYPE&t;&t;&t;/* Support for prototype hardware errata. */
r_if
c_cond
(paren
id|yellowfin_debug
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Received %d frames that we should not have.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|bogus_rx
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yellowfin_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|yellowfin_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|yp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor. */
multiline_comment|/* The little-endian AUTODIN32 ethernet CRC calculation.&n;   N.B. Do not use for bulk data, use a table-based routine instead.&n;   This is common code and should be moved to net/core/crc.c */
DECL|variable|ethernet_polynomial_le
r_static
r_int
r_const
id|ethernet_polynomial_le
op_assign
l_int|0xedb88320U
suffix:semicolon
DECL|function|ether_crc_le
r_static
r_inline
r_int
id|ether_crc_le
c_func
(paren
r_int
id|length
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
r_int
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* Initial value. */
r_while
c_loop
(paren
op_decrement
id|length
op_ge
l_int|0
)paren
(brace
r_int
r_char
id|current_octet
op_assign
op_star
id|data
op_increment
suffix:semicolon
r_int
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|8
suffix:semicolon
op_decrement
id|bit
op_ge
l_int|0
suffix:semicolon
id|current_octet
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|crc
op_xor
id|current_octet
)paren
op_amp
l_int|1
)paren
(brace
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
id|crc
op_xor_assign
id|ethernet_polynomial_le
suffix:semicolon
)brace
r_else
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|crc
suffix:semicolon
)brace
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|yp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u16
id|cfg_value
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
id|Cnfg
)paren
suffix:semicolon
multiline_comment|/* Stop the Rx process to change any value. */
id|outw
c_func
(paren
id|cfg_value
op_amp
op_complement
l_int|0x1000
comma
id|ioaddr
op_plus
id|Cnfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x000F
comma
id|ioaddr
op_plus
id|AddrMode
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
l_int|64
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to filter well, or accept all multicasts. */
id|outw
c_func
(paren
l_int|0x000B
comma
id|ioaddr
op_plus
id|AddrMode
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
OG
l_int|0
)paren
(brace
multiline_comment|/* Must use the multicast hash table. */
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|u16
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|hash_table
comma
l_int|0
comma
r_sizeof
(paren
id|hash_table
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
multiline_comment|/* Due to a bug in the early chip versions, multiple filter&n;&t;&t;&t;   slots must be set for each address. */
r_if
c_cond
(paren
id|yp-&gt;drv_flags
op_amp
id|HasMulticastBug
)paren
(brace
id|set_bit
c_func
(paren
(paren
id|ether_crc_le
c_func
(paren
l_int|3
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x3f
comma
id|hash_table
)paren
suffix:semicolon
id|set_bit
c_func
(paren
(paren
id|ether_crc_le
c_func
(paren
l_int|4
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x3f
comma
id|hash_table
)paren
suffix:semicolon
id|set_bit
c_func
(paren
(paren
id|ether_crc_le
c_func
(paren
l_int|5
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x3f
comma
id|hash_table
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
(paren
id|ether_crc_le
c_func
(paren
l_int|6
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x3f
comma
id|hash_table
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy the hash table to the chip. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|outw
c_func
(paren
id|hash_table
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|HashTbl
op_plus
id|i
op_star
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0003
comma
id|ioaddr
op_plus
id|AddrMode
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal, unicast/broadcast-only mode. */
id|outw
c_func
(paren
l_int|0x0001
comma
id|ioaddr
op_plus
id|AddrMode
)paren
suffix:semicolon
)brace
multiline_comment|/* Restart the Rx process. */
id|outw
c_func
(paren
id|cfg_value
op_or
l_int|0x1000
comma
id|ioaddr
op_plus
id|Cnfg
)paren
suffix:semicolon
)brace
DECL|function|netdev_ethtool_ioctl
r_static
r_int
id|netdev_ethtool_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|useraddr
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|ethcmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ethcmd
comma
id|useraddr
comma
r_sizeof
(paren
id|ethcmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|ethcmd
)paren
(brace
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
r_struct
id|ethtool_drvinfo
id|info
op_assign
(brace
id|ETHTOOL_GDRVINFO
)brace
suffix:semicolon
id|strcpy
c_func
(paren
id|info.driver
comma
id|DRV_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info.version
comma
id|DRV_VERSION
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info.bus_info
comma
id|np-&gt;pci_dev-&gt;slot_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|netdev_ioctl
r_static
r_int
id|netdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|yellowfin_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|mii_ioctl_data
op_star
id|data
op_assign
(paren
r_struct
id|mii_ioctl_data
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
r_return
id|netdev_ethtool_ioctl
c_func
(paren
id|dev
comma
(paren
r_void
op_star
)paren
id|rq-&gt;ifr_data
)paren
suffix:semicolon
r_case
id|SIOCGMIIPHY
suffix:colon
multiline_comment|/* Get address of MII PHY in use. */
r_case
id|SIOCDEVPRIVATE
suffix:colon
multiline_comment|/* for binary compat, remove in 2.5 */
id|data-&gt;phy_id
op_assign
id|np-&gt;phys
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
multiline_comment|/* Fall Through */
r_case
id|SIOCGMIIREG
suffix:colon
multiline_comment|/* Read MII PHY register. */
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
multiline_comment|/* for binary compat, remove in 2.5 */
id|data-&gt;val_out
op_assign
id|mdio_read
c_func
(paren
id|ioaddr
comma
id|data-&gt;phy_id
op_amp
l_int|0x1f
comma
id|data-&gt;reg_num
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCSMIIREG
suffix:colon
multiline_comment|/* Write MII PHY register. */
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
multiline_comment|/* for binary compat, remove in 2.5 */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;phy_id
op_eq
id|np-&gt;phys
(braket
l_int|0
)braket
)paren
(brace
id|u16
id|value
op_assign
id|data-&gt;val_in
suffix:semicolon
r_switch
c_cond
(paren
id|data-&gt;reg_num
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Check for autonegotiation on or reset. */
id|np-&gt;medialock
op_assign
(paren
id|value
op_amp
l_int|0x9000
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;medialock
)paren
id|np-&gt;full_duplex
op_assign
(paren
id|value
op_amp
l_int|0x0100
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|np-&gt;advertising
op_assign
id|value
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Perhaps check_duplex(dev), depending on chip semantics. */
)brace
id|mdio_write
c_func
(paren
id|ioaddr
comma
id|data-&gt;phy_id
op_amp
l_int|0x1f
comma
id|data-&gt;reg_num
op_amp
l_int|0x1f
comma
id|data-&gt;val_in
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|yellowfin_remove_one
r_static
r_void
id|__devexit
id|yellowfin_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|yellowfin_private
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|STATUS_TOTAL_SIZE
comma
id|np-&gt;tx_status
comma
id|np-&gt;tx_status_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
id|np-&gt;rx_ring
comma
id|np-&gt;rx_ring_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
id|np-&gt;tx_ring
comma
id|np-&gt;tx_ring_dma
)paren
suffix:semicolon
id|unregister_netdev
(paren
id|dev
)paren
suffix:semicolon
id|pci_release_regions
(paren
id|pdev
)paren
suffix:semicolon
macro_line|#ifndef USE_IO_OPS
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
macro_line|#endif
id|kfree
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|yellowfin_driver
r_static
r_struct
id|pci_driver
id|yellowfin_driver
op_assign
(brace
id|name
suffix:colon
id|DRV_NAME
comma
id|id_table
suffix:colon
id|yellowfin_pci_tbl
comma
id|probe
suffix:colon
id|yellowfin_init_one
comma
id|remove
suffix:colon
id|yellowfin_remove_one
comma
)brace
suffix:semicolon
DECL|function|yellowfin_init
r_static
r_int
id|__init
id|yellowfin_init
(paren
r_void
)paren
(brace
multiline_comment|/* when a module, this is printed whether or not devices are found in probe */
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
(paren
op_amp
id|yellowfin_driver
)paren
suffix:semicolon
)brace
DECL|function|yellowfin_cleanup
r_static
r_void
id|__exit
id|yellowfin_cleanup
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|yellowfin_driver
)paren
suffix:semicolon
)brace
DECL|variable|yellowfin_init
id|module_init
c_func
(paren
id|yellowfin_init
)paren
suffix:semicolon
DECL|variable|yellowfin_cleanup
id|module_exit
c_func
(paren
id|yellowfin_cleanup
)paren
suffix:semicolon
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  compile-command: &quot;gcc -DMODULE -Wall -Wstrict-prototypes -O6 -c yellowfin.c&quot;&n; *  compile-command-alphaLX: &quot;gcc -DMODULE -Wall -Wstrict-prototypes -O2 -c yellowfin.c -fomit-frame-pointer -fno-strength-reduce -mno-fp-regs -Wa,-m21164a -DBWX_USABLE -DBWIO_ENABLED&quot;&n; *  simple-compile-command: &quot;gcc -DMODULE -O6 -c yellowfin.c&quot;&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; * End:&n; */
eof
