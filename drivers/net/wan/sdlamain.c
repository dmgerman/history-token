multiline_comment|/****************************************************************************&n;* sdlamain.c&t;WANPIPE(tm) Multiprotocol WAN Link Driver.  Main module.&n;*&n;* Author:&t;Nenad Corbic&t;&lt;ncorbic@sangoma.com&gt;&n;*&t;&t;Gideon Hack&t;&n;*&n;* Copyright:&t;(c) 1995-2000 Sangoma Technologies Inc.&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;* Dec 22, 2000  Nenad Corbic&t;Updated for 2.4.X kernels.&n;* &t;&t;&t;&t;Removed the polling routine.&n;* Nov 13, 2000  Nenad Corbic&t;Added hw probing on module load and dynamic&n;* &t;&t;&t;&t;device allocation. &n;* Nov 7,  2000  Nenad Corbic&t;Fixed the Multi-Port PPP for kernels&n;*                               2.2.16 and above.&n;* Aug 2,  2000  Nenad Corbic&t;Block the Multi-Port PPP from running on&n;*  &t;&t;&t;        kernels 2.2.16 or greater.  The SyncPPP &n;*  &t;&t;&t;        has changed.&n;* Jul 25, 2000  Nenad Corbic&t;Updated the Piggiback support for MultPPPP.&n;* Jul 13, 2000&t;Nenad Corbic&t;Added Multi-PPP support.&n;* Feb 02, 2000  Nenad Corbic    Fixed up piggyback probing and selection.&n;* Sep 23, 1999  Nenad Corbic    Added support for SMP&n;* Sep 13, 1999  Nenad Corbic&t;Each port is treated as a separate device.&n;* Jun 02, 1999  Gideon Hack     Added support for the S514 adapter.&n;*&t;&t;&t;&t;Updates for Linux 2.2.X kernels.&n;* Sep 17, 1998&t;Jaspreet Singh&t;Updated for 2.1.121+ kernel&n;* Nov 28, 1997&t;Jaspreet Singh&t;Changed DRV_RELEASE to 1&n;* Nov 10, 1997&t;Jaspreet Singh&t;Changed sti() to restore_flags();&n;* Nov 06, 1997 &t;Jaspreet Singh&t;Changed DRV_VERSION to 4 and DRV_RELEASE to 0&n;* Oct 20, 1997 &t;Jaspreet Singh&t;Modified sdla_isr routine so that card-&gt;in_isr&n;*&t;&t;&t;&t;assignments are taken out and placed in the&n;*&t;&t;&t;&t;sdla_ppp.c, sdla_fr.c and sdla_x25.c isr&n;*&t;&t;&t;&t;routines. Took out &squot;wandev-&gt;tx_int_enabled&squot; and&n;*&t;&t;&t;&t;replaced it with &squot;wandev-&gt;enable_tx_int&squot;. &n;* May 29, 1997&t;Jaspreet Singh&t;Flow Control Problem&n;*&t;&t;&t;&t;added &quot;wandev-&gt;tx_int_enabled=1&quot; line in the&n;*&t;&t;&t;&t;init module. This line intializes the flag for &n;*&t;&t;&t;&t;preventing Interrupt disabled with device set to&n;*&t;&t;&t;&t;busy&n;* Jan 15, 1997&t;Gene Kozin&t;Version 3.1.0&n;*&t;&t;&t;&t; o added UDP management stuff&n;* Jan 02, 1997&t;Gene Kozin&t;Initial version.&n;*****************************************************************************/
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/config.h&gt;&t;/* OS configuration options */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/slab.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/module.h&gt;&t;/* support for loadable modules */
macro_line|#include &lt;linux/ioport.h&gt;&t;/* request_region(), release_region() */
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;linux/wanpipe.h&gt;&t;/* WANPIPE common user API definitions */
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;asm/io.h&gt;&t;&t;/* phys_to_virt() */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/sdlapci.h&gt;
macro_line|#include &lt;linux/if_wanpipe_common.h&gt;
macro_line|#if defined(LINUX_2_4)
macro_line|#include &lt;asm/uaccess.h&gt;&t;/* kernel &lt;-&gt; user copy */
macro_line|#include &lt;linux/inetdevice.h&gt;
DECL|macro|netdevice_t
mdefine_line|#define netdevice_t struct net_device 
macro_line|#elif defined(LINUX_2_1)
macro_line|#include &lt;asm/uaccess.h&gt;&t;/* kernel &lt;-&gt; user copy */
macro_line|#include &lt;linux/inetdevice.h&gt;
DECL|macro|netdevice_t
mdefine_line|#define netdevice_t struct device 
macro_line|#else
macro_line|#include &lt;asm/segment.h&gt;
DECL|macro|devinet_ioctl
mdefine_line|#define devinet_ioctl(x,y) dev_ioctl(x,y)
DECL|macro|netdevice_t
mdefine_line|#define netdevice_t struct device 
DECL|macro|test_and_set_bit
mdefine_line|#define test_and_set_bit set_bit
DECL|typedef|mm_segment_t
r_typedef
r_int
r_int
id|mm_segment_t
suffix:semicolon
macro_line|#endif
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/route.h&gt;
DECL|macro|KMEM_SAFETYZONE
mdefine_line|#define KMEM_SAFETYZONE 8
macro_line|#ifndef CONFIG_WANPIPE_FR
DECL|macro|wpf_init
mdefine_line|#define wpf_init(a,b) (-EPROTONOSUPPORT) 
macro_line|#endif
macro_line|#ifndef CONFIG_WANPIPE_CHDLC
DECL|macro|wpc_init
mdefine_line|#define wpc_init(a,b) (-EPROTONOSUPPORT) 
macro_line|#endif
macro_line|#ifndef CONFIG_WANPIPE_X25
DECL|macro|wpx_init
mdefine_line|#define wpx_init(a,b) (-EPROTONOSUPPORT) 
macro_line|#endif
macro_line|#ifndef CONFIG_WANPIPE_PPP
DECL|macro|wpp_init
mdefine_line|#define wpp_init(a,b) (-EPROTONOSUPPORT) 
macro_line|#endif
macro_line|#ifndef CONFIG_WANPIPE_MULTPPP 
DECL|macro|wsppp_init
mdefine_line|#define wsppp_init(a,b) (-EPROTONOSUPPORT) 
macro_line|#endif
multiline_comment|/***********FOR DEBUGGING PURPOSES*********************************************&n;static void * dbg_kmalloc(unsigned int size, int prio, int line) {&n;&t;int i = 0;&n;&t;void * v = kmalloc(size+sizeof(unsigned int)+2*KMEM_SAFETYZONE*8,prio);&n;&t;char * c1 = v;&t;&n;&t;c1 += sizeof(unsigned int);&n;&t;*((unsigned int *)v) = size;&n;&n;&t;for (i = 0; i &lt; KMEM_SAFETYZONE; i++) {&n;&t;&t;c1[0] = &squot;D&squot;; c1[1] = &squot;E&squot;; c1[2] = &squot;A&squot;; c1[3] = &squot;D&squot;;&n;&t;&t;c1[4] = &squot;B&squot;; c1[5] = &squot;E&squot;; c1[6] = &squot;E&squot;; c1[7] = &squot;F&squot;;&n;&t;&t;c1 += 8;&n;&t;}&n;&t;c1 += size;&n;&t;for (i = 0; i &lt; KMEM_SAFETYZONE; i++) {&n;&t;&t;c1[0] = &squot;M&squot;; c1[1] = &squot;U&squot;; c1[2] = &squot;N&squot;; c1[3] = &squot;G&squot;;&n;&t;&t;c1[4] = &squot;W&squot;; c1[5] = &squot;A&squot;; c1[6] = &squot;L&squot;; c1[7] = &squot;L&squot;;&n;&t;&t;c1 += 8;&n;&t;}&n;&t;v = ((char *)v) + sizeof(unsigned int) + KMEM_SAFETYZONE*8;&n;&t;printk(KERN_INFO &quot;line %d  kmalloc(%d,%d) = %p&bslash;n&quot;,line,size,prio,v);&n;&t;return v;&n;}&n;static void dbg_kfree(void * v, int line) {&n;&t;unsigned int * sp = (unsigned int *)(((char *)v) - (sizeof(unsigned int) + KMEM_SAFETYZONE*8));&n;&t;unsigned int size = *sp;&n;&t;char * c1 = ((char *)v) - KMEM_SAFETYZONE*8;&n;&t;int i = 0;&n;&t;for (i = 0; i &lt; KMEM_SAFETYZONE; i++) {&n;&t;&t;if (   c1[0] != &squot;D&squot; || c1[1] != &squot;E&squot; || c1[2] != &squot;A&squot; || c1[3] != &squot;D&squot;&n;&t;&t;    || c1[4] != &squot;B&squot; || c1[5] != &squot;E&squot; || c1[6] != &squot;E&squot; || c1[7] != &squot;F&squot;) {&n;&t;&t;&t;printk(KERN_INFO &quot;kmalloced block at %p has been corrupted (underrun)!&bslash;n&quot;,v);&n;&t;&t;&t;printk(KERN_INFO &quot; %4x: %2x %2x %2x %2x %2x %2x %2x %2x&bslash;n&quot;, i*8,&n;&t;&t;&t;                c1[0],c1[1],c1[2],c1[3],c1[4],c1[5],c1[6],c1[7] );&n;&t;&t;}&n;&t;&t;c1 += 8;&n;&t;}&n;&t;c1 += size;&n;&t;for (i = 0; i &lt; KMEM_SAFETYZONE; i++) {&n;&t;&t;if (   c1[0] != &squot;M&squot; || c1[1] != &squot;U&squot; || c1[2] != &squot;N&squot; || c1[3] != &squot;G&squot;&n;&t;&t;    || c1[4] != &squot;W&squot; || c1[5] != &squot;A&squot; || c1[6] != &squot;L&squot; || c1[7] != &squot;L&squot;&n;&t;&t;   ) {&n;&t;&t;&t;printk(KERN_INFO &quot;kmalloced block at %p has been corrupted (overrun):&bslash;n&quot;,v);&n;&t;&t;&t;printk(KERN_INFO &quot; %4x: %2x %2x %2x %2x %2x %2x %2x %2x&bslash;n&quot;, i*8,&n;&t;&t;&t;                c1[0],c1[1],c1[2],c1[3],c1[4],c1[5],c1[6],c1[7] );&n;&t;&t;}&n;&t;&t;c1 += 8;&n;&t;}&n;&t;printk(KERN_INFO &quot;line %d  kfree(%p)&bslash;n&quot;,line,v);&n;&t;v = ((char *)v) - (sizeof(unsigned int) + KMEM_SAFETYZONE*8);&n;&t;kfree(v);&n;}&n;&n;#define kmalloc(x,y) dbg_kmalloc(x,y,__LINE__)&n;#define kfree(x) dbg_kfree(x,__LINE__)&n;******************************************************************************/
multiline_comment|/****** Defines &amp; Macros ****************************************************/
macro_line|#ifdef&t;_DEBUG_
DECL|macro|STATIC
mdefine_line|#define&t;STATIC
macro_line|#else
DECL|macro|STATIC
mdefine_line|#define&t;STATIC&t;&t;static
macro_line|#endif
DECL|macro|DRV_VERSION
mdefine_line|#define&t;DRV_VERSION&t;5&t;&t;/* version number */
DECL|macro|DRV_RELEASE
mdefine_line|#define&t;DRV_RELEASE&t;0&t;&t;/* release (minor version) number */
DECL|macro|MAX_CARDS
mdefine_line|#define&t;MAX_CARDS&t;16&t;&t;/* max number of adapters */
macro_line|#ifndef&t;CONFIG_WANPIPE_CARDS&t;&t;/* configurable option */
DECL|macro|CONFIG_WANPIPE_CARDS
mdefine_line|#define&t;CONFIG_WANPIPE_CARDS 1
macro_line|#endif
DECL|macro|CMD_OK
mdefine_line|#define&t;CMD_OK&t;&t;0&t;&t;/* normal firmware return code */
DECL|macro|CMD_TIMEOUT
mdefine_line|#define&t;CMD_TIMEOUT&t;0xFF&t;&t;/* firmware command timed out */
DECL|macro|MAX_CMD_RETRY
mdefine_line|#define&t;MAX_CMD_RETRY&t;10&t;&t;/* max number of firmware retries */
multiline_comment|/****** Function Prototypes *************************************************/
r_extern
r_void
id|disable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|enable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* Module entry points */
r_int
id|init_module
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* WAN link driver entry points */
r_static
r_int
id|setup
(paren
id|wan_device_t
op_star
id|wandev
comma
id|wandev_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|shutdown
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
r_static
r_int
id|ioctl
(paren
id|wan_device_t
op_star
id|wandev
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
multiline_comment|/* IOCTL handlers */
r_static
r_int
id|ioctl_dump
(paren
id|sdla_t
op_star
id|card
comma
id|sdla_dump_t
op_star
id|u_dump
)paren
suffix:semicolon
r_static
r_int
id|ioctl_exec
(paren
id|sdla_t
op_star
id|card
comma
id|sdla_exec_t
op_star
id|u_exec
comma
r_int
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous functions */
id|STATIC
r_void
id|sdla_isr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|release_hw
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|run_wanpipe_tq
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|check_s508_conflicts
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
comma
r_int
op_star
)paren
suffix:semicolon
r_static
r_int
id|check_s514_conflicts
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
comma
r_int
op_star
)paren
suffix:semicolon
multiline_comment|/****** Global Data **********************************************************&n; * Note: All data must be explicitly initialized!!!&n; */
multiline_comment|/* private data */
DECL|variable|drvname
r_static
r_char
id|drvname
(braket
)braket
op_assign
l_string|&quot;wanpipe&quot;
suffix:semicolon
DECL|variable|fullname
r_static
r_char
id|fullname
(braket
)braket
op_assign
l_string|&quot;WANPIPE(tm) Multiprotocol Driver&quot;
suffix:semicolon
DECL|variable|copyright
r_static
r_char
id|copyright
(braket
)braket
op_assign
l_string|&quot;(c) 1995-2000 Sangoma Technologies Inc.&quot;
suffix:semicolon
DECL|variable|ncards
r_static
r_int
id|ncards
op_assign
l_int|0
suffix:semicolon
DECL|variable|card_array
r_static
id|sdla_t
op_star
id|card_array
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* adapter data space */
multiline_comment|/* Wanpipe&squot;s own task queue, used for all API&squot;s.&n; * All protocol specific tasks will be instered&n; * into &quot;wanpipe_tq_custom&quot; task_queue. &n;&n; * On each rx_interrupt, the whole task queue&n; * (wanpipe_tq_custom) will be queued into &n; * IMMEDIATE_BH via wanpipe_mark_bh() call. &n; &n; * The IMMEDIATE_BH will execute run_wanpipe_tq() &n; * function, which will execute all pending,&n; * tasks in wanpipe_tq_custom queue */
macro_line|#ifdef LINUX_2_4
DECL|variable|wanpipe_tq_custom
id|DECLARE_TASK_QUEUE
c_func
(paren
id|wanpipe_tq_custom
)paren
suffix:semicolon
DECL|variable|wanpipe_tq_task
r_static
r_struct
id|tq_struct
id|wanpipe_tq_task
op_assign
(brace
dot
id|routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|run_wanpipe_tq
comma
dot
id|data
op_assign
op_amp
id|wanpipe_tq_custom
)brace
suffix:semicolon
macro_line|#else
DECL|variable|wanpipe_tq_custom
r_static
r_struct
id|tq_struct
op_star
id|wanpipe_tq_custom
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|wanpipe_tq_task
r_static
r_struct
id|tq_struct
id|wanpipe_tq_task
op_assign
(brace
l_int|NULL
comma
l_int|0
comma
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|run_wanpipe_tq
comma
op_amp
id|wanpipe_tq_custom
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|wanpipe_bh_critical
r_static
r_int
id|wanpipe_bh_critical
op_assign
l_int|0
suffix:semicolon
multiline_comment|/******* Kernel Loadable Module Entry Points ********************************/
multiline_comment|/*============================================================================&n; * Module &squot;insert&squot; entry point.&n; * o print announcement&n; * o allocate adapter data space&n; * o initialize static data&n; * o register all cards with WAN router&n; * o calibrate SDLA shared memory access delay.&n; *&n; * Return:&t;0&t;Ok&n; *&t;&t;&lt; 0&t;error.&n; * Context:&t;process&n; */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
(paren
r_void
)paren
macro_line|#else
r_int
id|wanpipe_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_int
id|cnt
comma
id|err
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s v%u.%u %s&bslash;n&quot;
comma
id|fullname
comma
id|DRV_VERSION
comma
id|DRV_RELEASE
comma
id|copyright
)paren
suffix:semicolon
multiline_comment|/* Probe for wanpipe cards and return the number found */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;wanpipe: Probing for WANPIPE hardware.&bslash;n&quot;
)paren
suffix:semicolon
id|ncards
op_assign
id|wanpipe_hw_probe
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncards
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;wanpipe: Allocating maximum %i devices: wanpipe%i - wanpipe%i.&bslash;n&quot;
comma
id|ncards
comma
l_int|1
comma
id|ncards
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;wanpipe: No S514/S508 cards found, unloading modules!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Verify number of cards and allocate adapter data space */
id|card_array
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|sdla_t
)paren
op_star
id|ncards
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card_array
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|card_array
comma
l_int|0
comma
r_sizeof
(paren
id|sdla_t
)paren
op_star
id|ncards
)paren
suffix:semicolon
multiline_comment|/* Register adapters with WAN router */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|ncards
suffix:semicolon
op_increment
id|cnt
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
op_amp
id|card_array
(braket
id|cnt
)braket
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
id|card-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;devname
comma
l_string|&quot;%s%d&quot;
comma
id|drvname
comma
id|cnt
op_plus
l_int|1
)paren
suffix:semicolon
id|wandev-&gt;magic
op_assign
id|ROUTER_MAGIC
suffix:semicolon
id|wandev-&gt;name
op_assign
id|card-&gt;devname
suffix:semicolon
id|wandev
op_member_access_from_pointer
r_private
op_assign
id|card
suffix:semicolon
id|wandev-&gt;enable_tx_int
op_assign
l_int|0
suffix:semicolon
id|wandev-&gt;setup
op_assign
op_amp
id|setup
suffix:semicolon
id|wandev-&gt;shutdown
op_assign
op_amp
id|shutdown
suffix:semicolon
id|wandev-&gt;ioctl
op_assign
op_amp
id|ioctl
suffix:semicolon
id|err
op_assign
id|register_wan_device
c_func
(paren
id|wandev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s registration failed with error %d!&bslash;n&quot;
comma
id|drvname
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cnt
)paren
(brace
id|ncards
op_assign
id|cnt
suffix:semicolon
multiline_comment|/* adjust actual number of cards */
)brace
r_else
(brace
id|kfree
c_func
(paren
id|card_array
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IN Init Module: NO Cards registered&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/*============================================================================&n; * Module &squot;remove&squot; entry point.&n; * o unregister all adapters from the WAN router&n; * o release all remaining system resources&n; */
DECL|function|cleanup_module
r_void
id|cleanup_module
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ncards
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncards
suffix:semicolon
op_increment
id|i
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
op_amp
id|card_array
(braket
id|i
)braket
suffix:semicolon
id|unregister_wan_device
c_func
(paren
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|card_array
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;nwanpipe: WANPIPE Modules Unloaded.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/******* WAN Device Driver Entry Points *************************************/
multiline_comment|/*============================================================================&n; * Setup/configure WAN link driver.&n; * o check adapter state&n; * o make sure firmware is present in configuration&n; * o make sure I/O port and IRQ are specified&n; * o make sure I/O region is available&n; * o allocate interrupt vector&n; * o setup SDLA hardware&n; * o call appropriate routine to perform protocol-specific initialization&n; * o mark I/O region as used&n; * o if this is the first active card, then schedule background task&n; *&n; * This function is called when router handles ROUTER_SETUP IOCTL. The&n; * configuration structure is in kernel memory (including extended data, if&n; * any).&n; */
DECL|function|setup
r_static
r_int
id|setup
(paren
id|wan_device_t
op_star
id|wandev
comma
id|wandev_conf_t
op_star
id|conf
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|conf
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed Sdlamain Setup wandev %u, card %u, conf %u !&bslash;n&quot;
comma
id|wandev-&gt;name
comma
(paren
r_int
r_int
)paren
id|wandev
comma
(paren
r_int
r_int
)paren
id|wandev
op_member_access_from_pointer
r_private
comma
(paren
r_int
r_int
)paren
id|conf
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Starting WAN Setup&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_ne
id|WAN_UNCONFIGURED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: failed sdlamain setup, busy!&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* already configured */
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;nProcessing WAN device %s...&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Initialize the counters for each wandev &n;&t; * Used for counting number of times new_if and &n;         * del_if get called.&n;&t; */
id|wandev-&gt;del_if_cnt
op_assign
l_int|0
suffix:semicolon
id|wandev-&gt;new_if_cnt
op_assign
l_int|0
suffix:semicolon
id|wandev-&gt;config_id
op_assign
id|conf-&gt;config_id
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;data_size
op_logical_or
(paren
id|conf-&gt;data
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: firmware not found in configuration data!&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Check for resource conflicts and setup the&n;&t; * card for piggibacking if necessary */
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;S514_CPU_no
(braket
l_int|0
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|check_s508_conflicts
c_func
(paren
id|card
comma
id|conf
comma
op_amp
id|irq
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|check_s514_conflicts
c_func
(paren
id|card
comma
id|conf
comma
op_amp
id|irq
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
multiline_comment|/* If the current card has already been configured&n;         * or its a piggyback card, do not try to allocate&n;         * resources.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;wandev.piggyback
op_logical_and
op_logical_neg
id|card-&gt;configured
)paren
(brace
multiline_comment|/* Configure hardware, load firmware, etc. */
id|memset
c_func
(paren
op_amp
id|card-&gt;hw
comma
l_int|0
comma
r_sizeof
(paren
id|sdlahw_t
)paren
)paren
suffix:semicolon
multiline_comment|/* for an S514 adapter, pass the CPU number and the slot number read */
multiline_comment|/* from &squot;router.conf&squot; to the &squot;sdla_setup()&squot; function via the &squot;port&squot; */
multiline_comment|/* parameter */
r_if
c_cond
(paren
id|conf-&gt;S514_CPU_no
(braket
l_int|0
)braket
)paren
(brace
id|card-&gt;hw.S514_cpu_no
(braket
l_int|0
)braket
op_assign
id|conf-&gt;S514_CPU_no
(braket
l_int|0
)braket
suffix:semicolon
id|card-&gt;hw.S514_slot_no
op_assign
id|conf-&gt;PCI_slot_no
suffix:semicolon
id|card-&gt;hw.auto_pci_cfg
op_assign
id|conf-&gt;auto_pci_cfg
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.auto_pci_cfg
op_eq
id|WANOPT_YES
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting CPU to %c and Slot to Auto&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;hw.S514_cpu_no
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting CPU to %c and Slot to %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;hw.S514_cpu_no
(braket
l_int|0
)braket
comma
id|card-&gt;hw.S514_slot_no
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* 508 Card io port and irq initialization */
id|card-&gt;hw.port
op_assign
id|conf-&gt;ioport
suffix:semicolon
id|card-&gt;hw.irq
op_assign
(paren
id|conf-&gt;irq
op_eq
l_int|9
)paren
ques
c_cond
l_int|2
suffix:colon
id|conf-&gt;irq
suffix:semicolon
)brace
multiline_comment|/* Compute the virtual address of the card in kernel space */
r_if
c_cond
(paren
id|conf-&gt;maddr
)paren
(brace
id|card-&gt;hw.dpmbase
op_assign
id|phys_to_virt
c_func
(paren
id|conf-&gt;maddr
)paren
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;hw.dpmbase
op_assign
(paren
r_void
op_star
)paren
id|conf-&gt;maddr
suffix:semicolon
)brace
id|card-&gt;hw.dpmsize
op_assign
id|SDLA_WINDOWSIZE
suffix:semicolon
multiline_comment|/* set the adapter type if using an S514 adapter */
id|card-&gt;hw.type
op_assign
(paren
id|conf-&gt;S514_CPU_no
(braket
l_int|0
)braket
)paren
ques
c_cond
id|SDLA_S514
suffix:colon
id|conf-&gt;hw_opt
(braket
l_int|0
)braket
suffix:semicolon
id|card-&gt;hw.pclk
op_assign
id|conf-&gt;hw_opt
(braket
l_int|1
)braket
suffix:semicolon
id|err
op_assign
id|sdla_setup
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|conf-&gt;data
comma
id|conf-&gt;data_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Hardware setup Failed %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|irq
op_assign
(paren
id|conf-&gt;irq
op_eq
l_int|2
)paren
ques
c_cond
l_int|9
suffix:colon
id|conf-&gt;irq
suffix:semicolon
)brace
multiline_comment|/* IRQ2 -&gt; IRQ9 */
r_else
id|irq
op_assign
id|card-&gt;hw.irq
suffix:semicolon
multiline_comment|/* request an interrupt vector - note that interrupts may be shared */
multiline_comment|/* when using the S514 PCI adapter */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sdla_isr
comma
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
ques
c_cond
id|SA_SHIRQ
suffix:colon
l_int|0
comma
id|wandev-&gt;name
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Can&squot;t reserve IRQ %d!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|irq
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Card Configured %i or Piggybacking %i!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|card-&gt;configured
comma
id|card-&gt;wandev.piggyback
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;configured
)paren
(brace
multiline_comment|/* Initialize the Spin lock */
macro_line|#if defined(__SMP__) || defined(LINUX_2_4) 
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Initializing for SMP&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Piggyback spin lock has already been initialized,&n;&t;&t; * in check_s514/s508_conflicts() */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;wandev.piggyback
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;wandev.lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Intialize WAN device data space */
id|wandev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|wandev-&gt;dma
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|wandev-&gt;ioport
op_assign
id|card-&gt;hw.port
suffix:semicolon
)brace
r_else
(brace
id|wandev-&gt;S514_cpu_no
(braket
l_int|0
)braket
op_assign
id|card-&gt;hw.S514_cpu_no
(braket
l_int|0
)braket
suffix:semicolon
id|wandev-&gt;S514_slot_no
op_assign
id|card-&gt;hw.S514_slot_no
suffix:semicolon
)brace
id|wandev-&gt;maddr
op_assign
(paren
r_int
r_int
)paren
id|card-&gt;hw.dpmbase
suffix:semicolon
id|wandev-&gt;msize
op_assign
id|card-&gt;hw.dpmsize
suffix:semicolon
id|wandev-&gt;hw_opt
(braket
l_int|0
)braket
op_assign
id|card-&gt;hw.type
suffix:semicolon
id|wandev-&gt;hw_opt
(braket
l_int|1
)braket
op_assign
id|card-&gt;hw.pclk
suffix:semicolon
id|wandev-&gt;hw_opt
(braket
l_int|2
)braket
op_assign
id|card-&gt;hw.memory
suffix:semicolon
id|wandev-&gt;hw_opt
(braket
l_int|3
)braket
op_assign
id|card-&gt;hw.fwid
suffix:semicolon
)brace
multiline_comment|/* Protocol-specific initialization */
r_switch
c_cond
(paren
id|card-&gt;hw.fwid
)paren
(brace
r_case
id|SFID_X25_502
suffix:colon
r_case
id|SFID_X25_508
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Starting X.25 Protocol Init.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
id|wpx_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SFID_FR502
suffix:colon
r_case
id|SFID_FR508
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Starting Frame Relay Protocol Init.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
id|wpf_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SFID_PPP502
suffix:colon
r_case
id|SFID_PPP508
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Starting PPP Protocol Init.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
id|wpp_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SFID_CHDLC508
suffix:colon
r_case
id|SFID_CHDLC514
suffix:colon
r_if
c_cond
(paren
id|conf-&gt;ft1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Starting FT1 CSU/DSU Config Driver.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
id|wpft1_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|conf-&gt;config_id
op_eq
id|WANCONFIG_MPPP
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Starting Multi-Port PPP Protocol Init.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
id|wsppp_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Starting CHDLC Protocol Init.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
id|wpc_init
c_func
(paren
id|card
comma
id|conf
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error, Firmware is not supported %X %X!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|card-&gt;hw.fwid
comma
id|SFID_CHDLC508
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EPROTONOSUPPORT
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error, Protocol selected has not been compiled!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:        Re-configure the kernel and re-build the modules!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|release_hw
c_func
(paren
id|card
)paren
suffix:semicolon
id|wandev-&gt;state
op_assign
id|WAN_UNCONFIGURED
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Reserve I/O region and schedule background task */
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
op_logical_and
op_logical_neg
id|card-&gt;wandev.piggyback
)paren
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|card-&gt;hw.port
comma
id|card-&gt;hw.io_range
comma
id|wandev-&gt;name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;port 0x%04x busy&bslash;n&quot;
comma
id|card-&gt;hw.port
)paren
suffix:semicolon
id|release_hw
c_func
(paren
id|card
)paren
suffix:semicolon
id|wandev-&gt;state
op_assign
id|WAN_UNCONFIGURED
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Only use the polling routine for the X25 protocol */
id|card-&gt;wandev.critical
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*================================================================== &n; * configure_s508_card&n; * &n; * For a S508 adapter, check for a possible configuration error in that&n; * we are loading an adapter in the same IO port as a previously loaded S508&n; * card.&n; */
DECL|function|check_s508_conflicts
r_static
r_int
id|check_s508_conflicts
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
comma
r_int
op_star
id|irq
)paren
(brace
r_int
r_int
id|smp_flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;ioport
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: can&squot;t configure without I/O port address!&bslash;n&quot;
comma
id|card-&gt;wandev.name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;irq
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: can&squot;t configure without IRQ!&bslash;n&quot;
comma
id|card-&gt;wandev.name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|card-&gt;configured
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Check for already loaded card with the same IO port and IRQ &n;&t; * If found, copy its hardware configuration and use its&n;&t; * resources (i.e. piggybacking)&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sdla_t
op_star
id|nxt_card
op_assign
op_amp
id|card_array
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Skip the current card ptr */
r_if
c_cond
(paren
id|nxt_card
op_eq
id|card
)paren
r_continue
suffix:semicolon
multiline_comment|/* Find a card that is already configured with the&n;&t;&t; * same IO Port */
r_if
c_cond
(paren
(paren
id|nxt_card-&gt;hw.type
op_eq
id|SDLA_S508
)paren
op_logical_and
(paren
id|nxt_card-&gt;hw.port
op_eq
id|conf-&gt;ioport
)paren
op_logical_and
(paren
id|nxt_card-&gt;next
op_eq
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* We found a card the card that has same configuration&n;&t;&t;&t; * as us. This means, that we must setup this card in &n;&t;&t;&t; * piggibacking mode. However, only CHDLC and MPPP protocol&n;&t;&t;&t; * support this setup */
r_if
c_cond
(paren
(paren
id|conf-&gt;config_id
op_eq
id|WANCONFIG_CHDLC
op_logical_or
id|conf-&gt;config_id
op_eq
id|WANCONFIG_MPPP
)paren
op_logical_and
(paren
id|nxt_card-&gt;wandev.config_id
op_eq
id|WANCONFIG_CHDLC
op_logical_or
id|nxt_card-&gt;wandev.config_id
op_eq
id|WANCONFIG_MPPP
)paren
)paren
(brace
op_star
id|irq
op_assign
id|nxt_card-&gt;hw.irq
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|card-&gt;hw
comma
op_amp
id|nxt_card-&gt;hw
comma
r_sizeof
(paren
id|sdlahw_t
)paren
)paren
suffix:semicolon
multiline_comment|/* The master could already be running, we must&n;&t;&t;&t;&t; * set this as a critical area */
id|lock_adapter_irq
c_func
(paren
op_amp
id|nxt_card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|nxt_card-&gt;next
op_assign
id|card
suffix:semicolon
id|card-&gt;next
op_assign
id|nxt_card
suffix:semicolon
id|card-&gt;wandev.piggyback
op_assign
id|WANOPT_YES
suffix:semicolon
multiline_comment|/* We must initialise the piggiback spin lock here&n;&t;&t;&t;&t; * since isr will try to lock card-&gt;next if it&n;&t;&t;&t;&t; * exists */
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;wandev.lock
)paren
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|nxt_card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Trying to run piggibacking with a wrong protocol */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR: Resource busy, ioport: 0x%x&bslash;n&quot;
l_string|&quot;%s:        This protocol doesn&squot;t support&bslash;n&quot;
l_string|&quot;%s:        multi-port operation!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|nxt_card-&gt;hw.port
comma
id|card-&gt;devname
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Make sure I/O port region is available only if we are the&n;&t; * master device.  If we are running in piggibacking mode, &n;&t; * we will use the resources of the master card */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|conf-&gt;ioport
comma
id|SDLA_MAXIORANGE
)paren
op_logical_and
op_logical_neg
id|card-&gt;wandev.piggyback
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: I/O region 0x%X - 0x%X is in use!&bslash;n&quot;
comma
id|card-&gt;wandev.name
comma
id|conf-&gt;ioport
comma
id|conf-&gt;ioport
op_plus
id|SDLA_MAXIORANGE
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*================================================================== &n; * configure_s514_card&n; * &n; * For a S514 adapter, check for a possible configuration error in that&n; * we are loading an adapter in the same slot as a previously loaded S514&n; * card.&n; */
DECL|function|check_s514_conflicts
r_static
r_int
id|check_s514_conflicts
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
comma
r_int
op_star
id|irq
)paren
(brace
r_int
r_int
id|smp_flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|card-&gt;configured
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Check for already loaded card with the same IO port and IRQ &n;&t; * If found, copy its hardware configuration and use its&n;&t; * resources (i.e. piggybacking)&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sdla_t
op_star
id|nxt_card
op_assign
op_amp
id|card_array
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nxt_card
op_eq
id|card
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|nxt_card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
op_logical_and
(paren
id|nxt_card-&gt;hw.S514_slot_no
op_eq
id|conf-&gt;PCI_slot_no
)paren
op_logical_and
(paren
id|nxt_card-&gt;hw.S514_cpu_no
(braket
l_int|0
)braket
op_eq
id|conf-&gt;S514_CPU_no
(braket
l_int|0
)braket
)paren
op_logical_and
(paren
id|nxt_card-&gt;next
op_eq
l_int|NULL
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|conf-&gt;config_id
op_eq
id|WANCONFIG_CHDLC
op_logical_or
id|conf-&gt;config_id
op_eq
id|WANCONFIG_MPPP
)paren
op_logical_and
(paren
id|nxt_card-&gt;wandev.config_id
op_eq
id|WANCONFIG_CHDLC
op_logical_or
id|nxt_card-&gt;wandev.config_id
op_eq
id|WANCONFIG_MPPP
)paren
)paren
(brace
op_star
id|irq
op_assign
id|nxt_card-&gt;hw.irq
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|card-&gt;hw
comma
op_amp
id|nxt_card-&gt;hw
comma
r_sizeof
(paren
id|sdlahw_t
)paren
)paren
suffix:semicolon
multiline_comment|/* The master could already be running, we must&n;&t;&t;&t;&t; * set this as a critical area */
id|lock_adapter_irq
c_func
(paren
op_amp
id|nxt_card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|nxt_card-&gt;next
op_assign
id|card
suffix:semicolon
id|card-&gt;next
op_assign
id|nxt_card
suffix:semicolon
id|card-&gt;wandev.piggyback
op_assign
id|WANOPT_YES
suffix:semicolon
multiline_comment|/* We must initialise the piggiback spin lock here&n;&t;&t;&t;&t; * since isr will try to lock card-&gt;next if it&n;&t;&t;&t;&t; * exists */
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;wandev.lock
)paren
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|nxt_card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Trying to run piggibacking with a wrong protocol */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR: Resource busy: CPU %c PCISLOT %i&bslash;n&quot;
l_string|&quot;%s:        This protocol doesn&squot;t support&bslash;n&quot;
l_string|&quot;%s:        multi-port operation!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;S514_CPU_no
(braket
l_int|0
)braket
comma
id|conf-&gt;PCI_slot_no
comma
id|card-&gt;devname
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Shut down WAN link driver. &n; * o shut down adapter hardware&n; * o release system resources.&n; *&n; * This function is called by the router when device is being unregistered or&n; * when it handles ROUTER_DOWN IOCTL.&n; */
DECL|function|shutdown
r_static
r_int
id|shutdown
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;tty_open
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Shutdown Failed: TTY is still open&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
id|wandev-&gt;state
op_assign
id|WAN_UNCONFIGURED
suffix:semicolon
id|set_bit
c_func
(paren
id|PERI_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
suffix:semicolon
multiline_comment|/* In case of piggibacking, make sure that &n;         * we never try to shutdown both devices at the same&n;         * time, because they depend on one another */
r_if
c_cond
(paren
id|card-&gt;disable_comm
)paren
(brace
id|card
op_member_access_from_pointer
id|disable_comm
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* Release Resources */
id|release_hw
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* only free the allocated I/O range if not an S514 adapter */
r_if
c_cond
(paren
id|wandev-&gt;hw_opt
(braket
l_int|0
)braket
op_ne
id|SDLA_S514
op_logical_and
op_logical_neg
id|card-&gt;configured
)paren
(brace
id|release_region
c_func
(paren
id|card-&gt;hw.port
comma
id|card-&gt;hw.io_range
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;configured
)paren
(brace
id|memset
c_func
(paren
op_amp
id|card-&gt;hw
comma
l_int|0
comma
r_sizeof
(paren
id|sdlahw_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
id|memset
c_func
(paren
op_amp
id|card-&gt;next-&gt;hw
comma
l_int|0
comma
r_sizeof
(paren
id|sdlahw_t
)paren
)paren
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
id|PERI_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|release_hw
r_static
r_void
id|release_hw
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|sdla_t
op_star
id|nxt_card
suffix:semicolon
multiline_comment|/* Check if next device exists */
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
id|nxt_card
op_assign
id|card-&gt;next
suffix:semicolon
multiline_comment|/* If next device is down then release resources */
r_if
c_cond
(paren
id|nxt_card-&gt;wandev.state
op_eq
id|WAN_UNCONFIGURED
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.piggyback
)paren
(brace
multiline_comment|/* If this device is piggyback then use&n;                                 * information of the master device &n;&t;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Piggyback shutting down&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|sdla_down
c_func
(paren
op_amp
id|card-&gt;next-&gt;hw
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;wandev.irq
comma
id|card-&gt;next
)paren
suffix:semicolon
id|card-&gt;configured
op_assign
l_int|0
suffix:semicolon
id|card-&gt;next-&gt;configured
op_assign
l_int|0
suffix:semicolon
id|card-&gt;wandev.piggyback
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Master device shutting down */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Master shutting down&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|sdla_down
c_func
(paren
op_amp
id|card-&gt;hw
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;wandev.irq
comma
id|card
)paren
suffix:semicolon
id|card-&gt;configured
op_assign
l_int|0
suffix:semicolon
id|card-&gt;next-&gt;configured
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Device still running %i&bslash;n&quot;
comma
id|nxt_card-&gt;devname
comma
id|nxt_card-&gt;wandev.state
)paren
suffix:semicolon
id|card-&gt;configured
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Master shutting down&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|sdla_down
c_func
(paren
op_amp
id|card-&gt;hw
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;wandev.irq
comma
id|card
)paren
suffix:semicolon
id|card-&gt;configured
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Driver I/O control. &n; * o verify arguments&n; * o perform requested action&n; *&n; * This function is called when router handles one of the reserved user&n; * IOCTLs.  Note that &squot;arg&squot; stil points to user address space.&n; */
DECL|function|ioctl
r_static
r_int
id|ioctl
(paren
id|wan_device_t
op_star
id|wandev
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|disable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|wandev-&gt;critical
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|WANPIPE_DUMP
suffix:colon
id|err
op_assign
id|ioctl_dump
c_func
(paren
id|wandev
op_member_access_from_pointer
r_private
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WANPIPE_EXEC
suffix:colon
id|err
op_assign
id|ioctl_exec
c_func
(paren
id|wandev
op_member_access_from_pointer
r_private
comma
(paren
r_void
op_star
)paren
id|arg
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/****** Driver IOCTL Handlers ***********************************************/
multiline_comment|/*============================================================================&n; * Dump adapter memory to user buffer.&n; * o verify request structure&n; * o copy request structure to kernel data space&n; * o verify length/offset&n; * o verify user buffer&n; * o copy adapter memory image to user buffer&n; *&n; * Note: when dumping memory, this routine switches curent dual-port memory&n; *&t; vector, so care must be taken to avoid racing conditions.&n; */
DECL|function|ioctl_dump
r_static
r_int
id|ioctl_dump
(paren
id|sdla_t
op_star
id|card
comma
id|sdla_dump_t
op_star
id|u_dump
)paren
(brace
id|sdla_dump_t
id|dump
suffix:semicolon
r_int
id|winsize
suffix:semicolon
r_int
r_int
id|oldvec
suffix:semicolon
multiline_comment|/* DPM window vector */
r_int
r_int
id|smp_flags
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|dump
comma
(paren
r_void
op_star
)paren
id|u_dump
comma
r_sizeof
(paren
id|sdla_dump_t
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
(paren
id|u_dump
op_eq
l_int|NULL
)paren
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|u_dump
comma
r_sizeof
(paren
id|sdla_dump_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|dump
comma
(paren
r_void
op_star
)paren
id|u_dump
comma
r_sizeof
(paren
id|sdla_dump_t
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|dump.magic
op_ne
id|WANPIPE_MAGIC
)paren
op_logical_or
(paren
id|dump.offset
op_plus
id|dump.length
OG
id|card-&gt;hw.memory
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef LINUX_2_0
r_if
c_cond
(paren
(paren
id|dump.ptr
op_eq
l_int|NULL
)paren
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|dump.ptr
comma
id|dump.length
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#endif&t;
id|winsize
op_assign
id|card-&gt;hw.dpmsize
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|lock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|oldvec
op_assign
id|card-&gt;hw.vector
suffix:semicolon
r_while
c_loop
(paren
id|dump.length
)paren
(brace
multiline_comment|/* current offset */
r_int
id|pos
op_assign
id|dump.offset
op_mod
id|winsize
suffix:semicolon
multiline_comment|/* current vector */
r_int
r_int
id|vec
op_assign
id|dump.offset
op_minus
id|pos
suffix:semicolon
r_int
id|len
op_assign
(paren
id|dump.length
OG
(paren
id|winsize
op_minus
id|pos
)paren
)paren
ques
c_cond
(paren
id|winsize
op_minus
id|pos
)paren
suffix:colon
id|dump.length
suffix:semicolon
multiline_comment|/* relocate window */
r_if
c_cond
(paren
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|vec
)paren
op_ne
l_int|0
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|dump.ptr
comma
(paren
id|u8
op_star
)paren
id|card-&gt;hw.dpmbase
op_plus
id|pos
comma
id|len
)paren
)paren
(brace
id|unlock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
macro_line|#else
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|dump.ptr
)paren
comma
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|pos
)paren
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|dump.length
op_sub_assign
id|len
suffix:semicolon
id|dump.offset
op_add_assign
id|len
suffix:semicolon
(paren
r_char
op_star
)paren
id|dump.ptr
op_add_assign
id|len
suffix:semicolon
)brace
id|sdla_mapmem
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|oldvec
)paren
suffix:semicolon
multiline_comment|/* restore DPM window position */
id|unlock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4) 
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|dump.ptr
comma
(paren
id|u8
op_star
)paren
id|card-&gt;hw.dpmbase
op_plus
id|dump.offset
comma
id|dump.length
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
macro_line|#else
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|dump.ptr
)paren
comma
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|dump.offset
)paren
comma
id|dump.length
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Execute adapter firmware command.&n; * o verify request structure&n; * o copy request structure to kernel data space&n; * o call protocol-specific &squot;exec&squot; function&n; */
DECL|function|ioctl_exec
r_static
r_int
id|ioctl_exec
(paren
id|sdla_t
op_star
id|card
comma
id|sdla_exec_t
op_star
id|u_exec
comma
r_int
id|cmd
)paren
(brace
id|sdla_exec_t
id|exec
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;exec
op_eq
l_int|NULL
op_logical_and
id|cmd
op_eq
id|WANPIPE_EXEC
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)&t;
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|exec
comma
(paren
r_void
op_star
)paren
id|u_exec
comma
r_sizeof
(paren
id|sdla_exec_t
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
(paren
id|u_exec
op_eq
l_int|NULL
)paren
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|u_exec
comma
r_sizeof
(paren
id|sdla_exec_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|exec
comma
(paren
r_void
op_star
)paren
id|u_exec
comma
r_sizeof
(paren
id|sdla_exec_t
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|exec.magic
op_ne
id|WANPIPE_MAGIC
)paren
op_logical_or
(paren
id|exec.cmd
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|WANPIPE_EXEC
suffix:colon
id|err
op_assign
id|card
op_member_access_from_pointer
id|exec
c_func
(paren
id|card
comma
id|exec.cmd
comma
id|exec.data
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/******* Miscellaneous ******************************************************/
multiline_comment|/*============================================================================&n; * SDLA Interrupt Service Routine.&n; * o acknowledge SDLA hardware interrupt.&n; * o call protocol-specific interrupt service routine, if any.&n; */
DECL|function|sdla_isr
id|STATIC
r_void
id|sdla_isr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
DECL|macro|card
mdefine_line|#define&t;card&t;((sdla_t*)dev_id)
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
multiline_comment|/* handle interrrupt on S514 */
id|u32
id|int_status
suffix:semicolon
r_int
r_char
id|CPU_no
op_assign
id|card-&gt;hw.S514_cpu_no
(braket
l_int|0
)braket
suffix:semicolon
r_int
r_char
id|card_found_for_IRQ
suffix:semicolon
id|u8
id|IRQ_count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|read_S514_int_stat
c_func
(paren
op_amp
id|card-&gt;hw
comma
op_amp
id|int_status
)paren
suffix:semicolon
multiline_comment|/* check if the interrupt is for this device */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
r_int
r_char
)paren
id|int_status
op_amp
(paren
id|IRQ_CPU_A
op_or
id|IRQ_CPU_B
)paren
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* if the IRQ is for both CPUs on the same adapter, */
multiline_comment|/* then alter the interrupt status so as to handle */
multiline_comment|/* one CPU at a time */
r_if
c_cond
(paren
(paren
(paren
r_int
r_char
)paren
id|int_status
op_amp
(paren
id|IRQ_CPU_A
op_or
id|IRQ_CPU_B
)paren
)paren
op_eq
(paren
id|IRQ_CPU_A
op_or
id|IRQ_CPU_B
)paren
)paren
(brace
id|int_status
op_and_assign
(paren
id|CPU_no
op_eq
id|S514_CPU_A
)paren
ques
c_cond
op_complement
id|IRQ_CPU_B
suffix:colon
op_complement
id|IRQ_CPU_A
suffix:semicolon
)brace
id|card_found_for_IRQ
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check to see that the CPU number for this device */
multiline_comment|/* corresponds to the interrupt status read */
r_switch
c_cond
(paren
id|CPU_no
)paren
(brace
r_case
id|S514_CPU_A
suffix:colon
r_if
c_cond
(paren
(paren
r_int
r_char
)paren
id|int_status
op_amp
id|IRQ_CPU_A
)paren
(brace
id|card_found_for_IRQ
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|S514_CPU_B
suffix:colon
r_if
c_cond
(paren
(paren
r_int
r_char
)paren
id|int_status
op_amp
id|IRQ_CPU_B
)paren
(brace
id|card_found_for_IRQ
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* exit if the interrupt is for another CPU on the */
multiline_comment|/* same IRQ */
r_if
c_cond
(paren
op_logical_neg
id|card_found_for_IRQ
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
(paren
id|card-&gt;wandev.state
op_eq
id|WAN_UNCONFIGURED
op_logical_and
op_logical_neg
id|card-&gt;configured
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Received IRQ %d for CPU #%c&bslash;n&quot;
comma
id|irq
comma
id|CPU_no
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IRQ for unconfigured adapter&bslash;n&quot;
)paren
suffix:semicolon
id|S514_intack
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|int_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;in_isr
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interrupt re-entrancy on IRQ %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.irq
)paren
suffix:semicolon
id|S514_intack
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|int_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;wandev.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;next-&gt;wandev.lock
)paren
suffix:semicolon
)brace
id|S514_intack
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|int_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;isr
)paren
id|card
op_member_access_from_pointer
id|isr
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;next-&gt;wandev.lock
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;wandev.lock
)paren
suffix:semicolon
multiline_comment|/* handle a maximum of two interrupts (one for each */
multiline_comment|/* CPU on the adapter) before returning */
r_if
c_cond
(paren
(paren
op_increment
id|IRQ_count
)paren
op_eq
l_int|2
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* handle interrupt on S508 adapter */
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
(paren
(paren
id|card-&gt;wandev.state
op_eq
id|WAN_UNCONFIGURED
)paren
op_logical_and
op_logical_neg
id|card-&gt;configured
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;in_isr
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interrupt re-entrancy on IRQ %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;wandev.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;next-&gt;wandev.lock
)paren
suffix:semicolon
)brace
id|sdla_intack
c_func
(paren
op_amp
id|card-&gt;hw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;isr
)paren
id|card
op_member_access_from_pointer
id|isr
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;next-&gt;wandev.lock
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;wandev.lock
)paren
suffix:semicolon
)brace
DECL|macro|card
macro_line|#undef&t;card
)brace
multiline_comment|/*============================================================================&n; * This routine is called by the protocol-specific modules when network&n; * interface is being open.  The only reason we need this, is because we&n; * have to call MOD_INC_USE_COUNT, but cannot include &squot;module.h&squot; where it&squot;s&n; * defined more than once into the same kernel module.&n; */
DECL|function|wanpipe_open
r_void
id|wanpipe_open
(paren
id|sdla_t
op_star
id|card
)paren
(brace
op_increment
id|card-&gt;open_cnt
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * This routine is called by the protocol-specific modules when network&n; * interface is being closed.  The only reason we need this, is because we&n; * have to call MOD_DEC_USE_COUNT, but cannot include &squot;module.h&squot; where it&squot;s&n; * defined more than once into the same kernel module.&n; */
DECL|function|wanpipe_close
r_void
id|wanpipe_close
(paren
id|sdla_t
op_star
id|card
)paren
(brace
op_decrement
id|card-&gt;open_cnt
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set WAN device state.&n; */
DECL|function|wanpipe_set_state
r_void
id|wanpipe_set_state
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|state
)paren
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: link connected!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: link connecting...&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: link disconnected!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;wandev.state
op_assign
id|state
suffix:semicolon
)brace
id|card-&gt;state_tick
op_assign
id|jiffies
suffix:semicolon
)brace
DECL|function|wanpipe_find_card
id|sdla_t
op_star
id|wanpipe_find_card
(paren
r_char
op_star
id|name
)paren
(brace
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|ncards
suffix:semicolon
op_increment
id|cnt
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
op_amp
id|card_array
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|card-&gt;devname
comma
id|name
)paren
)paren
r_return
id|card
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|wanpipe_find_card_num
id|sdla_t
op_star
id|wanpipe_find_card_num
(paren
r_int
id|num
)paren
(brace
r_if
c_cond
(paren
id|num
template_param
id|ncards
)paren
r_return
l_int|NULL
suffix:semicolon
id|num
op_decrement
suffix:semicolon
r_return
op_amp
id|card_array
(braket
id|num
)braket
suffix:semicolon
)brace
DECL|function|run_wanpipe_tq
r_static
r_void
id|run_wanpipe_tq
(paren
r_int
r_int
id|data
)paren
(brace
id|task_queue
op_star
id|tq_queue
op_assign
(paren
id|task_queue
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|2
comma
(paren
r_void
op_star
)paren
op_amp
id|wanpipe_bh_critical
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CRITICAL IN RUNNING TASK QUEUE&bslash;n&quot;
)paren
suffix:semicolon
id|run_task_queue
(paren
id|tq_queue
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|2
comma
(paren
r_void
op_star
)paren
op_amp
id|wanpipe_bh_critical
)paren
suffix:semicolon
)brace
DECL|function|wanpipe_queue_tq
r_void
id|wanpipe_queue_tq
(paren
r_struct
id|tq_struct
op_star
id|bh_pointer
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|1
comma
(paren
r_void
op_star
)paren
op_amp
id|wanpipe_bh_critical
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CRITICAL IN QUEUING TASK&bslash;n&quot;
)paren
suffix:semicolon
id|queue_task
c_func
(paren
id|bh_pointer
comma
op_amp
id|wanpipe_tq_custom
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|1
comma
(paren
r_void
op_star
)paren
op_amp
id|wanpipe_bh_critical
)paren
suffix:semicolon
)brace
DECL|function|wanpipe_mark_bh
r_void
id|wanpipe_mark_bh
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|wanpipe_bh_critical
)paren
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|wanpipe_tq_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|wanpipe_bh_critical
)paren
suffix:semicolon
)brace
)brace
DECL|function|wakeup_sk_bh
r_void
id|wakeup_sk_bh
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|wanpipe_common_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;common_critical
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;sk
op_logical_and
id|chan-&gt;tx_timer
)paren
(brace
id|chan-&gt;tx_timer-&gt;expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
id|chan-&gt;tx_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|change_dev_flags
r_int
id|change_dev_flags
(paren
id|netdevice_t
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|ifreq
id|if_info
suffix:semicolon
id|mm_segment_t
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|if_info
comma
l_int|0
comma
r_sizeof
(paren
id|if_info
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|if_info.ifr_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|if_info.ifr_flags
op_assign
id|flags
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* get user space block */
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFFLAGS
comma
op_amp
id|if_info
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|get_ip_address
r_int
r_int
id|get_ip_address
(paren
id|netdevice_t
op_star
id|dev
comma
r_int
id|option
)paren
(brace
macro_line|#ifdef LINUX_2_4
r_struct
id|in_ifaddr
op_star
id|ifaddr
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_dev
op_assign
id|__in_dev_get
c_func
(paren
id|dev
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#elif defined(LINUX_2_1)
r_struct
id|in_ifaddr
op_star
id|ifaddr
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_dev
op_assign
id|dev-&gt;ip_ptr
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_if
c_cond
(paren
(paren
id|ifaddr
op_assign
id|in_dev-&gt;ifa_list
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|option
)paren
(brace
r_case
id|WAN_LOCAL_IP
suffix:colon
macro_line|#ifdef LINUX_2_0
r_return
id|dev-&gt;pa_addr
suffix:semicolon
macro_line|#else&t;
r_return
id|ifaddr-&gt;ifa_local
suffix:semicolon
macro_line|#endif&t;
r_break
suffix:semicolon
r_case
id|WAN_POINTOPOINT_IP
suffix:colon
macro_line|#ifdef LINUX_2_0
r_return
id|dev-&gt;pa_dstaddr
suffix:semicolon
macro_line|#else&t;
r_return
id|ifaddr-&gt;ifa_address
suffix:semicolon
macro_line|#endif&t;
r_break
suffix:semicolon
r_case
id|WAN_NETMASK_IP
suffix:colon
macro_line|#ifdef LINUX_2_0
r_return
id|dev-&gt;pa_mask
suffix:semicolon
macro_line|#else&t;
r_return
id|ifaddr-&gt;ifa_mask
suffix:semicolon
macro_line|#endif&t;
r_break
suffix:semicolon
r_case
id|WAN_BROADCAST_IP
suffix:colon
macro_line|#ifdef LINUX_2_0
r_return
id|dev-&gt;pa_brdaddr
suffix:semicolon
macro_line|#else&t;
r_return
id|ifaddr-&gt;ifa_broadcast
suffix:semicolon
macro_line|#endif&t;
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|add_gateway
r_void
id|add_gateway
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
)paren
(brace
id|mm_segment_t
id|oldfs
suffix:semicolon
r_struct
id|rtentry
id|route
suffix:semicolon
r_int
id|res
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|route
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rtentry
)paren
)paren
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_dst
)paren
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
op_assign
l_int|0
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_dst
)paren
)paren
op_member_access_from_pointer
id|sin_family
op_assign
id|AF_INET
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_genmask
)paren
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
op_assign
l_int|0
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_genmask
)paren
)paren
op_member_access_from_pointer
id|sin_family
op_assign
id|AF_INET
suffix:semicolon
id|route.rt_flags
op_assign
l_int|0
suffix:semicolon
id|route.rt_dev
op_assign
id|dev-&gt;name
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|res
op_assign
id|ip_rt_ioctl
c_func
(paren
id|SIOCADDRT
comma
op_amp
id|route
)paren
suffix:semicolon
macro_line|#else
id|res
op_assign
id|ip_rt_new
c_func
(paren
op_amp
id|route
)paren
suffix:semicolon
macro_line|#endif
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Gateway added for %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/****** End *********************************************************/
eof
