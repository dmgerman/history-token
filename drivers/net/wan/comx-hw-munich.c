multiline_comment|/*&n; * Hardware-level driver for the SliceCOM board for Linux kernels 2.4.X&n; *&n; * Current maintainer / latest changes: Pasztor Szilard &lt;don@itc.hu&gt;&n; *&n; * Original author: Bartok Istvan &lt;bartoki@itc.hu&gt;&n; * Based on skeleton by Tivadar Szemethy &lt;tiv@itc.hu&gt;&n; *&n; * 0.51:&n; *      - port for 2.4.x&n; *&t;- clean up some code, make it more portable&n; *&t;- busted direct hardware access through mapped memory&n; *&t;- fix a possible race&n; *&t;- prevent procfs buffer overflow&n; *&n; * 0.50:&n; *&t;- support for the pcicom board, lots of rearrangements&n; *&t;- handle modem status lines&n; *&n; * 0.50a:&n; *&t;- fix for falc version 1.0&n; *&n; * 0.50b: T&amp;t&n; *&t;- fix for bad localbus&n; */
DECL|macro|VERSION
mdefine_line|#define VERSION&t;&t;&quot;0.51&quot;
DECL|macro|VERSIONSTR
mdefine_line|#define VERSIONSTR&t;&quot;SliceCOM v&quot; VERSION &quot;, 2002/01/07&bslash;n&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|COMX_NEW
mdefine_line|#define COMX_NEW
macro_line|#ifndef COMX_NEW
macro_line|#include &quot;../include/comx.h&quot;
macro_line|#include &quot;../include/munich32x.h&quot;
macro_line|#include &quot;../include/falc-lh.h&quot;
macro_line|#else
macro_line|#include &quot;comx.h&quot;
macro_line|#include &quot;munich32x.h&quot;
macro_line|#include &quot;falc-lh.h&quot;
macro_line|#endif
id|MODULE_AUTHOR
(paren
l_string|&quot;Bartok Istvan &lt;bartoki@itc.hu&gt;, Gergely Madarasz &lt;gorgo@itc.hu&gt;, Szilard Pasztor &lt;don@itc.hu&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;Hardware-level driver for the SliceCOM and PciCOM (WelCOM) adapters&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;TODO: az ilyenek a comxhw.h -ban szoktak lenni, idovel menjenek majd oda:&n; */
DECL|macro|FILENAME_BOARDNUM
mdefine_line|#define FILENAME_BOARDNUM&t;&quot;boardnum&quot;&t;/* /proc/comx/comx0.1/boardnum          */
DECL|macro|FILENAME_TIMESLOTS
mdefine_line|#define FILENAME_TIMESLOTS&t;&quot;timeslots&quot;&t;/* /proc/comx/comx0.1/timeslots         */
DECL|macro|FILENAME_FRAMING
mdefine_line|#define FILENAME_FRAMING&t;&quot;framing&quot;&t;/* /proc/comx/comx0.1/framing           */
DECL|macro|FILENAME_LINECODE
mdefine_line|#define FILENAME_LINECODE&t;&quot;linecode&quot;&t;/* /proc/comx/comx0.1/linecode          */
DECL|macro|FILENAME_CLOCK_SOURCE
mdefine_line|#define FILENAME_CLOCK_SOURCE&t;&quot;clock_source&quot;&t;/* /proc/comx/comx0.1/clock_source      */
DECL|macro|FILENAME_LOOPBACK
mdefine_line|#define FILENAME_LOOPBACK&t;&quot;loopback&quot;&t;/* /proc/comx/comx0.1/loopback          */
DECL|macro|FILENAME_REG
mdefine_line|#define FILENAME_REG&t;&t;&quot;reg&quot;&t;&t;/* /proc/comx/comx0.1/reg               */
DECL|macro|FILENAME_LBIREG
mdefine_line|#define FILENAME_LBIREG&t;&t;&quot;lbireg&quot;&t;/* /proc/comx/comx0.1/lbireg            */
DECL|macro|SLICECOM_BOARDNUM_DEFAULT
mdefine_line|#define SLICECOM_BOARDNUM_DEFAULT&t;0
DECL|macro|SLICECOM_FRAMING_CRC4
mdefine_line|#define SLICECOM_FRAMING_CRC4&t;&t;1
DECL|macro|SLICECOM_FRAMING_NO_CRC4
mdefine_line|#define SLICECOM_FRAMING_NO_CRC4&t;2
DECL|macro|SLICECOM_FRAMING_DEFAULT
mdefine_line|#define SLICECOM_FRAMING_DEFAULT&t;SLICECOM_FRAMING_CRC4
DECL|macro|SLICECOM_LINECODE_HDB3
mdefine_line|#define SLICECOM_LINECODE_HDB3&t;&t;1
DECL|macro|SLICECOM_LINECODE_AMI
mdefine_line|#define SLICECOM_LINECODE_AMI&t;&t;2
DECL|macro|SLICECOM_LINECODE_DEFAULT
mdefine_line|#define SLICECOM_LINECODE_DEFAULT&t;SLICECOM_LINECODE_HDB3
DECL|macro|SLICECOM_CLOCK_SOURCE_LINE
mdefine_line|#define SLICECOM_CLOCK_SOURCE_LINE&t;1
DECL|macro|SLICECOM_CLOCK_SOURCE_INTERNAL
mdefine_line|#define SLICECOM_CLOCK_SOURCE_INTERNAL&t;2
DECL|macro|SLICECOM_CLOCK_SOURCE_DEFAULT
mdefine_line|#define SLICECOM_CLOCK_SOURCE_DEFAULT&t;SLICECOM_CLOCK_SOURCE_LINE
DECL|macro|SLICECOM_LOOPBACK_NONE
mdefine_line|#define SLICECOM_LOOPBACK_NONE&t;&t;1
DECL|macro|SLICECOM_LOOPBACK_LOCAL
mdefine_line|#define SLICECOM_LOOPBACK_LOCAL&t;&t;2
DECL|macro|SLICECOM_LOOPBACK_REMOTE
mdefine_line|#define SLICECOM_LOOPBACK_REMOTE&t;3
DECL|macro|SLICECOM_LOOPBACK_DEFAULT
mdefine_line|#define SLICECOM_LOOPBACK_DEFAULT&t;SLICECOM_LOOPBACK_NONE
DECL|macro|MUNICH_VIRT
mdefine_line|#define MUNICH_VIRT(addr) (void *)(&amp;bar1[addr])
DECL|struct|slicecom_stringtable
r_struct
id|slicecom_stringtable
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|value
r_int
id|value
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* A convention: keep &quot;default&quot; the last not NULL when reading from /proc,&n;   &quot;error&quot; is an indication that something went wrong, we have an undefined value */
DECL|variable|slicecom_framings
r_struct
id|slicecom_stringtable
id|slicecom_framings
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;crc4&quot;
comma
id|SLICECOM_FRAMING_CRC4
)brace
comma
(brace
l_string|&quot;no-crc4&quot;
comma
id|SLICECOM_FRAMING_NO_CRC4
)brace
comma
(brace
l_string|&quot;default&quot;
comma
id|SLICECOM_FRAMING_DEFAULT
)brace
comma
(brace
l_string|&quot;error&quot;
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|slicecom_linecodes
r_struct
id|slicecom_stringtable
id|slicecom_linecodes
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;hdb3&quot;
comma
id|SLICECOM_LINECODE_HDB3
)brace
comma
(brace
l_string|&quot;ami&quot;
comma
id|SLICECOM_LINECODE_AMI
)brace
comma
(brace
l_string|&quot;default&quot;
comma
id|SLICECOM_LINECODE_DEFAULT
)brace
comma
(brace
l_string|&quot;error&quot;
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|slicecom_clock_sources
r_struct
id|slicecom_stringtable
id|slicecom_clock_sources
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;line&quot;
comma
id|SLICECOM_CLOCK_SOURCE_LINE
)brace
comma
(brace
l_string|&quot;internal&quot;
comma
id|SLICECOM_CLOCK_SOURCE_INTERNAL
)brace
comma
(brace
l_string|&quot;default&quot;
comma
id|SLICECOM_CLOCK_SOURCE_DEFAULT
)brace
comma
(brace
l_string|&quot;error&quot;
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|slicecom_loopbacks
r_struct
id|slicecom_stringtable
id|slicecom_loopbacks
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;none&quot;
comma
id|SLICECOM_LOOPBACK_NONE
)brace
comma
(brace
l_string|&quot;local&quot;
comma
id|SLICECOM_LOOPBACK_LOCAL
)brace
comma
(brace
l_string|&quot;remote&quot;
comma
id|SLICECOM_LOOPBACK_REMOTE
)brace
comma
(brace
l_string|&quot;default&quot;
comma
id|SLICECOM_LOOPBACK_DEFAULT
)brace
comma
(brace
l_string|&quot;error&quot;
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Some tunable values...&n; *&n; *&t;Note: when tuning values which change the length of text in&n; *&t;/proc/comx/comx[n]/status, keep in mind that it must be shorter then&n; *&t;PAGESIZE !&n; */
DECL|macro|MAX_BOARDS
mdefine_line|#define MAX_BOARDS&t;4&t;/* ezzel 4 kartya lehet a gepben: 0..3          */
DECL|macro|RX_DESC_MAX
mdefine_line|#define RX_DESC_MAX&t;8&t;/* Rx ring size, must be &gt;= 4                   */
DECL|macro|TX_DESC_MAX
mdefine_line|#define TX_DESC_MAX&t;4&t;/* Tx ring size, must be &gt;= 2                   */
multiline_comment|/* a sokkal hosszabb Tx ring mar ronthatja a nem-FIFO packet    */
multiline_comment|/* schedulerek (fair queueing, stb.) hatekonysagat.             */
DECL|macro|MAX_WORK
mdefine_line|#define MAX_WORK&t;10&t;/* TOD: update the info max. ennyi-1 esemenyt dolgoz fel egy interrupt hivasnal */
multiline_comment|/*&n; *&t;These are tunable too, but don&squot;t touch them without fully understanding what is happening&n; */
DECL|macro|UDELAY
mdefine_line|#define UDELAY&t;&t;20&t;/* We wait UDELAY usecs with disabled interrupts before and     */
multiline_comment|/* after each command to avoid writing into each other&squot;s        */
multiline_comment|/* ccb-&gt;action_spec. A _send_packet nem var, mert azt az        */
multiline_comment|/* _interrupt()-bol is meghivhatja a LINE_tx()                  */
multiline_comment|/*&n; *&t;Just to avoid warnings about implicit declarations:&n; */
r_static
r_int
id|MUNICH_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|slicecomhw
r_static
r_struct
id|comx_hardware
id|slicecomhw
suffix:semicolon
DECL|variable|pcicomhw
r_static
r_struct
id|comx_hardware
id|pcicomhw
suffix:semicolon
DECL|variable|flags
r_static
r_int
r_int
id|flags
suffix:semicolon
DECL|variable|mister_lock
r_static
id|spinlock_t
id|mister_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_typedef
r_volatile
r_struct
multiline_comment|/* Time Slot Assignment */
(brace
DECL|member|rxfillmask
id|u32
id|rxfillmask
suffix:colon
l_int|8
comma
singleline_comment|// ----------------------------+------+
singleline_comment|//                             |      |
DECL|member|rxchannel
id|rxchannel
suffix:colon
l_int|5
comma
singleline_comment|// ----------------------+---+ |      |
DECL|member|rti
id|rti
suffix:colon
l_int|1
comma
singleline_comment|// ---------------------+|   | |      |
DECL|member|res2
id|res2
suffix:colon
l_int|2
comma
singleline_comment|// -------------------++||   | |      |
singleline_comment|//                    ||||   | |      |
DECL|member|txfillmask
id|txfillmask
suffix:colon
l_int|8
comma
singleline_comment|// ----------+------+ ||||   | |      |
singleline_comment|//           |      | ||||   | |      |
DECL|member|txchannel
id|txchannel
suffix:colon
l_int|5
comma
singleline_comment|// ----+---+ |      | ||||   | |      |
DECL|member|tti
id|tti
suffix:colon
l_int|1
comma
singleline_comment|// ---+|   | |      | ||||   | |      |
DECL|member|res1
id|res1
suffix:colon
l_int|2
suffix:semicolon
singleline_comment|// -++||   | |      | ||||   | |      |
singleline_comment|//   3          2          1
singleline_comment|//  10987654 32109876 54321098 76543210
DECL|typedef|timeslot_spec_t
)brace
id|timeslot_spec_t
suffix:semicolon
r_typedef
r_volatile
r_struct
multiline_comment|/* Receive Descriptor */
(brace
DECL|member|zero1
DECL|member|no
DECL|member|hi
DECL|member|hold
DECL|member|zero2
id|u32
id|zero1
suffix:colon
l_int|16
comma
id|no
suffix:colon
l_int|13
comma
id|hi
suffix:colon
l_int|1
comma
id|hold
suffix:colon
l_int|1
comma
id|zero2
suffix:colon
l_int|1
suffix:semicolon
DECL|member|next
id|u32
id|next
suffix:semicolon
DECL|member|data
id|u32
id|data
suffix:semicolon
DECL|member|zero3
DECL|member|status
DECL|member|bno
DECL|member|zero4
DECL|member|c
DECL|member|fe
id|u32
id|zero3
suffix:colon
l_int|8
comma
id|status
suffix:colon
l_int|8
comma
id|bno
suffix:colon
l_int|13
comma
id|zero4
suffix:colon
l_int|1
comma
id|c
suffix:colon
l_int|1
comma
id|fe
suffix:colon
l_int|1
suffix:semicolon
DECL|typedef|rx_desc_t
)brace
id|rx_desc_t
suffix:semicolon
r_typedef
r_volatile
r_struct
multiline_comment|/* Transmit Descriptor */
(brace
DECL|member|fnum
DECL|member|csm
DECL|member|no13
DECL|member|zero1
DECL|member|v110
DECL|member|no
DECL|member|hi
DECL|member|hold
DECL|member|fe
id|u32
id|fnum
suffix:colon
l_int|11
comma
id|csm
suffix:colon
l_int|1
comma
id|no13
suffix:colon
l_int|1
comma
id|zero1
suffix:colon
l_int|2
comma
id|v110
suffix:colon
l_int|1
comma
id|no
suffix:colon
l_int|13
comma
id|hi
suffix:colon
l_int|1
comma
id|hold
suffix:colon
l_int|1
comma
id|fe
suffix:colon
l_int|1
suffix:semicolon
DECL|member|next
id|u32
id|next
suffix:semicolon
DECL|member|data
id|u32
id|data
suffix:semicolon
DECL|typedef|tx_desc_t
)brace
id|tx_desc_t
suffix:semicolon
r_typedef
r_volatile
r_struct
multiline_comment|/* Channel Specification */
(brace
DECL|member|iftf
DECL|member|mode
DECL|member|fa
DECL|member|trv
DECL|member|crc
DECL|member|inv
DECL|member|cs
DECL|member|tflag
DECL|member|ra
DECL|member|ro
id|u32
id|iftf
suffix:colon
l_int|1
comma
id|mode
suffix:colon
l_int|2
comma
id|fa
suffix:colon
l_int|1
comma
id|trv
suffix:colon
l_int|2
comma
id|crc
suffix:colon
l_int|1
comma
id|inv
suffix:colon
l_int|1
comma
id|cs
suffix:colon
l_int|1
comma
id|tflag
suffix:colon
l_int|7
comma
id|ra
suffix:colon
l_int|1
comma
id|ro
suffix:colon
l_int|1
comma
DECL|member|th
DECL|member|ta
DECL|member|to
DECL|member|ti
DECL|member|ri
DECL|member|nitbs
DECL|member|fit
DECL|member|fir
DECL|member|re
DECL|member|te
DECL|member|ch
id|th
suffix:colon
l_int|1
comma
id|ta
suffix:colon
l_int|1
comma
id|to
suffix:colon
l_int|1
comma
id|ti
suffix:colon
l_int|1
comma
id|ri
suffix:colon
l_int|1
comma
id|nitbs
suffix:colon
l_int|1
comma
id|fit
suffix:colon
l_int|1
comma
id|fir
suffix:colon
l_int|1
comma
id|re
suffix:colon
l_int|1
comma
id|te
suffix:colon
l_int|1
comma
id|ch
suffix:colon
l_int|1
comma
DECL|member|ifc
DECL|member|sfe
DECL|member|fe2
id|ifc
suffix:colon
l_int|1
comma
id|sfe
suffix:colon
l_int|1
comma
id|fe2
suffix:colon
l_int|1
suffix:semicolon
DECL|member|frda
id|u32
id|frda
suffix:semicolon
DECL|member|ftda
id|u32
id|ftda
suffix:semicolon
DECL|member|itbs
DECL|member|zero1
id|u32
id|itbs
suffix:colon
l_int|6
comma
id|zero1
suffix:colon
l_int|26
suffix:semicolon
DECL|typedef|channel_spec_t
)brace
id|channel_spec_t
suffix:semicolon
r_typedef
r_volatile
r_struct
multiline_comment|/* Configuration Control Block */
(brace
DECL|member|action_spec
id|u32
id|action_spec
suffix:semicolon
DECL|member|reserved1
id|u32
id|reserved1
suffix:semicolon
DECL|member|reserved2
id|u32
id|reserved2
suffix:semicolon
DECL|member|timeslot_spec
id|timeslot_spec_t
id|timeslot_spec
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|channel_spec
id|channel_spec_t
id|channel_spec
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|current_rx_desc
id|u32
id|current_rx_desc
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|current_tx_desc
id|u32
id|current_tx_desc
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|csa
id|u32
id|csa
suffix:semicolon
multiline_comment|/* Control Start Address. CSA = *CCBA; CCB = *CSA */
multiline_comment|/* MUNICH does it like: CCB = *( *CCBA )          */
DECL|typedef|munich_ccb_t
)brace
id|munich_ccb_t
suffix:semicolon
r_typedef
r_volatile
r_struct
multiline_comment|/* Entry in the interrupt queue */
(brace
DECL|member|all
id|u32
id|all
suffix:semicolon
DECL|typedef|munich_intq_t
)brace
id|munich_intq_t
suffix:semicolon
DECL|macro|MUNICH_INTQLEN
mdefine_line|#define MUNICH_INTQLEN&t;63&t;/* Rx/Tx Interrupt Queue Length&n;&t;&t;&t;&t;   (not the real len, but the TIQL/RIQL value)  */
DECL|macro|MUNICH_INTQMAX
mdefine_line|#define MUNICH_INTQMAX&t;( 16*(MUNICH_INTQLEN+1) )&t;/* Rx/Tx/Periph Interrupt Queue size in munich_intq_t&squot;s */
DECL|macro|MUNICH_INTQSIZE
mdefine_line|#define MUNICH_INTQSIZE&t;( 4*MUNICH_INTQMAX )&t;/* Rx/Tx/Periph Interrupt Queue size in bytes           */
DECL|macro|MUNICH_PIQLEN
mdefine_line|#define MUNICH_PIQLEN&t;4&t;/* Peripheral Interrupt Queue Length. Unlike the RIQL/TIQL, */
DECL|macro|MUNICH_PIQMAX
mdefine_line|#define MUNICH_PIQMAX&t;( 4*MUNICH_PIQLEN )&t;/* PIQL register needs it like this                     */
DECL|macro|MUNICH_PIQSIZE
mdefine_line|#define MUNICH_PIQSIZE&t;( 4*MUNICH_PIQMAX )
DECL|typedef|vol_u32
r_typedef
r_volatile
id|u32
id|vol_u32
suffix:semicolon
multiline_comment|/* TOD: ezek megszunnek ha atirom readw()/writew()-re - k&#xfffd;sz */
DECL|typedef|vol_u8
r_typedef
r_volatile
id|u8
id|vol_u8
suffix:semicolon
r_typedef
r_volatile
r_struct
multiline_comment|/* counters of E1-errors and errored seconds, see rfc2495 */
(brace
multiline_comment|/* use here only unsigned ints, we depend on it when calculating the sum for the last N intervals */
DECL|member|line_code_violations
r_int
id|line_code_violations
comma
multiline_comment|/* AMI: bipolar violations, HDB3: hdb3 violations                       */
DECL|member|path_code_violations
id|path_code_violations
comma
multiline_comment|/* FAS errors and CRC4 errors                                                   */
DECL|member|e_bit_errors
id|e_bit_errors
comma
multiline_comment|/* E-Bit Errors (the remote side received from us with CRC4-error) */
DECL|member|slip_secs
id|slip_secs
comma
multiline_comment|/* number of seconds with (receive) Controlled Slip(s)          */
DECL|member|fr_loss_secs
id|fr_loss_secs
comma
multiline_comment|/* number of seconds an Out Of Frame defect was detected                */
DECL|member|line_err_secs
id|line_err_secs
comma
multiline_comment|/* number of seconds with one or more Line Code Violations              */
DECL|member|degraded_mins
id|degraded_mins
comma
multiline_comment|/* Degraded Minute - the estimated error rate is &gt;1E-6, but &lt;1E-3       */
DECL|member|errored_secs
id|errored_secs
comma
multiline_comment|/* Errored Second - at least one of these happened:&n;&t;&t;&t;&t;   - Path Code Violation&n;&t;&t;&t;&t;   - Out Of Frame defect&n;&t;&t;&t;&t;   - Slip&n;&t;&t;&t;&t;   - receiving AIS&n;&t;&t;&t;&t;   - not incremented during an Unavailable Second                       */
DECL|member|bursty_err_secs
id|bursty_err_secs
comma
multiline_comment|/* Bursty Errored Second: (rfc2495 says it does not apply to E1)&n;&t;&t;&t;&t;   - Path Code Violations &gt;1, but &lt;320&n;&t;&t;&t;&t;   - not a Severely Errored Second&n;&t;&t;&t;&t;   - no AIS&n;&t;&t;&t;&t;   - not incremented during an Unavailabla Second                       */
DECL|member|severely_err_secs
id|severely_err_secs
comma
multiline_comment|/* Severely Errored Second:&n;&t;&t;&t;&t;   - CRC4: &gt;=832 Path COde Violations || &gt;0 Out Of Frame defects&n;&t;&t;&t;&t;   - noCRC4: &gt;=2048 Line Code Violations&n;&t;&t;&t;&t;   - not incremented during an Unavailable Second                       */
DECL|member|unavail_secs
id|unavail_secs
suffix:semicolon
multiline_comment|/* number of Unavailable Seconds. Unavailable state is said after:&n;&t;&t;&t;&t;   - 10 contiguous Severely Errored Seconds&n;&t;&t;&t;&t;   - or RAI || AIS || LOF || LOS &n;&t;&t;&t;&t;   - (any) loopback has been set                                                */
multiline_comment|/*&n;     * we do not strictly comply to the rfc: we do not retroactively reduce errored_secs,&n;     * bursty_err_secs, severely_err_secs when &squot;unavailable state&squot; is reached&n;     */
DECL|typedef|e1_stats_t
)brace
id|e1_stats_t
suffix:semicolon
r_typedef
r_volatile
r_struct
multiline_comment|/* ezek board-adatok, nem lehetnek a slicecom_privdata -ban     */
(brace
DECL|member|use_count
r_int
id|use_count
suffix:semicolon
multiline_comment|/* num. of interfaces using the board                           */
DECL|member|irq
r_int
id|irq
suffix:semicolon
multiline_comment|/* a kartya irq-ja. belemasoljuk a dev-&gt;irq -kba is, de csak hogy       */
multiline_comment|/* szebb legyen az ifconfig outputja                            */
multiline_comment|/* ha != 0, az azt jelenti hogy az az irq most nekunk sikeresen */
multiline_comment|/* le van foglalva                                              */
DECL|member|pci
r_struct
id|pci_dev
op_star
id|pci
suffix:semicolon
multiline_comment|/* a kartya PCI strukturaja. NULL, ha nincs kartya              */
DECL|member|bar1
id|u32
op_star
id|bar1
suffix:semicolon
multiline_comment|/* pci-&gt;base_address[0] ioremap()-ed by munich_probe(),         */
multiline_comment|/* on x86 can be used both as a bus or virtual address.         */
multiline_comment|/* These are the Munich&squot;s registers                             */
DECL|member|lbi
id|u8
op_star
id|lbi
suffix:semicolon
multiline_comment|/* pci-&gt;base_address[1] ioremap()-ed by munich_probe(),         */
multiline_comment|/* this is a 256-byte range, the start of the LBI on the board  */
DECL|member|ccb
id|munich_ccb_t
op_star
id|ccb
suffix:semicolon
multiline_comment|/* virtual address of CCB                                       */
DECL|member|tiq
id|munich_intq_t
op_star
id|tiq
suffix:semicolon
multiline_comment|/* Tx Interrupt Queue                                           */
DECL|member|riq
id|munich_intq_t
op_star
id|riq
suffix:semicolon
multiline_comment|/* Rx Interrupt Queue                                           */
DECL|member|piq
id|munich_intq_t
op_star
id|piq
suffix:semicolon
multiline_comment|/* Peripheral Interrupt Queue (FALC interrupts arrive here)     */
DECL|member|tiq_ptr
r_int
id|tiq_ptr
comma
multiline_comment|/* A &squot;current&squot; helyek a tiq/riq/piq -ban.                       */
DECL|member|riq_ptr
id|riq_ptr
comma
multiline_comment|/* amikor feldolgoztam az interruptokat, a legelso ures         */
DECL|member|piq_ptr
id|piq_ptr
suffix:semicolon
multiline_comment|/* interrupt_information szora mutatnak.                        */
DECL|member|twins
r_struct
id|net_device
op_star
id|twins
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* MUNICH channel -&gt; network interface assignment       */
DECL|member|lastcheck
r_int
r_int
id|lastcheck
suffix:semicolon
multiline_comment|/* When were the Rx rings last checked. Time in jiffies         */
DECL|member|modemline_timer
r_struct
id|timer_list
id|modemline_timer
suffix:semicolon
DECL|member|isx21
r_char
id|isx21
suffix:semicolon
DECL|member|lineup
r_char
id|lineup
suffix:semicolon
DECL|member|framing
r_char
id|framing
suffix:semicolon
multiline_comment|/* a beallitasok tarolasa                               */
DECL|member|linecode
r_char
id|linecode
suffix:semicolon
DECL|member|clock_source
r_char
id|clock_source
suffix:semicolon
DECL|member|loopback
r_char
id|loopback
suffix:semicolon
DECL|member|devname
r_char
id|devname
(braket
l_int|30
)braket
suffix:semicolon
multiline_comment|/* what to show in /proc/interrupts                     */
DECL|member|histogram
r_int
id|histogram
(braket
id|MAX_WORK
)braket
suffix:semicolon
multiline_comment|/* number of processed events in the interrupt loop     */
DECL|member|stat_pri_races
r_int
id|stat_pri_races
suffix:semicolon
multiline_comment|/* number of special events, we try to handle them      */
DECL|member|stat_pti_races
r_int
id|stat_pti_races
suffix:semicolon
DECL|member|stat_pri_races_missed
r_int
id|stat_pri_races_missed
suffix:semicolon
multiline_comment|/* when it can not be handled, because of MAX_WORK      */
DECL|member|stat_pti_races_missed
r_int
id|stat_pti_races_missed
suffix:semicolon
DECL|macro|SLICECOM_BOARD_INTERVALS_SIZE
mdefine_line|#define SLICECOM_BOARD_INTERVALS_SIZE&t;97
DECL|member|intervals
id|e1_stats_t
id|intervals
(braket
id|SLICECOM_BOARD_INTERVALS_SIZE
)braket
suffix:semicolon
multiline_comment|/* E1 line statistics           */
DECL|member|current_interval
r_int
id|current_interval
suffix:semicolon
multiline_comment|/* pointer to the current interval                      */
DECL|member|elapsed_seconds
r_int
id|elapsed_seconds
suffix:semicolon
multiline_comment|/* elapsed seconds from the start of the current interval */
DECL|member|ses_seconds
r_int
id|ses_seconds
suffix:semicolon
multiline_comment|/* counter of contiguous Severely Errored Seconds       */
DECL|member|is_unavailable
r_int
id|is_unavailable
suffix:semicolon
multiline_comment|/* set to 1 after 10 contiguous Severely Errored Seconds */
DECL|member|no_ses_seconds
r_int
id|no_ses_seconds
suffix:semicolon
multiline_comment|/* contiguous Severely Error -free seconds in unavail state */
DECL|member|deg_elapsed_seconds
r_int
id|deg_elapsed_seconds
suffix:semicolon
multiline_comment|/* for counting the &squot;Degraded Mins&squot;                     */
DECL|member|deg_cumulated_errors
r_int
id|deg_cumulated_errors
suffix:semicolon
DECL|member|owner
r_struct
id|module
op_star
id|owner
suffix:semicolon
multiline_comment|/* pointer to our module to avoid module load races */
DECL|typedef|munich_board_t
)brace
id|munich_board_t
suffix:semicolon
DECL|struct|slicecom_privdata
r_struct
id|slicecom_privdata
(brace
DECL|member|busy
r_int
id|busy
suffix:semicolon
multiline_comment|/* transmitter busy - number of packets in the Tx ring  */
DECL|member|channel
r_int
id|channel
suffix:semicolon
multiline_comment|/* Munich logical channel (&squot;channel-group&squot; in Cisco)    */
DECL|member|boardnum
r_int
id|boardnum
suffix:semicolon
DECL|member|timeslots
id|u32
id|timeslots
suffix:semicolon
multiline_comment|/* i-th bit means i-th timeslot is our                  */
DECL|member|tx_ring_hist
r_int
id|tx_ring_hist
(braket
id|TX_DESC_MAX
)braket
suffix:semicolon
multiline_comment|/* histogram: number of packets in Tx ring when _send_packet is called  */
DECL|member|tx_desc
id|tx_desc_t
id|tx_desc
(braket
id|TX_DESC_MAX
)braket
suffix:semicolon
multiline_comment|/* the ring of Tx descriptors                           */
DECL|member|tx_data
id|u8
id|tx_data
(braket
id|TX_DESC_MAX
)braket
(braket
id|TXBUFFER_SIZE
)braket
suffix:semicolon
multiline_comment|/* buffers for data to transmit                 */
DECL|member|tx_desc_ptr
r_int
id|tx_desc_ptr
suffix:semicolon
multiline_comment|/* hanyadik descriptornal tartunk a beirassal   */
multiline_comment|/* ahol ez all, oda irtunk utoljara                     */
DECL|member|rx_desc
id|rx_desc_t
id|rx_desc
(braket
id|RX_DESC_MAX
)braket
suffix:semicolon
multiline_comment|/* the ring of Rx descriptors                           */
DECL|member|rx_data
id|u8
id|rx_data
(braket
id|RX_DESC_MAX
)braket
(braket
id|RXBUFFER_SIZE
)braket
suffix:semicolon
multiline_comment|/* buffers for received data                            */
DECL|member|rx_desc_ptr
r_int
id|rx_desc_ptr
suffix:semicolon
multiline_comment|/* hanyadik descriptornal tartunk az olvasassal */
DECL|member|rafutott
r_int
id|rafutott
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|reg
DECL|variable|reg_ertek
r_static
id|u32
id|reg
comma
id|reg_ertek
suffix:semicolon
multiline_comment|/* why static: don&squot;t write stack trash into regs if strtoul() fails */
DECL|variable|lbireg
r_static
id|u32
id|lbireg
suffix:semicolon
DECL|variable|lbireg_ertek
r_static
id|u8
id|lbireg_ertek
suffix:semicolon
multiline_comment|/* why static: don&squot;t write stack trash into regs if strtoul() fails */
DECL|variable|slicecom_boards
r_static
id|munich_board_t
id|slicecom_boards
(braket
id|MAX_BOARDS
)braket
suffix:semicolon
DECL|variable|pcicom_boards
r_static
id|munich_board_t
id|pcicom_boards
(braket
id|MAX_BOARDS
)braket
suffix:semicolon
multiline_comment|/*&n; * Reprogram Idle Channel Registers in the FALC - send special code in not used channels&n; * Should be called from the open and close, when the timeslot assignment changes&n; */
DECL|function|rework_idle_channels
r_void
id|rework_idle_channels
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
id|munich_board_t
op_star
id|board
op_assign
id|slicecom_boards
op_plus
id|hw-&gt;boardnum
suffix:semicolon
id|munich_ccb_t
op_star
id|ccb
op_assign
id|board-&gt;ccb
suffix:semicolon
id|u8
op_star
id|lbi
op_assign
id|board-&gt;lbi
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|tmp
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp
op_assign
l_int|0xFF
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|ccb-&gt;timeslot_spec
(braket
l_int|8
op_star
id|i
op_plus
id|j
)braket
dot
id|tti
op_eq
l_int|0
)paren
id|tmp
op_xor_assign
(paren
l_int|0x80
op_rshift
id|j
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tmp
comma
id|lbi
op_plus
l_int|0x30
op_plus
id|i
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set PCM framing - /proc/comx/comx0/framing&n; */
DECL|function|slicecom_set_framing
r_void
id|slicecom_set_framing
c_func
(paren
r_int
id|boardnum
comma
r_int
id|value
)paren
(brace
id|u8
op_star
id|lbi
op_assign
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|lbi
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|framing
op_assign
id|value
suffix:semicolon
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
id|SLICECOM_FRAMING_CRC4
suffix:colon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|FMR1
)paren
op_or
l_int|8
comma
id|lbi
op_plus
id|FMR1
)paren
suffix:semicolon
id|writeb
c_func
(paren
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|FMR2
)paren
op_amp
l_int|0x3f
)paren
op_or
l_int|0x80
comma
id|lbi
op_plus
id|FMR2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SLICECOM_FRAMING_NO_CRC4
suffix:colon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|FMR1
)paren
op_amp
l_int|0xf7
comma
id|lbi
op_plus
id|FMR1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|FMR2
)paren
op_amp
l_int|0x3f
comma
id|lbi
op_plus
id|FMR2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;slicecom: board %d: unhandled &quot;
id|FILENAME_FRAMING
l_string|&quot; value %d&bslash;n&quot;
comma
id|boardnum
comma
id|value
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set PCM linecode - /proc/comx/comx0/linecode&n; */
DECL|function|slicecom_set_linecode
r_void
id|slicecom_set_linecode
c_func
(paren
r_int
id|boardnum
comma
r_int
id|value
)paren
(brace
id|u8
op_star
id|lbi
op_assign
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|lbi
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|linecode
op_assign
id|value
suffix:semicolon
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
id|SLICECOM_LINECODE_HDB3
suffix:colon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|FMR0
)paren
op_or
l_int|0xf0
comma
id|lbi
op_plus
id|FMR0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SLICECOM_LINECODE_AMI
suffix:colon
id|writeb
c_func
(paren
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|FMR0
)paren
op_amp
l_int|0x0f
)paren
op_or
l_int|0xa0
comma
id|lbi
op_plus
id|FMR0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;slicecom: board %d: unhandled &quot;
id|FILENAME_LINECODE
l_string|&quot; value %d&bslash;n&quot;
comma
id|boardnum
comma
id|value
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set PCM clock source - /proc/comx/comx0/clock_source&n; */
DECL|function|slicecom_set_clock_source
r_void
id|slicecom_set_clock_source
c_func
(paren
r_int
id|boardnum
comma
r_int
id|value
)paren
(brace
id|u8
op_star
id|lbi
op_assign
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|lbi
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|clock_source
op_assign
id|value
suffix:semicolon
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
id|SLICECOM_CLOCK_SOURCE_LINE
suffix:colon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|LIM0
)paren
op_amp
op_complement
l_int|1
comma
id|lbi
op_plus
id|LIM0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SLICECOM_CLOCK_SOURCE_INTERNAL
suffix:colon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|LIM0
)paren
op_or
l_int|1
comma
id|lbi
op_plus
id|LIM0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;slicecom: board %d: unhandled &quot;
id|FILENAME_CLOCK_SOURCE
l_string|&quot; value %d&bslash;n&quot;
comma
id|boardnum
comma
id|value
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set loopbacks - /proc/comx/comx0/loopback&n; */
DECL|function|slicecom_set_loopback
r_void
id|slicecom_set_loopback
c_func
(paren
r_int
id|boardnum
comma
r_int
id|value
)paren
(brace
id|u8
op_star
id|lbi
op_assign
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|lbi
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|loopback
op_assign
id|value
suffix:semicolon
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
id|SLICECOM_LOOPBACK_NONE
suffix:colon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|LIM0
)paren
op_amp
op_complement
l_int|2
comma
id|lbi
op_plus
id|LIM0
)paren
suffix:semicolon
multiline_comment|/* Local Loop OFF  */
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|LIM1
)paren
op_amp
op_complement
l_int|2
comma
id|lbi
op_plus
id|LIM1
)paren
suffix:semicolon
multiline_comment|/* Remote Loop OFF */
r_break
suffix:semicolon
r_case
id|SLICECOM_LOOPBACK_LOCAL
suffix:colon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|LIM1
)paren
op_amp
op_complement
l_int|2
comma
id|lbi
op_plus
id|LIM1
)paren
suffix:semicolon
multiline_comment|/* Remote Loop OFF */
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|LIM0
)paren
op_or
l_int|2
comma
id|lbi
op_plus
id|LIM0
)paren
suffix:semicolon
multiline_comment|/* Local Loop ON   */
r_break
suffix:semicolon
r_case
id|SLICECOM_LOOPBACK_REMOTE
suffix:colon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|LIM0
)paren
op_amp
op_complement
l_int|2
comma
id|lbi
op_plus
id|LIM0
)paren
suffix:semicolon
multiline_comment|/* Local Loop OFF  */
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|LIM1
)paren
op_or
l_int|2
comma
id|lbi
op_plus
id|LIM1
)paren
suffix:semicolon
multiline_comment|/* Remote Loop ON  */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;slicecom: board %d: unhandled &quot;
id|FILENAME_LOOPBACK
l_string|&quot; value %d&bslash;n&quot;
comma
id|boardnum
comma
id|value
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Update E1 line status LEDs on the adapter&n; */
DECL|function|slicecom_update_leds
r_void
id|slicecom_update_leds
c_func
(paren
id|munich_board_t
op_star
id|board
)paren
(brace
id|u32
op_star
id|bar1
op_assign
id|board-&gt;bar1
suffix:semicolon
id|u8
op_star
id|lbi
op_assign
id|board-&gt;lbi
suffix:semicolon
id|u8
id|frs0
suffix:semicolon
id|u32
id|leds
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|leds
op_assign
l_int|0
suffix:semicolon
id|frs0
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|FRS0
)paren
suffix:semicolon
multiline_comment|/* FRS0 bits described on page 137 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|frs0
op_amp
l_int|0xa0
)paren
)paren
(brace
id|leds
op_or_assign
l_int|0x2000
suffix:semicolon
multiline_comment|/* Green LED: Input signal seems to be OK, no LOS, no LFA       */
r_if
c_cond
(paren
id|frs0
op_amp
l_int|0x10
)paren
id|leds
op_or_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* Red LED: Receiving Remote Alarm                                      */
)brace
id|writel
c_func
(paren
id|leds
comma
id|MUNICH_VIRT
c_func
(paren
id|GPDATA
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|leds
op_eq
l_int|0x2000
op_logical_and
op_logical_neg
id|board-&gt;lineup
)paren
(brace
multiline_comment|/* line up */
id|board-&gt;lineup
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|board-&gt;twins
(braket
id|i
)braket
op_logical_and
(paren
id|board-&gt;twins
(braket
id|i
)braket
op_member_access_from_pointer
id|flags
op_amp
id|IFF_RUNNING
)paren
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|board-&gt;twins
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|ch-&gt;lineup_pending
)paren
)paren
(brace
id|ch-&gt;lineup_timer.function
op_assign
id|comx_lineup_func
suffix:semicolon
id|ch-&gt;lineup_timer.data
op_assign
(paren
r_int
r_int
)paren
id|board-&gt;twins
(braket
id|i
)braket
suffix:semicolon
id|ch-&gt;lineup_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
id|ch-&gt;lineup_delay
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ch-&gt;lineup_timer
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|leds
op_ne
l_int|0x2000
op_logical_and
id|board-&gt;lineup
)paren
(brace
multiline_comment|/* line down */
id|board-&gt;lineup
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|board-&gt;twins
(braket
id|i
)braket
op_logical_and
(paren
id|board-&gt;twins
(braket
id|i
)braket
op_member_access_from_pointer
id|flags
op_amp
id|IFF_RUNNING
)paren
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|board-&gt;twins
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|ch-&gt;lineup_pending
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|ch-&gt;lineup_timer
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ch-&gt;line_status
op_amp
id|LINE_UP
)paren
(brace
id|ch-&gt;line_status
op_and_assign
op_complement
id|LINE_UP
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;LINE_status
)paren
id|ch
op_member_access_from_pointer
id|LINE_status
c_func
(paren
id|board-&gt;twins
(braket
id|i
)braket
comma
id|ch-&gt;line_status
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function gets called every second when the FALC issues the interrupt.&n; * Hardware counters contain error counts for last 1-second time interval.&n; * We add them to the global counters here.&n; * Read rfc2495 to understand this.&n; */
DECL|function|slicecom_update_line_counters
r_void
id|slicecom_update_line_counters
c_func
(paren
id|munich_board_t
op_star
id|board
)paren
(brace
id|e1_stats_t
op_star
id|curr_int
op_assign
op_amp
id|board-&gt;intervals
(braket
id|board-&gt;current_interval
)braket
suffix:semicolon
id|u8
op_star
id|lbi
op_assign
id|board-&gt;lbi
suffix:semicolon
r_int
id|framing_errors
comma
id|code_violations
comma
id|path_code_violations
comma
id|crc4_errors
comma
id|e_bit_errors
suffix:semicolon
r_int
id|slip_detected
comma
multiline_comment|/* this one has logical value, not the number of slips! */
id|out_of_frame_defect
comma
multiline_comment|/* logical value        */
id|ais_defect
comma
multiline_comment|/* logical value        */
id|errored_sec
comma
id|bursty_err_sec
comma
id|severely_err_sec
op_assign
l_int|0
comma
id|failure_sec
suffix:semicolon
id|u8
id|isr2
comma
id|isr3
comma
id|isr5
comma
id|frs0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|isr2
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|ISR2
)paren
suffix:semicolon
multiline_comment|/* ISR0-5 described on page 156     */
id|isr3
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|ISR3
)paren
suffix:semicolon
id|isr5
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|ISR5
)paren
suffix:semicolon
id|frs0
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|FRS0
)paren
suffix:semicolon
multiline_comment|/* FRS0 described on page 137       */
multiline_comment|/* Error Events: */
id|code_violations
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|CVCL
)paren
op_plus
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|CVCH
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|framing_errors
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|FECL
)paren
op_plus
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|FECH
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|crc4_errors
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|CEC1L
)paren
op_plus
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|CEC1H
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|e_bit_errors
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|EBCL
)paren
op_plus
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|EBCH
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|slip_detected
op_assign
id|isr3
op_amp
(paren
id|ISR3_RSN
op_or
id|ISR3_RSP
)paren
suffix:semicolon
id|path_code_violations
op_assign
id|framing_errors
op_plus
id|crc4_errors
suffix:semicolon
id|curr_int-&gt;line_code_violations
op_add_assign
id|code_violations
suffix:semicolon
id|curr_int-&gt;path_code_violations
op_add_assign
id|path_code_violations
suffix:semicolon
id|curr_int-&gt;e_bit_errors
op_add_assign
id|e_bit_errors
suffix:semicolon
multiline_comment|/* Performance Defects: */
multiline_comment|/* there was an LFA in the last second, but maybe disappeared: */
id|out_of_frame_defect
op_assign
(paren
id|isr2
op_amp
id|ISR2_LFA
)paren
op_logical_or
(paren
id|frs0
op_amp
id|FRS0_LFA
)paren
suffix:semicolon
multiline_comment|/* there was an AIS in the last second, but maybe disappeared: */
id|ais_defect
op_assign
(paren
id|isr2
op_amp
id|ISR2_AIS
)paren
op_logical_or
(paren
id|frs0
op_amp
id|FRS0_AIS
)paren
suffix:semicolon
multiline_comment|/* Performance Parameters: */
r_if
c_cond
(paren
id|out_of_frame_defect
)paren
id|curr_int-&gt;fr_loss_secs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|code_violations
)paren
id|curr_int-&gt;line_err_secs
op_increment
suffix:semicolon
id|errored_sec
op_assign
(paren
(paren
id|board-&gt;framing
op_eq
id|SLICECOM_FRAMING_NO_CRC4
)paren
op_logical_and
(paren
id|code_violations
)paren
)paren
op_logical_or
id|path_code_violations
op_logical_or
id|out_of_frame_defect
op_logical_or
id|slip_detected
op_logical_or
id|ais_defect
suffix:semicolon
id|bursty_err_sec
op_assign
op_logical_neg
id|out_of_frame_defect
op_logical_and
op_logical_neg
id|ais_defect
op_logical_and
(paren
id|path_code_violations
OG
l_int|1
)paren
op_logical_and
(paren
id|path_code_violations
OL
l_int|320
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|board-&gt;framing
)paren
(brace
r_case
id|SLICECOM_FRAMING_CRC4
suffix:colon
id|severely_err_sec
op_assign
id|out_of_frame_defect
op_logical_or
(paren
id|path_code_violations
op_ge
l_int|832
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SLICECOM_FRAMING_NO_CRC4
suffix:colon
id|severely_err_sec
op_assign
(paren
id|code_violations
op_ge
l_int|2048
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;     * failure_sec: true if there was a condition leading to a failure&n;     * (and leading to unavailable state) in this second:&n;     */
id|failure_sec
op_assign
(paren
id|isr2
op_amp
id|ISR2_RA
)paren
op_logical_or
(paren
id|frs0
op_amp
id|FRS0_RRA
)paren
multiline_comment|/* Remote/Far End/Distant Alarm Failure */
op_logical_or
id|ais_defect
op_logical_or
id|out_of_frame_defect
multiline_comment|/* AIS or LOF Failure                           */
op_logical_or
(paren
id|isr2
op_amp
id|ISR2_LOS
)paren
op_logical_or
(paren
id|frs0
op_amp
id|FRS0_LOS
)paren
multiline_comment|/* Loss Of Signal Failure                       */
op_logical_or
(paren
id|board-&gt;loopback
op_ne
id|SLICECOM_LOOPBACK_NONE
)paren
suffix:semicolon
multiline_comment|/* Loopback has been set                        */
r_if
c_cond
(paren
id|board-&gt;is_unavailable
)paren
(brace
r_if
c_cond
(paren
id|severely_err_sec
)paren
id|board-&gt;no_ses_seconds
op_assign
l_int|0
suffix:semicolon
r_else
id|board-&gt;no_ses_seconds
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|board-&gt;no_ses_seconds
op_ge
l_int|10
)paren
op_logical_and
op_logical_neg
id|failure_sec
)paren
(brace
id|board-&gt;is_unavailable
op_assign
l_int|0
suffix:semicolon
id|board-&gt;ses_seconds
op_assign
l_int|0
suffix:semicolon
id|board-&gt;no_ses_seconds
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|severely_err_sec
)paren
id|board-&gt;ses_seconds
op_increment
suffix:semicolon
r_else
id|board-&gt;ses_seconds
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|board-&gt;ses_seconds
op_ge
l_int|10
)paren
op_logical_or
id|failure_sec
)paren
(brace
id|board-&gt;is_unavailable
op_assign
l_int|1
suffix:semicolon
id|board-&gt;ses_seconds
op_assign
l_int|0
suffix:semicolon
id|board-&gt;no_ses_seconds
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|board-&gt;is_unavailable
)paren
id|curr_int-&gt;unavail_secs
op_increment
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|slip_detected
)paren
id|curr_int-&gt;slip_secs
op_increment
suffix:semicolon
id|curr_int-&gt;errored_secs
op_add_assign
id|errored_sec
suffix:semicolon
id|curr_int-&gt;bursty_err_secs
op_add_assign
id|bursty_err_sec
suffix:semicolon
id|curr_int-&gt;severely_err_secs
op_add_assign
id|severely_err_sec
suffix:semicolon
)brace
multiline_comment|/* the RFC does not say clearly which errors to count here, we try to count bit errors */
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;is_unavailable
op_logical_and
op_logical_neg
id|severely_err_sec
)paren
(brace
id|board-&gt;deg_cumulated_errors
op_add_assign
id|code_violations
suffix:semicolon
id|board-&gt;deg_elapsed_seconds
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;deg_elapsed_seconds
op_ge
l_int|60
)paren
(brace
r_if
c_cond
(paren
id|board-&gt;deg_cumulated_errors
op_ge
l_int|123
)paren
id|curr_int-&gt;degraded_mins
op_increment
suffix:semicolon
id|board-&gt;deg_cumulated_errors
op_assign
l_int|0
suffix:semicolon
id|board-&gt;deg_elapsed_seconds
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|board-&gt;elapsed_seconds
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;elapsed_seconds
op_ge
l_int|900
)paren
(brace
id|board-&gt;current_interval
op_assign
(paren
id|board-&gt;current_interval
op_plus
l_int|1
)paren
op_mod
id|SLICECOM_BOARD_INTERVALS_SIZE
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|board-&gt;intervals
(braket
id|board-&gt;current_interval
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|e1_stats_t
)paren
)paren
suffix:semicolon
id|board-&gt;elapsed_seconds
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|pcicom_modemline
r_static
r_void
id|pcicom_modemline
c_func
(paren
r_int
r_int
id|b
)paren
(brace
id|munich_board_t
op_star
id|board
op_assign
(paren
id|munich_board_t
op_star
)paren
id|b
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|board-&gt;twins
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|regs
suffix:semicolon
id|regs
op_assign
id|readl
c_func
(paren
(paren
r_void
op_star
)paren
(paren
op_amp
id|board-&gt;bar1
(braket
id|GPDATA
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;line_status
op_amp
id|LINE_UP
)paren
op_logical_and
(paren
id|regs
op_amp
l_int|0x0800
)paren
)paren
(brace
id|ch-&gt;line_status
op_and_assign
op_complement
id|LINE_UP
suffix:semicolon
id|board-&gt;lineup
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;LINE_status
)paren
(brace
id|ch
op_member_access_from_pointer
id|LINE_status
c_func
(paren
id|dev
comma
id|ch-&gt;line_status
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;line_status
op_amp
id|LINE_UP
)paren
op_logical_and
op_logical_neg
(paren
id|regs
op_amp
l_int|0x0800
)paren
)paren
(brace
id|ch-&gt;line_status
op_or_assign
id|LINE_UP
suffix:semicolon
id|board-&gt;lineup
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;LINE_status
)paren
(brace
id|ch
op_member_access_from_pointer
id|LINE_status
c_func
(paren
id|dev
comma
id|ch-&gt;line_status
)paren
suffix:semicolon
)brace
)brace
id|mod_timer
c_func
(paren
(paren
r_struct
id|timer_list
op_star
)paren
op_amp
id|board-&gt;modemline_timer
comma
id|jiffies
op_plus
id|HZ
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Is it possible to transmit ?&n; * Called (may be called) by the protocol layer &n; */
DECL|function|MUNICH_txe
r_static
r_int
id|MUNICH_txe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
r_return
(paren
id|hw-&gt;busy
OL
id|TX_DESC_MAX
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Hw probe function. Detects all the boards in the system,&n; * and fills up slicecom_boards[] and pcicom_boards[]&n; * Returns 0 on success.&n; * We do not disable interrupts!&n; */
DECL|function|munich_probe
r_static
r_int
id|munich_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci
suffix:semicolon
r_int
id|boardnum
suffix:semicolon
r_int
id|slicecom_boardnum
suffix:semicolon
r_int
id|pcicom_boardnum
suffix:semicolon
id|u32
op_star
id|bar1
suffix:semicolon
id|u8
op_star
id|lbi
suffix:semicolon
id|munich_board_t
op_star
id|board
suffix:semicolon
r_for
c_loop
(paren
id|boardnum
op_assign
l_int|0
suffix:semicolon
id|boardnum
OL
id|MAX_BOARDS
suffix:semicolon
id|boardnum
op_increment
)paren
(brace
id|pcicom_boards
(braket
id|boardnum
)braket
dot
id|pci
op_assign
l_int|0
suffix:semicolon
id|pcicom_boards
(braket
id|boardnum
)braket
dot
id|bar1
op_assign
l_int|0
suffix:semicolon
id|pcicom_boards
(braket
id|boardnum
)braket
dot
id|lbi
op_assign
l_int|0
suffix:semicolon
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|pci
op_assign
l_int|0
suffix:semicolon
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|bar1
op_assign
l_int|0
suffix:semicolon
id|slicecom_boards
(braket
id|boardnum
)braket
dot
id|lbi
op_assign
l_int|0
suffix:semicolon
)brace
id|pci
op_assign
l_int|NULL
suffix:semicolon
id|board
op_assign
l_int|NULL
suffix:semicolon
id|slicecom_boardnum
op_assign
l_int|0
suffix:semicolon
id|pcicom_boardnum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|boardnum
op_assign
l_int|0
suffix:semicolon
id|boardnum
OL
id|MAX_BOARDS
op_logical_and
(paren
id|pci
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SIEMENS
comma
id|PCI_DEVICE_ID_SIEMENS_MUNICH32X
comma
id|pci
)paren
)paren
suffix:semicolon
id|boardnum
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pci
)paren
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;munich_probe: munich chip found, IRQ %d&bslash;n&quot;
comma
id|pci-&gt;irq
)paren
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &lt; 0x02030d)
id|bar1
op_assign
id|ioremap_nocache
c_func
(paren
id|pci-&gt;base_address
(braket
l_int|0
)braket
comma
l_int|0x100
)paren
suffix:semicolon
id|lbi
op_assign
id|ioremap_nocache
c_func
(paren
id|pci-&gt;base_address
(braket
l_int|1
)braket
comma
l_int|0x100
)paren
suffix:semicolon
macro_line|#else
id|bar1
op_assign
id|ioremap_nocache
c_func
(paren
id|pci-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
l_int|0x100
)paren
suffix:semicolon
id|lbi
op_assign
id|ioremap_nocache
c_func
(paren
id|pci-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
l_int|0x100
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|bar1
op_logical_and
id|lbi
)paren
(brace
id|pci_write_config_dword
c_func
(paren
id|pci
comma
id|MUNICH_PCI_PCIRES
comma
l_int|0xe0000
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pci
comma
id|MUNICH_PCI_PCIRES
comma
l_int|0
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* check the type of the card */
id|writel
c_func
(paren
id|LREG0_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG0
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG1_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG1
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG2_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG2
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG3_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG3
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG4_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG4
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG5_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG5
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LCONF_MAGIC2
comma
id|MUNICH_VIRT
c_func
(paren
id|LCONF
)paren
)paren
suffix:semicolon
multiline_comment|/* enable the DMSM */
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|VSTR
)paren
op_eq
l_int|0x13
)paren
op_logical_or
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|VSTR
)paren
op_eq
l_int|0x10
)paren
)paren
(brace
id|board
op_assign
id|slicecom_boards
op_plus
id|slicecom_boardnum
suffix:semicolon
id|sprintf
c_func
(paren
(paren
r_char
op_star
)paren
id|board-&gt;devname
comma
l_string|&quot;slicecom%d&quot;
comma
id|slicecom_boardnum
)paren
suffix:semicolon
id|board-&gt;isx21
op_assign
l_int|0
suffix:semicolon
id|slicecom_boardnum
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|VSTR
)paren
op_eq
l_int|0x6
)paren
op_logical_or
(paren
id|readb
c_func
(paren
id|lbi
op_plus
id|GIS
)paren
op_eq
l_int|0x6
)paren
)paren
(brace
id|board
op_assign
id|pcicom_boards
op_plus
id|pcicom_boardnum
suffix:semicolon
id|sprintf
c_func
(paren
(paren
r_char
op_star
)paren
id|board-&gt;devname
comma
l_string|&quot;pcicom%d&quot;
comma
id|pcicom_boardnum
)paren
suffix:semicolon
id|board-&gt;isx21
op_assign
l_int|1
suffix:semicolon
id|pcicom_boardnum
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|board
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;munich_probe: %s board found&bslash;n&quot;
comma
id|board-&gt;devname
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LCONF_MAGIC1
comma
id|MUNICH_VIRT
c_func
(paren
id|LCONF
)paren
)paren
suffix:semicolon
multiline_comment|/* reset the DMSM */
id|board-&gt;pci
op_assign
id|pci
suffix:semicolon
id|board-&gt;bar1
op_assign
id|bar1
suffix:semicolon
id|board-&gt;lbi
op_assign
id|lbi
suffix:semicolon
id|board-&gt;framing
op_assign
id|SLICECOM_FRAMING_DEFAULT
suffix:semicolon
id|board-&gt;linecode
op_assign
id|SLICECOM_LINECODE_DEFAULT
suffix:semicolon
id|board-&gt;clock_source
op_assign
id|SLICECOM_CLOCK_SOURCE_DEFAULT
suffix:semicolon
id|board-&gt;loopback
op_assign
id|SLICECOM_LOOPBACK_DEFAULT
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|board
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;munich_probe: Board error, VSTR: %02X&bslash;n&quot;
comma
id|readb
c_func
(paren
id|lbi
op_plus
id|VSTR
)paren
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|bar1
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|lbi
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;munich_probe: ioremap() failed, not enabling this board!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* .pci = NULL, so the MUNICH_open will not try to open it            */
r_if
c_cond
(paren
id|bar1
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|bar1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lbi
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|lbi
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|pci
op_logical_and
op_logical_neg
id|boardnum
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;munich_probe: no PCI present!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcicom_boardnum
op_plus
id|slicecom_boardnum
op_eq
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;munich_probe: Couldn&squot;t find any munich board: vendor:device %x:%x not found&bslash;n&quot;
comma
id|PCI_VENDOR_ID_SIEMENS
comma
id|PCI_DEVICE_ID_SIEMENS_MUNICH32X
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Found some */
r_if
c_cond
(paren
id|pcicom_boardnum
)paren
id|printk
c_func
(paren
l_string|&quot;%d pcicom board(s) found.&bslash;n&quot;
comma
id|pcicom_boardnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slicecom_boardnum
)paren
id|printk
c_func
(paren
l_string|&quot;%d slicecom board(s) found.&bslash;n&quot;
comma
id|slicecom_boardnum
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Reset the hardware. Get called only from within this module if needed.&n; */
macro_line|#if 0
r_static
r_int
id|slicecom_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;slicecom_reset: resetting the hardware&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Begin to reset the hardware */
r_if
c_cond
(paren
id|ch-&gt;HW_set_clock
)paren
id|ch
op_member_access_from_pointer
id|HW_set_clock
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* And finish it */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* &n; * Transmit a packet. &n; * Called by the protocol layer&n; * Return values:&t;&n; *&t;FRAME_ACCEPTED:&t;frame is being transmited, transmitter is busy&n; *&t;FRAME_QUEUED:&t;frame is being transmitted, there&squot;s more room in&n; *&t;&t;&t;&t;the transmitter for additional packet(s)&n; *&t;FRAME_ERROR:&n; *&t;FRAME_DROPPED:&t;there was some error&n; */
DECL|function|MUNICH_send_packet
r_static
r_int
id|MUNICH_send_packet
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
(paren
r_struct
id|comx_channel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
multiline_comment|/* Send it to the debug facility too if needed: */
r_if
c_cond
(paren
id|ch-&gt;debug_flags
op_amp
id|DEBUG_HW_TX
)paren
id|comx_debug_bytes
c_func
(paren
id|dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_string|&quot;MUNICH_send_packet&quot;
)paren
suffix:semicolon
multiline_comment|/* If the line is inactive, don&squot;t accept: */
multiline_comment|/* TODO: atgondolni hogy mi is legyen itt */
multiline_comment|/* if (!(ch-&gt;line_status &amp; LINE_UP)) return FRAME_DROPPED; */
multiline_comment|/* More check, to be sure: */
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|TXBUFFER_SIZE
)paren
(brace
id|ch-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|FRAME_ERROR
suffix:semicolon
)brace
multiline_comment|/* Maybe you have to disable irq&squot;s while programming the hw: */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* And more check: */
r_if
c_cond
(paren
id|hw-&gt;busy
op_ge
id|TX_DESC_MAX
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Transmitter called while busy... dropping frame, busy = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|hw-&gt;busy
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|FRAME_DROPPED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw-&gt;busy
op_ge
l_int|0
)paren
id|hw-&gt;tx_ring_hist
(braket
id|hw-&gt;busy
)braket
op_increment
suffix:semicolon
multiline_comment|/* DELL: */
r_else
id|printk
c_func
(paren
l_string|&quot;slicecom: %s: FATAL: busy = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|hw-&gt;busy
)paren
suffix:semicolon
singleline_comment|//              /* DEL: */
singleline_comment|//      printk(&quot;slicecom: %s: _send_packet called, busy = %d&bslash;n&quot;, dev-&gt;name, hw-&gt;busy );
multiline_comment|/* Packet can go, update stats: */
id|ch-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|ch-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Pass the packet to the HW:                   */
multiline_comment|/* Step forward with the transmit descriptors:  */
id|hw-&gt;tx_desc_ptr
op_assign
(paren
id|hw-&gt;tx_desc_ptr
op_plus
l_int|1
)paren
op_mod
id|TX_DESC_MAX
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|hw-&gt;tx_data
(braket
id|hw-&gt;tx_desc_ptr
)braket
(braket
l_int|0
)braket
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|hw-&gt;tx_desc
(braket
id|hw-&gt;tx_desc_ptr
)braket
dot
id|no
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* We don&squot;t issue any command, just step with the HOLD bit      */
id|hw-&gt;tx_desc
(braket
id|hw-&gt;tx_desc_ptr
)braket
dot
id|hold
op_assign
l_int|1
suffix:semicolon
id|hw-&gt;tx_desc
(braket
(paren
id|hw-&gt;tx_desc_ptr
op_plus
id|TX_DESC_MAX
op_minus
l_int|1
)paren
op_mod
id|TX_DESC_MAX
)braket
dot
id|hold
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef COMX_NEW
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* csomag kerult a Tx ringbe: */
id|hw-&gt;busy
op_increment
suffix:semicolon
multiline_comment|/* Report it: */
r_if
c_cond
(paren
id|ch-&gt;debug_flags
op_amp
id|DEBUG_HW_TX
)paren
id|comx_debug
c_func
(paren
id|dev
comma
l_string|&quot;%s: MUNICH_send_packet was successful&bslash;n&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;busy
op_ge
id|TX_DESC_MAX
op_minus
l_int|1
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|FRAME_ACCEPTED
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* All done */
r_return
id|FRAME_QUEUED
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt handler routine.&n; * Called by the Linux kernel.&n; * BEWARE! The interrupts are enabled on the call!&n; */
DECL|function|MUNICH_interrupt
r_static
r_void
id|MUNICH_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|length
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_int
id|work
suffix:semicolon
multiline_comment|/* hany esemenyt kezeltem mar le                                */
id|u32
op_star
id|bar1
suffix:semicolon
id|u8
op_star
id|lbi
suffix:semicolon
id|u32
id|stat
comma
multiline_comment|/* az esemenyek, amiket a ebben a loop korben le kell meg kezelni       */
id|race_stat
op_assign
l_int|0
comma
multiline_comment|/* race eseten ebben uzenek magamnak hogy mit kell meg lekezelni        */
id|ack
suffix:semicolon
multiline_comment|/* ezt fogom a vegen a STAT-ba irni, kiveszek belole 1-1 bitet ha       */
multiline_comment|/* az adott dolgot nem kell ack-olni mert volt vele munkam, es  */
multiline_comment|/* legjobb ha visszaterek ide megegyszer                        */
id|munich_intq_t
id|int_info
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|comx_channel
op_star
id|ch
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
suffix:semicolon
id|munich_board_t
op_star
id|board
op_assign
(paren
id|munich_board_t
op_star
)paren
id|dev_id
suffix:semicolon
r_int
id|channel
suffix:semicolon
singleline_comment|//      , boardnum = (int)dev_id;
singleline_comment|// board = munich_boards + boardnum;
id|bar1
op_assign
id|board-&gt;bar1
suffix:semicolon
id|lbi
op_assign
id|board-&gt;lbi
suffix:semicolon
singleline_comment|//      Do not uncomment this under heavy load! :-&gt;
singleline_comment|//      printk(&quot;MUNICH_interrupt: masked STAT=0x%08x, tiq=0x%08x, riq=0x%08x, piq=0x%08x&bslash;n&quot;, stat, board-&gt;tiq[0].all, board-&gt;riq[0].all, board-&gt;piq[0].all );
r_for
c_loop
(paren
id|work
op_assign
l_int|0
suffix:semicolon
(paren
id|stat
op_assign
(paren
id|race_stat
op_or
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
op_complement
id|STAT_NOT_HANDLED_BY_INTERRUPT
)paren
)paren
)paren
op_logical_and
(paren
id|work
OL
id|MAX_WORK
op_minus
l_int|1
)paren
suffix:semicolon
id|work
op_increment
)paren
(brace
id|ack
op_assign
id|stat
op_amp
(paren
id|STAT_PRI
op_or
id|STAT_PTI
op_or
id|STAT_LBII
)paren
suffix:semicolon
multiline_comment|/* Handle the interrupt information in the Rx queue. We don&squot;t really trust      */
multiline_comment|/* info from this queue, because it can be overflowed, so later check           */
multiline_comment|/* every Rx ring for received packets. But there are some errors which can&squot;t    */
multiline_comment|/* be counted from the Rx rings, so we parse it.                                        */
id|int_info
op_assign
id|board-&gt;riq
(braket
id|board-&gt;riq_ptr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|int_info.all
op_amp
l_int|0xF0000000
)paren
multiline_comment|/* ha ez nem 0, akkor itt interrupt_info van                    */
(brace
id|ack
op_and_assign
op_complement
id|STAT_PRI
suffix:semicolon
multiline_comment|/* don&squot;t ack the interrupt, we had some work to do              */
id|channel
op_assign
id|PCM_INT_CHANNEL
c_func
(paren
id|int_info.all
)paren
suffix:semicolon
id|dev
op_assign
id|board-&gt;twins
(braket
id|channel
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;MUNICH_interrupt: got an Rx interrupt info for NULL device &quot;
l_string|&quot;%s.twins[%d], int_info = 0x%08x&bslash;n&quot;
comma
id|board-&gt;devname
comma
id|channel
comma
id|int_info.all
)paren
suffix:semicolon
r_goto
id|go_for_next_interrupt
suffix:semicolon
)brace
id|ch
op_assign
(paren
r_struct
id|comx_channel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hw
op_assign
(paren
r_struct
id|slicecom_privdata
op_star
)paren
id|ch-&gt;HW_privdata
suffix:semicolon
singleline_comment|//      printk(&quot;Rx STAT=0x%08x int_info=0x%08x rx_desc_ptr=%d rx_desc.status=0x%01x&bslash;n&quot;,
singleline_comment|//              stat, int_info.all, hw-&gt;rx_desc_ptr, hw-&gt;rx_desc[ hw-&gt;rx_desc_ptr ].status );
r_if
c_cond
(paren
id|int_info.all
op_amp
id|PCM_INT_HI
)paren
id|printk
c_func
(paren
l_string|&quot;SliceCOM: %s: Host Initiated interrupt&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|int_info.all
op_amp
id|PCM_INT_IFC
)paren
id|printk
c_func
(paren
l_string|&quot;SliceCOM: %s: Idle/Flag Change&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* TOD: jo ez az Idle/Flag Change valamire? - azonnal latszik belole hogy mikor ad a masik oldal */
multiline_comment|/* TOD: ilyen IT most nem is jon, mert ki van maszkolva az interrupt, biztosan kell ez? */
r_if
c_cond
(paren
id|int_info.all
op_amp
id|PCM_INT_FO
)paren
multiline_comment|/* Internal buffer (RB) overrun */
id|ch-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
multiline_comment|/* TOD: Ez azt jelenti hogy a belso RB nem volt hozzaferheto, es ezert kihagyott valamit. De nem csak csomag lehetett, hanem esemeny, stb. is. lasd page 247. Ezzel a &squot;cat status&squot;-hoz igazodok, de a netdevice.h szerint nem egyertelmu hogy ide ez kellene. Nem lehet hogy rx_missed ? */
multiline_comment|/* DE: nem gotozok sehova, elvileg jo igy */
multiline_comment|/* kesobb meg visszaterek az FO-ra, ha packet-FO volt. Keresd a &quot;packet-FO&quot;-t. */
r_if
c_cond
(paren
id|int_info.all
op_amp
id|PCM_INT_FI
)paren
multiline_comment|/* frame received, but we do not trust the int_info queue       */
r_if
c_cond
(paren
id|int_info.all
op_amp
id|PCM_INT_SF
)paren
(brace
multiline_comment|/* Short Frame: rovidebb mint a CRC */
multiline_comment|/* &quot;rovidebb mint CRC+2byte&quot; vizsgalat a &quot;CRC+2&quot;-nel */
id|ch-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
multiline_comment|/* TOD: noveljem? ne noveljem? */
r_goto
id|go_for_next_interrupt
suffix:semicolon
)brace
id|go_for_next_interrupt
suffix:colon
multiline_comment|/* One step in the interrupt queue */
id|board-&gt;riq
(braket
id|board-&gt;riq_ptr
)braket
dot
id|all
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* megjelolom hogy itt meg nem jart a hw */
id|board-&gt;riq_ptr
op_assign
(paren
id|board-&gt;riq_ptr
op_plus
l_int|1
)paren
op_mod
id|MUNICH_INTQMAX
suffix:semicolon
)brace
multiline_comment|/* Check every Rx ring for incomed packets: */
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
OL
l_int|32
suffix:semicolon
id|channel
op_increment
)paren
(brace
id|dev
op_assign
id|board-&gt;twins
(braket
id|channel
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
(brace
id|ch
op_assign
(paren
r_struct
id|comx_channel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hw
op_assign
(paren
r_struct
id|slicecom_privdata
op_star
)paren
id|ch-&gt;HW_privdata
suffix:semicolon
id|rx_status
op_assign
id|hw-&gt;rx_desc
(braket
id|hw-&gt;rx_desc_ptr
)braket
dot
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rx_status
op_amp
l_int|0x80
)paren
)paren
multiline_comment|/* mar jart itt a hardver */
(brace
id|ack
op_and_assign
op_complement
id|STAT_PRI
suffix:semicolon
multiline_comment|/* Don&squot;t ack, we had some work          */
multiline_comment|/* Ez most egy kicsit zuros, mert itt mar nem latom az int_infot        */
r_if
c_cond
(paren
id|rx_status
op_amp
id|RX_STATUS_ROF
)paren
id|ch-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
multiline_comment|/* TOD: &squot;cat status&squot;-hoz igazodok */
r_if
c_cond
(paren
id|rx_status
op_amp
id|RX_STATUS_RA
)paren
multiline_comment|/* Abort received or issued on channel  */
id|ch-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
multiline_comment|/* or HOLD bit in the descriptor                */
multiline_comment|/* TOD: &squot;cat status&squot;-hoz igazodok */
r_if
c_cond
(paren
id|rx_status
op_amp
id|RX_STATUS_LFD
)paren
(brace
multiline_comment|/* Long Frame (longer then MFL in the MODE1) */
id|ch-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_goto
id|go_for_next_frame
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_status
op_amp
id|RX_STATUS_NOB
)paren
(brace
multiline_comment|/* Not n*8 bits long frame - frame alignment */
id|ch-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
multiline_comment|/* ez viszont nem igazodik a &squot;cat status&squot;-hoz */
r_goto
id|go_for_next_frame
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_status
op_amp
id|RX_STATUS_CRCO
)paren
(brace
multiline_comment|/* CRC error */
id|ch-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_goto
id|go_for_next_frame
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_status
op_amp
id|RX_STATUS_SF
)paren
(brace
multiline_comment|/* Short Frame: rovidebb mint CRC+2byte */
id|ch-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* The HW does not set PCI_INT_ERR bit for this one, see page 246 */
id|ch-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_goto
id|go_for_next_frame
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_status
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SliceCOM: %s: unhandled rx_status: 0x%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rx_status
)paren
suffix:semicolon
r_goto
id|go_for_next_frame
suffix:semicolon
)brace
multiline_comment|/* frame received without errors: */
id|length
op_assign
id|hw-&gt;rx_desc
(braket
id|hw-&gt;rx_desc_ptr
)braket
dot
id|bno
suffix:semicolon
id|ch-&gt;stats.rx_packets
op_increment
suffix:semicolon
multiline_comment|/* Count only &squot;good&squot; packets */
id|ch-&gt;stats.rx_bytes
op_add_assign
id|length
suffix:semicolon
multiline_comment|/* Allocate a larger skb and reserve the heading for efficiency: */
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|length
op_plus
l_int|16
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ch-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_goto
id|go_for_next_frame
suffix:semicolon
)brace
multiline_comment|/* Do bookkeeping: */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|16
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Now copy the data into the buffer: */
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
op_amp
(paren
id|hw-&gt;rx_data
(braket
id|hw-&gt;rx_desc_ptr
)braket
(braket
l_int|0
)braket
)paren
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* DEL: UGLY HACK!!!! */
r_if
c_cond
(paren
op_star
(paren
(paren
r_int
op_star
)paren
id|skb-&gt;data
)paren
op_eq
l_int|0x02000000
op_logical_and
op_star
(paren
(paren
(paren
r_int
op_star
)paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
op_eq
l_int|0x3580008f
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: swapping hack&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
op_star
(paren
(paren
r_int
op_star
)paren
id|skb-&gt;data
)paren
op_assign
l_int|0x3580008f
suffix:semicolon
op_star
(paren
(paren
(paren
r_int
op_star
)paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
op_assign
l_int|0x02000000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch-&gt;debug_flags
op_amp
id|DEBUG_HW_RX
)paren
id|comx_debug_skb
c_func
(paren
id|dev
comma
id|skb
comma
l_string|&quot;MUNICH_interrupt receiving&quot;
)paren
suffix:semicolon
multiline_comment|/* Pass it to the protocol entity: */
id|ch
op_member_access_from_pointer
id|LINE_rx
c_func
(paren
id|dev
comma
id|skb
)paren
suffix:semicolon
id|go_for_next_frame
suffix:colon
multiline_comment|/* DEL: rafutott-e a HOLD bitre -detektalas */
(brace
r_if
c_cond
(paren
(paren
(paren
id|rx_desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|board-&gt;ccb-&gt;current_rx_desc
(braket
id|channel
)braket
)paren
)paren
op_member_access_from_pointer
id|hold
op_logical_and
(paren
(paren
id|rx_desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|board-&gt;ccb-&gt;current_rx_desc
(braket
id|channel
)braket
)paren
)paren
op_member_access_from_pointer
id|status
op_ne
l_int|0xff
)paren
(brace
id|hw-&gt;rafutott
op_increment
suffix:semicolon
)brace
multiline_comment|/* rafutott: hanyszor volt olyan hogy a current descriptoron HOLD bit volt, es a hw mar befejezte az irast (azaz a hw rafutott a HOLD bitre) */
)brace
singleline_comment|//      if( jiffies % 2 )               /* DELL: okozzunk egy kis Rx ring slipet :) */
singleline_comment|//      {
multiline_comment|/* Step forward with the receive descriptors: */
multiline_comment|/* if you change this, change the copy of it below too! Search for: &quot;RxSlip&quot; */
id|hw-&gt;rx_desc
(braket
(paren
id|hw-&gt;rx_desc_ptr
op_plus
id|RX_DESC_MAX
op_minus
l_int|1
)paren
op_mod
id|RX_DESC_MAX
)braket
dot
id|hold
op_assign
l_int|1
suffix:semicolon
id|hw-&gt;rx_desc
(braket
id|hw-&gt;rx_desc_ptr
)braket
dot
id|status
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* megjelolom hogy itt meg nem jart a hw */
id|hw-&gt;rx_desc
(braket
(paren
id|hw-&gt;rx_desc_ptr
op_plus
id|RX_DESC_MAX
op_minus
l_int|2
)paren
op_mod
id|RX_DESC_MAX
)braket
dot
id|hold
op_assign
l_int|0
suffix:semicolon
id|hw-&gt;rx_desc_ptr
op_assign
(paren
id|hw-&gt;rx_desc_ptr
op_plus
l_int|1
)paren
op_mod
id|RX_DESC_MAX
suffix:semicolon
singleline_comment|//      }
)brace
)brace
)brace
id|stat
op_and_assign
op_complement
id|STAT_PRI
suffix:semicolon
singleline_comment|//      }
singleline_comment|//      if( stat &amp; STAT_PTI )   /* TOD: primko megvalositas: mindig csak egy esemenyt dolgozok fel, */
multiline_comment|/* es nem torlom a STAT-ot, ezert ujra visszajon ide a rendszer. Amikor */
multiline_comment|/* jon interrupt, de nincs mit feldolgozni, akkor torlom a STAT-ot.     */
multiline_comment|/* &squot;needs a rewrite&squot;, de elso megoldasnak jo lesz                       */
singleline_comment|//              {
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
id|int_info
op_assign
id|board-&gt;tiq
(braket
id|board-&gt;tiq_ptr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|int_info.all
op_amp
l_int|0xF0000000
)paren
multiline_comment|/* ha ez nem 0, akkor itt interrupt_info van    */
(brace
id|ack
op_and_assign
op_complement
id|STAT_PTI
suffix:semicolon
multiline_comment|/* don&squot;t ack the interrupt, we had some work to do      */
id|channel
op_assign
id|PCM_INT_CHANNEL
c_func
(paren
id|int_info.all
)paren
suffix:semicolon
id|dev
op_assign
id|board-&gt;twins
(braket
id|channel
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MUNICH_interrupt: got a Tx interrupt for NULL device &quot;
l_string|&quot;%s.twins[%d], int_info = 0x%08x&bslash;n&quot;
comma
id|board-&gt;isx21
ques
c_cond
l_string|&quot;pcicom&quot;
suffix:colon
l_string|&quot;slicecom&quot;
comma
id|channel
comma
id|int_info.all
)paren
suffix:semicolon
r_goto
id|go_for_next_tx_interrupt
suffix:semicolon
)brace
id|ch
op_assign
(paren
r_struct
id|comx_channel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hw
op_assign
(paren
r_struct
id|slicecom_privdata
op_star
)paren
id|ch-&gt;HW_privdata
suffix:semicolon
singleline_comment|//      printk(&quot;Tx STAT=0x%08x int_info=0x%08x tiq_ptr=%d&bslash;n&quot;, stat, int_info.all, board-&gt;tiq_ptr );
r_if
c_cond
(paren
id|int_info.all
op_amp
id|PCM_INT_FE2
)paren
(brace
multiline_comment|/* &quot;Tx available&quot;                               */
multiline_comment|/* do nothing */
)brace
r_else
r_if
c_cond
(paren
id|int_info.all
op_amp
id|PCM_INT_FO
)paren
(brace
multiline_comment|/* Internal buffer (RB) overrun */
id|ch-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;slicecom: %s: unhandled Tx int_info: 0x%08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|int_info.all
)paren
suffix:semicolon
)brace
id|go_for_next_tx_interrupt
suffix:colon
id|board-&gt;tiq
(braket
id|board-&gt;tiq_ptr
)braket
dot
id|all
op_assign
l_int|0
suffix:semicolon
id|board-&gt;tiq_ptr
op_assign
(paren
id|board-&gt;tiq_ptr
op_plus
l_int|1
)paren
op_mod
id|MUNICH_INTQMAX
suffix:semicolon
)brace
multiline_comment|/* Check every Tx ring for incoming packets: */
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
OL
l_int|32
suffix:semicolon
id|channel
op_increment
)paren
(brace
id|dev
op_assign
id|board-&gt;twins
(braket
id|channel
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
(brace
r_int
id|newbusy
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|comx_channel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|hw
op_assign
(paren
r_struct
id|slicecom_privdata
op_star
)paren
id|ch-&gt;HW_privdata
suffix:semicolon
multiline_comment|/* We dont trust the &quot;Tx available&quot; info from the TIQ, but check        */
multiline_comment|/* every ring if there is some free room                                        */
r_if
c_cond
(paren
id|ch-&gt;init_status
op_logical_and
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|newbusy
op_assign
(paren
id|TX_DESC_MAX
op_plus
(paren
op_amp
id|hw-&gt;tx_desc
(braket
id|hw-&gt;tx_desc_ptr
)braket
)paren
op_minus
(paren
id|tx_desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|board-&gt;ccb-&gt;current_tx_desc
(braket
id|hw-&gt;channel
)braket
)paren
)paren
op_mod
id|TX_DESC_MAX
suffix:semicolon
r_if
c_cond
(paren
id|newbusy
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;slicecom: %s: FATAL: fresly computed busy = %d, HW: 0x%p, SW: 0x%p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|newbusy
comma
id|phys_to_virt
c_func
(paren
id|board-&gt;ccb-&gt;current_tx_desc
(braket
id|hw-&gt;channel
)braket
)paren
comma
op_amp
id|hw-&gt;tx_desc
(braket
id|hw-&gt;tx_desc_ptr
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Fogyott valami a Tx ringbol? */
r_if
c_cond
(paren
id|newbusy
OL
id|hw-&gt;busy
)paren
(brace
singleline_comment|// ack &amp;= ~STAT_PTI;                            /* Don&squot;t ack, we had some work  */
id|hw-&gt;busy
op_assign
id|newbusy
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;LINE_tx
)paren
id|ch
op_member_access_from_pointer
id|LINE_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Report it to protocol driver */
)brace
r_else
r_if
c_cond
(paren
id|newbusy
OG
id|hw-&gt;busy
)paren
id|printk
c_func
(paren
l_string|&quot;slicecom: %s: newbusy &gt; hw-&gt;busy, this should not happen!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
id|stat
op_and_assign
op_complement
id|STAT_PTI
suffix:semicolon
id|int_info
op_assign
id|board-&gt;piq
(braket
id|board-&gt;piq_ptr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|int_info.all
op_amp
l_int|0xF0000000
)paren
multiline_comment|/* ha ez nem 0, akkor itt interrupt_info van            */
(brace
id|ack
op_and_assign
op_complement
id|STAT_LBII
suffix:semicolon
multiline_comment|/* don&squot;t ack the interrupt, we had some work to do      */
multiline_comment|/* We do not really use (yet) the interrupt info from this queue, */
singleline_comment|// printk(&quot;slicecom: %s: LBI Interrupt event: %08x&bslash;n&quot;, board-&gt;devname, int_info.all);
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;isx21
)paren
(brace
id|slicecom_update_leds
c_func
(paren
id|board
)paren
suffix:semicolon
id|slicecom_update_line_counters
c_func
(paren
id|board
)paren
suffix:semicolon
)brace
r_goto
id|go_for_next_lbi_interrupt
suffix:semicolon
multiline_comment|/* To avoid warning about unused label  */
id|go_for_next_lbi_interrupt
suffix:colon
multiline_comment|/* One step in the interrupt queue */
id|board-&gt;piq
(braket
id|board-&gt;piq_ptr
)braket
dot
id|all
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* megjelolom hogy itt meg nem jart a hw        */
id|board-&gt;piq_ptr
op_assign
(paren
id|board-&gt;piq_ptr
op_plus
l_int|1
)paren
op_mod
id|MUNICH_PIQMAX
suffix:semicolon
)brace
id|stat
op_and_assign
op_complement
id|STAT_LBII
suffix:semicolon
id|writel
c_func
(paren
id|ack
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_TSPA
)paren
(brace
singleline_comment|//      printk(&quot;slicecom: %s: PCM TSP Asynchronous&bslash;n&quot;, board-&gt;devname);
id|writel
c_func
(paren
id|STAT_TSPA
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
id|stat
op_and_assign
op_complement
id|STAT_TSPA
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_RSPA
)paren
(brace
singleline_comment|//      printk(&quot;slicecom: %s: PCM RSP Asynchronous&bslash;n&quot;, board-&gt;devname);
id|writel
c_func
(paren
id|STAT_RSPA
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
id|stat
op_and_assign
op_complement
id|STAT_RSPA
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MUNICH_interrupt: unhandled interrupt, STAT=0x%08x&bslash;n&quot;
comma
id|stat
)paren
suffix:semicolon
id|writel
c_func
(paren
id|stat
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
multiline_comment|/* ha valamit megsem kezeltunk le, azert ack-ot kuldunk neki */
)brace
)brace
id|board-&gt;histogram
(braket
id|work
)braket
op_increment
suffix:semicolon
multiline_comment|/* We can miss these if we reach the MAX_WORK   */
multiline_comment|/* Count it to see how often it happens         */
r_if
c_cond
(paren
id|race_stat
op_amp
id|STAT_PRI
)paren
id|board-&gt;stat_pri_races_missed
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|race_stat
op_amp
id|STAT_PTI
)paren
id|board-&gt;stat_pti_races_missed
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &n; * Hardware open routine.&n; * Called by comx (upper) layer when the user wants to bring up the interface&n; * with ifconfig.&n; * Initializes hardware, allocates resources etc.&n; * Returns 0 on OK, or standard error value on error.&n; */
DECL|function|MUNICH_open
r_static
r_int
id|MUNICH_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|procfile
op_assign
id|ch-&gt;procdir-&gt;subdir
suffix:semicolon
id|munich_board_t
op_star
id|board
suffix:semicolon
id|munich_ccb_t
op_star
id|ccb
suffix:semicolon
id|u32
op_star
id|bar1
suffix:semicolon
id|u8
op_star
id|lbi
suffix:semicolon
id|u32
id|stat
suffix:semicolon
r_int
r_int
id|flags
comma
id|jiffs
suffix:semicolon
r_int
id|i
comma
id|channel
suffix:semicolon
id|u32
id|timeslots
op_assign
id|hw-&gt;timeslots
suffix:semicolon
id|board
op_assign
id|hw-&gt;boardnum
op_plus
(paren
id|ch-&gt;hardware
op_eq
op_amp
id|pcicomhw
ques
c_cond
id|pcicom_boards
suffix:colon
id|slicecom_boards
)paren
suffix:semicolon
id|bar1
op_assign
id|board-&gt;bar1
suffix:semicolon
id|lbi
op_assign
id|board-&gt;lbi
suffix:semicolon
multiline_comment|/* TODO: a timeslotok ellenorzese kell majd ide .. hat, biztos? mar a write_proc-ban is&n;       ellenorzom valamennyire.&n;       if (!dev-&gt;io || !dev-&gt;irq) return -ENODEV;&n;     */
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;pci
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MUNICH_open: no %s board with boardnum = %d&bslash;n&quot;
comma
id|ch-&gt;hardware-&gt;name
comma
id|hw-&gt;boardnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* lock the section to avoid race with multiple opens and make sure&n;       that no interrupts get called while this lock is active */
r_if
c_cond
(paren
id|board-&gt;use_count
op_eq
l_int|0
)paren
multiline_comment|/* bring up the board if it was unused                  */
multiline_comment|/* if fails, frees allocated resources and returns.     */
multiline_comment|/* TOD: is it safe? nem kellene resetelni a kartyat?    */
(brace
id|printk
c_func
(paren
l_string|&quot;MUNICH_open: %s: bringing up board&bslash;n&quot;
comma
id|board-&gt;devname
)paren
suffix:semicolon
multiline_comment|/* Clean up the board&squot;s static struct if messed: */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|board-&gt;twins
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_WORK
suffix:semicolon
id|i
op_increment
)paren
id|board-&gt;histogram
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|board-&gt;lineup
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allocate CCB: */
id|board-&gt;ccb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|munich_ccb_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;ccb
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;ccb
comma
l_int|0
comma
r_sizeof
(paren
id|munich_ccb_t
)paren
)paren
suffix:semicolon
id|board-&gt;ccb-&gt;csa
op_assign
id|virt_to_phys
c_func
(paren
id|board-&gt;ccb
)paren
suffix:semicolon
id|ccb
op_assign
id|board-&gt;ccb
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|tti
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|rti
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Interrupt queues: */
id|board-&gt;tiq
op_assign
id|kmalloc
c_func
(paren
id|MUNICH_INTQSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;tiq
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;tiq
comma
l_int|0
comma
id|MUNICH_INTQSIZE
)paren
suffix:semicolon
id|board-&gt;riq
op_assign
id|kmalloc
c_func
(paren
id|MUNICH_INTQSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;riq
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;riq
comma
l_int|0
comma
id|MUNICH_INTQSIZE
)paren
suffix:semicolon
id|board-&gt;piq
op_assign
id|kmalloc
c_func
(paren
id|MUNICH_PIQSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;piq
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;piq
comma
l_int|0
comma
id|MUNICH_PIQSIZE
)paren
suffix:semicolon
id|board-&gt;tiq_ptr
op_assign
l_int|0
suffix:semicolon
id|board-&gt;riq_ptr
op_assign
l_int|0
suffix:semicolon
id|board-&gt;piq_ptr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Request irq: */
id|board-&gt;irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (char*) cast to avoid warning about discarding volatile:             */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|board-&gt;pci-&gt;irq
comma
id|MUNICH_interrupt
comma
l_int|0
comma
(paren
r_char
op_star
)paren
id|board-&gt;devname
comma
(paren
r_void
op_star
)paren
id|board
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MUNICH_open: %s: unable to obtain irq %d&bslash;n&quot;
comma
id|board-&gt;devname
comma
id|board-&gt;pci-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* TOD: free other resources (a sok malloc feljebb)                     */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|board-&gt;irq
op_assign
id|board-&gt;pci-&gt;irq
suffix:semicolon
multiline_comment|/* csak akkor legyen != 0, ha tenyleg le van foglalva nekunk */
multiline_comment|/* Programming device: */
multiline_comment|/* Reset the board like a power-on: */
multiline_comment|/* TOD:&n;&t;   - It is not a real power-on: if a DMA transaction fails with master abort, the board&n;&t;   stays in half-dead state.&n;&t;   - It doesn&squot;t reset the FALC line driver */
id|pci_write_config_dword
c_func
(paren
id|board-&gt;pci
comma
id|MUNICH_PCI_PCIRES
comma
l_int|0xe0000
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|board-&gt;pci
comma
id|MUNICH_PCI_PCIRES
comma
l_int|0
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|virt_to_phys
c_func
(paren
op_amp
id|ccb-&gt;csa
)paren
comma
id|MUNICH_VIRT
c_func
(paren
id|CCBA
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|virt_to_phys
c_func
(paren
id|board-&gt;tiq
)paren
comma
id|MUNICH_VIRT
c_func
(paren
id|TIQBA
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MUNICH_INTQLEN
comma
id|MUNICH_VIRT
c_func
(paren
id|TIQL
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|virt_to_phys
c_func
(paren
id|board-&gt;riq
)paren
comma
id|MUNICH_VIRT
c_func
(paren
id|RIQBA
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MUNICH_INTQLEN
comma
id|MUNICH_VIRT
c_func
(paren
id|RIQL
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|virt_to_phys
c_func
(paren
id|board-&gt;piq
)paren
comma
id|MUNICH_VIRT
c_func
(paren
id|PIQBA
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MUNICH_PIQLEN
comma
id|MUNICH_VIRT
c_func
(paren
id|PIQL
)paren
)paren
suffix:semicolon
multiline_comment|/* Put the magic values into the registers: */
id|writel
c_func
(paren
id|MODE1_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|MODE1
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MODE2_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|MODE2
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG0_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG0
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG1_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG1
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG2_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG2
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG3_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG3
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG4_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG4
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LREG5_MAGIC
comma
id|MUNICH_VIRT
c_func
(paren
id|LREG5
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LCONF_MAGIC1
comma
id|MUNICH_VIRT
c_func
(paren
id|LCONF
)paren
)paren
suffix:semicolon
multiline_comment|/* reset the DMSM */
id|writel
c_func
(paren
id|LCONF_MAGIC2
comma
id|MUNICH_VIRT
c_func
(paren
id|LCONF
)paren
)paren
suffix:semicolon
multiline_comment|/* enable the DMSM */
id|writel
c_func
(paren
op_complement
l_int|0
comma
id|MUNICH_VIRT
c_func
(paren
id|TXPOLL
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|board-&gt;isx21
ques
c_cond
l_int|0x1400
suffix:colon
l_int|0xa000
comma
id|MUNICH_VIRT
c_func
(paren
id|GPDIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
)paren
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
id|ccb-&gt;action_spec
op_assign
id|CCB_ACTIONSPEC_RES
op_or
id|CCB_ACTIONSPEC_IA
suffix:semicolon
id|writel
c_func
(paren
id|CMD_ARPCM
comma
id|MUNICH_VIRT
c_func
(paren
id|CMD
)paren
)paren
suffix:semicolon
multiline_comment|/* Start the PCM core reset */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|stat
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Wait for the action to complete max. 1 second */
id|jiffs
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|stat
op_assign
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
)paren
op_amp
(paren
id|STAT_PCMA
op_or
id|STAT_PCMF
)paren
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|jiffs
op_plus
id|HZ
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_PCMF
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MUNICH_open: %s: Initial ARPCM failed. STAT=0x%08x&bslash;n&quot;
comma
id|board-&gt;devname
comma
id|stat
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
id|STAT_PCMF
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|board-&gt;irq
comma
(paren
r_void
op_star
)paren
id|board
)paren
suffix:semicolon
multiline_comment|/* TOD: free other resources too */
multiline_comment|/* maybe shut down hw? */
id|board-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|STAT_PCMA
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MUNICH_open: %s: Initial ARPCM timeout. STAT=0x%08x&bslash;n&quot;
comma
id|board-&gt;devname
comma
id|stat
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|board-&gt;irq
comma
(paren
r_void
op_star
)paren
id|board
)paren
suffix:semicolon
multiline_comment|/* TOD: free other resources too */
multiline_comment|/* maybe shut off the hw? */
id|board-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
id|STAT_PCMA
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
multiline_comment|/* Acknowledge */
r_if
c_cond
(paren
id|board-&gt;isx21
)paren
id|writel
c_func
(paren
l_int|0
comma
id|MUNICH_VIRT
c_func
(paren
id|GPDATA
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MUNICH_open: %s: succesful HW-open took %ld jiffies&bslash;n&quot;
comma
id|board-&gt;devname
comma
id|jiffies
op_minus
id|jiffs
)paren
suffix:semicolon
multiline_comment|/* Set up the FALC hanging on the Local Bus: */
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;isx21
)paren
(brace
id|writeb
c_func
(paren
l_int|0x0e
comma
id|lbi
op_plus
id|FMR1
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|lbi
op_plus
id|LIM0
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xb0
comma
id|lbi
op_plus
id|LIM1
)paren
suffix:semicolon
multiline_comment|/* TODO: input threshold */
id|writeb
c_func
(paren
l_int|0xf7
comma
id|lbi
op_plus
id|XPM0
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x02
comma
id|lbi
op_plus
id|XPM1
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|lbi
op_plus
id|XPM2
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xf0
comma
id|lbi
op_plus
id|FMR0
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x80
comma
id|lbi
op_plus
id|PCD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x80
comma
id|lbi
op_plus
id|PCR
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|lbi
op_plus
id|LIM2
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x07
comma
id|lbi
op_plus
id|XC0
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x3d
comma
id|lbi
op_plus
id|XC1
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x05
comma
id|lbi
op_plus
id|RC0
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|lbi
op_plus
id|RC1
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x83
comma
id|lbi
op_plus
id|FMR2
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x9f
comma
id|lbi
op_plus
id|XSW
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x0f
comma
id|lbi
op_plus
id|XSP
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|lbi
op_plus
id|TSWM
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xe0
comma
id|lbi
op_plus
id|MODE
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xff
comma
id|lbi
op_plus
id|IDLE
)paren
suffix:semicolon
multiline_comment|/* Idle Code to send in unused timeslots        */
id|writeb
c_func
(paren
l_int|0x83
comma
id|lbi
op_plus
id|IPC
)paren
suffix:semicolon
multiline_comment|/* interrupt query line mode: Push/pull output, active high     */
id|writeb
c_func
(paren
l_int|0xbf
comma
id|lbi
op_plus
id|IMR3
)paren
suffix:semicolon
multiline_comment|/* send an interrupt every second               */
id|slicecom_set_framing
c_func
(paren
id|hw-&gt;boardnum
comma
id|board-&gt;framing
)paren
suffix:semicolon
id|slicecom_set_linecode
c_func
(paren
id|hw-&gt;boardnum
comma
id|board-&gt;linecode
)paren
suffix:semicolon
id|slicecom_set_clock_source
c_func
(paren
id|hw-&gt;boardnum
comma
id|board-&gt;clock_source
)paren
suffix:semicolon
id|slicecom_set_loopback
c_func
(paren
id|hw-&gt;boardnum
comma
id|board-&gt;loopback
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;intervals
comma
l_int|0
comma
r_sizeof
(paren
id|board-&gt;intervals
)paren
)paren
suffix:semicolon
id|board-&gt;current_interval
op_assign
l_int|0
suffix:semicolon
id|board-&gt;elapsed_seconds
op_assign
l_int|0
suffix:semicolon
id|board-&gt;ses_seconds
op_assign
l_int|0
suffix:semicolon
id|board-&gt;is_unavailable
op_assign
l_int|0
suffix:semicolon
id|board-&gt;no_ses_seconds
op_assign
l_int|0
suffix:semicolon
id|board-&gt;deg_elapsed_seconds
op_assign
l_int|0
suffix:semicolon
id|board-&gt;deg_cumulated_errors
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Enable the interrupts last                                                   */
multiline_comment|/* These interrupts will be enabled. We do not need the others. */
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|IMASK
)paren
)paren
op_amp
op_complement
(paren
id|STAT_PTI
op_or
id|STAT_PRI
op_or
id|STAT_LBII
op_or
id|STAT_TSPA
op_or
id|STAT_RSPA
)paren
comma
id|MUNICH_VIRT
c_func
(paren
id|IMASK
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|board-&gt;irq
suffix:semicolon
multiline_comment|/* hogy szep legyen az ifconfig outputja */
id|ccb
op_assign
id|board-&gt;ccb
suffix:semicolon
multiline_comment|/* TODO: ez igy csunya egy kicsit hogy benn is meg kinn is beletoltom :( */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Check if the selected timeslots aren&squot;t used already */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_amp
id|timeslots
)paren
op_logical_and
op_logical_neg
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|tti
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MUNICH_open: %s: timeslot %d already used by %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
comma
id|board-&gt;twins
(braket
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|txchannel
)braket
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* TODO: lehet hogy valami mas errno kellene? */
)brace
multiline_comment|/* find a free channel: */
multiline_comment|/* TODO: ugly, rewrite it  */
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
op_le
l_int|32
suffix:semicolon
id|channel
op_increment
)paren
(brace
r_if
c_cond
(paren
id|channel
op_eq
l_int|32
)paren
(brace
multiline_comment|/* not found a free one */
id|printk
(paren
l_string|&quot;MUNICH_open: %s: FATAL: can not find a free channel - this should not happen!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|board-&gt;twins
(braket
id|channel
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* found the first free one */
)brace
id|board-&gt;lastcheck
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* avoid checking uninitialized hardware channel */
multiline_comment|/* Open the channel. If fails, calls MUNICH_close() to properly free resources and stop the HW */
id|hw-&gt;channel
op_assign
id|channel
suffix:semicolon
id|board-&gt;twins
(braket
id|channel
)braket
op_assign
id|dev
suffix:semicolon
id|board-&gt;use_count
op_increment
suffix:semicolon
multiline_comment|/* meg nem nyitottuk meg a csatornat, de a twins-ben&n;&t;&t;&t;&t;   mar elfoglaltunk egyet, es ha a _close-t akarjuk hivni, akkor ez kell. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_amp
id|timeslots
)paren
(brace
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|tti
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|txchannel
op_assign
id|channel
suffix:semicolon
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|txfillmask
op_assign
op_complement
l_int|0
suffix:semicolon
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|rti
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|rxchannel
op_assign
id|channel
suffix:semicolon
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|rxfillmask
op_assign
op_complement
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;isx21
)paren
id|rework_idle_channels
c_func
(paren
id|dev
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
(paren
id|hw-&gt;tx_desc
)paren
comma
l_int|0
comma
id|TX_DESC_MAX
op_star
r_sizeof
(paren
id|tx_desc_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
(paren
id|hw-&gt;rx_desc
)paren
comma
l_int|0
comma
id|RX_DESC_MAX
op_star
r_sizeof
(paren
id|rx_desc_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_DESC_MAX
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hw-&gt;tx_desc
(braket
id|i
)braket
dot
id|fe
op_assign
l_int|1
suffix:semicolon
id|hw-&gt;tx_desc
(braket
id|i
)braket
dot
id|fnum
op_assign
l_int|2
suffix:semicolon
id|hw-&gt;tx_desc
(braket
id|i
)braket
dot
id|data
op_assign
id|virt_to_phys
c_func
(paren
op_amp
(paren
id|hw-&gt;tx_data
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|hw-&gt;tx_desc
(braket
id|i
)braket
dot
id|next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
(paren
id|hw-&gt;tx_desc
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|TX_DESC_MAX
)braket
)paren
)paren
suffix:semicolon
)brace
id|hw-&gt;tx_desc_ptr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we will send an initial packet so it is correct: &quot;oda irtunk utoljara&quot; */
id|hw-&gt;busy
op_assign
l_int|0
suffix:semicolon
id|hw-&gt;tx_desc
(braket
id|hw-&gt;tx_desc_ptr
)braket
dot
id|hold
op_assign
l_int|1
suffix:semicolon
id|hw-&gt;tx_desc
(braket
id|hw-&gt;tx_desc_ptr
)braket
dot
id|no
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* TOD: inkabb csak 0 hosszut kuldjunk ki az initkor? */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_DESC_MAX
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hw-&gt;rx_desc
(braket
id|i
)braket
dot
id|no
op_assign
id|RXBUFFER_SIZE
suffix:semicolon
id|hw-&gt;rx_desc
(braket
id|i
)braket
dot
id|data
op_assign
id|virt_to_phys
c_func
(paren
op_amp
(paren
id|hw-&gt;rx_data
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|hw-&gt;rx_desc
(braket
id|i
)braket
dot
id|next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
(paren
id|hw-&gt;rx_desc
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|RX_DESC_MAX
)braket
)paren
)paren
suffix:semicolon
id|hw-&gt;rx_desc
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0xFF
suffix:semicolon
)brace
id|hw-&gt;rx_desc_ptr
op_assign
l_int|0
suffix:semicolon
id|hw-&gt;rx_desc
(braket
(paren
id|hw-&gt;rx_desc_ptr
op_plus
id|RX_DESC_MAX
op_minus
l_int|2
)paren
op_mod
id|RX_DESC_MAX
)braket
dot
id|hold
op_assign
l_int|1
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|channel_spec_t
)paren
)paren
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ti
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Transmit off */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|to
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ta
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|th
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Transmit hold        */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ri
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Receive off  */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ro
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ra
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|mode
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* HDLC */
id|ccb-&gt;action_spec
op_assign
id|CCB_ACTIONSPEC_IN
op_or
(paren
id|channel
op_lshift
l_int|8
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CMD_ARPCM
comma
id|MUNICH_VIRT
c_func
(paren
id|CMD
)paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|stat
op_assign
l_int|0
suffix:semicolon
id|jiffs
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|stat
op_assign
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
)paren
op_amp
(paren
id|STAT_PCMA
op_or
id|STAT_PCMF
)paren
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|jiffs
op_plus
id|HZ
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_PCMF
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MUNICH_open: %s: %s channel %d off failed&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board-&gt;devname
comma
id|channel
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
id|STAT_PCMF
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
id|MUNICH_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|STAT_PCMA
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MUNICH_open: %s: %s channel %d off timeout&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|board-&gt;devname
comma
id|channel
)paren
suffix:semicolon
id|MUNICH_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
id|STAT_PCMA
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
singleline_comment|//      printk(&quot;MUNICH_open: %s: succesful channel off took %ld jiffies&bslash;n&quot;, board-&gt;devname, jiffies-jiffs);
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ifc
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 .. &squot;Idle/Flag change&squot; interrupt letiltva   */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|fit
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|nitbs
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|itbs
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* TODOO: lehet hogy jo lenne igy, de utana kellene nezni hogy nem okoz-e fragmentaciot */
singleline_comment|//      ccb-&gt;channel_spec[channel].itbs = 2 * number_of_timeslots;
singleline_comment|//      printk(&quot;open: %s: number_of_timeslots: %d&bslash;n&quot;, dev-&gt;name, number_of_timeslots);
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|mode
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* HDLC */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ftda
op_assign
id|virt_to_phys
c_func
(paren
op_amp
(paren
id|hw-&gt;tx_desc
)paren
)paren
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|frda
op_assign
id|virt_to_phys
c_func
(paren
op_amp
(paren
id|hw-&gt;rx_desc
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ti
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Transmit init        */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|to
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ta
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|th
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ri
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Receive init */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ro
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ra
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;action_spec
op_assign
id|CCB_ACTIONSPEC_ICO
op_or
(paren
id|channel
op_lshift
l_int|8
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CMD_ARPCM
comma
id|MUNICH_VIRT
c_func
(paren
id|CMD
)paren
)paren
suffix:semicolon
multiline_comment|/* Start the channel init */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|stat
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Wait for the action to complete max. 1 second */
id|jiffs
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|stat
op_assign
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
)paren
op_amp
(paren
id|STAT_PCMA
op_or
id|STAT_PCMF
)paren
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|jiffs
op_plus
id|HZ
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_PCMF
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MUNICH_open: %s: channel open ARPCM failed&bslash;n&quot;
comma
id|board-&gt;devname
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
id|STAT_PCMF
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
id|MUNICH_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|STAT_PCMA
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MUNICH_open: %s: channel open ARPCM timeout&bslash;n&quot;
comma
id|board-&gt;devname
)paren
suffix:semicolon
id|MUNICH_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
id|STAT_PCMA
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
singleline_comment|//      printk(&quot;MUNICH_open: %s: succesful channel open took %ld jiffies&bslash;n&quot;, board-&gt;devname, jiffies-jiffs);
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|nitbs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* once ITBS defined, these must be 0   */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|itbs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;isx21
)paren
(brace
id|board-&gt;modemline_timer.data
op_assign
(paren
r_int
r_int
)paren
id|board
suffix:semicolon
id|board-&gt;modemline_timer.function
op_assign
id|pcicom_modemline
suffix:semicolon
id|board-&gt;modemline_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
(paren
r_struct
id|timer_list
op_star
)paren
op_amp
id|board-&gt;modemline_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* It is done. Declare that we&squot;re open: */
id|hw-&gt;busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* It may be 1 if the frame at Tx init already ended, but it is not     */
multiline_comment|/* a real problem: we compute hw-&gt;busy on every interrupt                       */
id|hw-&gt;rafutott
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;init_status
op_or_assign
id|HW_OPEN
suffix:semicolon
multiline_comment|/* Initialize line state: */
r_if
c_cond
(paren
id|board-&gt;lineup
)paren
id|ch-&gt;line_status
op_or_assign
id|LINE_UP
suffix:semicolon
r_else
id|ch-&gt;line_status
op_and_assign
op_complement
id|LINE_UP
suffix:semicolon
multiline_comment|/* Remove w attribute from /proc files associated to hw parameters:&n;       no write when the device is open */
r_for
c_loop
(paren
suffix:semicolon
id|procfile
suffix:semicolon
id|procfile
op_assign
id|procfile-&gt;next
)paren
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|procfile-&gt;name
comma
id|FILENAME_BOARDNUM
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|procfile-&gt;name
comma
id|FILENAME_TIMESLOTS
)paren
op_eq
l_int|0
)paren
id|procfile-&gt;mode
op_assign
id|S_IFREG
op_or
l_int|0444
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Hardware close routine.&n; * Called by comx (upper) layer when the user wants to bring down the interface&n; * with ifconfig.&n; * We also call it from MUNICH_open, if the open fails.&n; * Brings down hardware, frees resources, stops receiver&n; * Returns 0 on OK, or standard error value on error.&n; */
DECL|function|MUNICH_close
r_static
r_int
id|MUNICH_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|procfile
op_assign
id|ch-&gt;procdir-&gt;subdir
suffix:semicolon
id|munich_board_t
op_star
id|board
suffix:semicolon
id|munich_ccb_t
op_star
id|ccb
suffix:semicolon
id|u32
op_star
id|bar1
suffix:semicolon
id|u32
id|timeslots
op_assign
id|hw-&gt;timeslots
suffix:semicolon
r_int
id|stat
comma
id|i
comma
id|channel
op_assign
id|hw-&gt;channel
suffix:semicolon
r_int
r_int
id|jiffs
suffix:semicolon
id|board
op_assign
id|hw-&gt;boardnum
op_plus
(paren
id|ch-&gt;hardware
op_eq
op_amp
id|pcicomhw
ques
c_cond
id|pcicom_boards
suffix:colon
id|slicecom_boards
)paren
suffix:semicolon
id|ccb
op_assign
id|board-&gt;ccb
suffix:semicolon
id|bar1
op_assign
id|board-&gt;bar1
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;isx21
)paren
id|del_timer
c_func
(paren
(paren
r_struct
id|timer_list
op_star
)paren
op_amp
id|board-&gt;modemline_timer
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Disable receiver for the channel: */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_amp
id|timeslots
)paren
(brace
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|tti
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|txfillmask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just to be double-sure :) */
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|rti
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;timeslot_spec
(braket
id|i
)braket
dot
id|rxfillmask
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;isx21
)paren
id|rework_idle_channels
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ti
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Receive off, Transmit off */
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|to
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ta
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|th
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ri
op_assign
l_int|0
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ro
op_assign
l_int|1
suffix:semicolon
id|ccb-&gt;channel_spec
(braket
id|channel
)braket
dot
id|ra
op_assign
l_int|0
suffix:semicolon
id|board-&gt;twins
(braket
id|channel
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ccb-&gt;action_spec
op_assign
id|CCB_ACTIONSPEC_IN
op_or
(paren
id|channel
op_lshift
l_int|8
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CMD_ARPCM
comma
id|MUNICH_VIRT
c_func
(paren
id|CMD
)paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
id|stat
op_assign
l_int|0
suffix:semicolon
id|jiffs
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|stat
op_assign
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
)paren
op_amp
(paren
id|STAT_PCMA
op_or
id|STAT_PCMF
)paren
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|jiffs
op_plus
id|HZ
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|STAT_PCMF
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MUNICH_close: %s: FATAL: channel off ARPCM failed, not closing!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
id|STAT_PCMF
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
multiline_comment|/* If we return success, the privdata (and the descriptor list) will be freed */
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|STAT_PCMA
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MUNICH_close: %s: channel off ARPCM timeout&bslash;n&quot;
comma
id|board-&gt;devname
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
op_amp
id|STAT_PCMA
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
singleline_comment|//      printk(&quot;MUNICH_close: %s: channel off took %ld jiffies&bslash;n&quot;, board-&gt;devname, jiffies-jiffs);
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;use_count
)paren
id|board-&gt;use_count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;use_count
)paren
multiline_comment|/* we were the last user of the board */
(brace
id|printk
c_func
(paren
l_string|&quot;MUNICH_close: bringing down board %s&bslash;n&quot;
comma
id|board-&gt;devname
)paren
suffix:semicolon
multiline_comment|/* program down the board: */
id|writel
c_func
(paren
l_int|0x0000FF7F
comma
id|MUNICH_VIRT
c_func
(paren
id|IMASK
)paren
)paren
suffix:semicolon
multiline_comment|/* do not send any interrupts */
id|writel
c_func
(paren
l_int|0
comma
id|MUNICH_VIRT
c_func
(paren
id|CMD
)paren
)paren
suffix:semicolon
multiline_comment|/* stop the timer if someone started it */
id|writel
c_func
(paren
op_complement
l_int|0U
comma
id|MUNICH_VIRT
c_func
(paren
id|STAT
)paren
)paren
suffix:semicolon
multiline_comment|/* if an interrupt came between the cli()-sti(), quiet it */
r_if
c_cond
(paren
id|ch-&gt;hardware
op_eq
op_amp
id|pcicomhw
)paren
id|writel
c_func
(paren
l_int|0x1400
comma
id|MUNICH_VIRT
c_func
(paren
id|GPDATA
)paren
)paren
suffix:semicolon
multiline_comment|/* Put the board into &squot;reset&squot; state: */
id|pci_write_config_dword
c_func
(paren
id|board-&gt;pci
comma
id|MUNICH_PCI_PCIRES
comma
l_int|0xe0000
)paren
suffix:semicolon
multiline_comment|/* Free irq and other resources: */
r_if
c_cond
(paren
id|board-&gt;irq
)paren
id|free_irq
c_func
(paren
id|board-&gt;irq
comma
(paren
r_void
op_star
)paren
id|board
)paren
suffix:semicolon
multiline_comment|/* Ha nem inicializalta magat, akkor meg nincs irq */
id|board-&gt;irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Free CCB and the interrupt queues */
r_if
c_cond
(paren
id|board-&gt;ccb
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;ccb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;tiq
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;tiq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;riq
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;riq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board-&gt;piq
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|board-&gt;piq
)paren
suffix:semicolon
id|board-&gt;ccb
op_assign
l_int|NULL
suffix:semicolon
id|board-&gt;tiq
op_assign
id|board-&gt;riq
op_assign
id|board-&gt;piq
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Enable setting of hw parameters */
r_for
c_loop
(paren
suffix:semicolon
id|procfile
suffix:semicolon
id|procfile
op_assign
id|procfile-&gt;next
)paren
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|procfile-&gt;name
comma
id|FILENAME_BOARDNUM
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|procfile-&gt;name
comma
id|FILENAME_TIMESLOTS
)paren
op_eq
l_int|0
)paren
id|procfile-&gt;mode
op_assign
id|S_IFREG
op_or
l_int|0644
suffix:semicolon
multiline_comment|/* We&squot;re not open anymore */
id|ch-&gt;init_status
op_and_assign
op_complement
id|HW_OPEN
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mister_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Give (textual) status information.&n; * The text it returns will be a part of what appears when the user does a&n; * cat /proc/comx/comx[n]/status &n; * Don&squot;t write more than PAGESIZE.&n; * Return value: number of bytes written (length of the string, incl. 0)&n; */
DECL|function|MUNICH_minden
r_static
r_int
id|MUNICH_minden
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|page
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
id|munich_board_t
op_star
id|board
suffix:semicolon
r_struct
id|net_device
op_star
id|devp
suffix:semicolon
id|u8
op_star
id|lbi
suffix:semicolon
id|e1_stats_t
op_star
id|curr_int
comma
op_star
id|prev_int
suffix:semicolon
id|e1_stats_t
id|last4
comma
id|last96
suffix:semicolon
multiline_comment|/* sum of last 4, resp. last 96 intervals               */
r_int
op_star
id|sump
comma
multiline_comment|/* running pointer for the sum data                     */
op_star
id|p
suffix:semicolon
multiline_comment|/* running pointer for the interval data                */
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|u8
id|frs0
comma
id|frs1
suffix:semicolon
id|u8
id|fmr2
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|u32
id|timeslots
suffix:semicolon
id|board
op_assign
id|hw-&gt;boardnum
op_plus
(paren
id|ch-&gt;hardware
op_eq
op_amp
id|pcicomhw
ques
c_cond
id|pcicom_boards
suffix:colon
id|slicecom_boards
)paren
suffix:semicolon
id|lbi
op_assign
id|board-&gt;lbi
suffix:semicolon
id|curr_int
op_assign
op_amp
id|board-&gt;intervals
(braket
id|board-&gt;current_interval
)braket
suffix:semicolon
id|prev_int
op_assign
op_amp
id|board
op_member_access_from_pointer
id|intervals
(braket
(paren
id|board-&gt;current_interval
op_plus
id|SLICECOM_BOARD_INTERVALS_SIZE
op_minus
l_int|1
)paren
op_mod
id|SLICECOM_BOARD_INTERVALS_SIZE
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;isx21
)paren
(brace
id|frs0
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|FRS0
)paren
suffix:semicolon
id|fmr2
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|FMR2
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Controller status:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frs0
op_eq
l_int|0
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tNo alarms&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|frs0
op_amp
id|FRS0_LOS
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tLoss Of Signal&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|frs0
op_amp
id|FRS0_AIS
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tAlarm Indication Signal&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|frs0
op_amp
id|FRS0_AUXP
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tAuxiliary Pattern Indication&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frs0
op_amp
id|FRS0_LFA
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tLoss of Frame Alignment&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|frs0
op_amp
id|FRS0_RRA
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tReceive Remote Alarm&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* You can&squot;t set this framing with the /proc interface, but it  */
multiline_comment|/* may be good to have here this alarm if you set it by hand:   */
r_if
c_cond
(paren
(paren
id|board-&gt;framing
op_eq
id|SLICECOM_FRAMING_CRC4
)paren
op_logical_and
(paren
id|frs0
op_amp
id|FRS0_LMFA
)paren
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tLoss of CRC4 Multiframe Alignment&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|fmr2
op_amp
l_int|0xc0
)paren
op_eq
l_int|0xc0
)paren
op_logical_and
(paren
id|frs0
op_amp
id|FRS0_NMF
)paren
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tNo CRC4 Multiframe alignment Found after 400 msec&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|frs1
op_assign
id|readb
c_func
(paren
id|lbi
op_plus
id|FRS1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FRS1_XLS
op_amp
id|frs1
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tTransmit Line Short&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* debug Rx ring: DEL: - vagy meghagyni, de akkor legyen kicsit altalanosabb */
)brace
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Rx ring:&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;trafutott: %d&bslash;n&quot;
comma
id|hw-&gt;rafutott
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tlastcheck: %ld, jiffies: %ld&bslash;n&quot;
comma
id|board-&gt;lastcheck
comma
id|jiffies
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;tbase: %08x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|virt_to_phys
c_func
(paren
op_amp
id|hw-&gt;rx_desc
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;trx_desc_ptr: %d&bslash;n&quot;
comma
id|hw-&gt;rx_desc_ptr
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;trx_desc_ptr: %08x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|virt_to_phys
c_func
(paren
op_amp
id|hw-&gt;rx_desc
(braket
id|hw-&gt;rx_desc_ptr
)braket
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;thw_curr_ptr: %08x&bslash;n&quot;
comma
id|board-&gt;ccb-&gt;current_rx_desc
(braket
id|hw-&gt;channel
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_DESC_MAX
suffix:semicolon
id|i
op_increment
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;t%08x %08x %08x %08x&bslash;n&quot;
comma
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|hw-&gt;rx_desc
(braket
id|i
)braket
op_plus
l_int|0
)paren
comma
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|hw-&gt;rx_desc
(braket
id|i
)braket
op_plus
l_int|1
)paren
comma
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|hw-&gt;rx_desc
(braket
id|i
)braket
op_plus
l_int|2
)paren
comma
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|hw-&gt;rx_desc
(braket
id|i
)braket
op_plus
l_int|3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;isx21
)paren
(brace
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Interfaces using this board: (channel-group, interface, timeslots)&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|devp
op_assign
id|board-&gt;twins
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devp
op_ne
l_int|NULL
)paren
(brace
id|timeslots
op_assign
(paren
(paren
r_struct
id|slicecom_privdata
op_star
)paren
(paren
(paren
r_struct
id|comx_channel
op_star
)paren
id|devp
op_member_access_from_pointer
id|priv
)paren
op_member_access_from_pointer
id|HW_privdata
)paren
op_member_access_from_pointer
id|timeslots
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;t%2d %s: &quot;
comma
id|i
comma
id|devp-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|32
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|j
)paren
op_amp
id|timeslots
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;%d &quot;
comma
id|j
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Interrupt work histogram:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_WORK
suffix:semicolon
id|i
op_increment
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;hist[%2d]: %8u%c&quot;
comma
id|i
comma
id|board-&gt;histogram
(braket
id|i
)braket
comma
(paren
id|i
op_logical_and
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|4
op_eq
l_int|0
op_logical_or
id|i
op_eq
id|MAX_WORK
op_minus
l_int|1
)paren
)paren
ques
c_cond
l_char|&squot;&bslash;n&squot;
suffix:colon
l_char|&squot; &squot;
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Tx ring histogram:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_DESC_MAX
suffix:semicolon
id|i
op_increment
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;hist[%2d]: %8u%c&quot;
comma
id|i
comma
id|hw-&gt;tx_ring_hist
(braket
id|i
)braket
comma
(paren
id|i
op_logical_and
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|4
op_eq
l_int|0
op_logical_or
id|i
op_eq
id|TX_DESC_MAX
op_minus
l_int|1
)paren
)paren
ques
c_cond
l_char|&squot;&bslash;n&squot;
suffix:colon
l_char|&squot; &squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|board-&gt;isx21
)paren
(brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|last4
comma
l_int|0
comma
r_sizeof
(paren
id|last4
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|last96
comma
l_int|0
comma
r_sizeof
(paren
id|last96
)paren
)paren
suffix:semicolon
multiline_comment|/* Calculate the sum of last 4 intervals: */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
(paren
r_int
op_star
)paren
op_amp
id|board-&gt;intervals
(braket
(paren
id|board-&gt;current_interval
op_plus
id|SLICECOM_BOARD_INTERVALS_SIZE
op_minus
id|i
)paren
op_mod
id|SLICECOM_BOARD_INTERVALS_SIZE
)braket
suffix:semicolon
id|sump
op_assign
(paren
r_int
op_star
)paren
op_amp
id|last4
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
r_sizeof
(paren
id|e1_stats_t
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|j
op_increment
)paren
id|sump
(braket
id|j
)braket
op_add_assign
id|p
(braket
id|j
)braket
suffix:semicolon
)brace
multiline_comment|/* Calculate the sum of last 96 intervals: */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|96
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
(paren
r_int
op_star
)paren
op_amp
id|board-&gt;intervals
(braket
(paren
id|board-&gt;current_interval
op_plus
id|SLICECOM_BOARD_INTERVALS_SIZE
op_minus
id|i
)paren
op_mod
id|SLICECOM_BOARD_INTERVALS_SIZE
)braket
suffix:semicolon
id|sump
op_assign
(paren
r_int
op_star
)paren
op_amp
id|last96
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
r_sizeof
(paren
id|e1_stats_t
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|j
op_increment
)paren
id|sump
(braket
id|j
)braket
op_add_assign
id|p
(braket
id|j
)braket
suffix:semicolon
)brace
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Data in current interval (%d seconds elapsed):&bslash;n&quot;
comma
id|board-&gt;elapsed_seconds
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Line Code Violations, %d Path Code Violations, %d E-Bit Errors&bslash;n&quot;
comma
id|curr_int-&gt;line_code_violations
comma
id|curr_int-&gt;path_code_violations
comma
id|curr_int-&gt;e_bit_errors
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Slip Secs, %d Fr Loss Secs, %d Line Err Secs, %d Degraded Mins&bslash;n&quot;
comma
id|curr_int-&gt;slip_secs
comma
id|curr_int-&gt;fr_loss_secs
comma
id|curr_int-&gt;line_err_secs
comma
id|curr_int-&gt;degraded_mins
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Errored Secs, %d Bursty Err Secs, %d Severely Err Secs, %d Unavail Secs&bslash;n&quot;
comma
id|curr_int-&gt;errored_secs
comma
id|curr_int-&gt;bursty_err_secs
comma
id|curr_int-&gt;severely_err_secs
comma
id|curr_int-&gt;unavail_secs
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Data in Interval 1 (15 minutes):&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Line Code Violations, %d Path Code Violations, %d E-Bit Errors&bslash;n&quot;
comma
id|prev_int-&gt;line_code_violations
comma
id|prev_int-&gt;path_code_violations
comma
id|prev_int-&gt;e_bit_errors
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Slip Secs, %d Fr Loss Secs, %d Line Err Secs, %d Degraded Mins&bslash;n&quot;
comma
id|prev_int-&gt;slip_secs
comma
id|prev_int-&gt;fr_loss_secs
comma
id|prev_int-&gt;line_err_secs
comma
id|prev_int-&gt;degraded_mins
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Errored Secs, %d Bursty Err Secs, %d Severely Err Secs, %d Unavail Secs&bslash;n&quot;
comma
id|prev_int-&gt;errored_secs
comma
id|prev_int-&gt;bursty_err_secs
comma
id|prev_int-&gt;severely_err_secs
comma
id|prev_int-&gt;unavail_secs
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Data in last 4 intervals (1 hour):&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Line Code Violations, %d Path Code Violations, %d E-Bit Errors&bslash;n&quot;
comma
id|last4.line_code_violations
comma
id|last4.path_code_violations
comma
id|last4.e_bit_errors
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Slip Secs, %d Fr Loss Secs, %d Line Err Secs, %d Degraded Mins&bslash;n&quot;
comma
id|last4.slip_secs
comma
id|last4.fr_loss_secs
comma
id|last4.line_err_secs
comma
id|last4.degraded_mins
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Errored Secs, %d Bursty Err Secs, %d Severely Err Secs, %d Unavail Secs&bslash;n&quot;
comma
id|last4.errored_secs
comma
id|last4.bursty_err_secs
comma
id|last4.severely_err_secs
comma
id|last4.unavail_secs
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;Data in last 96 intervals (24 hours):&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Line Code Violations, %d Path Code Violations, %d E-Bit Errors&bslash;n&quot;
comma
id|last96.line_code_violations
comma
id|last96.path_code_violations
comma
id|last96.e_bit_errors
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Slip Secs, %d Fr Loss Secs, %d Line Err Secs, %d Degraded Mins&bslash;n&quot;
comma
id|last96.slip_secs
comma
id|last96.fr_loss_secs
comma
id|last96.line_err_secs
comma
id|last96.degraded_mins
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;   %d Errored Secs, %d Bursty Err Secs, %d Severely Err Secs, %d Unavail Secs&bslash;n&quot;
comma
id|last96.errored_secs
comma
id|last96.bursty_err_secs
comma
id|last96.severely_err_secs
comma
id|last96.unavail_secs
)paren
suffix:semicolon
)brace
singleline_comment|//      len +=snprintf( page + len, PAGE_SIZE - len, &quot;Special events:&bslash;n&quot; );
singleline_comment|//      len +=snprintf( page + len, PAGE_SIZE - len, &quot;&bslash;tstat_pri/missed: %u / %u&bslash;n&quot;, board-&gt;stat_pri_races, board-&gt;stat_pri_races_missed );
singleline_comment|//      len +=snprintf( page + len, PAGE_SIZE - len, &quot;&bslash;tstat_pti/missed: %u / %u&bslash;n&quot;, board-&gt;stat_pti_races, board-&gt;stat_pti_races_missed );
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Memory dump function. Not used currently.&n; */
DECL|function|BOARD_dump
r_static
r_int
id|BOARD_dump
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
(paren
l_string|&quot;BOARD_dump() requested. It is unimplemented, it should not be called&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * /proc file read function for the files registered by this module.&n; * This function is called by the procfs implementation when a user&n; * wants to read from a file registered by this module.&n; * page is the workspace, start should point to the real start of data,&n; * off is the file offset, data points to the file&squot;s proc_dir_entry&n; * structure.&n; * Returns the number of bytes copied to the request buffer.&n; */
DECL|function|munich_read_proc
r_static
r_int
id|munich_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|file
op_assign
(paren
r_struct
id|proc_dir_entry
op_star
)paren
id|data
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|file-&gt;parent-&gt;data
suffix:semicolon
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
id|munich_board_t
op_star
id|board
suffix:semicolon
r_int
id|len
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|u32
id|timeslots
op_assign
id|hw-&gt;timeslots
suffix:semicolon
id|board
op_assign
id|hw-&gt;boardnum
op_plus
(paren
id|ch-&gt;hardware
op_eq
op_amp
id|pcicomhw
ques
c_cond
id|pcicom_boards
suffix:colon
id|slicecom_boards
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|file-&gt;name
comma
id|FILENAME_BOARDNUM
)paren
)paren
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|hw-&gt;boardnum
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|file-&gt;name
comma
id|FILENAME_TIMESLOTS
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_amp
id|timeslots
)paren
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;%d &quot;
comma
id|i
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|file-&gt;name
comma
id|FILENAME_FRAMING
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|slicecom_framings
(braket
id|i
)braket
dot
id|value
op_logical_and
id|slicecom_framings
(braket
id|i
)braket
dot
id|value
op_ne
id|board-&gt;framing
)paren
id|i
op_increment
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|slicecom_framings
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|file-&gt;name
comma
id|FILENAME_LINECODE
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|slicecom_linecodes
(braket
id|i
)braket
dot
id|value
op_logical_and
id|slicecom_linecodes
(braket
id|i
)braket
dot
id|value
op_ne
id|board-&gt;linecode
)paren
id|i
op_increment
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|slicecom_linecodes
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|file-&gt;name
comma
id|FILENAME_CLOCK_SOURCE
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|slicecom_clock_sources
(braket
id|i
)braket
dot
id|value
op_logical_and
id|slicecom_clock_sources
(braket
id|i
)braket
dot
id|value
op_ne
id|board-&gt;clock_source
)paren
id|i
op_increment
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|slicecom_clock_sources
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|file-&gt;name
comma
id|FILENAME_LOOPBACK
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|slicecom_loopbacks
(braket
id|i
)braket
dot
id|value
op_logical_and
id|slicecom_loopbacks
(braket
id|i
)braket
dot
id|value
op_ne
id|board-&gt;loopback
)paren
id|i
op_increment
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|slicecom_loopbacks
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/* We set permissions to write-only for REG and LBIREG, but root can read them anyway: */
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|file-&gt;name
comma
id|FILENAME_REG
)paren
)paren
(brace
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;%s: &quot;
id|FILENAME_REG
l_string|&quot;: write-only file&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|file-&gt;name
comma
id|FILENAME_LBIREG
)paren
)paren
(brace
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|PAGE_SIZE
op_minus
id|len
comma
l_string|&quot;%s: &quot;
id|FILENAME_LBIREG
l_string|&quot;: write-only file&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;slicecom_read_proc: internal error, filename %s&bslash;n&quot;
comma
id|file-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
multiline_comment|/* file handling administration: count eof status, offset, start address&n;       and count: */
r_if
c_cond
(paren
id|off
op_ge
id|len
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
id|len
op_minus
id|off
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
id|min
c_func
(paren
(paren
id|off_t
)paren
id|count
comma
(paren
id|off_t
)paren
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Write function for /proc files registered by us.&n; * See the comment on read function above.&n; * Beware! buffer is in userspace!!!&n; * Returns the number of bytes written&n; */
DECL|function|munich_write_proc
r_static
r_int
id|munich_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
id|u_long
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|entry
op_assign
(paren
r_struct
id|proc_dir_entry
op_star
)paren
id|data
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|entry-&gt;parent-&gt;data
suffix:semicolon
r_struct
id|comx_channel
op_star
id|ch
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
id|munich_board_t
op_star
id|board
suffix:semicolon
r_int
r_int
id|ts
comma
id|tmp_boardnum
suffix:semicolon
id|u32
id|tmp_timeslots
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|page
comma
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|board
op_assign
id|hw-&gt;boardnum
op_plus
(paren
id|ch-&gt;hardware
op_eq
op_amp
id|pcicomhw
ques
c_cond
id|pcicom_boards
suffix:colon
id|slicecom_boards
)paren
suffix:semicolon
multiline_comment|/* Paranoia checking: */
r_if
c_cond
(paren
id|PDE
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
op_ne
id|entry
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;munich_write_proc: file &lt;-&gt; data internal error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Request tmp buffer */
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_assign
(paren
r_char
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Copy user data and cut trailing &bslash;n */
id|copy_from_user
c_func
(paren
id|page
comma
id|buffer
comma
id|count
op_assign
id|min
c_func
(paren
id|count
comma
id|PAGE_SIZE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|page
op_plus
id|count
op_minus
l_int|1
)paren
op_eq
l_char|&squot;&bslash;n&squot;
)paren
op_star
(paren
id|page
op_plus
id|count
op_minus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|page
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|entry-&gt;name
comma
id|FILENAME_BOARDNUM
)paren
)paren
(brace
id|tmp_boardnum
op_assign
id|simple_strtoul
c_func
(paren
id|page
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_le
id|tmp_boardnum
op_logical_and
id|tmp_boardnum
OL
id|MAX_BOARDS
)paren
id|hw-&gt;boardnum
op_assign
id|tmp_boardnum
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
id|FILENAME_BOARDNUM
l_string|&quot; range is 0...%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|MAX_BOARDS
op_minus
l_int|1
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|entry-&gt;name
comma
id|FILENAME_TIMESLOTS
)paren
)paren
(brace
id|p
op_assign
id|page
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
id|isspace
c_func
(paren
op_star
id|p
)paren
)paren
id|p
op_increment
suffix:semicolon
r_else
(brace
id|ts
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
op_amp
id|p
comma
l_int|10
)paren
suffix:semicolon
multiline_comment|/* base = 10: Don&squot;t read 09 as an octal number */
multiline_comment|/* ts = 0 ha nem tudta beolvasni a stringet, erre egy kicsit epitek itt: */
r_if
c_cond
(paren
l_int|0
op_le
id|ts
op_logical_and
id|ts
OL
l_int|32
)paren
(brace
id|tmp_timeslots
op_or_assign
(paren
l_int|1
op_lshift
id|ts
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
id|FILENAME_TIMESLOTS
l_string|&quot; range is 1...31&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
id|hw-&gt;timeslots
op_assign
id|tmp_timeslots
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|entry-&gt;name
comma
id|FILENAME_FRAMING
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|slicecom_framings
(braket
id|i
)braket
dot
id|value
op_logical_and
id|strncmp
c_func
(paren
id|slicecom_framings
(braket
id|i
)braket
dot
id|name
comma
id|page
comma
id|strlen
c_func
(paren
id|slicecom_framings
(braket
id|i
)braket
dot
id|name
)paren
)paren
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slicecom_framings
(braket
id|i
)braket
dot
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;slicecom: %s: Invalid &quot;
id|FILENAME_FRAMING
l_string|&quot; &squot;%s&squot;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|page
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * If somebody says:&n;&t;&t;&t;&t; *      echo &gt;boardnum  0&n;&t;&t;&t;&t; *      echo &gt;framing   no-crc4&n;&t;&t;&t;&t; *      echo &gt;boardnum  1&n;&t;&t;&t;&t; * - when the framing was set, hw-&gt;boardnum was 0, so it would set the framing for board 0&n;&t;&t;&t;&t; * Workaround: allow to set it only if interface is administrative UP&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
id|slicecom_set_framing
c_func
(paren
id|hw-&gt;boardnum
comma
id|slicecom_framings
(braket
id|i
)braket
dot
id|value
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
id|FILENAME_FRAMING
l_string|&quot; can not be set while the interface is DOWN&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|entry-&gt;name
comma
id|FILENAME_LINECODE
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|slicecom_linecodes
(braket
id|i
)braket
dot
id|value
op_logical_and
id|strncmp
c_func
(paren
id|slicecom_linecodes
(braket
id|i
)braket
dot
id|name
comma
id|page
comma
id|strlen
c_func
(paren
id|slicecom_linecodes
(braket
id|i
)braket
dot
id|name
)paren
)paren
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slicecom_linecodes
(braket
id|i
)braket
dot
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;slicecom: %s: Invalid &quot;
id|FILENAME_LINECODE
l_string|&quot; &squot;%s&squot;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|page
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Allow to set it only if interface is administrative UP,&n;&t;&t;&t;&t; * for the same reason as FILENAME_FRAMING&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
id|slicecom_set_linecode
c_func
(paren
id|hw-&gt;boardnum
comma
id|slicecom_linecodes
(braket
id|i
)braket
dot
id|value
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
id|FILENAME_LINECODE
l_string|&quot; can not be set while the interface is DOWN&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|entry-&gt;name
comma
id|FILENAME_CLOCK_SOURCE
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|slicecom_clock_sources
(braket
id|i
)braket
dot
id|value
op_logical_and
id|strncmp
c_func
(paren
id|slicecom_clock_sources
(braket
id|i
)braket
dot
id|name
comma
id|page
comma
id|strlen
c_func
(paren
id|slicecom_clock_sources
(braket
id|i
)braket
dot
id|name
)paren
)paren
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slicecom_clock_sources
(braket
id|i
)braket
dot
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Invalid &quot;
id|FILENAME_CLOCK_SOURCE
l_string|&quot; &squot;%s&squot;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|page
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Allow to set it only if interface is administrative UP,&n;&t;&t;&t;&t; * for the same reason as FILENAME_FRAMING&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
id|slicecom_set_clock_source
c_func
(paren
id|hw-&gt;boardnum
comma
id|slicecom_clock_sources
(braket
id|i
)braket
dot
id|value
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
id|FILENAME_CLOCK_SOURCE
l_string|&quot; can not be set while the interface is DOWN&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|entry-&gt;name
comma
id|FILENAME_LOOPBACK
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|slicecom_loopbacks
(braket
id|i
)braket
dot
id|value
op_logical_and
id|strncmp
c_func
(paren
id|slicecom_loopbacks
(braket
id|i
)braket
dot
id|name
comma
id|page
comma
id|strlen
c_func
(paren
id|slicecom_loopbacks
(braket
id|i
)braket
dot
id|name
)paren
)paren
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slicecom_loopbacks
(braket
id|i
)braket
dot
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Invalid &quot;
id|FILENAME_LOOPBACK
l_string|&quot; &squot;%s&squot;&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|page
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Allow to set it only if interface is administrative UP,&n;&t;&t;&t;&t; * for the same reason as FILENAME_FRAMING&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
id|slicecom_set_loopback
c_func
(paren
id|hw-&gt;boardnum
comma
id|slicecom_loopbacks
(braket
id|i
)braket
dot
id|value
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
id|FILENAME_LOOPBACK
l_string|&quot; can not be set while the interface is DOWN&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|entry-&gt;name
comma
id|FILENAME_REG
)paren
)paren
(brace
multiline_comment|/* DEL: &squot;reg&squot; csak tmp */
r_char
op_star
id|p
suffix:semicolon
id|u32
op_star
id|bar1
op_assign
id|board-&gt;bar1
suffix:semicolon
id|reg
op_assign
id|simple_strtoul
c_func
(paren
id|page
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
id|reg_ertek
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
OL
l_int|0x100
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;reg(0x%02x) := 0x%08x  jiff: %lu&bslash;n&quot;
comma
id|reg
comma
id|reg_ertek
comma
id|jiffies
)paren
suffix:semicolon
id|writel
c_func
(paren
id|reg_ertek
comma
id|MUNICH_VIRT
c_func
(paren
id|reg
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;reg(0x%02x) is 0x%08x  jiff: %lu&bslash;n&quot;
comma
id|reg
op_minus
l_int|0x100
comma
id|readl
c_func
(paren
id|MUNICH_VIRT
c_func
(paren
(paren
id|reg
op_minus
l_int|0x100
)paren
op_rshift
l_int|2
)paren
)paren
comma
id|jiffies
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|entry-&gt;name
comma
id|FILENAME_LBIREG
)paren
)paren
(brace
multiline_comment|/* DEL: &squot;lbireg&squot; csak tmp */
r_char
op_star
id|p
suffix:semicolon
id|u8
op_star
id|lbi
op_assign
id|board-&gt;lbi
suffix:semicolon
id|lbireg
op_assign
id|simple_strtoul
c_func
(paren
id|page
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
id|lbireg_ertek
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lbireg
OL
l_int|0x100
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;lbireg(0x%02x) := 0x%02x  jiff: %lu&bslash;n&quot;
comma
id|lbireg
comma
id|lbireg_ertek
comma
id|jiffies
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|lbireg_ertek
comma
id|lbi
op_plus
id|lbireg
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;lbireg(0x%02x) is 0x%02x  jiff: %lu&bslash;n&quot;
comma
id|lbireg
op_minus
l_int|0x100
comma
id|readb
c_func
(paren
id|lbi
op_plus
id|lbireg
op_minus
l_int|0x100
)paren
comma
id|jiffies
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;munich_write_proc: internal error, filename %s&bslash;n&quot;
comma
id|entry-&gt;name
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t forget to free the workspace */
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* &n; * Boardtype init function.&n; * Called by the comx (upper) layer, when you set boardtype.&n; * Allocates resources associated to using munich board for this device,&n; * initializes ch_struct pointers etc.&n; * Returns 0 on success and standard error codes on error.&n; */
DECL|function|init_escape
r_static
r_int
id|init_escape
c_func
(paren
r_struct
id|comx_channel
op_star
id|ch
)paren
(brace
id|kfree
c_func
(paren
id|ch-&gt;HW_privdata
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|BOARD_init
r_static
r_int
id|BOARD_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
(paren
r_struct
id|comx_channel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|new_file
suffix:semicolon
multiline_comment|/* Alloc data for private structure */
r_if
c_cond
(paren
(paren
id|ch-&gt;HW_privdata
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|slicecom_privdata
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|hw
op_assign
id|ch-&gt;HW_privdata
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|slicecom_privdata
)paren
)paren
suffix:semicolon
multiline_comment|/* Register /proc files */
r_if
c_cond
(paren
(paren
id|new_file
op_assign
id|create_proc_entry
c_func
(paren
id|FILENAME_BOARDNUM
comma
id|S_IFREG
op_or
l_int|0644
comma
id|ch-&gt;procdir
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|init_escape
c_func
(paren
id|ch
)paren
suffix:semicolon
id|new_file-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|new_file
suffix:semicolon
id|new_file-&gt;read_proc
op_assign
op_amp
id|munich_read_proc
suffix:semicolon
id|new_file-&gt;write_proc
op_assign
op_amp
id|munich_write_proc
suffix:semicolon
singleline_comment|//      new_file-&gt;proc_iops = &amp;comx_normal_inode_ops;
id|new_file-&gt;nlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;hardware
op_eq
op_amp
id|slicecomhw
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_file
op_assign
id|create_proc_entry
c_func
(paren
id|FILENAME_TIMESLOTS
comma
id|S_IFREG
op_or
l_int|0644
comma
id|ch-&gt;procdir
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|init_escape
c_func
(paren
id|ch
)paren
suffix:semicolon
id|new_file-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|new_file
suffix:semicolon
id|new_file-&gt;read_proc
op_assign
op_amp
id|munich_read_proc
suffix:semicolon
id|new_file-&gt;write_proc
op_assign
op_amp
id|munich_write_proc
suffix:semicolon
singleline_comment|//              new_file-&gt;proc_iops = &amp;comx_normal_inode_ops;
id|new_file-&gt;nlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_file
op_assign
id|create_proc_entry
c_func
(paren
id|FILENAME_FRAMING
comma
id|S_IFREG
op_or
l_int|0644
comma
id|ch-&gt;procdir
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|init_escape
c_func
(paren
id|ch
)paren
suffix:semicolon
id|new_file-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|new_file
suffix:semicolon
id|new_file-&gt;read_proc
op_assign
op_amp
id|munich_read_proc
suffix:semicolon
id|new_file-&gt;write_proc
op_assign
op_amp
id|munich_write_proc
suffix:semicolon
singleline_comment|//              new_file-&gt;proc_iops = &amp;comx_normal_inode_ops;
id|new_file-&gt;nlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_file
op_assign
id|create_proc_entry
c_func
(paren
id|FILENAME_LINECODE
comma
id|S_IFREG
op_or
l_int|0644
comma
id|ch-&gt;procdir
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|init_escape
c_func
(paren
id|ch
)paren
suffix:semicolon
id|new_file-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|new_file
suffix:semicolon
id|new_file-&gt;read_proc
op_assign
op_amp
id|munich_read_proc
suffix:semicolon
id|new_file-&gt;write_proc
op_assign
op_amp
id|munich_write_proc
suffix:semicolon
singleline_comment|//              new_file-&gt;proc_iops = &amp;comx_normal_inode_ops;
id|new_file-&gt;nlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_file
op_assign
id|create_proc_entry
c_func
(paren
id|FILENAME_CLOCK_SOURCE
comma
id|S_IFREG
op_or
l_int|0644
comma
id|ch-&gt;procdir
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|init_escape
c_func
(paren
id|ch
)paren
suffix:semicolon
id|new_file-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|new_file
suffix:semicolon
id|new_file-&gt;read_proc
op_assign
op_amp
id|munich_read_proc
suffix:semicolon
id|new_file-&gt;write_proc
op_assign
op_amp
id|munich_write_proc
suffix:semicolon
singleline_comment|//              new_file-&gt;proc_iops = &amp;comx_normal_inode_ops;
id|new_file-&gt;nlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_file
op_assign
id|create_proc_entry
c_func
(paren
id|FILENAME_LOOPBACK
comma
id|S_IFREG
op_or
l_int|0644
comma
id|ch-&gt;procdir
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|init_escape
c_func
(paren
id|ch
)paren
suffix:semicolon
id|new_file-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|new_file
suffix:semicolon
id|new_file-&gt;read_proc
op_assign
op_amp
id|munich_read_proc
suffix:semicolon
id|new_file-&gt;write_proc
op_assign
op_amp
id|munich_write_proc
suffix:semicolon
singleline_comment|//              new_file-&gt;proc_iops = &amp;comx_normal_inode_ops;
id|new_file-&gt;nlink
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* DEL: ez itt csak fejlesztesi celokra!! */
r_if
c_cond
(paren
(paren
id|new_file
op_assign
id|create_proc_entry
c_func
(paren
id|FILENAME_REG
comma
id|S_IFREG
op_or
l_int|0200
comma
id|ch-&gt;procdir
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|init_escape
c_func
(paren
id|ch
)paren
suffix:semicolon
id|new_file-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|new_file
suffix:semicolon
id|new_file-&gt;read_proc
op_assign
op_amp
id|munich_read_proc
suffix:semicolon
id|new_file-&gt;write_proc
op_assign
op_amp
id|munich_write_proc
suffix:semicolon
singleline_comment|//      new_file-&gt;proc_iops = &amp;comx_normal_inode_ops;
id|new_file-&gt;nlink
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* DEL: ez itt csak fejlesztesi celokra!! */
r_if
c_cond
(paren
(paren
id|new_file
op_assign
id|create_proc_entry
c_func
(paren
id|FILENAME_LBIREG
comma
id|S_IFREG
op_or
l_int|0200
comma
id|ch-&gt;procdir
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|init_escape
c_func
(paren
id|ch
)paren
suffix:semicolon
id|new_file-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|new_file
suffix:semicolon
id|new_file-&gt;read_proc
op_assign
op_amp
id|munich_read_proc
suffix:semicolon
id|new_file-&gt;write_proc
op_assign
op_amp
id|munich_write_proc
suffix:semicolon
singleline_comment|//      new_file-&gt;proc_iops = &amp;comx_normal_inode_ops;
id|new_file-&gt;nlink
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Fill in ch_struct hw specific pointers: */
id|ch-&gt;HW_txe
op_assign
id|MUNICH_txe
suffix:semicolon
id|ch-&gt;HW_open
op_assign
id|MUNICH_open
suffix:semicolon
id|ch-&gt;HW_close
op_assign
id|MUNICH_close
suffix:semicolon
id|ch-&gt;HW_send_packet
op_assign
id|MUNICH_send_packet
suffix:semicolon
macro_line|#ifndef COMX_NEW
id|ch-&gt;HW_minden
op_assign
id|MUNICH_minden
suffix:semicolon
macro_line|#else
id|ch-&gt;HW_statistics
op_assign
id|MUNICH_minden
suffix:semicolon
macro_line|#endif
id|hw-&gt;boardnum
op_assign
id|SLICECOM_BOARDNUM_DEFAULT
suffix:semicolon
id|hw-&gt;timeslots
op_assign
id|ch-&gt;hardware
op_eq
op_amp
id|pcicomhw
ques
c_cond
l_int|0xffffffff
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* O.K. Count one more user on this module */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Boardtype exit function.&n; * Called by the comx (upper) layer, when you clear boardtype from munich.&n; * Frees resources associated to using munich board for this device,&n; * resets ch_struct pointers etc.&n; */
DECL|function|BOARD_exit
r_static
r_int
id|BOARD_exit
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|comx_channel
op_star
id|ch
op_assign
(paren
r_struct
id|comx_channel
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|slicecom_privdata
op_star
id|hw
op_assign
id|ch-&gt;HW_privdata
suffix:semicolon
singleline_comment|//    munich_board_t *board;
multiline_comment|/* Free private data area */
singleline_comment|//    board = hw-&gt;boardnum + (ch-&gt;hardware == &amp;pcicomhw ? pcicom_boards : slicecom_boards);
id|kfree
c_func
(paren
id|ch-&gt;HW_privdata
)paren
suffix:semicolon
multiline_comment|/* Remove /proc files */
id|remove_proc_entry
c_func
(paren
id|FILENAME_BOARDNUM
comma
id|ch-&gt;procdir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;hardware
op_eq
op_amp
id|slicecomhw
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|FILENAME_TIMESLOTS
comma
id|ch-&gt;procdir
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|FILENAME_FRAMING
comma
id|ch-&gt;procdir
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|FILENAME_LINECODE
comma
id|ch-&gt;procdir
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|FILENAME_CLOCK_SOURCE
comma
id|ch-&gt;procdir
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|FILENAME_LOOPBACK
comma
id|ch-&gt;procdir
)paren
suffix:semicolon
)brace
id|remove_proc_entry
c_func
(paren
id|FILENAME_REG
comma
id|ch-&gt;procdir
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|FILENAME_LBIREG
comma
id|ch-&gt;procdir
)paren
suffix:semicolon
multiline_comment|/* Minus one user for the module accounting */
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|slicecomhw
r_static
r_struct
id|comx_hardware
id|slicecomhw
op_assign
(brace
l_string|&quot;slicecom&quot;
comma
macro_line|#ifdef COMX_NEW
id|VERSION
comma
macro_line|#endif
id|BOARD_init
comma
id|BOARD_exit
comma
id|BOARD_dump
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|pcicomhw
r_static
r_struct
id|comx_hardware
id|pcicomhw
op_assign
(brace
l_string|&quot;pcicom&quot;
comma
macro_line|#ifdef COMX_NEW
id|VERSION
comma
macro_line|#endif
id|BOARD_init
comma
id|BOARD_exit
comma
id|BOARD_dump
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Module management */
DECL|function|init_mister
r_int
id|__init
id|init_mister
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|VERSIONSTR
)paren
suffix:semicolon
id|comx_register_hardware
c_func
(paren
op_amp
id|slicecomhw
)paren
suffix:semicolon
id|comx_register_hardware
c_func
(paren
op_amp
id|pcicomhw
)paren
suffix:semicolon
r_return
id|munich_probe
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_mister
r_static
r_void
id|__exit
id|cleanup_mister
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|comx_unregister_hardware
c_func
(paren
l_string|&quot;slicecom&quot;
)paren
suffix:semicolon
id|comx_unregister_hardware
c_func
(paren
l_string|&quot;pcicom&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_BOARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|slicecom_boards
(braket
id|i
)braket
dot
id|bar1
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|slicecom_boards
(braket
id|i
)braket
dot
id|bar1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slicecom_boards
(braket
id|i
)braket
dot
id|lbi
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|slicecom_boards
(braket
id|i
)braket
dot
id|lbi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcicom_boards
(braket
id|i
)braket
dot
id|bar1
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|pcicom_boards
(braket
id|i
)braket
dot
id|bar1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcicom_boards
(braket
id|i
)braket
dot
id|lbi
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|pcicom_boards
(braket
id|i
)braket
dot
id|lbi
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init_mister
id|module_init
c_func
(paren
id|init_mister
)paren
suffix:semicolon
DECL|variable|cleanup_mister
id|module_exit
c_func
(paren
id|cleanup_mister
)paren
suffix:semicolon
eof
