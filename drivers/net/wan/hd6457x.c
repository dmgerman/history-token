multiline_comment|/*&n; * Hitachi SCA HD64570 and HD64572 common driver for Linux&n; *&n; * Copyright (C) 1998-2000 Krzysztof Halasa &lt;khc@pm.waw.pl&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * Sources of information:&n; *    Hitachi HD64570 SCA User&squot;s Manual&n; *    Hitachi HD64572 SCA-II User&squot;s Manual&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
macro_line|#if (!defined (__HD64570_H) &amp;&amp; !defined (__HD64572_H)) || &bslash;&n;    (defined (__HD64570_H) &amp;&amp; defined (__HD64572_H))
macro_line|#error Either hd64570.h or hd64572.h must be included
macro_line|#endif
DECL|variable|sca_version
r_static
r_char
id|sca_version
(braket
)braket
op_assign
l_string|&quot;1.09&quot;
suffix:semicolon
DECL|macro|get_msci
mdefine_line|#define get_msci(port)&t;  (phy_node(port) ?   MSCI1_OFFSET :   MSCI0_OFFSET)
DECL|macro|get_dmac_rx
mdefine_line|#define get_dmac_rx(port) (phy_node(port) ? DMAC1RX_OFFSET : DMAC0RX_OFFSET)
DECL|macro|get_dmac_tx
mdefine_line|#define get_dmac_tx(port) (phy_node(port) ? DMAC1TX_OFFSET : DMAC0TX_OFFSET)
DECL|macro|SCA_INTR_MSCI
mdefine_line|#define SCA_INTR_MSCI(node)    (node ? 0x10 : 0x01)
DECL|macro|SCA_INTR_DMAC_RX
mdefine_line|#define SCA_INTR_DMAC_RX(node) (node ? 0x20 : 0x02)
DECL|macro|SCA_INTR_DMAC_TX
mdefine_line|#define SCA_INTR_DMAC_TX(node) (node ? 0x40 : 0x04)
macro_line|#ifdef __HD64570_H /* HD64570 */
DECL|macro|sca_outa
mdefine_line|#define sca_outa(value, reg, card)&t;sca_outw(value, reg, card)
DECL|macro|sca_ina
mdefine_line|#define sca_ina(reg, card)&t;&t;sca_inw(reg, card)
DECL|macro|writea
mdefine_line|#define writea(value, ptr)&t;&t;writew(value, ptr)
macro_line|#else /* HD64572 */
DECL|macro|sca_outa
mdefine_line|#define sca_outa(value, reg, card)&t;sca_outl(value, reg, card)
DECL|macro|sca_ina
mdefine_line|#define sca_ina(reg, card)&t;&t;sca_inl(reg, card)
DECL|macro|writea
mdefine_line|#define writea(value, ptr)&t;&t;writel(value, ptr)
macro_line|#endif
DECL|function|sca_intr_status
r_static
r_inline
r_int
id|sca_intr_status
c_func
(paren
id|card_t
op_star
id|card
)paren
(brace
id|u8
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef __HD64570_H /* HD64570 */
id|u8
id|isr0
op_assign
id|sca_in
c_func
(paren
id|ISR0
comma
id|card
)paren
suffix:semicolon
id|u8
id|isr1
op_assign
id|sca_in
c_func
(paren
id|ISR1
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr1
op_amp
l_int|0x03
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_RX
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr1
op_amp
l_int|0x0C
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_TX
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr1
op_amp
l_int|0x30
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_RX
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr1
op_amp
l_int|0xC0
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_TX
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr0
op_amp
l_int|0x0F
)paren
id|result
op_or_assign
id|SCA_INTR_MSCI
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr0
op_amp
l_int|0xF0
)paren
id|result
op_or_assign
id|SCA_INTR_MSCI
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#else /* HD64572 */
id|u32
id|isr0
op_assign
id|sca_inl
c_func
(paren
id|ISR0
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr0
op_amp
l_int|0x0000000F
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_RX
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr0
op_amp
l_int|0x000000F0
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_TX
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr0
op_amp
l_int|0x00000F00
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_RX
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr0
op_amp
l_int|0x0000F000
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_TX
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr0
op_amp
l_int|0x003E0000
)paren
id|result
op_or_assign
id|SCA_INTR_MSCI
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr0
op_amp
l_int|0x3E000000
)paren
id|result
op_or_assign
id|SCA_INTR_MSCI
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif /* HD64570 vs HD64572 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_amp
id|SCA_INTR_DMAC_TX
c_func
(paren
l_int|0
)paren
)paren
)paren
r_if
c_cond
(paren
id|sca_in
c_func
(paren
id|DSR_TX
c_func
(paren
l_int|0
)paren
comma
id|card
)paren
op_amp
id|DSR_EOM
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_TX
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_amp
id|SCA_INTR_DMAC_TX
c_func
(paren
l_int|1
)paren
)paren
)paren
r_if
c_cond
(paren
id|sca_in
c_func
(paren
id|DSR_TX
c_func
(paren
l_int|1
)paren
comma
id|card
)paren
op_amp
id|DSR_EOM
)paren
id|result
op_or_assign
id|SCA_INTR_DMAC_TX
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|hdlc_to_port
r_static
r_inline
id|port_t
op_star
id|hdlc_to_port
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
r_return
(paren
id|port_t
op_star
)paren
id|hdlc
suffix:semicolon
)brace
DECL|function|dev_to_port
r_static
r_inline
id|port_t
op_star
id|dev_to_port
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|hdlc_to_port
c_func
(paren
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|next_desc
r_static
r_inline
id|u8
id|next_desc
c_func
(paren
id|port_t
op_star
id|port
comma
id|u8
id|desc
)paren
(brace
r_return
(paren
id|desc
op_plus
l_int|1
)paren
op_mod
id|port_to_card
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|ring_buffers
suffix:semicolon
)brace
DECL|function|desc_offset
r_static
r_inline
id|u16
id|desc_offset
c_func
(paren
id|port_t
op_star
id|port
comma
id|u8
id|desc
comma
id|u8
id|transmit
)paren
(brace
multiline_comment|/* Descriptor offset always fits in 16 bytes */
id|u8
id|buffs
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|ring_buffers
suffix:semicolon
r_return
(paren
(paren
id|log_node
c_func
(paren
id|port
)paren
op_star
l_int|2
op_plus
id|transmit
)paren
op_star
id|buffs
op_plus
(paren
id|desc
op_mod
id|buffs
)paren
)paren
op_star
r_sizeof
(paren
id|pkt_desc
)paren
suffix:semicolon
)brace
DECL|function|desc_address
r_static
r_inline
id|pkt_desc
op_star
id|desc_address
c_func
(paren
id|port_t
op_star
id|port
comma
id|u8
id|desc
comma
id|u8
id|transmit
)paren
(brace
macro_line|#ifdef PAGE0_ALWAYS_MAPPED
r_return
(paren
id|pkt_desc
op_star
)paren
(paren
id|win0base
c_func
(paren
id|port_to_card
c_func
(paren
id|port
)paren
)paren
op_plus
id|desc_offset
c_func
(paren
id|port
comma
id|desc
comma
id|transmit
)paren
)paren
suffix:semicolon
macro_line|#else
r_return
(paren
id|pkt_desc
op_star
)paren
(paren
id|winbase
c_func
(paren
id|port_to_card
c_func
(paren
id|port
)paren
)paren
op_plus
id|desc_offset
c_func
(paren
id|port
comma
id|desc
comma
id|transmit
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|buffer_offset
r_static
r_inline
id|u32
id|buffer_offset
c_func
(paren
id|port_t
op_star
id|port
comma
id|u8
id|desc
comma
id|u8
id|transmit
)paren
(brace
id|u8
id|buffs
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|ring_buffers
suffix:semicolon
r_return
id|port_to_card
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|buff_offset
op_plus
(paren
(paren
id|log_node
c_func
(paren
id|port
)paren
op_star
l_int|2
op_plus
id|transmit
)paren
op_star
id|buffs
op_plus
(paren
id|desc
op_mod
id|buffs
)paren
)paren
op_star
(paren
id|u32
)paren
id|HDLC_MAX_MRU
suffix:semicolon
)brace
DECL|function|sca_init_sync_port
r_static
r_void
id|sca_init_sync_port
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
id|card_t
op_star
id|card
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|transmit
comma
id|i
suffix:semicolon
id|u16
id|dmac
comma
id|buffs
op_assign
id|card-&gt;ring_buffers
suffix:semicolon
id|port-&gt;rxin
op_assign
l_int|0
suffix:semicolon
id|port-&gt;txin
op_assign
l_int|0
suffix:semicolon
id|port-&gt;txlast
op_assign
l_int|0
suffix:semicolon
macro_line|#if !defined(PAGE0_ALWAYS_MAPPED) &amp;&amp; !defined(ALL_PAGES_ALWAYS_MAPPED)
id|openwin
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|transmit
op_assign
l_int|0
suffix:semicolon
id|transmit
OL
l_int|2
suffix:semicolon
id|transmit
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|buffs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pkt_desc
op_star
id|desc
op_assign
id|desc_address
c_func
(paren
id|port
comma
id|i
comma
id|transmit
)paren
suffix:semicolon
id|u16
id|chain_off
op_assign
id|desc_offset
c_func
(paren
id|port
comma
id|i
op_plus
l_int|1
comma
id|transmit
)paren
suffix:semicolon
id|u32
id|buff_off
op_assign
id|buffer_offset
c_func
(paren
id|port
comma
id|i
comma
id|transmit
)paren
suffix:semicolon
id|writea
c_func
(paren
id|chain_off
comma
op_amp
id|desc-&gt;cp
)paren
suffix:semicolon
id|writel
c_func
(paren
id|buff_off
comma
op_amp
id|desc-&gt;bp
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
op_amp
id|desc-&gt;len
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|desc-&gt;stat
)paren
suffix:semicolon
)brace
id|dmac
op_assign
id|transmit
ques
c_cond
id|get_dmac_tx
c_func
(paren
id|port
)paren
suffix:colon
id|get_dmac_rx
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* DMA disable - to halt state */
id|sca_out
c_func
(paren
l_int|0
comma
id|transmit
ques
c_cond
id|DSR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
suffix:colon
id|DSR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* software ABORT - to initial state */
id|sca_out
c_func
(paren
id|DCR_ABORT
comma
id|transmit
ques
c_cond
id|DCR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
suffix:colon
id|DCR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
macro_line|#ifdef __HD64570_H
id|sca_out
c_func
(paren
l_int|0
comma
id|dmac
op_plus
id|CPB
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* pointer base */
macro_line|#endif
multiline_comment|/* current desc addr */
id|sca_outa
c_func
(paren
id|desc_offset
c_func
(paren
id|port
comma
l_int|0
comma
id|transmit
)paren
comma
id|dmac
op_plus
id|CDAL
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|transmit
)paren
id|sca_outa
c_func
(paren
id|desc_offset
c_func
(paren
id|port
comma
id|buffs
op_minus
l_int|1
comma
id|transmit
)paren
comma
id|dmac
op_plus
id|EDAL
comma
id|card
)paren
suffix:semicolon
r_else
id|sca_outa
c_func
(paren
id|desc_offset
c_func
(paren
id|port
comma
l_int|0
comma
id|transmit
)paren
comma
id|dmac
op_plus
id|EDAL
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* clear frame end interrupt counter */
id|sca_out
c_func
(paren
id|DCR_CLEAR_EOF
comma
id|transmit
ques
c_cond
id|DCR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
suffix:colon
id|DCR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|transmit
)paren
(brace
multiline_comment|/* Receive */
multiline_comment|/* set buffer length */
id|sca_outw
c_func
(paren
id|HDLC_MAX_MRU
comma
id|dmac
op_plus
id|BFLL
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* Chain mode, Multi-frame */
id|sca_out
c_func
(paren
l_int|0x14
comma
id|DMR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|DIR_EOME
op_or
id|DIR_BOFE
comma
id|DIR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* DMA enable */
id|sca_out
c_func
(paren
id|DSR_DE
comma
id|DSR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Transmit */
multiline_comment|/* Chain mode, Multi-frame */
id|sca_out
c_func
(paren
l_int|0x14
comma
id|DMR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* enable underflow interrupts */
id|sca_out
c_func
(paren
id|DIR_BOFE
comma
id|DIR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* MSCI interrupt service */
DECL|function|sca_msci_intr
r_static
r_inline
r_void
id|sca_msci_intr
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
id|u16
id|msci
op_assign
id|get_msci
c_func
(paren
id|port
)paren
suffix:semicolon
id|card_t
op_star
id|card
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|stat
op_assign
id|sca_in
c_func
(paren
id|msci
op_plus
id|ST1
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* read MSCI ST1 status */
multiline_comment|/* printk(KERN_DEBUG &quot;MSCI INT: ST1=%02X ILAR=%02X&bslash;n&quot;,&n;&t;   stat, sca_in(ILAR, card)); */
multiline_comment|/* Reset MSCI TX underrun status bit */
id|sca_out
c_func
(paren
id|stat
op_amp
id|ST1_UDRN
comma
id|msci
op_plus
id|ST1
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|ST1_UDRN
)paren
(brace
id|port-&gt;hdlc.stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* TX Underrun error detected */
id|port-&gt;hdlc.stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
)brace
DECL|function|sca_rx
r_static
r_inline
r_void
id|sca_rx
c_func
(paren
id|card_t
op_star
id|card
comma
id|port_t
op_star
id|port
comma
id|pkt_desc
op_star
id|desc
comma
id|u8
id|rxin
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u16
id|len
suffix:semicolon
id|u32
id|buff
suffix:semicolon
macro_line|#ifndef ALL_PAGES_ALWAYS_MAPPED
id|u32
id|maxlen
suffix:semicolon
id|u8
id|page
suffix:semicolon
macro_line|#endif
id|len
op_assign
id|readw
c_func
(paren
op_amp
id|desc-&gt;len
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|port-&gt;hdlc.stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|buff
op_assign
id|buffer_offset
c_func
(paren
id|port
comma
id|rxin
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifndef ALL_PAGES_ALWAYS_MAPPED
id|page
op_assign
id|buff
op_div
id|winsize
c_func
(paren
id|card
)paren
suffix:semicolon
id|buff
op_assign
id|buff
op_mod
id|winsize
c_func
(paren
id|card
)paren
suffix:semicolon
id|maxlen
op_assign
id|winsize
c_func
(paren
id|card
)paren
op_minus
id|buff
suffix:semicolon
id|openwin
c_func
(paren
id|card
comma
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|maxlen
)paren
(brace
id|memcpy_fromio
c_func
(paren
id|skb-&gt;data
comma
id|winbase
c_func
(paren
id|card
)paren
op_plus
id|buff
comma
id|maxlen
)paren
suffix:semicolon
id|openwin
c_func
(paren
id|card
comma
id|page
op_plus
l_int|1
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|skb-&gt;data
op_plus
id|maxlen
comma
id|winbase
c_func
(paren
id|card
)paren
comma
id|len
op_minus
id|maxlen
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
id|memcpy_fromio
c_func
(paren
id|skb-&gt;data
comma
id|winbase
c_func
(paren
id|card
)paren
op_plus
id|buff
comma
id|len
)paren
suffix:semicolon
macro_line|#if !defined(PAGE0_ALWAYS_MAPPED) &amp;&amp; !defined(ALL_PAGES_ALWAYS_MAPPED)
multiline_comment|/* select pkt_desc table page back */
id|openwin
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC_DEBUG_PKT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s RX(%i):&quot;
comma
id|hdlc_to_name
c_func
(paren
op_amp
id|port-&gt;hdlc
)paren
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|debug_frame
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|port-&gt;hdlc.stats.rx_packets
op_increment
suffix:semicolon
id|port-&gt;hdlc.stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|hdlc_to_dev
c_func
(paren
op_amp
id|port-&gt;hdlc
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_HDLC
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Receive DMA interrupt service */
DECL|function|sca_rx_intr
r_static
r_inline
r_void
id|sca_rx_intr
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
id|u16
id|dmac
op_assign
id|get_dmac_rx
c_func
(paren
id|port
)paren
suffix:semicolon
id|card_t
op_star
id|card
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|stat
op_assign
id|sca_in
c_func
(paren
id|DSR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* read DMA Status */
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|port-&gt;hdlc.stats
suffix:semicolon
multiline_comment|/* Reset DSR status bits */
id|sca_out
c_func
(paren
(paren
id|stat
op_amp
(paren
id|DSR_EOT
op_or
id|DSR_EOM
op_or
id|DSR_BOF
op_or
id|DSR_COF
)paren
)paren
op_or
id|DSR_DWE
comma
id|DSR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|DSR_BOF
)paren
id|stats-&gt;rx_over_errors
op_increment
suffix:semicolon
multiline_comment|/* Dropped one or more frames */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|u32
id|desc_off
op_assign
id|desc_offset
c_func
(paren
id|port
comma
id|port-&gt;rxin
comma
l_int|0
)paren
suffix:semicolon
id|pkt_desc
op_star
id|desc
suffix:semicolon
id|u32
id|cda
op_assign
id|sca_ina
c_func
(paren
id|dmac
op_plus
id|CDAL
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cda
op_ge
id|desc_off
)paren
op_logical_and
(paren
id|cda
OL
id|desc_off
op_plus
r_sizeof
(paren
id|pkt_desc
)paren
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* No frame received */
id|desc
op_assign
id|desc_address
c_func
(paren
id|port
comma
id|port-&gt;rxin
comma
l_int|0
)paren
suffix:semicolon
id|stat
op_assign
id|readb
c_func
(paren
op_amp
id|desc-&gt;stat
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|ST_RX_EOM
)paren
)paren
id|port-&gt;rxpart
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* partial frame received */
r_else
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|ST_ERROR_MASK
)paren
op_logical_or
id|port-&gt;rxpart
)paren
(brace
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|ST_RX_OVERRUN
)paren
id|stats-&gt;rx_fifo_errors
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|stat
op_amp
(paren
id|ST_RX_SHORT
op_or
id|ST_RX_ABORT
op_or
id|ST_RX_RESBIT
)paren
)paren
op_logical_or
id|port-&gt;rxpart
)paren
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stat
op_amp
id|ST_RX_CRC
)paren
id|stats-&gt;rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|ST_RX_EOM
)paren
id|port-&gt;rxpart
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* received last fragment */
)brace
r_else
id|sca_rx
c_func
(paren
id|card
comma
id|port
comma
id|desc
comma
id|port-&gt;rxin
)paren
suffix:semicolon
multiline_comment|/* Set new error descriptor address */
id|sca_outa
c_func
(paren
id|desc_off
comma
id|dmac
op_plus
id|EDAL
comma
id|card
)paren
suffix:semicolon
id|port-&gt;rxin
op_assign
id|next_desc
c_func
(paren
id|port
comma
id|port-&gt;rxin
)paren
suffix:semicolon
)brace
multiline_comment|/* make sure RX DMA is enabled */
id|sca_out
c_func
(paren
id|DSR_DE
comma
id|DSR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* Transmit DMA interrupt service */
DECL|function|sca_tx_intr
r_static
r_inline
r_void
id|sca_tx_intr
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
id|u16
id|dmac
op_assign
id|get_dmac_tx
c_func
(paren
id|port
)paren
suffix:semicolon
id|card_t
op_star
id|card
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|stat
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
id|stat
op_assign
id|sca_in
c_func
(paren
id|DSR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* read DMA Status */
multiline_comment|/* Reset DSR status bits */
id|sca_out
c_func
(paren
(paren
id|stat
op_amp
(paren
id|DSR_EOT
op_or
id|DSR_EOM
op_or
id|DSR_BOF
op_or
id|DSR_COF
)paren
)paren
op_or
id|DSR_DWE
comma
id|DSR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|pkt_desc
op_star
id|desc
suffix:semicolon
id|u32
id|desc_off
op_assign
id|desc_offset
c_func
(paren
id|port
comma
id|port-&gt;txlast
comma
l_int|1
)paren
suffix:semicolon
id|u32
id|cda
op_assign
id|sca_ina
c_func
(paren
id|dmac
op_plus
id|CDAL
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cda
op_ge
id|desc_off
)paren
op_logical_and
(paren
id|cda
OL
id|desc_off
op_plus
r_sizeof
(paren
id|pkt_desc
)paren
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Transmitter is/will_be sending this frame */
id|desc
op_assign
id|desc_address
c_func
(paren
id|port
comma
id|port-&gt;txlast
comma
l_int|1
)paren
suffix:semicolon
id|port-&gt;hdlc.stats.tx_packets
op_increment
suffix:semicolon
id|port-&gt;hdlc.stats.tx_bytes
op_add_assign
id|readw
c_func
(paren
op_amp
id|desc-&gt;len
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|desc-&gt;stat
)paren
suffix:semicolon
multiline_comment|/* Free descriptor */
id|port-&gt;txlast
op_assign
(paren
id|port-&gt;txlast
op_plus
l_int|1
)paren
op_mod
id|port_to_card
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|ring_buffers
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|hdlc_to_dev
c_func
(paren
op_amp
id|port-&gt;hdlc
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|sca_intr
r_static
r_void
id|sca_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|card_t
op_star
id|card
op_assign
id|dev_id
suffix:semicolon
multiline_comment|/* Maximum events to handle at each interrupt - should I increase it? */
r_int
id|boguscnt
op_assign
l_int|4
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u8
id|stat
suffix:semicolon
macro_line|#ifndef ALL_PAGES_ALWAYS_MAPPED
id|u8
id|page
op_assign
id|sca_get_page
c_func
(paren
id|card
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
(paren
id|stat
op_assign
id|sca_intr_status
c_func
(paren
id|card
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port_t
op_star
id|port
op_assign
id|get_port
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
(brace
r_if
c_cond
(paren
id|stat
op_amp
id|SCA_INTR_MSCI
c_func
(paren
id|i
)paren
)paren
id|sca_msci_intr
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|SCA_INTR_DMAC_RX
c_func
(paren
id|i
)paren
)paren
id|sca_rx_intr
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|SCA_INTR_DMAC_TX
c_func
(paren
id|i
)paren
)paren
id|sca_tx_intr
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: too much work at &quot;
l_string|&quot;interrupt&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
op_amp
id|port-&gt;hdlc
)paren
)paren
suffix:semicolon
macro_line|#endif
r_goto
m_exit
suffix:semicolon
)brace
)brace
)brace
m_exit
suffix:colon
macro_line|#ifndef ALL_PAGES_ALWAYS_MAPPED
id|openwin
c_func
(paren
id|card
comma
id|page
)paren
suffix:semicolon
multiline_comment|/* Restore original page */
macro_line|#endif
)brace
DECL|function|sca_set_port
r_static
r_void
id|sca_set_port
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
id|card_t
op_star
id|card
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|msci
op_assign
id|get_msci
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|md2
op_assign
id|sca_in
c_func
(paren
id|msci
op_plus
id|MD2
comma
id|card
)paren
suffix:semicolon
r_int
r_int
id|tmc
comma
id|br
op_assign
l_int|10
comma
id|brv
op_assign
l_int|1024
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;settings.clock_rate
OG
l_int|0
)paren
(brace
multiline_comment|/* Try lower br for better accuracy*/
r_do
(brace
id|br
op_decrement
suffix:semicolon
id|brv
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* brv = 2^9 = 512 max in specs */
multiline_comment|/* Baud Rate = CLOCK_BASE / TMC / 2^BR */
id|tmc
op_assign
id|CLOCK_BASE
op_div
(paren
id|brv
op_star
id|port-&gt;settings.clock_rate
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|br
OG
l_int|1
op_logical_and
id|tmc
op_le
l_int|128
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmc
OL
l_int|1
)paren
(brace
id|tmc
op_assign
l_int|1
suffix:semicolon
id|br
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* For baud=CLOCK_BASE we use tmc=1 br=0 */
id|brv
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tmc
OG
l_int|255
)paren
id|tmc
op_assign
l_int|256
suffix:semicolon
multiline_comment|/* tmc=0 means 256 - low baud rates */
id|port-&gt;settings.clock_rate
op_assign
id|CLOCK_BASE
op_div
(paren
id|brv
op_star
id|tmc
)paren
suffix:semicolon
)brace
r_else
(brace
id|br
op_assign
l_int|9
suffix:semicolon
multiline_comment|/* Minimum clock rate */
id|tmc
op_assign
l_int|256
suffix:semicolon
multiline_comment|/* 8bit = 0 */
id|port-&gt;settings.clock_rate
op_assign
id|CLOCK_BASE
op_div
(paren
l_int|256
op_star
l_int|512
)paren
suffix:semicolon
)brace
id|port-&gt;rxs
op_assign
(paren
id|port-&gt;rxs
op_amp
op_complement
id|CLK_BRG_MASK
)paren
op_or
id|br
suffix:semicolon
id|port-&gt;txs
op_assign
(paren
id|port-&gt;txs
op_amp
op_complement
id|CLK_BRG_MASK
)paren
op_or
id|br
suffix:semicolon
id|port-&gt;tmc
op_assign
id|tmc
suffix:semicolon
multiline_comment|/* baud divisor - time constant*/
macro_line|#ifdef __HD64570_H
id|sca_out
c_func
(paren
id|port-&gt;tmc
comma
id|msci
op_plus
id|TMC
comma
id|card
)paren
suffix:semicolon
macro_line|#else
id|sca_out
c_func
(paren
id|port-&gt;tmc
comma
id|msci
op_plus
id|TMCR
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|port-&gt;tmc
comma
id|msci
op_plus
id|TMCT
comma
id|card
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set BRG bits */
id|sca_out
c_func
(paren
id|port-&gt;rxs
comma
id|msci
op_plus
id|RXS
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|port-&gt;txs
comma
id|msci
op_plus
id|TXS
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;settings.loopback
)paren
id|md2
op_or_assign
id|MD2_LOOPBACK
suffix:semicolon
r_else
id|md2
op_and_assign
op_complement
id|MD2_LOOPBACK
suffix:semicolon
id|sca_out
c_func
(paren
id|md2
comma
id|msci
op_plus
id|MD2
comma
id|card
)paren
suffix:semicolon
)brace
DECL|function|sca_open
r_static
r_void
id|sca_open
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|port_t
op_star
id|port
op_assign
id|hdlc_to_port
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|card_t
op_star
id|card
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|msci
op_assign
id|get_msci
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|md0
comma
id|md2
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;encoding
)paren
(brace
r_case
id|ENCODING_NRZ
suffix:colon
id|md2
op_assign
id|MD2_NRZ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_NRZI
suffix:colon
id|md2
op_assign
id|MD2_NRZI
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_FM_MARK
suffix:colon
id|md2
op_assign
id|MD2_FM_MARK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_FM_SPACE
suffix:colon
id|md2
op_assign
id|MD2_FM_SPACE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|md2
op_assign
id|MD2_MANCHESTER
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port-&gt;settings.loopback
)paren
id|md2
op_or_assign
id|MD2_LOOPBACK
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;parity
)paren
(brace
r_case
id|PARITY_CRC16_PR0
suffix:colon
id|md0
op_assign
id|MD0_HDLC
op_or
id|MD0_CRC_16_0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARITY_CRC16_PR1
suffix:colon
id|md0
op_assign
id|MD0_HDLC
op_or
id|MD0_CRC_16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef __HD64570_H
r_case
id|PARITY_CRC16_PR0_CCITT
suffix:colon
id|md0
op_assign
id|MD0_HDLC
op_or
id|MD0_CRC_ITU_0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
r_case
id|PARITY_CRC32_PR1_CCITT
suffix:colon
id|md0
op_assign
id|MD0_HDLC
op_or
id|MD0_CRC_ITU32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif&t;
r_case
id|PARITY_CRC16_PR1_CCITT
suffix:colon
id|md0
op_assign
id|MD0_HDLC
op_or
id|MD0_CRC_ITU
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|md0
op_assign
id|MD0_HDLC
op_or
id|MD0_CRC_NONE
suffix:semicolon
)brace
id|sca_out
c_func
(paren
id|CMD_RESET
comma
id|msci
op_plus
id|CMD
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|md0
comma
id|msci
op_plus
id|MD0
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
l_int|0x00
comma
id|msci
op_plus
id|MD1
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* no address field check */
id|sca_out
c_func
(paren
id|md2
comma
id|msci
op_plus
id|MD2
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
l_int|0x7E
comma
id|msci
op_plus
id|IDL
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* flag character 0x7E */
macro_line|#ifdef __HD64570_H
id|sca_out
c_func
(paren
id|CTL_IDLE
comma
id|msci
op_plus
id|CTL
comma
id|card
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Skip the rest of underrun frame */
id|sca_out
c_func
(paren
id|CTL_IDLE
op_or
id|CTL_URCT
op_or
id|CTL_URSKP
comma
id|msci
op_plus
id|CTL
comma
id|card
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef __HD64570_H
multiline_comment|/* Allow at least 8 bytes before requesting RX DMA operation */
multiline_comment|/* TX with higher priority and possibly with shorter transfers */
id|sca_out
c_func
(paren
l_int|0x07
comma
id|msci
op_plus
id|RRC
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* +1=RXRDY/DMA activation condition*/
id|sca_out
c_func
(paren
l_int|0x10
comma
id|msci
op_plus
id|TRC0
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* = TXRDY/DMA activation condition*/
id|sca_out
c_func
(paren
l_int|0x14
comma
id|msci
op_plus
id|TRC1
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* +1=TXRDY/DMA deactiv condition */
macro_line|#else
id|sca_out
c_func
(paren
l_int|0x0F
comma
id|msci
op_plus
id|RNR
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* +1=RX DMA activation condition */
id|sca_out
c_func
(paren
l_int|0x3C
comma
id|msci
op_plus
id|TFS
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* +1 = TX start */
id|sca_out
c_func
(paren
l_int|0x38
comma
id|msci
op_plus
id|TCR
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* =Critical TX DMA activ condition */
id|sca_out
c_func
(paren
l_int|0x38
comma
id|msci
op_plus
id|TNR0
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* =TX DMA activation condition */
id|sca_out
c_func
(paren
l_int|0x3F
comma
id|msci
op_plus
id|TNR1
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* +1=TX DMA deactivation condition*/
macro_line|#endif
multiline_comment|/* We&squot;re using the following interrupts:&n;   - TXINT (DMAC completed all transmisions, underflow or CTS change)&n;   - all DMA interrupts&n;*/
macro_line|#ifdef __HD64570_H
multiline_comment|/* MSCI TX INT IRQ enable */
id|sca_out
c_func
(paren
id|IE0_TXINT
comma
id|msci
op_plus
id|IE0
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|IE1_UDRN
comma
id|msci
op_plus
id|IE1
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* TX underrun -&gt; TXINT */
id|sca_out
c_func
(paren
id|sca_in
c_func
(paren
id|IER0
comma
id|card
)paren
op_or
(paren
id|phy_node
c_func
(paren
id|port
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x08
)paren
comma
id|IER0
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* DMA IRQ enable */
id|sca_out
c_func
(paren
id|sca_in
c_func
(paren
id|IER1
comma
id|card
)paren
op_or
(paren
id|phy_node
c_func
(paren
id|port
)paren
ques
c_cond
l_int|0xF0
suffix:colon
l_int|0x0F
)paren
comma
id|IER1
comma
id|card
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* MSCI TX INT IRQ enable */
id|sca_outl
c_func
(paren
id|IE0_TXINT
op_or
id|IE0_UDRN
comma
id|msci
op_plus
id|IE0
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* DMA &amp; MSCI IRQ enable */
id|sca_outl
c_func
(paren
id|sca_in
c_func
(paren
id|IER0
comma
id|card
)paren
op_or
(paren
id|phy_node
c_func
(paren
id|port
)paren
ques
c_cond
l_int|0x02006600
suffix:colon
l_int|0x00020066
)paren
comma
id|IER0
comma
id|card
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef __HD64570_H
id|sca_out
c_func
(paren
id|port-&gt;tmc
comma
id|msci
op_plus
id|TMC
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* Restore registers */
macro_line|#else
id|sca_out
c_func
(paren
id|port-&gt;tmc
comma
id|msci
op_plus
id|TMCR
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|port-&gt;tmc
comma
id|msci
op_plus
id|TMCT
comma
id|card
)paren
suffix:semicolon
macro_line|#endif
id|sca_out
c_func
(paren
id|port-&gt;rxs
comma
id|msci
op_plus
id|RXS
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|port-&gt;txs
comma
id|msci
op_plus
id|TXS
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|CMD_TX_ENABLE
comma
id|msci
op_plus
id|CMD
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|CMD_RX_ENABLE
comma
id|msci
op_plus
id|CMD
comma
id|card
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|hdlc_to_dev
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
)brace
DECL|function|sca_close
r_static
r_void
id|sca_close
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|port_t
op_star
id|port
op_assign
id|hdlc_to_port
c_func
(paren
id|hdlc
)paren
suffix:semicolon
multiline_comment|/* reset channel */
id|netif_stop_queue
c_func
(paren
id|hdlc_to_dev
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|CMD_RESET
comma
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|CMD
comma
id|port_to_card
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
DECL|function|sca_attach
r_static
r_int
id|sca_attach
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_int
r_int
id|encoding
comma
r_int
r_int
id|parity
)paren
(brace
r_if
c_cond
(paren
id|encoding
op_ne
id|ENCODING_NRZ
op_logical_and
id|encoding
op_ne
id|ENCODING_NRZI
op_logical_and
id|encoding
op_ne
id|ENCODING_FM_MARK
op_logical_and
id|encoding
op_ne
id|ENCODING_FM_SPACE
op_logical_and
id|encoding
op_ne
id|ENCODING_MANCHESTER
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|parity
op_ne
id|PARITY_NONE
op_logical_and
id|parity
op_ne
id|PARITY_CRC16_PR0
op_logical_and
id|parity
op_ne
id|PARITY_CRC16_PR1
op_logical_and
macro_line|#ifdef __HD64570_H
id|parity
op_ne
id|PARITY_CRC16_PR0_CCITT
op_logical_and
macro_line|#else
id|parity
op_ne
id|PARITY_CRC32_PR1_CCITT
op_logical_and
macro_line|#endif&t;
id|parity
op_ne
id|PARITY_CRC16_PR1_CCITT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hdlc_to_port
c_func
(paren
id|hdlc
)paren
op_member_access_from_pointer
id|encoding
op_assign
id|encoding
suffix:semicolon
id|hdlc_to_port
c_func
(paren
id|hdlc
)paren
op_member_access_from_pointer
id|parity
op_assign
id|parity
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HDLC_DEBUG_RINGS
DECL|function|sca_dump_rings
r_static
r_void
id|sca_dump_rings
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|port_t
op_star
id|port
op_assign
id|hdlc_to_port
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|card_t
op_star
id|card
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
suffix:semicolon
id|u16
id|cnt
suffix:semicolon
macro_line|#if !defined(PAGE0_ALWAYS_MAPPED) &amp;&amp; !defined(ALL_PAGES_ALWAYS_MAPPED)
id|u8
id|page
suffix:semicolon
macro_line|#endif
macro_line|#if !defined(PAGE0_ALWAYS_MAPPED) &amp;&amp; !defined(ALL_PAGES_ALWAYS_MAPPED)
id|page
op_assign
id|sca_get_page
c_func
(paren
id|card
)paren
suffix:semicolon
id|openwin
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;RX ring: CDA=%u EDA=%u DSR=%02X in=%u &quot;
l_string|&quot;%sactive&quot;
comma
id|sca_ina
c_func
(paren
id|get_dmac_rx
c_func
(paren
id|port
)paren
op_plus
id|CDAL
comma
id|card
)paren
comma
id|sca_ina
c_func
(paren
id|get_dmac_rx
c_func
(paren
id|port
)paren
op_plus
id|EDAL
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|DSR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
comma
id|port-&gt;rxin
comma
id|sca_in
c_func
(paren
id|DSR_RX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
op_amp
id|DSR_DE
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;in&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|port_to_card
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|ring_buffers
suffix:semicolon
id|cnt
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
id|readb
c_func
(paren
op_amp
(paren
id|desc_address
c_func
(paren
id|port
comma
id|cnt
comma
l_int|0
)paren
op_member_access_from_pointer
id|stat
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_ERR
l_string|&quot;TX ring: CDA=%u EDA=%u DSR=%02X in=%u &quot;
l_string|&quot;last=%u %sactive&quot;
comma
id|sca_ina
c_func
(paren
id|get_dmac_tx
c_func
(paren
id|port
)paren
op_plus
id|CDAL
comma
id|card
)paren
comma
id|sca_ina
c_func
(paren
id|get_dmac_tx
c_func
(paren
id|port
)paren
op_plus
id|EDAL
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|DSR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
comma
id|port-&gt;txin
comma
id|port-&gt;txlast
comma
id|sca_in
c_func
(paren
id|DSR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
op_amp
id|DSR_DE
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;in&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|port_to_card
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|ring_buffers
suffix:semicolon
id|cnt
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02X&quot;
comma
id|readb
c_func
(paren
op_amp
(paren
id|desc_address
c_func
(paren
id|port
comma
id|cnt
comma
l_int|1
)paren
op_member_access_from_pointer
id|stat
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSCI: MD: %02x %02x %02x, &quot;
l_string|&quot;ST: %02x %02x %02x %02x&quot;
macro_line|#ifdef __HD64572_H
l_string|&quot; %02x&quot;
macro_line|#endif
l_string|&quot;, FST: %02x CST: %02x %02x&bslash;n&quot;
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|MD0
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|MD1
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|MD2
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|ST0
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|ST1
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|ST2
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|ST3
comma
id|card
)paren
comma
macro_line|#ifdef __HD64572_H
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|ST4
comma
id|card
)paren
comma
macro_line|#endif
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|FST
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|CST0
comma
id|card
)paren
comma
id|sca_in
c_func
(paren
id|get_msci
c_func
(paren
id|port
)paren
op_plus
id|CST1
comma
id|card
)paren
)paren
suffix:semicolon
macro_line|#ifdef __HD64572_H
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ILAR: %02x&bslash;n&quot;
comma
id|sca_in
c_func
(paren
id|ILAR
comma
id|card
)paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if !defined(PAGE0_ALWAYS_MAPPED) &amp;&amp; !defined(ALL_PAGES_ALWAYS_MAPPED)
id|openwin
c_func
(paren
id|card
comma
id|page
)paren
suffix:semicolon
multiline_comment|/* Restore original page */
macro_line|#endif
)brace
macro_line|#endif /* CONFIG_HDLC_DEBUG_RINGS */
DECL|function|sca_xmit
r_static
r_int
id|sca_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|hdlc_device
op_star
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|port_t
op_star
id|port
op_assign
id|hdlc_to_port
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|card_t
op_star
id|card
op_assign
id|port_to_card
c_func
(paren
id|port
)paren
suffix:semicolon
id|pkt_desc
op_star
id|desc
suffix:semicolon
id|u32
id|buff
comma
id|len
suffix:semicolon
macro_line|#ifndef ALL_PAGES_ALWAYS_MAPPED
id|u8
id|page
suffix:semicolon
id|u32
id|maxlen
suffix:semicolon
macro_line|#endif
id|spin_lock_irq
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
id|desc
op_assign
id|desc_address
c_func
(paren
id|port
comma
id|port-&gt;txin
op_plus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|desc-&gt;stat
)paren
)paren
(brace
multiline_comment|/* allow 1 packet gap */
multiline_comment|/* should never happen - previous xmit should stop queue */
macro_line|#ifdef CONFIG_HDLC_DEBUG_PKT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: transmitter buffer full&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* request packet to be queued */
)brace
macro_line|#ifdef CONFIG_HDLC_DEBUG_PKT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s TX(%i):&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|debug_frame
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|desc
op_assign
id|desc_address
c_func
(paren
id|port
comma
id|port-&gt;txin
comma
l_int|1
)paren
suffix:semicolon
id|buff
op_assign
id|buffer_offset
c_func
(paren
id|port
comma
id|port-&gt;txin
comma
l_int|1
)paren
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
macro_line|#ifndef ALL_PAGES_ALWAYS_MAPPED
id|page
op_assign
id|buff
op_div
id|winsize
c_func
(paren
id|card
)paren
suffix:semicolon
id|buff
op_assign
id|buff
op_mod
id|winsize
c_func
(paren
id|card
)paren
suffix:semicolon
id|maxlen
op_assign
id|winsize
c_func
(paren
id|card
)paren
op_minus
id|buff
suffix:semicolon
id|openwin
c_func
(paren
id|card
comma
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|maxlen
)paren
(brace
id|memcpy_toio
c_func
(paren
id|winbase
c_func
(paren
id|card
)paren
op_plus
id|buff
comma
id|skb-&gt;data
comma
id|maxlen
)paren
suffix:semicolon
id|openwin
c_func
(paren
id|card
comma
id|page
op_plus
l_int|1
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|winbase
c_func
(paren
id|card
)paren
comma
id|skb-&gt;data
op_plus
id|maxlen
comma
id|len
op_minus
id|maxlen
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
id|memcpy_toio
c_func
(paren
id|winbase
c_func
(paren
id|card
)paren
op_plus
id|buff
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
macro_line|#if !defined(PAGE0_ALWAYS_MAPPED) &amp;&amp; !defined(ALL_PAGES_ALWAYS_MAPPED)
id|openwin
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* select pkt_desc table page back */
macro_line|#endif
id|writew
c_func
(paren
id|len
comma
op_amp
id|desc-&gt;len
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|ST_TX_EOM
comma
op_amp
id|desc-&gt;stat
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|port-&gt;txin
op_assign
id|next_desc
c_func
(paren
id|port
comma
id|port-&gt;txin
)paren
suffix:semicolon
id|sca_outa
c_func
(paren
id|desc_offset
c_func
(paren
id|port
comma
id|port-&gt;txin
comma
l_int|1
)paren
comma
id|get_dmac_tx
c_func
(paren
id|port
)paren
op_plus
id|EDAL
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|DSR_DE
comma
id|DSR_TX
c_func
(paren
id|phy_node
c_func
(paren
id|port
)paren
)paren
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* Enable TX DMA */
id|desc
op_assign
id|desc_address
c_func
(paren
id|port
comma
id|port-&gt;txin
op_plus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|desc-&gt;stat
)paren
)paren
multiline_comment|/* allow 1 packet gap */
id|netif_stop_queue
c_func
(paren
id|hdlc_to_dev
c_func
(paren
op_amp
id|port-&gt;hdlc
)paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sca_init
r_static
r_void
id|sca_init
c_func
(paren
id|card_t
op_star
id|card
comma
r_int
id|wait_states
)paren
(brace
id|sca_out
c_func
(paren
id|wait_states
comma
id|WCRL
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* Wait Control */
id|sca_out
c_func
(paren
id|wait_states
comma
id|WCRM
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|wait_states
comma
id|WCRH
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
l_int|0
comma
id|DMER
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* DMA Master disable */
id|sca_out
c_func
(paren
l_int|0x03
comma
id|PCR
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* DMA priority */
id|sca_out
c_func
(paren
l_int|0
comma
id|IER1
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* DMA interrupt disable */
id|sca_out
c_func
(paren
l_int|0
comma
id|DSR_RX
c_func
(paren
l_int|0
)paren
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* DMA disable - to halt state */
id|sca_out
c_func
(paren
l_int|0
comma
id|DSR_TX
c_func
(paren
l_int|0
)paren
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
l_int|0
comma
id|DSR_RX
c_func
(paren
l_int|1
)paren
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
l_int|0
comma
id|DSR_TX
c_func
(paren
l_int|1
)paren
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|DMER_DME
comma
id|DMER
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* DMA Master enable */
)brace
eof
