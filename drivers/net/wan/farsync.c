multiline_comment|/*&n; *      FarSync WAN driver for Linux (2.6.x kernel version)&n; *&n; *      Actually sync driver for X.21, V.35 and V.24 on FarSync T-series cards&n; *&n; *      Copyright (C) 2001-2004 FarSite Communications Ltd.&n; *      www.farsite.co.uk&n; *&n; *      This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; *&n; *      Author:      R.J.Dunlop    &lt;bob.dunlop@farsite.co.uk&gt;&n; *      Maintainer:  Kevin Curtis  &lt;kevin.curtis@farsite.co.uk&gt;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;farsync.h&quot;
multiline_comment|/*&n; *      Module info&n; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;R.J.Dunlop &lt;bob.dunlop@farsite.co.uk&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;FarSync T-Series WAN driver. FarSite Communications Ltd.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fst_txq_low
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fst_txq_high
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fst_max_reads
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fst_excluded_cards
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fst_excluded_list
comma
l_string|&quot;0-32i&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*      Driver configuration and global parameters&n; *      ==========================================&n; */
multiline_comment|/*      Number of ports (per card) and cards supported&n; */
DECL|macro|FST_MAX_PORTS
mdefine_line|#define FST_MAX_PORTS           4
DECL|macro|FST_MAX_CARDS
mdefine_line|#define FST_MAX_CARDS           32
multiline_comment|/*      Default parameters for the link&n; */
DECL|macro|FST_TX_QUEUE_LEN
mdefine_line|#define FST_TX_QUEUE_LEN        100&t;/* At 8Mbps a longer queue length is&n;&t;&t;&t;&t;&t; * useful, the syncppp module forces&n;&t;&t;&t;&t;&t; * this down assuming a slower line I&n;&t;&t;&t;&t;&t; * guess.&n;&t;&t;&t;&t;&t; */
DECL|macro|FST_TXQ_DEPTH
mdefine_line|#define FST_TXQ_DEPTH           16&t;/* This one is for the buffering&n;&t;&t;&t;&t;&t; * of frames on the way down to the card&n;&t;&t;&t;&t;&t; * so that we can keep the card busy&n;&t;&t;&t;&t;&t; * and maximise throughput&n;&t;&t;&t;&t;&t; */
DECL|macro|FST_HIGH_WATER_MARK
mdefine_line|#define FST_HIGH_WATER_MARK     12&t;/* Point at which we flow control&n;&t;&t;&t;&t;&t; * network layer */
DECL|macro|FST_LOW_WATER_MARK
mdefine_line|#define FST_LOW_WATER_MARK      8&t;/* Point at which we remove flow&n;&t;&t;&t;&t;&t; * control from network layer */
DECL|macro|FST_MAX_MTU
mdefine_line|#define FST_MAX_MTU             8000&t;/* Huge but possible */
DECL|macro|FST_DEF_MTU
mdefine_line|#define FST_DEF_MTU             1500&t;/* Common sane value */
DECL|macro|FST_TX_TIMEOUT
mdefine_line|#define FST_TX_TIMEOUT          (2*HZ)
macro_line|#ifdef ARPHRD_RAWHDLC
DECL|macro|ARPHRD_MYTYPE
mdefine_line|#define ARPHRD_MYTYPE   ARPHRD_RAWHDLC&t;/* Raw frames */
macro_line|#else
DECL|macro|ARPHRD_MYTYPE
mdefine_line|#define ARPHRD_MYTYPE   ARPHRD_HDLC&t;/* Cisco-HDLC (keepalives etc) */
macro_line|#endif
multiline_comment|/*&n; * Modules parameters and associated varaibles&n; */
DECL|variable|fst_txq_low
r_int
id|fst_txq_low
op_assign
id|FST_LOW_WATER_MARK
suffix:semicolon
DECL|variable|fst_txq_high
r_int
id|fst_txq_high
op_assign
id|FST_HIGH_WATER_MARK
suffix:semicolon
DECL|variable|fst_max_reads
r_int
id|fst_max_reads
op_assign
l_int|7
suffix:semicolon
DECL|variable|fst_excluded_cards
r_int
id|fst_excluded_cards
op_assign
l_int|0
suffix:semicolon
DECL|variable|fst_excluded_list
r_int
id|fst_excluded_list
(braket
id|FST_MAX_CARDS
)braket
suffix:semicolon
multiline_comment|/*      Card shared memory layout&n; *      =========================&n; */
macro_line|#pragma pack(1)
multiline_comment|/*      This information is derived in part from the FarSite FarSync Smc.h&n; *      file. Unfortunately various name clashes and the non-portability of the&n; *      bit field declarations in that file have meant that I have chosen to&n; *      recreate the information here.&n; *&n; *      The SMC (Shared Memory Configuration) has a version number that is&n; *      incremented every time there is a significant change. This number can&n; *      be used to check that we have not got out of step with the firmware&n; *      contained in the .CDE files.&n; */
DECL|macro|SMC_VERSION
mdefine_line|#define SMC_VERSION 24
DECL|macro|FST_MEMSIZE
mdefine_line|#define FST_MEMSIZE 0x100000&t;/* Size of card memory (1Mb) */
DECL|macro|SMC_BASE
mdefine_line|#define SMC_BASE 0x00002000L&t;/* Base offset of the shared memory window main&n;&t;&t;&t;&t; * configuration structure */
DECL|macro|BFM_BASE
mdefine_line|#define BFM_BASE 0x00010000L&t;/* Base offset of the shared memory window DMA&n;&t;&t;&t;&t; * buffers */
DECL|macro|LEN_TX_BUFFER
mdefine_line|#define LEN_TX_BUFFER 8192&t;/* Size of packet buffers */
DECL|macro|LEN_RX_BUFFER
mdefine_line|#define LEN_RX_BUFFER 8192
DECL|macro|LEN_SMALL_TX_BUFFER
mdefine_line|#define LEN_SMALL_TX_BUFFER 256&t;/* Size of obsolete buffs used for DOS diags */
DECL|macro|LEN_SMALL_RX_BUFFER
mdefine_line|#define LEN_SMALL_RX_BUFFER 256
DECL|macro|NUM_TX_BUFFER
mdefine_line|#define NUM_TX_BUFFER 2&t;&t;/* Must be power of 2. Fixed by firmware */
DECL|macro|NUM_RX_BUFFER
mdefine_line|#define NUM_RX_BUFFER 8
multiline_comment|/* Interrupt retry time in milliseconds */
DECL|macro|INT_RETRY_TIME
mdefine_line|#define INT_RETRY_TIME 2
multiline_comment|/*      The Am186CH/CC processors support a SmartDMA mode using circular pools&n; *      of buffer descriptors. The structure is almost identical to that used&n; *      in the LANCE Ethernet controllers. Details available as PDF from the&n; *      AMD web site: http://www.amd.com/products/epd/processors/&bslash;&n; *                    2.16bitcont/3.am186cxfa/a21914/21914.pdf&n; */
DECL|struct|txdesc
r_struct
id|txdesc
(brace
multiline_comment|/* Transmit descriptor */
DECL|member|ladr
r_volatile
id|u16
id|ladr
suffix:semicolon
multiline_comment|/* Low order address of packet. This is a&n;&t;&t;&t;&t; * linear address in the Am186 memory space&n;&t;&t;&t;&t; */
DECL|member|hadr
r_volatile
id|u8
id|hadr
suffix:semicolon
multiline_comment|/* High order address. Low 4 bits only, high 4&n;&t;&t;&t;&t; * bits must be zero&n;&t;&t;&t;&t; */
DECL|member|bits
r_volatile
id|u8
id|bits
suffix:semicolon
multiline_comment|/* Status and config */
DECL|member|bcnt
r_volatile
id|u16
id|bcnt
suffix:semicolon
multiline_comment|/* 2s complement of packet size in low 15 bits.&n;&t;&t;&t;&t; * Transmit terminal count interrupt enable in&n;&t;&t;&t;&t; * top bit.&n;&t;&t;&t;&t; */
DECL|member|unused
id|u16
id|unused
suffix:semicolon
multiline_comment|/* Not used in Tx */
)brace
suffix:semicolon
DECL|struct|rxdesc
r_struct
id|rxdesc
(brace
multiline_comment|/* Receive descriptor */
DECL|member|ladr
r_volatile
id|u16
id|ladr
suffix:semicolon
multiline_comment|/* Low order address of packet */
DECL|member|hadr
r_volatile
id|u8
id|hadr
suffix:semicolon
multiline_comment|/* High order address */
DECL|member|bits
r_volatile
id|u8
id|bits
suffix:semicolon
multiline_comment|/* Status and config */
DECL|member|bcnt
r_volatile
id|u16
id|bcnt
suffix:semicolon
multiline_comment|/* 2s complement of buffer size in low 15 bits.&n;&t;&t;&t;&t; * Receive terminal count interrupt enable in&n;&t;&t;&t;&t; * top bit.&n;&t;&t;&t;&t; */
DECL|member|mcnt
r_volatile
id|u16
id|mcnt
suffix:semicolon
multiline_comment|/* Message byte count (15 bits) */
)brace
suffix:semicolon
multiline_comment|/* Convert a length into the 15 bit 2&squot;s complement */
multiline_comment|/* #define cnv_bcnt(len)   (( ~(len) + 1 ) &amp; 0x7FFF ) */
multiline_comment|/* Since we need to set the high bit to enable the completion interrupt this&n; * can be made a lot simpler&n; */
DECL|macro|cnv_bcnt
mdefine_line|#define cnv_bcnt(len)   (-(len))
multiline_comment|/* Status and config bits for the above */
DECL|macro|DMA_OWN
mdefine_line|#define DMA_OWN         0x80&t;/* SmartDMA owns the descriptor */
DECL|macro|TX_STP
mdefine_line|#define TX_STP          0x02&t;/* Tx: start of packet */
DECL|macro|TX_ENP
mdefine_line|#define TX_ENP          0x01&t;/* Tx: end of packet */
DECL|macro|RX_ERR
mdefine_line|#define RX_ERR          0x40&t;/* Rx: error (OR of next 4 bits) */
DECL|macro|RX_FRAM
mdefine_line|#define RX_FRAM         0x20&t;/* Rx: framing error */
DECL|macro|RX_OFLO
mdefine_line|#define RX_OFLO         0x10&t;/* Rx: overflow error */
DECL|macro|RX_CRC
mdefine_line|#define RX_CRC          0x08&t;/* Rx: CRC error */
DECL|macro|RX_HBUF
mdefine_line|#define RX_HBUF         0x04&t;/* Rx: buffer error */
DECL|macro|RX_STP
mdefine_line|#define RX_STP          0x02&t;/* Rx: start of packet */
DECL|macro|RX_ENP
mdefine_line|#define RX_ENP          0x01&t;/* Rx: end of packet */
multiline_comment|/* Interrupts from the card are caused by various events which are presented&n; * in a circular buffer as several events may be processed on one physical int&n; */
DECL|macro|MAX_CIRBUFF
mdefine_line|#define MAX_CIRBUFF     32
DECL|struct|cirbuff
r_struct
id|cirbuff
(brace
DECL|member|rdindex
id|u8
id|rdindex
suffix:semicolon
multiline_comment|/* read, then increment and wrap */
DECL|member|wrindex
id|u8
id|wrindex
suffix:semicolon
multiline_comment|/* write, then increment and wrap */
DECL|member|evntbuff
id|u8
id|evntbuff
(braket
id|MAX_CIRBUFF
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Interrupt event codes.&n; * Where appropriate the two low order bits indicate the port number&n; */
DECL|macro|CTLA_CHG
mdefine_line|#define CTLA_CHG        0x18&t;/* Control signal changed */
DECL|macro|CTLB_CHG
mdefine_line|#define CTLB_CHG        0x19
DECL|macro|CTLC_CHG
mdefine_line|#define CTLC_CHG        0x1A
DECL|macro|CTLD_CHG
mdefine_line|#define CTLD_CHG        0x1B
DECL|macro|INIT_CPLT
mdefine_line|#define INIT_CPLT       0x20&t;/* Initialisation complete */
DECL|macro|INIT_FAIL
mdefine_line|#define INIT_FAIL       0x21&t;/* Initialisation failed */
DECL|macro|ABTA_SENT
mdefine_line|#define ABTA_SENT       0x24&t;/* Abort sent */
DECL|macro|ABTB_SENT
mdefine_line|#define ABTB_SENT       0x25
DECL|macro|ABTC_SENT
mdefine_line|#define ABTC_SENT       0x26
DECL|macro|ABTD_SENT
mdefine_line|#define ABTD_SENT       0x27
DECL|macro|TXA_UNDF
mdefine_line|#define TXA_UNDF        0x28&t;/* Transmission underflow */
DECL|macro|TXB_UNDF
mdefine_line|#define TXB_UNDF        0x29
DECL|macro|TXC_UNDF
mdefine_line|#define TXC_UNDF        0x2A
DECL|macro|TXD_UNDF
mdefine_line|#define TXD_UNDF        0x2B
DECL|macro|F56_INT
mdefine_line|#define F56_INT         0x2C
DECL|macro|M32_INT
mdefine_line|#define M32_INT         0x2D
DECL|macro|TE1_ALMA
mdefine_line|#define TE1_ALMA        0x30
multiline_comment|/* Port physical configuration. See farsync.h for field values */
DECL|struct|port_cfg
r_struct
id|port_cfg
(brace
DECL|member|lineInterface
id|u16
id|lineInterface
suffix:semicolon
multiline_comment|/* Physical interface type */
DECL|member|x25op
id|u8
id|x25op
suffix:semicolon
multiline_comment|/* Unused at present */
DECL|member|internalClock
id|u8
id|internalClock
suffix:semicolon
multiline_comment|/* 1 =&gt; internal clock, 0 =&gt; external */
DECL|member|transparentMode
id|u8
id|transparentMode
suffix:semicolon
multiline_comment|/* 1 =&gt; on, 0 =&gt; off */
DECL|member|invertClock
id|u8
id|invertClock
suffix:semicolon
multiline_comment|/* 0 =&gt; normal, 1 =&gt; inverted */
DECL|member|padBytes
id|u8
id|padBytes
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* Padding */
DECL|member|lineSpeed
id|u32
id|lineSpeed
suffix:semicolon
multiline_comment|/* Speed in bps */
)brace
suffix:semicolon
multiline_comment|/* TE1 port physical configuration */
DECL|struct|su_config
r_struct
id|su_config
(brace
DECL|member|dataRate
id|u32
id|dataRate
suffix:semicolon
DECL|member|clocking
id|u8
id|clocking
suffix:semicolon
DECL|member|framing
id|u8
id|framing
suffix:semicolon
DECL|member|structure
id|u8
id|structure
suffix:semicolon
DECL|member|interface
id|u8
id|interface
suffix:semicolon
DECL|member|coding
id|u8
id|coding
suffix:semicolon
DECL|member|lineBuildOut
id|u8
id|lineBuildOut
suffix:semicolon
DECL|member|equalizer
id|u8
id|equalizer
suffix:semicolon
DECL|member|transparentMode
id|u8
id|transparentMode
suffix:semicolon
DECL|member|loopMode
id|u8
id|loopMode
suffix:semicolon
DECL|member|range
id|u8
id|range
suffix:semicolon
DECL|member|txBufferMode
id|u8
id|txBufferMode
suffix:semicolon
DECL|member|rxBufferMode
id|u8
id|rxBufferMode
suffix:semicolon
DECL|member|startingSlot
id|u8
id|startingSlot
suffix:semicolon
DECL|member|losThreshold
id|u8
id|losThreshold
suffix:semicolon
DECL|member|enableIdleCode
id|u8
id|enableIdleCode
suffix:semicolon
DECL|member|idleCode
id|u8
id|idleCode
suffix:semicolon
DECL|member|spare
id|u8
id|spare
(braket
l_int|44
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* TE1 Status */
DECL|struct|su_status
r_struct
id|su_status
(brace
DECL|member|receiveBufferDelay
id|u32
id|receiveBufferDelay
suffix:semicolon
DECL|member|framingErrorCount
id|u32
id|framingErrorCount
suffix:semicolon
DECL|member|codeViolationCount
id|u32
id|codeViolationCount
suffix:semicolon
DECL|member|crcErrorCount
id|u32
id|crcErrorCount
suffix:semicolon
DECL|member|lineAttenuation
id|u32
id|lineAttenuation
suffix:semicolon
DECL|member|portStarted
id|u8
id|portStarted
suffix:semicolon
DECL|member|lossOfSignal
id|u8
id|lossOfSignal
suffix:semicolon
DECL|member|receiveRemoteAlarm
id|u8
id|receiveRemoteAlarm
suffix:semicolon
DECL|member|alarmIndicationSignal
id|u8
id|alarmIndicationSignal
suffix:semicolon
DECL|member|spare
id|u8
id|spare
(braket
l_int|40
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Finally sling all the above together into the shared memory structure.&n; * Sorry it&squot;s a hodge podge of arrays, structures and unused bits, it&squot;s been&n; * evolving under NT for some time so I guess we&squot;re stuck with it.&n; * The structure starts at offset SMC_BASE.&n; * See farsync.h for some field values.&n; */
DECL|struct|fst_shared
r_struct
id|fst_shared
(brace
multiline_comment|/* DMA descriptor rings */
DECL|member|rxDescrRing
r_struct
id|rxdesc
id|rxDescrRing
(braket
id|FST_MAX_PORTS
)braket
(braket
id|NUM_RX_BUFFER
)braket
suffix:semicolon
DECL|member|txDescrRing
r_struct
id|txdesc
id|txDescrRing
(braket
id|FST_MAX_PORTS
)braket
(braket
id|NUM_TX_BUFFER
)braket
suffix:semicolon
multiline_comment|/* Obsolete small buffers */
DECL|member|smallRxBuffer
id|u8
id|smallRxBuffer
(braket
id|FST_MAX_PORTS
)braket
(braket
id|NUM_RX_BUFFER
)braket
(braket
id|LEN_SMALL_RX_BUFFER
)braket
suffix:semicolon
DECL|member|smallTxBuffer
id|u8
id|smallTxBuffer
(braket
id|FST_MAX_PORTS
)braket
(braket
id|NUM_TX_BUFFER
)braket
(braket
id|LEN_SMALL_TX_BUFFER
)braket
suffix:semicolon
DECL|member|taskStatus
id|u8
id|taskStatus
suffix:semicolon
multiline_comment|/* 0x00 =&gt; initialising, 0x01 =&gt; running,&n;&t;&t;&t;&t; * 0xFF =&gt; halted&n;&t;&t;&t;&t; */
DECL|member|interruptHandshake
id|u8
id|interruptHandshake
suffix:semicolon
multiline_comment|/* Set to 0x01 by adapter to signal interrupt,&n;&t;&t;&t;&t; * set to 0xEE by host to acknowledge interrupt&n;&t;&t;&t;&t; */
DECL|member|smcVersion
id|u16
id|smcVersion
suffix:semicolon
multiline_comment|/* Must match SMC_VERSION */
DECL|member|smcFirmwareVersion
id|u32
id|smcFirmwareVersion
suffix:semicolon
multiline_comment|/* 0xIIVVRRBB where II = product ID, VV = major&n;&t;&t;&t;&t; * version, RR = revision and BB = build&n;&t;&t;&t;&t; */
DECL|member|txa_done
id|u16
id|txa_done
suffix:semicolon
multiline_comment|/* Obsolete completion flags */
DECL|member|rxa_done
id|u16
id|rxa_done
suffix:semicolon
DECL|member|txb_done
id|u16
id|txb_done
suffix:semicolon
DECL|member|rxb_done
id|u16
id|rxb_done
suffix:semicolon
DECL|member|txc_done
id|u16
id|txc_done
suffix:semicolon
DECL|member|rxc_done
id|u16
id|rxc_done
suffix:semicolon
DECL|member|txd_done
id|u16
id|txd_done
suffix:semicolon
DECL|member|rxd_done
id|u16
id|rxd_done
suffix:semicolon
DECL|member|mailbox
id|u16
id|mailbox
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Diagnostics mailbox. Not used */
DECL|member|interruptEvent
r_struct
id|cirbuff
id|interruptEvent
suffix:semicolon
multiline_comment|/* interrupt causes */
DECL|member|v24IpSts
id|u32
id|v24IpSts
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* V.24 control input status */
DECL|member|v24OpSts
id|u32
id|v24OpSts
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* V.24 control output status */
DECL|member|portConfig
r_struct
id|port_cfg
id|portConfig
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
DECL|member|clockStatus
id|u16
id|clockStatus
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* lsb: 0=&gt; present, 1=&gt; absent */
DECL|member|cableStatus
id|u16
id|cableStatus
suffix:semicolon
multiline_comment|/* lsb: 0=&gt; present, 1=&gt; absent */
DECL|member|txDescrIndex
id|u16
id|txDescrIndex
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* transmit descriptor ring index */
DECL|member|rxDescrIndex
id|u16
id|rxDescrIndex
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* receive descriptor ring index */
DECL|member|portMailbox
id|u16
id|portMailbox
(braket
id|FST_MAX_PORTS
)braket
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* command, modifier */
DECL|member|cardMailbox
id|u16
id|cardMailbox
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Not used */
multiline_comment|/* Number of times the card thinks the host has&n;&t; * missed an interrupt by not acknowledging&n;&t; * within 2mS (I guess NT has problems)&n;&t; */
DECL|member|interruptRetryCount
id|u32
id|interruptRetryCount
suffix:semicolon
multiline_comment|/* Driver private data used as an ID. We&squot;ll not&n;&t; * use this as I&squot;d rather keep such things&n;&t; * in main memory rather than on the PCI bus&n;&t; */
DECL|member|portHandle
id|u32
id|portHandle
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* Count of Tx underflows for stats */
DECL|member|transmitBufferUnderflow
id|u32
id|transmitBufferUnderflow
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* Debounced V.24 control input status */
DECL|member|v24DebouncedSts
id|u32
id|v24DebouncedSts
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* Adapter debounce timers. Don&squot;t touch */
DECL|member|ctsTimer
id|u32
id|ctsTimer
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
DECL|member|ctsTimerRun
id|u32
id|ctsTimerRun
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
DECL|member|dcdTimer
id|u32
id|dcdTimer
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
DECL|member|dcdTimerRun
id|u32
id|dcdTimerRun
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
DECL|member|numberOfPorts
id|u32
id|numberOfPorts
suffix:semicolon
multiline_comment|/* Number of ports detected at startup */
DECL|member|_reserved
id|u16
id|_reserved
(braket
l_int|64
)braket
suffix:semicolon
DECL|member|cardMode
id|u16
id|cardMode
suffix:semicolon
multiline_comment|/* Bit-mask to enable features:&n;&t;&t;&t;&t; * Bit 0: 1 enables LED identify mode&n;&t;&t;&t;&t; */
DECL|member|portScheduleOffset
id|u16
id|portScheduleOffset
suffix:semicolon
DECL|member|suConfig
r_struct
id|su_config
id|suConfig
suffix:semicolon
multiline_comment|/* TE1 Bits */
DECL|member|suStatus
r_struct
id|su_status
id|suStatus
suffix:semicolon
DECL|member|endOfSmcSignature
id|u32
id|endOfSmcSignature
suffix:semicolon
multiline_comment|/* endOfSmcSignature MUST be the last member of&n;&t;&t;&t;&t; * the structure and marks the end of shared&n;&t;&t;&t;&t; * memory. Adapter code initializes it as&n;&t;&t;&t;&t; * END_SIG.&n;&t;&t;&t;&t; */
)brace
suffix:semicolon
multiline_comment|/* endOfSmcSignature value */
DECL|macro|END_SIG
mdefine_line|#define END_SIG                 0x12345678
multiline_comment|/* Mailbox values. (portMailbox) */
DECL|macro|NOP
mdefine_line|#define NOP             0&t;/* No operation */
DECL|macro|ACK
mdefine_line|#define ACK             1&t;/* Positive acknowledgement to PC driver */
DECL|macro|NAK
mdefine_line|#define NAK             2&t;/* Negative acknowledgement to PC driver */
DECL|macro|STARTPORT
mdefine_line|#define STARTPORT       3&t;/* Start an HDLC port */
DECL|macro|STOPPORT
mdefine_line|#define STOPPORT        4&t;/* Stop an HDLC port */
DECL|macro|ABORTTX
mdefine_line|#define ABORTTX         5&t;/* Abort the transmitter for a port */
DECL|macro|SETV24O
mdefine_line|#define SETV24O         6&t;/* Set V24 outputs */
multiline_comment|/* PLX Chip Register Offsets */
DECL|macro|CNTRL_9052
mdefine_line|#define CNTRL_9052      0x50&t;/* Control Register */
DECL|macro|CNTRL_9054
mdefine_line|#define CNTRL_9054      0x6c&t;/* Control Register */
DECL|macro|INTCSR_9052
mdefine_line|#define INTCSR_9052     0x4c&t;/* Interrupt control/status register */
DECL|macro|INTCSR_9054
mdefine_line|#define INTCSR_9054     0x68&t;/* Interrupt control/status register */
multiline_comment|/* 9054 DMA Registers */
multiline_comment|/*&n; * Note that we will be using DMA Channel 0 for copying rx data&n; * and Channel 1 for copying tx data&n; */
DECL|macro|DMAMODE0
mdefine_line|#define DMAMODE0        0x80
DECL|macro|DMAPADR0
mdefine_line|#define DMAPADR0        0x84
DECL|macro|DMALADR0
mdefine_line|#define DMALADR0        0x88
DECL|macro|DMASIZ0
mdefine_line|#define DMASIZ0         0x8c
DECL|macro|DMADPR0
mdefine_line|#define DMADPR0         0x90
DECL|macro|DMAMODE1
mdefine_line|#define DMAMODE1        0x94
DECL|macro|DMAPADR1
mdefine_line|#define DMAPADR1        0x98
DECL|macro|DMALADR1
mdefine_line|#define DMALADR1        0x9c
DECL|macro|DMASIZ1
mdefine_line|#define DMASIZ1         0xa0
DECL|macro|DMADPR1
mdefine_line|#define DMADPR1         0xa4
DECL|macro|DMACSR0
mdefine_line|#define DMACSR0         0xa8
DECL|macro|DMACSR1
mdefine_line|#define DMACSR1         0xa9
DECL|macro|DMAARB
mdefine_line|#define DMAARB          0xac
DECL|macro|DMATHR
mdefine_line|#define DMATHR          0xb0
DECL|macro|DMADAC0
mdefine_line|#define DMADAC0         0xb4
DECL|macro|DMADAC1
mdefine_line|#define DMADAC1         0xb8
DECL|macro|DMAMARBR
mdefine_line|#define DMAMARBR        0xac
DECL|macro|FST_MIN_DMA_LEN
mdefine_line|#define FST_MIN_DMA_LEN 64
DECL|macro|FST_RX_DMA_INT
mdefine_line|#define FST_RX_DMA_INT  0x01
DECL|macro|FST_TX_DMA_INT
mdefine_line|#define FST_TX_DMA_INT  0x02
DECL|macro|FST_CARD_INT
mdefine_line|#define FST_CARD_INT    0x04
multiline_comment|/* Larger buffers are positioned in memory at offset BFM_BASE */
DECL|struct|buf_window
r_struct
id|buf_window
(brace
DECL|member|txBuffer
id|u8
id|txBuffer
(braket
id|FST_MAX_PORTS
)braket
(braket
id|NUM_TX_BUFFER
)braket
(braket
id|LEN_TX_BUFFER
)braket
suffix:semicolon
DECL|member|rxBuffer
id|u8
id|rxBuffer
(braket
id|FST_MAX_PORTS
)braket
(braket
id|NUM_RX_BUFFER
)braket
(braket
id|LEN_RX_BUFFER
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Calculate offset of a buffer object within the shared memory window */
DECL|macro|BUF_OFFSET
mdefine_line|#define BUF_OFFSET(X)   ((unsigned int)&amp;(((struct buf_window *)BFM_BASE)-&gt;X))
macro_line|#pragma pack()
multiline_comment|/*      Device driver private information&n; *      =================================&n; */
multiline_comment|/*      Per port (line or channel) information&n; */
DECL|struct|fst_port_info
r_struct
id|fst_port_info
(brace
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* Device struct - must be first */
DECL|member|card
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
multiline_comment|/* Card we&squot;re associated with */
DECL|member|index
r_int
id|index
suffix:semicolon
multiline_comment|/* Port index on the card */
DECL|member|hwif
r_int
id|hwif
suffix:semicolon
multiline_comment|/* Line hardware (lineInterface copy) */
DECL|member|run
r_int
id|run
suffix:semicolon
multiline_comment|/* Port is running */
DECL|member|mode
r_int
id|mode
suffix:semicolon
multiline_comment|/* Normal or FarSync raw */
DECL|member|rxpos
r_int
id|rxpos
suffix:semicolon
multiline_comment|/* Next Rx buffer to use */
DECL|member|txpos
r_int
id|txpos
suffix:semicolon
multiline_comment|/* Next Tx buffer to use */
DECL|member|txipos
r_int
id|txipos
suffix:semicolon
multiline_comment|/* Next Tx buffer to check for free */
DECL|member|start
r_int
id|start
suffix:semicolon
multiline_comment|/* Indication of start/stop to network */
multiline_comment|/*&n;&t; * A sixteen entry transmit queue&n;&t; */
DECL|member|txqs
r_int
id|txqs
suffix:semicolon
multiline_comment|/* index to get next buffer to tx */
DECL|member|txqe
r_int
id|txqe
suffix:semicolon
multiline_comment|/* index to queue next packet */
DECL|member|txq
r_struct
id|sk_buff
op_star
id|txq
(braket
id|FST_TXQ_DEPTH
)braket
suffix:semicolon
multiline_comment|/* The queue */
DECL|member|rxqdepth
r_int
id|rxqdepth
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*      Per card information&n; */
DECL|struct|fst_card_info
r_struct
id|fst_card_info
(brace
DECL|member|mem
r_char
op_star
id|mem
suffix:semicolon
multiline_comment|/* Card memory mapped to kernel space */
DECL|member|ctlmem
r_char
op_star
id|ctlmem
suffix:semicolon
multiline_comment|/* Control memory for PCI cards */
DECL|member|phys_mem
r_int
r_int
id|phys_mem
suffix:semicolon
multiline_comment|/* Physical memory window address */
DECL|member|phys_ctlmem
r_int
r_int
id|phys_ctlmem
suffix:semicolon
multiline_comment|/* Physical control memory address */
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
multiline_comment|/* Interrupt request line number */
DECL|member|nports
r_int
r_int
id|nports
suffix:semicolon
multiline_comment|/* Number of serial ports */
DECL|member|type
r_int
r_int
id|type
suffix:semicolon
multiline_comment|/* Type index of card */
DECL|member|state
r_int
r_int
id|state
suffix:semicolon
multiline_comment|/* State of card */
DECL|member|card_lock
id|spinlock_t
id|card_lock
suffix:semicolon
multiline_comment|/* Lock for SMP access */
DECL|member|pci_conf
r_int
r_int
id|pci_conf
suffix:semicolon
multiline_comment|/* PCI card config in I/O space */
multiline_comment|/* Per port info */
DECL|member|ports
r_struct
id|fst_port_info
id|ports
(braket
id|FST_MAX_PORTS
)braket
suffix:semicolon
DECL|member|device
r_struct
id|pci_dev
op_star
id|device
suffix:semicolon
multiline_comment|/* Information about the pci device */
DECL|member|card_no
r_int
id|card_no
suffix:semicolon
multiline_comment|/* Inst of the card on the system */
DECL|member|family
r_int
id|family
suffix:semicolon
multiline_comment|/* TxP or TxU */
DECL|member|dmarx_in_progress
r_int
id|dmarx_in_progress
suffix:semicolon
DECL|member|dmatx_in_progress
r_int
id|dmatx_in_progress
suffix:semicolon
DECL|member|int_count
r_int
r_int
id|int_count
suffix:semicolon
DECL|member|int_time_ave
r_int
r_int
id|int_time_ave
suffix:semicolon
DECL|member|rx_dma_handle_host
r_void
op_star
id|rx_dma_handle_host
suffix:semicolon
DECL|member|rx_dma_handle_card
id|dma_addr_t
id|rx_dma_handle_card
suffix:semicolon
DECL|member|tx_dma_handle_host
r_void
op_star
id|tx_dma_handle_host
suffix:semicolon
DECL|member|tx_dma_handle_card
id|dma_addr_t
id|tx_dma_handle_card
suffix:semicolon
DECL|member|dma_skb_rx
r_struct
id|sk_buff
op_star
id|dma_skb_rx
suffix:semicolon
DECL|member|dma_port_rx
r_struct
id|fst_port_info
op_star
id|dma_port_rx
suffix:semicolon
DECL|member|dma_port_tx
r_struct
id|fst_port_info
op_star
id|dma_port_tx
suffix:semicolon
DECL|member|dma_len_rx
r_int
id|dma_len_rx
suffix:semicolon
DECL|member|dma_len_tx
r_int
id|dma_len_tx
suffix:semicolon
DECL|member|dma_txpos
r_int
id|dma_txpos
suffix:semicolon
DECL|member|dma_rxpos
r_int
id|dma_rxpos
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Convert an HDLC device pointer into a port info pointer and similar */
DECL|macro|dev_to_port
mdefine_line|#define dev_to_port(D)  (dev_to_hdlc(D)-&gt;priv)
DECL|macro|port_to_dev
mdefine_line|#define port_to_dev(P)  ((P)-&gt;dev)
multiline_comment|/*&n; *      Shared memory window access macros&n; *&n; *      We have a nice memory based structure above, which could be directly&n; *      mapped on i386 but might not work on other architectures unless we use&n; *      the readb,w,l and writeb,w,l macros. Unfortunately these macros take&n; *      physical offsets so we have to convert. The only saving grace is that&n; *      this should all collapse back to a simple indirection eventually.&n; */
DECL|macro|WIN_OFFSET
mdefine_line|#define WIN_OFFSET(X)   ((long)&amp;(((struct fst_shared *)SMC_BASE)-&gt;X))
DECL|macro|FST_RDB
mdefine_line|#define FST_RDB(C,E)    readb ((C)-&gt;mem + WIN_OFFSET(E))
DECL|macro|FST_RDW
mdefine_line|#define FST_RDW(C,E)    readw ((C)-&gt;mem + WIN_OFFSET(E))
DECL|macro|FST_RDL
mdefine_line|#define FST_RDL(C,E)    readl ((C)-&gt;mem + WIN_OFFSET(E))
DECL|macro|FST_WRB
mdefine_line|#define FST_WRB(C,E,B)  writeb ((B), (C)-&gt;mem + WIN_OFFSET(E))
DECL|macro|FST_WRW
mdefine_line|#define FST_WRW(C,E,W)  writew ((W), (C)-&gt;mem + WIN_OFFSET(E))
DECL|macro|FST_WRL
mdefine_line|#define FST_WRL(C,E,L)  writel ((L), (C)-&gt;mem + WIN_OFFSET(E))
multiline_comment|/*&n; *      Debug support&n; */
macro_line|#if FST_DEBUG
DECL|variable|fst_debug_mask
r_static
r_int
id|fst_debug_mask
op_assign
(brace
id|FST_DEBUG
)brace
suffix:semicolon
multiline_comment|/* Most common debug activity is to print something if the corresponding bit&n; * is set in the debug mask. Note: this uses a non-ANSI extension in GCC to&n; * support variable numbers of macro parameters. The inverted if prevents us&n; * eating someone else&squot;s else clause.&n; */
DECL|macro|dbg
mdefine_line|#define dbg(F,fmt,A...) if ( ! ( fst_debug_mask &amp; (F))) &bslash;&n;                                ; &bslash;&n;                        else &bslash;&n;                                printk ( KERN_DEBUG FST_NAME &quot;: &quot; fmt, ## A )
macro_line|#else
DECL|macro|dbg
mdefine_line|#define dbg(X...)&t;&t;/* NOP */
macro_line|#endif
multiline_comment|/*      Printing short cuts&n; */
DECL|macro|printk_err
mdefine_line|#define printk_err(fmt,A...)    printk ( KERN_ERR     FST_NAME &quot;: &quot; fmt, ## A )
DECL|macro|printk_warn
mdefine_line|#define printk_warn(fmt,A...)   printk ( KERN_WARNING FST_NAME &quot;: &quot; fmt, ## A )
DECL|macro|printk_info
mdefine_line|#define printk_info(fmt,A...)   printk ( KERN_INFO    FST_NAME &quot;: &quot; fmt, ## A )
multiline_comment|/*&n; *      PCI ID lookup table&n; */
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|fst_pci_dev_id
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_FARSITE
comma
id|PCI_DEVICE_ID_FARSITE_T2P
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FST_TYPE_T2P
)brace
comma
(brace
id|PCI_VENDOR_ID_FARSITE
comma
id|PCI_DEVICE_ID_FARSITE_T4P
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FST_TYPE_T4P
)brace
comma
(brace
id|PCI_VENDOR_ID_FARSITE
comma
id|PCI_DEVICE_ID_FARSITE_T1U
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FST_TYPE_T1U
)brace
comma
(brace
id|PCI_VENDOR_ID_FARSITE
comma
id|PCI_DEVICE_ID_FARSITE_T2U
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FST_TYPE_T2U
)brace
comma
(brace
id|PCI_VENDOR_ID_FARSITE
comma
id|PCI_DEVICE_ID_FARSITE_T4U
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FST_TYPE_T4U
)brace
comma
(brace
id|PCI_VENDOR_ID_FARSITE
comma
id|PCI_DEVICE_ID_FARSITE_TE1
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FST_TYPE_TE1
)brace
comma
(brace
id|PCI_VENDOR_ID_FARSITE
comma
id|PCI_DEVICE_ID_FARSITE_TE1C
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FST_TYPE_TE1
)brace
comma
(brace
l_int|0
comma
)brace
multiline_comment|/* End */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|fst_pci_dev_id
)paren
suffix:semicolon
multiline_comment|/*&n; *      Device Driver Work Queues&n; *&n; *      So that we don&squot;t spend too much time processing events in the &n; *      Interrupt Service routine, we will declare a work queue per Card &n; *      and make the ISR schedule a task in the queue for later execution.&n; *      In the 2.4 Kernel we used to use the immediate queue for BH&squot;s&n; *      Now that they are gone, tasklets seem to be much better than work &n; *      queues.&n; */
r_static
r_void
id|do_bottom_half_tx
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|do_bottom_half_rx
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|fst_process_tx_work_q
c_func
(paren
r_int
r_int
id|work_q
)paren
suffix:semicolon
r_static
r_void
id|fst_process_int_work_q
c_func
(paren
r_int
r_int
id|work_q
)paren
suffix:semicolon
id|DECLARE_TASKLET
c_func
(paren
id|fst_tx_task
comma
id|fst_process_tx_work_q
comma
l_int|0
)paren
suffix:semicolon
id|DECLARE_TASKLET
c_func
(paren
id|fst_int_task
comma
id|fst_process_int_work_q
comma
l_int|0
)paren
suffix:semicolon
DECL|variable|fst_card_array
r_struct
id|fst_card_info
op_star
id|fst_card_array
(braket
id|FST_MAX_CARDS
)braket
suffix:semicolon
DECL|variable|fst_work_q_lock
id|spinlock_t
id|fst_work_q_lock
suffix:semicolon
DECL|variable|fst_work_txq
id|u64
id|fst_work_txq
suffix:semicolon
DECL|variable|fst_work_intq
id|u64
id|fst_work_intq
suffix:semicolon
r_static
r_void
DECL|function|fst_q_work_item
id|fst_q_work_item
c_func
(paren
id|u64
op_star
id|queue
comma
r_int
id|card_index
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u64
id|mask
suffix:semicolon
multiline_comment|/*&n;&t; * Grab the queue exclusively&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fst_work_q_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Making an entry in the queue is simply a matter of setting&n;&t; * a bit for the card indicating that there is work to do in the&n;&t; * bottom half for the card.  Note the limitation of 64 cards.&n;&t; * That ought to be enough&n;&t; */
id|mask
op_assign
l_int|1
op_lshift
id|card_index
suffix:semicolon
op_star
id|queue
op_or_assign
id|mask
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fst_work_q_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|fst_process_tx_work_q
id|fst_process_tx_work_q
c_func
(paren
r_int
r_int
multiline_comment|/*void **/
id|work_q
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u64
id|work_txq
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Grab the queue exclusively&n;&t; */
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;fst_process_tx_work_q&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fst_work_q_lock
comma
id|flags
)paren
suffix:semicolon
id|work_txq
op_assign
id|fst_work_txq
suffix:semicolon
id|fst_work_txq
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fst_work_q_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Call the bottom half for each card with work waiting&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FST_MAX_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|work_txq
op_amp
l_int|0x01
)paren
(brace
r_if
c_cond
(paren
id|fst_card_array
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;Calling tx bh for card %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|do_bottom_half_tx
c_func
(paren
id|fst_card_array
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|work_txq
op_assign
id|work_txq
op_rshift
l_int|1
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|fst_process_int_work_q
id|fst_process_int_work_q
c_func
(paren
r_int
r_int
multiline_comment|/*void **/
id|work_q
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u64
id|work_intq
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Grab the queue exclusively&n;&t; */
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;fst_process_int_work_q&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fst_work_q_lock
comma
id|flags
)paren
suffix:semicolon
id|work_intq
op_assign
id|fst_work_intq
suffix:semicolon
id|fst_work_intq
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fst_work_q_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Call the bottom half for each card with work waiting&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FST_MAX_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|work_intq
op_amp
l_int|0x01
)paren
(brace
r_if
c_cond
(paren
id|fst_card_array
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;Calling rx &amp; tx bh for card %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|do_bottom_half_rx
c_func
(paren
id|fst_card_array
(braket
id|i
)braket
)paren
suffix:semicolon
id|do_bottom_half_tx
c_func
(paren
id|fst_card_array
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|work_intq
op_assign
id|work_intq
op_rshift
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*      Card control functions&n; *      ======================&n; */
multiline_comment|/*      Place the processor in reset state&n; *&n; * Used to be a simple write to card control space but a glitch in the latest&n; * AMD Am186CH processor means that we now have to do it by asserting and de-&n; * asserting the PLX chip PCI Adapter Software Reset. Bit 30 in CNTRL register&n; * at offset 9052_CNTRL.  Note the updates for the TXU.&n; */
r_static
r_inline
r_void
DECL|function|fst_cpureset
id|fst_cpureset
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_int
r_char
id|interrupt_line_register
suffix:semicolon
r_int
r_int
id|j
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
r_int
r_int
id|regval
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
r_if
c_cond
(paren
id|pci_read_config_byte
(paren
id|card-&gt;device
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|interrupt_line_register
)paren
)paren
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Error in reading interrupt line register&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Assert PLX software reset and Am186 hardware reset&n;&t;&t; * and then deassert the PLX software reset but 186 still in reset&n;&t;&t; */
id|outw
c_func
(paren
l_int|0x440f
comma
id|card-&gt;pci_conf
op_plus
id|CNTRL_9054
op_plus
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x040f
comma
id|card-&gt;pci_conf
op_plus
id|CNTRL_9054
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We are delaying here to allow the 9054 to reset itself&n;&t;&t; */
id|j
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|j
)paren
multiline_comment|/* Do nothing */
suffix:semicolon
id|outw
c_func
(paren
l_int|0x240f
comma
id|card-&gt;pci_conf
op_plus
id|CNTRL_9054
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We are delaying here to allow the 9054 to reload its eeprom&n;&t;&t; */
id|j
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|j
)paren
multiline_comment|/* Do nothing */
suffix:semicolon
id|outw
c_func
(paren
l_int|0x040f
comma
id|card-&gt;pci_conf
op_plus
id|CNTRL_9054
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_byte
(paren
id|card-&gt;device
comma
id|PCI_INTERRUPT_LINE
comma
id|interrupt_line_register
)paren
)paren
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Error in writing interrupt line register&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|regval
op_assign
id|inl
c_func
(paren
id|card-&gt;pci_conf
op_plus
id|CNTRL_9052
)paren
suffix:semicolon
id|outl
c_func
(paren
id|regval
op_or
l_int|0x40000000
comma
id|card-&gt;pci_conf
op_plus
id|CNTRL_9052
)paren
suffix:semicolon
id|outl
c_func
(paren
id|regval
op_amp
op_complement
l_int|0x40000000
comma
id|card-&gt;pci_conf
op_plus
id|CNTRL_9052
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*      Release the processor from reset&n; */
r_static
r_inline
r_void
DECL|function|fst_cpurelease
id|fst_cpurelease
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
multiline_comment|/*&n;&t;&t; * Force posted writes to complete&n;&t;&t; */
(paren
r_void
)paren
id|readb
c_func
(paren
id|card-&gt;mem
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Release LRESET DO = 1&n;&t;&t; * Then release Local Hold, DO = 1&n;&t;&t; */
id|outw
c_func
(paren
l_int|0x040e
comma
id|card-&gt;pci_conf
op_plus
id|CNTRL_9054
op_plus
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x040f
comma
id|card-&gt;pci_conf
op_plus
id|CNTRL_9054
op_plus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
(paren
r_void
)paren
id|readb
c_func
(paren
id|card-&gt;ctlmem
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*      Clear the cards interrupt flag&n; */
r_static
r_inline
r_void
DECL|function|fst_clear_intr
id|fst_clear_intr
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
(paren
r_void
)paren
id|readb
c_func
(paren
id|card-&gt;ctlmem
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Poke the appropriate PLX chip register (same as enabling interrupts)&n;&t;&t; */
id|outw
c_func
(paren
l_int|0x0543
comma
id|card-&gt;pci_conf
op_plus
id|INTCSR_9052
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*      Enable card interrupts&n; */
r_static
r_inline
r_void
DECL|function|fst_enable_intr
id|fst_enable_intr
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
id|outl
c_func
(paren
l_int|0x0f0c0900
comma
id|card-&gt;pci_conf
op_plus
id|INTCSR_9054
)paren
suffix:semicolon
)brace
r_else
(brace
id|outw
c_func
(paren
l_int|0x0543
comma
id|card-&gt;pci_conf
op_plus
id|INTCSR_9052
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*      Disable card interrupts&n; */
r_static
r_inline
r_void
DECL|function|fst_disable_intr
id|fst_disable_intr
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
id|outl
c_func
(paren
l_int|0x00000000
comma
id|card-&gt;pci_conf
op_plus
id|INTCSR_9054
)paren
suffix:semicolon
)brace
r_else
(brace
id|outw
c_func
(paren
l_int|0x0000
comma
id|card-&gt;pci_conf
op_plus
id|INTCSR_9052
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*      Process the result of trying to pass a recieved frame up the stack&n; */
r_static
r_void
DECL|function|fst_process_rx_status
id|fst_process_rx_status
c_func
(paren
r_int
id|rx_status
comma
r_char
op_star
id|name
)paren
(brace
r_switch
c_cond
(paren
id|rx_status
)paren
(brace
r_case
id|NET_RX_SUCCESS
suffix:colon
(brace
multiline_comment|/*&n;&t;&t;&t; * Nothing to do here&n;&t;&t;&t; */
r_break
suffix:semicolon
)brace
r_case
id|NET_RX_CN_LOW
suffix:colon
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;%s: Receive Low Congestion&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|NET_RX_CN_MOD
suffix:colon
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;%s: Receive Moderate Congestion&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|NET_RX_CN_HIGH
suffix:colon
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;%s: Receive High Congestion&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|NET_RX_DROP
suffix:colon
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;%s: Received packet dropped&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*      Initilaise DMA for PLX 9054&n; */
r_static
r_inline
r_void
DECL|function|fst_init_dma
id|fst_init_dma
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
multiline_comment|/*&n;&t; * This is only required for the PLX 9054&n;&t; */
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
id|pci_set_master
c_func
(paren
id|card-&gt;device
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00020441
comma
id|card-&gt;pci_conf
op_plus
id|DMAMODE0
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00020441
comma
id|card-&gt;pci_conf
op_plus
id|DMAMODE1
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x0
comma
id|card-&gt;pci_conf
op_plus
id|DMATHR
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*      Tx dma complete interrupt&n; */
r_static
r_void
DECL|function|fst_tx_dma_complete
id|fst_tx_dma_complete
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
comma
r_int
id|len
comma
r_int
id|txpos
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|port_to_dev
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Everything is now set, just tell the card to go&n;&t; */
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;fst_tx_dma_complete&bslash;n&quot;
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|txDescrRing
(braket
id|port-&gt;index
)braket
(braket
id|txpos
)braket
dot
id|bits
comma
id|DMA_OWN
op_or
id|TX_STP
op_or
id|TX_ENP
)paren
suffix:semicolon
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|len
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/*      Rx dma complete interrupt&n; */
r_static
r_void
DECL|function|fst_rx_dma_complete
id|fst_rx_dma_complete
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
comma
r_int
id|len
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|rxp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|port_to_dev
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|pi
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;fst_rx_dma_complete&bslash;n&quot;
)paren
suffix:semicolon
id|pi
op_assign
id|port-&gt;index
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|card-&gt;rx_dma_handle_host
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Reset buffer descriptor */
id|FST_WRB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|bits
comma
id|DMA_OWN
)paren
suffix:semicolon
multiline_comment|/* Update stats */
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|len
suffix:semicolon
multiline_comment|/* Push upstream */
id|dbg
c_func
(paren
id|DBG_RX
comma
l_string|&quot;Pushing the frame up the stack&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;mode
op_eq
id|FST_RAW
)paren
(brace
multiline_comment|/*&n;&t;&t; * Mark it for our own raw sockets interface&n;&t;&t; */
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_CUST
)paren
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;protocol
op_assign
id|hdlc_type_trans
c_func
(paren
id|skb
comma
id|skb-&gt;dev
)paren
suffix:semicolon
)brace
id|rx_status
op_assign
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|fst_process_rx_status
c_func
(paren
id|rx_status
comma
id|port_to_dev
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_eq
id|NET_RX_DROP
)paren
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/*&n; *      Receive a frame through the DMA&n; */
r_static
r_inline
r_void
DECL|function|fst_rx_dma
id|fst_rx_dma
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_int
r_char
op_star
id|skb
comma
r_int
r_char
op_star
id|mem
comma
r_int
id|len
)paren
(brace
multiline_comment|/*&n;&t; * This routine will setup the DMA and start it&n;&t; */
id|dbg
c_func
(paren
id|DBG_RX
comma
l_string|&quot;In fst_rx_dma %p %p %d&bslash;n&quot;
comma
id|skb
comma
id|mem
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;dmarx_in_progress
)paren
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;In fst_rx_dma while dma in progress&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
(paren
r_int
r_int
)paren
id|skb
comma
id|card-&gt;pci_conf
op_plus
id|DMAPADR0
)paren
suffix:semicolon
multiline_comment|/* Copy to here */
id|outl
c_func
(paren
(paren
r_int
r_int
)paren
id|mem
comma
id|card-&gt;pci_conf
op_plus
id|DMALADR0
)paren
suffix:semicolon
multiline_comment|/* from here */
id|outl
c_func
(paren
id|len
comma
id|card-&gt;pci_conf
op_plus
id|DMASIZ0
)paren
suffix:semicolon
multiline_comment|/* for this length */
id|outl
c_func
(paren
l_int|0x00000000c
comma
id|card-&gt;pci_conf
op_plus
id|DMADPR0
)paren
suffix:semicolon
multiline_comment|/* In this direction */
multiline_comment|/*&n;&t; * We use the dmarx_in_progress flag to flag the channel as busy&n;&t; */
id|card-&gt;dmarx_in_progress
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
l_int|0x03
comma
id|card-&gt;pci_conf
op_plus
id|DMACSR0
)paren
suffix:semicolon
multiline_comment|/* Start the transfer */
)brace
multiline_comment|/*&n; *      Send a frame through the DMA&n; */
r_static
r_inline
r_void
DECL|function|fst_tx_dma
id|fst_tx_dma
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_int
r_char
op_star
id|skb
comma
r_int
r_char
op_star
id|mem
comma
r_int
id|len
)paren
(brace
multiline_comment|/*&n;&t; * This routine will setup the DMA and start it.&n;&t; */
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;In fst_tx_dma %p %p %d&bslash;n&quot;
comma
id|skb
comma
id|mem
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;dmatx_in_progress
)paren
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;In fst_tx_dma while dma in progress&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
(paren
r_int
r_int
)paren
id|skb
comma
id|card-&gt;pci_conf
op_plus
id|DMAPADR1
)paren
suffix:semicolon
multiline_comment|/* Copy from here */
id|outl
c_func
(paren
(paren
r_int
r_int
)paren
id|mem
comma
id|card-&gt;pci_conf
op_plus
id|DMALADR1
)paren
suffix:semicolon
multiline_comment|/* to here */
id|outl
c_func
(paren
id|len
comma
id|card-&gt;pci_conf
op_plus
id|DMASIZ1
)paren
suffix:semicolon
multiline_comment|/* for this length */
id|outl
c_func
(paren
l_int|0x000000004
comma
id|card-&gt;pci_conf
op_plus
id|DMADPR1
)paren
suffix:semicolon
multiline_comment|/* In this direction */
multiline_comment|/*&n;&t; * We use the dmatx_in_progress to flag the channel as busy&n;&t; */
id|card-&gt;dmatx_in_progress
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
l_int|0x03
comma
id|card-&gt;pci_conf
op_plus
id|DMACSR1
)paren
suffix:semicolon
multiline_comment|/* Start the transfer */
)brace
multiline_comment|/*      Issue a Mailbox command for a port.&n; *      Note we issue them on a fire and forget basis, not expecting to see an&n; *      error and not waiting for completion.&n; */
r_static
r_void
DECL|function|fst_issue_cmd
id|fst_issue_cmd
c_func
(paren
r_struct
id|fst_port_info
op_star
id|port
comma
r_int
r_int
id|cmd
)paren
(brace
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
r_int
r_int
id|mbval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|safety
suffix:semicolon
id|card
op_assign
id|port-&gt;card
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
id|mbval
op_assign
id|FST_RDW
c_func
(paren
id|card
comma
id|portMailbox
(braket
id|port-&gt;index
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|safety
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Wait for any previous command to complete */
r_while
c_loop
(paren
id|mbval
OG
id|NAK
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|safety
OG
l_int|2000
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Mailbox safety timeout&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mbval
op_assign
id|FST_RDW
c_func
(paren
id|card
comma
id|portMailbox
(braket
id|port-&gt;index
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|safety
OG
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|DBG_CMD
comma
l_string|&quot;Mailbox clear after %d jiffies&bslash;n&quot;
comma
id|safety
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mbval
op_eq
id|NAK
)paren
(brace
id|dbg
c_func
(paren
id|DBG_CMD
comma
l_string|&quot;issue_cmd: previous command was NAK&squot;d&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|FST_WRW
c_func
(paren
id|card
comma
id|portMailbox
(braket
id|port-&gt;index
)braket
(braket
l_int|0
)braket
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|ABORTTX
op_logical_or
id|cmd
op_eq
id|STARTPORT
)paren
(brace
id|port-&gt;txpos
op_assign
l_int|0
suffix:semicolon
id|port-&gt;txipos
op_assign
l_int|0
suffix:semicolon
id|port-&gt;start
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*      Port output signals control&n; */
r_static
r_inline
r_void
DECL|function|fst_op_raise
id|fst_op_raise
c_func
(paren
r_struct
id|fst_port_info
op_star
id|port
comma
r_int
r_int
id|outputs
)paren
(brace
id|outputs
op_or_assign
id|FST_RDL
c_func
(paren
id|port-&gt;card
comma
id|v24OpSts
(braket
id|port-&gt;index
)braket
)paren
suffix:semicolon
id|FST_WRL
c_func
(paren
id|port-&gt;card
comma
id|v24OpSts
(braket
id|port-&gt;index
)braket
comma
id|outputs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;run
)paren
id|fst_issue_cmd
c_func
(paren
id|port
comma
id|SETV24O
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|fst_op_lower
id|fst_op_lower
c_func
(paren
r_struct
id|fst_port_info
op_star
id|port
comma
r_int
r_int
id|outputs
)paren
(brace
id|outputs
op_assign
op_complement
id|outputs
op_amp
id|FST_RDL
c_func
(paren
id|port-&gt;card
comma
id|v24OpSts
(braket
id|port-&gt;index
)braket
)paren
suffix:semicolon
id|FST_WRL
c_func
(paren
id|port-&gt;card
comma
id|v24OpSts
(braket
id|port-&gt;index
)braket
comma
id|outputs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;run
)paren
id|fst_issue_cmd
c_func
(paren
id|port
comma
id|SETV24O
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *      Setup port Rx buffers&n; */
r_static
r_void
DECL|function|fst_rx_config
id|fst_rx_config
c_func
(paren
r_struct
id|fst_port_info
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|pi
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
id|pi
op_assign
id|port-&gt;index
suffix:semicolon
id|card
op_assign
id|port-&gt;card
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RX_BUFFER
suffix:semicolon
id|i
op_increment
)paren
(brace
id|offset
op_assign
id|BUF_OFFSET
c_func
(paren
id|rxBuffer
(braket
id|pi
)braket
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|FST_WRW
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|ladr
comma
(paren
id|u16
)paren
id|offset
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|hadr
comma
(paren
id|u8
)paren
(paren
id|offset
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|FST_WRW
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|bcnt
comma
id|cnv_bcnt
c_func
(paren
id|LEN_RX_BUFFER
)paren
)paren
suffix:semicolon
id|FST_WRW
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|mcnt
comma
id|LEN_RX_BUFFER
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|bits
comma
id|DMA_OWN
)paren
suffix:semicolon
)brace
id|port-&gt;rxpos
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *      Setup port Tx buffers&n; */
r_static
r_void
DECL|function|fst_tx_config
id|fst_tx_config
c_func
(paren
r_struct
id|fst_port_info
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|pi
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
id|pi
op_assign
id|port-&gt;index
suffix:semicolon
id|card
op_assign
id|port-&gt;card
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TX_BUFFER
suffix:semicolon
id|i
op_increment
)paren
(brace
id|offset
op_assign
id|BUF_OFFSET
c_func
(paren
id|txBuffer
(braket
id|pi
)braket
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|FST_WRW
c_func
(paren
id|card
comma
id|txDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|ladr
comma
(paren
id|u16
)paren
id|offset
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|txDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|hadr
comma
(paren
id|u8
)paren
(paren
id|offset
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|FST_WRW
c_func
(paren
id|card
comma
id|txDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|bcnt
comma
l_int|0
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|txDescrRing
(braket
id|pi
)braket
(braket
id|i
)braket
dot
id|bits
comma
l_int|0
)paren
suffix:semicolon
)brace
id|port-&gt;txpos
op_assign
l_int|0
suffix:semicolon
id|port-&gt;txipos
op_assign
l_int|0
suffix:semicolon
id|port-&gt;start
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*      TE1 Alarm change interrupt event&n; */
r_static
r_void
DECL|function|fst_intr_te1_alarm
id|fst_intr_te1_alarm
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
)paren
(brace
id|u8
id|los
suffix:semicolon
id|u8
id|rra
suffix:semicolon
id|u8
id|ais
suffix:semicolon
id|los
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suStatus.lossOfSignal
)paren
suffix:semicolon
id|rra
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suStatus.receiveRemoteAlarm
)paren
suffix:semicolon
id|ais
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suStatus.alarmIndicationSignal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|los
)paren
(brace
multiline_comment|/*&n;&t;&t; * Lost the link&n;&t;&t; */
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;Net carrier off&bslash;n&quot;
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Link available&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|netif_carrier_ok
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;Net carrier on&bslash;n&quot;
)paren
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|los
)paren
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;Assert LOS Alarm&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;De-assert LOS Alarm&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rra
)paren
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;Assert RRA Alarm&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;De-assert RRA Alarm&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ais
)paren
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;Assert AIS Alarm&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;De-assert AIS Alarm&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*      Control signal change interrupt event&n; */
r_static
r_void
DECL|function|fst_intr_ctlchg
id|fst_intr_ctlchg
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
)paren
(brace
r_int
id|signals
suffix:semicolon
id|signals
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|v24DebouncedSts
(braket
id|port-&gt;index
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signals
op_amp
(paren
(paren
(paren
id|port-&gt;hwif
op_eq
id|X21
)paren
op_logical_or
(paren
id|port-&gt;hwif
op_eq
id|X21D
)paren
)paren
ques
c_cond
id|IPSTS_INDICATE
suffix:colon
id|IPSTS_DCD
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|netif_carrier_ok
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;DCD active&bslash;n&quot;
)paren
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;DCD lost&bslash;n&quot;
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*      Log Rx Errors&n; */
r_static
r_void
DECL|function|fst_log_rx_error
id|fst_log_rx_error
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
comma
r_int
r_char
id|dmabits
comma
r_int
id|rxp
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|port_to_dev
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Increment the appropriate error counter&n;&t; */
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dmabits
op_amp
id|RX_OFLO
)paren
(brace
id|stats-&gt;rx_fifo_errors
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Rx fifo error on card %d port %d buffer %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|port-&gt;index
comma
id|rxp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabits
op_amp
id|RX_CRC
)paren
(brace
id|stats-&gt;rx_crc_errors
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Rx crc error on card %d port %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|port-&gt;index
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabits
op_amp
id|RX_FRAM
)paren
(brace
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Rx frame error on card %d port %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|port-&gt;index
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabits
op_eq
(paren
id|RX_STP
op_or
id|RX_ENP
)paren
)paren
(brace
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Rx length error (%d) on card %d port %d&bslash;n&quot;
comma
id|len
comma
id|card-&gt;card_no
comma
id|port-&gt;index
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*      Rx Error Recovery&n; */
r_static
r_void
DECL|function|fst_recover_rx_error
id|fst_recover_rx_error
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
comma
r_int
r_char
id|dmabits
comma
r_int
id|rxp
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|pi
suffix:semicolon
id|pi
op_assign
id|port-&gt;index
suffix:semicolon
multiline_comment|/* &n;&t; * Discard buffer descriptors until we see the start of the&n;&t; * next frame.  Note that for long frames this could be in&n;&t; * a subsequent interrupt. &n;&t; */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dmabits
op_amp
(paren
id|DMA_OWN
op_or
id|RX_STP
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|FST_WRB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|bits
comma
id|DMA_OWN
)paren
suffix:semicolon
id|rxp
op_assign
(paren
id|rxp
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFFER
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
OG
id|NUM_RX_BUFFER
)paren
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;intr_rx: Discarding more bufs&quot;
l_string|&quot; than we have&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dmabits
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|bits
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;DMA Bits of next buffer was %x&bslash;n&quot;
comma
id|dmabits
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;There were %d subsequent buffers in error&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Discard the terminal buffer */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dmabits
op_amp
id|DMA_OWN
)paren
)paren
(brace
id|FST_WRB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|bits
comma
id|DMA_OWN
)paren
suffix:semicolon
id|rxp
op_assign
(paren
id|rxp
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFFER
suffix:semicolon
)brace
id|port-&gt;rxpos
op_assign
id|rxp
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*      Rx complete interrupt&n; */
r_static
r_void
DECL|function|fst_intr_rx
id|fst_intr_rx
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
)paren
(brace
r_int
r_char
id|dmabits
suffix:semicolon
r_int
id|pi
suffix:semicolon
r_int
id|rxp
suffix:semicolon
r_int
id|rx_status
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|port_to_dev
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check we have a buffer to process */
id|pi
op_assign
id|port-&gt;index
suffix:semicolon
id|rxp
op_assign
id|port-&gt;rxpos
suffix:semicolon
id|dmabits
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|bits
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabits
op_amp
id|DMA_OWN
)paren
(brace
id|dbg
c_func
(paren
id|DBG_RX
op_or
id|DBG_INTR
comma
l_string|&quot;intr_rx: No buffer port %d pos %d&bslash;n&quot;
comma
id|pi
comma
id|rxp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;dmarx_in_progress
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Get buffer length */
id|len
op_assign
id|FST_RDW
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|mcnt
)paren
suffix:semicolon
multiline_comment|/* Discard the CRC */
id|len
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * This seems to happen on the TE1 interface sometimes&n;&t;&t; * so throw the frame away and log the event.&n;&t;&t; */
id|printk_err
c_func
(paren
l_string|&quot;Frame received with 0 length. Card %d Port %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|port-&gt;index
)paren
suffix:semicolon
multiline_comment|/* Return descriptor to card */
id|FST_WRB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|bits
comma
id|DMA_OWN
)paren
suffix:semicolon
id|rxp
op_assign
(paren
id|rxp
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFFER
suffix:semicolon
id|port-&gt;rxpos
op_assign
id|rxp
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Check buffer length and for other errors. We insist on one packet&n;&t; * in one buffer. This simplifies things greatly and since we&squot;ve&n;&t; * allocated 8K it shouldn&squot;t be a real world limitation&n;&t; */
id|dbg
c_func
(paren
id|DBG_RX
comma
l_string|&quot;intr_rx: %d,%d: flags %x len %d&bslash;n&quot;
comma
id|pi
comma
id|rxp
comma
id|dmabits
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabits
op_ne
(paren
id|RX_STP
op_or
id|RX_ENP
)paren
op_logical_or
id|len
OG
id|LEN_RX_BUFFER
op_minus
l_int|2
)paren
(brace
id|fst_log_rx_error
c_func
(paren
id|card
comma
id|port
comma
id|dmabits
comma
id|rxp
comma
id|len
)paren
suffix:semicolon
id|fst_recover_rx_error
c_func
(paren
id|card
comma
id|port
comma
id|dmabits
comma
id|rxp
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Allocate SKB */
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
id|DBG_RX
comma
l_string|&quot;intr_rx: can&squot;t allocate buffer&bslash;n&quot;
)paren
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
multiline_comment|/* Return descriptor to card */
id|FST_WRB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|bits
comma
id|DMA_OWN
)paren
suffix:semicolon
id|rxp
op_assign
(paren
id|rxp
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFFER
suffix:semicolon
id|port-&gt;rxpos
op_assign
id|rxp
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We know the length we need to receive, len.&n;&t; * It&squot;s not worth using the DMA for reads of less than&n;&t; * FST_MIN_DMA_LEN&n;&t; */
r_if
c_cond
(paren
(paren
id|len
OL
id|FST_MIN_DMA_LEN
)paren
op_logical_or
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXP
)paren
)paren
(brace
id|memcpy_fromio
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|card-&gt;mem
op_plus
id|BUF_OFFSET
c_func
(paren
id|rxBuffer
(braket
id|pi
)braket
(braket
id|rxp
)braket
(braket
l_int|0
)braket
)paren
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Reset buffer descriptor */
id|FST_WRB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|rxp
)braket
dot
id|bits
comma
id|DMA_OWN
)paren
suffix:semicolon
multiline_comment|/* Update stats */
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|len
suffix:semicolon
multiline_comment|/* Push upstream */
id|dbg
c_func
(paren
id|DBG_RX
comma
l_string|&quot;Pushing frame up the stack&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;mode
op_eq
id|FST_RAW
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Mark it for our own raw sockets interface&n;&t;&t;&t; */
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_CUST
)paren
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;protocol
op_assign
id|hdlc_type_trans
c_func
(paren
id|skb
comma
id|skb-&gt;dev
)paren
suffix:semicolon
)brace
id|rx_status
op_assign
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|fst_process_rx_status
c_func
(paren
id|rx_status
comma
id|port_to_dev
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_eq
id|NET_RX_DROP
)paren
(brace
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
)brace
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;dma_skb_rx
op_assign
id|skb
suffix:semicolon
id|card-&gt;dma_port_rx
op_assign
id|port
suffix:semicolon
id|card-&gt;dma_len_rx
op_assign
id|len
suffix:semicolon
id|card-&gt;dma_rxpos
op_assign
id|rxp
suffix:semicolon
id|fst_rx_dma
c_func
(paren
id|card
comma
(paren
r_char
op_star
)paren
id|card-&gt;rx_dma_handle_card
comma
(paren
r_char
op_star
)paren
id|BUF_OFFSET
c_func
(paren
id|rxBuffer
(braket
id|pi
)braket
(braket
id|rxp
)braket
(braket
l_int|0
)braket
)paren
comma
id|len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rxp
op_ne
id|port-&gt;rxpos
)paren
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;About to increment rxpos by more than 1&bslash;n&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;rxp = %d rxpos = %d&bslash;n&quot;
comma
id|rxp
comma
id|port-&gt;rxpos
)paren
suffix:semicolon
)brace
id|rxp
op_assign
(paren
id|rxp
op_plus
l_int|1
)paren
op_mod
id|NUM_RX_BUFFER
suffix:semicolon
id|port-&gt;rxpos
op_assign
id|rxp
suffix:semicolon
)brace
multiline_comment|/*&n; *      The bottom halfs to the ISR&n; *&n; */
r_static
r_void
DECL|function|do_bottom_half_tx
id|do_bottom_half_tx
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_struct
id|fst_port_info
op_star
id|port
suffix:semicolon
r_int
id|pi
suffix:semicolon
r_int
id|txq_length
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
suffix:semicolon
multiline_comment|/*&n;&t; *  Find a free buffer for the transmit&n;&t; *  Step through each port on this card&n;&t; */
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;do_bottom_half_tx&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pi
op_assign
l_int|0
comma
id|port
op_assign
id|card-&gt;ports
suffix:semicolon
id|pi
OL
id|card-&gt;nports
suffix:semicolon
id|pi
op_increment
comma
id|port
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;run
)paren
r_continue
suffix:semicolon
id|dev
op_assign
id|port_to_dev
c_func
(paren
id|port
)paren
suffix:semicolon
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|FST_RDB
c_func
(paren
id|card
comma
id|txDescrRing
(braket
id|pi
)braket
(braket
id|port-&gt;txpos
)braket
dot
id|bits
)paren
op_amp
id|DMA_OWN
)paren
op_logical_and
op_logical_neg
(paren
id|card-&gt;dmatx_in_progress
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * There doesn&squot;t seem to be a txdone event per-se&n;&t;&t;&t; * We seem to have to deduce it, by checking the DMA_OWN&n;&t;&t;&t; * bit on the next buffer we think we can use&n;&t;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|txq_length
op_assign
id|port-&gt;txqe
op_minus
id|port-&gt;txqs
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * This is the case where one has wrapped and the&n;&t;&t;&t;&t; * maths gives us a negative number&n;&t;&t;&t;&t; */
id|txq_length
op_assign
id|txq_length
op_plus
id|FST_TXQ_DEPTH
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txq_length
OG
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * There is something to send&n;&t;&t;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
id|skb
op_assign
id|port-&gt;txq
(braket
id|port-&gt;txqs
)braket
suffix:semicolon
id|port-&gt;txqs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;txqs
op_eq
id|FST_TXQ_DEPTH
)paren
(brace
id|port-&gt;txqs
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * copy the data and set the required indicators on the&n;&t;&t;&t;&t; * card.&n;&t;&t;&t;&t; */
id|FST_WRW
c_func
(paren
id|card
comma
id|txDescrRing
(braket
id|pi
)braket
(braket
id|port-&gt;txpos
)braket
dot
id|bcnt
comma
id|cnv_bcnt
c_func
(paren
id|skb-&gt;len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb-&gt;len
OL
id|FST_MIN_DMA_LEN
)paren
op_logical_or
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXP
)paren
)paren
(brace
multiline_comment|/* Enqueue the packet with normal io */
id|memcpy_toio
c_func
(paren
id|card-&gt;mem
op_plus
id|BUF_OFFSET
c_func
(paren
id|txBuffer
(braket
id|pi
)braket
(braket
id|port
op_member_access_from_pointer
id|txpos
)braket
(braket
l_int|0
)braket
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|txDescrRing
(braket
id|pi
)braket
(braket
id|port-&gt;txpos
)braket
dot
id|bits
comma
id|DMA_OWN
op_or
id|TX_STP
op_or
id|TX_ENP
)paren
suffix:semicolon
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Or do it through dma */
id|memcpy
c_func
(paren
id|card-&gt;tx_dma_handle_host
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|card-&gt;dma_port_tx
op_assign
id|port
suffix:semicolon
id|card-&gt;dma_len_tx
op_assign
id|skb-&gt;len
suffix:semicolon
id|card-&gt;dma_txpos
op_assign
id|port-&gt;txpos
suffix:semicolon
id|fst_tx_dma
c_func
(paren
id|card
comma
(paren
r_char
op_star
)paren
id|card
op_member_access_from_pointer
id|tx_dma_handle_card
comma
(paren
r_char
op_star
)paren
id|BUF_OFFSET
c_func
(paren
id|txBuffer
(braket
id|pi
)braket
(braket
id|port-&gt;txpos
)braket
(braket
l_int|0
)braket
)paren
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|port-&gt;txpos
op_ge
id|NUM_TX_BUFFER
)paren
id|port-&gt;txpos
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * If we have flow control on, can we now release it?&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|port-&gt;start
)paren
(brace
r_if
c_cond
(paren
id|txq_length
OL
id|fst_txq_low
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|port_to_dev
(paren
id|port
)paren
)paren
suffix:semicolon
id|port-&gt;start
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Nothing to send so break out of the while loop&n;&t;&t;&t;&t; */
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_static
r_void
DECL|function|do_bottom_half_rx
id|do_bottom_half_rx
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_struct
id|fst_port_info
op_star
id|port
suffix:semicolon
r_int
id|pi
suffix:semicolon
r_int
id|rx_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check for rx completions on all ports on this card */
id|dbg
c_func
(paren
id|DBG_RX
comma
l_string|&quot;do_bottom_half_rx&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pi
op_assign
l_int|0
comma
id|port
op_assign
id|card-&gt;ports
suffix:semicolon
id|pi
OL
id|card-&gt;nports
suffix:semicolon
id|pi
op_increment
comma
id|port
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;run
)paren
r_continue
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|FST_RDB
c_func
(paren
id|card
comma
id|rxDescrRing
(braket
id|pi
)braket
(braket
id|port-&gt;rxpos
)braket
dot
id|bits
)paren
op_amp
id|DMA_OWN
)paren
op_logical_and
op_logical_neg
(paren
id|card-&gt;dmarx_in_progress
)paren
)paren
(brace
r_if
c_cond
(paren
id|rx_count
OG
id|fst_max_reads
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Don&squot;t spend forever in receive processing&n;&t;&t;&t;&t; * Schedule another event&n;&t;&t;&t;&t; */
id|fst_q_work_item
c_func
(paren
op_amp
id|fst_work_intq
comma
id|card-&gt;card_no
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|fst_int_task
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Leave the loop */
)brace
id|fst_intr_rx
c_func
(paren
id|card
comma
id|port
)paren
suffix:semicolon
id|rx_count
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *      The interrupt service routine&n; *      Dev_id is our fst_card_info pointer&n; */
id|irqreturn_t
DECL|function|fst_intr
id|fst_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
r_struct
id|fst_port_info
op_star
id|port
suffix:semicolon
r_int
id|rdidx
suffix:semicolon
multiline_comment|/* Event buffer indices */
r_int
id|wridx
suffix:semicolon
r_int
id|event
suffix:semicolon
multiline_comment|/* Actual event for processing */
r_int
r_int
id|dma_intcsr
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|do_card_interrupt
suffix:semicolon
r_int
r_int
id|int_retry_count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card
op_assign
id|dev_id
)paren
op_eq
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;intr: spurious %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check to see if the interrupt was for this card&n;&t; * return if not&n;&t; * Note that the call to clear the interrupt is important&n;&t; */
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;intr: %d %p&bslash;n&quot;
comma
id|irq
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;state
op_ne
id|FST_RUNNING
)paren
(brace
id|printk_err
(paren
l_string|&quot;Interrupt received for card %d in a non running state (%d)&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|card-&gt;state
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * It is possible to really be running, i.e. we have re-loaded&n;&t;&t; * a running card&n;&t;&t; * Clear and reprime the interrupt source &n;&t;&t; */
id|fst_clear_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Clear and reprime the interrupt source */
id|fst_clear_intr
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Is the interrupt for this card (handshake == 1)&n;&t; */
id|do_card_interrupt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|FST_RDB
c_func
(paren
id|card
comma
id|interruptHandshake
)paren
op_eq
l_int|1
)paren
(brace
id|do_card_interrupt
op_add_assign
id|FST_CARD_INT
suffix:semicolon
multiline_comment|/* Set the software acknowledge */
id|FST_WRB
c_func
(paren
id|card
comma
id|interruptHandshake
comma
l_int|0xEE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
multiline_comment|/*&n;&t;&t; * Is it a DMA Interrupt&n;&t;&t; */
id|dma_intcsr
op_assign
id|inl
c_func
(paren
id|card-&gt;pci_conf
op_plus
id|INTCSR_9054
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_intcsr
op_amp
l_int|0x00200000
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * DMA Channel 0 (Rx transfer complete)&n;&t;&t;&t; */
id|dbg
c_func
(paren
id|DBG_RX
comma
l_string|&quot;DMA Rx xfer complete&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x8
comma
id|card-&gt;pci_conf
op_plus
id|DMACSR0
)paren
suffix:semicolon
id|fst_rx_dma_complete
c_func
(paren
id|card
comma
id|card-&gt;dma_port_rx
comma
id|card-&gt;dma_len_rx
comma
id|card-&gt;dma_skb_rx
comma
id|card-&gt;dma_rxpos
)paren
suffix:semicolon
id|card-&gt;dmarx_in_progress
op_assign
l_int|0
suffix:semicolon
id|do_card_interrupt
op_add_assign
id|FST_RX_DMA_INT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_intcsr
op_amp
l_int|0x00400000
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * DMA Channel 1 (Tx transfer complete)&n;&t;&t;&t; */
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;DMA Tx xfer complete&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x8
comma
id|card-&gt;pci_conf
op_plus
id|DMACSR1
)paren
suffix:semicolon
id|fst_tx_dma_complete
c_func
(paren
id|card
comma
id|card-&gt;dma_port_tx
comma
id|card-&gt;dma_len_tx
comma
id|card-&gt;dma_txpos
)paren
suffix:semicolon
id|card-&gt;dmatx_in_progress
op_assign
l_int|0
suffix:semicolon
id|do_card_interrupt
op_add_assign
id|FST_TX_DMA_INT
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Have we been missing Interrupts&n;&t; */
id|int_retry_count
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|interruptRetryCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|int_retry_count
)paren
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Card %d int_retry_count is  %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|int_retry_count
)paren
suffix:semicolon
id|FST_WRL
c_func
(paren
id|card
comma
id|interruptRetryCount
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|do_card_interrupt
)paren
(brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Scehdule the bottom half of the ISR */
id|fst_q_work_item
c_func
(paren
op_amp
id|fst_work_intq
comma
id|card-&gt;card_no
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|fst_int_task
)paren
suffix:semicolon
multiline_comment|/* Drain the event queue */
id|rdidx
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|interruptEvent.rdindex
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|wridx
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|interruptEvent.wrindex
)paren
op_amp
l_int|0x1f
suffix:semicolon
r_while
c_loop
(paren
id|rdidx
op_ne
id|wridx
)paren
(brace
id|event
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|interruptEvent.evntbuff
(braket
id|rdidx
)braket
)paren
suffix:semicolon
id|port
op_assign
op_amp
id|card-&gt;ports
(braket
id|event
op_amp
l_int|0x03
)braket
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;Processing Interrupt event: %x&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|TE1_ALMA
suffix:colon
id|dbg
c_func
(paren
id|DBG_INTR
comma
l_string|&quot;TE1 Alarm intr&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;run
)paren
id|fst_intr_te1_alarm
c_func
(paren
id|card
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTLA_CHG
suffix:colon
r_case
id|CTLB_CHG
suffix:colon
r_case
id|CTLC_CHG
suffix:colon
r_case
id|CTLD_CHG
suffix:colon
r_if
c_cond
(paren
id|port-&gt;run
)paren
id|fst_intr_ctlchg
c_func
(paren
id|card
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ABTA_SENT
suffix:colon
r_case
id|ABTB_SENT
suffix:colon
r_case
id|ABTC_SENT
suffix:colon
r_case
id|ABTD_SENT
suffix:colon
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;Abort complete port %d&bslash;n&quot;
comma
id|port-&gt;index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TXA_UNDF
suffix:colon
r_case
id|TXB_UNDF
suffix:colon
r_case
id|TXC_UNDF
suffix:colon
r_case
id|TXD_UNDF
suffix:colon
multiline_comment|/* Difficult to see how we&squot;d get this given that we&n;&t;&t;&t; * always load up the entire packet for DMA.&n;&t;&t;&t; */
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;Tx underflow port %d&bslash;n&quot;
comma
id|port-&gt;index
)paren
suffix:semicolon
id|hdlc_stats
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
op_member_access_from_pointer
id|tx_errors
op_increment
suffix:semicolon
id|hdlc_stats
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
op_member_access_from_pointer
id|tx_fifo_errors
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Tx underflow on card %d port %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|port-&gt;index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INIT_CPLT
suffix:colon
id|dbg
c_func
(paren
id|DBG_INIT
comma
l_string|&quot;Card init OK intr&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INIT_FAIL
suffix:colon
id|dbg
c_func
(paren
id|DBG_INIT
comma
l_string|&quot;Card init FAILED intr&bslash;n&quot;
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_IFAILED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk_err
c_func
(paren
l_string|&quot;intr: unknown card event %d. ignored&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Bump and wrap the index */
r_if
c_cond
(paren
op_increment
id|rdidx
op_ge
id|MAX_CIRBUFF
)paren
id|rdidx
op_assign
l_int|0
suffix:semicolon
)brace
id|FST_WRB
c_func
(paren
id|card
comma
id|interruptEvent.rdindex
comma
id|rdidx
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*      Check that the shared memory configuration is one that we can handle&n; *      and that some basic parameters are correct&n; */
r_static
r_void
DECL|function|check_started_ok
id|check_started_ok
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Check structure version and end marker */
r_if
c_cond
(paren
id|FST_RDW
c_func
(paren
id|card
comma
id|smcVersion
)paren
op_ne
id|SMC_VERSION
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Bad shared memory version %d expected %d&bslash;n&quot;
comma
id|FST_RDW
c_func
(paren
id|card
comma
id|smcVersion
)paren
comma
id|SMC_VERSION
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_BADVERSION
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|FST_RDL
c_func
(paren
id|card
comma
id|endOfSmcSignature
)paren
op_ne
id|END_SIG
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Missing shared memory signature&bslash;n&quot;
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_BADVERSION
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Firmware status flag, 0x00 = initialising, 0x01 = OK, 0xFF = fail */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|taskStatus
)paren
)paren
op_eq
l_int|0x01
)paren
(brace
id|card-&gt;state
op_assign
id|FST_RUNNING
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_eq
l_int|0xFF
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Firmware initialisation failed. Card halted&bslash;n&quot;
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_HALTED
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_ne
l_int|0x00
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Unknown firmware status 0x%x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_HALTED
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Finally check the number of ports reported by firmware against the&n;&t; * number we assumed at card detection. Should never happen with&n;&t; * existing firmware etc so we just report it for the moment.&n;&t; */
r_if
c_cond
(paren
id|FST_RDL
c_func
(paren
id|card
comma
id|numberOfPorts
)paren
op_ne
id|card-&gt;nports
)paren
(brace
id|printk_warn
c_func
(paren
l_string|&quot;Port count mismatch on card %d.&quot;
l_string|&quot; Firmware thinks %d we say %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|FST_RDL
c_func
(paren
id|card
comma
id|numberOfPorts
)paren
comma
id|card-&gt;nports
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|set_conf_from_info
id|set_conf_from_info
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
comma
r_struct
id|fstioc_info
op_star
id|info
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
r_char
id|my_framing
suffix:semicolon
multiline_comment|/* Set things according to the user set valid flags &n;&t; * Several of the old options have been invalidated/replaced by the &n;&t; * generic hdlc package.&n;&t; */
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|FSTVAL_PROTO
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;proto
op_eq
id|FST_RAW
)paren
id|port-&gt;mode
op_assign
id|FST_RAW
suffix:semicolon
r_else
id|port-&gt;mode
op_assign
id|FST_GEN_HDLC
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|FSTVAL_CABLE
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|FSTVAL_SPEED
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|FSTVAL_PHASE
)paren
id|FST_WRB
c_func
(paren
id|card
comma
id|portConfig
(braket
id|port-&gt;index
)braket
dot
id|invertClock
comma
id|info-&gt;invertClock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|FSTVAL_MODE
)paren
id|FST_WRW
c_func
(paren
id|card
comma
id|cardMode
comma
id|info-&gt;cardMode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|FSTVAL_TE1
)paren
(brace
id|FST_WRL
c_func
(paren
id|card
comma
id|suConfig.dataRate
comma
id|info-&gt;lineSpeed
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.clocking
comma
id|info-&gt;clockSource
)paren
suffix:semicolon
id|my_framing
op_assign
id|FRAMING_E1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;framing
op_eq
id|E1
)paren
id|my_framing
op_assign
id|FRAMING_E1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;framing
op_eq
id|T1
)paren
id|my_framing
op_assign
id|FRAMING_T1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;framing
op_eq
id|J1
)paren
id|my_framing
op_assign
id|FRAMING_J1
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.framing
comma
id|my_framing
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.structure
comma
id|info-&gt;structure
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.interface
comma
id|info-&gt;interface
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.coding
comma
id|info-&gt;coding
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.lineBuildOut
comma
id|info-&gt;lineBuildOut
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.equalizer
comma
id|info-&gt;equalizer
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.transparentMode
comma
id|info-&gt;transparentMode
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.loopMode
comma
id|info-&gt;loopMode
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.range
comma
id|info-&gt;range
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.txBufferMode
comma
id|info-&gt;txBufferMode
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.rxBufferMode
comma
id|info-&gt;rxBufferMode
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.startingSlot
comma
id|info-&gt;startingSlot
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.losThreshold
comma
id|info-&gt;losThreshold
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;idleCode
)paren
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.enableIdleCode
comma
l_int|1
)paren
suffix:semicolon
r_else
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.enableIdleCode
comma
l_int|0
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|suConfig.idleCode
comma
id|info-&gt;idleCode
)paren
suffix:semicolon
macro_line|#if FST_DEBUG
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|FSTVAL_TE1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Setting TE1 data&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Line Speed = %d&bslash;n&quot;
comma
id|info-&gt;lineSpeed
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Start slot = %d&bslash;n&quot;
comma
id|info-&gt;startingSlot
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Clock source = %d&bslash;n&quot;
comma
id|info-&gt;clockSource
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Framing = %d&bslash;n&quot;
comma
id|my_framing
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Structure = %d&bslash;n&quot;
comma
id|info-&gt;structure
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;interface = %d&bslash;n&quot;
comma
id|info-&gt;interface
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Coding = %d&bslash;n&quot;
comma
id|info-&gt;coding
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Line build out = %d&bslash;n&quot;
comma
id|info-&gt;lineBuildOut
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Equaliser = %d&bslash;n&quot;
comma
id|info-&gt;equalizer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Transparent mode = %d&bslash;n&quot;
comma
id|info-&gt;transparentMode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Loop mode = %d&bslash;n&quot;
comma
id|info-&gt;loopMode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Range = %d&bslash;n&quot;
comma
id|info-&gt;range
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Tx Buffer mode = %d&bslash;n&quot;
comma
id|info-&gt;txBufferMode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Rx Buffer mode = %d&bslash;n&quot;
comma
id|info-&gt;rxBufferMode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;LOS Threshold = %d&bslash;n&quot;
comma
id|info-&gt;losThreshold
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Idle Code = %d&bslash;n&quot;
comma
id|info-&gt;idleCode
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#if FST_DEBUG
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|FSTVAL_DEBUG
)paren
(brace
id|fst_debug_mask
op_assign
id|info-&gt;debug
suffix:semicolon
)brace
macro_line|#endif
r_return
id|err
suffix:semicolon
)brace
r_static
r_void
DECL|function|gather_conf_info
id|gather_conf_info
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
comma
r_struct
id|fstioc_info
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fstioc_info
)paren
)paren
suffix:semicolon
id|i
op_assign
id|port-&gt;index
suffix:semicolon
id|info-&gt;kernelVersion
op_assign
id|LINUX_VERSION_CODE
suffix:semicolon
id|info-&gt;nports
op_assign
id|card-&gt;nports
suffix:semicolon
id|info-&gt;type
op_assign
id|card-&gt;type
suffix:semicolon
id|info-&gt;state
op_assign
id|card-&gt;state
suffix:semicolon
id|info-&gt;proto
op_assign
id|FST_GEN_HDLC
suffix:semicolon
id|info-&gt;index
op_assign
id|i
suffix:semicolon
macro_line|#if FST_DEBUG
id|info-&gt;debug
op_assign
id|fst_debug_mask
suffix:semicolon
macro_line|#endif
multiline_comment|/* Only mark information as valid if card is running.&n;&t; * Copy the data anyway in case it is useful for diagnostics&n;&t; */
id|info-&gt;valid
op_assign
(paren
(paren
id|card-&gt;state
op_eq
id|FST_RUNNING
)paren
ques
c_cond
id|FSTVAL_ALL
suffix:colon
id|FSTVAL_CARD
)paren
macro_line|#if FST_DEBUG
op_or
id|FSTVAL_DEBUG
macro_line|#endif
suffix:semicolon
id|info-&gt;lineInterface
op_assign
id|FST_RDW
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineInterface
)paren
suffix:semicolon
id|info-&gt;internalClock
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|internalClock
)paren
suffix:semicolon
id|info-&gt;lineSpeed
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineSpeed
)paren
suffix:semicolon
id|info-&gt;invertClock
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|invertClock
)paren
suffix:semicolon
id|info-&gt;v24IpSts
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|v24IpSts
(braket
id|i
)braket
)paren
suffix:semicolon
id|info-&gt;v24OpSts
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|v24OpSts
(braket
id|i
)braket
)paren
suffix:semicolon
id|info-&gt;clockStatus
op_assign
id|FST_RDW
c_func
(paren
id|card
comma
id|clockStatus
(braket
id|i
)braket
)paren
suffix:semicolon
id|info-&gt;cableStatus
op_assign
id|FST_RDW
c_func
(paren
id|card
comma
id|cableStatus
)paren
suffix:semicolon
id|info-&gt;cardMode
op_assign
id|FST_RDW
c_func
(paren
id|card
comma
id|cardMode
)paren
suffix:semicolon
id|info-&gt;smcFirmwareVersion
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|smcFirmwareVersion
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The T2U can report cable presence for both A or B&n;&t; * in bits 0 and 1 of cableStatus.  See which port we are and &n;&t; * do the mapping.&n;&t; */
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;index
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Port A&n;&t;&t;&t; */
id|info-&gt;cableStatus
op_assign
id|info-&gt;cableStatus
op_amp
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * Port B&n;&t;&t;&t; */
id|info-&gt;cableStatus
op_assign
id|info-&gt;cableStatus
op_rshift
l_int|1
suffix:semicolon
id|info-&gt;cableStatus
op_assign
id|info-&gt;cableStatus
op_amp
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Some additional bits if we are TE1&n;&t; */
r_if
c_cond
(paren
id|card-&gt;type
op_eq
id|FST_TYPE_TE1
)paren
(brace
id|info-&gt;lineSpeed
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|suConfig.dataRate
)paren
suffix:semicolon
id|info-&gt;clockSource
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.clocking
)paren
suffix:semicolon
id|info-&gt;framing
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.framing
)paren
suffix:semicolon
id|info-&gt;structure
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.structure
)paren
suffix:semicolon
id|info-&gt;interface
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.interface
)paren
suffix:semicolon
id|info-&gt;coding
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.coding
)paren
suffix:semicolon
id|info-&gt;lineBuildOut
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.lineBuildOut
)paren
suffix:semicolon
id|info-&gt;equalizer
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.equalizer
)paren
suffix:semicolon
id|info-&gt;loopMode
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.loopMode
)paren
suffix:semicolon
id|info-&gt;range
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.range
)paren
suffix:semicolon
id|info-&gt;txBufferMode
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.txBufferMode
)paren
suffix:semicolon
id|info-&gt;rxBufferMode
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.rxBufferMode
)paren
suffix:semicolon
id|info-&gt;startingSlot
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.startingSlot
)paren
suffix:semicolon
id|info-&gt;losThreshold
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.losThreshold
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.enableIdleCode
)paren
)paren
id|info-&gt;idleCode
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suConfig.idleCode
)paren
suffix:semicolon
r_else
id|info-&gt;idleCode
op_assign
l_int|0
suffix:semicolon
id|info-&gt;receiveBufferDelay
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|suStatus.receiveBufferDelay
)paren
suffix:semicolon
id|info-&gt;framingErrorCount
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|suStatus.framingErrorCount
)paren
suffix:semicolon
id|info-&gt;codeViolationCount
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|suStatus.codeViolationCount
)paren
suffix:semicolon
id|info-&gt;crcErrorCount
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|suStatus.crcErrorCount
)paren
suffix:semicolon
id|info-&gt;lineAttenuation
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|suStatus.lineAttenuation
)paren
suffix:semicolon
id|info-&gt;lossOfSignal
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suStatus.lossOfSignal
)paren
suffix:semicolon
id|info-&gt;receiveRemoteAlarm
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suStatus.receiveRemoteAlarm
)paren
suffix:semicolon
id|info-&gt;alarmIndicationSignal
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|suStatus.alarmIndicationSignal
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|fst_set_iface
id|fst_set_iface
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
comma
r_struct
id|ifreq
op_star
id|ifr
)paren
(brace
id|sync_serial_settings
id|sync
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
op_ne
r_sizeof
(paren
id|sync
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|sync
comma
id|ifr-&gt;ifr_settings.ifs_ifsu.sync
comma
r_sizeof
(paren
id|sync
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sync.loopback
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|i
op_assign
id|port-&gt;index
suffix:semicolon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_IFACE_V35
suffix:colon
id|FST_WRW
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineInterface
comma
id|V35
)paren
suffix:semicolon
id|port-&gt;hwif
op_assign
id|V35
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_IFACE_V24
suffix:colon
id|FST_WRW
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineInterface
comma
id|V24
)paren
suffix:semicolon
id|port-&gt;hwif
op_assign
id|V24
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_IFACE_X21
suffix:colon
id|FST_WRW
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineInterface
comma
id|X21
)paren
suffix:semicolon
id|port-&gt;hwif
op_assign
id|X21
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_IFACE_X21D
suffix:colon
id|FST_WRW
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineInterface
comma
id|X21D
)paren
suffix:semicolon
id|port-&gt;hwif
op_assign
id|X21D
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_IFACE_T1
suffix:colon
id|FST_WRW
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineInterface
comma
id|T1
)paren
suffix:semicolon
id|port-&gt;hwif
op_assign
id|T1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_IFACE_E1
suffix:colon
id|FST_WRW
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineInterface
comma
id|E1
)paren
suffix:semicolon
id|port-&gt;hwif
op_assign
id|E1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_IFACE_SYNC_SERIAL
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sync.clock_type
)paren
(brace
r_case
id|CLOCK_EXT
suffix:colon
id|FST_WRB
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|internalClock
comma
id|EXTCLK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_INT
suffix:colon
id|FST_WRB
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|internalClock
comma
id|INTCLK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|FST_WRL
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineSpeed
comma
id|sync.clock_rate
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fst_get_iface
id|fst_get_iface
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
comma
r_struct
id|fst_port_info
op_star
id|port
comma
r_struct
id|ifreq
op_star
id|ifr
)paren
(brace
id|sync_serial_settings
id|sync
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* First check what line type is set, we&squot;ll default to reporting X.21&n;&t; * if nothing is set as IF_IFACE_SYNC_SERIAL implies it can&squot;t be&n;&t; * changed&n;&t; */
r_switch
c_cond
(paren
id|port-&gt;hwif
)paren
(brace
r_case
id|E1
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_E1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|T1
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_T1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V35
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_V35
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V24
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_V24
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X21D
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_X21D
suffix:semicolon
r_break
suffix:semicolon
r_case
id|X21
suffix:colon
r_default
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_X21
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* only type requested */
)brace
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
OL
r_sizeof
(paren
id|sync
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|i
op_assign
id|port-&gt;index
suffix:semicolon
id|sync.clock_rate
op_assign
id|FST_RDL
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|lineSpeed
)paren
suffix:semicolon
multiline_comment|/* Lucky card and linux use same encoding here */
id|sync.clock_type
op_assign
id|FST_RDB
c_func
(paren
id|card
comma
id|portConfig
(braket
id|i
)braket
dot
id|internalClock
)paren
op_eq
id|INTCLK
ques
c_cond
id|CLOCK_INT
suffix:colon
id|CLOCK_EXT
suffix:semicolon
id|sync.loopback
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_settings.ifs_ifsu.sync
comma
op_amp
id|sync
comma
r_sizeof
(paren
id|sync
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ifr-&gt;ifr_settings.size
op_assign
r_sizeof
(paren
id|sync
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fst_ioctl
id|fst_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
r_struct
id|fst_port_info
op_star
id|port
suffix:semicolon
r_struct
id|fstioc_write
id|wrthdr
suffix:semicolon
r_struct
id|fstioc_info
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_IOCTL
comma
l_string|&quot;ioctl: %x, %p&bslash;n&quot;
comma
id|cmd
comma
id|ifr-&gt;ifr_data
)paren
suffix:semicolon
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
id|card
op_assign
id|port-&gt;card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|FSTCPURESET
suffix:colon
id|fst_cpureset
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_RESET
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|FSTCPURELEASE
suffix:colon
id|fst_cpurelease
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_STARTING
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|FSTWRITE
suffix:colon
multiline_comment|/* Code write (download) */
multiline_comment|/* First copy in the header with the length and offset of data&n;&t;&t; * to write&n;&t;&t; */
r_if
c_cond
(paren
id|ifr-&gt;ifr_data
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|wrthdr
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
r_struct
id|fstioc_write
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Sanity check the parameters. We don&squot;t support partial writes&n;&t;&t; * when going over the top&n;&t;&t; */
r_if
c_cond
(paren
id|wrthdr.size
OG
id|FST_MEMSIZE
op_logical_or
id|wrthdr.offset
OG
id|FST_MEMSIZE
op_logical_or
id|wrthdr.size
op_plus
id|wrthdr.offset
OG
id|FST_MEMSIZE
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/* Now copy the data to the card.&n;&t;&t; * This will probably break on some architectures.&n;&t;&t; * I&squot;ll fix it when I have something to test on.&n;&t;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|card-&gt;mem
op_plus
id|wrthdr.offset
comma
id|ifr-&gt;ifr_data
op_plus
r_sizeof
(paren
r_struct
id|fstioc_write
)paren
comma
id|wrthdr.size
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Writes to the memory of a card in the reset state constitute&n;&t;&t; * a download&n;&t;&t; */
r_if
c_cond
(paren
id|card-&gt;state
op_eq
id|FST_RESET
)paren
(brace
id|card-&gt;state
op_assign
id|FST_DOWNLOAD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|FSTGETCONF
suffix:colon
multiline_comment|/* If card has just been started check the shared memory config&n;&t;&t; * version and marker&n;&t;&t; */
r_if
c_cond
(paren
id|card-&gt;state
op_eq
id|FST_STARTING
)paren
(brace
id|check_started_ok
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* If everything checked out enable card interrupts */
r_if
c_cond
(paren
id|card-&gt;state
op_eq
id|FST_RUNNING
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
id|fst_enable_intr
c_func
(paren
id|card
)paren
suffix:semicolon
id|FST_WRB
c_func
(paren
id|card
comma
id|interruptHandshake
comma
l_int|0xEE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ifr-&gt;ifr_data
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|gather_conf_info
c_func
(paren
id|card
comma
id|port
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|FSTSETCONF
suffix:colon
multiline_comment|/*&n;&t;&t; * Most of the settings have been moved to the generic ioctls&n;&t;&t; * this just covers debug and board ident now&n;&t;&t; */
r_if
c_cond
(paren
id|card-&gt;state
op_ne
id|FST_RUNNING
)paren
(brace
id|printk_err
(paren
l_string|&quot;Attempt to configure card %d in non-running state (%d)&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|card-&gt;state
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|set_conf_from_info
c_func
(paren
id|card
comma
id|port
comma
op_amp
id|info
)paren
suffix:semicolon
r_case
id|SIOCWANDEV
suffix:colon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_GET_IFACE
suffix:colon
r_return
id|fst_get_iface
c_func
(paren
id|card
comma
id|port
comma
id|ifr
)paren
suffix:semicolon
r_case
id|IF_IFACE_SYNC_SERIAL
suffix:colon
r_case
id|IF_IFACE_V35
suffix:colon
r_case
id|IF_IFACE_V24
suffix:colon
r_case
id|IF_IFACE_X21
suffix:colon
r_case
id|IF_IFACE_X21D
suffix:colon
r_case
id|IF_IFACE_T1
suffix:colon
r_case
id|IF_IFACE_E1
suffix:colon
r_return
id|fst_set_iface
c_func
(paren
id|card
comma
id|port
comma
id|ifr
)paren
suffix:semicolon
r_case
id|IF_PROTO_RAW
suffix:colon
id|port-&gt;mode
op_assign
id|FST_RAW
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_GET_PROTO
suffix:colon
r_if
c_cond
(paren
id|port-&gt;mode
op_eq
id|FST_RAW
)paren
(brace
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_PROTO_RAW
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
r_default
suffix:colon
id|port-&gt;mode
op_assign
id|FST_GEN_HDLC
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_IOCTL
comma
l_string|&quot;Passing this type to hdlc %x&bslash;n&quot;
comma
id|ifr-&gt;ifr_settings.type
)paren
suffix:semicolon
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
)brace
r_default
suffix:colon
multiline_comment|/* Not one of ours. Pass through to HDLC package */
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|fst_openport
id|fst_openport
c_func
(paren
r_struct
id|fst_port_info
op_star
id|port
)paren
(brace
r_int
id|signals
suffix:semicolon
r_int
id|txq_length
suffix:semicolon
multiline_comment|/* Only init things if card is actually running. This allows open to&n;&t; * succeed for downloads etc.&n;&t; */
r_if
c_cond
(paren
id|port-&gt;card-&gt;state
op_eq
id|FST_RUNNING
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;run
)paren
(brace
id|dbg
c_func
(paren
id|DBG_OPEN
comma
l_string|&quot;open: found port already running&bslash;n&quot;
)paren
suffix:semicolon
id|fst_issue_cmd
c_func
(paren
id|port
comma
id|STOPPORT
)paren
suffix:semicolon
id|port-&gt;run
op_assign
l_int|0
suffix:semicolon
)brace
id|fst_rx_config
c_func
(paren
id|port
)paren
suffix:semicolon
id|fst_tx_config
c_func
(paren
id|port
)paren
suffix:semicolon
id|fst_op_raise
c_func
(paren
id|port
comma
id|OPSTS_RTS
op_or
id|OPSTS_DTR
)paren
suffix:semicolon
id|fst_issue_cmd
c_func
(paren
id|port
comma
id|STARTPORT
)paren
suffix:semicolon
id|port-&gt;run
op_assign
l_int|1
suffix:semicolon
id|signals
op_assign
id|FST_RDL
c_func
(paren
id|port-&gt;card
comma
id|v24DebouncedSts
(braket
id|port-&gt;index
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signals
op_amp
(paren
(paren
(paren
id|port-&gt;hwif
op_eq
id|X21
)paren
op_logical_or
(paren
id|port-&gt;hwif
op_eq
id|X21D
)paren
)paren
ques
c_cond
id|IPSTS_INDICATE
suffix:colon
id|IPSTS_DCD
)paren
)paren
id|netif_carrier_on
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_else
id|netif_carrier_off
c_func
(paren
id|port_to_dev
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|txq_length
op_assign
id|port-&gt;txqe
op_minus
id|port-&gt;txqs
suffix:semicolon
id|port-&gt;txqe
op_assign
l_int|0
suffix:semicolon
id|port-&gt;txqs
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|fst_closeport
id|fst_closeport
c_func
(paren
r_struct
id|fst_port_info
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;card-&gt;state
op_eq
id|FST_RUNNING
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;run
)paren
(brace
id|port-&gt;run
op_assign
l_int|0
suffix:semicolon
id|fst_op_lower
c_func
(paren
id|port
comma
id|OPSTS_RTS
op_or
id|OPSTS_DTR
)paren
suffix:semicolon
id|fst_issue_cmd
c_func
(paren
id|port
comma
id|STOPPORT
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
id|DBG_OPEN
comma
l_string|&quot;close: port not running&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_int
DECL|function|fst_open
id|fst_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|fst_port_info
op_star
id|port
suffix:semicolon
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|try_module_get
c_func
(paren
id|THIS_MODULE
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;mode
op_ne
id|FST_RAW
)paren
(brace
id|err
op_assign
id|hdlc_open
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
)brace
id|fst_openport
c_func
(paren
id|port
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fst_close
id|fst_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fst_port_info
op_star
id|port
suffix:semicolon
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
r_int
r_char
id|tx_dma_done
suffix:semicolon
r_int
r_char
id|rx_dma_done
suffix:semicolon
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
id|card
op_assign
id|port-&gt;card
suffix:semicolon
id|tx_dma_done
op_assign
id|inb
c_func
(paren
id|card-&gt;pci_conf
op_plus
id|DMACSR1
)paren
suffix:semicolon
id|rx_dma_done
op_assign
id|inb
c_func
(paren
id|card-&gt;pci_conf
op_plus
id|DMACSR0
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_OPEN
comma
l_string|&quot;Port Close: tx_dma_in_progress = %d (%x) rx_dma_in_progress = %d (%x)&bslash;n&quot;
comma
id|card-&gt;dmatx_in_progress
comma
id|tx_dma_done
comma
id|card-&gt;dmarx_in_progress
comma
id|rx_dma_done
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fst_closeport
c_func
(paren
id|dev_to_port
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;mode
op_ne
id|FST_RAW
)paren
(brace
id|hdlc_close
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fst_attach
id|fst_attach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|encoding
comma
r_int
r_int
id|parity
)paren
(brace
multiline_comment|/*&n;&t; * Setting currently fixed in FarSync card so we check and forget&n;&t; */
r_if
c_cond
(paren
id|encoding
op_ne
id|ENCODING_NRZ
op_logical_or
id|parity
op_ne
id|PARITY_CRC16_PR1_CCITT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|fst_tx_timeout
id|fst_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fst_port_info
op_star
id|port
suffix:semicolon
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
id|card
op_assign
id|port-&gt;card
suffix:semicolon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Tx timeout card %d port %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|port-&gt;index
)paren
suffix:semicolon
id|fst_issue_cmd
c_func
(paren
id|port
comma
id|ABORTTX
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|port-&gt;start
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fst_start_xmit
id|fst_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
r_struct
id|fst_port_info
op_star
id|port
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|txq_length
suffix:semicolon
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
id|card
op_assign
id|port-&gt;card
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_TX
comma
l_string|&quot;fst_start_xmit: length = %d&bslash;n&quot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Drop packet with error if we don&squot;t have carrier */
r_if
c_cond
(paren
op_logical_neg
id|netif_carrier_ok
c_func
(paren
id|dev
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_carrier_errors
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Tried to transmit but no carrier on card %d port %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|port-&gt;index
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Drop it if it&squot;s too big! MTU failure ? */
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|LEN_TX_BUFFER
)paren
(brace
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Packet too large %d vs %d&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|LEN_TX_BUFFER
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We are always going to queue the packet&n;&t; * so that the bottom half is the only place we tx from&n;&t; * Check there is room in the port txq&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|txq_length
op_assign
id|port-&gt;txqe
op_minus
id|port-&gt;txqs
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * This is the case where the next free has wrapped but the&n;&t;&t; * last used hasn&squot;t&n;&t;&t; */
id|txq_length
op_assign
id|txq_length
op_plus
id|FST_TXQ_DEPTH
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txq_length
OG
id|fst_txq_high
)paren
(brace
multiline_comment|/*&n;&t;&t; * We have got enough buffers in the pipeline.  Ask the network&n;&t;&t; * layer to stop sending frames down&n;&t;&t; */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|port-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* I&squot;m using this to signal stop sent up */
)brace
r_if
c_cond
(paren
id|txq_length
op_eq
id|FST_TXQ_DEPTH
op_minus
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t; * This shouldn&squot;t have happened but such is life&n;&t;&t; */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;Tx queue overflow card %d port %d&bslash;n&quot;
comma
id|card-&gt;card_no
comma
id|port-&gt;index
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * queue the buffer&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
id|port-&gt;txq
(braket
id|port-&gt;txqe
)braket
op_assign
id|skb
suffix:semicolon
id|port-&gt;txqe
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;txqe
op_eq
id|FST_TXQ_DEPTH
)paren
id|port-&gt;txqe
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;card_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Scehdule the bottom half which now does transmit processing */
id|fst_q_work_item
c_func
(paren
op_amp
id|fst_work_txq
comma
id|card-&gt;card_no
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|fst_tx_task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *      Card setup having checked hardware resources.&n; *      Should be pretty bizarre if we get an error here (kernel memory&n; *      exhaustion is one possibility). If we do see a problem we report it&n; *      via a printk and leave the corresponding interface and all that follow&n; *      disabled.&n; */
DECL|variable|__devinitdata
r_static
r_char
op_star
id|type_strings
(braket
)braket
id|__devinitdata
op_assign
(brace
l_string|&quot;no hardware&quot;
comma
multiline_comment|/* Should never be seen */
l_string|&quot;FarSync T2P&quot;
comma
l_string|&quot;FarSync T4P&quot;
comma
l_string|&quot;FarSync T1U&quot;
comma
l_string|&quot;FarSync T2U&quot;
comma
l_string|&quot;FarSync T4U&quot;
comma
l_string|&quot;FarSync TE1&quot;
)brace
suffix:semicolon
r_static
r_void
id|__devinit
DECL|function|fst_init_card
id|fst_init_card
c_func
(paren
r_struct
id|fst_card_info
op_star
id|card
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* We&squot;re working on a number of ports based on the card ID. If the&n;&t; * firmware detects something different later (should never happen)&n;&t; * we&squot;ll have to revise it in some way then.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;nports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|err
op_assign
id|register_hdlc_device
c_func
(paren
id|card-&gt;ports
(braket
id|i
)braket
dot
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_int
id|j
suffix:semicolon
id|printk_err
(paren
l_string|&quot;Cannot register HDLC device for port %d&quot;
l_string|&quot; (errno %d)&bslash;n&quot;
comma
id|i
comma
op_minus
id|err
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|i
suffix:semicolon
id|j
OL
id|card-&gt;nports
suffix:semicolon
id|j
op_increment
)paren
(brace
id|free_netdev
c_func
(paren
id|card-&gt;ports
(braket
id|j
)braket
dot
id|dev
)paren
suffix:semicolon
id|card-&gt;ports
(braket
id|j
)braket
dot
id|dev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|card-&gt;nports
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|printk_info
c_func
(paren
l_string|&quot;%s-%s: %s IRQ%d, %d ports&bslash;n&quot;
comma
id|port_to_dev
c_func
(paren
op_amp
id|card-&gt;ports
(braket
l_int|0
)braket
)paren
op_member_access_from_pointer
id|name
comma
id|port_to_dev
c_func
(paren
op_amp
id|card-&gt;ports
(braket
id|card-&gt;nports
op_minus
l_int|1
)braket
)paren
op_member_access_from_pointer
id|name
comma
id|type_strings
(braket
id|card-&gt;type
)braket
comma
id|card-&gt;irq
comma
id|card-&gt;nports
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *      Initialise card when detected.&n; *      Returns 0 to indicate success, or errno otherwise.&n; */
r_static
r_int
id|__devinit
DECL|function|fst_add_one
id|fst_add_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
id|firsttime_done
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|no_of_cards_added
op_assign
l_int|0
suffix:semicolon
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|firsttime_done
)paren
(brace
id|printk_info
c_func
(paren
l_string|&quot;FarSync WAN driver &quot;
id|FST_USER_VERSION
l_string|&quot; (c) 2001-2004 FarSite Communications Ltd.&bslash;n&quot;
)paren
suffix:semicolon
id|firsttime_done
op_assign
l_int|1
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_ASS
comma
l_string|&quot;The value of debug mask is %x&bslash;n&quot;
comma
id|fst_debug_mask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We are going to be clever and allow certain cards not to be&n;&t; * configured.  An exclude list can be provided in /etc/modules.conf&n;&t; */
r_if
c_cond
(paren
id|fst_excluded_cards
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * There are cards to exclude&n;&t;&t; *&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fst_excluded_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|pdev-&gt;devfn
)paren
op_rshift
l_int|3
op_eq
id|fst_excluded_list
(braket
id|i
)braket
)paren
(brace
id|printk_info
c_func
(paren
l_string|&quot;FarSync PCI device %d not assigned&bslash;n&quot;
comma
(paren
id|pdev-&gt;devfn
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Allocate driver private data */
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fst_card_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;FarSync card found but insufficient memory for&quot;
l_string|&quot; driver storage&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fst_card_info
)paren
)paren
suffix:semicolon
multiline_comment|/* Try to enable the device */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Failed to enable card. Err %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;FarSync&quot;
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Failed to allocate regions. Err %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Get virtual addresses of memory regions */
id|card-&gt;pci_conf
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|card-&gt;phys_mem
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|card-&gt;phys_ctlmem
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;mem
op_assign
id|ioremap
c_func
(paren
id|card-&gt;phys_mem
comma
id|FST_MEMSIZE
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Physical memory remap failed&bslash;n&quot;
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|card-&gt;ctlmem
op_assign
id|ioremap
c_func
(paren
id|card-&gt;phys_ctlmem
comma
l_int|0x10
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Control memory remap failed&bslash;n&quot;
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|DBG_PCI
comma
l_string|&quot;kernel mem %p, ctlmem %p&bslash;n&quot;
comma
id|card-&gt;mem
comma
id|card-&gt;ctlmem
)paren
suffix:semicolon
multiline_comment|/* Register the interrupt handler */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|fst_intr
comma
id|SA_SHIRQ
comma
id|FST_DEV_NAME
comma
id|card
)paren
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Unable to register interrupt %d&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;ctlmem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;mem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Record info we need */
id|card-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|card-&gt;type
op_assign
id|ent-&gt;driver_data
suffix:semicolon
id|card-&gt;family
op_assign
(paren
(paren
id|ent-&gt;driver_data
op_eq
id|FST_TYPE_T2P
)paren
op_logical_or
(paren
id|ent-&gt;driver_data
op_eq
id|FST_TYPE_T4P
)paren
)paren
ques
c_cond
id|FST_FAMILY_TXP
suffix:colon
id|FST_FAMILY_TXU
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ent-&gt;driver_data
op_eq
id|FST_TYPE_T1U
)paren
op_logical_or
(paren
id|ent-&gt;driver_data
op_eq
id|FST_TYPE_TE1
)paren
)paren
id|card-&gt;nports
op_assign
l_int|1
suffix:semicolon
r_else
id|card-&gt;nports
op_assign
(paren
(paren
id|ent-&gt;driver_data
op_eq
id|FST_TYPE_T2P
)paren
op_logical_or
(paren
id|ent-&gt;driver_data
op_eq
id|FST_TYPE_T2U
)paren
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_UNINIT
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|card-&gt;card_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;nports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|alloc_hdlcdev
c_func
(paren
op_amp
id|card-&gt;ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|hdlc_device
op_star
id|hdlc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|free_netdev
c_func
(paren
id|card-&gt;ports
(braket
id|i
)braket
dot
id|dev
)paren
suffix:semicolon
id|printk_err
(paren
l_string|&quot;FarSync: out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;ctlmem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;mem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|card-&gt;ports
(braket
id|i
)braket
dot
id|dev
op_assign
id|dev
suffix:semicolon
id|card-&gt;ports
(braket
id|i
)braket
dot
id|card
op_assign
id|card
suffix:semicolon
id|card-&gt;ports
(braket
id|i
)braket
dot
id|index
op_assign
id|i
suffix:semicolon
id|card-&gt;ports
(braket
id|i
)braket
dot
id|run
op_assign
l_int|0
suffix:semicolon
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Fill in the net device info */
multiline_comment|/* Since this is a PCI setup this is purely&n;&t;&t; * informational. Give them the buffer addresses&n;&t;&t; * and basic card I/O.&n;&t;&t; */
id|dev-&gt;mem_start
op_assign
id|card-&gt;phys_mem
op_plus
id|BUF_OFFSET
(paren
id|txBuffer
(braket
id|i
)braket
(braket
l_int|0
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|card-&gt;phys_mem
op_plus
id|BUF_OFFSET
(paren
id|txBuffer
(braket
id|i
)braket
(braket
id|NUM_TX_BUFFER
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|card-&gt;pci_conf
suffix:semicolon
id|dev-&gt;irq
op_assign
id|card-&gt;irq
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
id|FST_TX_QUEUE_LEN
suffix:semicolon
id|dev-&gt;open
op_assign
id|fst_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|fst_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|fst_ioctl
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|FST_TX_TIMEOUT
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|fst_tx_timeout
suffix:semicolon
id|hdlc-&gt;attach
op_assign
id|fst_attach
suffix:semicolon
id|hdlc-&gt;xmit
op_assign
id|fst_start_xmit
suffix:semicolon
)brace
id|card-&gt;device
op_assign
id|pdev
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_PCI
comma
l_string|&quot;type %d nports %d irq %d&bslash;n&quot;
comma
id|card-&gt;type
comma
id|card-&gt;nports
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|DBG_PCI
comma
l_string|&quot;conf %04x mem %08x ctlmem %08x&bslash;n&quot;
comma
id|card-&gt;pci_conf
comma
id|card-&gt;phys_mem
comma
id|card-&gt;phys_ctlmem
)paren
suffix:semicolon
multiline_comment|/* Reset the card&squot;s processor */
id|fst_cpureset
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|FST_RESET
suffix:semicolon
multiline_comment|/* Initialise DMA (if required) */
id|fst_init_dma
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* Record driver data for later use */
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* Remainder of card setup */
id|fst_card_array
(braket
id|no_of_cards_added
)braket
op_assign
id|card
suffix:semicolon
id|card-&gt;card_no
op_assign
id|no_of_cards_added
op_increment
suffix:semicolon
multiline_comment|/* Record instance and bump it */
id|fst_init_card
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
multiline_comment|/*&n;&t;&t; * Allocate a dma buffer for transmit and receives&n;&t;&t; */
id|card-&gt;rx_dma_handle_host
op_assign
id|pci_alloc_consistent
c_func
(paren
id|card-&gt;device
comma
id|FST_MAX_MTU
comma
op_amp
id|card-&gt;rx_dma_handle_card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rx_dma_handle_host
op_eq
l_int|NULL
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Could not allocate rx dma buffer&bslash;n&quot;
)paren
suffix:semicolon
id|fst_disable_intr
c_func
(paren
id|card
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;ctlmem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;mem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|card-&gt;tx_dma_handle_host
op_assign
id|pci_alloc_consistent
c_func
(paren
id|card-&gt;device
comma
id|FST_MAX_MTU
comma
op_amp
id|card-&gt;tx_dma_handle_card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tx_dma_handle_host
op_eq
l_int|NULL
)paren
(brace
id|printk_err
c_func
(paren
l_string|&quot;Could not allocate tx dma buffer&bslash;n&quot;
)paren
suffix:semicolon
id|fst_disable_intr
c_func
(paren
id|card
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;ctlmem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;mem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Success */
)brace
multiline_comment|/*&n; *      Cleanup and close down a card&n; */
r_static
r_void
id|__devexit
DECL|function|fst_remove_one
id|fst_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|fst_card_info
op_star
id|card
suffix:semicolon
r_int
id|i
suffix:semicolon
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;nports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|port_to_dev
c_func
(paren
op_amp
id|card-&gt;ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|unregister_hdlc_device
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|fst_disable_intr
c_func
(paren
id|card
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;ctlmem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;mem
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;family
op_eq
id|FST_FAMILY_TXU
)paren
(brace
multiline_comment|/*&n;&t;&t; * Free dma buffers&n;&t;&t; */
id|pci_free_consistent
c_func
(paren
id|card-&gt;device
comma
id|FST_MAX_MTU
comma
id|card-&gt;rx_dma_handle_host
comma
id|card-&gt;rx_dma_handle_card
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|card-&gt;device
comma
id|FST_MAX_MTU
comma
id|card-&gt;tx_dma_handle_host
comma
id|card-&gt;tx_dma_handle_card
)paren
suffix:semicolon
)brace
id|fst_card_array
(braket
id|card-&gt;card_no
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|variable|fst_driver
r_static
r_struct
id|pci_driver
id|fst_driver
op_assign
(brace
dot
id|name
op_assign
id|FST_NAME
comma
dot
id|id_table
op_assign
id|fst_pci_dev_id
comma
dot
id|probe
op_assign
id|fst_add_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|fst_remove_one
)paren
comma
dot
id|suspend
op_assign
l_int|NULL
comma
dot
id|resume
op_assign
l_int|NULL
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|fst_init
id|fst_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FST_MAX_CARDS
suffix:semicolon
id|i
op_increment
)paren
id|fst_card_array
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|fst_work_q_lock
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|fst_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|fst_cleanup_module
id|fst_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|printk_info
c_func
(paren
l_string|&quot;FarSync WAN driver unloading&bslash;n&quot;
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|fst_driver
)paren
suffix:semicolon
)brace
DECL|variable|fst_init
id|module_init
c_func
(paren
id|fst_init
)paren
suffix:semicolon
DECL|variable|fst_cleanup_module
id|module_exit
c_func
(paren
id|fst_cleanup_module
)paren
suffix:semicolon
eof
