multiline_comment|/*&n; * wanXL serial card driver for Linux&n; * host part&n; *&n; * Copyright (C) 2003 Krzysztof Halasa &lt;khc@pm.waw.pl&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of version 2 of the GNU General Public License&n; * as published by the Free Software Foundation.&n; *&n; * Status:&n; *   - Only DTE (external clock) support with NRZ and NRZI encodings&n; *   - wanXL100 will require minor driver modifications, no access to hw&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &quot;wanxl.h&quot;
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;wanXL serial card driver version: 0.48&quot;
suffix:semicolon
DECL|macro|PLX_CTL_RESET
mdefine_line|#define PLX_CTL_RESET   0x40000000 /* adapter reset */
DECL|macro|DEBUG_PKT
macro_line|#undef DEBUG_PKT
DECL|macro|DEBUG_PCI
macro_line|#undef DEBUG_PCI
multiline_comment|/* MAILBOX #1 - PUTS COMMANDS */
DECL|macro|MBX1_CMD_ABORTJ
mdefine_line|#define MBX1_CMD_ABORTJ 0x85000000 /* Abort and Jump */
macro_line|#ifdef __LITTLE_ENDIAN
DECL|macro|MBX1_CMD_BSWAP
mdefine_line|#define MBX1_CMD_BSWAP  0x8C000001 /* little-endian Byte Swap Mode */
macro_line|#else
DECL|macro|MBX1_CMD_BSWAP
mdefine_line|#define MBX1_CMD_BSWAP  0x8C000000 /* big-endian Byte Swap Mode */
macro_line|#endif
multiline_comment|/* MAILBOX #2 - DRAM SIZE */
DECL|macro|MBX2_MEMSZ_MASK
mdefine_line|#define MBX2_MEMSZ_MASK 0xFFFF0000 /* PUTS Memory Size Register mask */
r_typedef
r_struct
(brace
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
DECL|member|card
r_struct
id|card_t
op_star
id|card
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* for wanxl_xmit */
DECL|member|node
r_int
id|node
suffix:semicolon
multiline_comment|/* physical port #0 - 3 */
DECL|member|clock_type
r_int
r_int
id|clock_type
suffix:semicolon
DECL|member|tx_in
DECL|member|tx_out
r_int
id|tx_in
comma
id|tx_out
suffix:semicolon
DECL|member|tx_skbs
r_struct
id|sk_buff
op_star
id|tx_skbs
(braket
id|TX_BUFFERS
)braket
suffix:semicolon
DECL|typedef|port_t
)brace
id|port_t
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|rx_descs
id|desc_t
id|rx_descs
(braket
id|RX_QUEUE_LENGTH
)braket
suffix:semicolon
DECL|member|port_status
id|port_status_t
id|port_status
(braket
l_int|4
)braket
suffix:semicolon
DECL|typedef|card_status_t
)brace
id|card_status_t
suffix:semicolon
DECL|struct|card_t
r_typedef
r_struct
id|card_t
(brace
DECL|member|n_ports
r_int
id|n_ports
suffix:semicolon
multiline_comment|/* 1, 2 or 4 ports */
DECL|member|irq
id|u8
id|irq
suffix:semicolon
DECL|member|plx
id|u8
id|__iomem
op_star
id|plx
suffix:semicolon
multiline_comment|/* PLX PCI9060 virtual base address */
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
multiline_comment|/* for pdev-&gt;slot_name */
DECL|member|rx_in
r_int
id|rx_in
suffix:semicolon
DECL|member|rx_skbs
r_struct
id|sk_buff
op_star
id|rx_skbs
(braket
id|RX_QUEUE_LENGTH
)braket
suffix:semicolon
DECL|member|status
id|card_status_t
op_star
id|status
suffix:semicolon
multiline_comment|/* shared between host and card */
DECL|member|status_address
id|dma_addr_t
id|status_address
suffix:semicolon
DECL|member|ports
id|port_t
id|ports
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* 1 - 4 port_t structures follow */
DECL|typedef|card_t
)brace
id|card_t
suffix:semicolon
DECL|function|dev_to_port
r_static
r_inline
id|port_t
op_star
id|dev_to_port
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
(paren
id|port_t
op_star
)paren
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|priv
suffix:semicolon
)brace
DECL|function|card_name
r_static
r_inline
r_const
r_char
op_star
id|card_name
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_return
id|pdev-&gt;slot_name
suffix:semicolon
)brace
DECL|function|get_status
r_static
r_inline
id|port_status_t
op_star
id|get_status
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
r_return
op_amp
id|port-&gt;card-&gt;status-&gt;port_status
(braket
id|port-&gt;node
)braket
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_PCI
DECL|function|pci_map_single_debug
r_static
r_inline
id|dma_addr_t
id|pci_map_single_debug
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_void
op_star
id|ptr
comma
r_int
id|size
comma
r_int
id|direction
)paren
(brace
id|dma_addr_t
id|addr
op_assign
id|pci_map_single
c_func
(paren
id|pdev
comma
id|ptr
comma
id|size
comma
id|direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_plus
id|size
OG
l_int|0x100000000LL
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;wanXL %s: pci_map_single() returned memory&quot;
l_string|&quot; at 0x%LX!&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
comma
(paren
r_int
r_int
r_int
)paren
id|addr
)paren
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
DECL|macro|pci_map_single
macro_line|#undef pci_map_single
DECL|macro|pci_map_single
mdefine_line|#define pci_map_single pci_map_single_debug
macro_line|#endif
multiline_comment|/* Cable and/or personality module change interrupt service */
DECL|function|wanxl_cable_intr
r_static
r_inline
r_void
id|wanxl_cable_intr
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
id|u32
id|value
op_assign
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|cable
suffix:semicolon
r_int
id|valid
op_assign
l_int|1
suffix:semicolon
r_const
r_char
op_star
id|cable
comma
op_star
id|pm
comma
op_star
id|dte
op_assign
l_string|&quot;&quot;
comma
op_star
id|dsr
op_assign
l_string|&quot;&quot;
comma
op_star
id|dcd
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_switch
c_cond
(paren
id|value
op_amp
l_int|0x7
)paren
(brace
r_case
id|STATUS_CABLE_V35
suffix:colon
id|cable
op_assign
l_string|&quot;V.35&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_CABLE_X21
suffix:colon
id|cable
op_assign
l_string|&quot;X.21&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_CABLE_V24
suffix:colon
id|cable
op_assign
l_string|&quot;V.24&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_CABLE_EIA530
suffix:colon
id|cable
op_assign
l_string|&quot;EIA530&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_CABLE_NONE
suffix:colon
id|cable
op_assign
l_string|&quot;no&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cable
op_assign
l_string|&quot;invalid&quot;
suffix:semicolon
)brace
r_switch
c_cond
(paren
(paren
id|value
op_rshift
id|STATUS_CABLE_PM_SHIFT
)paren
op_amp
l_int|0x7
)paren
(brace
r_case
id|STATUS_CABLE_V35
suffix:colon
id|pm
op_assign
l_string|&quot;V.35&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_CABLE_X21
suffix:colon
id|pm
op_assign
l_string|&quot;X.21&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_CABLE_V24
suffix:colon
id|pm
op_assign
l_string|&quot;V.24&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_CABLE_EIA530
suffix:colon
id|pm
op_assign
l_string|&quot;EIA530&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_CABLE_NONE
suffix:colon
id|pm
op_assign
l_string|&quot;no personality&quot;
suffix:semicolon
id|valid
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pm
op_assign
l_string|&quot;invalid personality&quot;
suffix:semicolon
id|valid
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_amp
l_int|7
)paren
op_eq
(paren
(paren
id|value
op_rshift
id|STATUS_CABLE_PM_SHIFT
)paren
op_amp
l_int|7
)paren
)paren
(brace
id|dsr
op_assign
(paren
id|value
op_amp
id|STATUS_CABLE_DSR
)paren
ques
c_cond
l_string|&quot;, DSR ON&quot;
suffix:colon
l_string|&quot;, DSR off&quot;
suffix:semicolon
id|dcd
op_assign
(paren
id|value
op_amp
id|STATUS_CABLE_DCD
)paren
ques
c_cond
l_string|&quot;, carrier ON&quot;
suffix:colon
l_string|&quot;, carrier off&quot;
suffix:semicolon
)brace
id|dte
op_assign
(paren
id|value
op_amp
id|STATUS_CABLE_DCE
)paren
ques
c_cond
l_string|&quot; DCE&quot;
suffix:colon
l_string|&quot; DTE&quot;
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s%s module, %s cable%s%s&bslash;n&quot;
comma
id|port-&gt;dev-&gt;name
comma
id|pm
comma
id|dte
comma
id|cable
comma
id|dsr
comma
id|dcd
)paren
suffix:semicolon
id|hdlc_set_carrier
c_func
(paren
id|value
op_amp
id|STATUS_CABLE_DCD
comma
id|port-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Transmit complete interrupt service */
DECL|function|wanxl_tx_intr
r_static
r_inline
r_void
id|wanxl_tx_intr
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|port-&gt;dev
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|desc_t
op_star
id|desc
op_assign
op_amp
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|tx_descs
(braket
id|port-&gt;tx_in
)braket
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|port-&gt;tx_skbs
(braket
id|port-&gt;tx_in
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|desc-&gt;stat
)paren
(brace
r_case
id|PACKET_FULL
suffix:colon
r_case
id|PACKET_EMPTY
suffix:colon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|PACKET_UNDERRUN
suffix:colon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_fifo_errors
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|desc-&gt;stat
op_assign
id|PACKET_EMPTY
suffix:semicolon
multiline_comment|/* Free descriptor */
id|pci_unmap_single
c_func
(paren
id|port-&gt;card-&gt;pdev
comma
id|desc-&gt;address
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|port-&gt;tx_in
op_assign
(paren
id|port-&gt;tx_in
op_plus
l_int|1
)paren
op_mod
id|TX_BUFFERS
suffix:semicolon
)brace
)brace
multiline_comment|/* Receive complete interrupt service */
DECL|function|wanxl_rx_intr
r_static
r_inline
r_void
id|wanxl_rx_intr
c_func
(paren
id|card_t
op_star
id|card
)paren
(brace
id|desc_t
op_star
id|desc
suffix:semicolon
r_while
c_loop
(paren
id|desc
op_assign
op_amp
id|card-&gt;status-&gt;rx_descs
(braket
id|card-&gt;rx_in
)braket
comma
id|desc-&gt;stat
op_ne
id|PACKET_EMPTY
)paren
(brace
r_if
c_cond
(paren
(paren
id|desc-&gt;stat
op_amp
id|PACKET_PORT_MASK
)paren
OG
id|card-&gt;n_ports
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;wanXL %s: received packet for&quot;
l_string|&quot; nonexistent port&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|card-&gt;pdev
)paren
)paren
suffix:semicolon
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|card-&gt;rx_skbs
(braket
id|card-&gt;rx_in
)braket
suffix:semicolon
id|port_t
op_star
id|port
op_assign
op_amp
id|card-&gt;ports
(braket
id|desc-&gt;stat
op_amp
id|PACKET_PORT_MASK
)braket
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|port-&gt;dev
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
r_else
(brace
id|pci_unmap_single
c_func
(paren
id|card-&gt;pdev
comma
id|desc-&gt;address
comma
id|BUFFER_LENGTH
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|desc-&gt;length
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_PKT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s RX(%i):&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|debug_frame
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|hdlc_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|BUFFER_LENGTH
)paren
suffix:semicolon
id|desc-&gt;address
op_assign
id|skb
ques
c_cond
id|pci_map_single
c_func
(paren
id|card-&gt;pdev
comma
id|skb-&gt;data
comma
id|BUFFER_LENGTH
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:colon
l_int|0
suffix:semicolon
id|card-&gt;rx_skbs
(braket
id|card-&gt;rx_in
)braket
op_assign
id|skb
suffix:semicolon
)brace
)brace
id|desc-&gt;stat
op_assign
id|PACKET_EMPTY
suffix:semicolon
multiline_comment|/* Free descriptor */
id|card-&gt;rx_in
op_assign
(paren
id|card-&gt;rx_in
op_plus
l_int|1
)paren
op_mod
id|RX_QUEUE_LENGTH
suffix:semicolon
)brace
)brace
DECL|function|wanxl_intr
r_static
id|irqreturn_t
id|wanxl_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|card_t
op_star
id|card
op_assign
id|dev_id
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|stat
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;plx
op_plus
id|PLX_DOORBELL_FROM_CARD
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|handled
op_assign
l_int|1
suffix:semicolon
id|writel
c_func
(paren
id|stat
comma
id|card-&gt;plx
op_plus
id|PLX_DOORBELL_FROM_CARD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|stat
op_amp
(paren
l_int|1
op_lshift
(paren
id|DOORBELL_FROM_CARD_TX_0
op_plus
id|i
)paren
)paren
)paren
id|wanxl_tx_intr
c_func
(paren
op_amp
id|card-&gt;ports
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
(paren
l_int|1
op_lshift
(paren
id|DOORBELL_FROM_CARD_CABLE_0
op_plus
id|i
)paren
)paren
)paren
id|wanxl_cable_intr
c_func
(paren
op_amp
id|card-&gt;ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
(paren
l_int|1
op_lshift
id|DOORBELL_FROM_CARD_RX
)paren
)paren
id|wanxl_rx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
DECL|function|wanxl_xmit
r_static
r_int
id|wanxl_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|port_t
op_star
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
id|desc_t
op_star
id|desc
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
id|desc
op_assign
op_amp
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|tx_descs
(braket
id|port-&gt;tx_out
)braket
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;stat
op_ne
id|PACKET_EMPTY
)paren
(brace
multiline_comment|/* should never happen - previous xmit should stop queue */
macro_line|#ifdef DEBUG_PKT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: transmitter buffer full&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* request packet to be queued */
)brace
macro_line|#ifdef DEBUG_PKT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s TX(%i):&quot;
comma
id|dev-&gt;name
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|debug_frame
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|port-&gt;tx_skbs
(braket
id|port-&gt;tx_out
)braket
op_assign
id|skb
suffix:semicolon
id|desc-&gt;address
op_assign
id|pci_map_single
c_func
(paren
id|port-&gt;card-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|desc-&gt;length
op_assign
id|skb-&gt;len
suffix:semicolon
id|desc-&gt;stat
op_assign
id|PACKET_FULL
suffix:semicolon
id|writel
c_func
(paren
l_int|1
op_lshift
(paren
id|DOORBELL_TO_CARD_TX_0
op_plus
id|port-&gt;node
)paren
comma
id|port-&gt;card-&gt;plx
op_plus
id|PLX_DOORBELL_TO_CARD
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|port-&gt;tx_out
op_assign
(paren
id|port-&gt;tx_out
op_plus
l_int|1
)paren
op_mod
id|TX_BUFFERS
suffix:semicolon
r_if
c_cond
(paren
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|tx_descs
(braket
id|port-&gt;tx_out
)braket
dot
id|stat
op_ne
id|PACKET_EMPTY
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_PKT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: transmitter buffer full&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
)brace
id|spin_unlock
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wanxl_attach
r_static
r_int
id|wanxl_attach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|encoding
comma
r_int
r_int
id|parity
)paren
(brace
id|port_t
op_star
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|encoding
op_ne
id|ENCODING_NRZ
op_logical_and
id|encoding
op_ne
id|ENCODING_NRZI
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|parity
op_ne
id|PARITY_NONE
op_logical_and
id|parity
op_ne
id|PARITY_CRC32_PR1_CCITT
op_logical_and
id|parity
op_ne
id|PARITY_CRC16_PR1_CCITT
op_logical_and
id|parity
op_ne
id|PARITY_CRC32_PR0_CCITT
op_logical_and
id|parity
op_ne
id|PARITY_CRC16_PR0_CCITT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|encoding
op_assign
id|encoding
suffix:semicolon
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|parity
op_assign
id|parity
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wanxl_ioctl
r_static
r_int
id|wanxl_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_const
r_int
id|size
op_assign
r_sizeof
(paren
id|sync_serial_settings
)paren
suffix:semicolon
id|sync_serial_settings
id|line
suffix:semicolon
id|port_t
op_star
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCWANDEV
)paren
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_GET_IFACE
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_SYNC_SERIAL
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
OL
id|size
)paren
(brace
id|ifr-&gt;ifr_settings.size
op_assign
id|size
suffix:semicolon
multiline_comment|/* data size wanted */
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|line.clock_type
op_assign
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|clocking
suffix:semicolon
id|line.clock_rate
op_assign
l_int|0
suffix:semicolon
id|line.loopback
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_settings.ifs_ifsu.sync
comma
op_amp
id|line
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_IFACE_SYNC_SERIAL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|line
comma
id|ifr-&gt;ifr_settings.ifs_ifsu.sync
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|line.clock_type
op_ne
id|CLOCK_EXT
op_logical_and
id|line.clock_type
op_ne
id|CLOCK_TXFROMRX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* No such clock setting */
r_if
c_cond
(paren
id|line.loopback
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|clocking
op_assign
id|line.clock_type
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
DECL|function|wanxl_open
r_static
r_int
id|wanxl_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|port_t
op_star
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
id|u8
id|__iomem
op_star
id|dbr
op_assign
id|port-&gt;card-&gt;plx
op_plus
id|PLX_DOORBELL_TO_CARD
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|open
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: port already open&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|hdlc_open
c_func
(paren
id|dev
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|i
suffix:semicolon
id|port-&gt;tx_in
op_assign
id|port-&gt;tx_out
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|tx_descs
(braket
id|i
)braket
dot
id|stat
op_assign
id|PACKET_EMPTY
suffix:semicolon
multiline_comment|/* signal the card */
id|writel
c_func
(paren
l_int|1
op_lshift
(paren
id|DOORBELL_TO_CARD_OPEN_0
op_plus
id|port-&gt;node
)paren
comma
id|dbr
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_do
r_if
c_cond
(paren
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|open
)paren
(brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|timeout
comma
id|jiffies
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to open port&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* ask the card to close the port, should it be still alive */
id|writel
c_func
(paren
l_int|1
op_lshift
(paren
id|DOORBELL_TO_CARD_CLOSE_0
op_plus
id|port-&gt;node
)paren
comma
id|dbr
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
DECL|function|wanxl_close
r_static
r_int
id|wanxl_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|port_t
op_star
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hdlc_close
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* signal the card */
id|writel
c_func
(paren
l_int|1
op_lshift
(paren
id|DOORBELL_TO_CARD_CLOSE_0
op_plus
id|port-&gt;node
)paren
comma
id|port-&gt;card-&gt;plx
op_plus
id|PLX_DOORBELL_TO_CARD
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_do
r_if
c_cond
(paren
op_logical_neg
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|open
)paren
r_break
suffix:semicolon
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|timeout
comma
id|jiffies
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|open
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to close port&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|desc_t
op_star
id|desc
op_assign
op_amp
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|tx_descs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;stat
op_ne
id|PACKET_EMPTY
)paren
(brace
id|desc-&gt;stat
op_assign
id|PACKET_EMPTY
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|port-&gt;card-&gt;pdev
comma
id|desc-&gt;address
comma
id|port-&gt;tx_skbs
(braket
id|i
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|port-&gt;tx_skbs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wanxl_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|wanxl_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|port_t
op_star
id|port
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
id|stats-&gt;rx_over_errors
op_assign
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|rx_overruns
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_assign
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|rx_frame_errors
suffix:semicolon
id|stats-&gt;rx_errors
op_assign
id|stats-&gt;rx_over_errors
op_plus
id|stats-&gt;rx_frame_errors
suffix:semicolon
r_return
id|stats
suffix:semicolon
)brace
DECL|function|wanxl_puts_command
r_static
r_int
id|wanxl_puts_command
c_func
(paren
id|card_t
op_star
id|card
comma
id|u32
id|cmd
)paren
(brace
r_int
r_int
id|timeout
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|writel
c_func
(paren
id|cmd
comma
id|card-&gt;plx
op_plus
id|PLX_MAILBOX_1
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|card-&gt;plx
op_plus
id|PLX_MAILBOX_1
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|timeout
comma
id|jiffies
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|wanxl_reset
r_static
r_void
id|wanxl_reset
c_func
(paren
id|card_t
op_star
id|card
)paren
(brace
id|u32
id|old_value
op_assign
id|readl
c_func
(paren
id|card-&gt;plx
op_plus
id|PLX_CONTROL
)paren
op_amp
op_complement
id|PLX_CTL_RESET
suffix:semicolon
id|writel
c_func
(paren
l_int|0x80
comma
id|card-&gt;plx
op_plus
id|PLX_MAILBOX_0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|old_value
op_or
id|PLX_CTL_RESET
comma
id|card-&gt;plx
op_plus
id|PLX_CONTROL
)paren
suffix:semicolon
id|readl
c_func
(paren
id|card-&gt;plx
op_plus
id|PLX_CONTROL
)paren
suffix:semicolon
multiline_comment|/* wait for posted write */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|old_value
comma
id|card-&gt;plx
op_plus
id|PLX_CONTROL
)paren
suffix:semicolon
id|readl
c_func
(paren
id|card-&gt;plx
op_plus
id|PLX_CONTROL
)paren
suffix:semicolon
multiline_comment|/* wait for posted write */
)brace
DECL|function|wanxl_pci_remove_one
r_static
r_void
id|wanxl_pci_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|card_t
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|unregister_hdlc_device
c_func
(paren
id|card-&gt;ports
(braket
id|i
)braket
dot
id|dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|card-&gt;ports
(braket
id|i
)braket
dot
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* unregister and free all host resources */
r_if
c_cond
(paren
id|card-&gt;irq
)paren
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|wanxl_reset
c_func
(paren
id|card
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_QUEUE_LENGTH
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|card-&gt;rx_skbs
(braket
id|i
)braket
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|card-&gt;pdev
comma
id|card-&gt;status-&gt;rx_descs
(braket
id|i
)braket
dot
id|address
comma
id|BUFFER_LENGTH
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|card-&gt;rx_skbs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;plx
)paren
id|iounmap
c_func
(paren
id|card-&gt;plx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;status
)paren
id|pci_free_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
id|card_status_t
)paren
comma
id|card-&gt;status
comma
id|card-&gt;status_address
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
macro_line|#include &quot;wanxlfw.inc&quot;
DECL|function|wanxl_pci_init_one
r_static
r_int
id|__devinit
id|wanxl_pci_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
id|u32
id|ramsize
comma
id|stat
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u32
id|plx_phy
suffix:semicolon
multiline_comment|/* PLX PCI base address */
id|u32
id|mem_phy
suffix:semicolon
multiline_comment|/* memory PCI base addr */
id|u8
id|__iomem
op_star
id|mem
suffix:semicolon
multiline_comment|/* memory virtual base addr */
r_int
id|i
comma
id|ports
comma
id|alloc_size
suffix:semicolon
macro_line|#ifndef MODULE
r_static
r_int
id|printed_version
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
)paren
(brace
id|printed_version
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
)brace
macro_line|#endif
id|i
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
multiline_comment|/* QUICC can only access first 256 MB of host RAM directly,&n;&t;   but PLX9060 DMA does 32-bits for actual packet data transfers */
multiline_comment|/* FIXME when PCI/DMA subsystems are fixed.&n;&t;   We set both dma_mask and consistent_dma_mask to 28 bits&n;&t;   and pray pci_alloc_consistent() will use this info. It should&n;&t;   work on most platforms */
r_if
c_cond
(paren
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
l_int|0x0FFFFFFF
)paren
op_logical_or
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0x0FFFFFFF
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;wanXL: No usable DMA configuration&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|i
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;wanXL&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pdev-&gt;device
)paren
(brace
r_case
id|PCI_DEVICE_ID_SBE_WANXL100
suffix:colon
id|ports
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_SBE_WANXL200
suffix:colon
id|ports
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ports
op_assign
l_int|4
suffix:semicolon
)brace
id|alloc_size
op_assign
r_sizeof
(paren
id|card_t
)paren
op_plus
id|ports
op_star
r_sizeof
(paren
id|port_t
)paren
suffix:semicolon
id|card
op_assign
id|kmalloc
c_func
(paren
id|alloc_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;wanXL %s: unable to allocate memory&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
id|alloc_size
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|card
)paren
suffix:semicolon
id|card-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|card-&gt;status
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
id|card_status_t
)paren
comma
op_amp
id|card-&gt;status_address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;status
op_eq
l_int|NULL
)paren
(brace
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_PCI
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;wanXL %s: pci_alloc_consistent() returned memory&quot;
l_string|&quot; at 0x%LX&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
comma
(paren
r_int
r_int
r_int
)paren
id|card-&gt;status_address
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* FIXME when PCI/DMA subsystems are fixed.&n;&t;   We set both dma_mask and consistent_dma_mask back to 32 bits&n;&t;   to indicate the card can do 32-bit DMA addressing */
r_if
c_cond
(paren
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xFFFFFFFF
)paren
op_logical_or
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xFFFFFFFF
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;wanXL: No usable DMA configuration&bslash;n&quot;
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* set up PLX mapping */
id|plx_phy
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|card-&gt;plx
op_assign
id|ioremap_nocache
c_func
(paren
id|plx_phy
comma
l_int|0x70
)paren
suffix:semicolon
macro_line|#if RESET_WHILE_LOADING
id|wanxl_reset
c_func
(paren
id|card
)paren
suffix:semicolon
macro_line|#endif
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
(paren
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;plx
op_plus
id|PLX_MAILBOX_0
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|timeout
comma
id|jiffies
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;wanXL %s: timeout waiting for&quot;
l_string|&quot; PUTS to complete&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|stat
op_amp
l_int|0xC0
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* hmm - PUTS completed with non-zero code? */
r_case
l_int|0x80
suffix:colon
multiline_comment|/* PUTS still testing the hardware */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;wanXL %s: PUTS test 0x%X&quot;
l_string|&quot; failed&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
comma
id|stat
op_amp
l_int|0x30
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* get on-board memory size (PUTS detects no more than 4 MB) */
id|ramsize
op_assign
id|readl
c_func
(paren
id|card-&gt;plx
op_plus
id|PLX_MAILBOX_2
)paren
op_amp
id|MBX2_MEMSZ_MASK
suffix:semicolon
multiline_comment|/* set up on-board RAM mapping */
id|mem_phy
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* sanity check the board&squot;s reported memory size */
r_if
c_cond
(paren
id|ramsize
OL
id|BUFFERS_ADDR
op_plus
(paren
id|TX_BUFFERS
op_plus
id|RX_BUFFERS
)paren
op_star
id|BUFFER_LENGTH
op_star
id|ports
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;wanXL %s: no enough on-board RAM&quot;
l_string|&quot; (%u bytes detected, %u bytes required)&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
comma
id|ramsize
comma
id|BUFFERS_ADDR
op_plus
(paren
id|TX_BUFFERS
op_plus
id|RX_BUFFERS
)paren
op_star
id|BUFFER_LENGTH
op_star
id|ports
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wanxl_puts_command
c_func
(paren
id|card
comma
id|MBX1_CMD_BSWAP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;wanXL %s: unable to Set Byte Swap&quot;
l_string|&quot; Mode&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_QUEUE_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|BUFFER_LENGTH
)paren
suffix:semicolon
id|card-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|card-&gt;status-&gt;rx_descs
(braket
id|i
)braket
dot
id|address
op_assign
id|pci_map_single
c_func
(paren
id|card-&gt;pdev
comma
id|skb-&gt;data
comma
id|BUFFER_LENGTH
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
)brace
id|mem
op_assign
id|ioremap_nocache
c_func
(paren
id|mem_phy
comma
id|PDM_OFFSET
op_plus
r_sizeof
(paren
id|firmware
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|firmware
)paren
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
id|writel
c_func
(paren
id|htonl
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|firmware
op_plus
id|i
)paren
)paren
comma
id|mem
op_plus
id|PDM_OFFSET
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ports
suffix:semicolon
id|i
op_increment
)paren
id|writel
c_func
(paren
id|card-&gt;status_address
op_plus
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;status-&gt;port_status
(braket
id|i
)braket
op_minus
(paren
r_void
op_star
)paren
id|card-&gt;status
comma
id|mem
op_plus
id|PDM_OFFSET
op_plus
l_int|4
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
id|writel
c_func
(paren
id|card-&gt;status_address
comma
id|mem
op_plus
id|PDM_OFFSET
op_plus
l_int|20
)paren
suffix:semicolon
id|writel
c_func
(paren
id|PDM_OFFSET
comma
id|mem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|mem
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;plx
op_plus
id|PLX_MAILBOX_5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wanxl_puts_command
c_func
(paren
id|card
comma
id|MBX1_CMD_ABORTJ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;wanXL %s: unable to Abort and Jump&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|stat
op_assign
l_int|0
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
(paren
id|stat
op_assign
id|readl
c_func
(paren
id|card-&gt;plx
op_plus
id|PLX_MAILBOX_5
)paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time_after
c_func
(paren
id|timeout
comma
id|jiffies
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stat
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;wanXL %s: timeout while initializing card&quot;
l_string|&quot;firmware&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#if DETECT_RAM
id|ramsize
op_assign
id|stat
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;wanXL %s: at 0x%X, %u KB of RAM at 0x%X, irq %u&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
comma
id|plx_phy
comma
id|ramsize
op_div
l_int|1024
comma
id|mem_phy
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Allocate IRQ */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|wanxl_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;wanXL&quot;
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;wanXL %s: could not allocate IRQ%i.&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|card-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hdlc_device
op_star
id|hdlc
suffix:semicolon
id|port_t
op_star
id|port
op_assign
op_amp
id|card-&gt;ports
(braket
id|i
)braket
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|alloc_hdlcdev
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;wanXL %s: unable to allocate&quot;
l_string|&quot; memory&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|port-&gt;dev
op_assign
id|dev
suffix:semicolon
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|50
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|wanxl_ioctl
suffix:semicolon
id|dev-&gt;open
op_assign
id|wanxl_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|wanxl_close
suffix:semicolon
id|hdlc-&gt;attach
op_assign
id|wanxl_attach
suffix:semicolon
id|hdlc-&gt;xmit
op_assign
id|wanxl_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|wanxl_get_stats
suffix:semicolon
id|port-&gt;card
op_assign
id|card
suffix:semicolon
id|port-&gt;node
op_assign
id|i
suffix:semicolon
id|get_status
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|clocking
op_assign
id|CLOCK_EXT
suffix:semicolon
r_if
c_cond
(paren
id|register_hdlc_device
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;wanXL %s: unable to register hdlc&quot;
l_string|&quot; device&bslash;n&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|wanxl_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|card-&gt;n_ports
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;wanXL %s: port&quot;
comma
id|card_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ports
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s #%i: %s&quot;
comma
id|i
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|i
comma
id|card-&gt;ports
(braket
id|i
)braket
dot
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ports
suffix:semicolon
id|i
op_increment
)paren
id|wanxl_cable_intr
c_func
(paren
op_amp
id|card-&gt;ports
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* get carrier status etc.*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|wanxl_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_SBE
comma
id|PCI_DEVICE_ID_SBE_WANXL100
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_SBE
comma
id|PCI_DEVICE_ID_SBE_WANXL200
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_SBE
comma
id|PCI_DEVICE_ID_SBE_WANXL400
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|variable|wanxl_pci_driver
r_static
r_struct
id|pci_driver
id|wanxl_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;wanXL&quot;
comma
dot
id|id_table
op_assign
id|wanxl_pci_tbl
comma
dot
id|probe
op_assign
id|wanxl_pci_init_one
comma
dot
id|remove
op_assign
id|wanxl_pci_remove_one
comma
)brace
suffix:semicolon
DECL|function|wanxl_init_module
r_static
r_int
id|__init
id|wanxl_init_module
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
c_func
(paren
op_amp
id|wanxl_pci_driver
)paren
suffix:semicolon
)brace
DECL|function|wanxl_cleanup_module
r_static
r_void
id|__exit
id|wanxl_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|wanxl_pci_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Krzysztof Halasa &lt;khc@pm.waw.pl&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SBE Inc. wanXL serial port driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL v2&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|wanxl_pci_tbl
)paren
suffix:semicolon
DECL|variable|wanxl_init_module
id|module_init
c_func
(paren
id|wanxl_init_module
)paren
suffix:semicolon
DECL|variable|wanxl_cleanup_module
id|module_exit
c_func
(paren
id|wanxl_cleanup_module
)paren
suffix:semicolon
eof
