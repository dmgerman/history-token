multiline_comment|/*&n; * pc300_tty.c&t;Cyclades-PC300(tm) TTY Driver.&n; *&n; * Author:&t;Regina Kodato &lt;reginak@cyclades.com&gt;&n; *&n; * Copyright:&t;(c) 1999-2002 Cyclades Corp.&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *   &n; *  $Log: pc300_tty.c,v $&n; *  Revision 3.7  2002/03/07 14:17:09  henrique&n; *  License data fixed&n; *&n; *  Revision 3.6  2001/12/10 12:29:42  regina&n; *  Fix the MLPPP bug&n; *&n; *  Revision 3.5  2001/10/31 11:20:05  regina&n; *  automatic pppd starts&n; *&n; *  Revision 3.4  2001/08/06 12:01:51  regina&n; *  problem in DSR_DE bit&n; *&n; *  Revision 3.3  2001/07/26 22:58:41  regina&n; *  update EDA value&n; *&n; *  Revision 3.2  2001/07/12 13:11:20  regina&n; *  bug fix - DCD-OFF in pc300 tty driver&n; *&n; *&t;DMA transmission bug fix&n; *  &n; *  Revision 3.1  2001/06/22 13:13:02  regina&n; *  MLPPP implementation&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
multiline_comment|/* TTY includes */
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;pc300.h&quot;
multiline_comment|/* defines and macros */
multiline_comment|/* TTY Global definitions */
DECL|macro|CPC_TTY_NPORTS
mdefine_line|#define&t;CPC_TTY_NPORTS&t;8&t;/* maximum number of the sync tty connections */
DECL|macro|CPC_TTY_MAJOR
mdefine_line|#define&t;CPC_TTY_MAJOR&t;CYCLADES_MAJOR&t;
DECL|macro|CPC_TTY_MINOR_START
mdefine_line|#define CPC_TTY_MINOR_START&t;240&t;/* minor of the first PC300 interface */
DECL|macro|CPC_TTY_MAX_MTU
mdefine_line|#define CPC_TTY_MAX_MTU&t;2000&t;
multiline_comment|/* tty interface state */
DECL|macro|CPC_TTY_ST_IDLE
mdefine_line|#define&t;CPC_TTY_ST_IDLE&t;0
DECL|macro|CPC_TTY_ST_INIT
mdefine_line|#define CPC_TTY_ST_INIT&t;1&t;/* configured with MLPPP and up */
DECL|macro|CPC_TTY_ST_OPEN
mdefine_line|#define CPC_TTY_ST_OPEN&t;2&t;/* opened by application */
DECL|macro|CPC_TTY_LOCK
mdefine_line|#define&t;CPC_TTY_LOCK(card,flags)&bslash;&n;&t;do {&bslash;&n;&t;&t;spin_lock_irqsave(&amp;card-&gt;card_lock, flags);&t;&bslash;&n;&t;} while (0)
DECL|macro|CPC_TTY_UNLOCK
mdefine_line|#define CPC_TTY_UNLOCK(card,flags)&t;&bslash;&n;&t;do {&bslash;&n;&t;&t;spin_unlock_irqrestore(&amp;card-&gt;card_lock, flags);&t;&bslash;&n;&t;} while (0)
singleline_comment|//#define&t;CPC_TTY_DBG(format,a...)&t;printk(format,##a)
DECL|macro|CPC_TTY_DBG
mdefine_line|#define&t;CPC_TTY_DBG(format,a...)
multiline_comment|/* data structures */
DECL|struct|_st_cpc_rx_buf
r_typedef
r_struct
id|_st_cpc_rx_buf
(brace
DECL|member|next
r_struct
id|_st_cpc_rx_buf
op_star
id|next
suffix:semicolon
DECL|member|size
r_int
id|size
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
(braket
l_int|1
)braket
suffix:semicolon
DECL|typedef|st_cpc_rx_buf
)brace
id|st_cpc_rx_buf
suffix:semicolon
DECL|struct|st_cpc_rx_list
r_struct
id|st_cpc_rx_list
(brace
DECL|member|first
id|st_cpc_rx_buf
op_star
id|first
suffix:semicolon
DECL|member|last
id|st_cpc_rx_buf
op_star
id|last
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|_st_cpc_tty_area
r_typedef
r_struct
id|_st_cpc_tty_area
(brace
DECL|member|state
r_int
id|state
suffix:semicolon
multiline_comment|/* state of the TTY interface */
DECL|member|num_open
r_int
id|num_open
suffix:semicolon
DECL|member|tty_minor
r_int
r_int
id|tty_minor
suffix:semicolon
multiline_comment|/* minor this interface */
DECL|member|buf_rx
r_volatile
r_struct
id|st_cpc_rx_list
id|buf_rx
suffix:semicolon
multiline_comment|/* ptr. to reception buffer */
DECL|member|buf_tx
r_int
r_char
op_star
id|buf_tx
suffix:semicolon
multiline_comment|/* ptr. to transmission buffer */
DECL|member|pc300dev
id|pc300dev_t
op_star
id|pc300dev
suffix:semicolon
multiline_comment|/* ptr. to info struct in PC300 driver */
DECL|member|name
r_int
r_char
id|name
(braket
l_int|20
)braket
suffix:semicolon
multiline_comment|/* interf. name + &quot;-tty&quot; */
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|tty_tx_work
r_struct
id|work_struct
id|tty_tx_work
suffix:semicolon
multiline_comment|/* tx work - tx interrupt */
DECL|member|tty_rx_work
r_struct
id|work_struct
id|tty_rx_work
suffix:semicolon
multiline_comment|/* rx work - rx interrupt */
DECL|typedef|st_cpc_tty_area
)brace
id|st_cpc_tty_area
suffix:semicolon
multiline_comment|/* TTY data structures */
DECL|variable|serial_drv
r_static
r_struct
id|tty_driver
id|serial_drv
suffix:semicolon
multiline_comment|/* local variables */
DECL|variable|cpc_tty_area
id|st_cpc_tty_area
id|cpc_tty_area
(braket
id|CPC_TTY_NPORTS
)braket
suffix:semicolon
DECL|variable|cpc_tty_cnt
r_int
id|cpc_tty_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of intrfaces configured with MLPPP */
DECL|variable|cpc_tty_unreg_flag
r_int
id|cpc_tty_unreg_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* TTY functions prototype */
r_static
r_int
id|cpc_tty_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|flip
)paren
suffix:semicolon
r_static
r_void
id|cpc_tty_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|flip
)paren
suffix:semicolon
r_static
r_int
id|cpc_tty_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|cpc_tty_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|cpc_tty_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|cpc_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|cpc_tty_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|cpc_tty_rx_work
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|cpc_tty_tx_work
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|cpc_tty_send_to_card
c_func
(paren
id|pc300dev_t
op_star
id|dev
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|cpc_tty_trace
c_func
(paren
id|pc300dev_t
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_char
id|rxtx
)paren
suffix:semicolon
r_static
r_void
id|cpc_tty_signal_off
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
comma
r_int
r_char
)paren
suffix:semicolon
r_static
r_void
id|cpc_tty_signal_on
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
comma
r_int
r_char
)paren
suffix:semicolon
r_int
id|pc300_tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_int
id|pc300_tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
multiline_comment|/* functions called by PC300 driver */
r_void
id|cpc_tty_init
c_func
(paren
id|pc300dev_t
op_star
id|dev
)paren
suffix:semicolon
r_void
id|cpc_tty_unregister_service
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
)paren
suffix:semicolon
r_void
id|cpc_tty_receive
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
)paren
suffix:semicolon
r_void
id|cpc_tty_trigger_poll
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
)paren
suffix:semicolon
r_void
id|cpc_tty_reset_var
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * PC300 TTY clear &quot;signal&quot;&n; */
DECL|function|cpc_tty_signal_off
r_static
r_void
id|cpc_tty_signal_off
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
comma
r_int
r_char
id|signal
)paren
(brace
id|pc300ch_t
op_star
id|pc300chan
op_assign
(paren
id|pc300ch_t
op_star
)paren
id|pc300dev-&gt;chan
suffix:semicolon
id|pc300_t
op_star
id|card
op_assign
(paren
id|pc300_t
op_star
)paren
id|pc300chan-&gt;card
suffix:semicolon
r_int
id|ch
op_assign
id|pc300chan-&gt;channel
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s-tty: Clear signal %x&bslash;n&quot;
comma
id|pc300dev-&gt;dev-&gt;name
comma
id|signal
)paren
suffix:semicolon
id|CPC_TTY_LOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|M_REG
c_func
(paren
id|CTL
comma
id|ch
)paren
comma
id|cpc_readb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|M_REG
c_func
(paren
id|CTL
comma
id|ch
)paren
)paren
op_amp
id|signal
)paren
suffix:semicolon
id|CPC_TTY_UNLOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY set &quot;signal&quot; to ON&n; */
DECL|function|cpc_tty_signal_on
r_static
r_void
id|cpc_tty_signal_on
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
comma
r_int
r_char
id|signal
)paren
(brace
id|pc300ch_t
op_star
id|pc300chan
op_assign
(paren
id|pc300ch_t
op_star
)paren
id|pc300dev-&gt;chan
suffix:semicolon
id|pc300_t
op_star
id|card
op_assign
(paren
id|pc300_t
op_star
)paren
id|pc300chan-&gt;card
suffix:semicolon
r_int
id|ch
op_assign
id|pc300chan-&gt;channel
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s-tty: Set signal %x&bslash;n&quot;
comma
id|pc300dev-&gt;dev-&gt;name
comma
id|signal
)paren
suffix:semicolon
id|CPC_TTY_LOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|M_REG
c_func
(paren
id|CTL
comma
id|ch
)paren
comma
id|cpc_readb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|M_REG
c_func
(paren
id|CTL
comma
id|ch
)paren
)paren
op_amp
op_complement
id|signal
)paren
suffix:semicolon
id|CPC_TTY_UNLOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY initialization routine&n; *&n; * This routine is called by the PC300 driver during board configuration &n; * (ioctl=SIOCSP300CONF). At this point the adapter is completely&n; * initialized.&n; * o verify kernel version (only 2.4.x)&n; * o register TTY driver&n; * o init cpc_tty_area struct&n; */
DECL|function|cpc_tty_init
r_void
id|cpc_tty_init
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
)paren
(brace
r_int
id|port
comma
id|aux
suffix:semicolon
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
multiline_comment|/* hdlcX - X=interface number */
id|port
op_assign
id|pc300dev-&gt;dev-&gt;name
(braket
l_int|4
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|port
op_ge
id|CPC_TTY_NPORTS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s-tty: invalid interface selected (0-%i): %i&quot;
comma
id|pc300dev-&gt;dev-&gt;name
comma
id|CPC_TTY_NPORTS
op_minus
l_int|1
comma
id|port
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpc_tty_cnt
op_eq
l_int|0
)paren
(brace
multiline_comment|/* first TTY connection -&gt; register driver */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s-tty: driver init, major:%i, minor range:%i=%i&bslash;n&quot;
comma
id|pc300dev-&gt;dev-&gt;name
comma
id|CPC_TTY_MAJOR
comma
id|CPC_TTY_MINOR_START
comma
id|CPC_TTY_MINOR_START
op_plus
id|CPC_TTY_NPORTS
)paren
suffix:semicolon
multiline_comment|/* initialize tty driver struct */
id|memset
c_func
(paren
op_amp
id|serial_drv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|serial_drv.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|serial_drv.owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|serial_drv.driver_name
op_assign
l_string|&quot;pc300_tty&quot;
suffix:semicolon
id|serial_drv.name
op_assign
l_string|&quot;ttyCP&quot;
suffix:semicolon
id|serial_drv.major
op_assign
id|CPC_TTY_MAJOR
suffix:semicolon
id|serial_drv.minor_start
op_assign
id|CPC_TTY_MINOR_START
suffix:semicolon
id|serial_drv.num
op_assign
id|CPC_TTY_NPORTS
suffix:semicolon
id|serial_drv.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|serial_drv.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|serial_drv.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|serial_drv.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|serial_drv.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
multiline_comment|/* interface routines from the upper tty layer to the tty driver */
id|serial_drv.open
op_assign
id|cpc_tty_open
suffix:semicolon
id|serial_drv.close
op_assign
id|cpc_tty_close
suffix:semicolon
id|serial_drv.write
op_assign
id|cpc_tty_write
suffix:semicolon
id|serial_drv.write_room
op_assign
id|cpc_tty_write_room
suffix:semicolon
id|serial_drv.chars_in_buffer
op_assign
id|cpc_tty_chars_in_buffer
suffix:semicolon
id|serial_drv.tiocmset
op_assign
id|pc300_tiocmset
suffix:semicolon
id|serial_drv.tiocmget
op_assign
id|pc300_tiocmget
suffix:semicolon
id|serial_drv.flush_buffer
op_assign
id|cpc_tty_flush_buffer
suffix:semicolon
id|serial_drv.hangup
op_assign
id|cpc_tty_hangup
suffix:semicolon
multiline_comment|/* register the TTY driver */
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|serial_drv
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s-tty: Failed to register serial driver! &quot;
comma
id|pc300dev-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|cpc_tty_area
comma
l_int|0
comma
r_sizeof
(paren
id|st_cpc_tty_area
)paren
op_star
id|CPC_TTY_NPORTS
)paren
suffix:semicolon
)brace
id|cpc_tty
op_assign
op_amp
id|cpc_tty_area
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cpc_tty-&gt;state
op_ne
id|CPC_TTY_ST_IDLE
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s-tty: TTY port %i, already in use.&bslash;n&quot;
comma
id|pc300dev-&gt;dev-&gt;name
comma
id|port
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cpc_tty_cnt
op_increment
suffix:semicolon
id|cpc_tty-&gt;state
op_assign
id|CPC_TTY_ST_INIT
suffix:semicolon
id|cpc_tty-&gt;num_open
op_assign
l_int|0
suffix:semicolon
id|cpc_tty-&gt;tty_minor
op_assign
id|port
op_plus
id|CPC_TTY_MINOR_START
suffix:semicolon
id|cpc_tty-&gt;pc300dev
op_assign
id|pc300dev
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|cpc_tty-&gt;tty_tx_work
comma
id|cpc_tty_tx_work
comma
(paren
r_void
op_star
)paren
id|cpc_tty
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|cpc_tty-&gt;tty_rx_work
comma
id|cpc_tty_rx_work
comma
(paren
r_void
op_star
)paren
id|port
)paren
suffix:semicolon
id|cpc_tty-&gt;buf_rx.first
op_assign
id|cpc_tty-&gt;buf_rx.last
op_assign
l_int|0
suffix:semicolon
id|pc300dev-&gt;cpc_tty
op_assign
(paren
r_void
op_star
)paren
id|cpc_tty
suffix:semicolon
id|aux
op_assign
id|strlen
c_func
(paren
id|pc300dev-&gt;dev-&gt;name
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|cpc_tty-&gt;name
comma
id|pc300dev-&gt;dev-&gt;name
comma
id|aux
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|cpc_tty-&gt;name
(braket
id|aux
)braket
comma
l_string|&quot;-tty&quot;
comma
l_int|5
)paren
suffix:semicolon
id|cpc_open
c_func
(paren
id|pc300dev-&gt;dev
)paren
suffix:semicolon
id|cpc_tty_signal_off
c_func
(paren
id|pc300dev
comma
id|CTL_DTR
)paren
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: Initializing TTY Sync Driver, tty major#%d minor#%i&bslash;n&quot;
comma
id|cpc_tty-&gt;name
comma
id|CPC_TTY_MAJOR
comma
id|cpc_tty-&gt;tty_minor
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY OPEN routine&n; *&n; * This routine is called by the tty driver to open the interface &n; * o verify minor&n; * o allocate buffer to Rx and Tx&n; */
DECL|function|cpc_tty_open
r_static
r_int
id|cpc_tty_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|flip
)paren
(brace
r_int
id|port
suffix:semicolon
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|port
op_assign
id|tty-&gt;index
suffix:semicolon
r_if
c_cond
(paren
(paren
id|port
OL
l_int|0
)paren
op_logical_or
(paren
id|port
op_ge
id|CPC_TTY_NPORTS
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;pc300_tty: open invalid port %d&bslash;n&quot;
comma
id|port
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cpc_tty
op_assign
op_amp
id|cpc_tty_area
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cpc_tty-&gt;state
op_eq
id|CPC_TTY_ST_IDLE
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: open - invalid interface, port=%d&bslash;n&quot;
comma
id|cpc_tty-&gt;name
comma
id|tty-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpc_tty-&gt;num_open
op_eq
l_int|0
)paren
(brace
multiline_comment|/* first open of this tty */
r_if
c_cond
(paren
op_logical_neg
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_tx
)paren
(brace
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_tx
op_assign
id|kmalloc
c_func
(paren
id|CPC_TTY_MAX_MTU
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_tx
op_eq
l_int|0
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: error in memory allocation&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_rx.first
)paren
(brace
r_int
r_char
op_star
id|aux
suffix:semicolon
r_while
c_loop
(paren
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_rx.first
)paren
(brace
id|aux
op_assign
(paren
r_int
r_char
op_star
)paren
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_rx.first
suffix:semicolon
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_rx.first
op_assign
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_rx.first-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|aux
)paren
suffix:semicolon
)brace
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_rx.first
op_assign
l_int|NULL
suffix:semicolon
id|cpc_tty_area
(braket
id|port
)braket
dot
id|buf_rx.last
op_assign
l_int|NULL
suffix:semicolon
)brace
id|cpc_tty_area
(braket
id|port
)braket
dot
id|state
op_assign
id|CPC_TTY_ST_OPEN
suffix:semicolon
id|cpc_tty_area
(braket
id|port
)braket
dot
id|tty
op_assign
id|tty
suffix:semicolon
id|tty-&gt;driver_data
op_assign
op_amp
id|cpc_tty_area
(braket
id|port
)braket
suffix:semicolon
id|cpc_tty_signal_on
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
id|CTL_DTR
)paren
suffix:semicolon
)brace
id|cpc_tty-&gt;num_open
op_increment
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: opening TTY driver&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
multiline_comment|/* avisar driver PC300 */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY CLOSE routine&n; *&n; * This routine is called by the tty driver to close the interface &n; * o call close channel in PC300 driver (cpc_closech)&n; * o free Rx and Tx buffers&n; */
DECL|function|cpc_tty_close
r_static
r_void
id|cpc_tty_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|flip
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;hdlx-tty: no TTY in close &bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpc_tty-&gt;tty
op_ne
id|tty
)paren
op_logical_or
(paren
id|cpc_tty-&gt;state
op_ne
id|CPC_TTY_ST_OPEN
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY is not opened&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpc_tty-&gt;num_open
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY is closed&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|cpc_tty-&gt;num_open
OG
l_int|0
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY closed&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cpc_tty_signal_off
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
id|CTL_DTR
)paren
suffix:semicolon
id|CPC_TTY_LOCK
c_func
(paren
id|cpc_tty-&gt;pc300dev-&gt;chan-&gt;card
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* lock irq */
id|cpc_tty-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|cpc_tty-&gt;state
op_assign
id|CPC_TTY_ST_INIT
suffix:semicolon
id|CPC_TTY_UNLOCK
c_func
(paren
id|cpc_tty-&gt;pc300dev-&gt;chan-&gt;card
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* unlock irq */
r_if
c_cond
(paren
id|cpc_tty-&gt;buf_rx.first
)paren
(brace
r_int
r_char
op_star
id|aux
suffix:semicolon
r_while
c_loop
(paren
id|cpc_tty-&gt;buf_rx.first
)paren
(brace
id|aux
op_assign
(paren
r_int
r_char
op_star
)paren
id|cpc_tty-&gt;buf_rx.first
suffix:semicolon
id|cpc_tty-&gt;buf_rx.first
op_assign
id|cpc_tty-&gt;buf_rx.first-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|aux
)paren
suffix:semicolon
)brace
id|cpc_tty-&gt;buf_rx.first
op_assign
l_int|NULL
suffix:semicolon
id|cpc_tty-&gt;buf_rx.last
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpc_tty-&gt;buf_tx
)paren
(brace
id|kfree
c_func
(paren
id|cpc_tty-&gt;buf_tx
)paren
suffix:semicolon
id|cpc_tty-&gt;buf_tx
op_assign
l_int|NULL
suffix:semicolon
)brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY closed&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial_drv.refcount
op_logical_and
id|cpc_tty_unreg_flag
)paren
(brace
id|cpc_tty_unreg_flag
op_assign
l_int|0
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: unregister the tty driver&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|serial_drv
)paren
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: ERROR -&gt;unregister the tty driver error=%d&bslash;n&quot;
comma
id|cpc_tty-&gt;name
comma
id|res
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY WRITE routine&n; *&n; * This routine is called by the tty driver to write a series of characters&n; * to the tty device. The characters may come from user or kernel space.&n; * o verify the DCD signal&n; * o send characters to board and start the transmission&n; */
DECL|function|cpc_tty_write
r_static
r_int
id|cpc_tty_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
id|pc300ch_t
op_star
id|pc300chan
suffix:semicolon
id|pc300_t
op_star
id|card
suffix:semicolon
r_int
id|ch
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;hdlcX-tty: no TTY in write&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpc_tty-&gt;tty
op_ne
id|tty
)paren
op_logical_or
(paren
id|cpc_tty-&gt;state
op_ne
id|CPC_TTY_ST_OPEN
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY is not opened&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
id|CPC_TTY_MAX_MTU
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: count is invalid&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* frame too big */
)brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: cpc_tty_write %s data len=%i&bslash;n&quot;
comma
id|cpc_tty-&gt;name
comma
(paren
id|from_user
)paren
ques
c_cond
l_string|&quot;from user&quot;
suffix:colon
l_string|&quot;from kernel&quot;
comma
id|count
)paren
suffix:semicolon
id|pc300chan
op_assign
(paren
id|pc300ch_t
op_star
)paren
(paren
(paren
id|pc300dev_t
op_star
)paren
id|cpc_tty-&gt;pc300dev
)paren
op_member_access_from_pointer
id|chan
suffix:semicolon
id|stats
op_assign
id|hdlc_stats
c_func
(paren
(paren
(paren
id|pc300dev_t
op_star
)paren
id|cpc_tty-&gt;pc300dev
)paren
op_member_access_from_pointer
id|dev
)paren
suffix:semicolon
id|card
op_assign
(paren
id|pc300_t
op_star
)paren
id|pc300chan-&gt;card
suffix:semicolon
id|ch
op_assign
id|pc300chan-&gt;channel
suffix:semicolon
multiline_comment|/* verify DCD signal*/
r_if
c_cond
(paren
id|cpc_readb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|M_REG
c_func
(paren
id|ST3
comma
id|ch
)paren
)paren
op_amp
id|ST3_DCD
)paren
(brace
multiline_comment|/* DCD is OFF */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s : DCD is OFF&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_carrier_errors
op_increment
suffix:semicolon
id|CPC_TTY_LOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|M_REG
c_func
(paren
id|CMD
comma
id|ch
)paren
comma
id|CMD_TX_BUF_CLR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|PC300_TE
)paren
(brace
id|cpc_writeb
c_func
(paren
id|card-&gt;hw.falcbase
op_plus
id|card-&gt;hw.cpld_reg2
comma
id|cpc_readb
c_func
(paren
id|card-&gt;hw.falcbase
op_plus
id|card-&gt;hw.cpld_reg2
)paren
op_amp
op_complement
(paren
id|CPLD_REG2_FALC_LED1
op_lshift
(paren
l_int|2
op_star
id|ch
)paren
)paren
)paren
suffix:semicolon
)brace
id|CPC_TTY_UNLOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_int
r_char
op_star
id|buf_tmp
suffix:semicolon
id|buf_tmp
op_assign
id|cpc_tty-&gt;buf_tx
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf_tmp
comma
id|buf
comma
id|count
)paren
)paren
(brace
multiline_comment|/* failed to copy from user */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: error in copy from user&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpc_tty_send_to_card
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
(paren
r_void
op_star
)paren
id|buf_tmp
comma
id|count
)paren
)paren
(brace
multiline_comment|/* failed to send */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: transmission error&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|cpc_tty_send_to_card
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
(paren
r_void
op_star
)paren
id|buf
comma
id|count
)paren
)paren
(brace
multiline_comment|/* failed to send */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: trasmition error&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY Write Room routine&n; * &n; * This routine returns the numbers of characteres the tty driver will accept&n; * for queuing to be written. &n; * o return MTU&n; */
DECL|function|cpc_tty_write_room
r_static
r_int
id|cpc_tty_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;hdlcX-tty: no TTY to write room&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpc_tty-&gt;tty
op_ne
id|tty
)paren
op_logical_or
(paren
id|cpc_tty-&gt;state
op_ne
id|CPC_TTY_ST_OPEN
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY is not opened&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: write room&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
id|CPC_TTY_MAX_MTU
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY chars in buffer routine&n; * &n; * This routine returns the chars number in the transmission buffer &n; * o returns 0&n; */
DECL|function|cpc_tty_chars_in_buffer
r_static
r_int
id|cpc_tty_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;hdlcX-tty: no TTY to chars in buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpc_tty-&gt;tty
op_ne
id|tty
)paren
op_logical_or
(paren
id|cpc_tty-&gt;state
op_ne
id|CPC_TTY_ST_OPEN
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY is not opened&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pc300_tiocmset
r_int
id|pc300_tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: set:%x clear:%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|set
comma
id|clear
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;hdlcX-tty: no TTY to chars in buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
)paren
id|cpc_tty_signal_on
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
id|CTL_RTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DTR
)paren
id|cpc_tty_signal_on
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
id|CTL_DTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
)paren
id|cpc_tty_signal_off
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
id|CTL_RTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DTR
)paren
id|cpc_tty_signal_off
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
id|CTL_DTR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pc300_tiocmget
r_int
id|pc300_tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|result
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|st_cpc_tty_area
op_star
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|pc300dev_t
op_star
id|pc300dev
op_assign
id|cpc_tty-&gt;pc300dev
suffix:semicolon
id|pc300ch_t
op_star
id|pc300chan
op_assign
(paren
id|pc300ch_t
op_star
)paren
id|pc300dev-&gt;chan
suffix:semicolon
id|pc300_t
op_star
id|card
op_assign
(paren
id|pc300_t
op_star
)paren
id|pc300chan-&gt;card
suffix:semicolon
r_int
id|ch
op_assign
id|pc300chan-&gt;channel
suffix:semicolon
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s-tty: tiocmget&bslash;n&quot;
comma
(paren
(paren
r_struct
id|net_device
op_star
)paren
(paren
id|pc300dev-&gt;hdlc
)paren
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
id|CPC_TTY_LOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|cpc_readb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|M_REG
c_func
(paren
id|CTL
comma
id|ch
)paren
)paren
suffix:semicolon
id|CPC_TTY_UNLOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|status
op_amp
id|CTL_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|CTL_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY Flush Buffer routine&n; *&n; * This routine resets the transmission buffer &n; */
DECL|function|cpc_tty_flush_buffer
r_static
r_void
id|cpc_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;hdlcX-tty: no TTY to flush buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpc_tty-&gt;tty
op_ne
id|tty
)paren
op_logical_or
(paren
id|cpc_tty-&gt;state
op_ne
id|CPC_TTY_ST_OPEN
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY is not opened&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: call wake_up_interruptible&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: call line disc. wake up&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
id|tty-&gt;ldisc
dot
id|write_wakeup
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY Hangup routine&n; *&n; * This routine is called by the tty driver to hangup the interface &n; * o clear DTR signal&n; */
DECL|function|cpc_tty_hangup
r_static
r_void
id|cpc_tty_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;hdlcX-tty: no TTY to hangup&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpc_tty-&gt;tty
op_ne
id|tty
)paren
op_logical_or
(paren
id|cpc_tty-&gt;state
op_ne
id|CPC_TTY_ST_OPEN
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: TTY is not opened&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|serial_drv.refcount
op_logical_and
id|cpc_tty_unreg_flag
)paren
(brace
id|cpc_tty_unreg_flag
op_assign
l_int|0
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: unregister the tty driver&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|serial_drv
)paren
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: ERROR -&gt;unregister the tty driver error=%d&bslash;n&quot;
comma
id|cpc_tty-&gt;name
comma
id|res
)paren
suffix:semicolon
)brace
)brace
id|cpc_tty_signal_off
c_func
(paren
id|cpc_tty-&gt;pc300dev
comma
id|CTL_DTR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY RX work routine&n; * This routine treats RX work&n; * o verify read buffer&n; * o call the line disc. read&n; * o free memory&n; */
DECL|function|cpc_tty_rx_work
r_static
r_void
id|cpc_tty_rx_work
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|port
comma
id|i
comma
id|j
suffix:semicolon
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
r_volatile
id|st_cpc_rx_buf
op_star
id|buf
suffix:semicolon
r_char
id|flags
op_assign
l_int|0
comma
id|flg_rx
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cpc_tty_cnt
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
l_int|4
)paren
op_logical_and
id|flg_rx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|flg_rx
op_assign
l_int|0
suffix:semicolon
id|port
op_assign
(paren
r_int
)paren
id|data
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|CPC_TTY_NPORTS
suffix:semicolon
id|j
op_increment
)paren
(brace
id|cpc_tty
op_assign
op_amp
id|cpc_tty_area
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buf
op_assign
id|cpc_tty-&gt;buf_rx.first
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cpc_tty-&gt;tty
op_logical_and
(paren
id|cpc_tty-&gt;tty-&gt;ldisc.receive_buf
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: call line disc. receive_buf&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
id|cpc_tty-&gt;tty-&gt;ldisc
dot
id|receive_buf
c_func
(paren
id|cpc_tty-&gt;tty
comma
(paren
r_char
op_star
)paren
(paren
id|buf-&gt;data
)paren
comma
op_amp
id|flags
comma
id|buf-&gt;size
)paren
suffix:semicolon
)brace
id|cpc_tty-&gt;buf_rx.first
op_assign
id|cpc_tty-&gt;buf_rx.first-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
)paren
suffix:semicolon
id|buf
op_assign
id|cpc_tty-&gt;buf_rx.first
suffix:semicolon
id|flg_rx
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|port
op_eq
id|CPC_TTY_NPORTS
)paren
id|port
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * PC300 TTY RX work routine&n; *&n; * This routine treats RX interrupt. &n; * o read all frames in card&n; * o verify the frame size&n; * o read the frame in rx buffer&n; */
DECL|function|cpc_tty_rx_disc_frame
r_static
r_void
id|cpc_tty_rx_disc_frame
c_func
(paren
id|pc300ch_t
op_star
id|pc300chan
)paren
(brace
r_volatile
id|pcsca_bd_t
op_star
id|ptdescr
suffix:semicolon
r_volatile
r_int
r_char
id|status
suffix:semicolon
id|pc300_t
op_star
id|card
op_assign
(paren
id|pc300_t
op_star
)paren
id|pc300chan-&gt;card
suffix:semicolon
r_int
id|ch
op_assign
id|pc300chan-&gt;channel
suffix:semicolon
multiline_comment|/* dma buf read */
id|ptdescr
op_assign
(paren
id|pcsca_bd_t
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|RX_BD_ADDR
c_func
(paren
id|ch
comma
id|pc300chan-&gt;rx_first_bd
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pc300chan-&gt;rx_first_bd
op_ne
id|pc300chan-&gt;rx_last_bd
)paren
(brace
id|status
op_assign
id|cpc_readb
c_func
(paren
op_amp
id|ptdescr-&gt;status
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
op_amp
id|ptdescr-&gt;status
comma
l_int|0
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
op_amp
id|ptdescr-&gt;len
comma
l_int|0
)paren
suffix:semicolon
id|pc300chan-&gt;rx_first_bd
op_assign
(paren
id|pc300chan-&gt;rx_first_bd
op_plus
l_int|1
)paren
op_amp
(paren
id|N_DMA_RX_BUF
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|DST_EOM
)paren
(brace
r_break
suffix:semicolon
multiline_comment|/* end of message */
)brace
id|ptdescr
op_assign
(paren
id|pcsca_bd_t
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|cpc_readl
c_func
(paren
op_amp
id|ptdescr-&gt;next
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|cpc_tty_receive
r_void
id|cpc_tty_receive
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
id|pc300ch_t
op_star
id|pc300chan
op_assign
(paren
id|pc300ch_t
op_star
)paren
id|pc300dev-&gt;chan
suffix:semicolon
id|pc300_t
op_star
id|card
op_assign
(paren
id|pc300_t
op_star
)paren
id|pc300chan-&gt;card
suffix:semicolon
r_int
id|ch
op_assign
id|pc300chan-&gt;channel
suffix:semicolon
r_volatile
id|pcsca_bd_t
op_star
id|ptdescr
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|pc300dev-&gt;dev
)paren
suffix:semicolon
r_int
id|rx_len
comma
id|rx_aux
suffix:semicolon
r_volatile
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|first_bd
op_assign
id|pc300chan-&gt;rx_first_bd
suffix:semicolon
id|st_cpc_rx_buf
op_star
r_new
suffix:semicolon
r_int
r_char
id|dsr_rx
suffix:semicolon
r_if
c_cond
(paren
id|pc300dev-&gt;cpc_tty
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|dsr_rx
op_assign
id|cpc_readb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|DSR_RX
c_func
(paren
id|ch
)paren
)paren
suffix:semicolon
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|pc300dev-&gt;cpc_tty
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|rx_len
op_assign
l_int|0
suffix:semicolon
id|ptdescr
op_assign
(paren
id|pcsca_bd_t
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|RX_BD_ADDR
c_func
(paren
id|ch
comma
id|first_bd
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|cpc_readb
c_func
(paren
op_amp
id|ptdescr-&gt;status
)paren
)paren
op_amp
id|DST_OSB
)paren
(brace
id|rx_len
op_add_assign
id|cpc_readw
c_func
(paren
op_amp
id|ptdescr-&gt;len
)paren
suffix:semicolon
id|first_bd
op_assign
(paren
id|first_bd
op_plus
l_int|1
)paren
op_amp
(paren
id|N_DMA_RX_BUF
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|DST_EOM
)paren
(brace
r_break
suffix:semicolon
)brace
id|ptdescr
op_assign
(paren
id|pcsca_bd_t
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|cpc_readl
c_func
(paren
op_amp
id|ptdescr-&gt;next
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rx_len
)paren
(brace
r_if
c_cond
(paren
id|dsr_rx
op_amp
id|DSR_BOF
)paren
(brace
multiline_comment|/* update EDA */
id|cpc_writel
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|DRX_REG
c_func
(paren
id|EDAL
comma
id|ch
)paren
comma
id|RX_BD_ADDR
c_func
(paren
id|ch
comma
id|pc300chan-&gt;rx_last_bd
)paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_len
OG
id|CPC_TTY_MAX_MTU
)paren
(brace
multiline_comment|/* Free RX descriptors */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: frame size is invalid.&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
id|cpc_tty_rx_disc_frame
c_func
(paren
id|pc300chan
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_new
op_assign
(paren
id|st_cpc_rx_buf
op_star
)paren
id|kmalloc
c_func
(paren
id|rx_len
op_plus
r_sizeof
(paren
id|st_cpc_rx_buf
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
op_eq
l_int|0
)paren
(brace
id|cpc_tty_rx_disc_frame
c_func
(paren
id|pc300chan
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* dma buf read */
id|ptdescr
op_assign
(paren
id|pcsca_bd_t
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|RX_BD_ADDR
c_func
(paren
id|ch
comma
id|pc300chan-&gt;rx_first_bd
)paren
)paren
suffix:semicolon
id|rx_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* counter frame size */
r_while
c_loop
(paren
(paren
id|status
op_assign
id|cpc_readb
c_func
(paren
op_amp
id|ptdescr-&gt;status
)paren
)paren
op_amp
id|DST_OSB
)paren
(brace
id|rx_aux
op_assign
id|cpc_readw
c_func
(paren
op_amp
id|ptdescr-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|DST_OVR
op_or
id|DST_CRC
op_or
id|DST_RBIT
op_or
id|DST_SHRT
op_or
id|DST_ABT
)paren
)paren
op_logical_or
(paren
id|rx_aux
OG
id|BD_DEF_LEN
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: reception error&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|DST_OVR
)paren
(brace
id|stats-&gt;rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|DST_CRC
)paren
(brace
id|stats-&gt;rx_crc_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|DST_RBIT
op_or
id|DST_SHRT
op_or
id|DST_ABT
)paren
)paren
op_logical_or
(paren
id|rx_aux
OG
id|BD_DEF_LEN
)paren
)paren
(brace
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* discard remainig descriptors used by the bad frame */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: reception error - discard descriptors&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
id|cpc_tty_rx_disc_frame
c_func
(paren
id|pc300chan
)paren
suffix:semicolon
id|rx_len
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_int
r_char
op_star
)paren
r_new
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* read next frame - while(1) */
)brace
r_if
c_cond
(paren
id|cpc_tty-&gt;state
op_ne
id|CPC_TTY_ST_OPEN
)paren
(brace
multiline_comment|/* Free RX descriptors */
id|cpc_tty_rx_disc_frame
c_func
(paren
id|pc300chan
)paren
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
id|rx_len
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_int
r_char
op_star
)paren
r_new
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* read next frame - while(1) */
)brace
multiline_comment|/* read the segment of the frame */
r_if
c_cond
(paren
id|rx_aux
op_ne
l_int|0
)paren
(brace
id|memcpy_fromio
c_func
(paren
(paren
r_new
op_member_access_from_pointer
id|data
op_plus
id|rx_len
)paren
comma
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|cpc_readl
c_func
(paren
op_amp
id|ptdescr-&gt;ptbuf
)paren
)paren
comma
id|rx_aux
)paren
suffix:semicolon
id|rx_len
op_add_assign
id|rx_aux
suffix:semicolon
)brace
id|cpc_writeb
c_func
(paren
op_amp
id|ptdescr-&gt;status
comma
l_int|0
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
op_amp
id|ptdescr-&gt;len
comma
l_int|0
)paren
suffix:semicolon
id|pc300chan-&gt;rx_first_bd
op_assign
(paren
id|pc300chan-&gt;rx_first_bd
op_plus
l_int|1
)paren
op_amp
(paren
id|N_DMA_RX_BUF
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|DST_EOM
)paren
r_break
suffix:semicolon
id|ptdescr
op_assign
(paren
id|pcsca_bd_t
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|cpc_readl
c_func
(paren
op_amp
id|ptdescr-&gt;next
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* update pointer */
id|pc300chan-&gt;rx_last_bd
op_assign
(paren
id|pc300chan-&gt;rx_first_bd
op_minus
l_int|1
)paren
op_amp
(paren
id|N_DMA_RX_BUF
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dsr_rx
op_amp
id|DSR_BOF
)paren
)paren
(brace
multiline_comment|/* update EDA */
id|cpc_writel
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|DRX_REG
c_func
(paren
id|EDAL
comma
id|ch
)paren
comma
id|RX_BD_ADDR
c_func
(paren
id|ch
comma
id|pc300chan-&gt;rx_last_bd
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rx_len
op_ne
l_int|0
)paren
(brace
id|stats-&gt;rx_bytes
op_add_assign
id|rx_len
suffix:semicolon
r_if
c_cond
(paren
id|pc300dev-&gt;trace_on
)paren
(brace
id|cpc_tty_trace
c_func
(paren
id|pc300dev
comma
r_new
op_member_access_from_pointer
id|data
comma
id|rx_len
comma
l_char|&squot;R&squot;
)paren
suffix:semicolon
)brace
r_new
op_member_access_from_pointer
id|size
op_assign
id|rx_len
suffix:semicolon
r_new
op_member_access_from_pointer
id|next
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cpc_tty-&gt;buf_rx.first
op_eq
l_int|0
)paren
(brace
id|cpc_tty-&gt;buf_rx.first
op_assign
r_new
suffix:semicolon
id|cpc_tty-&gt;buf_rx.last
op_assign
r_new
suffix:semicolon
)brace
r_else
(brace
id|cpc_tty-&gt;buf_rx.last-&gt;next
op_assign
r_new
suffix:semicolon
id|cpc_tty-&gt;buf_rx.last
op_assign
r_new
suffix:semicolon
)brace
id|schedule_work
c_func
(paren
op_amp
(paren
id|cpc_tty-&gt;tty_rx_work
)paren
)paren
suffix:semicolon
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * PC300 TTY TX work routine&n; * &n; * This routine treats TX interrupt. &n; * o if need call line discipline wakeup&n; * o call wake_up_interruptible&n; */
DECL|function|cpc_tty_tx_work
r_static
r_void
id|cpc_tty_tx_work
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|data
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: cpc_tty_tx_work init&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|cpc_tty-&gt;tty
)paren
op_eq
l_int|0
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: the interface is not opened&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s:call line disc. wakeup&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
id|tty-&gt;ldisc.write_wakeup
(paren
id|tty
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY send to card routine&n; * &n; * This routine send data to card. &n; * o clear descriptors&n; * o write data to DMA buffers&n; * o start the transmission&n; */
DECL|function|cpc_tty_send_to_card
r_static
r_int
id|cpc_tty_send_to_card
c_func
(paren
id|pc300dev_t
op_star
id|dev
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
id|pc300ch_t
op_star
id|chan
op_assign
(paren
id|pc300ch_t
op_star
)paren
id|dev-&gt;chan
suffix:semicolon
id|pc300_t
op_star
id|card
op_assign
(paren
id|pc300_t
op_star
)paren
id|chan-&gt;card
suffix:semicolon
r_int
id|ch
op_assign
id|chan-&gt;channel
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev-&gt;dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_volatile
id|pcsca_bd_t
op_star
id|ptdescr
suffix:semicolon
r_int
id|i
comma
id|nchar
suffix:semicolon
r_int
id|tosend
op_assign
id|len
suffix:semicolon
r_int
id|nbuf
op_assign
(paren
(paren
id|len
op_minus
l_int|1
)paren
op_div
id|BD_DEF_LEN
)paren
op_plus
l_int|1
suffix:semicolon
r_int
r_char
op_star
id|pdata
op_assign
id|buf
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s:cpc_tty_send_to_cars len=%i&quot;
comma
(paren
id|st_cpc_tty_area
op_star
)paren
id|dev-&gt;cpc_tty-&gt;name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nbuf
op_ge
id|card-&gt;chan
(braket
id|ch
)braket
dot
id|nfree_tx_bd
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* write buffer to DMA buffers */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: call dma_buf_write&bslash;n&quot;
comma
(paren
id|st_cpc_tty_area
op_star
)paren
id|dev-&gt;cpc_tty-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nbuf
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ptdescr
op_assign
(paren
id|pcsca_bd_t
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|TX_BD_ADDR
c_func
(paren
id|ch
comma
id|card-&gt;chan
(braket
id|ch
)braket
dot
id|tx_next_bd
)paren
)paren
suffix:semicolon
id|nchar
op_assign
(paren
id|BD_DEF_LEN
OG
id|tosend
)paren
ques
c_cond
id|tosend
suffix:colon
id|BD_DEF_LEN
suffix:semicolon
r_if
c_cond
(paren
id|cpc_readb
c_func
(paren
op_amp
id|ptdescr-&gt;status
)paren
op_amp
id|DST_OSB
)paren
(brace
id|memcpy_toio
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.rambase
op_plus
id|cpc_readl
c_func
(paren
op_amp
id|ptdescr-&gt;ptbuf
)paren
)paren
comma
op_amp
id|pdata
(braket
id|len
op_minus
id|tosend
)braket
comma
id|nchar
)paren
suffix:semicolon
id|card-&gt;chan
(braket
id|ch
)braket
dot
id|nfree_tx_bd
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_eq
id|nbuf
)paren
(brace
multiline_comment|/* This must be the last BD to be used */
id|cpc_writeb
c_func
(paren
op_amp
id|ptdescr-&gt;status
comma
id|DST_EOM
)paren
suffix:semicolon
)brace
r_else
(brace
id|cpc_writeb
c_func
(paren
op_amp
id|ptdescr-&gt;status
comma
l_int|0
)paren
suffix:semicolon
)brace
id|cpc_writew
c_func
(paren
op_amp
id|ptdescr-&gt;len
comma
id|nchar
)paren
suffix:semicolon
)brace
r_else
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: error in dma_buf_write&bslash;n&quot;
comma
(paren
id|st_cpc_tty_area
op_star
)paren
id|dev-&gt;cpc_tty-&gt;name
)paren
suffix:semicolon
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|tosend
op_sub_assign
id|nchar
suffix:semicolon
id|card-&gt;chan
(braket
id|ch
)braket
dot
id|tx_next_bd
op_assign
(paren
id|card-&gt;chan
(braket
id|ch
)braket
dot
id|tx_next_bd
op_plus
l_int|1
)paren
op_amp
(paren
id|N_DMA_TX_BUF
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;trace_on
)paren
(brace
id|cpc_tty_trace
c_func
(paren
id|dev
comma
id|buf
comma
id|len
comma
l_char|&squot;T&squot;
)paren
suffix:semicolon
)brace
multiline_comment|/* start transmission */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: start transmission&bslash;n&quot;
comma
(paren
id|st_cpc_tty_area
op_star
)paren
id|dev-&gt;cpc_tty-&gt;name
)paren
suffix:semicolon
id|CPC_TTY_LOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|DTX_REG
c_func
(paren
id|EDAL
comma
id|ch
)paren
comma
id|TX_BD_ADDR
c_func
(paren
id|ch
comma
id|chan-&gt;tx_next_bd
)paren
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|M_REG
c_func
(paren
id|CMD
comma
id|ch
)paren
comma
id|CMD_TX_ENA
)paren
suffix:semicolon
id|cpc_writeb
c_func
(paren
id|card-&gt;hw.scabase
op_plus
id|DSR_TX
c_func
(paren
id|ch
)paren
comma
id|DSR_DE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|PC300_TE
)paren
(brace
id|cpc_writeb
c_func
(paren
id|card-&gt;hw.falcbase
op_plus
id|card-&gt;hw.cpld_reg2
comma
id|cpc_readb
c_func
(paren
id|card-&gt;hw.falcbase
op_plus
id|card-&gt;hw.cpld_reg2
)paren
op_or
(paren
id|CPLD_REG2_FALC_LED1
op_lshift
(paren
l_int|2
op_star
id|ch
)paren
)paren
)paren
suffix:semicolon
)brace
id|CPC_TTY_UNLOCK
c_func
(paren
id|card
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;PC300 TTY trace routine&n; *&n; *  This routine send trace of connection to application. &n; *  o clear descriptors&n; *  o write data to DMA buffers&n; *  o start the transmission&n; */
DECL|function|cpc_tty_trace
r_static
r_void
id|cpc_tty_trace
c_func
(paren
id|pc300dev_t
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_char
id|rxtx
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|10
op_plus
id|len
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* out of memory */
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: tty_trace - out of memory&bslash;n&quot;
comma
id|dev-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_put
(paren
id|skb
comma
l_int|10
op_plus
id|len
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev-&gt;dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_CUST
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|skb-&gt;len
op_assign
l_int|10
op_plus
id|len
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|dev-&gt;dev-&gt;name
comma
l_int|5
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|5
)braket
op_assign
l_char|&squot;[&squot;
suffix:semicolon
id|skb-&gt;data
(braket
l_int|6
)braket
op_assign
id|rxtx
suffix:semicolon
id|skb-&gt;data
(braket
l_int|7
)braket
op_assign
l_char|&squot;]&squot;
suffix:semicolon
id|skb-&gt;data
(braket
l_int|8
)braket
op_assign
l_char|&squot;:&squot;
suffix:semicolon
id|skb-&gt;data
(braket
l_int|9
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|skb-&gt;data
(braket
l_int|10
)braket
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;PC300 TTY unregister service routine&n; *&n; *&t;This routine unregister one interface. &n; */
DECL|function|cpc_tty_unregister_service
r_void
id|cpc_tty_unregister_service
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|pc300dev-&gt;cpc_tty
)paren
op_eq
l_int|0
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: interface is not TTY&bslash;n&quot;
comma
id|pc300dev-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: cpc_tty_unregister_service&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpc_tty-&gt;pc300dev
op_ne
id|pc300dev
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: invalid tty ptr=%s&bslash;n&quot;
comma
id|pc300dev-&gt;dev-&gt;name
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|cpc_tty_cnt
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|serial_drv.refcount
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: unregister is not possible, refcount=%d&quot;
comma
id|cpc_tty-&gt;name
comma
id|serial_drv.refcount
)paren
suffix:semicolon
id|cpc_tty_cnt
op_increment
suffix:semicolon
id|cpc_tty_unreg_flag
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: unregister the tty driver&bslash;n&quot;
comma
id|cpc_tty-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|serial_drv
)paren
)paren
)paren
(brace
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;%s: ERROR -&gt;unregister the tty driver error=%d&bslash;n&quot;
comma
id|cpc_tty-&gt;name
comma
id|res
)paren
suffix:semicolon
)brace
)brace
)brace
id|CPC_TTY_LOCK
c_func
(paren
id|pc300dev-&gt;chan-&gt;card
comma
id|flags
)paren
suffix:semicolon
id|cpc_tty-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|CPC_TTY_UNLOCK
c_func
(paren
id|pc300dev-&gt;chan-&gt;card
comma
id|flags
)paren
suffix:semicolon
id|cpc_tty-&gt;tty_minor
op_assign
l_int|0
suffix:semicolon
id|cpc_tty-&gt;state
op_assign
id|CPC_TTY_ST_IDLE
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY trigger poll routine&n; * This routine is called by pc300driver to treats Tx interrupt. &n; */
DECL|function|cpc_tty_trigger_poll
r_void
id|cpc_tty_trigger_poll
c_func
(paren
id|pc300dev_t
op_star
id|pc300dev
)paren
(brace
id|st_cpc_tty_area
op_star
id|cpc_tty
op_assign
(paren
id|st_cpc_tty_area
op_star
)paren
id|pc300dev-&gt;cpc_tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpc_tty
)paren
(brace
r_return
suffix:semicolon
)brace
id|schedule_work
c_func
(paren
op_amp
(paren
id|cpc_tty-&gt;tty_tx_work
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PC300 TTY reset var routine&n; * This routine is called by pc300driver to init the TTY area. &n; */
DECL|function|cpc_tty_reset_var
r_void
id|cpc_tty_reset_var
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|CPC_TTY_DBG
c_func
(paren
l_string|&quot;hdlcX-tty: reset variables&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* reset  the tty_driver structure - serial_drv */
id|memset
c_func
(paren
op_amp
id|serial_drv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CPC_TTY_NPORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|cpc_tty_area
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|st_cpc_tty_area
)paren
)paren
suffix:semicolon
)brace
)brace
eof
