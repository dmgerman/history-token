multiline_comment|/*****************************************************************************&n;* sdla_chdlc.c&t;WANPIPE(tm) Multiprotocol WAN Link Driver. Cisco HDLC module.&n;*&n;* Authors: &t;Nenad Corbic &lt;ncorbic@sangoma.com&gt;&n;*&t;&t;Gideon Hack  &n;*&n;* Copyright:&t;(c) 1995-2001 Sangoma Technologies Inc.&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;* Feb 28, 2001  Nenad Corbic&t;Updated if_tx_timeout() routine for &n;* &t;&t;&t;&t;2.4.X kernels.&n;* Jan 25, 2001  Nenad Corbic&t;Added a TTY Sync serial driver over the&n;* &t;&t;&t;&t;HDLC streaming protocol&n;* &t;&t;&t;&t;Added a TTY Async serial driver over the&n;* &t;&t;&t;&t;Async protocol.&n;* Dec 15, 2000  Nenad Corbic    Updated for 2.4.X Kernel support&n;* Nov 13, 2000  Nenad Corbic    Added true interface type encoding option.&n;* &t;&t;&t;&t;Tcpdump doesn&squot;t support CHDLC inteface&n;* &t;&t;&t;&t;types, to fix this &quot;true type&quot; option will set&n;* &t;&t;&t;&t;the interface type to RAW IP mode.&n;* Nov 07, 2000  Nenad Corbic&t;Added security features for UDP debugging:&n;*                               Deny all and specify allowed requests.&n;* Jun 20, 2000  Nenad Corbic&t;Fixed the API IP ERROR bug. Caused by the &n;*                               latest update.&n;* May 09, 2000&t;Nenad Corbic&t;Option to bring down an interface&n;*                               upon disconnect.&n;* Mar 23, 2000  Nenad Corbic&t;Improved task queue, bh handling.&n;* Mar 16, 2000&t;Nenad Corbic&t;Fixed the SLARP Dynamic IP addressing.&n;* Mar 06, 2000  Nenad Corbic&t;Bug Fix: corrupted mbox recovery.&n;* Feb 10, 2000  Gideon Hack     Added ASYNC support.&n;* Feb 09, 2000  Nenad Corbic    Fixed two shutdown bugs in update() and&n;*                               if_stats() functions.&n;* Jan 24, 2000  Nenad Corbic    Fixed a startup wanpipe state racing,  &n;*                               condition between if_open and isr. &n;* Jan 10, 2000  Nenad Corbic    Added new socket API support.&n;* Dev 15, 1999  Nenad Corbic    Fixed up header files for 2.0.X kernels&n;* Nov 20, 1999  Nenad Corbic &t;Fixed zero length API bug.&n;* Sep 30, 1999  Nenad Corbic    Fixed dynamic IP and route setup.&n;* Sep 23, 1999  Nenad Corbic    Added SMP support, fixed tracing &n;* Sep 13, 1999  Nenad Corbic&t;Split up Port 0 and 1 into separate devices.&n;* Jun 02, 1999  Gideon Hack     Added support for the S514 adapter.&n;* Oct 30, 1998&t;Jaspreet Singh&t;Added Support for CHDLC API (HDLC STREAMING).&n;* Oct 28, 1998&t;Jaspreet Singh&t;Added Support for Dual Port CHDLC.&n;* Aug 07, 1998&t;David Fong&t;Initial version.&n;*****************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/slab.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;linux/wanpipe.h&gt;&t;/* WANPIPE common user API definitions */
macro_line|#include &lt;linux/if_arp.h&gt;&t;/* ARPHRD_* defines */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#else &t;&t;&t;&t;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;net/route.h&gt;          /* Adding new route entries : 2.0.X kernels */
macro_line|#endif
macro_line|#include &lt;linux/in.h&gt;&t;&t;/* sockaddr_in */
macro_line|#include &lt;linux/inet.h&gt;&t;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;linux/sdlapci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/sdla_chdlc.h&gt;&t;&t;/* CHDLC firmware API definitions */
macro_line|#include &lt;linux/sdla_asy.h&gt;           &t;/* CHDLC (async) API definitions */
macro_line|#include &lt;linux/if_wanpipe_common.h&gt;    /* Socket Driver common area */
macro_line|#include &lt;linux/if_wanpipe.h&gt;&t;&t;
multiline_comment|/* TTY Includes */
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
multiline_comment|/****** Defines &amp; Macros ****************************************************/
multiline_comment|/* reasons for enabling the timer interrupt on the adapter */
DECL|macro|TMR_INT_ENABLED_UDP
mdefine_line|#define TMR_INT_ENABLED_UDP   &t;&t;0x01
DECL|macro|TMR_INT_ENABLED_UPDATE
mdefine_line|#define TMR_INT_ENABLED_UPDATE&t;&t;0x02
DECL|macro|TMR_INT_ENABLED_CONFIG
mdefine_line|#define TMR_INT_ENABLED_CONFIG&t;&t;0x10
DECL|macro|MAX_IP_ERRORS
mdefine_line|#define MAX_IP_ERRORS&t;10
DECL|macro|TTY_CHDLC_MAX_MTU
mdefine_line|#define TTY_CHDLC_MAX_MTU&t;2000
DECL|macro|CHDLC_DFLT_DATA_LEN
mdefine_line|#define&t;CHDLC_DFLT_DATA_LEN&t;1500&t;&t;/* default MTU */
DECL|macro|CHDLC_HDR_LEN
mdefine_line|#define CHDLC_HDR_LEN&t;&t;1
DECL|macro|CHDLC_API
mdefine_line|#define CHDLC_API 0x01
DECL|macro|PORT
mdefine_line|#define PORT(x)   (x == 0 ? &quot;PRIMARY&quot; : &quot;SECONDARY&quot; )
DECL|macro|MAX_BH_BUFF
mdefine_line|#define MAX_BH_BUFF&t;10
singleline_comment|//#define PRINT_DEBUG
macro_line|#ifdef PRINT_DEBUG
DECL|macro|dbg_printk
mdefine_line|#define dbg_printk(format, a...) printk(format, ## a)
macro_line|#else
DECL|macro|dbg_printk
mdefine_line|#define dbg_printk(format, a...)
macro_line|#endif  
multiline_comment|/******Data Structures*****************************************************/
multiline_comment|/* This structure is placed in the private data area of the device structure.&n; * The card structure used to occupy the private area but now the following &n; * structure will incorporate the card structure along with CHDLC specific data&n; */
DECL|struct|chdlc_private_area
r_typedef
r_struct
id|chdlc_private_area
(brace
DECL|member|common
id|wanpipe_common_t
id|common
suffix:semicolon
DECL|member|card
id|sdla_t
op_star
id|card
suffix:semicolon
DECL|member|TracingEnabled
r_int
id|TracingEnabled
suffix:semicolon
multiline_comment|/* For enabling Tracing */
DECL|member|curr_trace_addr
r_int
r_int
id|curr_trace_addr
suffix:semicolon
multiline_comment|/* Used for Tracing */
DECL|member|start_trace_addr
r_int
r_int
id|start_trace_addr
suffix:semicolon
DECL|member|end_trace_addr
r_int
r_int
id|end_trace_addr
suffix:semicolon
DECL|member|base_addr_trace_buffer
r_int
r_int
id|base_addr_trace_buffer
suffix:semicolon
DECL|member|end_addr_trace_buffer
r_int
r_int
id|end_addr_trace_buffer
suffix:semicolon
DECL|member|number_trace_elements
r_int
r_int
id|number_trace_elements
suffix:semicolon
DECL|member|available_buffer_space
r_int
id|available_buffer_space
suffix:semicolon
DECL|member|router_start_time
r_int
r_int
id|router_start_time
suffix:semicolon
DECL|member|route_status
r_int
r_char
id|route_status
suffix:semicolon
DECL|member|route_removed
r_int
r_char
id|route_removed
suffix:semicolon
DECL|member|tick_counter
r_int
r_int
id|tick_counter
suffix:semicolon
multiline_comment|/* For 5s timeout counter */
DECL|member|router_up_time
r_int
r_int
id|router_up_time
suffix:semicolon
DECL|member|IP_address
id|u32
id|IP_address
suffix:semicolon
multiline_comment|/* IP addressing */
DECL|member|IP_netmask
id|u32
id|IP_netmask
suffix:semicolon
DECL|member|ip_local
id|u32
id|ip_local
suffix:semicolon
DECL|member|ip_remote
id|u32
id|ip_remote
suffix:semicolon
DECL|member|ip_local_tmp
id|u32
id|ip_local_tmp
suffix:semicolon
DECL|member|ip_remote_tmp
id|u32
id|ip_remote_tmp
suffix:semicolon
DECL|member|ip_error
id|u8
id|ip_error
suffix:semicolon
DECL|member|config_chdlc
id|u8
id|config_chdlc
suffix:semicolon
DECL|member|config_chdlc_timeout
id|u8
id|config_chdlc_timeout
suffix:semicolon
DECL|member|mc
r_int
r_char
id|mc
suffix:semicolon
multiline_comment|/* Mulitcast support on/off */
DECL|member|udp_pkt_lgth
r_int
r_int
id|udp_pkt_lgth
suffix:semicolon
multiline_comment|/* udp packet processing */
DECL|member|udp_pkt_src
r_char
id|udp_pkt_src
suffix:semicolon
DECL|member|udp_pkt_data
r_char
id|udp_pkt_data
(braket
id|MAX_LGTH_UDP_MGNT_PKT
)braket
suffix:semicolon
DECL|member|timer_int_enabled
r_int
r_int
id|timer_int_enabled
suffix:semicolon
DECL|member|update_comms_stats
r_char
id|update_comms_stats
suffix:semicolon
multiline_comment|/* updating comms stats */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
DECL|member|bh_head
id|bh_data_t
op_star
id|bh_head
suffix:semicolon
multiline_comment|/* Circular buffer for chdlc_bh */
DECL|member|tq_working
r_int
r_int
id|tq_working
suffix:semicolon
DECL|member|bh_write
r_volatile
r_int
id|bh_write
suffix:semicolon
DECL|member|bh_read
r_volatile
r_int
id|bh_read
suffix:semicolon
DECL|member|bh_buff_used
id|atomic_t
id|bh_buff_used
suffix:semicolon
macro_line|#endif
DECL|member|interface_down
r_int
r_char
id|interface_down
suffix:semicolon
multiline_comment|/* Polling task queue. Each interface&n;         * has its own task queue, which is used&n;         * to defer events from the interrupt */
DECL|member|poll_task
r_struct
id|tq_struct
id|poll_task
suffix:semicolon
DECL|member|poll_delay_timer
r_struct
id|timer_list
id|poll_delay_timer
suffix:semicolon
DECL|member|gateway
id|u8
id|gateway
suffix:semicolon
DECL|member|true_if_encoding
id|u8
id|true_if_encoding
suffix:semicolon
singleline_comment|//FIXME: add driver stats as per frame relay!
DECL|typedef|chdlc_private_area_t
)brace
id|chdlc_private_area_t
suffix:semicolon
multiline_comment|/* Route Status options */
DECL|macro|NO_ROUTE
mdefine_line|#define NO_ROUTE&t;0x00
DECL|macro|ADD_ROUTE
mdefine_line|#define ADD_ROUTE&t;0x01
DECL|macro|ROUTE_ADDED
mdefine_line|#define ROUTE_ADDED&t;0x02
DECL|macro|REMOVE_ROUTE
mdefine_line|#define REMOVE_ROUTE&t;0x03
multiline_comment|/* variable for keeping track of enabling/disabling FT1 monitor status */
DECL|variable|rCount
r_static
r_int
id|rCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* variable for tracking how many interfaces to open for WANPIPE on the&n;   two ports */
r_extern
r_void
id|disable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|enable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/****** Function Prototypes *************************************************/
multiline_comment|/* WAN link driver entry points. These are called by the WAN router module. */
r_static
r_int
id|update
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
r_static
r_int
id|new_if
(paren
id|wan_device_t
op_star
id|wandev
comma
id|netdevice_t
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
suffix:semicolon
multiline_comment|/* Network device interface */
r_static
r_int
id|if_init
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_open
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_close
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_header
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
macro_line|#else
r_static
r_int
id|if_rebuild_hdr
(paren
r_void
op_star
id|hdr
comma
id|netdevice_t
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_struct
id|enet_statistics
op_star
id|if_stats
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* CHDLC Firmware interface functions */
r_static
r_int
id|chdlc_configure
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|chdlc_comm_enable
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|chdlc_read_version
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_int
id|chdlc_set_intr_mode
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|chdlc_send
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|chdlc_read_comm_err_stats
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|chdlc_read_op_stats
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|chdlc_error
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|err
comma
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
)paren
suffix:semicolon
r_static
r_int
id|chdlc_disable_comm_shutdown
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
macro_line|#ifdef LINUX_2_4
r_static
r_void
id|if_tx_timeout
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Miscellaneous CHDLC Functions */
r_static
r_int
id|set_chdlc_config
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|init_chdlc_tx_rx_buff
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|process_chdlc_exception
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|process_global_exception
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|update_comms_stats
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
)paren
suffix:semicolon
r_static
r_int
id|configure_ip
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|unconfigure_ip
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|process_route
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|port_set_state
(paren
id|sdla_t
op_star
id|card
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|config_chdlc
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|disable_comm
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|trigger_chdlc_poll
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|chdlc_poll
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|chdlc_poll_delay
(paren
r_int
r_int
id|dev_ptr
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous asynchronous interface Functions */
r_static
r_int
id|set_asy_config
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|asy_comm_enable
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Interrupt handlers */
r_static
r_void
id|wpc_isr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|rx_intr
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|timer_intr
c_func
(paren
id|sdla_t
op_star
)paren
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/* Bottom half handlers */
r_static
r_void
id|chdlc_bh
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|chdlc_bh_cleanup
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|bh_enqueue
(paren
id|netdevice_t
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Miscellaneous functions */
r_static
r_int
id|chk_bcast_mcast_addr
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|reply_udp
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|mbox_len
)paren
suffix:semicolon
r_static
r_int
id|intr_test
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|udp_pkt_type
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|store_udp_mgmt_pkt
c_func
(paren
r_char
id|udp_pkt_src
comma
id|sdla_t
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
comma
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
)paren
suffix:semicolon
r_static
r_int
id|process_udp_mgmt_pkt
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
comma
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
)paren
suffix:semicolon
r_static
r_int
r_int
id|calc_checksum
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|s508_lock
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
suffix:semicolon
r_static
r_void
id|s508_unlock
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
suffix:semicolon
DECL|variable|Intr_test_counter
r_static
r_int
id|Intr_test_counter
suffix:semicolon
multiline_comment|/* TTY Global Definitions */
macro_line|#if defined(LINUX_2_4) || defined(LINUX_2_1)
DECL|macro|NR_PORTS
mdefine_line|#define NR_PORTS 4
DECL|macro|WAN_TTY_MAJOR
mdefine_line|#define WAN_TTY_MAJOR 226
DECL|macro|WAN_TTY_MINOR
mdefine_line|#define WAN_TTY_MINOR 0
DECL|macro|WAN_CARD
mdefine_line|#define WAN_CARD(port) (tty_card_map[port])
DECL|macro|MIN_PORT
mdefine_line|#define MIN_PORT 0
DECL|macro|MAX_PORT
mdefine_line|#define MAX_PORT NR_PORTS-1 
DECL|macro|CRC_LENGTH
mdefine_line|#define CRC_LENGTH 2
r_static
r_int
id|wanpipe_tty_init
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|wanpipe_tty_receive
c_func
(paren
id|sdla_t
op_star
comma
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|wanpipe_tty_trigger_poll
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
DECL|variable|serial_driver
DECL|variable|callout_driver
r_static
r_struct
id|tty_driver
id|serial_driver
comma
id|callout_driver
suffix:semicolon
DECL|variable|serial_refcount
r_static
r_int
id|serial_refcount
op_assign
l_int|1
suffix:semicolon
DECL|variable|tty_init_cnt
r_static
r_int
id|tty_init_cnt
op_assign
l_int|0
suffix:semicolon
DECL|variable|rs_table
r_static
r_struct
id|serial_state
id|rs_table
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|serial_table
r_static
r_struct
id|tty_struct
op_star
id|serial_table
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|serial_termios
r_static
r_struct
id|termios
op_star
id|serial_termios
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|serial_termios_locked
r_static
r_struct
id|termios
op_star
id|serial_termios_locked
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|tty_driver_mode
r_static
r_char
id|tty_driver_mode
op_assign
id|WANOPT_TTY_SYNC
suffix:semicolon
DECL|variable|opt_decode
r_static
r_char
op_star
id|opt_decode
(braket
)braket
op_assign
(brace
l_string|&quot;NONE&quot;
comma
l_string|&quot;CRTSCTS&quot;
comma
l_string|&quot;XONXOFF-RX&quot;
comma
l_string|&quot;CRTSCTS XONXOFF-RX&quot;
comma
l_string|&quot;XONXOFF-TX&quot;
comma
l_string|&quot;CRTSCTS XONXOFF-TX&quot;
comma
l_string|&quot;CRTSCTS XONXOFF&quot;
)brace
suffix:semicolon
DECL|variable|p_decode
r_static
r_char
op_star
id|p_decode
(braket
)braket
op_assign
(brace
l_string|&quot;NONE&quot;
comma
l_string|&quot;ODD&quot;
comma
l_string|&quot;EVEN&quot;
)brace
suffix:semicolon
DECL|variable|tty_card_map
r_static
r_void
op_star
id|tty_card_map
(braket
id|NR_PORTS
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/****** Public Functions ****************************************************/
multiline_comment|/*============================================================================&n; * Cisco HDLC protocol initialization routine.&n; *&n; * This routine is called by the main WANPIPE module during setup.  At this&n; * point adapter is completely initialized and firmware is running.&n; *  o read firmware version (to make sure it&squot;s alive)&n; *  o configure adapter&n; *  o initialize protocol-specific fields of the adapter data space.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure.&n; */
DECL|function|wpc_init
r_int
id|wpc_init
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
)paren
(brace
r_int
r_char
id|port_num
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_int
id|max_permitted_baud
op_assign
l_int|0
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
suffix:semicolon
r_union
(brace
r_char
id|str
(braket
l_int|80
)braket
suffix:semicolon
)brace
id|u
suffix:semicolon
r_volatile
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
suffix:semicolon
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb1
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
multiline_comment|/* Verify configuration ID */
r_if
c_cond
(paren
id|conf-&gt;config_id
op_ne
id|WANCONFIG_CHDLC
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid configuration ID %u!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;config_id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Find out which Port to use */
r_if
c_cond
(paren
(paren
id|conf-&gt;comm_port
op_eq
id|WANOPT_PRI
)paren
op_logical_or
(paren
id|conf-&gt;comm_port
op_eq
id|WANOPT_SEC
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|conf-&gt;comm_port
op_ne
id|card-&gt;next-&gt;u.c.comm_port
)paren
(brace
id|card-&gt;u.c.comm_port
op_assign
id|conf-&gt;comm_port
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR - %s port used!&bslash;n&quot;
comma
id|card-&gt;wandev.name
comma
id|PORT
c_func
(paren
id|conf-&gt;comm_port
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|card-&gt;u.c.comm_port
op_assign
id|conf-&gt;comm_port
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR - Invalid Port Selected!&bslash;n&quot;
comma
id|card-&gt;wandev.name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Initialize protocol-specific fields */
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;u.c.comm_port
op_eq
id|WANOPT_PRI
)paren
(brace
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
id|card-&gt;hw.dpmbase
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
id|card-&gt;hw.dpmbase
op_plus
id|SEC_BASE_ADDR_MB_STRUCT
op_minus
id|PRI_BASE_ADDR_MB_STRUCT
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* for a S514 adapter, set a pointer to the actual mailbox in the */
multiline_comment|/* allocated virtual memory area */
r_if
c_cond
(paren
id|card-&gt;u.c.comm_port
op_eq
id|WANOPT_PRI
)paren
(brace
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
id|card-&gt;hw.dpmbase
op_plus
id|PRI_BASE_ADDR_MB_STRUCT
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
id|card-&gt;hw.dpmbase
op_plus
id|SEC_BASE_ADDR_MB_STRUCT
suffix:semicolon
)brace
)brace
id|mb
op_assign
id|mb1
op_assign
id|card-&gt;mbox
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;configured
)paren
(brace
multiline_comment|/* The board will place an &squot;I&squot; in the return code to indicate that it is&n;&t;   &t;ready to accept commands.  We expect this to be completed in less&n;           &t;than 1 second. */
id|timeout
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|mb-&gt;return_code
op_ne
l_char|&squot;I&squot;
)paren
multiline_comment|/* Wait 1s for board to initialize */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
l_int|1
op_star
id|HZ
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|mb-&gt;return_code
op_ne
l_char|&squot;I&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Initialization not completed by adapter&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Please contact Sangoma representative.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
multiline_comment|/* Read firmware version.  Note that when adapter initializes, it&n;&t; * clears the mailbox, so it may appear that the first command was&n;&t; * executed successfully when in fact it was merely erased. To work&n;&t; * around this, we execute the first command twice.&n;&t; */
r_if
c_cond
(paren
id|chdlc_read_version
c_func
(paren
id|card
comma
id|u.str
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Running Cisco HDLC firmware v%s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|u.str
)paren
suffix:semicolon
id|card-&gt;isr
op_assign
op_amp
id|wpc_isr
suffix:semicolon
id|card-&gt;poll
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;exec
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;wandev.update
op_assign
op_amp
id|update
suffix:semicolon
id|card-&gt;wandev.new_if
op_assign
op_amp
id|new_if
suffix:semicolon
id|card-&gt;wandev.del_if
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;wandev.udp_port
op_assign
id|conf-&gt;udp_port
suffix:semicolon
id|card-&gt;disable_comm
op_assign
op_amp
id|disable_comm
suffix:semicolon
id|card-&gt;wandev.new_if_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset the number of times the &squot;update()&squot; proc has been called */
id|card-&gt;u.c.update_call_count
op_assign
l_int|0
suffix:semicolon
id|card-&gt;wandev.ttl
op_assign
id|conf-&gt;ttl
suffix:semicolon
id|card-&gt;wandev.interface
op_assign
id|conf-&gt;interface
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;u.c.comm_port
op_eq
id|WANOPT_SEC
op_logical_and
id|conf-&gt;interface
op_eq
id|WANOPT_V35
)paren
op_logical_and
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR - V35 Interface not supported on S508 %s port &bslash;n&quot;
comma
id|card-&gt;devname
comma
id|PORT
c_func
(paren
id|card-&gt;u.c.comm_port
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|card-&gt;wandev.clocking
op_assign
id|conf-&gt;clocking
suffix:semicolon
id|port_num
op_assign
id|card-&gt;u.c.comm_port
suffix:semicolon
multiline_comment|/* in API mode, we can configure for &quot;receive only&quot; buffering */
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|card-&gt;u.c.receive_only
op_assign
id|conf-&gt;receive_only
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;receive_only
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Configured for &squot;receive only&squot; mode&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Setup Port Bps */
r_if
c_cond
(paren
id|card-&gt;wandev.clocking
)paren
(brace
r_if
c_cond
(paren
(paren
id|port_num
op_eq
id|WANOPT_PRI
)paren
op_logical_or
id|card-&gt;u.c.receive_only
)paren
(brace
multiline_comment|/* For Primary Port 0 */
id|max_permitted_baud
op_assign
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
ques
c_cond
id|PRI_MAX_BAUD_RATE_S514
suffix:colon
id|PRI_MAX_BAUD_RATE_S508
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port_num
op_eq
id|WANOPT_SEC
)paren
(brace
multiline_comment|/* For Secondary Port 1 */
id|max_permitted_baud
op_assign
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
ques
c_cond
id|SEC_MAX_BAUD_RATE_S514
suffix:colon
id|SEC_MAX_BAUD_RATE_S508
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;bps
OG
id|max_permitted_baud
)paren
(brace
id|conf-&gt;bps
op_assign
id|max_permitted_baud
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Baud too high!&bslash;n&quot;
comma
id|card-&gt;wandev.name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Baud rate set to %lu bps&bslash;n&quot;
comma
id|card-&gt;wandev.name
comma
id|max_permitted_baud
)paren
suffix:semicolon
)brace
id|card-&gt;wandev.bps
op_assign
id|conf-&gt;bps
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;wandev.bps
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup the Port MTU */
r_if
c_cond
(paren
(paren
id|port_num
op_eq
id|WANOPT_PRI
)paren
op_logical_or
id|card-&gt;u.c.receive_only
)paren
(brace
multiline_comment|/* For Primary Port 0 */
id|card-&gt;wandev.mtu
op_assign
(paren
id|conf-&gt;mtu
op_ge
id|MIN_LGTH_CHDLC_DATA_CFG
)paren
ques
c_cond
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;mtu
comma
id|PRI_MAX_NO_DATA_BYTES_IN_FRAME
)paren
suffix:colon
id|CHDLC_DFLT_DATA_LEN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port_num
op_eq
id|WANOPT_SEC
)paren
(brace
multiline_comment|/* For Secondary Port 1 */
id|card-&gt;wandev.mtu
op_assign
(paren
id|conf-&gt;mtu
op_ge
id|MIN_LGTH_CHDLC_DATA_CFG
)paren
ques
c_cond
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;mtu
comma
id|SEC_MAX_NO_DATA_BYTES_IN_FRAME
)paren
suffix:colon
id|CHDLC_DFLT_DATA_LEN
suffix:semicolon
)brace
multiline_comment|/* Set up the interrupt status area */
multiline_comment|/* Read the CHDLC Configuration and obtain: &n;&t; *&t;Ptr to shared memory infor struct&n;         * Use this pointer to calculate the value of card-&gt;u.c.flags !&n; &t; */
id|mb1-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb1-&gt;command
op_assign
id|READ_CHDLC_CONFIGURATION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb1
)paren
ques
c_cond
id|mb1-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
)brace
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb1
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|card-&gt;u.c.flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
(paren
(paren
id|CHDLC_CONFIGURATION_STRUCT
op_star
)paren
id|mb1-&gt;data
)paren
op_member_access_from_pointer
id|ptr_shared_mem_info_struct
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;u.c.flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
(paren
(paren
id|CHDLC_CONFIGURATION_STRUCT
op_star
)paren
id|mb1-&gt;data
)paren
op_member_access_from_pointer
id|ptr_shared_mem_info_struct
op_mod
id|SDLA_WINDOWSIZE
)paren
)paren
suffix:semicolon
)brace
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
multiline_comment|/* This is for the ports link state */
id|card-&gt;wandev.state
op_assign
id|WAN_DUALPORT
suffix:semicolon
id|card-&gt;u.c.state
op_assign
id|WAN_DISCONNECTED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;wandev.piggyback
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/* Perform interrupt testing */
id|err
op_assign
id|intr_test
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_or
(paren
id|Intr_test_counter
OL
id|MAX_INTR_TEST_COUNTER
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interrupt test failed (%i)&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|Intr_test_counter
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Please choose another interrupt&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interrupt test passed (%i)&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|Intr_test_counter
)paren
suffix:semicolon
id|card-&gt;configured
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|card-&gt;tty_opt
op_assign
id|conf-&gt;tty
)paren
op_eq
id|WANOPT_YES
)paren
(brace
macro_line|#if defined(LINUX_2_4) || defined(LINUX_2_1)&t;
r_int
id|err
suffix:semicolon
id|card-&gt;tty_minor
op_assign
id|conf-&gt;tty_minor
suffix:semicolon
multiline_comment|/* On ASYNC connections internal clocking &n;&t;&t; * is mandatory */
r_if
c_cond
(paren
(paren
id|card-&gt;u.c.async_mode
op_assign
id|conf-&gt;tty_mode
)paren
)paren
(brace
id|card-&gt;wandev.clocking
op_assign
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|wanpipe_tty_init
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error: TTY driver is not supported on 2.0.X kernels!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
id|APP_INT_ON_TIMER
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
"&quot;"
op_mod
id|s
suffix:colon
id|Failed
id|to
id|set
id|interrupt
id|triggers
op_logical_neg
"&bslash;"
id|n
"&quot;"
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Mask the Timer interrupt */
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_and_assign
op_complement
id|APP_INT_ON_TIMER
suffix:semicolon
)brace
multiline_comment|/* If we are using CHDLC in backup mode, this flag will&n;&t; * indicate not to look for IP addresses in config_chdlc()*/
id|card-&gt;u.c.backup
op_assign
id|conf-&gt;backup
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******* WAN Device Driver Entry Points *************************************/
multiline_comment|/*============================================================================&n; * Update device status &amp; statistics&n; * This procedure is called when updating the PROC file system and returns&n; * various communications statistics. These statistics are accumulated from 3 &n; * different locations:&n; * &t;1) The &squot;if_stats&squot; recorded for the device.&n; * &t;2) Communication error statistics on the adapter.&n; *      3) CHDLC operational statistics on the adapter.&n; * The board level statistics are read during a timer interrupt. Note that we &n; * read the error and operational statistics during consecitive timer ticks so&n; * as to minimize the time that we are inside the interrupt handler.&n; *&n; */
DECL|function|update
r_static
r_int
id|update
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|netdevice_t
op_star
id|dev
suffix:semicolon
r_volatile
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* more sanity checks */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.c.flags
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PERI_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;update_comms_stats
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* we will need 2 timer interrupts to complete the */
multiline_comment|/* reading of the statistics */
id|chdlc_priv_area-&gt;update_comms_stats
op_assign
l_int|2
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_or_assign
id|APP_INT_ON_TIMER
suffix:semicolon
id|chdlc_priv_area-&gt;timer_int_enabled
op_assign
id|TMR_INT_ENABLED_UPDATE
suffix:semicolon
multiline_comment|/* wait a maximum of 1 second for the statistics to be updated */
id|timeout
op_assign
id|jiffies
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;update_comms_stats
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
(paren
l_int|1
op_star
id|HZ
)paren
)paren
(brace
id|chdlc_priv_area-&gt;update_comms_stats
op_assign
l_int|0
suffix:semicolon
id|chdlc_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UPDATE
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Create new logical channel.&n; * This routine is called by the router when ROUTER_IFNEW IOCTL is being&n; * handled.&n; * o parse media- and hardware-specific configuration&n; * o make sure that a new channel can be created&n; * o allocate resources, if necessary&n; * o prepare network device structure for registaration.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure (channel will not be created)&n; */
DECL|function|new_if
r_static
r_int
id|new_if
(paren
id|wan_device_t
op_star
id|wandev
comma
id|netdevice_t
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Configuring Interface: %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conf-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
id|strlen
c_func
(paren
id|conf-&gt;name
)paren
OG
id|WAN_IFNAME_SZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Invalid interface name!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* allocate and initialize private data */
id|chdlc_priv_area
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|chdlc_private_area_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chdlc_priv_area
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|chdlc_priv_area
comma
l_int|0
comma
r_sizeof
(paren
id|chdlc_private_area_t
)paren
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;card
op_assign
id|card
suffix:semicolon
id|chdlc_priv_area-&gt;common.sk
op_assign
l_int|NULL
suffix:semicolon
id|chdlc_priv_area-&gt;common.func
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* initialize data */
id|strcpy
c_func
(paren
id|card-&gt;u.c.if_name
comma
id|conf-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.new_if_cnt
OG
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|chdlc_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
id|card-&gt;wandev.new_if_cnt
op_increment
suffix:semicolon
id|chdlc_priv_area-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
id|chdlc_priv_area-&gt;route_status
op_assign
id|NO_ROUTE
suffix:semicolon
id|chdlc_priv_area-&gt;route_removed
op_assign
l_int|0
suffix:semicolon
id|card-&gt;u.c.async_mode
op_assign
id|conf-&gt;async_mode
suffix:semicolon
multiline_comment|/* setup for asynchronous mode */
r_if
c_cond
(paren
id|conf-&gt;async_mode
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Configuring for asynchronous mode&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.comm_port
op_eq
id|WANOPT_PRI
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:Asynchronous mode on secondary port only&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chdlc_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;WANPIPE&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Running in WANIPE Async Mode&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|card-&gt;u.c.usedby
op_assign
id|WANPIPE
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;u.c.usedby
op_assign
id|API
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;wandev.clocking
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Asynch. clocking must be &squot;Internal&squot;&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chdlc_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|card-&gt;wandev.bps
OL
id|MIN_ASY_BAUD_RATE
)paren
op_logical_or
(paren
id|card-&gt;wandev.bps
OG
id|MAX_ASY_BAUD_RATE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Selected baud rate is invalid.&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Must be between %u and %u bps.&bslash;n&quot;
comma
id|MIN_ASY_BAUD_RATE
comma
id|MAX_ASY_BAUD_RATE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chdlc_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|card-&gt;u.c.api_options
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;asy_data_trans
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.api_options
op_or_assign
id|ASY_RX_DATA_TRANSPARENT
suffix:semicolon
)brace
id|card-&gt;u.c.protocol_options
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;rts_hs_for_receive
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.protocol_options
op_or_assign
id|ASY_RTS_HS_FOR_RX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;xon_xoff_hs_for_receive
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.protocol_options
op_or_assign
id|ASY_XON_XOFF_HS_FOR_RX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;xon_xoff_hs_for_transmit
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.protocol_options
op_or_assign
id|ASY_XON_XOFF_HS_FOR_TX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;dcd_hs_for_transmit
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.protocol_options
op_or_assign
id|ASY_DCD_HS_FOR_TX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;cts_hs_for_transmit
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.protocol_options
op_or_assign
id|ASY_CTS_HS_FOR_TX
suffix:semicolon
)brace
id|card-&gt;u.c.tx_bits_per_char
op_assign
id|conf-&gt;tx_bits_per_char
suffix:semicolon
id|card-&gt;u.c.rx_bits_per_char
op_assign
id|conf-&gt;rx_bits_per_char
suffix:semicolon
id|card-&gt;u.c.stop_bits
op_assign
id|conf-&gt;stop_bits
suffix:semicolon
id|card-&gt;u.c.parity
op_assign
id|conf-&gt;parity
suffix:semicolon
id|card-&gt;u.c.break_timer
op_assign
id|conf-&gt;break_timer
suffix:semicolon
id|card-&gt;u.c.inter_char_timer
op_assign
id|conf-&gt;inter_char_timer
suffix:semicolon
id|card-&gt;u.c.rx_complete_length
op_assign
id|conf-&gt;rx_complete_length
suffix:semicolon
id|card-&gt;u.c.xon_char
op_assign
id|conf-&gt;xon_char
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* setup for synchronous mode */
id|card-&gt;u.c.protocol_options
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;ignore_dcd
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.protocol_options
op_or_assign
id|IGNORE_DCD_FOR_LINK_STAT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;ignore_cts
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.protocol_options
op_or_assign
id|IGNORE_CTS_FOR_LINK_STAT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;ignore_keepalive
op_eq
id|WANOPT_YES
)paren
(brace
id|card-&gt;u.c.protocol_options
op_or_assign
id|IGNORE_KPALV_FOR_LINK_STAT
suffix:semicolon
id|card-&gt;u.c.kpalv_tx
op_assign
id|MIN_Tx_KPALV_TIMER
suffix:semicolon
id|card-&gt;u.c.kpalv_rx
op_assign
id|MIN_Rx_KPALV_TIMER
suffix:semicolon
id|card-&gt;u.c.kpalv_err
op_assign
id|MIN_KPALV_ERR_TOL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Do not ignore keepalives */
id|card-&gt;u.c.kpalv_tx
op_assign
(paren
(paren
id|conf-&gt;keepalive_tx_tmr
op_minus
id|MIN_Tx_KPALV_TIMER
)paren
op_ge
l_int|0
)paren
ques
c_cond
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;keepalive_tx_tmr
comma
id|MAX_Tx_KPALV_TIMER
)paren
suffix:colon
id|DEFAULT_Tx_KPALV_TIMER
suffix:semicolon
id|card-&gt;u.c.kpalv_rx
op_assign
(paren
(paren
id|conf-&gt;keepalive_rx_tmr
op_minus
id|MIN_Rx_KPALV_TIMER
)paren
op_ge
l_int|0
)paren
ques
c_cond
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;keepalive_rx_tmr
comma
id|MAX_Rx_KPALV_TIMER
)paren
suffix:colon
id|DEFAULT_Rx_KPALV_TIMER
suffix:semicolon
id|card-&gt;u.c.kpalv_err
op_assign
(paren
(paren
id|conf-&gt;keepalive_err_margin
op_minus
id|MIN_KPALV_ERR_TOL
)paren
op_ge
l_int|0
)paren
ques
c_cond
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;keepalive_err_margin
comma
id|MAX_KPALV_ERR_TOL
)paren
suffix:colon
id|DEFAULT_KPALV_ERR_TOL
suffix:semicolon
)brace
multiline_comment|/* Setup slarp timer to control delay between slarps */
id|card-&gt;u.c.slarp_timer
op_assign
(paren
(paren
id|conf-&gt;slarp_timer
op_minus
id|MIN_SLARP_REQ_TIMER
)paren
op_ge
l_int|0
)paren
ques
c_cond
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;slarp_timer
comma
id|MAX_SLARP_REQ_TIMER
)paren
suffix:colon
id|DEFAULT_SLARP_REQ_TIMER
suffix:semicolon
macro_line|#ifdef LINUX_2_0
r_if
c_cond
(paren
id|card-&gt;u.c.slarp_timer
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error: Dynamic IP support not available for 2.0.X kernels&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:        Defaulting to Static IP addressing&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|card-&gt;u.c.slarp_timer
op_assign
l_int|0
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
id|conf-&gt;hdlc_streaming
op_eq
id|WANOPT_YES
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling HDLC STREAMING Mode&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|card-&gt;u.c.protocol_options
op_assign
id|HDLC_STREAMING_MODE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|chdlc_priv_area-&gt;true_if_encoding
op_assign
id|conf-&gt;true_if_encoding
)paren
op_eq
id|WANOPT_YES
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling, true interface type encoding.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup wanpipe as a router (WANPIPE) or as an API */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;WANPIPE&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Running in WANPIPE mode!&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|card-&gt;u.c.usedby
op_assign
id|WANPIPE
suffix:semicolon
multiline_comment|/* Option to bring down the interface when &n;        &t;&t; * the link goes down */
r_if
c_cond
(paren
id|conf-&gt;if_down
)paren
(brace
id|set_bit
c_func
(paren
id|DYN_OPT_ON
comma
op_amp
id|chdlc_priv_area-&gt;interface_down
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Dynamic interface configuration enabled&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;API&quot;
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4) 
id|card-&gt;u.c.usedby
op_assign
id|API
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Running in API mode !&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: API Mode is not supported for kernels lower than 2.2.X!&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Please upgrade to a 2.2.X kernel fro the API support&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chdlc_priv_area
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
)brace
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/* Tells us that if this interface is a&n;         * gateway or not */
r_if
c_cond
(paren
(paren
id|chdlc_priv_area-&gt;gateway
op_assign
id|conf-&gt;gateway
)paren
op_eq
id|WANOPT_YES
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s is set as a gateway.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;u.c.if_name
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Get Multicast Information */
id|chdlc_priv_area-&gt;mc
op_assign
id|conf-&gt;mc
suffix:semicolon
multiline_comment|/* prepare network device data space for registration */
macro_line|#ifdef LINUX_2_4
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|card-&gt;u.c.if_name
)paren
suffix:semicolon
macro_line|#else
id|dev-&gt;name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|card-&gt;u.c.if_name
)paren
op_plus
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;%s&quot;
comma
id|card-&gt;u.c.if_name
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;init
op_assign
op_amp
id|if_init
suffix:semicolon
id|dev-&gt;priv
op_assign
id|chdlc_priv_area
suffix:semicolon
multiline_comment|/* Initialize the polling task routine */
macro_line|#ifndef LINUX_2_4
id|chdlc_priv_area-&gt;poll_task.next
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|chdlc_priv_area-&gt;poll_task.sync
op_assign
l_int|0
suffix:semicolon
id|chdlc_priv_area-&gt;poll_task.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|chdlc_poll
suffix:semicolon
id|chdlc_priv_area-&gt;poll_task.data
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Initialize the polling delay timer */
id|init_timer
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;poll_delay_timer
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;poll_delay_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|chdlc_priv_area-&gt;poll_delay_timer.function
op_assign
id|chdlc_poll_delay
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Network Device Interface ********************************************/
multiline_comment|/*============================================================================&n; * Initialize Linux network interface.&n; *&n; * This routine is called only once for each interface, during Linux network&n; * interface registration.  Returning anything but zero will fail interface&n; * registration.&n; */
DECL|function|if_init
r_static
r_int
id|if_init
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chdlc_priv_area-&gt;card
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
macro_line|#ifdef LINUX_2_0
r_int
id|i
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialize device driver entry points */
id|dev-&gt;open
op_assign
op_amp
id|if_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|if_close
suffix:semicolon
id|dev-&gt;hard_header
op_assign
op_amp
id|if_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
op_amp
id|if_rebuild_hdr
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|if_send
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|if_stats
suffix:semicolon
macro_line|#ifdef LINUX_2_4
id|dev-&gt;tx_timeout
op_assign
op_amp
id|if_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialize media-specific parameters */
id|dev-&gt;flags
op_or_assign
id|IFF_POINTOPOINT
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_NOARP
suffix:semicolon
multiline_comment|/* Enable Mulitcasting if user selected */
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;mc
op_eq
id|WANOPT_YES
)paren
(brace
id|dev-&gt;flags
op_or_assign
id|IFF_MULTICAST
suffix:semicolon
)brace
macro_line|#ifdef LINUX_2_0
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;true_if_encoding
)paren
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|dev-&gt;type
op_assign
id|ARPHRD_HDLC
suffix:semicolon
multiline_comment|/* This breaks the tcpdump */
macro_line|#else
id|dev-&gt;type
op_assign
id|ARPHRD_PPP
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|dev-&gt;type
op_assign
id|ARPHRD_PPP
suffix:semicolon
)brace
id|dev-&gt;mtu
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
multiline_comment|/* for API usage, add the API header size to the requested MTU size */
r_if
c_cond
(paren
id|card-&gt;u.c.usedby
op_eq
id|API
)paren
(brace
id|dev-&gt;mtu
op_add_assign
r_sizeof
(paren
id|api_tx_hdr_t
)paren
suffix:semicolon
)brace
id|dev-&gt;hard_header_len
op_assign
id|CHDLC_HDR_LEN
suffix:semicolon
multiline_comment|/* Initialize hardware parameters */
id|dev-&gt;irq
op_assign
id|wandev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
id|wandev-&gt;dma
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|wandev-&gt;ioport
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|wandev-&gt;maddr
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|wandev-&gt;maddr
op_plus
id|wandev-&gt;msize
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set transmit buffer queue length &n;&t; * If too low packets will not be retransmitted &n;         * by stack.&n;&t; */
id|dev-&gt;tx_queue_len
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* Initialize socket buffers */
macro_line|#if !defined(LINUX_2_1) &amp;&amp; !defined(LINUX_2_4)
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
op_increment
id|i
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Open network interface.&n; * o enable communications and interrupts.&n; * o prevent module from unloading by incrementing use count&n; *&n; * Return 0 if O.k. or errno.&n; */
DECL|function|if_open
r_static
r_int
id|if_open
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chdlc_priv_area-&gt;card
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Only one open per interface is allowed */
r_if
c_cond
(paren
id|is_dev_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/* Initialize the task queue */
id|chdlc_priv_area-&gt;tq_working
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef LINUX_2_4
id|chdlc_priv_area-&gt;common.wanpipe_task.next
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|chdlc_priv_area-&gt;common.wanpipe_task.sync
op_assign
l_int|0
suffix:semicolon
id|chdlc_priv_area-&gt;common.wanpipe_task.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|chdlc_bh
suffix:semicolon
id|chdlc_priv_area-&gt;common.wanpipe_task.data
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Allocate and initialize BH circular buffer */
multiline_comment|/* Add 1 to MAX_BH_BUFF so we don&squot;t have test with (MAX_BH_BUFF-1) */
id|chdlc_priv_area-&gt;bh_head
op_assign
id|kmalloc
c_func
(paren
(paren
r_sizeof
(paren
id|bh_data_t
)paren
op_star
(paren
id|MAX_BH_BUFF
op_plus
l_int|1
)paren
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|memset
c_func
(paren
id|chdlc_priv_area-&gt;bh_head
comma
l_int|0
comma
(paren
r_sizeof
(paren
id|bh_data_t
)paren
op_star
(paren
id|MAX_BH_BUFF
op_plus
l_int|1
)paren
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;bh_buff_used
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;router_start_time
op_assign
id|tv.tv_sec
suffix:semicolon
macro_line|#ifdef LINUX_2_4
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#else
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|wanpipe_open
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* TTY is configured during wanpipe_set_termios&n;&t; * call, not here */
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
r_return
id|err
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|chdlc_priv_area-&gt;config_chdlc
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;config_chdlc_timeout
op_assign
id|jiffies
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;poll_delay_timer
)paren
suffix:semicolon
multiline_comment|/* Start the CHDLC configuration after 1sec delay.&n;&t; * This will give the interface initilization time&n;&t; * to finish its configuration */
id|chdlc_priv_area-&gt;poll_delay_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;poll_delay_timer
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Close network interface.&n; * o if this is the last close, then disable communications and interrupts.&n; * o reset flags.&n; */
DECL|function|if_close
r_static
r_int
id|if_close
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chdlc_priv_area-&gt;card
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;bh_head
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|MAX_BH_BUFF
op_plus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
(paren
(paren
id|bh_data_t
op_star
)paren
op_amp
id|chdlc_priv_area-&gt;bh_head
(braket
id|i
)braket
)paren
op_member_access_from_pointer
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|chdlc_priv_area-&gt;bh_head
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;bh_head
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
id|stop_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifndef LINUX_2_4
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|wanpipe_close
c_func
(paren
id|card
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;poll_delay_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|disable_comm
r_static
r_void
id|disable_comm
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.comm_enabled
)paren
(brace
id|chdlc_disable_comm_shutdown
(paren
id|card
)paren
suffix:semicolon
)brace
r_else
(brace
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(LINUX_2_4) || defined(LINUX_2_1)&t;
r_if
c_cond
(paren
op_logical_neg
id|tty_init_cnt
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
(brace
r_struct
id|serial_state
op_star
id|state
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|tty_init_cnt
)paren
)paren
(brace
r_int
id|e1
comma
id|e2
suffix:semicolon
op_star
id|serial_driver.refcount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e1
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|serial_driver
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;SERIAL: failed to unregister serial driver (%d)&bslash;n&quot;
comma
id|e1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e2
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|callout_driver
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;SERIAL: failed to unregister callout driver (%d)&bslash;n&quot;
comma
id|e2
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unregistering TTY Driver, Major %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|WAN_TTY_MAJOR
)paren
suffix:semicolon
)brace
id|card-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|tty_card_map
(braket
id|card-&gt;tty_minor
)braket
op_assign
l_int|NULL
suffix:semicolon
id|state
op_assign
op_amp
id|rs_table
(braket
id|card-&gt;tty_minor
)braket
suffix:semicolon
id|memset
c_func
(paren
id|state
comma
l_int|0
comma
r_sizeof
(paren
id|state
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Build media header.&n; *&n; * The trick here is to put packet type (Ethertype) into &squot;protocol&squot; field of&n; * the socket buffer, so that we don&squot;t forget it.  If packet type is not&n; * supported, set skb-&gt;protocol to 0 and discard packet later.&n; *&n; * Return:&t;media header length.&n; */
DECL|function|if_header
r_static
r_int
id|if_header
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
r_return
id|CHDLC_HDR_LEN
suffix:semicolon
)brace
macro_line|#ifdef LINUX_2_4
multiline_comment|/*============================================================================&n; * Handle transmit timeout event from netif watchdog&n; */
DECL|function|if_tx_timeout
r_static
r_void
id|if_tx_timeout
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
multiline_comment|/* If our device stays busy for at least 5 seconds then we will&n;&t; * kick start the device by making dev-&gt;tbusy = 0.  We expect&n;&t; * that our device never stays busy more than 5 seconds. So this                 &n;&t; * is only used as a last resort.&n;&t; */
op_increment
id|card-&gt;wandev.stats.collisions
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit timed out on %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*============================================================================&n; * Re-build media header.&n; *&n; * Return:&t;1&t;physical address resolved.&n; *&t;&t;0&t;physical address not resolved&n; */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
DECL|function|if_rebuild_hdr
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#else
DECL|function|if_rebuild_hdr
r_static
r_int
id|if_rebuild_hdr
(paren
r_void
op_star
id|hdr
comma
id|netdevice_t
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*============================================================================&n; * Send a packet on a network interface.&n; * o set tbusy flag (marks start of the transmission) to block a timer-based&n; *   transmit from overlapping.&n; * o check link state. If link is not up, then drop the packet.&n; * o execute adapter send command.&n; * o free socket buffer&n; *&n; * Return:&t;0&t;complete (socket buffer must be freed)&n; *&t;&t;non-0&t;packet may be re-transmitted (tbusy must be set)&n; *&n; * Notes:&n; * 1. This routine is called either by the protocol stack or by the &quot;net&n; *    bottom half&quot; (with interrupts enabled).&n; * 2. Setting tbusy flag will inhibit further transmit requests from the&n; *    protocol stack and can be used for flow control with protocol layer.&n; */
DECL|function|if_send
r_static
r_int
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chdlc_priv_area-&gt;card
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
id|INTERRUPT_INFORMATION_STRUCT
op_star
id|chdlc_int
op_assign
op_amp
id|flags-&gt;interrupt_info_struct
suffix:semicolon
r_int
id|udp_type
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|smp_flags
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef LINUX_2_4
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* If we get here, some higher layer thinks we&squot;ve missed an&n;&t;&t; * tx-done interrupt.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s got kicked!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|wake_net_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef LINUX_2_4
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
multiline_comment|/* If our device stays busy for at least 5 seconds then we will&n;&t;&t; * kick start the device by making dev-&gt;tbusy = 0.  We expect &n;&t;&t; * that our device never stays busy more than 5 seconds. So this&n;&t;&t; * is only used as a last resort. &n;&t;&t; */
op_increment
id|card-&gt;wandev.stats.collisions
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|chdlc_priv_area-&gt;tick_counter
)paren
OL
(paren
l_int|5
op_star
id|HZ
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit timeout !&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
multiline_comment|/* unbusy the interface */
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|dev-&gt;tbusy
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
op_ne
id|htons
c_func
(paren
id|PVC_PROT
)paren
)paren
(brace
multiline_comment|/* check the udp packet type */
id|udp_type
op_assign
id|udp_pkt_type
c_func
(paren
id|skb
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udp_type
op_eq
id|UDP_CPIPE_TYPE
)paren
(brace
r_if
c_cond
(paren
id|store_udp_mgmt_pkt
c_func
(paren
id|UDP_PKT_FRM_STACK
comma
id|card
comma
id|skb
comma
id|dev
comma
id|chdlc_priv_area
)paren
)paren
(brace
id|chdlc_int-&gt;interrupt_permission
op_or_assign
id|APP_INT_ON_TIMER
suffix:semicolon
)brace
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check to see if the source IP address is a broadcast or */
multiline_comment|/* multicast IP address */
r_if
c_cond
(paren
id|chk_bcast_mcast_addr
c_func
(paren
id|card
comma
id|dev
comma
id|skb
)paren
)paren
(brace
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Lock the 508 Card: SMP is supported */
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_lock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Critical in if_send: %lx&bslash;n&quot;
comma
id|card-&gt;wandev.name
comma
id|card-&gt;wandev.critical
)paren
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|if_send_exit_crit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;u.c.state
op_ne
id|WAN_CONNECTED
)paren
(brace
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;protocol
)paren
(brace
op_increment
id|card-&gt;wandev.stats.tx_errors
suffix:semicolon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
r_void
op_star
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
r_char
id|attr
suffix:semicolon
multiline_comment|/* If it&squot;s an API packet pull off the API&n;&t;&t; * header. Also check that the packet size&n;&t;&t; * is larger than the API header&n;&t;         */
r_if
c_cond
(paren
id|card-&gt;u.c.usedby
op_eq
id|API
)paren
(brace
id|api_tx_hdr_t
op_star
id|api_tx_hdr
suffix:semicolon
multiline_comment|/* discard the frame if we are configured for */
multiline_comment|/* &squot;receive only&squot; mode or if there is no data */
r_if
c_cond
(paren
id|card-&gt;u.c.receive_only
op_logical_or
(paren
id|len
op_le
r_sizeof
(paren
id|api_tx_hdr_t
)paren
)paren
)paren
(brace
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|if_send_exit_crit
suffix:semicolon
)brace
id|api_tx_hdr
op_assign
(paren
id|api_tx_hdr_t
op_star
)paren
id|data
suffix:semicolon
id|attr
op_assign
id|api_tx_hdr-&gt;attr
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
id|api_tx_hdr_t
)paren
suffix:semicolon
id|len
op_sub_assign
r_sizeof
(paren
id|api_tx_hdr_t
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chdlc_send
c_func
(paren
id|card
comma
id|data
comma
id|len
)paren
)paren
(brace
id|stop_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
op_increment
id|card-&gt;wandev.stats.tx_packets
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|card-&gt;wandev.stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
macro_line|#endif
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef LINUX_2_4
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
macro_line|#endif
)brace
)brace
id|if_send_exit_crit
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|err
op_assign
id|is_queue_stopped
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_else
(brace
id|chdlc_priv_area-&gt;tick_counter
op_assign
id|jiffies
suffix:semicolon
id|chdlc_int-&gt;interrupt_permission
op_or_assign
id|APP_INT_ON_TX_FRAME
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Check to see if the packet to be transmitted contains a broadcast or&n; * multicast source IP address.&n; */
DECL|function|chk_bcast_mcast_addr
r_static
r_int
id|chk_bcast_mcast_addr
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|u32
id|src_ip_addr
suffix:semicolon
id|u32
id|broadcast_ip_addr
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
macro_line|#endif
multiline_comment|/* read the IP source address from the outgoing packet */
id|src_ip_addr
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* read the IP broadcast address for the device */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_ne
l_int|NULL
)paren
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_ne
l_int|NULL
)paren
(brace
id|broadcast_ip_addr
op_assign
id|ifa-&gt;ifa_broadcast
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
id|broadcast_ip_addr
op_assign
id|dev-&gt;pa_brdaddr
suffix:semicolon
macro_line|#endif
multiline_comment|/* check if the IP Source Address is a Broadcast address */
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_BROADCAST
)paren
op_logical_and
(paren
id|src_ip_addr
op_eq
id|broadcast_ip_addr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Broadcast Source Address silently discarded&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* check if the IP Source Address is a Multicast address */
r_if
c_cond
(paren
(paren
id|ntohl
c_func
(paren
id|src_ip_addr
)paren
op_ge
l_int|0xE0000001
)paren
op_logical_and
(paren
id|ntohl
c_func
(paren
id|src_ip_addr
)paren
op_le
l_int|0xFFFFFFFE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Multicast Source Address silently discarded&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Reply to UDP Management system.&n; * Return length of reply.&n; */
DECL|function|reply_udp
r_static
r_int
id|reply_udp
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|mbox_len
)paren
(brace
r_int
r_int
id|len
comma
id|udp_length
comma
id|temp
comma
id|ip_length
suffix:semicolon
r_int
r_int
id|ip_temp
suffix:semicolon
r_int
id|even_bound
op_assign
l_int|0
suffix:semicolon
id|chdlc_udp_pkt_t
op_star
id|c_udp_pkt
op_assign
(paren
id|chdlc_udp_pkt_t
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* Set length of packet */
id|len
op_assign
r_sizeof
(paren
id|ip_pkt_t
)paren
op_plus
r_sizeof
(paren
id|udp_pkt_t
)paren
op_plus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_plus
r_sizeof
(paren
id|cblock_t
)paren
op_plus
r_sizeof
(paren
id|trace_info_t
)paren
op_plus
id|mbox_len
suffix:semicolon
multiline_comment|/* fill in UDP reply */
id|c_udp_pkt-&gt;wp_mgmt.request_reply
op_assign
id|UDPMGMT_REPLY
suffix:semicolon
multiline_comment|/* fill in UDP length */
id|udp_length
op_assign
r_sizeof
(paren
id|udp_pkt_t
)paren
op_plus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_plus
r_sizeof
(paren
id|cblock_t
)paren
op_plus
r_sizeof
(paren
id|trace_info_t
)paren
op_plus
id|mbox_len
suffix:semicolon
multiline_comment|/* put it on an even boundary */
r_if
c_cond
(paren
id|udp_length
op_amp
l_int|0x0001
)paren
(brace
id|udp_length
op_add_assign
l_int|1
suffix:semicolon
id|len
op_add_assign
l_int|1
suffix:semicolon
id|even_bound
op_assign
l_int|1
suffix:semicolon
)brace
id|temp
op_assign
(paren
id|udp_length
op_lshift
l_int|8
)paren
op_or
(paren
id|udp_length
op_rshift
l_int|8
)paren
suffix:semicolon
id|c_udp_pkt-&gt;udp_pkt.udp_length
op_assign
id|temp
suffix:semicolon
multiline_comment|/* swap UDP ports */
id|temp
op_assign
id|c_udp_pkt-&gt;udp_pkt.udp_src_port
suffix:semicolon
id|c_udp_pkt-&gt;udp_pkt.udp_src_port
op_assign
id|c_udp_pkt-&gt;udp_pkt.udp_dst_port
suffix:semicolon
id|c_udp_pkt-&gt;udp_pkt.udp_dst_port
op_assign
id|temp
suffix:semicolon
multiline_comment|/* add UDP pseudo header */
id|temp
op_assign
l_int|0x1100
suffix:semicolon
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|c_udp_pkt-&gt;data
op_plus
id|mbox_len
op_plus
id|even_bound
)paren
)paren
op_assign
id|temp
suffix:semicolon
id|temp
op_assign
(paren
id|udp_length
op_lshift
l_int|8
)paren
op_or
(paren
id|udp_length
op_rshift
l_int|8
)paren
suffix:semicolon
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|c_udp_pkt-&gt;data
op_plus
id|mbox_len
op_plus
id|even_bound
op_plus
l_int|2
)paren
)paren
op_assign
id|temp
suffix:semicolon
multiline_comment|/* calculate UDP checksum */
id|c_udp_pkt-&gt;udp_pkt.udp_checksum
op_assign
l_int|0
suffix:semicolon
id|c_udp_pkt-&gt;udp_pkt.udp_checksum
op_assign
id|calc_checksum
c_func
(paren
op_amp
id|data
(braket
id|UDP_OFFSET
)braket
comma
id|udp_length
op_plus
id|UDP_OFFSET
)paren
suffix:semicolon
multiline_comment|/* fill in IP length */
id|ip_length
op_assign
id|len
suffix:semicolon
id|temp
op_assign
(paren
id|ip_length
op_lshift
l_int|8
)paren
op_or
(paren
id|ip_length
op_rshift
l_int|8
)paren
suffix:semicolon
id|c_udp_pkt-&gt;ip_pkt.total_length
op_assign
id|temp
suffix:semicolon
multiline_comment|/* swap IP addresses */
id|ip_temp
op_assign
id|c_udp_pkt-&gt;ip_pkt.ip_src_address
suffix:semicolon
id|c_udp_pkt-&gt;ip_pkt.ip_src_address
op_assign
id|c_udp_pkt-&gt;ip_pkt.ip_dst_address
suffix:semicolon
id|c_udp_pkt-&gt;ip_pkt.ip_dst_address
op_assign
id|ip_temp
suffix:semicolon
multiline_comment|/* fill in IP checksum */
id|c_udp_pkt-&gt;ip_pkt.hdr_checksum
op_assign
l_int|0
suffix:semicolon
id|c_udp_pkt-&gt;ip_pkt.hdr_checksum
op_assign
id|calc_checksum
c_func
(paren
id|data
comma
r_sizeof
(paren
id|ip_pkt_t
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* reply_udp */
DECL|function|calc_checksum
r_int
r_int
id|calc_checksum
(paren
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|temp
suffix:semicolon
r_int
r_int
id|sum
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|temp
comma
op_amp
id|data
(braket
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
r_int
r_int
)paren
id|temp
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sum
op_rshift
l_int|16
)paren
(brace
id|sum
op_assign
(paren
id|sum
op_amp
l_int|0xffffUL
)paren
op_plus
(paren
id|sum
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
id|temp
op_assign
(paren
r_int
r_int
)paren
id|sum
suffix:semicolon
id|temp
op_assign
op_complement
id|temp
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_eq
l_int|0
)paren
(brace
id|temp
op_assign
l_int|0xffff
suffix:semicolon
)brace
r_return
id|temp
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get ethernet-style interface statistics.&n; * Return a pointer to struct enet_statistics.&n; */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
DECL|function|if_stats
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|sdla_t
op_star
id|my_card
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|my_card
op_assign
id|chdlc_priv_area-&gt;card
suffix:semicolon
r_return
op_amp
id|my_card-&gt;wandev.stats
suffix:semicolon
)brace
macro_line|#else
DECL|function|if_stats
r_static
r_struct
id|enet_statistics
op_star
id|if_stats
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|sdla_t
op_star
id|my_card
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|my_card
op_assign
id|chdlc_priv_area-&gt;card
suffix:semicolon
r_return
op_amp
id|my_card-&gt;wandev.stats
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/****** Cisco HDLC Firmware Interface Functions *******************************/
multiline_comment|/*============================================================================&n; * Read firmware code version.&n; *&t;Put code version as ASCII string in str. &n; */
DECL|function|chdlc_read_version
r_static
r_int
id|chdlc_read_version
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
id|err
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|READ_CHDLC_CODE_VERSION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
(brace
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|str
)paren
(brace
multiline_comment|/* is not null */
id|len
op_assign
id|mb-&gt;buffer_length
suffix:semicolon
id|memcpy
c_func
(paren
id|str
comma
id|mb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|str
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------------------&n; *  Configure CHDLC firmware.&n; */
DECL|function|chdlc_configure
r_static
r_int
id|chdlc_configure
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|err
suffix:semicolon
id|CHDLC_MAILBOX_STRUCT
op_star
id|mailbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|data_length
op_assign
r_sizeof
(paren
id|CHDLC_CONFIGURATION_STRUCT
)paren
suffix:semicolon
id|mailbox-&gt;buffer_length
op_assign
id|data_length
suffix:semicolon
id|memcpy
c_func
(paren
id|mailbox-&gt;data
comma
id|data
comma
id|data_length
)paren
suffix:semicolon
id|mailbox-&gt;command
op_assign
id|SET_CHDLC_CONFIGURATION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mailbox
)paren
ques
c_cond
id|mailbox-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
id|chdlc_error
(paren
id|card
comma
id|err
comma
id|mailbox
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set interrupt mode -- HDLC Version.&n; */
DECL|function|chdlc_set_intr_mode
r_static
r_int
id|chdlc_set_intr_mode
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|CHDLC_INT_TRIGGERS_STRUCT
op_star
id|int_data
op_assign
(paren
id|CHDLC_INT_TRIGGERS_STRUCT
op_star
)paren
id|mb-&gt;data
suffix:semicolon
r_int
id|err
suffix:semicolon
id|int_data-&gt;CHDLC_interrupt_triggers
op_assign
id|mode
suffix:semicolon
id|int_data-&gt;IRQ
op_assign
id|card-&gt;hw.irq
suffix:semicolon
id|int_data-&gt;interrupt_timer
op_assign
l_int|1
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
r_sizeof
(paren
id|CHDLC_INT_TRIGGERS_STRUCT
)paren
suffix:semicolon
id|mb-&gt;command
op_assign
id|SET_CHDLC_INTERRUPT_TRIGGERS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
id|chdlc_error
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*===========================================================&n; * chdlc_disable_comm_shutdown&n; *&n; * Shutdown() disables the communications. We must&n; * have a sparate functions, because we must not&n; * call chdlc_error() hander since the private&n; * area has already been replaced */
DECL|function|chdlc_disable_comm_shutdown
r_static
r_int
id|chdlc_disable_comm_shutdown
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|CHDLC_INT_TRIGGERS_STRUCT
op_star
id|int_data
op_assign
(paren
id|CHDLC_INT_TRIGGERS_STRUCT
op_star
)paren
id|mb-&gt;data
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Disable Interrutps */
id|int_data-&gt;CHDLC_interrupt_triggers
op_assign
l_int|0
suffix:semicolon
id|int_data-&gt;IRQ
op_assign
id|card-&gt;hw.irq
suffix:semicolon
id|int_data-&gt;interrupt_timer
op_assign
l_int|1
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
r_sizeof
(paren
id|CHDLC_INT_TRIGGERS_STRUCT
)paren
suffix:semicolon
id|mb-&gt;command
op_assign
id|SET_CHDLC_INTERRUPT_TRIGGERS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
multiline_comment|/* Disable Communications */
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
id|mb-&gt;command
op_assign
id|DISABLE_ASY_COMMUNICATIONS
suffix:semicolon
)brace
r_else
(brace
id|mb-&gt;command
op_assign
id|DISABLE_CHDLC_COMMUNICATIONS
suffix:semicolon
)brace
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
id|card-&gt;u.c.comm_enabled
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Enable communications.&n; */
DECL|function|chdlc_comm_enable
r_static
r_int
id|chdlc_comm_enable
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_int
id|err
suffix:semicolon
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|ENABLE_CHDLC_COMMUNICATIONS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_else
id|card-&gt;u.c.comm_enabled
op_assign
l_int|1
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Read communication error statistics.&n; */
DECL|function|chdlc_read_comm_err_stats
r_static
r_int
id|chdlc_read_comm_err_stats
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_int
id|err
suffix:semicolon
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|READ_COMMS_ERROR_STATS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Read CHDLC operational statistics.&n; */
DECL|function|chdlc_read_op_stats
r_static
r_int
id|chdlc_read_op_stats
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_int
id|err
suffix:semicolon
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|READ_CHDLC_OPERATIONAL_STATS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Update communications error and general packet statistics.&n; */
DECL|function|update_comms_stats
r_static
r_int
id|update_comms_stats
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|COMMS_ERROR_STATS_STRUCT
op_star
id|err_stats
suffix:semicolon
id|CHDLC_OPERATIONAL_STATS_STRUCT
op_star
id|op_stats
suffix:semicolon
multiline_comment|/* on the first timer interrupt, read the comms error statistics */
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;update_comms_stats
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|chdlc_read_comm_err_stats
c_func
(paren
id|card
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|err_stats
op_assign
(paren
id|COMMS_ERROR_STATS_STRUCT
op_star
)paren
id|mb-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_over_errors
op_assign
id|err_stats-&gt;Rx_overrun_err_count
suffix:semicolon
id|card-&gt;wandev.stats.rx_crc_errors
op_assign
id|err_stats-&gt;CRC_err_count
suffix:semicolon
id|card-&gt;wandev.stats.rx_frame_errors
op_assign
id|err_stats-&gt;Rx_abort_count
suffix:semicolon
id|card-&gt;wandev.stats.rx_fifo_errors
op_assign
id|err_stats-&gt;Rx_dis_pri_bfrs_full_count
suffix:semicolon
id|card-&gt;wandev.stats.rx_missed_errors
op_assign
id|card-&gt;wandev.stats.rx_fifo_errors
suffix:semicolon
id|card-&gt;wandev.stats.tx_aborted_errors
op_assign
id|err_stats-&gt;sec_Tx_abort_count
suffix:semicolon
)brace
multiline_comment|/* on the second timer interrupt, read the operational statistics */
r_else
(brace
r_if
c_cond
(paren
id|chdlc_read_op_stats
c_func
(paren
id|card
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|op_stats
op_assign
(paren
id|CHDLC_OPERATIONAL_STATS_STRUCT
op_star
)paren
id|mb-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_length_errors
op_assign
(paren
id|op_stats-&gt;Rx_Data_discard_short_count
op_plus
id|op_stats-&gt;Rx_Data_discard_long_count
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send packet.&n; *&t;Return:&t;0 - o.k.&n; *&t;&t;1 - no transmit buffers available&n; */
DECL|function|chdlc_send
r_static
r_int
id|chdlc_send
(paren
id|sdla_t
op_star
id|card
comma
r_void
op_star
id|data
comma
r_int
id|len
)paren
(brace
id|CHDLC_DATA_TX_STATUS_EL_STRUCT
op_star
id|txbuf
op_assign
id|card-&gt;u.c.txbuf
suffix:semicolon
r_if
c_cond
(paren
id|txbuf-&gt;opp_flag
)paren
r_return
l_int|1
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|txbuf-&gt;ptr_data_bfr
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|txbuf-&gt;frame_length
op_assign
id|len
suffix:semicolon
id|txbuf-&gt;opp_flag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* start transmission */
multiline_comment|/* Update transmit buffer control fields */
id|card-&gt;u.c.txbuf
op_assign
op_increment
id|txbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|txbuf
OG
id|card-&gt;u.c.txbuf_last
)paren
id|card-&gt;u.c.txbuf
op_assign
id|card-&gt;u.c.txbuf_base
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Firmware Error Handler **********************************************/
multiline_comment|/*============================================================================&n; * Firmware error handler.&n; *&t;This routine is called whenever firmware command returns non-zero&n; *&t;return code.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
DECL|function|chdlc_error
r_static
r_int
id|chdlc_error
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|err
comma
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
)paren
(brace
r_int
id|cmd
op_assign
id|mb-&gt;command
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
id|CMD_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: command 0x%02X timed out!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S514_BOTH_PORTS_SAME_CLK_MODE
suffix:colon
r_if
c_cond
(paren
id|cmd
op_eq
id|SET_CHDLC_CONFIGURATION
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Configure both ports for the same clock source&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: command 0x%02X returned 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|cmd
comma
id|err
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/********** Bottom Half Handlers ********************************************/
multiline_comment|/* NOTE: There is no API, BH support for Kernels lower than 2.2.X.&n; *       DO NOT INSERT ANY CODE HERE, NOTICE THE &n; *       PREPROCESSOR STATEMENT ABOVE, UNLESS YOU KNOW WHAT YOU ARE&n; *       DOING */
DECL|function|chdlc_bh
r_static
r_void
id|chdlc_bh
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
op_eq
l_int|0
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;tq_working
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
)paren
(brace
id|skb
op_assign
(paren
(paren
id|bh_data_t
op_star
)paren
op_amp
id|chan-&gt;bh_head
(braket
id|chan-&gt;bh_read
)braket
)paren
op_member_access_from_pointer
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;common.sk
op_eq
l_int|NULL
op_logical_or
id|chan-&gt;common.func
op_eq
l_int|NULL
)paren
(brace
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|chdlc_bh_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;common
dot
id|func
c_func
(paren
id|skb
comma
id|dev
comma
id|chan-&gt;common.sk
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Sock full cannot send, queue us for another&n;                                 * try */
id|atomic_set
c_func
(paren
op_amp
id|chan-&gt;common.receive_block
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|chdlc_bh_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|chdlc_bh_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;tq_working
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|chdlc_bh_cleanup
r_static
r_int
id|chdlc_bh_cleanup
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
(paren
(paren
id|bh_data_t
op_star
)paren
op_amp
id|chan-&gt;bh_head
(braket
id|chan-&gt;bh_read
)braket
)paren
op_member_access_from_pointer
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;bh_read
op_eq
id|MAX_BH_BUFF
)paren
(brace
id|chan-&gt;bh_read
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_increment
id|chan-&gt;bh_read
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bh_enqueue
r_static
r_int
id|bh_enqueue
(paren
id|netdevice_t
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* Check for full */
id|chdlc_private_area_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
op_eq
(paren
id|MAX_BH_BUFF
op_plus
l_int|1
)paren
)paren
(brace
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
(paren
(paren
id|bh_data_t
op_star
)paren
op_amp
id|chan-&gt;bh_head
(braket
id|chan-&gt;bh_write
)braket
)paren
op_member_access_from_pointer
id|skb
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;bh_write
op_eq
id|MAX_BH_BUFF
)paren
(brace
id|chan-&gt;bh_write
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_increment
id|chan-&gt;bh_write
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* END OF API BH Support */
macro_line|#endif
multiline_comment|/****** Interrupt Handlers **************************************************/
multiline_comment|/*============================================================================&n; * Cisco HDLC interrupt service routine.&n; */
DECL|function|wpc_isr
r_static
r_void
id|wpc_isr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sdla_t
op_star
id|my_card
suffix:semicolon
multiline_comment|/* Check for which port the interrupt has been generated&n;&t; * Since Secondary Port is piggybacking on the Primary&n;         * the check must be done here. &n;&t; */
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|flags-&gt;interrupt_info_struct.interrupt_type
)paren
(brace
multiline_comment|/* Check for a second port (piggybacking) */
r_if
c_cond
(paren
(paren
id|my_card
op_assign
id|card-&gt;next
)paren
)paren
(brace
id|flags
op_assign
id|my_card-&gt;u.c.flags
suffix:semicolon
r_if
c_cond
(paren
id|flags-&gt;interrupt_info_struct.interrupt_type
)paren
(brace
id|card
op_assign
id|my_card
suffix:semicolon
id|card
op_member_access_from_pointer
id|isr
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|1
suffix:semicolon
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
multiline_comment|/* If we get an interrupt with no network device, stop the interrupts&n;&t; * and issue an error */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;tty_opt
op_logical_and
op_logical_neg
id|dev
op_logical_and
id|flags-&gt;interrupt_info_struct.interrupt_type
op_ne
id|COMMAND_COMPLETE_APP_INT_PEND
)paren
(brace
r_goto
id|isr_done
suffix:semicolon
)brace
multiline_comment|/* if critical due to peripheral operations&n;&t; * ie. update() or getstats() then reset the interrupt and&n;&t; * wait for the board to retrigger.&n;&t; */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PERI_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ISR CRIT TO PERI&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|isr_done
suffix:semicolon
)brace
multiline_comment|/* On a 508 Card, if critical due to if_send &n;         * Major Error !!! */
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Critical while in ISR: %lx&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_type
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|flags-&gt;interrupt_info_struct.interrupt_type
)paren
(brace
r_case
id|RX_APP_INT_PEND
suffix:colon
multiline_comment|/* 0x01: receive interrupt */
id|rx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TX_APP_INT_PEND
suffix:colon
multiline_comment|/* 0x02: transmit interrupt */
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_and_assign
op_complement
id|APP_INT_ON_TX_FRAME
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
(brace
id|wanpipe_tty_trigger_poll
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_logical_and
id|is_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;u.c.usedby
op_eq
id|API
)paren
(brace
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|wakeup_sk_bh
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|wake_net_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
id|wake_net_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|COMMAND_COMPLETE_APP_INT_PEND
suffix:colon
multiline_comment|/* 0x04: cmd cplt */
op_increment
id|Intr_test_counter
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CHDLC_EXCEP_COND_APP_INT_PEND
suffix:colon
multiline_comment|/* 0x20 */
id|process_chdlc_exception
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GLOBAL_EXCEP_COND_APP_INT_PEND
suffix:colon
id|process_global_exception
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIMER_APP_INT_PEND
suffix:colon
id|timer_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: spurious interrupt 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|flags-&gt;interrupt_info_struct.interrupt_type
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Code name: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%c&quot;
comma
id|flags-&gt;global_info_struct.codename
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;nCode version: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%c&quot;
comma
id|flags-&gt;global_info_struct.codeversion
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|isr_done
suffix:colon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_type
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Receive interrupt handler.&n; */
DECL|function|rx_intr
r_static
r_void
id|rx_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
id|CHDLC_DATA_RX_STATUS_EL_STRUCT
op_star
id|rxbuf
op_assign
id|card-&gt;u.c.rxmb
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|addr
op_assign
id|rxbuf-&gt;ptr_data_bfr
suffix:semicolon
r_void
op_star
id|buf
suffix:semicolon
r_int
id|i
comma
id|udp_type
suffix:semicolon
r_if
c_cond
(paren
id|rxbuf-&gt;opp_flag
op_ne
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: corrupted Rx buffer @ 0x%X, flag = 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
(paren
r_int
)paren
id|rxbuf
comma
id|rxbuf-&gt;opp_flag
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Code name: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%c&quot;
comma
id|flags-&gt;global_info_struct.codename
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;nCode version: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%c&quot;
comma
id|flags-&gt;global_info_struct.codeversion
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Bug Fix: Mar 6 2000&n;                 * If we get a corrupted mailbox, it measn that driver &n;                 * is out of sync with the firmware. There is no recovery.&n;                 * If we don&squot;t turn off all interrupts for this card&n;                 * the machine will crash. &n;                 */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Critical router failure ...!!!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Please contact Sangoma Technologies !&bslash;n&quot;
)paren
suffix:semicolon
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|len
op_assign
id|rxbuf-&gt;frame_length
suffix:semicolon
macro_line|#if defined(LINUX_2_4) || defined(LINUX_2_1)&t;
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
(brace
r_if
c_cond
(paren
id|rxbuf-&gt;error_flag
)paren
(brace
r_goto
id|rx_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_le
id|CRC_LENGTH
)paren
(brace
r_goto
id|rx_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.c.async_mode
)paren
(brace
id|len
op_sub_assign
id|CRC_LENGTH
suffix:semicolon
)brace
id|wanpipe_tty_receive
c_func
(paren
id|card
comma
id|addr
comma
id|len
)paren
suffix:semicolon
r_goto
id|rx_exit
suffix:semicolon
)brace
macro_line|#endif
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
r_goto
id|rx_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_dev_running
c_func
(paren
id|dev
)paren
)paren
r_goto
id|rx_exit
suffix:semicolon
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Allocate socket buffer */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
r_goto
id|rx_exit
suffix:semicolon
)brace
multiline_comment|/* Copy data to the socket buffer */
r_if
c_cond
(paren
(paren
id|addr
op_plus
id|len
)paren
OG
id|card-&gt;u.c.rx_top
op_plus
l_int|1
)paren
(brace
r_int
id|tmp
op_assign
id|card-&gt;u.c.rx_top
op_minus
id|addr
op_plus
l_int|1
suffix:semicolon
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|tmp
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|buf
comma
id|tmp
)paren
suffix:semicolon
id|addr
op_assign
id|card-&gt;u.c.rx_base
suffix:semicolon
id|len
op_sub_assign
id|tmp
suffix:semicolon
)brace
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|card-&gt;wandev.stats.rx_packets
op_increment
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|card-&gt;wandev.stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
macro_line|#endif
id|udp_type
op_assign
id|udp_pkt_type
c_func
(paren
id|skb
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udp_type
op_eq
id|UDP_CPIPE_TYPE
)paren
(brace
r_if
c_cond
(paren
id|store_udp_mgmt_pkt
c_func
(paren
id|UDP_PKT_FRM_NETWORK
comma
id|card
comma
id|skb
comma
id|dev
comma
id|chdlc_priv_area
)paren
)paren
(brace
id|flags-&gt;interrupt_info_struct
dot
id|interrupt_permission
op_or_assign
id|APP_INT_ON_TIMER
suffix:semicolon
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;u.c.usedby
op_eq
id|API
)paren
(brace
id|api_rx_hdr_t
op_star
id|api_rx_hdr
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|api_rx_hdr_t
)paren
)paren
suffix:semicolon
id|api_rx_hdr
op_assign
(paren
id|api_rx_hdr_t
op_star
)paren
op_amp
id|skb-&gt;data
(braket
l_int|0x00
)braket
suffix:semicolon
id|api_rx_hdr-&gt;error_flag
op_assign
id|rxbuf-&gt;error_flag
suffix:semicolon
id|api_rx_hdr-&gt;time_stamp
op_assign
id|rxbuf-&gt;time_stamp
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|PVC_PROT
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|WAN_PACKET_DATA
suffix:semicolon
id|bh_enqueue
c_func
(paren
id|dev
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|chdlc_priv_area-&gt;tq_working
)paren
)paren
(brace
id|wanpipe_queue_tq
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;common.wanpipe_task
)paren
suffix:semicolon
id|wanpipe_mark_bh
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* FIXME: we should check to see if the received packet is a &n;                          multicast packet so that we can increment the multicast &n;                          statistic&n;                          ++ chdlc_priv_area-&gt;if_stats.multicast;&n;&t;&t;*/
multiline_comment|/* Pass it up the protocol stack */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|rx_exit
suffix:colon
multiline_comment|/* Release buffer element and calculate a pointer to the next one */
id|rxbuf-&gt;opp_flag
op_assign
l_int|0x00
suffix:semicolon
id|card-&gt;u.c.rxmb
op_assign
op_increment
id|rxbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|rxbuf
OG
id|card-&gt;u.c.rxbuf_last
)paren
(brace
id|card-&gt;u.c.rxmb
op_assign
id|card-&gt;u.c.rxbuf_base
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Timer interrupt handler.&n; * The timer interrupt is used for two purposes:&n; *    1) Processing udp calls from &squot;cpipemon&squot;.&n; *    2) Reading board-level statistics for updating the proc file system.&n; */
DECL|function|timer_intr
r_void
id|timer_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
l_int|NULL
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
)paren
op_eq
l_int|NULL
)paren
(brace
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_and_assign
op_complement
id|APP_INT_ON_TIMER
suffix:semicolon
r_return
suffix:semicolon
)brace
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;timer_int_enabled
op_amp
id|TMR_INT_ENABLED_CONFIG
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|config_chdlc
c_func
(paren
id|card
)paren
)paren
(brace
id|chdlc_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_CONFIG
suffix:semicolon
)brace
)brace
multiline_comment|/* process a udp call if pending */
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UDP
)paren
(brace
id|process_udp_mgmt_pkt
c_func
(paren
id|card
comma
id|dev
comma
id|chdlc_priv_area
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UDP
suffix:semicolon
)brace
multiline_comment|/* read the communications statistics if required */
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UPDATE
)paren
(brace
id|update_comms_stats
c_func
(paren
id|card
comma
id|chdlc_priv_area
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|chdlc_priv_area-&gt;update_comms_stats
)paren
)paren
(brace
id|chdlc_priv_area-&gt;timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UPDATE
suffix:semicolon
)brace
)brace
multiline_comment|/* only disable the timer interrupt if there are no udp or statistic */
multiline_comment|/* updates pending */
r_if
c_cond
(paren
op_logical_neg
id|chdlc_priv_area-&gt;timer_int_enabled
)paren
(brace
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_and_assign
op_complement
id|APP_INT_ON_TIMER
suffix:semicolon
)brace
)brace
multiline_comment|/*------------------------------------------------------------------------------&n;  Miscellaneous Functions&n;&t;- set_chdlc_config() used to set configuration options on the board&n;------------------------------------------------------------------------------*/
DECL|function|set_chdlc_config
r_static
r_int
id|set_chdlc_config
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|CHDLC_CONFIGURATION_STRUCT
id|cfg
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cfg
comma
l_int|0
comma
r_sizeof
(paren
id|CHDLC_CONFIGURATION_STRUCT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.clocking
)paren
(brace
id|cfg.baud_rate
op_assign
id|card-&gt;wandev.bps
suffix:semicolon
)brace
id|cfg.line_config_options
op_assign
(paren
id|card-&gt;wandev.interface
op_eq
id|WANOPT_RS232
)paren
ques
c_cond
id|INTERFACE_LEVEL_RS232
suffix:colon
id|INTERFACE_LEVEL_V35
suffix:semicolon
id|cfg.modem_config_options
op_assign
l_int|0
suffix:semicolon
id|cfg.modem_status_timer
op_assign
l_int|100
suffix:semicolon
id|cfg.CHDLC_protocol_options
op_assign
id|card-&gt;u.c.protocol_options
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
(brace
id|cfg.CHDLC_API_options
op_assign
id|DISCARD_RX_ERROR_FRAMES
suffix:semicolon
)brace
id|cfg.percent_data_buffer_for_Tx
op_assign
(paren
id|card-&gt;u.c.receive_only
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|50
suffix:semicolon
id|cfg.CHDLC_statistics_options
op_assign
(paren
id|CHDLC_TX_DATA_BYTE_COUNT_STAT
op_or
id|CHDLC_RX_DATA_BYTE_COUNT_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
(brace
id|card-&gt;wandev.mtu
op_assign
id|TTY_CHDLC_MAX_MTU
suffix:semicolon
)brace
id|cfg.max_CHDLC_data_field_length
op_assign
id|card-&gt;wandev.mtu
suffix:semicolon
id|cfg.transmit_keepalive_timer
op_assign
id|card-&gt;u.c.kpalv_tx
suffix:semicolon
id|cfg.receive_keepalive_timer
op_assign
id|card-&gt;u.c.kpalv_rx
suffix:semicolon
id|cfg.keepalive_error_tolerance
op_assign
id|card-&gt;u.c.kpalv_err
suffix:semicolon
id|cfg.SLARP_request_timer
op_assign
id|card-&gt;u.c.slarp_timer
suffix:semicolon
r_if
c_cond
(paren
id|cfg.SLARP_request_timer
)paren
(brace
id|cfg.IP_address
op_assign
l_int|0
suffix:semicolon
id|cfg.IP_netmask
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;wandev.dev
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_struct
id|in_device
op_star
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_ne
l_int|NULL
)paren
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_ne
l_int|NULL
)paren
(brace
id|cfg.IP_address
op_assign
id|ntohl
c_func
(paren
id|ifa-&gt;ifa_local
)paren
suffix:semicolon
id|cfg.IP_netmask
op_assign
id|ntohl
c_func
(paren
id|ifa-&gt;ifa_mask
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;IP_address
op_assign
id|ntohl
c_func
(paren
id|ifa-&gt;ifa_local
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;IP_netmask
op_assign
id|ntohl
c_func
(paren
id|ifa-&gt;ifa_mask
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
id|cfg.IP_address
op_assign
id|ntohl
c_func
(paren
id|dev-&gt;pa_addr
)paren
suffix:semicolon
id|cfg.IP_netmask
op_assign
id|ntohl
c_func
(paren
id|dev-&gt;pa_mask
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;IP_address
op_assign
id|ntohl
c_func
(paren
id|dev-&gt;pa_addr
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;IP_netmask
op_assign
id|ntohl
c_func
(paren
id|dev-&gt;pa_mask
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* FIXME: We must re-think this message in next release&n;&t;&t;if((cfg.IP_address &amp; 0x000000FF) &gt; 2) {&n;&t;&t;&t;printk(KERN_WARNING &quot;&bslash;n&quot;);&n;&t;                printk(KERN_WARNING &quot;  WARNING:%s configured with an&bslash;n&quot;,&n;&t;&t;&t;&t;card-&gt;devname);&n;&t;&t;&t;printk(KERN_WARNING &quot;  invalid local IP address.&bslash;n&quot;);&n;                        printk(KERN_WARNING &quot;  Slarp pragmatics will fail.&bslash;n&quot;);&n;                        printk(KERN_WARNING &quot;  IP address should be of the&bslash;n&quot;);&n;&t;&t;&t;printk(KERN_WARNING &quot;  format A.B.C.1 or A.B.C.2.&bslash;n&quot;);&n;&t;&t;}&n;&t;&t;*/
)brace
r_return
id|chdlc_configure
c_func
(paren
id|card
comma
op_amp
id|cfg
)paren
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------------------&n;   set_asy_config() used to set asynchronous configuration options on the board&n;------------------------------------------------------------------------------*/
DECL|function|set_asy_config
r_static
r_int
id|set_asy_config
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|ASY_CONFIGURATION_STRUCT
id|cfg
suffix:semicolon
id|CHDLC_MAILBOX_STRUCT
op_star
id|mailbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cfg
comma
l_int|0
comma
r_sizeof
(paren
id|ASY_CONFIGURATION_STRUCT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.clocking
)paren
(brace
id|cfg.baud_rate
op_assign
id|card-&gt;wandev.bps
suffix:semicolon
)brace
id|cfg.line_config_options
op_assign
(paren
id|card-&gt;wandev.interface
op_eq
id|WANOPT_RS232
)paren
ques
c_cond
id|INTERFACE_LEVEL_RS232
suffix:colon
id|INTERFACE_LEVEL_V35
suffix:semicolon
id|cfg.modem_config_options
op_assign
l_int|0
suffix:semicolon
id|cfg.asy_API_options
op_assign
id|card-&gt;u.c.api_options
suffix:semicolon
id|cfg.asy_protocol_options
op_assign
id|card-&gt;u.c.protocol_options
suffix:semicolon
id|cfg.Tx_bits_per_char
op_assign
id|card-&gt;u.c.tx_bits_per_char
suffix:semicolon
id|cfg.Rx_bits_per_char
op_assign
id|card-&gt;u.c.rx_bits_per_char
suffix:semicolon
id|cfg.stop_bits
op_assign
id|card-&gt;u.c.stop_bits
suffix:semicolon
id|cfg.parity
op_assign
id|card-&gt;u.c.parity
suffix:semicolon
id|cfg.break_timer
op_assign
id|card-&gt;u.c.break_timer
suffix:semicolon
id|cfg.asy_Rx_inter_char_timer
op_assign
id|card-&gt;u.c.inter_char_timer
suffix:semicolon
id|cfg.asy_Rx_complete_length
op_assign
id|card-&gt;u.c.rx_complete_length
suffix:semicolon
id|cfg.XON_char
op_assign
id|card-&gt;u.c.xon_char
suffix:semicolon
id|cfg.XOFF_char
op_assign
id|card-&gt;u.c.xoff_char
suffix:semicolon
id|cfg.asy_statistics_options
op_assign
(paren
id|CHDLC_TX_DATA_BYTE_COUNT_STAT
op_or
id|CHDLC_RX_DATA_BYTE_COUNT_STAT
)paren
suffix:semicolon
id|mailbox-&gt;buffer_length
op_assign
r_sizeof
(paren
id|ASY_CONFIGURATION_STRUCT
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mailbox-&gt;data
comma
op_amp
id|cfg
comma
id|mailbox-&gt;buffer_length
)paren
suffix:semicolon
id|mailbox-&gt;command
op_assign
id|SET_ASY_CONFIGURATION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mailbox
)paren
ques
c_cond
id|mailbox-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
id|chdlc_error
(paren
id|card
comma
id|err
comma
id|mailbox
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Enable asynchronous communications.&n; */
DECL|function|asy_comm_enable
r_static
r_int
id|asy_comm_enable
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_int
id|err
suffix:semicolon
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|ENABLE_ASY_COMMUNICATIONS
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
op_logical_and
id|card-&gt;wandev.dev
)paren
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|card-&gt;u.c.comm_enabled
op_assign
l_int|1
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Process global exception condition&n; */
DECL|function|process_global_exception
r_static
r_int
id|process_global_exception
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|mbox-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;command
op_assign
id|READ_GLOBAL_EXCEPTION_CONDITION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_TIMEOUT
)paren
(brace
r_switch
c_cond
(paren
id|mbox-&gt;return_code
)paren
(brace
r_case
id|EXCEP_MODEM_STATUS_CHANGE
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Modem status change&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mbox-&gt;data
(braket
l_int|0
)braket
op_amp
(paren
id|DCD_HIGH
op_or
id|CTS_HIGH
)paren
)paren
(brace
r_case
(paren
id|DCD_HIGH
)paren
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DCD high, CTS low&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|CTS_HIGH
)paren
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DCD low, CTS high&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
(paren
id|DCD_HIGH
op_or
id|CTS_HIGH
)paren
)paren
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DCD high, CTS high&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DCD low, CTS low&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXCEP_TRC_DISABLED
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Line trace disabled&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXCEP_IRQ_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IRQ timeout occurred&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x17
suffix:colon
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;tty
op_logical_and
id|card-&gt;tty_open
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Modem Hangup Exception: Hanging Up!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|tty_hangup
c_func
(paren
id|card-&gt;tty
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* If TTY is not used just drop throught */
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Global exception %x&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mbox-&gt;return_code
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Process chdlc exception condition&n; */
DECL|function|process_chdlc_exception
r_static
r_int
id|process_chdlc_exception
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|READ_CHDLC_EXCEPTION_CONDITION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_TIMEOUT
)paren
(brace
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
id|EXCEP_LINK_ACTIVE
suffix:colon
id|port_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
id|trigger_chdlc_poll
c_func
(paren
id|card-&gt;wandev.dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXCEP_LINK_INACTIVE_MODEM
suffix:colon
id|port_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|unconfigure_ip
c_func
(paren
id|card
)paren
suffix:semicolon
id|trigger_chdlc_poll
c_func
(paren
id|card-&gt;wandev.dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXCEP_LINK_INACTIVE_KPALV
suffix:colon
id|port_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Keepalive timer expired.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|unconfigure_ip
c_func
(paren
id|card
)paren
suffix:semicolon
id|trigger_chdlc_poll
c_func
(paren
id|card-&gt;wandev.dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXCEP_IP_ADDRESS_DISCOVERED
suffix:colon
r_if
c_cond
(paren
id|configure_ip
c_func
(paren
id|card
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXCEP_LOOPBACK_CONDITION
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Loopback Condition Detected.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NO_CHDLC_EXCEP_COND_TO_REPORT
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No exceptions reported.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Configure IP from SLARP negotiation&n; * This adds dynamic routes when SLARP has provided valid addresses&n; */
DECL|function|configure_ip
r_static
r_int
id|configure_ip
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
suffix:semicolon
r_char
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|0
suffix:semicolon
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* set to discover */
r_if
c_cond
(paren
id|card-&gt;u.c.slarp_timer
op_ne
l_int|0x00
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|CHDLC_CONFIGURATION_STRUCT
op_star
id|cfg
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|READ_CHDLC_CONFIGURATION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
(brace
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|cfg
op_assign
(paren
id|CHDLC_CONFIGURATION_STRUCT
op_star
)paren
id|mb-&gt;data
suffix:semicolon
id|chdlc_priv_area-&gt;IP_address
op_assign
id|cfg-&gt;IP_address
suffix:semicolon
id|chdlc_priv_area-&gt;IP_netmask
op_assign
id|cfg-&gt;IP_netmask
suffix:semicolon
multiline_comment|/* Set flag to add route */
id|chdlc_priv_area-&gt;route_status
op_assign
id|ADD_ROUTE
suffix:semicolon
multiline_comment|/* The idea here is to add the route in the poll routine.&n;&t;   &t;This way, we aren&squot;t in interrupt context when adding routes */
id|trigger_chdlc_poll
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Un-Configure IP negotiated by SLARP&n; * This removes dynamic routes when the link becomes inactive.&n; */
DECL|function|unconfigure_ip
r_static
r_int
id|unconfigure_ip
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|0
suffix:semicolon
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;route_status
op_eq
id|ROUTE_ADDED
)paren
(brace
multiline_comment|/* Note: If this function is called, the &n;                 * port state has been DISCONNECTED.  This state&n;                 * change will trigger a poll_disconnected &n;                 * function, that will check for this condition. &n;&t;&t; */
id|chdlc_priv_area-&gt;route_status
op_assign
id|REMOVE_ROUTE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Routine to add/remove routes &n; * Called like a polling routine when Routes are flagged to be added/removed.&n; */
DECL|function|process_route
r_static
r_void
id|process_route
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
r_int
r_char
id|port_num
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|local_IP_addr
op_assign
l_int|0
suffix:semicolon
id|u32
id|remote_IP_addr
op_assign
l_int|0
suffix:semicolon
id|u32
id|IP_netmask
comma
id|IP_addr
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
r_struct
id|ifreq
id|if_info
suffix:semicolon
r_struct
id|sockaddr_in
op_star
id|if_data1
comma
op_star
id|if_data2
suffix:semicolon
macro_line|#else
r_int
r_int
id|fs
op_assign
l_int|0
suffix:semicolon
r_struct
id|rtentry
id|route
suffix:semicolon
macro_line|#endif
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|port_num
op_assign
id|card-&gt;u.c.comm_port
suffix:semicolon
multiline_comment|/* Bug Fix Mar 16 2000&n;&t; * AND the IP address to the Mask before checking&n;         * the last two bits. */
r_if
c_cond
(paren
(paren
id|chdlc_priv_area-&gt;route_status
op_eq
id|ADD_ROUTE
)paren
op_logical_and
(paren
(paren
id|chdlc_priv_area-&gt;IP_address
op_amp
op_complement
id|chdlc_priv_area-&gt;IP_netmask
)paren
OG
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Dynamic route failure.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.slarp_timer
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Bad IP address %s received&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|ntohl
c_func
(paren
id|chdlc_priv_area-&gt;IP_address
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: from remote station.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Bad IP address %s issued&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|ntohl
c_func
(paren
id|chdlc_priv_area-&gt;IP_address
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: to remote station. Local&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IP address must be A.B.C.1&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: or A.B.C.2.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
multiline_comment|/* remove the route due to the IP address error condition */
id|chdlc_priv_area-&gt;route_status
op_assign
id|REMOVE_ROUTE
suffix:semicolon
id|err
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If we are removing a route with bad IP addressing, then use the */
multiline_comment|/* locally configured IP addresses */
r_if
c_cond
(paren
(paren
id|chdlc_priv_area-&gt;route_status
op_eq
id|REMOVE_ROUTE
)paren
op_logical_and
id|err
)paren
(brace
multiline_comment|/* do not remove a bad route that has already been removed */
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;route_removed
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_ne
l_int|NULL
)paren
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_ne
l_int|NULL
)paren
(brace
id|local_IP_addr
op_assign
id|ifa-&gt;ifa_local
suffix:semicolon
id|IP_netmask
op_assign
id|ifa-&gt;ifa_mask
suffix:semicolon
)brace
)brace
macro_line|#else
id|local_IP_addr
op_assign
id|dev-&gt;pa_addr
suffix:semicolon
id|remote_IP_addr
op_assign
id|dev-&gt;pa_dstaddr
suffix:semicolon
id|IP_netmask
op_assign
id|dev-&gt;pa_mask
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* According to Cisco HDLC, if the point-to-point address is&n;&t;&t;   A.B.C.1, then we are the opposite (A.B.C.2), and vice-versa.&n;&t;&t;*/
id|IP_netmask
op_assign
id|ntohl
c_func
(paren
id|chdlc_priv_area-&gt;IP_netmask
)paren
suffix:semicolon
id|remote_IP_addr
op_assign
id|ntohl
c_func
(paren
id|chdlc_priv_area-&gt;IP_address
)paren
suffix:semicolon
multiline_comment|/* If Netmask is 255.255.255.255 the local address&n;                 * calculation will fail. Default it back to 255.255.255.0 */
r_if
c_cond
(paren
id|IP_netmask
op_eq
l_int|0xffffffff
)paren
id|IP_netmask
op_and_assign
l_int|0x00ffffff
suffix:semicolon
multiline_comment|/* Bug Fix Mar 16 2000&n;&t;&t; * AND the Remote IP address with IP netmask, instead&n;                 * of static netmask of 255.255.255.0 */
id|local_IP_addr
op_assign
(paren
id|remote_IP_addr
op_amp
id|IP_netmask
)paren
op_plus
(paren
op_complement
id|remote_IP_addr
op_amp
id|ntohl
c_func
(paren
l_int|0x0003
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.c.slarp_timer
)paren
(brace
id|IP_addr
op_assign
id|local_IP_addr
suffix:semicolon
id|local_IP_addr
op_assign
id|remote_IP_addr
suffix:semicolon
id|remote_IP_addr
op_assign
id|IP_addr
suffix:semicolon
)brace
)brace
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Save file system  */
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Get user space block */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/* Setup a structure for adding/removing routes */
id|memset
c_func
(paren
op_amp
id|if_info
comma
l_int|0
comma
r_sizeof
(paren
id|if_info
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|if_info.ifr_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Setup a structure for adding/removing routes */
id|dev-&gt;pa_mask
op_assign
id|IP_netmask
suffix:semicolon
id|dev-&gt;pa_dstaddr
op_assign
id|remote_IP_addr
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
id|local_IP_addr
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|route
comma
l_int|0
comma
r_sizeof
(paren
id|route
)paren
)paren
suffix:semicolon
id|route.rt_dev
op_assign
id|dev-&gt;name
suffix:semicolon
id|route.rt_flags
op_assign
l_int|0
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_dst
)paren
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
op_assign
id|dev-&gt;pa_dstaddr
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_dst
)paren
)paren
op_member_access_from_pointer
id|sin_family
op_assign
id|AF_INET
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_genmask
)paren
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_genmask
)paren
)paren
op_member_access_from_pointer
id|sin_family
op_assign
id|AF_INET
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|chdlc_priv_area-&gt;route_status
)paren
(brace
r_case
id|ADD_ROUTE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.c.slarp_timer
)paren
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|if_data2
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_dstaddr
suffix:semicolon
id|if_data2-&gt;sin_addr.s_addr
op_assign
id|remote_IP_addr
suffix:semicolon
id|if_data2-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFDSTADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
macro_line|#else
id|err
op_assign
id|ip_rt_new
c_func
(paren
op_amp
id|route
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|if_data1
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_addr
suffix:semicolon
id|if_data1-&gt;sin_addr.s_addr
op_assign
id|local_IP_addr
suffix:semicolon
id|if_data1-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFADDR
comma
op_amp
id|if_info
)paren
)paren
)paren
(brace
id|if_data2
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_dstaddr
suffix:semicolon
id|if_data2-&gt;sin_addr.s_addr
op_assign
id|remote_IP_addr
suffix:semicolon
id|if_data2-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFDSTADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
)brace
macro_line|#else
id|err
op_assign
id|ip_rt_new
c_func
(paren
op_amp
id|route
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Add route %s failed (%d)&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|remote_IP_addr
)paren
comma
id|err
)paren
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
id|chdlc_private_area_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|route_status
op_assign
id|ROUTE_ADDED
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Dynamic route added.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:    Local IP addr : %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|local_IP_addr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:    Remote IP addr: %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|remote_IP_addr
)paren
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;route_removed
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REMOVE_ROUTE
suffix:colon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/* Change the local ip address of the interface to 0.&n;&t;&t; * This will also delete the destination route.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.c.slarp_timer
)paren
(brace
id|if_data2
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_dstaddr
suffix:semicolon
id|if_data2-&gt;sin_addr.s_addr
op_assign
l_int|0
suffix:semicolon
id|if_data2-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFDSTADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
)brace
r_else
(brace
id|if_data1
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_addr
suffix:semicolon
id|if_data1-&gt;sin_addr.s_addr
op_assign
l_int|0
suffix:semicolon
id|if_data1-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* set the point-to-point IP address to 0.0.0.0 */
id|dev-&gt;pa_dstaddr
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|ip_rt_kill
c_func
(paren
op_amp
id|route
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Remove route %s failed, (err %d)&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|remote_IP_addr
)paren
comma
id|err
)paren
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
id|chdlc_private_area_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|route_status
op_assign
id|NO_ROUTE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Dynamic route removed: %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|in_ntoa
c_func
(paren
id|local_IP_addr
)paren
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;route_removed
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
multiline_comment|/* Restore file system */
)brace
multiline_comment|/*=============================================================================&n; * Store a UDP management packet for later processing.&n; */
DECL|function|store_udp_mgmt_pkt
r_static
r_int
id|store_udp_mgmt_pkt
c_func
(paren
r_char
id|udp_pkt_src
comma
id|sdla_t
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
comma
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
)paren
(brace
r_int
id|udp_pkt_stored
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chdlc_priv_area-&gt;udp_pkt_lgth
op_logical_and
(paren
id|skb-&gt;len
op_le
id|MAX_LGTH_UDP_MGNT_PKT
)paren
)paren
(brace
id|chdlc_priv_area-&gt;udp_pkt_lgth
op_assign
id|skb-&gt;len
suffix:semicolon
id|chdlc_priv_area-&gt;udp_pkt_src
op_assign
id|udp_pkt_src
suffix:semicolon
id|memcpy
c_func
(paren
id|chdlc_priv_area-&gt;udp_pkt_data
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;timer_int_enabled
op_assign
id|TMR_INT_ENABLED_UDP
suffix:semicolon
id|udp_pkt_stored
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|udp_pkt_src
op_eq
id|UDP_PKT_FRM_STACK
)paren
(brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_else
(brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
r_return
id|udp_pkt_stored
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Process UDP management packet.&n; */
DECL|function|process_udp_mgmt_pkt
r_static
r_int
id|process_udp_mgmt_pkt
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
comma
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
)paren
(brace
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
r_int
id|frames
comma
id|len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
r_int
r_int
id|buffer_length
comma
id|real_len
suffix:semicolon
r_int
r_int
id|data_ptr
suffix:semicolon
r_int
id|data_length
suffix:semicolon
r_int
id|udp_mgmt_req_valid
op_assign
l_int|1
suffix:semicolon
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
id|chdlc_udp_pkt_t
op_star
id|chdlc_udp_pkt
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_int
id|err
suffix:semicolon
r_char
id|ut_char
suffix:semicolon
id|chdlc_udp_pkt
op_assign
(paren
id|chdlc_udp_pkt_t
op_star
)paren
id|chdlc_priv_area-&gt;udp_pkt_data
suffix:semicolon
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;udp_pkt_src
op_eq
id|UDP_PKT_FRM_NETWORK
)paren
(brace
multiline_comment|/* Only these commands are support for remote debugging.&n;&t;&t; * All others are not */
r_switch
c_cond
(paren
id|chdlc_udp_pkt-&gt;cblock.command
)paren
(brace
r_case
id|READ_GLOBAL_STATISTICS
suffix:colon
r_case
id|READ_MODEM_STATUS
suffix:colon
r_case
id|READ_CHDLC_LINK_STATUS
suffix:colon
r_case
id|CPIPE_ROUTER_UP_TIME
suffix:colon
r_case
id|READ_COMMS_ERROR_STATS
suffix:colon
r_case
id|READ_CHDLC_OPERATIONAL_STATS
suffix:colon
multiline_comment|/* These two commands are executed for&n;&t;&t;&t; * each request */
r_case
id|READ_CHDLC_CONFIGURATION
suffix:colon
r_case
id|READ_CHDLC_CODE_VERSION
suffix:colon
id|udp_mgmt_req_valid
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|udp_mgmt_req_valid
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|udp_mgmt_req_valid
)paren
(brace
multiline_comment|/* set length to 0 */
id|chdlc_udp_pkt-&gt;cblock.buffer_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set return code */
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
l_int|0xCD
suffix:semicolon
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Warning, Illegal UDP command attempted from network: %x&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chdlc_udp_pkt-&gt;cblock.command
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
r_int
id|trace_status_cfg_addr
op_assign
l_int|0
suffix:semicolon
id|TRACE_STATUS_EL_CFG_STRUCT
id|trace_cfg_struct
suffix:semicolon
id|TRACE_STATUS_ELEMENT_STRUCT
id|trace_element_struct
suffix:semicolon
r_switch
c_cond
(paren
id|chdlc_udp_pkt-&gt;cblock.command
)paren
(brace
r_case
id|CPIPE_ENABLE_TRACING
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|chdlc_priv_area-&gt;TracingEnabled
)paren
(brace
multiline_comment|/* OPERATE_DATALINE_MONITOR */
id|mb-&gt;buffer_length
op_assign
r_sizeof
(paren
id|LINE_TRACE_CONFIG_STRUCT
)paren
suffix:semicolon
id|mb-&gt;command
op_assign
id|SET_TRACE_CONFIGURATION
suffix:semicolon
(paren
(paren
id|LINE_TRACE_CONFIG_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|trace_config
op_assign
id|TRACE_ACTIVE
suffix:semicolon
multiline_comment|/* Trace delay mode is not used because it slows&n;&t;&t;&t;   down transfer and results in a standoff situation&n;&t;&t;&t;   when there is a lot of data */
multiline_comment|/* Configure the Trace based on user inputs */
(paren
(paren
id|LINE_TRACE_CONFIG_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|trace_config
op_or_assign
id|chdlc_udp_pkt-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|LINE_TRACE_CONFIG_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|trace_deactivation_timer
op_assign
l_int|4000
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
(brace
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
id|card-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
id|err
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Get the base address of the trace element list */
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|READ_TRACE_CONFIGURATION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
(brace
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
id|err
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|trace_status_cfg_addr
op_assign
(paren
(paren
id|LINE_TRACE_CONFIG_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|ptr_trace_stat_el_cfg_struct
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|trace_status_cfg_addr
comma
op_amp
id|trace_cfg_struct
comma
r_sizeof
(paren
id|trace_cfg_struct
)paren
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;start_trace_addr
op_assign
id|trace_cfg_struct
dot
id|base_addr_trace_status_elements
suffix:semicolon
id|chdlc_priv_area-&gt;number_trace_elements
op_assign
id|trace_cfg_struct.number_trace_status_elements
suffix:semicolon
id|chdlc_priv_area-&gt;end_trace_addr
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|TRACE_STATUS_ELEMENT_STRUCT
op_star
)paren
id|chdlc_priv_area-&gt;start_trace_addr
op_plus
(paren
id|chdlc_priv_area-&gt;number_trace_elements
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;base_addr_trace_buffer
op_assign
id|trace_cfg_struct.base_addr_trace_buffer
suffix:semicolon
id|chdlc_priv_area-&gt;end_addr_trace_buffer
op_assign
id|trace_cfg_struct.end_addr_trace_buffer
suffix:semicolon
id|chdlc_priv_area-&gt;curr_trace_addr
op_assign
id|trace_cfg_struct.next_trace_element_to_use
suffix:semicolon
id|chdlc_priv_area-&gt;available_buffer_space
op_assign
l_int|2000
op_minus
r_sizeof
(paren
id|ip_pkt_t
)paren
op_minus
r_sizeof
(paren
id|udp_pkt_t
)paren
op_minus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_minus
r_sizeof
(paren
id|cblock_t
)paren
op_minus
r_sizeof
(paren
id|trace_info_t
)paren
suffix:semicolon
)brace
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
id|COMMAND_OK
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|chdlc_priv_area-&gt;TracingEnabled
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIPE_DISABLE_TRACING
suffix:colon
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;TracingEnabled
)paren
(brace
multiline_comment|/* OPERATE_DATALINE_MONITOR */
id|mb-&gt;buffer_length
op_assign
r_sizeof
(paren
id|LINE_TRACE_CONFIG_STRUCT
)paren
suffix:semicolon
id|mb-&gt;command
op_assign
id|SET_TRACE_CONFIGURATION
suffix:semicolon
(paren
(paren
id|LINE_TRACE_CONFIG_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|trace_config
op_assign
id|TRACE_INACTIVE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
id|chdlc_priv_area-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
id|COMMAND_OK
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIPE_GET_TRACE_INFO
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|chdlc_priv_area-&gt;TracingEnabled
)paren
(brace
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
l_int|1
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|chdlc_udp_pkt-&gt;trace_info.ismoredata
op_assign
l_int|0x00
suffix:semicolon
id|buffer_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* offset of packet already occupied */
r_for
c_loop
(paren
id|frames
op_assign
l_int|0
suffix:semicolon
id|frames
OL
id|chdlc_priv_area-&gt;number_trace_elements
suffix:semicolon
id|frames
op_increment
)paren
(brace
id|trace_pkt_t
op_star
id|trace_pkt
op_assign
(paren
id|trace_pkt_t
op_star
)paren
op_amp
id|chdlc_udp_pkt-&gt;data
(braket
id|buffer_length
)braket
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|chdlc_priv_area-&gt;curr_trace_addr
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|trace_element_struct
comma
r_sizeof
(paren
id|TRACE_STATUS_ELEMENT_STRUCT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trace_element_struct.opp_flag
op_eq
l_int|0x00
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* get pointer to real data */
id|data_ptr
op_assign
id|trace_element_struct.ptr_data_bfr
suffix:semicolon
multiline_comment|/* See if there is actual data on the trace buffer */
r_if
c_cond
(paren
id|data_ptr
)paren
(brace
id|data_length
op_assign
id|trace_element_struct.trace_length
suffix:semicolon
)brace
r_else
(brace
id|data_length
op_assign
l_int|0
suffix:semicolon
id|chdlc_udp_pkt-&gt;trace_info.ismoredata
op_assign
l_int|0x01
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|chdlc_priv_area-&gt;available_buffer_space
op_minus
id|buffer_length
)paren
OL
(paren
r_sizeof
(paren
id|trace_pkt_t
)paren
op_plus
id|data_length
)paren
)paren
(brace
multiline_comment|/* indicate there are more frames on board &amp; exit */
id|chdlc_udp_pkt-&gt;trace_info.ismoredata
op_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
)brace
id|trace_pkt-&gt;status
op_assign
id|trace_element_struct.trace_type
suffix:semicolon
id|trace_pkt-&gt;time_stamp
op_assign
id|trace_element_struct.trace_time_stamp
suffix:semicolon
id|trace_pkt-&gt;real_length
op_assign
id|trace_element_struct.trace_length
suffix:semicolon
multiline_comment|/* see if we can fit the frame into the user buffer */
id|real_len
op_assign
id|trace_pkt-&gt;real_length
suffix:semicolon
r_if
c_cond
(paren
id|data_ptr
op_eq
l_int|0
)paren
(brace
id|trace_pkt-&gt;data_avail
op_assign
l_int|0x00
suffix:semicolon
)brace
r_else
(brace
r_int
id|tmp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* get the data from circular buffer&n;&t;&t;&t;&t;    must check for end of buffer */
id|trace_pkt-&gt;data_avail
op_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data_ptr
op_plus
id|real_len
)paren
OG
id|chdlc_priv_area-&gt;end_addr_trace_buffer
op_plus
l_int|1
)paren
(brace
id|tmp
op_assign
id|chdlc_priv_area-&gt;end_addr_trace_buffer
op_minus
id|data_ptr
op_plus
l_int|1
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|data_ptr
comma
id|trace_pkt-&gt;data
comma
id|tmp
)paren
suffix:semicolon
id|data_ptr
op_assign
id|chdlc_priv_area-&gt;base_addr_trace_buffer
suffix:semicolon
)brace
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|data_ptr
comma
op_amp
id|trace_pkt-&gt;data
(braket
id|tmp
)braket
comma
id|real_len
op_minus
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* zero the opp flag to show we got the frame */
id|ut_char
op_assign
l_int|0x00
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|chdlc_priv_area-&gt;curr_trace_addr
comma
op_amp
id|ut_char
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* now move onto the next frame */
id|chdlc_priv_area-&gt;curr_trace_addr
op_add_assign
r_sizeof
(paren
id|TRACE_STATUS_ELEMENT_STRUCT
)paren
suffix:semicolon
multiline_comment|/* check if we went over the last address */
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;curr_trace_addr
OG
id|chdlc_priv_area-&gt;end_trace_addr
)paren
(brace
id|chdlc_priv_area-&gt;curr_trace_addr
op_assign
id|chdlc_priv_area-&gt;start_trace_addr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|trace_pkt-&gt;data_avail
op_eq
l_int|0x01
)paren
(brace
id|buffer_length
op_add_assign
id|real_len
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* for the header */
id|buffer_length
op_add_assign
r_sizeof
(paren
id|trace_pkt_t
)paren
suffix:semicolon
)brace
multiline_comment|/* For Loop */
r_if
c_cond
(paren
id|frames
op_eq
id|chdlc_priv_area-&gt;number_trace_elements
)paren
(brace
id|chdlc_udp_pkt-&gt;trace_info.ismoredata
op_assign
l_int|0x01
suffix:semicolon
)brace
id|chdlc_udp_pkt-&gt;trace_info.num_frames
op_assign
id|frames
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
id|buffer_length
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.buffer_length
op_assign
id|buffer_length
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
id|COMMAND_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIPE_FT1_READ_STATUS
suffix:colon
(paren
(paren
r_int
r_char
op_star
)paren
id|chdlc_udp_pkt-&gt;data
)paren
(braket
l_int|0
)braket
op_assign
id|flags-&gt;FT1_info_struct.parallel_port_A_input
suffix:semicolon
(paren
(paren
r_int
r_char
op_star
)paren
id|chdlc_udp_pkt-&gt;data
)paren
(braket
l_int|1
)braket
op_assign
id|flags-&gt;FT1_info_struct.parallel_port_B_input
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
id|COMMAND_OK
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.buffer_length
op_assign
l_int|2
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPIPE_ROUTER_UP_TIME
suffix:colon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;router_up_time
op_assign
id|tv.tv_sec
op_minus
id|chdlc_priv_area-&gt;router_start_time
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|chdlc_udp_pkt-&gt;data
op_assign
id|chdlc_priv_area-&gt;router_up_time
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.buffer_length
op_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|chdlc_udp_pkt-&gt;cblock.return_code
op_assign
id|COMMAND_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FT1_MONITOR_STATUS_CTRL
suffix:colon
multiline_comment|/* Enable FT1 MONITOR STATUS */
r_if
c_cond
(paren
(paren
id|chdlc_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_amp
id|ENABLE_READ_FT1_STATUS
)paren
op_logical_or
(paren
id|chdlc_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_amp
id|ENABLE_READ_FT1_OP_STATS
)paren
)paren
(brace
r_if
c_cond
(paren
id|rCount
op_increment
op_ne
l_int|0
)paren
(brace
id|chdlc_udp_pkt-&gt;cblock
dot
id|return_code
op_assign
id|COMMAND_OK
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Disable FT1 MONITOR STATUS */
r_if
c_cond
(paren
id|chdlc_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|rCount
op_ne
l_int|0
)paren
(brace
id|chdlc_udp_pkt-&gt;cblock
dot
id|return_code
op_assign
id|COMMAND_OK
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_goto
id|dflt_1
suffix:semicolon
r_default
suffix:colon
id|dflt_1
suffix:colon
multiline_comment|/* it&squot;s a board command */
id|mb-&gt;command
op_assign
id|chdlc_udp_pkt-&gt;cblock.command
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
id|chdlc_udp_pkt-&gt;cblock.buffer_length
suffix:semicolon
r_if
c_cond
(paren
id|mb-&gt;buffer_length
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|mb-&gt;data
comma
(paren
r_int
r_char
op_star
)paren
id|chdlc_udp_pkt
op_member_access_from_pointer
id|data
comma
id|mb-&gt;buffer_length
)paren
suffix:semicolon
)brace
multiline_comment|/* run the command on the board */
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* copy the result back to our buffer */
id|memcpy
c_func
(paren
op_amp
id|chdlc_udp_pkt-&gt;cblock
comma
id|mb
comma
r_sizeof
(paren
id|cblock_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb-&gt;buffer_length
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|chdlc_udp_pkt-&gt;data
comma
op_amp
id|mb-&gt;data
comma
id|mb-&gt;buffer_length
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end of switch */
)brace
multiline_comment|/* end of else */
multiline_comment|/* Fill UDP TTL */
id|chdlc_udp_pkt-&gt;ip_pkt.ttl
op_assign
id|card-&gt;wandev.ttl
suffix:semicolon
id|len
op_assign
id|reply_udp
c_func
(paren
id|chdlc_priv_area-&gt;udp_pkt_data
comma
id|mb-&gt;buffer_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;udp_pkt_src
op_eq
id|UDP_PKT_FRM_NETWORK
)paren
(brace
multiline_comment|/* Must check if we interrupted if_send() routine. The&n;&t;&t; * tx buffers might be used. If so drop the packet */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|SEND_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|chdlc_send
c_func
(paren
id|card
comma
id|chdlc_priv_area-&gt;udp_pkt_data
comma
id|len
)paren
)paren
(brace
op_increment
id|card-&gt;wandev.stats.tx_packets
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|card-&gt;wandev.stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Pass it up the stack&n;    &t;&t;   Allocate socket buffer */
r_if
c_cond
(paren
(paren
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* copy data into new_skb */
id|buf
op_assign
id|skb_put
c_func
(paren
id|new_skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|chdlc_priv_area-&gt;udp_pkt_data
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Decapsulate pkt and pass it up the protocol stack */
id|new_skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|new_skb-&gt;mac.raw
op_assign
id|new_skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|new_skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
id|chdlc_priv_area-&gt;udp_pkt_lgth
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Initialize Receive and Transmit Buffers.&n; */
DECL|function|init_chdlc_tx_rx_buff
r_static
r_void
id|init_chdlc_tx_rx_buff
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
id|CHDLC_TX_STATUS_EL_CFG_STRUCT
op_star
id|tx_config
suffix:semicolon
id|CHDLC_RX_STATUS_EL_CFG_STRUCT
op_star
id|rx_config
suffix:semicolon
r_char
id|err
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|READ_CHDLC_CONFIGURATION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.dev
)paren
(brace
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|tx_config
op_assign
(paren
id|CHDLC_TX_STATUS_EL_CFG_STRUCT
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
(paren
(paren
id|CHDLC_CONFIGURATION_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|ptr_CHDLC_Tx_stat_el_cfg_struct
)paren
)paren
suffix:semicolon
id|rx_config
op_assign
(paren
id|CHDLC_RX_STATUS_EL_CFG_STRUCT
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
(paren
(paren
id|CHDLC_CONFIGURATION_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|ptr_CHDLC_Rx_stat_el_cfg_struct
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup Head and Tails for buffers */
id|card-&gt;u.c.txbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|tx_config-&gt;base_addr_Tx_status_elements
)paren
suffix:semicolon
id|card-&gt;u.c.txbuf_last
op_assign
(paren
id|CHDLC_DATA_TX_STATUS_EL_STRUCT
op_star
)paren
id|card-&gt;u.c.txbuf_base
op_plus
(paren
id|tx_config-&gt;number_Tx_status_elements
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;u.c.rxbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|rx_config-&gt;base_addr_Rx_status_elements
)paren
suffix:semicolon
id|card-&gt;u.c.rxbuf_last
op_assign
(paren
id|CHDLC_DATA_RX_STATUS_EL_STRUCT
op_star
)paren
id|card-&gt;u.c.rxbuf_base
op_plus
(paren
id|rx_config-&gt;number_Rx_status_elements
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Set up next pointer to be used */
id|card-&gt;u.c.txbuf
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|tx_config-&gt;next_Tx_status_element_to_use
)paren
suffix:semicolon
id|card-&gt;u.c.rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|rx_config-&gt;next_Rx_status_element_to_use
)paren
suffix:semicolon
)brace
r_else
(brace
id|tx_config
op_assign
(paren
id|CHDLC_TX_STATUS_EL_CFG_STRUCT
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
(paren
(paren
id|CHDLC_CONFIGURATION_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|ptr_CHDLC_Tx_stat_el_cfg_struct
op_mod
id|SDLA_WINDOWSIZE
)paren
)paren
suffix:semicolon
id|rx_config
op_assign
(paren
id|CHDLC_RX_STATUS_EL_CFG_STRUCT
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
(paren
(paren
id|CHDLC_CONFIGURATION_STRUCT
op_star
)paren
id|mb-&gt;data
)paren
op_member_access_from_pointer
id|ptr_CHDLC_Rx_stat_el_cfg_struct
op_mod
id|SDLA_WINDOWSIZE
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup Head and Tails for buffers */
id|card-&gt;u.c.txbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|tx_config-&gt;base_addr_Tx_status_elements
op_mod
id|SDLA_WINDOWSIZE
)paren
)paren
suffix:semicolon
id|card-&gt;u.c.txbuf_last
op_assign
(paren
id|CHDLC_DATA_TX_STATUS_EL_STRUCT
op_star
)paren
id|card-&gt;u.c.txbuf_base
op_plus
(paren
id|tx_config-&gt;number_Tx_status_elements
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;u.c.rxbuf_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|rx_config-&gt;base_addr_Rx_status_elements
op_mod
id|SDLA_WINDOWSIZE
)paren
)paren
suffix:semicolon
id|card-&gt;u.c.rxbuf_last
op_assign
(paren
id|CHDLC_DATA_RX_STATUS_EL_STRUCT
op_star
)paren
id|card-&gt;u.c.rxbuf_base
op_plus
(paren
id|rx_config-&gt;number_Rx_status_elements
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Set up next pointer to be used */
id|card-&gt;u.c.txbuf
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|tx_config-&gt;next_Tx_status_element_to_use
op_mod
id|SDLA_WINDOWSIZE
)paren
)paren
suffix:semicolon
id|card-&gt;u.c.rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|rx_config-&gt;next_Rx_status_element_to_use
op_mod
id|SDLA_WINDOWSIZE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup Actual Buffer Start and end addresses */
id|card-&gt;u.c.rx_base
op_assign
id|rx_config-&gt;base_addr_Rx_buffer
suffix:semicolon
id|card-&gt;u.c.rx_top
op_assign
id|rx_config-&gt;end_addr_Rx_buffer
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Perform Interrupt Test by running READ_CHDLC_CODE_VERSION command MAX_INTR&n; * _TEST_COUNTER times.&n; */
DECL|function|intr_test
r_static
r_int
id|intr_test
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
id|Intr_test_counter
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
id|APP_INT_ON_COMMAND_COMPLETE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|CMD_OK
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_INTR_TEST_COUNTER
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mb-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;command
op_assign
id|READ_CHDLC_CODE_VERSION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|chdlc_error
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Determine what type of UDP call it is. CPIPEAB ?&n; */
DECL|function|udp_pkt_type
r_static
r_int
id|udp_pkt_type
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|sdla_t
op_star
id|card
)paren
(brace
id|chdlc_udp_pkt_t
op_star
id|chdlc_udp_pkt
op_assign
(paren
id|chdlc_udp_pkt_t
op_star
)paren
id|skb-&gt;data
suffix:semicolon
macro_line|#ifdef _WAN_UDP_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SIG %s = %s&bslash;n&bslash;&n;&t;&t;&t;&t;  UPP %x = %x&bslash;n&bslash;&n;&t;&t;&t;&t;  PRT %x = %x&bslash;n&bslash;&n;&t;&t;&t;&t;  REQ %i = %i&bslash;n&bslash;&n;&t;&t;&t;&t;  36 th = %x 37th = %x&bslash;n&quot;
comma
id|chdlc_udp_pkt-&gt;wp_mgmt.signature
comma
id|UDPMGMT_SIGNATURE
comma
id|chdlc_udp_pkt-&gt;udp_pkt.udp_dst_port
comma
id|ntohs
c_func
(paren
id|card-&gt;wandev.udp_port
)paren
comma
id|chdlc_udp_pkt-&gt;ip_pkt.protocol
comma
id|UDPMGMT_UDP_PROTOCOL
comma
id|chdlc_udp_pkt-&gt;wp_mgmt.request_reply
comma
id|UDPMGMT_REQUEST
comma
id|skb-&gt;data
(braket
l_int|36
)braket
comma
id|skb-&gt;data
(braket
l_int|37
)braket
)paren
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|chdlc_udp_pkt-&gt;wp_mgmt.signature
comma
id|UDPMGMT_SIGNATURE
comma
l_int|8
)paren
op_logical_and
(paren
id|chdlc_udp_pkt-&gt;udp_pkt.udp_dst_port
op_eq
id|ntohs
c_func
(paren
id|card-&gt;wandev.udp_port
)paren
)paren
op_logical_and
(paren
id|chdlc_udp_pkt-&gt;ip_pkt.protocol
op_eq
id|UDPMGMT_UDP_PROTOCOL
)paren
op_logical_and
(paren
id|chdlc_udp_pkt-&gt;wp_mgmt.request_reply
op_eq
id|UDPMGMT_REQUEST
)paren
)paren
(brace
r_return
id|UDP_CPIPE_TYPE
suffix:semicolon
)brace
r_else
(brace
r_return
id|UDP_INVALID_TYPE
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * Set PORT state.&n; */
DECL|function|port_set_state
r_static
r_void
id|port_set_state
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;u.c.state
op_ne
id|state
)paren
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Link connected!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Link connecting...&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Link disconnected!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;wandev.state
op_assign
id|card-&gt;u.c.state
op_assign
id|state
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.dev
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|chdlc_priv_area-&gt;common.state
op_assign
id|state
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*===========================================================================&n; * config_chdlc&n; *&n; *&t;Configure the chdlc protocol and enable communications.&t;&t;&n; *&n; *   &t;The if_open() function binds this function to the poll routine.&n; *      Therefore, this function will run every time the chdlc interface&n; *      is brought up. We cannot run this function from the if_open &n; *      because if_open does not have access to the remote IP address.&n; *      &n; *&t;If the communications are not enabled, proceed to configure&n; *      the card and enable communications.&n; *&n; *      If the communications are enabled, it means that the interface&n; *      was shutdown by ether the user or driver. In this case, we &n; *      have to check that the IP addresses have not changed.  If&n; *      the IP addresses have changed, we have to reconfigure the firmware&n; *      and update the changed IP addresses.  Otherwise, just exit.&n; *&n; */
DECL|function|config_chdlc
r_static
r_int
id|config_chdlc
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.comm_enabled
)paren
(brace
multiline_comment|/* Jun 20. 2000: NC&n;&t;&t; * IP addresses are not used in the API mode */
r_if
c_cond
(paren
(paren
id|chdlc_priv_area-&gt;ip_local_tmp
op_ne
id|chdlc_priv_area-&gt;ip_local
op_logical_or
id|chdlc_priv_area-&gt;ip_remote_tmp
op_ne
id|chdlc_priv_area-&gt;ip_remote
)paren
op_logical_and
id|card-&gt;u.c.usedby
op_eq
id|WANPIPE
)paren
(brace
multiline_comment|/* The IP addersses have changed, we must&n;                         * stop the communications and reconfigure&n;                         * the card. Reason: the firmware must know&n;                         * the local and remote IP addresses. */
id|disable_comm
c_func
(paren
id|card
)paren
suffix:semicolon
id|port_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IP addresses changed!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Restarting communications ...&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* IP addresses are the same and the link is up, &n;                         * we dont have to do anything here. Therefore, exit */
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|chdlc_priv_area-&gt;ip_local
op_assign
id|chdlc_priv_area-&gt;ip_local_tmp
suffix:semicolon
id|chdlc_priv_area-&gt;ip_remote
op_assign
id|chdlc_priv_area-&gt;ip_remote_tmp
suffix:semicolon
multiline_comment|/* Setup the Board for asynchronous mode */
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
r_if
c_cond
(paren
id|set_asy_config
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Failed CHDLC Async configuration!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Setup the Board for CHDLC */
r_if
c_cond
(paren
id|set_chdlc_config
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Failed CHDLC configuration!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Set interrupt mode and mask */
r_if
c_cond
(paren
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
id|APP_INT_ON_RX_FRAME
op_or
id|APP_INT_ON_GLOBAL_EXCEP_COND
op_or
id|APP_INT_ON_TX_FRAME
op_or
id|APP_INT_ON_CHDLC_EXCEP_COND
op_or
id|APP_INT_ON_TIMER
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to set interrupt triggers!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Mask the Transmit and Timer interrupt */
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_and_assign
op_complement
(paren
id|APP_INT_ON_TX_FRAME
op_or
id|APP_INT_ON_TIMER
)paren
suffix:semicolon
multiline_comment|/* In TTY mode, receive interrupt will be enabled during&n;&t; * wanpipe_tty_open() operation */
r_if
c_cond
(paren
id|card-&gt;tty_opt
)paren
(brace
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_and_assign
op_complement
id|APP_INT_ON_RX_FRAME
suffix:semicolon
)brace
multiline_comment|/* Enable communications */
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
r_if
c_cond
(paren
id|asy_comm_enable
c_func
(paren
id|card
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to enable async commnunication!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_assign
l_int|0
suffix:semicolon
id|card-&gt;u.c.comm_enabled
op_assign
l_int|0
suffix:semicolon
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|chdlc_comm_enable
c_func
(paren
id|card
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to enable chdlc communications!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_assign
l_int|0
suffix:semicolon
id|card-&gt;u.c.comm_enabled
op_assign
l_int|0
suffix:semicolon
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Initialize Rx/Tx buffer control fields */
id|init_chdlc_tx_rx_buff
c_func
(paren
id|card
)paren
suffix:semicolon
id|port_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================&n; * chdlc_poll&n; *&t;&n; * Rationale:&n; * &t;We cannot manipulate the routing tables, or&n; *      ip addresses withing the interrupt. Therefore&n; *      we must perform such actons outside an interrupt &n; *      at a later time. &n; *&n; * Description:&t;&n; *&t;CHDLC polling routine, responsible for &n; *     &t;shutting down interfaces upon disconnect&n; *     &t;and adding/removing routes. &n; *      &n; * Usage:        &n; * &t;This function is executed for each CHDLC  &n; * &t;interface through a tq_schedule bottom half.&n; *      &n; *      trigger_chdlc_poll() function is used to kick&n; *      the chldc_poll routine.  &n; */
DECL|function|chdlc_poll
r_static
r_void
id|chdlc_poll
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
suffix:semicolon
id|sdla_t
op_star
id|card
suffix:semicolon
id|u8
id|check_gateway
op_assign
l_int|0
suffix:semicolon
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
(paren
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|card
op_assign
id|chdlc_priv_area-&gt;card
suffix:semicolon
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
multiline_comment|/* (Re)Configuraiton is in progress, stop what you are &n;&t; * doing and get out */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PERI_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|POLL_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* if_open() function has triggered the polling routine&n;&t; * to determine the configured IP addresses.  Once the&n;&t; * addresses are found, trigger the chdlc configuration */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|chdlc_priv_area-&gt;config_chdlc
)paren
)paren
(brace
id|chdlc_priv_area-&gt;ip_local_tmp
op_assign
id|get_ip_address
c_func
(paren
id|dev
comma
id|WAN_LOCAL_IP
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;ip_remote_tmp
op_assign
id|get_ip_address
c_func
(paren
id|dev
comma
id|WAN_POINTOPOINT_IP
)paren
suffix:semicolon
multiline_comment|/* Jun 20. 2000 Bug Fix&n;&t; &t;* Only perform this check in WANPIPE mode, since&n;&t; &t;* IP addresses are not used in the API mode. */
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;ip_local_tmp
op_eq
id|chdlc_priv_area-&gt;ip_remote_tmp
op_logical_and
id|card-&gt;u.c.slarp_timer
op_eq
l_int|0x00
op_logical_and
op_logical_neg
id|card-&gt;u.c.backup
op_logical_and
id|card-&gt;u.c.usedby
op_eq
id|WANPIPE
)paren
(brace
r_if
c_cond
(paren
op_increment
id|chdlc_priv_area-&gt;ip_error
OG
id|MAX_IP_ERRORS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n%s: --- WARNING ---&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: The local IP address is the same as the&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Point-to-Point IP address.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: --- WARNING ---&bslash;n&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_else
(brace
id|clear_bit
c_func
(paren
id|POLL_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;poll_delay_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;poll_delay_timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chdlc_priv_area-&gt;config_chdlc
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|POLL_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_CONFIG
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_or_assign
id|APP_INT_ON_TIMER
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Dynamic interface implementation, as well as dynamic&n;&t; * routing.  */
r_switch
c_cond
(paren
id|card-&gt;u.c.state
)paren
(brace
r_case
id|WAN_DISCONNECTED
suffix:colon
multiline_comment|/* If the dynamic interface configuration is on, and interface &n;&t;&t; * is up, then bring down the netowrk interface */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|DYN_OPT_ON
comma
op_amp
id|chdlc_priv_area-&gt;interface_down
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|DEV_DOWN
comma
op_amp
id|chdlc_priv_area-&gt;interface_down
)paren
op_logical_and
id|card-&gt;wandev.dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s down.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.dev-&gt;name
)paren
suffix:semicolon
id|change_dev_flags
c_func
(paren
id|card-&gt;wandev.dev
comma
(paren
id|card-&gt;wandev.dev-&gt;flags
op_amp
op_complement
id|IFF_UP
)paren
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|DEV_DOWN
comma
op_amp
id|chdlc_priv_area-&gt;interface_down
)paren
suffix:semicolon
id|chdlc_priv_area-&gt;route_status
op_assign
id|NO_ROUTE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We need to check if the local IP address is&n;               &t;  &t; * zero. If it is, we shouldn&squot;t try to remove it.&n;                 &t; */
r_if
c_cond
(paren
id|card-&gt;wandev.dev-&gt;flags
op_amp
id|IFF_UP
op_logical_and
id|get_ip_address
c_func
(paren
id|card-&gt;wandev.dev
comma
id|WAN_LOCAL_IP
)paren
op_logical_and
id|chdlc_priv_area-&gt;route_status
op_ne
id|NO_ROUTE
op_logical_and
id|card-&gt;u.c.slarp_timer
)paren
(brace
id|process_route
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|WAN_CONNECTED
suffix:colon
multiline_comment|/* In SMP machine this code can execute before the interface&n;&t;&t; * comes up.  In this case, we must make sure that we do not&n;&t;&t; * try to bring up the interface before dev_open() is finished */
multiline_comment|/* DEV_DOWN will be set only when we bring down the interface&n;&t;&t; * for the very first time. This way we know that it was us&n;&t;&t; * that brought the interface down */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|DYN_OPT_ON
comma
op_amp
id|chdlc_priv_area-&gt;interface_down
)paren
op_logical_and
id|test_bit
c_func
(paren
id|DEV_DOWN
comma
op_amp
id|chdlc_priv_area-&gt;interface_down
)paren
op_logical_and
op_logical_neg
(paren
id|card-&gt;wandev.dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s up.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.dev-&gt;name
)paren
suffix:semicolon
id|change_dev_flags
c_func
(paren
id|card-&gt;wandev.dev
comma
(paren
id|card-&gt;wandev.dev-&gt;flags
op_or
id|IFF_UP
)paren
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|DEV_DOWN
comma
op_amp
id|chdlc_priv_area-&gt;interface_down
)paren
suffix:semicolon
id|check_gateway
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;route_status
op_eq
id|ADD_ROUTE
op_logical_and
id|card-&gt;u.c.slarp_timer
)paren
(brace
id|process_route
c_func
(paren
id|card
)paren
suffix:semicolon
id|check_gateway
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chdlc_priv_area-&gt;gateway
op_logical_and
id|check_gateway
)paren
id|add_gateway
c_func
(paren
id|card
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|POLL_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================&n; * trigger_chdlc_poll&n; *&n; * Description:&n; * &t;Add a chdlc_poll() task into a tq_scheduler bh handler&n; *      for a specific dlci/interface.  This will kick&n; *      the fr_poll() routine at a later time. &n; *&n; * Usage:&n; * &t;Interrupts use this to defer a taks to &n; *      a polling routine.&n; *&n; */
DECL|function|trigger_chdlc_poll
r_static
r_void
id|trigger_chdlc_poll
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|chdlc_private_area_t
op_star
id|chdlc_priv_area
suffix:semicolon
id|sdla_t
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chdlc_priv_area
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|card
op_assign
id|chdlc_priv_area-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|POLL_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PERI_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#ifdef LINUX_2_4
id|schedule_task
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;poll_task
)paren
suffix:semicolon
macro_line|#else
id|queue_task
c_func
(paren
op_amp
id|chdlc_priv_area-&gt;poll_task
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
DECL|function|chdlc_poll_delay
r_static
r_void
id|chdlc_poll_delay
(paren
r_int
r_int
id|dev_ptr
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
(paren
id|netdevice_t
op_star
)paren
id|dev_ptr
suffix:semicolon
id|trigger_chdlc_poll
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|s508_lock
r_void
id|s508_lock
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
(brace
macro_line|#if defined(__SMP__) || defined(LINUX_2_4)
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_star
id|smp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;next-&gt;wandev.lock
)paren
suffix:semicolon
)brace
macro_line|#else
id|disable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
macro_line|#endif                                                                     
)brace
DECL|function|s508_unlock
r_void
id|s508_unlock
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
(brace
macro_line|#if defined(__SMP__) || defined(LINUX_2_4)
r_if
c_cond
(paren
id|card-&gt;next
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;next-&gt;wandev.lock
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_star
id|smp_flags
)paren
suffix:semicolon
macro_line|#else
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
macro_line|#endif           
)brace
singleline_comment|//*********** TTY SECTION ****************
macro_line|#if defined(LINUX_2_4) || defined(LINUX_2_1)
DECL|function|wanpipe_tty_trigger_tx_irq
r_static
r_void
id|wanpipe_tty_trigger_tx_irq
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
id|INTERRUPT_INFORMATION_STRUCT
op_star
id|chdlc_int
op_assign
op_amp
id|flags-&gt;interrupt_info_struct
suffix:semicolon
id|chdlc_int-&gt;interrupt_permission
op_or_assign
id|APP_INT_ON_TX_FRAME
suffix:semicolon
)brace
DECL|function|wanpipe_tty_trigger_poll
r_static
r_void
id|wanpipe_tty_trigger_poll
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
macro_line|#ifdef LINUX_2_4
id|schedule_task
c_func
(paren
op_amp
id|card-&gt;tty_task_queue
)paren
suffix:semicolon
macro_line|#else
id|queue_task
c_func
(paren
op_amp
id|card-&gt;tty_task_queue
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|tty_poll_task
r_static
r_void
id|tty_poll_task
(paren
r_void
op_star
id|data
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
(paren
id|sdla_t
op_star
)paren
id|data
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|card-&gt;tty
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(brace
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
macro_line|#if defined(SERIAL_HAVE_POLL_WAIT) || &bslash;&n;         (defined LINUX_2_1 &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,2,15))
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;poll_wait
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_close
r_static
r_void
id|wanpipe_tty_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
r_int
id|smp_flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
r_return
suffix:semicolon
)brace
id|card
op_assign
(paren
id|sdla_t
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Closing TTY Driver!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
multiline_comment|/* Sanity Check */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;tty_open
)paren
r_return
suffix:semicolon
id|wanpipe_close
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|card-&gt;tty_open
op_eq
l_int|0
)paren
(brace
id|lock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|card-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|chdlc_disable_comm_shutdown
c_func
(paren
id|card
)paren
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tty_buf
)paren
(brace
id|kfree
c_func
(paren
id|card-&gt;tty_buf
)paren
suffix:semicolon
id|card-&gt;tty_buf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;tty_rx
)paren
(brace
id|kfree
c_func
(paren
id|card-&gt;tty_rx
)paren
suffix:semicolon
id|card-&gt;tty_rx
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_open
r_static
r_int
id|wanpipe_tty_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
r_int
id|smp_flags
suffix:semicolon
id|sdla_t
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
r_int
id|port
suffix:semicolon
id|port
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|port
OL
l_int|0
)paren
op_logical_or
(paren
id|port
op_ge
id|NR_PORTS
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|WAN_CARD
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty-&gt;driver_data
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|card
op_assign
(paren
id|sdla_t
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|lock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|card-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Opening TTY Driver!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tty_open
op_eq
l_int|0
)paren
(brace
id|lock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|card-&gt;tty
op_assign
id|tty
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;tty_buf
)paren
(brace
id|card-&gt;tty_buf
op_assign
id|kmalloc
c_func
(paren
id|TTY_CHDLC_MAX_MTU
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;tty_buf
)paren
(brace
id|card-&gt;tty_buf
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;tty_rx
)paren
(brace
id|card-&gt;tty_rx
op_assign
id|kmalloc
c_func
(paren
id|TTY_CHDLC_MAX_MTU
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;tty_rx
)paren
(brace
multiline_comment|/* Free the buffer above */
id|kfree
c_func
(paren
id|card-&gt;tty_buf
)paren
suffix:semicolon
id|card-&gt;tty_buf
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
)brace
op_increment
id|card-&gt;tty_open
suffix:semicolon
id|wanpipe_open
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wanpipe_tty_write
r_static
r_int
id|wanpipe_tty_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|smp_flags
op_assign
l_int|0
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NO TTY in Write&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|card
op_assign
(paren
id|sdla_t
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;No Card in TTY Write&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
id|card-&gt;wandev.mtu
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Frame too big in Write %i Max: %i&bslash;n&quot;
comma
id|count
comma
id|card-&gt;wandev.mtu
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Card not connected in TTY Write&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Lock the 508 Card: SMP is supported */
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_lock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Critical in TTY Write&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
multiline_comment|/* Lock the 508 Card: SMP is supported */
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_int
r_char
op_star
id|tmp_buf
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp_buf
op_assign
id|card-&gt;tty_buf
)paren
op_eq
l_int|NULL
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;No TTY BUF in Write&bslash;n&quot;
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|tmp_buf
comma
id|buf
comma
id|count
)paren
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to copy from user!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chdlc_send
c_func
(paren
id|card
comma
(paren
r_void
op_star
)paren
id|tmp_buf
comma
id|count
)paren
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to send, retry later: user!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|wanpipe_tty_trigger_tx_irq
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|chdlc_send
c_func
(paren
id|card
comma
(paren
r_void
op_star
)paren
id|buf
comma
id|count
)paren
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to send, retry later: kernel!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|wanpipe_tty_trigger_tx_irq
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Packet sent OK: %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|count
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|wanpipe_tty_receive
r_static
r_void
id|wanpipe_tty_receive
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|addr
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|offset
op_assign
l_int|0
suffix:semicolon
r_int
id|olen
op_assign
id|len
suffix:semicolon
r_char
id|fp
op_assign
l_int|0
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;tty_open
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: TTY not open during receive&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|card-&gt;tty
)paren
op_eq
l_int|NULL
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No TTY on receive&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tty-&gt;driver_data
)paren
(brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No Driver Data, or Flip on receive&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty-&gt;flip.count
op_plus
id|len
)paren
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received packet size too big: %i bytes, Max: %i!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|len
comma
id|TTY_FLIPBUF_SIZE
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|addr
op_plus
id|len
)paren
OG
id|card-&gt;u.c.rx_top
op_plus
l_int|1
)paren
(brace
id|offset
op_assign
id|card-&gt;u.c.rx_top
op_minus
id|addr
op_plus
l_int|1
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|tty-&gt;flip.char_buf_ptr
comma
id|offset
)paren
suffix:semicolon
id|addr
op_assign
id|card-&gt;u.c.rx_base
suffix:semicolon
id|len
op_sub_assign
id|offset
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|offset
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|offset
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
l_int|0
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
)brace
)brace
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|tty-&gt;flip.char_buf_ptr
comma
id|len
)paren
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|len
suffix:semicolon
id|card-&gt;tty-&gt;flip.count
op_add_assign
id|len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
l_int|0
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
)brace
id|tty-&gt;low_latency
op_assign
l_int|1
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;tty_rx
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Receive sync buffer not available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|TTY_CHDLC_MAX_MTU
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received packet size too big: %i bytes, Max: %i!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|len
comma
id|TTY_FLIPBUF_SIZE
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|addr
op_plus
id|len
)paren
OG
id|card-&gt;u.c.rx_top
op_plus
l_int|1
)paren
(brace
id|offset
op_assign
id|card-&gt;u.c.rx_top
op_minus
id|addr
op_plus
l_int|1
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|card-&gt;tty_rx
comma
id|offset
)paren
suffix:semicolon
id|addr
op_assign
id|card-&gt;u.c.rx_base
suffix:semicolon
id|len
op_sub_assign
id|offset
suffix:semicolon
)brace
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|addr
comma
id|card-&gt;tty_rx
op_plus
id|offset
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.receive_buf
)paren
(brace
id|tty-&gt;ldisc
dot
id|receive_buf
c_func
(paren
id|tty
comma
id|card-&gt;tty_rx
comma
op_amp
id|fp
comma
id|olen
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: NO TTY Sync line discipline!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
)brace
id|dbg_printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received Data %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|olen
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_int
id|wanpipe_tty_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
macro_line|#endif
DECL|function|wanpipe_tty_stop
r_static
r_void
id|wanpipe_tty_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_start
r_static
r_void
id|wanpipe_tty_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|config_tty
r_static
r_int
id|config_tty
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|SHARED_MEMORY_INFO_STRUCT
op_star
id|flags
op_assign
id|card-&gt;u.c.flags
suffix:semicolon
multiline_comment|/* Setup the Board for asynchronous mode */
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
r_if
c_cond
(paren
id|set_asy_config
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Failed CHDLC Async configuration!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Setup the Board for CHDLC */
r_if
c_cond
(paren
id|set_chdlc_config
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Failed CHDLC configuration!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Set interrupt mode and mask */
r_if
c_cond
(paren
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
id|APP_INT_ON_RX_FRAME
op_or
id|APP_INT_ON_GLOBAL_EXCEP_COND
op_or
id|APP_INT_ON_TX_FRAME
op_or
id|APP_INT_ON_CHDLC_EXCEP_COND
op_or
id|APP_INT_ON_TIMER
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to set interrupt triggers!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Mask the Transmit and Timer interrupt */
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_and_assign
op_complement
(paren
id|APP_INT_ON_TX_FRAME
op_or
id|APP_INT_ON_TIMER
)paren
suffix:semicolon
multiline_comment|/* Enable communications */
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
r_if
c_cond
(paren
id|asy_comm_enable
c_func
(paren
id|card
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to enable async commnunication!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_assign
l_int|0
suffix:semicolon
id|card-&gt;u.c.comm_enabled
op_assign
l_int|0
suffix:semicolon
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|chdlc_comm_enable
c_func
(paren
id|card
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to enable chdlc communications!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|flags-&gt;interrupt_info_struct.interrupt_permission
op_assign
l_int|0
suffix:semicolon
id|card-&gt;u.c.comm_enabled
op_assign
l_int|0
suffix:semicolon
id|chdlc_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Initialize Rx/Tx buffer control fields */
id|init_chdlc_tx_rx_buff
c_func
(paren
id|card
)paren
suffix:semicolon
id|port_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTING
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|change_speed
r_static
r_int
id|change_speed
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_int
id|baud
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|cflag
suffix:semicolon
r_int
id|dbits
comma
id|sbits
comma
id|parity
comma
id|handshaking
suffix:semicolon
id|cflag
op_assign
id|tty-&gt;termios-&gt;c_cflag
suffix:semicolon
multiline_comment|/* There is always one stop bit */
id|sbits
op_assign
id|WANOPT_ONE
suffix:semicolon
multiline_comment|/* Parity is defaulted to NONE */
id|parity
op_assign
id|WANOPT_NONE
suffix:semicolon
id|handshaking
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* byte size and parity */
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|dbits
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|dbits
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|dbits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|dbits
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Never happens, but GCC is too dumb to figure it out */
r_default
suffix:colon
id|dbits
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* One more stop bit should be supported, thus increment&n;&t; * the number of stop bits Max=2 */
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
(brace
id|sbits
op_assign
id|WANOPT_TWO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
id|parity
op_assign
id|WANOPT_EVEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
(brace
id|parity
op_assign
id|WANOPT_ODD
suffix:semicolon
)brace
multiline_comment|/* Determine divisor based on baud rate */
id|baud
op_assign
id|tty_get_baud_rate
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|baud
)paren
id|baud
op_assign
l_int|9600
suffix:semicolon
multiline_comment|/* B0 transition handled in rs_set_termios */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|handshaking
op_or_assign
id|ASY_RTS_HS_FOR_RX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IGNPAR
c_func
(paren
id|tty
)paren
)paren
id|parity
op_assign
id|WANOPT_NONE
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
id|handshaking
op_or_assign
id|ASY_XON_XOFF_HS_FOR_RX
suffix:semicolon
id|handshaking
op_or_assign
id|ASY_XON_XOFF_HS_FOR_TX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IXON
c_func
(paren
id|tty
)paren
)paren
(brace
id|handshaking
op_or_assign
id|ASY_XON_XOFF_HS_FOR_RX
suffix:semicolon
id|handshaking
op_or_assign
id|ASY_XON_XOFF_HS_FOR_TX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.bps
op_ne
id|baud
)paren
id|ret
op_assign
l_int|1
suffix:semicolon
id|card-&gt;wandev.bps
op_assign
id|baud
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;u.c.protocol_options
op_ne
id|handshaking
)paren
id|ret
op_assign
l_int|1
suffix:semicolon
id|card-&gt;u.c.protocol_options
op_assign
id|handshaking
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.tx_bits_per_char
op_ne
id|dbits
)paren
id|ret
op_assign
l_int|1
suffix:semicolon
id|card-&gt;u.c.tx_bits_per_char
op_assign
id|dbits
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.rx_bits_per_char
op_ne
id|dbits
)paren
id|ret
op_assign
l_int|1
suffix:semicolon
id|card-&gt;u.c.rx_bits_per_char
op_assign
id|dbits
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.stop_bits
op_ne
id|sbits
)paren
id|ret
op_assign
l_int|1
suffix:semicolon
id|card-&gt;u.c.stop_bits
op_assign
id|sbits
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.parity
op_ne
id|parity
)paren
id|ret
op_assign
l_int|1
suffix:semicolon
id|card-&gt;u.c.parity
op_assign
id|parity
suffix:semicolon
id|card-&gt;u.c.break_timer
op_assign
l_int|50
suffix:semicolon
id|card-&gt;u.c.inter_char_timer
op_assign
l_int|10
suffix:semicolon
id|card-&gt;u.c.rx_complete_length
op_assign
l_int|100
suffix:semicolon
id|card-&gt;u.c.xon_char
op_assign
l_int|0xFE
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;u.c.protocol_options
op_assign
id|HDLC_STREAMING_MODE
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|wanpipe_tty_set_termios
r_static
r_void
id|wanpipe_tty_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
id|err
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
r_return
suffix:semicolon
)brace
id|card
op_assign
(paren
id|sdla_t
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|change_speed
c_func
(paren
id|card
comma
id|tty
comma
id|old_termios
)paren
op_logical_or
op_logical_neg
id|card-&gt;u.c.comm_enabled
)paren
(brace
r_int
r_int
id|smp_flags
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.comm_enabled
)paren
(brace
id|lock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|chdlc_disable_comm_shutdown
c_func
(paren
id|card
)paren
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
id|lock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|err
op_assign
id|config_tty
c_func
(paren
id|card
)paren
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.c.async_mode
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: TTY Async Configuration:&bslash;n&quot;
l_string|&quot;   Baud        =%i&bslash;n&quot;
l_string|&quot;   Handshaking =%s&bslash;n&quot;
l_string|&quot;   Tx Dbits    =%i&bslash;n&quot;
l_string|&quot;   Rx Dbits    =%i&bslash;n&quot;
l_string|&quot;   Parity      =%s&bslash;n&quot;
l_string|&quot;   Stop Bits   =%i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.bps
comma
id|opt_decode
(braket
id|card-&gt;u.c.protocol_options
)braket
comma
id|card-&gt;u.c.tx_bits_per_char
comma
id|card-&gt;u.c.rx_bits_per_char
comma
id|p_decode
(braket
id|card-&gt;u.c.parity
)braket
comma
id|card-&gt;u.c.stop_bits
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: TTY Sync Configuration:&bslash;n&quot;
l_string|&quot;   Baud        =%i&bslash;n&quot;
l_string|&quot;   Protocol    =HDLC_STREAMING&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;wandev.bps
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|port_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
)brace
r_else
(brace
id|port_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_put_char
r_static
r_void
id|wanpipe_tty_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
r_int
id|smp_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
r_return
suffix:semicolon
)brace
id|card
op_assign
(paren
id|sdla_t
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_lock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|wanpipe_tty_trigger_tx_irq
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chdlc_send
c_func
(paren
id|card
comma
(paren
r_void
op_star
)paren
op_amp
id|ch
comma
l_int|1
)paren
)paren
(brace
id|wanpipe_tty_trigger_tx_irq
c_func
(paren
id|card
)paren
suffix:semicolon
id|dbg_printk
c_func
(paren
l_string|&quot;%s: Failed to TX char!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|dbg_printk
c_func
(paren
l_string|&quot;%s: Char TX OK&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
id|s508_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_flush_chars
r_static
r_void
id|wanpipe_tty_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_flush_buffer
r_static
r_void
id|wanpipe_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
macro_line|#if defined(SERIAL_HAVE_POLL_WAIT) || &bslash;&n;         (defined LINUX_2_1 &amp;&amp; LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,2,15))
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;poll_wait
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is used to send a high-priority XON/XOFF character to&n; * the device&n; */
DECL|function|wanpipe_tty_send_xchar
r_static
r_void
id|wanpipe_tty_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_chars_in_buffer
r_static
r_int
id|wanpipe_tty_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wanpipe_tty_write_room
r_static
r_int
id|wanpipe_tty_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;TTY Write Room&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|card
op_assign
(paren
id|sdla_t
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|SEC_MAX_NO_DATA_BYTES_IN_FRAME
suffix:semicolon
)brace
DECL|function|set_modem_status
r_static
r_int
id|set_modem_status
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_char
id|data
)paren
(brace
id|CHDLC_MAILBOX_STRUCT
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|mb-&gt;buffer_length
op_assign
l_int|1
suffix:semicolon
id|mb-&gt;command
op_assign
id|SET_MODEM_STATUS
suffix:semicolon
id|mb-&gt;data
(braket
l_int|0
)braket
op_assign
id|data
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;return_code
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|COMMAND_OK
)paren
id|chdlc_error
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|wanpipe_tty_hangup
r_static
r_void
id|wanpipe_tty_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
r_int
id|smp_flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;TTY Hangup!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
r_return
suffix:semicolon
)brace
id|card
op_assign
(paren
id|sdla_t
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
suffix:semicolon
id|lock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|set_modem_status
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_break
r_static
r_void
id|wanpipe_tty_break
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_wait_until_sent
r_static
r_void
id|wanpipe_tty_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_throttle
r_static
r_void
id|wanpipe_tty_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_unthrottle
r_static
r_void
id|wanpipe_tty_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|wanpipe_tty_read_proc
r_int
id|wanpipe_tty_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The serial driver boot-time initialization code!&n; */
DECL|function|wanpipe_tty_init
r_int
id|wanpipe_tty_init
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_struct
id|serial_state
op_star
id|state
suffix:semicolon
multiline_comment|/* Initialize the tty_driver structure */
r_if
c_cond
(paren
id|card-&gt;tty_minor
template_param
id|NR_PORTS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Illegal Minor TTY number (0-4): %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;tty_minor
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|WAN_CARD
c_func
(paren
id|card-&gt;tty_minor
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: TTY Minor %i, already in use&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;tty_minor
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty_init_cnt
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: TTY %s Driver Init: Major %i, Minor Range %i-%i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|card-&gt;u.c.async_mode
ques
c_cond
l_string|&quot;ASYNC&quot;
suffix:colon
l_string|&quot;SYNC&quot;
comma
id|WAN_TTY_MAJOR
comma
id|MIN_PORT
comma
id|MAX_PORT
)paren
suffix:semicolon
id|tty_driver_mode
op_assign
id|card-&gt;u.c.async_mode
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|serial_driver
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|serial_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|serial_driver.driver_name
op_assign
l_string|&quot;wanpipe_tty&quot;
suffix:semicolon
id|serial_driver.name
op_assign
l_string|&quot;ttyW&quot;
suffix:semicolon
id|serial_driver.major
op_assign
id|WAN_TTY_MAJOR
suffix:semicolon
id|serial_driver.minor_start
op_assign
id|WAN_TTY_MINOR
suffix:semicolon
id|serial_driver.num
op_assign
id|NR_PORTS
suffix:semicolon
id|serial_driver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|serial_driver.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|serial_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|serial_driver.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|serial_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|serial_driver.refcount
op_assign
op_amp
id|serial_refcount
suffix:semicolon
id|serial_driver.table
op_assign
id|serial_table
suffix:semicolon
id|serial_driver.termios
op_assign
id|serial_termios
suffix:semicolon
id|serial_driver.termios_locked
op_assign
id|serial_termios_locked
suffix:semicolon
id|serial_driver.open
op_assign
id|wanpipe_tty_open
suffix:semicolon
id|serial_driver.close
op_assign
id|wanpipe_tty_close
suffix:semicolon
id|serial_driver.write
op_assign
id|wanpipe_tty_write
suffix:semicolon
id|serial_driver.put_char
op_assign
id|wanpipe_tty_put_char
suffix:semicolon
id|serial_driver.flush_chars
op_assign
id|wanpipe_tty_flush_chars
suffix:semicolon
id|serial_driver.write_room
op_assign
id|wanpipe_tty_write_room
suffix:semicolon
id|serial_driver.chars_in_buffer
op_assign
id|wanpipe_tty_chars_in_buffer
suffix:semicolon
id|serial_driver.flush_buffer
op_assign
id|wanpipe_tty_flush_buffer
suffix:semicolon
singleline_comment|//serial_driver.ioctl = wanpipe_tty_ioctl;
id|serial_driver.throttle
op_assign
id|wanpipe_tty_throttle
suffix:semicolon
id|serial_driver.unthrottle
op_assign
id|wanpipe_tty_unthrottle
suffix:semicolon
id|serial_driver.send_xchar
op_assign
id|wanpipe_tty_send_xchar
suffix:semicolon
id|serial_driver.set_termios
op_assign
id|wanpipe_tty_set_termios
suffix:semicolon
id|serial_driver.stop
op_assign
id|wanpipe_tty_stop
suffix:semicolon
id|serial_driver.start
op_assign
id|wanpipe_tty_start
suffix:semicolon
id|serial_driver.hangup
op_assign
id|wanpipe_tty_hangup
suffix:semicolon
id|serial_driver.break_ctl
op_assign
id|wanpipe_tty_break
suffix:semicolon
id|serial_driver.wait_until_sent
op_assign
id|wanpipe_tty_wait_until_sent
suffix:semicolon
id|serial_driver.read_proc
op_assign
id|wanpipe_tty_read_proc
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The callout device is just like normal device except for&n;&t;&t; * major number and the subtype code.&n;&t;&t; */
id|callout_driver
op_assign
id|serial_driver
suffix:semicolon
id|callout_driver.name
op_assign
l_string|&quot;cuw&quot;
suffix:semicolon
id|callout_driver.major
op_assign
id|TTYAUX_MAJOR
suffix:semicolon
id|callout_driver.subtype
op_assign
id|SERIAL_TYPE_CALLOUT
suffix:semicolon
id|callout_driver.read_proc
op_assign
l_int|0
suffix:semicolon
id|callout_driver.proc_entry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|serial_driver
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to register serial driver!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|callout_driver
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to register callout driver!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The subsequent ports must comply to the initial configuration */
r_if
c_cond
(paren
id|tty_driver_mode
op_ne
id|card-&gt;u.c.async_mode
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error: TTY Driver operation mode mismatch!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: The TTY driver is configured for %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|tty_driver_mode
ques
c_cond
l_string|&quot;ASYNC&quot;
suffix:colon
l_string|&quot;SYNC&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tty_init_cnt
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Initializing TTY %s Driver Minor %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|tty_driver_mode
ques
c_cond
l_string|&quot;ASYNC&quot;
suffix:colon
l_string|&quot;SYNC&quot;
comma
id|card-&gt;tty_minor
)paren
suffix:semicolon
id|tty_card_map
(braket
id|card-&gt;tty_minor
)braket
op_assign
id|card
suffix:semicolon
id|state
op_assign
op_amp
id|rs_table
(braket
id|card-&gt;tty_minor
)braket
suffix:semicolon
id|state-&gt;magic
op_assign
id|SSTATE_MAGIC
suffix:semicolon
id|state-&gt;line
op_assign
l_int|0
suffix:semicolon
id|state-&gt;type
op_assign
id|PORT_UNKNOWN
suffix:semicolon
id|state-&gt;custom_divisor
op_assign
l_int|0
suffix:semicolon
id|state-&gt;close_delay
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|state-&gt;closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|state-&gt;callout_termios
op_assign
id|callout_driver.init_termios
suffix:semicolon
id|state-&gt;normal_termios
op_assign
id|serial_driver.init_termios
suffix:semicolon
id|state-&gt;icount.cts
op_assign
id|state-&gt;icount.dsr
op_assign
id|state-&gt;icount.rng
op_assign
id|state-&gt;icount.dcd
op_assign
l_int|0
suffix:semicolon
id|state-&gt;icount.rx
op_assign
id|state-&gt;icount.tx
op_assign
l_int|0
suffix:semicolon
id|state-&gt;icount.frame
op_assign
id|state-&gt;icount.parity
op_assign
l_int|0
suffix:semicolon
id|state-&gt;icount.overrun
op_assign
id|state-&gt;icount.brk
op_assign
l_int|0
suffix:semicolon
id|state-&gt;irq
op_assign
id|card-&gt;wandev.irq
suffix:semicolon
id|card-&gt;tty_task_queue.routine
op_assign
id|tty_poll_task
suffix:semicolon
id|card-&gt;tty_task_queue.data
op_assign
(paren
r_void
op_star
)paren
id|card
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/****** End ****************************************************************/
eof
