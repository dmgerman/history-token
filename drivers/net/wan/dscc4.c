multiline_comment|/*&n; * drivers/net/wan/dscc4/dscc4_main.c: a DSCC4 HDLC driver for Linux&n; *&n; * This software may be used and distributed according to the terms of the &n; * GNU General Public License. &n; *&n; * The author may be reached as romieu@cogenit.fr.&n; * Specific bug reports/asian food will be welcome.&n; *&n; * Special thanks to the nice people at CS-Telecom for the hardware and the&n; * access to the test/measure tools.&n; *&n; *&n; *                             Theory of Operation&n; *&n; * I. Board Compatibility&n; *&n; * This device driver is designed for the Siemens PEB20534 4 ports serial&n; * controller as found on Etinc PCISYNC cards. The documentation for the &n; * chipset is available at http://www.infineon.com:&n; * - Data Sheet &quot;DSCC4, DMA Supported Serial Communication Controller with&n; * 4 Channels, PEB 20534 Version 2.1, PEF 20534 Version 2.1&quot;;&n; * - Application Hint &quot;Management of DSCC4 on-chip FIFO resources&quot;.&n; * Jens David has built an adapter based on the same chipset. Take a look&n; * at http://www.afthd.tu-darmstadt.de/~dg1kjd/pciscc4 for a specific&n; * driver.&n; * Sample code (2 revisions) is available at Infineon.&n; *&n; * II. Board-specific settings&n; *&n; * Pcisync can transmit some clock signal to the outside world on the&n; * *first two* ports provided you put a quartz and a line driver on it and&n; * remove the jumpers. The operation is described on Etinc web site. If you&n; * go DCE on these ports, don&squot;t forget to use an adequate cable.&n; *&n; * Sharing of the PCI interrupt line for this board is possible.&n; *&n; * III. Driver operation&n; *&n; * The rx/tx operations are based on a linked list of descriptor. I haven&squot;t&n; * tried the start/stop descriptor method as this one looks like the cheapest&n; * in terms of PCI manipulation.&n; *&n; * Tx direction&n; * Once the data section of the current descriptor processed, the next linked&n; * descriptor is loaded if the HOLD bit isn&squot;t set in the current descriptor.&n; * If HOLD is met, the transmission is stopped until the host unsets it and&n; * signals the change via TxPOLL.&n; * When the tx ring is full, the xmit routine issues a call to netdev_stop.&n; * The device is supposed to be enabled again during an ALLS irq (we could&n; * use HI but as it&squot;s easy to loose events, it&squot;s fscked).&n; *&n; * Rx direction&n; * The received frames aren&squot;t supposed to span over multiple receiving areas.&n; * I may implement it some day but it isn&squot;t the highest ranked item.&n; *&n; * IV. Notes&n; * The chipset is buggy. Typically, under some specific load patterns (I&n; * wouldn&squot;t call them &quot;high&quot;), the irq queues and the descriptors look like&n; * some event has been lost. Even assuming some fancy PCI feature, it won&squot;t &n; * explain the reproductible missing &quot;C&quot; bit in the descriptors. Faking an &n; * irq in the periodic timer isn&squot;t really elegant but at least it seems &n; * reliable.&n; * The current error (XDU, RFO) recovery code is untested.&n; * So far, RDO takes his RX channel down and the right sequence to enable it&n; * again is still a mistery. If RDO happens, plan a reboot. More details&n; * in the code (NB: as this happens, TX still works).&n; * Don&squot;t mess the cables during operation, especially on DTE ports. I don&squot;t&n; * suggest it for DCE either but at least one can get some messages instead&n; * of a complete instant freeze.&n; * Tests are done on Rev. 20 of the silicium. The RDO handling changes with&n; * the documentation/chipset releases. An on-line errata would be welcome.&n; *&n; * TODO:&n; * - some trivial error lurk,&n; * - the stats are fscked,&n; * - use polling at high irq/s,&n; * - performance analysis,&n; * - endianness.&n; *&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;net/syncppp.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
multiline_comment|/* Version */
DECL|variable|version
r_static
r_const
r_char
id|version
(braket
)braket
op_assign
l_string|&quot;$Id: dscc4.c,v 1.130 2001/02/25 15:27:34 romieu Exp $&bslash;n&quot;
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
multiline_comment|/* Module parameters */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Maintainer: Francois Romieu &lt;romieu@cogenit.fr&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Siemens PEB20534 PCI Controller&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* Structures */
DECL|struct|TxFD
r_struct
id|TxFD
(brace
DECL|member|state
id|u32
id|state
suffix:semicolon
DECL|member|next
id|u32
id|next
suffix:semicolon
DECL|member|data
id|u32
id|data
suffix:semicolon
DECL|member|complete
id|u32
id|complete
suffix:semicolon
DECL|member|jiffies
id|u32
id|jiffies
suffix:semicolon
multiline_comment|/* more hack to come :o) */
)brace
suffix:semicolon
DECL|struct|RxFD
r_struct
id|RxFD
(brace
DECL|member|state1
id|u32
id|state1
suffix:semicolon
DECL|member|next
id|u32
id|next
suffix:semicolon
DECL|member|data
id|u32
id|data
suffix:semicolon
DECL|member|state2
id|u32
id|state2
suffix:semicolon
DECL|member|end
id|u32
id|end
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG
DECL|macro|DEBUG_PARANOID
mdefine_line|#define DEBUG_PARANOID
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE    32
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE    32
DECL|macro|IRQ_RING_SIZE
mdefine_line|#define IRQ_RING_SIZE   64 /* Keep it A multiple of 32 */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT      (HZ/10)
DECL|macro|BRR_DIVIDER_MAX
mdefine_line|#define BRR_DIVIDER_MAX 64*0x00008000
DECL|macro|dev_per_card
mdefine_line|#define dev_per_card&t;4
DECL|macro|SOURCE_ID
mdefine_line|#define SOURCE_ID(flags) ((flags &gt;&gt; 28 ) &amp; 0x03)
DECL|macro|TO_SIZE
mdefine_line|#define TO_SIZE(state) ((state &gt;&gt; 16) &amp; 0x1fff)
DECL|macro|TO_STATE
mdefine_line|#define TO_STATE(len) cpu_to_le32((len &amp; TxSizeMax) &lt;&lt; 16)
DECL|macro|RX_MAX
mdefine_line|#define RX_MAX(len) ((((len) &gt;&gt; 5) + 1) &lt;&lt; 5)
DECL|macro|SCC_REG_START
mdefine_line|#define SCC_REG_START(id) SCC_START+(id)*SCC_OFFSET
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|struct|dscc4_pci_priv
r_struct
id|dscc4_pci_priv
(brace
DECL|member|iqcfg
id|u32
op_star
id|iqcfg
suffix:semicolon
DECL|member|cfg_cur
r_int
id|cfg_cur
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|root
r_struct
id|net_device
op_star
id|root
suffix:semicolon
DECL|member|iqcfg_dma
id|dma_addr_t
id|iqcfg_dma
suffix:semicolon
DECL|member|xtal_hz
id|u32
id|xtal_hz
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|dscc4_dev_priv
r_struct
id|dscc4_dev_priv
(brace
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_fd
r_struct
id|RxFD
op_star
id|rx_fd
suffix:semicolon
DECL|member|tx_fd
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
DECL|member|iqrx
id|u32
op_star
id|iqrx
suffix:semicolon
DECL|member|iqtx
id|u32
op_star
id|iqtx
suffix:semicolon
DECL|member|rx_current
id|u32
id|rx_current
suffix:semicolon
DECL|member|tx_current
id|u32
id|tx_current
suffix:semicolon
DECL|member|iqrx_current
id|u32
id|iqrx_current
suffix:semicolon
DECL|member|iqtx_current
id|u32
id|iqtx_current
suffix:semicolon
DECL|member|tx_dirty
id|u32
id|tx_dirty
suffix:semicolon
DECL|member|bad_tx_frame
r_int
id|bad_tx_frame
suffix:semicolon
DECL|member|bad_rx_frame
r_int
id|bad_rx_frame
suffix:semicolon
DECL|member|rx_needs_refill
r_int
id|rx_needs_refill
suffix:semicolon
DECL|member|tx_fd_dma
id|dma_addr_t
id|tx_fd_dma
suffix:semicolon
DECL|member|rx_fd_dma
id|dma_addr_t
id|rx_fd_dma
suffix:semicolon
DECL|member|iqtx_dma
id|dma_addr_t
id|iqtx_dma
suffix:semicolon
DECL|member|iqrx_dma
id|dma_addr_t
id|iqrx_dma
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|pci_priv
r_struct
id|dscc4_pci_priv
op_star
id|pci_priv
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|dev_id
r_int
id|dev_id
suffix:semicolon
DECL|member|flags
id|u32
id|flags
suffix:semicolon
DECL|member|timer_help
id|u32
id|timer_help
suffix:semicolon
DECL|member|hi_expected
id|u32
id|hi_expected
suffix:semicolon
DECL|member|hdlc
r_struct
id|hdlc_device_struct
id|hdlc
suffix:semicolon
DECL|member|usecount
r_int
id|usecount
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* GLOBAL registers definitions */
DECL|macro|GCMDR
mdefine_line|#define GCMDR   0x00
DECL|macro|GSTAR
mdefine_line|#define GSTAR   0x04
DECL|macro|GMODE
mdefine_line|#define GMODE   0x08
DECL|macro|IQLENR0
mdefine_line|#define IQLENR0 0x0C
DECL|macro|IQLENR1
mdefine_line|#define IQLENR1 0x10
DECL|macro|IQRX0
mdefine_line|#define IQRX0   0x14
DECL|macro|IQTX0
mdefine_line|#define IQTX0   0x24
DECL|macro|IQCFG
mdefine_line|#define IQCFG   0x3c
DECL|macro|FIFOCR1
mdefine_line|#define FIFOCR1 0x44
DECL|macro|FIFOCR2
mdefine_line|#define FIFOCR2 0x48
DECL|macro|FIFOCR3
mdefine_line|#define FIFOCR3 0x4c
DECL|macro|FIFOCR4
mdefine_line|#define FIFOCR4 0x34
DECL|macro|CH0CFG
mdefine_line|#define CH0CFG  0x50
DECL|macro|CH0BRDA
mdefine_line|#define CH0BRDA 0x54
DECL|macro|CH0BTDA
mdefine_line|#define CH0BTDA 0x58
multiline_comment|/* SCC registers definitions */
DECL|macro|SCC_START
mdefine_line|#define SCC_START&t;0x0100
DECL|macro|SCC_OFFSET
mdefine_line|#define SCC_OFFSET      0x80
DECL|macro|CMDR
mdefine_line|#define CMDR    0x00
DECL|macro|STAR
mdefine_line|#define STAR    0x04
DECL|macro|CCR0
mdefine_line|#define CCR0    0x08
DECL|macro|CCR1
mdefine_line|#define CCR1    0x0c
DECL|macro|CCR2
mdefine_line|#define CCR2    0x10
DECL|macro|BRR
mdefine_line|#define BRR     0x2C
DECL|macro|RLCR
mdefine_line|#define RLCR    0x40
DECL|macro|IMR
mdefine_line|#define IMR     0x54
DECL|macro|ISR
mdefine_line|#define ISR     0x58
multiline_comment|/* Bit masks */
DECL|macro|IntRxScc0
mdefine_line|#define IntRxScc0       0x10000000
DECL|macro|IntTxScc0
mdefine_line|#define IntTxScc0       0x01000000
DECL|macro|TxPollCmd
mdefine_line|#define TxPollCmd&t;0x00000400
DECL|macro|RxActivate
mdefine_line|#define RxActivate&t;0x08000000
DECL|macro|MTFi
mdefine_line|#define MTFi&t;&t;0x04000000
DECL|macro|Rdr
mdefine_line|#define Rdr&t;&t;0x00400000
DECL|macro|Rdt
mdefine_line|#define Rdt&t;&t;0x00200000
DECL|macro|Idr
mdefine_line|#define Idr&t;&t;0x00100000
DECL|macro|Idt
mdefine_line|#define Idt&t;&t;0x00080000
DECL|macro|TxSccRes
mdefine_line|#define TxSccRes       0x01000000
DECL|macro|RxSccRes
mdefine_line|#define RxSccRes       0x00010000
DECL|macro|TxSizeMax
mdefine_line|#define TxSizeMax&t;0x1ffc
DECL|macro|RxSizeMax
mdefine_line|#define RxSizeMax&t;0x1ffc
DECL|macro|Ccr0ClockMask
mdefine_line|#define Ccr0ClockMask&t;0x0000003f
DECL|macro|Ccr1LoopMask
mdefine_line|#define Ccr1LoopMask&t;0x00000200
DECL|macro|BrrExpMask
mdefine_line|#define BrrExpMask&t;0x00000f00
DECL|macro|BrrMultMask
mdefine_line|#define BrrMultMask&t;0x0000003f
DECL|macro|EncodingMask
mdefine_line|#define EncodingMask&t;0x00700000
DECL|macro|Hold
mdefine_line|#define Hold&t;&t;0x40000000
DECL|macro|SccBusy
mdefine_line|#define SccBusy&t;&t;0x10000000
DECL|macro|FrameOk
mdefine_line|#define FrameOk&t;&t;(FrameVfr | FrameCrc)
DECL|macro|FrameVfr
mdefine_line|#define FrameVfr&t;0x80
DECL|macro|FrameRdo
mdefine_line|#define FrameRdo&t;0x40
DECL|macro|FrameCrc
mdefine_line|#define FrameCrc&t;0x20
DECL|macro|FrameAborted
mdefine_line|#define FrameAborted&t;0x00000200
DECL|macro|FrameEnd
mdefine_line|#define FrameEnd&t;0x80000000
DECL|macro|DataComplete
mdefine_line|#define DataComplete&t;0x40000000
DECL|macro|LengthCheck
mdefine_line|#define LengthCheck&t;0x00008000
DECL|macro|SccEvt
mdefine_line|#define SccEvt&t;&t;0x02000000
DECL|macro|NoAck
mdefine_line|#define NoAck&t;&t;0x00000200
DECL|macro|Action
mdefine_line|#define Action&t;&t;0x00000001
DECL|macro|HiDesc
mdefine_line|#define HiDesc&t;&t;0x20000000
multiline_comment|/* SCC events */
DECL|macro|RxEvt
mdefine_line|#define RxEvt&t;&t;0xf0000000
DECL|macro|TxEvt
mdefine_line|#define TxEvt&t;&t;0x0f000000
DECL|macro|Alls
mdefine_line|#define Alls&t;&t;0x00040000
DECL|macro|Xdu
mdefine_line|#define Xdu&t;&t;0x00010000
DECL|macro|Xmr
mdefine_line|#define Xmr&t;&t;0x00002000
DECL|macro|Xpr
mdefine_line|#define Xpr&t;&t;0x00001000
DECL|macro|Rdo
mdefine_line|#define Rdo&t;&t;0x00000080
DECL|macro|Rfs
mdefine_line|#define Rfs&t;&t;0x00000040
DECL|macro|Rfo
mdefine_line|#define Rfo&t;&t;0x00000002
DECL|macro|Flex
mdefine_line|#define Flex&t;&t;0x00000001
multiline_comment|/* DMA core events */
DECL|macro|Cfg
mdefine_line|#define Cfg&t;&t;0x00200000
DECL|macro|Hi
mdefine_line|#define Hi&t;&t;0x00040000
DECL|macro|Fi
mdefine_line|#define Fi&t;&t;0x00020000
DECL|macro|Err
mdefine_line|#define Err&t;&t;0x00010000
DECL|macro|Arf
mdefine_line|#define Arf&t;&t;0x00000002
DECL|macro|ArAck
mdefine_line|#define ArAck&t;&t;0x00000001
multiline_comment|/* Misc */
DECL|macro|NeedIDR
mdefine_line|#define NeedIDR&t;&t;0x00000001
DECL|macro|NeedIDT
mdefine_line|#define NeedIDT&t;&t;0x00000002
DECL|macro|RdoSet
mdefine_line|#define RdoSet&t;&t;0x00000004
multiline_comment|/* Functions prototypes */
r_static
id|__inline__
r_void
id|dscc4_rx_irq
c_func
(paren
r_struct
id|dscc4_pci_priv
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|dscc4_tx_irq
c_func
(paren
r_struct
id|dscc4_pci_priv
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_found1
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_int
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
id|dscc4_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
r_int
id|dscc4_open
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_close
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|dscc4_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mtu
)paren
suffix:semicolon
r_static
r_int
id|dscc4_init_ring
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|dscc4_release_ring
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
suffix:semicolon
r_static
r_void
id|dscc4_timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|dscc4_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|dscc4_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|dscc4_get_stats
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_attach_hdlc_device
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|dscc4_unattach_hdlc_device
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_hdlc_open
c_func
(paren
r_struct
id|hdlc_device_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|dscc4_hdlc_close
c_func
(paren
r_struct
id|hdlc_device_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_hdlc_ioctl
c_func
(paren
r_struct
id|hdlc_device_struct
op_star
comma
r_struct
id|ifreq
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|dscc4_hdlc_xmit
c_func
(paren
id|hdlc_device
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
macro_line|#ifdef EXPERIMENTAL_POLLING
r_static
r_int
id|dscc4_tx_poll
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
macro_line|#endif
DECL|function|reset_TxFD
r_void
r_inline
id|reset_TxFD
c_func
(paren
r_struct
id|TxFD
op_star
id|tx_fd
)paren
(brace
multiline_comment|/* FIXME: test with the last arg (size specification) = 0 */
id|tx_fd-&gt;state
op_assign
id|FrameEnd
op_or
id|Hold
op_or
l_int|0x00100000
suffix:semicolon
id|tx_fd-&gt;complete
op_assign
l_int|0x00000000
suffix:semicolon
)brace
DECL|function|dscc4_release_ring_skbuff
r_void
r_inline
id|dscc4_release_ring_skbuff
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|p
comma
r_int
id|n
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|n
OG
l_int|0
suffix:semicolon
id|n
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
)paren
id|dev_kfree_skb
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
)brace
DECL|function|dscc4_release_ring
r_static
r_void
id|dscc4_release_ring
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|dpriv-&gt;pci_priv-&gt;pdev
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|TxFD
)paren
comma
id|dpriv-&gt;tx_fd
comma
id|dpriv-&gt;tx_fd_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|RX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|dpriv-&gt;rx_fd
comma
id|dpriv-&gt;rx_fd_dma
)paren
suffix:semicolon
id|dscc4_release_ring_skbuff
c_func
(paren
id|dpriv-&gt;tx_skbuff
comma
id|TX_RING_SIZE
)paren
suffix:semicolon
id|dscc4_release_ring_skbuff
c_func
(paren
id|dpriv-&gt;rx_skbuff
comma
id|RX_RING_SIZE
)paren
suffix:semicolon
)brace
DECL|function|try_get_rx_skb
r_void
r_inline
id|try_get_rx_skb
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|priv
comma
r_int
id|cur
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_MAX
c_func
(paren
id|HDLC_MAX_MRU
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|priv-&gt;rx_skbuff
(braket
id|cur
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|priv-&gt;rx_fd
(braket
id|cur
op_decrement
)braket
dot
id|data
op_assign
(paren
id|u32
)paren
l_int|NULL
suffix:semicolon
id|priv-&gt;rx_fd
(braket
id|cur
op_mod
id|RX_RING_SIZE
)braket
dot
id|state1
op_or_assign
id|Hold
suffix:semicolon
id|priv-&gt;rx_needs_refill
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|priv-&gt;rx_fd
(braket
id|cur
)braket
dot
id|data
op_assign
id|pci_map_single
c_func
(paren
id|priv-&gt;pci_priv-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * IRQ/thread/whatever safe&n; */
DECL|function|dscc4_wait_ack_cec
r_static
r_int
id|dscc4_wait_ack_cec
c_func
(paren
id|u32
id|ioaddr
comma
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|msg
)paren
(brace
id|s16
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|STAR
)paren
op_amp
id|SccBusy
)paren
(brace
r_if
c_cond
(paren
id|i
op_increment
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s timeout&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s ack (%d try)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
comma
id|i
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dscc4_do_action
r_static
r_int
id|dscc4_do_action
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|msg
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u32
id|state
suffix:semicolon
id|s16
id|i
suffix:semicolon
id|writel
c_func
(paren
id|Action
comma
id|ioaddr
op_plus
id|GCMDR
)paren
suffix:semicolon
id|ioaddr
op_add_assign
id|GSTAR
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|state
op_assign
id|readl
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|Arf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s failed&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
id|writel
c_func
(paren
id|Arf
comma
id|ioaddr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|state
op_amp
id|ArAck
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s ack (%d try)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
comma
id|i
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ArAck
comma
id|ioaddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s timeout&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|dscc4_xpr_ack
r_static
id|__inline__
r_int
id|dscc4_xpr_ack
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
r_int
id|cur
suffix:semicolon
id|s16
id|i
suffix:semicolon
id|cur
op_assign
id|dpriv-&gt;iqtx_current
op_mod
id|IRQ_RING_SIZE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dpriv-&gt;flags
op_amp
(paren
id|NeedIDR
op_or
id|NeedIDT
)paren
)paren
op_logical_or
(paren
id|dpriv-&gt;iqtx
(braket
id|cur
)braket
op_amp
id|Xpr
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s timeout&bslash;n&quot;
comma
l_string|&quot;dscc4&quot;
comma
l_string|&quot;XPR&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|dscc4_rx_skb
r_static
id|__inline__
r_void
id|dscc4_rx_skb
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_int
id|cur
comma
r_struct
id|RxFD
op_star
id|rx_fd
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|dpriv-&gt;pci_priv-&gt;pdev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
id|skb
op_assign
id|dpriv-&gt;rx_skbuff
(braket
id|cur
)braket
suffix:semicolon
id|pkt_len
op_assign
id|TO_SIZE
c_func
(paren
id|rx_fd-&gt;state2
)paren
op_minus
l_int|1
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|pdev
comma
id|rx_fd-&gt;data
comma
id|pkt_len
op_plus
l_int|1
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb-&gt;data
(braket
id|pkt_len
)braket
op_amp
id|FrameOk
)paren
op_eq
id|FrameOk
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|pdev
comma
id|rx_fd-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dpriv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|dpriv-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
id|skb-&gt;tail
op_add_assign
id|pkt_len
suffix:semicolon
id|skb-&gt;len
op_assign
id|pkt_len
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|hdlc_to_dev
c_func
(paren
op_amp
id|dpriv-&gt;hdlc
)paren
)paren
)paren
id|hdlc_netif_rx
c_func
(paren
op_amp
id|dpriv-&gt;hdlc
comma
id|skb
)paren
suffix:semicolon
r_else
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|try_get_rx_skb
c_func
(paren
id|dpriv
comma
id|cur
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|pkt_len
)braket
op_amp
id|FrameRdo
)paren
(brace
id|dpriv-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb-&gt;data
(braket
id|pkt_len
)braket
op_or
op_complement
id|FrameCrc
)paren
)paren
(brace
id|dpriv-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb-&gt;data
(braket
id|pkt_len
)braket
op_or
op_complement
id|FrameVfr
)paren
)paren
(brace
id|dpriv-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
id|dpriv-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
id|rx_fd-&gt;state1
op_or_assign
id|Hold
suffix:semicolon
id|rx_fd-&gt;state2
op_assign
l_int|0x00000000
suffix:semicolon
id|rx_fd-&gt;end
op_assign
l_int|0xbabeface
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rx_fd-&gt;data
)paren
r_return
suffix:semicolon
id|rx_fd
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cur
)paren
id|rx_fd
op_add_assign
id|RX_RING_SIZE
suffix:semicolon
id|rx_fd-&gt;state1
op_and_assign
op_complement
id|Hold
suffix:semicolon
)brace
DECL|function|dscc4_init_one
r_static
r_int
id|__init
id|dscc4_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|dscc4_pci_priv
op_star
id|priv
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_static
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
l_string|&quot;registers&quot;
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;dscc4: can&squot;t reserve MMIO region (regs)&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
l_string|&quot;LBI interface&quot;
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;dscc4: can&squot;t reserve MMIO region (lbi)&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_mmio_region0
suffix:semicolon
)brace
id|ioaddr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dscc4: cannot remap MMIO region %lx @ %lx&bslash;n&quot;
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|err_out_free_mmio_region
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Siemens DSCC4, MMIO at %#lx (regs), %#lx (lbi), IRQ %d.&bslash;n&quot;
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* High PCI latency useless. Cf app. note. */
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0x10
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_found1
c_func
(paren
id|pdev
comma
id|ioaddr
)paren
)paren
r_goto
id|err_out_iounmap
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|dscc4_pci_priv
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
op_amp
id|dscc4_irq
comma
id|SA_SHIRQ
comma
l_string|&quot;dscc4&quot;
comma
id|priv-&gt;root
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dscc4: IRQ %d is busy&bslash;n&quot;
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
r_goto
id|err_out_iounmap
suffix:semicolon
)brace
id|priv-&gt;pdev
op_assign
id|pdev
suffix:semicolon
multiline_comment|/* power up/little endian/dma core controlled via hold bit */
id|writel
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|GMODE
)paren
suffix:semicolon
multiline_comment|/* Shared interrupt queue */
(brace
id|u32
id|bits
suffix:semicolon
id|bits
op_assign
(paren
id|IRQ_RING_SIZE
op_rshift
l_int|5
)paren
op_minus
l_int|1
suffix:semicolon
id|bits
op_or_assign
id|bits
op_lshift
l_int|4
suffix:semicolon
id|bits
op_or_assign
id|bits
op_lshift
l_int|8
suffix:semicolon
id|bits
op_or_assign
id|bits
op_lshift
l_int|16
suffix:semicolon
id|writel
c_func
(paren
id|bits
comma
id|ioaddr
op_plus
id|IQLENR0
)paren
suffix:semicolon
)brace
multiline_comment|/* Global interrupt queue */
id|writel
c_func
(paren
(paren
id|u32
)paren
(paren
(paren
(paren
id|IRQ_RING_SIZE
op_rshift
l_int|5
)paren
op_minus
l_int|1
)paren
op_lshift
l_int|20
)paren
comma
id|ioaddr
op_plus
id|IQLENR1
)paren
suffix:semicolon
id|priv-&gt;iqcfg
op_assign
(paren
id|u32
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
op_amp
id|priv-&gt;iqcfg_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;iqcfg
)paren
r_goto
id|err_out_free_irq
suffix:semicolon
id|writel
c_func
(paren
id|priv-&gt;iqcfg_dma
comma
id|ioaddr
op_plus
id|IQCFG
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * SCC 0-3 private rx/tx irq structures &n;&t; * IQRX/TXi needs to be set soon. Learned it the hard way...&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
(paren
id|priv-&gt;root
op_plus
id|i
)paren
op_member_access_from_pointer
id|priv
suffix:semicolon
id|dpriv-&gt;iqtx
op_assign
(paren
id|u32
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
op_amp
id|dpriv-&gt;iqtx_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dpriv-&gt;iqtx
)paren
r_goto
id|err_out_free_iqtx
suffix:semicolon
id|writel
c_func
(paren
id|dpriv-&gt;iqtx_dma
comma
id|ioaddr
op_plus
id|IQTX0
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
(paren
id|priv-&gt;root
op_plus
id|i
)paren
op_member_access_from_pointer
id|priv
suffix:semicolon
id|dpriv-&gt;iqrx
op_assign
(paren
id|u32
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
op_amp
id|dpriv-&gt;iqrx_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dpriv-&gt;iqrx
)paren
r_goto
id|err_out_free_iqrx
suffix:semicolon
id|writel
c_func
(paren
id|dpriv-&gt;iqrx_dma
comma
id|ioaddr
op_plus
id|IQRX0
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * Cf application hint. Beware of hard-lock condition on &n;&t; * threshold .&n;&t; */
id|writel
c_func
(paren
l_int|0x42104000
comma
id|ioaddr
op_plus
id|FIFOCR1
)paren
suffix:semicolon
singleline_comment|//writel(0x9ce69800, ioaddr + FIFOCR2);
id|writel
c_func
(paren
l_int|0xdef6d800
comma
id|ioaddr
op_plus
id|FIFOCR2
)paren
suffix:semicolon
singleline_comment|//writel(0x11111111, ioaddr + FIFOCR4);
id|writel
c_func
(paren
l_int|0x18181818
comma
id|ioaddr
op_plus
id|FIFOCR4
)paren
suffix:semicolon
singleline_comment|// FIXME: should depend on the chipset revision
id|writel
c_func
(paren
l_int|0x0000000e
comma
id|ioaddr
op_plus
id|FIFOCR3
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xff200001
comma
id|ioaddr
op_plus
id|GCMDR
)paren
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_free_iqrx
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
(brace
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
(paren
id|priv-&gt;root
op_plus
id|i
)paren
op_member_access_from_pointer
id|priv
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|dpriv-&gt;iqrx
comma
id|dpriv-&gt;iqrx_dma
)paren
suffix:semicolon
)brace
id|i
op_assign
id|dev_per_card
suffix:semicolon
id|err_out_free_iqtx
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
(brace
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
(paren
id|priv-&gt;root
op_plus
id|i
)paren
op_member_access_from_pointer
id|priv
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|dpriv-&gt;iqtx
comma
id|dpriv-&gt;iqtx_dma
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|priv-&gt;iqcfg
comma
id|priv-&gt;iqcfg_dma
)paren
suffix:semicolon
id|err_out_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|priv-&gt;root
)paren
suffix:semicolon
id|err_out_iounmap
suffix:colon
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|ioaddr
)paren
suffix:semicolon
id|err_out_free_mmio_region
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|err_out_free_mmio_region0
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
suffix:semicolon
DECL|function|dscc4_found1
r_static
r_int
id|dscc4_found1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|ioaddr
)paren
(brace
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|kmalloc
c_func
(paren
id|dev_per_card
op_star
r_sizeof
(paren
r_struct
id|dscc4_dev_priv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dpriv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dscc4: can&squot;t allocate data&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dpriv
comma
l_int|0
comma
id|dev_per_card
op_star
r_sizeof
(paren
r_struct
id|dscc4_dev_priv
)paren
)paren
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|kmalloc
c_func
(paren
id|dev_per_card
op_star
r_sizeof
(paren
r_struct
id|net_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dscc4: can&squot;t allocate net_device&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_dealloc_priv
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
id|dev_per_card
op_star
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|ppriv
op_assign
(paren
r_struct
id|dscc4_pci_priv
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dscc4_pci_priv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppriv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dscc4: can&squot;t allocate pci private data.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_dealloc_dev
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ppriv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dscc4_pci_priv
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|p
suffix:semicolon
r_struct
id|net_device
op_star
id|d
suffix:semicolon
id|d
op_assign
id|dev
op_plus
id|i
suffix:semicolon
id|d-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|d-&gt;init
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
multiline_comment|/* The card adds the crc */
id|d-&gt;type
op_assign
id|ARPHRD_RAWHDLC
suffix:semicolon
id|d-&gt;open
op_assign
id|dscc4_open
suffix:semicolon
id|d-&gt;stop
op_assign
id|dscc4_close
suffix:semicolon
id|d-&gt;hard_start_xmit
op_assign
id|dscc4_start_xmit
suffix:semicolon
id|d-&gt;set_multicast_list
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;do_ioctl
op_assign
id|dscc4_ioctl
suffix:semicolon
id|d-&gt;get_stats
op_assign
id|dscc4_get_stats
suffix:semicolon
id|d-&gt;change_mtu
op_assign
id|dscc4_change_mtu
suffix:semicolon
id|d-&gt;mtu
op_assign
id|HDLC_MAX_MTU
suffix:semicolon
id|d-&gt;flags
op_assign
id|IFF_MULTICAST
op_or
id|IFF_POINTOPOINT
op_or
id|IFF_NOARP
suffix:semicolon
id|d-&gt;tx_timeout
op_assign
id|dscc4_tx_timeout
suffix:semicolon
id|d-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|p
op_assign
id|dpriv
op_plus
id|i
suffix:semicolon
id|p-&gt;dev_id
op_assign
id|i
suffix:semicolon
id|p-&gt;pci_priv
op_assign
id|ppriv
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|p-&gt;lock
)paren
suffix:semicolon
id|d-&gt;priv
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
id|dev_alloc_name
c_func
(paren
id|d
comma
l_string|&quot;scc%d&quot;
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dev_alloc_name failed for scc.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_dealloc_dev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|d
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: register_netdev != 0.&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
r_goto
id|err_dealloc_dev
suffix:semicolon
)brace
id|dscc4_attach_hdlc_device
c_func
(paren
id|d
)paren
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|d
)paren
suffix:semicolon
)brace
id|ppriv-&gt;root
op_assign
id|dev
suffix:semicolon
id|ppriv-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ppriv-&gt;lock
)paren
suffix:semicolon
id|pdev-&gt;driver_data
op_assign
id|ppriv
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|ppriv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_dealloc_dev
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
id|unregister_netdev
c_func
(paren
id|dev
op_plus
id|i
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_dealloc_priv
suffix:colon
id|kfree
c_func
(paren
id|dpriv
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
suffix:semicolon
DECL|function|dscc4_timer
r_static
r_void
id|dscc4_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
suffix:semicolon
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
id|dpriv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|dev-&gt;trans_start
)paren
OG
id|TX_TIMEOUT
)paren
)paren
(brace
id|ppriv
op_assign
id|dpriv-&gt;pci_priv
suffix:semicolon
r_if
c_cond
(paren
id|dpriv-&gt;iqtx
(braket
id|dpriv-&gt;iqtx_current
op_mod
id|IRQ_RING_SIZE
)braket
)paren
(brace
id|u32
id|flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: pending events&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ppriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dscc4_tx_irq
c_func
(paren
id|ppriv
comma
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ppriv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: missing events&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|i
op_assign
id|dpriv-&gt;tx_dirty
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|j
op_assign
id|dpriv-&gt;tx_current
op_minus
id|dpriv-&gt;tx_dirty
suffix:semicolon
id|dpriv-&gt;stats.tx_dropped
op_add_assign
id|j
suffix:semicolon
r_while
c_loop
(paren
id|j
op_decrement
)paren
(brace
id|skb
op_assign
id|dpriv-&gt;tx_skbuff
(braket
id|i
)braket
suffix:semicolon
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dpriv-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ppriv-&gt;pdev
comma
id|tx_fd-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: hardware on drugs!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tx_fd-&gt;data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DEBUG */
id|tx_fd-&gt;complete
op_and_assign
op_complement
id|DataComplete
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|i
op_mod_assign
id|TX_RING_SIZE
suffix:semicolon
)brace
id|dpriv-&gt;tx_dirty
op_assign
id|dpriv-&gt;tx_current
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: re-enabled&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
id|dpriv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TX_TIMEOUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|dpriv-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|dscc4_tx_timeout
r_static
r_void
id|dscc4_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* FIXME: something is missing there */
)brace
suffix:semicolon
DECL|function|dscc4_open
r_static
r_int
id|dscc4_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
id|u32
id|ioaddr
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|ppriv
op_assign
id|dpriv-&gt;pci_priv
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_init_ring
c_func
(paren
id|dev
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
suffix:semicolon
multiline_comment|/* FIXME: VIS */
id|writel
c_func
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|CCR0
)paren
op_or
l_int|0x80001000
comma
id|ioaddr
op_plus
id|CCR0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|LengthCheck
op_or
(paren
id|HDLC_MAX_MRU
op_rshift
l_int|5
)paren
comma
id|ioaddr
op_plus
id|RLCR
)paren
suffix:semicolon
multiline_comment|/* no address recognition/crc-CCITT/cts enabled */
id|writel
c_func
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|CCR1
)paren
op_or
l_int|0x021c8000
comma
id|ioaddr
op_plus
id|CCR1
)paren
suffix:semicolon
multiline_comment|/* Ccr2.Rac = 0 */
id|writel
c_func
(paren
l_int|0x00050008
op_amp
op_complement
id|RxActivate
comma
id|ioaddr
op_plus
id|CCR2
)paren
suffix:semicolon
macro_line|#ifdef EXPERIMENTAL_POLLING
id|writel
c_func
(paren
l_int|0xfffeef7f
comma
id|ioaddr
op_plus
id|IMR
)paren
suffix:semicolon
multiline_comment|/* Interrupt mask */
macro_line|#else
multiline_comment|/* Don&squot;t mask RDO. Ever. */
singleline_comment|//writel(0xfffaef7f, ioaddr + IMR); /* Interrupt mask */
id|writel
c_func
(paren
l_int|0xfffaef7e
comma
id|ioaddr
op_plus
id|IMR
)paren
suffix:semicolon
multiline_comment|/* Interrupt mask */
macro_line|#endif
multiline_comment|/* IDT+IDR during XPR */
id|dpriv-&gt;flags
op_assign
id|NeedIDR
op_or
id|NeedIDT
suffix:semicolon
multiline_comment|/*&n;&t; * The following is a bit paranoid...&n;&t; *&n;&t; * NB: the datasheet &quot;...CEC will stay active if the SCC is in&n;&t; * power-down mode or...&quot; and CCR2.RAC = 1 are two different&n;&t; * situations.&n;&t; */
r_if
c_cond
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|STAR
)paren
op_amp
id|SccBusy
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s busy. Try later&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|err_free_ring
suffix:semicolon
)brace
id|writel
c_func
(paren
id|TxSccRes
op_or
id|RxSccRes
comma
id|ioaddr
op_plus
id|CMDR
)paren
suffix:semicolon
multiline_comment|/* ... the following isn&squot;t */
r_if
c_cond
(paren
id|dscc4_wait_ack_cec
c_func
(paren
id|ioaddr
comma
id|dev
comma
l_string|&quot;Cec&quot;
)paren
)paren
r_goto
id|err_free_ring
suffix:semicolon
multiline_comment|/* &n;&t; * I would expect XPR near CE completion (before ? after ?).&n;&t; * At worst, this code won&squot;t see a late XPR and people&n;&t; * will have to re-issue an ifconfig (this is harmless). &n;&t; * WARNING, a really missing XPR usually means a hardware &n;&t; * reset is needed. Suggestions anyone ?&n;&t; */
r_if
c_cond
(paren
id|dscc4_xpr_ack
c_func
(paren
id|dpriv
)paren
)paren
r_goto
id|err_free_ring
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|dpriv-&gt;timer
)paren
suffix:semicolon
id|dpriv-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|dpriv-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|dpriv-&gt;timer.function
op_assign
op_amp
id|dscc4_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|dpriv-&gt;timer
)paren
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_free_ring
suffix:colon
id|dscc4_release_ring
c_func
(paren
id|dpriv
)paren
suffix:semicolon
id|err_out
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#ifdef EXPERIMENTAL_POLLING
DECL|function|dscc4_tx_poll
r_static
r_int
id|dscc4_tx_poll
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* FIXME: it&squot;s gonna be easy (TM), for sure */
)brace
macro_line|#endif /* EXPERIMENTAL_POLLING */
DECL|function|dscc4_start_xmit
r_static
r_int
id|dscc4_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
r_int
id|cur
comma
id|next
suffix:semicolon
id|ppriv
op_assign
id|dpriv-&gt;pci_priv
suffix:semicolon
id|cur
op_assign
id|dpriv-&gt;tx_current
op_increment
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|next
op_assign
id|dpriv-&gt;tx_current
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|dpriv-&gt;tx_skbuff
(braket
id|next
)braket
op_assign
id|skb
suffix:semicolon
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
op_plus
id|next
suffix:semicolon
id|tx_fd-&gt;state
op_assign
id|FrameEnd
op_or
id|Hold
op_or
id|TO_STATE
c_func
(paren
id|skb-&gt;len
op_amp
id|TxSizeMax
)paren
suffix:semicolon
id|tx_fd-&gt;data
op_assign
id|pci_map_single
c_func
(paren
id|ppriv-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|tx_fd-&gt;complete
op_assign
l_int|0x00000000
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// FIXME: suppress ?
macro_line|#ifdef EXPERIMENTAL_POLLING
id|spin_lock
c_func
(paren
op_amp
id|dpriv-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dscc4_tx_poll
c_func
(paren
id|dpriv
comma
id|dev
)paren
)paren
(brace
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dpriv-&gt;lock
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * I know there&squot;s a window for a race in the following lines but&n;&t; * dscc4_timer will take good care of it. The chipset eats events&n;&t; * (especially the net_dev re-enabling ones) thus there is no&n;&t; * reason to try and be smart.&n;&t; */
r_if
c_cond
(paren
(paren
id|dpriv-&gt;tx_dirty
op_plus
l_int|16
)paren
OL
id|dpriv-&gt;tx_current
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dpriv-&gt;hi_expected
op_assign
l_int|2
suffix:semicolon
)brace
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
op_plus
id|cur
suffix:semicolon
id|tx_fd-&gt;state
op_and_assign
op_complement
id|Hold
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// FIXME: suppress ?
multiline_comment|/* &n;&t; * One may avoid some pci transactions during intense TX periods.&n;&t; * Not sure it&squot;s worth the pain...&n;&t; */
id|writel
c_func
(paren
(paren
id|TxPollCmd
op_lshift
id|dpriv-&gt;dev_id
)paren
op_or
id|NoAck
comma
id|dev-&gt;base_addr
op_plus
id|GCMDR
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dscc4_close
r_static
r_int
id|dscc4_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|dev_id
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|dpriv-&gt;timer
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev_id
op_assign
id|dpriv-&gt;dev_id
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00050000
comma
id|ioaddr
op_plus
id|SCC_REG_START
c_func
(paren
id|dev_id
)paren
op_plus
id|CCR2
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MTFi
op_or
id|Rdr
op_or
id|Rdt
comma
id|ioaddr
op_plus
id|CH0CFG
op_plus
id|dev_id
op_star
l_int|0x0c
)paren
suffix:semicolon
multiline_comment|/* Reset Rx/Tx */
id|writel
c_func
(paren
l_int|0x00000001
comma
id|ioaddr
op_plus
id|GCMDR
)paren
suffix:semicolon
id|dscc4_release_ring
c_func
(paren
id|dpriv
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dscc4_set_clock
r_static
r_int
id|dscc4_set_clock
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|bps
comma
id|u32
op_star
id|state
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u32
id|brr
suffix:semicolon
op_star
id|state
op_and_assign
op_complement
id|Ccr0ClockMask
suffix:semicolon
r_if
c_cond
(paren
op_star
id|bps
)paren
(brace
multiline_comment|/* DCE */
id|u32
id|n
op_assign
l_int|0
comma
id|m
op_assign
l_int|0
comma
id|divider
suffix:semicolon
r_int
id|xtal
suffix:semicolon
id|xtal
op_assign
id|dpriv-&gt;pci_priv-&gt;xtal_hz
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xtal
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|divider
op_assign
id|xtal
op_div
op_star
id|bps
suffix:semicolon
r_if
c_cond
(paren
id|divider
OG
id|BRR_DIVIDER_MAX
)paren
(brace
id|divider
op_rshift_assign
l_int|4
suffix:semicolon
op_star
id|state
op_or_assign
l_int|0x00000036
suffix:semicolon
multiline_comment|/* Clock mode 6b (BRG/16) */
)brace
r_else
op_star
id|state
op_or_assign
l_int|0x00000037
suffix:semicolon
multiline_comment|/* Clock mode 7b (BRG) */
r_if
c_cond
(paren
id|divider
op_rshift
l_int|22
)paren
(brace
id|n
op_assign
l_int|63
suffix:semicolon
id|m
op_assign
l_int|15
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|divider
)paren
(brace
multiline_comment|/* Extraction of the 6 highest weighted bits */
id|m
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|0xffffffc0
op_amp
id|divider
)paren
(brace
id|m
op_increment
suffix:semicolon
id|divider
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|n
op_assign
id|divider
suffix:semicolon
)brace
id|brr
op_assign
(paren
id|m
op_lshift
l_int|8
)paren
op_or
id|n
suffix:semicolon
id|divider
op_assign
id|n
op_lshift
id|m
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|state
op_amp
l_int|0x00000001
)paren
)paren
multiline_comment|/* Clock mode 6b */
id|divider
op_lshift_assign
l_int|4
suffix:semicolon
op_star
id|bps
op_assign
id|xtal
op_div
id|divider
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DTE */
multiline_comment|/* &n;&t;&t; * &quot;state&quot; already reflects Clock mode 0a. &n;&t;&t; * Nothing more to be done &n;&t;&t; */
id|brr
op_assign
l_int|0
suffix:semicolon
)brace
id|writel
c_func
(paren
id|brr
comma
id|dev-&gt;base_addr
op_plus
id|BRR
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef LATER_PLEASE
multiline_comment|/*&n; * -*- [RFC] Configuring Synchronous Interfaces in Linux -*-&n; */
singleline_comment|// FIXME: MEDIA already defined in linux/hdlc.h
DECL|macro|HDLC_MEDIA_V35
mdefine_line|#define HDLC_MEDIA_V35&t;&t;0
DECL|macro|HDLC_MEDIA_RS232
mdefine_line|#define HDLC_MEDIA_RS232&t;1
DECL|macro|HDLC_MEDIA_X21
mdefine_line|#define HDLC_MEDIA_X21&t;&t;2
DECL|macro|HDLC_MEDIA_E1
mdefine_line|#define HDLC_MEDIA_E1&t;&t;3
DECL|macro|HDLC_MEDIA_HSSI
mdefine_line|#define HDLC_MEDIA_HSSI&t;&t;4
DECL|macro|HDLC_CODING_NRZ
mdefine_line|#define HDLC_CODING_NRZ&t;&t;0
DECL|macro|HDLC_CODING_NRZI
mdefine_line|#define HDLC_CODING_NRZI&t;1
DECL|macro|HDLC_CODING_FM0
mdefine_line|#define HDLC_CODING_FM0&t;&t;2
DECL|macro|HDLC_CODING_FM1
mdefine_line|#define HDLC_CODING_FM1&t;&t;3
DECL|macro|HDLC_CODING_MANCHESTER
mdefine_line|#define HDLC_CODING_MANCHESTER&t;4
DECL|macro|HDLC_CRC_NONE
mdefine_line|#define HDLC_CRC_NONE&t;&t;0
DECL|macro|HDLC_CRC_16
mdefine_line|#define HDLC_CRC_16&t;&t;1
DECL|macro|HDLC_CRC_32
mdefine_line|#define HDLC_CRC_32&t;&t;2
DECL|macro|HDLC_CRC_CCITT
mdefine_line|#define HDLC_CRC_CCITT&t;&t;3
multiline_comment|/* RFC: add the crc reset value ? */
DECL|struct|hdlc_physical
r_struct
id|hdlc_physical
(brace
DECL|member|media
id|u8
id|media
suffix:semicolon
DECL|member|coding
id|u8
id|coding
suffix:semicolon
DECL|member|rate
id|u32
id|rate
suffix:semicolon
DECL|member|crc
id|u8
id|crc
suffix:semicolon
DECL|member|crc_siz
id|u8
id|crc_siz
suffix:semicolon
multiline_comment|/* 2 or 4 bytes */
DECL|member|shared_flags
id|u8
id|shared_flags
suffix:semicolon
multiline_comment|/* Discouraged on the DSCC4 */
)brace
suffix:semicolon
singleline_comment|// FIXME: PROTO already defined in linux/hdlc.h
DECL|macro|HDLC_PROTO_RAW
mdefine_line|#define HDLC_PROTO_RAW&t;&t;0
DECL|macro|HDLC_PROTO_FR
mdefine_line|#define HDLC_PROTO_FR&t;&t;1
DECL|macro|HDLC_PROTO_X25
mdefine_line|#define HDLC_PROTO_X25&t;&t;2
DECL|macro|HDLC_PROTO_PPP
mdefine_line|#define HDLC_PROTO_PPP&t;&t;3
DECL|macro|HDLC_PROTO_CHDLC
mdefine_line|#define HDLC_PROTO_CHDLC&t;4
DECL|struct|hdlc_protocol
r_struct
id|hdlc_protocol
(brace
DECL|member|proto
id|u8
id|proto
suffix:semicolon
r_union
(brace
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|screq
r_struct
id|screq
(brace
DECL|member|media_group
id|u16
id|media_group
suffix:semicolon
r_union
(brace
DECL|member|hdlc_phy
r_struct
id|hdlc_physical
id|hdlc_phy
suffix:semicolon
DECL|member|hdlc_proto
r_struct
id|hdlc_protocol
id|hdlc_proto
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
singleline_comment|// FIXME: go sub-module 
r_static
r_struct
(brace
DECL|member|coding
id|u16
id|coding
suffix:semicolon
DECL|member|bits
id|u16
id|bits
suffix:semicolon
DECL|variable|map
)brace
id|map
(braket
)braket
op_assign
(brace
(brace
id|HDLC_CODING_NRZ
comma
l_int|0x00
)brace
comma
(brace
id|HDLC_CODING_NRZI
comma
l_int|0x20
)brace
comma
(brace
id|HDLC_CODING_FM0
comma
l_int|0x40
)brace
comma
(brace
id|HDLC_CODING_FM1
comma
l_int|0x50
)brace
comma
(brace
id|HDLC_CODING_MANCHESTER
comma
l_int|0x60
)brace
comma
(brace
l_int|65535
comma
l_int|0x00
)brace
)brace
suffix:semicolon
macro_line|#endif /* LATER_PLEASE */
DECL|function|dscc4_ioctl
r_static
r_int
id|dscc4_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|state
comma
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* Set built-in quartz frequency */
r_case
id|SIOCDEVPRIVATE
suffix:colon
(brace
id|u32
id|hz
suffix:semicolon
id|hz
op_assign
id|ifr-&gt;ifr_ifru.ifru_ivalue
suffix:semicolon
r_if
c_cond
(paren
id|hz
op_ge
l_int|33000000
)paren
multiline_comment|/* 33 MHz */
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|dpriv-&gt;pci_priv-&gt;xtal_hz
op_assign
id|hz
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set/unset loopback */
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|1
suffix:colon
(brace
id|u32
id|flags
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
op_plus
id|CCR1
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
suffix:semicolon
id|state
op_assign
id|readl
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|flags
op_assign
id|ifr-&gt;ifr_ifru.ifru_ivalue
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|0x00000001
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: loopback&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|state
op_or_assign
l_int|0x00000100
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: normal&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|state
op_and_assign
op_complement
l_int|0x00000100
suffix:semicolon
)brace
id|writel
c_func
(paren
id|state
comma
id|ioaddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef LATER_PLEASE
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|2
suffix:colon
(brace
(brace
r_struct
id|screq
id|scr
suffix:semicolon
id|err
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|scr
comma
id|ifr-&gt;ifr_ifru.ifru_data
comma
r_sizeof
(paren
r_struct
id|screq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|scr.u.hdlc_phy.coding
op_eq
id|map
(braket
id|i
)braket
dot
id|coding
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|map
(braket
op_increment
id|i
)braket
dot
id|coding
op_ne
l_int|65535
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|map
(braket
id|i
)braket
dot
id|coding
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
op_plus
id|CCR0
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
suffix:semicolon
id|state
op_assign
id|readl
c_func
(paren
id|ioaddr
)paren
op_amp
op_complement
id|EncodingMask
suffix:semicolon
id|state
op_or_assign
(paren
id|u32
)paren
id|map
(braket
id|i
)braket
dot
id|bits
op_lshift
l_int|16
suffix:semicolon
id|writel
c_func
(paren
id|state
comma
id|ioaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;state: %08x&bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
multiline_comment|/* DEBUG */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SIOCDEVPRIVATE
op_plus
l_int|3
suffix:colon
(brace
r_struct
id|screq
op_star
id|scr
op_assign
(paren
r_struct
id|screq
op_star
)paren
id|ifr-&gt;ifr_ifru.ifru_data
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
op_plus
id|CCR0
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
suffix:semicolon
id|state
op_assign
(paren
id|readl
c_func
(paren
id|ioaddr
)paren
op_amp
id|EncodingMask
)paren
op_rshift
l_int|16
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|state
op_eq
id|map
(braket
id|i
)braket
dot
id|bits
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|map
(braket
op_increment
id|i
)braket
dot
id|coding
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|map
(braket
id|i
)braket
dot
id|coding
comma
(paren
id|u16
op_star
)paren
id|scr-&gt;u.hdlc_phy.coding
)paren
suffix:semicolon
)brace
macro_line|#endif /* LATER_PLEASE */
r_case
id|HDLCSCLOCKRATE
suffix:colon
(brace
id|u32
id|state
comma
id|bps
suffix:semicolon
id|bps
op_assign
id|ifr-&gt;ifr_ifru.ifru_ivalue
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
op_plus
id|CCR0
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
suffix:semicolon
id|state
op_assign
id|readl
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_set_clock
c_func
(paren
id|dev
comma
op_amp
id|bps
comma
op_amp
id|state
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bps
)paren
(brace
multiline_comment|/* DCE */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: generated RxClk (DCE)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ifr-&gt;ifr_ifru.ifru_ivalue
op_assign
id|bps
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DTE */
id|state
op_assign
l_int|0x80001000
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: external RxClk (DTE)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|state
comma
id|ioaddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|HDLCGCLOCKRATE
suffix:colon
(brace
id|u32
id|brr
suffix:semicolon
r_int
id|bps
suffix:semicolon
id|brr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|BRR
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
)paren
suffix:semicolon
id|bps
op_assign
id|dpriv-&gt;pci_priv-&gt;xtal_hz
op_rshift
(paren
id|brr
op_rshift
l_int|8
)paren
suffix:semicolon
id|bps
op_div_assign
(paren
id|brr
op_amp
l_int|0x3f
)paren
op_plus
l_int|1
suffix:semicolon
id|ifr-&gt;ifr_ifru.ifru_ivalue
op_assign
id|bps
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|dscc4_change_mtu
r_static
r_int
id|dscc4_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mtu
)paren
(brace
multiline_comment|/* FIXME: chainsaw coded... */
r_if
c_cond
(paren
(paren
id|mtu
op_le
l_int|3
)paren
op_logical_or
(paren
id|mtu
OG
l_int|65531
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|dev-&gt;mtu
op_assign
id|mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dscc4_irq
r_static
r_void
id|dscc4_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|dscc4_pci_priv
op_star
id|priv
suffix:semicolon
id|u32
id|ioaddr
comma
id|state
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|priv
op_assign
(paren
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|pci_priv
suffix:semicolon
multiline_comment|/* &n;&t; * FIXME: shorten the protected area (set some bit telling we&squot;re&n;&t; * in an interrupt or increment some work-to-do counter etc...)&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|state
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|GSTAR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
r_goto
id|out
suffix:semicolon
id|writel
c_func
(paren
id|state
comma
id|ioaddr
op_plus
id|GSTAR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|Arf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: failure (Arf). Harass the maintener&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|state
op_and_assign
op_complement
id|ArAck
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|Cfg
)paren
(brace
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;CfgIV&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;iqcfg
(braket
id|priv-&gt;cfg_cur
op_increment
op_mod
id|IRQ_RING_SIZE
)braket
op_amp
id|Arf
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s failed&bslash;n&quot;
comma
id|dev-&gt;name
comma
l_string|&quot;CFG&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Cfg
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|RxEvt
)paren
(brace
id|i
op_assign
id|dev_per_card
op_minus
l_int|1
suffix:semicolon
r_do
(brace
id|dscc4_rx_irq
c_func
(paren
id|priv
comma
id|dev
op_plus
id|i
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
suffix:semicolon
id|state
op_and_assign
op_complement
id|RxEvt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|TxEvt
)paren
(brace
id|i
op_assign
id|dev_per_card
op_minus
l_int|1
suffix:semicolon
r_do
(brace
id|dscc4_tx_irq
c_func
(paren
id|priv
comma
id|dev
op_plus
id|i
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
suffix:semicolon
id|state
op_and_assign
op_complement
id|TxEvt
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|dscc4_tx_irq
r_static
id|__inline__
r_void
id|dscc4_tx_irq
c_func
(paren
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|state
suffix:semicolon
r_int
id|cur
comma
id|loop
op_assign
l_int|0
suffix:semicolon
r_try
suffix:colon
id|cur
op_assign
id|dpriv-&gt;iqtx_current
op_mod
id|IRQ_RING_SIZE
suffix:semicolon
id|state
op_assign
id|dpriv-&gt;iqtx
(braket
id|cur
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|loop
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Tx irq loop=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|loop
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|loop
op_logical_and
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
r_if
c_cond
(paren
(paren
id|dpriv-&gt;tx_dirty
op_plus
l_int|8
)paren
op_ge
id|dpriv-&gt;tx_current
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|loop
op_increment
suffix:semicolon
id|dpriv-&gt;iqtx
(braket
id|cur
)braket
op_assign
l_int|0
suffix:semicolon
id|dpriv-&gt;iqtx_current
op_increment
suffix:semicolon
macro_line|#ifdef DEBUG_PARANOID
r_if
c_cond
(paren
id|SOURCE_ID
c_func
(paren
id|state
)paren
op_ne
id|dpriv-&gt;dev_id
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s (Tx): Source Id=%d, state=%08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|SOURCE_ID
c_func
(paren
id|state
)paren
comma
id|state
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
l_int|0x0df80c00
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s (Tx): state=%08x (UFO alert)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|state
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
singleline_comment|// state &amp;= 0x0fffffff; /* Tracking the analyzed bits */
r_if
c_cond
(paren
id|state
op_amp
id|SccEvt
)paren
(brace
r_if
c_cond
(paren
id|state
op_amp
id|Alls
)paren
(brace
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|cur
op_assign
id|dpriv-&gt;tx_dirty
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
op_plus
id|cur
suffix:semicolon
id|skb
op_assign
id|dpriv-&gt;tx_skbuff
(braket
id|cur
)braket
suffix:semicolon
multiline_comment|/* XXX: hideous kludge - to be removed &quot;later&quot; */
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: NULL skb in tx_irq at index %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cur
)paren
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
id|dpriv-&gt;tx_dirty
op_increment
suffix:semicolon
singleline_comment|// MUST be after skb test
multiline_comment|/* Happens sometime. Don&squot;t know what triggers it */
r_if
c_cond
(paren
op_logical_neg
(paren
id|tx_fd-&gt;complete
op_amp
id|DataComplete
)paren
)paren
(brace
id|u32
id|ioaddr
comma
id|isr
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
op_plus
id|ISR
suffix:semicolon
id|isr
op_assign
id|readl
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: DataComplete=0 cur=%d isr=%08x state=%08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cur
comma
id|isr
comma
id|state
)paren
suffix:semicolon
id|writel
c_func
(paren
id|isr
comma
id|ioaddr
)paren
suffix:semicolon
id|dpriv-&gt;stats.tx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|tx_fd-&gt;complete
op_and_assign
op_complement
id|DataComplete
suffix:semicolon
r_if
c_cond
(paren
id|tx_fd-&gt;state
op_amp
id|FrameEnd
)paren
(brace
id|dpriv-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|dpriv-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
)brace
id|dpriv-&gt;tx_skbuff
(braket
id|cur
)braket
op_assign
l_int|NULL
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ppriv-&gt;pdev
comma
id|tx_fd-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|tx_fd-&gt;data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DEBUG */
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
(brace
singleline_comment|// DEBUG
id|cur
op_assign
(paren
id|dpriv-&gt;tx_dirty
op_minus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
op_plus
id|cur
suffix:semicolon
id|tx_fd-&gt;state
op_or_assign
id|Hold
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Alls
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; * Transmit Data Underrun&n;&t;&t; */
r_if
c_cond
(paren
id|state
op_amp
id|Xdu
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dscc4: XDU. Contact maintainer&bslash;n&quot;
)paren
suffix:semicolon
id|dpriv-&gt;flags
op_assign
id|NeedIDT
suffix:semicolon
multiline_comment|/* Tx reset */
id|writel
c_func
(paren
id|MTFi
op_or
id|Rdt
comma
id|dev-&gt;base_addr
op_plus
l_int|0x0c
op_star
id|dpriv-&gt;dev_id
op_plus
id|CH0CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00000001
comma
id|dev-&gt;base_addr
op_plus
id|GCMDR
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Xmr
)paren
(brace
multiline_comment|/* Frame needs to be sent again - FIXME */
singleline_comment|//dscc4_start_xmit(dpriv-&gt;tx_skbuff[dpriv-&gt;tx_dirty], dev);
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
l_int|0x00002000
)paren
)paren
multiline_comment|/* DEBUG */
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Xpr
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|scc_offset
suffix:semicolon
id|u32
id|scc_addr
suffix:semicolon
id|scc_offset
op_assign
id|ioaddr
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
suffix:semicolon
id|scc_addr
op_assign
id|ioaddr
op_plus
l_int|0x0c
op_star
id|dpriv-&gt;dev_id
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
id|scc_offset
op_plus
id|STAR
)paren
op_amp
id|SccBusy
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s busy. Fatal&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Keep this order: IDT before IDR&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dpriv-&gt;flags
op_amp
id|NeedIDT
)paren
(brace
id|writel
c_func
(paren
id|MTFi
op_or
id|Idt
comma
id|scc_addr
op_plus
id|CH0CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dpriv-&gt;tx_fd_dma
op_plus
(paren
id|dpriv-&gt;tx_dirty
op_mod
id|TX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|TxFD
)paren
comma
id|scc_addr
op_plus
id|CH0BTDA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;IDT&quot;
)paren
)paren
(brace
r_goto
id|err_xpr
suffix:semicolon
)brace
id|dpriv-&gt;flags
op_and_assign
op_complement
id|NeedIDT
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dpriv-&gt;flags
op_amp
id|NeedIDR
)paren
(brace
id|writel
c_func
(paren
id|MTFi
op_or
id|Idr
comma
id|scc_addr
op_plus
id|CH0CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dpriv-&gt;rx_fd_dma
op_plus
(paren
id|dpriv-&gt;rx_current
op_mod
id|RX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|scc_addr
op_plus
id|CH0BRDA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;IDR&quot;
)paren
)paren
(brace
r_goto
id|err_xpr
suffix:semicolon
)brace
id|dpriv-&gt;flags
op_and_assign
op_complement
id|NeedIDR
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Activate receiver and misc */
id|writel
c_func
(paren
l_int|0x08050008
comma
id|scc_offset
op_plus
id|CCR2
)paren
suffix:semicolon
)brace
id|err_xpr
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Xpr
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ! SccEvt */
r_if
c_cond
(paren
id|state
op_amp
id|Hi
)paren
(brace
macro_line|#ifdef EXPERIMENTAL_POLLING
r_while
c_loop
(paren
op_logical_neg
id|dscc4_tx_poll
c_func
(paren
id|dpriv
comma
id|dev
)paren
)paren
(brace
suffix:semicolon
)brace
macro_line|#endif
id|state
op_and_assign
op_complement
id|Hi
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * FIXME: it may be avoided. Re-re-re-read the manual.&n;&t;&t; */
r_if
c_cond
(paren
id|state
op_amp
id|Err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Tx ERR&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dpriv-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|state
op_and_assign
op_complement
id|Err
suffix:semicolon
)brace
)brace
r_goto
r_try
suffix:semicolon
)brace
r_static
id|__inline__
r_void
id|dscc4_rx_irq
c_func
(paren
r_struct
id|dscc4_pci_priv
op_star
id|priv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|state
suffix:semicolon
r_int
id|cur
suffix:semicolon
r_try
suffix:colon
id|cur
op_assign
id|dpriv-&gt;iqrx_current
op_mod
id|IRQ_RING_SIZE
suffix:semicolon
id|state
op_assign
id|dpriv-&gt;iqrx
(braket
id|cur
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
r_return
suffix:semicolon
id|dpriv-&gt;iqrx
(braket
id|cur
)braket
op_assign
l_int|0
suffix:semicolon
id|dpriv-&gt;iqrx_current
op_increment
suffix:semicolon
macro_line|#ifdef DEBUG_PARANOID
r_if
c_cond
(paren
id|SOURCE_ID
c_func
(paren
id|state
)paren
op_ne
id|dpriv-&gt;dev_id
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s (Rx): Source Id=%d, state=%08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|SOURCE_ID
c_func
(paren
id|state
)paren
comma
id|state
)paren
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
l_int|0x0df80c00
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s (Rx): state=%08x (UFO alert)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|state
)paren
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_amp
id|SccEvt
)paren
)paren
(brace
r_struct
id|RxFD
op_star
id|rx_fd
suffix:semicolon
id|state
op_and_assign
l_int|0x00ffffff
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|Err
)paren
(brace
multiline_comment|/* Hold or reset */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s (Rx): ERR&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|cur
op_assign
id|dpriv-&gt;rx_current
suffix:semicolon
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
op_plus
id|cur
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Presume we&squot;re not facing a DMAC receiver reset. &n;&t;&t;&t; * As We use the rx size-filtering feature of the &n;&t;&t;&t; * DSCC4, the beginning of a new frame is waiting in &n;&t;&t;&t; * the rx fifo. I bet a Receive Data Overflow will &n;&t;&t;&t; * happen most of time but let&squot;s try and avoid it.&n;&t;&t;&t; * Btw (as for RDO) if one experiences ERR whereas&n;&t;&t;&t; * the system looks rather idle, there may be a &n;&t;&t;&t; * problem with latency. In this case, increasing&n;&t;&t;&t; * RX_RING_SIZE may help.&n;&t;&t;&t; */
r_while
c_loop
(paren
id|dpriv-&gt;rx_needs_refill
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|rx_fd-&gt;state1
op_amp
id|Hold
)paren
)paren
(brace
id|rx_fd
op_increment
suffix:semicolon
id|cur
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cur
op_assign
id|cur
op_mod
id|RX_RING_SIZE
)paren
)paren
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
suffix:semicolon
)brace
id|dpriv-&gt;rx_needs_refill
op_decrement
suffix:semicolon
id|try_get_rx_skb
c_func
(paren
id|dpriv
comma
id|cur
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rx_fd-&gt;data
)paren
r_goto
r_try
suffix:semicolon
id|rx_fd-&gt;state1
op_and_assign
op_complement
id|Hold
suffix:semicolon
id|rx_fd-&gt;state2
op_assign
l_int|0x00000000
suffix:semicolon
id|rx_fd-&gt;end
op_assign
l_int|0xbabeface
suffix:semicolon
)brace
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Fi
)paren
(brace
id|cur
op_assign
id|dpriv-&gt;rx_current
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
op_plus
id|cur
suffix:semicolon
id|dscc4_rx_skb
c_func
(paren
id|dpriv
comma
id|cur
comma
id|rx_fd
comma
id|dev
)paren
suffix:semicolon
id|dpriv-&gt;rx_current
op_increment
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Hi
)paren
(brace
multiline_comment|/* HI bit */
id|state
op_and_assign
op_complement
id|Hi
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ! SccEvt */
macro_line|#ifdef DEBUG_PARANOIA
r_int
id|i
suffix:semicolon
r_static
r_struct
(brace
id|u32
id|mask
suffix:semicolon
r_const
r_char
op_star
id|irq_name
suffix:semicolon
)brace
id|evts
(braket
)braket
op_assign
(brace
(brace
l_int|0x00008000
comma
l_string|&quot;TIN&quot;
)brace
comma
(brace
l_int|0x00004000
comma
l_string|&quot;CSC&quot;
)brace
comma
(brace
l_int|0x00000020
comma
l_string|&quot;RSC&quot;
)brace
comma
(brace
l_int|0x00000010
comma
l_string|&quot;PCE&quot;
)brace
comma
(brace
l_int|0x00000008
comma
l_string|&quot;PLLA&quot;
)brace
comma
(brace
l_int|0x00000004
comma
l_string|&quot;CDSC&quot;
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
macro_line|#endif /* DEBUG_PARANOIA */
id|state
op_and_assign
l_int|0x00ffffff
suffix:semicolon
macro_line|#ifdef DEBUG_PARANOIA
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|evts
(braket
id|i
)braket
dot
id|irq_name
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|state
op_amp
id|evts
(braket
id|i
)braket
dot
id|mask
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dscc4(%s): %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|evts
(braket
id|i
)braket
dot
id|irq_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|evts
(braket
id|i
)braket
dot
id|mask
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
)brace
macro_line|#endif /* DEBUG_PARANOIA */
multiline_comment|/*&n;&t;&t; * Receive Data Overflow (FIXME: untested)&n;&t;&t; */
r_if
c_cond
(paren
id|state
op_amp
id|Rdo
)paren
(brace
id|u32
id|ioaddr
comma
id|scc_offset
comma
id|scc_addr
suffix:semicolon
r_struct
id|RxFD
op_star
id|rx_fd
suffix:semicolon
r_int
id|cur
suffix:semicolon
singleline_comment|//if (debug)
singleline_comment|//&t;dscc4_rx_dump(dpriv);
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|scc_addr
op_assign
id|ioaddr
op_plus
l_int|0x0c
op_star
id|dpriv-&gt;dev_id
suffix:semicolon
id|scc_offset
op_assign
id|ioaddr
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv-&gt;dev_id
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|scc_offset
op_plus
id|CCR2
)paren
op_amp
op_complement
id|RxActivate
comma
id|scc_offset
op_plus
id|CCR2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * This has no effect. Why ?&n;&t;&t;&t; * ORed with TxSccRes, one sees the CFG ack (for&n;&t;&t;&t; * the TX part only).&n;&t;&t;&t; */
id|writel
c_func
(paren
id|RxSccRes
comma
id|scc_offset
op_plus
id|CMDR
)paren
suffix:semicolon
id|dpriv-&gt;flags
op_or_assign
id|RdoSet
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Let&squot;s try and save something in the received data.&n;&t;&t;&t; * rx_current must be incremented at least once to&n;&t;&t;&t; * avoid HOLD in the BRDA-to-be-pointed desc.&n;&t;&t;&t; */
r_do
(brace
id|cur
op_assign
id|dpriv-&gt;rx_current
op_increment
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
op_plus
id|cur
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rx_fd-&gt;state2
op_amp
id|DataComplete
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rx_fd-&gt;state2
op_amp
id|FrameAborted
)paren
(brace
id|dpriv-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
id|rx_fd-&gt;state1
op_or_assign
id|Hold
suffix:semicolon
id|rx_fd-&gt;state2
op_assign
l_int|0x00000000
suffix:semicolon
id|rx_fd-&gt;end
op_assign
l_int|0xbabeface
suffix:semicolon
)brace
r_else
id|dscc4_rx_skb
c_func
(paren
id|dpriv
comma
id|cur
comma
id|rx_fd
comma
id|dev
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
(brace
r_if
c_cond
(paren
id|dpriv-&gt;flags
op_amp
id|RdoSet
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dscc4: no RDO in Rx data&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef DSCC4_RDO_EXPERIMENTAL_RECOVERY
multiline_comment|/*&n;&t;&t;&t; * FIXME: must the reset be this violent ?&n;&t;&t;&t; */
id|writel
c_func
(paren
id|dpriv-&gt;rx_fd_dma
op_plus
(paren
id|dpriv-&gt;rx_current
op_mod
id|RX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|scc_addr
op_plus
id|CH0BRDA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MTFi
op_or
id|Rdr
op_or
id|Idr
comma
id|scc_addr
op_plus
id|CH0CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;RDR&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RDO recovery failed(%s)&bslash;n&quot;
comma
id|dev-&gt;name
comma
l_string|&quot;RDR&quot;
)paren
suffix:semicolon
r_goto
id|rdo_end
suffix:semicolon
)brace
id|writel
c_func
(paren
id|MTFi
op_or
id|Idr
comma
id|scc_addr
op_plus
id|CH0CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;IDR&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RDO recovery failed(%s)&bslash;n&quot;
comma
id|dev-&gt;name
comma
l_string|&quot;IDR&quot;
)paren
suffix:semicolon
r_goto
id|rdo_end
suffix:semicolon
)brace
id|rdo_end
suffix:colon
macro_line|#endif
id|writel
c_func
(paren
id|readl
c_func
(paren
id|scc_offset
op_plus
id|CCR2
)paren
op_or
id|RxActivate
comma
id|scc_offset
op_plus
id|CCR2
)paren
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
multiline_comment|/* These will be used later */
r_if
c_cond
(paren
id|state
op_amp
id|Rfs
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Rfs
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Rfo
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Rfo
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Flex
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Flex
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
)brace
)brace
r_static
r_int
id|dscc4_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
r_struct
id|RxFD
op_star
id|rx_fd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tx_fd
op_assign
(paren
r_struct
id|TxFD
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|dpriv-&gt;pci_priv-&gt;pdev
comma
id|TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|TxFD
)paren
comma
op_amp
id|dpriv-&gt;tx_fd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tx_fd
)paren
r_goto
id|err_out
suffix:semicolon
id|rx_fd
op_assign
(paren
r_struct
id|RxFD
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|dpriv-&gt;pci_priv-&gt;pdev
comma
id|RX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
op_amp
id|dpriv-&gt;rx_fd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rx_fd
)paren
r_goto
id|err_free_dma_tx
suffix:semicolon
id|dpriv-&gt;tx_fd
op_assign
id|tx_fd
suffix:semicolon
id|dpriv-&gt;rx_fd
op_assign
id|rx_fd
suffix:semicolon
id|dpriv-&gt;rx_current
op_assign
l_int|0
suffix:semicolon
id|dpriv-&gt;tx_current
op_assign
l_int|0
suffix:semicolon
id|dpriv-&gt;tx_dirty
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* the dma core of the dscc4 will be locked on the first desc */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
)paren
(brace
id|reset_TxFD
c_func
(paren
id|tx_fd
)paren
suffix:semicolon
multiline_comment|/* FIXME: NULL should be ok - to be tried */
id|tx_fd-&gt;data
op_assign
id|dpriv-&gt;tx_fd_dma
suffix:semicolon
id|dpriv-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|tx_fd-&gt;next
op_assign
(paren
id|u32
)paren
(paren
id|dpriv-&gt;tx_fd_dma
op_plus
id|i
op_star
r_sizeof
(paren
r_struct
id|TxFD
)paren
)paren
suffix:semicolon
id|tx_fd
op_increment
suffix:semicolon
)brace
(paren
op_decrement
id|tx_fd
)paren
op_member_access_from_pointer
id|next
op_assign
(paren
id|u32
)paren
id|dpriv-&gt;tx_fd_dma
suffix:semicolon
(brace
multiline_comment|/*&n;&t; * XXX: I would expect the following to work for the first descriptor&n;&t; * (tx_fd-&gt;state = 0xc0000000)&n;&t; * - Hold=1 (don&squot;t try and branch to the next descripto);&n;&t; * - No=0 (I want an empty data section, i.e. size=0);&n;&t; * - Fe=1 (required by No=0 or we got an Err irq and must reset).&n;&t; * Alas, it fails (and locks solid). Thus the introduction of a dummy&n;&t; * skb to avoid No=0 (choose one: Ugly [ ] Tasteless [ ] VMS [ ]).&n;&t; * TODO: fiddle the tx threshold when time permits.&n;&t; */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|err_free_dma_tx
suffix:semicolon
id|skb-&gt;len
op_assign
l_int|32
suffix:semicolon
id|memset
c_func
(paren
id|skb-&gt;data
comma
l_int|0xaa
comma
l_int|16
)paren
suffix:semicolon
id|tx_fd
op_sub_assign
(paren
id|TX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|tx_fd-&gt;state
op_assign
l_int|0xc0000000
suffix:semicolon
id|tx_fd-&gt;state
op_or_assign
(paren
(paren
id|u32
)paren
(paren
id|skb-&gt;len
op_amp
id|TxSizeMax
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|tx_fd-&gt;data
op_assign
id|pci_map_single
c_func
(paren
id|dpriv-&gt;pci_priv-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dpriv-&gt;tx_skbuff
(braket
l_int|0
)braket
op_assign
id|skb
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
)paren
(brace
multiline_comment|/* size set by the host. Multiple of 4 bytes please */
id|rx_fd-&gt;state1
op_assign
id|HiDesc
suffix:semicolon
multiline_comment|/* Hi, no Hold */
id|rx_fd-&gt;state2
op_assign
l_int|0x00000000
suffix:semicolon
id|rx_fd-&gt;end
op_assign
l_int|0xbabeface
suffix:semicolon
id|rx_fd-&gt;state1
op_or_assign
(paren
(paren
id|u32
)paren
(paren
id|HDLC_MAX_MRU
op_amp
id|RxSizeMax
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|try_get_rx_skb
c_func
(paren
id|dpriv
comma
id|i
comma
id|dev
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|rx_fd-&gt;next
op_assign
(paren
id|u32
)paren
(paren
id|dpriv-&gt;rx_fd_dma
op_plus
id|i
op_star
r_sizeof
(paren
r_struct
id|RxFD
)paren
)paren
suffix:semicolon
id|rx_fd
op_increment
suffix:semicolon
)brace
(paren
op_decrement
id|rx_fd
)paren
op_member_access_from_pointer
id|next
op_assign
(paren
id|u32
)paren
id|dpriv-&gt;rx_fd_dma
suffix:semicolon
id|rx_fd-&gt;state1
op_or_assign
l_int|0x40000000
suffix:semicolon
multiline_comment|/* Hold */
r_return
l_int|0
suffix:semicolon
id|err_free_dma_tx
suffix:colon
id|pci_free_consistent
c_func
(paren
id|dpriv-&gt;pci_priv-&gt;pdev
comma
id|TX_RING_SIZE
op_star
r_sizeof
(paren
op_star
id|tx_fd
)paren
comma
id|tx_fd
comma
id|dpriv-&gt;tx_fd_dma
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_struct
id|net_device_stats
op_star
id|dscc4_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|priv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
r_static
r_void
id|__exit
id|dscc4_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
r_struct
id|net_device
op_star
id|root
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ppriv
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|root
op_assign
id|ppriv-&gt;root
suffix:semicolon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|root
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|ppriv-&gt;iqcfg
comma
id|ppriv-&gt;iqcfg_dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|dev
op_assign
id|ppriv-&gt;root
op_plus
id|i
suffix:semicolon
id|dscc4_unattach_hdlc_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dpriv
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|dpriv-&gt;iqrx
comma
id|dpriv-&gt;iqrx_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|dpriv-&gt;iqtx
comma
id|dpriv-&gt;iqtx_dma
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|root-&gt;priv
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|root-&gt;base_addr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ppriv
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
id|dscc4_hdlc_ioctl
c_func
(paren
r_struct
id|hdlc_device_struct
op_star
id|hdlc
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|hdlc-&gt;netdev.base_addr
suffix:semicolon
r_int
id|result
suffix:semicolon
multiline_comment|/* FIXME: locking ? */
id|result
op_assign
id|dscc4_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
id|dscc4_hdlc_open
c_func
(paren
r_struct
id|hdlc_device_struct
op_star
id|hdlc
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
(paren
id|hdlc-&gt;netdev.base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: already running&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
singleline_comment|// DEBUG
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|dscc4_open
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_int
id|dscc4_hdlc_xmit
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|hdlc-&gt;netdev.base_addr
suffix:semicolon
r_return
id|dscc4_start_xmit
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
id|dscc4_hdlc_close
c_func
(paren
r_struct
id|hdlc_device_struct
op_star
id|hdlc
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|hdlc-&gt;netdev.base_addr
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
suffix:semicolon
id|dpriv
op_assign
id|dev-&gt;priv
suffix:semicolon
op_decrement
id|dpriv-&gt;usecount
suffix:semicolon
)brace
multiline_comment|/* Operated under dev lock */
r_static
r_int
id|dscc4_attach_hdlc_device
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|hdlc_device_struct
op_star
id|hdlc
suffix:semicolon
r_int
id|result
suffix:semicolon
id|hdlc
op_assign
op_amp
id|dpriv-&gt;hdlc
suffix:semicolon
multiline_comment|/* XXX: Don&squot;t look at the next line */
id|hdlc-&gt;netdev.base_addr
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|hdlc-&gt;set_mode
op_assign
l_int|NULL
suffix:semicolon
id|hdlc-&gt;open
op_assign
id|dscc4_hdlc_open
suffix:semicolon
id|hdlc-&gt;close
op_assign
id|dscc4_hdlc_close
suffix:semicolon
id|hdlc-&gt;ioctl
op_assign
id|dscc4_hdlc_ioctl
suffix:semicolon
id|hdlc-&gt;xmit
op_assign
id|dscc4_hdlc_xmit
suffix:semicolon
id|result
op_assign
id|register_hdlc_device
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|dpriv-&gt;usecount
op_increment
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Operated under dev lock */
r_static
r_void
id|dscc4_unattach_hdlc_device
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|unregister_hdlc_device
c_func
(paren
op_amp
id|dpriv-&gt;hdlc
)paren
suffix:semicolon
id|dpriv-&gt;usecount
op_decrement
suffix:semicolon
)brace
r_static
r_struct
id|pci_device_id
id|dscc4_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_SIEMENS
comma
id|PCI_DEVICE_ID_SIEMENS_DSCC4
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|dscc4_pci_tbl
)paren
suffix:semicolon
r_static
r_struct
id|pci_driver
id|dscc4_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;dscc4&quot;
comma
id|id_table
suffix:colon
id|dscc4_pci_tbl
comma
id|probe
suffix:colon
id|dscc4_init_one
comma
id|remove
suffix:colon
id|dscc4_remove_one
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
id|dscc4_init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|dscc4_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
id|dscc4_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|dscc4_driver
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|dscc4_init_module
)paren
suffix:semicolon
id|module_exit
c_func
(paren
id|dscc4_cleanup_module
)paren
suffix:semicolon
eof
