multiline_comment|/*&n; * drivers/net/wan/dscc4/dscc4.c: a DSCC4 HDLC driver for Linux&n; *&n; * This software may be used and distributed according to the terms of the&n; * GNU General Public License.&n; *&n; * The author may be reached as romieu@cogenit.fr.&n; * Specific bug reports/asian food will be welcome.&n; *&n; * Special thanks to the nice people at CS-Telecom for the hardware and the&n; * access to the test/measure tools.&n; *&n; *&n; *                             Theory of Operation&n; *&n; * I. Board Compatibility&n; *&n; * This device driver is designed for the Siemens PEB20534 4 ports serial&n; * controller as found on Etinc PCISYNC cards. The documentation for the&n; * chipset is available at http://www.infineon.com:&n; * - Data Sheet &quot;DSCC4, DMA Supported Serial Communication Controller with&n; * 4 Channels, PEB 20534 Version 2.1, PEF 20534 Version 2.1&quot;;&n; * - Application Hint &quot;Management of DSCC4 on-chip FIFO resources&quot;.&n; * - Errata sheet DS5 (courtesy of Michael Skerritt).&n; * Jens David has built an adapter based on the same chipset. Take a look&n; * at http://www.afthd.tu-darmstadt.de/~dg1kjd/pciscc4 for a specific&n; * driver.&n; * Sample code (2 revisions) is available at Infineon.&n; *&n; * II. Board-specific settings&n; *&n; * Pcisync can transmit some clock signal to the outside world on the&n; * *first two* ports provided you put a quartz and a line driver on it and&n; * remove the jumpers. The operation is described on Etinc web site. If you&n; * go DCE on these ports, don&squot;t forget to use an adequate cable.&n; *&n; * Sharing of the PCI interrupt line for this board is possible.&n; *&n; * III. Driver operation&n; *&n; * The rx/tx operations are based on a linked list of descriptors. The driver&n; * doesn&squot;t use HOLD mode any more. HOLD mode is definitely buggy and the more&n; * I tried to fix it, the more it started to look like (convoluted) software&n; * mutation of LxDA method. Errata sheet DS5 suggests to use LxDA: consider&n; * this a rfc2119 MUST.&n; *&n; * Tx direction&n; * When the tx ring is full, the xmit routine issues a call to netdev_stop.&n; * The device is supposed to be enabled again during an ALLS irq (we could&n; * use HI but as it&squot;s easy to lose events, it&squot;s fscked).&n; *&n; * Rx direction&n; * The received frames aren&squot;t supposed to span over multiple receiving areas.&n; * I may implement it some day but it isn&squot;t the highest ranked item.&n; *&n; * IV. Notes&n; * The current error (XDU, RFO) recovery code is untested.&n; * So far, RDO takes his RX channel down and the right sequence to enable it&n; * again is still a mistery. If RDO happens, plan a reboot. More details&n; * in the code (NB: as this happens, TX still works).&n; * Don&squot;t mess the cables during operation, especially on DTE ports. I don&squot;t&n; * suggest it for DCE either but at least one can get some messages instead&n; * of a complete instant freeze.&n; * Tests are done on Rev. 20 of the silicium. The RDO handling changes with&n; * the documentation/chipset releases.&n; *&n; * TODO:&n; * - test X25.&n; * - use polling at high irq/s,&n; * - performance analysis,&n; * - endianness.&n; *&n; * 2001/12/10&t;Daniela Squassoni  &lt;daniela@cyclades.com&gt;&n; * - Contribution to support the new generic HDLC layer.&n; *&n; * 2002/01&t;Ueimor&n; * - old style interface removal&n; * - dscc4_release_ring fix (related to DMA mapping)&n; * - hard_start_xmit fix (hint: TxSizeMax)&n; * - misc crapectomy.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;net/syncppp.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
multiline_comment|/* Version */
DECL|variable|version
r_static
r_const
r_char
id|version
(braket
)braket
op_assign
l_string|&quot;$Id: dscc4.c,v 1.173 2003/09/20 23:55:34 romieu Exp $ for Linux&bslash;n&quot;
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|variable|quartz
r_static
r_int
id|quartz
suffix:semicolon
macro_line|#ifdef CONFIG_DSCC4_PCI_RST
r_static
id|DECLARE_MUTEX
c_func
(paren
id|dscc4_sem
)paren
suffix:semicolon
DECL|variable|dscc4_pci_config_store
r_static
id|u32
id|dscc4_pci_config_store
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
DECL|macro|DRV_NAME
mdefine_line|#define&t;DRV_NAME&t;&quot;dscc4&quot;
DECL|macro|DSCC4_POLLING
macro_line|#undef DSCC4_POLLING
multiline_comment|/* Module parameters */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Maintainer: Francois Romieu &lt;romieu@cogenit.fr&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Siemens PEB20534 PCI Controler&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Enable/disable extra messages&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|quartz
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|quartz
comma
l_string|&quot;If present, on-board quartz frequency (Hz)&quot;
)paren
suffix:semicolon
multiline_comment|/* Structures */
DECL|struct|thingie
r_struct
id|thingie
(brace
DECL|member|define
r_int
id|define
suffix:semicolon
DECL|member|bits
id|u32
id|bits
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|TxFD
r_struct
id|TxFD
(brace
DECL|member|state
id|u32
id|state
suffix:semicolon
DECL|member|next
id|u32
id|next
suffix:semicolon
DECL|member|data
id|u32
id|data
suffix:semicolon
DECL|member|complete
id|u32
id|complete
suffix:semicolon
DECL|member|jiffies
id|u32
id|jiffies
suffix:semicolon
multiline_comment|/* Allows sizeof(TxFD) == sizeof(RxFD) + extra hack */
)brace
suffix:semicolon
DECL|struct|RxFD
r_struct
id|RxFD
(brace
DECL|member|state1
id|u32
id|state1
suffix:semicolon
DECL|member|next
id|u32
id|next
suffix:semicolon
DECL|member|data
id|u32
id|data
suffix:semicolon
DECL|member|state2
id|u32
id|state2
suffix:semicolon
DECL|member|end
id|u32
id|end
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|DUMMY_SKB_SIZE
mdefine_line|#define DUMMY_SKB_SIZE&t;&t;64
DECL|macro|TX_LOW
mdefine_line|#define TX_LOW&t;&t;&t;8
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;&t;32
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;&t;32
DECL|macro|TX_TOTAL_SIZE
mdefine_line|#define TX_TOTAL_SIZE&t;&t;TX_RING_SIZE*sizeof(struct TxFD)
DECL|macro|RX_TOTAL_SIZE
mdefine_line|#define RX_TOTAL_SIZE&t;&t;RX_RING_SIZE*sizeof(struct RxFD)
DECL|macro|IRQ_RING_SIZE
mdefine_line|#define IRQ_RING_SIZE&t;&t;64&t;&t;/* Keep it a multiple of 32 */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;&t;(HZ/10)
DECL|macro|DSCC4_HZ_MAX
mdefine_line|#define DSCC4_HZ_MAX&t;&t;33000000
DECL|macro|BRR_DIVIDER_MAX
mdefine_line|#define BRR_DIVIDER_MAX&t;&t;64*0x00004000&t;/* Cf errata DS5 p.10 */
DECL|macro|dev_per_card
mdefine_line|#define dev_per_card&t;&t;4
DECL|macro|SCC_REGISTERS_MAX
mdefine_line|#define SCC_REGISTERS_MAX&t;23&t;&t;/* Cf errata DS5 p.4 */
DECL|macro|SOURCE_ID
mdefine_line|#define SOURCE_ID(flags)&t;(((flags) &gt;&gt; 28) &amp; 0x03)
DECL|macro|TO_SIZE
mdefine_line|#define TO_SIZE(state)&t;&t;(((state) &gt;&gt; 16) &amp; 0x1fff)
multiline_comment|/*&n; * Given the operating range of Linux HDLC, the 2 defines below could be&n; * made simpler. However they are a fine reminder for the limitations of&n; * the driver: it&squot;s better to stay &lt; TxSizeMax and &lt; RxSizeMax.&n; */
DECL|macro|TO_STATE_TX
mdefine_line|#define TO_STATE_TX(len)&t;cpu_to_le32(((len) &amp; TxSizeMax) &lt;&lt; 16)
DECL|macro|TO_STATE_RX
mdefine_line|#define TO_STATE_RX(len)&t;cpu_to_le32((RX_MAX(len) % RxSizeMax) &lt;&lt; 16)
DECL|macro|RX_MAX
mdefine_line|#define RX_MAX(len)&t;&t;((((len) &gt;&gt; 5) + 1) &lt;&lt; 5)&t;/* Cf RLCR */
DECL|macro|SCC_REG_START
mdefine_line|#define SCC_REG_START(dpriv)&t;(SCC_START+(dpriv-&gt;dev_id)*SCC_OFFSET)
DECL|struct|dscc4_pci_priv
r_struct
id|dscc4_pci_priv
(brace
DECL|member|iqcfg
id|u32
op_star
id|iqcfg
suffix:semicolon
DECL|member|cfg_cur
r_int
id|cfg_cur
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|root
r_struct
id|dscc4_dev_priv
op_star
id|root
suffix:semicolon
DECL|member|iqcfg_dma
id|dma_addr_t
id|iqcfg_dma
suffix:semicolon
DECL|member|xtal_hz
id|u32
id|xtal_hz
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|dscc4_dev_priv
r_struct
id|dscc4_dev_priv
(brace
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_fd
r_struct
id|RxFD
op_star
id|rx_fd
suffix:semicolon
DECL|member|tx_fd
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
DECL|member|iqrx
id|u32
op_star
id|iqrx
suffix:semicolon
DECL|member|iqtx
id|u32
op_star
id|iqtx
suffix:semicolon
multiline_comment|/* FIXME: check all the volatile are required */
DECL|member|tx_current
r_volatile
id|u32
id|tx_current
suffix:semicolon
DECL|member|rx_current
id|u32
id|rx_current
suffix:semicolon
DECL|member|iqtx_current
id|u32
id|iqtx_current
suffix:semicolon
DECL|member|iqrx_current
id|u32
id|iqrx_current
suffix:semicolon
DECL|member|tx_dirty
r_volatile
id|u32
id|tx_dirty
suffix:semicolon
DECL|member|ltda
r_volatile
id|u32
id|ltda
suffix:semicolon
DECL|member|rx_dirty
id|u32
id|rx_dirty
suffix:semicolon
DECL|member|lrda
id|u32
id|lrda
suffix:semicolon
DECL|member|tx_fd_dma
id|dma_addr_t
id|tx_fd_dma
suffix:semicolon
DECL|member|rx_fd_dma
id|dma_addr_t
id|rx_fd_dma
suffix:semicolon
DECL|member|iqtx_dma
id|dma_addr_t
id|iqtx_dma
suffix:semicolon
DECL|member|iqrx_dma
id|dma_addr_t
id|iqrx_dma
suffix:semicolon
DECL|member|scc_regs
id|u32
id|scc_regs
(braket
id|SCC_REGISTERS_MAX
)braket
suffix:semicolon
multiline_comment|/* Cf errata DS5 p.4 */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|pci_priv
r_struct
id|dscc4_pci_priv
op_star
id|pci_priv
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|dev_id
r_int
id|dev_id
suffix:semicolon
DECL|member|flags
r_volatile
id|u32
id|flags
suffix:semicolon
DECL|member|timer_help
id|u32
id|timer_help
suffix:semicolon
DECL|member|encoding
r_int
r_int
id|encoding
suffix:semicolon
DECL|member|parity
r_int
r_int
id|parity
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
DECL|member|settings
id|sync_serial_settings
id|settings
suffix:semicolon
DECL|member|base_addr
r_void
id|__iomem
op_star
id|base_addr
suffix:semicolon
DECL|member|__pad
id|u32
id|__pad
id|__attribute__
(paren
(paren
id|aligned
(paren
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* GLOBAL registers definitions */
DECL|macro|GCMDR
mdefine_line|#define GCMDR   0x00
DECL|macro|GSTAR
mdefine_line|#define GSTAR   0x04
DECL|macro|GMODE
mdefine_line|#define GMODE   0x08
DECL|macro|IQLENR0
mdefine_line|#define IQLENR0 0x0C
DECL|macro|IQLENR1
mdefine_line|#define IQLENR1 0x10
DECL|macro|IQRX0
mdefine_line|#define IQRX0   0x14
DECL|macro|IQTX0
mdefine_line|#define IQTX0   0x24
DECL|macro|IQCFG
mdefine_line|#define IQCFG   0x3c
DECL|macro|FIFOCR1
mdefine_line|#define FIFOCR1 0x44
DECL|macro|FIFOCR2
mdefine_line|#define FIFOCR2 0x48
DECL|macro|FIFOCR3
mdefine_line|#define FIFOCR3 0x4c
DECL|macro|FIFOCR4
mdefine_line|#define FIFOCR4 0x34
DECL|macro|CH0CFG
mdefine_line|#define CH0CFG  0x50
DECL|macro|CH0BRDA
mdefine_line|#define CH0BRDA 0x54
DECL|macro|CH0BTDA
mdefine_line|#define CH0BTDA 0x58
DECL|macro|CH0FRDA
mdefine_line|#define CH0FRDA 0x98
DECL|macro|CH0FTDA
mdefine_line|#define CH0FTDA 0xb0
DECL|macro|CH0LRDA
mdefine_line|#define CH0LRDA 0xc8
DECL|macro|CH0LTDA
mdefine_line|#define CH0LTDA 0xe0
multiline_comment|/* SCC registers definitions */
DECL|macro|SCC_START
mdefine_line|#define SCC_START&t;0x0100
DECL|macro|SCC_OFFSET
mdefine_line|#define SCC_OFFSET      0x80
DECL|macro|CMDR
mdefine_line|#define CMDR    0x00
DECL|macro|STAR
mdefine_line|#define STAR    0x04
DECL|macro|CCR0
mdefine_line|#define CCR0    0x08
DECL|macro|CCR1
mdefine_line|#define CCR1    0x0c
DECL|macro|CCR2
mdefine_line|#define CCR2    0x10
DECL|macro|BRR
mdefine_line|#define BRR     0x2C
DECL|macro|RLCR
mdefine_line|#define RLCR    0x40
DECL|macro|IMR
mdefine_line|#define IMR     0x54
DECL|macro|ISR
mdefine_line|#define ISR     0x58
DECL|macro|GPDIR
mdefine_line|#define GPDIR&t;0x0400
DECL|macro|GPDATA
mdefine_line|#define GPDATA&t;0x0404
DECL|macro|GPIM
mdefine_line|#define GPIM&t;0x0408
multiline_comment|/* Bit masks */
DECL|macro|EncodingMask
mdefine_line|#define EncodingMask&t;0x00700000
DECL|macro|CrcMask
mdefine_line|#define CrcMask&t;&t;0x00000003
DECL|macro|IntRxScc0
mdefine_line|#define IntRxScc0&t;0x10000000
DECL|macro|IntTxScc0
mdefine_line|#define IntTxScc0&t;0x01000000
DECL|macro|TxPollCmd
mdefine_line|#define TxPollCmd&t;0x00000400
DECL|macro|RxActivate
mdefine_line|#define RxActivate&t;0x08000000
DECL|macro|MTFi
mdefine_line|#define MTFi&t;&t;0x04000000
DECL|macro|Rdr
mdefine_line|#define Rdr&t;&t;0x00400000
DECL|macro|Rdt
mdefine_line|#define Rdt&t;&t;0x00200000
DECL|macro|Idr
mdefine_line|#define Idr&t;&t;0x00100000
DECL|macro|Idt
mdefine_line|#define Idt&t;&t;0x00080000
DECL|macro|TxSccRes
mdefine_line|#define TxSccRes&t;0x01000000
DECL|macro|RxSccRes
mdefine_line|#define RxSccRes&t;0x00010000
DECL|macro|TxSizeMax
mdefine_line|#define TxSizeMax&t;0x1fff&t;&t;/* Datasheet DS1 - 11.1.1.1 */
DECL|macro|RxSizeMax
mdefine_line|#define RxSizeMax&t;0x1ffc&t;&t;/* Datasheet DS1 - 11.1.2.1 */
DECL|macro|Ccr0ClockMask
mdefine_line|#define Ccr0ClockMask&t;0x0000003f
DECL|macro|Ccr1LoopMask
mdefine_line|#define Ccr1LoopMask&t;0x00000200
DECL|macro|IsrMask
mdefine_line|#define IsrMask&t;&t;0x000fffff
DECL|macro|BrrExpMask
mdefine_line|#define BrrExpMask&t;0x00000f00
DECL|macro|BrrMultMask
mdefine_line|#define BrrMultMask&t;0x0000003f
DECL|macro|EncodingMask
mdefine_line|#define EncodingMask&t;0x00700000
DECL|macro|Hold
mdefine_line|#define Hold&t;&t;0x40000000
DECL|macro|SccBusy
mdefine_line|#define SccBusy&t;&t;0x10000000
DECL|macro|PowerUp
mdefine_line|#define PowerUp&t;&t;0x80000000
DECL|macro|Vis
mdefine_line|#define Vis&t;&t;0x00001000
DECL|macro|FrameOk
mdefine_line|#define FrameOk&t;&t;(FrameVfr | FrameCrc)
DECL|macro|FrameVfr
mdefine_line|#define FrameVfr&t;0x80
DECL|macro|FrameRdo
mdefine_line|#define FrameRdo&t;0x40
DECL|macro|FrameCrc
mdefine_line|#define FrameCrc&t;0x20
DECL|macro|FrameRab
mdefine_line|#define FrameRab&t;0x10
DECL|macro|FrameAborted
mdefine_line|#define FrameAborted&t;0x00000200
DECL|macro|FrameEnd
mdefine_line|#define FrameEnd&t;0x80000000
DECL|macro|DataComplete
mdefine_line|#define DataComplete&t;0x40000000
DECL|macro|LengthCheck
mdefine_line|#define LengthCheck&t;0x00008000
DECL|macro|SccEvt
mdefine_line|#define SccEvt&t;&t;0x02000000
DECL|macro|NoAck
mdefine_line|#define NoAck&t;&t;0x00000200
DECL|macro|Action
mdefine_line|#define Action&t;&t;0x00000001
DECL|macro|HiDesc
mdefine_line|#define HiDesc&t;&t;0x20000000
multiline_comment|/* SCC events */
DECL|macro|RxEvt
mdefine_line|#define RxEvt&t;&t;0xf0000000
DECL|macro|TxEvt
mdefine_line|#define TxEvt&t;&t;0x0f000000
DECL|macro|Alls
mdefine_line|#define Alls&t;&t;0x00040000
DECL|macro|Xdu
mdefine_line|#define Xdu&t;&t;0x00010000
DECL|macro|Cts
mdefine_line|#define Cts&t;&t;0x00004000
DECL|macro|Xmr
mdefine_line|#define Xmr&t;&t;0x00002000
DECL|macro|Xpr
mdefine_line|#define Xpr&t;&t;0x00001000
DECL|macro|Rdo
mdefine_line|#define Rdo&t;&t;0x00000080
DECL|macro|Rfs
mdefine_line|#define Rfs&t;&t;0x00000040
DECL|macro|Cd
mdefine_line|#define Cd&t;&t;0x00000004
DECL|macro|Rfo
mdefine_line|#define Rfo&t;&t;0x00000002
DECL|macro|Flex
mdefine_line|#define Flex&t;&t;0x00000001
multiline_comment|/* DMA core events */
DECL|macro|Cfg
mdefine_line|#define Cfg&t;&t;0x00200000
DECL|macro|Hi
mdefine_line|#define Hi&t;&t;0x00040000
DECL|macro|Fi
mdefine_line|#define Fi&t;&t;0x00020000
DECL|macro|Err
mdefine_line|#define Err&t;&t;0x00010000
DECL|macro|Arf
mdefine_line|#define Arf&t;&t;0x00000002
DECL|macro|ArAck
mdefine_line|#define ArAck&t;&t;0x00000001
multiline_comment|/* State flags */
DECL|macro|Ready
mdefine_line|#define Ready&t;&t;0x00000000
DECL|macro|NeedIDR
mdefine_line|#define NeedIDR&t;&t;0x00000001
DECL|macro|NeedIDT
mdefine_line|#define NeedIDT&t;&t;0x00000002
DECL|macro|RdoSet
mdefine_line|#define RdoSet&t;&t;0x00000004
DECL|macro|FakeReset
mdefine_line|#define FakeReset&t;0x00000008
multiline_comment|/* Don&squot;t mask RDO. Ever. */
macro_line|#ifdef DSCC4_POLLING
DECL|macro|EventsMask
mdefine_line|#define EventsMask&t;0xfffeef7f
macro_line|#else
DECL|macro|EventsMask
mdefine_line|#define EventsMask&t;0xfffa8f7a
macro_line|#endif
multiline_comment|/* Functions prototypes */
r_static
r_void
id|dscc4_rx_irq
c_func
(paren
r_struct
id|dscc4_pci_priv
op_star
comma
r_struct
id|dscc4_dev_priv
op_star
)paren
suffix:semicolon
r_static
r_void
id|dscc4_tx_irq
c_func
(paren
r_struct
id|dscc4_pci_priv
op_star
comma
r_struct
id|dscc4_dev_priv
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_found1
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_void
id|__iomem
op_star
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
id|dscc4_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
r_int
id|dscc4_open
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_close
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|dscc4_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|dscc4_init_ring
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|dscc4_release_ring
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
suffix:semicolon
r_static
r_void
id|dscc4_timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|dscc4_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|dscc4_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
suffix:semicolon
r_static
r_int
id|dscc4_hdlc_attach
c_func
(paren
r_struct
id|net_device
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|dscc4_set_iface
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
macro_line|#ifdef DSCC4_POLLING
r_static
r_int
id|dscc4_tx_poll
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
macro_line|#endif
DECL|function|dscc4_priv
r_static
r_inline
r_struct
id|dscc4_dev_priv
op_star
id|dscc4_priv
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|priv
suffix:semicolon
)brace
DECL|function|dscc4_to_dev
r_static
r_inline
r_struct
id|net_device
op_star
id|dscc4_to_dev
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|p
)paren
(brace
r_return
id|p-&gt;dev
suffix:semicolon
)brace
DECL|function|scc_patchl
r_static
r_void
id|scc_patchl
c_func
(paren
id|u32
id|mask
comma
id|u32
id|value
comma
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|offset
)paren
(brace
id|u32
id|state
suffix:semicolon
multiline_comment|/* Cf scc_writel for concern regarding thread-safety */
id|state
op_assign
id|dpriv-&gt;scc_regs
(braket
id|offset
op_rshift
l_int|2
)braket
suffix:semicolon
id|state
op_and_assign
op_complement
id|mask
suffix:semicolon
id|state
op_or_assign
id|value
suffix:semicolon
id|dpriv-&gt;scc_regs
(braket
id|offset
op_rshift
l_int|2
)braket
op_assign
id|state
suffix:semicolon
id|writel
c_func
(paren
id|state
comma
id|dpriv-&gt;base_addr
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv
)paren
op_plus
id|offset
)paren
suffix:semicolon
)brace
DECL|function|scc_writel
r_static
r_void
id|scc_writel
c_func
(paren
id|u32
id|bits
comma
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|offset
)paren
(brace
multiline_comment|/*&n;&t; * Thread-UNsafe.&n;&t; * As of 2002/02/16, there are no thread racing for access.&n;&t; */
id|dpriv-&gt;scc_regs
(braket
id|offset
op_rshift
l_int|2
)braket
op_assign
id|bits
suffix:semicolon
id|writel
c_func
(paren
id|bits
comma
id|dpriv-&gt;base_addr
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv
)paren
op_plus
id|offset
)paren
suffix:semicolon
)brace
DECL|function|scc_readl
r_static
r_inline
id|u32
id|scc_readl
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_int
id|offset
)paren
(brace
r_return
id|dpriv-&gt;scc_regs
(braket
id|offset
op_rshift
l_int|2
)braket
suffix:semicolon
)brace
DECL|function|scc_readl_star
r_static
id|u32
id|scc_readl_star
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* Cf errata DS5 p.4 */
id|readl
c_func
(paren
id|dpriv-&gt;base_addr
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv
)paren
op_plus
id|STAR
)paren
suffix:semicolon
r_return
id|readl
c_func
(paren
id|dpriv-&gt;base_addr
op_plus
id|SCC_REG_START
c_func
(paren
id|dpriv
)paren
op_plus
id|STAR
)paren
suffix:semicolon
)brace
DECL|function|dscc4_do_tx
r_static
r_inline
r_void
id|dscc4_do_tx
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dpriv-&gt;ltda
op_assign
id|dpriv-&gt;tx_fd_dma
op_plus
(paren
(paren
id|dpriv-&gt;tx_current
op_minus
l_int|1
)paren
op_mod
id|TX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|TxFD
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dpriv-&gt;ltda
comma
id|dpriv-&gt;base_addr
op_plus
id|CH0LTDA
op_plus
id|dpriv-&gt;dev_id
op_star
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Flush posted writes *NOW* */
id|readl
c_func
(paren
id|dpriv-&gt;base_addr
op_plus
id|CH0LTDA
op_plus
id|dpriv-&gt;dev_id
op_star
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|dscc4_rx_update
r_static
r_inline
r_void
id|dscc4_rx_update
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dpriv-&gt;lrda
op_assign
id|dpriv-&gt;rx_fd_dma
op_plus
(paren
(paren
id|dpriv-&gt;rx_dirty
op_minus
l_int|1
)paren
op_mod
id|RX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|RxFD
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dpriv-&gt;lrda
comma
id|dpriv-&gt;base_addr
op_plus
id|CH0LRDA
op_plus
id|dpriv-&gt;dev_id
op_star
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|dscc4_tx_done
r_static
r_inline
r_int
r_int
id|dscc4_tx_done
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
r_return
id|dpriv-&gt;tx_current
op_eq
id|dpriv-&gt;tx_dirty
suffix:semicolon
)brace
DECL|function|dscc4_tx_quiescent
r_static
r_inline
r_int
r_int
id|dscc4_tx_quiescent
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|readl
c_func
(paren
id|dpriv-&gt;base_addr
op_plus
id|CH0FTDA
op_plus
id|dpriv-&gt;dev_id
op_star
l_int|4
)paren
op_eq
id|dpriv-&gt;ltda
suffix:semicolon
)brace
DECL|function|state_check
r_int
id|state_check
c_func
(paren
id|u32
id|state
comma
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|SOURCE_ID
c_func
(paren
id|state
)paren
op_ne
id|dpriv-&gt;dev_id
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s (%s): Source Id=%d, state=%08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
comma
id|SOURCE_ID
c_func
(paren
id|state
)paren
comma
id|state
)paren
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
l_int|0x0df80c00
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s (%s): state=%08x (UFO alert)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
comma
id|state
)paren
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dscc4_tx_print
r_void
id|dscc4_tx_print
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_char
op_star
id|msg
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: tx_current=%02d tx_dirty=%02d (%s)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dpriv-&gt;tx_current
comma
id|dpriv-&gt;tx_dirty
comma
id|msg
)paren
suffix:semicolon
)brace
DECL|function|dscc4_release_ring
r_static
r_void
id|dscc4_release_ring
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|dpriv-&gt;pci_priv-&gt;pdev
suffix:semicolon
r_struct
id|TxFD
op_star
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
suffix:semicolon
r_struct
id|RxFD
op_star
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
suffix:semicolon
r_struct
id|sk_buff
op_star
op_star
id|skbuff
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
id|tx_fd
comma
id|dpriv-&gt;tx_fd_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
id|rx_fd
comma
id|dpriv-&gt;rx_fd_dma
)paren
suffix:semicolon
id|skbuff
op_assign
id|dpriv-&gt;tx_skbuff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|skbuff
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|pdev
comma
id|tx_fd-&gt;data
comma
(paren
op_star
id|skbuff
)paren
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
op_star
id|skbuff
)paren
suffix:semicolon
)brace
id|skbuff
op_increment
suffix:semicolon
id|tx_fd
op_increment
suffix:semicolon
)brace
id|skbuff
op_assign
id|dpriv-&gt;rx_skbuff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|skbuff
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|pdev
comma
id|rx_fd-&gt;data
comma
id|RX_MAX
c_func
(paren
id|HDLC_MAX_MRU
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
op_star
id|skbuff
)paren
suffix:semicolon
)brace
id|skbuff
op_increment
suffix:semicolon
id|rx_fd
op_increment
suffix:semicolon
)brace
)brace
DECL|function|try_get_rx_skb
r_inline
r_int
id|try_get_rx_skb
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|dirty
op_assign
id|dpriv-&gt;rx_dirty
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_struct
id|RxFD
op_star
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
op_plus
id|dirty
suffix:semicolon
r_const
r_int
id|len
op_assign
id|RX_MAX
c_func
(paren
id|HDLC_MAX_MRU
)paren
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
id|dpriv-&gt;rx_skbuff
(braket
id|dirty
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;protocol
op_assign
id|hdlc_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|rx_fd-&gt;data
op_assign
id|pci_map_single
c_func
(paren
id|dpriv-&gt;pci_priv-&gt;pdev
comma
id|skb-&gt;data
comma
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
)brace
r_else
(brace
id|rx_fd-&gt;data
op_assign
(paren
id|u32
)paren
l_int|NULL
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * IRQ/thread/whatever safe&n; */
DECL|function|dscc4_wait_ack_cec
r_static
r_int
id|dscc4_wait_ack_cec
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|msg
)paren
(brace
id|s8
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|scc_readl_star
c_func
(paren
id|dpriv
comma
id|dev
)paren
op_amp
id|SccBusy
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s ack (%d try)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
comma
id|i
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|i
OG
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s timeout&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
id|done
suffix:colon
r_return
(paren
id|i
op_ge
l_int|0
)paren
ques
c_cond
id|i
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
)brace
DECL|function|dscc4_do_action
r_static
r_int
id|dscc4_do_action
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|msg
)paren
(brace
r_void
id|__iomem
op_star
id|ioaddr
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|base_addr
suffix:semicolon
id|s16
id|i
op_assign
l_int|0
suffix:semicolon
id|writel
c_func
(paren
id|Action
comma
id|ioaddr
op_plus
id|GCMDR
)paren
suffix:semicolon
id|ioaddr
op_add_assign
id|GSTAR
suffix:semicolon
r_do
(brace
id|u32
id|state
op_assign
id|readl
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|ArAck
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s ack&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ArAck
comma
id|ioaddr
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|state
op_amp
id|Arf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s failed&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
id|writel
c_func
(paren
id|Arf
comma
id|ioaddr
)paren
suffix:semicolon
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|i
OG
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s timeout&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|msg
)paren
suffix:semicolon
id|done
suffix:colon
r_return
id|i
suffix:semicolon
)brace
DECL|function|dscc4_xpr_ack
r_static
r_inline
r_int
id|dscc4_xpr_ack
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
r_int
id|cur
op_assign
id|dpriv-&gt;iqtx_current
op_mod
id|IRQ_RING_SIZE
suffix:semicolon
id|s8
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dpriv-&gt;flags
op_amp
(paren
id|NeedIDR
op_or
id|NeedIDT
)paren
)paren
op_logical_or
(paren
id|dpriv-&gt;iqtx
(braket
id|cur
)braket
op_amp
id|Xpr
)paren
)paren
r_break
suffix:semicolon
id|smp_rmb
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|i
OG
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|i
op_ge
l_int|0
)paren
ques
c_cond
id|i
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#if 0 /* dscc4_{rx/tx}_reset are both unreliable - more tweak needed */
r_static
r_void
id|dscc4_rx_reset
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dpriv-&gt;pci_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Cf errata DS5 p.6 */
id|writel
c_func
(paren
l_int|0x00000000
comma
id|dpriv-&gt;base_addr
op_plus
id|CH0LRDA
op_plus
id|dpriv-&gt;dev_id
op_star
l_int|4
)paren
suffix:semicolon
id|scc_patchl
c_func
(paren
id|PowerUp
comma
l_int|0
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dpriv-&gt;base_addr
op_plus
id|CH0LRDA
op_plus
id|dpriv-&gt;dev_id
op_star
l_int|4
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MTFi
op_or
id|Rdr
comma
id|dpriv-&gt;base_addr
op_plus
id|dpriv-&gt;dev_id
op_star
l_int|0x0c
op_plus
id|CH0CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|Action
comma
id|dpriv-&gt;base_addr
op_plus
id|GCMDR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dpriv-&gt;pci_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if 0
r_static
r_void
id|dscc4_tx_reset
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|u16
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Cf errata DS5 p.7 */
id|scc_patchl
c_func
(paren
id|PowerUp
comma
l_int|0
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
id|scc_writel
c_func
(paren
l_int|0x00050000
comma
id|dpriv
comma
id|dev
comma
id|CCR2
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Must be longer than the time required to fill the fifo.&n;&t; */
r_while
c_loop
(paren
op_logical_neg
id|dscc4_tx_quiescent
c_func
(paren
id|dpriv
comma
id|dev
)paren
op_logical_and
op_increment
id|i
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|MTFi
op_or
id|Rdt
comma
id|dpriv-&gt;base_addr
op_plus
id|dpriv-&gt;dev_id
op_star
l_int|0x0c
op_plus
id|CH0CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;Rdt&quot;
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Tx reset failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* TODO: (ab)use this function to refill a completely depleted RX ring. */
DECL|function|dscc4_rx_skb
r_static
r_inline
r_void
id|dscc4_rx_skb
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|RxFD
op_star
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
op_plus
id|dpriv-&gt;rx_current
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|dpriv-&gt;pci_priv-&gt;pdev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
id|skb
op_assign
id|dpriv-&gt;rx_skbuff
(braket
id|dpriv-&gt;rx_current
op_increment
op_mod
id|RX_RING_SIZE
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: skb=0 (%s)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|refill
suffix:semicolon
)brace
id|pkt_len
op_assign
id|TO_SIZE
c_func
(paren
id|rx_fd-&gt;state2
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|pdev
comma
id|rx_fd-&gt;data
comma
id|RX_MAX
c_func
(paren
id|HDLC_MAX_MRU
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb-&gt;data
(braket
op_decrement
id|pkt_len
)braket
op_amp
id|FrameOk
)paren
op_eq
id|FrameOk
)paren
(brace
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
id|skb-&gt;protocol
op_assign
id|hdlc_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|skb-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|pkt_len
)braket
op_amp
id|FrameRdo
)paren
id|stats-&gt;rx_fifo_errors
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb-&gt;data
(braket
id|pkt_len
)braket
op_or
op_complement
id|FrameCrc
)paren
)paren
id|stats-&gt;rx_crc_errors
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb-&gt;data
(braket
id|pkt_len
)braket
op_or
op_complement
(paren
id|FrameVfr
op_or
id|FrameRab
)paren
)paren
)paren
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
r_else
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|refill
suffix:colon
r_while
c_loop
(paren
(paren
id|dpriv-&gt;rx_dirty
op_minus
id|dpriv-&gt;rx_current
)paren
op_mod
id|RX_RING_SIZE
)paren
(brace
r_if
c_cond
(paren
id|try_get_rx_skb
c_func
(paren
id|dpriv
comma
id|dev
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
id|dpriv-&gt;rx_dirty
op_increment
suffix:semicolon
)brace
id|dscc4_rx_update
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
id|rx_fd-&gt;state2
op_assign
l_int|0x00000000
suffix:semicolon
id|rx_fd-&gt;end
op_assign
l_int|0xbabeface
suffix:semicolon
)brace
DECL|function|dscc4_free1
r_static
r_void
id|dscc4_free1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|root
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ppriv
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|root
op_assign
id|ppriv-&gt;root
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
id|unregister_hdlc_device
c_func
(paren
id|dscc4_to_dev
c_func
(paren
op_amp
id|root
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
id|free_netdev
c_func
(paren
id|root
(braket
id|i
)braket
dot
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|root
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ppriv
)paren
suffix:semicolon
)brace
DECL|function|dscc4_init_one
r_static
r_int
id|__devinit
id|dscc4_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|dscc4_pci_priv
op_star
id|priv
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
suffix:semicolon
r_static
r_int
id|cards_found
op_assign
l_int|0
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
l_string|&quot;registers&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t reserve MMIO region (regs)&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
l_string|&quot;LBI interface&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t reserve MMIO region (lbi)&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_goto
id|err_out_free_mmio_region0
suffix:semicolon
)brace
id|ioaddr
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: cannot remap MMIO region %lx @ %lx&bslash;n&quot;
comma
id|DRV_NAME
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|err_out_free_mmio_region
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Siemens DSCC4, MMIO at %#lx (regs), %#lx (lbi), IRQ %d&bslash;n&quot;
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Cf errata DS5 p.2 */
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0xf8
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_found1
c_func
(paren
id|pdev
comma
id|ioaddr
)paren
)paren
r_goto
id|err_out_iounmap
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|dscc4_pci_priv
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
op_amp
id|dscc4_irq
comma
id|SA_SHIRQ
comma
id|DRV_NAME
comma
id|priv-&gt;root
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: IRQ %d busy&bslash;n&quot;
comma
id|DRV_NAME
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
r_goto
id|err_out_free1
suffix:semicolon
)brace
multiline_comment|/* power up/little endian/dma core controlled via lrda/ltda */
id|writel
c_func
(paren
l_int|0x00000001
comma
id|ioaddr
op_plus
id|GMODE
)paren
suffix:semicolon
multiline_comment|/* Shared interrupt queue */
(brace
id|u32
id|bits
suffix:semicolon
id|bits
op_assign
(paren
id|IRQ_RING_SIZE
op_rshift
l_int|5
)paren
op_minus
l_int|1
suffix:semicolon
id|bits
op_or_assign
id|bits
op_lshift
l_int|4
suffix:semicolon
id|bits
op_or_assign
id|bits
op_lshift
l_int|8
suffix:semicolon
id|bits
op_or_assign
id|bits
op_lshift
l_int|16
suffix:semicolon
id|writel
c_func
(paren
id|bits
comma
id|ioaddr
op_plus
id|IQLENR0
)paren
suffix:semicolon
)brace
multiline_comment|/* Global interrupt queue */
id|writel
c_func
(paren
(paren
id|u32
)paren
(paren
(paren
(paren
id|IRQ_RING_SIZE
op_rshift
l_int|5
)paren
op_minus
l_int|1
)paren
op_lshift
l_int|20
)paren
comma
id|ioaddr
op_plus
id|IQLENR1
)paren
suffix:semicolon
id|priv-&gt;iqcfg
op_assign
(paren
id|u32
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
op_amp
id|priv-&gt;iqcfg_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;iqcfg
)paren
r_goto
id|err_out_free_irq
suffix:semicolon
id|writel
c_func
(paren
id|priv-&gt;iqcfg_dma
comma
id|ioaddr
op_plus
id|IQCFG
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * SCC 0-3 private rx/tx irq structures&n;&t; * IQRX/TXi needs to be set soon. Learned it the hard way...&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dpriv
op_assign
id|priv-&gt;root
op_plus
id|i
suffix:semicolon
id|dpriv-&gt;iqtx
op_assign
(paren
id|u32
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
op_amp
id|dpriv-&gt;iqtx_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dpriv-&gt;iqtx
)paren
r_goto
id|err_out_free_iqtx
suffix:semicolon
id|writel
c_func
(paren
id|dpriv-&gt;iqtx_dma
comma
id|ioaddr
op_plus
id|IQTX0
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dpriv
op_assign
id|priv-&gt;root
op_plus
id|i
suffix:semicolon
id|dpriv-&gt;iqrx
op_assign
(paren
id|u32
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
op_amp
id|dpriv-&gt;iqrx_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dpriv-&gt;iqrx
)paren
r_goto
id|err_out_free_iqrx
suffix:semicolon
id|writel
c_func
(paren
id|dpriv-&gt;iqrx_dma
comma
id|ioaddr
op_plus
id|IQRX0
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* Cf application hint. Beware of hard-lock condition on threshold. */
id|writel
c_func
(paren
l_int|0x42104000
comma
id|ioaddr
op_plus
id|FIFOCR1
)paren
suffix:semicolon
singleline_comment|//writel(0x9ce69800, ioaddr + FIFOCR2);
id|writel
c_func
(paren
l_int|0xdef6d800
comma
id|ioaddr
op_plus
id|FIFOCR2
)paren
suffix:semicolon
singleline_comment|//writel(0x11111111, ioaddr + FIFOCR4);
id|writel
c_func
(paren
l_int|0x18181818
comma
id|ioaddr
op_plus
id|FIFOCR4
)paren
suffix:semicolon
singleline_comment|// FIXME: should depend on the chipset revision
id|writel
c_func
(paren
l_int|0x0000000e
comma
id|ioaddr
op_plus
id|FIFOCR3
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xff200001
comma
id|ioaddr
op_plus
id|GCMDR
)paren
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_free_iqrx
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
(brace
id|dpriv
op_assign
id|priv-&gt;root
op_plus
id|i
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|dpriv-&gt;iqrx
comma
id|dpriv-&gt;iqrx_dma
)paren
suffix:semicolon
)brace
id|i
op_assign
id|dev_per_card
suffix:semicolon
id|err_out_free_iqtx
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
(brace
id|dpriv
op_assign
id|priv-&gt;root
op_plus
id|i
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|dpriv-&gt;iqtx
comma
id|dpriv-&gt;iqtx_dma
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|priv-&gt;iqcfg
comma
id|priv-&gt;iqcfg_dma
)paren
suffix:semicolon
id|err_out_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|priv-&gt;root
)paren
suffix:semicolon
id|err_out_free1
suffix:colon
id|dscc4_free1
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_iounmap
suffix:colon
id|iounmap
(paren
id|ioaddr
)paren
suffix:semicolon
id|err_out_free_mmio_region
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|err_out_free_mmio_region0
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Let&squot;s hope the default values are decent enough to protect my&n; * feet from the user&squot;s gun - Ueimor&n; */
DECL|function|dscc4_init_registers
r_static
r_void
id|dscc4_init_registers
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* No interrupts, SCC core disabled. Let&squot;s relax */
id|scc_writel
c_func
(paren
l_int|0x00000000
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
id|scc_writel
c_func
(paren
id|LengthCheck
op_or
(paren
id|HDLC_MAX_MRU
op_rshift
l_int|5
)paren
comma
id|dpriv
comma
id|dev
comma
id|RLCR
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * No address recognition/crc-CCITT/cts enabled&n;&t; * Shared flags transmission disabled - cf errata DS5 p.11&n;&t; * Carrier detect disabled - cf errata p.14&n;&t; * FIXME: carrier detection/polarity may be handled more gracefully.&n;&t; */
id|scc_writel
c_func
(paren
l_int|0x02408000
comma
id|dpriv
comma
id|dev
comma
id|CCR1
)paren
suffix:semicolon
multiline_comment|/* crc not forwarded - Cf errata DS5 p.11 */
id|scc_writel
c_func
(paren
l_int|0x00050008
op_amp
op_complement
id|RxActivate
comma
id|dpriv
comma
id|dev
comma
id|CCR2
)paren
suffix:semicolon
singleline_comment|// crc forwarded
singleline_comment|//scc_writel(0x00250008 &amp; ~RxActivate, dpriv, dev, CCR2);
)brace
DECL|function|dscc4_set_quartz
r_static
r_inline
r_int
id|dscc4_set_quartz
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_int
id|hz
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hz
OL
l_int|0
)paren
op_logical_or
(paren
id|hz
OG
id|DSCC4_HZ_MAX
)paren
)paren
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_else
id|dpriv-&gt;pci_priv-&gt;xtal_hz
op_assign
id|hz
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dscc4_found1
r_static
r_int
id|dscc4_found1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_void
id|__iomem
op_star
id|ioaddr
)paren
(brace
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|root
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|root
op_assign
(paren
r_struct
id|dscc4_dev_priv
op_star
)paren
id|kmalloc
c_func
(paren
id|dev_per_card
op_star
r_sizeof
(paren
op_star
id|root
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|root
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t allocate data&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|root
comma
l_int|0
comma
id|dev_per_card
op_star
r_sizeof
(paren
op_star
id|root
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
id|root
(braket
id|i
)braket
dot
id|dev
op_assign
id|alloc_hdlcdev
c_func
(paren
id|root
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|root
(braket
id|i
)braket
dot
id|dev
)paren
(brace
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|free_netdev
c_func
(paren
id|root
(braket
id|i
)braket
dot
id|dev
)paren
suffix:semicolon
r_goto
id|err_free_dev
suffix:semicolon
)brace
)brace
id|ppriv
op_assign
(paren
r_struct
id|dscc4_pci_priv
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ppriv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ppriv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t allocate private data&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_goto
id|err_free_dev2
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ppriv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dscc4_pci_priv
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|dscc4_set_quartz
c_func
(paren
id|root
comma
id|quartz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|err_free_priv
suffix:semicolon
id|ppriv-&gt;root
op_assign
id|root
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ppriv-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|root
op_plus
id|i
suffix:semicolon
r_struct
id|net_device
op_star
id|d
op_assign
id|dscc4_to_dev
c_func
(paren
id|dpriv
)paren
suffix:semicolon
id|hdlc_device
op_star
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|d
)paren
suffix:semicolon
id|d-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|ioaddr
suffix:semicolon
id|d-&gt;init
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|d-&gt;open
op_assign
id|dscc4_open
suffix:semicolon
id|d-&gt;stop
op_assign
id|dscc4_close
suffix:semicolon
id|d-&gt;set_multicast_list
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;do_ioctl
op_assign
id|dscc4_ioctl
suffix:semicolon
id|d-&gt;tx_timeout
op_assign
id|dscc4_tx_timeout
suffix:semicolon
id|d-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|d
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|d
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
id|dpriv-&gt;dev_id
op_assign
id|i
suffix:semicolon
id|dpriv-&gt;pci_priv
op_assign
id|ppriv
suffix:semicolon
id|dpriv-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dpriv-&gt;lock
)paren
suffix:semicolon
id|hdlc-&gt;xmit
op_assign
id|dscc4_start_xmit
suffix:semicolon
id|hdlc-&gt;attach
op_assign
id|dscc4_hdlc_attach
suffix:semicolon
id|dscc4_init_registers
c_func
(paren
id|dpriv
comma
id|d
)paren
suffix:semicolon
id|dpriv-&gt;parity
op_assign
id|PARITY_CRC16_PR0_CCITT
suffix:semicolon
id|dpriv-&gt;encoding
op_assign
id|ENCODING_NRZ
suffix:semicolon
id|ret
op_assign
id|dscc4_init_ring
c_func
(paren
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|err_unregister
suffix:semicolon
id|ret
op_assign
id|register_hdlc_device
c_func
(paren
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to register&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
id|dscc4_release_ring
c_func
(paren
id|dpriv
)paren
suffix:semicolon
r_goto
id|err_unregister
suffix:semicolon
)brace
)brace
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|ppriv
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
id|err_unregister
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
(brace
id|dscc4_release_ring
c_func
(paren
id|root
op_plus
id|i
)paren
suffix:semicolon
id|unregister_hdlc_device
c_func
(paren
id|dscc4_to_dev
c_func
(paren
op_amp
id|root
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|err_free_priv
suffix:colon
id|kfree
c_func
(paren
id|ppriv
)paren
suffix:semicolon
id|err_free_dev2
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
id|free_netdev
c_func
(paren
id|root
(braket
id|i
)braket
dot
id|dev
)paren
suffix:semicolon
id|err_free_dev
suffix:colon
id|kfree
c_func
(paren
id|root
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* FIXME: get rid of the unneeded code */
DECL|function|dscc4_timer
r_static
r_void
id|dscc4_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|//&t;struct dscc4_pci_priv *ppriv;
r_goto
id|done
suffix:semicolon
id|done
suffix:colon
id|dpriv-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TX_TIMEOUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|dpriv-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|dscc4_tx_timeout
r_static
r_void
id|dscc4_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* FIXME: something is missing there */
)brace
DECL|function|dscc4_loopback_check
r_static
r_int
id|dscc4_loopback_check
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
id|sync_serial_settings
op_star
id|settings
op_assign
op_amp
id|dpriv-&gt;settings
suffix:semicolon
r_if
c_cond
(paren
id|settings-&gt;loopback
op_logical_and
(paren
id|settings-&gt;clock_type
op_ne
id|CLOCK_INT
)paren
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dscc4_to_dev
c_func
(paren
id|dpriv
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: loopback requires clock&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_DSCC4_PCI_RST
multiline_comment|/*&n; * Some DSCC4-based cards wires the GPIO port and the PCI #RST pin together&n; * so as to provide a safe way to reset the asic while not the whole machine&n; * rebooting.&n; *&n; * This code doesn&squot;t need to be efficient. Keep It Simple&n; */
DECL|function|dscc4_pci_reset
r_static
r_void
id|dscc4_pci_reset
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_void
id|__iomem
op_star
id|ioaddr
)paren
(brace
r_int
id|i
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dscc4_sem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|i
op_lshift
l_int|2
comma
id|dscc4_pci_config_store
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Maximal LBI clock divider (who cares ?) and whole GPIO range. */
id|writel
c_func
(paren
l_int|0x001c0000
comma
id|ioaddr
op_plus
id|GMODE
)paren
suffix:semicolon
multiline_comment|/* Configure GPIO port as output */
id|writel
c_func
(paren
l_int|0x0000ffff
comma
id|ioaddr
op_plus
id|GPDIR
)paren
suffix:semicolon
multiline_comment|/* Disable interruption */
id|writel
c_func
(paren
l_int|0x0000ffff
comma
id|ioaddr
op_plus
id|GPIM
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0000ffff
comma
id|ioaddr
op_plus
id|GPDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00000000
comma
id|ioaddr
op_plus
id|GPDATA
)paren
suffix:semicolon
multiline_comment|/* Flush posted writes */
id|readl
c_func
(paren
id|ioaddr
op_plus
id|GSTAR
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|i
op_lshift
l_int|2
comma
id|dscc4_pci_config_store
(braket
id|i
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dscc4_sem
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|dscc4_pci_reset
mdefine_line|#define dscc4_pci_reset(pdev,ioaddr)&t;do {} while (0)
macro_line|#endif /* CONFIG_DSCC4_PCI_RST */
DECL|function|dscc4_open
r_static
r_int
id|dscc4_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dscc4_loopback_check
c_func
(paren
id|dpriv
)paren
OL
l_int|0
)paren
op_logical_or
op_logical_neg
id|dev-&gt;hard_start_xmit
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|hdlc_open
c_func
(paren
id|dev
)paren
)paren
)paren
r_goto
id|err
suffix:semicolon
id|ppriv
op_assign
id|dpriv-&gt;pci_priv
suffix:semicolon
multiline_comment|/*&n;&t; * Due to various bugs, there is no way to reliably reset a&n;&t; * specific port (manufacturer&squot;s dependant special PCI #RST wiring&n;&t; * apart: it affects all ports). Thus the device goes in the best&n;&t; * silent mode possible at dscc4_close() time and simply claims to&n;&t; * be up if it&squot;s opened again. It still isn&squot;t possible to change&n;&t; * the HDLC configuration without rebooting but at least the ports&n;&t; * can be up/down ifconfig&squot;ed without killing the host.&n;&t; */
r_if
c_cond
(paren
id|dpriv-&gt;flags
op_amp
id|FakeReset
)paren
(brace
id|dpriv-&gt;flags
op_and_assign
op_complement
id|FakeReset
suffix:semicolon
id|scc_patchl
c_func
(paren
l_int|0
comma
id|PowerUp
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
id|scc_patchl
c_func
(paren
l_int|0
comma
l_int|0x00050000
comma
id|dpriv
comma
id|dev
comma
id|CCR2
)paren
suffix:semicolon
id|scc_writel
c_func
(paren
id|EventsMask
comma
id|dpriv
comma
id|dev
comma
id|IMR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: up again.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/* IDT+IDR during XPR */
id|dpriv-&gt;flags
op_assign
id|NeedIDR
op_or
id|NeedIDT
suffix:semicolon
id|scc_patchl
c_func
(paren
l_int|0
comma
id|PowerUp
op_or
id|Vis
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The following is a bit paranoid...&n;&t; *&n;&t; * NB: the datasheet &quot;...CEC will stay active if the SCC is in&n;&t; * power-down mode or...&quot; and CCR2.RAC = 1 are two different&n;&t; * situations.&n;&t; */
r_if
c_cond
(paren
id|scc_readl_star
c_func
(paren
id|dpriv
comma
id|dev
)paren
op_amp
id|SccBusy
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s busy. Try later&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: available. Good&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|scc_writel
c_func
(paren
id|EventsMask
comma
id|dpriv
comma
id|dev
comma
id|IMR
)paren
suffix:semicolon
multiline_comment|/* Posted write is flushed in the wait_ack loop */
id|scc_writel
c_func
(paren
id|TxSccRes
op_or
id|RxSccRes
comma
id|dpriv
comma
id|dev
comma
id|CMDR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dscc4_wait_ack_cec
c_func
(paren
id|dpriv
comma
id|dev
comma
l_string|&quot;Cec&quot;
)paren
)paren
OL
l_int|0
)paren
r_goto
id|err_disable_scc_events
suffix:semicolon
multiline_comment|/*&n;&t; * I would expect XPR near CE completion (before ? after ?).&n;&t; * At worst, this code won&squot;t see a late XPR and people&n;&t; * will have to re-issue an ifconfig (this is harmless).&n;&t; * WARNING, a really missing XPR usually means a hardware&n;&t; * reset is needed. Suggestions anyone ?&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dscc4_xpr_ack
c_func
(paren
id|dpriv
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s timeout&bslash;n&quot;
comma
id|DRV_NAME
comma
l_string|&quot;XPR&quot;
)paren
suffix:semicolon
r_goto
id|err_disable_scc_events
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|dscc4_tx_print
c_func
(paren
id|dev
comma
id|dpriv
comma
l_string|&quot;Open&quot;
)paren
suffix:semicolon
id|done
suffix:colon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|dpriv-&gt;timer
)paren
suffix:semicolon
id|dpriv-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|dpriv-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|dpriv-&gt;timer.function
op_assign
op_amp
id|dscc4_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|dpriv-&gt;timer
)paren
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_disable_scc_events
suffix:colon
id|scc_writel
c_func
(paren
l_int|0xffffffff
comma
id|dpriv
comma
id|dev
comma
id|IMR
)paren
suffix:semicolon
id|scc_patchl
c_func
(paren
id|PowerUp
op_or
id|Vis
comma
l_int|0
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
id|err_out
suffix:colon
id|hdlc_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef DSCC4_POLLING
DECL|function|dscc4_tx_poll
r_static
r_int
id|dscc4_tx_poll
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* FIXME: it&squot;s gonna be easy (TM), for sure */
)brace
macro_line|#endif /* DSCC4_POLLING */
DECL|function|dscc4_start_xmit
r_static
r_int
id|dscc4_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
op_assign
id|dpriv-&gt;pci_priv
suffix:semicolon
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
r_int
id|next
suffix:semicolon
id|next
op_assign
id|dpriv-&gt;tx_current
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|dpriv-&gt;tx_skbuff
(braket
id|next
)braket
op_assign
id|skb
suffix:semicolon
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
op_plus
id|next
suffix:semicolon
id|tx_fd-&gt;state
op_assign
id|FrameEnd
op_or
id|TO_STATE_TX
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|tx_fd-&gt;data
op_assign
id|pci_map_single
c_func
(paren
id|ppriv-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|tx_fd-&gt;complete
op_assign
l_int|0x00000000
suffix:semicolon
id|tx_fd-&gt;jiffies
op_assign
id|jiffies
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef DSCC4_POLLING
id|spin_lock
c_func
(paren
op_amp
id|dpriv-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dscc4_tx_poll
c_func
(paren
id|dpriv
comma
id|dev
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dpriv-&gt;lock
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|dscc4_tx_print
c_func
(paren
id|dev
comma
id|dpriv
comma
l_string|&quot;Xmit&quot;
)paren
suffix:semicolon
multiline_comment|/* To be cleaned(unsigned int)/optimized. Later, ok ? */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
op_increment
id|dpriv-&gt;tx_current
op_minus
id|dpriv-&gt;tx_dirty
)paren
op_mod
id|TX_RING_SIZE
)paren
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_tx_quiescent
c_func
(paren
id|dpriv
comma
id|dev
)paren
)paren
id|dscc4_do_tx
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dscc4_close
r_static
r_int
id|dscc4_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|dpriv-&gt;timer
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|scc_patchl
c_func
(paren
id|PowerUp
op_or
id|Vis
comma
l_int|0
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
id|scc_patchl
c_func
(paren
l_int|0x00050000
comma
l_int|0
comma
id|dpriv
comma
id|dev
comma
id|CCR2
)paren
suffix:semicolon
id|scc_writel
c_func
(paren
l_int|0xffffffff
comma
id|dpriv
comma
id|dev
comma
id|IMR
)paren
suffix:semicolon
id|dpriv-&gt;flags
op_or_assign
id|FakeReset
suffix:semicolon
id|hdlc_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dscc4_check_clock_ability
r_static
r_inline
r_int
id|dscc4_check_clock_ability
c_func
(paren
r_int
id|port
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_DSCC4_PCISYNC
r_if
c_cond
(paren
id|port
op_ge
l_int|2
)paren
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * DS1 p.137: &quot;There are a total of 13 different clocking modes...&quot;&n; *                                  ^^&n; * Design choices:&n; * - by default, assume a clock is provided on pin RxClk/TxClk (clock mode 0a).&n; *   Clock mode 3b _should_ work but the testing seems to make this point&n; *   dubious (DIY testing requires setting CCR0 at 0x00000033).&n; *   This is supposed to provide least surprise &quot;DTE like&quot; behavior.&n; * - if line rate is specified, clocks are assumed to be locally generated.&n; *   A quartz must be available (on pin XTAL1). Modes 6b/7b are used. Choosing&n; *   between these it automagically done according on the required frequency&n; *   scaling. Of course some rounding may take place.&n; * - no high speed mode (40Mb/s). May be trivial to do but I don&squot;t have an&n; *   appropriate external clocking device for testing.&n; * - no time-slot/clock mode 5: shameless lazyness.&n; *&n; * The clock signals wiring can be (is ?) manufacturer dependant. Good luck.&n; *&n; * BIG FAT WARNING: if the device isn&squot;t provided enough clocking signal, it&n; * won&squot;t pass the init sequence. For example, straight back-to-back DTE without&n; * external clock will fail when dscc4_open() (&lt;- &squot;ifconfig hdlcx xxx&squot;) is&n; * called.&n; *&n; * Typos lurk in datasheet (missing divier in clock mode 7a figure 51 p.153&n; * DS0 for example)&n; *&n; * Clock mode related bits of CCR0:&n; *     +------------ TOE: output TxClk (0b/2b/3a/3b/6b/7a/7b only)&n; *     | +---------- SSEL: sub-mode select 0 -&gt; a, 1 -&gt; b&n; *     | | +-------- High Speed: say 0&n; *     | | | +-+-+-- Clock Mode: 0..7&n; *     | | | | | |&n; * -+-+-+-+-+-+-+-+&n; * x|x|5|4|3|2|1|0| lower bits&n; *&n; * Division factor of BRR: k = (N+1)x2^M (total divider = 16xk in mode 6b)&n; *            +-+-+-+------------------ M (0..15)&n; *            | | | |     +-+-+-+-+-+-- N (0..63)&n; *    0 0 0 0 | | | | 0 0 | | | | | |&n; * ...-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    f|e|d|c|b|a|9|8|7|6|5|4|3|2|1|0| lower bits&n; *&n; */
DECL|function|dscc4_set_clock
r_static
r_int
id|dscc4_set_clock
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|bps
comma
id|u32
op_star
id|state
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
id|u32
id|brr
suffix:semicolon
op_star
id|state
op_and_assign
op_complement
id|Ccr0ClockMask
suffix:semicolon
r_if
c_cond
(paren
op_star
id|bps
)paren
(brace
multiline_comment|/* Clock generated - required for DCE */
id|u32
id|n
op_assign
l_int|0
comma
id|m
op_assign
l_int|0
comma
id|divider
suffix:semicolon
r_int
id|xtal
suffix:semicolon
id|xtal
op_assign
id|dpriv-&gt;pci_priv-&gt;xtal_hz
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xtal
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_check_clock_ability
c_func
(paren
id|dpriv-&gt;dev_id
)paren
OL
l_int|0
)paren
r_goto
id|done
suffix:semicolon
id|divider
op_assign
id|xtal
op_div
op_star
id|bps
suffix:semicolon
r_if
c_cond
(paren
id|divider
OG
id|BRR_DIVIDER_MAX
)paren
(brace
id|divider
op_rshift_assign
l_int|4
suffix:semicolon
op_star
id|state
op_or_assign
l_int|0x00000036
suffix:semicolon
multiline_comment|/* Clock mode 6b (BRG/16) */
)brace
r_else
op_star
id|state
op_or_assign
l_int|0x00000037
suffix:semicolon
multiline_comment|/* Clock mode 7b (BRG) */
r_if
c_cond
(paren
id|divider
op_rshift
l_int|22
)paren
(brace
id|n
op_assign
l_int|63
suffix:semicolon
id|m
op_assign
l_int|15
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|divider
)paren
(brace
multiline_comment|/* Extraction of the 6 highest weighted bits */
id|m
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|0xffffffc0
op_amp
id|divider
)paren
(brace
id|m
op_increment
suffix:semicolon
id|divider
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|n
op_assign
id|divider
suffix:semicolon
)brace
id|brr
op_assign
(paren
id|m
op_lshift
l_int|8
)paren
op_or
id|n
suffix:semicolon
id|divider
op_assign
id|n
op_lshift
id|m
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|state
op_amp
l_int|0x00000001
)paren
)paren
multiline_comment|/* ?b mode mask =&gt; clock mode 6b */
id|divider
op_lshift_assign
l_int|4
suffix:semicolon
op_star
id|bps
op_assign
id|xtal
op_div
id|divider
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * External clock - DTE&n;&t;&t; * &quot;state&quot; already reflects Clock mode 0a (CCR0 = 0xzzzzzz00).&n;&t;&t; * Nothing more to be done&n;&t;&t; */
id|brr
op_assign
l_int|0
suffix:semicolon
)brace
id|scc_writel
c_func
(paren
id|brr
comma
id|dpriv
comma
id|dev
comma
id|BRR
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|done
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dscc4_ioctl
r_static
r_int
id|dscc4_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
id|sync_serial_settings
id|__user
op_star
id|line
op_assign
id|ifr-&gt;ifr_settings.ifs_ifsu.sync
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_const
r_int
id|size
op_assign
r_sizeof
(paren
id|dpriv-&gt;settings
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCWANDEV
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_GET_IFACE
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_SYNC_SERIAL
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
OL
id|size
)paren
(brace
id|ifr-&gt;ifr_settings.size
op_assign
id|size
suffix:semicolon
multiline_comment|/* data size wanted */
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|line
comma
op_amp
id|dpriv-&gt;settings
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_IFACE_SYNC_SERIAL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|dpriv-&gt;flags
op_amp
id|FakeReset
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: please reset the device&quot;
l_string|&quot; before this command&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dpriv-&gt;settings
comma
id|line
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
id|dscc4_set_iface
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dscc4_match
r_static
r_int
id|dscc4_match
c_func
(paren
r_struct
id|thingie
op_star
id|p
comma
r_int
id|value
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|p
(braket
id|i
)braket
dot
id|define
op_ne
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|p
(braket
id|i
)braket
dot
id|define
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p
(braket
id|i
)braket
dot
id|define
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_else
r_return
id|i
suffix:semicolon
)brace
DECL|function|dscc4_clock_setting
r_static
r_int
id|dscc4_clock_setting
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|sync_serial_settings
op_star
id|settings
op_assign
op_amp
id|dpriv-&gt;settings
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|u32
id|bps
comma
id|state
suffix:semicolon
id|bps
op_assign
id|settings-&gt;clock_rate
suffix:semicolon
id|state
op_assign
id|scc_readl
c_func
(paren
id|dpriv
comma
id|CCR0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_set_clock
c_func
(paren
id|dev
comma
op_amp
id|bps
comma
op_amp
id|state
)paren
OL
l_int|0
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|bps
)paren
(brace
multiline_comment|/* DCE */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: generated RxClk (DCE)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|settings-&gt;clock_rate
op_ne
id|bps
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: clock adjusted (%08d -&gt; %08d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|settings-&gt;clock_rate
comma
id|bps
)paren
suffix:semicolon
id|settings-&gt;clock_rate
op_assign
id|bps
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* DTE */
id|state
op_or_assign
id|PowerUp
op_or
id|Vis
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: external RxClk (DTE)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|scc_writel
c_func
(paren
id|state
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|done
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dscc4_encoding_setting
r_static
r_int
id|dscc4_encoding_setting
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|thingie
id|encoding
(braket
)braket
op_assign
(brace
(brace
id|ENCODING_NRZ
comma
l_int|0x00000000
)brace
comma
(brace
id|ENCODING_NRZI
comma
l_int|0x00200000
)brace
comma
(brace
id|ENCODING_FM_MARK
comma
l_int|0x00400000
)brace
comma
(brace
id|ENCODING_FM_SPACE
comma
l_int|0x00500000
)brace
comma
(brace
id|ENCODING_MANCHESTER
comma
l_int|0x00600000
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|dscc4_match
c_func
(paren
id|encoding
comma
id|dpriv-&gt;encoding
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
id|scc_patchl
c_func
(paren
id|EncodingMask
comma
id|encoding
(braket
id|i
)braket
dot
id|bits
comma
id|dpriv
comma
id|dev
comma
id|CCR0
)paren
suffix:semicolon
r_else
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dscc4_loopback_setting
r_static
r_int
id|dscc4_loopback_setting
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|sync_serial_settings
op_star
id|settings
op_assign
op_amp
id|dpriv-&gt;settings
suffix:semicolon
id|u32
id|state
suffix:semicolon
id|state
op_assign
id|scc_readl
c_func
(paren
id|dpriv
comma
id|CCR1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|settings-&gt;loopback
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: loopback&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|state
op_or_assign
l_int|0x00000100
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: normal&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|state
op_and_assign
op_complement
l_int|0x00000100
suffix:semicolon
)brace
id|scc_writel
c_func
(paren
id|state
comma
id|dpriv
comma
id|dev
comma
id|CCR1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dscc4_crc_setting
r_static
r_int
id|dscc4_crc_setting
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|thingie
id|crc
(braket
)braket
op_assign
(brace
(brace
id|PARITY_CRC16_PR0_CCITT
comma
l_int|0x00000010
)brace
comma
(brace
id|PARITY_CRC16_PR1_CCITT
comma
l_int|0x00000000
)brace
comma
(brace
id|PARITY_CRC32_PR0_CCITT
comma
l_int|0x00000011
)brace
comma
(brace
id|PARITY_CRC32_PR1_CCITT
comma
l_int|0x00000001
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|dscc4_match
c_func
(paren
id|crc
comma
id|dpriv-&gt;parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
id|scc_patchl
c_func
(paren
id|CrcMask
comma
id|crc
(braket
id|i
)braket
dot
id|bits
comma
id|dpriv
comma
id|dev
comma
id|CCR1
)paren
suffix:semicolon
r_else
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dscc4_set_iface
r_static
r_int
id|dscc4_set_iface
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
(brace
r_int
(paren
op_star
id|action
)paren
(paren
r_struct
id|dscc4_dev_priv
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
)brace
op_star
id|p
comma
id|do_setting
(braket
)braket
op_assign
(brace
(brace
id|dscc4_encoding_setting
)brace
comma
(brace
id|dscc4_clock_setting
)brace
comma
(brace
id|dscc4_loopback_setting
)brace
comma
(brace
id|dscc4_crc_setting
)brace
comma
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|do_setting
suffix:semicolon
id|p-&gt;action
suffix:semicolon
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|p
op_member_access_from_pointer
id|action
c_func
(paren
id|dpriv
comma
id|dev
)paren
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dscc4_irq
r_static
id|irqreturn_t
id|dscc4_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|token
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|root
op_assign
id|token
suffix:semicolon
r_struct
id|dscc4_pci_priv
op_star
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr
suffix:semicolon
id|u32
id|state
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|handled
op_assign
l_int|1
suffix:semicolon
id|priv
op_assign
id|root-&gt;pci_priv
suffix:semicolon
id|dev
op_assign
id|dscc4_to_dev
c_func
(paren
id|root
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ioaddr
op_assign
id|root-&gt;base_addr
suffix:semicolon
id|state
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|GSTAR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
id|handled
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: GSTAR = 0x%08x&bslash;n&quot;
comma
id|DRV_NAME
comma
id|state
)paren
suffix:semicolon
id|writel
c_func
(paren
id|state
comma
id|ioaddr
op_plus
id|GSTAR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|Arf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: failure (Arf). Harass the maintener&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|state
op_and_assign
op_complement
id|ArAck
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|Cfg
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: CfgIV&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;iqcfg
(braket
id|priv-&gt;cfg_cur
op_increment
op_mod
id|IRQ_RING_SIZE
)braket
op_amp
id|Arf
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s failed&bslash;n&quot;
comma
id|dev-&gt;name
comma
l_string|&quot;CFG&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Cfg
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|RxEvt
)paren
(brace
id|i
op_assign
id|dev_per_card
op_minus
l_int|1
suffix:semicolon
r_do
(brace
id|dscc4_rx_irq
c_func
(paren
id|priv
comma
id|root
op_plus
id|i
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
suffix:semicolon
id|state
op_and_assign
op_complement
id|RxEvt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|TxEvt
)paren
(brace
id|i
op_assign
id|dev_per_card
op_minus
l_int|1
suffix:semicolon
r_do
(brace
id|dscc4_tx_irq
c_func
(paren
id|priv
comma
id|root
op_plus
id|i
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
suffix:semicolon
id|state
op_and_assign
op_complement
id|TxEvt
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
DECL|function|dscc4_tx_irq
r_static
r_void
id|dscc4_tx_irq
c_func
(paren
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
comma
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dscc4_to_dev
c_func
(paren
id|dpriv
)paren
suffix:semicolon
id|u32
id|state
suffix:semicolon
r_int
id|cur
comma
id|loop
op_assign
l_int|0
suffix:semicolon
r_try
suffix:colon
id|cur
op_assign
id|dpriv-&gt;iqtx_current
op_mod
id|IRQ_RING_SIZE
suffix:semicolon
id|state
op_assign
id|dpriv-&gt;iqtx
(braket
id|cur
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Tx ISR = 0x%08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|debug
OG
l_int|1
)paren
op_logical_and
(paren
id|loop
OG
l_int|1
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Tx irq loop=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|loop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loop
op_logical_and
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
r_if
c_cond
(paren
(paren
id|dpriv-&gt;tx_current
op_minus
id|dpriv-&gt;tx_dirty
)paren
op_mod
id|TX_RING_SIZE
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
op_logical_and
id|dscc4_tx_quiescent
c_func
(paren
id|dpriv
comma
id|dev
)paren
op_logical_and
op_logical_neg
id|dscc4_tx_done
c_func
(paren
id|dpriv
)paren
)paren
id|dscc4_do_tx
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|loop
op_increment
suffix:semicolon
id|dpriv-&gt;iqtx
(braket
id|cur
)braket
op_assign
l_int|0
suffix:semicolon
id|dpriv-&gt;iqtx_current
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|state_check
c_func
(paren
id|state
comma
id|dpriv
comma
id|dev
comma
l_string|&quot;Tx&quot;
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|SccEvt
)paren
(brace
r_if
c_cond
(paren
id|state
op_amp
id|Alls
)paren
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|dscc4_tx_print
c_func
(paren
id|dev
comma
id|dpriv
comma
l_string|&quot;Alls&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * DataComplete can&squot;t be trusted for Tx completion.&n;&t;&t;&t; * Cf errata DS5 p.8&n;&t;&t;&t; */
id|cur
op_assign
id|dpriv-&gt;tx_dirty
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
op_plus
id|cur
suffix:semicolon
id|skb
op_assign
id|dpriv-&gt;tx_skbuff
(braket
id|cur
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|ppriv-&gt;pdev
comma
id|tx_fd-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_fd-&gt;state
op_amp
id|FrameEnd
)paren
(brace
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dpriv-&gt;tx_skbuff
(braket
id|cur
)braket
op_assign
l_int|NULL
suffix:semicolon
op_increment
id|dpriv-&gt;tx_dirty
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s Tx: NULL skb %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cur
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * If the driver ends sending crap on the wire, it&n;&t;&t;&t; * will be way easier to diagnose than the (not so)&n;&t;&t;&t; * random freeze induced by null sized tx frames.&n;&t;&t;&t; */
id|tx_fd-&gt;data
op_assign
id|tx_fd-&gt;next
suffix:semicolon
id|tx_fd-&gt;state
op_assign
id|FrameEnd
op_or
id|TO_STATE_TX
c_func
(paren
l_int|2
op_star
id|DUMMY_SKB_SIZE
)paren
suffix:semicolon
id|tx_fd-&gt;complete
op_assign
l_int|0x00000000
suffix:semicolon
id|tx_fd-&gt;jiffies
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Alls
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Transmit Data Underrun&n;&t;&t; */
r_if
c_cond
(paren
id|state
op_amp
id|Xdu
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: XDU. Ask maintainer&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
id|dpriv-&gt;flags
op_assign
id|NeedIDT
suffix:semicolon
multiline_comment|/* Tx reset */
id|writel
c_func
(paren
id|MTFi
op_or
id|Rdt
comma
id|dpriv-&gt;base_addr
op_plus
l_int|0x0c
op_star
id|dpriv-&gt;dev_id
op_plus
id|CH0CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|Action
comma
id|dpriv-&gt;base_addr
op_plus
id|GCMDR
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Cts
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CTS transition&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Cts
)paren
)paren
multiline_comment|/* DEBUG */
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Xmr
)paren
(brace
multiline_comment|/* Frame needs to be sent again - FIXME */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Xmr. Ask maintainer&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Xmr
)paren
)paren
multiline_comment|/* DEBUG */
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Xpr
)paren
(brace
r_void
id|__iomem
op_star
id|scc_addr
suffix:semicolon
r_int
r_int
id|ring
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * - the busy condition happens (sometimes);&n;&t;&t;&t; * - it doesn&squot;t seem to make the handler unreliable.&n;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
suffix:semicolon
id|i
op_lshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|scc_readl_star
c_func
(paren
id|dpriv
comma
id|dev
)paren
op_amp
id|SccBusy
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s busy in irq&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|scc_addr
op_assign
id|dpriv-&gt;base_addr
op_plus
l_int|0x0c
op_star
id|dpriv-&gt;dev_id
suffix:semicolon
multiline_comment|/* Keep this order: IDT before IDR */
r_if
c_cond
(paren
id|dpriv-&gt;flags
op_amp
id|NeedIDT
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|dscc4_tx_print
c_func
(paren
id|dev
comma
id|dpriv
comma
l_string|&quot;Xpr&quot;
)paren
suffix:semicolon
id|ring
op_assign
id|dpriv-&gt;tx_fd_dma
op_plus
(paren
id|dpriv-&gt;tx_dirty
op_mod
id|TX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|TxFD
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ring
comma
id|scc_addr
op_plus
id|CH0BTDA
)paren
suffix:semicolon
id|dscc4_do_tx
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MTFi
op_or
id|Idt
comma
id|scc_addr
op_plus
id|CH0CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;IDT&quot;
)paren
OL
l_int|0
)paren
r_goto
id|err_xpr
suffix:semicolon
id|dpriv-&gt;flags
op_and_assign
op_complement
id|NeedIDT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dpriv-&gt;flags
op_amp
id|NeedIDR
)paren
(brace
id|ring
op_assign
id|dpriv-&gt;rx_fd_dma
op_plus
(paren
id|dpriv-&gt;rx_current
op_mod
id|RX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|RxFD
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ring
comma
id|scc_addr
op_plus
id|CH0BRDA
)paren
suffix:semicolon
id|dscc4_rx_update
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MTFi
op_or
id|Idr
comma
id|scc_addr
op_plus
id|CH0CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;IDR&quot;
)paren
OL
l_int|0
)paren
r_goto
id|err_xpr
suffix:semicolon
id|dpriv-&gt;flags
op_and_assign
op_complement
id|NeedIDR
suffix:semicolon
id|smp_wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Activate receiver and misc */
id|scc_writel
c_func
(paren
l_int|0x08050008
comma
id|dpriv
comma
id|dev
comma
id|CCR2
)paren
suffix:semicolon
)brace
id|err_xpr
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Xpr
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Cd
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CD transition&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Cd
)paren
)paren
multiline_comment|/* DEBUG */
r_goto
r_try
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ! SccEvt */
r_if
c_cond
(paren
id|state
op_amp
id|Hi
)paren
(brace
macro_line|#ifdef DSCC4_POLLING
r_while
c_loop
(paren
op_logical_neg
id|dscc4_tx_poll
c_func
(paren
id|dpriv
comma
id|dev
)paren
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Tx Hi&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|state
op_and_assign
op_complement
id|Hi
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Tx ERR&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hdlc_stats
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|tx_errors
op_increment
suffix:semicolon
id|state
op_and_assign
op_complement
id|Err
suffix:semicolon
)brace
)brace
r_goto
r_try
suffix:semicolon
)brace
DECL|function|dscc4_rx_irq
r_static
r_void
id|dscc4_rx_irq
c_func
(paren
r_struct
id|dscc4_pci_priv
op_star
id|priv
comma
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dscc4_to_dev
c_func
(paren
id|dpriv
)paren
suffix:semicolon
id|u32
id|state
suffix:semicolon
r_int
id|cur
suffix:semicolon
r_try
suffix:colon
id|cur
op_assign
id|dpriv-&gt;iqrx_current
op_mod
id|IRQ_RING_SIZE
suffix:semicolon
id|state
op_assign
id|dpriv-&gt;iqrx
(braket
id|cur
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
r_return
suffix:semicolon
id|dpriv-&gt;iqrx
(braket
id|cur
)braket
op_assign
l_int|0
suffix:semicolon
id|dpriv-&gt;iqrx_current
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|state_check
c_func
(paren
id|state
comma
id|dpriv
comma
id|dev
comma
l_string|&quot;Rx&quot;
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_amp
id|SccEvt
)paren
)paren
(brace
r_struct
id|RxFD
op_star
id|rx_fd
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Rx ISR = 0x%08x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|state
)paren
suffix:semicolon
id|state
op_and_assign
l_int|0x00ffffff
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|Err
)paren
(brace
multiline_comment|/* Hold or reset */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Rx ERR&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|cur
op_assign
id|dpriv-&gt;rx_current
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
op_plus
id|cur
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Presume we&squot;re not facing a DMAC receiver reset.&n;&t;&t;&t; * As We use the rx size-filtering feature of the&n;&t;&t;&t; * DSCC4, the beginning of a new frame is waiting in&n;&t;&t;&t; * the rx fifo. I bet a Receive Data Overflow will&n;&t;&t;&t; * happen most of time but let&squot;s try and avoid it.&n;&t;&t;&t; * Btw (as for RDO) if one experiences ERR whereas&n;&t;&t;&t; * the system looks rather idle, there may be a&n;&t;&t;&t; * problem with latency. In this case, increasing&n;&t;&t;&t; * RX_RING_SIZE may help.&n;&t;&t;&t; */
singleline_comment|//while (dpriv-&gt;rx_needs_refill) {
r_while
c_loop
(paren
op_logical_neg
(paren
id|rx_fd-&gt;state1
op_amp
id|Hold
)paren
)paren
(brace
id|rx_fd
op_increment
suffix:semicolon
id|cur
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cur
op_assign
id|cur
op_mod
id|RX_RING_SIZE
)paren
)paren
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
suffix:semicolon
)brace
singleline_comment|//dpriv-&gt;rx_needs_refill--;
id|try_get_rx_skb
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rx_fd-&gt;data
)paren
r_goto
r_try
suffix:semicolon
id|rx_fd-&gt;state1
op_and_assign
op_complement
id|Hold
suffix:semicolon
id|rx_fd-&gt;state2
op_assign
l_int|0x00000000
suffix:semicolon
id|rx_fd-&gt;end
op_assign
l_int|0xbabeface
suffix:semicolon
singleline_comment|//}
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Fi
)paren
(brace
id|dscc4_rx_skb
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Hi
)paren
(brace
multiline_comment|/* HI bit */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Rx Hi&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|state
op_and_assign
op_complement
id|Hi
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* SccEvt */
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
(brace
singleline_comment|//FIXME: verifier la presence de tous les evenements
r_static
r_struct
(brace
id|u32
id|mask
suffix:semicolon
r_const
r_char
op_star
id|irq_name
suffix:semicolon
)brace
id|evts
(braket
)braket
op_assign
(brace
(brace
l_int|0x00008000
comma
l_string|&quot;TIN&quot;
)brace
comma
(brace
l_int|0x00000020
comma
l_string|&quot;RSC&quot;
)brace
comma
(brace
l_int|0x00000010
comma
l_string|&quot;PCE&quot;
)brace
comma
(brace
l_int|0x00000008
comma
l_string|&quot;PLLA&quot;
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
comma
op_star
id|evt
suffix:semicolon
r_for
c_loop
(paren
id|evt
op_assign
id|evts
suffix:semicolon
id|evt-&gt;irq_name
suffix:semicolon
id|evt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|state
op_amp
id|evt-&gt;mask
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|evt-&gt;irq_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|evt-&gt;mask
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
l_int|0x0000c03c
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Cts
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CTS transition&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Cts
)paren
)paren
multiline_comment|/* DEBUG */
r_goto
r_try
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Receive Data Overflow (FIXME: fscked)&n;&t;&t; */
r_if
c_cond
(paren
id|state
op_amp
id|Rdo
)paren
(brace
r_struct
id|RxFD
op_star
id|rx_fd
suffix:semicolon
r_void
id|__iomem
op_star
id|scc_addr
suffix:semicolon
r_int
id|cur
suffix:semicolon
singleline_comment|//if (debug)
singleline_comment|//&t;dscc4_rx_dump(dpriv);
id|scc_addr
op_assign
id|dpriv-&gt;base_addr
op_plus
l_int|0x0c
op_star
id|dpriv-&gt;dev_id
suffix:semicolon
id|scc_patchl
c_func
(paren
id|RxActivate
comma
l_int|0
comma
id|dpriv
comma
id|dev
comma
id|CCR2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * This has no effect. Why ?&n;&t;&t;&t; * ORed with TxSccRes, one sees the CFG ack (for&n;&t;&t;&t; * the TX part only).&n;&t;&t;&t; */
id|scc_writel
c_func
(paren
id|RxSccRes
comma
id|dpriv
comma
id|dev
comma
id|CMDR
)paren
suffix:semicolon
id|dpriv-&gt;flags
op_or_assign
id|RdoSet
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Let&squot;s try and save something in the received data.&n;&t;&t;&t; * rx_current must be incremented at least once to&n;&t;&t;&t; * avoid HOLD in the BRDA-to-be-pointed desc.&n;&t;&t;&t; */
r_do
(brace
id|cur
op_assign
id|dpriv-&gt;rx_current
op_increment
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|rx_fd
op_assign
id|dpriv-&gt;rx_fd
op_plus
id|cur
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rx_fd-&gt;state2
op_amp
id|DataComplete
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rx_fd-&gt;state2
op_amp
id|FrameAborted
)paren
(brace
id|hdlc_stats
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|rx_over_errors
op_increment
suffix:semicolon
id|rx_fd-&gt;state1
op_or_assign
id|Hold
suffix:semicolon
id|rx_fd-&gt;state2
op_assign
l_int|0x00000000
suffix:semicolon
id|rx_fd-&gt;end
op_assign
l_int|0xbabeface
suffix:semicolon
)brace
r_else
id|dscc4_rx_skb
c_func
(paren
id|dpriv
comma
id|dev
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|dpriv-&gt;flags
op_amp
id|RdoSet
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: no RDO in Rx data&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
)brace
macro_line|#ifdef DSCC4_RDO_EXPERIMENTAL_RECOVERY
multiline_comment|/*&n;&t;&t;&t; * FIXME: must the reset be this violent ?&n;&t;&t;&t; */
macro_line|#warning &quot;FIXME: CH0BRDA&quot;
id|writel
c_func
(paren
id|dpriv-&gt;rx_fd_dma
op_plus
(paren
id|dpriv-&gt;rx_current
op_mod
id|RX_RING_SIZE
)paren
op_star
r_sizeof
(paren
r_struct
id|RxFD
)paren
comma
id|scc_addr
op_plus
id|CH0BRDA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MTFi
op_or
id|Rdr
op_or
id|Idr
comma
id|scc_addr
op_plus
id|CH0CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;RDR&quot;
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RDO recovery failed(%s)&bslash;n&quot;
comma
id|dev-&gt;name
comma
l_string|&quot;RDR&quot;
)paren
suffix:semicolon
r_goto
id|rdo_end
suffix:semicolon
)brace
id|writel
c_func
(paren
id|MTFi
op_or
id|Idr
comma
id|scc_addr
op_plus
id|CH0CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_do_action
c_func
(paren
id|dev
comma
l_string|&quot;IDR&quot;
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RDO recovery failed(%s)&bslash;n&quot;
comma
id|dev-&gt;name
comma
l_string|&quot;IDR&quot;
)paren
suffix:semicolon
r_goto
id|rdo_end
suffix:semicolon
)brace
id|rdo_end
suffix:colon
macro_line|#endif
id|scc_patchl
c_func
(paren
l_int|0
comma
id|RxActivate
comma
id|dpriv
comma
id|dev
comma
id|CCR2
)paren
suffix:semicolon
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Cd
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CD transition&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Cd
)paren
)paren
multiline_comment|/* DEBUG */
r_goto
r_try
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|Flex
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Flex. Ttttt...&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_and_assign
op_complement
id|Flex
)paren
)paren
r_goto
r_try
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * I had expected the following to work for the first descriptor&n; * (tx_fd-&gt;state = 0xc0000000)&n; * - Hold=1 (don&squot;t try and branch to the next descripto);&n; * - No=0 (I want an empty data section, i.e. size=0);&n; * - Fe=1 (required by No=0 or we got an Err irq and must reset).&n; * It failed and locked solid. Thus the introduction of a dummy skb.&n; * Problem is acknowledged in errata sheet DS5. Joy :o/&n; */
DECL|function|dscc4_init_dummy_skb
r_struct
id|sk_buff
op_star
id|dscc4_init_dummy_skb
c_func
(paren
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|DUMMY_SKB_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_int
id|last
op_assign
id|dpriv-&gt;tx_dirty
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_struct
id|TxFD
op_star
id|tx_fd
op_assign
id|dpriv-&gt;tx_fd
op_plus
id|last
suffix:semicolon
id|skb-&gt;len
op_assign
id|DUMMY_SKB_SIZE
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|version
comma
id|strlen
c_func
(paren
id|version
)paren
op_mod
id|DUMMY_SKB_SIZE
)paren
suffix:semicolon
id|tx_fd-&gt;state
op_assign
id|FrameEnd
op_or
id|TO_STATE_TX
c_func
(paren
id|DUMMY_SKB_SIZE
)paren
suffix:semicolon
id|tx_fd-&gt;data
op_assign
id|pci_map_single
c_func
(paren
id|dpriv-&gt;pci_priv-&gt;pdev
comma
id|skb-&gt;data
comma
id|DUMMY_SKB_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dpriv-&gt;tx_skbuff
(braket
id|last
)braket
op_assign
id|skb
suffix:semicolon
)brace
r_return
id|skb
suffix:semicolon
)brace
DECL|function|dscc4_init_ring
r_static
r_int
id|dscc4_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|dpriv-&gt;pci_priv-&gt;pdev
suffix:semicolon
r_struct
id|TxFD
op_star
id|tx_fd
suffix:semicolon
r_struct
id|RxFD
op_star
id|rx_fd
suffix:semicolon
r_void
op_star
id|ring
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
op_amp
id|dpriv-&gt;rx_fd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ring
)paren
r_goto
id|err_out
suffix:semicolon
id|dpriv-&gt;rx_fd
op_assign
id|rx_fd
op_assign
(paren
r_struct
id|RxFD
op_star
)paren
id|ring
suffix:semicolon
id|ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
op_amp
id|dpriv-&gt;tx_fd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ring
)paren
r_goto
id|err_free_dma_rx
suffix:semicolon
id|dpriv-&gt;tx_fd
op_assign
id|tx_fd
op_assign
(paren
r_struct
id|TxFD
op_star
)paren
id|ring
suffix:semicolon
id|memset
c_func
(paren
id|dpriv-&gt;tx_skbuff
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sk_buff
op_star
)paren
op_star
id|TX_RING_SIZE
)paren
suffix:semicolon
id|dpriv-&gt;tx_dirty
op_assign
l_int|0xffffffff
suffix:semicolon
id|i
op_assign
id|dpriv-&gt;tx_current
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|tx_fd-&gt;state
op_assign
id|FrameEnd
op_or
id|TO_STATE_TX
c_func
(paren
l_int|2
op_star
id|DUMMY_SKB_SIZE
)paren
suffix:semicolon
id|tx_fd-&gt;complete
op_assign
l_int|0x00000000
suffix:semicolon
multiline_comment|/* FIXME: NULL should be ok - to be tried */
id|tx_fd-&gt;data
op_assign
id|dpriv-&gt;tx_fd_dma
suffix:semicolon
(paren
id|tx_fd
op_increment
)paren
op_member_access_from_pointer
id|next
op_assign
(paren
id|u32
)paren
(paren
id|dpriv-&gt;tx_fd_dma
op_plus
(paren
op_increment
id|i
op_mod
id|TX_RING_SIZE
)paren
op_star
r_sizeof
(paren
op_star
id|tx_fd
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|TX_RING_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dscc4_init_dummy_skb
c_func
(paren
id|dpriv
)paren
OL
l_int|0
)paren
r_goto
id|err_free_dma_tx
suffix:semicolon
id|memset
c_func
(paren
id|dpriv-&gt;rx_skbuff
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sk_buff
op_star
)paren
op_star
id|RX_RING_SIZE
)paren
suffix:semicolon
id|i
op_assign
id|dpriv-&gt;rx_dirty
op_assign
id|dpriv-&gt;rx_current
op_assign
l_int|0
suffix:semicolon
r_do
(brace
multiline_comment|/* size set by the host. Multiple of 4 bytes please */
id|rx_fd-&gt;state1
op_assign
id|HiDesc
suffix:semicolon
id|rx_fd-&gt;state2
op_assign
l_int|0x00000000
suffix:semicolon
id|rx_fd-&gt;end
op_assign
l_int|0xbabeface
suffix:semicolon
id|rx_fd-&gt;state1
op_or_assign
id|TO_STATE_RX
c_func
(paren
id|HDLC_MAX_MRU
)paren
suffix:semicolon
singleline_comment|// FIXME: return value verifiee mais traitement suspect
r_if
c_cond
(paren
id|try_get_rx_skb
c_func
(paren
id|dpriv
comma
id|dev
)paren
op_ge
l_int|0
)paren
id|dpriv-&gt;rx_dirty
op_increment
suffix:semicolon
(paren
id|rx_fd
op_increment
)paren
op_member_access_from_pointer
id|next
op_assign
(paren
id|u32
)paren
(paren
id|dpriv-&gt;rx_fd_dma
op_plus
(paren
op_increment
id|i
op_mod
id|RX_RING_SIZE
)paren
op_star
r_sizeof
(paren
op_star
id|rx_fd
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|RX_RING_SIZE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_free_dma_tx
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
id|ring
comma
id|dpriv-&gt;tx_fd_dma
)paren
suffix:semicolon
id|err_free_dma_rx
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
id|rx_fd
comma
id|dpriv-&gt;rx_fd_dma
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|dscc4_remove_one
r_static
r_void
id|__devexit
id|dscc4_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|dscc4_pci_priv
op_star
id|ppriv
suffix:semicolon
r_struct
id|dscc4_dev_priv
op_star
id|root
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ppriv
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|root
op_assign
id|ppriv-&gt;root
suffix:semicolon
id|ioaddr
op_assign
id|root-&gt;base_addr
suffix:semicolon
id|dscc4_pci_reset
c_func
(paren
id|pdev
comma
id|ioaddr
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|root
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|ppriv-&gt;iqcfg
comma
id|ppriv-&gt;iqcfg_dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_per_card
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|root
op_plus
id|i
suffix:semicolon
id|dscc4_release_ring
c_func
(paren
id|dpriv
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|dpriv-&gt;iqrx
comma
id|dpriv-&gt;iqrx_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|IRQ_RING_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|dpriv-&gt;iqtx
comma
id|dpriv-&gt;iqtx_dma
)paren
suffix:semicolon
)brace
id|dscc4_free1
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|dscc4_hdlc_attach
r_static
r_int
id|dscc4_hdlc_attach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|encoding
comma
r_int
r_int
id|parity
)paren
(brace
r_struct
id|dscc4_dev_priv
op_star
id|dpriv
op_assign
id|dscc4_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|encoding
op_ne
id|ENCODING_NRZ
op_logical_and
id|encoding
op_ne
id|ENCODING_NRZI
op_logical_and
id|encoding
op_ne
id|ENCODING_FM_MARK
op_logical_and
id|encoding
op_ne
id|ENCODING_FM_SPACE
op_logical_and
id|encoding
op_ne
id|ENCODING_MANCHESTER
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|parity
op_ne
id|PARITY_NONE
op_logical_and
id|parity
op_ne
id|PARITY_CRC16_PR0_CCITT
op_logical_and
id|parity
op_ne
id|PARITY_CRC16_PR1_CCITT
op_logical_and
id|parity
op_ne
id|PARITY_CRC32_PR0_CCITT
op_logical_and
id|parity
op_ne
id|PARITY_CRC32_PR1_CCITT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dpriv-&gt;encoding
op_assign
id|encoding
suffix:semicolon
id|dpriv-&gt;parity
op_assign
id|parity
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|dscc4_setup
r_static
r_int
id|__init
id|dscc4_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
op_star
id|args
(braket
)braket
op_assign
(brace
op_amp
id|debug
comma
op_amp
id|quartz
comma
l_int|NULL
)brace
comma
op_star
op_star
id|p
op_assign
id|args
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_logical_and
(paren
id|get_option
c_func
(paren
op_amp
id|str
comma
op_star
id|p
)paren
op_eq
l_int|2
)paren
)paren
id|p
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;dscc4.setup=&quot;
comma
id|dscc4_setup
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|dscc4_pci_tbl
r_static
r_struct
id|pci_device_id
id|dscc4_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_SIEMENS
comma
id|PCI_DEVICE_ID_SIEMENS_DSCC4
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|dscc4_pci_tbl
)paren
suffix:semicolon
DECL|variable|dscc4_driver
r_static
r_struct
id|pci_driver
id|dscc4_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|id_table
op_assign
id|dscc4_pci_tbl
comma
dot
id|probe
op_assign
id|dscc4_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|dscc4_remove_one
)paren
comma
)brace
suffix:semicolon
DECL|function|dscc4_init_module
r_static
r_int
id|__init
id|dscc4_init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|dscc4_driver
)paren
suffix:semicolon
)brace
DECL|function|dscc4_cleanup_module
r_static
r_void
id|__exit
id|dscc4_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|dscc4_driver
)paren
suffix:semicolon
)brace
DECL|variable|dscc4_init_module
id|module_init
c_func
(paren
id|dscc4_init_module
)paren
suffix:semicolon
DECL|variable|dscc4_cleanup_module
id|module_exit
c_func
(paren
id|dscc4_cleanup_module
)paren
suffix:semicolon
eof
