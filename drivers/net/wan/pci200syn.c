multiline_comment|/*&n; * Goramo PCI200SYN synchronous serial card driver for Linux&n; *&n; * Copyright (C) 2002-2003 Krzysztof Halasa &lt;khc@pm.waw.pl&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of version 2 of the GNU General Public License&n; * as published by the Free Software Foundation.&n; *&n; * For information see http://hq.pm.waw.pl/hdlc/&n; *&n; * Sources of information:&n; *    Hitachi HD64572 SCA-II User&squot;s Manual&n; *    PLX Technology Inc. PCI9052 Data Book&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;hd64572.h&quot;
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;Goramo PCI200SYN driver version: 1.16&quot;
suffix:semicolon
DECL|variable|devname
r_static
r_const
r_char
op_star
id|devname
op_assign
l_string|&quot;PCI200SYN&quot;
suffix:semicolon
DECL|macro|DEBUG_PKT
macro_line|#undef DEBUG_PKT
DECL|macro|DEBUG_RINGS
mdefine_line|#define DEBUG_RINGS
DECL|macro|PCI200SYN_PLX_SIZE
mdefine_line|#define PCI200SYN_PLX_SIZE&t;0x80&t;/* PLX control window size (128b) */
DECL|macro|PCI200SYN_SCA_SIZE
mdefine_line|#define PCI200SYN_SCA_SIZE&t;0x400&t;/* SCA window size (1Kb) */
DECL|macro|ALL_PAGES_ALWAYS_MAPPED
mdefine_line|#define ALL_PAGES_ALWAYS_MAPPED
DECL|macro|NEED_DETECT_RAM
mdefine_line|#define NEED_DETECT_RAM
DECL|macro|NEED_SCA_MSCI_INTR
mdefine_line|#define NEED_SCA_MSCI_INTR
DECL|macro|MAX_TX_BUFFERS
mdefine_line|#define MAX_TX_BUFFERS&t;&t;10
DECL|variable|pci_clock_freq
r_static
r_int
id|pci_clock_freq
op_assign
l_int|33000000
suffix:semicolon
DECL|macro|CLOCK_BASE
mdefine_line|#define CLOCK_BASE pci_clock_freq
DECL|macro|PCI_VENDOR_ID_GORAMO
mdefine_line|#define PCI_VENDOR_ID_GORAMO&t;0x10B5&t;/* uses PLX:9050 ID - this card&t;*/
DECL|macro|PCI_DEVICE_ID_PCI200SYN
mdefine_line|#define PCI_DEVICE_ID_PCI200SYN&t;0x9050&t;/* doesn&squot;t have its own ID&t;*/
multiline_comment|/*&n; *      PLX PCI9052 local configuration and shared runtime registers.&n; *      This structure can be used to access 9052 registers (memory mapped).&n; */
r_typedef
r_struct
(brace
DECL|member|loc_addr_range
id|u32
id|loc_addr_range
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* 00-0Ch : Local Address Ranges */
DECL|member|loc_rom_range
id|u32
id|loc_rom_range
suffix:semicolon
multiline_comment|/* 10h : Local ROM Range */
DECL|member|loc_addr_base
id|u32
id|loc_addr_base
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* 14-20h : Local Address Base Addrs */
DECL|member|loc_rom_base
id|u32
id|loc_rom_base
suffix:semicolon
multiline_comment|/* 24h : Local ROM Base */
DECL|member|loc_bus_descr
id|u32
id|loc_bus_descr
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* 28-34h : Local Bus Descriptors */
DECL|member|rom_bus_descr
id|u32
id|rom_bus_descr
suffix:semicolon
multiline_comment|/* 38h : ROM Bus Descriptor */
DECL|member|cs_base
id|u32
id|cs_base
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* 3C-48h : Chip Select Base Addrs */
DECL|member|intr_ctrl_stat
id|u32
id|intr_ctrl_stat
suffix:semicolon
multiline_comment|/* 4Ch : Interrupt Control/Status */
DECL|member|init_ctrl
id|u32
id|init_ctrl
suffix:semicolon
multiline_comment|/* 50h : EEPROM ctrl, Init Ctrl, etc */
DECL|typedef|plx9052
)brace
id|plx9052
suffix:semicolon
DECL|struct|port_s
r_typedef
r_struct
id|port_s
(brace
DECL|member|hdlc
id|hdlc_device
id|hdlc
suffix:semicolon
multiline_comment|/* HDLC device struct - must be first */
DECL|member|card
r_struct
id|card_s
op_star
id|card
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* TX lock */
DECL|member|settings
id|sync_serial_settings
id|settings
suffix:semicolon
DECL|member|rxpart
r_int
id|rxpart
suffix:semicolon
multiline_comment|/* partial frame received, next frame invalid*/
DECL|member|encoding
r_int
r_int
id|encoding
suffix:semicolon
DECL|member|parity
r_int
r_int
id|parity
suffix:semicolon
DECL|member|rxin
id|u16
id|rxin
suffix:semicolon
multiline_comment|/* rx ring buffer &squot;in&squot; pointer */
DECL|member|txin
id|u16
id|txin
suffix:semicolon
multiline_comment|/* tx ring buffer &squot;in&squot; and &squot;last&squot; pointers */
DECL|member|txlast
id|u16
id|txlast
suffix:semicolon
DECL|member|rxs
DECL|member|txs
DECL|member|tmc
id|u8
id|rxs
comma
id|txs
comma
id|tmc
suffix:semicolon
multiline_comment|/* SCA registers */
DECL|member|phy_node
id|u8
id|phy_node
suffix:semicolon
multiline_comment|/* physical port # - 0 or 1 */
DECL|typedef|port_t
)brace
id|port_t
suffix:semicolon
DECL|struct|card_s
r_typedef
r_struct
id|card_s
(brace
DECL|member|rambase
id|u8
op_star
id|rambase
suffix:semicolon
multiline_comment|/* buffer memory base (virtual) */
DECL|member|scabase
id|u8
op_star
id|scabase
suffix:semicolon
multiline_comment|/* SCA memory base (virtual) */
DECL|member|plxbase
id|plx9052
op_star
id|plxbase
suffix:semicolon
multiline_comment|/* PLX registers memory base (virtual) */
DECL|member|rx_ring_buffers
id|u16
id|rx_ring_buffers
suffix:semicolon
multiline_comment|/* number of buffers in a ring */
DECL|member|tx_ring_buffers
id|u16
id|tx_ring_buffers
suffix:semicolon
DECL|member|buff_offset
id|u16
id|buff_offset
suffix:semicolon
multiline_comment|/* offset of first buffer of first channel */
DECL|member|irq
id|u8
id|irq
suffix:semicolon
multiline_comment|/* interrupt request level */
DECL|member|ports
id|port_t
id|ports
(braket
l_int|2
)braket
suffix:semicolon
DECL|typedef|card_t
)brace
id|card_t
suffix:semicolon
DECL|macro|sca_in
mdefine_line|#define sca_in(reg, card)&t;     readb(card-&gt;scabase + (reg))
DECL|macro|sca_out
mdefine_line|#define sca_out(value, reg, card)    writeb(value, card-&gt;scabase + (reg))
DECL|macro|sca_inw
mdefine_line|#define sca_inw(reg, card)&t;     readw(card-&gt;scabase + (reg))
DECL|macro|sca_outw
mdefine_line|#define sca_outw(value, reg, card)   writew(value, card-&gt;scabase + (reg))
DECL|macro|sca_inl
mdefine_line|#define sca_inl(reg, card)&t;     readl(card-&gt;scabase + (reg))
DECL|macro|sca_outl
mdefine_line|#define sca_outl(value, reg, card)   writel(value, card-&gt;scabase + (reg))
DECL|macro|port_to_card
mdefine_line|#define port_to_card(port)&t;     (port-&gt;card)
DECL|macro|log_node
mdefine_line|#define log_node(port)&t;&t;     (port-&gt;phy_node)
DECL|macro|phy_node
mdefine_line|#define phy_node(port)&t;&t;     (port-&gt;phy_node)
DECL|macro|winbase
mdefine_line|#define winbase(card)&t;&t;     (card-&gt;rambase)
DECL|macro|get_port
mdefine_line|#define get_port(card, port)&t;     (&amp;card-&gt;ports[port])
DECL|macro|sca_flush
mdefine_line|#define sca_flush(card)&t;&t;     (sca_in(IER0, card));
DECL|function|new_memcpy_toio
r_static
r_inline
r_void
id|new_memcpy_toio
c_func
(paren
r_char
op_star
id|dest
comma
r_char
op_star
id|src
comma
r_int
id|length
)paren
(brace
r_int
id|len
suffix:semicolon
r_do
(brace
id|len
op_assign
id|length
OG
l_int|256
ques
c_cond
l_int|256
suffix:colon
id|length
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|dest
comma
id|src
comma
id|len
)paren
suffix:semicolon
id|dest
op_add_assign
id|len
suffix:semicolon
id|src
op_add_assign
id|len
suffix:semicolon
id|length
op_sub_assign
id|len
suffix:semicolon
id|readb
c_func
(paren
id|dest
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
)paren
suffix:semicolon
)brace
DECL|macro|memcpy_toio
macro_line|#undef memcpy_toio
DECL|macro|memcpy_toio
mdefine_line|#define memcpy_toio new_memcpy_toio
macro_line|#include &quot;hd6457x.c&quot;
DECL|function|pci200_set_iface
r_static
r_void
id|pci200_set_iface
c_func
(paren
id|port_t
op_star
id|port
)paren
(brace
id|card_t
op_star
id|card
op_assign
id|port-&gt;card
suffix:semicolon
id|u16
id|msci
op_assign
id|get_msci
c_func
(paren
id|port
)paren
suffix:semicolon
id|u8
id|rxs
op_assign
id|port-&gt;rxs
op_amp
id|CLK_BRG_MASK
suffix:semicolon
id|u8
id|txs
op_assign
id|port-&gt;txs
op_amp
id|CLK_BRG_MASK
suffix:semicolon
id|sca_out
c_func
(paren
id|EXS_TES1
comma
(paren
id|phy_node
c_func
(paren
id|port
)paren
ques
c_cond
id|MSCI1_OFFSET
suffix:colon
id|MSCI0_OFFSET
)paren
op_plus
id|EXS
comma
id|port_to_card
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;settings.clock_type
)paren
(brace
r_case
id|CLOCK_INT
suffix:colon
id|rxs
op_or_assign
id|CLK_BRG
suffix:semicolon
multiline_comment|/* BRG output */
id|txs
op_or_assign
id|CLK_PIN_OUT
op_or
id|CLK_TX_RXCLK
suffix:semicolon
multiline_comment|/* RX clock */
r_break
suffix:semicolon
r_case
id|CLOCK_TXINT
suffix:colon
id|rxs
op_or_assign
id|CLK_LINE
suffix:semicolon
multiline_comment|/* RXC input */
id|txs
op_or_assign
id|CLK_PIN_OUT
op_or
id|CLK_BRG
suffix:semicolon
multiline_comment|/* BRG output */
r_break
suffix:semicolon
r_case
id|CLOCK_TXFROMRX
suffix:colon
id|rxs
op_or_assign
id|CLK_LINE
suffix:semicolon
multiline_comment|/* RXC input */
id|txs
op_or_assign
id|CLK_PIN_OUT
op_or
id|CLK_TX_RXCLK
suffix:semicolon
multiline_comment|/* RX clock */
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* EXTernal clock */
id|rxs
op_or_assign
id|CLK_LINE
suffix:semicolon
multiline_comment|/* RXC input */
id|txs
op_or_assign
id|CLK_PIN_OUT
op_or
id|CLK_LINE
suffix:semicolon
multiline_comment|/* TXC input */
r_break
suffix:semicolon
)brace
id|port-&gt;rxs
op_assign
id|rxs
suffix:semicolon
id|port-&gt;txs
op_assign
id|txs
suffix:semicolon
id|sca_out
c_func
(paren
id|rxs
comma
id|msci
op_plus
id|RXS
comma
id|card
)paren
suffix:semicolon
id|sca_out
c_func
(paren
id|txs
comma
id|msci
op_plus
id|TXS
comma
id|card
)paren
suffix:semicolon
id|sca_set_port
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
DECL|function|pci200_open
r_static
r_int
id|pci200_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|hdlc_device
op_star
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|port_t
op_star
id|port
op_assign
id|hdlc_to_port
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_int
id|result
op_assign
id|hdlc_open
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sca_open
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|pci200_set_iface
c_func
(paren
id|port
)paren
suffix:semicolon
id|sca_flush
c_func
(paren
id|port_to_card
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci200_close
r_static
r_int
id|pci200_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|hdlc_device
op_star
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sca_close
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|sca_flush
c_func
(paren
id|port_to_card
c_func
(paren
id|dev_to_port
c_func
(paren
id|dev
)paren
)paren
)paren
suffix:semicolon
id|hdlc_close
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci200_ioctl
r_static
r_int
id|pci200_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_const
r_int
id|size
op_assign
r_sizeof
(paren
id|sync_serial_settings
)paren
suffix:semicolon
id|sync_serial_settings
id|new_line
comma
op_star
id|line
op_assign
id|ifr-&gt;ifr_settings.ifs_ifsu.sync
suffix:semicolon
id|hdlc_device
op_star
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|port_t
op_star
id|port
op_assign
id|hdlc_to_port
c_func
(paren
id|hdlc
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_RINGS
r_if
c_cond
(paren
id|cmd
op_eq
id|SIOCDEVPRIVATE
)paren
(brace
id|sca_dump_rings
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCWANDEV
)paren
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_GET_IFACE
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_V35
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
OL
id|size
)paren
(brace
id|ifr-&gt;ifr_settings.size
op_assign
id|size
suffix:semicolon
multiline_comment|/* data size wanted */
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|line
comma
op_amp
id|port-&gt;settings
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_IFACE_V35
suffix:colon
r_case
id|IF_IFACE_SYNC_SERIAL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|new_line
comma
id|line
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|new_line.clock_type
op_ne
id|CLOCK_EXT
op_logical_and
id|new_line.clock_type
op_ne
id|CLOCK_TXFROMRX
op_logical_and
id|new_line.clock_type
op_ne
id|CLOCK_INT
op_logical_and
id|new_line.clock_type
op_ne
id|CLOCK_TXINT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* No such clock setting */
r_if
c_cond
(paren
id|new_line.loopback
op_ne
l_int|0
op_logical_and
id|new_line.loopback
op_ne
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|port-&gt;settings
comma
op_amp
id|new_line
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Update settings */
id|pci200_set_iface
c_func
(paren
id|port
)paren
suffix:semicolon
id|sca_flush
c_func
(paren
id|port_to_card
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
DECL|function|pci200_pci_remove_one
r_static
r_void
id|pci200_pci_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_int
id|i
suffix:semicolon
id|card_t
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|card-&gt;ports
(braket
id|i
)braket
dot
id|card
)paren
id|unregister_hdlc_device
c_func
(paren
op_amp
id|card-&gt;ports
(braket
id|i
)braket
dot
id|hdlc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;irq
)paren
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rambase
)paren
id|iounmap
c_func
(paren
id|card-&gt;rambase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;scabase
)paren
id|iounmap
c_func
(paren
id|card-&gt;scabase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;plxbase
)paren
id|iounmap
c_func
(paren
id|card-&gt;plxbase
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
DECL|function|pci200_pci_init_one
r_static
r_int
id|__devinit
id|pci200_pci_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
id|u8
id|rev_id
suffix:semicolon
id|u32
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|ramsize
suffix:semicolon
id|u32
id|ramphys
suffix:semicolon
multiline_comment|/* buffer memory base */
id|u32
id|scaphys
suffix:semicolon
multiline_comment|/* SCA memory base */
id|u32
id|plxphys
suffix:semicolon
multiline_comment|/* PLX registers memory base */
macro_line|#ifndef MODULE
r_static
r_int
id|printed_version
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
macro_line|#endif
id|i
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;PCI200SYN&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|card_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pci200syn: unable to allocate memory&bslash;n&quot;
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
id|card_t
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|card
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|rev_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_ne
id|PCI200SYN_PLX_SIZE
op_logical_or
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|2
)paren
op_ne
id|PCI200SYN_SCA_SIZE
op_logical_or
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|3
)paren
OL
l_int|16384
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pci200syn: invalid card EEPROM parameters&bslash;n&quot;
)paren
suffix:semicolon
id|pci200_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|plxphys
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|card-&gt;plxbase
op_assign
id|ioremap
c_func
(paren
id|plxphys
comma
id|PCI200SYN_PLX_SIZE
)paren
suffix:semicolon
id|scaphys
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|card-&gt;scabase
op_assign
id|ioremap
c_func
(paren
id|scaphys
comma
id|PCI200SYN_SCA_SIZE
)paren
suffix:semicolon
id|ramphys
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|3
)paren
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|card-&gt;rambase
op_assign
id|ioremap
c_func
(paren
id|ramphys
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;plxbase
op_eq
l_int|NULL
op_logical_or
id|card-&gt;scabase
op_eq
l_int|NULL
op_logical_or
id|card-&gt;rambase
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pci200syn: ioremap() failed&bslash;n&quot;
)paren
suffix:semicolon
id|pci200_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset PLX */
id|p
op_assign
op_amp
id|card-&gt;plxbase-&gt;init_ctrl
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|p
)paren
op_or
l_int|0x40000000
comma
id|p
)paren
suffix:semicolon
id|readl
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* Flush the write - do not use sca_flush */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|p
)paren
op_amp
op_complement
l_int|0x40000000
comma
id|p
)paren
suffix:semicolon
id|readl
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* Flush the write - do not use sca_flush */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ramsize
op_assign
id|sca_detect_ram
c_func
(paren
id|card
comma
id|card-&gt;rambase
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|3
)paren
)paren
suffix:semicolon
multiline_comment|/* number of TX + RX buffers for one port - this is dual port card */
id|i
op_assign
id|ramsize
op_div
(paren
l_int|2
op_star
(paren
r_sizeof
(paren
id|pkt_desc
)paren
op_plus
id|HDLC_MAX_MRU
)paren
)paren
suffix:semicolon
id|card-&gt;tx_ring_buffers
op_assign
id|min
c_func
(paren
id|i
op_div
l_int|2
comma
id|MAX_TX_BUFFERS
)paren
suffix:semicolon
id|card-&gt;rx_ring_buffers
op_assign
id|i
op_minus
id|card-&gt;tx_ring_buffers
suffix:semicolon
id|card-&gt;buff_offset
op_assign
l_int|2
op_star
r_sizeof
(paren
id|pkt_desc
)paren
op_star
(paren
id|card-&gt;tx_ring_buffers
op_plus
id|card-&gt;rx_ring_buffers
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pci200syn: %u KB RAM at 0x%x, IRQ%u, using %u TX +&quot;
l_string|&quot; %u RX packets rings&bslash;n&quot;
comma
id|ramsize
op_div
l_int|1024
comma
id|ramphys
comma
id|pdev-&gt;irq
comma
id|card-&gt;tx_ring_buffers
comma
id|card-&gt;rx_ring_buffers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tx_ring_buffers
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pci200syn: RAM test failed&bslash;n&quot;
)paren
suffix:semicolon
id|pci200_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Enable interrupts on the PCI bridge */
id|p
op_assign
op_amp
id|card-&gt;plxbase-&gt;intr_ctrl_stat
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|p
)paren
op_or
l_int|0x0040
comma
id|p
)paren
suffix:semicolon
multiline_comment|/* Allocate IRQ */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|sca_intr
comma
id|SA_SHIRQ
comma
id|devname
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;pci200syn: could not allocate IRQ%d.&bslash;n&quot;
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|pci200_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|card-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|sca_init
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port_t
op_star
id|port
op_assign
op_amp
id|card-&gt;ports
(braket
id|i
)braket
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|hdlc_to_dev
c_func
(paren
op_amp
id|port-&gt;hdlc
)paren
suffix:semicolon
id|port-&gt;phy_node
op_assign
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|card-&gt;irq
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|ramphys
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|ramphys
op_plus
id|ramsize
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|50
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|pci200_ioctl
suffix:semicolon
id|dev-&gt;open
op_assign
id|pci200_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|pci200_close
suffix:semicolon
id|port-&gt;hdlc.attach
op_assign
id|sca_attach
suffix:semicolon
id|port-&gt;hdlc.xmit
op_assign
id|sca_xmit
suffix:semicolon
id|port-&gt;settings.clock_type
op_assign
id|CLOCK_EXT
suffix:semicolon
r_if
c_cond
(paren
id|register_hdlc_device
c_func
(paren
op_amp
id|port-&gt;hdlc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pci200syn: unable to register hdlc &quot;
l_string|&quot;device&bslash;n&quot;
)paren
suffix:semicolon
id|pci200_pci_remove_one
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|port-&gt;card
op_assign
id|card
suffix:semicolon
id|sca_init_sync_port
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Set up SCA memory */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCI200SYN node %d&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
op_amp
id|port-&gt;hdlc
)paren
comma
id|port-&gt;phy_node
)paren
suffix:semicolon
)brace
id|sca_flush
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|pci200_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_GORAMO
comma
id|PCI_DEVICE_ID_PCI200SYN
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|variable|pci200_pci_driver
r_static
r_struct
id|pci_driver
id|pci200_pci_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;PCI200SYN&quot;
comma
id|id_table
suffix:colon
id|pci200_pci_tbl
comma
id|probe
suffix:colon
id|pci200_pci_init_one
comma
id|remove
suffix:colon
id|pci200_pci_remove_one
comma
)brace
suffix:semicolon
DECL|function|pci200_init_module
r_static
r_int
id|__init
id|pci200_init_module
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pci_clock_freq
template_param
l_int|80000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pci200syn: Invalid PCI clock frequency&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|pci200_pci_driver
)paren
suffix:semicolon
)brace
DECL|function|pci200_cleanup_module
r_static
r_void
id|__exit
id|pci200_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|pci200_pci_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Krzysztof Halasa &lt;khc@pm.waw.pl&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Goramo PCI200SYN serial port driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL v2&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|pci200_pci_tbl
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|pci_clock_freq
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pci_clock_freq
comma
l_string|&quot;System PCI clock frequency in Hz&quot;
)paren
suffix:semicolon
DECL|variable|pci200_init_module
id|module_init
c_func
(paren
id|pci200_init_module
)paren
suffix:semicolon
DECL|variable|pci200_cleanup_module
id|module_exit
c_func
(paren
id|pci200_cleanup_module
)paren
suffix:semicolon
eof
