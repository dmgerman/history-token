multiline_comment|/*&n; * Generic HDLC support routines for Linux&n; * Frame Relay support&n; *&n; * Copyright (C) 1999 - 2003 Krzysztof Halasa &lt;khc@pm.waw.pl&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of version 2 of the GNU General Public License&n; * as published by the Free Software Foundation.&n; *&n;&n;            Theory of PVC state&n;&n; DCE mode:&n;&n; (exist,new) -&gt; 0,0 when &quot;PVC create&quot; or if &quot;link unreliable&quot;&n;         0,x -&gt; 1,1 if &quot;link reliable&quot; when sending FULL STATUS&n;         1,1 -&gt; 1,0 if received FULL STATUS ACK&n;&n; (active)    -&gt; 0 when &quot;ifconfig PVC down&quot; or &quot;link unreliable&quot; or &quot;PVC create&quot;&n;             -&gt; 1 when &quot;PVC up&quot; and (exist,new) = 1,0&n;&n; DTE mode:&n; (exist,new,active) = FULL STATUS if &quot;link reliable&quot;&n;&t;&t;    = 0, 0, 0 if &quot;link unreliable&quot;&n; No LMI:&n; active = open and &quot;link reliable&quot;&n; exist = new = not used&n;&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/pkt_sched.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/lapb.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
DECL|macro|DEBUG_PKT
macro_line|#undef DEBUG_PKT
DECL|macro|DEBUG_ECN
macro_line|#undef DEBUG_ECN
DECL|macro|DEBUG_LINK
macro_line|#undef DEBUG_LINK
DECL|macro|MAXLEN_LMISTAT
mdefine_line|#define MAXLEN_LMISTAT  20&t;/* max size of status enquiry frame */
DECL|macro|PVC_STATE_NEW
mdefine_line|#define PVC_STATE_NEW&t; 0x01
DECL|macro|PVC_STATE_ACTIVE
mdefine_line|#define PVC_STATE_ACTIVE 0x02
DECL|macro|PVC_STATE_FECN
mdefine_line|#define PVC_STATE_FECN&t; 0x08 /* FECN condition */
DECL|macro|PVC_STATE_BECN
mdefine_line|#define PVC_STATE_BECN&t; 0x10 /* BECN condition */
DECL|macro|FR_UI
mdefine_line|#define FR_UI&t;&t; 0x03
DECL|macro|FR_PAD
mdefine_line|#define FR_PAD&t;&t; 0x00
DECL|macro|NLPID_IP
mdefine_line|#define NLPID_IP&t; 0xCC
DECL|macro|NLPID_IPV6
mdefine_line|#define NLPID_IPV6&t; 0x8E
DECL|macro|NLPID_SNAP
mdefine_line|#define NLPID_SNAP&t; 0x80
DECL|macro|NLPID_PAD
mdefine_line|#define NLPID_PAD&t; 0x00
DECL|macro|NLPID_Q933
mdefine_line|#define NLPID_Q933&t; 0x08
DECL|macro|LMI_DLCI
mdefine_line|#define LMI_DLCI                   0 /* LMI DLCI */
DECL|macro|LMI_PROTO
mdefine_line|#define LMI_PROTO               0x08
DECL|macro|LMI_CALLREF
mdefine_line|#define LMI_CALLREF             0x00 /* Call Reference */
DECL|macro|LMI_ANSI_LOCKSHIFT
mdefine_line|#define LMI_ANSI_LOCKSHIFT      0x95 /* ANSI lockshift */
DECL|macro|LMI_REPTYPE
mdefine_line|#define LMI_REPTYPE                1 /* report type */
DECL|macro|LMI_CCITT_REPTYPE
mdefine_line|#define LMI_CCITT_REPTYPE       0x51
DECL|macro|LMI_ALIVE
mdefine_line|#define LMI_ALIVE                  3 /* keep alive */
DECL|macro|LMI_CCITT_ALIVE
mdefine_line|#define LMI_CCITT_ALIVE         0x53
DECL|macro|LMI_PVCSTAT
mdefine_line|#define LMI_PVCSTAT                7 /* pvc status */
DECL|macro|LMI_CCITT_PVCSTAT
mdefine_line|#define LMI_CCITT_PVCSTAT       0x57
DECL|macro|LMI_FULLREP
mdefine_line|#define LMI_FULLREP                0 /* full report  */
DECL|macro|LMI_INTEGRITY
mdefine_line|#define LMI_INTEGRITY              1 /* link integrity report */
DECL|macro|LMI_SINGLE
mdefine_line|#define LMI_SINGLE                 2 /* single pvc report */
DECL|macro|LMI_STATUS_ENQUIRY
mdefine_line|#define LMI_STATUS_ENQUIRY      0x75
DECL|macro|LMI_STATUS
mdefine_line|#define LMI_STATUS              0x7D /* reply */
DECL|macro|LMI_REPT_LEN
mdefine_line|#define LMI_REPT_LEN               1 /* report type element length */
DECL|macro|LMI_INTEG_LEN
mdefine_line|#define LMI_INTEG_LEN              2 /* link integrity element length */
DECL|macro|LMI_LENGTH
mdefine_line|#define LMI_LENGTH                13 /* standard LMI frame length */
DECL|macro|LMI_ANSI_LENGTH
mdefine_line|#define LMI_ANSI_LENGTH           14
r_typedef
r_struct
(brace
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|ea1
r_int
id|ea1
suffix:colon
l_int|1
suffix:semicolon
DECL|member|cr
r_int
id|cr
suffix:colon
l_int|1
suffix:semicolon
DECL|member|dlcih
r_int
id|dlcih
suffix:colon
l_int|6
suffix:semicolon
DECL|member|ea2
r_int
id|ea2
suffix:colon
l_int|1
suffix:semicolon
DECL|member|de
r_int
id|de
suffix:colon
l_int|1
suffix:semicolon
DECL|member|becn
r_int
id|becn
suffix:colon
l_int|1
suffix:semicolon
DECL|member|fecn
r_int
id|fecn
suffix:colon
l_int|1
suffix:semicolon
DECL|member|dlcil
r_int
id|dlcil
suffix:colon
l_int|4
suffix:semicolon
macro_line|#else
r_int
id|dlcih
suffix:colon
l_int|6
suffix:semicolon
r_int
id|cr
suffix:colon
l_int|1
suffix:semicolon
r_int
id|ea1
suffix:colon
l_int|1
suffix:semicolon
r_int
id|dlcil
suffix:colon
l_int|4
suffix:semicolon
r_int
id|fecn
suffix:colon
l_int|1
suffix:semicolon
r_int
id|becn
suffix:colon
l_int|1
suffix:semicolon
r_int
id|de
suffix:colon
l_int|1
suffix:semicolon
r_int
id|ea2
suffix:colon
l_int|1
suffix:semicolon
macro_line|#endif
DECL|typedef|fr_hdr
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
id|fr_hdr
suffix:semicolon
DECL|function|q922_to_dlci
r_static
r_inline
id|u16
id|q922_to_dlci
c_func
(paren
id|u8
op_star
id|hdr
)paren
(brace
r_return
(paren
(paren
id|hdr
(braket
l_int|0
)braket
op_amp
l_int|0xFC
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|hdr
(braket
l_int|1
)braket
op_amp
l_int|0xF0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|dlci_to_q922
r_static
r_inline
r_void
id|dlci_to_q922
c_func
(paren
id|u8
op_star
id|hdr
comma
id|u16
id|dlci
)paren
(brace
id|hdr
(braket
l_int|0
)braket
op_assign
(paren
id|dlci
op_rshift
l_int|2
)paren
op_amp
l_int|0xFC
suffix:semicolon
id|hdr
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|dlci
op_lshift
l_int|4
)paren
op_amp
l_int|0xF0
)paren
op_or
l_int|0x01
suffix:semicolon
)brace
DECL|function|find_pvc
r_static
r_inline
id|pvc_device
op_star
id|find_pvc
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
id|u16
id|dlci
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
r_if
c_cond
(paren
id|pvc-&gt;dlci
op_eq
id|dlci
)paren
r_return
id|pvc
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;dlci
OG
id|dlci
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* the listed is sorted */
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|add_pvc
r_static
r_inline
id|pvc_device
op_star
id|add_pvc
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
id|u16
id|dlci
)paren
(brace
id|pvc_device
op_star
id|pvc
comma
op_star
op_star
id|pvc_p
op_assign
op_amp
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pvc_p
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pvc_p
)paren
op_member_access_from_pointer
id|dlci
op_eq
id|dlci
)paren
r_return
op_star
id|pvc_p
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|pvc_p
)paren
op_member_access_from_pointer
id|dlci
OG
id|dlci
)paren
r_break
suffix:semicolon
multiline_comment|/* the list is sorted */
id|pvc_p
op_assign
op_amp
(paren
op_star
id|pvc_p
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
id|pvc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|pvc_device
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pvc
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|pvc
comma
l_int|0
comma
r_sizeof
(paren
id|pvc_device
)paren
)paren
suffix:semicolon
id|pvc-&gt;dlci
op_assign
id|dlci
suffix:semicolon
id|pvc-&gt;master
op_assign
id|hdlc
suffix:semicolon
id|pvc-&gt;next
op_assign
op_star
id|pvc_p
suffix:semicolon
multiline_comment|/* Put it in the chain */
op_star
id|pvc_p
op_assign
id|pvc
suffix:semicolon
r_return
id|pvc
suffix:semicolon
)brace
DECL|function|pvc_is_used
r_static
r_inline
r_int
id|pvc_is_used
c_func
(paren
id|pvc_device
op_star
id|pvc
)paren
(brace
r_return
id|pvc-&gt;main
op_ne
l_int|NULL
op_logical_or
id|pvc-&gt;ether
op_ne
l_int|NULL
suffix:semicolon
)brace
DECL|function|pvc_carrier
r_static
r_inline
r_void
id|pvc_carrier
c_func
(paren
r_int
id|on
comma
id|pvc_device
op_star
id|pvc
)paren
(brace
r_if
c_cond
(paren
id|on
)paren
(brace
r_if
c_cond
(paren
id|pvc-&gt;main
)paren
r_if
c_cond
(paren
op_logical_neg
id|netif_carrier_ok
c_func
(paren
id|pvc-&gt;main
)paren
)paren
id|netif_carrier_on
c_func
(paren
id|pvc-&gt;main
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;ether
)paren
r_if
c_cond
(paren
op_logical_neg
id|netif_carrier_ok
c_func
(paren
id|pvc-&gt;ether
)paren
)paren
id|netif_carrier_on
c_func
(paren
id|pvc-&gt;ether
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pvc-&gt;main
)paren
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|pvc-&gt;main
)paren
)paren
id|netif_carrier_off
c_func
(paren
id|pvc-&gt;main
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;ether
)paren
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|pvc-&gt;ether
)paren
)paren
id|netif_carrier_off
c_func
(paren
id|pvc-&gt;ether
)paren
suffix:semicolon
)brace
)brace
DECL|function|delete_unused_pvcs
r_static
r_inline
r_void
id|delete_unused_pvcs
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|pvc_device
op_star
op_star
id|pvc_p
op_assign
op_amp
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pvc_p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pvc_is_used
c_func
(paren
op_star
id|pvc_p
)paren
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
op_star
id|pvc_p
suffix:semicolon
op_star
id|pvc_p
op_assign
id|pvc-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|pvc
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pvc_p
op_assign
op_amp
(paren
op_star
id|pvc_p
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
DECL|function|get_dev_p
r_static
r_inline
r_struct
id|net_device
op_star
op_star
id|get_dev_p
c_func
(paren
id|pvc_device
op_star
id|pvc
comma
r_int
id|type
)paren
(brace
r_if
c_cond
(paren
id|type
op_eq
id|ARPHRD_ETHER
)paren
r_return
op_amp
id|pvc-&gt;ether
suffix:semicolon
r_else
r_return
op_amp
id|pvc-&gt;main
suffix:semicolon
)brace
DECL|function|status_to_dlci
r_static
r_inline
id|u16
id|status_to_dlci
c_func
(paren
id|u8
op_star
id|status
comma
r_int
op_star
id|active
comma
r_int
op_star
r_new
)paren
(brace
op_star
r_new
op_assign
(paren
id|status
(braket
l_int|2
)braket
op_amp
l_int|0x08
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
op_star
id|active
op_assign
(paren
id|status
(braket
l_int|2
)braket
op_amp
l_int|0x02
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_return
(paren
(paren
id|status
(braket
l_int|0
)braket
op_amp
l_int|0x3F
)paren
op_lshift
l_int|4
)paren
op_or
(paren
(paren
id|status
(braket
l_int|1
)braket
op_amp
l_int|0x78
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
)brace
DECL|function|dlci_to_status
r_static
r_inline
r_void
id|dlci_to_status
c_func
(paren
id|u16
id|dlci
comma
id|u8
op_star
id|status
comma
r_int
id|active
comma
r_int
r_new
)paren
(brace
id|status
(braket
l_int|0
)braket
op_assign
(paren
id|dlci
op_rshift
l_int|4
)paren
op_amp
l_int|0x3F
suffix:semicolon
id|status
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|dlci
op_lshift
l_int|3
)paren
op_amp
l_int|0x78
)paren
op_or
l_int|0x80
suffix:semicolon
id|status
(braket
l_int|2
)braket
op_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
r_new
)paren
id|status
(braket
l_int|2
)braket
op_or_assign
l_int|0x08
suffix:semicolon
r_else
r_if
c_cond
(paren
id|active
)paren
id|status
(braket
l_int|2
)braket
op_or_assign
l_int|0x02
suffix:semicolon
)brace
DECL|function|fr_hard_header
r_static
r_int
id|fr_hard_header
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
id|u16
id|dlci
)paren
(brace
id|u16
id|head_len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_switch
c_cond
(paren
id|skb-&gt;protocol
)paren
(brace
r_case
id|__constant_ntohs
c_func
(paren
id|ETH_P_IP
)paren
suffix:colon
id|head_len
op_assign
l_int|4
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|NLPID_IP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|__constant_ntohs
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:colon
id|head_len
op_assign
l_int|4
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|NLPID_IPV6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|__constant_ntohs
c_func
(paren
id|LMI_PROTO
)paren
suffix:colon
id|head_len
op_assign
l_int|4
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|LMI_PROTO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|__constant_ntohs
c_func
(paren
id|ETH_P_802_3
)paren
suffix:colon
id|head_len
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|head_len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb2
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
op_star
id|skb_p
op_assign
id|skb2
suffix:semicolon
)brace
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|4
)braket
op_assign
id|NLPID_SNAP
suffix:semicolon
id|skb-&gt;data
(braket
l_int|5
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|6
)braket
op_assign
l_int|0x80
suffix:semicolon
id|skb-&gt;data
(braket
l_int|7
)braket
op_assign
l_int|0xC2
suffix:semicolon
id|skb-&gt;data
(braket
l_int|8
)braket
op_assign
l_int|0x00
suffix:semicolon
id|skb-&gt;data
(braket
l_int|9
)braket
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* bridged Ethernet frame w/out FCS */
r_break
suffix:semicolon
r_default
suffix:colon
id|head_len
op_assign
l_int|10
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|4
)braket
op_assign
id|NLPID_SNAP
suffix:semicolon
id|skb-&gt;data
(braket
l_int|5
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|6
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|7
)braket
op_assign
id|FR_PAD
suffix:semicolon
op_star
(paren
id|u16
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|8
)paren
op_assign
id|skb-&gt;protocol
suffix:semicolon
)brace
id|dlci_to_q922
c_func
(paren
id|skb-&gt;data
comma
id|dlci
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|2
)braket
op_assign
id|FR_UI
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvc_open
r_static
r_int
id|pvc_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|dev_to_pvc
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hdlc_to_dev
c_func
(paren
id|pvc-&gt;master
)paren
op_member_access_from_pointer
id|flags
op_amp
id|IFF_UP
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Master must be UP in order to activate PVC */
r_if
c_cond
(paren
id|pvc-&gt;open_count
op_increment
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pvc-&gt;master-&gt;state.fr.settings.lmi
op_eq
id|LMI_NONE
)paren
id|pvc-&gt;state.active
op_assign
id|pvc-&gt;master-&gt;carrier
suffix:semicolon
id|pvc_carrier
c_func
(paren
id|pvc-&gt;state.active
comma
id|pvc
)paren
suffix:semicolon
id|pvc-&gt;master-&gt;state.fr.dce_changed
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvc_close
r_static
r_int
id|pvc_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|dev_to_pvc
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|pvc-&gt;open_count
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pvc-&gt;master-&gt;state.fr.settings.lmi
op_eq
id|LMI_NONE
)paren
id|pvc-&gt;state.active
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;master-&gt;state.fr.settings.dce
)paren
(brace
id|pvc-&gt;master-&gt;state.fr.dce_changed
op_assign
l_int|1
suffix:semicolon
id|pvc-&gt;state.active
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvc_ioctl
r_int
id|pvc_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|dev_to_pvc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fr_proto_pvc_info
id|info
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.type
op_eq
id|IF_GET_PROTO
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;type
op_eq
id|ARPHRD_ETHER
)paren
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_PROTO_FR_ETH_PVC
suffix:semicolon
r_else
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_PROTO_FR_PVC
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
OL
r_sizeof
(paren
id|info
)paren
)paren
(brace
multiline_comment|/* data size wanted */
id|ifr-&gt;ifr_settings.size
op_assign
r_sizeof
(paren
id|info
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|info.dlci
op_assign
id|pvc-&gt;dlci
suffix:semicolon
id|memcpy
c_func
(paren
id|info.master
comma
id|hdlc_to_name
c_func
(paren
id|pvc-&gt;master
)paren
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_settings.ifs_ifsu.fr_pvc_info
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pvc_get_stats
r_static
r_inline
r_struct
id|net_device_stats
op_star
id|pvc_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
(paren
r_struct
id|net_device_stats
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|dev
op_plus
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
)brace
DECL|function|pvc_xmit
r_static
r_int
id|pvc_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|dev_to_pvc
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|pvc_get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;state.active
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;type
op_eq
id|ARPHRD_ETHER
)paren
(brace
r_int
id|pad
op_assign
id|ETH_ZLEN
op_minus
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|pad
OG
l_int|0
)paren
(brace
multiline_comment|/* Pad the frame with zeros */
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
OL
id|pad
)paren
r_if
c_cond
(paren
id|pskb_expand_head
c_func
(paren
id|skb
comma
l_int|0
comma
id|pad
comma
id|GFP_ATOMIC
)paren
)paren
(brace
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|pad
)paren
suffix:semicolon
id|memset
c_func
(paren
id|skb-&gt;data
op_plus
id|len
comma
l_int|0
comma
id|pad
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|fr_hard_header
c_func
(paren
op_amp
id|skb
comma
id|pvc-&gt;dlci
)paren
)paren
(brace
id|stats-&gt;tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;state.fecn
)paren
multiline_comment|/* TX Congestion counter */
id|stats-&gt;tx_compressed
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|hdlc_to_dev
c_func
(paren
id|pvc-&gt;master
)paren
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvc_change_mtu
r_static
r_int
id|pvc_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|68
)paren
op_logical_or
(paren
id|new_mtu
OG
id|HDLC_MAX_MTU
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fr_log_dlci_active
r_static
r_inline
r_void
id|fr_log_dlci_active
c_func
(paren
id|pvc_device
op_star
id|pvc
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI %d [%s%s%s]%s %s&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|pvc-&gt;master
)paren
comma
id|pvc-&gt;dlci
comma
id|pvc-&gt;main
ques
c_cond
id|pvc-&gt;main-&gt;name
suffix:colon
l_string|&quot;&quot;
comma
id|pvc-&gt;main
op_logical_and
id|pvc-&gt;ether
ques
c_cond
l_string|&quot; &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|pvc-&gt;ether
ques
c_cond
id|pvc-&gt;ether-&gt;name
suffix:colon
l_string|&quot;&quot;
comma
id|pvc-&gt;state
dot
r_new
ques
c_cond
l_string|&quot; new&quot;
suffix:colon
l_string|&quot;&quot;
comma
op_logical_neg
id|pvc-&gt;state.exist
ques
c_cond
l_string|&quot;deleted&quot;
suffix:colon
id|pvc-&gt;state.active
ques
c_cond
l_string|&quot;active&quot;
suffix:colon
l_string|&quot;inactive&quot;
)paren
suffix:semicolon
)brace
DECL|function|fr_lmi_nextseq
r_static
r_inline
id|u8
id|fr_lmi_nextseq
c_func
(paren
id|u8
id|x
)paren
(brace
id|x
op_increment
suffix:semicolon
r_return
id|x
ques
c_cond
id|x
suffix:colon
l_int|1
suffix:semicolon
)brace
DECL|function|fr_lmi_send
r_static
r_void
id|fr_lmi_send
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_int
id|fullrep
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_int
id|len
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_ANSI
)paren
ques
c_cond
id|LMI_ANSI_LENGTH
suffix:colon
id|LMI_LENGTH
suffix:semicolon
r_int
id|stat_len
op_assign
l_int|3
suffix:semicolon
id|u8
op_star
id|data
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
op_logical_and
id|fullrep
)paren
(brace
id|len
op_add_assign
id|hdlc-&gt;state.fr.dce_pvc_count
op_star
(paren
l_int|2
op_plus
id|stat_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|HDLC_MAX_MRU
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too many PVCs while sending &quot;
l_string|&quot;LMI full report&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze on fr_lmi_send()&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|skb-&gt;data
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|LMI_PROTO
)paren
suffix:semicolon
id|fr_hard_header
c_func
(paren
op_amp
id|skb
comma
id|LMI_DLCI
)paren
suffix:semicolon
id|data
op_assign
id|skb-&gt;tail
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|LMI_CALLREF
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|hdlc-&gt;state.fr.settings.dce
ques
c_cond
id|LMI_STATUS
suffix:colon
id|LMI_STATUS_ENQUIRY
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_ANSI
)paren
id|data
(braket
id|i
op_increment
)braket
op_assign
id|LMI_ANSI_LOCKSHIFT
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_REPTYPE
suffix:colon
id|LMI_REPTYPE
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|LMI_REPT_LEN
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|fullrep
ques
c_cond
id|LMI_FULLREP
suffix:colon
id|LMI_INTEGRITY
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_ALIVE
suffix:colon
id|LMI_ALIVE
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|LMI_INTEG_LEN
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|hdlc-&gt;state.fr.txseq
op_assign
id|fr_lmi_nextseq
c_func
(paren
id|hdlc-&gt;state.fr.txseq
)paren
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|hdlc-&gt;state.fr.rxseq
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
op_logical_and
id|fullrep
)paren
(brace
r_while
c_loop
(paren
id|pvc
)paren
(brace
id|data
(braket
id|i
op_increment
)braket
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_PVCSTAT
suffix:colon
id|LMI_PVCSTAT
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|stat_len
suffix:semicolon
multiline_comment|/* LMI start/restart */
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.reliable
op_logical_and
op_logical_neg
id|pvc-&gt;state.exist
)paren
(brace
id|pvc-&gt;state.exist
op_assign
id|pvc-&gt;state
dot
r_new
op_assign
l_int|1
suffix:semicolon
id|fr_log_dlci_active
c_func
(paren
id|pvc
)paren
suffix:semicolon
)brace
multiline_comment|/* ifconfig PVC up */
r_if
c_cond
(paren
id|pvc-&gt;open_count
op_logical_and
op_logical_neg
id|pvc-&gt;state.active
op_logical_and
id|pvc-&gt;state.exist
op_logical_and
op_logical_neg
id|pvc-&gt;state
dot
r_new
)paren
(brace
id|pvc_carrier
c_func
(paren
l_int|1
comma
id|pvc
)paren
suffix:semicolon
id|pvc-&gt;state.active
op_assign
l_int|1
suffix:semicolon
id|fr_log_dlci_active
c_func
(paren
id|pvc
)paren
suffix:semicolon
)brace
id|dlci_to_status
c_func
(paren
id|pvc-&gt;dlci
comma
id|data
op_plus
id|i
comma
id|pvc-&gt;state.active
comma
id|pvc-&gt;state
dot
r_new
)paren
suffix:semicolon
id|i
op_add_assign
id|stat_len
suffix:semicolon
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|i
)paren
suffix:semicolon
id|skb-&gt;priority
op_assign
id|TC_PRIO_CONTROL
suffix:semicolon
id|skb-&gt;dev
op_assign
id|hdlc_to_dev
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|fr_set_link_state
r_static
r_void
id|fr_set_link_state
c_func
(paren
r_int
id|reliable
comma
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
id|hdlc-&gt;state.fr.reliable
op_assign
id|reliable
suffix:semicolon
r_if
c_cond
(paren
id|reliable
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|netif_carrier_ok
c_func
(paren
op_amp
id|hdlc-&gt;netdev
)paren
)paren
id|netif_carrier_on
c_func
(paren
op_amp
id|hdlc-&gt;netdev
)paren
suffix:semicolon
id|hdlc-&gt;state.fr.n391cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Request full status */
id|hdlc-&gt;state.fr.dce_changed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_NONE
)paren
(brace
r_while
c_loop
(paren
id|pvc
)paren
(brace
multiline_comment|/* Activate all PVCs */
id|pvc_carrier
c_func
(paren
l_int|1
comma
id|pvc
)paren
suffix:semicolon
id|pvc-&gt;state.exist
op_assign
id|pvc-&gt;state.active
op_assign
l_int|1
suffix:semicolon
id|pvc-&gt;state
dot
r_new
op_assign
l_int|0
suffix:semicolon
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
op_amp
id|hdlc-&gt;netdev
)paren
)paren
id|netif_carrier_off
c_func
(paren
op_amp
id|hdlc-&gt;netdev
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
multiline_comment|/* Deactivate all PVCs */
id|pvc_carrier
c_func
(paren
l_int|0
comma
id|pvc
)paren
suffix:semicolon
id|pvc-&gt;state.exist
op_assign
id|pvc-&gt;state.active
op_assign
l_int|0
suffix:semicolon
id|pvc-&gt;state
dot
r_new
op_assign
l_int|0
suffix:semicolon
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
)brace
DECL|function|fr_timer
r_static
r_void
id|fr_timer
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|hdlc_device
op_star
id|hdlc
op_assign
(paren
id|hdlc_device
op_star
)paren
id|arg
suffix:semicolon
r_int
id|i
comma
id|cnt
op_assign
l_int|0
comma
id|reliable
suffix:semicolon
id|u32
id|list
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
)paren
id|reliable
op_assign
(paren
id|jiffies
op_minus
id|hdlc-&gt;state.fr.last_poll
OL
id|hdlc-&gt;state.fr.settings.t392
op_star
id|HZ
)paren
suffix:semicolon
r_else
(brace
id|hdlc-&gt;state.fr.last_errors
op_lshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* Shift the list */
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.request
)paren
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.reliable
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No LMI status reply &quot;
l_string|&quot;received&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
id|hdlc-&gt;state.fr.last_errors
op_or_assign
l_int|1
suffix:semicolon
)brace
id|list
op_assign
id|hdlc-&gt;state.fr.last_errors
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hdlc-&gt;state.fr.settings.n393
suffix:semicolon
id|i
op_increment
comma
id|list
op_rshift_assign
l_int|1
)paren
id|cnt
op_add_assign
(paren
id|list
op_amp
l_int|1
)paren
suffix:semicolon
multiline_comment|/* errors count */
id|reliable
op_assign
(paren
id|cnt
OL
id|hdlc-&gt;state.fr.settings.n392
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.reliable
op_ne
id|reliable
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link %sreliable&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|reliable
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;un&quot;
)paren
suffix:semicolon
id|fr_set_link_state
c_func
(paren
id|reliable
comma
id|hdlc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
)paren
id|hdlc-&gt;state.fr.timer.expires
op_assign
id|jiffies
op_plus
id|hdlc-&gt;state.fr.settings.t392
op_star
id|HZ
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.n391cnt
)paren
id|hdlc-&gt;state.fr.n391cnt
op_decrement
suffix:semicolon
id|fr_lmi_send
c_func
(paren
id|hdlc
comma
id|hdlc-&gt;state.fr.n391cnt
op_eq
l_int|0
)paren
suffix:semicolon
id|hdlc-&gt;state.fr.request
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.timer.expires
op_assign
id|jiffies
op_plus
id|hdlc-&gt;state.fr.settings.t391
op_star
id|HZ
suffix:semicolon
)brace
id|hdlc-&gt;state.fr.timer.function
op_assign
id|fr_timer
suffix:semicolon
id|hdlc-&gt;state.fr.timer.data
op_assign
id|arg
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.timer
)paren
suffix:semicolon
)brace
DECL|function|fr_lmi_recv
r_static
r_int
id|fr_lmi_recv
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|stat_len
suffix:semicolon
id|pvc_device
op_star
id|pvc
suffix:semicolon
r_int
id|reptype
op_assign
op_minus
l_int|1
comma
id|error
comma
id|no_ram
suffix:semicolon
id|u8
id|rxseq
comma
id|txseq
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
(paren
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_ANSI
)paren
ques
c_cond
id|LMI_ANSI_LENGTH
suffix:colon
id|LMI_LENGTH
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Short LMI frame&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|5
)braket
op_ne
(paren
op_logical_neg
id|hdlc-&gt;state.fr.settings.dce
ques
c_cond
id|LMI_STATUS
suffix:colon
id|LMI_STATUS_ENQUIRY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: LMI msgtype=%x, Not LMI status %s&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
l_int|2
)braket
comma
id|hdlc-&gt;state.fr.settings.dce
ques
c_cond
l_string|&quot;enquiry&quot;
suffix:colon
l_string|&quot;reply&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_ANSI
)paren
ques
c_cond
l_int|7
suffix:colon
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_ne
(paren
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_REPTYPE
suffix:colon
id|LMI_REPTYPE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Not a report type=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
multiline_comment|/* Skip length field */
id|reptype
op_assign
id|skb-&gt;data
(braket
id|i
op_increment
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_ne
(paren
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_ALIVE
suffix:colon
id|LMI_ALIVE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported status element=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
multiline_comment|/* Skip length field */
id|hdlc-&gt;state.fr.rxseq
op_assign
id|skb-&gt;data
(braket
id|i
op_increment
)braket
suffix:semicolon
multiline_comment|/* TX sequence from peer */
id|rxseq
op_assign
id|skb-&gt;data
(braket
id|i
op_increment
)braket
suffix:semicolon
multiline_comment|/* Should confirm our sequence */
id|txseq
op_assign
id|hdlc-&gt;state.fr.txseq
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
)paren
(brace
r_if
c_cond
(paren
id|reptype
op_ne
id|LMI_FULLREP
op_logical_and
id|reptype
op_ne
id|LMI_INTEGRITY
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported report type=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|reptype
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdlc-&gt;state.fr.reliable
)paren
id|error
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rxseq
op_eq
l_int|0
op_logical_or
id|rxseq
op_ne
id|txseq
)paren
(brace
id|hdlc-&gt;state.fr.n391cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ask for full report next time */
id|error
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
)paren
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.fullrep_sent
op_logical_and
op_logical_neg
id|error
)paren
(brace
multiline_comment|/* Stop sending full report - the last one has been confirmed by DTE */
id|hdlc-&gt;state.fr.fullrep_sent
op_assign
l_int|0
suffix:semicolon
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
r_if
c_cond
(paren
id|pvc-&gt;state
dot
r_new
)paren
(brace
id|pvc-&gt;state
dot
r_new
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Tell DTE that new PVC is now active */
id|hdlc-&gt;state.fr.dce_changed
op_assign
l_int|1
suffix:semicolon
)brace
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.dce_changed
)paren
(brace
id|reptype
op_assign
id|LMI_FULLREP
suffix:semicolon
id|hdlc-&gt;state.fr.fullrep_sent
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.dce_changed
op_assign
l_int|0
suffix:semicolon
)brace
id|fr_lmi_send
c_func
(paren
id|hdlc
comma
id|reptype
op_eq
id|LMI_FULLREP
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* DTE */
r_if
c_cond
(paren
id|reptype
op_ne
id|LMI_FULLREP
op_logical_or
id|error
)paren
r_return
l_int|0
suffix:semicolon
id|stat_len
op_assign
l_int|3
suffix:semicolon
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
id|pvc-&gt;state.deleted
op_assign
l_int|1
suffix:semicolon
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
id|no_ram
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|skb-&gt;len
op_ge
id|i
op_plus
l_int|2
op_plus
id|stat_len
)paren
(brace
id|u16
id|dlci
suffix:semicolon
r_int
r_int
id|active
comma
r_new
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_ne
(paren
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_PVCSTAT
suffix:colon
id|LMI_PVCSTAT
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Invalid PVCSTAT ID: %x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_ne
id|stat_len
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Invalid PVCSTAT length: %x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
id|dlci
op_assign
id|status_to_dlci
c_func
(paren
id|skb-&gt;data
op_plus
id|i
comma
op_amp
id|active
comma
op_amp
r_new
)paren
suffix:semicolon
id|pvc
op_assign
id|add_pvc
c_func
(paren
id|hdlc
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pvc
op_logical_and
op_logical_neg
id|no_ram
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze on fr_lmi_recv()&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
id|no_ram
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pvc
)paren
(brace
id|pvc-&gt;state.exist
op_assign
l_int|1
suffix:semicolon
id|pvc-&gt;state.deleted
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|active
op_ne
id|pvc-&gt;state.active
op_logical_or
r_new
op_ne
id|pvc-&gt;state
dot
r_new
op_logical_or
op_logical_neg
id|pvc-&gt;state.exist
)paren
(brace
id|pvc-&gt;state
dot
r_new
op_assign
r_new
suffix:semicolon
id|pvc-&gt;state.active
op_assign
id|active
suffix:semicolon
id|pvc_carrier
c_func
(paren
id|active
comma
id|pvc
)paren
suffix:semicolon
id|fr_log_dlci_active
c_func
(paren
id|pvc
)paren
suffix:semicolon
)brace
)brace
id|i
op_add_assign
id|stat_len
suffix:semicolon
)brace
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
r_if
c_cond
(paren
id|pvc-&gt;state.deleted
op_logical_and
id|pvc-&gt;state.exist
)paren
(brace
id|pvc_carrier
c_func
(paren
l_int|0
comma
id|pvc
)paren
suffix:semicolon
id|pvc-&gt;state.active
op_assign
id|pvc-&gt;state
dot
r_new
op_assign
l_int|0
suffix:semicolon
id|pvc-&gt;state.exist
op_assign
l_int|0
suffix:semicolon
id|fr_log_dlci_active
c_func
(paren
id|pvc
)paren
suffix:semicolon
)brace
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
multiline_comment|/* Next full report after N391 polls */
id|hdlc-&gt;state.fr.n391cnt
op_assign
id|hdlc-&gt;state.fr.settings.n391
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fr_rx
r_static
r_int
id|fr_rx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|hdlc_device
op_star
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|skb-&gt;dev
)paren
suffix:semicolon
id|fr_hdr
op_star
id|fh
op_assign
(paren
id|fr_hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|u8
op_star
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
id|u16
id|dlci
suffix:semicolon
id|pvc_device
op_star
id|pvc
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|4
op_logical_or
id|fh-&gt;ea1
op_logical_or
id|data
(braket
l_int|2
)braket
op_ne
id|FR_UI
)paren
r_goto
id|rx_error
suffix:semicolon
id|dlci
op_assign
id|q922_to_dlci
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlci
op_eq
id|LMI_DLCI
)paren
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_NONE
)paren
r_goto
id|rx_error
suffix:semicolon
multiline_comment|/* LMI packet with no LMI? */
r_if
c_cond
(paren
id|data
(braket
l_int|3
)braket
op_eq
id|LMI_PROTO
)paren
(brace
r_if
c_cond
(paren
id|fr_lmi_recv
c_func
(paren
id|hdlc
comma
id|skb
)paren
)paren
r_goto
id|rx_error
suffix:semicolon
r_else
(brace
multiline_comment|/* No request pending */
id|hdlc-&gt;state.fr.request
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.last_poll
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_RX_SUCCESS
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received non-LMI frame with LMI DLCI&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_goto
id|rx_error
suffix:semicolon
)brace
id|pvc
op_assign
id|find_pvc
c_func
(paren
id|hdlc
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pvc
)paren
(brace
macro_line|#ifdef DEBUG_PKT
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No PVC for received frame&squot;s DLCI %d&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|dlci
)paren
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_RX_DROP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pvc-&gt;state.fecn
op_ne
id|fh-&gt;fecn
)paren
(brace
macro_line|#ifdef DEBUG_ECN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: DLCI %d FECN O%s&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|pvc
)paren
comma
id|dlci
comma
id|fh-&gt;fecn
ques
c_cond
l_string|&quot;N&quot;
suffix:colon
l_string|&quot;FF&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pvc-&gt;state.fecn
op_xor_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pvc-&gt;state.becn
op_ne
id|fh-&gt;becn
)paren
(brace
macro_line|#ifdef DEBUG_ECN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: DLCI %d BECN O%s&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|pvc
)paren
comma
id|dlci
comma
id|fh-&gt;becn
ques
c_cond
l_string|&quot;N&quot;
suffix:colon
l_string|&quot;FF&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pvc-&gt;state.becn
op_xor_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_share_check
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|hdlc-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
id|NET_RX_DROP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
(braket
l_int|3
)braket
op_eq
id|NLPID_IP
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Remove 4-byte header (hdr, UI, NLPID) */
id|dev
op_assign
id|pvc-&gt;main
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data
(braket
l_int|3
)braket
op_eq
id|NLPID_IPV6
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Remove 4-byte header (hdr, UI, NLPID) */
id|dev
op_assign
id|pvc-&gt;main
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skb-&gt;len
OG
l_int|10
op_logical_and
id|data
(braket
l_int|3
)braket
op_eq
id|FR_PAD
op_logical_and
id|data
(braket
l_int|4
)braket
op_eq
id|NLPID_SNAP
op_logical_and
id|data
(braket
l_int|5
)braket
op_eq
id|FR_PAD
)paren
(brace
id|u16
id|oui
op_assign
id|ntohs
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|data
op_plus
l_int|6
)paren
)paren
suffix:semicolon
id|u16
id|pid
op_assign
id|ntohs
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|data
op_plus
l_int|8
)paren
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|10
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
(paren
(paren
id|u32
)paren
id|oui
)paren
op_lshift
l_int|16
)paren
op_or
id|pid
)paren
(brace
r_case
id|ETH_P_ARP
suffix:colon
multiline_comment|/* routed frame with SNAP */
r_case
id|ETH_P_IPX
suffix:colon
r_case
id|ETH_P_IP
suffix:colon
multiline_comment|/* a long variant */
r_case
id|ETH_P_IPV6
suffix:colon
id|dev
op_assign
id|pvc-&gt;main
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|pid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x80C20007
suffix:colon
multiline_comment|/* bridged Ethernet frame */
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|pvc-&gt;ether
)paren
op_ne
l_int|NULL
)paren
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported protocol, OUI=%x &quot;
l_string|&quot;PID=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|oui
comma
id|pid
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_RX_DROP
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported protocol, NLPID=%x &quot;
l_string|&quot;length = %i&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|data
(braket
l_int|3
)braket
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_RX_DROP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
)paren
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|pvc_get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
multiline_comment|/* PVC traffic */
id|stats-&gt;rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;state.becn
)paren
id|stats-&gt;rx_compressed
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_RX_SUCCESS
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_RX_DROP
suffix:semicolon
)brace
id|rx_error
suffix:colon
id|hdlc-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* Mark error */
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_RX_DROP
suffix:semicolon
)brace
DECL|function|fr_start
r_static
r_void
id|fr_start
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
macro_line|#ifdef DEBUG_LINK
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fr_start&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_ne
id|LMI_NONE
)paren
(brace
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
op_amp
id|hdlc-&gt;netdev
)paren
)paren
id|netif_carrier_off
c_func
(paren
op_amp
id|hdlc-&gt;netdev
)paren
suffix:semicolon
id|hdlc-&gt;state.fr.last_poll
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.reliable
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.dce_changed
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.request
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.fullrep_sent
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.last_errors
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|hdlc-&gt;state.fr.n391cnt
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.txseq
op_assign
id|hdlc-&gt;state.fr.rxseq
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.timer
)paren
suffix:semicolon
multiline_comment|/* First poll after 1 s */
id|hdlc-&gt;state.fr.timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|hdlc-&gt;state.fr.timer.function
op_assign
id|fr_timer
suffix:semicolon
id|hdlc-&gt;state.fr.timer.data
op_assign
(paren
r_int
r_int
)paren
id|hdlc
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.timer
)paren
suffix:semicolon
)brace
r_else
id|fr_set_link_state
c_func
(paren
l_int|1
comma
id|hdlc
)paren
suffix:semicolon
)brace
DECL|function|fr_stop
r_static
r_void
id|fr_stop
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
macro_line|#ifdef DEBUG_LINK
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fr_stop&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_ne
id|LMI_NONE
)paren
id|del_timer_sync
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.timer
)paren
suffix:semicolon
id|fr_set_link_state
c_func
(paren
l_int|0
comma
id|hdlc
)paren
suffix:semicolon
)brace
DECL|function|fr_close
r_static
r_void
id|fr_close
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
multiline_comment|/* Shutdown all PVCs for this FRAD */
r_if
c_cond
(paren
id|pvc-&gt;main
)paren
id|dev_close
c_func
(paren
id|pvc-&gt;main
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;ether
)paren
id|dev_close
c_func
(paren
id|pvc-&gt;ether
)paren
suffix:semicolon
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
DECL|function|fr_add_pvc
r_static
r_int
id|fr_add_pvc
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_int
r_int
id|dlci
comma
r_int
id|type
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|result
comma
id|used
suffix:semicolon
r_char
op_star
id|prefix
op_assign
l_string|&quot;pvc%d&quot;
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|ARPHRD_ETHER
)paren
id|prefix
op_assign
l_string|&quot;pvceth%d&quot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pvc
op_assign
id|add_pvc
c_func
(paren
id|hdlc
comma
id|dlci
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze on fr_add_pvc()&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|get_dev_p
c_func
(paren
id|pvc
comma
id|type
)paren
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|used
op_assign
id|pvc_is_used
c_func
(paren
id|pvc
)paren
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze on fr_pvc()&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
id|delete_unused_pvcs
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
op_plus
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|ARPHRD_ETHER
)paren
(brace
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;x00&bslash;x01&quot;
comma
l_int|2
)paren
suffix:semicolon
id|get_random_bytes
c_func
(paren
id|dev-&gt;dev_addr
op_plus
l_int|2
comma
id|ETH_ALEN
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;type
op_assign
id|ARPHRD_DLCI
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_POINTOPOINT
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
l_int|10
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|2
suffix:semicolon
op_star
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
c_func
(paren
id|dlci
)paren
suffix:semicolon
id|dlci_to_q922
c_func
(paren
id|dev-&gt;broadcast
comma
id|dlci
)paren
suffix:semicolon
)brace
id|dev-&gt;hard_start_xmit
op_assign
id|pvc_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|pvc_get_stats
suffix:semicolon
id|dev-&gt;open
op_assign
id|pvc_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|pvc_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|pvc_ioctl
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|pvc_change_mtu
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|HDLC_MAX_MTU
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;priv
op_assign
id|pvc
suffix:semicolon
id|result
op_assign
id|dev_alloc_name
c_func
(paren
id|dev
comma
id|prefix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|delete_unused_pvcs
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdevice
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|delete_unused_pvcs
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|dev-&gt;destructor
op_assign
id|free_netdev
suffix:semicolon
op_star
id|get_dev_p
c_func
(paren
id|pvc
comma
id|type
)paren
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|used
)paren
(brace
id|hdlc-&gt;state.fr.dce_changed
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.dce_pvc_count
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fr_del_pvc
r_static
r_int
id|fr_del_pvc
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_int
r_int
id|dlci
comma
r_int
id|type
)paren
(brace
id|pvc_device
op_star
id|pvc
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pvc
op_assign
id|find_pvc
c_func
(paren
id|hdlc
comma
id|dlci
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
op_star
id|get_dev_p
c_func
(paren
id|pvc
comma
id|type
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* PVC in use */
id|unregister_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* the destructor will kfree(dev) */
op_star
id|get_dev_p
c_func
(paren
id|pvc
comma
id|type
)paren
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pvc_is_used
c_func
(paren
id|pvc
)paren
)paren
(brace
id|hdlc-&gt;state.fr.dce_pvc_count
op_decrement
suffix:semicolon
id|hdlc-&gt;state.fr.dce_changed
op_assign
l_int|1
suffix:semicolon
)brace
id|delete_unused_pvcs
c_func
(paren
id|hdlc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fr_destroy
r_static
r_void
id|fr_destroy
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|pvc_device
op_star
id|pvc
suffix:semicolon
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
id|hdlc-&gt;state.fr.first_pvc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* All PVCs destroyed */
id|hdlc-&gt;state.fr.dce_pvc_count
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.dce_changed
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
id|pvc_device
op_star
id|next
op_assign
id|pvc-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;main
)paren
multiline_comment|/* the destructor will kfree(main + ether) */
id|unregister_netdevice
c_func
(paren
id|pvc-&gt;main
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;ether
)paren
id|unregister_netdevice
c_func
(paren
id|pvc-&gt;ether
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pvc
)paren
suffix:semicolon
id|pvc
op_assign
id|next
suffix:semicolon
)brace
)brace
DECL|function|hdlc_fr_ioctl
r_int
id|hdlc_fr_ioctl
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_struct
id|ifreq
op_star
id|ifr
)paren
(brace
id|fr_proto
op_star
id|fr_s
op_assign
id|ifr-&gt;ifr_settings.ifs_ifsu.fr
suffix:semicolon
r_const
r_int
id|size
op_assign
r_sizeof
(paren
id|fr_proto
)paren
suffix:semicolon
id|fr_proto
id|new_settings
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|hdlc_to_dev
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|fr_proto_pvc
id|pvc
suffix:semicolon
r_int
id|result
suffix:semicolon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_GET_PROTO
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_PROTO_FR
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
OL
id|size
)paren
(brace
id|ifr-&gt;ifr_settings.size
op_assign
id|size
suffix:semicolon
multiline_comment|/* data size wanted */
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|fr_s
comma
op_amp
id|hdlc-&gt;state.fr.settings
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_PROTO_FR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|new_settings
comma
id|fr_s
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|new_settings.lmi
op_eq
id|LMI_DEFAULT
)paren
id|new_settings.lmi
op_assign
id|LMI_ANSI
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_settings.lmi
op_ne
id|LMI_NONE
op_logical_and
id|new_settings.lmi
op_ne
id|LMI_ANSI
op_logical_and
id|new_settings.lmi
op_ne
id|LMI_CCITT
)paren
op_logical_or
id|new_settings.t391
OL
l_int|1
op_logical_or
id|new_settings.t392
OL
l_int|2
op_logical_or
id|new_settings.n391
OL
l_int|1
op_logical_or
id|new_settings.n392
OL
l_int|1
op_logical_or
id|new_settings.n393
template_param
l_int|32
op_logical_or
(paren
id|new_settings.dce
op_ne
l_int|0
op_logical_and
id|new_settings.dce
op_ne
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|result
op_assign
id|hdlc
op_member_access_from_pointer
id|attach
c_func
(paren
id|hdlc
comma
id|ENCODING_NRZ
comma
id|PARITY_CRC16_PR1_CCITT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;proto.id
op_ne
id|IF_PROTO_FR
)paren
(brace
id|hdlc_proto_detach
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|hdlc-&gt;state.fr.first_pvc
op_assign
l_int|NULL
suffix:semicolon
id|hdlc-&gt;state.fr.dce_pvc_count
op_assign
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.settings
comma
op_amp
id|new_settings
comma
id|size
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hdlc-&gt;proto
comma
l_int|0
comma
r_sizeof
(paren
id|hdlc-&gt;proto
)paren
)paren
suffix:semicolon
id|hdlc-&gt;proto.close
op_assign
id|fr_close
suffix:semicolon
id|hdlc-&gt;proto.start
op_assign
id|fr_start
suffix:semicolon
id|hdlc-&gt;proto.stop
op_assign
id|fr_stop
suffix:semicolon
id|hdlc-&gt;proto.detach
op_assign
id|fr_destroy
suffix:semicolon
id|hdlc-&gt;proto.netif_rx
op_assign
id|fr_rx
suffix:semicolon
id|hdlc-&gt;proto.id
op_assign
id|IF_PROTO_FR
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|hdlc-&gt;xmit
suffix:semicolon
id|dev-&gt;hard_header
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_FRAD
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_POINTOPOINT
op_or
id|IFF_NOARP
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_PROTO_FR_ADD_PVC
suffix:colon
r_case
id|IF_PROTO_FR_DEL_PVC
suffix:colon
r_case
id|IF_PROTO_FR_ADD_ETH_PVC
suffix:colon
r_case
id|IF_PROTO_FR_DEL_ETH_PVC
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|pvc
comma
id|ifr-&gt;ifr_settings.ifs_ifsu.fr_pvc
comma
r_sizeof
(paren
id|fr_proto_pvc
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|pvc.dlci
op_le
l_int|0
op_logical_or
id|pvc.dlci
op_ge
l_int|1024
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Only 10 bits, DLCI 0 reserved */
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.type
op_eq
id|IF_PROTO_FR_ADD_ETH_PVC
op_logical_or
id|ifr-&gt;ifr_settings.type
op_eq
id|IF_PROTO_FR_DEL_ETH_PVC
)paren
id|result
op_assign
id|ARPHRD_ETHER
suffix:semicolon
multiline_comment|/* bridged Ethernet device */
r_else
id|result
op_assign
id|ARPHRD_DLCI
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.type
op_eq
id|IF_PROTO_FR_ADD_PVC
op_logical_or
id|ifr-&gt;ifr_settings.type
op_eq
id|IF_PROTO_FR_ADD_ETH_PVC
)paren
r_return
id|fr_add_pvc
c_func
(paren
id|hdlc
comma
id|pvc.dlci
comma
id|result
)paren
suffix:semicolon
r_else
r_return
id|fr_del_pvc
c_func
(paren
id|hdlc
comma
id|pvc.dlci
comma
id|result
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
eof
