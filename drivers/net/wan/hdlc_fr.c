multiline_comment|/*&n; * Generic HDLC support routines for Linux&n; * Frame Relay support&n; *&n; * Copyright (C) 1999 - 2001 Krzysztof Halasa &lt;khc@pm.waw.pl&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/pkt_sched.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/lapb.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
DECL|function|find_pvc
id|__inline__
id|pvc_device
op_star
id|find_pvc
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
id|u16
id|dlci
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
r_if
c_cond
(paren
id|netdev_dlci
c_func
(paren
op_amp
id|pvc-&gt;netdev
)paren
op_eq
id|dlci
)paren
r_return
id|pvc
suffix:semicolon
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|status_to_dlci
id|__inline__
id|u16
id|status_to_dlci
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
id|u8
op_star
id|status
comma
r_int
op_star
id|active
comma
r_int
op_star
r_new
)paren
(brace
op_star
r_new
op_assign
(paren
id|status
(braket
l_int|2
)braket
op_amp
l_int|0x08
)paren
suffix:semicolon
op_star
id|active
op_assign
(paren
op_logical_neg
op_star
r_new
op_logical_and
(paren
id|status
(braket
l_int|2
)braket
op_amp
l_int|0x02
)paren
)paren
suffix:semicolon
r_return
(paren
(paren
id|status
(braket
l_int|0
)braket
op_amp
l_int|0x3F
)paren
op_lshift
l_int|4
)paren
op_or
(paren
(paren
id|status
(braket
l_int|1
)braket
op_amp
l_int|0x78
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
)brace
DECL|function|dlci_to_status
id|__inline__
r_void
id|dlci_to_status
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
id|u16
id|dlci
comma
id|u8
op_star
id|status
comma
r_int
id|active
comma
r_int
r_new
)paren
(brace
id|status
(braket
l_int|0
)braket
op_assign
(paren
id|dlci
op_rshift
l_int|4
)paren
op_amp
l_int|0x3F
suffix:semicolon
id|status
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|dlci
op_lshift
l_int|3
)paren
op_amp
l_int|0x78
)paren
op_or
l_int|0x80
suffix:semicolon
id|status
(braket
l_int|2
)braket
op_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
r_new
)paren
id|status
(braket
l_int|2
)braket
op_or_assign
l_int|0x08
suffix:semicolon
r_else
r_if
c_cond
(paren
id|active
)paren
id|status
(braket
l_int|2
)braket
op_or_assign
l_int|0x02
suffix:semicolon
)brace
DECL|function|fr_hard_header
r_static
r_int
id|fr_hard_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
r_int
id|len
)paren
(brace
id|u16
id|head_len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|daddr
)paren
id|daddr
op_assign
id|dev-&gt;broadcast
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC_DEBUG_HARD_HEADER
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: fr_hard_header called&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|head_len
op_assign
l_int|4
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|NLPID_IP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_IPV6
suffix:colon
id|head_len
op_assign
l_int|4
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|NLPID_IPV6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LMI_PROTO
suffix:colon
id|head_len
op_assign
l_int|4
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|LMI_PROTO
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|head_len
op_assign
l_int|10
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|head_len
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|3
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|4
)braket
op_assign
id|NLPID_SNAP
suffix:semicolon
id|skb-&gt;data
(braket
l_int|5
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|6
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|7
)braket
op_assign
id|FR_PAD
suffix:semicolon
id|skb-&gt;data
(braket
l_int|8
)braket
op_assign
id|type
op_rshift
l_int|8
suffix:semicolon
id|skb-&gt;data
(braket
l_int|9
)braket
op_assign
(paren
id|u8
)paren
id|type
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|daddr
comma
l_int|2
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|2
)braket
op_assign
id|FR_UI
suffix:semicolon
r_return
id|head_len
suffix:semicolon
)brace
DECL|function|pvc_open
r_static
r_int
id|pvc_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|dev_to_pvc
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hdlc_to_dev
c_func
(paren
id|pvc-&gt;master
)paren
op_member_access_from_pointer
id|flags
op_amp
id|IFF_UP
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Master must be UP in order to activate PVC */
r_if
c_cond
(paren
id|pvc-&gt;master-&gt;state.fr.settings.lmi
op_ne
id|LMI_NONE
)paren
id|pvc-&gt;state.active
op_assign
l_int|0
suffix:semicolon
r_else
id|pvc-&gt;state.active
op_assign
l_int|1
suffix:semicolon
id|pvc-&gt;state
dot
r_new
op_assign
l_int|0
suffix:semicolon
id|pvc-&gt;master-&gt;state.fr.changed
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvc_close
r_static
r_int
id|pvc_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|dev_to_pvc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pvc-&gt;state.active
op_assign
id|pvc-&gt;state
dot
r_new
op_assign
l_int|0
suffix:semicolon
id|pvc-&gt;master-&gt;state.fr.changed
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvc_xmit
r_static
r_int
id|pvc_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|dev_to_pvc
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;state.active
)paren
(brace
id|skb-&gt;dev
op_assign
id|hdlc_to_dev
c_func
(paren
id|pvc-&gt;master
)paren
suffix:semicolon
id|pvc-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|pvc-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;state.fecn
)paren
id|pvc-&gt;stats.tx_compressed
op_increment
suffix:semicolon
multiline_comment|/* TX Congestion counter */
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|pvc-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvc_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|pvc_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|dev_to_pvc
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_amp
id|pvc-&gt;stats
suffix:semicolon
)brace
DECL|function|pvc_change_mtu
r_static
r_int
id|pvc_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|68
)paren
op_logical_or
(paren
id|new_mtu
OG
id|HDLC_MAX_MTU
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fr_log_dlci_active
r_static
r_inline
r_void
id|fr_log_dlci_active
c_func
(paren
id|pvc_device
op_star
id|pvc
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %sactive%s&bslash;n&quot;
comma
id|pvc_to_name
c_func
(paren
id|pvc
)paren
comma
id|pvc-&gt;state.active
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;in&quot;
comma
id|pvc-&gt;state
dot
r_new
ques
c_cond
l_string|&quot; new&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
DECL|function|fr_lmi_nextseq
r_static
r_inline
id|u8
id|fr_lmi_nextseq
c_func
(paren
id|u8
id|x
)paren
(brace
id|x
op_increment
suffix:semicolon
r_return
id|x
ques
c_cond
id|x
suffix:colon
l_int|1
suffix:semicolon
)brace
DECL|function|fr_lmi_send
r_static
r_void
id|fr_lmi_send
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_int
id|fullrep
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_int
id|len
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_ANSI
)paren
ques
c_cond
id|LMI_ANSI_LENGTH
suffix:colon
id|LMI_LENGTH
suffix:semicolon
r_int
id|stat_len
op_assign
l_int|3
suffix:semicolon
id|u8
op_star
id|data
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
op_logical_and
id|fullrep
)paren
(brace
id|len
op_add_assign
id|hdlc-&gt;state.fr.pvc_count
op_star
(paren
l_int|2
op_plus
id|stat_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|HDLC_MAX_MTU
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too many PVCs while sending &quot;
l_string|&quot;LMI full report&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze on fr_lmi_send()&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|skb-&gt;data
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|fr_hard_header
c_func
(paren
id|skb
comma
id|hdlc_to_dev
c_func
(paren
id|hdlc
)paren
comma
id|LMI_PROTO
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|data
op_assign
id|skb-&gt;tail
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|LMI_CALLREF
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|hdlc-&gt;state.fr.settings.dce
ques
c_cond
id|LMI_STATUS
suffix:colon
id|LMI_STATUS_ENQUIRY
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_ANSI
)paren
id|data
(braket
id|i
op_increment
)braket
op_assign
id|LMI_ANSI_LOCKSHIFT
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_REPTYPE
suffix:colon
id|LMI_REPTYPE
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|LMI_REPT_LEN
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|fullrep
ques
c_cond
id|LMI_FULLREP
suffix:colon
id|LMI_INTEGRITY
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_ALIVE
suffix:colon
id|LMI_ALIVE
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|LMI_INTEG_LEN
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|hdlc-&gt;state.fr.txseq
op_assign
id|fr_lmi_nextseq
c_func
(paren
id|hdlc-&gt;state.fr.txseq
)paren
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|hdlc-&gt;state.fr.rxseq
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
op_logical_and
id|fullrep
)paren
(brace
r_while
c_loop
(paren
id|pvc
)paren
(brace
id|data
(braket
id|i
op_increment
)braket
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_PVCSTAT
suffix:colon
id|LMI_PVCSTAT
suffix:semicolon
id|data
(braket
id|i
op_increment
)braket
op_assign
id|stat_len
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.reliable
op_logical_and
(paren
id|pvc-&gt;netdev.flags
op_amp
id|IFF_UP
)paren
op_logical_and
op_logical_neg
id|pvc-&gt;state.active
op_logical_and
op_logical_neg
id|pvc-&gt;state
dot
r_new
)paren
(brace
id|pvc-&gt;state
dot
r_new
op_assign
l_int|1
suffix:semicolon
id|fr_log_dlci_active
c_func
(paren
id|pvc
)paren
suffix:semicolon
)brace
id|dlci_to_status
c_func
(paren
id|hdlc
comma
id|netdev_dlci
c_func
(paren
op_amp
id|pvc-&gt;netdev
)paren
comma
id|data
op_plus
id|i
comma
id|pvc-&gt;state.active
comma
id|pvc-&gt;state
dot
r_new
)paren
suffix:semicolon
id|i
op_add_assign
id|stat_len
suffix:semicolon
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|i
)paren
suffix:semicolon
id|skb-&gt;priority
op_assign
id|TC_PRIO_CONTROL
suffix:semicolon
id|skb-&gt;dev
op_assign
id|hdlc_to_dev
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|fr_timer
r_static
r_void
id|fr_timer
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|hdlc_device
op_star
id|hdlc
op_assign
(paren
id|hdlc_device
op_star
)paren
id|arg
suffix:semicolon
r_int
id|i
comma
id|cnt
op_assign
l_int|0
comma
id|reliable
suffix:semicolon
id|u32
id|list
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
)paren
id|reliable
op_assign
(paren
id|jiffies
op_minus
id|hdlc-&gt;state.fr.last_poll
OL
id|hdlc-&gt;state.fr.settings.t392
op_star
id|HZ
)paren
suffix:semicolon
r_else
(brace
id|hdlc-&gt;state.fr.last_errors
op_lshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* Shift the list */
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.request
)paren
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.reliable
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No LMI status reply &quot;
l_string|&quot;received&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
id|hdlc-&gt;state.fr.last_errors
op_or_assign
l_int|1
suffix:semicolon
)brace
id|list
op_assign
id|hdlc-&gt;state.fr.last_errors
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hdlc-&gt;state.fr.settings.n393
suffix:semicolon
id|i
op_increment
comma
id|list
op_rshift_assign
l_int|1
)paren
id|cnt
op_add_assign
(paren
id|list
op_amp
l_int|1
)paren
suffix:semicolon
multiline_comment|/* errors count */
id|reliable
op_assign
(paren
id|cnt
OL
id|hdlc-&gt;state.fr.settings.n392
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.reliable
op_ne
id|reliable
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
id|hdlc-&gt;state.fr.reliable
op_assign
id|reliable
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link %sreliable&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|reliable
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;un&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reliable
)paren
(brace
id|hdlc-&gt;state.fr.n391cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Request full status */
id|hdlc-&gt;state.fr.changed
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|pvc
)paren
(brace
multiline_comment|/* Deactivate all PVCs */
id|pvc-&gt;state
dot
r_new
op_assign
id|pvc-&gt;state.active
op_assign
l_int|0
suffix:semicolon
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
)paren
id|hdlc-&gt;state.fr.timer.expires
op_assign
id|jiffies
op_plus
id|hdlc-&gt;state.fr.settings.t392
op_star
id|HZ
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.n391cnt
)paren
id|hdlc-&gt;state.fr.n391cnt
op_decrement
suffix:semicolon
id|fr_lmi_send
c_func
(paren
id|hdlc
comma
id|hdlc-&gt;state.fr.n391cnt
op_eq
l_int|0
)paren
suffix:semicolon
id|hdlc-&gt;state.fr.request
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.timer.expires
op_assign
id|jiffies
op_plus
id|hdlc-&gt;state.fr.settings.t391
op_star
id|HZ
suffix:semicolon
)brace
id|hdlc-&gt;state.fr.timer.function
op_assign
id|fr_timer
suffix:semicolon
id|hdlc-&gt;state.fr.timer.data
op_assign
id|arg
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.timer
)paren
suffix:semicolon
)brace
DECL|function|fr_lmi_recv
r_static
r_int
id|fr_lmi_recv
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|stat_len
suffix:semicolon
id|pvc_device
op_star
id|pvc
suffix:semicolon
r_int
id|reptype
op_assign
op_minus
l_int|1
comma
id|error
suffix:semicolon
id|u8
id|rxseq
comma
id|txseq
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
(paren
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_ANSI
)paren
ques
c_cond
id|LMI_ANSI_LENGTH
suffix:colon
id|LMI_LENGTH
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Short LMI frame&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|5
)braket
op_ne
(paren
op_logical_neg
id|hdlc-&gt;state.fr.settings.dce
ques
c_cond
id|LMI_STATUS
suffix:colon
id|LMI_STATUS_ENQUIRY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: LMI msgtype=%x, Not LMI status %s&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
l_int|2
)braket
comma
id|hdlc-&gt;state.fr.settings.dce
ques
c_cond
l_string|&quot;enquiry&quot;
suffix:colon
l_string|&quot;reply&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_assign
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_ANSI
)paren
ques
c_cond
l_int|7
suffix:colon
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_ne
(paren
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_REPTYPE
suffix:colon
id|LMI_REPTYPE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Not a report type=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
multiline_comment|/* Skip length field */
id|reptype
op_assign
id|skb-&gt;data
(braket
id|i
op_increment
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_ne
(paren
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_ALIVE
suffix:colon
id|LMI_ALIVE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported status element=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
multiline_comment|/* Skip length field */
id|hdlc-&gt;state.fr.rxseq
op_assign
id|skb-&gt;data
(braket
id|i
op_increment
)braket
suffix:semicolon
multiline_comment|/* TX sequence from peer */
id|rxseq
op_assign
id|skb-&gt;data
(braket
id|i
op_increment
)braket
suffix:semicolon
multiline_comment|/* Should confirm our sequence */
id|txseq
op_assign
id|hdlc-&gt;state.fr.txseq
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
)paren
(brace
r_if
c_cond
(paren
id|reptype
op_ne
id|LMI_FULLREP
op_logical_and
id|reptype
op_ne
id|LMI_INTEGRITY
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported report type=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|reptype
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdlc-&gt;state.fr.reliable
)paren
id|error
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rxseq
op_eq
l_int|0
op_logical_or
id|rxseq
op_ne
id|txseq
)paren
(brace
id|hdlc-&gt;state.fr.n391cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ask for full report next time */
id|error
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.dce
)paren
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.fullrep_sent
op_logical_and
op_logical_neg
id|error
)paren
(brace
multiline_comment|/* Stop sending full report - the last one has been confirmed by DTE */
id|hdlc-&gt;state.fr.fullrep_sent
op_assign
l_int|0
suffix:semicolon
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
r_if
c_cond
(paren
id|pvc-&gt;state
dot
r_new
)paren
(brace
id|pvc-&gt;state
dot
r_new
op_assign
l_int|0
suffix:semicolon
id|pvc-&gt;state.active
op_assign
l_int|1
suffix:semicolon
id|fr_log_dlci_active
c_func
(paren
id|pvc
)paren
suffix:semicolon
multiline_comment|/* Tell DTE that new PVC is now active */
id|hdlc-&gt;state.fr.changed
op_assign
l_int|1
suffix:semicolon
)brace
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.changed
)paren
(brace
id|reptype
op_assign
id|LMI_FULLREP
suffix:semicolon
id|hdlc-&gt;state.fr.fullrep_sent
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.changed
op_assign
l_int|0
suffix:semicolon
)brace
id|fr_lmi_send
c_func
(paren
id|hdlc
comma
id|reptype
op_eq
id|LMI_FULLREP
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* DTE */
r_if
c_cond
(paren
id|reptype
op_ne
id|LMI_FULLREP
op_logical_or
id|error
)paren
r_return
l_int|0
suffix:semicolon
id|stat_len
op_assign
l_int|3
suffix:semicolon
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
id|pvc-&gt;state.deleted
op_assign
id|pvc-&gt;state.active
suffix:semicolon
multiline_comment|/* mark active PVCs */
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|skb-&gt;len
op_ge
id|i
op_plus
l_int|2
op_plus
id|stat_len
)paren
(brace
id|u16
id|dlci
suffix:semicolon
r_int
id|active
comma
r_new
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_ne
(paren
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_CCITT
)paren
ques
c_cond
id|LMI_CCITT_PVCSTAT
suffix:colon
id|LMI_PVCSTAT
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Invalid PVCSTAT ID: %x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
id|i
)braket
op_ne
id|stat_len
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Invalid PVCSTAT length: %x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
id|dlci
op_assign
id|status_to_dlci
c_func
(paren
id|hdlc
comma
id|skb-&gt;data
op_plus
id|i
comma
op_amp
id|active
comma
op_amp
r_new
)paren
suffix:semicolon
id|pvc
op_assign
id|find_pvc
c_func
(paren
id|hdlc
comma
id|dlci
)paren
suffix:semicolon
id|active
op_or_assign
r_new
suffix:semicolon
r_if
c_cond
(paren
id|pvc
)paren
(brace
r_if
c_cond
(paren
id|active
op_logical_and
op_logical_neg
id|pvc-&gt;state.active
op_logical_and
(paren
id|pvc-&gt;netdev.flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|pvc-&gt;state.active
op_assign
id|active
suffix:semicolon
id|fr_log_dlci_active
c_func
(paren
id|pvc
)paren
suffix:semicolon
)brace
id|pvc-&gt;state.deleted
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
r_new
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: new PVC available, DLCI=%u&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|dlci
)paren
suffix:semicolon
id|i
op_add_assign
id|stat_len
suffix:semicolon
)brace
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
r_if
c_cond
(paren
id|pvc-&gt;state.deleted
)paren
(brace
id|pvc-&gt;state.active
op_assign
id|pvc-&gt;state
dot
r_new
op_assign
l_int|0
suffix:semicolon
id|fr_log_dlci_active
c_func
(paren
id|pvc
)paren
suffix:semicolon
id|pvc-&gt;state.deleted
op_assign
l_int|0
suffix:semicolon
)brace
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
multiline_comment|/* Next full report after N391 polls */
id|hdlc-&gt;state.fr.n391cnt
op_assign
id|hdlc-&gt;state.fr.settings.n391
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fr_rx
r_static
r_void
id|fr_rx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|hdlc_device
op_star
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|skb-&gt;dev
)paren
suffix:semicolon
id|fr_hdr
op_star
id|fh
op_assign
(paren
id|fr_hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|u8
op_star
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
id|u16
id|dlci
suffix:semicolon
id|pvc_device
op_star
id|pvc
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|4
op_logical_or
id|fh-&gt;ea1
op_logical_or
id|data
(braket
l_int|2
)braket
op_ne
id|FR_UI
)paren
r_goto
id|rx_error
suffix:semicolon
id|dlci
op_assign
id|q922_to_dlci
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlci
op_eq
id|LMI_DLCI
)paren
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_eq
id|LMI_NONE
)paren
r_goto
id|rx_error
suffix:semicolon
multiline_comment|/* LMI packet with no LMI? */
r_if
c_cond
(paren
id|data
(braket
l_int|3
)braket
op_eq
id|LMI_PROTO
)paren
(brace
r_if
c_cond
(paren
id|fr_lmi_recv
c_func
(paren
id|hdlc
comma
id|skb
)paren
)paren
r_goto
id|rx_error
suffix:semicolon
r_else
(brace
multiline_comment|/* No request pending */
id|hdlc-&gt;state.fr.request
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.last_poll
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received non-LMI frame with LMI DLCI&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_goto
id|rx_error
suffix:semicolon
)brace
id|pvc
op_assign
id|find_pvc
c_func
(paren
id|hdlc
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pvc
)paren
(brace
macro_line|#ifdef CONFIG_HDLC_DEBUG_PKT
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No PVC for received frame&squot;s DLCI %d&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|dlci
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|rx_error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pvc-&gt;netdev.flags
op_amp
id|IFF_UP
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef CONFIG_HDLC_DEBUG_PKT
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PVC for received frame&squot;s DLCI %d is down&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|dlci
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|rx_error
suffix:semicolon
)brace
id|pvc-&gt;stats.rx_packets
op_increment
suffix:semicolon
multiline_comment|/* PVC traffic */
id|pvc-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;state.fecn
op_ne
(paren
id|fh-&gt;fecn
ques
c_cond
id|PVC_STATE_FECN
suffix:colon
l_int|0
)paren
)paren
(brace
macro_line|#ifdef CONFIG_HDLC_DEBUG_ECN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: FECN O%s&bslash;n&quot;
comma
id|pvc_to_name
c_func
(paren
id|pvc
)paren
comma
id|fh-&gt;fecn
ques
c_cond
l_string|&quot;N&quot;
suffix:colon
l_string|&quot;FF&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pvc-&gt;state.fecn
op_xor_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pvc-&gt;state.becn
op_ne
(paren
id|fh-&gt;becn
ques
c_cond
id|PVC_STATE_BECN
suffix:colon
l_int|0
)paren
)paren
(brace
macro_line|#ifdef CONFIG_HDLC_DEBUG_ECN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: BECN O%s&bslash;n&quot;
comma
id|pvc_to_name
c_func
(paren
id|pvc
)paren
comma
id|fh-&gt;becn
ques
c_cond
l_string|&quot;N&quot;
suffix:colon
l_string|&quot;FF&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pvc-&gt;state.becn
op_xor_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pvc-&gt;state.becn
)paren
id|pvc-&gt;stats.rx_compressed
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
op_amp
id|pvc-&gt;netdev
suffix:semicolon
r_if
c_cond
(paren
id|data
(braket
l_int|3
)braket
op_eq
id|NLPID_IP
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Remove 4-byte header (hdr, UI, NLPID) */
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
(braket
l_int|3
)braket
op_eq
id|NLPID_IPV6
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Remove 4-byte header (hdr, UI, NLPID) */
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
(braket
l_int|3
)braket
op_eq
id|FR_PAD
op_logical_and
id|data
(braket
l_int|4
)braket
op_eq
id|NLPID_SNAP
op_logical_and
id|data
(braket
l_int|5
)braket
op_eq
id|FR_PAD
)paren
(brace
id|u16
id|oui
op_assign
id|ntohl
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|data
op_plus
l_int|6
)paren
)paren
suffix:semicolon
id|u16
id|pid
op_assign
id|ntohl
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|data
op_plus
l_int|8
)paren
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|10
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
(paren
(paren
id|u32
)paren
id|oui
)paren
op_lshift
l_int|16
)paren
op_or
id|pid
)paren
(brace
r_case
id|ETH_P_ARP
suffix:colon
multiline_comment|/* routed frame with SNAP */
r_case
id|ETH_P_IPX
suffix:colon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|pid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported protocol, OUI=%x &quot;
l_string|&quot;PID=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|oui
comma
id|pid
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported protocol, NLPID=%x&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
comma
id|data
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
id|rx_error
suffix:colon
id|hdlc-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* Mark error */
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|fr_open
r_static
r_int
id|fr_open
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_ne
id|LMI_NONE
)paren
(brace
id|hdlc-&gt;state.fr.last_poll
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.reliable
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.changed
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.request
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.fullrep_sent
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.last_errors
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|hdlc-&gt;state.fr.n391cnt
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.txseq
op_assign
id|hdlc-&gt;state.fr.rxseq
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.timer
)paren
suffix:semicolon
multiline_comment|/* First poll after 1 s */
id|hdlc-&gt;state.fr.timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|hdlc-&gt;state.fr.timer.function
op_assign
id|fr_timer
suffix:semicolon
id|hdlc-&gt;state.fr.timer.data
op_assign
(paren
r_int
r_int
)paren
id|hdlc
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.timer
)paren
suffix:semicolon
)brace
r_else
id|hdlc-&gt;state.fr.reliable
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fr_close
r_static
r_void
id|fr_close
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_if
c_cond
(paren
id|hdlc-&gt;state.fr.settings.lmi
op_ne
id|LMI_NONE
)paren
id|del_timer_sync
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.timer
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
id|dev_close
c_func
(paren
op_amp
id|pvc-&gt;netdev
)paren
suffix:semicolon
multiline_comment|/* Shutdown all PVCs for this FRAD */
id|pvc
op_assign
id|pvc-&gt;next
suffix:semicolon
)brace
)brace
DECL|function|fr_pvc
r_static
r_int
id|fr_pvc
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_int
r_int
id|dlci
comma
r_int
id|create
)paren
(brace
id|pvc_device
op_star
op_star
id|pvc_p
op_assign
op_amp
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
id|pvc_device
op_star
id|pvc
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|dlci
op_le
l_int|0
op_logical_or
id|dlci
op_ge
l_int|1024
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Only 10 bits for DLCI, DLCI 0 reserved */
r_while
c_loop
(paren
op_star
id|pvc_p
)paren
(brace
r_if
c_cond
(paren
id|netdev_dlci
c_func
(paren
op_amp
(paren
op_star
id|pvc_p
)paren
op_member_access_from_pointer
id|netdev
)paren
op_eq
id|dlci
)paren
r_break
suffix:semicolon
id|pvc_p
op_assign
op_amp
(paren
op_star
id|pvc_p
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|create
)paren
(brace
multiline_comment|/* Create PVC */
r_if
c_cond
(paren
op_star
id|pvc_p
op_ne
l_int|NULL
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|pvc
op_assign
op_star
id|pvc_p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|pvc_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pvc
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze on fr_pvc()&bslash;n&quot;
comma
id|hdlc_to_name
c_func
(paren
id|hdlc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pvc
comma
l_int|0
comma
r_sizeof
(paren
id|pvc_device
)paren
)paren
suffix:semicolon
id|pvc-&gt;netdev.hard_start_xmit
op_assign
id|pvc_xmit
suffix:semicolon
id|pvc-&gt;netdev.get_stats
op_assign
id|pvc_get_stats
suffix:semicolon
id|pvc-&gt;netdev.open
op_assign
id|pvc_open
suffix:semicolon
id|pvc-&gt;netdev.stop
op_assign
id|pvc_close
suffix:semicolon
id|pvc-&gt;netdev.change_mtu
op_assign
id|pvc_change_mtu
suffix:semicolon
id|pvc-&gt;netdev.mtu
op_assign
id|HDLC_MAX_MTU
suffix:semicolon
id|pvc-&gt;netdev.type
op_assign
id|ARPHRD_DLCI
suffix:semicolon
id|pvc-&gt;netdev.hard_header_len
op_assign
l_int|16
suffix:semicolon
id|pvc-&gt;netdev.hard_header
op_assign
id|fr_hard_header
suffix:semicolon
id|pvc-&gt;netdev.tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|pvc-&gt;netdev.flags
op_assign
id|IFF_POINTOPOINT
suffix:semicolon
id|pvc-&gt;master
op_assign
id|hdlc
suffix:semicolon
op_star
(paren
id|u16
op_star
)paren
id|pvc-&gt;netdev.dev_addr
op_assign
id|htons
c_func
(paren
id|dlci
)paren
suffix:semicolon
id|dlci_to_q922
c_func
(paren
id|pvc-&gt;netdev.broadcast
comma
id|dlci
)paren
suffix:semicolon
id|pvc-&gt;netdev.addr_len
op_assign
l_int|2
suffix:semicolon
id|result
op_assign
id|dev_alloc_name
c_func
(paren
op_amp
id|pvc-&gt;netdev
comma
l_string|&quot;pvc%d&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|pvc
)paren
suffix:semicolon
op_star
id|pvc_p
op_assign
l_int|NULL
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_netdevice
c_func
(paren
op_amp
id|pvc-&gt;netdev
)paren
op_ne
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|pvc
)paren
suffix:semicolon
op_star
id|pvc_p
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|hdlc-&gt;state.fr.changed
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.pvc_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|pvc_p
op_eq
l_int|NULL
)paren
multiline_comment|/* Delete PVC */
r_return
op_minus
id|ENOENT
suffix:semicolon
id|pvc
op_assign
op_star
id|pvc_p
suffix:semicolon
r_if
c_cond
(paren
id|pvc-&gt;netdev.flags
op_amp
id|IFF_UP
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* PVC in use */
id|hdlc-&gt;state.fr.changed
op_assign
l_int|1
suffix:semicolon
id|hdlc-&gt;state.fr.pvc_count
op_decrement
suffix:semicolon
op_star
id|pvc_p
op_assign
id|pvc-&gt;next
suffix:semicolon
id|unregister_netdevice
c_func
(paren
op_amp
id|pvc-&gt;netdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pvc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fr_destroy
r_static
r_void
id|fr_destroy
c_func
(paren
id|hdlc_device
op_star
id|hdlc
)paren
(brace
id|pvc_device
op_star
id|pvc
op_assign
id|hdlc-&gt;state.fr.first_pvc
suffix:semicolon
r_while
c_loop
(paren
id|pvc
)paren
(brace
id|pvc_device
op_star
id|next
op_assign
id|pvc-&gt;next
suffix:semicolon
id|unregister_netdevice
c_func
(paren
op_amp
id|pvc-&gt;netdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pvc
)paren
suffix:semicolon
id|pvc
op_assign
id|next
suffix:semicolon
)brace
id|hdlc-&gt;state.fr.first_pvc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* All PVCs destroyed */
id|hdlc-&gt;state.fr.pvc_count
op_assign
l_int|0
suffix:semicolon
id|hdlc-&gt;state.fr.changed
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|hdlc_fr_ioctl
r_int
id|hdlc_fr_ioctl
c_func
(paren
id|hdlc_device
op_star
id|hdlc
comma
r_struct
id|ifreq
op_star
id|ifr
)paren
(brace
r_const
r_int
id|size
op_assign
r_sizeof
(paren
id|fr_proto
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|hdlc_to_dev
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|fr_proto_pvc
id|pvc
suffix:semicolon
r_int
id|result
suffix:semicolon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_GET_PROTO
suffix:colon
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_PROTO_FR
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.data_length
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* return protocol only */
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.data_length
OL
id|size
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* buffer too small */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_settings.data
comma
op_amp
id|hdlc-&gt;state.fr.settings
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ifr-&gt;ifr_settings.data_length
op_assign
id|size
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_PROTO_FR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.data_length
op_ne
id|size
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* incorrect data length */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|hdlc-&gt;state.fr.settings
comma
id|ifr-&gt;ifr_settings.data
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* FIXME - put sanity checks here */
r_if
c_cond
(paren
id|hdlc-&gt;proto
op_ne
id|IF_PROTO_FR
)paren
(brace
id|hdlc_detach
c_func
(paren
id|hdlc
)paren
suffix:semicolon
id|hdlc-&gt;state.fr.first_pvc
op_assign
l_int|NULL
suffix:semicolon
id|hdlc-&gt;state.fr.pvc_count
op_assign
l_int|0
suffix:semicolon
)brace
id|result
op_assign
id|hdlc
op_member_access_from_pointer
id|attach
c_func
(paren
id|hdlc
comma
id|ENCODING_NRZ
comma
id|PARITY_CRC16_PR1_CCITT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|hdlc-&gt;proto
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|hdlc-&gt;open
op_assign
id|fr_open
suffix:semicolon
id|hdlc-&gt;stop
op_assign
id|fr_close
suffix:semicolon
id|hdlc-&gt;netif_rx
op_assign
id|fr_rx
suffix:semicolon
id|hdlc-&gt;detach
op_assign
id|fr_destroy
suffix:semicolon
id|hdlc-&gt;proto
op_assign
id|IF_PROTO_FR
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|hdlc-&gt;xmit
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|fr_hard_header
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_FRAD
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|2
suffix:semicolon
op_star
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
c_func
(paren
id|LMI_DLCI
)paren
suffix:semicolon
id|dlci_to_q922
c_func
(paren
id|dev-&gt;broadcast
comma
id|LMI_DLCI
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_PROTO_FR_ADD_PVC
suffix:colon
r_case
id|IF_PROTO_FR_DEL_PVC
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|pvc
comma
id|ifr-&gt;ifr_settings.data
comma
r_sizeof
(paren
id|fr_proto_pvc
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|fr_pvc
c_func
(paren
id|hdlc
comma
id|pvc.dlci
comma
id|ifr-&gt;ifr_settings.type
op_eq
id|IF_PROTO_FR_ADD_PVC
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
eof
