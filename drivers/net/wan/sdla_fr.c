multiline_comment|/*****************************************************************************&n;* sdla_fr.c&t;WANPIPE(tm) Multiprotocol WAN Link Driver. Frame relay module.&n;*&n;* Author(s):&t;Nenad Corbic  &lt;ncorbic@sangoma.com&gt;&n;*&t;&t;Gideon Hack&n;*&n;* Copyright:&t;(c) 1995-2001 Sangoma Technologies Inc.&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;* Nov 23, 2000  Nenad Corbic    o Added support for 2.4.X kernels&n;* Nov 15, 2000  David Rokavarg  &n;*               Nenad Corbic&t;o Added frame relay bridging support.&n;* &t;&t;&t;&t;  Original code from Mark Wells and Kristian Hoffmann has&n;* &t;&t;&t;&t;  been integrated into the frame relay driver.&n;* Nov 13, 2000  Nenad Corbic    o Added true interface type encoding option.&n;* &t;&t;&t;&t;  Tcpdump doesn&squot;t support Frame Relay inteface&n;* &t;&t;&t;&t;  types, to fix this true type option will set&n;* &t;&t;&t;&t;  the interface type to RAW IP mode.&n;* Nov 07, 2000  Nenad Corbic&t;o Added security features for UDP debugging:&n;*                                 Deny all and specify allowed requests.&n;* Nov 06, 2000  Nenad Corbic&t;o Wanpipe interfaces conform to raw packet interfaces.  &n;*                                 Moved the if_header into the if_send() routine.&n;*                                 The if_header() was breaking the libpcap &n;*                                 support. i.e. support for tcpdump, ethereal ...&n;* Oct 12. 2000  Nenad Corbic    o Added error message in fr_configure&n;* Jul 31, 2000  Nenad Corbic&t;o Fixed the Router UP Time.&n;* Apr 28, 2000  Nenad Corbic&t;o Added the option to shutdown an interface&n;*                                 when the channel gets disconnected.&n;* Apr 28, 2000  Nenad Corbic &t;o Added M.Grants patch: disallow duplicate&n;*                                 interface setups. &n;* Apr 25, 2000  Nenad Corbic&t;o Added M.Grants patch: dynamically add/remove &n;*                                 new dlcis/interfaces.&n;* Mar 23, 2000  Nenad Corbic &t;o Improved task queue, bh handling.&n;* Mar 16, 2000&t;Nenad Corbic&t;o Added Inverse ARP support&n;* Mar 13, 2000  Nenad Corbic&t;o Added new socket API support.&n;* Mar 06, 2000  Nenad Corbic&t;o Bug Fix: corrupted mbox recovery.&n;* Feb 24, 2000  Nenad Corbic    o Fixed up FT1 UDP debugging problem.&n;* Dev 15, 1999  Nenad Corbic    o Fixed up header files for 2.0.X kernels&n;*&n;* Nov 08, 1999  Nenad Corbic    o Combined all debug UDP calls into one function&n;*                               o Removed the ARP support. This has to be done&n;*                                 in the next version.&n;*                               o Only a Node can implement NO signalling.&n;*                                 Initialize DLCI during if_open() if NO &n;*&t;&t;&t;&t;  signalling.&n;*&t;&t;&t;&t;o Took out IPX support, implement in next&n;*                                 version&n;* Sep 29, 1999  Nenad Corbic&t;o Added SMP support and changed the update&n;*                                 function to use timer interrupt.&n;*&t;&t;&t;&t;o Fixed the CIR bug:  Set the value of BC&n;*                                 to CIR when the CIR is enabled.&n;*  &t;&t;&t;&t;o Updated comments, statistics and tracing.&n;* Jun 02, 1999&t;Gideon Hack&t;o Updated for S514 support.&n;* Sep 18, 1998&t;Jaspreet Singh&t;o Updated for 2.2.X kernels.&n;* Jul 31, 1998&t;Jaspreet Singh&t;o Removed wpf_poll routine.  The channel/DLCI &n;*&t;&t;&t;&t;  status is received through an event interrupt.&n;* Jul 08, 1998&t;David Fong&t;o Added inverse ARP support.&n;* Mar 26, 1997&t;Jaspreet Singh&t;o Returning return codes for failed UDP cmds.&n;* Jan 28, 1997&t;Jaspreet Singh  o Improved handling of inactive DLCIs.&n;* Dec 30, 1997&t;Jaspreet Singh&t;o Replaced dev_tint() with mark_bh(NET_BH)&n;* Dec 16, 1997&t;Jaspreet Singh&t;o Implemented Multiple IPX support.&n;* Nov 26, 1997&t;Jaspreet Singh&t;o Improved load sharing with multiple boards&n;*&t;&t;&t;&t;o Added Cli() to protect enabling of interrupts&n;*&t;&t;&t;&t;  while polling is called.&n;* Nov 24, 1997&t;Jaspreet Singh&t;o Added counters to avoid enabling of interrupts&n;*&t;&t;&t;&t;  when they have been disabled by another&n;*&t;&t;&t;&t;  interface or routine (eg. wpf_poll).&n;* Nov 06, 1997&t;Jaspreet Singh&t;o Added INTR_TEST_MODE to avoid polling&t;&n;*&t;&t;&t;&t;  routine disable interrupts during interrupt&n;*&t;&t;&t;&t;  testing.&n;* Oct 20, 1997  Jaspreet Singh  o Added hooks in for Router UP time.&n;* Oct 16, 1997  Jaspreet Singh  o The critical flag is used to maintain flow&n;*                                 control by avoiding RACE conditions.  The&n;*                                 cli() and restore_flags() are taken out.&n;*                                 The fr_channel structure is appended for &n;*                                 Driver Statistics.&n;* Oct 15, 1997  Farhan Thawar    o updated if_send() and receive for IPX&n;* Aug 29, 1997  Farhan Thawar    o Removed most of the cli() and sti()&n;*                                o Abstracted the UDP management stuff&n;*                                o Now use tbusy and critical more intelligently&n;* Jul 21, 1997  Jaspreet Singh&t; o Can configure T391, T392, N391, N392 &amp; N393&n;*&t;&t;&t;&t;   through router.conf.&n;*&t;&t;&t;&t; o Protected calls to sdla_peek() by adDing &n;*&t;&t;&t;&t;   save_flags(), cli() and restore_flags().&n;*&t;&t;&t;&t; o Added error message for Inactive DLCIs in&n;*&t;&t;&t;&t;   fr_event() and update_chan_state().&n;*&t;&t;&t;&t; o Fixed freeing up of buffers using kfree() &n;*&t;&t;&t;           when packets are received.&n;* Jul 07, 1997&t;Jaspreet Singh&t; o Added configurable TTL for UDP packets &n;*&t;&t;&t;&t; o Added ability to discard multicast and &n;*&t;&t;&t;&t;   broadcast source addressed packets&n;* Jun 27, 1997&t;Jaspreet Singh&t; o Added FT1 monitor capabilities &n;*&t;&t;&t;&t;   New case (0x44) statement in if_send routine &n;*&t;&t;&t;&t;   Added a global variable rCount to keep track&n;*&t;&t;&t; &t;   of FT1 status enabled on the board.&n;* May 29, 1997&t;Jaspreet Singh&t; o Fixed major Flow Control Problem&n;*&t;&t;&t;&t;   With multiple boards a problem was seen where&n;*&t;&t;&t;&t;   the second board always stopped transmitting&n;*&t;&t;&t;&t;   packet after running for a while. The code&n;*&t;&t;&t;&t;   got into a stage where the interrupts were&n;*&t;&t;&t;&t;   disabled and dev-&gt;tbusy was set to 1.&n;*                  &t;&t;   This caused the If_send() routine to get into&n;*                                  the if clause for it(0,dev-&gt;tbusy) &n;*&t;&t;&t;&t;   forever.&n;*&t;&t;&t;&t;   The code got into this stage due to an &n;*&t;&t;&t;&t;   interrupt occuring within the if clause for &n;*&t;&t;&t;&t;   set_bit(0,dev-&gt;tbusy).  Since an interrupt &n;*&t;&t;&t;&t;   disables furhter transmit interrupt and &n;* &t;&t;&t;&t;   makes dev-&gt;tbusy = 0, this effect was undone &n;*                                  by making dev-&gt;tbusy = 1 in the if clause.&n;*&t;&t;&t;&t;   The Fix checks to see if Transmit interrupts&n;*&t;&t;&t;&t;   are disabled then do not make dev-&gt;tbusy = 1&n;* &t;   &t;&t;&t;   Introduced a global variable: int_occur and&n;*&t;&t;&t;&t;   added tx_int_enabled in the wan_device &n;*&t;&t;&t;&t;   structure.&t;&n;* May 21, 1997  Jaspreet Singh   o Fixed UDP Management for multiple&n;*                                  boards.&n;*&n;* Apr 25, 1997  Farhan Thawar    o added UDP Management stuff&n;*                                o fixed bug in if_send() and tx_intr() to&n;*                                  sleep and wakeup all devices&n;* Mar 11, 1997  Farhan Thawar   Version 3.1.1&n;*                                o fixed (+1) bug in fr508_rx_intr()&n;*                                o changed if_send() to return 0 if&n;*                                  wandev.critical() is true&n;*                                o free socket buffer in if_send() if&n;*                                  returning 0 &n;*                                o added tx_intr() routine&n;* Jan 30, 1997&t;Gene Kozin&t;Version 3.1.0&n;*&t;&t;&t;&t; o implemented exec() entry point&n;*&t;&t;&t;&t; o fixed a bug causing driver configured as&n;*&t;&t;&t;&t;   a FR switch to be stuck in WAN_&n;*&t;&t;&t;&t;   mode&n;* Jan 02, 1997&t;Gene Kozin&t;Initial version.&n;*****************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;&t;/* printk(), and other useful stuff */
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline memset(), etc. */
macro_line|#include &lt;linux/slab.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router definitions */
macro_line|#include &lt;linux/wanpipe.h&gt;&t;/* WANPIPE common user API definitions */
macro_line|#include &lt;linux/if_arp.h&gt;&t;/* ARPHRD_* defines */
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;asm/io.h&gt;&t;&t;/* for inb(), outb(), etc. */
macro_line|#include &lt;linux/time.h&gt;&t; &t;/* for do_gettimeofday */&t;
macro_line|#include &lt;linux/in.h&gt;&t;&t;/* sockaddr_in */
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/if_wanpipe_common.h&gt;&t;/* Wanpipe Socket */
macro_line|#include &lt;linux/if_wanpipe.h&gt;&t;
macro_line|#include &lt;linux/sdla_fr.h&gt;&t;&t;/* frame relay firmware API definitions */
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;net/route.h&gt;          &t;/* Dynamic Route Creation */
macro_line|#include &lt;linux/etherdevice.h&gt;&t;&t;/* eth_type_trans() used for bridging */
macro_line|#include &lt;linux/random.h&gt;
multiline_comment|/****** Defines &amp; Macros ****************************************************/
DECL|macro|MAX_CMD_RETRY
mdefine_line|#define&t;MAX_CMD_RETRY&t;10&t;&t;/* max number of firmware retries */
DECL|macro|FR_HEADER_LEN
mdefine_line|#define&t;FR_HEADER_LEN&t;8&t;&t;/* max encapsulation header size */
DECL|macro|FR_CHANNEL_MTU
mdefine_line|#define&t;FR_CHANNEL_MTU&t;1500&t;&t;/* unfragmented logical channel MTU */
multiline_comment|/* Q.922 frame types */
DECL|macro|Q922_UI
mdefine_line|#define&t;Q922_UI&t;&t;0x03&t;&t;/* Unnumbered Info frame */
DECL|macro|Q922_XID
mdefine_line|#define&t;Q922_XID&t;0xAF&t;&t;
multiline_comment|/* DLCI configured or not */
DECL|macro|DLCI_NOT_CONFIGURED
mdefine_line|#define DLCI_NOT_CONFIGURED&t;0x00
DECL|macro|DLCI_CONFIG_PENDING
mdefine_line|#define DLCI_CONFIG_PENDING&t;0x01
DECL|macro|DLCI_CONFIGURED
mdefine_line|#define DLCI_CONFIGURED&t;&t;0x02
multiline_comment|/* CIR enabled or not */
DECL|macro|CIR_ENABLED
mdefine_line|#define CIR_ENABLED&t;0x00
DECL|macro|CIR_DISABLED
mdefine_line|#define CIR_DISABLED&t;0x01
DECL|macro|FRAME_RELAY_API
mdefine_line|#define FRAME_RELAY_API 1
DECL|macro|MAX_BH_BUFF
mdefine_line|#define MAX_BH_BUFF&t;10
multiline_comment|/* For handle_IPXWAN() */
DECL|macro|CVHexToAscii
mdefine_line|#define CVHexToAscii(b) (((unsigned char)(b) &gt; (unsigned char)9) ? ((unsigned char)&squot;A&squot; + ((unsigned char)(b) - (unsigned char)10)) : ((unsigned char)&squot;0&squot; + (unsigned char)(b)))
multiline_comment|/****** Data Structures *****************************************************/
multiline_comment|/* This is an extention of the &squot;struct device&squot; we create for each network&n; * interface to keep the rest of channel-specific data.&n; */
DECL|struct|fr_channel
r_typedef
r_struct
id|fr_channel
(brace
DECL|member|common
id|wanpipe_common_t
id|common
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
id|WAN_IFNAME_SZ
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* interface name, ASCIIZ */
DECL|member|dlci_configured
r_int
id|dlci_configured
suffix:semicolon
multiline_comment|/* check whether configured or not */
DECL|member|cir_status
r_int
id|cir_status
suffix:semicolon
multiline_comment|/* check whether CIR enabled or not */
DECL|member|dlci
r_int
id|dlci
suffix:semicolon
multiline_comment|/* logical channel number */
DECL|member|cir
r_int
id|cir
suffix:semicolon
multiline_comment|/* committed information rate */
DECL|member|bc
r_int
id|bc
suffix:semicolon
multiline_comment|/* committed burst size */
DECL|member|be
r_int
id|be
suffix:semicolon
multiline_comment|/* excess burst size */
DECL|member|mc
r_int
id|mc
suffix:semicolon
multiline_comment|/* multicast support on or off */
DECL|member|tx_int_status
r_int
id|tx_int_status
suffix:semicolon
multiline_comment|/* Transmit Interrupt Status */
DECL|member|pkt_length
r_int
r_int
id|pkt_length
suffix:semicolon
multiline_comment|/* Packet Length */
DECL|member|router_start_time
r_int
r_int
id|router_start_time
suffix:semicolon
multiline_comment|/* Router start time in seconds */
DECL|member|tick_counter
r_int
r_int
id|tick_counter
suffix:semicolon
multiline_comment|/* counter for transmit time out */
DECL|member|dev_pending_devtint
r_char
id|dev_pending_devtint
suffix:semicolon
multiline_comment|/* interface pending dev_tint() */
DECL|member|dlci_int_interface
r_void
op_star
id|dlci_int_interface
suffix:semicolon
multiline_comment|/* pointer to the DLCI Interface */
DECL|member|IB_addr
r_int
r_int
id|IB_addr
suffix:semicolon
multiline_comment|/* physical address of Interface Byte */
DECL|member|state_tick
r_int
r_int
id|state_tick
suffix:semicolon
multiline_comment|/* time of the last state change */
DECL|member|enable_IPX
r_int
r_char
id|enable_IPX
suffix:semicolon
multiline_comment|/* Enable/Disable the use of IPX */
DECL|member|network_number
r_int
r_int
id|network_number
suffix:semicolon
multiline_comment|/* Internal Network Number for IPX*/
DECL|member|card
id|sdla_t
op_star
id|card
suffix:semicolon
multiline_comment|/* -&gt; owner */
DECL|member|route_flag
r_int
id|route_flag
suffix:semicolon
multiline_comment|/* Add/Rem dest addr in route tables */
DECL|member|inarp
r_int
id|inarp
suffix:semicolon
multiline_comment|/* Inverse Arp Request status */
DECL|member|inarp_ready
r_int
r_char
id|inarp_ready
suffix:semicolon
multiline_comment|/* Ready to send requests */
DECL|member|inarp_interval
r_int
id|inarp_interval
suffix:semicolon
multiline_comment|/* Time between InArp Requests */
DECL|member|inarp_tick
r_int
r_int
id|inarp_tick
suffix:semicolon
multiline_comment|/* InArp jiffies tick counter */
DECL|member|interface_down
r_int
r_char
id|interface_down
suffix:semicolon
multiline_comment|/* Bring interface down on disconnect */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
DECL|member|ifstats
r_struct
id|net_device_stats
id|ifstats
suffix:semicolon
multiline_comment|/* interface statistics */
macro_line|#else
DECL|member|ifstats
r_struct
id|enet_statistics
id|ifstats
suffix:semicolon
macro_line|#endif&t;
DECL|member|drvstats_if_send
id|if_send_stat_t
id|drvstats_if_send
suffix:semicolon
DECL|member|drvstats_rx_intr
id|rx_intr_stat_t
id|drvstats_rx_intr
suffix:semicolon
DECL|member|drvstats_gen
id|pipe_mgmt_stat_t
id|drvstats_gen
suffix:semicolon
DECL|member|router_up_time
r_int
r_int
id|router_up_time
suffix:semicolon
DECL|member|transmit_length
r_int
r_int
id|transmit_length
suffix:semicolon
DECL|member|delay_skb
r_struct
id|sk_buff
op_star
id|delay_skb
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
DECL|member|bh_head
id|bh_data_t
op_star
id|bh_head
suffix:semicolon
multiline_comment|/* Circular buffer for chdlc_bh */
DECL|member|tq_working
r_int
r_int
id|tq_working
suffix:semicolon
DECL|member|bh_write
r_volatile
r_int
id|bh_write
suffix:semicolon
DECL|member|bh_read
r_volatile
r_int
id|bh_read
suffix:semicolon
DECL|member|bh_buff_used
id|atomic_t
id|bh_buff_used
suffix:semicolon
macro_line|#endif
multiline_comment|/* Polling task queue. Each interface&n;         * has its own task queue, which is used&n;         * to defer events from the interrupt */
DECL|member|fr_poll_task
r_struct
id|tq_struct
id|fr_poll_task
suffix:semicolon
DECL|member|fr_arp_timer
r_struct
id|timer_list
id|fr_arp_timer
suffix:semicolon
DECL|member|ip_local
id|u32
id|ip_local
suffix:semicolon
DECL|member|ip_remote
id|u32
id|ip_remote
suffix:semicolon
DECL|member|config_dlci
id|u8
id|config_dlci
suffix:semicolon
DECL|member|unconfig_dlci
id|u32
id|unconfig_dlci
suffix:semicolon
multiline_comment|/* Whether this interface should be setup as a gateway.&n;&t; * Used by dynamic route setup code */
DECL|member|gateway
id|u8
id|gateway
suffix:semicolon
multiline_comment|/* True interface type */
DECL|member|true_if_encoding
id|u8
id|true_if_encoding
suffix:semicolon
DECL|member|fr_header
id|u8
id|fr_header
(braket
id|FR_HEADER_LEN
)braket
suffix:semicolon
DECL|member|fr_header_len
r_char
id|fr_header_len
suffix:semicolon
DECL|typedef|fr_channel_t
)brace
id|fr_channel_t
suffix:semicolon
multiline_comment|/* Route Flag options */
DECL|macro|NO_ROUTE
mdefine_line|#define NO_ROUTE&t;0x00
DECL|macro|ADD_ROUTE
mdefine_line|#define ADD_ROUTE &t;0x01
DECL|macro|ROUTE_ADDED
mdefine_line|#define ROUTE_ADDED&t;0x02
DECL|macro|REMOVE_ROUTE
mdefine_line|#define REMOVE_ROUTE &t;0x03
DECL|macro|ARP_REQ
mdefine_line|#define ARP_REQ&t;&t;0x04
multiline_comment|/* inarp options */
DECL|macro|INARP_NONE
mdefine_line|#define INARP_NONE&t;&t;0x00
DECL|macro|INARP_REQUEST
mdefine_line|#define INARP_REQUEST&t;&t;0x01
DECL|macro|INARP_CONFIGURED
mdefine_line|#define INARP_CONFIGURED&t;0x02
multiline_comment|/* reasons for enabling the timer interrupt on the adapter */
DECL|macro|TMR_INT_ENABLED_UDP
mdefine_line|#define TMR_INT_ENABLED_UDP   &t;0x01
DECL|macro|TMR_INT_ENABLED_UPDATE
mdefine_line|#define TMR_INT_ENABLED_UPDATE &t;0x02
DECL|macro|TMR_INT_ENABLED_ARP
mdefine_line|#define TMR_INT_ENABLED_ARP&t;0x04
DECL|macro|TMR_INT_ENABLED_UPDATE_STATE
mdefine_line|#define TMR_INT_ENABLED_UPDATE_STATE &t;0x08
DECL|macro|TMR_INT_ENABLED_CONFIG
mdefine_line|#define TMR_INT_ENABLED_CONFIG&t;0x10
DECL|macro|TMR_INT_ENABLED_UNCONFIG
mdefine_line|#define TMR_INT_ENABLED_UNCONFIG&t;0x20
DECL|struct|dlci_status
r_typedef
r_struct
id|dlci_status
(brace
DECL|member|PACKED
r_int
r_int
id|dlci
id|PACKED
suffix:semicolon
DECL|member|PACKED
r_int
r_char
id|state
id|PACKED
suffix:semicolon
DECL|typedef|dlci_status_t
)brace
id|dlci_status_t
suffix:semicolon
DECL|struct|dlci_IB_mapping
r_typedef
r_struct
id|dlci_IB_mapping
(brace
DECL|member|PACKED
r_int
r_int
id|dlci
id|PACKED
suffix:semicolon
DECL|member|PACKED
r_int
r_int
id|addr_value
id|PACKED
suffix:semicolon
DECL|typedef|dlci_IB_mapping_t
)brace
id|dlci_IB_mapping_t
suffix:semicolon
multiline_comment|/* This structure is used for DLCI list Tx interrupt mode.  It is used to&n;   enable interrupt bit and set the packet length for transmission&n; */
DECL|struct|fr_dlci_interface
r_typedef
r_struct
id|fr_dlci_interface
(brace
DECL|member|PACKED
r_int
r_char
id|gen_interrupt
id|PACKED
suffix:semicolon
DECL|member|PACKED
r_int
r_int
id|packet_length
id|PACKED
suffix:semicolon
DECL|member|PACKED
r_int
r_char
id|reserved
id|PACKED
suffix:semicolon
DECL|typedef|fr_dlci_interface_t
)brace
id|fr_dlci_interface_t
suffix:semicolon
multiline_comment|/* variable for keeping track of enabling/disabling FT1 monitor status */
DECL|variable|rCount
r_static
r_int
id|rCount
op_assign
l_int|0
suffix:semicolon
r_extern
r_void
id|disable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|enable_irq
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* variable for keeping track of number of interrupts generated during &n; * interrupt test routine &n; */
DECL|variable|Intr_test_counter
r_static
r_int
id|Intr_test_counter
suffix:semicolon
multiline_comment|/****** Function Prototypes *************************************************/
multiline_comment|/* WAN link driver entry points. These are called by the WAN router module. */
r_static
r_int
id|update
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
suffix:semicolon
r_static
r_int
id|new_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
id|netdevice_t
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|del_if
c_func
(paren
id|wan_device_t
op_star
id|wandev
comma
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|disable_comm
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* WANPIPE-specific entry points */
r_static
r_int
id|wpf_exec
c_func
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
suffix:semicolon
multiline_comment|/* Network device interface */
r_static
r_int
id|if_init
c_func
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_open
c_func
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|if_close
c_func
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
macro_line|#ifdef LINUX_2_4
r_static
r_void
id|if_tx_timeout
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
macro_line|#else
r_static
r_int
id|if_rebuild_hdr
(paren
r_void
op_star
id|hdr
comma
id|netdevice_t
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|if_send
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|chk_bcast_mcast_addr
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
c_func
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
macro_line|#else
r_static
r_struct
id|enet_statistics
op_star
id|if_stats
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Interrupt handlers */
r_static
r_void
id|fr_isr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|rx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|tx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|timer_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|spur_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Frame relay firmware interface functions */
r_static
r_int
id|fr_read_version
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_int
id|fr_configure
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_conf_t
op_star
id|conf
)paren
suffix:semicolon
r_static
r_int
id|fr_dlci_configure
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_dlc_conf_t
op_star
id|conf
comma
r_int
id|dlci
)paren
suffix:semicolon
r_static
r_int
id|fr_init_dlci
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_int
id|fr_set_intr_mode
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
comma
r_int
id|mtu
comma
r_int
r_int
id|timeout
)paren
suffix:semicolon
r_static
r_int
id|fr_comm_enable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|fr_comm_disable
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|fr_get_err_stats
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|fr_get_stats
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|fr_add_dlci
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
suffix:semicolon
r_static
r_int
id|fr_activate_dlci
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
suffix:semicolon
r_static
r_int
id|fr_delete_dlci
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
suffix:semicolon
r_static
r_int
id|fr_issue_isf
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|isf
)paren
suffix:semicolon
r_static
r_int
id|fr_send
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
r_char
id|attr
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|fr_send_data_header
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
r_char
id|attr
comma
r_int
id|len
comma
r_void
op_star
id|buf
comma
r_int
r_char
id|hdr_len
)paren
suffix:semicolon
r_static
r_int
r_int
id|fr_send_hdr
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
r_int
id|offset
)paren
suffix:semicolon
r_static
r_int
id|check_dlci_config
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_void
id|initialize_rx_tx_buffers
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/* Firmware asynchronous event handlers */
r_static
r_int
id|fr_event
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|event
comma
id|fr_mbox_t
op_star
id|mbox
)paren
suffix:semicolon
r_static
r_int
id|fr_modem_failure
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_mbox_t
op_star
id|mbox
)paren
suffix:semicolon
r_static
r_int
id|fr_dlci_change
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_mbox_t
op_star
id|mbox
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous functions */
r_static
r_int
id|update_chan_state
c_func
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_chan_state
c_func
(paren
id|netdevice_t
op_star
id|dev
comma
r_int
id|state
)paren
suffix:semicolon
r_static
id|netdevice_t
op_star
id|find_channel
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
suffix:semicolon
r_static
r_int
id|is_tx_ready
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_int
r_int
id|dec_to_uint
c_func
(paren
r_int
r_char
op_star
id|str
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|reply_udp
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|mbox_len
)paren
suffix:semicolon
r_static
r_int
id|intr_test
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|init_chan_statistics
c_func
(paren
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_void
id|init_global_statistics
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|read_DLCI_IB_mapping
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_int
id|setup_for_delayed_transmit
c_func
(paren
id|netdevice_t
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
id|netdevice_t
op_star
id|move_dev_to_next
(paren
id|sdla_t
op_star
comma
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|check_tx_status
c_func
(paren
id|sdla_t
op_star
comma
id|netdevice_t
op_star
)paren
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/* Frame Relay Socket API */
r_static
r_void
id|trigger_fr_bh
(paren
id|fr_channel_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|fr_bh
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|fr_bh_cleanup
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|bh_enqueue
(paren
id|netdevice_t
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|trigger_fr_poll
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|fr_poll
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
singleline_comment|//static void add_gateway (netdevice_t *);
r_static
r_void
id|trigger_unconfig_fr
(paren
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|unconfig_fr
(paren
id|sdla_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|trigger_config_fr
(paren
id|sdla_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|config_fr
(paren
id|sdla_t
op_star
)paren
suffix:semicolon
multiline_comment|/* Inverse ARP and Dynamic routing functions */
r_int
id|process_ARP
c_func
(paren
id|arphdr_1490_t
op_star
id|ArpPacket
comma
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_int
id|is_arp
c_func
(paren
r_void
op_star
id|buf
)paren
suffix:semicolon
r_int
id|send_inarp_request
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|trigger_fr_arp
(paren
id|netdevice_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|fr_arp
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
multiline_comment|/* Udp management functions */
r_static
r_int
id|process_udp_mgmt_pkt
c_func
(paren
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|udp_pkt_type
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|sdla_t
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|store_udp_mgmt_pkt
c_func
(paren
r_int
id|udp_type
comma
r_char
id|udp_pkt_src
comma
id|sdla_t
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|dlci
)paren
suffix:semicolon
multiline_comment|/* IPX functions */
r_static
r_void
id|switch_net_numbers
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_int
r_int
id|network_number
comma
r_int
r_char
id|incoming
)paren
suffix:semicolon
r_static
r_int
id|handle_IPXWAN
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_char
op_star
id|devname
comma
r_int
r_char
id|enable_IPX
comma
r_int
r_int
id|network_number
)paren
suffix:semicolon
multiline_comment|/* Lock Functions: SMP supported */
r_void
id|s508_s514_unlock
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
suffix:semicolon
r_void
id|s508_s514_lock
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
suffix:semicolon
r_int
r_int
id|calc_checksum
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|setup_fr_header
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
comma
r_char
id|op_mode
)paren
suffix:semicolon
multiline_comment|/****** Public Functions ****************************************************/
multiline_comment|/*============================================================================&n; * Frame relay protocol initialization routine.&n; *&n; * This routine is called by the main WANPIPE module during setup.  At this&n; * point adapter is completely initialized and firmware is running.&n; *  o read firmware version (to make sure it&squot;s alive)&n; *  o configure adapter&n; *  o initialize protocol-specific fields of the adapter data space.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure.&n; */
DECL|function|wpf_init
r_int
id|wpf_init
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|wandev_conf_t
op_star
id|conf
)paren
(brace
r_int
id|err
suffix:semicolon
id|fr508_flags_t
op_star
id|flags
suffix:semicolon
r_union
(brace
r_char
id|str
(braket
l_int|80
)braket
suffix:semicolon
id|fr_conf_t
id|cfg
suffix:semicolon
)brace
id|u
suffix:semicolon
id|fr_buf_info_t
op_star
id|buf_info
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Verify configuration ID */
r_if
c_cond
(paren
id|conf-&gt;config_id
op_ne
id|WANCONFIG_FR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: invalid configuration ID %u!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|conf-&gt;config_id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Initialize protocol-specific fields of adapter data space */
r_switch
c_cond
(paren
id|card-&gt;hw.fwid
)paren
(brace
r_case
id|SFID_FR508
suffix:colon
id|card-&gt;mbox
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR508_MBOX_OFFS
)paren
suffix:semicolon
id|card-&gt;flags
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR508_FLAG_OFFS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|card-&gt;mbox
op_add_assign
id|FR_MB_VECTOR
suffix:semicolon
id|card-&gt;flags
op_add_assign
id|FR_MB_VECTOR
suffix:semicolon
)brace
id|card-&gt;isr
op_assign
op_amp
id|fr_isr
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
multiline_comment|/* Read firmware version.  Note that when adapter initializes, it&n;&t; * clears the mailbox, so it may appear that the first command was&n;&t; * executed successfully when in fact it was merely erased. To work&n;&t; * around this, we execute the first command twice.&n;&t; */
r_if
c_cond
(paren
id|fr_read_version
c_func
(paren
id|card
comma
l_int|NULL
)paren
op_logical_or
id|fr_read_version
c_func
(paren
id|card
comma
id|u.str
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: running frame relay firmware v%s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|u.str
)paren
suffix:semicolon
multiline_comment|/* Adjust configuration */
id|conf-&gt;mtu
op_add_assign
id|FR_HEADER_LEN
suffix:semicolon
id|conf-&gt;mtu
op_assign
(paren
id|conf-&gt;mtu
op_ge
id|MIN_LGTH_FR_DATA_CFG
)paren
ques
c_cond
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;mtu
comma
id|FR_MAX_NO_DATA_BYTES_IN_FRAME
)paren
suffix:colon
id|FR_CHANNEL_MTU
op_plus
id|FR_HEADER_LEN
suffix:semicolon
id|conf-&gt;bps
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;bps
comma
l_int|2048000
)paren
suffix:semicolon
multiline_comment|/* Initialze the configuration structure sent to the board to zero */
id|memset
c_func
(paren
op_amp
id|u.cfg
comma
l_int|0
comma
r_sizeof
(paren
id|u.cfg
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|card-&gt;u.f.dlci_to_dev_map
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;u.f.dlci_to_dev_map
)paren
)paren
suffix:semicolon
multiline_comment|/* Configure adapter firmware */
id|u.cfg.mtu
op_assign
id|conf-&gt;mtu
suffix:semicolon
id|u.cfg.kbps
op_assign
id|conf-&gt;bps
op_div
l_int|1000
suffix:semicolon
id|u.cfg.cir_fwd
op_assign
id|u.cfg.cir_bwd
op_assign
l_int|16
suffix:semicolon
id|u.cfg.bc_fwd
op_assign
id|u.cfg.bc_bwd
op_assign
l_int|16
suffix:semicolon
id|u.cfg.options
op_assign
l_int|0x0000
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Global CIR enabled by Default&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|conf-&gt;u.fr.signalling
)paren
(brace
r_case
id|WANOPT_FR_ANSI
suffix:colon
id|u.cfg.options
op_assign
l_int|0x0000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WANOPT_FR_Q933
suffix:colon
id|u.cfg.options
op_or_assign
l_int|0x0200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WANOPT_FR_LMI
suffix:colon
id|u.cfg.options
op_or_assign
l_int|0x0400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WANOPT_NO
suffix:colon
id|u.cfg.options
op_or_assign
l_int|0x0800
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Illegal Signalling option&bslash;n&quot;
comma
id|card-&gt;wandev.name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|card-&gt;wandev.signalling
op_assign
id|conf-&gt;u.fr.signalling
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;station
op_eq
id|WANOPT_CPE
)paren
(brace
r_if
c_cond
(paren
id|conf-&gt;u.fr.signalling
op_eq
id|WANOPT_NO
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR - For NO signalling, station must be set to Node!&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|u.cfg.station
op_assign
l_int|0
suffix:semicolon
id|u.cfg.options
op_or_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* auto config DLCI */
id|card-&gt;u.f.dlci_num
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|u.cfg.station
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* switch emulation mode */
multiline_comment|/* For switch emulation we have to create a list of dlci(s)&n;&t;&t; * that will be sent to be global SET_DLCI_CONFIGURATION &n;&t;&t; * command in fr_configure() routine. &n;&t;&t; */
id|card-&gt;u.f.dlci_num
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|max_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;u.fr.dlci_num
comma
l_int|1
)paren
comma
l_int|100
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;u.f.dlci_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;u.f.node_dlci
(braket
id|i
)braket
op_assign
(paren
r_int
r_int
)paren
id|conf-&gt;u.fr.dlci
(braket
id|i
)braket
ques
c_cond
id|conf-&gt;u.fr.dlci
(braket
id|i
)braket
suffix:colon
l_int|16
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|conf-&gt;clocking
op_eq
id|WANOPT_INTERNAL
)paren
id|u.cfg.port
op_or_assign
l_int|0x0001
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;interface
op_eq
id|WANOPT_RS232
)paren
id|u.cfg.port
op_or_assign
l_int|0x0002
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.t391
)paren
id|u.cfg.t391
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;u.fr.t391
comma
l_int|30
)paren
suffix:semicolon
r_else
id|u.cfg.t391
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.t392
)paren
id|u.cfg.t392
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;u.fr.t392
comma
l_int|30
)paren
suffix:semicolon
r_else
id|u.cfg.t392
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.n391
)paren
id|u.cfg.n391
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;u.fr.n391
comma
l_int|255
)paren
suffix:semicolon
r_else
id|u.cfg.n391
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.n392
)paren
id|u.cfg.n392
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;u.fr.n392
comma
l_int|10
)paren
suffix:semicolon
r_else
id|u.cfg.n392
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;u.fr.n393
)paren
id|u.cfg.n393
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;u.fr.n393
comma
l_int|10
)paren
suffix:semicolon
r_else
id|u.cfg.n393
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|fr_configure
c_func
(paren
id|card
comma
op_amp
id|u.cfg
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|buf_info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR_MB_VECTOR
op_plus
id|FR508_RXBC_OFFS
)paren
suffix:semicolon
id|card-&gt;rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_next
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_last
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_plus
(paren
id|buf_info-&gt;rse_num
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
id|fr_rx_buf_ctl_t
)paren
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
)brace
r_else
(brace
id|buf_info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR508_RXBC_OFFS
)paren
suffix:semicolon
id|card-&gt;rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_next
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_last
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_plus
(paren
id|buf_info-&gt;rse_num
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
id|fr_rx_buf_ctl_t
)paren
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
)brace
id|card-&gt;u.f.rx_base
op_assign
id|buf_info-&gt;buf_base
suffix:semicolon
id|card-&gt;u.f.rx_top
op_assign
id|buf_info-&gt;buf_top
suffix:semicolon
id|card-&gt;u.f.tx_interrupts_pending
op_assign
l_int|0
suffix:semicolon
id|card-&gt;wandev.mtu
op_assign
id|conf-&gt;mtu
suffix:semicolon
id|card-&gt;wandev.bps
op_assign
id|conf-&gt;bps
suffix:semicolon
id|card-&gt;wandev.interface
op_assign
id|conf-&gt;interface
suffix:semicolon
id|card-&gt;wandev.clocking
op_assign
id|conf-&gt;clocking
suffix:semicolon
id|card-&gt;wandev.station
op_assign
id|conf-&gt;station
suffix:semicolon
id|card-&gt;poll
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;exec
op_assign
op_amp
id|wpf_exec
suffix:semicolon
id|card-&gt;wandev.update
op_assign
op_amp
id|update
suffix:semicolon
id|card-&gt;wandev.new_if
op_assign
op_amp
id|new_if
suffix:semicolon
id|card-&gt;wandev.del_if
op_assign
op_amp
id|del_if
suffix:semicolon
id|card-&gt;wandev.state
op_assign
id|WAN_DISCONNECTED
suffix:semicolon
id|card-&gt;wandev.ttl
op_assign
id|conf-&gt;ttl
suffix:semicolon
id|card-&gt;wandev.udp_port
op_assign
id|conf-&gt;udp_port
suffix:semicolon
id|card-&gt;disable_comm
op_assign
op_amp
id|disable_comm
suffix:semicolon
id|card-&gt;u.f.arp_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Intialize global statistics for a card */
id|init_global_statistics
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Interrupt Test */
id|Intr_test_counter
op_assign
l_int|0
suffix:semicolon
id|card-&gt;intr_mode
op_assign
id|INTR_TEST_MODE
suffix:semicolon
id|err
op_assign
id|intr_test
c_func
(paren
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: End of Interrupt Test rc=0x%x  count=%i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|err
comma
id|Intr_test_counter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_or
(paren
id|Intr_test_counter
OL
id|MAX_INTR_TEST_COUNTER
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Interrupt Test Failed, Counter: %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|Intr_test_counter
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Please choose another interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interrupt Test Passed, Counter: %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|Intr_test_counter
)paren
suffix:semicolon
multiline_comment|/* Apr 28 2000. Nenad Corbic&n;&t; * Enable commnunications here, not in if_open or new_if, since&n;         * interfaces come down when the link is disconnected. &n;         */
multiline_comment|/* If you enable comms and then set ints, you get a Tx int as you&n;&t; * perform the SET_INT_TRIGGERS command. So, we only set int&n;&t; * triggers and then adjust the interrupt mask (to disable Tx ints)&n;&t; * before enabling comms. &n;&t; */
r_if
c_cond
(paren
id|fr_set_intr_mode
c_func
(paren
id|card
comma
(paren
id|FR_INTR_RXRDY
op_or
id|FR_INTR_TXRDY
op_or
id|FR_INTR_DLC
op_or
id|FR_INTR_TIMER
op_or
id|FR_INTR_TX_MULT_DLCIs
)paren
comma
id|card-&gt;wandev.mtu
comma
l_int|0
)paren
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|flags-&gt;imask
op_and_assign
op_complement
(paren
id|FR_INTR_TXRDY
op_or
id|FR_INTR_TIMER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fr_comm_enable
c_func
(paren
id|card
)paren
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;u.f.if_send_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******* WAN Device Driver Entry Points *************************************/
multiline_comment|/*============================================================================&n; * Update device status &amp; statistics.&n; */
DECL|function|update
r_static
r_int
id|update
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
r_volatile
id|sdla_t
op_star
id|card
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|fr508_flags_t
op_star
id|flags
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
id|wandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|wandev
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;state
op_eq
id|WAN_UNCONFIGURED
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
id|card-&gt;u.f.update_comms_stats
op_assign
l_int|1
suffix:semicolon
id|card-&gt;u.f.timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_UPDATE
suffix:semicolon
id|flags-&gt;imask
op_or_assign
id|FR_INTR_TIMER
suffix:semicolon
id|timeout
op_assign
id|jiffies
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;u.f.update_comms_stats
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
(paren
l_int|1
op_star
id|HZ
)paren
)paren
(brace
id|card-&gt;u.f.update_comms_stats
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Create new logical channel.&n; * This routine is called by the router when ROUTER_IFNEW IOCTL is being&n; * handled.&n; * o parse media- and hardware-specific configuration&n; * o make sure that a new channel can be created&n; * o allocate resources, if necessary&n; * o prepare network device structure for registaration.&n; *&n; * Return:&t;0&t;o.k.&n; *&t;&t;&lt; 0&t;failure (channel will not be created)&n; */
DECL|function|new_if
r_static
r_int
id|new_if
(paren
id|wan_device_t
op_star
id|wandev
comma
id|netdevice_t
op_star
id|dev
comma
id|wanif_conf_t
op_star
id|conf
)paren
(brace
id|sdla_t
op_star
id|card
op_assign
id|wandev
op_member_access_from_pointer
r_private
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_int
id|dlci
op_assign
l_int|0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conf-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
id|strlen
c_func
(paren
id|conf-&gt;name
)paren
OG
id|WAN_IFNAME_SZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Invalid interface name!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* allocate and initialize private data */
id|chan
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|fr_channel_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|chan
comma
l_int|0
comma
r_sizeof
(paren
id|fr_channel_t
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|chan-&gt;name
comma
id|conf-&gt;name
)paren
suffix:semicolon
id|chan-&gt;card
op_assign
id|card
suffix:semicolon
multiline_comment|/* verify media address */
r_if
c_cond
(paren
id|is_digit
c_func
(paren
id|conf-&gt;addr
(braket
l_int|0
)braket
)paren
)paren
(brace
id|dlci
op_assign
id|dec_to_uint
c_func
(paren
id|conf-&gt;addr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlci
op_logical_and
(paren
id|dlci
op_le
id|HIGHEST_VALID_DLCI
)paren
)paren
(brace
id|chan-&gt;dlci
op_assign
id|dlci
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Invalid DLCI %u on interface %s!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|dlci
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Invalid media address on interface %s!&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|chan-&gt;true_if_encoding
op_assign
id|conf-&gt;true_if_encoding
)paren
op_eq
id|WANOPT_YES
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Enabling, true interface type encoding.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup wanpipe as a router (WANPIPE) even if it is&n;&t; * a bridged DLCI, or as an API &n;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;WANPIPE&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;BRIDGE&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;BRIDGE_N&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;WANPIPE&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|chan-&gt;common.usedby
op_assign
id|WANPIPE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Running in WANPIPE mode.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;BRIDGE&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|chan-&gt;common.usedby
op_assign
id|BRIDGE
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4) 
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Running in WANPIPE (BRIDGE) mode.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: WANPIPE Bridging mode not supported in 2.0.X kernels.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;BRIDGE_N&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|chan-&gt;common.usedby
op_assign
id|BRIDGE_NODE
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Running in WANPIPE (BRIDGE_NODE) mode.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: WANPIPE Bridging mode not supported in 2.0.X kernels.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
multiline_comment|/* Dynamic interface configuration option.&n;&t;&t;&t; * On disconnect, if the options is selected,&n;&t;&t;&t; * the interface will be brought down */
r_if
c_cond
(paren
id|conf-&gt;if_down
op_eq
id|WANOPT_YES
)paren
(brace
id|set_bit
c_func
(paren
id|DYN_OPT_ON
comma
op_amp
id|chan-&gt;interface_down
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Dynamic interface configuration enabled.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|conf-&gt;usedby
comma
l_string|&quot;API&quot;
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4) 
id|chan-&gt;common.usedby
op_assign
id|API
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Running in API mode.&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: The API Mode is not supported for&quot;
l_string|&quot;kernels lower than 2.2.X !&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Please upgrade to a 2.2.X kernel for the API support&bslash;n&quot;
comma
id|wandev-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* place cir,be,bc and other channel specific information into the&n;&t; * chan structure &n;         */
r_if
c_cond
(paren
id|conf-&gt;cir
)paren
(brace
id|chan-&gt;cir
op_assign
id|max_t
c_func
(paren
r_int
r_int
comma
l_int|1
comma
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;cir
comma
l_int|512
)paren
)paren
suffix:semicolon
id|chan-&gt;cir_status
op_assign
id|CIR_ENABLED
suffix:semicolon
multiline_comment|/* If CIR is enabled, force BC to equal CIR&n;                 * this solves number of potential problems if CIR is &n;                 * set and BC is not &n;&t;&t; */
id|chan-&gt;bc
op_assign
id|chan-&gt;cir
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;be
)paren
(brace
id|chan-&gt;be
op_assign
id|max_t
c_func
(paren
r_int
r_int
comma
l_int|0
comma
id|min_t
c_func
(paren
r_int
r_int
comma
id|conf-&gt;be
comma
l_int|511
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|conf-&gt;be
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: CIR enabled for DLCI %i &bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s:     CIR = %i ; BC = %i ; BE = %i&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|chan-&gt;cir
comma
id|chan-&gt;bc
comma
id|chan-&gt;be
)paren
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;cir_status
op_assign
id|CIR_DISABLED
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: CIR disabled for DLCI %i&bslash;n&quot;
comma
id|wandev-&gt;name
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
)brace
id|chan-&gt;mc
op_assign
id|conf-&gt;mc
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;inarp
op_eq
id|WANOPT_YES
)paren
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Inverse ARP Support Enabled&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|chan-&gt;inarp
op_assign
id|conf-&gt;inarp
ques
c_cond
id|INARP_REQUEST
suffix:colon
id|INARP_NONE
suffix:semicolon
id|chan-&gt;inarp_interval
op_assign
id|conf-&gt;inarp_interval
ques
c_cond
id|conf-&gt;inarp_interval
suffix:colon
l_int|10
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Warning, Inverse ARP Support not available for 2.0.X kernels!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|chan-&gt;inarp
op_assign
id|INARP_NONE
suffix:semicolon
id|chan-&gt;inarp_interval
op_assign
l_int|10
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Inverse ARP Support Disabled&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|chan-&gt;inarp
op_assign
id|INARP_NONE
suffix:semicolon
id|chan-&gt;inarp_interval
op_assign
l_int|10
suffix:semicolon
)brace
id|chan-&gt;dlci_configured
op_assign
id|DLCI_NOT_CONFIGURED
suffix:semicolon
multiline_comment|/*FIXME: IPX disabled in this WANPIPE version */
r_if
c_cond
(paren
id|conf-&gt;enable_IPX
op_eq
id|WANOPT_YES
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR - This version of WANPIPE doesn&squot;t support IPX&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;enable_IPX
op_assign
id|WANOPT_NO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;network_number
)paren
(brace
id|chan-&gt;network_number
op_assign
id|conf-&gt;network_number
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;network_number
op_assign
l_int|0xDEADBEEF
suffix:semicolon
)brace
id|chan-&gt;route_flag
op_assign
id|NO_ROUTE
suffix:semicolon
id|init_chan_statistics
c_func
(paren
id|chan
)paren
suffix:semicolon
id|chan-&gt;transmit_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* prepare network device data space for registration */
macro_line|#ifdef LINUX_2_4
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|chan-&gt;name
)paren
suffix:semicolon
macro_line|#else
id|dev-&gt;name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|chan-&gt;name
)paren
op_plus
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;name
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;%s&quot;
comma
id|chan-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;init
op_assign
op_amp
id|if_init
suffix:semicolon
id|dev-&gt;priv
op_assign
id|chan
suffix:semicolon
multiline_comment|/* Initialize FR Polling Task Queue&n;         * We need a poll routine for each network&n;         * interface. &n;         */
macro_line|#ifndef LINUX_2_4
id|chan-&gt;fr_poll_task.next
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|chan-&gt;fr_poll_task.sync
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;fr_poll_task.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|fr_poll
suffix:semicolon
id|chan-&gt;fr_poll_task.data
op_assign
id|dev
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|chan-&gt;fr_arp_timer
)paren
suffix:semicolon
id|chan-&gt;fr_arp_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|chan-&gt;fr_arp_timer.function
op_assign
id|fr_arp
suffix:semicolon
id|wandev-&gt;new_if_cnt
op_increment
suffix:semicolon
multiline_comment|/* Tells us that if this interface is a&n;         * gateway or not */
r_if
c_cond
(paren
(paren
id|chan-&gt;gateway
op_assign
id|conf-&gt;gateway
)paren
op_eq
id|WANOPT_YES
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s is set as a gateway.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* M. Grant Patch Apr 28 2000 &n;         * Disallow duplicate dlci configurations. */
r_if
c_cond
(paren
id|card-&gt;u.f.dlci_to_dev_map
(braket
id|chan-&gt;dlci
)braket
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|chan
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Configure this dlci at a later date, when&n;         * the interface comes up. i.e. when if_open() &n;         * executes */
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;config_dlci
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Delete logical channel.&n; */
DECL|function|del_if
r_static
r_int
id|del_if
(paren
id|wan_device_t
op_star
id|wandev
comma
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|smp_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This interface is dead, make sure the &n;&t; * ARP timer is stopped */
id|del_timer
c_func
(paren
op_amp
id|chan-&gt;fr_arp_timer
)paren
suffix:semicolon
multiline_comment|/* If we are a NODE, we must unconfigure this DLCI&n;&t; * Trigger an unconfigure command that will&n;&t; * be executed in timer interrupt. We must wait&n;&t; * for the command to complete. */
id|trigger_unconfig_fr
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lock_adapter_irq
c_func
(paren
op_amp
id|wandev-&gt;lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
id|wandev-&gt;new_if_cnt
op_decrement
suffix:semicolon
id|unlock_adapter_irq
c_func
(paren
op_amp
id|wandev-&gt;lock
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=====================================================================&n; * disable_comm&n; *&n; * Description:&n; *&t;Disable communications.&n; * &t;This code runs in shutdown (sdlamain.c)&n; *      under critical flag. Therefore it is not&n; *      necessary to set a critical flag here &n; *&n; * Usage:&n; * &t;Commnunications are disabled only on a card&n; *      shutdown.&n; */
DECL|function|disable_comm
r_static
r_void
id|disable_comm
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Disabling Communications!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|fr_comm_disable
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/****** WANPIPE-specific entry points ***************************************/
multiline_comment|/*============================================================================&n; * Execute adapter interface command.&n; */
DECL|function|wpf_exec
r_static
r_int
id|wpf_exec
(paren
r_struct
id|sdla
op_star
id|card
comma
r_void
op_star
id|u_cmd
comma
r_void
op_star
id|u_data
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
comma
id|len
suffix:semicolon
id|fr_cmd_t
id|cmd
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
comma
id|u_cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* execute command */
r_do
(brace
id|memcpy
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
op_amp
id|cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd.length
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|u_data
comma
id|cmd.length
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sdla_exec
c_func
(paren
id|mbox
)paren
)paren
id|err
op_assign
id|mbox-&gt;cmd.result
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
multiline_comment|/* return result */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|u_cmd
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;cmd
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|u_data
op_logical_and
op_logical_neg
id|copy_to_user
c_func
(paren
id|u_data
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|u_cmd
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|u_cmd
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
comma
id|u_cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd.length
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|u_data
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|u_data
comma
id|cmd.length
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* execute command */
r_do
(brace
id|memcpy
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
op_amp
id|cmd
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd.length
)paren
id|memcpy_fromfs
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|u_data
comma
id|cmd.length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdla_exec
c_func
(paren
id|mbox
)paren
)paren
id|err
op_assign
id|mbox-&gt;cmd.result
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
multiline_comment|/* return result */
id|memcpy_tofs
c_func
(paren
id|u_cmd
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;cmd
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|u_data
op_logical_and
op_logical_neg
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|u_data
comma
id|len
)paren
)paren
id|memcpy_tofs
c_func
(paren
id|u_data
comma
(paren
r_void
op_star
)paren
op_amp
id|mbox-&gt;data
comma
id|len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/****** Network Device Interface ********************************************/
multiline_comment|/*============================================================================&n; * Initialize Linux network interface.&n; *&n; * This routine is called only once for each interface, during Linux network&n; * interface registration.  Returning anything but zero will fail interface&n; * registration.&n; */
DECL|function|if_init
r_static
r_int
id|if_init
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|wan_device_t
op_star
id|wandev
op_assign
op_amp
id|card-&gt;wandev
suffix:semicolon
macro_line|#ifdef LINUX_2_0
r_int
id|i
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialize device driver entry points */
id|dev-&gt;open
op_assign
op_amp
id|if_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|if_close
suffix:semicolon
id|dev-&gt;hard_header
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
op_amp
id|if_rebuild_hdr
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|if_send
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|if_stats
suffix:semicolon
macro_line|#ifdef LINUX_2_4
id|dev-&gt;tx_timeout
op_assign
op_amp
id|if_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|chan-&gt;common.usedby
op_eq
id|WANPIPE
op_logical_or
id|chan-&gt;common.usedby
op_eq
id|API
)paren
(brace
macro_line|#ifdef LINUX_2_0
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialize media-specific parameters */
r_if
c_cond
(paren
id|chan-&gt;true_if_encoding
)paren
(brace
id|dev-&gt;type
op_assign
id|ARPHRD_DLCI
suffix:semicolon
multiline_comment|/* This breaks tcpdump */
)brace
r_else
(brace
id|dev-&gt;type
op_assign
id|ARPHRD_PPP
suffix:semicolon
multiline_comment|/* ARP h/w type */
)brace
id|dev-&gt;flags
op_or_assign
id|IFF_POINTOPOINT
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_NOARP
suffix:semicolon
multiline_comment|/* Enable Multicast addressing */
r_if
c_cond
(paren
id|chan-&gt;mc
op_eq
id|WANOPT_YES
)paren
(brace
id|dev-&gt;flags
op_or_assign
id|IFF_MULTICAST
suffix:semicolon
)brace
id|dev-&gt;mtu
op_assign
id|wandev-&gt;mtu
op_minus
id|FR_HEADER_LEN
suffix:semicolon
multiline_comment|/* For an API, the maximum number of bytes that the stack will pass&n;&t;&t;   to the driver is (dev-&gt;mtu + dev-&gt;hard_header_len). So, adjust the&n;&t;&t;   mtu so that a frame of maximum size can be transmitted by the API. &n;&t;&t;*/
r_if
c_cond
(paren
id|chan-&gt;common.usedby
op_eq
id|API
)paren
(brace
id|dev-&gt;mtu
op_add_assign
(paren
r_sizeof
(paren
id|api_tx_hdr_t
)paren
op_minus
id|FR_HEADER_LEN
)paren
suffix:semicolon
)brace
id|dev-&gt;hard_header_len
op_assign
id|FR_HEADER_LEN
suffix:semicolon
multiline_comment|/* media header length */
id|dev-&gt;addr_len
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* hardware address length */
op_star
(paren
r_int
r_int
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
c_func
(paren
id|chan-&gt;dlci
)paren
suffix:semicolon
multiline_comment|/* Set transmit buffer queue length */
id|dev-&gt;tx_queue_len
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* Initialize socket buffers */
macro_line|#if !defined(LINUX_2_1) &amp;&amp; !defined(LINUX_2_4)
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
op_increment
id|i
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* Setup the interface for Bridging */
r_int
id|hw_addr
op_assign
l_int|0
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Use a random number to generate the MAC address */
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
l_string|&quot;&bslash;xFE&bslash;xFC&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|6
)paren
suffix:semicolon
id|get_random_bytes
c_func
(paren
op_amp
id|hw_addr
comma
r_sizeof
(paren
id|hw_addr
)paren
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
(paren
id|dev-&gt;dev_addr
op_plus
l_int|2
)paren
op_add_assign
id|hw_addr
suffix:semicolon
)brace
multiline_comment|/* Initialize hardware parameters (just for reference) */
id|dev-&gt;irq
op_assign
id|wandev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
id|wandev-&gt;dma
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|wandev-&gt;ioport
suffix:semicolon
id|dev-&gt;mem_start
op_assign
id|wandev-&gt;maddr
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|wandev-&gt;maddr
op_plus
id|wandev-&gt;msize
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Open network interface.&n; * o if this is the first open, then enable communications and interrupts.&n; * o prevent module from unloading by incrementing use count&n; *&n; * Return 0 if O.k. or errno.&n; */
DECL|function|if_open
r_static
r_int
id|if_open
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_if
c_cond
(paren
id|is_dev_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/* Initialize the task queue */
id|chan-&gt;tq_working
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef LINUX_2_4
id|chan-&gt;common.wanpipe_task.next
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|chan-&gt;common.wanpipe_task.sync
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;common.wanpipe_task.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|fr_bh
suffix:semicolon
id|chan-&gt;common.wanpipe_task.data
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Allocate and initialize BH circular buffer */
id|chan-&gt;bh_head
op_assign
id|kmalloc
c_func
(paren
(paren
r_sizeof
(paren
id|bh_data_t
)paren
op_star
id|MAX_BH_BUFF
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|memset
c_func
(paren
id|chan-&gt;bh_head
comma
l_int|0
comma
(paren
r_sizeof
(paren
id|bh_data_t
)paren
op_star
id|MAX_BH_BUFF
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef LINUX_2_4
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#else&t;
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|wanpipe_open
c_func
(paren
id|card
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|chan-&gt;router_start_time
op_assign
id|tv.tv_sec
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;config_dlci
)paren
)paren
(brace
id|trigger_config_fr
(paren
id|card
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;inarp
op_eq
id|INARP_REQUEST
)paren
(brace
id|trigger_fr_arp
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Close network interface.&n; * o if this is the last open, then disable communications and interrupts.&n; * o reset flags.&n; */
DECL|function|if_close
r_static
r_int
id|if_close
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;inarp
op_eq
id|INARP_CONFIGURED
)paren
(brace
id|chan-&gt;inarp
op_assign
id|INARP_REQUEST
suffix:semicolon
)brace
id|stop_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifndef LINUX_2_4
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|wanpipe_close
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Re-build media header.&n; *&n; * Return:&t;1&t;physical address resolved.&n; *&t;&t;0&t;physical address not resolved&n; */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
DECL|function|if_rebuild_hdr
r_static
r_int
id|if_rebuild_hdr
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#else
r_static
r_int
id|if_rebuild_hdr
(paren
r_void
op_star
id|hdr
comma
id|netdevice_t
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#endif
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4) 
id|netdevice_t
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
macro_line|#endif
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: rebuild_header() called for interface %s!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef LINUX_2_4
multiline_comment|/*============================================================================&n; * Handle transmit timeout event from netif watchdog&n; */
DECL|function|if_tx_timeout
r_static
r_void
id|if_tx_timeout
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
multiline_comment|/* If our device stays busy for at least 5 seconds then we will&n;&t; * kick start the device by making dev-&gt;tbusy = 0.  We expect&n;&t; * that our device never stays busy more than 5 seconds. So this                 &n;&t; * is only used as a last resort.&n;&t; */
id|chan-&gt;drvstats_if_send.if_send_tbusy
op_increment
suffix:semicolon
op_increment
id|chan-&gt;ifstats.collisions
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit timed out on %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|chan-&gt;drvstats_if_send.if_send_tbusy_timeout
op_increment
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*============================================================================&n; * Send a packet on a network interface.&n; * o set tbusy flag (marks start of the transmission) to block a timer-based&n; *   transmit from overlapping.&n; * o set critical flag when accessing board.&n; * o check link state. If link is not up, then drop the packet.&n; * o check channel status. If it&squot;s down then initiate a call.&n; * o pass a packet to corresponding WAN device.&n; * o free socket buffer&n; *&n; * Return:&t;0&t;complete (socket buffer must be freed)&n; *&t;&t;non-0&t;packet may be re-transmitted (tbusy must be set)&n; *&n; * Notes:&n; * 1. This routine is called either by the protocol stack or by the &quot;net&n; *    bottom half&quot; (with interrupts enabled).&n; * &n; * 2. Using the start_net_queue() and stop_net_queue() MACROS&n; *    will inhibit further transmit requests from the protocol stack &n; *    and can be used for flow control with protocol layer.&n; */
DECL|function|if_send
r_static
r_int
id|if_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_char
op_star
id|sendpacket
suffix:semicolon
id|fr508_flags_t
op_star
id|adptr_flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_int
id|udp_type
comma
id|delay_tx_queued
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|smp_flags
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|attr
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;drvstats_if_send.if_send_entry
op_increment
suffix:semicolon
macro_line|#ifdef LINUX_2_4
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* if we get here, some higher layer thinks we&squot;ve missed an&n;&t;&t; * tx-done interrupt.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interface %s got kicked!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|chan-&gt;drvstats_if_send.if_send_skb_null
op_increment
suffix:semicolon
id|wake_net_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If a peripheral task is running just drop packets */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PERI_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Critical in if_send(): Peripheral running!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We must set the &squot;tbusy&squot; flag if we already have a packet queued for&n;&t;   transmission in the transmit interrupt handler. However, we must&n;&t;   ensure that the transmit interrupt does not reset the &squot;tbusy&squot; flag&n;&t;   just before we set it, as this will result in a &quot;transmit timeout&quot;.&n;&t;*/
id|set_bit
c_func
(paren
id|SEND_TXIRQ_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;transmit_length
)paren
(brace
id|stop_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|chan-&gt;tick_counter
op_assign
id|jiffies
suffix:semicolon
id|clear_bit
c_func
(paren
id|SEND_TXIRQ_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|SEND_TXIRQ_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
macro_line|#ifndef LINUX_2_4
r_if
c_cond
(paren
id|dev-&gt;tbusy
)paren
(brace
multiline_comment|/* If our device stays busy for at least 5 seconds then we will&n;                 * kick start the device by making dev-&gt;tbusy = 0.  We expect&n;                 * that our device never stays busy more than 5 seconds. So this                 &n;&t;&t; * is only used as a last resort.&n;                 */
id|chan-&gt;drvstats_if_send.if_send_tbusy
op_increment
suffix:semicolon
op_increment
id|chan-&gt;ifstats.collisions
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|chan-&gt;tick_counter
)paren
OL
(paren
l_int|5
op_star
id|HZ
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transmit timed out on %s&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;name
)paren
suffix:semicolon
id|chan-&gt;drvstats_if_send.if_send_tbusy_timeout
op_increment
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Move the if_header() code to here. By inserting frame&n;&t; * relay header in if_header() we would break the&n;&t; * tcpdump and other packet sniffers */
id|chan-&gt;fr_header_len
op_assign
id|setup_fr_header
c_func
(paren
op_amp
id|skb
comma
id|dev
comma
id|chan-&gt;common.usedby
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;fr_header_len
OL
l_int|0
)paren
(brace
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sendpacket
op_assign
id|skb-&gt;data
suffix:semicolon
id|udp_type
op_assign
id|udp_pkt_type
c_func
(paren
id|skb
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udp_type
op_ne
id|UDP_INVALID_TYPE
)paren
(brace
r_if
c_cond
(paren
id|store_udp_mgmt_pkt
c_func
(paren
id|udp_type
comma
id|UDP_PKT_FRM_STACK
comma
id|card
comma
id|skb
comma
id|chan-&gt;dlci
)paren
)paren
(brace
id|adptr_flags-&gt;imask
op_or_assign
id|FR_INTR_TIMER
suffix:semicolon
r_if
c_cond
(paren
id|udp_type
op_eq
id|UDP_FPIPE_TYPE
)paren
(brace
id|chan-&gt;drvstats_if_send
dot
id|if_send_PIPE_request
op_increment
suffix:semicolon
)brace
)brace
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//FIXME: can we do better than sendpacket[2]?
r_if
c_cond
(paren
(paren
id|chan-&gt;common.usedby
op_eq
id|WANPIPE
)paren
op_logical_and
(paren
id|sendpacket
(braket
l_int|2
)braket
op_eq
l_int|0x45
)paren
)paren
(brace
multiline_comment|/* check to see if the source IP address is a broadcast or */
multiline_comment|/* multicast IP address */
r_if
c_cond
(paren
id|chk_bcast_mcast_addr
c_func
(paren
id|card
comma
id|dev
comma
id|skb
)paren
)paren
(brace
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Lock the S514/S508 card: SMP Supported */
id|s508_s514_lock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|chan-&gt;drvstats_if_send.if_send_critical_non_ISR
op_increment
suffix:semicolon
id|chan-&gt;ifstats.tx_dropped
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Critical in IF_SEND: if_send() already running!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_goto
id|if_send_start_and_exit
suffix:semicolon
)brace
multiline_comment|/* API packet check: minimum packet size must be greater than &n;&t; * 16 byte API header */
r_if
c_cond
(paren
(paren
id|chan-&gt;common.usedby
op_eq
id|API
)paren
op_logical_and
(paren
id|skb-&gt;len
op_le
r_sizeof
(paren
id|api_tx_hdr_t
)paren
)paren
)paren
(brace
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
r_goto
id|if_send_start_and_exit
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* During API transmission, get rid of the API header */
r_if
c_cond
(paren
id|chan-&gt;common.usedby
op_eq
id|API
)paren
(brace
id|api_tx_hdr_t
op_star
id|api_tx_hdr
suffix:semicolon
id|api_tx_hdr
op_assign
(paren
id|api_tx_hdr_t
op_star
)paren
op_amp
id|skb-&gt;data
(braket
l_int|0x00
)braket
suffix:semicolon
id|attr
op_assign
id|api_tx_hdr-&gt;attr
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|api_tx_hdr_t
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_ne
id|WAN_CONNECTED
)paren
(brace
id|chan-&gt;drvstats_if_send.if_send_wan_disconnected
op_increment
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;common.state
op_ne
id|WAN_CONNECTED
)paren
(brace
id|chan-&gt;drvstats_if_send.if_send_dlci_disconnected
op_increment
suffix:semicolon
multiline_comment|/* Update the DLCI state in timer interrupt */
id|card-&gt;u.f.timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_UPDATE_STATE
suffix:semicolon
id|adptr_flags-&gt;imask
op_or_assign
id|FR_INTR_TIMER
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|is_tx_ready
c_func
(paren
id|card
comma
id|chan
)paren
)paren
(brace
multiline_comment|/* No tx buffers available, store for delayed transmit */
r_if
c_cond
(paren
op_logical_neg
id|setup_for_delayed_transmit
c_func
(paren
id|dev
comma
id|skb
)paren
)paren
(brace
id|set_bit
c_func
(paren
l_int|1
comma
op_amp
id|delay_tx_queued
)paren
suffix:semicolon
)brace
id|chan-&gt;drvstats_if_send.if_send_no_bfrs
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;protocol
)paren
(brace
multiline_comment|/* No protocols drop packet */
id|chan-&gt;drvstats_if_send.if_send_protocol_error
op_increment
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_errors
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ARP_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
multiline_comment|/* We are trying to send an ARP Packet, block IP data until&n;&t;&t; * ARP is sent */
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//FIXME: IPX is not implemented in this version of Frame Relay ?
r_if
c_cond
(paren
(paren
id|chan-&gt;common.usedby
op_eq
id|WANPIPE
)paren
op_logical_and
id|sendpacket
(braket
l_int|1
)braket
op_eq
l_int|0x00
op_logical_and
id|sendpacket
(braket
l_int|2
)braket
op_eq
l_int|0x80
op_logical_and
id|sendpacket
(braket
l_int|6
)braket
op_eq
l_int|0x81
op_logical_and
id|sendpacket
(braket
l_int|7
)braket
op_eq
l_int|0x37
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;enable_IPX
)paren
(brace
id|switch_net_numbers
c_func
(paren
id|sendpacket
comma
id|chan-&gt;network_number
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//FIXME: Take this out when IPX is fixed 
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: WARNING: Unsupported IPX data in send, packet dropped&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
op_assign
id|fr_send_data_header
c_func
(paren
id|card
comma
id|chan-&gt;dlci
comma
id|attr
comma
id|skb-&gt;len
comma
id|skb-&gt;data
comma
id|chan-&gt;fr_header_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
id|FRRES_CIR_OVERFLOW
suffix:colon
r_case
id|FRRES_BUFFER_OVERFLOW
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|setup_for_delayed_transmit
c_func
(paren
id|dev
comma
id|skb
)paren
)paren
(brace
id|set_bit
c_func
(paren
l_int|1
comma
op_amp
id|delay_tx_queued
)paren
suffix:semicolon
)brace
id|chan-&gt;drvstats_if_send
dot
id|if_send_adptr_bfrs_full
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FRRES_TOO_LONG
suffix:colon
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error: Frame too long, transmission failed %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
(paren
r_int
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
)brace
multiline_comment|/* Drop down to default */
r_default
suffix:colon
id|chan-&gt;drvstats_if_send
dot
id|if_send_dlci_disconnected
op_increment
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_dropped
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_dropped
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|chan-&gt;drvstats_if_send
dot
id|if_send_bfr_passed_to_adptr
op_increment
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_packets
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_packets
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|chan-&gt;ifstats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|card-&gt;wandev.stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
macro_line|#endif
macro_line|#ifdef LINUX_2_4
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
id|if_send_start_and_exit
suffix:colon
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* If we queued the packet for transmission, we must not&n;&t; * deallocate it. The packet is unlinked from the IP stack&n;&t; * not copied. Therefore, we must keep the original packet */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
l_int|1
comma
op_amp
id|delay_tx_queued
)paren
)paren
(brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_else
(brace
id|adptr_flags-&gt;imask
op_or_assign
id|FR_INTR_TXRDY
suffix:semicolon
id|card-&gt;u.f.tx_interrupts_pending
op_increment
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|s508_s514_unlock
c_func
(paren
id|card
comma
op_amp
id|smp_flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Setup so that a frame can be transmitted on the occurence of a transmit&n; * interrupt.&n; */
DECL|function|setup_for_delayed_transmit
r_static
r_int
id|setup_for_delayed_transmit
(paren
id|netdevice_t
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|fr_dlci_interface_t
op_star
id|dlci_interface
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Check that the dlci is properly configured,&n;         * before using tx interrupt */
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;dlci_int_interface
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR on DLCI %i: Not configured properly !&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Please contact Sangoma Technologies&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|dlci_interface
op_assign
id|chan-&gt;dlci_int_interface
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;transmit_length
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Big mess in setup_for_del...&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|FR_MAX_NO_DATA_BYTES_IN_FRAME
)paren
(brace
singleline_comment|//FIXME: increment some statistic */
r_return
l_int|1
suffix:semicolon
)brace
id|skb_unlink
c_func
(paren
id|skb
)paren
suffix:semicolon
id|chan-&gt;transmit_length
op_assign
id|len
suffix:semicolon
id|chan-&gt;delay_skb
op_assign
id|skb
suffix:semicolon
id|dlci_interface-&gt;gen_interrupt
op_or_assign
id|FR_INTR_TXRDY
suffix:semicolon
id|dlci_interface-&gt;packet_length
op_assign
id|len
suffix:semicolon
multiline_comment|/* Turn on TX interrupt at the end of if_send */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Check to see if the packet to be transmitted contains a broadcast or&n; * multicast source IP address.&n; * Return 0 if not broadcast/multicast address, otherwise return 1.&n; */
DECL|function|chk_bcast_mcast_addr
r_static
r_int
id|chk_bcast_mcast_addr
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|u32
id|src_ip_addr
suffix:semicolon
id|u32
id|broadcast_ip_addr
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
macro_line|#endif
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* read the IP source address from the outgoing packet */
id|src_ip_addr
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|14
)paren
suffix:semicolon
multiline_comment|/* read the IP broadcast address for the device */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_ne
l_int|NULL
)paren
(brace
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_ne
l_int|NULL
)paren
(brace
id|broadcast_ip_addr
op_assign
id|ifa-&gt;ifa_broadcast
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
id|broadcast_ip_addr
op_assign
id|dev-&gt;pa_brdaddr
suffix:semicolon
macro_line|#endif
multiline_comment|/* check if the IP Source Address is a Broadcast address */
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_BROADCAST
)paren
op_logical_and
(paren
id|src_ip_addr
op_eq
id|broadcast_ip_addr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Broadcast Source Address silently discarded&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* check if the IP Source Address is a Multicast address */
r_if
c_cond
(paren
(paren
id|chan-&gt;mc
op_eq
id|WANOPT_NO
)paren
op_logical_and
(paren
id|ntohl
c_func
(paren
id|src_ip_addr
)paren
op_ge
l_int|0xE0000001
)paren
op_logical_and
(paren
id|ntohl
c_func
(paren
id|src_ip_addr
)paren
op_le
l_int|0xFFFFFFFE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Multicast Source Address silently discarded&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Reply to UDP Management system.&n; * Return nothing.&n; */
DECL|function|reply_udp
r_static
r_int
id|reply_udp
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|mbox_len
)paren
(brace
r_int
r_int
id|len
comma
id|udp_length
comma
id|temp
comma
id|ip_length
suffix:semicolon
r_int
r_int
id|ip_temp
suffix:semicolon
r_int
id|even_bound
op_assign
l_int|0
suffix:semicolon
id|fr_udp_pkt_t
op_star
id|fr_udp_pkt
op_assign
(paren
id|fr_udp_pkt_t
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* Set length of packet */
id|len
op_assign
singleline_comment|//sizeof(fr_encap_hdr_t)+
r_sizeof
(paren
id|ip_pkt_t
)paren
op_plus
r_sizeof
(paren
id|udp_pkt_t
)paren
op_plus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_plus
r_sizeof
(paren
id|cblock_t
)paren
op_plus
id|mbox_len
suffix:semicolon
multiline_comment|/* fill in UDP reply */
id|fr_udp_pkt-&gt;wp_mgmt.request_reply
op_assign
id|UDPMGMT_REPLY
suffix:semicolon
multiline_comment|/* fill in UDP length */
id|udp_length
op_assign
r_sizeof
(paren
id|udp_pkt_t
)paren
op_plus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_plus
r_sizeof
(paren
id|cblock_t
)paren
op_plus
id|mbox_len
suffix:semicolon
multiline_comment|/* put it on an even boundary */
r_if
c_cond
(paren
id|udp_length
op_amp
l_int|0x0001
)paren
(brace
id|udp_length
op_add_assign
l_int|1
suffix:semicolon
id|len
op_add_assign
l_int|1
suffix:semicolon
id|even_bound
op_assign
l_int|1
suffix:semicolon
)brace
id|temp
op_assign
(paren
id|udp_length
op_lshift
l_int|8
)paren
op_or
(paren
id|udp_length
op_rshift
l_int|8
)paren
suffix:semicolon
id|fr_udp_pkt-&gt;udp_pkt.udp_length
op_assign
id|temp
suffix:semicolon
multiline_comment|/* swap UDP ports */
id|temp
op_assign
id|fr_udp_pkt-&gt;udp_pkt.udp_src_port
suffix:semicolon
id|fr_udp_pkt-&gt;udp_pkt.udp_src_port
op_assign
id|fr_udp_pkt-&gt;udp_pkt.udp_dst_port
suffix:semicolon
id|fr_udp_pkt-&gt;udp_pkt.udp_dst_port
op_assign
id|temp
suffix:semicolon
multiline_comment|/* add UDP pseudo header */
id|temp
op_assign
l_int|0x1100
suffix:semicolon
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|fr_udp_pkt-&gt;data
op_plus
id|mbox_len
op_plus
id|even_bound
)paren
)paren
op_assign
id|temp
suffix:semicolon
id|temp
op_assign
(paren
id|udp_length
op_lshift
l_int|8
)paren
op_or
(paren
id|udp_length
op_rshift
l_int|8
)paren
suffix:semicolon
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|fr_udp_pkt-&gt;data
op_plus
id|mbox_len
op_plus
id|even_bound
op_plus
l_int|2
)paren
)paren
op_assign
id|temp
suffix:semicolon
multiline_comment|/* calculate UDP checksum */
id|fr_udp_pkt-&gt;udp_pkt.udp_checksum
op_assign
l_int|0
suffix:semicolon
id|fr_udp_pkt-&gt;udp_pkt.udp_checksum
op_assign
id|calc_checksum
c_func
(paren
op_amp
id|data
(braket
id|UDP_OFFSET
multiline_comment|/*+sizeof(fr_encap_hdr_t)*/
)braket
comma
id|udp_length
op_plus
id|UDP_OFFSET
)paren
suffix:semicolon
multiline_comment|/* fill in IP length */
id|ip_length
op_assign
id|udp_length
op_plus
r_sizeof
(paren
id|ip_pkt_t
)paren
suffix:semicolon
id|temp
op_assign
(paren
id|ip_length
op_lshift
l_int|8
)paren
op_or
(paren
id|ip_length
op_rshift
l_int|8
)paren
suffix:semicolon
id|fr_udp_pkt-&gt;ip_pkt.total_length
op_assign
id|temp
suffix:semicolon
multiline_comment|/* swap IP addresses */
id|ip_temp
op_assign
id|fr_udp_pkt-&gt;ip_pkt.ip_src_address
suffix:semicolon
id|fr_udp_pkt-&gt;ip_pkt.ip_src_address
op_assign
id|fr_udp_pkt-&gt;ip_pkt.ip_dst_address
suffix:semicolon
id|fr_udp_pkt-&gt;ip_pkt.ip_dst_address
op_assign
id|ip_temp
suffix:semicolon
multiline_comment|/* fill in IP checksum */
id|fr_udp_pkt-&gt;ip_pkt.hdr_checksum
op_assign
l_int|0
suffix:semicolon
id|fr_udp_pkt-&gt;ip_pkt.hdr_checksum
op_assign
id|calc_checksum
c_func
(paren
op_amp
id|data
(braket
multiline_comment|/*sizeof(fr_encap_hdr_t)*/
l_int|0
)braket
comma
r_sizeof
(paren
id|ip_pkt_t
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* reply_udp */
DECL|function|calc_checksum
r_int
r_int
id|calc_checksum
(paren
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|temp
suffix:semicolon
r_int
r_int
id|sum
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|temp
comma
op_amp
id|data
(braket
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
r_int
r_int
)paren
id|temp
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sum
op_rshift
l_int|16
)paren
(brace
id|sum
op_assign
(paren
id|sum
op_amp
l_int|0xffffUL
)paren
op_plus
(paren
id|sum
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
id|temp
op_assign
(paren
r_int
r_int
)paren
id|sum
suffix:semicolon
id|temp
op_assign
op_complement
id|temp
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_eq
l_int|0
)paren
(brace
id|temp
op_assign
l_int|0xffff
suffix:semicolon
)brace
r_return
id|temp
suffix:semicolon
)brace
multiline_comment|/*&n;   If incoming is 0 (outgoing)- if the net numbers is ours make it 0&n;   if incoming is 1 - if the net number is 0 make it ours &n;&n;*/
DECL|function|switch_net_numbers
r_static
r_void
id|switch_net_numbers
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_int
r_int
id|network_number
comma
r_int
r_char
id|incoming
)paren
(brace
r_int
r_int
id|pnetwork_number
suffix:semicolon
id|pnetwork_number
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|sendpacket
(braket
l_int|14
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|15
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|16
)braket
op_lshift
l_int|8
)paren
op_plus
id|sendpacket
(braket
l_int|17
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|incoming
)paren
(brace
multiline_comment|/* If the destination network number is ours, make it 0 */
r_if
c_cond
(paren
id|pnetwork_number
op_eq
id|network_number
)paren
(brace
id|sendpacket
(braket
l_int|14
)braket
op_assign
id|sendpacket
(braket
l_int|15
)braket
op_assign
id|sendpacket
(braket
l_int|16
)braket
op_assign
id|sendpacket
(braket
l_int|17
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If the incoming network is 0, make it ours */
r_if
c_cond
(paren
id|pnetwork_number
op_eq
l_int|0
)paren
(brace
id|sendpacket
(braket
l_int|14
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|15
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|16
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|17
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
)brace
)brace
id|pnetwork_number
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|sendpacket
(braket
l_int|26
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|27
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|sendpacket
(braket
l_int|28
)braket
op_lshift
l_int|8
)paren
op_plus
id|sendpacket
(braket
l_int|29
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|incoming
)paren
(brace
multiline_comment|/* If the source network is ours, make it 0 */
r_if
c_cond
(paren
id|pnetwork_number
op_eq
id|network_number
)paren
(brace
id|sendpacket
(braket
l_int|26
)braket
op_assign
id|sendpacket
(braket
l_int|27
)braket
op_assign
id|sendpacket
(braket
l_int|28
)braket
op_assign
id|sendpacket
(braket
l_int|29
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If the source network is 0, make it ours */
r_if
c_cond
(paren
id|pnetwork_number
op_eq
l_int|0
)paren
(brace
id|sendpacket
(braket
l_int|26
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|27
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|28
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|29
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* switch_net_numbers */
multiline_comment|/*============================================================================&n; * Get ethernet-style interface statistics.&n; * Return a pointer to struct enet_statistics.&n; */
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
DECL|function|if_stats
r_static
r_struct
id|net_device_stats
op_star
id|if_stats
c_func
(paren
id|netdevice_t
op_star
id|dev
)paren
macro_line|#else
r_static
r_struct
id|enet_statistics
op_star
id|if_stats
(paren
id|netdevice_t
op_star
id|dev
)paren
macro_line|#endif
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
op_amp
id|chan-&gt;ifstats
suffix:semicolon
)brace
multiline_comment|/****** Interrupt Handlers **************************************************/
multiline_comment|/*============================================================================&n; * fr_isr:&t;S508 frame relay interrupt service routine.&n; *&n; * Description:&n; *&t;Frame relay main interrupt service route. This&n; *      function check the interrupt type and takes&n; *      the appropriate action.&n; */
DECL|function|fr_isr
r_static
r_void
id|fr_isr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_char
op_star
id|ptr
op_assign
op_amp
id|flags-&gt;iflag
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
multiline_comment|/* This flag prevents nesting of interrupts.  See sdla_isr() routine&n;         * in sdlamain.c.  */
id|card-&gt;in_isr
op_assign
l_int|1
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_entry
suffix:semicolon
multiline_comment|/* All peripheral (configuraiton, re-configuration) events&n;&t; * take presidence over the ISR.  Thus, retrigger */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PERI_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
op_increment
id|card-&gt;statistics.isr_already_critical
suffix:semicolon
r_goto
id|fr_isr_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Critical while in ISR: If Send Running!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_already_critical
suffix:semicolon
r_goto
id|fr_isr_exit
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|flags-&gt;iflag
)paren
(brace
r_case
id|FR_INTR_RXRDY
suffix:colon
multiline_comment|/* receive interrupt */
op_increment
id|card-&gt;statistics.isr_rx
suffix:semicolon
id|rx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FR_INTR_TXRDY
suffix:colon
multiline_comment|/* transmit interrupt */
op_increment
id|card-&gt;statistics.isr_tx
suffix:semicolon
id|tx_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FR_INTR_READY
suffix:colon
id|Intr_test_counter
op_increment
suffix:semicolon
op_increment
id|card-&gt;statistics.isr_intr_test
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FR_INTR_DLC
suffix:colon
multiline_comment|/* Event interrupt occured */
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_STATUS
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FR_INTR_TIMER
suffix:colon
multiline_comment|/* Timer interrupt */
id|timer_intr
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
op_increment
id|card-&gt;statistics.isr_spurious
suffix:semicolon
id|spur_intr
c_func
(paren
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interrupt Type 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|flags-&gt;iflag
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ID Bytes = &quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;0x%02X &quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|0x28
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|fr_isr_exit
suffix:colon
id|card-&gt;in_isr
op_assign
l_int|0
suffix:semicolon
id|flags-&gt;iflag
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*===========================================================&n; * rx_intr&t;Receive interrupt handler.&n; *&n; * Description&n; * &t;Upon receiveing an interrupt: &n; *&t;1. Check that the firmware is in sync with &n; *     &t;   the driver. &n; *      2. Find an appropriate network interface&n; *         based on the received dlci number.&n; *&t;3. Check that the netowrk interface exists&n; *         and that it&squot;s setup properly.&n; *&t;4. Copy the data into an skb buffer.&n; *&t;5. Check the packet type and take&n; *         appropriate acton: UPD, API, ARP or Data.&n; */
DECL|function|rx_intr
r_static
r_void
id|rx_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_rx_buf_ctl_t
op_star
id|frbuf
op_assign
id|card-&gt;rxmb
suffix:semicolon
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_char
op_star
id|ptr
op_assign
op_amp
id|flags-&gt;iflag
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|netdevice_t
op_star
id|dev
suffix:semicolon
r_void
op_star
id|buf
suffix:semicolon
r_int
id|dlci
comma
id|len
comma
id|offs
comma
id|len_incl_hdr
suffix:semicolon
r_int
id|i
comma
id|udp_type
suffix:semicolon
multiline_comment|/* Check that firmware buffers are in sync */
r_if
c_cond
(paren
id|frbuf-&gt;flag
op_ne
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: corrupted Rx buffer @ 0x%X, flag = 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
(paren
r_int
)paren
id|frbuf
comma
id|frbuf-&gt;flag
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ID Bytes = &quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;0x%02X &quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|0x28
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|card-&gt;statistics.rx_intr_corrupt_rx_bfr
suffix:semicolon
multiline_comment|/* Bug Fix: Mar 6 2000&n;                 * If we get a corrupted mailbox, it means that driver &n;                 * is out of sync with the firmware. There is no recovery.&n;                 * If we don&squot;t turn off all interrupts for this card&n;                 * the machine will crash. &n;                 */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Critical router failure ...!!!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Please contact Sangoma Technologies !&bslash;n&quot;
)paren
suffix:semicolon
id|fr_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|len
op_assign
id|frbuf-&gt;length
suffix:semicolon
id|dlci
op_assign
id|frbuf-&gt;dlci
suffix:semicolon
id|offs
op_assign
id|frbuf-&gt;offset
suffix:semicolon
multiline_comment|/* Find the network interface for this packet */
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|dlci
)paren
suffix:semicolon
multiline_comment|/* Check that the network interface is active and&n;         * properly setup */
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: received data on unconfigured DLCI %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
)brace
op_increment
id|card-&gt;statistics.rx_intr_on_orphaned_DLCI
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
r_goto
id|rx_done
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|chan
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: received data on unconfigured DLCI %d!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
)brace
op_increment
id|card-&gt;statistics.rx_intr_on_orphaned_DLCI
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
r_goto
id|rx_done
suffix:semicolon
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_dev_running
c_func
(paren
id|dev
)paren
op_logical_or
(paren
id|skb
op_eq
l_int|NULL
)paren
)paren
(brace
op_increment
id|chan-&gt;ifstats.rx_dropped
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|chan-&gt;drvstats_rx_intr.rx_intr_no_socket
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_dev_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|chan-&gt;drvstats_rx_intr
dot
id|rx_intr_dev_not_started
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
)brace
r_goto
id|rx_done
suffix:semicolon
)brace
multiline_comment|/* Copy data from the board into the socket buffer */
r_if
c_cond
(paren
(paren
id|offs
op_plus
id|len
)paren
OG
id|card-&gt;u.f.rx_top
op_plus
l_int|1
)paren
(brace
r_int
id|tmp
op_assign
id|card-&gt;u.f.rx_top
op_minus
id|offs
op_plus
l_int|1
suffix:semicolon
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|tmp
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|offs
comma
id|buf
comma
id|tmp
)paren
suffix:semicolon
id|offs
op_assign
id|card-&gt;u.f.rx_base
suffix:semicolon
id|len
op_sub_assign
id|tmp
suffix:semicolon
)brace
id|buf
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|offs
comma
id|buf
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* We got the packet from the bard. &n;         * Check the packet type and take appropriate action */
id|udp_type
op_assign
id|udp_pkt_type
c_func
(paren
id|skb
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udp_type
op_ne
id|UDP_INVALID_TYPE
)paren
(brace
multiline_comment|/* UDP Debug packet received, store the&n;&t;&t; * packet and handle it in timer interrupt */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wanrouter_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|store_udp_mgmt_pkt
c_func
(paren
id|udp_type
comma
id|UDP_PKT_FRM_NETWORK
comma
id|card
comma
id|skb
comma
id|dlci
)paren
)paren
(brace
id|flags-&gt;imask
op_or_assign
id|FR_INTR_TIMER
suffix:semicolon
r_if
c_cond
(paren
id|udp_type
op_eq
id|UDP_FPIPE_TYPE
)paren
(brace
op_increment
id|chan-&gt;drvstats_rx_intr.rx_intr_PIPE_request
suffix:semicolon
)brace
)brace
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;common.usedby
op_eq
id|API
)paren
(brace
multiline_comment|/* We are in API mode. &n;                 * Add an API header to the RAW packet&n;                 * and queue it into a circular buffer.&n;                 * Then kick the fr_bh() bottom half handler */
id|api_rx_hdr_t
op_star
id|api_rx_hdr
suffix:semicolon
id|chan-&gt;drvstats_rx_intr.rx_intr_bfr_passed_to_stack
op_increment
suffix:semicolon
id|chan-&gt;ifstats.rx_packets
op_increment
suffix:semicolon
id|card-&gt;wandev.stats.rx_packets
op_increment
suffix:semicolon
id|chan-&gt;ifstats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|card-&gt;wandev.stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|api_rx_hdr_t
)paren
)paren
suffix:semicolon
id|api_rx_hdr
op_assign
(paren
id|api_rx_hdr_t
op_star
)paren
op_amp
id|skb-&gt;data
(braket
l_int|0x00
)braket
suffix:semicolon
id|api_rx_hdr-&gt;attr
op_assign
id|frbuf-&gt;attr
suffix:semicolon
id|api_rx_hdr-&gt;time_stamp
op_assign
id|frbuf-&gt;tmstamp
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|WAN_PACKET_DATA
suffix:semicolon
id|bh_enqueue
c_func
(paren
id|dev
comma
id|skb
)paren
suffix:semicolon
id|trigger_fr_bh
c_func
(paren
id|chan
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|handle_IPXWAN
c_func
(paren
id|skb-&gt;data
comma
id|chan-&gt;name
comma
id|chan-&gt;enable_IPX
comma
id|chan-&gt;network_number
)paren
)paren
(brace
singleline_comment|//FIXME: Frame Relay IPX is not supported, Yet !
singleline_comment|//if (chan-&gt;enable_IPX) {
singleline_comment|//&t;fr_send(card, dlci, 0, skb-&gt;len,skb-&gt;data);
singleline_comment|//}
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is_arp
c_func
(paren
id|skb-&gt;data
)paren
)paren
(brace
multiline_comment|/* ARP support enabled Mar 16 2000 &n;&t;&t; * Process incoming ARP reply/request, setup&n;&t;&t; * dynamic routes. */
r_if
c_cond
(paren
id|process_ARP
c_func
(paren
(paren
id|arphdr_1490_t
op_star
)paren
id|skb-&gt;data
comma
id|card
comma
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Error processing ARP Packet.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_ne
l_int|0x03
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Non IETF packet discarded.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
r_else
(brace
id|len_incl_hdr
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Decapsulate packet and pass it up the&n;&t;&t;   protocol stack */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;common.usedby
op_eq
id|BRIDGE
op_logical_or
id|chan-&gt;common.usedby
op_eq
id|BRIDGE_NODE
)paren
(brace
multiline_comment|/* Make sure it&squot;s an Ethernet frame, otherwise drop it */
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|skb-&gt;data
comma
l_string|&quot;&bslash;x03&bslash;x00&bslash;x80&bslash;x00&bslash;x80&bslash;xC2&bslash;x00&bslash;x07&quot;
comma
l_int|8
)paren
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
l_int|8
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
op_increment
id|chan-&gt;drvstats_rx_intr.rx_intr_bfr_not_passed_to_stack
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_errors
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_errors
suffix:semicolon
r_goto
id|rx_done
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* remove hardware header */
id|buf
op_assign
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wanrouter_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
)paren
(brace
multiline_comment|/* can&squot;t decapsulate packet */
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
op_increment
id|chan-&gt;drvstats_rx_intr.rx_intr_bfr_not_passed_to_stack
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_errors
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_errors
suffix:semicolon
r_goto
id|rx_done
suffix:semicolon
)brace
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
)brace
multiline_comment|/* Send a packed up the IP stack */
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
op_increment
id|chan-&gt;drvstats_rx_intr.rx_intr_bfr_passed_to_stack
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_packets
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.rx_packets
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|chan-&gt;ifstats.rx_bytes
op_add_assign
id|len_incl_hdr
suffix:semicolon
id|card-&gt;wandev.stats.rx_bytes
op_add_assign
id|len_incl_hdr
suffix:semicolon
macro_line|#endif
)brace
id|rx_done
suffix:colon
multiline_comment|/* Release buffer element and calculate a pointer to the next one */
id|frbuf-&gt;flag
op_assign
l_int|0
suffix:semicolon
id|card-&gt;rxmb
op_assign
op_increment
id|frbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|frbuf
OG
id|card-&gt;u.f.rxmb_last
)paren
id|card-&gt;rxmb
op_assign
id|card-&gt;u.f.rxmb_base
suffix:semicolon
)brace
multiline_comment|/*==================================================================&n; * tx_intr:&t;Transmit interrupt handler.&n; *&n; * Rationale:&n; *      If the board is busy transmitting, if_send() will&n; *      buffers a single packet and turn on&n; *      the tx interrupt. Tx interrupt will be called&n; *      by the board, once the firmware can send more&n; *      data. Thus, no polling is required.&t; &n; *&n; * Description:&n; *&t;Tx interrupt is called for each &n; *      configured dlci channel. Thus: &n; * &t;1. Obtain the netowrk interface based on the&n; *         dlci number.&n; *      2. Check that network interface is up and&n; *         properly setup.&n; * &t;3. Check for a buffered packed.&n; *      4. Transmit the packed.&n; *&t;5. If we are in WANPIPE mode, mark the &n; *         NET_BH handler. &n; *      6. If we are in API mode, kick&n; *         the AF_WANPIPE socket for more data. &n; *&t;   &n; */
DECL|function|tx_intr
r_static
r_void
id|tx_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
id|fr_tx_buf_ctl_t
op_star
id|bctl
suffix:semicolon
id|netdevice_t
op_star
id|dev
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|bctl
op_assign
(paren
r_void
op_star
)paren
(paren
id|flags-&gt;tse_offs
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
)brace
r_else
(brace
id|bctl
op_assign
(paren
r_void
op_star
)paren
(paren
id|flags-&gt;tse_offs
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
)brace
multiline_comment|/* Find the structure and make it unbusy */
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|flags-&gt;dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NO DEV IN TX Interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end_of_tx_intr
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|chan
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NO CHAN IN TX Interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end_of_tx_intr
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;transmit_length
op_logical_or
op_logical_neg
id|chan-&gt;delay_skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx int error - transmit length zero&bslash;n&quot;
comma
id|card-&gt;wandev.name
)paren
suffix:semicolon
r_goto
id|end_of_tx_intr
suffix:semicolon
)brace
multiline_comment|/* If the &squot;if_send()&squot; procedure is currently checking the &squot;tbusy&squot;&n;&t;   status, then we cannot transmit. Instead, we configure the microcode&n;&t;   so as to re-issue this transmit interrupt at a later stage. &n;&t;*/
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|SEND_TXIRQ_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|fr_dlci_interface_t
op_star
id|dlci_interface
op_assign
id|chan-&gt;dlci_int_interface
suffix:semicolon
id|bctl-&gt;flag
op_assign
l_int|0xA0
suffix:semicolon
id|dlci_interface-&gt;gen_interrupt
op_or_assign
id|FR_INTR_TXRDY
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|bctl-&gt;dlci
op_assign
id|flags-&gt;dlci
suffix:semicolon
id|bctl-&gt;length
op_assign
id|chan-&gt;transmit_length
op_plus
id|chan-&gt;fr_header_len
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|fr_send_hdr
c_func
(paren
id|card
comma
id|bctl-&gt;dlci
comma
id|bctl-&gt;offset
)paren
comma
id|chan-&gt;delay_skb-&gt;data
comma
id|chan-&gt;delay_skb-&gt;len
)paren
suffix:semicolon
id|bctl-&gt;flag
op_assign
l_int|0xC0
suffix:semicolon
op_increment
id|chan-&gt;ifstats.tx_packets
suffix:semicolon
op_increment
id|card-&gt;wandev.stats.tx_packets
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|chan-&gt;ifstats.tx_bytes
op_add_assign
id|chan-&gt;transmit_length
suffix:semicolon
id|card-&gt;wandev.stats.tx_bytes
op_add_assign
id|chan-&gt;transmit_length
suffix:semicolon
macro_line|#endif
multiline_comment|/* We must free an sk buffer, which we used&n;&t;&t; * for delayed transmission; Otherwise, the sock&n;&t;&t; * will run out of memory */
id|wan_dev_kfree_skb
c_func
(paren
id|chan-&gt;delay_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|chan-&gt;delay_skb
op_assign
l_int|NULL
suffix:semicolon
id|chan-&gt;transmit_length
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef LINUX_2_4
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
macro_line|#endif
macro_line|#ifdef LINUX_2_0
id|wake_net_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|is_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* If using API, than wakeup socket BH handler */
r_if
c_cond
(paren
id|chan-&gt;common.usedby
op_eq
id|API
)paren
(brace
id|start_net_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|wakeup_sk_bh
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|wake_net_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
id|end_of_tx_intr
suffix:colon
multiline_comment|/* if any other interfaces have transmit interrupts pending, &n;&t; * do not disable the global transmit interrupt */
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|card-&gt;u.f.tx_interrupts_pending
)paren
)paren
(brace
id|flags-&gt;imask
op_and_assign
op_complement
id|FR_INTR_TXRDY
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * timer_intr:&t;Timer interrupt handler.&n; *&n; * Rationale:&n; *&t;All commans must be executed within the timer&n; *      interrupt since no two commands should execute&n; *      at the same time.&n; *&n; * Description:&n; *&t;The timer interrupt is used to:&n; *    &t;1. Processing udp calls from &squot;fpipemon&squot;.&n; *    &t;2. Processing update calls from /proc file system&n; *   &t;3. Reading board-level statistics for &n; *         updating the proc file system.&n; *    &t;4. Sending inverse ARP request packets.&n; *&t;5. Configure a dlci/channel.&n; *&t;6. Unconfigure a dlci/channel. (Node only)&n; */
DECL|function|timer_intr
r_static
r_void
id|timer_intr
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
multiline_comment|/* UDP Debuging: fpipemon call */
r_if
c_cond
(paren
id|card-&gt;u.f.timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UDP
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;u.f.udp_type
op_eq
id|UDP_FPIPE_TYPE
)paren
(brace
r_if
c_cond
(paren
id|process_udp_mgmt_pkt
c_func
(paren
id|card
)paren
)paren
(brace
id|card-&gt;u.f.timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UDP
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* /proc update call : triggered from update() */
r_if
c_cond
(paren
id|card-&gt;u.f.timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UPDATE
)paren
(brace
id|fr_get_err_stats
c_func
(paren
id|card
)paren
suffix:semicolon
id|fr_get_stats
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;u.f.update_comms_stats
op_assign
l_int|0
suffix:semicolon
id|card-&gt;u.f.timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UPDATE
suffix:semicolon
)brace
multiline_comment|/* Update the channel state call.  This is call is&n;         * triggered by if_send() function */
r_if
c_cond
(paren
id|card-&gt;u.f.timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UPDATE_STATE
)paren
(brace
id|netdevice_t
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.state
op_eq
id|WAN_CONNECTED
)paren
(brace
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;common.state
op_ne
id|WAN_CONNECTED
)paren
(brace
id|update_chan_state
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
id|card-&gt;u.f.timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UPDATE_STATE
suffix:semicolon
)brace
multiline_comment|/* configure a dlci/channel */
r_if
c_cond
(paren
id|card-&gt;u.f.timer_int_enabled
op_amp
id|TMR_INT_ENABLED_CONFIG
)paren
(brace
id|config_fr
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;u.f.timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_CONFIG
suffix:semicolon
)brace
multiline_comment|/* unconfigure a dlci/channel */
r_if
c_cond
(paren
id|card-&gt;u.f.timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UNCONFIG
)paren
(brace
id|unconfig_fr
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;u.f.timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UNCONFIG
suffix:semicolon
)brace
multiline_comment|/* Transmit ARP packets */
r_if
c_cond
(paren
id|card-&gt;u.f.timer_int_enabled
op_amp
id|TMR_INT_ENABLED_ARP
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|netdevice_t
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;u.f.arp_dev
op_eq
l_int|NULL
)paren
id|card-&gt;u.f.arp_dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
op_assign
id|card-&gt;u.f.arp_dev
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* If the interface is brought down cancel sending In-ARPs */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;inarp_ready
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;inarp_ready
)paren
)paren
(brace
r_if
c_cond
(paren
id|check_tx_status
c_func
(paren
id|card
comma
id|dev
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|ARP_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|send_inarp_request
c_func
(paren
id|card
comma
id|dev
)paren
)paren
(brace
id|trigger_fr_arp
c_func
(paren
id|dev
)paren
suffix:semicolon
id|chan-&gt;inarp_tick
op_assign
id|jiffies
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;inarp_ready
)paren
suffix:semicolon
id|dev
op_assign
id|move_dev_to_next
c_func
(paren
id|card
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev
op_assign
id|move_dev_to_next
c_func
(paren
id|card
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_eq
id|card-&gt;wandev.new_if_cnt
)paren
(brace
id|card-&gt;u.f.timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_ARP
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|card-&gt;u.f.arp_dev
op_assign
id|dev
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.f.timer_int_enabled
)paren
(brace
id|flags-&gt;imask
op_and_assign
op_complement
id|FR_INTR_TIMER
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; * spur_intr:&t;Spurious interrupt handler.&n; * &n; * Description:&n; *  &t;We don&squot;t know this interrupt.&n; *      Print a warning.&n; */
DECL|function|spur_intr
r_static
r_void
id|spur_intr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: spurious interrupt!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//FIXME: Fix the IPX in next version
multiline_comment|/*===========================================================================&n; *  Return 0 for non-IPXWAN packet&n; *         1 for IPXWAN packet or IPX is not enabled!&n; *  FIXME: Use a IPX structure here not offsets&n; */
DECL|function|handle_IPXWAN
r_static
r_int
id|handle_IPXWAN
c_func
(paren
r_int
r_char
op_star
id|sendpacket
comma
r_char
op_star
id|devname
comma
r_int
r_char
id|enable_IPX
comma
r_int
r_int
id|network_number
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|1
)braket
op_eq
l_int|0x00
op_logical_and
id|sendpacket
(braket
l_int|2
)braket
op_eq
l_int|0x80
op_logical_and
id|sendpacket
(braket
l_int|6
)braket
op_eq
l_int|0x81
op_logical_and
id|sendpacket
(braket
l_int|7
)braket
op_eq
l_int|0x37
)paren
(brace
multiline_comment|/* It&squot;s an IPX packet */
r_if
c_cond
(paren
op_logical_neg
id|enable_IPX
)paren
(brace
multiline_comment|/* Return 1 so we don&squot;t pass it up the stack. */
singleline_comment|//FIXME: Take this out when IPX is fixed
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: WARNING: Unsupported IPX packet received and dropped&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* It&squot;s not IPX so return and pass it up the stack. */
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|24
)braket
op_eq
l_int|0x90
op_logical_and
id|sendpacket
(braket
l_int|25
)braket
op_eq
l_int|0x04
)paren
(brace
multiline_comment|/* It&squot;s IPXWAN */
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|10
)braket
op_eq
l_int|0x02
op_logical_and
id|sendpacket
(braket
l_int|42
)braket
op_eq
l_int|0x00
)paren
(brace
multiline_comment|/* It&squot;s a timer request packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received IPXWAN Timer Request packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
multiline_comment|/* Go through the routing options and answer no to every&n;&t;&t;&t; * option except Unnumbered RIP/SAP&n;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|49
suffix:semicolon
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x00
suffix:semicolon
id|i
op_add_assign
l_int|5
)paren
(brace
multiline_comment|/* 0x02 is the option for Unnumbered RIP/SAP */
r_if
c_cond
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|4
)braket
op_ne
l_int|0x02
)paren
(brace
id|sendpacket
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Skip over the extended Node ID option */
r_if
c_cond
(paren
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x04
)paren
(brace
id|i
op_add_assign
l_int|8
suffix:semicolon
)brace
multiline_comment|/* We also want to turn off all header compression opt.&n;&t;&t;&t; */
r_for
c_loop
(paren
suffix:semicolon
id|sendpacket
(braket
id|i
)braket
op_eq
l_int|0x80
suffix:semicolon
)paren
(brace
id|sendpacket
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|i
op_add_assign
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|sendpacket
(braket
id|i
op_plus
l_int|3
)braket
)paren
op_plus
l_int|4
suffix:semicolon
)brace
multiline_comment|/* Set the packet type to timer response */
id|sendpacket
(braket
l_int|42
)braket
op_assign
l_int|0x01
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending IPXWAN Timer Response&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sendpacket
(braket
l_int|42
)braket
op_eq
l_int|0x02
)paren
(brace
multiline_comment|/* This is an information request packet */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received IPXWAN Information Request packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
multiline_comment|/* Set the packet type to information response */
id|sendpacket
(braket
l_int|42
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* Set the router name */
id|sendpacket
(braket
l_int|59
)braket
op_assign
l_char|&squot;F&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|60
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|61
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|62
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|63
)braket
op_assign
l_char|&squot;E&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|64
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|sendpacket
(braket
l_int|65
)braket
op_assign
id|CVHexToAscii
c_func
(paren
id|network_number
op_rshift
l_int|28
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|66
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x0F000000
)paren
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|67
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x00F00000
)paren
op_rshift
l_int|20
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|68
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x000F0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|69
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x0000F000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|70
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x00000F00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|71
)braket
op_assign
id|CVHexToAscii
c_func
(paren
(paren
id|network_number
op_amp
l_int|0x000000F0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|72
)braket
op_assign
id|CVHexToAscii
c_func
(paren
id|network_number
op_amp
l_int|0x0000000F
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|73
suffix:semicolon
id|i
OL
l_int|107
suffix:semicolon
id|i
op_add_assign
l_int|1
)paren
(brace
id|sendpacket
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending IPXWAN Information Response packet&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unknown IPXWAN packet!&bslash;n&quot;
comma
id|devname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the WNodeID to our network address */
id|sendpacket
(braket
l_int|43
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_rshift
l_int|24
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|44
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|45
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|network_number
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sendpacket
(braket
l_int|46
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|network_number
op_amp
l_int|0x000000FF
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If we get here, its an IPX-data packet so it&squot;ll get passed up the &n;&t; * stack.&n;&t; * switch the network numbers &n;&t; */
id|switch_net_numbers
c_func
(paren
id|sendpacket
comma
id|network_number
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * process_route&n; * &n; * Rationale:&n; *&t;If the interface goes down, or we receive an ARP request,&n; *      we have to change the network interface ip addresses.&n; * &t;This cannot be done within the interrupt.&n; *&n; * Description:&n; *&n; * &t;This routine is called as a polling routine to dynamically &n; *&t;add/delete routes negotiated by inverse ARP.  It is in this &n; *    &t;&quot;task&quot; because we don&squot;t want routes to be added while in &n; *      interrupt context.&n; *&n; * Usage:&n; *&t;This function is called by fr_poll() polling funtion.&n; */
DECL|function|process_route
r_static
r_void
id|process_route
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
r_struct
id|ifreq
id|if_info
suffix:semicolon
r_struct
id|sockaddr_in
op_star
id|if_data
suffix:semicolon
id|mm_segment_t
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|u32
id|ip_tmp
suffix:semicolon
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|chan-&gt;route_flag
)paren
(brace
r_case
id|ADD_ROUTE
suffix:colon
multiline_comment|/* Set remote addresses */
id|memset
c_func
(paren
op_amp
id|if_info
comma
l_int|0
comma
r_sizeof
(paren
id|if_info
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|if_info.ifr_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* get user space block */
id|if_data
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_dstaddr
suffix:semicolon
id|if_data-&gt;sin_addr.s_addr
op_assign
id|chan-&gt;ip_remote
suffix:semicolon
id|if_data-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFDSTADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
multiline_comment|/* restore old block */
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Route Add failed.  Error: %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Address: %u.%u.%u.%u&bslash;n&quot;
comma
id|chan-&gt;name
comma
id|NIPQUAD
c_func
(paren
id|chan-&gt;ip_remote
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Route Added Successfully: %u.%u.%u.%U&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|NIPQUAD
c_func
(paren
id|chan-&gt;ip_remote
)paren
)paren
suffix:semicolon
id|chan-&gt;route_flag
op_assign
id|ROUTE_ADDED
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REMOVE_ROUTE
suffix:colon
multiline_comment|/* Set remote addresses */
id|memset
c_func
(paren
op_amp
id|if_info
comma
l_int|0
comma
r_sizeof
(paren
id|if_info
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|if_info.ifr_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ip_tmp
op_assign
id|get_ip_address
c_func
(paren
id|dev
comma
id|WAN_POINTOPOINT_IP
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* get user space block */
id|if_data
op_assign
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|if_info.ifr_dstaddr
suffix:semicolon
id|if_data-&gt;sin_addr.s_addr
op_assign
l_int|0
suffix:semicolon
id|if_data-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|err
op_assign
id|devinet_ioctl
c_func
(paren
id|SIOCSIFDSTADDR
comma
op_amp
id|if_info
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Deleting of route failed.  Error: %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Address: %u.%u.%u.%u&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|NIPQUAD
c_func
(paren
id|chan-&gt;ip_remote
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Route Removed Sucessfuly: %u.%u.%u.%u&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|NIPQUAD
c_func
(paren
id|ip_tmp
)paren
)paren
suffix:semicolon
id|chan-&gt;route_flag
op_assign
id|NO_ROUTE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Case Statement */
macro_line|#else
multiline_comment|/* Dynamic Route adding/removing */
r_struct
id|rtentry
id|route
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|route
comma
l_int|0
comma
r_sizeof
(paren
id|route
)paren
)paren
suffix:semicolon
id|route.rt_dev
op_assign
id|dev-&gt;name
suffix:semicolon
id|route.rt_flags
op_assign
l_int|0
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_dst
)paren
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
op_assign
id|dev-&gt;pa_dstaddr
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_dst
)paren
)paren
op_member_access_from_pointer
id|sin_family
op_assign
id|AF_INET
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_genmask
)paren
)paren
op_member_access_from_pointer
id|sin_addr.s_addr
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
(paren
id|route.rt_genmask
)paren
)paren
op_member_access_from_pointer
id|sin_family
op_assign
id|AF_INET
suffix:semicolon
r_switch
c_cond
(paren
id|chan-&gt;route_flag
)paren
(brace
r_case
id|ADD_ROUTE
suffix:colon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* get user space block */
id|err
op_assign
id|ip_rt_new
c_func
(paren
op_amp
id|route
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
multiline_comment|/* restore old block */
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Adding of route failed.  Error: %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Address: %u.%u.%u.%u&bslash;n&quot;
comma
id|chan-&gt;name
comma
id|NIPQUAD
c_func
(paren
id|dev-&gt;pa_dstaddr
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;route_flag
op_assign
id|ROUTE_ADDED
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REMOVE_ROUTE
suffix:colon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* get user space block */
id|err
op_assign
id|ip_rt_kill
c_func
(paren
op_amp
id|route
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
multiline_comment|/* restore old block */
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Deleting of route failed.  Error: %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Address: %u.%u.%u.%u&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|NIPQUAD
c_func
(paren
id|dev-&gt;pa_dstaddr
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Removed route.&bslash;n&quot;
comma
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
id|chan-&gt;route_flag
op_assign
id|NO_ROUTE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
macro_line|#endif&t;
)brace
multiline_comment|/****** Frame Relay Firmware-Specific Functions *****************************/
multiline_comment|/*============================================================================&n; * Read firmware code version.&n; * o fill string str with firmware version info. &n; */
DECL|function|fr_read_version
r_static
r_int
id|fr_read_version
(paren
id|sdla_t
op_star
id|card
comma
r_char
op_star
id|str
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_CODE_VERSION
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|str
)paren
(brace
r_int
id|len
op_assign
id|mbox-&gt;cmd.length
suffix:semicolon
id|memcpy
c_func
(paren
id|str
comma
id|mbox-&gt;data
comma
id|len
)paren
suffix:semicolon
id|str
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set global configuration.&n; */
DECL|function|fr_configure
r_static
r_int
id|fr_configure
(paren
id|sdla_t
op_star
id|card
comma
id|fr_conf_t
op_star
id|conf
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|dlci_num
op_assign
id|card-&gt;u.f.dlci_num
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
r_do
(brace
id|memcpy
c_func
(paren
id|mbox-&gt;data
comma
id|conf
comma
r_sizeof
(paren
id|fr_conf_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlci_num
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dlci_num
suffix:semicolon
op_increment
id|i
)paren
(paren
(paren
id|fr_conf_t
op_star
)paren
id|mbox-&gt;data
)paren
op_member_access_from_pointer
id|dlci
(braket
id|i
)braket
op_assign
id|card-&gt;u.f.node_dlci
(braket
id|i
)braket
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
id|fr_conf_t
)paren
op_plus
id|dlci_num
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
multiline_comment|/*NC Oct 12 2000 */
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Frame Relay Configuration Failed: rc=0x%x&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|err
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set DLCI configuration.&n; */
DECL|function|fr_dlci_configure
r_static
r_int
id|fr_dlci_configure
(paren
id|sdla_t
op_star
id|card
comma
id|fr_dlc_conf_t
op_star
id|conf
comma
r_int
id|dlci
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memcpy
c_func
(paren
id|mbox-&gt;data
comma
id|conf
comma
r_sizeof
(paren
id|fr_dlc_conf_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
(paren
r_int
r_int
)paren
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
id|fr_dlc_conf_t
)paren
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set interrupt mode.&n; */
DECL|function|fr_set_intr_mode
r_static
r_int
id|fr_set_intr_mode
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|mode
comma
r_int
id|mtu
comma
r_int
r_int
id|timeout
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
id|fr508_intr_ctl_t
op_star
id|ictl
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|memset
c_func
(paren
id|ictl
comma
l_int|0
comma
r_sizeof
(paren
id|fr508_intr_ctl_t
)paren
)paren
suffix:semicolon
id|ictl-&gt;mode
op_assign
id|mode
suffix:semicolon
id|ictl-&gt;tx_len
op_assign
id|mtu
suffix:semicolon
id|ictl-&gt;irq
op_assign
id|card-&gt;hw.irq
suffix:semicolon
multiline_comment|/* indicate timeout on timer */
r_if
c_cond
(paren
id|mode
op_amp
l_int|0x20
)paren
id|ictl-&gt;timeout
op_assign
id|timeout
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
id|fr508_intr_ctl_t
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_INTR_MODE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Enable communications.&n; */
DECL|function|fr_comm_enable
r_static
r_int
id|fr_comm_enable
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_COMM_ENABLE
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * fr_comm_disable &n; *&n; * Warning: This functin is called by the shutdown() procedure. It is void&n; *          since dev-&gt;priv are has already been deallocated and no&n; *          error checking is possible using fr_event() function.&n; */
DECL|function|fr_comm_disable
r_static
r_void
id|fr_comm_disable
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_MODEM_STATUS
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
)paren
suffix:semicolon
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_COMM_DISABLE
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get communications error statistics. &n; */
DECL|function|fr_get_err_stats
r_static
r_int
id|fr_get_err_stats
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_ERROR_STATS
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|fr_comm_stat_t
op_star
id|stats
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_over_errors
op_assign
id|stats-&gt;rx_overruns
suffix:semicolon
id|card-&gt;wandev.stats.rx_crc_errors
op_assign
id|stats-&gt;rx_bad_crc
suffix:semicolon
id|card-&gt;wandev.stats.rx_missed_errors
op_assign
id|stats-&gt;rx_aborts
suffix:semicolon
id|card-&gt;wandev.stats.rx_length_errors
op_assign
id|stats-&gt;rx_too_long
suffix:semicolon
id|card-&gt;wandev.stats.tx_aborted_errors
op_assign
id|stats-&gt;tx_aborts
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Get statistics. &n; */
DECL|function|fr_get_stats
r_static
r_int
id|fr_get_stats
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_STATISTICS
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|fr_link_stat_t
op_star
id|stats
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|card-&gt;wandev.stats.rx_frame_errors
op_assign
id|stats-&gt;rx_bad_format
suffix:semicolon
id|card-&gt;wandev.stats.rx_dropped
op_assign
id|stats-&gt;rx_dropped
op_plus
id|stats-&gt;rx_dropped2
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Add DLCI(s) (Access Node only!).&n; * This routine will perform the ADD_DLCIs command for the specified DLCI.&n; */
DECL|function|fr_add_dlci
r_static
r_int
id|fr_add_dlci
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
r_int
r_int
op_star
id|dlci_list
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|dlci_list
(braket
l_int|0
)braket
op_assign
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_ADD_DLCI
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Activate DLCI(s) (Access Node only!). &n; * This routine will perform the ACTIVATE_DLCIs command with a DLCI number. &n; */
DECL|function|fr_activate_dlci
r_static
r_int
id|fr_activate_dlci
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
r_int
r_int
op_star
id|dlci_list
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|dlci_list
(braket
l_int|0
)braket
op_assign
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_ACTIVATE_DLCI
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Delete DLCI(s) (Access Node only!). &n; * This routine will perform the DELETE_DLCIs command with a DLCI number. &n; */
DECL|function|fr_delete_dlci
r_static
r_int
id|fr_delete_dlci
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
r_int
r_int
op_star
id|dlci_list
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|dlci_list
(braket
l_int|0
)braket
op_assign
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_DELETE_DLCI
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Issue in-channel signalling frame. &n; */
DECL|function|fr_issue_isf
r_static
r_int
id|fr_issue_isf
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|isf
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
id|isf
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_ISSUE_IS_FRAME
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|fr_send_hdr
r_static
r_int
r_int
id|fr_send_hdr
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
r_int
id|offset
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|dlci
)paren
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
(paren
id|chan
op_assign
id|dev-&gt;priv
)paren
)paren
r_return
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;fr_header_len
)paren
(brace
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|offset
comma
id|chan-&gt;fr_header
comma
id|chan-&gt;fr_header_len
)paren
suffix:semicolon
)brace
r_return
id|offset
op_plus
id|chan-&gt;fr_header_len
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Send a frame on a selected DLCI.  &n; */
DECL|function|fr_send_data_header
r_static
r_int
id|fr_send_data_header
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
r_char
id|attr
comma
r_int
id|len
comma
r_void
op_star
id|buf
comma
r_int
r_char
id|hdr_len
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
op_plus
l_int|0x800
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.dlci
op_assign
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.attr
op_assign
id|attr
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|len
op_plus
id|hdr_len
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_WRITE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|fr_tx_buf_ctl_t
op_star
id|frbuf
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|frbuf
op_assign
(paren
r_void
op_star
)paren
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|mbox-&gt;data
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
)brace
r_else
id|frbuf
op_assign
(paren
r_void
op_star
)paren
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|mbox-&gt;data
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|fr_send_hdr
c_func
(paren
id|card
comma
id|dlci
comma
id|frbuf-&gt;offset
)paren
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|frbuf-&gt;flag
op_assign
l_int|0x01
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|fr_send
r_static
r_int
id|fr_send
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
comma
r_int
r_char
id|attr
comma
r_int
id|len
comma
r_void
op_star
id|buf
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
op_plus
l_int|0x800
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.dlci
op_assign
id|dlci
suffix:semicolon
id|mbox-&gt;cmd.attr
op_assign
id|attr
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|len
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_WRITE
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|fr_tx_buf_ctl_t
op_star
id|frbuf
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|frbuf
op_assign
(paren
r_void
op_star
)paren
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|mbox-&gt;data
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
)brace
r_else
id|frbuf
op_assign
(paren
r_void
op_star
)paren
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|mbox-&gt;data
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|frbuf-&gt;offset
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|frbuf-&gt;flag
op_assign
l_int|0x01
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/****** Firmware Asynchronous Event Handlers ********************************/
multiline_comment|/*============================================================================&n; * Main asyncronous event/error handler.&n; *&t;This routine is called whenever firmware command returns non-zero&n; *&t;return code.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
DECL|function|fr_event
r_static
r_int
id|fr_event
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|event
comma
id|fr_mbox_t
op_star
id|mbox
)paren
(brace
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_char
op_star
id|ptr
op_assign
op_amp
id|flags-&gt;iflag
suffix:semicolon
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|FRRES_MODEM_FAILURE
suffix:colon
r_return
id|fr_modem_failure
c_func
(paren
id|card
comma
id|mbox
)paren
suffix:semicolon
r_case
id|FRRES_CHANNEL_DOWN
suffix:colon
(brace
id|netdevice_t
op_star
id|dev
suffix:semicolon
multiline_comment|/* Remove all routes from associated DLCI&squot;s */
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;route_flag
op_eq
id|ROUTE_ADDED
)paren
(brace
id|chan-&gt;route_flag
op_assign
id|REMOVE_ROUTE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;inarp
op_eq
id|INARP_CONFIGURED
)paren
(brace
id|chan-&gt;inarp
op_assign
id|INARP_REQUEST
suffix:semicolon
)brace
multiline_comment|/* If the link becomes disconnected then,&n;                                 * all channels will be disconnected&n;                                 * as well.&n;                                 */
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_case
id|FRRES_CHANNEL_UP
suffix:colon
(brace
id|netdevice_t
op_star
id|dev
suffix:semicolon
multiline_comment|/* FIXME: Only startup devices that are on the list */
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
)paren
(brace
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
)brace
id|wanpipe_set_state
c_func
(paren
id|card
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_case
id|FRRES_DLCI_CHANGE
suffix:colon
r_return
id|fr_dlci_change
c_func
(paren
id|card
comma
id|mbox
)paren
suffix:semicolon
r_case
id|FRRES_DLCI_MISMATCH
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI list mismatch!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
id|CMD_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: command 0x%02X timed out!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mbox-&gt;cmd.command
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ID Bytes = &quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;0x%02X &quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|0x18
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FRRES_DLCI_INACTIVE
suffix:colon
r_break
suffix:semicolon
r_case
id|FRRES_CIR_OVERFLOW
suffix:colon
r_break
suffix:semicolon
r_case
id|FRRES_BUFFER_OVERFLOW
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: command 0x%02X returned 0x%02X!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mbox-&gt;cmd.command
comma
id|event
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle modem error.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
DECL|function|fr_modem_failure
r_static
r_int
id|fr_modem_failure
(paren
id|sdla_t
op_star
id|card
comma
id|fr_mbox_t
op_star
id|mbox
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: physical link down! (modem error 0x%02X)&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|mbox-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mbox-&gt;cmd.command
)paren
(brace
r_case
id|FR_WRITE
suffix:colon
r_case
id|FR_READ
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Handle DLCI status change.&n; *&n; * Return zero if previous command has to be cancelled.&n; */
DECL|function|fr_dlci_change
r_static
r_int
id|fr_dlci_change
(paren
id|sdla_t
op_star
id|card
comma
id|fr_mbox_t
op_star
id|mbox
)paren
(brace
id|dlci_status_t
op_star
id|status
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
r_int
id|cnt
op_assign
id|mbox-&gt;cmd.length
op_div
r_sizeof
(paren
id|dlci_status_t
)paren
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
id|netdevice_t
op_star
id|dev2
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|cnt
suffix:semicolon
op_decrement
id|cnt
comma
op_increment
id|status
)paren
(brace
r_int
r_int
id|dlci
op_assign
id|status-&gt;dlci
suffix:semicolon
id|netdevice_t
op_star
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CPE contains unconfigured DLCI= %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unconfigured DLCI %d reported by network&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|status-&gt;state
op_eq
id|FR_LINK_INOPER
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI %u is inactive!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
id|is_dev_running
c_func
(paren
id|dev
)paren
)paren
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status-&gt;state
op_amp
id|FR_DLCI_DELETED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI %u has been deleted!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
id|is_dev_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;route_flag
op_eq
id|ROUTE_ADDED
)paren
(brace
id|chan-&gt;route_flag
op_assign
id|REMOVE_ROUTE
suffix:semicolon
multiline_comment|/* The state change will trigger&n;                                                 * the fr polling routine */
)brace
r_if
c_cond
(paren
id|chan-&gt;inarp
op_eq
id|INARP_CONFIGURED
)paren
(brace
id|chan-&gt;inarp
op_assign
id|INARP_REQUEST
suffix:semicolon
)brace
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|status-&gt;state
op_amp
id|FR_DLCI_ACTIVE
)paren
(brace
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* This flag is used for configuring specific &n;&t;&t;&t;&t;   DLCI(s) when they become active.&n;&t;&t;&t; &t;*/
id|chan-&gt;dlci_configured
op_assign
id|DLCI_CONFIG_PENDING
suffix:semicolon
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|dev2
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev2
suffix:semicolon
id|dev2
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev2-&gt;priv
)paren
)paren
(brace
id|chan
op_assign
id|dev2-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;dlci_configured
op_eq
id|DLCI_CONFIG_PENDING
)paren
(brace
r_if
c_cond
(paren
id|fr_init_dlci
c_func
(paren
id|card
comma
id|chan
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|fr_init_dlci
r_static
r_int
id|fr_init_dlci
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
(brace
id|fr_dlc_conf_t
id|cfg
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cfg
comma
l_int|0
comma
r_sizeof
(paren
id|cfg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;cir_status
op_eq
id|CIR_DISABLED
)paren
(brace
id|cfg.cir_fwd
op_assign
id|cfg.cir_bwd
op_assign
l_int|16
suffix:semicolon
id|cfg.bc_fwd
op_assign
id|cfg.bc_bwd
op_assign
l_int|16
suffix:semicolon
id|cfg.conf_flags
op_assign
l_int|0x0001
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;cir_status
op_eq
id|CIR_ENABLED
)paren
(brace
id|cfg.cir_fwd
op_assign
id|cfg.cir_bwd
op_assign
id|chan-&gt;cir
suffix:semicolon
id|cfg.bc_fwd
op_assign
id|cfg.bc_bwd
op_assign
id|chan-&gt;bc
suffix:semicolon
id|cfg.be_fwd
op_assign
id|cfg.be_bwd
op_assign
id|chan-&gt;be
suffix:semicolon
id|cfg.conf_flags
op_assign
l_int|0x0000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fr_dlci_configure
c_func
(paren
id|card
comma
op_amp
id|cfg
comma
id|chan-&gt;dlci
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI Configure failed for %d&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|chan-&gt;dlci_configured
op_assign
id|DLCI_CONFIGURED
suffix:semicolon
multiline_comment|/* Read the interface byte mapping into the channel &n;&t; * structure.&n;&t; */
id|read_DLCI_IB_mapping
c_func
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******* Miscellaneous ******************************************************/
multiline_comment|/*============================================================================&n; * Update channel state. &n; */
DECL|function|update_chan_state
r_static
r_int
id|update_chan_state
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_LIST_ACTIVE_DLCI
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
r_int
r_int
op_star
id|list
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
r_int
id|cnt
op_assign
id|mbox-&gt;cmd.length
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|err
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|cnt
suffix:semicolon
op_decrement
id|cnt
comma
op_increment
id|list
)paren
(brace
r_if
c_cond
(paren
op_star
id|list
op_eq
id|chan-&gt;dlci
)paren
(brace
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_CONNECTED
)paren
suffix:semicolon
multiline_comment|/* May 23 2000. NC&n;&t;&t;&t;&t; * When a dlci is added or restarted,&n;                                 * the dlci_int_interface pointer must&n;&t;&t;&t;&t; * be reinitialized.  */
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;dlci_int_interface
)paren
(brace
id|err
op_assign
id|fr_init_dlci
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Set channel state.&n; */
DECL|function|set_chan_state
r_static
r_void
id|set_chan_state
(paren
id|netdevice_t
op_star
id|dev
comma
r_int
id|state
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;common.state
op_ne
id|state
)paren
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|WAN_CONNECTED
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s: DLCI %d connected&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
multiline_comment|/* If the interface was previoulsy down,&n;                                 * bring it up, since the channel is active */
id|trigger_fr_poll
(paren
id|dev
)paren
suffix:semicolon
id|trigger_fr_arp
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s: DLCI %d connecting&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s: DLCI %d disconnected!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
multiline_comment|/* If the interface is up, bring it down,&n;                                 * since the channel is now disconnected */
id|trigger_fr_poll
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|chan-&gt;common.state
op_assign
id|state
suffix:semicolon
)brace
id|chan-&gt;state_tick
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Find network device by its channel number.&n; *&n; * We need this critical flag because we change&n; * the dlci_to_dev_map outside the interrupt.&n; *&n; * NOTE: del_if() functions updates this array, it uses&n; *       the spin locks to avoid corruption.&n; */
DECL|function|find_channel
r_static
id|netdevice_t
op_star
id|find_channel
(paren
id|sdla_t
op_star
id|card
comma
r_int
id|dlci
)paren
(brace
r_if
c_cond
(paren
id|dlci
OG
id|HIGHEST_VALID_DLCI
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|card-&gt;u.f.dlci_to_dev_map
(braket
id|dlci
)braket
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Check to see if a frame can be sent. If no transmit buffers available,&n; * enable transmit interrupts.&n; *&n; * Return:&t;1 - Tx buffer(s) available&n; *&t;&t;0 - no buffers available&n; */
DECL|function|is_tx_ready
r_static
r_int
id|is_tx_ready
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
(brace
r_int
r_char
id|sb
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|sb
op_assign
id|inb
c_func
(paren
id|card-&gt;hw.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
op_amp
l_int|0x02
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Convert decimal string to unsigned integer.&n; * If len != 0 then only &squot;len&squot; characters of the string are converted.&n; */
DECL|function|dec_to_uint
r_static
r_int
r_int
id|dec_to_uint
(paren
r_int
r_char
op_star
id|str
comma
r_int
id|len
)paren
(brace
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
r_for
c_loop
(paren
id|val
op_assign
l_int|0
suffix:semicolon
id|len
op_logical_and
id|is_digit
c_func
(paren
op_star
id|str
)paren
suffix:semicolon
op_increment
id|str
comma
op_decrement
id|len
)paren
id|val
op_assign
(paren
id|val
op_star
l_int|10
)paren
op_plus
(paren
op_star
id|str
op_minus
(paren
r_int
)paren
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*=============================================================================&n; * Store a UDP management packet for later processing.&n; */
DECL|function|store_udp_mgmt_pkt
r_static
r_int
id|store_udp_mgmt_pkt
c_func
(paren
r_int
id|udp_type
comma
r_char
id|udp_pkt_src
comma
id|sdla_t
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|dlci
)paren
(brace
r_int
id|udp_pkt_stored
op_assign
l_int|0
suffix:semicolon
id|netdevice_t
op_star
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|dlci
)paren
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
(paren
id|chan
op_assign
id|dev-&gt;priv
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;u.f.udp_pkt_lgth
op_logical_and
(paren
id|skb-&gt;len
op_le
id|MAX_LGTH_UDP_MGNT_PKT
)paren
)paren
(brace
id|card-&gt;u.f.udp_pkt_lgth
op_assign
id|skb-&gt;len
op_plus
id|chan-&gt;fr_header_len
suffix:semicolon
id|card-&gt;u.f.udp_type
op_assign
id|udp_type
suffix:semicolon
id|card-&gt;u.f.udp_pkt_src
op_assign
id|udp_pkt_src
suffix:semicolon
id|card-&gt;u.f.udp_dlci
op_assign
id|dlci
suffix:semicolon
id|memcpy
c_func
(paren
id|card-&gt;u.f.udp_pkt_data
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|card-&gt;u.f.timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_UDP
suffix:semicolon
id|udp_pkt_stored
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ERROR: UDP packet not stored for DLCI %d&bslash;n&quot;
comma
id|dlci
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|udp_pkt_src
op_eq
id|UDP_PKT_FRM_STACK
)paren
(brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_else
(brace
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
r_return
id|udp_pkt_stored
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Process UDP call of type FPIPE8ND&n; */
DECL|function|process_udp_mgmt_pkt
r_static
r_int
id|process_udp_mgmt_pkt
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
r_int
id|c_retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
r_char
id|frames
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
r_int
id|buffer_length
suffix:semicolon
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_int
id|udp_mgmt_req_valid
op_assign
l_int|1
suffix:semicolon
id|netdevice_t
op_star
id|dev
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
id|fr_udp_pkt_t
op_star
id|fr_udp_pkt
suffix:semicolon
r_int
r_int
id|num_trc_els
suffix:semicolon
id|fr_trc_el_t
op_star
id|ptr_trc_el
suffix:semicolon
id|fr_trc_el_t
id|trc_el
suffix:semicolon
id|fpipemon_trc_t
op_star
id|fpipemon_trc
suffix:semicolon
r_char
id|udp_pkt_src
op_assign
id|card-&gt;u.f.udp_pkt_src
suffix:semicolon
r_int
id|dlci
op_assign
id|card-&gt;u.f.udp_dlci
suffix:semicolon
multiline_comment|/* Find network interface for this packet */
id|dev
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|card-&gt;u.f.udp_pkt_lgth
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|chan
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
(brace
id|card-&gt;u.f.udp_pkt_lgth
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If the UDP packet is from the network, we are going to have to &n;&t;   transmit a response. Before doing so, we must check to see that&n;&t;   we are not currently transmitting a frame (in &squot;if_send()&squot;) and&n;&t;   that we are not already in a &squot;delayed transmit&squot; state.&n;&t;*/
r_if
c_cond
(paren
id|udp_pkt_src
op_eq
id|UDP_PKT_FRM_NETWORK
)paren
(brace
r_if
c_cond
(paren
id|check_tx_status
c_func
(paren
id|card
comma
id|dev
)paren
)paren
(brace
id|card-&gt;u.f.udp_pkt_lgth
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|fr_udp_pkt
op_assign
(paren
id|fr_udp_pkt_t
op_star
)paren
id|card-&gt;u.f.udp_pkt_data
suffix:semicolon
r_if
c_cond
(paren
id|udp_pkt_src
op_eq
id|UDP_PKT_FRM_NETWORK
)paren
(brace
r_switch
c_cond
(paren
id|fr_udp_pkt-&gt;cblock.command
)paren
(brace
r_case
id|FR_READ_MODEM_STATUS
suffix:colon
r_case
id|FR_READ_STATUS
suffix:colon
r_case
id|FPIPE_ROUTER_UP_TIME
suffix:colon
r_case
id|FR_READ_ERROR_STATS
suffix:colon
r_case
id|FPIPE_DRIVER_STAT_GEN
suffix:colon
r_case
id|FR_READ_STATISTICS
suffix:colon
r_case
id|FR_READ_ADD_DLC_STATS
suffix:colon
r_case
id|FR_READ_CONFIG
suffix:colon
r_case
id|FR_READ_CODE_VERSION
suffix:colon
id|udp_mgmt_req_valid
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|udp_mgmt_req_valid
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|udp_mgmt_req_valid
)paren
(brace
multiline_comment|/* set length to 0 */
id|fr_udp_pkt-&gt;cblock.length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set return code */
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0xCD
suffix:semicolon
id|chan-&gt;drvstats_gen.UDP_PIPE_mgmt_direction_err
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Warning, Illegal UDP command attempted from network: %x&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|fr_udp_pkt-&gt;cblock.command
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|fr_udp_pkt-&gt;cblock.command
)paren
(brace
r_case
id|FPIPE_ENABLE_TRACING
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;TracingEnabled
)paren
(brace
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_TRACE_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
l_int|0x00
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
id|fr_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_or
id|RESET_TRC
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|c_retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|card-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set the return code */
id|fr_udp_pkt-&gt;cblock.result
op_assign
id|mbox-&gt;cmd.result
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|NO_TRC_ELEMENTS_OFF
comma
op_amp
id|num_trc_els
comma
l_int|2
)paren
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|BASE_TRC_ELEMENTS_OFF
comma
op_amp
id|card-&gt;u.f.trc_el_base
comma
l_int|4
)paren
suffix:semicolon
id|card-&gt;u.f.curr_trc_el
op_assign
id|card-&gt;u.f.trc_el_base
suffix:semicolon
id|card-&gt;u.f.trc_el_last
op_assign
id|card-&gt;u.f.curr_trc_el
op_plus
(paren
(paren
id|num_trc_els
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
id|fr_trc_el_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Calculate the maximum trace data area in */
multiline_comment|/* the UDP packet */
id|card-&gt;u.f.trc_bfr_space
op_assign
(paren
id|MAX_LGTH_UDP_MGNT_PKT
op_minus
singleline_comment|//sizeof(fr_encap_hdr_t) -
r_sizeof
(paren
id|ip_pkt_t
)paren
op_minus
r_sizeof
(paren
id|udp_pkt_t
)paren
op_minus
r_sizeof
(paren
id|wp_mgmt_t
)paren
op_minus
r_sizeof
(paren
id|cblock_t
)paren
)paren
suffix:semicolon
multiline_comment|/* set return code */
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* set return code to line trace already &n;&t;&t;&t;&t;   enabled */
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|1
suffix:semicolon
)brace
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|card-&gt;TracingEnabled
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FPIPE_DISABLE_TRACING
suffix:colon
r_if
c_cond
(paren
id|card-&gt;TracingEnabled
)paren
(brace
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_TRACE_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
l_int|0x00
suffix:semicolon
id|mbox-&gt;data
(braket
l_int|0
)braket
op_assign
op_complement
id|ACTIVATE_TRC
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|c_retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* set return code */
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|card-&gt;TracingEnabled
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FPIPE_GET_TRACE_INFO
suffix:colon
multiline_comment|/* Line trace cannot be performed on the 502 */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;TracingEnabled
)paren
(brace
multiline_comment|/* set return code */
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|1
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
(paren
r_void
op_star
)paren
id|ptr_trc_el
op_assign
id|card-&gt;u.f.curr_trc_el
suffix:semicolon
id|buffer_length
op_assign
l_int|0
suffix:semicolon
id|fr_udp_pkt-&gt;data
(braket
l_int|0x00
)braket
op_assign
l_int|0x00
suffix:semicolon
r_for
c_loop
(paren
id|frames
op_assign
l_int|0
suffix:semicolon
id|frames
OL
id|MAX_FRMS_TRACED
suffix:semicolon
id|frames
op_increment
)paren
(brace
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
(paren
r_int
r_int
)paren
id|ptr_trc_el
comma
(paren
r_void
op_star
)paren
op_amp
id|trc_el.flag
comma
r_sizeof
(paren
id|fr_trc_el_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trc_el.flag
op_eq
l_int|0x00
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|card-&gt;u.f.trc_bfr_space
op_minus
id|buffer_length
)paren
OL
r_sizeof
(paren
id|fpipemon_trc_hdr_t
)paren
)paren
(brace
id|fr_udp_pkt-&gt;data
(braket
l_int|0x00
)braket
op_or_assign
id|MORE_TRC_DATA
suffix:semicolon
r_break
suffix:semicolon
)brace
id|fpipemon_trc
op_assign
(paren
id|fpipemon_trc_t
op_star
)paren
op_amp
id|fr_udp_pkt-&gt;data
(braket
id|buffer_length
)braket
suffix:semicolon
id|fpipemon_trc-&gt;fpipemon_trc_hdr.status
op_assign
id|trc_el.attr
suffix:semicolon
id|fpipemon_trc-&gt;fpipemon_trc_hdr.tmstamp
op_assign
id|trc_el.tmstamp
suffix:semicolon
id|fpipemon_trc-&gt;fpipemon_trc_hdr.length
op_assign
id|trc_el.length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|trc_el.offset
op_logical_or
op_logical_neg
id|trc_el.length
)paren
(brace
id|fpipemon_trc-&gt;fpipemon_trc_hdr.data_passed
op_assign
l_int|0x00
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|trc_el.length
op_plus
r_sizeof
(paren
id|fpipemon_trc_hdr_t
)paren
op_plus
l_int|1
)paren
OG
(paren
id|card-&gt;u.f.trc_bfr_space
op_minus
id|buffer_length
)paren
)paren
(brace
id|fpipemon_trc-&gt;fpipemon_trc_hdr.data_passed
op_assign
l_int|0x00
suffix:semicolon
id|fr_udp_pkt-&gt;data
(braket
l_int|0x00
)braket
op_or_assign
id|MORE_TRC_DATA
suffix:semicolon
)brace
r_else
(brace
id|fpipemon_trc-&gt;fpipemon_trc_hdr.data_passed
op_assign
l_int|0x01
suffix:semicolon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
id|trc_el.offset
comma
id|fpipemon_trc-&gt;data
comma
id|trc_el.length
)paren
suffix:semicolon
)brace
id|trc_el.flag
op_assign
l_int|0x00
suffix:semicolon
id|sdla_poke
c_func
(paren
op_amp
id|card-&gt;hw
comma
(paren
r_int
r_int
)paren
id|ptr_trc_el
comma
op_amp
id|trc_el.flag
comma
l_int|1
)paren
suffix:semicolon
id|ptr_trc_el
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
r_void
op_star
)paren
id|ptr_trc_el
OG
id|card-&gt;u.f.trc_el_last
)paren
(brace
(paren
r_void
op_star
)paren
id|ptr_trc_el
op_assign
id|card-&gt;u.f.trc_el_base
suffix:semicolon
)brace
id|buffer_length
op_add_assign
r_sizeof
(paren
id|fpipemon_trc_hdr_t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fpipemon_trc-&gt;fpipemon_trc_hdr.data_passed
)paren
(brace
id|buffer_length
op_add_assign
id|trc_el.length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fr_udp_pkt-&gt;data
(braket
l_int|0x00
)braket
op_amp
id|MORE_TRC_DATA
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|frames
op_eq
id|MAX_FRMS_TRACED
)paren
(brace
id|fr_udp_pkt-&gt;data
(braket
l_int|0x00
)braket
op_or_assign
id|MORE_TRC_DATA
suffix:semicolon
)brace
id|card-&gt;u.f.curr_trc_el
op_assign
(paren
r_void
op_star
)paren
id|ptr_trc_el
suffix:semicolon
multiline_comment|/* set the total number of frames passed */
id|fr_udp_pkt-&gt;data
(braket
l_int|0x00
)braket
op_or_assign
(paren
(paren
id|frames
op_lshift
l_int|1
)paren
op_amp
(paren
id|MAX_FRMS_TRACED
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* set the data length and return code */
id|fr_udp_pkt-&gt;cblock.length
op_assign
id|mbox-&gt;cmd.length
op_assign
id|buffer_length
suffix:semicolon
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FPIPE_FT1_READ_STATUS
suffix:colon
id|sdla_peek
c_func
(paren
op_amp
id|card-&gt;hw
comma
l_int|0xF020
comma
op_amp
id|fr_udp_pkt-&gt;data
(braket
l_int|0x00
)braket
comma
l_int|2
)paren
suffix:semicolon
id|fr_udp_pkt-&gt;cblock.length
op_assign
id|mbox-&gt;cmd.length
op_assign
l_int|2
suffix:semicolon
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FPIPE_FLUSH_DRIVER_STATS
suffix:colon
id|init_chan_statistics
c_func
(paren
id|chan
)paren
suffix:semicolon
id|init_global_statistics
c_func
(paren
id|card
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FPIPE_ROUTER_UP_TIME
suffix:colon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|chan-&gt;router_up_time
op_assign
id|tv.tv_sec
op_minus
id|chan-&gt;router_start_time
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|fr_udp_pkt-&gt;data
op_assign
id|chan-&gt;router_up_time
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|fr_udp_pkt-&gt;cblock.length
op_assign
l_int|4
suffix:semicolon
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FPIPE_DRIVER_STAT_IFSEND
suffix:colon
id|memcpy
c_func
(paren
id|fr_udp_pkt-&gt;data
comma
op_amp
id|chan-&gt;drvstats_if_send.if_send_entry
comma
r_sizeof
(paren
id|if_send_stat_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|fr_udp_pkt-&gt;cblock.length
op_assign
r_sizeof
(paren
id|if_send_stat_t
)paren
suffix:semicolon
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FPIPE_DRIVER_STAT_INTR
suffix:colon
id|memcpy
c_func
(paren
id|fr_udp_pkt-&gt;data
comma
op_amp
id|card-&gt;statistics.isr_entry
comma
r_sizeof
(paren
id|global_stats_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|fr_udp_pkt-&gt;data
(braket
r_sizeof
(paren
id|global_stats_t
)paren
)braket
comma
op_amp
id|chan-&gt;drvstats_rx_intr.rx_intr_no_socket
comma
r_sizeof
(paren
id|rx_intr_stat_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|fr_udp_pkt-&gt;cblock.length
op_assign
r_sizeof
(paren
id|global_stats_t
)paren
op_plus
r_sizeof
(paren
id|rx_intr_stat_t
)paren
suffix:semicolon
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FPIPE_DRIVER_STAT_GEN
suffix:colon
id|memcpy
c_func
(paren
id|fr_udp_pkt-&gt;data
comma
op_amp
id|chan-&gt;drvstats_gen.UDP_PIPE_mgmt_kmalloc_err
comma
r_sizeof
(paren
id|pipe_mgmt_stat_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|fr_udp_pkt-&gt;data
(braket
r_sizeof
(paren
id|pipe_mgmt_stat_t
)paren
)braket
comma
op_amp
id|card-&gt;statistics
comma
r_sizeof
(paren
id|global_stats_t
)paren
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
id|fr_udp_pkt-&gt;cblock.length
op_assign
r_sizeof
(paren
id|global_stats_t
)paren
op_plus
r_sizeof
(paren
id|rx_intr_stat_t
)paren
suffix:semicolon
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FR_FT1_STATUS_CTRL
suffix:colon
r_if
c_cond
(paren
id|fr_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|rCount
op_increment
op_ne
l_int|0
)paren
(brace
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Disable FT1 MONITOR STATUS */
r_if
c_cond
(paren
id|fr_udp_pkt-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|rCount
op_ne
l_int|0
)paren
(brace
id|fr_udp_pkt-&gt;cblock.result
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_goto
id|udp_mgmt_dflt
suffix:semicolon
r_default
suffix:colon
(brace
)brace
id|udp_mgmt_dflt
suffix:colon
r_do
(brace
id|memcpy
c_func
(paren
op_amp
id|mbox-&gt;cmd
comma
op_amp
id|fr_udp_pkt-&gt;cblock.command
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox-&gt;cmd.length
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|mbox-&gt;data
comma
(paren
r_char
op_star
)paren
id|fr_udp_pkt-&gt;data
comma
id|mbox-&gt;cmd.length
)paren
suffix:semicolon
)brace
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|c_retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|chan-&gt;drvstats_gen
dot
id|UDP_PIPE_mgmt_adptr_cmnd_OK
op_increment
suffix:semicolon
)brace
r_else
id|chan-&gt;drvstats_gen
dot
id|UDP_PIPE_mgmt_adptr_cmnd_timeout
op_increment
suffix:semicolon
multiline_comment|/* copy the result back to our buffer */
id|memcpy
c_func
(paren
op_amp
id|fr_udp_pkt-&gt;cblock.command
comma
op_amp
id|mbox-&gt;cmd
comma
r_sizeof
(paren
id|fr_cmd_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox-&gt;cmd.length
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|fr_udp_pkt-&gt;data
comma
op_amp
id|mbox-&gt;data
comma
id|mbox-&gt;cmd.length
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Fill UDP TTL */
id|fr_udp_pkt-&gt;ip_pkt.ttl
op_assign
id|card-&gt;wandev.ttl
suffix:semicolon
id|len
op_assign
id|reply_udp
c_func
(paren
id|card-&gt;u.f.udp_pkt_data
comma
id|mbox-&gt;cmd.length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udp_pkt_src
op_eq
id|UDP_PKT_FRM_NETWORK
)paren
(brace
id|chan-&gt;fr_header_len
op_assign
l_int|2
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|0
)braket
op_assign
id|Q922_UI
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|1
)braket
op_assign
id|NLPID_IP
suffix:semicolon
id|err
op_assign
id|fr_send_data_header
c_func
(paren
id|card
comma
id|dlci
comma
l_int|0
comma
id|len
comma
id|card-&gt;u.f.udp_pkt_data
comma
id|chan-&gt;fr_header_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|chan-&gt;drvstats_gen.UDP_PIPE_mgmt_adptr_send_passed
op_increment
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;drvstats_gen.UDP_PIPE_mgmt_adptr_send_failed
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Allocate socket buffer */
r_if
c_cond
(paren
(paren
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* copy data into new_skb */
id|buf
op_assign
id|skb_put
c_func
(paren
id|new_skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|card-&gt;u.f.udp_pkt_data
comma
id|len
)paren
suffix:semicolon
id|chan-&gt;drvstats_gen
dot
id|UDP_PIPE_mgmt_passed_to_stack
op_increment
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|new_skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|new_skb-&gt;mac.raw
op_assign
id|new_skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|new_skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;drvstats_gen.UDP_PIPE_mgmt_no_socket
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: UDP mgmt cmnd, no socket buffers available!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
id|card-&gt;u.f.udp_pkt_lgth
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Send Inverse ARP Request&n; */
DECL|function|send_inarp_request
r_int
id|send_inarp_request
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|arphdr_1490_t
op_star
id|ArpPacket
suffix:semicolon
id|arphdr_fr_t
op_star
id|arphdr
suffix:semicolon
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
r_if
c_cond
(paren
id|in_dev
op_ne
l_int|NULL
)paren
(brace
id|ArpPacket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|arphdr_1490_t
)paren
op_plus
r_sizeof
(paren
id|arphdr_fr_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/* SNAP Header indicating ARP */
id|ArpPacket-&gt;control
op_assign
l_int|0x03
suffix:semicolon
id|ArpPacket-&gt;pad
op_assign
l_int|0x00
suffix:semicolon
id|ArpPacket-&gt;NLPID
op_assign
l_int|0x80
suffix:semicolon
id|ArpPacket-&gt;OUI
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ArpPacket-&gt;OUI
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|ArpPacket-&gt;OUI
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|ArpPacket-&gt;PID
op_assign
l_int|0x0608
suffix:semicolon
id|arphdr
op_assign
(paren
id|arphdr_fr_t
op_star
)paren
(paren
id|ArpPacket
op_plus
l_int|1
)paren
suffix:semicolon
singleline_comment|// Go to ARP Packet
multiline_comment|/* InARP request */
id|arphdr-&gt;ar_hrd
op_assign
l_int|0x0F00
suffix:semicolon
multiline_comment|/* Frame Relay HW type */
id|arphdr-&gt;ar_pro
op_assign
l_int|0x0008
suffix:semicolon
multiline_comment|/* IP Protocol&t;       */
id|arphdr-&gt;ar_hln
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* HW addr length      */
id|arphdr-&gt;ar_pln
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* IP addr length      */
id|arphdr-&gt;ar_op
op_assign
id|htons
c_func
(paren
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* InARP Request       */
id|arphdr-&gt;ar_sha
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* src HW DLCI - Doesn&squot;t matter */
r_if
c_cond
(paren
id|in_dev-&gt;ifa_list
op_ne
l_int|NULL
)paren
(brace
id|arphdr-&gt;ar_sip
op_assign
id|in_dev-&gt;ifa_list-&gt;ifa_local
suffix:semicolon
)brace
multiline_comment|/* Local Address       */
r_else
id|arphdr-&gt;ar_sip
op_assign
l_int|0
suffix:semicolon
id|arphdr-&gt;ar_tha
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* dst HW DLCI - Doesn&squot;t matter */
id|arphdr-&gt;ar_tip
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Remote Address -- what we want */
id|err
op_assign
id|fr_send
c_func
(paren
id|card
comma
id|chan-&gt;dlci
comma
l_int|0
comma
r_sizeof
(paren
id|arphdr_1490_t
)paren
op_plus
r_sizeof
(paren
id|arphdr_fr_t
)paren
comma
(paren
r_void
op_star
)paren
id|ArpPacket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n%s: Sending InARP request on DLCI %d.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ARP_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ArpPacket
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: INARP ERROR: %s doesn&squot;t have a local IP address!&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#else
id|arphdr_1490_t
op_star
id|ArpPacket
suffix:semicolon
id|arphdr_fr_t
op_star
id|arphdr
suffix:semicolon
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ArpPacket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|arphdr_1490_t
)paren
op_plus
r_sizeof
(paren
id|arphdr_fr_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/* SNAP Header indicating ARP */
id|ArpPacket-&gt;control
op_assign
l_int|0x03
suffix:semicolon
id|ArpPacket-&gt;pad
op_assign
l_int|0x00
suffix:semicolon
id|ArpPacket-&gt;NLPID
op_assign
l_int|0x80
suffix:semicolon
id|ArpPacket-&gt;OUI
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ArpPacket-&gt;OUI
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|ArpPacket-&gt;OUI
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|ArpPacket-&gt;PID
op_assign
l_int|0x0608
suffix:semicolon
id|arphdr
op_assign
(paren
id|arphdr_fr_t
op_star
)paren
(paren
id|ArpPacket
op_plus
l_int|1
)paren
suffix:semicolon
singleline_comment|// Go to ARP Packet
multiline_comment|/* InARP request */
id|arphdr-&gt;ar_hrd
op_assign
l_int|0x0F00
suffix:semicolon
multiline_comment|/* Frame Relay HW type */
id|arphdr-&gt;ar_pro
op_assign
l_int|0x0008
suffix:semicolon
multiline_comment|/* IP Protocol         */
id|arphdr-&gt;ar_hln
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* HW addr length      */
id|arphdr-&gt;ar_pln
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* IP addr length      */
id|arphdr-&gt;ar_op
op_assign
id|htons
c_func
(paren
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* InARP Request       */
id|arphdr-&gt;ar_sha
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* src HW DLCI - Doesn&squot;t matter */
id|arphdr-&gt;ar_sip
op_assign
id|dev-&gt;pa_addr
suffix:semicolon
multiline_comment|/* Local Address       */
id|arphdr-&gt;ar_tha
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* dst HW DLCI - Doesn&squot;t matter */
id|arphdr-&gt;ar_tip
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Remote Address -- what we want */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending InARP request on DLCI %d.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
id|err
op_assign
id|fr_send
c_func
(paren
id|card
comma
id|chan-&gt;dlci
comma
l_int|0
comma
r_sizeof
(paren
id|arphdr_1490_t
)paren
op_plus
r_sizeof
(paren
id|arphdr_fr_t
)paren
comma
(paren
r_void
op_star
)paren
id|ArpPacket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n%s: Sending InARP request on DLCI %d.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ARP_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ArpPacket
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Check packet for ARP Type&n; */
DECL|function|is_arp
r_int
id|is_arp
c_func
(paren
r_void
op_star
id|buf
)paren
(brace
id|arphdr_1490_t
op_star
id|arphdr
op_assign
(paren
id|arphdr_1490_t
op_star
)paren
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|arphdr-&gt;pad
op_eq
l_int|0x00
op_logical_and
id|arphdr-&gt;NLPID
op_eq
l_int|0x80
op_logical_and
id|arphdr-&gt;PID
op_eq
l_int|0x0608
)paren
r_return
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Process ARP Packet Type&n; */
DECL|function|process_ARP
r_int
id|process_ARP
c_func
(paren
id|arphdr_1490_t
op_star
id|ArpPacket
comma
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
)paren
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|arphdr_fr_t
op_star
id|arphdr
op_assign
(paren
id|arphdr_fr_t
op_star
)paren
(paren
id|ArpPacket
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Skip header */
id|fr_rx_buf_ctl_t
op_star
id|frbuf
op_assign
id|card-&gt;rxmb
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#else
id|arphdr_fr_t
op_star
id|arphdr
op_assign
(paren
id|arphdr_fr_t
op_star
)paren
(paren
id|ArpPacket
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Skip header */
id|fr_rx_buf_ctl_t
op_star
id|frbuf
op_assign
id|card-&gt;rxmb
suffix:semicolon
macro_line|#endif
multiline_comment|/* Before we transmit ARP packet, we must check &n;&t; * to see that we are not currently transmitting a &n;&t; * frame (in &squot;if_send()&squot;) and that we are not &n;&t; * already in a &squot;delayed transmit&squot; state. */
r_if
c_cond
(paren
id|check_tx_status
c_func
(paren
id|card
comma
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Disabling comminication to process ARP&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|ARP_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
id|in_dev
op_assign
id|dev-&gt;ip_ptr
suffix:semicolon
multiline_comment|/* Check that IP addresses exist for our network address */
r_if
c_cond
(paren
id|in_dev
op_eq
l_int|NULL
op_logical_or
id|in_dev-&gt;ifa_list
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|ntohs
c_func
(paren
id|arphdr-&gt;ar_op
)paren
)paren
(brace
r_case
l_int|0x08
suffix:colon
singleline_comment|// Inverse ARP request  -- Send Reply, add route.
multiline_comment|/* Check for valid Address */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Recvd PtP addr -InArp Req: %u.%u.%u.%u&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|NIPQUAD
c_func
(paren
id|arphdr-&gt;ar_sip
)paren
)paren
suffix:semicolon
multiline_comment|/* Check that the network address is the same as ours, only&n;                 * if the netowrk mask is not 255.255.255.255. Otherwise&n;                 * this check would not make sense */
r_if
c_cond
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_mask
op_ne
l_int|0xFFFFFFFF
op_logical_and
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_mask
op_amp
id|arphdr-&gt;ar_sip
)paren
op_ne
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_mask
op_amp
id|in_dev-&gt;ifa_list-&gt;ifa_local
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Invalid PtP address. %u.%u.%u.%u  InARP ignored.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|NIPQUAD
c_func
(paren
id|arphdr-&gt;ar_sip
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: mask %u.%u.%u.%u&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|NIPQUAD
c_func
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_mask
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: local %u.%u.%u.%u&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|NIPQUAD
c_func
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_local
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_local
op_eq
id|arphdr-&gt;ar_sip
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Local addr = PtP addr.  InARP ignored.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|arphdr-&gt;ar_op
op_assign
id|htons
c_func
(paren
l_int|0x09
)paren
suffix:semicolon
multiline_comment|/* InARP Reply */
multiline_comment|/* Set addresses */
id|arphdr-&gt;ar_tip
op_assign
id|arphdr-&gt;ar_sip
suffix:semicolon
id|arphdr-&gt;ar_sip
op_assign
id|in_dev-&gt;ifa_list-&gt;ifa_local
suffix:semicolon
id|chan-&gt;ip_local
op_assign
id|in_dev-&gt;ifa_list-&gt;ifa_local
suffix:semicolon
id|chan-&gt;ip_remote
op_assign
id|arphdr-&gt;ar_sip
suffix:semicolon
id|fr_send
c_func
(paren
id|card
comma
id|frbuf-&gt;dlci
comma
l_int|0
comma
id|frbuf-&gt;length
comma
(paren
r_void
op_star
)paren
id|ArpPacket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ARP_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ARP Processed Enabling Communication!&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
id|ARP_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|chan-&gt;ip_local
op_assign
id|in_dev-&gt;ifa_list-&gt;ifa_local
suffix:semicolon
id|chan-&gt;ip_remote
op_assign
id|arphdr-&gt;ar_sip
suffix:semicolon
multiline_comment|/* Add Route Flag */
multiline_comment|/* The route will be added in the polling routine so&n;&t;&t;   that it is not interrupt context. */
id|chan-&gt;route_flag
op_assign
id|ADD_ROUTE
suffix:semicolon
id|trigger_fr_poll
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
singleline_comment|// Inverse ARP reply
multiline_comment|/* Check for valid Address */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Recvd PtP addr %u.%u.%u.%u -InArp Reply&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|NIPQUAD
c_func
(paren
id|arphdr-&gt;ar_sip
)paren
)paren
suffix:semicolon
multiline_comment|/* Compare network addresses, only if network mask&n;                 * is not 255.255.255.255  It would not make sense&n;                 * to perform this test if the mask was all 1&squot;s */
r_if
c_cond
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_mask
op_ne
l_int|0xffffffff
op_logical_and
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_mask
op_amp
id|arphdr-&gt;ar_sip
)paren
op_ne
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_mask
op_amp
id|in_dev-&gt;ifa_list-&gt;ifa_local
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Invalid PtP address.  InARP ignored.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Make sure that the received IP address is not&n;                 * the same as our own local address */
r_if
c_cond
(paren
id|in_dev-&gt;ifa_list-&gt;ifa_local
op_eq
id|arphdr-&gt;ar_sip
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Local addr = PtP addr.  InARP ignored.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|chan-&gt;ip_local
op_assign
id|in_dev-&gt;ifa_list-&gt;ifa_local
suffix:semicolon
id|chan-&gt;ip_remote
op_assign
id|arphdr-&gt;ar_sip
suffix:semicolon
multiline_comment|/* Add Route Flag */
multiline_comment|/* The route will be added in the polling routine so&n;&t;&t;   that it is not interrupt context. */
id|chan-&gt;route_flag
op_assign
id|ADD_ROUTE
suffix:semicolon
id|chan-&gt;inarp
op_assign
id|INARP_CONFIGURED
suffix:semicolon
id|trigger_fr_poll
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
singleline_comment|// ARP&squot;s and RARP&squot;s -- Shouldn&squot;t happen.
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_switch
c_cond
(paren
id|ntohs
c_func
(paren
id|arphdr-&gt;ar_op
)paren
)paren
(brace
r_case
l_int|0x08
suffix:colon
singleline_comment|// Inverse ARP request  -- Send Reply, add route.
multiline_comment|/* Check for valid Address */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Recvd PtP addr %u.%u.%u.%u -InArp Req&bslash;n&quot;
comma
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|name
comma
id|NIPQUAD
c_func
(paren
id|arphdr-&gt;ar_sip
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;pa_mask
op_ne
l_int|0xFFFFFFFF
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev-&gt;pa_mask
op_amp
id|arphdr-&gt;ar_sip
)paren
op_ne
(paren
id|dev-&gt;pa_mask
op_amp
id|dev-&gt;pa_addr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Invalid PtP address.  InARP ignored.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;pa_addr
op_eq
id|arphdr-&gt;ar_sip
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Local addr = PtP addr.  InARP ignored.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|arphdr-&gt;ar_op
op_assign
id|htons
c_func
(paren
l_int|0x09
)paren
suffix:semicolon
multiline_comment|/* InARP Reply */
multiline_comment|/* Set addresses */
id|arphdr-&gt;ar_tip
op_assign
id|arphdr-&gt;ar_sip
suffix:semicolon
id|arphdr-&gt;ar_sip
op_assign
id|dev-&gt;pa_addr
suffix:semicolon
id|fr_send
c_func
(paren
id|card
comma
id|frbuf-&gt;dlci
comma
l_int|0
comma
id|frbuf-&gt;length
comma
(paren
r_void
op_star
)paren
id|ArpPacket
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ARP_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
multiline_comment|/* Modify Point-to-Point Address */
id|dev-&gt;pa_dstaddr
op_assign
id|arphdr-&gt;ar_tip
suffix:semicolon
multiline_comment|/* Add Route Flag */
multiline_comment|/* The route will be added in the polling routine so&n;                           that it is not interrupt context. */
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|route_flag
op_assign
id|ADD_ROUTE
suffix:semicolon
id|trigger_fr_poll
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
singleline_comment|// Inverse ARP reply
multiline_comment|/* Check for valid Address */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Recvd PtP addr %u.%u.%u.%u -InArp Reply&bslash;n&quot;
comma
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|name
comma
id|NIPQUAD
c_func
(paren
id|arphdr-&gt;ar_sip
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;pa_mask
op_amp
id|arphdr-&gt;ar_sip
)paren
op_ne
(paren
id|dev-&gt;pa_mask
op_amp
id|dev-&gt;pa_addr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Invalid PtP address.  InARP ignored.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;pa_addr
op_eq
id|arphdr-&gt;ar_sip
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Local addr = PtP addr.  InARP ignored.&bslash;n&quot;
comma
id|card-&gt;devname
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Modify Point-to-Point Address */
id|dev-&gt;pa_dstaddr
op_assign
id|arphdr-&gt;ar_sip
suffix:semicolon
multiline_comment|/* Add Route Flag */
multiline_comment|/* The route will be added in the polling routine so&n;                           that it is not interrupt context. */
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|route_flag
op_assign
id|ADD_ROUTE
suffix:semicolon
(paren
(paren
id|fr_channel_t
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|inarp
op_assign
id|INARP_CONFIGURED
suffix:semicolon
id|trigger_fr_poll
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
singleline_comment|// ARP&squot;s and RARP&squot;s -- Shouldn&squot;t happen.
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*============================================================&n; * trigger_fr_arp&n; *&n; * Description:&n; * &t;Add an fr_arp() task into a arp&n; *      timer handler for a specific dlci/interface.  &n; *      This will kick the fr_arp() routine &n; *      within the specified time interval. &n; *&n; * Usage:&n; * &t;This timer is used to send ARP requests at&n; *      certain time intervals. &n; * &t;Called by an interrupt to request an action&n; *      at a later date.&n; */
DECL|function|trigger_fr_arp
r_static
r_void
id|trigger_fr_arp
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|chan-&gt;fr_arp_timer
)paren
suffix:semicolon
id|chan-&gt;fr_arp_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|chan-&gt;inarp_interval
op_star
id|HZ
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|chan-&gt;fr_arp_timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * ARP Request Action&n; *&n; *&t;This funciton is called by timer interrupt to send an arp request&n; *      to the remote end.&n; */
DECL|function|fr_arp
r_static
r_void
id|fr_arp
(paren
r_int
r_int
id|data
)paren
(brace
id|netdevice_t
op_star
id|dev
op_assign
(paren
id|netdevice_t
op_star
)paren
id|data
suffix:semicolon
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
multiline_comment|/* Send ARP packets for all devs&squot; until&n;         * ARP state changes to CONFIGURED */
r_if
c_cond
(paren
id|chan-&gt;inarp
op_eq
id|INARP_REQUEST
op_logical_and
id|chan-&gt;common.state
op_eq
id|WAN_CONNECTED
op_logical_and
id|card-&gt;wandev.state
op_eq
id|WAN_CONNECTED
)paren
(brace
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;inarp_ready
)paren
suffix:semicolon
id|card-&gt;u.f.timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_ARP
suffix:semicolon
id|flags-&gt;imask
op_or_assign
id|FR_INTR_TIMER
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Perform the Interrupt Test by running the READ_CODE_VERSION command MAX_INTR_&n; * TEST_COUNTER times.&n; */
DECL|function|intr_test
r_static
r_int
id|intr_test
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_mbox_t
op_star
id|mb
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
id|err
op_assign
id|fr_set_intr_mode
c_func
(paren
id|card
comma
id|FR_INTR_READY
comma
id|card-&gt;wandev.mtu
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|CMD_OK
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_INTR_TEST_COUNTER
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Run command READ_CODE_VERSION */
id|mb-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|mb-&gt;cmd.command
op_assign
id|FR_READ_CODE_VERSION
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mb
)paren
ques
c_cond
id|mb-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|fr_set_intr_mode
c_func
(paren
id|card
comma
l_int|0
comma
id|card-&gt;wandev.mtu
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Determine what type of UDP call it is. FPIPE8ND ?&n; */
DECL|function|udp_pkt_type
r_static
r_int
id|udp_pkt_type
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_udp_pkt_t
op_star
id|fr_udp_pkt
op_assign
(paren
id|fr_udp_pkt_t
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Quick HACK */
r_if
c_cond
(paren
(paren
id|fr_udp_pkt-&gt;ip_pkt.protocol
op_eq
id|UDPMGMT_UDP_PROTOCOL
)paren
op_logical_and
(paren
id|fr_udp_pkt-&gt;ip_pkt.ver_inet_hdr_length
op_eq
l_int|0x45
)paren
op_logical_and
(paren
id|fr_udp_pkt-&gt;udp_pkt.udp_dst_port
op_eq
id|ntohs
c_func
(paren
id|card-&gt;wandev.udp_port
)paren
)paren
op_logical_and
(paren
id|fr_udp_pkt-&gt;wp_mgmt.request_reply
op_eq
id|UDPMGMT_REQUEST
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|fr_udp_pkt-&gt;wp_mgmt.signature
comma
id|UDPMGMT_FPIPE_SIGNATURE
comma
l_int|8
)paren
)paren
(brace
r_return
id|UDP_FPIPE_TYPE
suffix:semicolon
)brace
)brace
r_return
id|UDP_INVALID_TYPE
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Initializes the Statistics values in the fr_channel structure.&n; */
DECL|function|init_chan_statistics
r_void
id|init_chan_statistics
c_func
(paren
id|fr_channel_t
op_star
id|chan
)paren
(brace
id|memset
c_func
(paren
op_amp
id|chan-&gt;drvstats_if_send.if_send_entry
comma
l_int|0
comma
r_sizeof
(paren
id|if_send_stat_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|chan-&gt;drvstats_rx_intr.rx_intr_no_socket
comma
l_int|0
comma
r_sizeof
(paren
id|rx_intr_stat_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|chan-&gt;drvstats_gen.UDP_PIPE_mgmt_kmalloc_err
comma
l_int|0
comma
r_sizeof
(paren
id|pipe_mgmt_stat_t
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==============================================================================&n; * Initializes the Statistics values in the Sdla_t structure.&n; */
DECL|function|init_global_statistics
r_void
id|init_global_statistics
c_func
(paren
id|sdla_t
op_star
id|card
)paren
(brace
multiline_comment|/* Intialize global statistics for a card */
id|memset
c_func
(paren
op_amp
id|card-&gt;statistics.isr_entry
comma
l_int|0
comma
r_sizeof
(paren
id|global_stats_t
)paren
)paren
suffix:semicolon
)brace
DECL|function|read_DLCI_IB_mapping
r_static
r_void
id|read_DLCI_IB_mapping
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|retry
op_assign
id|MAX_CMD_RETRY
suffix:semicolon
id|dlci_IB_mapping_t
op_star
id|result
suffix:semicolon
r_int
id|err
comma
id|counter
comma
id|found
suffix:semicolon
r_do
(brace
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_DLCI_IB_MAPPING
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|err
op_logical_and
id|retry
op_decrement
op_logical_and
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbox-&gt;cmd.result
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Read DLCI IB Mapping failed&bslash;n&quot;
comma
id|chan-&gt;name
)paren
suffix:semicolon
)brace
id|counter
op_assign
id|mbox-&gt;cmd.length
op_div
r_sizeof
(paren
id|dlci_IB_mapping_t
)paren
suffix:semicolon
id|result
op_assign
(paren
r_void
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|counter
suffix:semicolon
op_decrement
id|counter
comma
op_increment
id|result
)paren
(brace
r_if
c_cond
(paren
id|result-&gt;dlci
op_eq
id|chan-&gt;dlci
)paren
(brace
id|chan-&gt;IB_addr
op_assign
id|result-&gt;addr_value
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|chan-&gt;dlci_int_interface
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|chan-&gt;IB_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;dlci_int_interface
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
(paren
id|chan-&gt;IB_addr
op_amp
l_int|0x00001FFF
)paren
)paren
suffix:semicolon
)brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DLCI %d not found by IB MAPPING cmd&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
)brace
DECL|function|s508_s514_lock
r_void
id|s508_s514_lock
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
macro_line|#if defined(__SMP__) || defined(LINUX_2_4)
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_star
id|smp_flags
)paren
suffix:semicolon
macro_line|#else
id|disable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#if defined(__SMP__) || defined(LINUX_2_4)
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;u.f.if_send_lock
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
suffix:semicolon
)brace
DECL|function|s508_s514_unlock
r_void
id|s508_s514_unlock
c_func
(paren
id|sdla_t
op_star
id|card
comma
r_int
r_int
op_star
id|smp_flags
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_ne
id|SDLA_S514
)paren
(brace
macro_line|#if defined(__SMP__) || defined(LINUX_2_4)
id|spin_unlock_irqrestore
(paren
op_amp
id|card-&gt;wandev.lock
comma
op_star
id|smp_flags
)paren
suffix:semicolon
macro_line|#else
id|enable_irq
c_func
(paren
id|card-&gt;hw.irq
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#if defined(__SMP__) || defined(LINUX_2_4)
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;u.f.if_send_lock
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
suffix:semicolon
)brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/*----------------------------------------------------------------------&n;                  RECEIVE INTERRUPT: BOTTOM HALF HANDLERS &n; ----------------------------------------------------------------------*/
multiline_comment|/*========================================================&n; * bh_enqueue&n; *&n; * Description:&n; *&t;Insert a received packed into a circular&n; *      rx queue.  This packed will be picked up &n; *      by fr_bh() and sent up the stack to the&n; *      user.&n; *       &t;&n; * Usage: &n; *&t;This function is called by rx interrupt,&n; *      in API mode.&n; *&n; */
DECL|function|bh_enqueue
r_static
r_int
id|bh_enqueue
(paren
id|netdevice_t
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* Check for full */
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
op_eq
id|MAX_BH_BUFF
)paren
(brace
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
(paren
(paren
id|bh_data_t
op_star
)paren
op_amp
id|chan-&gt;bh_head
(braket
id|chan-&gt;bh_write
)braket
)paren
op_member_access_from_pointer
id|skb
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;bh_write
op_eq
(paren
id|MAX_BH_BUFF
op_minus
l_int|1
)paren
)paren
(brace
id|chan-&gt;bh_write
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_increment
id|chan-&gt;bh_write
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*========================================================&n; * trigger_fr_bh&n; *&n; * Description:&n; * &t;Kick the fr_bh() handler&n; *&n; * Usage:&n; *&t;rx interrupt calls this function during&n; *      the API mode. &n; */
DECL|function|trigger_fr_bh
r_static
r_void
id|trigger_fr_bh
(paren
id|fr_channel_t
op_star
id|chan
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;tq_working
)paren
)paren
(brace
id|wanpipe_queue_tq
c_func
(paren
op_amp
id|chan-&gt;common.wanpipe_task
)paren
suffix:semicolon
id|wanpipe_mark_bh
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*========================================================&n; * fr_bh&n; *&n; * Description:&n; *&t;Frame relay receive BH handler. &n; *&t;Dequeue data from the BH circular &n; *&t;buffer and pass it up the API sock.&n; *       &t;&n; * Rationale: &n; *&t;This fuction is used to offload the &n; *&t;rx_interrupt during API operation mode.  &n; *&t;The fr_bh() function executes for each &n; *&t;dlci/interface.  &n; * &n; *      Once receive interrupt copies data from the&n; *      card into an skb buffer, the skb buffer&n; *  &t;is appended to a circular BH buffer.&n; *  &t;Then the interrupt kicks fr_bh() to finish the&n; *      job at a later time (no within the interrupt).&n; *       &n; * Usage:&n; * &t;Interrupts use this to defer a taks to &n; *      a polling routine.&n; *&n; */
DECL|function|fr_bh
r_static
r_void
id|fr_bh
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
op_eq
l_int|0
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;tq_working
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;common.sk
op_eq
l_int|NULL
op_logical_or
id|chan-&gt;common.func
op_eq
l_int|NULL
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;tq_working
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb
op_assign
(paren
(paren
id|bh_data_t
op_star
)paren
op_amp
id|chan-&gt;bh_head
(braket
id|chan-&gt;bh_read
)braket
)paren
op_member_access_from_pointer
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;common.sk
op_eq
l_int|NULL
op_logical_or
id|chan-&gt;common.func
op_eq
l_int|NULL
)paren
(brace
op_increment
id|card-&gt;wandev.stats.rx_dropped
suffix:semicolon
op_increment
id|chan-&gt;ifstats.rx_dropped
suffix:semicolon
id|wan_dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
id|fr_bh_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;common
dot
id|func
c_func
(paren
id|skb
comma
id|dev
comma
id|chan-&gt;common.sk
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Sock full cannot send, queue us for&n;                                 * another try */
id|atomic_set
c_func
(paren
op_amp
id|chan-&gt;common.receive_block
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|fr_bh_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|fr_bh_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;tq_working
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|fr_bh_cleanup
r_static
r_int
id|fr_bh_cleanup
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
(paren
(paren
id|bh_data_t
op_star
)paren
op_amp
id|chan-&gt;bh_head
(braket
id|chan-&gt;bh_read
)braket
)paren
op_member_access_from_pointer
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;bh_read
op_eq
(paren
id|MAX_BH_BUFF
op_minus
l_int|1
)paren
)paren
(brace
id|chan-&gt;bh_read
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_increment
id|chan-&gt;bh_read
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|chan-&gt;bh_buff_used
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*----------------------------------------------------------------------&n;               POLL BH HANDLERS AND KICK ROUTINES &n; ----------------------------------------------------------------------*/
multiline_comment|/*============================================================&n; * trigger_fr_poll&n; *&n; * Description:&n; * &t;Add a fr_poll() task into a tq_scheduler bh handler&n; *      for a specific dlci/interface.  This will kick&n; *      the fr_poll() routine at a later time. &n; *&n; * Usage:&n; * &t;Interrupts use this to defer a taks to &n; *      a polling routine.&n; *&n; */
DECL|function|trigger_fr_poll
r_static
r_void
id|trigger_fr_poll
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef LINUX_2_4
id|schedule_task
c_func
(paren
op_amp
id|chan-&gt;fr_poll_task
)paren
suffix:semicolon
macro_line|#else
id|queue_task
c_func
(paren
op_amp
id|chan-&gt;fr_poll_task
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*============================================================&n; * fr_poll&n; *&t;&n; * Rationale:&n; * &t;We cannot manipulate the routing tables, or&n; *      ip addresses withing the interrupt. Therefore&n; *      we must perform such actons outside an interrupt &n; *      at a later time. &n; *&n; * Description:&t;&n; *&t;Frame relay polling routine, responsible for &n; *     &t;shutting down interfaces upon disconnect&n; *     &t;and adding/removing routes. &n; *      &n; * Usage:        &n; * &t;This function is executed for each frame relay&n; * &t;dlci/interface through a tq_schedule bottom half.&n; *      &n; *      trigger_fr_poll() function is used to kick&n; *      the fr_poll routine.  &n; */
DECL|function|fr_poll
r_static
r_void
id|fr_poll
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
suffix:semicolon
id|sdla_t
op_star
id|card
suffix:semicolon
id|u8
id|check_gateway
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
(paren
id|chan
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
multiline_comment|/* (Re)Configuraiton is in progress, stop what you are &n;&t; * doing and get out */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PERI_CRIT
comma
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|chan-&gt;common.state
)paren
(brace
r_case
id|WAN_DISCONNECTED
suffix:colon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|DYN_OPT_ON
comma
op_amp
id|chan-&gt;interface_down
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|DEV_DOWN
comma
op_amp
id|chan-&gt;interface_down
)paren
op_logical_and
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s is Down.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|change_dev_flags
c_func
(paren
id|dev
comma
id|dev-&gt;flags
op_amp
op_complement
id|IFF_UP
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|DEV_DOWN
comma
op_amp
id|chan-&gt;interface_down
)paren
suffix:semicolon
id|chan-&gt;route_flag
op_assign
id|NO_ROUTE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|chan-&gt;inarp
op_ne
id|INARP_NONE
)paren
id|process_route
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|WAN_CONNECTED
suffix:colon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|DYN_OPT_ON
comma
op_amp
id|chan-&gt;interface_down
)paren
op_logical_and
id|test_bit
c_func
(paren
id|DEV_DOWN
comma
op_amp
id|chan-&gt;interface_down
)paren
op_logical_and
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Interface %s is Up.&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|change_dev_flags
c_func
(paren
id|dev
comma
id|dev-&gt;flags
op_or
id|IFF_UP
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|DEV_DOWN
comma
op_amp
id|chan-&gt;interface_down
)paren
suffix:semicolon
id|check_gateway
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;inarp
op_ne
id|INARP_NONE
)paren
(brace
id|process_route
c_func
(paren
id|dev
)paren
suffix:semicolon
id|check_gateway
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;gateway
op_logical_and
id|check_gateway
)paren
id|add_gateway
c_func
(paren
id|card
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*==============================================================&n; * check_tx_status&n; *&n; * Rationale:&n; *&t;We cannot transmit from an interrupt while&n; *      the if_send is transmitting data.  Therefore,&n; *      we must check whether the tx buffers are&n; *      begin used, before we transmit from an&n; *      interrupt.&t;&n; * &n; * Description:&t;&n; *&t;Checks whether it&squot;s safe to use the transmit &n; *      buffers. &n; *&n; * Usage:&n; * &t;ARP and UDP handling routines use this function&n; *      because, they need to transmit data during&n; *      an interrupt.&n; */
DECL|function|check_tx_status
r_static
r_int
id|check_tx_status
c_func
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|SEND_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
op_logical_or
id|test_bit
c_func
(paren
id|SEND_TXIRQ_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|is_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_or
(paren
id|card-&gt;u.f.tx_interrupts_pending
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*===============================================================&n; * move_dev_to_next&n; *  &n; * Description:&n; *&t;Move the dev pointer to the next location in the&n; *      link list.  Check if we are at the end of the &n; *      list, if so start from the begining.&n; *&n; * Usage:&n; * &t;Timer interrupt uses this function to efficiently&n; *      step through the devices that need to send ARP data.&n; *&n; */
DECL|function|move_dev_to_next
id|netdevice_t
op_star
id|move_dev_to_next
(paren
id|sdla_t
op_star
id|card
comma
id|netdevice_t
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;wandev.new_if_cnt
op_ne
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
id|card-&gt;wandev.dev
suffix:semicolon
)brace
r_else
(brace
r_return
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
)brace
)brace
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/*==============================================================&n; * trigger_config_fr&n; *&n; * Rationale:&n; *&t;All commands must be performed inside of a  &n; *      interrupt.   &n; *&n; * Description:&n; *&t;Kick the config_fr() routine throught the&n; *      timer interrupt.&n; */
DECL|function|trigger_config_fr
r_static
r_void
id|trigger_config_fr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
id|card-&gt;u.f.timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_CONFIG
suffix:semicolon
id|flags-&gt;imask
op_or_assign
id|FR_INTR_TIMER
suffix:semicolon
)brace
multiline_comment|/*==============================================================&n; * config_fr&n; *&n; * Rationale:&n; * &t;All commands must be performed inside of a  &n; *      interrupt.  &n; &amp;&n; * Description:&t;&n; * &t;Configure a DLCI. This function is executed&n; *      by a timer_interrupt.  The if_open() function&n; *      triggers it.&n; *&n; * Usage:&n; *&t;new_if() collects all data necessary to&n; *      configure the DLCI. It sets the chan-&gt;dlci_ready &n; *      bit.  When the if_open() function is executed&n; *      it checks this bit, and if its set it triggers&n; *      the timer interrupt to execute the config_fr()&n; *      function.&n; */
DECL|function|config_fr
r_static
r_void
id|config_fr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|chan
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;config_dlci
)paren
)paren
r_continue
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;config_dlci
)paren
suffix:semicolon
multiline_comment|/* If signalling is set to NO, then setup &n;        &t; * DLCI addresses right away.  Don&squot;t have to wait for&n;&t;&t; * link to connect. &n;&t;&t; */
r_if
c_cond
(paren
id|card-&gt;wandev.signalling
op_eq
id|WANOPT_NO
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Signalling set to NO: Mapping DLCI&squot;s&bslash;n&quot;
comma
id|card-&gt;wandev.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fr_init_dlci
c_func
(paren
id|card
comma
id|chan
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ERROR: Failed to configure DLCI %i !&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|card-&gt;wandev.station
op_eq
id|WANOPT_CPE
)paren
(brace
id|update_chan_state
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* CPE: issue full status enquiry */
id|fr_issue_isf
c_func
(paren
id|card
comma
id|FR_ISF_FSE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FR switch: activate DLCI(s) */
multiline_comment|/* For Switch emulation we have to ADD and ACTIVATE&n;&t;&t;&t; * the DLCI(s) that were configured with the SET_DLCI_&n;&t;&t;&t; * CONFIGURATION command. Add and Activate will fail if&n;&t;&t;&t; * DLCI specified is not included in the list.&n;&t;&t;&t; *&n;&t;&t;&t; * Also If_open is called once for each interface. But&n;&t;&t;&t; * it does not get in here for all the interface. So&n;&t;&t; &t; * we have to pass the entire list of DLCI(s) to add &n;&t;&t;&t; * activate routines.  &n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|check_dlci_config
(paren
id|card
comma
id|chan
)paren
)paren
(brace
id|fr_add_dlci
c_func
(paren
id|card
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
id|fr_activate_dlci
c_func
(paren
id|card
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
)brace
)brace
id|card-&gt;u.f.dlci_to_dev_map
(braket
id|chan-&gt;dlci
)braket
op_assign
id|dev
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*==============================================================&n; * config_fr&n; *&n; * Rationale:&n; *&t;All commands must be executed during an interrupt.&n; * &n; * Description:&t;&n; *&t;Trigger uncofig_fr() function through &n; *      the timer interrupt.&n; *&n; */
DECL|function|trigger_unconfig_fr
r_static
r_void
id|trigger_unconfig_fr
(paren
id|netdevice_t
op_star
id|dev
)paren
(brace
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|sdla_t
op_star
id|card
op_assign
id|chan-&gt;card
suffix:semicolon
id|u32
id|timeout
suffix:semicolon
id|fr508_flags_t
op_star
id|flags
op_assign
id|card-&gt;flags
suffix:semicolon
r_int
id|reset_critical
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PERI_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|PERI_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
id|reset_critical
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* run unconfig_dlci() function &n;         * throught the timer interrupt */
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|chan-&gt;unconfig_dlci
)paren
suffix:semicolon
id|card-&gt;u.f.timer_int_enabled
op_or_assign
id|TMR_INT_ENABLED_UNCONFIG
suffix:semicolon
id|flags-&gt;imask
op_or_assign
id|FR_INTR_TIMER
suffix:semicolon
multiline_comment|/* Wait for the command to complete */
id|timeout
op_assign
id|jiffies
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;u.f.timer_int_enabled
op_amp
id|TMR_INT_ENABLED_UNCONFIG
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
(paren
l_int|1
op_star
id|HZ
)paren
)paren
(brace
id|card-&gt;u.f.timer_int_enabled
op_and_assign
op_complement
id|TMR_INT_ENABLED_UNCONFIG
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Failed to delete DLCI %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|reset_critical
)paren
(brace
id|set_bit
c_func
(paren
id|PERI_CRIT
comma
(paren
r_void
op_star
)paren
op_amp
id|card-&gt;wandev.critical
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*==============================================================&n; * unconfig_fr&n; *&n; * Rationale:&n; *&t;All commands must be executed during an interrupt.&n; * &n; * Description:&t;&n; *&t;Remove the dlci from firmware.&n; *&t;This funciton is used in NODE shutdown.&n; */
DECL|function|unconfig_fr
r_static
r_void
id|unconfig_fr
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|netdevice_t
op_star
id|dev
suffix:semicolon
id|fr_channel_t
op_star
id|chan
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|chan
op_assign
id|dev-&gt;priv
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;unconfig_dlci
)paren
)paren
r_continue
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|chan-&gt;unconfig_dlci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;wandev.station
op_eq
id|WANOPT_NODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unconfiguring DLCI %i&bslash;n&quot;
comma
id|card-&gt;devname
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
id|fr_delete_dlci
c_func
(paren
id|card
comma
id|chan-&gt;dlci
)paren
suffix:semicolon
)brace
id|card-&gt;u.f.dlci_to_dev_map
(braket
id|chan-&gt;dlci
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|setup_fr_header
r_static
r_int
id|setup_fr_header
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_orig
comma
id|netdevice_t
op_star
id|dev
comma
r_char
id|op_mode
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_orig
suffix:semicolon
id|fr_channel_t
op_star
id|chan
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|op_mode
op_eq
id|WANPIPE
)paren
(brace
id|chan-&gt;fr_header
(braket
l_int|0
)braket
op_assign
id|Q922_UI
suffix:semicolon
r_switch
c_cond
(paren
id|htons
c_func
(paren
id|skb-&gt;protocol
)paren
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|chan-&gt;fr_header
(braket
l_int|1
)braket
op_assign
id|NLPID_IP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|2
suffix:semicolon
)brace
multiline_comment|/* If we are in bridging mode, we must apply&n;&t; * an Ethernet header */
r_if
c_cond
(paren
id|op_mode
op_eq
id|BRIDGE
op_logical_or
id|op_mode
op_eq
id|BRIDGE_NODE
)paren
(brace
macro_line|#if defined(LINUX_2_1) || defined(LINUX_2_4)
multiline_comment|/* Encapsulate the packet as a bridged Ethernet frame. */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: encapsulating skb for frame relay&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|chan-&gt;fr_header
(braket
l_int|0
)braket
op_assign
l_int|0x03
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|2
)braket
op_assign
l_int|0x80
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|4
)braket
op_assign
l_int|0x80
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|5
)braket
op_assign
l_int|0xC2
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|6
)braket
op_assign
l_int|0x00
suffix:semicolon
id|chan-&gt;fr_header
(braket
l_int|7
)braket
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* Yuck. */
id|skb-&gt;protocol
op_assign
id|ETH_P_802_3
suffix:semicolon
r_return
l_int|8
suffix:semicolon
macro_line|#else
multiline_comment|/* BRIDGING is not supported in 2.0.X */
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|check_dlci_config
r_static
r_int
id|check_dlci_config
(paren
id|sdla_t
op_star
id|card
comma
id|fr_channel_t
op_star
id|chan
)paren
(brace
id|fr_mbox_t
op_star
id|mbox
op_assign
id|card-&gt;mbox
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|fr_conf_t
op_star
id|conf
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|dlci_num
op_assign
id|chan-&gt;dlci
suffix:semicolon
r_int
id|dlci_offset
op_assign
l_int|0
suffix:semicolon
id|netdevice_t
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
id|dlci_num
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|CMD_OK
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
)paren
(brace
id|set_chan_state
c_func
(paren
id|dev
comma
id|WAN_DISCONNECTED
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DLCI %i Not configured, configuring&bslash;n&quot;
comma
id|dlci_num
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_COMM_DISABLE
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Disabled Communications &bslash;n&quot;
)paren
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_READ_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
id|conf
op_assign
(paren
id|fr_conf_t
op_star
)paren
id|mbox-&gt;data
suffix:semicolon
id|dlci_offset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
)paren
(brace
id|fr_channel_t
op_star
id|chan_tmp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|conf-&gt;dlci
(braket
id|dlci_offset
)braket
op_assign
id|chan_tmp-&gt;dlci
suffix:semicolon
id|dlci_offset
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Got Fr configuration Buffer Length is %x Dlci %i Dlci Off %i&bslash;n&quot;
comma
id|mbox-&gt;cmd.length
comma
id|mbox-&gt;cmd.length
OG
l_int|0x20
ques
c_cond
id|conf-&gt;dlci
(braket
l_int|0
)braket
suffix:colon
op_minus
l_int|1
comma
id|dlci_offset
)paren
suffix:semicolon
id|mbox-&gt;cmd.length
op_assign
l_int|0x20
op_plus
id|dlci_offset
op_star
l_int|2
suffix:semicolon
id|mbox-&gt;cmd.command
op_assign
id|FR_SET_CONFIG
suffix:semicolon
id|mbox-&gt;cmd.dlci
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|sdla_exec
c_func
(paren
id|mbox
)paren
ques
c_cond
id|mbox-&gt;cmd.result
suffix:colon
id|CMD_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|CMD_OK
)paren
(brace
id|fr_event
c_func
(paren
id|card
comma
id|err
comma
id|mbox
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
id|initialize_rx_tx_buffers
(paren
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Configuraiton Succeded for new DLCI %i&bslash;n&quot;
comma
id|dlci_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fr_comm_enable
(paren
id|card
)paren
)paren
(brace
r_return
l_int|2
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Enabling Communications &bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|card-&gt;wandev.dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
op_star
(paren
(paren
id|netdevice_t
op_star
op_star
)paren
id|dev-&gt;priv
)paren
)paren
(brace
id|fr_channel_t
op_star
id|chan_tmp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|fr_init_dlci
c_func
(paren
id|card
comma
id|chan_tmp
)paren
suffix:semicolon
id|fr_add_dlci
c_func
(paren
id|card
comma
id|chan_tmp-&gt;dlci
)paren
suffix:semicolon
id|fr_activate_dlci
c_func
(paren
id|card
comma
id|chan_tmp-&gt;dlci
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;END OF CONFIGURAITON %i&bslash;n&quot;
comma
id|dlci_num
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|initialize_rx_tx_buffers
r_static
r_void
id|initialize_rx_tx_buffers
(paren
id|sdla_t
op_star
id|card
)paren
(brace
id|fr_buf_info_t
op_star
id|buf_info
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hw.type
op_eq
id|SDLA_S514
)paren
(brace
id|buf_info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR_MB_VECTOR
op_plus
id|FR508_RXBC_OFFS
)paren
suffix:semicolon
id|card-&gt;rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_next
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_last
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_plus
(paren
id|buf_info-&gt;rse_num
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
id|fr_rx_buf_ctl_t
)paren
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
)brace
r_else
(brace
id|buf_info
op_assign
(paren
r_void
op_star
)paren
(paren
id|card-&gt;hw.dpmbase
op_plus
id|FR508_RXBC_OFFS
)paren
suffix:semicolon
id|card-&gt;rxmb
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_next
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_base
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
id|card-&gt;u.f.rxmb_last
op_assign
(paren
r_void
op_star
)paren
(paren
id|buf_info-&gt;rse_base
op_plus
(paren
id|buf_info-&gt;rse_num
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
id|fr_rx_buf_ctl_t
)paren
op_minus
id|FR_MB_VECTOR
op_plus
id|card-&gt;hw.dpmbase
)paren
suffix:semicolon
)brace
id|card-&gt;u.f.rx_base
op_assign
id|buf_info-&gt;buf_base
suffix:semicolon
id|card-&gt;u.f.rx_top
op_assign
id|buf_info-&gt;buf_top
suffix:semicolon
id|card-&gt;u.f.tx_interrupts_pending
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/****** End *****************************************************************/
eof
