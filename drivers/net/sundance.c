multiline_comment|/* sundance.c: A Linux device driver for the Sundance ST201 &quot;Alta&quot;. */
multiline_comment|/*&n;&t;Written 1999-2000 by Donald Becker.&n;&n;&t;This software may be used and distributed according to the terms of&n;&t;the GNU General Public License (GPL), incorporated herein by reference.&n;&t;Drivers based on or derived from this code fall under the GPL and must&n;&t;retain the authorship, copyright and license notice.  This file is not&n;&t;a complete program and may only be used when the entire operating&n;&t;system is licensed under the GPL.&n;&n;&t;The author may be reached as becker@scyld.com, or C/O&n;&t;Scyld Computing Corporation&n;&t;410 Severn Ave., Suite 210&n;&t;Annapolis MD 21403&n;&n;&t;Support and updates available at&n;&t;http://www.scyld.com/network/sundance.html&n;&n;&n;&t;Version LK1.01a (jgarzik):&n;&t;- Replace some MII-related magic numbers with constants&n;&n;&t;Version LK1.02 (D-Link):&n;&t;- Add new board to PCI ID list&n;&t;- Fix multicast bug&n;&n;&t;Version LK1.03 (D-Link):&n;&t;- New Rx scheme, reduce Rx congestion&n;&t;- Option to disable flow control&n;&n;&t;Version LK1.04 (D-Link):&n;&t;- Tx timeout recovery&n;&t;- More support for ethtool.&n;&n;&t;Version LK1.04a:&n;&t;- Remove unused/constant members from struct pci_id_info&n;&t;(which then allows removal of &squot;drv_flags&squot; from private struct)&n;&t;(jgarzik)&n;&t;- If no phy is found, fail to load that board (jgarzik)&n;&t;- Always start phy id scan at id 1 to avoid problems (Donald Becker)&n;&t;- Autodetect where mii_preable_required is needed,&n;&t;default to not needed.  (Donald Becker)&n;&n;&t;Version LK1.04b:&n;&t;- Remove mii_preamble_required module parameter (Donald Becker)&n;&t;- Add per-interface mii_preamble_required (setting is autodetected)&n;&t;  (Donald Becker)&n;&t;- Remove unnecessary cast from void pointer (jgarzik)&n;&t;- Re-align comments in private struct (jgarzik)&n;&n;&t;Version LK1.04c (jgarzik):&n;&t;- Support bitmapped message levels (NETIF_MSG_xxx), and the&n;&t;  two ethtool ioctls that get/set them&n;&t;- Don&squot;t hand-code MII ethtool support, use standard API/lib&n;&n;&t;Version LK1.04d:&n;&t;- Merge from Donald Becker&squot;s sundance.c: (Jason Lunz)&n;&t;&t;* proper support for variably-sized MTUs&n;&t;&t;* default to PIO, to fix chip bugs&n;&t;- Add missing unregister_netdev (Jason Lunz)&n;&t;- Add CONFIG_SUNDANCE_MMIO config option (jgarzik)&n;&t;- Better rx buf size calculation (Donald Becker)&n;&n;*/
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;sundance&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;1.01+LK1.04d&quot;
DECL|macro|DRV_RELDATE
mdefine_line|#define DRV_RELDATE&t;&quot;19-Sep-2002&quot;
multiline_comment|/* The user-configurable values.&n;   These may be modified when a driver module is loaded.*/
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 normal messages, 0 quiet .. 7 verbose. */
multiline_comment|/* Maximum events (Rx packets, etc.) to handle at each interrupt. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Maximum number of multicast addresses to filter (vs. rx-all-multicast).&n;   Typical is a 64 element hash table based on the Ethernet CRC.  */
DECL|variable|multicast_filter_limit
r_static
r_int
id|multicast_filter_limit
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-frames scheme.&n;   Setting to &gt; 1518 effectively disables this feature.&n;   This chip can receive into offset buffers, so the Alpha does not&n;   need a copy-align. */
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
suffix:semicolon
DECL|variable|tx_coalesce
r_static
r_int
id|tx_coalesce
op_assign
l_int|1
suffix:semicolon
DECL|variable|flowctrl
r_static
r_int
id|flowctrl
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* media[] specifies the media type the NIC operates at.&n;&t;&t; autosense&t;Autosensing active media.&n;&t;&t; 10mbps_hd &t;10Mbps half duplex.&n;&t;&t; 10mbps_fd &t;10Mbps full duplex.&n;&t;&t; 100mbps_hd &t;100Mbps half duplex.&n;&t;&t; 100mbps_fd &t;100Mbps full duplex.&n;&t;&t; 0&t;&t;Autosensing active media.&n;&t;&t; 1&t; &t;10Mbps half duplex.&n;&t;&t; 2&t; &t;10Mbps full duplex.&n;&t;&t; 3&t; &t;100Mbps half duplex.&n;&t;&t; 4&t; &t;100Mbps full duplex.&n;*/
DECL|macro|MAX_UNITS
mdefine_line|#define MAX_UNITS 8
DECL|variable|media
r_static
r_char
op_star
id|media
(braket
id|MAX_UNITS
)braket
suffix:semicolon
multiline_comment|/* Operational parameters that are set at compile time. */
multiline_comment|/* Keep the ring sizes a power of two for compile efficiency.&n;   The compiler will convert &lt;unsigned&gt;&squot;%&squot;&lt;2^N&gt; into a bit mask.&n;   Making the Tx ring too large decreases the effectiveness of channel&n;   bonding and packet priority, and more than 128 requires modifying the&n;   Tx error recovery.&n;   Large receive rings merely waste memory. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;64
DECL|macro|TX_QUEUE_LEN
mdefine_line|#define TX_QUEUE_LEN&t;(TX_RING_SIZE - 1) /* Limit ring entries actually used.  */
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;64
DECL|macro|RX_BUDGET
mdefine_line|#define RX_BUDGET&t;32
DECL|macro|TX_TOTAL_SIZE
mdefine_line|#define TX_TOTAL_SIZE&t;TX_RING_SIZE*sizeof(struct netdev_desc)
DECL|macro|RX_TOTAL_SIZE
mdefine_line|#define RX_TOTAL_SIZE&t;RX_RING_SIZE*sizeof(struct netdev_desc)
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  (4*HZ)
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536&t;&t;&t;/* Size of each temporary Rx buffer.*/
macro_line|#ifndef __KERNEL__
DECL|macro|__KERNEL__
mdefine_line|#define __KERNEL__
macro_line|#endif
macro_line|#if !defined(__OPTIMIZE__)
macro_line|#warning  You must compile this file with the correct options!
macro_line|#warning  See the last lines of the source file.
macro_line|#error You must compile this driver with &quot;-O&quot;.
macro_line|#endif
multiline_comment|/* Include files, designed to support most kernel versions 2.0.0 and later. */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/processor.h&gt;&t;&t;/* Processor type for cache alignment. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#ifndef _COMPAT_WITH_OLD_KERNEL
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#else
macro_line|#include &quot;crc32.h&quot;
macro_line|#include &quot;ethtool.h&quot;
macro_line|#include &quot;mii.h&quot;
macro_line|#include &quot;compat.h&quot;
macro_line|#endif
multiline_comment|/* These identify the driver base version and may not be removed. */
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
id|KERN_INFO
id|DRV_NAME
l_string|&quot;.c:v&quot;
id|DRV_VERSION
l_string|&quot; &quot;
id|DRV_RELDATE
l_string|&quot;  Written by Donald Becker&bslash;n&quot;
id|KERN_INFO
l_string|&quot;  http://www.scyld.com/network/sundance.html&bslash;n&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@scyld.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Sundance Alta Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|media
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_UNITS
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|flowctrl
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;Sundance Alta maximum events handled per interrupt&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Sundance Alta debug level (0-5)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;Sundance Alta copy breakpoint for copy-only-tiny-frames&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|flowctrl
comma
l_string|&quot;Sundance Alta flow control [0|1]&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This driver is designed for the Sundance Technologies &quot;Alta&quot; ST201 chip.&n;&n;II. Board-specific settings&n;&n;III. Driver operation&n;&n;IIIa. Ring buffers&n;&n;This driver uses two statically allocated fixed-size descriptor lists&n;formed into rings by a branch from the final descriptor to the beginning of&n;the list.  The ring sizes are set at compile time by RX/TX_RING_SIZE.&n;Some chips explicitly use only 2^N sized rings, while others use a&n;&squot;next descriptor&squot; pointer that the driver forms into rings.&n;&n;IIIb/c. Transmit/Receive Structure&n;&n;This driver uses a zero-copy receive and transmit scheme.&n;The driver allocates full frame size skbuffs for the Rx ring buffers at&n;open() time and passes the skb-&gt;data field to the chip as receive data&n;buffers.  When an incoming frame is less than RX_COPYBREAK bytes long,&n;a fresh skbuff is allocated and the frame is copied to the new skbuff.&n;When the incoming frame is larger, the skbuff is passed directly up the&n;protocol stack.  Buffers consumed this way are replaced by newly allocated&n;skbuffs in a later phase of receives.&n;&n;The RX_COPYBREAK value is chosen to trade-off the memory wasted by&n;using a full-sized skbuff for small frames vs. the copying costs of larger&n;frames.  New boards are typically used in generously configured machines&n;and the underfilled buffers have negligible impact compared to the benefit of&n;a single allocation size, so the default value of zero results in never&n;copying packets.  When copying is done, the cost is usually mitigated by using&n;a combined copy/checksum routine.  Copying also preloads the cache, which is&n;most useful with small frames.&n;&n;A subtle aspect of the operation is that the IP header at offset 14 in an&n;ethernet frame isn&squot;t longword aligned for further processing.&n;Unaligned buffers are permitted by the Sundance hardware, so&n;frames are received into the skbuff at an offset of &quot;+2&quot;, 16-byte aligning&n;the IP header.&n;&n;IIId. Synchronization&n;&n;The driver runs as two independent, single-threaded flows of control.  One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;tbusy flag.  The other thread is the interrupt handler, which is single&n;threaded by the hardware and interrupt handling software.&n;&n;The send packet thread has partial control over the Tx ring and &squot;dev-&gt;tbusy&squot;&n;flag.  It sets the tbusy flag whenever it&squot;s queuing a Tx packet. If the next&n;queue slot is empty, it clears the tbusy flag when finished otherwise it sets&n;the &squot;lp-&gt;tx_full&squot; flag.&n;&n;The interrupt handler has exclusive control over the Rx ring and records stats&n;from the Tx ring.  After reaping the stats, it marks the Tx queue entry as&n;empty by incrementing the dirty_tx mark. Iff the &squot;lp-&gt;tx_full&squot; flag is set, it&n;clears both the tx_full and tbusy flags.&n;&n;IV. Notes&n;&n;IVb. References&n;&n;The Sundance ST201 datasheet, preliminary version.&n;http://cesdis.gsfc.nasa.gov/linux/misc/100mbps.html&n;http://cesdis.gsfc.nasa.gov/linux/misc/NWay.html&n;&n;IVc. Errata&n;&n;*/
multiline_comment|/* Work-around for Kendin chip bugs. */
macro_line|#ifndef CONFIG_SUNDANCE_MMIO
DECL|macro|USE_IO_OPS
mdefine_line|#define USE_IO_OPS 1
macro_line|#endif
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|sundance_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_int|0x1186
comma
l_int|0x1002
comma
l_int|0x1186
comma
l_int|0x1002
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0x1186
comma
l_int|0x1002
comma
l_int|0x1186
comma
l_int|0x1003
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0x1186
comma
l_int|0x1002
comma
l_int|0x1186
comma
l_int|0x1012
comma
l_int|0
comma
l_int|0
comma
l_int|2
)brace
comma
(brace
l_int|0x1186
comma
l_int|0x1002
comma
l_int|0x1186
comma
l_int|0x1040
comma
l_int|0
comma
l_int|0
comma
l_int|3
)brace
comma
(brace
l_int|0x1186
comma
l_int|0x1002
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|4
)brace
comma
(brace
l_int|0x13F0
comma
l_int|0x0201
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|5
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|sundance_pci_tbl
)paren
suffix:semicolon
r_enum
(brace
DECL|enumerator|netdev_io_size
id|netdev_io_size
op_assign
l_int|128
)brace
suffix:semicolon
DECL|struct|pci_id_info
r_struct
id|pci_id_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|pci_id_tbl
r_static
r_struct
id|pci_id_info
id|pci_id_tbl
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;D-Link DFE-550TX FAST Ethernet Adapter&quot;
)brace
comma
(brace
l_string|&quot;D-Link DFE-550FX 100Mbps Fiber-optics Adapter&quot;
)brace
comma
(brace
l_string|&quot;D-Link DFE-580TX 4 port Server Adapter&quot;
)brace
comma
(brace
l_string|&quot;D-Link DFE-530TXS FAST Ethernet Adapter&quot;
)brace
comma
(brace
l_string|&quot;D-Link DL10050-based FAST Ethernet Adapter&quot;
)brace
comma
(brace
l_string|&quot;Sundance Technology Alta&quot;
)brace
comma
(brace
l_int|0
comma
)brace
comma
multiline_comment|/* 0 terminated list. */
)brace
suffix:semicolon
multiline_comment|/* This driver was written to use PCI memory space, however x86-oriented&n;   hardware often uses I/O space accesses. */
macro_line|#ifdef USE_IO_OPS
DECL|macro|readb
macro_line|#undef readb
DECL|macro|readw
macro_line|#undef readw
DECL|macro|readl
macro_line|#undef readl
DECL|macro|writeb
macro_line|#undef writeb
DECL|macro|writew
macro_line|#undef writew
DECL|macro|writel
macro_line|#undef writel
DECL|macro|readb
mdefine_line|#define readb inb
DECL|macro|readw
mdefine_line|#define readw inw
DECL|macro|readl
mdefine_line|#define readl inl
DECL|macro|writeb
mdefine_line|#define writeb outb
DECL|macro|writew
mdefine_line|#define writew outw
DECL|macro|writel
mdefine_line|#define writel outl
macro_line|#endif
multiline_comment|/* Offsets to the device registers.&n;   Unlike software-only systems, device drivers interact with complex hardware.&n;   It&squot;s not useful to define symbolic names for every register bit in the&n;   device.  The name can only partially document the semantics and make&n;   the driver longer and more difficult to read.&n;   In general, only the important configuration values or bits changed&n;   multiple times should be defined symbolically.&n;*/
DECL|enum|alta_offsets
r_enum
id|alta_offsets
(brace
DECL|enumerator|DMACtrl
id|DMACtrl
op_assign
l_int|0x00
comma
DECL|enumerator|TxListPtr
id|TxListPtr
op_assign
l_int|0x04
comma
DECL|enumerator|TxDMABurstThresh
id|TxDMABurstThresh
op_assign
l_int|0x08
comma
DECL|enumerator|TxDMAUrgentThresh
id|TxDMAUrgentThresh
op_assign
l_int|0x09
comma
DECL|enumerator|TxDMAPollPeriod
id|TxDMAPollPeriod
op_assign
l_int|0x0a
comma
DECL|enumerator|RxDMAStatus
id|RxDMAStatus
op_assign
l_int|0x0c
comma
DECL|enumerator|RxListPtr
id|RxListPtr
op_assign
l_int|0x10
comma
DECL|enumerator|RxDMABurstThresh
id|RxDMABurstThresh
op_assign
l_int|0x14
comma
DECL|enumerator|RxDMAUrgentThresh
id|RxDMAUrgentThresh
op_assign
l_int|0x15
comma
DECL|enumerator|RxDMAPollPeriod
id|RxDMAPollPeriod
op_assign
l_int|0x16
comma
DECL|enumerator|LEDCtrl
id|LEDCtrl
op_assign
l_int|0x1a
comma
DECL|enumerator|ASICCtrl
id|ASICCtrl
op_assign
l_int|0x30
comma
DECL|enumerator|EEData
id|EEData
op_assign
l_int|0x34
comma
DECL|enumerator|EECtrl
id|EECtrl
op_assign
l_int|0x36
comma
DECL|enumerator|TxStartThresh
id|TxStartThresh
op_assign
l_int|0x3c
comma
DECL|enumerator|RxEarlyThresh
id|RxEarlyThresh
op_assign
l_int|0x3e
comma
DECL|enumerator|FlashAddr
id|FlashAddr
op_assign
l_int|0x40
comma
DECL|enumerator|FlashData
id|FlashData
op_assign
l_int|0x44
comma
DECL|enumerator|TxStatus
id|TxStatus
op_assign
l_int|0x46
comma
DECL|enumerator|TxFrameId
id|TxFrameId
op_assign
l_int|0x47
comma
DECL|enumerator|DownCounter
id|DownCounter
op_assign
l_int|0x18
comma
DECL|enumerator|IntrClear
id|IntrClear
op_assign
l_int|0x4a
comma
DECL|enumerator|IntrEnable
id|IntrEnable
op_assign
l_int|0x4c
comma
DECL|enumerator|IntrStatus
id|IntrStatus
op_assign
l_int|0x4e
comma
DECL|enumerator|MACCtrl0
id|MACCtrl0
op_assign
l_int|0x50
comma
DECL|enumerator|MACCtrl1
id|MACCtrl1
op_assign
l_int|0x52
comma
DECL|enumerator|StationAddr
id|StationAddr
op_assign
l_int|0x54
comma
DECL|enumerator|MaxFrameSize
id|MaxFrameSize
op_assign
l_int|0x5A
comma
DECL|enumerator|RxMode
id|RxMode
op_assign
l_int|0x5c
comma
DECL|enumerator|MIICtrl
id|MIICtrl
op_assign
l_int|0x5e
comma
DECL|enumerator|MulticastFilter0
id|MulticastFilter0
op_assign
l_int|0x60
comma
DECL|enumerator|MulticastFilter1
id|MulticastFilter1
op_assign
l_int|0x64
comma
DECL|enumerator|RxOctetsLow
id|RxOctetsLow
op_assign
l_int|0x68
comma
DECL|enumerator|RxOctetsHigh
id|RxOctetsHigh
op_assign
l_int|0x6a
comma
DECL|enumerator|TxOctetsLow
id|TxOctetsLow
op_assign
l_int|0x6c
comma
DECL|enumerator|TxOctetsHigh
id|TxOctetsHigh
op_assign
l_int|0x6e
comma
DECL|enumerator|TxFramesOK
id|TxFramesOK
op_assign
l_int|0x70
comma
DECL|enumerator|RxFramesOK
id|RxFramesOK
op_assign
l_int|0x72
comma
DECL|enumerator|StatsCarrierError
id|StatsCarrierError
op_assign
l_int|0x74
comma
DECL|enumerator|StatsLateColl
id|StatsLateColl
op_assign
l_int|0x75
comma
DECL|enumerator|StatsMultiColl
id|StatsMultiColl
op_assign
l_int|0x76
comma
DECL|enumerator|StatsOneColl
id|StatsOneColl
op_assign
l_int|0x77
comma
DECL|enumerator|StatsTxDefer
id|StatsTxDefer
op_assign
l_int|0x78
comma
DECL|enumerator|RxMissed
id|RxMissed
op_assign
l_int|0x79
comma
DECL|enumerator|StatsTxXSDefer
id|StatsTxXSDefer
op_assign
l_int|0x7a
comma
DECL|enumerator|StatsTxAbort
id|StatsTxAbort
op_assign
l_int|0x7b
comma
DECL|enumerator|StatsBcastTx
id|StatsBcastTx
op_assign
l_int|0x7c
comma
DECL|enumerator|StatsBcastRx
id|StatsBcastRx
op_assign
l_int|0x7d
comma
DECL|enumerator|StatsMcastTx
id|StatsMcastTx
op_assign
l_int|0x7e
comma
DECL|enumerator|StatsMcastRx
id|StatsMcastRx
op_assign
l_int|0x7f
comma
multiline_comment|/* Aliased and bogus values! */
DECL|enumerator|RxStatus
id|RxStatus
op_assign
l_int|0x0c
comma
)brace
suffix:semicolon
DECL|enum|ASICCtrl_HiWord_bit
r_enum
id|ASICCtrl_HiWord_bit
(brace
DECL|enumerator|GlobalReset
id|GlobalReset
op_assign
l_int|0x0001
comma
DECL|enumerator|RxReset
id|RxReset
op_assign
l_int|0x0002
comma
DECL|enumerator|TxReset
id|TxReset
op_assign
l_int|0x0004
comma
DECL|enumerator|DMAReset
id|DMAReset
op_assign
l_int|0x0008
comma
DECL|enumerator|FIFOReset
id|FIFOReset
op_assign
l_int|0x0010
comma
DECL|enumerator|NetworkReset
id|NetworkReset
op_assign
l_int|0x0020
comma
DECL|enumerator|HostReset
id|HostReset
op_assign
l_int|0x0040
comma
DECL|enumerator|ResetBusy
id|ResetBusy
op_assign
l_int|0x0400
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in the interrupt status/mask registers. */
DECL|enum|intr_status_bits
r_enum
id|intr_status_bits
(brace
DECL|enumerator|IntrSummary
DECL|enumerator|IntrPCIErr
DECL|enumerator|IntrMACCtrl
id|IntrSummary
op_assign
l_int|0x0001
comma
id|IntrPCIErr
op_assign
l_int|0x0002
comma
id|IntrMACCtrl
op_assign
l_int|0x0008
comma
DECL|enumerator|IntrTxDone
DECL|enumerator|IntrRxDone
DECL|enumerator|IntrRxStart
id|IntrTxDone
op_assign
l_int|0x0004
comma
id|IntrRxDone
op_assign
l_int|0x0010
comma
id|IntrRxStart
op_assign
l_int|0x0020
comma
DECL|enumerator|IntrDrvRqst
id|IntrDrvRqst
op_assign
l_int|0x0040
comma
DECL|enumerator|StatsMax
DECL|enumerator|LinkChange
id|StatsMax
op_assign
l_int|0x0080
comma
id|LinkChange
op_assign
l_int|0x0100
comma
DECL|enumerator|IntrTxDMADone
DECL|enumerator|IntrRxDMADone
id|IntrTxDMADone
op_assign
l_int|0x0200
comma
id|IntrRxDMADone
op_assign
l_int|0x0400
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in the RxMode register. */
DECL|enum|rx_mode_bits
r_enum
id|rx_mode_bits
(brace
DECL|enumerator|AcceptAllIPMulti
DECL|enumerator|AcceptMultiHash
DECL|enumerator|AcceptAll
id|AcceptAllIPMulti
op_assign
l_int|0x20
comma
id|AcceptMultiHash
op_assign
l_int|0x10
comma
id|AcceptAll
op_assign
l_int|0x08
comma
DECL|enumerator|AcceptBroadcast
DECL|enumerator|AcceptMulticast
DECL|enumerator|AcceptMyPhys
id|AcceptBroadcast
op_assign
l_int|0x04
comma
id|AcceptMulticast
op_assign
l_int|0x02
comma
id|AcceptMyPhys
op_assign
l_int|0x01
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in MACCtrl. */
DECL|enum|mac_ctrl0_bits
r_enum
id|mac_ctrl0_bits
(brace
DECL|enumerator|EnbFullDuplex
DECL|enumerator|EnbRcvLargeFrame
id|EnbFullDuplex
op_assign
l_int|0x20
comma
id|EnbRcvLargeFrame
op_assign
l_int|0x40
comma
DECL|enumerator|EnbFlowCtrl
DECL|enumerator|EnbPassRxCRC
id|EnbFlowCtrl
op_assign
l_int|0x100
comma
id|EnbPassRxCRC
op_assign
l_int|0x200
comma
)brace
suffix:semicolon
DECL|enum|mac_ctrl1_bits
r_enum
id|mac_ctrl1_bits
(brace
DECL|enumerator|StatsEnable
DECL|enumerator|StatsDisable
DECL|enumerator|StatsEnabled
id|StatsEnable
op_assign
l_int|0x0020
comma
id|StatsDisable
op_assign
l_int|0x0040
comma
id|StatsEnabled
op_assign
l_int|0x0080
comma
DECL|enumerator|TxEnable
DECL|enumerator|TxDisable
DECL|enumerator|TxEnabled
id|TxEnable
op_assign
l_int|0x0100
comma
id|TxDisable
op_assign
l_int|0x0200
comma
id|TxEnabled
op_assign
l_int|0x0400
comma
DECL|enumerator|RxEnable
DECL|enumerator|RxDisable
DECL|enumerator|RxEnabled
id|RxEnable
op_assign
l_int|0x0800
comma
id|RxDisable
op_assign
l_int|0x1000
comma
id|RxEnabled
op_assign
l_int|0x2000
comma
)brace
suffix:semicolon
multiline_comment|/* The Rx and Tx buffer descriptors. */
multiline_comment|/* Note that using only 32 bit fields simplifies conversion to big-endian&n;   architectures. */
DECL|struct|netdev_desc
r_struct
id|netdev_desc
(brace
DECL|member|next_desc
id|u32
id|next_desc
suffix:semicolon
DECL|member|status
id|u32
id|status
suffix:semicolon
DECL|struct|desc_frag
DECL|member|addr
DECL|member|length
DECL|member|frag
r_struct
id|desc_frag
(brace
id|u32
id|addr
comma
id|length
suffix:semicolon
)brace
id|frag
(braket
l_int|1
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Bits in netdev_desc.status */
DECL|enum|desc_status_bits
r_enum
id|desc_status_bits
(brace
DECL|enumerator|DescOwn
id|DescOwn
op_assign
l_int|0x8000
comma
DECL|enumerator|DescEndPacket
id|DescEndPacket
op_assign
l_int|0x4000
comma
DECL|enumerator|DescEndRing
id|DescEndRing
op_assign
l_int|0x2000
comma
DECL|enumerator|LastFrag
id|LastFrag
op_assign
l_int|0x80000000
comma
DECL|enumerator|DescIntrOnTx
id|DescIntrOnTx
op_assign
l_int|0x8000
comma
DECL|enumerator|DescIntrOnDMADone
id|DescIntrOnDMADone
op_assign
l_int|0x80000000
comma
DECL|enumerator|DisableAlign
id|DisableAlign
op_assign
l_int|0x00000001
comma
)brace
suffix:semicolon
DECL|macro|PRIV_ALIGN
mdefine_line|#define PRIV_ALIGN&t;15 &t;/* Required alignment mask */
multiline_comment|/* Use  __attribute__((aligned (L1_CACHE_BYTES)))  to maintain alignment&n;   within the structure. */
DECL|macro|MII_CNT
mdefine_line|#define MII_CNT&t;&t;4
DECL|struct|netdev_private
r_struct
id|netdev_private
(brace
multiline_comment|/* Descriptor rings first for alignment. */
DECL|member|rx_ring
r_struct
id|netdev_desc
op_star
id|rx_ring
suffix:semicolon
DECL|member|tx_ring
r_struct
id|netdev_desc
op_star
id|tx_ring
suffix:semicolon
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_ring_dma
id|dma_addr_t
id|tx_ring_dma
suffix:semicolon
DECL|member|rx_ring_dma
id|dma_addr_t
id|rx_ring_dma
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Media monitoring timer. */
multiline_comment|/* Frequently used values: keep some adjacent for cache effect. */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|rx_lock
id|spinlock_t
id|rx_lock
suffix:semicolon
multiline_comment|/* Group with Tx control cache line. */
DECL|member|msg_enable
r_int
id|msg_enable
suffix:semicolon
DECL|member|chip_id
r_int
id|chip_id
suffix:semicolon
DECL|member|cur_rx
DECL|member|dirty_rx
r_int
r_int
id|cur_rx
comma
id|dirty_rx
suffix:semicolon
multiline_comment|/* Producer/consumer ring indices */
DECL|member|rx_buf_sz
r_int
r_int
id|rx_buf_sz
suffix:semicolon
multiline_comment|/* Based on MTU+slack. */
DECL|member|last_tx
r_struct
id|netdev_desc
op_star
id|last_tx
suffix:semicolon
multiline_comment|/* Last Tx descriptor used. */
DECL|member|cur_tx
DECL|member|dirty_tx
r_int
r_int
id|cur_tx
comma
id|dirty_tx
suffix:semicolon
multiline_comment|/* These values are keep track of the transceiver/media in use. */
DECL|member|flowctrl
r_int
r_int
id|flowctrl
suffix:colon
l_int|1
suffix:semicolon
DECL|member|default_port
r_int
r_int
id|default_port
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Last dev-&gt;if_port value. */
DECL|member|an_enable
r_int
r_int
id|an_enable
suffix:colon
l_int|1
suffix:semicolon
DECL|member|speed
r_int
r_int
id|speed
suffix:semicolon
DECL|member|rx_tasklet
r_struct
id|tasklet_struct
id|rx_tasklet
suffix:semicolon
DECL|member|budget
r_int
id|budget
suffix:semicolon
multiline_comment|/* Multicast and receive mode. */
DECL|member|mcastlock
id|spinlock_t
id|mcastlock
suffix:semicolon
multiline_comment|/* SMP lock multicast updates. */
DECL|member|mcast_filter
id|u16
id|mcast_filter
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* MII transceiver section. */
DECL|member|mii_if
r_struct
id|mii_if_info
id|mii_if
suffix:semicolon
DECL|member|mii_preamble_required
r_int
id|mii_preamble_required
suffix:semicolon
DECL|member|phys
r_int
r_char
id|phys
(braket
id|MII_CNT
)braket
suffix:semicolon
multiline_comment|/* MII device addresses, only first one used. */
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* The station address location in the EEPROM. */
DECL|macro|EEPROM_SA_OFFSET
mdefine_line|#define EEPROM_SA_OFFSET&t;0x10
DECL|macro|DEFAULT_INTR
mdefine_line|#define DEFAULT_INTR (IntrRxDMADone | IntrPCIErr | &bslash;&n;&t;&t;&t;IntrDrvRqst | IntrTxDone | StatsMax | &bslash;&n;&t;&t;&t;LinkChange)
r_static
r_int
id|change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
suffix:semicolon
r_static
r_int
id|eeprom_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|netdev_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|netdev_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|start_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|reset_tx
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|rx_poll
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|refill_rx
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|netdev_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
suffix:semicolon
r_static
r_void
id|netdev_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
suffix:semicolon
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|netdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|netdev_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|sundance_probe1
r_static
r_int
id|__devinit
id|sundance_probe1
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
suffix:semicolon
r_static
r_int
id|card_idx
suffix:semicolon
r_int
id|chip_idx
op_assign
id|ent-&gt;driver_data
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
id|u16
id|mii_ctl
suffix:semicolon
r_void
op_star
id|ring_space
suffix:semicolon
id|dma_addr_t
id|ring_dma
suffix:semicolon
multiline_comment|/* when built into the kernel, we only print version if device is found */
macro_line|#ifndef MODULE
r_static
r_int
id|printed_version
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
op_star
id|np
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_NAME
)paren
)paren
r_goto
id|err_out_netdev
suffix:semicolon
macro_line|#ifdef USE_IO_OPS
id|ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
macro_line|#else
id|ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|ioaddr
op_assign
(paren
r_int
)paren
id|ioremap
(paren
id|ioaddr
comma
id|netdev_io_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr
)paren
r_goto
id|err_out_res
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
)paren
(braket
id|i
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|eeprom_read
c_func
(paren
id|ioaddr
comma
id|i
op_plus
id|EEPROM_SA_OFFSET
)paren
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|np-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
id|np-&gt;chip_id
op_assign
id|chip_idx
suffix:semicolon
id|np-&gt;msg_enable
op_assign
(paren
l_int|1
op_lshift
id|debug
)paren
op_minus
l_int|1
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|np-&gt;rx_tasklet
comma
id|rx_poll
comma
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
id|ring_space
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
op_amp
id|ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ring_space
)paren
r_goto
id|err_out_cleardev
suffix:semicolon
id|np-&gt;tx_ring
op_assign
(paren
r_struct
id|netdev_desc
op_star
)paren
id|ring_space
suffix:semicolon
id|np-&gt;tx_ring_dma
op_assign
id|ring_dma
suffix:semicolon
id|ring_space
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
op_amp
id|ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ring_space
)paren
r_goto
id|err_out_unmap_tx
suffix:semicolon
id|np-&gt;rx_ring
op_assign
(paren
r_struct
id|netdev_desc
op_star
)paren
id|ring_space
suffix:semicolon
id|np-&gt;rx_ring_dma
op_assign
id|ring_dma
suffix:semicolon
id|np-&gt;mii_if.dev
op_assign
id|dev
suffix:semicolon
id|np-&gt;mii_if.mdio_read
op_assign
id|mdio_read
suffix:semicolon
id|np-&gt;mii_if.mdio_write
op_assign
id|mdio_write
suffix:semicolon
multiline_comment|/* The chip-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|netdev_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|start_tx
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|netdev_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|set_rx_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|netdev_ioctl
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
op_amp
id|tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
op_amp
id|change_mtu
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|i
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_goto
id|err_out_unmap_rx
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at 0x%lx, &quot;
comma
id|dev-&gt;name
comma
id|pci_id_tbl
(braket
id|chip_idx
)braket
dot
id|name
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2x, IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
)paren
(brace
r_int
id|phy
comma
id|phy_idx
op_assign
l_int|0
suffix:semicolon
id|np-&gt;phys
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Default setting */
id|np-&gt;mii_preamble_required
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|phy
op_assign
l_int|1
suffix:semicolon
id|phy
OL
l_int|32
op_logical_and
id|phy_idx
OL
id|MII_CNT
suffix:semicolon
id|phy
op_increment
)paren
(brace
r_int
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_BMSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_ne
l_int|0xffff
op_logical_and
id|mii_status
op_ne
l_int|0x0000
)paren
(brace
id|np-&gt;phys
(braket
id|phy_idx
op_increment
)braket
op_assign
id|phy
suffix:semicolon
id|np-&gt;mii_if.advertising
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mii_status
op_amp
l_int|0x0040
)paren
op_eq
l_int|0
)paren
id|np-&gt;mii_preamble_required
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MII PHY found at address %d, status &quot;
l_string|&quot;0x%4.4x advertising %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy
comma
id|mii_status
comma
id|np-&gt;mii_if.advertising
)paren
suffix:semicolon
)brace
)brace
id|np-&gt;mii_preamble_required
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|phy_idx
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No MII transceiver found, aborting.  ASIC status %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ASICCtrl
)paren
)paren
suffix:semicolon
r_goto
id|err_out_unregister
suffix:semicolon
)brace
id|np-&gt;mii_if.phy_id
op_assign
id|np-&gt;phys
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/* Parse override configuration */
id|np-&gt;an_enable
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card_idx
OL
id|MAX_UNITS
)paren
(brace
r_if
c_cond
(paren
id|media
(braket
id|card_idx
)braket
op_ne
l_int|NULL
)paren
(brace
id|np-&gt;an_enable
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
(paren
id|media
(braket
id|card_idx
)braket
comma
l_string|&quot;100mbps_fd&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
(paren
id|media
(braket
id|card_idx
)braket
comma
l_string|&quot;4&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|np-&gt;speed
op_assign
l_int|100
suffix:semicolon
id|np-&gt;mii_if.full_duplex
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
(paren
id|media
(braket
id|card_idx
)braket
comma
l_string|&quot;100mbps_hd&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
(paren
id|media
(braket
id|card_idx
)braket
comma
l_string|&quot;3&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|np-&gt;speed
op_assign
l_int|100
suffix:semicolon
id|np-&gt;mii_if.full_duplex
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
(paren
id|media
(braket
id|card_idx
)braket
comma
l_string|&quot;10mbps_fd&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
(paren
id|media
(braket
id|card_idx
)braket
comma
l_string|&quot;2&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|np-&gt;speed
op_assign
l_int|10
suffix:semicolon
id|np-&gt;mii_if.full_duplex
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
(paren
id|media
(braket
id|card_idx
)braket
comma
l_string|&quot;10mbps_hd&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
(paren
id|media
(braket
id|card_idx
)braket
comma
l_string|&quot;1&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|np-&gt;speed
op_assign
l_int|10
suffix:semicolon
id|np-&gt;mii_if.full_duplex
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|np-&gt;an_enable
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tx_coalesce
OL
l_int|1
)paren
id|tx_coalesce
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tx_coalesce
OG
id|TX_QUEUE_LEN
op_minus
l_int|1
)paren
id|tx_coalesce
op_assign
id|TX_QUEUE_LEN
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|flowctrl
op_eq
l_int|0
)paren
id|np-&gt;flowctrl
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fibre PHY? */
r_if
c_cond
(paren
id|readl
(paren
id|ioaddr
op_plus
id|ASICCtrl
)paren
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* Default 100Mbps Full */
r_if
c_cond
(paren
id|np-&gt;an_enable
)paren
(brace
id|np-&gt;speed
op_assign
l_int|100
suffix:semicolon
id|np-&gt;mii_if.full_duplex
op_assign
l_int|1
suffix:semicolon
id|np-&gt;an_enable
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset PHY */
id|mdio_write
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_BMCR
comma
id|BMCR_RESET
)paren
suffix:semicolon
id|mdelay
(paren
l_int|300
)paren
suffix:semicolon
id|mdio_write
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_BMCR
comma
id|BMCR_ANENABLE
op_or
id|BMCR_ANRESTART
)paren
suffix:semicolon
multiline_comment|/* Force media type */
r_if
c_cond
(paren
op_logical_neg
id|np-&gt;an_enable
)paren
(brace
id|mii_ctl
op_assign
l_int|0
suffix:semicolon
id|mii_ctl
op_or_assign
(paren
id|np-&gt;speed
op_eq
l_int|100
)paren
ques
c_cond
id|BMCR_SPEED100
suffix:colon
l_int|0
suffix:semicolon
id|mii_ctl
op_or_assign
(paren
id|np-&gt;mii_if.full_duplex
)paren
ques
c_cond
id|BMCR_FULLDPLX
suffix:colon
l_int|0
suffix:semicolon
id|mdio_write
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_BMCR
comma
id|mii_ctl
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;Override speed=%d, %s duplex&bslash;n&quot;
comma
id|np-&gt;speed
comma
id|np-&gt;mii_if.full_duplex
ques
c_cond
l_string|&quot;Full&quot;
suffix:colon
l_string|&quot;Half&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Perhaps move the reset here? */
multiline_comment|/* Reset the chip to erase previous misconfiguration. */
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;ASIC Control is %x.&bslash;n&quot;
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ASICCtrl
)paren
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0x007f
comma
id|ioaddr
op_plus
id|ASICCtrl
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;ASIC Control is now %x.&bslash;n&quot;
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ASICCtrl
)paren
)paren
suffix:semicolon
id|card_idx
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_unregister
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_out_unmap_rx
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
id|np-&gt;rx_ring
comma
id|np-&gt;rx_ring_dma
)paren
suffix:semicolon
id|err_out_unmap_tx
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
id|np-&gt;tx_ring
comma
id|np-&gt;tx_ring_dma
)paren
suffix:semicolon
id|err_out_cleardev
suffix:colon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifndef USE_IO_OPS
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr
)paren
suffix:semicolon
id|err_out_res
suffix:colon
macro_line|#endif
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_netdev
suffix:colon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|change_mtu
r_static
r_int
id|change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|68
)paren
op_logical_or
(paren
id|new_mtu
OG
l_int|8191
)paren
)paren
multiline_comment|/* Set by RxDMAFrameLen */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read the EEPROM and MII Management Data I/O (MDIO) interfaces. */
DECL|function|eeprom_read
r_static
r_int
id|__devinit
id|eeprom_read
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|location
)paren
(brace
r_int
id|boguscnt
op_assign
l_int|1000
suffix:semicolon
multiline_comment|/* Typical 190 ticks. */
id|writew
c_func
(paren
l_int|0x0200
op_or
(paren
id|location
op_amp
l_int|0xff
)paren
comma
id|ioaddr
op_plus
id|EECtrl
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readw
c_func
(paren
id|ioaddr
op_plus
id|EECtrl
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
r_return
id|readw
c_func
(paren
id|ioaddr
op_plus
id|EEData
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_decrement
id|boguscnt
OG
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*  MII transceiver control section.&n;&t;Read and write the MII registers using software-generated serial&n;&t;MDIO protocol.  See the MII specifications or DP83840A data sheet&n;&t;for details.&n;&n;&t;The maximum data clock rate is 2.5 Mhz.  The minimum timing is usually&n;&t;met by back-to-back 33Mhz PCI cycles. */
DECL|macro|mdio_delay
mdefine_line|#define mdio_delay() readb(mdio_addr)
DECL|enum|mii_reg_bits
r_enum
id|mii_reg_bits
(brace
DECL|enumerator|MDIO_ShiftClk
DECL|enumerator|MDIO_Data
DECL|enumerator|MDIO_EnbOutput
id|MDIO_ShiftClk
op_assign
l_int|0x0001
comma
id|MDIO_Data
op_assign
l_int|0x0002
comma
id|MDIO_EnbOutput
op_assign
l_int|0x0004
comma
)brace
suffix:semicolon
DECL|macro|MDIO_EnbIn
mdefine_line|#define MDIO_EnbIn  (0)
DECL|macro|MDIO_WRITE0
mdefine_line|#define MDIO_WRITE0 (MDIO_EnbOutput)
DECL|macro|MDIO_WRITE1
mdefine_line|#define MDIO_WRITE1 (MDIO_Data | MDIO_EnbOutput)
multiline_comment|/* Generate the preamble required for initial synchronization and&n;   a few older transceivers. */
DECL|function|mdio_sync
r_static
r_void
id|mdio_sync
c_func
(paren
r_int
id|mdio_addr
)paren
(brace
r_int
id|bits
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Establish sync by sending at least 32 logic ones. */
r_while
c_loop
(paren
op_decrement
id|bits
op_ge
l_int|0
)paren
(brace
id|writeb
c_func
(paren
id|MDIO_WRITE1
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MDIO_WRITE1
op_or
id|MDIO_ShiftClk
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|mdio_addr
op_assign
id|dev-&gt;base_addr
op_plus
id|MIICtrl
suffix:semicolon
r_int
id|mii_cmd
op_assign
(paren
l_int|0xf6
op_lshift
l_int|10
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|5
)paren
op_or
id|location
suffix:semicolon
r_int
id|i
comma
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;mii_preamble_required
)paren
id|mdio_sync
c_func
(paren
id|mdio_addr
)paren
suffix:semicolon
multiline_comment|/* Shift the read command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|mii_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_WRITE1
suffix:colon
id|MDIO_WRITE0
suffix:semicolon
id|writeb
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|dataval
op_or
id|MDIO_ShiftClk
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Read the two transition, 16 data, and wire-idle bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|19
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|writeb
c_func
(paren
id|MDIO_EnbIn
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
(paren
id|retval
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|readb
c_func
(paren
id|mdio_addr
)paren
op_amp
id|MDIO_Data
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MDIO_EnbIn
op_or
id|MDIO_ShiftClk
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|retval
op_rshift
l_int|1
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|mdio_addr
op_assign
id|dev-&gt;base_addr
op_plus
id|MIICtrl
suffix:semicolon
r_int
id|mii_cmd
op_assign
(paren
l_int|0x5002
op_lshift
l_int|16
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|23
)paren
op_or
(paren
id|location
op_lshift
l_int|18
)paren
op_or
id|value
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;mii_preamble_required
)paren
id|mdio_sync
c_func
(paren
id|mdio_addr
)paren
suffix:semicolon
multiline_comment|/* Shift the command bits out. */
r_for
c_loop
(paren
id|i
op_assign
l_int|31
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|dataval
op_assign
(paren
id|mii_cmd
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|MDIO_WRITE1
suffix:colon
id|MDIO_WRITE0
suffix:semicolon
id|writeb
c_func
(paren
id|dataval
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|dataval
op_or
id|MDIO_ShiftClk
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear out extra bits. */
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|writeb
c_func
(paren
id|MDIO_EnbIn
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MDIO_EnbIn
op_or
id|MDIO_ShiftClk
comma
id|mdio_addr
)paren
suffix:semicolon
id|mdio_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|netdev_open
r_static
r_int
id|netdev_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Do we need to reset the chip??? */
id|i
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|intr_handler
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_ifup
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: netdev_open() irq %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|np-&gt;rx_ring_dma
comma
id|ioaddr
op_plus
id|RxListPtr
)paren
suffix:semicolon
multiline_comment|/* The Tx list pointer is written as packets are queued. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|StationAddr
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Initialize other registers. */
id|writew
c_func
(paren
id|dev-&gt;mtu
op_plus
l_int|14
comma
id|ioaddr
op_plus
id|MaxFrameSize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mtu
OG
l_int|2047
)paren
id|writel
c_func
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|ASICCtrl
)paren
op_or
l_int|0x0C
comma
id|ioaddr
op_plus
id|ASICCtrl
)paren
suffix:semicolon
multiline_comment|/* Configure the PCI bus bursts and FIFO thresholds. */
r_if
c_cond
(paren
id|dev-&gt;if_port
op_eq
l_int|0
)paren
id|dev-&gt;if_port
op_assign
id|np-&gt;default_port
suffix:semicolon
id|np-&gt;mcastlock
op_assign
(paren
id|spinlock_t
)paren
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DownCounter
)paren
suffix:semicolon
multiline_comment|/* Set the chip to poll every N*320nsec. */
id|writeb
c_func
(paren
l_int|100
comma
id|ioaddr
op_plus
id|RxDMAPollPeriod
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|127
comma
id|ioaddr
op_plus
id|TxDMAPollPeriod
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writew
c_func
(paren
id|StatsEnable
op_or
id|RxEnable
op_or
id|TxEnable
comma
id|ioaddr
op_plus
id|MACCtrl1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_ifup
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Done netdev_open(), status: Rx %x Tx %x &quot;
l_string|&quot;MAC Control %x, %4.4x %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
comma
id|readb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|MACCtrl0
)paren
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|MACCtrl1
)paren
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|MACCtrl0
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the timer to check for link beat. */
id|init_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
id|np-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
suffix:semicolon
id|np-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|np-&gt;timer.function
op_assign
op_amp
id|netdev_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts by setting the interrupt mask. */
id|writew
c_func
(paren
id|DEFAULT_INTR
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|check_duplex
r_static
r_void
id|check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|mii_lpa
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_LPA
)paren
suffix:semicolon
r_int
id|negotiated
op_assign
id|mii_lpa
op_amp
id|np-&gt;mii_if.advertising
suffix:semicolon
r_int
id|duplex
suffix:semicolon
multiline_comment|/* Force media */
r_if
c_cond
(paren
op_logical_neg
id|np-&gt;an_enable
op_logical_or
id|mii_lpa
op_eq
l_int|0xffff
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;mii_if.full_duplex
)paren
id|writew
(paren
id|readw
(paren
id|ioaddr
op_plus
id|MACCtrl0
)paren
op_or
id|EnbFullDuplex
comma
id|ioaddr
op_plus
id|MACCtrl0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Autonegotiation */
id|duplex
op_assign
(paren
id|negotiated
op_amp
l_int|0x0100
)paren
op_logical_or
(paren
id|negotiated
op_amp
l_int|0x01C0
)paren
op_eq
l_int|0x0040
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;mii_if.full_duplex
op_ne
id|duplex
)paren
(brace
id|np-&gt;mii_if.full_duplex
op_assign
id|duplex
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Setting %s-duplex based on MII #%d &quot;
l_string|&quot;negotiated capability %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|negotiated
)paren
suffix:semicolon
id|writew
c_func
(paren
id|duplex
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
comma
id|ioaddr
op_plus
id|MACCtrl0
)paren
suffix:semicolon
)brace
)brace
DECL|function|netdev_timer
r_static
r_void
id|netdev_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|next_tick
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_timer
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Media selection timer tick, intr status %4.4x, &quot;
l_string|&quot;Tx %x Rx %x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrEnable
)paren
comma
id|readb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
)paren
suffix:semicolon
)brace
id|check_duplex
c_func
(paren
id|dev
)paren
suffix:semicolon
id|np-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|next_tick
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|tx_timeout
r_static
r_void
id|tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|flag
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit timed out, TxStatus %2.2x &quot;
l_string|&quot;TxFrameId %2.2x,&quot;
l_string|&quot; resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|readb
c_func
(paren
id|ioaddr
op_plus
id|TxFrameId
)paren
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  Rx ring %p: &quot;
comma
id|np-&gt;rx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %8.8x&quot;
comma
(paren
r_int
r_int
)paren
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;  Tx ring %p: &quot;
comma
id|np-&gt;tx_ring
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %8.8x&quot;
comma
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|np-&gt;lock
comma
id|flag
)paren
suffix:semicolon
id|reset_tx
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|np-&gt;lock
comma
id|flag
)paren
suffix:semicolon
multiline_comment|/* Perhaps we should reinitialize the hardware here. */
id|dev-&gt;if_port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Stop and restart the chip&squot;s Tx processes . */
multiline_comment|/* Trigger an immediate transmit demand. */
id|writew
c_func
(paren
id|DEFAULT_INTR
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the Rx and Tx rings, along with various &squot;dev&squot; bits. */
DECL|function|init_ring
r_static
r_void
id|init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|np-&gt;cur_rx
op_assign
id|np-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|np-&gt;dirty_rx
op_assign
id|np-&gt;dirty_tx
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_buf_sz
op_assign
(paren
id|dev-&gt;mtu
op_le
l_int|1520
ques
c_cond
id|PKT_BUF_SZ
suffix:colon
id|dev-&gt;mtu
op_plus
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Initialize all Rx descriptors. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|next_desc
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;rx_ring_dma
op_plus
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|RX_RING_SIZE
)paren
op_star
r_sizeof
(paren
op_star
id|np-&gt;rx_ring
)paren
)paren
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|length
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fill in the Rx buffers.  Handle allocation failure gracefully. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|np-&gt;rx_buf_sz
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the IP header. */
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|skb-&gt;tail
comma
id|np-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|length
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;rx_buf_sz
op_or
id|LastFrag
)paren
suffix:semicolon
)brace
id|np-&gt;dirty_rx
op_assign
(paren
r_int
r_int
)paren
(paren
id|i
op_minus
id|RX_RING_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|start_tx
id|start_tx
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|netdev_desc
op_star
id|txdesc
suffix:semicolon
r_int
id|entry
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Note: Ordering is important here, set the field with the&n;&t;   &quot;ownership&quot; bit last, and only then increment cur_tx. */
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|np-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|txdesc
op_assign
op_amp
id|np-&gt;tx_ring
(braket
id|entry
)braket
suffix:semicolon
id|txdesc-&gt;next_desc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Note: disable the interrupt generation here before releasing. */
r_if
c_cond
(paren
id|entry
op_mod
id|tx_coalesce
op_eq
l_int|0
)paren
(brace
id|txdesc-&gt;status
op_assign
id|cpu_to_le32
(paren
(paren
id|entry
op_lshift
l_int|2
)paren
op_or
id|DescIntrOnTx
op_or
id|DisableAlign
)paren
suffix:semicolon
)brace
r_else
(brace
id|txdesc-&gt;status
op_assign
id|cpu_to_le32
(paren
(paren
id|entry
op_lshift
l_int|2
)paren
op_or
id|DisableAlign
)paren
suffix:semicolon
)brace
id|txdesc-&gt;frag
(braket
l_int|0
)braket
dot
id|addr
op_assign
id|cpu_to_le32
(paren
id|pci_map_single
(paren
id|np-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
)paren
suffix:semicolon
id|txdesc-&gt;frag
(braket
l_int|0
)braket
dot
id|length
op_assign
id|cpu_to_le32
(paren
id|skb-&gt;len
op_or
id|LastFrag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;last_tx
)paren
id|np-&gt;last_tx-&gt;next_desc
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;tx_ring_dma
op_plus
id|entry
op_star
r_sizeof
(paren
r_struct
id|netdev_desc
)paren
)paren
suffix:semicolon
id|np-&gt;last_tx
op_assign
id|txdesc
suffix:semicolon
id|np-&gt;cur_tx
op_increment
suffix:semicolon
multiline_comment|/* On some architectures: explicitly flush cache lines here. */
r_if
c_cond
(paren
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OL
id|TX_QUEUE_LEN
op_minus
l_int|1
op_logical_and
op_logical_neg
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* do nothing */
)brace
r_else
(brace
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Side effect: The read wakes the potentially-idle transmit channel. */
r_if
c_cond
(paren
id|readl
(paren
id|dev-&gt;base_addr
op_plus
id|TxListPtr
)paren
op_eq
l_int|0
)paren
id|writel
(paren
id|np-&gt;tx_ring_dma
op_plus
id|entry
op_star
r_sizeof
(paren
op_star
id|np-&gt;tx_ring
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TxListPtr
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_tx_queued
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit frame #%d queued in slot %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;cur_tx
comma
id|entry
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tx_coalesce
OG
l_int|1
)paren
id|writel
(paren
l_int|1000
comma
id|ioaddr
op_plus
id|DownCounter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|reset_tx
id|reset_tx
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|irq
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|frame_id
suffix:semicolon
id|frame_id
op_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|TxFrameId
)paren
suffix:semicolon
id|writew
(paren
id|TxReset
op_or
id|DMAReset
op_or
id|FIFOReset
op_or
id|NetworkReset
comma
id|ioaddr
op_plus
id|ASICCtrl
op_plus
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|50
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|readw
c_func
(paren
id|ioaddr
op_plus
id|ASICCtrl
op_plus
l_int|2
)paren
op_amp
id|ResetBusy
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OG
l_int|0
suffix:semicolon
id|np-&gt;dirty_tx
op_increment
)paren
(brace
r_int
id|entry
op_assign
id|np-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_amp
l_int|0x00010000
)paren
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
suffix:semicolon
multiline_comment|/* Free the original skb. */
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
)paren
id|dev_kfree_skb_irq
(paren
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
r_else
id|dev_kfree_skb
(paren
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|writel
(paren
id|np-&gt;tx_ring_dma
op_plus
id|frame_id
op_star
r_sizeof
(paren
op_star
id|np-&gt;tx_ring
)paren
comma
id|dev-&gt;base_addr
op_plus
id|TxListPtr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|intr_handler
r_static
r_void
id|intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|rgs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_instance
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_int
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_do
(brace
r_int
id|intr_status
op_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
id|writew
c_func
(paren
id|intr_status
comma
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Interrupt, status %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|intr_status
op_amp
id|DEFAULT_INTR
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrRxDMADone
)paren
)paren
(brace
id|writew
c_func
(paren
id|DEFAULT_INTR
op_amp
op_complement
(paren
id|IntrRxDone
op_or
id|IntrRxDMADone
)paren
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;budget
OL
l_int|0
)paren
id|np-&gt;budget
op_assign
id|RX_BUDGET
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|np-&gt;rx_tasklet
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrTxDone
op_or
id|IntrDrvRqst
)paren
)paren
(brace
r_int
id|boguscnt
op_assign
l_int|32
suffix:semicolon
r_int
id|tx_status
op_assign
id|readw
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tx_status
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_tx_done
c_func
(paren
id|np
)paren
)paren
id|printk
(paren
l_string|&quot;%s: Transmit status is %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x1e
)paren
(brace
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x10
)paren
id|np-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x08
)paren
id|np-&gt;stats.collisions
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x02
)paren
id|np-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
multiline_comment|/* This reset has not been verified!. */
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x10
)paren
(brace
multiline_comment|/* Reset the Tx. */
id|np-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|reset_tx
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tx_status
op_amp
l_int|0x1e
)paren
multiline_comment|/* Restart the Tx. */
id|writew
(paren
id|TxEnable
comma
id|ioaddr
op_plus
id|MACCtrl1
)paren
suffix:semicolon
)brace
multiline_comment|/* Yup, this is a documentation bug.  It cost me *hours*. */
id|writew
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
id|tx_status
op_assign
id|readw
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
)brace
id|spin_lock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OG
l_int|0
suffix:semicolon
id|np-&gt;dirty_tx
op_increment
)paren
(brace
r_int
id|entry
op_assign
id|np-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|status
op_amp
l_int|0x00010000
)paren
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
suffix:semicolon
multiline_comment|/* Free the original skb. */
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;tx_ring
(braket
id|entry
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
(paren
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OL
id|TX_QUEUE_LEN
op_minus
l_int|4
)paren
(brace
multiline_comment|/* The ring is no longer full, clear tbusy. */
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Abnormal error summary/uncommon events handlers. */
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrPCIErr
op_or
id|LinkChange
op_or
id|StatsMax
)paren
)paren
id|netdev_error
c_func
(paren
id|dev
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work at interrupt, &quot;
l_string|&quot;status=0x%4.4x / 0x%4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrClear
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt, status=%#4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;cur_tx
op_minus
id|np-&gt;dirty_tx
OG
l_int|0
op_logical_and
id|tx_coalesce
OG
l_int|1
)paren
id|writel
c_func
(paren
l_int|100
comma
id|ioaddr
op_plus
id|DownCounter
)paren
suffix:semicolon
)brace
DECL|function|rx_poll
r_static
r_void
id|rx_poll
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
op_assign
id|np-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|boguscnt
op_assign
id|np-&gt;budget
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|received
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If EOP is set on the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_struct
id|netdev_desc
op_star
id|desc
op_assign
op_amp
(paren
id|np-&gt;rx_ring
(braket
id|entry
)braket
)paren
suffix:semicolon
id|u32
id|frame_status
op_assign
id|le32_to_cpu
c_func
(paren
id|desc-&gt;status
)paren
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
r_goto
id|not_done
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|desc-&gt;status
op_amp
id|DescOwn
)paren
)paren
r_break
suffix:semicolon
id|pkt_len
op_assign
id|frame_status
op_amp
l_int|0x1fff
suffix:semicolon
multiline_comment|/* Chip omits the CRC. */
r_if
c_cond
(paren
id|netif_msg_rx_status
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  netdev_rx() status was %8.8x.&bslash;n&quot;
comma
id|frame_status
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|desc-&gt;frag
(braket
l_int|0
)braket
dot
id|addr
comma
id|np-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x001f4000
)paren
(brace
multiline_comment|/* There was a error. */
r_if
c_cond
(paren
id|netif_msg_rx_err
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  netdev_rx() Rx error was %8.8x.&bslash;n&quot;
comma
id|frame_status
)paren
suffix:semicolon
id|np-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x00100000
)paren
id|np-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x00010000
)paren
id|np-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x00060000
)paren
id|np-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x00080000
)paren
id|np-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|frame_status
op_amp
l_int|0x00100000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Oversized Ethernet frame,&quot;
l_string|&quot; status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|frame_status
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|netif_msg_rx_status
c_func
(paren
id|np
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  netdev_rx() normal Rx pkt length %d&quot;
l_string|&quot;, bogus_cnt %d.&bslash;n&quot;
comma
id|pkt_len
comma
id|boguscnt
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check if the packet is long enough to accept without copying&n;&t;&t;&t;   to a minimally-sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OL
id|rx_copybreak
op_logical_and
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the IP header */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|tail
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|desc-&gt;frag
(braket
l_int|0
)braket
dot
id|addr
comma
id|np-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
op_assign
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
comma
id|pkt_len
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Note: checksum -&gt; skb-&gt;ip_summed = CHECKSUM_UNNECESSARY; */
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
id|entry
op_assign
(paren
id|entry
op_plus
l_int|1
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|received
op_increment
suffix:semicolon
)brace
id|np-&gt;cur_rx
op_assign
id|entry
suffix:semicolon
id|refill_rx
(paren
id|dev
)paren
suffix:semicolon
id|np-&gt;budget
op_sub_assign
id|received
suffix:semicolon
id|writew
c_func
(paren
id|DEFAULT_INTR
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
r_return
suffix:semicolon
id|not_done
suffix:colon
id|np-&gt;cur_rx
op_assign
id|entry
suffix:semicolon
id|refill_rx
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|received
)paren
id|received
op_assign
l_int|1
suffix:semicolon
id|np-&gt;budget
op_sub_assign
id|received
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;budget
op_le
l_int|0
)paren
id|np-&gt;budget
op_assign
id|RX_BUDGET
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|np-&gt;rx_tasklet
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|refill_rx
r_static
r_void
id|refill_rx
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Refill the Rx ring buffers. */
r_for
c_loop
(paren
suffix:semicolon
(paren
id|np-&gt;cur_rx
op_minus
id|np-&gt;dirty_rx
op_plus
id|RX_RING_SIZE
)paren
op_mod
id|RX_RING_SIZE
OG
l_int|0
suffix:semicolon
id|np-&gt;dirty_rx
op_assign
(paren
id|np-&gt;dirty_rx
op_plus
l_int|1
)paren
op_mod
id|RX_RING_SIZE
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|entry
op_assign
id|np-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|np-&gt;rx_buf_sz
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Better luck next round. */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
id|np-&gt;rx_ring
(braket
id|entry
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|skb-&gt;tail
comma
id|np-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Perhaps we need not reset this field. */
id|np-&gt;rx_ring
(braket
id|entry
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|length
op_assign
id|cpu_to_le32
c_func
(paren
id|np-&gt;rx_buf_sz
op_or
id|LastFrag
)paren
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|entry
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|netdev_error
r_static
r_void
id|netdev_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u16
id|mii_ctl
comma
id|mii_advertise
comma
id|mii_lpa
suffix:semicolon
r_int
id|speed
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
id|LinkChange
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;an_enable
)paren
(brace
id|mii_advertise
op_assign
id|mdio_read
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
id|mii_lpa
op_assign
id|mdio_read
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_LPA
)paren
suffix:semicolon
id|mii_advertise
op_and_assign
id|mii_lpa
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Link changed: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_advertise
op_amp
id|ADVERTISE_100FULL
)paren
(brace
id|np-&gt;speed
op_assign
l_int|100
suffix:semicolon
id|printk
(paren
l_string|&quot;100Mbps, full duplex&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mii_advertise
op_amp
id|ADVERTISE_100HALF
)paren
(brace
id|np-&gt;speed
op_assign
l_int|100
suffix:semicolon
id|printk
(paren
l_string|&quot;100Mbps, half duplex&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mii_advertise
op_amp
id|ADVERTISE_10FULL
)paren
(brace
id|np-&gt;speed
op_assign
l_int|10
suffix:semicolon
id|printk
(paren
l_string|&quot;10Mbps, full duplex&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mii_advertise
op_amp
id|ADVERTISE_10HALF
)paren
(brace
id|np-&gt;speed
op_assign
l_int|10
suffix:semicolon
id|printk
(paren
l_string|&quot;10Mbps, half duplex&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|mii_ctl
op_assign
id|mdio_read
(paren
id|dev
comma
id|np-&gt;phys
(braket
l_int|0
)braket
comma
id|MII_BMCR
)paren
suffix:semicolon
id|speed
op_assign
(paren
id|mii_ctl
op_amp
id|BMCR_SPEED100
)paren
ques
c_cond
l_int|100
suffix:colon
l_int|10
suffix:semicolon
id|np-&gt;speed
op_assign
id|speed
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: Link changed: %dMbps ,&quot;
comma
id|dev-&gt;name
comma
id|speed
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%s duplex.&bslash;n&quot;
comma
(paren
id|mii_ctl
op_amp
id|BMCR_FULLDPLX
)paren
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
)brace
id|check_duplex
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;flowctrl
op_eq
l_int|0
)paren
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ioaddr
op_plus
id|MACCtrl0
)paren
op_amp
op_complement
id|EnbFlowCtrl
comma
id|ioaddr
op_plus
id|MACCtrl0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|StatsMax
)paren
(brace
id|get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrPCIErr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Something Wicked happened! %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
multiline_comment|/* We must do a global reset of DMA to continue. */
)brace
)brace
DECL|function|get_stats
r_static
r_struct
id|net_device_stats
op_star
id|get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* We should lock this segment of code for SMP eventually, although&n;&t;   the vulnerability window is very small and statistics are&n;&t;   non-critical. */
multiline_comment|/* The chip only need report frame silently dropped. */
id|np-&gt;stats.rx_missed_errors
op_add_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|np-&gt;stats.tx_packets
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|TxFramesOK
)paren
suffix:semicolon
id|np-&gt;stats.rx_packets
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxFramesOK
)paren
suffix:semicolon
id|np-&gt;stats.collisions
op_add_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StatsLateColl
)paren
suffix:semicolon
id|np-&gt;stats.collisions
op_add_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StatsMultiColl
)paren
suffix:semicolon
id|np-&gt;stats.collisions
op_add_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StatsOneColl
)paren
suffix:semicolon
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StatsCarrierError
)paren
suffix:semicolon
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StatsTxDefer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|StatsTxDefer
suffix:semicolon
id|i
op_le
id|StatsMcastRx
suffix:semicolon
id|i
op_increment
)paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|i
)paren
suffix:semicolon
id|np-&gt;stats.tx_bytes
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|TxOctetsLow
)paren
suffix:semicolon
id|np-&gt;stats.tx_bytes
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|TxOctetsHigh
)paren
op_lshift
l_int|16
suffix:semicolon
id|np-&gt;stats.rx_bytes
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxOctetsLow
)paren
suffix:semicolon
id|np-&gt;stats.rx_bytes
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxOctetsHigh
)paren
op_lshift
l_int|16
suffix:semicolon
r_return
op_amp
id|np-&gt;stats
suffix:semicolon
)brace
DECL|function|set_rx_mode
r_static
r_void
id|set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u16
id|mc_filter
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Multicast hash filter */
id|u32
id|rx_mode
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0xff
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptAll
op_or
id|AcceptMyPhys
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to match, or accept all multicasts. */
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0xff
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMulticast
op_or
id|AcceptMyPhys
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
r_int
id|bit
suffix:semicolon
r_int
id|index
suffix:semicolon
r_int
id|crc
suffix:semicolon
id|memset
(paren
id|mc_filter
comma
l_int|0
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
id|crc
op_assign
id|ether_crc_le
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
comma
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
l_int|6
suffix:semicolon
id|bit
op_increment
comma
id|crc
op_lshift_assign
l_int|1
)paren
r_if
c_cond
(paren
id|crc
op_amp
l_int|0x80000000
)paren
id|index
op_or_assign
l_int|1
op_lshift
id|bit
suffix:semicolon
id|mc_filter
(braket
id|index
op_div
l_int|16
)braket
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|index
op_mod
l_int|16
)paren
)paren
suffix:semicolon
)brace
id|rx_mode
op_assign
id|AcceptBroadcast
op_or
id|AcceptMultiHash
op_or
id|AcceptMyPhys
suffix:semicolon
)brace
r_else
(brace
id|writeb
c_func
(paren
id|AcceptBroadcast
op_or
id|AcceptMyPhys
comma
id|ioaddr
op_plus
id|RxMode
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|writew
c_func
(paren
id|mc_filter
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|MulticastFilter0
op_plus
id|i
op_star
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|rx_mode
comma
id|ioaddr
op_plus
id|RxMode
)paren
suffix:semicolon
)brace
DECL|function|netdev_ethtool_ioctl
r_static
r_int
id|netdev_ethtool_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|useraddr
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|ethcmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ethcmd
comma
id|useraddr
comma
r_sizeof
(paren
id|ethcmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|ethcmd
)paren
(brace
multiline_comment|/* get constant driver settings/info */
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
r_struct
id|ethtool_drvinfo
id|info
op_assign
(brace
id|ETHTOOL_GDRVINFO
)brace
suffix:semicolon
id|strcpy
c_func
(paren
id|info.driver
comma
id|DRV_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info.version
comma
id|DRV_VERSION
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info.bus_info
comma
id|np-&gt;pci_dev-&gt;slot_name
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info.fw_version
comma
l_int|0
comma
r_sizeof
(paren
id|info.fw_version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get media settings */
r_case
id|ETHTOOL_GSET
suffix:colon
(brace
r_struct
id|ethtool_cmd
id|ecmd
op_assign
(brace
id|ETHTOOL_GSET
)brace
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|mii_ethtool_gset
c_func
(paren
op_amp
id|np-&gt;mii_if
comma
op_amp
id|ecmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|ecmd
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set media settings */
r_case
id|ETHTOOL_SSET
suffix:colon
(brace
r_int
id|r
suffix:semicolon
r_struct
id|ethtool_cmd
id|ecmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ecmd
comma
id|useraddr
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|r
op_assign
id|mii_ethtool_sset
c_func
(paren
op_amp
id|np-&gt;mii_if
comma
op_amp
id|ecmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* restart autonegotiation */
r_case
id|ETHTOOL_NWAY_RST
suffix:colon
(brace
r_return
id|mii_nway_restart
c_func
(paren
op_amp
id|np-&gt;mii_if
)paren
suffix:semicolon
)brace
multiline_comment|/* get link status */
r_case
id|ETHTOOL_GLINK
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GLINK
)brace
suffix:semicolon
id|edata.data
op_assign
id|mii_link_ok
c_func
(paren
op_amp
id|np-&gt;mii_if
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get message-level */
r_case
id|ETHTOOL_GMSGLVL
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GMSGLVL
)brace
suffix:semicolon
id|edata.data
op_assign
id|np-&gt;msg_enable
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set message-level */
r_case
id|ETHTOOL_SMSGLVL
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|edata
comma
id|useraddr
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|np-&gt;msg_enable
op_assign
id|edata.data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|netdev_ioctl
r_static
r_int
id|netdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|mii_ioctl_data
op_star
id|data
op_assign
(paren
r_struct
id|mii_ioctl_data
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
r_return
id|netdev_ethtool_ioctl
c_func
(paren
id|dev
comma
(paren
r_void
op_star
)paren
id|rq-&gt;ifr_data
)paren
suffix:semicolon
r_case
id|SIOCGMIIPHY
suffix:colon
multiline_comment|/* Get address of MII PHY in use. */
id|data-&gt;phy_id
op_assign
(paren
(paren
r_struct
id|netdev_private
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|phys
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
multiline_comment|/* Fall Through */
r_case
id|SIOCGMIIREG
suffix:colon
multiline_comment|/* Read MII PHY register. */
id|data-&gt;val_out
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|data-&gt;phy_id
op_amp
l_int|0x1f
comma
id|data-&gt;reg_num
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCSMIIREG
suffix:colon
multiline_comment|/* Write MII PHY register. */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|data-&gt;phy_id
op_amp
l_int|0x1f
comma
id|data-&gt;reg_num
op_amp
l_int|0x1f
comma
id|data-&gt;val_in
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|netdev_close
r_static
r_int
id|netdev_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_ifdown
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard, status was Tx %2.2x &quot;
l_string|&quot;Rx %4.4x Int %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readb
c_func
(paren
id|ioaddr
op_plus
id|TxStatus
)paren
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|RxStatus
)paren
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Queue pointers were Tx %d / %d,  Rx %d / %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|np-&gt;cur_tx
comma
id|np-&gt;dirty_tx
comma
id|np-&gt;cur_rx
comma
id|np-&gt;dirty_rx
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|writew
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|writew
c_func
(paren
id|TxDisable
op_or
id|RxDisable
op_or
id|StatsDisable
comma
id|ioaddr
op_plus
id|MACCtrl1
)paren
suffix:semicolon
macro_line|#ifdef __i386__
r_if
c_cond
(paren
id|netif_msg_hw
c_func
(paren
id|np
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;  Tx ring at %8.8x:&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|np-&gt;tx_ring_dma
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; #%d desc. %4.4x %8.8x %8.8x.&bslash;n&quot;
comma
id|i
comma
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|status
comma
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
comma
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|length
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
l_string|&quot;  Rx ring %8.8x:&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|np-&gt;rx_ring_dma
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
multiline_comment|/*RX_RING_SIZE*/
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; #%d desc. %4.4x %4.4x %8.8x&bslash;n&quot;
comma
id|i
comma
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
comma
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
comma
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|length
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* __i386__ debugging only */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|np-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Free all the skbuffs in the Rx queue. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
op_assign
l_int|0xBADF00D0
suffix:semicolon
multiline_comment|/* An invalid address. */
id|skb
op_assign
id|np-&gt;rx_skbuff
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;rx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
comma
id|np-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|np-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
id|np-&gt;tx_skbuff
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|np-&gt;pci_dev
comma
id|np-&gt;tx_ring
(braket
id|i
)braket
dot
id|frag
(braket
l_int|0
)braket
dot
id|addr
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|np-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sundance_remove1
r_static
r_void
id|__devexit
id|sundance_remove1
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* No need to check MOD_IN_USE, as sys_delete_module() checks. */
r_if
c_cond
(paren
id|dev
)paren
(brace
r_struct
id|netdev_private
op_star
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|RX_TOTAL_SIZE
comma
id|np-&gt;rx_ring
comma
id|np-&gt;rx_ring_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|TX_TOTAL_SIZE
comma
id|np-&gt;tx_ring
comma
id|np-&gt;tx_ring_dma
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
macro_line|#ifndef USE_IO_OPS
id|iounmap
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
DECL|variable|sundance_driver
r_static
r_struct
id|pci_driver
id|sundance_driver
op_assign
(brace
id|name
suffix:colon
id|DRV_NAME
comma
id|id_table
suffix:colon
id|sundance_pci_tbl
comma
id|probe
suffix:colon
id|sundance_probe1
comma
id|remove
suffix:colon
id|__devexit_p
c_func
(paren
id|sundance_remove1
)paren
comma
)brace
suffix:semicolon
DECL|function|sundance_init
r_static
r_int
id|__init
id|sundance_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* when a module, this is printed whether or not devices are found in probe */
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
c_func
(paren
op_amp
id|sundance_driver
)paren
suffix:semicolon
)brace
DECL|function|sundance_exit
r_static
r_void
id|__exit
id|sundance_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|sundance_driver
)paren
suffix:semicolon
)brace
DECL|variable|sundance_init
id|module_init
c_func
(paren
id|sundance_init
)paren
suffix:semicolon
DECL|variable|sundance_exit
id|module_exit
c_func
(paren
id|sundance_exit
)paren
suffix:semicolon
eof
