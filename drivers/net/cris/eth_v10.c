multiline_comment|/* $Id: ethernet.c,v 1.31 2004/10/18 14:49:03 starvik Exp $&n; *&n; * e100net.c: A network driver for the ETRAX 100LX network controller.&n; *&n; * Copyright (c) 1998-2002 Axis Communications AB.&n; *&n; * The outline of this driver comes from skeleton.c.&n; *&n; * $Log: ethernet.c,v $&n; * Revision 1.31  2004/10/18 14:49:03  starvik&n; * Use RX interrupt as random source&n; *&n; * Revision 1.30  2004/09/29 10:44:04  starvik&n; * Enabed MAC-address output again&n; *&n; * Revision 1.29  2004/08/24 07:14:05  starvik&n; * Make use of generic MDIO interface and constants.&n; *&n; * Revision 1.28  2004/08/20 09:37:11  starvik&n; * Added support for Intel LXT972A. Creds to Randy Scarborough.&n; *&n; * Revision 1.27  2004/08/16 12:37:22  starvik&n; * Merge of Linux 2.6.8&n; *&n; * Revision 1.25  2004/06/21 10:29:57  starvik&n; * Merge of Linux 2.6.7&n; *&n; * Revision 1.23  2004/06/09 05:29:22  starvik&n; * Avoid any race where R_DMA_CH1_FIRST is NULL (may trigger cache bug).&n; *&n; * Revision 1.22  2004/05/14 07:58:03  starvik&n; * Merge of changes from 2.4&n; *&n; * Revision 1.20  2004/03/11 11:38:40  starvik&n; * Merge of Linux 2.6.4&n; *&n; * Revision 1.18  2003/12/03 13:45:46  starvik&n; * Use hardware pad for short packets to prevent information leakage.&n; *&n; * Revision 1.17  2003/07/04 08:27:37  starvik&n; * Merge of Linux 2.5.74&n; *&n; * Revision 1.16  2003/04/24 08:28:22  starvik&n; * New LED behaviour: LED off when no link&n; *&n; * Revision 1.15  2003/04/09 05:20:47  starvik&n; * Merge of Linux 2.5.67&n; *&n; * Revision 1.13  2003/03/06 16:11:01  henriken&n; * Off by one error in group address register setting.&n; *&n; * Revision 1.12  2003/02/27 17:24:19  starvik&n; * Corrected Rev to Revision&n; *&n; * Revision 1.11  2003/01/24 09:53:21  starvik&n; * Oops. Initialize GA to 0, not to 1&n; *&n; * Revision 1.10  2003/01/24 09:50:55  starvik&n; * Initialize GA_0 and GA_1 to 0 to avoid matching of unwanted packets&n; *&n; * Revision 1.9  2002/12/13 07:40:58  starvik&n; * Added basic ethtool interface&n; * Handled out of memory when allocating new buffers&n; *&n; * Revision 1.8  2002/12/11 13:13:57  starvik&n; * Added arch/ to v10 specific includes&n; * Added fix from Linux 2.4 in serial.c (flush_to_flip_buffer)&n; *&n; * Revision 1.7  2002/11/26 09:41:42  starvik&n; * Added e100_set_config (standard interface to set media type)&n; * Added protection against preemptive scheduling&n; * Added standard MII ioctls&n; *&n; * Revision 1.6  2002/11/21 07:18:18  starvik&n; * Timers must be initialized in 2.5.48&n; *&n; * Revision 1.5  2002/11/20 11:56:11  starvik&n; * Merge of Linux 2.5.48&n; *&n; * Revision 1.4  2002/11/18 07:26:46  starvik&n; * Linux 2.5 port of latest Linux 2.4 ethernet driver&n; *&n; * Revision 1.33  2002/10/02 20:16:17  hp&n; * SETF, SETS: Use underscored IO_x_ macros rather than incorrect token concatenation&n; *&n; * Revision 1.32  2002/09/16 06:05:58  starvik&n; * Align memory returned by dev_alloc_skb&n; * Moved handling of sent packets to interrupt to avoid reference counting problem&n; *&n; * Revision 1.31  2002/09/10 13:28:23  larsv&n; * Return -EINVAL for unknown ioctls to avoid confusing tools that tests&n; * for supported functionality by issuing special ioctls, i.e. wireless&n; * extensions.&n; *&n; * Revision 1.30  2002/05/07 18:50:08  johana&n; * Correct spelling in comments.&n; *&n; * Revision 1.29  2002/05/06 05:38:49  starvik&n; * Performance improvements:&n; *    Large packets are not copied (breakpoint set to 256 bytes)&n; *    The cache bug workaround is delayed until half of the receive list&n; *      has been used&n; *    Added transmit list&n; *    Transmit interrupts are only enabled when transmit queue is full&n; *&n; * Revision 1.28.2.1  2002/04/30 08:15:51  starvik&n; * Performance improvements:&n; *   Large packets are not copied (breakpoint set to 256 bytes)&n; *   The cache bug workaround is delayed until half of the receive list&n; *     has been used.&n; *   Added transmit list&n; *   Transmit interrupts are only enabled when transmit queue is full&n; *&n; * Revision 1.28  2002/04/22 11:47:21  johana&n; * Fix according to 2.4.19-pre7. time_after/time_before and&n; * missing end of comment.&n; * The patch has a typo for ethernet.c in e100_clear_network_leds(),&n; *  that is fixed here.&n; *&n; * Revision 1.27  2002/04/12 11:55:11  bjornw&n; * Added TODO&n; *&n; * Revision 1.26  2002/03/15 17:11:02  bjornw&n; * Use prepare_rx_descriptor after the CPU has touched the receiving descs&n; *&n; * Revision 1.25  2002/03/08 13:07:53  bjornw&n; * Unnecessary spinlock removed&n; *&n; * Revision 1.24  2002/02/20 12:57:43  fredriks&n; * Replaced MIN() with min().&n; *&n; * Revision 1.23  2002/02/20 10:58:14  fredriks&n; * Strip the Ethernet checksum (4 bytes) before forwarding a frame to upper layers.&n; *&n; * Revision 1.22  2002/01/30 07:48:22  matsfg&n; * Initiate R_NETWORK_TR_CTRL&n; *&n; * Revision 1.21  2001/11/23 11:54:49  starvik&n; * Added IFF_PROMISC and IFF_ALLMULTI handling in set_multicast_list&n; * Removed compiler warnings&n; *&n; * Revision 1.20  2001/11/12 19:26:00  pkj&n; * * Corrected e100_negotiate() to not assign half to current_duplex when&n; *   it was supposed to compare them...&n; * * Cleaned up failure handling in e100_open().&n; * * Fixed compiler warnings.&n; *&n; * Revision 1.19  2001/11/09 07:43:09  starvik&n; * Added full duplex support&n; * Added ioctl to set speed and duplex&n; * Clear LED timer only runs when LED is lit&n; *&n; * Revision 1.18  2001/10/03 14:40:43  jonashg&n; * Update rx_bytes counter.&n; *&n; * Revision 1.17  2001/06/11 12:43:46  olof&n; * Modified defines for network LED behavior&n; *&n; * Revision 1.16  2001/05/30 06:12:46  markusl&n; * TxDesc.next should not be set to NULL&n; *&n; * Revision 1.15  2001/05/29 10:27:04  markusl&n; * Updated after review remarks:&n; * +Use IO_EXTRACT&n; * +Handle underrun&n; *&n; * Revision 1.14  2001/05/29 09:20:14  jonashg&n; * Use driver name on printk output so one can tell which driver that complains.&n; *&n; * Revision 1.13  2001/05/09 12:35:59  johana&n; * Use DMA_NBR and IRQ_NBR defines from dma.h and irq.h&n; *&n; * Revision 1.12  2001/04/05 11:43:11  tobiasa&n; * Check dev before panic.&n; *&n; * Revision 1.11  2001/04/04 11:21:05  markusl&n; * Updated according to review remarks&n; *&n; * Revision 1.10  2001/03/26 16:03:06  bjornw&n; * Needs linux/config.h&n; *&n; * Revision 1.9  2001/03/19 14:47:48  pkj&n; * * Make sure there is always a pause after the network LEDs are&n; *   changed so they will not look constantly lit during heavy traffic.&n; * * Always use HZ when setting times relative to jiffies.&n; * * Use LED_NETWORK_SET() when setting the network LEDs.&n; *&n; * Revision 1.8  2001/02/27 13:52:48  bjornw&n; * malloc.h -&gt; slab.h&n; *&n; * Revision 1.7  2001/02/23 13:46:38  bjornw&n; * Spellling check&n; *&n; * Revision 1.6  2001/01/26 15:21:04  starvik&n; * Don&squot;t disable interrupts while reading MDIO registers (MDIO is slow)&n; * Corrected promiscuous mode&n; * Improved deallocation of IRQs (&quot;ifconfig eth0 down&quot; now works)&n; *&n; * Revision 1.5  2000/11/29 17:22:22  bjornw&n; * Get rid of the udword types legacy stuff&n; *&n; * Revision 1.4  2000/11/22 16:36:09  bjornw&n; * Please marketing by using the correct case when spelling Etrax.&n; *&n; * Revision 1.3  2000/11/21 16:43:04  bjornw&n; * Minor short-&gt;int change&n; *&n; * Revision 1.2  2000/11/08 14:27:57  bjornw&n; * 2.4 port&n; *&n; * Revision 1.1  2000/11/06 13:56:00  bjornw&n; * Verbatim copy of the 1.24 version of e100net.c from elinux&n; *&n; * Revision 1.24  2000/10/04 15:55:23  bjornw&n; * * Use virt_to_phys etc. for DMA addresses&n; * * Removed bogus CHECKSUM_UNNECESSARY&n; *&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;asm/arch/svinto.h&gt;/* DMA and register descriptions */
macro_line|#include &lt;asm/io.h&gt;         /* LED_* I/O functions */
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/ethernet.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
singleline_comment|//#define ETHDEBUG
DECL|macro|D
mdefine_line|#define D(x)
multiline_comment|/*&n; * The name of the card. Is used for messages and in the requests for&n; * io regions, irqs and dma channels&n; */
DECL|variable|cardname
r_static
r_const
r_char
op_star
id|cardname
op_assign
l_string|&quot;ETRAX 100LX built-in ethernet controller&quot;
suffix:semicolon
multiline_comment|/* A default ethernet address. Highlevel SW will set the real one later */
DECL|variable|default_mac
r_static
r_struct
id|sockaddr
id|default_mac
op_assign
(brace
l_int|0
comma
(brace
l_int|0x00
comma
l_int|0x40
comma
l_int|0x8C
comma
l_int|0xCD
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
suffix:semicolon
multiline_comment|/* Information that need to be kept for each board. */
DECL|struct|net_local
r_struct
id|net_local
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|mii_if
r_struct
id|mii_if_info
id|mii_if
suffix:semicolon
multiline_comment|/* Tx control lock.  This protects the transmit buffer ring&n;&t; * state along with the &quot;tx full&quot; state of the driver.  This&n;&t; * means all netif_queue flow control actions are protected&n;&t; * by this lock as well.&n;&t; */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|etrax_eth_descr
r_typedef
r_struct
id|etrax_eth_descr
(brace
DECL|member|descr
id|etrax_dma_descr
id|descr
suffix:semicolon
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|typedef|etrax_eth_descr
)brace
id|etrax_eth_descr
suffix:semicolon
multiline_comment|/* Some transceivers requires special handling */
DECL|struct|transceiver_ops
r_struct
id|transceiver_ops
(brace
DECL|member|oui
r_int
r_int
id|oui
suffix:semicolon
DECL|member|check_speed
r_void
(paren
op_star
id|check_speed
)paren
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|member|check_duplex
r_void
(paren
op_star
id|check_duplex
)paren
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|transceiver
r_struct
id|transceiver_ops
op_star
id|transceiver
suffix:semicolon
multiline_comment|/* Duplex settings */
DECL|enum|duplex
r_enum
id|duplex
(brace
DECL|enumerator|half
id|half
comma
DECL|enumerator|full
id|full
comma
DECL|enumerator|autoneg
id|autoneg
)brace
suffix:semicolon
multiline_comment|/* Dma descriptors etc. */
DECL|macro|MAX_MEDIA_DATA_SIZE
mdefine_line|#define MAX_MEDIA_DATA_SIZE 1518
DECL|macro|MIN_PACKET_LEN
mdefine_line|#define MIN_PACKET_LEN      46
DECL|macro|ETHER_HEAD_LEN
mdefine_line|#define ETHER_HEAD_LEN      14
multiline_comment|/*&n;** MDIO constants.&n;*/
DECL|macro|MDIO_START
mdefine_line|#define MDIO_START                          0x1
DECL|macro|MDIO_READ
mdefine_line|#define MDIO_READ                           0x2
DECL|macro|MDIO_WRITE
mdefine_line|#define MDIO_WRITE                          0x1
DECL|macro|MDIO_PREAMBLE
mdefine_line|#define MDIO_PREAMBLE              0xfffffffful
multiline_comment|/* Broadcom specific */
DECL|macro|MDIO_AUX_CTRL_STATUS_REG
mdefine_line|#define MDIO_AUX_CTRL_STATUS_REG           0x18
DECL|macro|MDIO_BC_FULL_DUPLEX_IND
mdefine_line|#define MDIO_BC_FULL_DUPLEX_IND             0x1
DECL|macro|MDIO_BC_SPEED
mdefine_line|#define MDIO_BC_SPEED                       0x2
multiline_comment|/* TDK specific */
DECL|macro|MDIO_TDK_DIAGNOSTIC_REG
mdefine_line|#define MDIO_TDK_DIAGNOSTIC_REG              18
DECL|macro|MDIO_TDK_DIAGNOSTIC_RATE
mdefine_line|#define MDIO_TDK_DIAGNOSTIC_RATE          0x400
DECL|macro|MDIO_TDK_DIAGNOSTIC_DPLX
mdefine_line|#define MDIO_TDK_DIAGNOSTIC_DPLX          0x800
multiline_comment|/*Intel LXT972A specific*/
DECL|macro|MDIO_INT_STATUS_REG_2
mdefine_line|#define MDIO_INT_STATUS_REG_2&t;&t;&t;0x0011
DECL|macro|MDIO_INT_FULL_DUPLEX_IND
mdefine_line|#define MDIO_INT_FULL_DUPLEX_IND&t;&t;( 1 &lt;&lt; 9 )
DECL|macro|MDIO_INT_SPEED
mdefine_line|#define MDIO_INT_SPEED&t;&t;&t;&t;( 1 &lt;&lt; 14 )
multiline_comment|/* Network flash constants */
DECL|macro|NET_FLASH_TIME
mdefine_line|#define NET_FLASH_TIME                  (HZ/50) /* 20 ms */
DECL|macro|NET_FLASH_PAUSE
mdefine_line|#define NET_FLASH_PAUSE                (HZ/100) /* 10 ms */
DECL|macro|NET_LINK_UP_CHECK_INTERVAL
mdefine_line|#define NET_LINK_UP_CHECK_INTERVAL       (2*HZ) /* 2 s   */
DECL|macro|NET_DUPLEX_CHECK_INTERVAL
mdefine_line|#define NET_DUPLEX_CHECK_INTERVAL        (2*HZ) /* 2 s   */
DECL|macro|NO_NETWORK_ACTIVITY
mdefine_line|#define NO_NETWORK_ACTIVITY 0
DECL|macro|NETWORK_ACTIVITY
mdefine_line|#define NETWORK_ACTIVITY    1
DECL|macro|NBR_OF_RX_DESC
mdefine_line|#define NBR_OF_RX_DESC     64
DECL|macro|NBR_OF_TX_DESC
mdefine_line|#define NBR_OF_TX_DESC     256
multiline_comment|/* Large packets are sent directly to upper layers while small packets are */
multiline_comment|/* copied (to reduce memory waste). The following constant decides the breakpoint */
DECL|macro|RX_COPYBREAK
mdefine_line|#define RX_COPYBREAK 256
multiline_comment|/* Due to a chip bug we need to flush the cache when descriptors are returned */
multiline_comment|/* to the DMA. To decrease performance impact we return descriptors in chunks. */
multiline_comment|/* The following constant determines the number of descriptors to return. */
DECL|macro|RX_QUEUE_THRESHOLD
mdefine_line|#define RX_QUEUE_THRESHOLD  NBR_OF_RX_DESC/2
DECL|macro|GET_BIT
mdefine_line|#define GET_BIT(bit,val)   (((val) &gt;&gt; (bit)) &amp; 0x01)
multiline_comment|/* Define some macros to access ETRAX 100 registers */
DECL|macro|SETF
mdefine_line|#define SETF(var, reg, field, val) var = (var &amp; ~IO_MASK_(reg##_, field##_)) | &bslash;&n;&t;&t;&t;&t;&t;  IO_FIELD_(reg##_, field##_, val)
DECL|macro|SETS
mdefine_line|#define SETS(var, reg, field, val) var = (var &amp; ~IO_MASK_(reg##_, field##_)) | &bslash;&n;&t;&t;&t;&t;&t;  IO_STATE_(reg##_, field##_, _##val)
DECL|variable|myNextRxDesc
r_static
id|etrax_eth_descr
op_star
id|myNextRxDesc
suffix:semicolon
multiline_comment|/* Points to the next descriptor to&n;                                          to be processed */
DECL|variable|myLastRxDesc
r_static
id|etrax_eth_descr
op_star
id|myLastRxDesc
suffix:semicolon
multiline_comment|/* The last processed descriptor */
DECL|variable|myPrevRxDesc
r_static
id|etrax_eth_descr
op_star
id|myPrevRxDesc
suffix:semicolon
multiline_comment|/* The descriptor right before myNextRxDesc */
DECL|variable|RxDescList
r_static
id|etrax_eth_descr
id|RxDescList
(braket
id|NBR_OF_RX_DESC
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|variable|myFirstTxDesc
r_static
id|etrax_eth_descr
op_star
id|myFirstTxDesc
suffix:semicolon
multiline_comment|/* First packet not yet sent */
DECL|variable|myLastTxDesc
r_static
id|etrax_eth_descr
op_star
id|myLastTxDesc
suffix:semicolon
multiline_comment|/* End of send queue */
DECL|variable|myNextTxDesc
r_static
id|etrax_eth_descr
op_star
id|myNextTxDesc
suffix:semicolon
multiline_comment|/* Next descriptor to use */
DECL|variable|TxDescList
r_static
id|etrax_eth_descr
id|TxDescList
(braket
id|NBR_OF_TX_DESC
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|variable|network_rec_config_shadow
r_static
r_int
r_int
id|network_rec_config_shadow
op_assign
l_int|0
suffix:semicolon
DECL|variable|mdio_phy_addr
r_static
r_int
r_int
id|mdio_phy_addr
suffix:semicolon
multiline_comment|/* Transciever address */
DECL|variable|network_tr_ctrl_shadow
r_static
r_int
r_int
id|network_tr_ctrl_shadow
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Network speed indication. */
DECL|variable|speed_timer
r_static
r_struct
id|timer_list
id|speed_timer
op_assign
id|TIMER_INITIALIZER
c_func
(paren
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
DECL|variable|clear_led_timer
r_static
r_struct
id|timer_list
id|clear_led_timer
op_assign
id|TIMER_INITIALIZER
c_func
(paren
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
DECL|variable|current_speed
r_static
r_int
id|current_speed
suffix:semicolon
multiline_comment|/* Speed read from transceiver */
DECL|variable|current_speed_selection
r_static
r_int
id|current_speed_selection
suffix:semicolon
multiline_comment|/* Speed selected by user */
DECL|variable|led_next_time
r_static
r_int
r_int
id|led_next_time
suffix:semicolon
DECL|variable|led_active
r_static
r_int
id|led_active
suffix:semicolon
DECL|variable|rx_queue_len
r_static
r_int
id|rx_queue_len
suffix:semicolon
multiline_comment|/* Duplex */
DECL|variable|duplex_timer
r_static
r_struct
id|timer_list
id|duplex_timer
op_assign
id|TIMER_INITIALIZER
c_func
(paren
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
DECL|variable|full_duplex
r_static
r_int
id|full_duplex
suffix:semicolon
DECL|variable|current_duplex
r_static
r_enum
id|duplex
id|current_duplex
suffix:semicolon
multiline_comment|/* Index to functions, as function prototypes. */
r_static
r_int
id|etrax_ethernet_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|e100_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|e100_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
r_static
r_int
id|e100_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|e100rxtx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|e100nw_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|e100_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|e100_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|e100_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|e100_ethtool_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
)paren
suffix:semicolon
r_static
r_int
id|e100_set_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
suffix:semicolon
r_static
r_void
id|e100_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|e100_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|e100_hardware_send_packet
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_void
id|update_rx_stats
c_func
(paren
r_struct
id|net_device_stats
op_star
)paren
suffix:semicolon
r_static
r_void
id|update_tx_stats
c_func
(paren
r_struct
id|net_device_stats
op_star
)paren
suffix:semicolon
r_static
r_int
id|e100_probe_transceiver
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|e100_check_speed
c_func
(paren
r_int
r_int
id|priv
)paren
suffix:semicolon
r_static
r_void
id|e100_set_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|speed
)paren
suffix:semicolon
r_static
r_void
id|e100_check_duplex
c_func
(paren
r_int
r_int
id|priv
)paren
suffix:semicolon
r_static
r_void
id|e100_set_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_enum
id|duplex
)paren
suffix:semicolon
r_static
r_void
id|e100_negotiate
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|e100_get_mdio_reg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|e100_set_mdio_reg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_void
id|e100_send_mdio_cmd
c_func
(paren
r_int
r_int
id|cmd
comma
r_int
id|write_cmd
)paren
suffix:semicolon
r_static
r_void
id|e100_send_mdio_bit
c_func
(paren
r_int
r_char
id|bit
)paren
suffix:semicolon
r_static
r_int
r_char
id|e100_receive_mdio_bit
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|e100_reset_transceiver
c_func
(paren
r_struct
id|net_device
op_star
id|net
)paren
suffix:semicolon
r_static
r_void
id|e100_clear_network_leds
c_func
(paren
r_int
r_int
id|dummy
)paren
suffix:semicolon
r_static
r_void
id|e100_set_network_leds
c_func
(paren
r_int
id|active
)paren
suffix:semicolon
r_static
r_void
id|broadcom_check_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|broadcom_check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tdk_check_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tdk_check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|intel_check_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|intel_check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|generic_check_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|generic_check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|transceivers
r_struct
id|transceiver_ops
id|transceivers
(braket
)braket
op_assign
(brace
(brace
l_int|0x1018
comma
id|broadcom_check_speed
comma
id|broadcom_check_duplex
)brace
comma
multiline_comment|/* Broadcom */
(brace
l_int|0xC039
comma
id|tdk_check_speed
comma
id|tdk_check_duplex
)brace
comma
multiline_comment|/* TDK 2120 */
(brace
l_int|0x039C
comma
id|tdk_check_speed
comma
id|tdk_check_duplex
)brace
comma
multiline_comment|/* TDK 2120C */
(brace
l_int|0x04de
comma
id|intel_check_speed
comma
id|intel_check_duplex
)brace
comma
multiline_comment|/* Intel LXT972A*/
(brace
l_int|0x0000
comma
id|generic_check_speed
comma
id|generic_check_duplex
)brace
multiline_comment|/* Generic, must be last */
)brace
suffix:semicolon
DECL|macro|tx_done
mdefine_line|#define tx_done(dev) (*R_DMA_CH0_CMD == 0)
multiline_comment|/*&n; * Check for a network adaptor of this type, and return &squot;0&squot; if one exists.&n; * If dev-&gt;base_addr == 0, probe all likely locations.&n; * If dev-&gt;base_addr == 1, always return failure.&n; * If dev-&gt;base_addr == 2, allocate space for the device and return success&n; * (detachable devices only).&n; */
r_static
r_int
id|__init
DECL|function|etrax_ethernet_init
id|etrax_ethernet_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|net_local
op_star
id|np
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ETRAX 100LX 10/100MBit ethernet v2.0 (c) 2000-2003 Axis Communications AB&bslash;n&quot;
)paren
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|net_local
)paren
)paren
suffix:semicolon
id|np
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|R_NETWORK_SA_0
suffix:semicolon
multiline_comment|/* just to have something to show */
multiline_comment|/* now setup our etrax specific stuff */
id|dev-&gt;irq
op_assign
id|NETWORK_DMA_RX_IRQ_NBR
suffix:semicolon
multiline_comment|/* we really use DMATX as well... */
id|dev-&gt;dma
op_assign
id|NETWORK_RX_DMA_NBR
suffix:semicolon
multiline_comment|/* fill in our handlers so the network layer can talk to us in the future */
id|dev-&gt;open
op_assign
id|e100_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|e100_send_packet
suffix:semicolon
id|dev-&gt;stop
op_assign
id|e100_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|e100_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|set_multicast_list
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|e100_set_mac_address
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|e100_ioctl
suffix:semicolon
id|dev-&gt;set_config
op_assign
id|e100_set_config
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|e100_tx_timeout
suffix:semicolon
multiline_comment|/* Initialise the list of Etrax DMA-descriptors */
multiline_comment|/* Initialise receive descriptors */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NBR_OF_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Allocate two extra cachelines to make sure that buffer used by DMA&n;&t;&t; * does not share cacheline with any other data (to avoid cache bug)&n;&t;&t; */
id|RxDescList
(braket
id|i
)braket
dot
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|MAX_MEDIA_DATA_SIZE
op_plus
l_int|2
op_star
id|L1_CACHE_BYTES
)paren
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|descr.ctrl
op_assign
l_int|0
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|descr.sw_len
op_assign
id|MAX_MEDIA_DATA_SIZE
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|descr.next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|RxDescList
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|descr.buf
op_assign
id|L1_CACHE_ALIGN
c_func
(paren
id|virt_to_phys
c_func
(paren
id|RxDescList
(braket
id|i
)braket
dot
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|descr.status
op_assign
l_int|0
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|descr.hw_len
op_assign
l_int|0
suffix:semicolon
id|prepare_rx_descriptor
c_func
(paren
op_amp
id|RxDescList
(braket
id|i
)braket
dot
id|descr
)paren
suffix:semicolon
)brace
id|RxDescList
(braket
id|NBR_OF_RX_DESC
op_minus
l_int|1
)braket
dot
id|descr.ctrl
op_assign
id|d_eol
suffix:semicolon
id|RxDescList
(braket
id|NBR_OF_RX_DESC
op_minus
l_int|1
)braket
dot
id|descr.next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|RxDescList
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|rx_queue_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize transmit descriptors */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NBR_OF_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TxDescList
(braket
id|i
)braket
dot
id|descr.ctrl
op_assign
l_int|0
suffix:semicolon
id|TxDescList
(braket
id|i
)braket
dot
id|descr.sw_len
op_assign
l_int|0
suffix:semicolon
id|TxDescList
(braket
id|i
)braket
dot
id|descr.next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxDescList
(braket
id|i
op_plus
l_int|1
)braket
dot
id|descr
)paren
suffix:semicolon
id|TxDescList
(braket
id|i
)braket
dot
id|descr.buf
op_assign
l_int|0
suffix:semicolon
id|TxDescList
(braket
id|i
)braket
dot
id|descr.status
op_assign
l_int|0
suffix:semicolon
id|TxDescList
(braket
id|i
)braket
dot
id|descr.hw_len
op_assign
l_int|0
suffix:semicolon
id|TxDescList
(braket
id|i
)braket
dot
id|skb
op_assign
l_int|0
suffix:semicolon
)brace
id|TxDescList
(braket
id|NBR_OF_TX_DESC
op_minus
l_int|1
)braket
dot
id|descr.ctrl
op_assign
id|d_eol
suffix:semicolon
id|TxDescList
(braket
id|NBR_OF_TX_DESC
op_minus
l_int|1
)braket
dot
id|descr.next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxDescList
(braket
l_int|0
)braket
dot
id|descr
)paren
suffix:semicolon
multiline_comment|/* Initialise initial pointers */
id|myNextRxDesc
op_assign
op_amp
id|RxDescList
(braket
l_int|0
)braket
suffix:semicolon
id|myLastRxDesc
op_assign
op_amp
id|RxDescList
(braket
id|NBR_OF_RX_DESC
op_minus
l_int|1
)braket
suffix:semicolon
id|myPrevRxDesc
op_assign
op_amp
id|RxDescList
(braket
id|NBR_OF_RX_DESC
op_minus
l_int|1
)braket
suffix:semicolon
id|myFirstTxDesc
op_assign
op_amp
id|TxDescList
(braket
l_int|0
)braket
suffix:semicolon
id|myNextTxDesc
op_assign
op_amp
id|TxDescList
(braket
l_int|0
)braket
suffix:semicolon
id|myLastTxDesc
op_assign
op_amp
id|TxDescList
(braket
id|NBR_OF_TX_DESC
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Register device */
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* set the default MAC address */
id|e100_set_mac_address
c_func
(paren
id|dev
comma
op_amp
id|default_mac
)paren
suffix:semicolon
multiline_comment|/* Initialize speed indicator stuff. */
id|current_speed
op_assign
l_int|10
suffix:semicolon
id|current_speed_selection
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Auto */
id|speed_timer.expires
op_assign
id|jiffies
op_plus
id|NET_LINK_UP_CHECK_INTERVAL
suffix:semicolon
id|duplex_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|speed_timer.function
op_assign
id|e100_check_speed
suffix:semicolon
id|clear_led_timer.function
op_assign
id|e100_clear_network_leds
suffix:semicolon
id|full_duplex
op_assign
l_int|0
suffix:semicolon
id|current_duplex
op_assign
id|autoneg
suffix:semicolon
id|duplex_timer.expires
op_assign
id|jiffies
op_plus
id|NET_DUPLEX_CHECK_INTERVAL
suffix:semicolon
id|duplex_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|duplex_timer.function
op_assign
id|e100_check_duplex
suffix:semicolon
multiline_comment|/* Initialize mii interface */
id|np-&gt;mii_if.phy_id
op_assign
id|mdio_phy_addr
suffix:semicolon
id|np-&gt;mii_if.phy_id_mask
op_assign
l_int|0x1f
suffix:semicolon
id|np-&gt;mii_if.reg_num_mask
op_assign
l_int|0x1f
suffix:semicolon
id|np-&gt;mii_if.dev
op_assign
id|dev
suffix:semicolon
id|np-&gt;mii_if.mdio_read
op_assign
id|e100_get_mdio_reg
suffix:semicolon
id|np-&gt;mii_if.mdio_write
op_assign
id|e100_set_mdio_reg
suffix:semicolon
multiline_comment|/* Initialize group address registers to make sure that no */
multiline_comment|/* unwanted addresses are matched */
op_star
id|R_NETWORK_GA_0
op_assign
l_int|0x00000000
suffix:semicolon
op_star
id|R_NETWORK_GA_1
op_assign
l_int|0x00000000
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set MAC address of the interface. called from the core after a&n; * SIOCSIFADDR ioctl, and from the bootup above.&n; */
r_static
r_int
DECL|function|e100_set_mac_address
id|e100_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|p
)paren
(brace
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sockaddr
op_star
id|addr
op_assign
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* preemption protection */
multiline_comment|/* remember it */
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|addr-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
multiline_comment|/* Write it to the hardware.&n;&t; * Note the way the address is wrapped:&n;&t; * *R_NETWORK_SA_0 = a0_0 | (a0_1 &lt;&lt; 8) | (a0_2 &lt;&lt; 16) | (a0_3 &lt;&lt; 24);&n;&t; * *R_NETWORK_SA_1 = a0_4 | (a0_5 &lt;&lt; 8);&n;&t; */
op_star
id|R_NETWORK_SA_0
op_assign
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
op_star
id|R_NETWORK_SA_1
op_assign
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
op_star
id|R_NETWORK_SA_2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* show it in the log as well */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: changed MAC to &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Open/initialize the board. This is called (in the current kernel)&n; * sometime after booting when the &squot;ifconfig&squot; program is run.&n; *&n; * This routine should set everything up anew at each open, even&n; * registers that &quot;should&quot; only need to be set once at boot, so that&n; * there is non-reboot way to recover if something goes wrong.&n; */
r_static
r_int
DECL|function|e100_open
id|e100_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* enable the MDIO output pin */
op_star
id|R_NETWORK_MGM_CTRL
op_assign
id|IO_STATE
c_func
(paren
id|R_NETWORK_MGM_CTRL
comma
id|mdoe
comma
id|enable
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK0_CLR
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_CLR
comma
id|overrun
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_CLR
comma
id|underrun
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_CLR
comma
id|excessive_col
comma
id|clr
)paren
suffix:semicolon
multiline_comment|/* clear dma0 and 1 eop and descr irq masks */
op_star
id|R_IRQ_MASK2_CLR
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma0_descr
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma0_eop
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma1_descr
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma1_eop
comma
id|clr
)paren
suffix:semicolon
multiline_comment|/* Reset and wait for the DMA channels */
id|RESET_DMA
c_func
(paren
id|NETWORK_TX_DMA_NBR
)paren
suffix:semicolon
id|RESET_DMA
c_func
(paren
id|NETWORK_RX_DMA_NBR
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
id|NETWORK_TX_DMA_NBR
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
id|NETWORK_RX_DMA_NBR
)paren
suffix:semicolon
multiline_comment|/* Initialise the etrax network controller */
multiline_comment|/* allocate the irq corresponding to the receiving DMA */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|NETWORK_DMA_RX_IRQ_NBR
comma
id|e100rxtx_interrupt
comma
id|SA_SAMPLE_RANDOM
comma
id|cardname
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
r_goto
id|grace_exit0
suffix:semicolon
)brace
multiline_comment|/* allocate the irq corresponding to the transmitting DMA */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|NETWORK_DMA_TX_IRQ_NBR
comma
id|e100rxtx_interrupt
comma
l_int|0
comma
id|cardname
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
r_goto
id|grace_exit1
suffix:semicolon
)brace
multiline_comment|/* allocate the irq corresponding to the network errors etc */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|NETWORK_STATUS_IRQ_NBR
comma
id|e100nw_interrupt
comma
l_int|0
comma
id|cardname
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
r_goto
id|grace_exit2
suffix:semicolon
)brace
multiline_comment|/* give the HW an idea of what MAC address we want */
op_star
id|R_NETWORK_SA_0
op_assign
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
op_star
id|R_NETWORK_SA_1
op_assign
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_or
(paren
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
op_star
id|R_NETWORK_SA_2
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
multiline_comment|/* use promiscuous mode for testing */
op_star
id|R_NETWORK_GA_0
op_assign
l_int|0xffffffff
suffix:semicolon
op_star
id|R_NETWORK_GA_1
op_assign
l_int|0xffffffff
suffix:semicolon
op_star
id|R_NETWORK_REC_CONFIG
op_assign
l_int|0xd
suffix:semicolon
multiline_comment|/* broadcast rec, individ. rec, ma0 enabled */
macro_line|#else
id|SETS
c_func
(paren
id|network_rec_config_shadow
comma
id|R_NETWORK_REC_CONFIG
comma
id|broadcast
comma
id|receive
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|network_rec_config_shadow
comma
id|R_NETWORK_REC_CONFIG
comma
id|ma0
comma
id|enable
)paren
suffix:semicolon
id|SETF
c_func
(paren
id|network_rec_config_shadow
comma
id|R_NETWORK_REC_CONFIG
comma
id|duplex
comma
id|full_duplex
)paren
suffix:semicolon
op_star
id|R_NETWORK_REC_CONFIG
op_assign
id|network_rec_config_shadow
suffix:semicolon
macro_line|#endif
op_star
id|R_NETWORK_GEN_CONFIG
op_assign
id|IO_STATE
c_func
(paren
id|R_NETWORK_GEN_CONFIG
comma
id|phy
comma
id|mii_clk
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_NETWORK_GEN_CONFIG
comma
id|enable
comma
id|on
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|clr_error
comma
id|clr
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|delay
comma
id|none
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|cancel
comma
id|dont
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|cd
comma
id|enable
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|retry
comma
id|enable
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|pad
comma
id|enable
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|crc
comma
id|enable
)paren
suffix:semicolon
op_star
id|R_NETWORK_TR_CTRL
op_assign
id|network_tr_ctrl_shadow
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* enable the irq&squot;s for ethernet DMA */
op_star
id|R_IRQ_MASK2_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma0_eop
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma1_eop
comma
id|set
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK0_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_SET
comma
id|overrun
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_SET
comma
id|underrun
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_SET
comma
id|excessive_col
comma
id|set
)paren
suffix:semicolon
multiline_comment|/* make sure the irqs are cleared */
op_star
id|R_DMA_CH0_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
suffix:semicolon
op_star
id|R_DMA_CH1_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH1_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
suffix:semicolon
multiline_comment|/* make sure the rec and transmit error counters are cleared */
(paren
r_void
)paren
op_star
id|R_REC_COUNTERS
suffix:semicolon
multiline_comment|/* dummy read */
(paren
r_void
)paren
op_star
id|R_TR_COUNTERS
suffix:semicolon
multiline_comment|/* dummy read */
multiline_comment|/* start the receiving DMA channel so we can receive packets from now on */
op_star
id|R_DMA_CH1_FIRST
op_assign
id|virt_to_phys
c_func
(paren
id|myNextRxDesc
)paren
suffix:semicolon
op_star
id|R_DMA_CH1_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH1_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
multiline_comment|/* Set up transmit DMA channel so it can be restarted later */
op_star
id|R_DMA_CH0_FIRST
op_assign
l_int|0
suffix:semicolon
op_star
id|R_DMA_CH0_DESCR
op_assign
id|virt_to_phys
c_func
(paren
id|myLastTxDesc
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Probe for transceiver */
r_if
c_cond
(paren
id|e100_probe_transceiver
c_func
(paren
id|dev
)paren
)paren
r_goto
id|grace_exit3
suffix:semicolon
multiline_comment|/* Start duplex/speed timers */
id|add_timer
c_func
(paren
op_amp
id|speed_timer
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|duplex_timer
)paren
suffix:semicolon
multiline_comment|/* We are now ready to accept transmit requeusts from&n;&t; * the queueing layer of the networking.&n;&t; */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|grace_exit3
suffix:colon
id|free_irq
c_func
(paren
id|NETWORK_STATUS_IRQ_NBR
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|grace_exit2
suffix:colon
id|free_irq
c_func
(paren
id|NETWORK_DMA_TX_IRQ_NBR
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|grace_exit1
suffix:colon
id|free_irq
c_func
(paren
id|NETWORK_DMA_RX_IRQ_NBR
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|grace_exit0
suffix:colon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_static
r_void
DECL|function|generic_check_speed
id|generic_check_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
id|ADVERTISE_100FULL
)paren
op_logical_or
(paren
id|data
op_amp
id|ADVERTISE_100HALF
)paren
)paren
id|current_speed
op_assign
l_int|100
suffix:semicolon
r_else
id|current_speed
op_assign
l_int|10
suffix:semicolon
)brace
r_static
r_void
DECL|function|tdk_check_speed
id|tdk_check_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MDIO_TDK_DIAGNOSTIC_REG
)paren
suffix:semicolon
id|current_speed
op_assign
(paren
id|data
op_amp
id|MDIO_TDK_DIAGNOSTIC_RATE
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|broadcom_check_speed
id|broadcom_check_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MDIO_AUX_CTRL_STATUS_REG
)paren
suffix:semicolon
id|current_speed
op_assign
(paren
id|data
op_amp
id|MDIO_BC_SPEED
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|intel_check_speed
id|intel_check_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MDIO_INT_STATUS_REG_2
)paren
suffix:semicolon
id|current_speed
op_assign
(paren
id|data
op_amp
id|MDIO_INT_SPEED
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|e100_check_speed
id|e100_check_speed
c_func
(paren
r_int
r_int
id|priv
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|priv
suffix:semicolon
r_static
r_int
id|led_initiated
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_int
id|old_speed
op_assign
id|current_speed
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_BMSR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_amp
id|BMSR_LSTATUS
)paren
)paren
(brace
id|current_speed
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|transceiver
op_member_access_from_pointer
id|check_speed
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|old_speed
op_ne
id|current_speed
)paren
op_logical_or
op_logical_neg
id|led_initiated
)paren
(brace
id|led_initiated
op_assign
l_int|1
suffix:semicolon
id|e100_set_network_leds
c_func
(paren
id|NO_NETWORK_ACTIVITY
)paren
suffix:semicolon
)brace
multiline_comment|/* Reinitialize the timer. */
id|speed_timer.expires
op_assign
id|jiffies
op_plus
id|NET_LINK_UP_CHECK_INTERVAL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|speed_timer
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|e100_negotiate
id|e100_negotiate
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
multiline_comment|/* Discard old speed and duplex settings */
id|data
op_and_assign
op_complement
(paren
id|ADVERTISE_100HALF
op_or
id|ADVERTISE_100FULL
op_or
id|ADVERTISE_10HALF
op_or
id|ADVERTISE_10FULL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|current_speed_selection
)paren
(brace
r_case
l_int|10
suffix:colon
r_if
c_cond
(paren
id|current_duplex
op_eq
id|full
)paren
id|data
op_or_assign
id|ADVERTISE_10FULL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|current_duplex
op_eq
id|half
)paren
id|data
op_or_assign
id|ADVERTISE_10HALF
suffix:semicolon
r_else
id|data
op_or_assign
id|ADVERTISE_10HALF
op_or
id|ADVERTISE_10FULL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|100
suffix:colon
r_if
c_cond
(paren
id|current_duplex
op_eq
id|full
)paren
id|data
op_or_assign
id|ADVERTISE_100FULL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|current_duplex
op_eq
id|half
)paren
id|data
op_or_assign
id|ADVERTISE_100HALF
suffix:semicolon
r_else
id|data
op_or_assign
id|ADVERTISE_100HALF
op_or
id|ADVERTISE_100FULL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* Auto */
r_if
c_cond
(paren
id|current_duplex
op_eq
id|full
)paren
id|data
op_or_assign
id|ADVERTISE_100FULL
op_or
id|ADVERTISE_10FULL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|current_duplex
op_eq
id|half
)paren
id|data
op_or_assign
id|ADVERTISE_100HALF
op_or
id|ADVERTISE_10HALF
suffix:semicolon
r_else
id|data
op_or_assign
id|ADVERTISE_10HALF
op_or
id|ADVERTISE_10FULL
op_or
id|ADVERTISE_100HALF
op_or
id|ADVERTISE_100FULL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* assume autoneg speed and duplex */
id|data
op_or_assign
id|ADVERTISE_10HALF
op_or
id|ADVERTISE_10FULL
op_or
id|ADVERTISE_100HALF
op_or
id|ADVERTISE_100FULL
suffix:semicolon
)brace
id|e100_set_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_ADVERTISE
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Renegotiate with link partner */
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_BMCR
)paren
suffix:semicolon
id|data
op_or_assign
id|BMCR_ANENABLE
op_or
id|BMCR_ANRESTART
suffix:semicolon
id|e100_set_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_BMCR
comma
id|data
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|e100_set_speed
id|e100_set_speed
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|speed
)paren
(brace
r_if
c_cond
(paren
id|speed
op_ne
id|current_speed_selection
)paren
(brace
id|current_speed_selection
op_assign
id|speed
suffix:semicolon
id|e100_negotiate
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|e100_check_duplex
id|e100_check_duplex
c_func
(paren
r_int
r_int
id|priv
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|priv
suffix:semicolon
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|old_duplex
op_assign
id|full_duplex
suffix:semicolon
id|transceiver
op_member_access_from_pointer
id|check_duplex
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_duplex
op_ne
id|full_duplex
)paren
(brace
multiline_comment|/* Duplex changed */
id|SETF
c_func
(paren
id|network_rec_config_shadow
comma
id|R_NETWORK_REC_CONFIG
comma
id|duplex
comma
id|full_duplex
)paren
suffix:semicolon
op_star
id|R_NETWORK_REC_CONFIG
op_assign
id|network_rec_config_shadow
suffix:semicolon
)brace
multiline_comment|/* Reinitialize the timer. */
id|duplex_timer.expires
op_assign
id|jiffies
op_plus
id|NET_DUPLEX_CHECK_INTERVAL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|duplex_timer
)paren
suffix:semicolon
id|np-&gt;mii_if.full_duplex
op_assign
id|full_duplex
suffix:semicolon
)brace
r_static
r_void
DECL|function|generic_check_duplex
id|generic_check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
id|ADVERTISE_10FULL
)paren
op_logical_or
(paren
id|data
op_amp
id|ADVERTISE_100FULL
)paren
)paren
id|full_duplex
op_assign
l_int|1
suffix:semicolon
r_else
id|full_duplex
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|tdk_check_duplex
id|tdk_check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MDIO_TDK_DIAGNOSTIC_REG
)paren
suffix:semicolon
id|full_duplex
op_assign
(paren
id|data
op_amp
id|MDIO_TDK_DIAGNOSTIC_DPLX
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|broadcom_check_duplex
id|broadcom_check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MDIO_AUX_CTRL_STATUS_REG
)paren
suffix:semicolon
id|full_duplex
op_assign
(paren
id|data
op_amp
id|MDIO_BC_FULL_DUPLEX_IND
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|intel_check_duplex
id|intel_check_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MDIO_INT_STATUS_REG_2
)paren
suffix:semicolon
id|full_duplex
op_assign
(paren
id|data
op_amp
id|MDIO_INT_FULL_DUPLEX_IND
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|e100_set_duplex
id|e100_set_duplex
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_enum
id|duplex
id|new_duplex
)paren
(brace
r_if
c_cond
(paren
id|new_duplex
op_ne
id|current_duplex
)paren
(brace
id|current_duplex
op_assign
id|new_duplex
suffix:semicolon
id|e100_negotiate
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|e100_probe_transceiver
id|e100_probe_transceiver
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|phyid_high
suffix:semicolon
r_int
r_int
id|phyid_low
suffix:semicolon
r_int
r_int
id|oui
suffix:semicolon
r_struct
id|transceiver_ops
op_star
id|ops
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Probe MDIO physical address */
r_for
c_loop
(paren
id|mdio_phy_addr
op_assign
l_int|0
suffix:semicolon
id|mdio_phy_addr
op_le
l_int|31
suffix:semicolon
id|mdio_phy_addr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_BMSR
)paren
op_ne
l_int|0xffff
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mdio_phy_addr
op_eq
l_int|32
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Get manufacturer */
id|phyid_high
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_PHYSID1
)paren
suffix:semicolon
id|phyid_low
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_PHYSID2
)paren
suffix:semicolon
id|oui
op_assign
(paren
id|phyid_high
op_lshift
l_int|6
)paren
op_or
(paren
id|phyid_low
op_rshift
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ops
op_assign
op_amp
id|transceivers
(braket
l_int|0
)braket
suffix:semicolon
id|ops-&gt;oui
suffix:semicolon
id|ops
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ops-&gt;oui
op_eq
id|oui
)paren
r_break
suffix:semicolon
)brace
id|transceiver
op_assign
id|ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|e100_get_mdio_reg
id|e100_get_mdio_reg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_int
r_int
id|cmd
suffix:semicolon
multiline_comment|/* Data to be sent on MDIO port */
r_int
id|data
suffix:semicolon
multiline_comment|/* Data read from MDIO */
r_int
id|bitCounter
suffix:semicolon
multiline_comment|/* Start of frame, OP Code, Physical Address, Register Address */
id|cmd
op_assign
(paren
id|MDIO_START
op_lshift
l_int|14
)paren
op_or
(paren
id|MDIO_READ
op_lshift
l_int|12
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|7
)paren
op_or
(paren
id|location
op_lshift
l_int|2
)paren
suffix:semicolon
id|e100_send_mdio_cmd
c_func
(paren
id|cmd
comma
l_int|0
)paren
suffix:semicolon
id|data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Data... */
r_for
c_loop
(paren
id|bitCounter
op_assign
l_int|15
suffix:semicolon
id|bitCounter
op_ge
l_int|0
suffix:semicolon
id|bitCounter
op_decrement
)paren
(brace
id|data
op_or_assign
(paren
id|e100_receive_mdio_bit
c_func
(paren
)paren
op_lshift
id|bitCounter
)paren
suffix:semicolon
)brace
r_return
id|data
suffix:semicolon
)brace
r_static
r_void
DECL|function|e100_set_mdio_reg
id|e100_set_mdio_reg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_int
id|bitCounter
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
id|cmd
op_assign
(paren
id|MDIO_START
op_lshift
l_int|14
)paren
op_or
(paren
id|MDIO_WRITE
op_lshift
l_int|12
)paren
op_or
(paren
id|phy_id
op_lshift
l_int|7
)paren
op_or
(paren
id|location
op_lshift
l_int|2
)paren
suffix:semicolon
id|e100_send_mdio_cmd
c_func
(paren
id|cmd
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Data... */
r_for
c_loop
(paren
id|bitCounter
op_assign
l_int|15
suffix:semicolon
id|bitCounter
op_ge
l_int|0
suffix:semicolon
id|bitCounter
op_decrement
)paren
(brace
id|e100_send_mdio_bit
c_func
(paren
id|GET_BIT
c_func
(paren
id|bitCounter
comma
id|value
)paren
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|e100_send_mdio_cmd
id|e100_send_mdio_cmd
c_func
(paren
r_int
r_int
id|cmd
comma
r_int
id|write_cmd
)paren
(brace
r_int
id|bitCounter
suffix:semicolon
r_int
r_char
id|data
op_assign
l_int|0x2
suffix:semicolon
multiline_comment|/* Preamble */
r_for
c_loop
(paren
id|bitCounter
op_assign
l_int|31
suffix:semicolon
id|bitCounter
op_ge
l_int|0
suffix:semicolon
id|bitCounter
op_decrement
)paren
id|e100_send_mdio_bit
c_func
(paren
id|GET_BIT
c_func
(paren
id|bitCounter
comma
id|MDIO_PREAMBLE
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bitCounter
op_assign
l_int|15
suffix:semicolon
id|bitCounter
op_ge
l_int|2
suffix:semicolon
id|bitCounter
op_decrement
)paren
id|e100_send_mdio_bit
c_func
(paren
id|GET_BIT
c_func
(paren
id|bitCounter
comma
id|cmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Turnaround */
r_for
c_loop
(paren
id|bitCounter
op_assign
l_int|1
suffix:semicolon
id|bitCounter
op_ge
l_int|0
suffix:semicolon
id|bitCounter
op_decrement
)paren
r_if
c_cond
(paren
id|write_cmd
)paren
id|e100_send_mdio_bit
c_func
(paren
id|GET_BIT
c_func
(paren
id|bitCounter
comma
id|data
)paren
)paren
suffix:semicolon
r_else
id|e100_receive_mdio_bit
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|e100_send_mdio_bit
id|e100_send_mdio_bit
c_func
(paren
r_int
r_char
id|bit
)paren
(brace
op_star
id|R_NETWORK_MGM_CTRL
op_assign
id|IO_STATE
c_func
(paren
id|R_NETWORK_MGM_CTRL
comma
id|mdoe
comma
id|enable
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_NETWORK_MGM_CTRL
comma
id|mdio
comma
id|bit
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
op_star
id|R_NETWORK_MGM_CTRL
op_assign
id|IO_STATE
c_func
(paren
id|R_NETWORK_MGM_CTRL
comma
id|mdoe
comma
id|enable
)paren
op_or
id|IO_MASK
c_func
(paren
id|R_NETWORK_MGM_CTRL
comma
id|mdck
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_NETWORK_MGM_CTRL
comma
id|mdio
comma
id|bit
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_int
r_char
DECL|function|e100_receive_mdio_bit
id|e100_receive_mdio_bit
c_func
(paren
)paren
(brace
r_int
r_char
id|bit
suffix:semicolon
op_star
id|R_NETWORK_MGM_CTRL
op_assign
l_int|0
suffix:semicolon
id|bit
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_NETWORK_STAT
comma
id|mdio
comma
op_star
id|R_NETWORK_STAT
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
op_star
id|R_NETWORK_MGM_CTRL
op_assign
id|IO_MASK
c_func
(paren
id|R_NETWORK_MGM_CTRL
comma
id|mdck
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
id|bit
suffix:semicolon
)brace
r_static
r_void
DECL|function|e100_reset_transceiver
id|e100_reset_transceiver
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|cmd
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_int
id|bitCounter
suffix:semicolon
id|data
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|MII_BMCR
)paren
suffix:semicolon
id|cmd
op_assign
(paren
id|MDIO_START
op_lshift
l_int|14
)paren
op_or
(paren
id|MDIO_WRITE
op_lshift
l_int|12
)paren
op_or
(paren
id|mdio_phy_addr
op_lshift
l_int|7
)paren
op_or
(paren
id|MII_BMCR
op_lshift
l_int|2
)paren
suffix:semicolon
id|e100_send_mdio_cmd
c_func
(paren
id|cmd
comma
l_int|1
)paren
suffix:semicolon
id|data
op_or_assign
l_int|0x8000
suffix:semicolon
r_for
c_loop
(paren
id|bitCounter
op_assign
l_int|15
suffix:semicolon
id|bitCounter
op_ge
l_int|0
suffix:semicolon
id|bitCounter
op_decrement
)paren
(brace
id|e100_send_mdio_bit
c_func
(paren
id|GET_BIT
c_func
(paren
id|bitCounter
comma
id|data
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Called by upper layers if they decide it took too long to complete&n; * sending a packet - we need to reset and stuff.&n; */
r_static
r_void
DECL|function|e100_tx_timeout
id|e100_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|np-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, %s?&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|tx_done
c_func
(paren
id|dev
)paren
ques
c_cond
l_string|&quot;IRQ problem&quot;
suffix:colon
l_string|&quot;network cable problem&quot;
)paren
suffix:semicolon
multiline_comment|/* remember we got an error */
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* reset the TX DMA in case it has hung on something */
id|RESET_DMA
c_func
(paren
id|NETWORK_TX_DMA_NBR
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
id|NETWORK_TX_DMA_NBR
)paren
suffix:semicolon
multiline_comment|/* Reset the transceiver. */
id|e100_reset_transceiver
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* and get rid of the packets that never got an interrupt */
r_while
c_loop
(paren
id|myFirstTxDesc
op_ne
id|myNextTxDesc
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|myFirstTxDesc-&gt;skb
)paren
suffix:semicolon
id|myFirstTxDesc-&gt;skb
op_assign
l_int|0
suffix:semicolon
id|myFirstTxDesc
op_assign
id|phys_to_virt
c_func
(paren
id|myFirstTxDesc-&gt;descr.next
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up transmit DMA channel so it can be restarted later */
op_star
id|R_DMA_CH0_FIRST
op_assign
l_int|0
suffix:semicolon
op_star
id|R_DMA_CH0_DESCR
op_assign
id|virt_to_phys
c_func
(paren
id|myLastTxDesc
)paren
suffix:semicolon
multiline_comment|/* tell the upper layers we&squot;re ok again */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|np-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* This will only be invoked if the driver is _not_ in XOFF state.&n; * What this means is that we need not check it, and that this&n; * invariant will hold if we make sure that the netif_*_queue()&n; * calls are done at the proper times.&n; */
r_static
r_int
DECL|function|e100_send_packet
id|e100_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef ETHDEBUG
id|printk
c_func
(paren
l_string|&quot;send packet len %d&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|np-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* protect from tx_interrupt and ourself */
id|myNextTxDesc-&gt;skb
op_assign
id|skb
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|e100_hardware_send_packet
c_func
(paren
id|buf
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|myNextTxDesc
op_assign
id|phys_to_virt
c_func
(paren
id|myNextTxDesc-&gt;descr.next
)paren
suffix:semicolon
multiline_comment|/* Stop queue if full */
r_if
c_cond
(paren
id|myNextTxDesc
op_eq
id|myFirstTxDesc
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|np-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The typical workload of the driver:&n; *   Handle the network interface interrupts.&n; */
r_static
id|irqreturn_t
DECL|function|e100rxtx_interrupt
id|e100rxtx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|irqbits
op_assign
op_star
id|R_IRQ_MASK2_RD
suffix:semicolon
multiline_comment|/* Disable RX/TX IRQs to avoid reentrancy */
op_star
id|R_IRQ_MASK2_CLR
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma0_eop
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma1_eop
comma
id|clr
)paren
suffix:semicolon
multiline_comment|/* Handle received packets */
r_if
c_cond
(paren
id|irqbits
op_amp
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_RD
comma
id|dma1_eop
comma
id|active
)paren
)paren
(brace
multiline_comment|/* acknowledge the eop interrupt */
op_star
id|R_DMA_CH1_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH1_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
suffix:semicolon
multiline_comment|/* check if one or more complete packets were indeed received */
r_while
c_loop
(paren
(paren
op_star
id|R_DMA_CH1_FIRST
op_ne
id|virt_to_phys
c_func
(paren
id|myNextRxDesc
)paren
)paren
op_logical_and
(paren
id|myNextRxDesc
op_ne
id|myLastRxDesc
)paren
)paren
(brace
multiline_comment|/* Take out the buffer and give it to the OS, then&n;&t;&t;&t; * allocate a new buffer to put a packet in.&n;&t;&t;&t; */
id|e100_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
(paren
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats.rx_packets
op_increment
suffix:semicolon
multiline_comment|/* restart/continue on the channel, for safety */
op_star
id|R_DMA_CH1_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH1_CMD
comma
id|cmd
comma
id|restart
)paren
suffix:semicolon
multiline_comment|/* clear dma channel 1 eop/descr irq bits */
op_star
id|R_DMA_CH1_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH1_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH1_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
multiline_comment|/* now, we might have gotten another packet&n;&t;&t;&t;   so we have to loop back and check if so */
)brace
)brace
multiline_comment|/* Report any packets that have been sent */
r_while
c_loop
(paren
id|myFirstTxDesc
op_ne
id|phys_to_virt
c_func
(paren
op_star
id|R_DMA_CH0_FIRST
)paren
op_logical_and
id|myFirstTxDesc
op_ne
id|myNextTxDesc
)paren
(brace
id|np-&gt;stats.tx_bytes
op_add_assign
id|myFirstTxDesc-&gt;skb-&gt;len
suffix:semicolon
id|np-&gt;stats.tx_packets
op_increment
suffix:semicolon
multiline_comment|/* dma is ready with the transmission of the data in tx_skb, so now&n;&t;&t;   we can release the skb memory */
id|dev_kfree_skb_irq
c_func
(paren
id|myFirstTxDesc-&gt;skb
)paren
suffix:semicolon
id|myFirstTxDesc-&gt;skb
op_assign
l_int|0
suffix:semicolon
id|myFirstTxDesc
op_assign
id|phys_to_virt
c_func
(paren
id|myFirstTxDesc-&gt;descr.next
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irqbits
op_amp
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_RD
comma
id|dma0_eop
comma
id|active
)paren
)paren
(brace
multiline_comment|/* acknowledge the eop interrupt and wake up queue */
op_star
id|R_DMA_CH0_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable RX/TX IRQs again */
op_star
id|R_IRQ_MASK2_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma0_eop
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma1_eop
comma
id|set
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|e100nw_interrupt
id|e100nw_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|irqbits
op_assign
op_star
id|R_IRQ_MASK0_RD
suffix:semicolon
multiline_comment|/* check for underrun irq */
r_if
c_cond
(paren
id|irqbits
op_amp
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_RD
comma
id|underrun
comma
id|active
)paren
)paren
(brace
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|clr_error
comma
id|clr
)paren
suffix:semicolon
op_star
id|R_NETWORK_TR_CTRL
op_assign
id|network_tr_ctrl_shadow
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|clr_error
comma
id|nop
)paren
suffix:semicolon
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|D
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ethernet receiver underrun!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* check for overrun irq */
r_if
c_cond
(paren
id|irqbits
op_amp
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_RD
comma
id|overrun
comma
id|active
)paren
)paren
(brace
id|update_rx_stats
c_func
(paren
op_amp
id|np-&gt;stats
)paren
suffix:semicolon
multiline_comment|/* this will ack the irq */
id|D
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ethernet receiver overrun!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* check for excessive collision irq */
r_if
c_cond
(paren
id|irqbits
op_amp
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_RD
comma
id|excessive_col
comma
id|active
)paren
)paren
(brace
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|clr_error
comma
id|clr
)paren
suffix:semicolon
op_star
id|R_NETWORK_TR_CTRL
op_assign
id|network_tr_ctrl_shadow
suffix:semicolon
id|SETS
c_func
(paren
id|network_tr_ctrl_shadow
comma
id|R_NETWORK_TR_CTRL
comma
id|clr_error
comma
id|nop
)paren
suffix:semicolon
op_star
id|R_NETWORK_TR_CTRL
op_assign
id|IO_STATE
c_func
(paren
id|R_NETWORK_TR_CTRL
comma
id|clr_error
comma
id|clr
)paren
suffix:semicolon
id|np-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|D
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ethernet excessive collisions!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* We have a good packet(s), get it/them out of the buffers. */
r_static
r_void
DECL|function|e100_rx
id|e100_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|length
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
op_star
id|skb_data_ptr
suffix:semicolon
macro_line|#ifdef ETHDEBUG
r_int
id|i
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|led_active
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|led_next_time
)paren
)paren
(brace
multiline_comment|/* light the network leds depending on the current speed. */
id|e100_set_network_leds
c_func
(paren
id|NETWORK_ACTIVITY
)paren
suffix:semicolon
multiline_comment|/* Set the earliest time we may clear the LED */
id|led_next_time
op_assign
id|jiffies
op_plus
id|NET_FLASH_TIME
suffix:semicolon
id|led_active
op_assign
l_int|1
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|clear_led_timer
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
)brace
id|length
op_assign
id|myNextRxDesc-&gt;descr.hw_len
op_minus
l_int|4
suffix:semicolon
(paren
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats.rx_bytes
op_add_assign
id|length
suffix:semicolon
macro_line|#ifdef ETHDEBUG
id|printk
c_func
(paren
l_string|&quot;Got a packet of length %d:&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* dump the first bytes in the packet */
id|skb_data_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|phys_to_virt
c_func
(paren
id|myNextRxDesc-&gt;descr.buf
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d: %.2x %.2x %.2x %.2x %.2x %.2x %.2x %.2x&bslash;n&quot;
comma
id|i
op_star
l_int|8
comma
id|skb_data_ptr
(braket
l_int|0
)braket
comma
id|skb_data_ptr
(braket
l_int|1
)braket
comma
id|skb_data_ptr
(braket
l_int|2
)braket
comma
id|skb_data_ptr
(braket
l_int|3
)braket
comma
id|skb_data_ptr
(braket
l_int|4
)braket
comma
id|skb_data_ptr
(braket
l_int|5
)braket
comma
id|skb_data_ptr
(braket
l_int|6
)braket
comma
id|skb_data_ptr
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|skb_data_ptr
op_add_assign
l_int|8
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|length
OL
id|RX_COPYBREAK
)paren
(brace
multiline_comment|/* Small packet, copy data */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|length
op_minus
id|ETHER_HEAD_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|np-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|length
op_minus
id|ETHER_HEAD_LEN
)paren
suffix:semicolon
multiline_comment|/* allocate room for the packet body */
id|skb_data_ptr
op_assign
id|skb_push
c_func
(paren
id|skb
comma
id|ETHER_HEAD_LEN
)paren
suffix:semicolon
multiline_comment|/* allocate room for the header */
macro_line|#ifdef ETHDEBUG
id|printk
c_func
(paren
l_string|&quot;head = 0x%x, data = 0x%x, tail = 0x%x, end = 0x%x&bslash;n&quot;
comma
id|skb-&gt;head
comma
id|skb-&gt;data
comma
id|skb-&gt;tail
comma
id|skb-&gt;end
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;copying packet to 0x%x.&bslash;n&quot;
comma
id|skb_data_ptr
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|skb_data_ptr
comma
id|phys_to_virt
c_func
(paren
id|myNextRxDesc-&gt;descr.buf
)paren
comma
id|length
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Large packet, send directly to upper layers and allocate new&n;&t;&t; * memory (aligned to cache line boundary to avoid bug).&n;&t;&t; * Before sending the skb to upper layers we must make sure that&n;&t;&t; * skb-&gt;data points to the aligned start of the packet.&n;&t;&t; */
r_int
id|align
suffix:semicolon
r_struct
id|sk_buff
op_star
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|MAX_MEDIA_DATA_SIZE
op_plus
l_int|2
op_star
id|L1_CACHE_BYTES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_skb
)paren
(brace
id|np-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb
op_assign
id|myNextRxDesc-&gt;skb
suffix:semicolon
id|align
op_assign
(paren
r_int
)paren
id|phys_to_virt
c_func
(paren
id|myNextRxDesc-&gt;descr.buf
)paren
op_minus
(paren
r_int
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|length
op_plus
id|align
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|align
)paren
suffix:semicolon
multiline_comment|/* Remove alignment bytes */
id|myNextRxDesc-&gt;skb
op_assign
id|new_skb
suffix:semicolon
id|myNextRxDesc-&gt;descr.buf
op_assign
id|L1_CACHE_ALIGN
c_func
(paren
id|virt_to_phys
c_func
(paren
id|myNextRxDesc-&gt;skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Send the packet to the upper layers */
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Prepare for next packet */
id|myNextRxDesc-&gt;descr.status
op_assign
l_int|0
suffix:semicolon
id|myPrevRxDesc
op_assign
id|myNextRxDesc
suffix:semicolon
id|myNextRxDesc
op_assign
id|phys_to_virt
c_func
(paren
id|myNextRxDesc-&gt;descr.next
)paren
suffix:semicolon
id|rx_queue_len
op_increment
suffix:semicolon
multiline_comment|/* Check if descriptors should be returned */
r_if
c_cond
(paren
id|rx_queue_len
op_eq
id|RX_QUEUE_THRESHOLD
)paren
(brace
id|flush_etrax_cache
c_func
(paren
)paren
suffix:semicolon
id|myPrevRxDesc-&gt;descr.ctrl
op_or_assign
id|d_eol
suffix:semicolon
id|myLastRxDesc-&gt;descr.ctrl
op_and_assign
op_complement
id|d_eol
suffix:semicolon
id|myLastRxDesc
op_assign
id|myPrevRxDesc
suffix:semicolon
id|rx_queue_len
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* The inverse routine to net_open(). */
r_static
r_int
DECL|function|e100_close
id|e100_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Closing %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK0_CLR
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_CLR
comma
id|overrun
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_CLR
comma
id|underrun
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK0_CLR
comma
id|excessive_col
comma
id|clr
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK2_CLR
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma0_descr
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma0_eop
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma1_descr
comma
id|clr
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_CLR
comma
id|dma1_eop
comma
id|clr
)paren
suffix:semicolon
multiline_comment|/* Stop the receiver and the transmitter */
id|RESET_DMA
c_func
(paren
id|NETWORK_TX_DMA_NBR
)paren
suffix:semicolon
id|RESET_DMA
c_func
(paren
id|NETWORK_RX_DMA_NBR
)paren
suffix:semicolon
multiline_comment|/* Flush the Tx and disable Rx here. */
id|free_irq
c_func
(paren
id|NETWORK_DMA_RX_IRQ_NBR
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|NETWORK_DMA_TX_IRQ_NBR
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|NETWORK_STATUS_IRQ_NBR
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Update the statistics here. */
id|update_rx_stats
c_func
(paren
op_amp
id|np-&gt;stats
)paren
suffix:semicolon
id|update_tx_stats
c_func
(paren
op_amp
id|np-&gt;stats
)paren
suffix:semicolon
multiline_comment|/* Stop speed/duplex timers */
id|del_timer
c_func
(paren
op_amp
id|speed_timer
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|duplex_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|e100_ioctl
id|e100_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|mii_ioctl_data
op_star
id|data
op_assign
id|if_mii
c_func
(paren
id|ifr
)paren
suffix:semicolon
r_struct
id|net_local
op_star
id|np
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Preempt protection */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
r_return
id|e100_ethtool_ioctl
c_func
(paren
id|dev
comma
id|ifr
)paren
suffix:semicolon
r_case
id|SIOCGMIIPHY
suffix:colon
multiline_comment|/* Get PHY address */
id|data-&gt;phy_id
op_assign
id|mdio_phy_addr
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGMIIREG
suffix:colon
multiline_comment|/* Read MII register */
id|data-&gt;val_out
op_assign
id|e100_get_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|data-&gt;reg_num
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMIIREG
suffix:colon
multiline_comment|/* Write MII register */
id|e100_set_mdio_reg
c_func
(paren
id|dev
comma
id|mdio_phy_addr
comma
id|data-&gt;reg_num
comma
id|data-&gt;val_in
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* The ioctls below should be considered obsolete but are */
multiline_comment|/* still present for compatability with old scripts/apps  */
r_case
id|SET_ETH_SPEED_10
suffix:colon
multiline_comment|/* 10 Mbps */
id|e100_set_speed
c_func
(paren
id|dev
comma
l_int|10
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_ETH_SPEED_100
suffix:colon
multiline_comment|/* 100 Mbps */
id|e100_set_speed
c_func
(paren
id|dev
comma
l_int|100
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_ETH_SPEED_AUTO
suffix:colon
multiline_comment|/* Auto negotiate speed */
id|e100_set_speed
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_ETH_DUPLEX_HALF
suffix:colon
multiline_comment|/* Half duplex. */
id|e100_set_duplex
c_func
(paren
id|dev
comma
id|half
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_ETH_DUPLEX_FULL
suffix:colon
multiline_comment|/* Full duplex. */
id|e100_set_duplex
c_func
(paren
id|dev
comma
id|full
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_ETH_DUPLEX_AUTO
suffix:colon
multiline_comment|/* Autonegotiate duplex*/
id|e100_set_duplex
c_func
(paren
id|dev
comma
id|autoneg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|e100_ethtool_ioctl
id|e100_ethtool_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
)paren
(brace
r_struct
id|ethtool_cmd
id|ecmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ecmd
comma
id|ifr-&gt;ifr_data
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|ecmd.cmd
)paren
(brace
r_case
id|ETHTOOL_GSET
suffix:colon
(brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ecmd
comma
l_int|0
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
suffix:semicolon
id|ecmd.supported
op_assign
id|SUPPORTED_Autoneg
op_or
id|SUPPORTED_TP
op_or
id|SUPPORTED_MII
op_or
id|SUPPORTED_10baseT_Half
op_or
id|SUPPORTED_10baseT_Full
op_or
id|SUPPORTED_100baseT_Half
op_or
id|SUPPORTED_100baseT_Full
suffix:semicolon
id|ecmd.port
op_assign
id|PORT_TP
suffix:semicolon
id|ecmd.transceiver
op_assign
id|XCVR_EXTERNAL
suffix:semicolon
id|ecmd.phy_address
op_assign
id|mdio_phy_addr
suffix:semicolon
id|ecmd.speed
op_assign
id|current_speed
suffix:semicolon
id|ecmd.duplex
op_assign
id|full_duplex
ques
c_cond
id|DUPLEX_FULL
suffix:colon
id|DUPLEX_HALF
suffix:semicolon
id|ecmd.advertising
op_assign
id|ADVERTISED_TP
suffix:semicolon
r_if
c_cond
(paren
id|current_duplex
op_eq
id|autoneg
op_logical_and
id|current_speed_selection
op_eq
l_int|0
)paren
id|ecmd.advertising
op_or_assign
id|ADVERTISED_Autoneg
suffix:semicolon
r_else
(brace
id|ecmd.advertising
op_or_assign
id|ADVERTISED_10baseT_Half
op_or
id|ADVERTISED_10baseT_Full
op_or
id|ADVERTISED_100baseT_Half
op_or
id|ADVERTISED_100baseT_Full
suffix:semicolon
r_if
c_cond
(paren
id|current_speed_selection
op_eq
l_int|10
)paren
id|ecmd.advertising
op_and_assign
op_complement
(paren
id|ADVERTISED_100baseT_Half
op_or
id|ADVERTISED_100baseT_Full
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|current_speed_selection
op_eq
l_int|100
)paren
id|ecmd.advertising
op_and_assign
op_complement
(paren
id|ADVERTISED_10baseT_Half
op_or
id|ADVERTISED_10baseT_Full
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_duplex
op_eq
id|half
)paren
id|ecmd.advertising
op_and_assign
op_complement
(paren
id|ADVERTISED_10baseT_Full
op_or
id|ADVERTISED_100baseT_Full
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|current_duplex
op_eq
id|full
)paren
id|ecmd.advertising
op_and_assign
op_complement
(paren
id|ADVERTISED_10baseT_Half
op_or
id|ADVERTISED_100baseT_Half
)paren
suffix:semicolon
)brace
id|ecmd.autoneg
op_assign
id|AUTONEG_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|ecmd
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ETHTOOL_SSET
suffix:colon
(brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ecmd.autoneg
op_eq
id|AUTONEG_ENABLE
)paren
(brace
id|e100_set_duplex
c_func
(paren
id|dev
comma
id|autoneg
)paren
suffix:semicolon
id|e100_set_speed
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|e100_set_duplex
c_func
(paren
id|dev
comma
id|ecmd.duplex
op_eq
id|DUPLEX_HALF
ques
c_cond
id|half
suffix:colon
id|full
)paren
suffix:semicolon
id|e100_set_speed
c_func
(paren
id|dev
comma
id|ecmd.speed
op_eq
id|SPEED_10
ques
c_cond
l_int|10
suffix:colon
l_int|100
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
r_struct
id|ethtool_drvinfo
id|info
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.driver
comma
l_string|&quot;ETRAX 100LX&quot;
comma
r_sizeof
(paren
id|info.driver
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.version
comma
l_string|&quot;$Revision: 1.31 $&quot;
comma
r_sizeof
(paren
id|info.version
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.fw_version
comma
l_string|&quot;N/A&quot;
comma
r_sizeof
(paren
id|info.fw_version
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.bus_info
comma
l_string|&quot;N/A&quot;
comma
r_sizeof
(paren
id|info.bus_info
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|info.regdump_len
op_assign
l_int|0
suffix:semicolon
id|info.eedump_len
op_assign
l_int|0
suffix:semicolon
id|info.testinfo_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ifr-&gt;ifr_data
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ETHTOOL_NWAY_RST
suffix:colon
r_if
c_cond
(paren
id|current_duplex
op_eq
id|autoneg
op_logical_and
id|current_speed_selection
op_eq
l_int|0
)paren
id|e100_negotiate
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|e100_set_config
id|e100_set_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_struct
id|net_local
op_star
id|np
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Preempt protection */
r_switch
c_cond
(paren
id|map-&gt;port
)paren
(brace
r_case
id|IF_PORT_UNKNOWN
suffix:colon
multiline_comment|/* Use autoneg */
id|e100_set_speed
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|e100_set_duplex
c_func
(paren
id|dev
comma
id|autoneg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_PORT_10BASET
suffix:colon
id|e100_set_speed
c_func
(paren
id|dev
comma
l_int|10
)paren
suffix:semicolon
id|e100_set_duplex
c_func
(paren
id|dev
comma
id|autoneg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_PORT_100BASET
suffix:colon
r_case
id|IF_PORT_100BASETX
suffix:colon
id|e100_set_speed
c_func
(paren
id|dev
comma
l_int|100
)paren
suffix:semicolon
id|e100_set_duplex
c_func
(paren
id|dev
comma
id|autoneg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IF_PORT_100BASEFX
suffix:colon
r_case
id|IF_PORT_10BASE2
suffix:colon
r_case
id|IF_PORT_AUI
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Invalid media selected&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|update_rx_stats
id|update_rx_stats
c_func
(paren
r_struct
id|net_device_stats
op_star
id|es
)paren
(brace
r_int
r_int
id|r
op_assign
op_star
id|R_REC_COUNTERS
suffix:semicolon
multiline_comment|/* update stats relevant to reception errors */
id|es-&gt;rx_fifo_errors
op_add_assign
id|IO_EXTRACT
c_func
(paren
id|R_REC_COUNTERS
comma
id|congestion
comma
id|r
)paren
suffix:semicolon
id|es-&gt;rx_crc_errors
op_add_assign
id|IO_EXTRACT
c_func
(paren
id|R_REC_COUNTERS
comma
id|crc_error
comma
id|r
)paren
suffix:semicolon
id|es-&gt;rx_frame_errors
op_add_assign
id|IO_EXTRACT
c_func
(paren
id|R_REC_COUNTERS
comma
id|alignment_error
comma
id|r
)paren
suffix:semicolon
id|es-&gt;rx_length_errors
op_add_assign
id|IO_EXTRACT
c_func
(paren
id|R_REC_COUNTERS
comma
id|oversize
comma
id|r
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|update_tx_stats
id|update_tx_stats
c_func
(paren
r_struct
id|net_device_stats
op_star
id|es
)paren
(brace
r_int
r_int
id|r
op_assign
op_star
id|R_TR_COUNTERS
suffix:semicolon
multiline_comment|/* update stats relevant to transmission errors */
id|es-&gt;collisions
op_add_assign
id|IO_EXTRACT
c_func
(paren
id|R_TR_COUNTERS
comma
id|single_col
comma
id|r
)paren
op_plus
id|IO_EXTRACT
c_func
(paren
id|R_TR_COUNTERS
comma
id|multiple_col
comma
id|r
)paren
suffix:semicolon
id|es-&gt;tx_errors
op_add_assign
id|IO_EXTRACT
c_func
(paren
id|R_TR_COUNTERS
comma
id|deferred
comma
id|r
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the current statistics.&n; * This may be called with the card open or closed.&n; */
r_static
r_struct
id|net_device_stats
op_star
DECL|function|e100_get_stats
id|e100_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|update_rx_stats
c_func
(paren
op_amp
id|lp-&gt;stats
)paren
suffix:semicolon
id|update_tx_stats
c_func
(paren
op_amp
id|lp-&gt;stats
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Set or clear the multicast filter for this adaptor.&n; * num_addrs == -1&t;Promiscuous mode, receive all packets&n; * num_addrs == 0&t;Normal mode, clear multicast list&n; * num_addrs &gt; 0&t;Multicast mode, receive normal and MC packets,&n; *&t;&t;&t;and do best-effort filtering.&n; */
r_static
r_void
DECL|function|set_multicast_list
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_local
op_star
id|lp
op_assign
(paren
r_struct
id|net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|num_addr
op_assign
id|dev-&gt;mc_count
suffix:semicolon
r_int
r_int
r_int
id|lo_bits
suffix:semicolon
r_int
r_int
r_int
id|hi_bits
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* promiscuous mode */
id|lo_bits
op_assign
l_int|0xfffffffful
suffix:semicolon
id|hi_bits
op_assign
l_int|0xfffffffful
suffix:semicolon
multiline_comment|/* Enable individual receive */
id|SETS
c_func
(paren
id|network_rec_config_shadow
comma
id|R_NETWORK_REC_CONFIG
comma
id|individual
comma
id|receive
)paren
suffix:semicolon
op_star
id|R_NETWORK_REC_CONFIG
op_assign
id|network_rec_config_shadow
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
multiline_comment|/* enable all multicasts */
id|lo_bits
op_assign
l_int|0xfffffffful
suffix:semicolon
id|hi_bits
op_assign
l_int|0xfffffffful
suffix:semicolon
multiline_comment|/* Disable individual receive */
id|SETS
c_func
(paren
id|network_rec_config_shadow
comma
id|R_NETWORK_REC_CONFIG
comma
id|individual
comma
id|discard
)paren
suffix:semicolon
op_star
id|R_NETWORK_REC_CONFIG
op_assign
id|network_rec_config_shadow
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|num_addr
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Normal, clear the mc list */
id|lo_bits
op_assign
l_int|0x00000000ul
suffix:semicolon
id|hi_bits
op_assign
l_int|0x00000000ul
suffix:semicolon
multiline_comment|/* Disable individual receive */
id|SETS
c_func
(paren
id|network_rec_config_shadow
comma
id|R_NETWORK_REC_CONFIG
comma
id|individual
comma
id|discard
)paren
suffix:semicolon
op_star
id|R_NETWORK_REC_CONFIG
op_assign
id|network_rec_config_shadow
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* MC mode, receive normal and MC packets */
r_char
id|hash_ix
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|baddr
suffix:semicolon
id|lo_bits
op_assign
l_int|0x00000000ul
suffix:semicolon
id|hi_bits
op_assign
l_int|0x00000000ul
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_addr
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Calculate the hash index for the GA registers */
id|hash_ix
op_assign
l_int|0
suffix:semicolon
id|baddr
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
op_star
id|baddr
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_rshift
l_int|6
)paren
op_amp
l_int|0x03
suffix:semicolon
op_increment
id|baddr
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_lshift
l_int|2
)paren
op_amp
l_int|0x03c
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
op_increment
id|baddr
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_lshift
l_int|4
)paren
op_amp
l_int|0x30
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_rshift
l_int|2
)paren
op_amp
l_int|0x3f
suffix:semicolon
op_increment
id|baddr
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
op_star
id|baddr
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_rshift
l_int|6
)paren
op_amp
l_int|0x03
suffix:semicolon
op_increment
id|baddr
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_lshift
l_int|2
)paren
op_amp
l_int|0x03c
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
op_increment
id|baddr
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_lshift
l_int|4
)paren
op_amp
l_int|0x30
suffix:semicolon
id|hash_ix
op_xor_assign
(paren
(paren
op_star
id|baddr
)paren
op_rshift
l_int|2
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|hash_ix
op_and_assign
l_int|0x3f
suffix:semicolon
r_if
c_cond
(paren
id|hash_ix
op_ge
l_int|32
)paren
(brace
id|hi_bits
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|hash_ix
op_minus
l_int|32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|lo_bits
op_or_assign
(paren
l_int|1
op_lshift
id|hash_ix
)paren
suffix:semicolon
)brace
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
multiline_comment|/* Disable individual receive */
id|SETS
c_func
(paren
id|network_rec_config_shadow
comma
id|R_NETWORK_REC_CONFIG
comma
id|individual
comma
id|discard
)paren
suffix:semicolon
op_star
id|R_NETWORK_REC_CONFIG
op_assign
id|network_rec_config_shadow
suffix:semicolon
)brace
op_star
id|R_NETWORK_GA_0
op_assign
id|lo_bits
suffix:semicolon
op_star
id|R_NETWORK_GA_1
op_assign
id|hi_bits
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
)brace
r_void
DECL|function|e100_hardware_send_packet
id|e100_hardware_send_packet
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|length
)paren
(brace
id|D
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;e100 send pack, buf 0x%x len %d&bslash;n&quot;
comma
id|buf
comma
id|length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|led_active
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|led_next_time
)paren
)paren
(brace
multiline_comment|/* light the network leds depending on the current speed. */
id|e100_set_network_leds
c_func
(paren
id|NETWORK_ACTIVITY
)paren
suffix:semicolon
multiline_comment|/* Set the earliest time we may clear the LED */
id|led_next_time
op_assign
id|jiffies
op_plus
id|NET_FLASH_TIME
suffix:semicolon
id|led_active
op_assign
l_int|1
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|clear_led_timer
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* configure the tx dma descriptor */
id|myNextTxDesc-&gt;descr.sw_len
op_assign
id|length
suffix:semicolon
id|myNextTxDesc-&gt;descr.ctrl
op_assign
id|d_eop
op_or
id|d_eol
op_or
id|d_wait
suffix:semicolon
id|myNextTxDesc-&gt;descr.buf
op_assign
id|virt_to_phys
c_func
(paren
id|buf
)paren
suffix:semicolon
multiline_comment|/* Move end of list */
id|myLastTxDesc-&gt;descr.ctrl
op_and_assign
op_complement
id|d_eol
suffix:semicolon
id|myLastTxDesc
op_assign
id|myNextTxDesc
suffix:semicolon
multiline_comment|/* Restart DMA channel */
op_star
id|R_DMA_CH0_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CMD
comma
id|cmd
comma
id|restart
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|e100_clear_network_leds
id|e100_clear_network_leds
c_func
(paren
r_int
r_int
id|dummy
)paren
(brace
r_if
c_cond
(paren
id|led_active
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|led_next_time
)paren
)paren
(brace
id|e100_set_network_leds
c_func
(paren
id|NO_NETWORK_ACTIVITY
)paren
suffix:semicolon
multiline_comment|/* Set the earliest time we may set the LED */
id|led_next_time
op_assign
id|jiffies
op_plus
id|NET_FLASH_PAUSE
suffix:semicolon
id|led_active
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|e100_set_network_leds
id|e100_set_network_leds
c_func
(paren
r_int
id|active
)paren
(brace
macro_line|#if defined(CONFIG_ETRAX_NETWORK_LED_ON_WHEN_LINK)
r_int
id|light_leds
op_assign
(paren
id|active
op_eq
id|NO_NETWORK_ACTIVITY
)paren
suffix:semicolon
macro_line|#elif defined(CONFIG_ETRAX_NETWORK_LED_ON_WHEN_ACTIVITY)
r_int
id|light_leds
op_assign
(paren
id|active
op_eq
id|NETWORK_ACTIVITY
)paren
suffix:semicolon
macro_line|#else
macro_line|#error &quot;Define either CONFIG_ETRAX_NETWORK_LED_ON_WHEN_LINK or CONFIG_ETRAX_NETWORK_LED_ON_WHEN_ACTIVITY&quot;
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|current_speed
)paren
(brace
multiline_comment|/* Make LED red, link is down */
macro_line|#if defined(CONFIG_ETRAX_NETWORK_RED_ON_NO_CONNECTION)
id|LED_NETWORK_SET
c_func
(paren
id|LED_RED
)paren
suffix:semicolon
macro_line|#else
id|LED_NETWORK_SET
c_func
(paren
id|LED_OFF
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|light_leds
)paren
(brace
r_if
c_cond
(paren
id|current_speed
op_eq
l_int|10
)paren
(brace
id|LED_NETWORK_SET
c_func
(paren
id|LED_ORANGE
)paren
suffix:semicolon
)brace
r_else
(brace
id|LED_NETWORK_SET
c_func
(paren
id|LED_GREEN
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|LED_NETWORK_SET
c_func
(paren
id|LED_OFF
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|etrax_init_module
id|etrax_init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|etrax_ethernet_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|e100_boot_setup
id|e100_boot_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_struct
id|sockaddr
id|sa
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Parse the colon separated Ethernet station address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|str
op_plus
l_int|3
op_star
id|i
comma
l_string|&quot;%2x&quot;
comma
op_amp
id|tmp
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Malformed station address&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sa.sa_data
(braket
id|i
)braket
op_assign
(paren
r_char
)paren
id|tmp
suffix:semicolon
)brace
id|default_mac
op_assign
id|sa
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;etrax100_eth=&quot;
comma
id|e100_boot_setup
)paren
suffix:semicolon
DECL|variable|etrax_init_module
id|module_init
c_func
(paren
id|etrax_init_module
)paren
suffix:semicolon
eof
