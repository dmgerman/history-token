multiline_comment|/** -*- linux-c -*- ***********************************************************&n; * Linux PPP over Ethernet (PPPoX/PPPoE) Sockets&n; *&n; * PPPoX --- Generic PPP encapsulation socket family&n; * PPPoE --- PPP over Ethernet (RFC 2516)&n; *&n; *&n; * Version:&t;0.7.0&n; *&n; * 220102 :&t;Fix module use count on failure in pppoe_create, pppox_sk -acme&n; * 030700 :&t;Fixed connect logic to allow for disconnect.&n; * 270700 :&t;Fixed potential SMP problems; we must protect against&n; *&t;&t;simultaneous invocation of ppp_input&n; *&t;&t;and ppp_unregister_channel.&n; * 040800 :&t;Respect reference count mechanisms on net-devices.&n; * 200800 :&t;fix kfree(skb) in pppoe_rcv (acme)&n; *&t;&t;Module reference count is decremented in the right spot now,&n; *&t;&t;guards against sock_put not actually freeing the sk&n; *&t;&t;in pppoe_release.&n; * 051000 :&t;Initialization cleanup.&n; * 111100 :&t;Fix recvmsg.&n; * 050101 :&t;Fix PADT procesing.&n; * 140501 :&t;Use pppoe_rcv_core to handle all backlog. (Alexey)&n; * 170701 :&t;Do not lock_sock with rwlock held. (DaveM)&n; *&t;&t;Ignore discovery frames if user has socket&n; *&t;&t;locked. (DaveM)&n; *&t;&t;Ignore return value of dev_queue_xmit in __pppoe_xmit&n; *&t;&t;or else we may kfree an SKB twice. (DaveM)&n; * 190701 :&t;When doing copies of skb&squot;s in __pppoe_xmit, always delete&n; *&t;&t;the original skb that was passed in on success, never on&n; *&t;&t;failure.  Delete the copy of the skb on failure to avoid&n; *&t;&t;a memory leak.&n; * 081001 :&t;Misc. cleanup (licence string, non-blocking, prevent&n; *&t;&t;reference of device on close).&n; * 121301 :&t;New ppp channels interface; cannot unregister a channel&n; *&t;&t;from interrupts.  Thus, we mark the socket as a ZOMBIE&n; *&t;&t;and do the unregistration later.&n; * 081002 :&t;seq_file support for proc stuff -acme&n; * 111602 :&t;Merge all 2.4 fixes into 2.5/2.6 tree.  Label 2.5/2.6&n; *&t;&t;as version 0.7.  Spacing cleanup.&n; * Author:&t;Michal Ostrowski &lt;mostrows@speakeasy.net&gt;&n; * Contributors:&n; * &t;&t;Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n; *&t;&t;David S. Miller (davem@redhat.com)&n; *&n; * License:&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/if_pppox.h&gt;
macro_line|#include &lt;linux/ppp_channel.h&gt;
macro_line|#include &lt;linux/ppp_defs.h&gt;
macro_line|#include &lt;linux/if_ppp.h&gt;
macro_line|#include &lt;linux/if_pppvar.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|PPPOE_HASH_BITS
mdefine_line|#define PPPOE_HASH_BITS 4
DECL|macro|PPPOE_HASH_SIZE
mdefine_line|#define PPPOE_HASH_SIZE (1&lt;&lt;PPPOE_HASH_BITS)
r_static
r_int
id|pppoe_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|pppoe_xmit
c_func
(paren
r_struct
id|ppp_channel
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|__pppoe_xmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
DECL|variable|pppoe_ops
r_static
r_struct
id|proto_ops
id|pppoe_ops
suffix:semicolon
DECL|variable|pppoe_hash_lock
r_static
id|rwlock_t
id|pppoe_hash_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|function|cmp_2_addr
r_static
r_inline
r_int
id|cmp_2_addr
c_func
(paren
r_struct
id|pppoe_addr
op_star
id|a
comma
r_struct
id|pppoe_addr
op_star
id|b
)paren
(brace
r_return
(paren
id|a-&gt;sid
op_eq
id|b-&gt;sid
op_logical_and
(paren
id|memcmp
c_func
(paren
id|a-&gt;remote
comma
id|b-&gt;remote
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|cmp_addr
r_static
r_inline
r_int
id|cmp_addr
c_func
(paren
r_struct
id|pppoe_addr
op_star
id|a
comma
r_int
r_int
id|sid
comma
r_char
op_star
id|addr
)paren
(brace
r_return
(paren
id|a-&gt;sid
op_eq
id|sid
op_logical_and
(paren
id|memcmp
c_func
(paren
id|a-&gt;remote
comma
id|addr
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|hash_item
r_static
r_int
id|hash_item
c_func
(paren
r_int
r_int
id|sid
comma
r_int
r_char
op_star
id|addr
)paren
(brace
r_char
id|hash
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
op_increment
id|i
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
op_div
id|PPPOE_HASH_BITS
suffix:semicolon
op_increment
id|j
)paren
(brace
id|hash
op_xor_assign
id|addr
(braket
id|i
)braket
op_rshift
(paren
id|j
op_star
id|PPPOE_HASH_BITS
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_star
l_int|8
)paren
op_div
id|PPPOE_HASH_BITS
suffix:semicolon
op_increment
id|i
)paren
id|hash
op_xor_assign
id|sid
op_rshift
(paren
id|i
op_star
id|PPPOE_HASH_BITS
)paren
suffix:semicolon
r_return
id|hash
op_amp
(paren
id|PPPOE_HASH_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* zeroed because its in .bss */
DECL|variable|item_hash_table
r_static
r_struct
id|pppox_opt
op_star
id|item_hash_table
(braket
id|PPPOE_HASH_SIZE
)braket
suffix:semicolon
multiline_comment|/**********************************************************************&n; *&n; *  Set/get/delete/rehash items  (internal versions)&n; *&n; **********************************************************************/
DECL|function|__get_item
r_static
r_struct
id|pppox_opt
op_star
id|__get_item
c_func
(paren
r_int
r_int
id|sid
comma
r_int
r_char
op_star
id|addr
)paren
(brace
r_int
id|hash
op_assign
id|hash_item
c_func
(paren
id|sid
comma
id|addr
)paren
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|ret
suffix:semicolon
id|ret
op_assign
id|item_hash_table
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|ret
op_logical_and
op_logical_neg
id|cmp_addr
c_func
(paren
op_amp
id|ret-&gt;pppoe_pa
comma
id|sid
comma
id|addr
)paren
)paren
id|ret
op_assign
id|ret-&gt;next
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__set_item
r_static
r_int
id|__set_item
c_func
(paren
r_struct
id|pppox_opt
op_star
id|po
)paren
(brace
r_int
id|hash
op_assign
id|hash_item
c_func
(paren
id|po-&gt;pppoe_pa.sid
comma
id|po-&gt;pppoe_pa.remote
)paren
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|ret
suffix:semicolon
id|ret
op_assign
id|item_hash_table
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|ret
)paren
(brace
r_if
c_cond
(paren
id|cmp_2_addr
c_func
(paren
op_amp
id|ret-&gt;pppoe_pa
comma
op_amp
id|po-&gt;pppoe_pa
)paren
)paren
r_return
op_minus
id|EALREADY
suffix:semicolon
id|ret
op_assign
id|ret-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|po-&gt;next
op_assign
id|item_hash_table
(braket
id|hash
)braket
suffix:semicolon
id|item_hash_table
(braket
id|hash
)braket
op_assign
id|po
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__delete_item
r_static
r_struct
id|pppox_opt
op_star
id|__delete_item
c_func
(paren
r_int
r_int
id|sid
comma
r_char
op_star
id|addr
)paren
(brace
r_int
id|hash
op_assign
id|hash_item
c_func
(paren
id|sid
comma
id|addr
)paren
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|ret
comma
op_star
op_star
id|src
suffix:semicolon
id|ret
op_assign
id|item_hash_table
(braket
id|hash
)braket
suffix:semicolon
id|src
op_assign
op_amp
id|item_hash_table
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|ret
)paren
(brace
r_if
c_cond
(paren
id|cmp_addr
c_func
(paren
op_amp
id|ret-&gt;pppoe_pa
comma
id|sid
comma
id|addr
)paren
)paren
(brace
op_star
id|src
op_assign
id|ret-&gt;next
suffix:semicolon
r_break
suffix:semicolon
)brace
id|src
op_assign
op_amp
id|ret-&gt;next
suffix:semicolon
id|ret
op_assign
id|ret-&gt;next
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; *  Set/get/delete/rehash items&n; *&n; **********************************************************************/
DECL|function|get_item
r_static
r_inline
r_struct
id|pppox_opt
op_star
id|get_item
c_func
(paren
r_int
r_int
id|sid
comma
r_int
r_char
op_star
id|addr
)paren
(brace
r_struct
id|pppox_opt
op_star
id|po
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
id|po
op_assign
id|__get_item
c_func
(paren
id|sid
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|po
)paren
id|sock_hold
c_func
(paren
id|po-&gt;sk
)paren
suffix:semicolon
id|read_unlock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
r_return
id|po
suffix:semicolon
)brace
DECL|function|get_item_by_addr
r_static
r_inline
r_struct
id|pppox_opt
op_star
id|get_item_by_addr
c_func
(paren
r_struct
id|sockaddr_pppox
op_star
id|sp
)paren
(brace
r_return
id|get_item
c_func
(paren
id|sp-&gt;sa_addr.pppoe.sid
comma
id|sp-&gt;sa_addr.pppoe.remote
)paren
suffix:semicolon
)brace
DECL|function|set_item
r_static
r_inline
r_int
id|set_item
c_func
(paren
r_struct
id|pppox_opt
op_star
id|po
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|po
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
id|i
op_assign
id|__set_item
c_func
(paren
id|po
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|delete_item
r_static
r_inline
r_struct
id|pppox_opt
op_star
id|delete_item
c_func
(paren
r_int
r_int
id|sid
comma
r_char
op_star
id|addr
)paren
(brace
r_struct
id|pppox_opt
op_star
id|ret
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
id|ret
op_assign
id|__delete_item
c_func
(paren
id|sid
comma
id|addr
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n; *&n; *  Handler for device events.&n; *  Certain device events require that sockets be unconnected.&n; *&n; **************************************************************************/
DECL|function|pppoe_flush_dev
r_static
r_void
id|pppoe_flush_dev
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|hash
suffix:semicolon
id|BUG_ON
c_func
(paren
id|dev
op_eq
l_int|NULL
)paren
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|hash
op_assign
l_int|0
suffix:semicolon
id|hash
OL
id|PPPOE_HASH_SIZE
suffix:semicolon
id|hash
op_increment
)paren
(brace
r_struct
id|pppox_opt
op_star
id|po
op_assign
id|item_hash_table
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|po
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|po-&gt;pppoe_dev
op_eq
id|dev
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|po-&gt;sk
suffix:semicolon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|po-&gt;pppoe_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* We hold a reference to SK, now drop the&n;&t;&t;&t;&t; * hash table lock so that we may attempt&n;&t;&t;&t;&t; * to lock the socket (which can sleep).&n;&t;&t;&t;&t; */
id|read_unlock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_amp
(paren
id|PPPOX_CONNECTED
op_or
id|PPPOX_BOUND
)paren
)paren
(brace
id|pppox_unbind_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|PPPOX_ZOMBIE
suffix:semicolon
id|sk
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
multiline_comment|/* Now restart from the beginning of this&n;&t;&t;&t;&t; * hash chain.  We always NULL out pppoe_dev&n;&t;&t;&t;&t; * so we are guaranteed to make forward&n;&t;&t;&t;&t; * progress.&n;&t;&t;&t;&t; */
id|po
op_assign
id|item_hash_table
(braket
id|hash
)braket
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|po
op_assign
id|po-&gt;next
suffix:semicolon
)brace
)brace
id|read_unlock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
)brace
DECL|function|pppoe_device_event
r_static
r_int
id|pppoe_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|ptr
suffix:semicolon
multiline_comment|/* Only look at sockets that are using this specific device. */
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|NETDEV_CHANGEMTU
suffix:colon
multiline_comment|/* A change in mtu is a bad thing, requiring&n;&t;&t; * LCP re-negotiation.&n;&t;&t; */
r_case
id|NETDEV_GOING_DOWN
suffix:colon
r_case
id|NETDEV_DOWN
suffix:colon
multiline_comment|/* Find every socket on this device and kill it. */
id|pppoe_flush_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|pppoe_notifier
r_static
r_struct
id|notifier_block
id|pppoe_notifier
op_assign
(brace
dot
id|notifier_call
op_assign
id|pppoe_device_event
comma
)brace
suffix:semicolon
multiline_comment|/************************************************************************&n; *&n; * Do the real work of receiving a PPPoE Session frame.&n; *&n; ***********************************************************************/
DECL|function|pppoe_rcv_core
r_static
r_int
id|pppoe_rcv_core
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|pppox_opt
op_star
id|po
op_assign
id|pppox_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|relay_po
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_BOUND
)paren
(brace
r_struct
id|pppoe_hdr
op_star
id|ph
op_assign
(paren
r_struct
id|pppoe_hdr
op_star
)paren
id|skb-&gt;nh.raw
suffix:semicolon
r_int
id|len
op_assign
id|ntohs
c_func
(paren
id|ph-&gt;length
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|ppp_input
c_func
(paren
op_amp
id|po-&gt;chan
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_RELAY
)paren
(brace
id|relay_po
op_assign
id|get_item_by_addr
c_func
(paren
op_amp
id|po-&gt;pppoe_relay
)paren
suffix:semicolon
r_if
c_cond
(paren
id|relay_po
op_eq
l_int|NULL
)paren
r_goto
id|abort_kfree
suffix:semicolon
r_if
c_cond
(paren
(paren
id|relay_po-&gt;sk-&gt;sk_state
op_amp
id|PPPOX_CONNECTED
)paren
op_eq
l_int|0
)paren
r_goto
id|abort_put
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|__pppoe_xmit
c_func
(paren
id|relay_po-&gt;sk
comma
id|skb
)paren
)paren
r_goto
id|abort_put
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sock_queue_rcv_skb
c_func
(paren
id|sk
comma
id|skb
)paren
)paren
r_goto
id|abort_kfree
suffix:semicolon
)brace
r_return
id|NET_RX_SUCCESS
suffix:semicolon
id|abort_put
suffix:colon
id|sock_put
c_func
(paren
id|relay_po-&gt;sk
)paren
suffix:semicolon
id|abort_kfree
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_RX_DROP
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; *&n; * Receive wrapper called in BH context.&n; *&n; ***********************************************************************/
DECL|function|pppoe_rcv
r_static
r_int
id|pppoe_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
(brace
r_struct
id|pppoe_hdr
op_star
id|ph
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|po
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pskb_may_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
)paren
r_goto
id|drop
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|skb_share_check
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ph
op_assign
(paren
r_struct
id|pppoe_hdr
op_star
)paren
id|skb-&gt;nh.raw
suffix:semicolon
id|po
op_assign
id|get_item
c_func
(paren
(paren
r_int
r_int
)paren
id|ph-&gt;sid
comma
id|skb-&gt;mac.ethernet-&gt;h_source
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|po
)paren
r_goto
id|drop
suffix:semicolon
id|sk
op_assign
id|po-&gt;sk
suffix:semicolon
id|bh_lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Socket state is unknown, must put skb into backlog. */
r_if
c_cond
(paren
id|sock_owned_by_user
c_func
(paren
id|sk
)paren
op_ne
l_int|0
)paren
(brace
id|sk_add_backlog
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|ret
op_assign
id|NET_RX_SUCCESS
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|pppoe_rcv_core
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
id|bh_unlock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
id|drop
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|NET_RX_DROP
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; *&n; * Receive a PPPoE Discovery frame.&n; * This is solely for detection of PADT frames&n; *&n; ***********************************************************************/
DECL|function|pppoe_disc_rcv
r_static
r_int
id|pppoe_disc_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
(brace
r_struct
id|pppoe_hdr
op_star
id|ph
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|po
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pskb_may_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
)paren
r_goto
m_abort
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|skb_share_check
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ph
op_assign
(paren
r_struct
id|pppoe_hdr
op_star
)paren
id|skb-&gt;nh.raw
suffix:semicolon
r_if
c_cond
(paren
id|ph-&gt;code
op_ne
id|PADT_CODE
)paren
r_goto
m_abort
suffix:semicolon
id|po
op_assign
id|get_item
c_func
(paren
(paren
r_int
r_int
)paren
id|ph-&gt;sid
comma
id|skb-&gt;mac.ethernet-&gt;h_source
)paren
suffix:semicolon
r_if
c_cond
(paren
id|po
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|po-&gt;sk
suffix:semicolon
id|bh_lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* If the user has locked the socket, just ignore&n;&t;&t; * the packet.  With the way two rcv protocols hook into&n;&t;&t; * one socket family type, we cannot (easily) distinguish&n;&t;&t; * what kind of SKB it is during backlog rcv.&n;&t;&t; */
r_if
c_cond
(paren
id|sock_owned_by_user
c_func
(paren
id|sk
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* We&squot;re no longer connect at the PPPOE layer,&n;&t;&t;&t; * and must wait for ppp channel to disconnect us.&n;&t;&t;&t; */
id|sk-&gt;sk_state
op_assign
id|PPPOX_ZOMBIE
suffix:semicolon
)brace
id|bh_unlock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
m_abort
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|NET_RX_SUCCESS
suffix:semicolon
multiline_comment|/* Lies... :-) */
)brace
DECL|variable|pppoes_ptype
r_static
r_struct
id|packet_type
id|pppoes_ptype
op_assign
(brace
dot
id|type
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_PPP_SES
)paren
comma
dot
id|func
op_assign
id|pppoe_rcv
comma
)brace
suffix:semicolon
DECL|variable|pppoed_ptype
r_static
r_struct
id|packet_type
id|pppoed_ptype
op_assign
(brace
dot
id|type
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_PPP_DISC
)paren
comma
dot
id|func
op_assign
id|pppoe_disc_rcv
comma
)brace
suffix:semicolon
multiline_comment|/***********************************************************************&n; *&n; * Really kill the socket. (Called from pppox_sk_free if refcnt == 0.)&n; *&n; **********************************************************************/
DECL|function|pppoe_sk_free
r_static
r_void
id|pppoe_sk_free
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|pppox_opt
op_star
id|po
op_assign
id|pppox_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|po
)paren
id|kfree
c_func
(paren
id|po
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; *&n; * Initialize a new struct sock.&n; *&n; **********************************************************************/
DECL|function|pppoe_create
r_static
r_int
id|pppoe_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_int
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|po
suffix:semicolon
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|PF_PPPOX
comma
id|GFP_KERNEL
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_goto
id|out
suffix:semicolon
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|sk_set_owner
c_func
(paren
id|sk
comma
id|THIS_MODULE
)paren
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|pppoe_ops
suffix:semicolon
id|sk-&gt;sk_backlog_rcv
op_assign
id|pppoe_rcv_core
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|PPPOX_NONE
suffix:semicolon
id|sk-&gt;sk_type
op_assign
id|SOCK_STREAM
suffix:semicolon
id|sk-&gt;sk_family
op_assign
id|PF_PPPOX
suffix:semicolon
id|sk-&gt;sk_protocol
op_assign
id|PX_PROTO_OE
suffix:semicolon
id|sk-&gt;sk_destruct
op_assign
id|pppoe_sk_free
suffix:semicolon
id|po
op_assign
id|pppox_sk
c_func
(paren
id|sk
)paren
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|po
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|po
)paren
r_goto
id|frees
suffix:semicolon
id|memset
c_func
(paren
id|po
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|po
)paren
)paren
suffix:semicolon
id|po-&gt;sk
op_assign
id|sk
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
id|frees
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|pppoe_release
r_static
r_int
id|pppoe_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|po
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sock_flag
c_func
(paren
id|sk
comma
id|SOCK_DEAD
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
id|pppox_unbind_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Signal the death of the socket. */
id|sk-&gt;sk_state
op_assign
id|PPPOX_DEAD
suffix:semicolon
id|po
op_assign
id|pppox_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|po-&gt;pppoe_pa.sid
)paren
(brace
id|delete_item
c_func
(paren
id|po-&gt;pppoe_pa.sid
comma
id|po-&gt;pppoe_pa.remote
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|po-&gt;pppoe_dev
)paren
id|dev_put
c_func
(paren
id|po-&gt;pppoe_dev
)paren
suffix:semicolon
id|po-&gt;pppoe_dev
op_assign
l_int|NULL
suffix:semicolon
id|sock_orphan
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|pppoe_connect
r_static
r_int
id|pppoe_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uservaddr
comma
r_int
id|sockaddr_len
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sockaddr_pppox
op_star
id|sp
op_assign
(paren
r_struct
id|sockaddr_pppox
op_star
)paren
id|uservaddr
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|po
op_assign
id|pppox_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_int
id|error
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;sa_protocol
op_ne
id|PX_PROTO_OE
)paren
r_goto
id|end
suffix:semicolon
multiline_comment|/* Check for already bound sockets */
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_CONNECTED
)paren
op_logical_and
id|sp-&gt;sa_addr.pppoe.sid
)paren
r_goto
id|end
suffix:semicolon
multiline_comment|/* Check for already disconnected sockets, on attempts to disconnect */
id|error
op_assign
op_minus
id|EALREADY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_DEAD
)paren
op_logical_and
op_logical_neg
id|sp-&gt;sa_addr.pppoe.sid
)paren
r_goto
id|end
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|po-&gt;pppoe_pa.sid
)paren
(brace
id|pppox_unbind_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Delete the old binding */
id|delete_item
c_func
(paren
id|po-&gt;pppoe_pa.sid
comma
id|po-&gt;pppoe_pa.remote
)paren
suffix:semicolon
r_if
c_cond
(paren
id|po-&gt;pppoe_dev
)paren
(brace
id|dev_put
c_func
(paren
id|po-&gt;pppoe_dev
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|po
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pppox_opt
)paren
)paren
suffix:semicolon
id|po-&gt;sk
op_assign
id|sk
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|PPPOX_NONE
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t re-bind if sid==0 */
r_if
c_cond
(paren
id|sp-&gt;sa_addr.pppoe.sid
op_ne
l_int|0
)paren
(brace
id|dev
op_assign
id|dev_get_by_name
c_func
(paren
id|sp-&gt;sa_addr.pppoe.dev
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|end
suffix:semicolon
id|po-&gt;pppoe_dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_goto
id|err_put
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|po-&gt;pppoe_pa
comma
op_amp
id|sp-&gt;sa_addr.pppoe
comma
r_sizeof
(paren
r_struct
id|pppoe_addr
)paren
)paren
suffix:semicolon
id|error
op_assign
id|set_item
c_func
(paren
id|po
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|err_put
suffix:semicolon
id|po-&gt;chan.hdrlen
op_assign
(paren
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
op_plus
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|po-&gt;chan
dot
r_private
op_assign
id|sk
suffix:semicolon
id|po-&gt;chan.ops
op_assign
op_amp
id|pppoe_chan_ops
suffix:semicolon
id|error
op_assign
id|ppp_register_channel
c_func
(paren
op_amp
id|po-&gt;chan
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|err_put
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|PPPOX_CONNECTED
suffix:semicolon
)brace
id|po-&gt;num
op_assign
id|sp-&gt;sa_addr.pppoe.sid
suffix:semicolon
id|end
suffix:colon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
id|err_put
suffix:colon
r_if
c_cond
(paren
id|po-&gt;pppoe_dev
)paren
(brace
id|dev_put
c_func
(paren
id|po-&gt;pppoe_dev
)paren
suffix:semicolon
id|po-&gt;pppoe_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
r_goto
id|end
suffix:semicolon
)brace
DECL|function|pppoe_getname
r_static
r_int
id|pppoe_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|usockaddr_len
comma
r_int
id|peer
)paren
(brace
r_int
id|len
op_assign
r_sizeof
(paren
r_struct
id|sockaddr_pppox
)paren
suffix:semicolon
r_struct
id|sockaddr_pppox
id|sp
suffix:semicolon
id|sp.sa_family
op_assign
id|AF_PPPOX
suffix:semicolon
id|sp.sa_protocol
op_assign
id|PX_PROTO_OE
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sp.sa_addr.pppoe
comma
op_amp
id|pppox_sk
c_func
(paren
id|sock-&gt;sk
)paren
op_member_access_from_pointer
id|pppoe_pa
comma
r_sizeof
(paren
r_struct
id|pppoe_addr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|uaddr
comma
op_amp
id|sp
comma
id|len
)paren
suffix:semicolon
op_star
id|usockaddr_len
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pppoe_ioctl
r_static
r_int
id|pppoe_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|po
op_assign
id|pppox_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|PPPIOCGMRU
suffix:colon
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_CONNECTED
)paren
)paren
r_break
suffix:semicolon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|po-&gt;pppoe_dev-&gt;mtu
op_minus
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
op_minus
id|PPP_HDRLEN
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_break
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCSMRU
suffix:colon
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_CONNECTED
)paren
)paren
r_break
suffix:semicolon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
(paren
id|po-&gt;pppoe_dev-&gt;mtu
op_minus
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
op_minus
id|PPP_HDRLEN
)paren
)paren
id|err
op_assign
l_int|0
suffix:semicolon
r_else
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCSFLAGS
suffix:colon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_break
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPOEIOCSFWD
suffix:colon
(brace
r_struct
id|pppox_opt
op_star
id|relay_po
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_amp
(paren
id|PPPOX_BOUND
op_or
id|PPPOX_ZOMBIE
op_or
id|PPPOX_DEAD
)paren
)paren
r_break
suffix:semicolon
id|err
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_CONNECTED
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* PPPoE address from the user specifies an outbound&n;&t;&t;   PPPoE address to which frames are forwarded to */
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|po-&gt;pppoe_relay
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|sockaddr_pppox
)paren
)paren
)paren
r_break
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|po-&gt;pppoe_relay.sa_family
op_ne
id|AF_PPPOX
op_logical_or
id|po-&gt;pppoe_relay.sa_protocol
op_ne
id|PX_PROTO_OE
)paren
r_break
suffix:semicolon
multiline_comment|/* Check that the socket referenced by the address&n;&t;&t;   actually exists. */
id|relay_po
op_assign
id|get_item_by_addr
c_func
(paren
op_amp
id|po-&gt;pppoe_relay
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|relay_po
)paren
r_break
suffix:semicolon
id|sock_put
c_func
(paren
id|relay_po-&gt;sk
)paren
suffix:semicolon
id|sk-&gt;sk_state
op_or_assign
id|PPPOX_RELAY
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|PPPOEIOCDFWD
suffix:colon
id|err
op_assign
op_minus
id|EALREADY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_RELAY
)paren
)paren
r_break
suffix:semicolon
id|sk-&gt;sk_state
op_and_assign
op_complement
id|PPPOX_RELAY
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|pppoe_sendmsg
r_static
r_int
id|pppoe_sendmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|iocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|m
comma
r_int
id|total_len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|pppox_opt
op_star
id|po
op_assign
id|pppox_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|pppoe_hdr
id|hdr
suffix:semicolon
r_struct
id|pppoe_hdr
op_star
id|ph
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_char
op_star
id|start
suffix:semicolon
r_if
c_cond
(paren
id|sock_flag
c_func
(paren
id|sk
comma
id|SOCK_DEAD
)paren
op_logical_or
op_logical_neg
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_CONNECTED
)paren
)paren
(brace
id|error
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|hdr.ver
op_assign
l_int|1
suffix:semicolon
id|hdr.type
op_assign
l_int|1
suffix:semicolon
id|hdr.code
op_assign
l_int|0
suffix:semicolon
id|hdr.sid
op_assign
id|po-&gt;num
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|dev
op_assign
id|po-&gt;pppoe_dev
suffix:semicolon
id|error
op_assign
op_minus
id|EMSGSIZE
suffix:semicolon
r_if
c_cond
(paren
id|total_len
OG
(paren
id|dev-&gt;mtu
op_plus
id|dev-&gt;hard_header_len
)paren
)paren
r_goto
id|end
suffix:semicolon
id|skb
op_assign
id|sock_wmalloc
c_func
(paren
id|sk
comma
id|total_len
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|32
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
multiline_comment|/* Reserve space for headers. */
id|skb_reserve
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;priority
op_assign
id|sk-&gt;sk_priority
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_PPP_SES
)paren
suffix:semicolon
id|ph
op_assign
(paren
r_struct
id|pppoe_hdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|total_len
op_plus
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
suffix:semicolon
id|start
op_assign
(paren
r_char
op_star
)paren
op_amp
id|ph-&gt;tag
(braket
l_int|0
)braket
suffix:semicolon
id|error
op_assign
id|memcpy_fromiovec
c_func
(paren
id|start
comma
id|m-&gt;msg_iov
comma
id|total_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|error
op_assign
id|total_len
suffix:semicolon
id|dev
op_member_access_from_pointer
id|hard_header
c_func
(paren
id|skb
comma
id|dev
comma
id|ETH_P_PPP_SES
comma
id|po-&gt;pppoe_pa.remote
comma
l_int|NULL
comma
id|total_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ph
comma
op_amp
id|hdr
comma
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
suffix:semicolon
id|ph-&gt;length
op_assign
id|htons
c_func
(paren
id|total_len
)paren
suffix:semicolon
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
id|end
suffix:colon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; *&n; * xmit function for internal use.&n; *&n; ***********************************************************************/
DECL|function|__pppoe_xmit
r_static
r_int
id|__pppoe_xmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|pppox_opt
op_star
id|po
op_assign
id|pppox_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|po-&gt;pppoe_dev
suffix:semicolon
r_struct
id|pppoe_hdr
id|hdr
suffix:semicolon
r_struct
id|pppoe_hdr
op_star
id|ph
suffix:semicolon
r_int
id|headroom
op_assign
id|skb_headroom
c_func
(paren
id|skb
)paren
suffix:semicolon
r_int
id|data_len
op_assign
id|skb-&gt;len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_if
c_cond
(paren
id|sock_flag
c_func
(paren
id|sk
comma
id|SOCK_DEAD
)paren
op_logical_or
op_logical_neg
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_CONNECTED
)paren
)paren
r_goto
m_abort
suffix:semicolon
id|hdr.ver
op_assign
l_int|1
suffix:semicolon
id|hdr.type
op_assign
l_int|1
suffix:semicolon
id|hdr.code
op_assign
l_int|0
suffix:semicolon
id|hdr.sid
op_assign
id|po-&gt;num
suffix:semicolon
id|hdr.length
op_assign
id|htons
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
m_abort
suffix:semicolon
multiline_comment|/* Copy the skb if there is no space for the header. */
r_if
c_cond
(paren
id|headroom
OL
(paren
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
op_plus
id|dev-&gt;hard_header_len
)paren
)paren
(brace
id|skb2
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|32
op_plus
id|skb-&gt;len
op_plus
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
op_plus
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
r_goto
m_abort
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb2
comma
id|dev-&gt;hard_header_len
op_plus
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb2
comma
id|skb-&gt;len
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Make a clone so as to not disturb the original skb,&n;&t;&t; * give dev_queue_xmit something it can free.&n;&t;&t; */
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
id|ph
op_assign
(paren
r_struct
id|pppoe_hdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb2
comma
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ph
comma
op_amp
id|hdr
comma
r_sizeof
(paren
r_struct
id|pppoe_hdr
)paren
)paren
suffix:semicolon
id|skb2-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_PPP_SES
)paren
suffix:semicolon
id|skb2-&gt;nh.raw
op_assign
id|skb2-&gt;data
suffix:semicolon
id|skb2-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev
op_member_access_from_pointer
id|hard_header
c_func
(paren
id|skb2
comma
id|dev
comma
id|ETH_P_PPP_SES
comma
id|po-&gt;pppoe_pa.remote
comma
l_int|NULL
comma
id|data_len
)paren
suffix:semicolon
multiline_comment|/* We&squot;re transmitting skb2, and assuming that dev_queue_xmit&n;&t; * will free it.  The generic ppp layer however, is expecting&n;&t; * that we give back &squot;skb&squot; (not &squot;skb2&squot;) in case of failure,&n;&t; * but free it in case of success.&n;&t; */
r_if
c_cond
(paren
id|dev_queue_xmit
c_func
(paren
id|skb2
)paren
OL
l_int|0
)paren
r_goto
m_abort
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
m_abort
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; *&n; * xmit function called by generic PPP driver&n; * sends PPP frame over PPPoE socket&n; *&n; ***********************************************************************/
DECL|function|pppoe_xmit
r_static
r_int
id|pppoe_xmit
c_func
(paren
r_struct
id|ppp_channel
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|chan
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|__pppoe_xmit
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|variable|pppoe_chan_ops
r_static
r_struct
id|ppp_channel_ops
id|pppoe_chan_ops
op_assign
(brace
dot
id|start_xmit
op_assign
id|pppoe_xmit
comma
)brace
suffix:semicolon
DECL|function|pppoe_recvmsg
r_static
r_int
id|pppoe_recvmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|iocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|m
comma
r_int
id|total_len
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|pppoe_hdr
op_star
id|ph
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_amp
id|PPPOX_BOUND
)paren
(brace
id|error
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
op_amp
op_complement
id|MSG_DONTWAIT
comma
id|flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|error
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
id|m-&gt;msg_namelen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|error
op_assign
l_int|0
suffix:semicolon
id|ph
op_assign
(paren
r_struct
id|pppoe_hdr
op_star
)paren
id|skb-&gt;nh.raw
suffix:semicolon
id|len
op_assign
id|ntohs
c_func
(paren
id|ph-&gt;length
)paren
suffix:semicolon
id|error
op_assign
id|memcpy_toiovec
c_func
(paren
id|m-&gt;msg_iov
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|ph-&gt;tag
(braket
l_int|0
)braket
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|do_skb_free
suffix:semicolon
id|error
op_assign
id|len
suffix:semicolon
)brace
id|do_skb_free
suffix:colon
r_if
c_cond
(paren
id|skb
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|end
suffix:colon
r_return
id|error
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|pppoe_seq_show
r_static
r_int
id|pppoe_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
r_struct
id|pppox_opt
op_star
id|po
suffix:semicolon
r_char
op_star
id|dev_name
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
id|SEQ_START_TOKEN
)paren
(brace
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;Id       Address              Device&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|po
op_assign
id|v
suffix:semicolon
id|dev_name
op_assign
id|po-&gt;pppoe_pa.dev
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;%08X %02X:%02X:%02X:%02X:%02X:%02X %8s&bslash;n&quot;
comma
id|po-&gt;pppoe_pa.sid
comma
id|po-&gt;pppoe_pa.remote
(braket
l_int|0
)braket
comma
id|po-&gt;pppoe_pa.remote
(braket
l_int|1
)braket
comma
id|po-&gt;pppoe_pa.remote
(braket
l_int|2
)braket
comma
id|po-&gt;pppoe_pa.remote
(braket
l_int|3
)braket
comma
id|po-&gt;pppoe_pa.remote
(braket
l_int|4
)braket
comma
id|po-&gt;pppoe_pa.remote
(braket
l_int|5
)braket
comma
id|dev_name
)paren
suffix:semicolon
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pppoe_get_idx
r_static
id|__inline__
r_struct
id|pppox_opt
op_star
id|pppoe_get_idx
c_func
(paren
id|loff_t
id|pos
)paren
(brace
r_struct
id|pppox_opt
op_star
id|po
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|PPPOE_HASH_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|po
op_assign
id|item_hash_table
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|po
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pos
op_decrement
)paren
r_goto
id|out
suffix:semicolon
id|po
op_assign
id|po-&gt;next
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|po
suffix:semicolon
)brace
DECL|function|pppoe_seq_start
r_static
r_void
op_star
id|pppoe_seq_start
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|loff_t
id|l
op_assign
op_star
id|pos
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
r_return
id|l
ques
c_cond
id|pppoe_get_idx
c_func
(paren
op_decrement
id|l
)paren
suffix:colon
id|SEQ_START_TOKEN
suffix:semicolon
)brace
DECL|function|pppoe_seq_next
r_static
r_void
op_star
id|pppoe_seq_next
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|pppox_opt
op_star
id|po
suffix:semicolon
op_increment
op_star
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
id|SEQ_START_TOKEN
)paren
(brace
id|po
op_assign
id|pppoe_get_idx
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|po
op_assign
id|v
suffix:semicolon
r_if
c_cond
(paren
id|po-&gt;next
)paren
id|po
op_assign
id|po-&gt;next
suffix:semicolon
r_else
(brace
r_int
id|hash
op_assign
id|hash_item
c_func
(paren
id|po-&gt;pppoe_pa.sid
comma
id|po-&gt;pppoe_pa.remote
)paren
suffix:semicolon
r_while
c_loop
(paren
op_increment
id|hash
OL
id|PPPOE_HASH_SIZE
)paren
(brace
id|po
op_assign
id|item_hash_table
(braket
id|hash
)braket
suffix:semicolon
r_if
c_cond
(paren
id|po
)paren
r_break
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|po
suffix:semicolon
)brace
DECL|function|pppoe_seq_stop
r_static
r_void
id|pppoe_seq_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
id|read_unlock_bh
c_func
(paren
op_amp
id|pppoe_hash_lock
)paren
suffix:semicolon
)brace
DECL|variable|pppoe_seq_ops
r_struct
id|seq_operations
id|pppoe_seq_ops
op_assign
(brace
dot
id|start
op_assign
id|pppoe_seq_start
comma
dot
id|next
op_assign
id|pppoe_seq_next
comma
dot
id|stop
op_assign
id|pppoe_seq_stop
comma
dot
id|show
op_assign
id|pppoe_seq_show
comma
)brace
suffix:semicolon
DECL|function|pppoe_seq_open
r_static
r_int
id|pppoe_seq_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|pppoe_seq_ops
)paren
suffix:semicolon
)brace
DECL|variable|pppoe_seq_fops
r_static
r_struct
id|file_operations
id|pppoe_seq_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|pppoe_seq_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PROC_FS */
multiline_comment|/* -&gt;ioctl are set at pppox_create */
DECL|variable|pppoe_ops
r_static
r_struct
id|proto_ops
id|pppoe_ops
op_assign
(brace
dot
id|family
op_assign
id|AF_PPPOX
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|release
op_assign
id|pppoe_release
comma
dot
id|bind
op_assign
id|sock_no_bind
comma
dot
id|connect
op_assign
id|pppoe_connect
comma
dot
id|socketpair
op_assign
id|sock_no_socketpair
comma
dot
id|accept
op_assign
id|sock_no_accept
comma
dot
id|getname
op_assign
id|pppoe_getname
comma
dot
id|poll
op_assign
id|datagram_poll
comma
dot
id|listen
op_assign
id|sock_no_listen
comma
dot
id|shutdown
op_assign
id|sock_no_shutdown
comma
dot
id|setsockopt
op_assign
id|sock_no_setsockopt
comma
dot
id|getsockopt
op_assign
id|sock_no_getsockopt
comma
dot
id|sendmsg
op_assign
id|pppoe_sendmsg
comma
dot
id|recvmsg
op_assign
id|pppoe_recvmsg
comma
dot
id|mmap
op_assign
id|sock_no_mmap
)brace
suffix:semicolon
DECL|variable|pppoe_proto
r_static
r_struct
id|pppox_proto
id|pppoe_proto
op_assign
(brace
dot
id|create
op_assign
id|pppoe_create
comma
dot
id|ioctl
op_assign
id|pppoe_ioctl
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|function|pppoe_init
r_static
r_int
id|__init
id|pppoe_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
op_assign
id|register_pppox_proto
c_func
(paren
id|PX_PROTO_OE
comma
op_amp
id|pppoe_proto
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
(brace
r_struct
id|proc_dir_entry
op_star
id|p
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;pppoe&quot;
comma
id|S_IRUGO
comma
id|proc_net
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_goto
id|out_unregister
suffix:semicolon
id|p-&gt;proc_fops
op_assign
op_amp
id|pppoe_seq_fops
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS */
id|dev_add_pack
c_func
(paren
op_amp
id|pppoes_ptype
)paren
suffix:semicolon
id|dev_add_pack
c_func
(paren
op_amp
id|pppoed_ptype
)paren
suffix:semicolon
id|register_netdevice_notifier
c_func
(paren
op_amp
id|pppoe_notifier
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
id|out_unregister
suffix:colon
id|unregister_pppox_proto
c_func
(paren
id|PX_PROTO_OE
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|pppoe_exit
r_static
r_void
id|__exit
id|pppoe_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_pppox_proto
c_func
(paren
id|PX_PROTO_OE
)paren
suffix:semicolon
id|dev_remove_pack
c_func
(paren
op_amp
id|pppoes_ptype
)paren
suffix:semicolon
id|dev_remove_pack
c_func
(paren
op_amp
id|pppoed_ptype
)paren
suffix:semicolon
id|unregister_netdevice_notifier
c_func
(paren
op_amp
id|pppoe_notifier
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|remove_proc_entry
c_func
(paren
l_string|&quot;pppoe&quot;
comma
id|proc_net
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|pppoe_init
id|module_init
c_func
(paren
id|pppoe_init
)paren
suffix:semicolon
DECL|variable|pppoe_exit
id|module_exit
c_func
(paren
id|pppoe_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Michal Ostrowski &lt;mostrows@speakeasy.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PPP over Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|PF_PPPOX
id|MODULE_ALIAS_NETPROTO
c_func
(paren
id|PF_PPPOX
)paren
suffix:semicolon
eof
