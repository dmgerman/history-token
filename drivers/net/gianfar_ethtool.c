multiline_comment|/*&n; *  drivers/net/gianfar_ethtool.c&n; *&n; *  Gianfar Ethernet Driver&n; *  Ethtool support for Gianfar Enet&n; *  Based on e1000 ethtool support&n; *&n; *  Author: Andy Fleming&n; *  Maintainer: Kumar Gala (kumar.gala@freescale.com)&n; *&n; *  Copyright (c) 2003,2004 Freescale Semiconductor, Inc.&n; *&n; *  This software may be used and distributed according to &n; *  the terms of the GNU Public License, Version 2, incorporated herein &n; *  by reference.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &quot;gianfar.h&quot;
DECL|macro|is_power_of_2
mdefine_line|#define is_power_of_2(x)        ((x) != 0 &amp;&amp; (((x) &amp; ((x) - 1)) == 0))
r_extern
r_int
id|startup_gfar
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_extern
r_void
id|stop_gfar
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_extern
r_void
id|gfar_receive
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_void
id|gfar_fill_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_stats
op_star
id|dummy
comma
id|u64
op_star
id|buf
)paren
suffix:semicolon
r_void
id|gfar_gstrings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|stringset
comma
id|u8
op_star
id|buf
)paren
suffix:semicolon
r_int
id|gfar_gcoalesce
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_coalesce
op_star
id|cvals
)paren
suffix:semicolon
r_int
id|gfar_scoalesce
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_coalesce
op_star
id|cvals
)paren
suffix:semicolon
r_void
id|gfar_gringparam
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_ringparam
op_star
id|rvals
)paren
suffix:semicolon
r_int
id|gfar_sringparam
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_ringparam
op_star
id|rvals
)paren
suffix:semicolon
r_void
id|gfar_gdrvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|drvinfo
)paren
suffix:semicolon
DECL|variable|stat_gstrings
r_static
r_char
id|stat_gstrings
(braket
)braket
(braket
id|ETH_GSTRING_LEN
)braket
op_assign
(brace
l_string|&quot;rx-dropped-by-kernel&quot;
comma
l_string|&quot;rx-large-frame-errors&quot;
comma
l_string|&quot;rx-short-frame-errors&quot;
comma
l_string|&quot;rx-non-octet-errors&quot;
comma
l_string|&quot;rx-crc-errors&quot;
comma
l_string|&quot;rx-overrun-errors&quot;
comma
l_string|&quot;rx-busy-errors&quot;
comma
l_string|&quot;rx-babbling-errors&quot;
comma
l_string|&quot;rx-truncated-frames&quot;
comma
l_string|&quot;ethernet-bus-error&quot;
comma
l_string|&quot;tx-babbling-errors&quot;
comma
l_string|&quot;tx-underrun-errors&quot;
comma
l_string|&quot;rx-skb-missing-errors&quot;
comma
l_string|&quot;tx-timeout-errors&quot;
comma
l_string|&quot;tx-rx-64-frames&quot;
comma
l_string|&quot;tx-rx-65-127-frames&quot;
comma
l_string|&quot;tx-rx-128-255-frames&quot;
comma
l_string|&quot;tx-rx-256-511-frames&quot;
comma
l_string|&quot;tx-rx-512-1023-frames&quot;
comma
l_string|&quot;tx-rx-1024-1518-frames&quot;
comma
l_string|&quot;tx-rx-1519-1522-good-vlan&quot;
comma
l_string|&quot;rx-bytes&quot;
comma
l_string|&quot;rx-packets&quot;
comma
l_string|&quot;rx-fcs-errors&quot;
comma
l_string|&quot;receive-multicast-packet&quot;
comma
l_string|&quot;receive-broadcast-packet&quot;
comma
l_string|&quot;rx-control-frame-packets&quot;
comma
l_string|&quot;rx-pause-frame-packets&quot;
comma
l_string|&quot;rx-unknown-op-code&quot;
comma
l_string|&quot;rx-alignment-error&quot;
comma
l_string|&quot;rx-frame-length-error&quot;
comma
l_string|&quot;rx-code-error&quot;
comma
l_string|&quot;rx-carrier-sense-error&quot;
comma
l_string|&quot;rx-undersize-packets&quot;
comma
l_string|&quot;rx-oversize-packets&quot;
comma
l_string|&quot;rx-fragmented-frames&quot;
comma
l_string|&quot;rx-jabber-frames&quot;
comma
l_string|&quot;rx-dropped-frames&quot;
comma
l_string|&quot;tx-byte-counter&quot;
comma
l_string|&quot;tx-packets&quot;
comma
l_string|&quot;tx-multicast-packets&quot;
comma
l_string|&quot;tx-broadcast-packets&quot;
comma
l_string|&quot;tx-pause-control-frames&quot;
comma
l_string|&quot;tx-deferral-packets&quot;
comma
l_string|&quot;tx-excessive-deferral-packets&quot;
comma
l_string|&quot;tx-single-collision-packets&quot;
comma
l_string|&quot;tx-multiple-collision-packets&quot;
comma
l_string|&quot;tx-late-collision-packets&quot;
comma
l_string|&quot;tx-excessive-collision-packets&quot;
comma
l_string|&quot;tx-total-collision&quot;
comma
l_string|&quot;reserved&quot;
comma
l_string|&quot;tx-dropped-frames&quot;
comma
l_string|&quot;tx-jabber-frames&quot;
comma
l_string|&quot;tx-fcs-errors&quot;
comma
l_string|&quot;tx-control-frames&quot;
comma
l_string|&quot;tx-oversize-frames&quot;
comma
l_string|&quot;tx-undersize-frames&quot;
comma
l_string|&quot;tx-fragmented-frames&quot;
comma
)brace
suffix:semicolon
multiline_comment|/* Fill in an array of 64-bit statistics from various sources.&n; * This array will be appended to the end of the ethtool_stats&n; * structure, and returned to user space&n; */
DECL|function|gfar_fill_stats
r_void
id|gfar_fill_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_stats
op_star
id|dummy
comma
id|u64
op_star
id|buf
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|gfar_private
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|u32
op_star
id|rmon
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|priv-&gt;regs-&gt;rmon
suffix:semicolon
id|u64
op_star
id|extra
op_assign
(paren
id|u64
op_star
)paren
op_amp
id|priv-&gt;extra_stats
suffix:semicolon
r_struct
id|gfar_stats
op_star
id|stats
op_assign
(paren
r_struct
id|gfar_stats
op_star
)paren
id|buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|GFAR_RMON_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stats-&gt;rmon
(braket
id|i
)braket
op_assign
(paren
id|u64
)paren
(paren
id|rmon
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|GFAR_EXTRA_STATS_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stats-&gt;extra
(braket
id|i
)braket
op_assign
id|extra
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/* Returns the number of stats (and their corresponding strings) */
DECL|function|gfar_stats_count
r_int
id|gfar_stats_count
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|GFAR_STATS_LEN
suffix:semicolon
)brace
DECL|function|gfar_gstrings_normon
r_void
id|gfar_gstrings_normon
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|stringset
comma
id|u8
op_star
id|buf
)paren
(brace
id|memcpy
c_func
(paren
id|buf
comma
id|stat_gstrings
comma
id|GFAR_EXTRA_STATS_LEN
op_star
id|ETH_GSTRING_LEN
)paren
suffix:semicolon
)brace
DECL|function|gfar_fill_stats_normon
r_void
id|gfar_fill_stats_normon
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_stats
op_star
id|dummy
comma
id|u64
op_star
id|buf
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|gfar_private
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|u64
op_star
id|extra
op_assign
(paren
id|u64
op_star
)paren
op_amp
id|priv-&gt;extra_stats
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|GFAR_EXTRA_STATS_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
(braket
id|i
)braket
op_assign
id|extra
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
DECL|function|gfar_stats_count_normon
r_int
id|gfar_stats_count_normon
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|GFAR_EXTRA_STATS_LEN
suffix:semicolon
)brace
multiline_comment|/* Fills in the drvinfo structure with some basic info */
DECL|function|gfar_gdrvinfo
r_void
id|gfar_gdrvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|drvinfo
)paren
(brace
id|strncpy
c_func
(paren
id|drvinfo-&gt;driver
comma
id|DRV_NAME
comma
id|GFAR_INFOSTR_LEN
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|drvinfo-&gt;version
comma
id|gfar_driver_version
comma
id|GFAR_INFOSTR_LEN
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|drvinfo-&gt;fw_version
comma
l_string|&quot;N/A&quot;
comma
id|GFAR_INFOSTR_LEN
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|drvinfo-&gt;bus_info
comma
l_string|&quot;N/A&quot;
comma
id|GFAR_INFOSTR_LEN
)paren
suffix:semicolon
id|drvinfo-&gt;n_stats
op_assign
id|GFAR_STATS_LEN
suffix:semicolon
id|drvinfo-&gt;testinfo_len
op_assign
l_int|0
suffix:semicolon
id|drvinfo-&gt;regdump_len
op_assign
l_int|0
suffix:semicolon
id|drvinfo-&gt;eedump_len
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Return the current settings in the ethtool_cmd structure */
DECL|function|gfar_gsettings
r_int
id|gfar_gsettings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|uint
id|gigabit_support
op_assign
id|priv-&gt;einfo-&gt;device_flags
op_amp
id|FSL_GIANFAR_DEV_HAS_GIGABIT
ques
c_cond
id|SUPPORTED_1000baseT_Full
suffix:colon
l_int|0
suffix:semicolon
id|uint
id|gigabit_advert
op_assign
id|priv-&gt;einfo-&gt;device_flags
op_amp
id|FSL_GIANFAR_DEV_HAS_GIGABIT
ques
c_cond
id|ADVERTISED_1000baseT_Full
suffix:colon
l_int|0
suffix:semicolon
id|cmd-&gt;supported
op_assign
(paren
id|SUPPORTED_10baseT_Half
op_or
id|SUPPORTED_100baseT_Half
op_or
id|SUPPORTED_100baseT_Full
op_or
id|gigabit_support
op_or
id|SUPPORTED_Autoneg
)paren
suffix:semicolon
multiline_comment|/* For now, we always advertise everything */
id|cmd-&gt;advertising
op_assign
(paren
id|ADVERTISED_10baseT_Half
op_or
id|ADVERTISED_100baseT_Half
op_or
id|ADVERTISED_100baseT_Full
op_or
id|gigabit_advert
op_or
id|ADVERTISED_Autoneg
)paren
suffix:semicolon
id|cmd-&gt;speed
op_assign
id|priv-&gt;mii_info-&gt;speed
suffix:semicolon
id|cmd-&gt;duplex
op_assign
id|priv-&gt;mii_info-&gt;duplex
suffix:semicolon
id|cmd-&gt;port
op_assign
id|PORT_MII
suffix:semicolon
id|cmd-&gt;phy_address
op_assign
id|priv-&gt;mii_info-&gt;mii_id
suffix:semicolon
id|cmd-&gt;transceiver
op_assign
id|XCVR_EXTERNAL
suffix:semicolon
id|cmd-&gt;autoneg
op_assign
id|AUTONEG_ENABLE
suffix:semicolon
id|cmd-&gt;maxtxpkt
op_assign
id|priv-&gt;txcount
suffix:semicolon
id|cmd-&gt;maxrxpkt
op_assign
id|priv-&gt;rxcount
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Return the length of the register structure */
DECL|function|gfar_reglen
r_int
id|gfar_reglen
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
r_sizeof
(paren
r_struct
id|gfar
)paren
suffix:semicolon
)brace
multiline_comment|/* Return a dump of the GFAR register space */
DECL|function|gfar_get_regs
r_void
id|gfar_get_regs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_regs
op_star
id|regs
comma
r_void
op_star
id|regbuf
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|gfar_private
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|u32
op_star
id|theregs
op_assign
(paren
id|u32
op_star
)paren
id|priv-&gt;regs
suffix:semicolon
id|u32
op_star
id|buf
op_assign
(paren
id|u32
op_star
)paren
id|regbuf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
r_struct
id|gfar
)paren
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|i
op_increment
)paren
id|buf
(braket
id|i
)braket
op_assign
id|theregs
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* Fill in a buffer with the strings which correspond to the&n; * stats */
DECL|function|gfar_gstrings
r_void
id|gfar_gstrings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|stringset
comma
id|u8
op_star
id|buf
)paren
(brace
id|memcpy
c_func
(paren
id|buf
comma
id|stat_gstrings
comma
id|GFAR_STATS_LEN
op_star
id|ETH_GSTRING_LEN
)paren
suffix:semicolon
)brace
multiline_comment|/* Convert microseconds to ethernet clock ticks, which changes&n; * depending on what speed the controller is running at */
DECL|function|gfar_usecs2ticks
r_static
r_int
r_int
id|gfar_usecs2ticks
c_func
(paren
r_struct
id|gfar_private
op_star
id|priv
comma
r_int
r_int
id|usecs
)paren
(brace
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* The timer is different, depending on the interface speed */
r_switch
c_cond
(paren
id|priv-&gt;mii_info-&gt;speed
)paren
(brace
r_case
l_int|1000
suffix:colon
id|count
op_assign
id|GFAR_GBIT_TIME
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|100
suffix:colon
id|count
op_assign
id|GFAR_100_TIME
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
r_default
suffix:colon
id|count
op_assign
id|GFAR_10_TIME
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Make sure we return a number greater than 0&n;&t; * if usecs &gt; 0 */
r_return
(paren
(paren
id|usecs
op_star
l_int|1000
op_plus
id|count
op_minus
l_int|1
)paren
op_div
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/* Convert ethernet clock ticks to microseconds */
DECL|function|gfar_ticks2usecs
r_static
r_int
r_int
id|gfar_ticks2usecs
c_func
(paren
r_struct
id|gfar_private
op_star
id|priv
comma
r_int
r_int
id|ticks
)paren
(brace
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* The timer is different, depending on the interface speed */
r_switch
c_cond
(paren
id|priv-&gt;mii_info-&gt;speed
)paren
(brace
r_case
l_int|1000
suffix:colon
id|count
op_assign
id|GFAR_GBIT_TIME
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|100
suffix:colon
id|count
op_assign
id|GFAR_100_TIME
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
r_default
suffix:colon
id|count
op_assign
id|GFAR_10_TIME
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Make sure we return a number greater than 0 */
multiline_comment|/* if ticks is &gt; 0 */
r_return
(paren
(paren
id|ticks
op_star
id|count
)paren
op_div
l_int|1000
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the coalescing parameters, and put them in the cvals&n; * structure.  */
DECL|function|gfar_gcoalesce
r_int
id|gfar_gcoalesce
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_coalesce
op_star
id|cvals
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cvals-&gt;rx_coalesce_usecs
op_assign
id|gfar_ticks2usecs
c_func
(paren
id|priv
comma
id|priv-&gt;rxtime
)paren
suffix:semicolon
id|cvals-&gt;rx_max_coalesced_frames
op_assign
id|priv-&gt;rxcount
suffix:semicolon
id|cvals-&gt;tx_coalesce_usecs
op_assign
id|gfar_ticks2usecs
c_func
(paren
id|priv
comma
id|priv-&gt;txtime
)paren
suffix:semicolon
id|cvals-&gt;tx_max_coalesced_frames
op_assign
id|priv-&gt;txcount
suffix:semicolon
id|cvals-&gt;use_adaptive_rx_coalesce
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;use_adaptive_tx_coalesce
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;pkt_rate_low
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;rx_coalesce_usecs_low
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;rx_max_coalesced_frames_low
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;tx_coalesce_usecs_low
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;tx_max_coalesced_frames_low
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* When the packet rate is below pkt_rate_high but above&n;&t; * pkt_rate_low (both measured in packets per second) the&n;&t; * normal {rx,tx}_* coalescing parameters are used.&n;&t; */
multiline_comment|/* When the packet rate is (measured in packets per second)&n;&t; * is above pkt_rate_high, the {rx,tx}_*_high parameters are&n;&t; * used.&n;&t; */
id|cvals-&gt;pkt_rate_high
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;rx_coalesce_usecs_high
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;rx_max_coalesced_frames_high
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;tx_coalesce_usecs_high
op_assign
l_int|0
suffix:semicolon
id|cvals-&gt;tx_max_coalesced_frames_high
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* How often to do adaptive coalescing packet rate sampling,&n;&t; * measured in seconds.  Must not be zero.&n;&t; */
id|cvals-&gt;rate_sample_interval
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Change the coalescing values.&n; * Both cvals-&gt;*_usecs and cvals-&gt;*_frames have to be &gt; 0&n; * in order for coalescing to be active&n; */
DECL|function|gfar_scoalesce
r_int
id|gfar_scoalesce
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_coalesce
op_star
id|cvals
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Set up rx coalescing */
r_if
c_cond
(paren
(paren
id|cvals-&gt;rx_coalesce_usecs
op_eq
l_int|0
)paren
op_logical_or
(paren
id|cvals-&gt;rx_max_coalesced_frames
op_eq
l_int|0
)paren
)paren
id|priv-&gt;rxcoalescing
op_assign
l_int|0
suffix:semicolon
r_else
id|priv-&gt;rxcoalescing
op_assign
l_int|1
suffix:semicolon
id|priv-&gt;rxtime
op_assign
id|gfar_usecs2ticks
c_func
(paren
id|priv
comma
id|cvals-&gt;rx_coalesce_usecs
)paren
suffix:semicolon
id|priv-&gt;rxcount
op_assign
id|cvals-&gt;rx_max_coalesced_frames
suffix:semicolon
multiline_comment|/* Set up tx coalescing */
r_if
c_cond
(paren
(paren
id|cvals-&gt;tx_coalesce_usecs
op_eq
l_int|0
)paren
op_logical_or
(paren
id|cvals-&gt;tx_max_coalesced_frames
op_eq
l_int|0
)paren
)paren
id|priv-&gt;txcoalescing
op_assign
l_int|0
suffix:semicolon
r_else
id|priv-&gt;txcoalescing
op_assign
l_int|1
suffix:semicolon
id|priv-&gt;txtime
op_assign
id|gfar_usecs2ticks
c_func
(paren
id|priv
comma
id|cvals-&gt;tx_coalesce_usecs
)paren
suffix:semicolon
id|priv-&gt;txcount
op_assign
id|cvals-&gt;tx_max_coalesced_frames
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rxcoalescing
)paren
id|gfar_write
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;rxic
comma
id|mk_ic_value
c_func
(paren
id|priv-&gt;rxcount
comma
id|priv-&gt;rxtime
)paren
)paren
suffix:semicolon
r_else
id|gfar_write
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;rxic
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;txcoalescing
)paren
id|gfar_write
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;txic
comma
id|mk_ic_value
c_func
(paren
id|priv-&gt;txcount
comma
id|priv-&gt;txtime
)paren
)paren
suffix:semicolon
r_else
id|gfar_write
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;txic
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fills in rvals with the current ring parameters.  Currently,&n; * rx, rx_mini, and rx_jumbo rings are the same size, as mini and&n; * jumbo are ignored by the driver */
DECL|function|gfar_gringparam
r_void
id|gfar_gringparam
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_ringparam
op_star
id|rvals
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rvals-&gt;rx_max_pending
op_assign
id|GFAR_RX_MAX_RING_SIZE
suffix:semicolon
id|rvals-&gt;rx_mini_max_pending
op_assign
id|GFAR_RX_MAX_RING_SIZE
suffix:semicolon
id|rvals-&gt;rx_jumbo_max_pending
op_assign
id|GFAR_RX_MAX_RING_SIZE
suffix:semicolon
id|rvals-&gt;tx_max_pending
op_assign
id|GFAR_TX_MAX_RING_SIZE
suffix:semicolon
multiline_comment|/* Values changeable by the user.  The valid values are&n;&t; * in the range 1 to the &quot;*_max_pending&quot; counterpart above.&n;&t; */
id|rvals-&gt;rx_pending
op_assign
id|priv-&gt;rx_ring_size
suffix:semicolon
id|rvals-&gt;rx_mini_pending
op_assign
id|priv-&gt;rx_ring_size
suffix:semicolon
id|rvals-&gt;rx_jumbo_pending
op_assign
id|priv-&gt;rx_ring_size
suffix:semicolon
id|rvals-&gt;tx_pending
op_assign
id|priv-&gt;tx_ring_size
suffix:semicolon
)brace
multiline_comment|/* Change the current ring parameters, stopping the controller if&n; * necessary so that we don&squot;t mess things up while we&squot;re in&n; * motion.  We wait for the ring to be clean before reallocating&n; * the rings. */
DECL|function|gfar_sringparam
r_int
id|gfar_sringparam
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_ringparam
op_star
id|rvals
)paren
(brace
id|u32
id|tempval
suffix:semicolon
r_struct
id|gfar_private
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rvals-&gt;rx_pending
OG
id|GFAR_RX_MAX_RING_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_power_of_2
c_func
(paren
id|rvals-&gt;rx_pending
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Ring sizes must be a power of 2&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rvals-&gt;tx_pending
OG
id|GFAR_TX_MAX_RING_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_power_of_2
c_func
(paren
id|rvals-&gt;tx_pending
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Ring sizes must be a power of 2&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Stop the controller so we don&squot;t rx any more frames */
multiline_comment|/* But first, make sure we clear the bits */
id|tempval
op_assign
id|gfar_read
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;dmactrl
)paren
suffix:semicolon
id|tempval
op_and_assign
op_complement
(paren
id|DMACTRL_GRS
op_or
id|DMACTRL_GTS
)paren
suffix:semicolon
id|gfar_write
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;dmactrl
comma
id|tempval
)paren
suffix:semicolon
id|tempval
op_assign
id|gfar_read
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;dmactrl
)paren
suffix:semicolon
id|tempval
op_or_assign
(paren
id|DMACTRL_GRS
op_or
id|DMACTRL_GTS
)paren
suffix:semicolon
id|gfar_write
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;dmactrl
comma
id|tempval
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|gfar_read
c_func
(paren
op_amp
id|priv-&gt;regs-&gt;ievent
)paren
op_amp
(paren
id|IEVENT_GRSC
op_or
id|IEVENT_GTSC
)paren
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Note that rx is not clean right now */
id|priv-&gt;rxclean
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
multiline_comment|/* Tell the driver to process the rest of the frames */
id|gfar_receive
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Now wait for it to be done */
id|wait_event_interruptible
c_func
(paren
id|priv-&gt;rxcleanupq
comma
id|priv-&gt;rxclean
)paren
suffix:semicolon
multiline_comment|/* Ok, all packets have been handled.  Now we bring it down,&n;&t;&t; * change the ring size, and bring it up */
id|stop_gfar
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|priv-&gt;rx_ring_size
op_assign
id|rvals-&gt;rx_pending
suffix:semicolon
id|priv-&gt;tx_ring_size
op_assign
id|rvals-&gt;tx_pending
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
id|err
op_assign
id|startup_gfar
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|gfar_ethtool_ops
r_struct
id|ethtool_ops
id|gfar_ethtool_ops
op_assign
(brace
dot
id|get_settings
op_assign
id|gfar_gsettings
comma
dot
id|get_drvinfo
op_assign
id|gfar_gdrvinfo
comma
dot
id|get_regs_len
op_assign
id|gfar_reglen
comma
dot
id|get_regs
op_assign
id|gfar_get_regs
comma
dot
id|get_link
op_assign
id|ethtool_op_get_link
comma
dot
id|get_coalesce
op_assign
id|gfar_gcoalesce
comma
dot
id|set_coalesce
op_assign
id|gfar_scoalesce
comma
dot
id|get_ringparam
op_assign
id|gfar_gringparam
comma
dot
id|set_ringparam
op_assign
id|gfar_sringparam
comma
dot
id|get_strings
op_assign
id|gfar_gstrings
comma
dot
id|get_stats_count
op_assign
id|gfar_stats_count
comma
dot
id|get_ethtool_stats
op_assign
id|gfar_fill_stats
comma
)brace
suffix:semicolon
DECL|variable|gfar_normon_nocoalesce_ethtool_ops
r_struct
id|ethtool_ops
id|gfar_normon_nocoalesce_ethtool_ops
op_assign
(brace
dot
id|get_settings
op_assign
id|gfar_gsettings
comma
dot
id|get_drvinfo
op_assign
id|gfar_gdrvinfo
comma
dot
id|get_regs_len
op_assign
id|gfar_reglen
comma
dot
id|get_regs
op_assign
id|gfar_get_regs
comma
dot
id|get_link
op_assign
id|ethtool_op_get_link
comma
dot
id|get_ringparam
op_assign
id|gfar_gringparam
comma
dot
id|set_ringparam
op_assign
id|gfar_sringparam
comma
dot
id|get_strings
op_assign
id|gfar_gstrings_normon
comma
dot
id|get_stats_count
op_assign
id|gfar_stats_count_normon
comma
dot
id|get_ethtool_stats
op_assign
id|gfar_fill_stats_normon
comma
)brace
suffix:semicolon
DECL|variable|gfar_nocoalesce_ethtool_ops
r_struct
id|ethtool_ops
id|gfar_nocoalesce_ethtool_ops
op_assign
(brace
dot
id|get_settings
op_assign
id|gfar_gsettings
comma
dot
id|get_drvinfo
op_assign
id|gfar_gdrvinfo
comma
dot
id|get_regs_len
op_assign
id|gfar_reglen
comma
dot
id|get_regs
op_assign
id|gfar_get_regs
comma
dot
id|get_link
op_assign
id|ethtool_op_get_link
comma
dot
id|get_ringparam
op_assign
id|gfar_gringparam
comma
dot
id|set_ringparam
op_assign
id|gfar_sringparam
comma
dot
id|get_strings
op_assign
id|gfar_gstrings
comma
dot
id|get_stats_count
op_assign
id|gfar_stats_count
comma
dot
id|get_ethtool_stats
op_assign
id|gfar_fill_stats
comma
)brace
suffix:semicolon
DECL|variable|gfar_normon_ethtool_ops
r_struct
id|ethtool_ops
id|gfar_normon_ethtool_ops
op_assign
(brace
dot
id|get_settings
op_assign
id|gfar_gsettings
comma
dot
id|get_drvinfo
op_assign
id|gfar_gdrvinfo
comma
dot
id|get_regs_len
op_assign
id|gfar_reglen
comma
dot
id|get_regs
op_assign
id|gfar_get_regs
comma
dot
id|get_link
op_assign
id|ethtool_op_get_link
comma
dot
id|get_coalesce
op_assign
id|gfar_gcoalesce
comma
dot
id|set_coalesce
op_assign
id|gfar_scoalesce
comma
dot
id|get_ringparam
op_assign
id|gfar_gringparam
comma
dot
id|set_ringparam
op_assign
id|gfar_sringparam
comma
dot
id|get_strings
op_assign
id|gfar_gstrings_normon
comma
dot
id|get_stats_count
op_assign
id|gfar_stats_count_normon
comma
dot
id|get_ethtool_stats
op_assign
id|gfar_fill_stats_normon
comma
)brace
suffix:semicolon
DECL|variable|gfar_op_array
r_struct
id|ethtool_ops
op_star
id|gfar_op_array
(braket
)braket
op_assign
(brace
op_amp
id|gfar_ethtool_ops
comma
op_amp
id|gfar_normon_ethtool_ops
comma
op_amp
id|gfar_nocoalesce_ethtool_ops
comma
op_amp
id|gfar_normon_nocoalesce_ethtool_ops
)brace
suffix:semicolon
eof
