multiline_comment|/*&n; * meth.c -- O2 Builtin 10/100 Ethernet driver&n; *&n; * Copyright (C) 2001-2003 Ilya Volynets&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt; /* printk() */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;  /* error codes */
macro_line|#include &lt;linux/types.h&gt;  /* size_t */
macro_line|#include &lt;linux/interrupt.h&gt; /* mark_bh */
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;linux/device.h&gt; /* struct device, et al */
macro_line|#include &lt;linux/netdevice.h&gt;   /* struct device, and other headers */
macro_line|#include &lt;linux/etherdevice.h&gt; /* eth_type_trans */
macro_line|#include &lt;linux/ip.h&gt;          /* struct iphdr */
macro_line|#include &lt;linux/tcp.h&gt;         /* struct tcphdr */
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/mii.h&gt;         /* MII definitions */
macro_line|#include &lt;asm/ip32/mace.h&gt;
macro_line|#include &lt;asm/ip32/ip32_ints.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
macro_line|#include &lt;asm/scatterlist.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &quot;meth.h&quot;
macro_line|#ifndef MFE_DEBUG
DECL|macro|MFE_DEBUG
mdefine_line|#define MFE_DEBUG 0
macro_line|#endif
macro_line|#if MFE_DEBUG&gt;=1
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(str,args...) printk(KERN_DEBUG &quot;meth: %s: &quot; str, __FUNCTION__ , ## args)
DECL|macro|MFE_RX_DEBUG
mdefine_line|#define MFE_RX_DEBUG 2
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(str,args...)
DECL|macro|MFE_RX_DEBUG
mdefine_line|#define MFE_RX_DEBUG 0
macro_line|#endif
DECL|variable|meth_str
r_static
r_const
r_char
op_star
id|meth_str
op_assign
l_string|&quot;SGI O2 Fast Ethernet&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ilya Volynets &lt;ilya@theIlya.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SGI O2 Builtin Fast Ethernet driver&quot;
)paren
suffix:semicolon
DECL|macro|HAVE_TX_TIMEOUT
mdefine_line|#define HAVE_TX_TIMEOUT
multiline_comment|/* The maximum time waited (in jiffies) before assuming a Tx failed. (400ms) */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT (400*HZ/1000)
macro_line|#ifdef HAVE_TX_TIMEOUT
DECL|variable|timeout
r_static
r_int
id|timeout
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|timeout
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * This structure is private to each device. It is used to pass&n; * packets in and out, so there is place for a packet&n; */
DECL|struct|meth_private
r_struct
id|meth_private
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
multiline_comment|/* in-memory copy of MAC Control register */
DECL|member|mac_ctrl
r_int
r_int
id|mac_ctrl
suffix:semicolon
multiline_comment|/* in-memory copy of DMA Control register */
DECL|member|dma_ctrl
r_int
r_int
id|dma_ctrl
suffix:semicolon
multiline_comment|/* address of PHY, used by mdio_* functions, initialized in mdio_probe */
DECL|member|phy_addr
r_int
r_int
id|phy_addr
suffix:semicolon
DECL|member|tx_ring
id|tx_packet
op_star
id|tx_ring
suffix:semicolon
DECL|member|tx_ring_dma
id|dma_addr_t
id|tx_ring_dma
suffix:semicolon
DECL|member|tx_skbs
r_struct
id|sk_buff
op_star
id|tx_skbs
(braket
id|TX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|tx_skb_dmas
id|dma_addr_t
id|tx_skb_dmas
(braket
id|TX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|tx_read
DECL|member|tx_write
DECL|member|tx_count
r_int
r_int
id|tx_read
comma
id|tx_write
comma
id|tx_count
suffix:semicolon
DECL|member|rx_ring
id|rx_packet
op_star
id|rx_ring
(braket
id|RX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|rx_ring_dmas
id|dma_addr_t
id|rx_ring_dmas
(braket
id|RX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|rx_skbs
r_struct
id|sk_buff
op_star
id|rx_skbs
(braket
id|RX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|rx_write
r_int
r_int
id|rx_write
suffix:semicolon
DECL|member|meth_lock
id|spinlock_t
id|meth_lock
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|meth_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|meth_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|pregs
)paren
suffix:semicolon
multiline_comment|/* global, initialized in ip32-setup.c */
DECL|variable|o2meth_eaddr
r_char
id|o2meth_eaddr
(braket
l_int|8
)braket
op_assign
initialization_block
suffix:semicolon
DECL|function|load_eaddr
r_static
r_inline
r_void
id|load_eaddr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Loading MAC Address: %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|0
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|1
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|2
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|3
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|4
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|5
)braket
op_amp
l_int|0xFF
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|o2meth_eaddr
(braket
id|i
)braket
suffix:semicolon
id|mace-&gt;eth.mac_addr
op_assign
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|o2meth_eaddr
)paren
op_rshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/*&n; * Waits for BUSY status of mdio bus to clear&n; */
DECL|macro|WAIT_FOR_PHY
mdefine_line|#define WAIT_FOR_PHY(___rval)&t;&t;&t;&t;&t;&bslash;&n;&t;while ((___rval = mace-&gt;eth.phy_data) &amp; MDIO_BUSY) {&t;&bslash;&n;&t;&t;udelay(25);&t;&t;&t;&t;&t;&bslash;&n;&t;}
multiline_comment|/*read phy register, return value read */
DECL|function|mdio_read
r_static
r_int
r_int
id|mdio_read
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
comma
r_int
r_int
id|phyreg
)paren
(brace
r_int
r_int
id|rval
suffix:semicolon
id|WAIT_FOR_PHY
c_func
(paren
id|rval
)paren
suffix:semicolon
id|mace-&gt;eth.phy_regs
op_assign
(paren
id|priv-&gt;phy_addr
op_lshift
l_int|5
)paren
op_or
(paren
id|phyreg
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|mace-&gt;eth.phy_trans_go
op_assign
l_int|1
suffix:semicolon
id|udelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|WAIT_FOR_PHY
c_func
(paren
id|rval
)paren
suffix:semicolon
r_return
id|rval
op_amp
id|MDIO_DATA_MASK
suffix:semicolon
)brace
DECL|function|mdio_probe
r_static
r_int
id|mdio_probe
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|p2
comma
id|p3
suffix:semicolon
multiline_comment|/* check if phy is detected already */
r_if
c_cond
(paren
id|priv-&gt;phy_addr
op_ge
l_int|0
op_logical_and
id|priv-&gt;phy_addr
OL
l_int|32
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
op_increment
id|i
)paren
(brace
id|priv-&gt;phy_addr
op_assign
id|i
suffix:semicolon
id|p2
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
l_int|2
)paren
suffix:semicolon
id|p3
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
l_int|3
)paren
suffix:semicolon
macro_line|#if MFE_DEBUG&gt;=2
r_switch
c_cond
(paren
(paren
id|p2
op_lshift
l_int|12
)paren
op_or
(paren
id|p3
op_rshift
l_int|4
)paren
)paren
(brace
r_case
id|PHY_QS6612X
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;PHY is QS6612X&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_ICS1889
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;PHY is ICS1889&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_ICS1890
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;PHY is ICS1890&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_DP83840
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;PHY is DP83840&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|p2
op_ne
l_int|0xffff
op_logical_and
id|p2
op_ne
l_int|0x0000
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;PHY code: %x&bslash;n&quot;
comma
(paren
id|p2
op_lshift
l_int|12
)paren
op_or
(paren
id|p3
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phy_addr
OL
l_int|32
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;Oopsie! PHY is not known!&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;phy_addr
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|meth_check_link
r_static
r_void
id|meth_check_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|mii_advertising
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
l_int|4
)paren
suffix:semicolon
r_int
r_int
id|mii_partner
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
l_int|5
)paren
suffix:semicolon
r_int
r_int
id|negotiated
op_assign
id|mii_advertising
op_amp
id|mii_partner
suffix:semicolon
r_int
r_int
id|duplex
comma
id|speed
suffix:semicolon
r_if
c_cond
(paren
id|mii_partner
op_eq
l_int|0xffff
)paren
r_return
suffix:semicolon
id|speed
op_assign
(paren
id|negotiated
op_amp
l_int|0x0380
)paren
ques
c_cond
id|METH_100MBIT
suffix:colon
l_int|0
suffix:semicolon
id|duplex
op_assign
(paren
(paren
id|negotiated
op_amp
l_int|0x0100
)paren
op_logical_or
(paren
id|negotiated
op_amp
l_int|0x01C0
)paren
op_eq
l_int|0x0040
)paren
ques
c_cond
id|METH_PHY_FDX
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;mac_ctrl
op_amp
id|METH_PHY_FDX
)paren
op_xor
id|duplex
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Setting %s-duplex&bslash;n&quot;
comma
id|duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|duplex
)paren
id|priv-&gt;mac_ctrl
op_or_assign
id|METH_PHY_FDX
suffix:semicolon
r_else
id|priv-&gt;mac_ctrl
op_and_assign
op_complement
id|METH_PHY_FDX
suffix:semicolon
id|mace-&gt;eth.mac_ctrl
op_assign
id|priv-&gt;mac_ctrl
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|priv-&gt;mac_ctrl
op_amp
id|METH_100MBIT
)paren
op_xor
id|speed
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Setting %dMbs mode&bslash;n&quot;
comma
id|speed
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|duplex
)paren
id|priv-&gt;mac_ctrl
op_or_assign
id|METH_100MBIT
suffix:semicolon
r_else
id|priv-&gt;mac_ctrl
op_and_assign
op_complement
id|METH_100MBIT
suffix:semicolon
id|mace-&gt;eth.mac_ctrl
op_assign
id|priv-&gt;mac_ctrl
suffix:semicolon
)brace
)brace
DECL|function|meth_init_tx_ring
r_static
r_int
id|meth_init_tx_ring
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
)paren
(brace
multiline_comment|/* Init TX ring */
id|priv-&gt;tx_ring
op_assign
id|dma_alloc_coherent
c_func
(paren
l_int|NULL
comma
id|TX_RING_BUFFER_SIZE
comma
op_amp
id|priv-&gt;tx_ring_dma
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;tx_ring
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|priv-&gt;tx_ring
comma
l_int|0
comma
id|TX_RING_BUFFER_SIZE
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_assign
id|priv-&gt;tx_read
op_assign
id|priv-&gt;tx_write
op_assign
l_int|0
suffix:semicolon
id|mace-&gt;eth.tx_ring_base
op_assign
id|priv-&gt;tx_ring_dma
suffix:semicolon
multiline_comment|/* Now init skb save area */
id|memset
c_func
(paren
id|priv-&gt;tx_skbs
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;tx_skbs
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|priv-&gt;tx_skb_dmas
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;tx_skb_dmas
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|meth_init_rx_ring
r_static
r_int
id|meth_init_rx_ring
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|priv-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|alloc_skb
c_func
(paren
id|METH_RX_BUFF_SIZE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 8byte status vector + 3quad padding + 2byte padding,&n;&t;&t; * to put data on 64bit aligned boundary */
id|skb_reserve
c_func
(paren
id|priv-&gt;rx_skbs
(braket
id|i
)braket
comma
id|METH_RX_HEAD
)paren
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_assign
(paren
id|rx_packet
op_star
)paren
(paren
id|priv-&gt;rx_skbs
(braket
id|i
)braket
op_member_access_from_pointer
id|head
)paren
suffix:semicolon
multiline_comment|/* I&squot;ll need to re-sync it after each RX */
id|priv-&gt;rx_ring_dmas
(braket
id|i
)braket
op_assign
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|priv-&gt;rx_ring
(braket
id|i
)braket
comma
id|METH_RX_BUFF_SIZE
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|mace-&gt;eth.rx_fifo
op_assign
id|priv-&gt;rx_ring_dmas
(braket
id|i
)braket
suffix:semicolon
)brace
id|priv-&gt;rx_write
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|meth_free_tx_ring
r_static
r_void
id|meth_free_tx_ring
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Remove any pending skb */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;tx_skbs
(braket
id|i
)braket
)paren
id|dev_kfree_skb
c_func
(paren
id|priv-&gt;tx_skbs
(braket
id|i
)braket
)paren
suffix:semicolon
id|priv-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|TX_RING_BUFFER_SIZE
comma
id|priv-&gt;tx_ring
comma
id|priv-&gt;tx_ring_dma
)paren
suffix:semicolon
)brace
multiline_comment|/* Presumes RX DMA engine is stopped, and RX fifo ring is reset */
DECL|function|meth_free_rx_ring
r_static
r_void
id|meth_free_rx_ring
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dma_unmap_single
c_func
(paren
l_int|NULL
comma
id|priv-&gt;rx_ring_dmas
(braket
id|i
)braket
comma
id|METH_RX_BUFF_SIZE
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rx_ring_dmas
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|kfree_skb
c_func
(paren
id|priv-&gt;rx_skbs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|meth_reset
r_int
id|meth_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Reset card */
id|mace-&gt;eth.mac_ctrl
op_assign
id|SGI_MAC_RESET
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|mace-&gt;eth.mac_ctrl
op_assign
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
multiline_comment|/* Load ethernet address */
id|load_eaddr
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Should load some &quot;errata&quot;, but later */
multiline_comment|/* Check for device */
r_if
c_cond
(paren
id|mdio_probe
c_func
(paren
id|priv
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Unable to find PHY&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Initial mode: 10 | Half-duplex | Accept normal packets */
id|priv-&gt;mac_ctrl
op_assign
id|METH_ACCEPT_MCAST
op_or
id|METH_DEFAULT_IPG
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_or
id|IFF_PROMISC
)paren
id|priv-&gt;mac_ctrl
op_or_assign
id|METH_PROMISC
suffix:semicolon
id|mace-&gt;eth.mac_ctrl
op_assign
id|priv-&gt;mac_ctrl
suffix:semicolon
multiline_comment|/* Autonegotiate speed and duplex mode */
id|meth_check_link
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Now set dma control, but don&squot;t enable DMA, yet */
id|priv-&gt;dma_ctrl
op_assign
(paren
l_int|4
op_lshift
id|METH_RX_OFFSET_SHIFT
)paren
op_or
(paren
id|RX_RING_ENTRIES
op_lshift
id|METH_RX_DEPTH_SHIFT
)paren
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============End Helper Routines=====================*/
multiline_comment|/*&n; * Open and close&n; */
DECL|function|meth_open
r_static
r_int
id|meth_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|priv-&gt;phy_addr
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* No PHY is known yet... */
multiline_comment|/* Initialize the hardware */
id|ret
op_assign
id|meth_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* Allocate the ring buffers */
id|ret
op_assign
id|meth_init_tx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|ret
op_assign
id|meth_init_rx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out_free_tx_ring
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|meth_interrupt
comma
l_int|0
comma
id|meth_str
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|out_free_rx_ring
suffix:semicolon
)brace
multiline_comment|/* Start DMA */
id|priv-&gt;dma_ctrl
op_or_assign
id|METH_DMA_TX_EN
op_or
multiline_comment|/*METH_DMA_TX_INT_EN |*/
id|METH_DMA_RX_EN
op_or
id|METH_DMA_RX_INT_EN
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;About to start queue&bslash;n&quot;
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free_rx_ring
suffix:colon
id|meth_free_rx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|out_free_tx_ring
suffix:colon
id|meth_free_tx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|meth_release
r_static
r_int
id|meth_release
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Stopping queue&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* can&squot;t transmit any more */
multiline_comment|/* shut down DMA */
id|priv-&gt;dma_ctrl
op_and_assign
op_complement
(paren
id|METH_DMA_TX_EN
op_or
id|METH_DMA_TX_INT_EN
op_or
id|METH_DMA_RX_EN
op_or
id|METH_DMA_RX_INT_EN
)paren
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|meth_free_tx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|meth_free_rx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive a packet: retrieve, encapsulate and pass over to upper levels&n; */
DECL|function|meth_rx
r_static
r_void
id|meth_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|int_status
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|fifo_rptr
op_assign
(paren
id|int_status
op_amp
id|METH_INT_RX_RPTR_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
id|priv-&gt;dma_ctrl
op_and_assign
op_complement
id|METH_DMA_RX_INT_EN
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|int_status
op_amp
id|METH_INT_RX_UNDERFLOW
)paren
(brace
id|fifo_rptr
op_assign
(paren
id|fifo_rptr
op_minus
l_int|1
)paren
op_amp
l_int|0x0f
suffix:semicolon
)brace
r_while
c_loop
(paren
id|priv-&gt;rx_write
op_ne
id|fifo_rptr
)paren
(brace
id|dma_unmap_single
c_func
(paren
l_int|NULL
comma
id|priv-&gt;rx_ring_dmas
(braket
id|priv-&gt;rx_write
)braket
comma
id|METH_RX_BUFF_SIZE
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|status
op_assign
id|priv-&gt;rx_ring
(braket
id|priv-&gt;rx_write
)braket
op_member_access_from_pointer
id|status.raw
suffix:semicolon
macro_line|#if MFE_DEBUG
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|METH_RX_ST_VALID
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Not received? status=%016lx&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|status
op_amp
id|METH_RX_STATUS_ERRORS
)paren
)paren
op_logical_and
(paren
id|status
op_amp
id|METH_RX_ST_VALID
)paren
)paren
(brace
r_int
id|len
op_assign
(paren
id|status
op_amp
l_int|0xffff
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* omit CRC */
multiline_comment|/* length sanity check */
r_if
c_cond
(paren
id|len
template_param
l_int|1518
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: bogus packet size: %ld, status=%#2lx.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;rx_write
comma
id|priv-&gt;rx_ring
(braket
id|priv-&gt;rx_write
)braket
op_member_access_from_pointer
id|status.raw
)paren
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
id|skb
op_assign
id|priv-&gt;rx_skbs
(braket
id|priv-&gt;rx_write
)braket
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|METH_RX_BUFF_SIZE
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
multiline_comment|/* Ouch! No memory! Drop packet on the floor */
id|DPRINTK
c_func
(paren
l_string|&quot;No mem: dropping packet&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|skb
op_assign
id|priv-&gt;rx_skbs
(braket
id|priv-&gt;rx_write
)braket
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb_c
op_assign
id|priv-&gt;rx_skbs
(braket
id|priv-&gt;rx_write
)braket
suffix:semicolon
multiline_comment|/* 8byte status vector + 3quad padding + 2byte padding,&n;&t;&t;&t;&t;&t; * to put data on 64bit aligned boundary */
id|skb_reserve
c_func
(paren
id|skb
comma
id|METH_RX_HEAD
)paren
suffix:semicolon
multiline_comment|/* Write metadata, and then pass to the receive level */
id|skb_put
c_func
(paren
id|skb_c
comma
id|len
)paren
suffix:semicolon
id|priv-&gt;rx_skbs
(braket
id|priv-&gt;rx_write
)braket
op_assign
id|skb
suffix:semicolon
id|skb_c-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_c-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb_c
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb_c
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|skb
op_assign
id|priv-&gt;rx_skbs
(braket
id|priv-&gt;rx_write
)braket
suffix:semicolon
macro_line|#if MFE_DEBUG&gt;0
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: RX error: status=0x%016lx&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|METH_RX_ST_RCV_CODE_VIOLATION
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Receive Code Violation&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_RX_ST_CRC_ERR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CRC error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_RX_ST_INV_PREAMBLE_CTX
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Invalid Preamble Context&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_RX_ST_LONG_EVT_SEEN
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Long Event Seen...&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_RX_ST_BAD_PACKET
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Bad Packet&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_RX_ST_CARRIER_EVT_SEEN
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Carrier Event Seen&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
id|priv-&gt;rx_ring
(braket
id|priv-&gt;rx_write
)braket
op_assign
(paren
id|rx_packet
op_star
)paren
id|skb-&gt;head
suffix:semicolon
id|priv-&gt;rx_ring
(braket
id|priv-&gt;rx_write
)braket
op_member_access_from_pointer
id|status.raw
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rx_ring_dmas
(braket
id|priv-&gt;rx_write
)braket
op_assign
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|priv-&gt;rx_ring
(braket
id|priv-&gt;rx_write
)braket
comma
id|METH_RX_BUFF_SIZE
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|mace-&gt;eth.rx_fifo
op_assign
id|priv-&gt;rx_ring_dmas
(braket
id|priv-&gt;rx_write
)braket
suffix:semicolon
id|ADVANCE_RX_PTR
c_func
(paren
id|priv-&gt;rx_write
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
multiline_comment|/* In case there was underflow, and Rx DMA was disabled */
id|priv-&gt;dma_ctrl
op_or_assign
id|METH_DMA_RX_INT_EN
op_or
id|METH_DMA_RX_EN
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
id|mace-&gt;eth.int_stat
op_assign
id|METH_INT_RX_THRESHOLD
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
)brace
DECL|function|meth_tx_full
r_static
r_int
id|meth_tx_full
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
(paren
id|priv-&gt;tx_count
op_ge
id|TX_RING_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|meth_tx_cleanup
r_static
r_void
id|meth_tx_cleanup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|int_status
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|rptr
op_assign
(paren
id|int_status
op_amp
id|TX_INFO_RPTR
)paren
op_rshift
l_int|16
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
multiline_comment|/* Stop DMA notification */
id|priv-&gt;dma_ctrl
op_and_assign
op_complement
(paren
id|METH_DMA_TX_INT_EN
)paren
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
r_while
c_loop
(paren
id|priv-&gt;tx_read
op_ne
id|rptr
)paren
(brace
id|skb
op_assign
id|priv-&gt;tx_skbs
(braket
id|priv-&gt;tx_read
)braket
suffix:semicolon
id|status
op_assign
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_read
)braket
dot
id|header.raw
suffix:semicolon
macro_line|#if MFE_DEBUG&gt;=1
r_if
c_cond
(paren
id|priv-&gt;tx_read
op_eq
id|priv-&gt;tx_write
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Auchi! tx_read=%d,tx_write=%d,rptr=%d?&bslash;n&quot;
comma
id|priv-&gt;tx_read
comma
id|priv-&gt;tx_write
comma
id|rptr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
op_amp
id|METH_TX_ST_DONE
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_TX_ST_SUCCESS
)paren
(brace
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
macro_line|#if MFE_DEBUG&gt;=1
id|DPRINTK
c_func
(paren
l_string|&quot;TX error: status=%016lx &lt;&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|METH_TX_ST_SUCCESS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; SUCCESS&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_TX_ST_TOOLONG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; TOOLONG&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_TX_ST_UNDERRUN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; UNDERRUN&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_TX_ST_EXCCOLL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; EXCCOLL&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_TX_ST_DEFER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; DEFER&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_TX_ST_LATECOLL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; LATECOLL&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; &gt;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;RPTR points us here, but packet not done?&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;tx_skbs
(braket
id|priv-&gt;tx_read
)braket
op_assign
l_int|NULL
suffix:semicolon
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_read
)braket
dot
id|header.raw
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;tx_read
op_assign
(paren
id|priv-&gt;tx_read
op_plus
l_int|1
)paren
op_amp
(paren
id|TX_RING_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_decrement
suffix:semicolon
)brace
multiline_comment|/* wake up queue if it was stopped */
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
op_logical_neg
id|meth_tx_full
c_func
(paren
id|dev
)paren
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|mace-&gt;eth.int_stat
op_assign
id|METH_INT_TX_EMPTY
op_or
id|METH_INT_TX_PKT
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
)brace
DECL|function|meth_error
r_static
r_void
id|meth_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|status
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: error status: 0x%08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* check for errors too... */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|METH_INT_TX_LINK_FAIL
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: link failure&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Should I do full reset in this case? */
r_if
c_cond
(paren
id|status
op_amp
(paren
id|METH_INT_MEM_ERROR
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: memory error&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|METH_INT_TX_ABORT
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: aborted&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|METH_INT_RX_OVERFLOW
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: Rx overflow&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|METH_INT_RX_UNDERFLOW
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: Rx underflow&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
id|mace-&gt;eth.int_stat
op_assign
id|METH_INT_RX_UNDERFLOW
suffix:semicolon
multiline_comment|/* more underflow interrupts will be delivered, &n;&t;&t; * effectively throwing us into an infinite loop.&n;&t;&t; *  Thus I stop processing Rx in this case. */
id|priv-&gt;dma_ctrl
op_and_assign
op_complement
id|METH_DMA_RX_EN
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Disabled meth Rx DMA temporarily&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
)brace
id|mace-&gt;eth.int_stat
op_assign
id|METH_INT_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n; * The typical interrupt entry point&n; */
DECL|function|meth_interrupt
r_static
id|irqreturn_t
id|meth_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|pregs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
id|status
op_assign
id|mace-&gt;eth.int_stat
suffix:semicolon
r_while
c_loop
(paren
id|status
op_amp
l_int|0xff
)paren
(brace
multiline_comment|/* First handle errors - if we get Rx underflow,&n;&t;&t; * Rx DMA will be disabled, and Rx handler will reenable&n;&t;&t; * it. I don&squot;t think it&squot;s possible to get Rx underflow,&n;&t;&t; * without getting Rx interrupt */
r_if
c_cond
(paren
id|status
op_amp
id|METH_INT_ERROR
)paren
(brace
id|meth_error
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|METH_INT_TX_EMPTY
op_or
id|METH_INT_TX_PKT
)paren
)paren
(brace
multiline_comment|/* a transmission is over: free the skb */
id|meth_tx_cleanup
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|METH_INT_RX_THRESHOLD
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|priv-&gt;dma_ctrl
op_amp
id|METH_DMA_RX_INT_EN
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* send it to meth_rx for handling */
id|meth_rx
c_func
(paren
id|dev
comma
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|mace-&gt;eth.int_stat
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmits packets that fit into TX descriptor (are &lt;=120B)&n; */
DECL|function|meth_tx_short_prepare
r_static
r_void
id|meth_tx_short_prepare
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|tx_packet
op_star
id|desc
op_assign
op_amp
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_write
)braket
suffix:semicolon
r_int
id|len
op_assign
(paren
id|skb-&gt;len
OL
id|ETH_ZLEN
)paren
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skb-&gt;len
suffix:semicolon
id|desc-&gt;header.raw
op_assign
id|METH_TX_CMD_INT_EN
op_or
(paren
id|len
op_minus
l_int|1
)paren
op_or
(paren
(paren
l_int|128
op_minus
id|len
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* maybe I should set whole thing to 0 first... */
id|memcpy
c_func
(paren
id|desc-&gt;data.dt
op_plus
(paren
l_int|120
op_minus
id|len
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
id|len
)paren
id|memset
c_func
(paren
id|desc-&gt;data.dt
op_plus
l_int|120
op_minus
id|len
op_plus
id|skb-&gt;len
comma
l_int|0
comma
id|len
op_minus
id|skb-&gt;len
)paren
suffix:semicolon
)brace
DECL|macro|TX_CATBUF1
mdefine_line|#define TX_CATBUF1 BIT(25)
DECL|function|meth_tx_1page_prepare
r_static
r_void
id|meth_tx_1page_prepare
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|tx_packet
op_star
id|desc
op_assign
op_amp
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_write
)braket
suffix:semicolon
r_void
op_star
id|buffer_data
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
suffix:semicolon
r_int
id|unaligned_len
op_assign
(paren
r_int
)paren
(paren
(paren
r_int
r_int
)paren
id|buffer_data
op_minus
(paren
r_int
r_int
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_int
id|buffer_len
op_assign
id|skb-&gt;len
op_minus
id|unaligned_len
suffix:semicolon
id|dma_addr_t
id|catbuf
suffix:semicolon
id|desc-&gt;header.raw
op_assign
id|METH_TX_CMD_INT_EN
op_or
id|TX_CATBUF1
op_or
(paren
id|skb-&gt;len
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* unaligned part */
r_if
c_cond
(paren
id|unaligned_len
)paren
(brace
id|memcpy
c_func
(paren
id|desc-&gt;data.dt
op_plus
(paren
l_int|120
op_minus
id|unaligned_len
)paren
comma
id|skb-&gt;data
comma
id|unaligned_len
)paren
suffix:semicolon
id|desc-&gt;header.raw
op_or_assign
(paren
l_int|128
op_minus
id|unaligned_len
)paren
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* first page */
id|catbuf
op_assign
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|buffer_data
comma
id|buffer_len
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|form.start_addr
op_assign
id|catbuf
op_rshift
l_int|3
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|form.len
op_assign
id|buffer_len
op_minus
l_int|1
suffix:semicolon
)brace
DECL|macro|TX_CATBUF2
mdefine_line|#define TX_CATBUF2 BIT(26)
DECL|function|meth_tx_2page_prepare
r_static
r_void
id|meth_tx_2page_prepare
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|tx_packet
op_star
id|desc
op_assign
op_amp
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_write
)braket
suffix:semicolon
r_void
op_star
id|buffer1_data
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
suffix:semicolon
r_void
op_star
id|buffer2_data
op_assign
(paren
r_void
op_star
)paren
id|PAGE_ALIGN
c_func
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_int
id|unaligned_len
op_assign
(paren
r_int
)paren
(paren
(paren
r_int
r_int
)paren
id|buffer1_data
op_minus
(paren
r_int
r_int
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_int
id|buffer1_len
op_assign
(paren
r_int
)paren
(paren
(paren
r_int
r_int
)paren
id|buffer2_data
op_minus
(paren
r_int
r_int
)paren
id|buffer1_data
)paren
suffix:semicolon
r_int
id|buffer2_len
op_assign
id|skb-&gt;len
op_minus
id|buffer1_len
op_minus
id|unaligned_len
suffix:semicolon
id|dma_addr_t
id|catbuf1
comma
id|catbuf2
suffix:semicolon
id|desc-&gt;header.raw
op_assign
id|METH_TX_CMD_INT_EN
op_or
id|TX_CATBUF1
op_or
id|TX_CATBUF2
op_or
(paren
id|skb-&gt;len
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* unaligned part */
r_if
c_cond
(paren
id|unaligned_len
)paren
(brace
id|memcpy
c_func
(paren
id|desc-&gt;data.dt
op_plus
(paren
l_int|120
op_minus
id|unaligned_len
)paren
comma
id|skb-&gt;data
comma
id|unaligned_len
)paren
suffix:semicolon
id|desc-&gt;header.raw
op_or_assign
(paren
l_int|128
op_minus
id|unaligned_len
)paren
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* first page */
id|catbuf1
op_assign
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|buffer1_data
comma
id|buffer1_len
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|form.start_addr
op_assign
id|catbuf1
op_rshift
l_int|3
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|form.len
op_assign
id|buffer1_len
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* second page */
id|catbuf2
op_assign
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|buffer2_data
comma
id|buffer2_len
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|1
)braket
dot
id|form.start_addr
op_assign
id|catbuf2
op_rshift
l_int|3
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|1
)braket
dot
id|form.len
op_assign
id|buffer2_len
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|meth_add_to_tx_ring
r_static
r_void
id|meth_add_to_tx_ring
c_func
(paren
r_struct
id|meth_private
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* Remember the skb, so we can free it at interrupt time */
id|priv-&gt;tx_skbs
(braket
id|priv-&gt;tx_write
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|120
)paren
(brace
multiline_comment|/* Whole packet fits into descriptor */
id|meth_tx_short_prepare
c_func
(paren
id|priv
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|PAGE_ALIGN
c_func
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
)paren
op_ne
id|PAGE_ALIGN
c_func
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Packet crosses page boundary */
id|meth_tx_2page_prepare
c_func
(paren
id|priv
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Packet is in one page */
id|meth_tx_1page_prepare
c_func
(paren
id|priv
comma
id|skb
)paren
suffix:semicolon
)brace
id|priv-&gt;tx_write
op_assign
(paren
id|priv-&gt;tx_write
op_plus
l_int|1
)paren
op_amp
(paren
id|TX_RING_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
id|mace-&gt;eth.tx_info
op_assign
id|priv-&gt;tx_write
suffix:semicolon
id|priv-&gt;tx_count
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit a packet (called by the kernel)&n; */
DECL|function|meth_tx
r_static
r_int
id|meth_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;meth_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Stop DMA notification */
id|priv-&gt;dma_ctrl
op_and_assign
op_complement
(paren
id|METH_DMA_TX_INT_EN
)paren
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
id|meth_add_to_tx_ring
c_func
(paren
id|priv
comma
id|skb
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* save the timestamp */
multiline_comment|/* If TX ring is full, tell the upper layer to stop sending packets */
r_if
c_cond
(paren
id|meth_tx_full
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;TX full: stopping&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Restart DMA notification */
id|priv-&gt;dma_ctrl
op_or_assign
id|METH_DMA_TX_INT_EN
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;meth_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Deal with a transmit timeout.&n; */
DECL|function|meth_tx_timeout
r_static
r_void
id|meth_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Protect against concurrent rx interrupts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;meth_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Try to reset the interface. */
id|meth_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Clear all rings */
id|meth_free_tx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|meth_free_rx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|meth_init_tx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|meth_init_rx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
multiline_comment|/* Restart dma */
id|priv-&gt;dma_ctrl
op_or_assign
id|METH_DMA_TX_EN
op_or
id|METH_DMA_RX_EN
op_or
id|METH_DMA_RX_INT_EN
suffix:semicolon
id|mace-&gt;eth.dma_ctrl
op_assign
id|priv-&gt;dma_ctrl
suffix:semicolon
multiline_comment|/* Enable interrupt */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;meth_lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Ioctl commands &n; */
DECL|function|meth_ioctl
r_static
r_int
id|meth_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
multiline_comment|/* XXX Not yet implemented */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGMIIPHY
suffix:colon
r_case
id|SIOCGMIIREG
suffix:colon
r_case
id|SIOCSMIIREG
suffix:colon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Return statistics to the caller&n; */
DECL|function|meth_stats
r_static
r_struct
id|net_device_stats
op_star
id|meth_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * The init function.&n; */
DECL|function|meth_init
r_static
r_struct
id|net_device
op_star
id|meth_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|meth_private
op_star
id|priv
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|meth_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|meth_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|meth_release
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|meth_tx
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|meth_ioctl
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|meth_stats
suffix:semicolon
macro_line|#ifdef HAVE_TX_TIMEOUT
id|dev-&gt;tx_timeout
op_assign
id|meth_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|timeout
suffix:semicolon
macro_line|#endif
id|dev-&gt;irq
op_assign
id|MACE_ETHERNET_IRQ
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
op_amp
id|mace-&gt;eth
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
id|ret
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: SGI MACE Ethernet rev. %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
r_int
)paren
(paren
id|mace-&gt;eth.mac_ctrl
op_rshift
l_int|29
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|meth_dev
r_static
r_struct
id|net_device
op_star
id|meth_dev
suffix:semicolon
DECL|function|meth_init_module
r_static
r_int
id|__init
id|meth_init_module
c_func
(paren
r_void
)paren
(brace
id|meth_dev
op_assign
id|meth_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|meth_dev
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|meth_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|meth_exit_module
r_static
r_void
id|__exit
id|meth_exit_module
c_func
(paren
r_void
)paren
(brace
id|unregister_netdev
c_func
(paren
id|meth_dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|meth_dev
)paren
suffix:semicolon
)brace
DECL|variable|meth_init_module
id|module_init
c_func
(paren
id|meth_init_module
)paren
suffix:semicolon
DECL|variable|meth_exit_module
id|module_exit
c_func
(paren
id|meth_exit_module
)paren
suffix:semicolon
eof
