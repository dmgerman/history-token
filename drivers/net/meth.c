multiline_comment|/*&n; * meth.c -- O2 Builtin 10/100 Ethernet driver&n; *&n; * Copyright (C) 2001 Ilya Volynets&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt; /* printk() */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;  /* error codes */
macro_line|#include &lt;linux/types.h&gt;  /* size_t */
macro_line|#include &lt;linux/interrupt.h&gt; /* mark_bh */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;   /* struct device, and other headers */
macro_line|#include &lt;linux/etherdevice.h&gt; /* eth_type_trans */
macro_line|#include &lt;linux/ip.h&gt;          /* struct iphdr */
macro_line|#include &lt;linux/tcp.h&gt;         /* struct tcphdr */
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/mii.h&gt; /*MII definitions */
macro_line|#include &lt;asm/ip32/crime.h&gt;
macro_line|#include &lt;asm/ip32/mace.h&gt;
macro_line|#include &lt;asm/ip32/ip32_ints.h&gt;
macro_line|#include &quot;meth.h&quot;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
macro_line|#ifndef MFE_DEBUG
DECL|macro|MFE_DEBUG
mdefine_line|#define MFE_DEBUG 0
macro_line|#endif
macro_line|#if MFE_DEBUG&gt;=1
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(str,args...) printk (KERN_DEBUG &quot;meth(%ld): %s: &quot; str, jiffies, __FUNCTION__ , ## args)
DECL|macro|MFE_RX_DEBUG
mdefine_line|#define MFE_RX_DEBUG 2
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(str,args...)
DECL|macro|MFE_RX_DEBUG
mdefine_line|#define MFE_RX_DEBUG 0
macro_line|#endif
DECL|variable|version
r_static
r_const
r_char
op_star
id|version
op_assign
l_string|&quot;meth.c: Ilya Volynets (ilya@theIlya.com)&quot;
suffix:semicolon
DECL|variable|meth_str
r_static
r_const
r_char
op_star
id|meth_str
op_assign
l_string|&quot;SGI O2 Fast Ethernet&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ilya Volynets&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SGI O2 Builtin Fast Ethernet driver&quot;
)paren
suffix:semicolon
multiline_comment|/* This is a load-time options */
multiline_comment|/*static int eth = 0;&n;MODULE_PARM(eth, &quot;i&quot;);*/
DECL|macro|HAVE_TX_TIMEOUT
mdefine_line|#define HAVE_TX_TIMEOUT
multiline_comment|/* The maximum time waited (in jiffies) before assuming a Tx failed. (400ms) */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT (400*HZ/1000)
macro_line|#ifdef HAVE_TX_TIMEOUT
DECL|variable|timeout
r_static
r_int
id|timeout
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|timeout
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|meth_eth
r_int
id|meth_eth
suffix:semicolon
multiline_comment|/*&n; * This structure is private to each device. It is used to pass&n; * packets in and out, so there is place for a packet&n; */
DECL|struct|meth_private
r_typedef
r_struct
id|meth_private
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|regs
r_volatile
r_struct
id|meth_regs
op_star
id|regs
suffix:semicolon
DECL|member|mode
id|u64
id|mode
suffix:semicolon
multiline_comment|/* in-memory copy of MAC control register */
DECL|member|phy_addr
r_int
id|phy_addr
suffix:semicolon
multiline_comment|/* address of phy, used by mdio_* functions, initialized in mdio_probe*/
DECL|member|tx_ring
id|tx_packet
op_star
id|tx_ring
suffix:semicolon
DECL|member|tx_ring_dma
id|dma_addr_t
id|tx_ring_dma
suffix:semicolon
DECL|member|free_space
r_int
id|free_space
suffix:semicolon
DECL|member|tx_skbs
r_struct
id|sk_buff
op_star
id|tx_skbs
(braket
id|TX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|tx_skb_dmas
id|dma_addr_t
id|tx_skb_dmas
(braket
id|TX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|tx_read
DECL|member|tx_write
r_int
id|tx_read
comma
id|tx_write
suffix:semicolon
DECL|member|tx_count
r_int
id|tx_count
suffix:semicolon
DECL|member|rx_ring
id|rx_packet
op_star
id|rx_ring
(braket
id|RX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|rx_ring_dmas
id|dma_addr_t
id|rx_ring_dmas
(braket
id|RX_RING_ENTRIES
)braket
suffix:semicolon
DECL|member|rx_write
r_int
id|rx_write
suffix:semicolon
DECL|member|meth_lock
id|spinlock_t
id|meth_lock
suffix:semicolon
DECL|typedef|meth_private
)brace
id|meth_private
suffix:semicolon
r_extern
r_struct
id|net_device
id|meth_devs
(braket
)braket
suffix:semicolon
r_void
id|meth_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|meth_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|pregs
)paren
suffix:semicolon
multiline_comment|/* global, initialized in ip32-setup.c */
DECL|variable|o2meth_eaddr
r_char
id|o2meth_eaddr
(braket
l_int|8
)braket
op_assign
initialization_block
suffix:semicolon
DECL|function|load_eaddr
r_static
r_inline
r_void
id|load_eaddr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_volatile
r_struct
id|meth_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Loading MAC Address: %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|0
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|1
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|2
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|3
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|4
)braket
op_amp
l_int|0xFF
comma
(paren
r_int
)paren
id|o2meth_eaddr
(braket
l_int|5
)braket
op_amp
l_int|0xFF
)paren
suffix:semicolon
singleline_comment|//memcpy(dev-&gt;dev_addr,o2meth_eaddr+2,6);
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|o2meth_eaddr
(braket
id|i
)braket
suffix:semicolon
id|regs-&gt;mac_addr
op_assign
singleline_comment|//dev-&gt;dev_addr[0]|(dev-&gt;dev_addr[1]&lt;&lt;8)|
singleline_comment|//dev-&gt;dev_addr[2]&lt;&lt;16|(dev-&gt;dev_addr[3]&lt;&lt;24)|
singleline_comment|//dev-&gt;dev_addr[4]&lt;&lt;32|(dev-&gt;dev_addr[5]&lt;&lt;40);
(paren
op_star
(paren
id|u64
op_star
)paren
id|o2meth_eaddr
)paren
op_rshift
l_int|16
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;MAC, finally is %0lx&bslash;n&quot;
comma
id|regs-&gt;mac_addr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *Waits for BUSY status of mdio bus to clear&n; */
DECL|macro|WAIT_FOR_PHY
mdefine_line|#define WAIT_FOR_PHY(___regs, ___rval)&t;&t;&t;&bslash;&n;&t;while((___rval=___regs-&gt;phy_data)&amp;MDIO_BUSY){&t;&bslash;&n;&t;&t;udelay(25);&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}
multiline_comment|/*read phy register, return value read */
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
id|meth_private
op_star
id|priv
comma
r_int
id|phyreg
)paren
(brace
r_volatile
id|meth_regs
op_star
id|regs
op_assign
id|priv-&gt;regs
suffix:semicolon
r_volatile
id|u32
id|rval
suffix:semicolon
id|WAIT_FOR_PHY
c_func
(paren
id|regs
comma
id|rval
)paren
id|regs-&gt;phy_registers
op_assign
(paren
id|priv-&gt;phy_addr
op_lshift
l_int|5
)paren
op_or
(paren
id|phyreg
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|regs-&gt;phy_trans_go
op_assign
l_int|1
suffix:semicolon
id|udelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|WAIT_FOR_PHY
c_func
(paren
id|regs
comma
id|rval
)paren
r_return
id|rval
op_amp
id|MDIO_DATA_MASK
suffix:semicolon
)brace
multiline_comment|/*write phy register */
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
id|meth_private
op_star
id|priv
comma
r_int
id|pfyreg
comma
r_int
id|val
)paren
(brace
r_volatile
id|meth_regs
op_star
id|regs
op_assign
id|priv-&gt;regs
suffix:semicolon
r_int
id|rval
suffix:semicolon
singleline_comment|///&t;DPRINTK(&quot;Trying to write value %i to reguster %i&bslash;n&quot;,val, pfyreg);
id|spin_lock_irq
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
id|WAIT_FOR_PHY
c_func
(paren
id|regs
comma
id|rval
)paren
id|regs-&gt;phy_registers
op_assign
(paren
id|priv-&gt;phy_addr
op_lshift
l_int|5
)paren
op_or
(paren
id|pfyreg
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|regs-&gt;phy_data
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|WAIT_FOR_PHY
c_func
(paren
id|regs
comma
id|rval
)paren
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Modify phy register using given mask and value */
DECL|function|mdio_update
r_static
r_void
id|mdio_update
c_func
(paren
id|meth_private
op_star
id|priv
comma
r_int
id|phyreg
comma
r_int
id|val
comma
r_int
id|mask
)paren
(brace
r_int
id|rval
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;RMW value %i to PHY register %i with mask %i&bslash;n&quot;
comma
id|val
comma
id|phyreg
comma
id|mask
)paren
suffix:semicolon
id|rval
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
id|phyreg
)paren
suffix:semicolon
id|rval
op_assign
(paren
id|rval
op_amp
op_complement
id|mask
)paren
op_or
(paren
id|val
op_amp
id|mask
)paren
suffix:semicolon
id|mdio_write
c_func
(paren
id|priv
comma
id|phyreg
comma
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/* handle errata data on MDIO bus */
singleline_comment|//static void mdio_errata(meth_private *priv)
singleline_comment|//{
multiline_comment|/* Hmmm... what the hell is phyerrata? does it come from sys init parameters in IRIX */
singleline_comment|//}
DECL|function|mdio_probe
r_static
r_int
id|mdio_probe
c_func
(paren
id|meth_private
op_star
id|priv
)paren
(brace
r_int
id|i
comma
id|p2
comma
id|p3
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Detecting PHY kind&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* check if phy is detected already */
r_if
c_cond
(paren
id|priv-&gt;phy_addr
op_ge
l_int|0
op_logical_and
id|priv-&gt;phy_addr
OL
l_int|32
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
op_increment
id|i
)paren
(brace
id|priv-&gt;phy_addr
op_assign
(paren
r_char
)paren
id|i
suffix:semicolon
id|p2
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef MFE_DEBUG
id|p3
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
l_int|3
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|p2
op_lshift
l_int|12
)paren
op_or
(paren
id|p3
op_rshift
l_int|4
)paren
)paren
(brace
r_case
id|PHY_QS6612X
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;PHY is QS6612X&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_ICS1889
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;PHY is ICS1889&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_ICS1890
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;PHY is ICS1890&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_DP83840
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;PHY is DP83840&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|p2
op_ne
l_int|0xffff
op_logical_and
id|p2
op_ne
l_int|0x0000
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;PHY code: %x&bslash;n&quot;
comma
(paren
id|p2
op_lshift
l_int|12
)paren
op_or
(paren
id|p3
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;phy_addr
OL
l_int|32
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;Oopsie! PHY is not known!&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;phy_addr
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|meth_check_link
r_static
r_void
id|meth_check_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|mii_partner
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
l_int|5
)paren
suffix:semicolon
r_int
id|mii_advertising
op_assign
id|mdio_read
c_func
(paren
id|priv
comma
l_int|4
)paren
suffix:semicolon
r_int
id|negotiated
op_assign
id|mii_advertising
op_amp
id|mii_partner
suffix:semicolon
r_int
id|duplex
comma
id|speed
suffix:semicolon
r_if
c_cond
(paren
id|mii_partner
op_eq
l_int|0xffff
)paren
r_return
suffix:semicolon
id|duplex
op_assign
(paren
(paren
id|negotiated
op_amp
l_int|0x0100
)paren
op_logical_or
(paren
id|negotiated
op_amp
l_int|0x01C0
)paren
op_eq
l_int|0x0040
)paren
ques
c_cond
id|METH_PHY_FDX
suffix:colon
l_int|0
suffix:semicolon
id|speed
op_assign
(paren
id|negotiated
op_amp
l_int|0x0380
)paren
ques
c_cond
id|METH_100MBIT
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;mode
op_amp
id|METH_PHY_FDX
)paren
op_xor
id|duplex
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Setting %s-duplex&bslash;n&quot;
comma
id|duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|duplex
)paren
id|priv-&gt;mode
op_or_assign
id|METH_PHY_FDX
suffix:semicolon
r_else
id|priv-&gt;mode
op_and_assign
op_complement
id|METH_PHY_FDX
suffix:semicolon
id|priv-&gt;regs-&gt;mac_ctrl
op_assign
id|priv-&gt;mode
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|priv-&gt;mode
op_amp
id|METH_100MBIT
)paren
op_xor
id|speed
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Setting %dMbs mode&bslash;n&quot;
comma
id|speed
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|duplex
)paren
id|priv-&gt;mode
op_or_assign
id|METH_100MBIT
suffix:semicolon
r_else
id|priv-&gt;mode
op_and_assign
op_complement
id|METH_100MBIT
suffix:semicolon
id|priv-&gt;regs-&gt;mac_ctrl
op_assign
id|priv-&gt;mode
suffix:semicolon
)brace
)brace
DECL|function|meth_init_tx_ring
r_static
r_int
id|meth_init_tx_ring
c_func
(paren
id|meth_private
op_star
id|priv
)paren
(brace
multiline_comment|/* Init TX ring */
id|DPRINTK
c_func
(paren
l_string|&quot;Initializing TX ring&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;tx_ring
op_assign
(paren
id|tx_packet
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
l_int|NULL
comma
id|TX_RING_BUFFER_SIZE
comma
op_amp
(paren
id|priv-&gt;tx_ring_dma
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;tx_ring
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|priv-&gt;tx_ring
comma
l_int|0
comma
id|TX_RING_BUFFER_SIZE
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_assign
id|priv-&gt;tx_read
op_assign
id|priv-&gt;tx_write
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;regs-&gt;tx_ring_base
op_assign
id|priv-&gt;tx_ring_dma
suffix:semicolon
id|priv-&gt;free_space
op_assign
id|TX_RING_ENTRIES
suffix:semicolon
multiline_comment|/* Now init skb save area */
id|memset
c_func
(paren
id|priv-&gt;tx_skbs
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;tx_skbs
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|priv-&gt;tx_skb_dmas
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;tx_skb_dmas
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Done with TX ring init&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|meth_init_rx_ring
r_static
r_int
id|meth_init_rx_ring
c_func
(paren
id|meth_private
op_star
id|priv
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Initializing RX ring&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;&bslash;t1:&bslash;t%i&bslash;t&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/*if(!(priv-&gt;rx_ring[i]=get_free_page(GFP_KERNEL)))&n;&t;&t;&t;return -ENOMEM;&n;&t;&t;DPRINTK(&quot;&bslash;t2:&bslash;t%i&bslash;n&quot;,i);*/
id|priv-&gt;rx_ring
(braket
id|i
)braket
op_assign
(paren
id|rx_packet
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
l_int|NULL
comma
id|METH_RX_BUFF_SIZE
comma
op_amp
(paren
id|priv-&gt;rx_ring_dmas
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* I&squot;ll need to re-sync it after each RX */
id|DPRINTK
c_func
(paren
l_string|&quot;&bslash;t%p&bslash;n&quot;
comma
id|priv-&gt;rx_ring
(braket
id|i
)braket
)paren
suffix:semicolon
id|priv-&gt;regs-&gt;rx_fifo
op_assign
id|priv-&gt;rx_ring_dmas
(braket
id|i
)braket
suffix:semicolon
)brace
id|priv-&gt;rx_write
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Done with RX ring&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|meth_free_tx_ring
r_static
r_void
id|meth_free_tx_ring
c_func
(paren
id|meth_private
op_star
id|priv
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Remove any pending skb */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;tx_skbs
(braket
id|i
)braket
)paren
id|dev_kfree_skb
c_func
(paren
id|priv-&gt;tx_skbs
(braket
id|i
)braket
)paren
suffix:semicolon
id|priv-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
l_int|NULL
comma
id|TX_RING_BUFFER_SIZE
comma
id|priv-&gt;tx_ring
comma
id|priv-&gt;tx_ring_dma
)paren
suffix:semicolon
)brace
DECL|function|meth_free_rx_ring
r_static
r_void
id|meth_free_rx_ring
c_func
(paren
id|meth_private
op_star
id|priv
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_free_consistent
c_func
(paren
l_int|NULL
comma
id|METH_RX_BUFF_SIZE
comma
id|priv-&gt;rx_ring
(braket
id|i
)braket
comma
id|priv-&gt;rx_ring_dmas
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|meth_reset
r_int
id|meth_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Reset card */
id|priv-&gt;regs-&gt;mac_ctrl
op_assign
id|SGI_MAC_RESET
suffix:semicolon
id|priv-&gt;regs-&gt;mac_ctrl
op_assign
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;MAC control after reset: %016lx&bslash;n&quot;
comma
id|priv-&gt;regs-&gt;mac_ctrl
)paren
suffix:semicolon
multiline_comment|/* Load ethernet address */
id|load_eaddr
c_func
(paren
id|dev
comma
id|priv-&gt;regs
)paren
suffix:semicolon
multiline_comment|/* Should load some &quot;errata&quot;, but later */
multiline_comment|/* Check for device */
r_if
c_cond
(paren
id|mdio_probe
c_func
(paren
id|priv
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Unable to find PHY&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Initial mode -- 10|Half-duplex|Accept normal packets */
id|priv-&gt;mode
op_assign
id|METH_ACCEPT_MCAST
op_or
id|METH_DEFAULT_IPG
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_or
id|IFF_PROMISC
)paren
(brace
id|priv-&gt;mode
op_or_assign
id|METH_PROMISC
suffix:semicolon
)brace
id|priv-&gt;regs-&gt;mac_ctrl
op_assign
id|priv-&gt;mode
suffix:semicolon
multiline_comment|/* Autonegociate speed and duplex mode */
id|meth_check_link
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Now set dma control, but don&squot;t enable DMA, yet */
id|priv-&gt;regs-&gt;dma_ctrl
op_assign
(paren
l_int|4
op_lshift
id|METH_RX_OFFSET_SHIFT
)paren
op_or
(paren
id|RX_RING_ENTRIES
op_lshift
id|METH_RX_DEPTH_SHIFT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============End Helper Routines=====================*/
multiline_comment|/*&n; * Open and close&n; */
DECL|function|meth_open
r_int
id|meth_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|meth_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|meth_regs
op_star
id|regs
op_assign
id|priv-&gt;regs
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/* Start DMA */
id|regs-&gt;dma_ctrl
op_or_assign
id|METH_DMA_TX_EN
op_or
multiline_comment|/*METH_DMA_TX_INT_EN|*/
id|METH_DMA_RX_EN
op_or
id|METH_DMA_RX_INT_EN
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|meth_interrupt
comma
id|SA_SHIRQ
comma
id|meth_str
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Opened... DMA control=0x%08lx&bslash;n&quot;
comma
id|regs-&gt;dma_ctrl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|meth_release
r_int
id|meth_release
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* can&squot;t transmit any more */
multiline_comment|/* shut down dma */
(paren
(paren
id|meth_private
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|regs-&gt;dma_ctrl
op_and_assign
op_complement
(paren
id|METH_DMA_TX_EN
op_or
id|METH_DMA_TX_INT_EN
op_or
id|METH_DMA_RX_EN
op_or
id|METH_DMA_RX_INT_EN
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Configuration changes (passed on by ifconfig)&n; */
DECL|function|meth_config
r_int
id|meth_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
multiline_comment|/* can&squot;t act on a running interface */
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Don&squot;t allow changing the I/O address */
r_if
c_cond
(paren
id|map-&gt;base_addr
op_ne
id|dev-&gt;base_addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: Can&squot;t change I/O address&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/* Allow changing the IRQ */
r_if
c_cond
(paren
id|map-&gt;irq
op_ne
id|dev-&gt;irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: Can&squot;t change IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configured&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ignore other fields */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive a packet: retrieve, encapsulate and pass over to upper levels&n; */
DECL|function|meth_rx
r_void
id|meth_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|rx_packet
op_star
id|rxb
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;RX...&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// TEMP&t;while((rxb=priv-&gt;rx_ring[priv-&gt;rx_write])-&gt;status.raw&amp;0x8000000000000000){
r_while
c_loop
(paren
(paren
id|rxb
op_assign
id|priv-&gt;rx_ring
(braket
id|priv-&gt;rx_write
)braket
)paren
op_member_access_from_pointer
id|status.raw
op_amp
l_int|0x8000000000000000
)paren
(brace
r_int
id|len
op_assign
id|rxb-&gt;status.parsed.rx_len
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* omit CRC */
id|DPRINTK
c_func
(paren
l_string|&quot;(%i)&bslash;n&quot;
comma
id|priv-&gt;rx_write
)paren
suffix:semicolon
multiline_comment|/* length sanity check */
r_if
c_cond
(paren
id|len
template_param
l_int|1518
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: bogus packet size: %d, status=%#2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|priv-&gt;rx_write
comma
id|rxb-&gt;status.raw
)paren
suffix:semicolon
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rxb-&gt;status.raw
op_amp
id|METH_RX_STATUS_ERRORS
)paren
)paren
(brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/* Should be atomic -- we are in interrupt */
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
multiline_comment|/* Ouch! No memory! Drop packet on the floor */
id|DPRINTK
c_func
(paren
l_string|&quot;!!!&gt;&gt;&gt;Ouch! Not enough Memory for RX buffer!&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* align IP on 16B boundary */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|rxb-&gt;buf
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Write metadata, and then pass to the receive level */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
singleline_comment|//skb-&gt;ip_summed = CHECKSUM_UNNECESSARY; /* don&squot;t check it */
id|DPRINTK
c_func
(paren
l_string|&quot;passing packet&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;len = %d rxb-&gt;status = %x&bslash;n&quot;
comma
id|len
comma
id|rxb-&gt;status.raw
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;There we go... Whew...&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|priv-&gt;regs-&gt;rx_fifo
op_assign
id|priv-&gt;rx_ring_dmas
(braket
id|priv-&gt;rx_write
)braket
suffix:semicolon
id|rxb-&gt;status.raw
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rx_write
op_assign
(paren
id|priv-&gt;rx_write
op_plus
l_int|1
)paren
op_amp
(paren
id|RX_RING_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|meth_tx_full
r_static
r_int
id|meth_tx_full
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
id|priv-&gt;tx_count
op_ge
id|TX_RING_ENTRIES
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|meth_tx_cleanup
r_void
id|meth_tx_cleanup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|rptr
)paren
(brace
id|meth_private
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|tx_packet
op_star
id|status
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
multiline_comment|/* Stop DMA */
id|priv-&gt;regs-&gt;dma_ctrl
op_and_assign
op_complement
(paren
id|METH_DMA_TX_INT_EN
)paren
suffix:semicolon
r_while
c_loop
(paren
id|priv-&gt;tx_read
op_ne
id|rptr
)paren
(brace
id|skb
op_assign
id|priv-&gt;tx_skbs
(braket
id|priv-&gt;tx_read
)braket
suffix:semicolon
id|status
op_assign
op_amp
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_read
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status-&gt;header.res.sent
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status-&gt;header.raw
op_amp
id|METH_TX_STATUS_DONE
)paren
(brace
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;tx_skbs
(braket
id|priv-&gt;tx_read
)braket
op_assign
l_int|NULL
suffix:semicolon
id|status-&gt;header.raw
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;tx_read
op_assign
(paren
id|priv-&gt;tx_read
op_plus
l_int|1
)paren
op_amp
(paren
id|TX_RING_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
id|priv-&gt;tx_count
op_decrement
suffix:semicolon
)brace
multiline_comment|/* wake up queue if it was stopped */
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
op_logical_neg
id|meth_tx_full
c_func
(paren
id|dev
)paren
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
id|priv-&gt;meth_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The typical interrupt entry point&n; */
DECL|function|meth_interrupt
r_void
id|meth_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|pregs
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
suffix:semicolon
r_union
(brace
id|u32
id|reg
suffix:semicolon
multiline_comment|/*Whole status register */
r_struct
(brace
id|u32
suffix:colon
l_int|2
comma
id|rx_seq
suffix:colon
l_int|5
comma
id|tx_read
suffix:colon
l_int|9
comma
id|rx_read
suffix:colon
l_int|8
comma
id|int_mask
suffix:colon
l_int|8
suffix:semicolon
)brace
id|parsed
suffix:semicolon
)brace
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * As usual, check the &quot;device&quot; pointer for shared handlers.&n;&t; * Then assign &quot;struct device *dev&quot;&n;&t; */
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
multiline_comment|/* ... and check with hw if it&squot;s really ours */
r_if
c_cond
(paren
op_logical_neg
id|dev
multiline_comment|/*paranoid*/
)paren
r_return
suffix:semicolon
multiline_comment|/* Lock the device */
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|status.reg
op_assign
id|priv-&gt;regs-&gt;int_flags
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Interrupt, status %08x...&bslash;n&quot;
comma
id|status.reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.parsed.int_mask
op_amp
id|METH_INT_RX_THRESHOLD
)paren
(brace
multiline_comment|/* send it to meth_rx for handling */
id|meth_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status.parsed.int_mask
op_amp
(paren
id|METH_INT_TX_EMPTY
op_or
id|METH_INT_TX_PKT
)paren
)paren
(brace
multiline_comment|/* a transmission is over: free the skb */
id|meth_tx_cleanup
c_func
(paren
id|dev
comma
id|status.parsed.tx_read
)paren
suffix:semicolon
)brace
multiline_comment|/* check for errors too... */
r_if
c_cond
(paren
id|status.parsed.int_mask
op_amp
(paren
id|METH_INT_TX_LINK_FAIL
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: link failure&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.parsed.int_mask
op_amp
(paren
id|METH_INT_MEM_ERROR
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: memory error&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.parsed.int_mask
op_amp
(paren
id|METH_INT_TX_ABORT
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;meth: aborted&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Interrupt handling done...&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;regs-&gt;int_flags
op_assign
id|status.reg
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* clear interrupts */
)brace
multiline_comment|/*&n; * Transmits packets that fit into TX descriptor (are &lt;=120B)&n; */
DECL|function|meth_tx_short_prepare
r_static
r_void
id|meth_tx_short_prepare
c_func
(paren
id|meth_private
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|tx_packet
op_star
id|desc
op_assign
op_amp
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_write
)braket
suffix:semicolon
r_int
id|len
op_assign
(paren
id|skb-&gt;len
OL
id|ETH_ZLEN
)paren
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skb-&gt;len
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;preparing short packet&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* maybe I should set whole thing to 0 first... */
id|memcpy
c_func
(paren
id|desc-&gt;data.dt
op_plus
(paren
l_int|120
op_minus
id|len
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
id|len
)paren
(brace
id|memset
c_func
(paren
id|desc-&gt;data.dt
op_plus
l_int|120
op_minus
id|len
op_plus
id|skb-&gt;len
comma
l_int|0
comma
id|len
op_minus
id|skb-&gt;len
)paren
suffix:semicolon
)brace
id|desc-&gt;header.raw
op_assign
id|METH_TX_CMD_INT_EN
op_or
(paren
id|len
op_minus
l_int|1
)paren
op_or
(paren
(paren
l_int|128
op_minus
id|len
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;desc=%016lx&bslash;n&quot;
comma
id|desc-&gt;header.raw
)paren
suffix:semicolon
)brace
DECL|macro|TX_CATBUF1
mdefine_line|#define TX_CATBUF1 BIT(25)
DECL|function|meth_tx_1page_prepare
r_static
r_void
id|meth_tx_1page_prepare
c_func
(paren
id|meth_private
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|tx_packet
op_star
id|desc
op_assign
op_amp
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_write
)braket
suffix:semicolon
r_void
op_star
id|buffer_data
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
id|u64
)paren
id|skb-&gt;data
op_plus
l_int|7ULL
)paren
op_amp
(paren
op_complement
l_int|7ULL
)paren
)paren
suffix:semicolon
r_int
id|unaligned_len
op_assign
(paren
r_int
)paren
(paren
(paren
id|u64
)paren
id|buffer_data
op_minus
(paren
id|u64
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_int
id|buffer_len
op_assign
id|skb-&gt;len
op_minus
id|unaligned_len
suffix:semicolon
id|dma_addr_t
id|catbuf
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;preparing 1 page...&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;length=%d data=%p&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|skb-&gt;data
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;unaligned_len=%d&bslash;n&quot;
comma
id|unaligned_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;buffer_data=%p buffer_len=%d&bslash;n&quot;
comma
id|buffer_data
comma
id|buffer_len
)paren
suffix:semicolon
id|desc-&gt;header.raw
op_assign
id|METH_TX_CMD_INT_EN
op_or
id|TX_CATBUF1
op_or
(paren
id|skb-&gt;len
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* unaligned part */
r_if
c_cond
(paren
id|unaligned_len
)paren
(brace
id|memcpy
c_func
(paren
id|desc-&gt;data.dt
op_plus
(paren
l_int|120
op_minus
id|unaligned_len
)paren
comma
id|skb-&gt;data
comma
id|unaligned_len
)paren
suffix:semicolon
id|desc-&gt;header.raw
op_or_assign
(paren
l_int|128
op_minus
id|unaligned_len
)paren
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* first page */
id|catbuf
op_assign
id|pci_map_single
c_func
(paren
l_int|NULL
comma
id|buffer_data
comma
id|buffer_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;catbuf=%x&bslash;n&quot;
comma
id|catbuf
)paren
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|form.start_addr
op_assign
id|catbuf
op_rshift
l_int|3
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|form.len
op_assign
id|buffer_len
op_minus
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;desc=%016lx&bslash;n&quot;
comma
id|desc-&gt;header.raw
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;cat_buf[0].raw=%016lx&bslash;n&quot;
comma
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|raw
)paren
suffix:semicolon
)brace
DECL|macro|TX_CATBUF2
mdefine_line|#define TX_CATBUF2 BIT(26)
DECL|function|meth_tx_2page_prepare
r_static
r_void
id|meth_tx_2page_prepare
c_func
(paren
id|meth_private
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|tx_packet
op_star
id|desc
op_assign
op_amp
id|priv-&gt;tx_ring
(braket
id|priv-&gt;tx_write
)braket
suffix:semicolon
r_void
op_star
id|buffer1_data
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
id|u64
)paren
id|skb-&gt;data
op_plus
l_int|7ULL
)paren
op_amp
(paren
op_complement
l_int|7ULL
)paren
)paren
suffix:semicolon
r_void
op_star
id|buffer2_data
op_assign
(paren
r_void
op_star
)paren
id|PAGE_ALIGN
c_func
(paren
(paren
id|u64
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_int
id|unaligned_len
op_assign
(paren
r_int
)paren
(paren
(paren
id|u64
)paren
id|buffer1_data
op_minus
(paren
id|u64
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_int
id|buffer1_len
op_assign
(paren
r_int
)paren
(paren
(paren
id|u64
)paren
id|buffer2_data
op_minus
(paren
id|u64
)paren
id|buffer1_data
)paren
suffix:semicolon
r_int
id|buffer2_len
op_assign
id|skb-&gt;len
op_minus
id|buffer1_len
op_minus
id|unaligned_len
suffix:semicolon
id|dma_addr_t
id|catbuf1
comma
id|catbuf2
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;preparing 2 pages... &bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;length=%d data=%p&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|skb-&gt;data
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;unaligned_len=%d&bslash;n&quot;
comma
id|unaligned_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;buffer1_data=%p buffer1_len=%d&bslash;n&quot;
comma
id|buffer1_data
comma
id|buffer1_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;buffer2_data=%p buffer2_len=%d&bslash;n&quot;
comma
id|buffer2_data
comma
id|buffer2_len
)paren
suffix:semicolon
id|desc-&gt;header.raw
op_assign
id|METH_TX_CMD_INT_EN
op_or
id|TX_CATBUF1
op_or
id|TX_CATBUF2
op_or
(paren
id|skb-&gt;len
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* unaligned part */
r_if
c_cond
(paren
id|unaligned_len
)paren
(brace
id|memcpy
c_func
(paren
id|desc-&gt;data.dt
op_plus
(paren
l_int|120
op_minus
id|unaligned_len
)paren
comma
id|skb-&gt;data
comma
id|unaligned_len
)paren
suffix:semicolon
id|desc-&gt;header.raw
op_or_assign
(paren
l_int|128
op_minus
id|unaligned_len
)paren
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* first page */
id|catbuf1
op_assign
id|pci_map_single
c_func
(paren
l_int|NULL
comma
id|buffer1_data
comma
id|buffer1_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;catbuf1=%x&bslash;n&quot;
comma
id|catbuf1
)paren
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|form.start_addr
op_assign
id|catbuf1
op_rshift
l_int|3
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|form.len
op_assign
id|buffer1_len
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* second page */
id|catbuf2
op_assign
id|pci_map_single
c_func
(paren
l_int|NULL
comma
id|buffer2_data
comma
id|buffer2_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;catbuf2=%x&bslash;n&quot;
comma
id|catbuf2
)paren
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|1
)braket
dot
id|form.start_addr
op_assign
id|catbuf2
op_rshift
l_int|3
suffix:semicolon
id|desc-&gt;data.cat_buf
(braket
l_int|1
)braket
dot
id|form.len
op_assign
id|buffer2_len
op_minus
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;desc=%016lx&bslash;n&quot;
comma
id|desc-&gt;header.raw
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;cat_buf[0].raw=%016lx&bslash;n&quot;
comma
id|desc-&gt;data.cat_buf
(braket
l_int|0
)braket
dot
id|raw
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;cat_buf[1].raw=%016lx&bslash;n&quot;
comma
id|desc-&gt;data.cat_buf
(braket
l_int|1
)braket
dot
id|raw
)paren
suffix:semicolon
)brace
DECL|function|meth_add_to_tx_ring
r_void
id|meth_add_to_tx_ring
c_func
(paren
id|meth_private
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Transmitting data...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_le
l_int|120
)paren
(brace
multiline_comment|/* Whole packet fits into descriptor */
id|meth_tx_short_prepare
c_func
(paren
id|priv
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|PAGE_ALIGN
c_func
(paren
(paren
id|u64
)paren
id|skb-&gt;data
)paren
op_ne
id|PAGE_ALIGN
c_func
(paren
(paren
id|u64
)paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Packet crosses page boundary */
id|meth_tx_2page_prepare
c_func
(paren
id|priv
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Packet is in one page */
id|meth_tx_1page_prepare
c_func
(paren
id|priv
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Remember the skb, so we can free it at interrupt time */
id|priv-&gt;tx_skbs
(braket
id|priv-&gt;tx_write
)braket
op_assign
id|skb
suffix:semicolon
id|priv-&gt;tx_write
op_assign
(paren
id|priv-&gt;tx_write
op_plus
l_int|1
)paren
op_amp
(paren
id|TX_RING_ENTRIES
op_minus
l_int|1
)paren
suffix:semicolon
id|priv-&gt;regs-&gt;tx_info.wptr
op_assign
id|priv-&gt;tx_write
suffix:semicolon
id|priv-&gt;tx_count
op_increment
suffix:semicolon
multiline_comment|/* Enable DMA transfer */
id|priv-&gt;regs-&gt;dma_ctrl
op_or_assign
id|METH_DMA_TX_INT_EN
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit a packet (called by the kernel)&n; */
DECL|function|meth_tx
r_int
id|meth_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
id|meth_add_to_tx_ring
c_func
(paren
id|priv
comma
id|skb
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* save the timestamp */
multiline_comment|/* If TX ring is full, tell the upper layer to stop sending packets */
r_if
c_cond
(paren
id|meth_tx_full
c_func
(paren
id|dev
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;TX full: stopping&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Deal with a transmit timeout.&n; */
DECL|function|meth_tx_timeout
r_void
id|meth_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Protect against concurrent rx interrupts */
id|spin_lock_irq
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
multiline_comment|/* Try to reset the adaptor. */
id|meth_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Clear all rings */
id|meth_free_tx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|meth_free_rx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|meth_init_tx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|meth_init_rx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
multiline_comment|/* Restart dma */
id|priv-&gt;regs-&gt;dma_ctrl
op_or_assign
id|METH_DMA_TX_EN
op_or
id|METH_DMA_RX_EN
op_or
id|METH_DMA_RX_INT_EN
suffix:semicolon
multiline_comment|/* Enable interrupt */
id|spin_unlock_irq
c_func
(paren
op_amp
id|priv-&gt;meth_lock
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Ioctl commands &n; */
DECL|function|meth_ioctl
r_int
id|meth_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ioctl&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Return statistics to the caller&n; */
DECL|function|meth_stats
r_struct
id|net_device_stats
op_star
id|meth_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|meth_private
op_star
id|priv
op_assign
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * The init function (sometimes called probe).&n; * It is invoked by register_netdev()&n; */
DECL|function|meth_init
r_int
id|meth_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|meth_private
op_star
id|priv
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* &n;&t; * Then, assign other fields in dev, using ether_setup() and some&n;&t; * hand assignments&n;&t; */
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* assign some of the fields */
id|dev-&gt;open
op_assign
id|meth_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|meth_release
suffix:semicolon
id|dev-&gt;set_config
op_assign
id|meth_config
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|meth_tx
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|meth_ioctl
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|meth_stats
suffix:semicolon
macro_line|#ifdef HAVE_TX_TIMEOUT
id|dev-&gt;tx_timeout
op_assign
id|meth_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|timeout
suffix:semicolon
macro_line|#endif
id|dev-&gt;irq
op_assign
id|MACE_ETHERNET_IRQ
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Then, allocate the priv field. This encloses the statistics&n;&t; * and a few private fields.&n;&t; */
id|priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|meth_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;priv
op_assign
id|priv
suffix:semicolon
id|memset
c_func
(paren
id|priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|meth_private
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
(paren
(paren
r_struct
id|meth_private
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|meth_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Make the usual checks: check_region(), probe irq, ...  -ENODEV&n;&t; * should be returned if no device found.  No resource should be&n;&t; * grabbed: this is done on open(). &n;&t; */
id|priv-&gt;regs
op_assign
(paren
id|meth_regs
op_star
)paren
id|SGI_MFE
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|SGI_MFE
suffix:semicolon
id|priv-&gt;phy_addr
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* No phy is known yet... */
multiline_comment|/* Initialize the hardware */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|meth_reset
c_func
(paren
id|dev
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Allocate the ring buffers */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|meth_init_tx_ring
c_func
(paren
id|priv
)paren
)paren
OL
l_int|0
op_logical_or
(paren
id|ret
op_assign
id|meth_init_rx_ring
c_func
(paren
id|priv
)paren
)paren
OL
l_int|0
)paren
(brace
id|meth_free_tx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
id|meth_free_rx_ring
c_func
(paren
id|priv
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;SGI O2 Fast Ethernet rev. %ld&bslash;n&quot;
comma
id|priv-&gt;regs-&gt;mac_ctrl
op_rshift
l_int|29
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The devices&n; */
DECL|variable|meth_devs
r_struct
id|net_device
id|meth_devs
(braket
l_int|1
)braket
op_assign
(brace
(brace
id|init
suffix:colon
id|meth_init
comma
)brace
multiline_comment|/* init, nothing more */
)brace
suffix:semicolon
multiline_comment|/*&n; * Finally, the module stuff&n; */
DECL|function|meth_init_module
r_int
id|meth_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|result
comma
id|device_present
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|meth_devs
(braket
l_int|0
)braket
dot
id|name
comma
l_string|&quot;eth%d&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|register_netdev
c_func
(paren
id|meth_devs
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;meth: error %i registering device &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|result
comma
id|meth_devs-&gt;name
)paren
suffix:semicolon
r_else
id|device_present
op_increment
suffix:semicolon
r_return
id|device_present
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|meth_cleanup
r_void
id|meth_cleanup
c_func
(paren
r_void
)paren
(brace
id|kfree
c_func
(paren
id|meth_devs-&gt;priv
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|meth_devs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|meth_init_module
id|module_init
c_func
(paren
id|meth_init_module
)paren
suffix:semicolon
DECL|variable|meth_cleanup
id|module_exit
c_func
(paren
id|meth_cleanup
)paren
suffix:semicolon
eof
