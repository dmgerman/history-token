multiline_comment|/* hplance.c  : the  Linux/hp300/lance ethernet driver&n; *&n; * Copyright (C) 05/1998 Peter Maydell &lt;pmaydell@chiark.greenend.org.uk&gt;&n; * Based on the Sun Lance driver and the NetBSD HP Lance driver&n; * Uses the generic 7990.c LANCE code.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
multiline_comment|/* Used for the temporal inet entries and routing */
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/dio.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;hplance.h&quot;
multiline_comment|/* We have 16834 bytes of RAM for the init block and buffers. This places&n; * an upper limit on the number of buffers we can use. NetBSD uses 8 Rx&n; * buffers and 2 Tx buffers.&n; */
DECL|macro|LANCE_LOG_TX_BUFFERS
mdefine_line|#define LANCE_LOG_TX_BUFFERS 1
DECL|macro|LANCE_LOG_RX_BUFFERS
mdefine_line|#define LANCE_LOG_RX_BUFFERS 3
macro_line|#include &quot;7990.h&quot;                                 /* use generic LANCE code */
multiline_comment|/* Our private data structure */
DECL|struct|hplance_private
r_struct
id|hplance_private
(brace
DECL|member|lance
r_struct
id|lance_private
id|lance
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* function prototypes... This is easy because all the grot is in the&n; * generic LANCE support. All we have to support is probing for boards,&n; * plus board-specific init, open and close actions. &n; * Oh, and we need to tell the generic code how to read and write LANCE registers...&n; */
r_static
r_int
id|__devinit
id|hplance_init_one
c_func
(paren
r_struct
id|dio_dev
op_star
id|d
comma
r_const
r_struct
id|dio_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
r_void
id|__devinit
id|hplance_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dio_dev
op_star
id|d
)paren
suffix:semicolon
r_static
r_void
id|__devexit
id|hplance_remove_one
c_func
(paren
r_struct
id|dio_dev
op_star
id|d
)paren
suffix:semicolon
r_static
r_void
id|hplance_writerap
c_func
(paren
r_void
op_star
id|priv
comma
r_int
r_int
id|value
)paren
suffix:semicolon
r_static
r_void
id|hplance_writerdp
c_func
(paren
r_void
op_star
id|priv
comma
r_int
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
r_int
id|hplance_readrdp
c_func
(paren
r_void
op_star
id|priv
)paren
suffix:semicolon
r_static
r_int
id|hplance_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|hplance_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|hplance_dio_tbl
r_static
r_struct
id|dio_device_id
id|hplance_dio_tbl
(braket
)braket
op_assign
(brace
(brace
id|DIO_ID_LAN
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|hplance_driver
r_static
r_struct
id|dio_driver
id|hplance_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;hplance&quot;
comma
dot
id|id_table
op_assign
id|hplance_dio_tbl
comma
dot
id|probe
op_assign
id|hplance_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|hplance_remove_one
)paren
comma
)brace
suffix:semicolon
multiline_comment|/* Find all the HP Lance boards and initialise them... */
DECL|function|hplance_init_one
r_static
r_int
id|__devinit
id|hplance_init_one
c_func
(paren
r_struct
id|dio_dev
op_star
id|d
comma
r_const
r_struct
id|dio_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|hplance_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|dio_resource_start
c_func
(paren
id|d
)paren
comma
id|dio_resource_len
c_func
(paren
id|d
)paren
comma
id|d-&gt;name
)paren
)paren
r_goto
id|out_free_netdev
suffix:semicolon
id|hplance_init
c_func
(paren
id|dev
comma
id|d
)paren
suffix:semicolon
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_release_mem_region
suffix:semicolon
id|dio_set_drvdata
c_func
(paren
id|d
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_release_mem_region
suffix:colon
id|release_mem_region
c_func
(paren
id|dio_resource_start
c_func
(paren
id|d
)paren
comma
id|dio_resource_len
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
id|out_free_netdev
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|hplance_remove_one
r_static
r_void
id|__devexit
id|hplance_remove_one
c_func
(paren
r_struct
id|dio_dev
op_star
id|d
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dio_get_drvdata
c_func
(paren
id|d
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|dio_resource_start
c_func
(paren
id|d
)paren
comma
id|dio_resource_len
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialise a single lance board at the given DIO device */
DECL|function|hplance_init
r_static
r_void
id|__init
id|hplance_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|dio_dev
op_star
id|d
)paren
(brace
r_int
r_int
id|va
op_assign
(paren
id|d-&gt;resource.start
op_plus
id|DIO_VIRADDRBASE
)paren
suffix:semicolon
r_struct
id|hplance_private
op_star
id|lp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s; select code %d, addr&quot;
comma
id|dev-&gt;name
comma
id|d-&gt;name
comma
id|d-&gt;scode
)paren
suffix:semicolon
multiline_comment|/* reset the board */
id|out_8
c_func
(paren
id|va
op_plus
id|DIO_IDOFF
comma
l_int|0xff
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* ariba! ariba! udelay! udelay! */
multiline_comment|/* Fill the dev fields */
id|dev-&gt;base_addr
op_assign
id|va
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|hplance_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|hplance_close
suffix:semicolon
macro_line|#ifdef CONFIG_NET_POLL_CONTROLLER
id|dev-&gt;poll_controller
op_assign
id|lance_poll
suffix:semicolon
macro_line|#endif
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|lance_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|lance_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|lance_set_multicast
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* The NVRAM holds our ethernet address, one nibble per byte,&n;                 * at bytes NVRAMOFF+1,3,5,7,9...&n;                 */
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
(paren
(paren
id|in_8
c_func
(paren
id|va
op_plus
id|HPLANCE_NVRAMOFF
op_plus
id|i
op_star
l_int|4
op_plus
l_int|1
)paren
op_amp
l_int|0xF
)paren
op_lshift
l_int|4
)paren
op_or
(paren
id|in_8
c_func
(paren
id|va
op_plus
id|HPLANCE_NVRAMOFF
op_plus
id|i
op_star
l_int|4
op_plus
l_int|3
)paren
op_amp
l_int|0xF
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%c%2.2x&quot;
comma
id|i
op_eq
l_int|0
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|lp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lp-&gt;lance.name
op_assign
(paren
r_char
op_star
)paren
id|d-&gt;name
suffix:semicolon
multiline_comment|/* discards const, shut up gcc */
id|lp-&gt;lance.base
op_assign
id|va
suffix:semicolon
id|lp-&gt;lance.init_block
op_assign
(paren
r_struct
id|lance_init_block
op_star
)paren
(paren
id|va
op_plus
id|HPLANCE_MEMOFF
)paren
suffix:semicolon
multiline_comment|/* CPU addr */
id|lp-&gt;lance.lance_init_block
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* LANCE addr of same RAM */
id|lp-&gt;lance.busmaster_regval
op_assign
id|LE_C3_BSWP
suffix:semicolon
multiline_comment|/* we&squot;re bigendian */
id|lp-&gt;lance.irq
op_assign
id|d-&gt;ipl
suffix:semicolon
id|lp-&gt;lance.writerap
op_assign
id|hplance_writerap
suffix:semicolon
id|lp-&gt;lance.writerdp
op_assign
id|hplance_writerdp
suffix:semicolon
id|lp-&gt;lance.readrdp
op_assign
id|hplance_readrdp
suffix:semicolon
id|lp-&gt;lance.lance_log_rx_bufs
op_assign
id|LANCE_LOG_RX_BUFFERS
suffix:semicolon
id|lp-&gt;lance.lance_log_tx_bufs
op_assign
id|LANCE_LOG_TX_BUFFERS
suffix:semicolon
id|lp-&gt;lance.rx_ring_mod_mask
op_assign
id|RX_RING_MOD_MASK
suffix:semicolon
id|lp-&gt;lance.tx_ring_mod_mask
op_assign
id|TX_RING_MOD_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, irq %d&bslash;n&quot;
comma
id|lp-&gt;lance.irq
)paren
suffix:semicolon
)brace
multiline_comment|/* This is disgusting. We have to check the DIO status register for ack every&n; * time we read or write the LANCE registers.&n; */
DECL|function|hplance_writerap
r_static
r_void
id|hplance_writerap
c_func
(paren
r_void
op_star
id|priv
comma
r_int
r_int
id|value
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|priv
suffix:semicolon
r_do
(brace
id|out_be16
c_func
(paren
id|lp-&gt;base
op_plus
id|HPLANCE_REGOFF
op_plus
id|LANCE_RAP
comma
id|value
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
id|lp-&gt;base
op_plus
id|HPLANCE_STATUS
)paren
op_amp
id|LE_ACK
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|hplance_writerdp
r_static
r_void
id|hplance_writerdp
c_func
(paren
r_void
op_star
id|priv
comma
r_int
r_int
id|value
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|priv
suffix:semicolon
r_do
(brace
id|out_be16
c_func
(paren
id|lp-&gt;base
op_plus
id|HPLANCE_REGOFF
op_plus
id|LANCE_RDP
comma
id|value
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
id|lp-&gt;base
op_plus
id|HPLANCE_STATUS
)paren
op_amp
id|LE_ACK
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|hplance_readrdp
r_static
r_int
r_int
id|hplance_readrdp
c_func
(paren
r_void
op_star
id|priv
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
(paren
r_struct
id|lance_private
op_star
)paren
id|priv
suffix:semicolon
id|__u16
id|value
suffix:semicolon
r_do
(brace
id|value
op_assign
id|in_be16
c_func
(paren
id|lp-&gt;base
op_plus
id|HPLANCE_REGOFF
op_plus
id|LANCE_RDP
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
id|lp-&gt;base
op_plus
id|HPLANCE_STATUS
)paren
op_amp
id|LE_ACK
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
DECL|function|hplance_open
r_static
r_int
id|hplance_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|status
suffix:semicolon
r_struct
id|lance_private
op_star
id|lp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|status
op_assign
id|lance_open
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* call generic lance open code */
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* enable interrupts at board level. */
id|out_8
c_func
(paren
id|lp-&gt;base
op_plus
id|HPLANCE_STATUS
comma
id|LE_IE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hplance_close
r_static
r_int
id|hplance_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lance_private
op_star
id|lp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|lp-&gt;base
op_plus
id|HPLANCE_STATUS
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable interrupts at boardlevel */
id|lance_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hplance_init_module
r_int
id|__init
id|hplance_init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|dio_module_init
c_func
(paren
op_amp
id|hplance_driver
)paren
suffix:semicolon
)brace
DECL|function|hplance_cleanup_module
r_void
id|__exit
id|hplance_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|dio_unregister_driver
c_func
(paren
op_amp
id|hplance_driver
)paren
suffix:semicolon
)brace
DECL|variable|hplance_init_module
id|module_init
c_func
(paren
id|hplance_init_module
)paren
suffix:semicolon
DECL|variable|hplance_cleanup_module
id|module_exit
c_func
(paren
id|hplance_cleanup_module
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
