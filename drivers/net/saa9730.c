multiline_comment|/*&n; * Carsten Langgaard, carstenl@mips.com&n; * Copyright (C) 2000 MIPS Technologies, Inc.  All rights reserved.&n; *&n; * ########################################################################&n; *&n; *  This program is free software; you can distribute it and/or modify it&n; *  under the terms of the GNU General Public License (Version 2) as&n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; *  for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * ########################################################################&n; *&n; * SAA9730 ethernet driver.&n; *&n; * Changes:&n; * Angelo Dell&squot;Aera &lt;buffer@antifork.org&gt; : Conversion to the new PCI API (pci_driver).&n; *                                          Conversion to spinlocks.&n; *                                          Error handling fixes.&n; *                                           &n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/mips-boards/prom.h&gt;
macro_line|#include &quot;saa9730.h&quot;
macro_line|#ifdef LAN_SAA9730_DEBUG
DECL|variable|lan_saa9730_debug
r_int
id|lan_saa9730_debug
op_assign
id|LAN_SAA9730_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|lan_saa9730_debug
r_int
id|lan_saa9730_debug
suffix:semicolon
macro_line|#endif
DECL|macro|DRV_MODULE_NAME
mdefine_line|#define DRV_MODULE_NAME &quot;saa9730&quot;
DECL|variable|saa9730_pci_tbl
r_static
r_struct
id|pci_device_id
id|saa9730_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_PHILIPS
comma
id|PCI_DEVICE_ID_PHILIPS_SAA9370
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0UL
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|saa9730_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* Non-zero only if the current card is a PCI with BIOS-set IRQ. */
DECL|variable|pci_irq_line
r_static
r_int
r_int
id|pci_irq_line
suffix:semicolon
DECL|macro|INL
mdefine_line|#define INL(a)     inl((unsigned long)a)
DECL|macro|OUTL
mdefine_line|#define OUTL(x,a)  outl(x,(unsigned long)a)
DECL|function|evm_saa9730_enable_lan_int
r_static
r_void
id|evm_saa9730_enable_lan_int
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
op_or
id|EVM_LAN_INT
comma
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
suffix:semicolon
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptStatus1
)paren
op_or
id|EVM_LAN_INT
comma
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptStatus1
)paren
suffix:semicolon
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptEnable1
)paren
op_or
id|EVM_LAN_INT
op_or
id|EVM_MASTER_EN
comma
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptEnable1
)paren
suffix:semicolon
)brace
DECL|function|evm_saa9730_disable_lan_int
r_static
r_void
id|evm_saa9730_disable_lan_int
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
op_amp
op_complement
id|EVM_LAN_INT
comma
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
suffix:semicolon
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptEnable1
)paren
op_amp
op_complement
id|EVM_LAN_INT
comma
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptEnable1
)paren
suffix:semicolon
)brace
DECL|function|evm_saa9730_clear_lan_int
r_static
r_void
id|evm_saa9730_clear_lan_int
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
id|OUTL
c_func
(paren
id|EVM_LAN_INT
comma
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptStatus1
)paren
suffix:semicolon
)brace
DECL|function|evm_saa9730_block_lan_int
r_static
r_void
id|evm_saa9730_block_lan_int
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
op_amp
op_complement
id|EVM_LAN_INT
comma
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
suffix:semicolon
)brace
DECL|function|evm_saa9730_unblock_lan_int
r_static
r_void
id|evm_saa9730_unblock_lan_int
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
op_or
id|EVM_LAN_INT
comma
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
suffix:semicolon
)brace
DECL|function|show_saa9730_regs
r_static
r_void
id|show_saa9730_regs
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TxmBufferA = %x&bslash;n&quot;
comma
id|lp-&gt;TxmBuffer
(braket
l_int|0
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TxmBufferB = %x&bslash;n&quot;
comma
id|lp-&gt;TxmBuffer
(braket
l_int|1
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RcvBufferA = %x&bslash;n&quot;
comma
id|lp-&gt;RcvBuffer
(braket
l_int|0
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RcvBufferB = %x&bslash;n&quot;
comma
id|lp-&gt;RcvBuffer
(braket
l_int|1
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|LAN_SAA9730_TXM_Q_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TxmBuffer[%d][%d] = %x&bslash;n&quot;
comma
id|i
comma
id|j
comma
id|le32_to_cpu
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|lp-&gt;TxmBuffer
(braket
id|i
)braket
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|LAN_SAA9730_RCV_Q_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RcvBuffer[%d][%d] = %x&bslash;n&quot;
comma
id|i
comma
id|j
comma
id|le32_to_cpu
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|lp-&gt;RcvBuffer
(braket
id|i
)braket
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1 = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptBlock1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;evm_saa9730_regs-&gt;InterruptStatus1 = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptStatus1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;evm_saa9730_regs-&gt;InterruptEnable1 = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;evm_saa9730_regs-&gt;InterruptEnable1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;Ok2Use = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;Ok2Use
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;NextTxmBufferIndex = %x&bslash;n&quot;
comma
id|lp-&gt;NextTxmBufferIndex
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;NextTxmPacketIndex = %x&bslash;n&quot;
comma
id|lp-&gt;NextTxmPacketIndex
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;PendingTxmBufferIndex = %x&bslash;n&quot;
comma
id|lp-&gt;PendingTxmBufferIndex
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;PendingTxmPacketIndex = %x&bslash;n&quot;
comma
id|lp-&gt;PendingTxmPacketIndex
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;LanDmaCtl = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;LanDmaCtl
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;DmaStatus = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DmaStatus
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;CamCtl = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamCtl
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;TxCtl = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;TxCtl
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;TxStatus = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;TxStatus
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;RxCtl = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;RxCtl
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;RxStatus = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;RxStatus
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_CAM_DWORDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OUTL
c_func
(paren
id|i
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamAddress
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;CamData = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamData
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.tx_packets = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.tx_packets
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.tx_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.tx_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.tx_aborted_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.tx_aborted_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.tx_window_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.tx_window_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.tx_carrier_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.tx_carrier_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.tx_fifo_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.tx_fifo_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.tx_heartbeat_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.tx_heartbeat_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.collisions = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.collisions
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.rx_packets = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.rx_packets
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.rx_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.rx_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.rx_dropped = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.rx_dropped
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.rx_crc_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.rx_crc_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.rx_frame_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.rx_frame_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.rx_fifo_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.rx_fifo_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;stats.rx_length_errors = %lx&bslash;n&quot;
comma
id|lp-&gt;stats.rx_length_errors
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;DebugPCIMasterAddr = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DebugPCIMasterAddr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;DebugLanTxStateMachine = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DebugLanTxStateMachine
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;DebugLanRxStateMachine = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DebugLanRxStateMachine
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;DebugLanTxFifoPointers = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DebugLanTxFifoPointers
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;DebugLanRxFifoPointers = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DebugLanRxFifoPointers
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp-&gt;lan_saa9730_regs-&gt;DebugLanCtlStateMachine = %x&bslash;n&quot;
comma
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DebugLanCtlStateMachine
)paren
)paren
suffix:semicolon
)brace
DECL|function|lan_saa9730_buffer_init
r_static
r_void
id|lan_saa9730_buffer_init
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* Init RX buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|LAN_SAA9730_RCV_Q_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
(paren
r_int
r_int
op_star
)paren
id|lp-&gt;RcvBuffer
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|RXSF_READY
op_lshift
id|RX_STAT_CTL_OWNER_SHF
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Init TX buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|LAN_SAA9730_TXM_Q_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
(paren
r_int
r_int
op_star
)paren
id|lp-&gt;TxmBuffer
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|TXSF_EMPTY
op_lshift
id|TX_STAT_CTL_OWNER_SHF
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|lan_saa9730_allocate_buffers
r_static
r_int
id|lan_saa9730_allocate_buffers
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
r_int
r_int
id|mem_size
suffix:semicolon
r_void
op_star
id|Pa
suffix:semicolon
r_int
r_int
id|i
comma
id|j
comma
id|RcvBufferSize
comma
id|TxmBufferSize
suffix:semicolon
r_int
r_int
id|buffer_start
suffix:semicolon
multiline_comment|/* &n;&t; * Allocate all RX and TX packets in one chunk. &n;&t; * The Rx and Tx packets must be PACKET_SIZE aligned.&n;&t; */
id|mem_size
op_assign
(paren
(paren
id|LAN_SAA9730_RCV_Q_SIZE
op_plus
id|LAN_SAA9730_TXM_Q_SIZE
)paren
op_star
id|LAN_SAA9730_PACKET_SIZE
op_star
id|LAN_SAA9730_BUFFERS
)paren
op_plus
id|LAN_SAA9730_PACKET_SIZE
suffix:semicolon
id|buffer_start
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|mem_size
comma
id|GFP_DMA
op_or
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer_start
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* &n;&t; * Set DMA buffer to kseg1 (uncached).&n;&t; * Make sure to flush before using it uncached.&n;&t; */
id|Pa
op_assign
(paren
r_void
op_star
)paren
id|KSEG1ADDR
c_func
(paren
(paren
id|buffer_start
op_plus
id|LAN_SAA9730_PACKET_SIZE
)paren
op_amp
op_complement
(paren
id|LAN_SAA9730_PACKET_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|Pa
comma
id|mem_size
)paren
suffix:semicolon
multiline_comment|/* Initialize buffer space */
id|RcvBufferSize
op_assign
id|LAN_SAA9730_PACKET_SIZE
suffix:semicolon
id|TxmBufferSize
op_assign
id|LAN_SAA9730_PACKET_SIZE
suffix:semicolon
id|lp-&gt;DmaRcvPackets
op_assign
id|LAN_SAA9730_RCV_Q_SIZE
suffix:semicolon
id|lp-&gt;DmaTxmPackets
op_assign
id|LAN_SAA9730_TXM_Q_SIZE
suffix:semicolon
multiline_comment|/* Init RX buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|LAN_SAA9730_RCV_Q_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
(paren
r_int
r_int
op_star
)paren
id|Pa
op_assign
id|cpu_to_le32
c_func
(paren
id|RXSF_READY
op_lshift
id|RX_STAT_CTL_OWNER_SHF
)paren
suffix:semicolon
id|lp-&gt;RcvBuffer
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
(paren
r_int
r_int
)paren
id|Pa
suffix:semicolon
id|Pa
op_add_assign
id|RcvBufferSize
suffix:semicolon
)brace
)brace
multiline_comment|/* Init TX buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|LAN_SAA9730_TXM_Q_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
(paren
r_int
r_int
op_star
)paren
id|Pa
op_assign
id|cpu_to_le32
c_func
(paren
id|TXSF_EMPTY
op_lshift
id|TX_STAT_CTL_OWNER_SHF
)paren
suffix:semicolon
id|lp-&gt;TxmBuffer
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
(paren
r_int
r_int
)paren
id|Pa
suffix:semicolon
id|Pa
op_add_assign
id|TxmBufferSize
suffix:semicolon
)brace
)brace
multiline_comment|/* &n;&t; * Set rx buffer A and rx buffer B to point to the first two buffer &n;&t; * spaces.&n;&t; */
id|OUTL
c_func
(paren
id|PHYSADDR
c_func
(paren
id|lp-&gt;RcvBuffer
(braket
l_int|0
)braket
(braket
l_int|0
)braket
)paren
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;RxBuffA
)paren
suffix:semicolon
id|OUTL
c_func
(paren
id|PHYSADDR
c_func
(paren
id|lp-&gt;RcvBuffer
(braket
l_int|1
)braket
(braket
l_int|0
)braket
)paren
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;RxBuffB
)paren
suffix:semicolon
multiline_comment|/* Initialize Buffer Index */
id|lp-&gt;NextRcvPacketIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;NextRcvToUseIsA
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set current buffer index &amp; next availble packet index */
id|lp-&gt;NextTxmPacketIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;NextTxmBufferIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;PendingTxmPacketIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;PendingTxmBufferIndex
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t; * Set txm_buf_a and txm_buf_b to point to the first two buffer&n;&t; * space &n;&t; */
id|OUTL
c_func
(paren
id|PHYSADDR
c_func
(paren
id|lp-&gt;TxmBuffer
(braket
l_int|0
)braket
(braket
l_int|0
)braket
)paren
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;TxBuffA
)paren
suffix:semicolon
id|OUTL
c_func
(paren
id|PHYSADDR
c_func
(paren
id|lp-&gt;TxmBuffer
(braket
l_int|1
)braket
(braket
l_int|0
)braket
)paren
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;TxBuffB
)paren
suffix:semicolon
multiline_comment|/* Set packet number */
id|OUTL
c_func
(paren
(paren
id|lp-&gt;DmaRcvPackets
op_lshift
id|PK_COUNT_RX_A_SHF
)paren
op_or
(paren
id|lp-&gt;DmaRcvPackets
op_lshift
id|PK_COUNT_RX_B_SHF
)paren
op_or
(paren
id|lp-&gt;DmaTxmPackets
op_lshift
id|PK_COUNT_TX_A_SHF
)paren
op_or
(paren
id|lp-&gt;DmaTxmPackets
op_lshift
id|PK_COUNT_TX_B_SHF
)paren
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;PacketCount
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_cam_load
r_static
r_int
id|lan_saa9730_cam_load
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|NetworkAddress
suffix:semicolon
id|NetworkAddress
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|lp-&gt;PhysicalAddress
(braket
l_int|0
)braket
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_CAM_DWORDS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* First set address to where data is written */
id|OUTL
c_func
(paren
id|i
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamAddress
)paren
suffix:semicolon
id|OUTL
c_func
(paren
(paren
id|NetworkAddress
(braket
l_int|0
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|NetworkAddress
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|NetworkAddress
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|NetworkAddress
(braket
l_int|3
)braket
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamData
)paren
suffix:semicolon
id|NetworkAddress
op_add_assign
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_cam_init
r_static
r_int
id|lan_saa9730_cam_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
multiline_comment|/* Copy MAC-address into all entries. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LAN_SAA9730_CAM_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|lp-&gt;PhysicalAddress
(braket
id|i
)braket
comma
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_mii_init
r_static
r_int
id|lan_saa9730_mii_init
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
r_int
id|i
comma
id|l
suffix:semicolon
multiline_comment|/* Check link status, spin here till station is not busy. */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtCtl
)paren
op_amp
id|MD_CA_BUSY
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|100
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Error: lan_saa9730_mii_init: timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait 1 ms. */
)brace
multiline_comment|/* Now set the control and address register. */
id|OUTL
c_func
(paren
id|MD_CA_BUSY
op_or
id|PHY_STATUS
op_or
id|PHY_ADDRESS
op_lshift
id|MD_CA_PHY_SHF
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtCtl
)paren
suffix:semicolon
multiline_comment|/* check link status, spin here till station is not busy */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtCtl
)paren
op_amp
id|MD_CA_BUSY
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|100
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Error: lan_saa9730_mii_init: timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait 1 ms. */
)brace
multiline_comment|/* Wait for 1 ms. */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Check the link status. */
r_if
c_cond
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtData
)paren
op_amp
id|PHY_STATUS_LINK_UP
)paren
(brace
multiline_comment|/* Link is up. */
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Link is down, reset the PHY first. */
multiline_comment|/* set PHY address = &squot;CONTROL&squot; */
id|OUTL
c_func
(paren
id|PHY_ADDRESS
op_lshift
id|MD_CA_PHY_SHF
op_or
id|MD_CA_WR
op_or
id|PHY_CONTROL
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtCtl
)paren
suffix:semicolon
multiline_comment|/* Wait for 1 ms. */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set &squot;CONTROL&squot; = force reset and renegotiate */
id|OUTL
c_func
(paren
id|PHY_CONTROL_RESET
op_or
id|PHY_CONTROL_AUTO_NEG
op_or
id|PHY_CONTROL_RESTART_AUTO_NEG
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtData
)paren
suffix:semicolon
multiline_comment|/* Wait for 50 ms. */
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* set &squot;BUSY&squot; to start operation */
id|OUTL
c_func
(paren
id|MD_CA_BUSY
op_or
id|PHY_ADDRESS
op_lshift
id|MD_CA_PHY_SHF
op_or
id|MD_CA_WR
op_or
id|PHY_CONTROL
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtCtl
)paren
suffix:semicolon
multiline_comment|/* await completion */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtCtl
)paren
op_amp
id|MD_CA_BUSY
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|100
)paren
(brace
id|printk
(paren
l_string|&quot;Error: lan_saa9730_mii_init: timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait 1 ms. */
)brace
multiline_comment|/* Wait for 1 ms. */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
multiline_comment|/* set PHY address = &squot;STATUS&squot; */
id|OUTL
c_func
(paren
id|MD_CA_BUSY
op_or
id|PHY_ADDRESS
op_lshift
id|MD_CA_PHY_SHF
op_or
id|PHY_STATUS
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtCtl
)paren
suffix:semicolon
multiline_comment|/* await completion */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtCtl
)paren
op_amp
id|MD_CA_BUSY
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|100
)paren
(brace
id|printk
(paren
l_string|&quot;Error: lan_saa9730_mii_init: timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait 1 ms. */
)brace
multiline_comment|/* wait for 3 sec. */
id|mdelay
c_func
(paren
l_int|3000
)paren
suffix:semicolon
multiline_comment|/* check the link status */
r_if
c_cond
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;StationMgmtData
)paren
op_amp
id|PHY_STATUS_LINK_UP
)paren
(brace
multiline_comment|/* link is up */
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_control_init
r_static
r_int
id|lan_saa9730_control_init
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
multiline_comment|/* Initialize DMA control register. */
id|OUTL
c_func
(paren
(paren
id|LANMB_ANY
op_lshift
id|DMA_CTL_MAX_XFER_SHF
)paren
op_or
(paren
id|LANEND_LITTLE
op_lshift
id|DMA_CTL_ENDIAN_SHF
)paren
op_or
(paren
id|LAN_SAA9730_RCV_Q_INT_THRESHOLD
op_lshift
id|DMA_CTL_RX_INT_COUNT_SHF
)paren
op_or
id|DMA_CTL_RX_INT_TO_EN
op_or
id|DMA_CTL_RX_INT_EN
op_or
id|DMA_CTL_MAC_RX_INT_EN
op_or
id|DMA_CTL_MAC_TX_INT_EN
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;LanDmaCtl
)paren
suffix:semicolon
multiline_comment|/* Initial MAC control register. */
id|OUTL
c_func
(paren
(paren
id|MACCM_MII
op_lshift
id|MAC_CONTROL_CONN_SHF
)paren
op_or
id|MAC_CONTROL_FULL_DUP
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;MacCtl
)paren
suffix:semicolon
multiline_comment|/* Initialize CAM control register. */
id|OUTL
c_func
(paren
id|CAM_CONTROL_COMP_EN
op_or
id|CAM_CONTROL_BROAD_ACC
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamCtl
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Initialize CAM enable register, only turn on first entry, should&n;&t; * contain own addr. &n;&t; */
id|OUTL
c_func
(paren
l_int|0x0001
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamEnable
)paren
suffix:semicolon
multiline_comment|/* Initialize Tx control register */
id|OUTL
c_func
(paren
id|TX_CTL_EN_COMP
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;TxCtl
)paren
suffix:semicolon
multiline_comment|/* Initialize Rcv control register */
id|OUTL
c_func
(paren
id|RX_CTL_STRIP_CRC
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;RxCtl
)paren
suffix:semicolon
multiline_comment|/* Reset DMA engine */
id|OUTL
c_func
(paren
id|DMA_TEST_SW_RESET
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DmaTest
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_stop
r_static
r_int
id|lan_saa9730_stop
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Stop DMA first */
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;LanDmaCtl
)paren
op_amp
op_complement
(paren
id|DMA_CTL_EN_TX_DMA
op_or
id|DMA_CTL_EN_RX_DMA
)paren
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;LanDmaCtl
)paren
suffix:semicolon
multiline_comment|/* Set the SW Reset bits in DMA and MAC control registers */
id|OUTL
c_func
(paren
id|DMA_TEST_SW_RESET
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DmaTest
)paren
suffix:semicolon
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;MacCtl
)paren
op_or
id|MAC_CONTROL_RESET
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;MacCtl
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Wait for MAC reset to have finished. The reset bit is auto cleared&n;&t; * when the reset is done.&n;&t; */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;MacCtl
)paren
op_amp
id|MAC_CONTROL_RESET
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|100
)paren
(brace
id|printk
(paren
l_string|&quot;Error: lan_sa9730_stop: MAC reset timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait 1 ms. */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_dma_init
r_static
r_int
id|lan_saa9730_dma_init
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
multiline_comment|/* Stop lan controller. */
id|lan_saa9730_stop
c_func
(paren
id|lp
)paren
suffix:semicolon
id|OUTL
c_func
(paren
id|LAN_SAA9730_DEFAULT_TIME_OUT_CNT
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;Timeout
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_start
r_static
r_int
id|lan_saa9730_start
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
id|lan_saa9730_buffer_init
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* Initialize Rx Buffer Index */
id|lp-&gt;NextRcvPacketIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;NextRcvToUseIsA
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set current buffer index &amp; next availble packet index */
id|lp-&gt;NextTxmPacketIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;NextTxmBufferIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;PendingTxmPacketIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;PendingTxmBufferIndex
op_assign
l_int|0
suffix:semicolon
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;LanDmaCtl
)paren
op_or
id|DMA_CTL_EN_TX_DMA
op_or
id|DMA_CTL_EN_RX_DMA
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;LanDmaCtl
)paren
suffix:semicolon
multiline_comment|/* For Tx, turn on MAC then DMA */
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;TxCtl
)paren
op_or
id|TX_CTL_TX_EN
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;TxCtl
)paren
suffix:semicolon
multiline_comment|/* For Rx, turn on DMA then MAC */
id|OUTL
c_func
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;RxCtl
)paren
op_or
id|RX_CTL_RX_EN
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;RxCtl
)paren
suffix:semicolon
multiline_comment|/* Set Ok2Use to let hardware owns the buffers */
id|OUTL
c_func
(paren
id|OK2USE_RX_A
op_or
id|OK2USE_RX_B
op_or
id|OK2USE_TX_A
op_or
id|OK2USE_TX_B
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;Ok2Use
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_restart
r_static
r_int
id|lan_saa9730_restart
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
)paren
(brace
id|lan_saa9730_stop
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lan_saa9730_start
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_tx
r_static
r_int
id|lan_saa9730_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
op_star
id|pPacket
suffix:semicolon
r_int
r_int
id|tx_status
suffix:semicolon
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;lan_saa9730_tx interrupt&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt. */
id|OUTL
c_func
(paren
id|DMA_STATUS_MAC_TX_INT
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DmaStatus
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|pPacket
op_assign
(paren
r_int
r_int
op_star
)paren
id|lp-&gt;TxmBuffer
(braket
id|lp
op_member_access_from_pointer
id|PendingTxmBufferIndex
)braket
(braket
id|lp-&gt;PendingTxmPacketIndex
)braket
suffix:semicolon
multiline_comment|/* Get status of first packet transmitted. */
id|tx_status
op_assign
id|le32_to_cpu
c_func
(paren
op_star
id|pPacket
)paren
suffix:semicolon
multiline_comment|/* Check ownership. */
r_if
c_cond
(paren
(paren
id|tx_status
op_amp
id|TX_STAT_CTL_OWNER_MSK
)paren
op_ne
(paren
id|TXSF_HWDONE
op_lshift
id|TX_STAT_CTL_OWNER_SHF
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Check for error. */
r_if
c_cond
(paren
id|tx_status
op_amp
id|TX_STAT_CTL_ERROR_MSK
)paren
(brace
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;lan_saa9730_tx: tx error = %x&bslash;n&quot;
comma
id|tx_status
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
(paren
id|TX_STATUS_EX_COLL
op_lshift
id|TX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
(paren
id|TX_STATUS_LATE_COLL
op_lshift
id|TX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats
dot
id|tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
(paren
id|TX_STATUS_L_CARR
op_lshift
id|TX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
(paren
id|TX_STATUS_UNDER
op_lshift
id|TX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
(paren
id|TX_STATUS_SQ_ERR
op_lshift
id|TX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
id|lp-&gt;stats.collisions
op_add_assign
id|tx_status
op_amp
id|TX_STATUS_TX_COLL_MSK
suffix:semicolon
)brace
multiline_comment|/* Free buffer. */
op_star
id|pPacket
op_assign
id|cpu_to_le32
c_func
(paren
id|TXSF_EMPTY
op_lshift
id|TX_STAT_CTL_OWNER_SHF
)paren
suffix:semicolon
multiline_comment|/* Update pending index pointer. */
id|lp-&gt;PendingTxmPacketIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;PendingTxmPacketIndex
op_ge
id|LAN_SAA9730_TXM_Q_SIZE
)paren
(brace
id|lp-&gt;PendingTxmPacketIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;PendingTxmBufferIndex
op_xor_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Make sure A and B are available to hardware. */
id|OUTL
c_func
(paren
id|OK2USE_TX_A
op_or
id|OK2USE_TX_B
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;Ok2Use
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* The tx buffer is no longer full. */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_rx
r_static
r_int
id|lan_saa9730_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|rx_status
suffix:semicolon
r_int
id|BufferIndex
suffix:semicolon
r_int
id|PacketIndex
suffix:semicolon
r_int
r_int
op_star
id|pPacket
suffix:semicolon
r_int
r_char
op_star
id|pData
suffix:semicolon
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;lan_saa9730_rx interrupt&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Clear receive interrupts. */
id|OUTL
c_func
(paren
id|DMA_STATUS_MAC_RX_INT
op_or
id|DMA_STATUS_RX_INT
op_or
id|DMA_STATUS_RX_TO_INT
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DmaStatus
)paren
suffix:semicolon
multiline_comment|/* Address next packet */
r_if
c_cond
(paren
id|lp-&gt;NextRcvToUseIsA
)paren
id|BufferIndex
op_assign
l_int|0
suffix:semicolon
r_else
id|BufferIndex
op_assign
l_int|1
suffix:semicolon
id|PacketIndex
op_assign
id|lp-&gt;NextRcvPacketIndex
suffix:semicolon
id|pPacket
op_assign
(paren
r_int
r_int
op_star
)paren
id|lp-&gt;RcvBuffer
(braket
id|BufferIndex
)braket
(braket
id|PacketIndex
)braket
suffix:semicolon
id|rx_status
op_assign
id|le32_to_cpu
c_func
(paren
op_star
id|pPacket
)paren
suffix:semicolon
multiline_comment|/* Process each packet. */
r_while
c_loop
(paren
(paren
id|rx_status
op_amp
id|RX_STAT_CTL_OWNER_MSK
)paren
op_eq
(paren
id|RXSF_HWDONE
op_lshift
id|RX_STAT_CTL_OWNER_SHF
)paren
)paren
(brace
multiline_comment|/* Check the rx status. */
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RX_STATUS_GOOD
op_lshift
id|RX_STAT_CTL_STATUS_SHF
)paren
)paren
(brace
multiline_comment|/* Received packet is good. */
id|len
op_assign
(paren
id|rx_status
op_amp
id|RX_STAT_CTL_LENGTH_MSK
)paren
op_rshift
id|RX_STAT_CTL_LENGTH_SHF
suffix:semicolon
id|pData
op_assign
(paren
r_int
r_char
op_star
)paren
id|pPacket
suffix:semicolon
id|pData
op_add_assign
l_int|4
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align */
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* make room */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
id|pData
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* We got an error packet. */
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|2
)paren
id|printk
(paren
l_string|&quot;lan_saa9730_rx: We got an error packet = %x&bslash;n&quot;
comma
id|rx_status
)paren
suffix:semicolon
id|lp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RX_STATUS_CRC_ERR
op_lshift
id|RX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RX_STATUS_ALIGN_ERR
op_lshift
id|RX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats
dot
id|rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RX_STATUS_OVERFLOW
op_lshift
id|RX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rx_status
op_amp
(paren
id|RX_STATUS_LONG_ERR
op_lshift
id|RX_STAT_CTL_STATUS_SHF
)paren
)paren
id|lp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Indicate we have processed the buffer. */
op_star
id|pPacket
op_assign
id|cpu_to_le32
c_func
(paren
id|RXSF_READY
op_lshift
id|RX_STAT_CTL_OWNER_SHF
)paren
suffix:semicolon
multiline_comment|/* Go to next packet in sequence. */
id|lp-&gt;NextRcvPacketIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;NextRcvPacketIndex
op_ge
id|LAN_SAA9730_RCV_Q_SIZE
)paren
(brace
id|lp-&gt;NextRcvPacketIndex
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|BufferIndex
)paren
(brace
id|lp-&gt;NextRcvToUseIsA
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;NextRcvToUseIsA
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|OUTL
c_func
(paren
id|OK2USE_RX_A
op_or
id|OK2USE_RX_B
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;Ok2Use
)paren
suffix:semicolon
multiline_comment|/* Address next packet */
r_if
c_cond
(paren
id|lp-&gt;NextRcvToUseIsA
)paren
id|BufferIndex
op_assign
l_int|0
suffix:semicolon
r_else
id|BufferIndex
op_assign
l_int|1
suffix:semicolon
id|PacketIndex
op_assign
id|lp-&gt;NextRcvPacketIndex
suffix:semicolon
id|pPacket
op_assign
(paren
r_int
r_int
op_star
)paren
id|lp
op_member_access_from_pointer
id|RcvBuffer
(braket
id|BufferIndex
)braket
(braket
id|PacketIndex
)braket
suffix:semicolon
id|rx_status
op_assign
id|le32_to_cpu
c_func
(paren
op_star
id|pPacket
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure A and B are available to hardware. */
id|OUTL
c_func
(paren
id|OK2USE_RX_A
op_or
id|OK2USE_RX_B
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;Ok2Use
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_interrupt
r_static
id|irqreturn_t
id|lan_saa9730_interrupt
c_func
(paren
r_const
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;lan_saa9730_interrupt&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Disable the EVM LAN interrupt. */
id|evm_saa9730_block_lan_int
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* Clear the EVM LAN interrupt. */
id|evm_saa9730_clear_lan_int
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* Service pending transmit interrupts. */
r_if
c_cond
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DmaStatus
)paren
op_amp
id|DMA_STATUS_MAC_TX_INT
)paren
id|lan_saa9730_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Service pending receive interrupts. */
r_if
c_cond
(paren
id|INL
c_func
(paren
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;DmaStatus
)paren
op_amp
(paren
id|DMA_STATUS_MAC_RX_INT
op_or
id|DMA_STATUS_RX_INT
op_or
id|DMA_STATUS_RX_TO_INT
)paren
)paren
id|lan_saa9730_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Enable the EVM LAN interrupt. */
id|evm_saa9730_unblock_lan_int
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|lan_saa9730_open_fail
r_static
r_int
id|lan_saa9730_open_fail
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|lan_saa9730_open
r_static
r_int
id|lan_saa9730_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Associate IRQ with lan_saa9730_interrupt */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|lan_saa9730_interrupt
comma
l_int|0
comma
l_string|&quot;SAA9730 Eth&quot;
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;lan_saa9730_open: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Enable the Lan interrupt in the event manager. */
id|evm_saa9730_enable_lan_int
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* Start the LAN controller */
r_if
c_cond
(paren
id|lan_saa9730_start
c_func
(paren
id|lp
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_write
r_static
r_int
id|lan_saa9730_write
c_func
(paren
r_struct
id|lan_saa9730_private
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|skblen
)paren
(brace
r_int
r_char
op_star
id|pbData
op_assign
id|skb-&gt;data
suffix:semicolon
r_int
r_int
id|len
op_assign
id|skblen
suffix:semicolon
r_int
r_char
op_star
id|pbPacketData
suffix:semicolon
r_int
r_int
id|tx_status
suffix:semicolon
r_int
id|BufferIndex
suffix:semicolon
r_int
id|PacketIndex
suffix:semicolon
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;lan_saa9730_write: skb=%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|skb
)paren
suffix:semicolon
id|BufferIndex
op_assign
id|lp-&gt;NextTxmBufferIndex
suffix:semicolon
id|PacketIndex
op_assign
id|lp-&gt;NextTxmPacketIndex
suffix:semicolon
id|tx_status
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|lp
op_member_access_from_pointer
id|TxmBuffer
(braket
id|BufferIndex
)braket
(braket
id|PacketIndex
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tx_status
op_amp
id|TX_STAT_CTL_OWNER_MSK
)paren
op_ne
(paren
id|TXSF_EMPTY
op_lshift
id|TX_STAT_CTL_OWNER_SHF
)paren
)paren
(brace
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|4
)paren
id|printk
(paren
l_string|&quot;lan_saa9730_write: Tx buffer not available: tx_status = %x&bslash;n&quot;
comma
id|tx_status
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|lp-&gt;NextTxmPacketIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;NextTxmPacketIndex
op_ge
id|LAN_SAA9730_TXM_Q_SIZE
)paren
(brace
id|lp-&gt;NextTxmPacketIndex
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;NextTxmBufferIndex
op_xor_assign
l_int|1
suffix:semicolon
)brace
id|pbPacketData
op_assign
(paren
r_int
r_char
op_star
)paren
id|lp-&gt;TxmBuffer
(braket
id|BufferIndex
)braket
(braket
id|PacketIndex
)braket
suffix:semicolon
id|pbPacketData
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* copy the bits */
id|memcpy
c_func
(paren
id|pbPacketData
comma
id|pbData
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Set transmit status for hardware */
op_star
(paren
r_int
r_int
op_star
)paren
id|lp-&gt;TxmBuffer
(braket
id|BufferIndex
)braket
(braket
id|PacketIndex
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|TXSF_READY
op_lshift
id|TX_STAT_CTL_OWNER_SHF
)paren
op_or
(paren
id|TX_STAT_CTL_INT_AFTER_TX
op_lshift
id|TX_STAT_CTL_FRAME_SHF
)paren
op_or
(paren
id|len
op_lshift
id|TX_STAT_CTL_LENGTH_SHF
)paren
)paren
suffix:semicolon
multiline_comment|/* Set hardware tx buffer. */
id|OUTL
c_func
(paren
id|OK2USE_TX_A
op_or
id|OK2USE_TX_B
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;Ok2Use
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_tx_timeout
r_static
r_void
id|lan_saa9730_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Transmitter timeout, serious problems */
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out, reset&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*show_saa9730_regs(lp); */
id|lan_saa9730_restart
c_func
(paren
id|lp
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|lan_saa9730_start_xmit
r_static
r_int
id|lan_saa9730_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|skblen
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;Send packet: skb=%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|skb
)paren
suffix:semicolon
id|skblen
op_assign
id|skb-&gt;len
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|len
op_assign
(paren
id|skblen
op_le
id|ETH_ZLEN
)paren
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skblen
suffix:semicolon
r_if
c_cond
(paren
id|lan_saa9730_write
c_func
(paren
id|lp
comma
id|skb
comma
id|skblen
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Error when writing packet to controller: skb=%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|skb
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|lp-&gt;stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_close
r_static
r_int
id|lan_saa9730_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;lan_saa9730_close:&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Disable the Lan interrupt in the event manager. */
id|evm_saa9730_disable_lan_int
c_func
(paren
id|lp
)paren
suffix:semicolon
multiline_comment|/* Stop the controller */
r_if
c_cond
(paren
id|lan_saa9730_stop
c_func
(paren
id|lp
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lan_saa9730_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|lan_saa9730_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
DECL|function|lan_saa9730_set_multicast
r_static
r_void
id|lan_saa9730_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Stop the controller */
id|lan_saa9730_stop
c_func
(paren
id|lp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* accept all packets */
id|OUTL
c_func
(paren
id|CAM_CONTROL_COMP_EN
op_or
id|CAM_CONTROL_STATION_ACC
op_or
id|CAM_CONTROL_GROUP_ACC
op_or
id|CAM_CONTROL_BROAD_ACC
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamCtl
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
multiline_comment|/* accept all multicast packets */
id|OUTL
c_func
(paren
id|CAM_CONTROL_COMP_EN
op_or
id|CAM_CONTROL_GROUP_ACC
op_or
id|CAM_CONTROL_BROAD_ACC
comma
op_amp
id|lp-&gt;lan_saa9730_regs-&gt;CamCtl
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &n;&t;&t;&t; * Will handle the multicast stuff later. -carstenl&n;&t;&t;&t; */
)brace
)brace
id|lan_saa9730_restart
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
DECL|function|saa9730_remove_one
r_static
r_void
id|__devexit
id|saa9730_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
DECL|function|lan_saa9730_init
r_static
r_int
id|lan_saa9730_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
comma
r_int
id|irq
)paren
(brace
r_struct
id|lan_saa9730_private
op_star
id|lp
suffix:semicolon
r_int
r_char
id|ethernet_addr
(braket
l_int|6
)braket
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;open
op_assign
id|lan_saa9730_open_fail
suffix:semicolon
r_if
c_cond
(paren
id|get_ethernet_addr
c_func
(paren
id|ethernet_addr
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|ethernet_addr
comma
l_int|6
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/* &n;&t; * Make certain the data structures used by the controller are aligned &n;&t; * and DMAble. &n;&t; */
id|lp
op_assign
(paren
r_struct
id|lan_saa9730_private
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|lp
)paren
op_plus
l_int|7
comma
id|GFP_DMA
op_or
id|GFP_KERNEL
)paren
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
id|lp
suffix:semicolon
id|memset
c_func
(paren
id|lp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|lp
)paren
)paren
suffix:semicolon
multiline_comment|/* Set SAA9730 LAN base address. */
id|lp-&gt;lan_saa9730_regs
op_assign
(paren
id|t_lan_saa9730_regmap
op_star
)paren
(paren
id|ioaddr
op_plus
id|SAA9730_LAN_REGS_ADDR
)paren
suffix:semicolon
multiline_comment|/* Set SAA9730 EVM base address. */
id|lp-&gt;evm_saa9730_regs
op_assign
(paren
id|t_evm_saa9730_regmap
op_star
)paren
(paren
id|ioaddr
op_plus
id|SAA9730_EVM_REGS_ADDR
)paren
suffix:semicolon
multiline_comment|/* Allocate LAN RX/TX frame buffer space. */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lan_saa9730_allocate_buffers
c_func
(paren
id|lp
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Stop LAN controller. */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lan_saa9730_stop
c_func
(paren
id|lp
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Initialize CAM registers. */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lan_saa9730_cam_init
c_func
(paren
id|dev
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Initialize MII registers. */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lan_saa9730_mii_init
c_func
(paren
id|lp
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Initialize control registers. */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lan_saa9730_control_init
c_func
(paren
id|lp
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Load CAM registers. */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lan_saa9730_cam_load
c_func
(paren
id|lp
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Initialize DMA context registers. */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lan_saa9730_dma_init
c_func
(paren
id|lp
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lp-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|lan_saa9730_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|lan_saa9730_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
id|lan_saa9730_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|lan_saa9730_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|lan_saa9730_set_multicast
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|lan_saa9730_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
(paren
id|HZ
op_rshift
l_int|1
)paren
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;priv
)paren
id|kfree
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|unregister_netdevice
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|saa9730_init_one
r_static
r_int
id|__devinit
id|saa9730_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|pci_ioaddr
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|lan_saa9730_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;saa9730.c: PCI bios is present, checking for devices...&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cannot enable PCI device, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_MODULE_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cannot obtain PCI resources, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_disable_pdev
suffix:semicolon
)brace
id|pci_irq_line
op_assign
id|pdev-&gt;irq
suffix:semicolon
multiline_comment|/* LAN base address in located at BAR 1. */
id|pci_ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Found SAA9730 (PCI) at %#x, irq %d.&bslash;n&quot;
comma
id|pci_ioaddr
comma
id|pci_irq_line
)paren
suffix:semicolon
id|err
op_assign
id|lan_saa9730_init
c_func
(paren
id|dev
comma
id|pci_ioaddr
comma
id|pci_irq_line
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Lan init failed&quot;
)paren
suffix:semicolon
r_goto
id|out_disable_pdev
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_disable_pdev
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|out
suffix:colon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|saa9730_driver
r_static
r_struct
id|pci_driver
id|saa9730_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_MODULE_NAME
comma
dot
id|id_table
op_assign
id|saa9730_pci_tbl
comma
dot
id|probe
op_assign
id|saa9730_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|saa9730_remove_one
)paren
comma
)brace
suffix:semicolon
DECL|function|saa9730_init
r_static
r_int
id|__init
id|saa9730_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|saa9730_driver
)paren
suffix:semicolon
)brace
DECL|function|saa9730_cleanup
r_static
r_void
id|__exit
id|saa9730_cleanup
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|saa9730_driver
)paren
suffix:semicolon
)brace
DECL|variable|saa9730_init
id|module_init
c_func
(paren
id|saa9730_init
)paren
suffix:semicolon
DECL|variable|saa9730_cleanup
id|module_exit
c_func
(paren
id|saa9730_cleanup
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
