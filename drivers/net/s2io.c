multiline_comment|/************************************************************************&n; * s2io.c: A Linux PCI-X Ethernet driver for S2IO 10GbE Server NIC&n; * Copyright(c) 2002-2005 S2IO Technologies&n;&n; * This software may be used and distributed according to the terms of&n; * the GNU General Public License (GPL), incorporated herein by reference.&n; * Drivers based on or derived from this code fall under the GPL and must&n; * retain the authorship, copyright and license notice.  This file is not&n; * a complete program and may only be used when the entire operating&n; * system is licensed under the GPL.&n; * See the file COPYING in this distribution for more information.&n; *&n; * Credits:&n; * Jeff Garzik&t;&t;: For pointing out the improper error condition &n; *&t;&t;&t;  check in the s2io_xmit routine and also some &n; * &t;&t;&t;  issues in the Tx watch dog function. Also for&n; *&t;&t;&t;  patiently answering all those innumerable &n; *&t;&t;&t;  questions regaring the 2.6 porting issues.&n; * Stephen Hemminger&t;: Providing proper 2.6 porting mechanism for some&n; *&t;&t;&t;  macros available only in 2.6 Kernel.&n; * Francois Romieu&t;: For pointing out all code part that were &n; *&t;&t;&t;  deprecated and also styling related comments.&n; * Grant Grundler&t;: For helping me get rid of some Architecture &n; *&t;&t;&t;  dependent code.&n; * Christopher Hellwig&t;: Some more 2.6 specific issues in the driver.&n; *&t;&t;&t;  &t;&n; * The module loadable parameters that are supported by the driver and a brief&n; * explaination of all the variables.&n; * rx_ring_num : This can be used to program the number of receive rings used &n; * in the driver.  &t;&t;&t;&t;&t;&n; * rx_ring_len: This defines the number of descriptors each ring can have. This &n; * is also an array of size 8.&n; * tx_fifo_num: This defines the number of Tx FIFOs thats used int the driver.&n; * tx_fifo_len: This too is an array of 8. Each element defines the number of &n; * Tx descriptors that can be associated with each corresponding FIFO.&n; * in PCI Configuration space.&n; ************************************************************************/
macro_line|#include&lt;linux/config.h&gt;
macro_line|#include&lt;linux/module.h&gt;
macro_line|#include&lt;linux/types.h&gt;
macro_line|#include&lt;linux/errno.h&gt;
macro_line|#include&lt;linux/ioport.h&gt;
macro_line|#include&lt;linux/pci.h&gt;
macro_line|#include&lt;linux/kernel.h&gt;
macro_line|#include&lt;linux/netdevice.h&gt;
macro_line|#include&lt;linux/etherdevice.h&gt;
macro_line|#include&lt;linux/skbuff.h&gt;
macro_line|#include&lt;linux/init.h&gt;
macro_line|#include&lt;linux/delay.h&gt;
macro_line|#include&lt;linux/stddef.h&gt;
macro_line|#include&lt;linux/ioctl.h&gt;
macro_line|#include&lt;linux/timex.h&gt;
macro_line|#include&lt;linux/sched.h&gt;
macro_line|#include&lt;linux/ethtool.h&gt;
macro_line|#include&lt;asm/system.h&gt;
macro_line|#include&lt;asm/uaccess.h&gt;
macro_line|#include&lt;linux/version.h&gt;
macro_line|#include&lt;asm/io.h&gt;
macro_line|#include&lt;linux/workqueue.h&gt;
multiline_comment|/* local include */
macro_line|#include &quot;s2io.h&quot;
macro_line|#include &quot;s2io-regs.h&quot;
multiline_comment|/* S2io Driver name &amp; version. */
DECL|variable|s2io_driver_name
r_static
r_char
id|s2io_driver_name
(braket
)braket
op_assign
l_string|&quot;s2io&quot;
suffix:semicolon
DECL|variable|s2io_driver_version
r_static
r_char
id|s2io_driver_version
(braket
)braket
op_assign
l_string|&quot;Version 1.7.5.1&quot;
suffix:semicolon
multiline_comment|/* &n; * Cards with following subsystem_id have a link state indication&n; * problem, 600B, 600C, 600D, 640B, 640C and 640D.&n; * macro below identifies these cards given the subsystem_id.&n; */
DECL|macro|CARDS_WITH_FAULTY_LINK_INDICATORS
mdefine_line|#define CARDS_WITH_FAULTY_LINK_INDICATORS(subid) &bslash;&n;&t;&t;(((subid &gt;= 0x600B) &amp;&amp; (subid &lt;= 0x600D)) || &bslash;&n;&t;&t; ((subid &gt;= 0x640B) &amp;&amp; (subid &lt;= 0x640D))) ? 1 : 0
DECL|macro|LINK_IS_UP
mdefine_line|#define LINK_IS_UP(val64) (!(val64 &amp; (ADAPTER_STATUS_RMAC_REMOTE_FAULT | &bslash;&n;&t;&t;&t;&t;      ADAPTER_STATUS_RMAC_LOCAL_FAULT)))
DECL|macro|TASKLET_IN_USE
mdefine_line|#define TASKLET_IN_USE test_and_set_bit(0, (&amp;sp-&gt;tasklet_status))
DECL|macro|PANIC
mdefine_line|#define PANIC&t;1
DECL|macro|LOW
mdefine_line|#define LOW&t;2
DECL|function|rx_buffer_level
r_static
r_inline
r_int
id|rx_buffer_level
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_int
id|rxb_size
comma
r_int
id|ring
)paren
(brace
r_int
id|level
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;pkt_cnt
(braket
id|ring
)braket
op_minus
id|rxb_size
)paren
OG
l_int|16
)paren
(brace
id|level
op_assign
id|LOW
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;pkt_cnt
(braket
id|ring
)braket
op_minus
id|rxb_size
)paren
OL
id|MAX_RXDS_PER_BLOCK
)paren
(brace
id|level
op_assign
id|PANIC
suffix:semicolon
)brace
)brace
r_return
id|level
suffix:semicolon
)brace
multiline_comment|/* Ethtool related variables and Macros. */
DECL|variable|s2io_gstrings
r_static
r_char
id|s2io_gstrings
(braket
)braket
(braket
id|ETH_GSTRING_LEN
)braket
op_assign
(brace
l_string|&quot;Register test&bslash;t(offline)&quot;
comma
l_string|&quot;Eeprom test&bslash;t(offline)&quot;
comma
l_string|&quot;Link test&bslash;t(online)&quot;
comma
l_string|&quot;RLDRAM test&bslash;t(offline)&quot;
comma
l_string|&quot;BIST Test&bslash;t(offline)&quot;
)brace
suffix:semicolon
DECL|variable|ethtool_stats_keys
r_static
r_char
id|ethtool_stats_keys
(braket
)braket
(braket
id|ETH_GSTRING_LEN
)braket
op_assign
(brace
(brace
l_string|&quot;tmac_frms&quot;
)brace
comma
(brace
l_string|&quot;tmac_data_octets&quot;
)brace
comma
(brace
l_string|&quot;tmac_drop_frms&quot;
)brace
comma
(brace
l_string|&quot;tmac_mcst_frms&quot;
)brace
comma
(brace
l_string|&quot;tmac_bcst_frms&quot;
)brace
comma
(brace
l_string|&quot;tmac_pause_ctrl_frms&quot;
)brace
comma
(brace
l_string|&quot;tmac_any_err_frms&quot;
)brace
comma
(brace
l_string|&quot;tmac_vld_ip_octets&quot;
)brace
comma
(brace
l_string|&quot;tmac_vld_ip&quot;
)brace
comma
(brace
l_string|&quot;tmac_drop_ip&quot;
)brace
comma
(brace
l_string|&quot;tmac_icmp&quot;
)brace
comma
(brace
l_string|&quot;tmac_rst_tcp&quot;
)brace
comma
(brace
l_string|&quot;tmac_tcp&quot;
)brace
comma
(brace
l_string|&quot;tmac_udp&quot;
)brace
comma
(brace
l_string|&quot;rmac_vld_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_data_octets&quot;
)brace
comma
(brace
l_string|&quot;rmac_fcs_err_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_drop_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_vld_mcst_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_vld_bcst_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_in_rng_len_err_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_long_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_pause_ctrl_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_discarded_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_usized_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_osized_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_frag_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_jabber_frms&quot;
)brace
comma
(brace
l_string|&quot;rmac_ip&quot;
)brace
comma
(brace
l_string|&quot;rmac_ip_octets&quot;
)brace
comma
(brace
l_string|&quot;rmac_hdr_err_ip&quot;
)brace
comma
(brace
l_string|&quot;rmac_drop_ip&quot;
)brace
comma
(brace
l_string|&quot;rmac_icmp&quot;
)brace
comma
(brace
l_string|&quot;rmac_tcp&quot;
)brace
comma
(brace
l_string|&quot;rmac_udp&quot;
)brace
comma
(brace
l_string|&quot;rmac_err_drp_udp&quot;
)brace
comma
(brace
l_string|&quot;rmac_pause_cnt&quot;
)brace
comma
(brace
l_string|&quot;rmac_accepted_ip&quot;
)brace
comma
(brace
l_string|&quot;rmac_err_tcp&quot;
)brace
comma
)brace
suffix:semicolon
DECL|macro|S2IO_STAT_LEN
mdefine_line|#define S2IO_STAT_LEN sizeof(ethtool_stats_keys)/ ETH_GSTRING_LEN
DECL|macro|S2IO_STAT_STRINGS_LEN
mdefine_line|#define S2IO_STAT_STRINGS_LEN S2IO_STAT_LEN * ETH_GSTRING_LEN
DECL|macro|S2IO_TEST_LEN
mdefine_line|#define S2IO_TEST_LEN&t;sizeof(s2io_gstrings) / ETH_GSTRING_LEN
DECL|macro|S2IO_STRINGS_LEN
mdefine_line|#define S2IO_STRINGS_LEN&t;S2IO_TEST_LEN * ETH_GSTRING_LEN
multiline_comment|/* &n; * Constants to be programmed into the Xena&squot;s registers, to configure&n; * the XAUI.&n; */
DECL|macro|SWITCH_SIGN
mdefine_line|#define SWITCH_SIGN&t;0xA5A5A5A5A5A5A5A5ULL
DECL|macro|END_SIGN
mdefine_line|#define&t;END_SIGN&t;0x0
DECL|variable|default_mdio_cfg
r_static
id|u64
id|default_mdio_cfg
(braket
)braket
op_assign
(brace
multiline_comment|/* Reset PMA PLL */
l_int|0xC001010000000000ULL
comma
l_int|0xC0010100000000E0ULL
comma
l_int|0xC0010100008000E4ULL
comma
multiline_comment|/* Remove Reset from PMA PLL */
l_int|0xC001010000000000ULL
comma
l_int|0xC0010100000000E0ULL
comma
l_int|0xC0010100000000E4ULL
comma
id|END_SIGN
)brace
suffix:semicolon
DECL|variable|default_dtx_cfg
r_static
id|u64
id|default_dtx_cfg
(braket
)braket
op_assign
(brace
l_int|0x8000051500000000ULL
comma
l_int|0x80000515000000E0ULL
comma
l_int|0x80000515D93500E4ULL
comma
l_int|0x8001051500000000ULL
comma
l_int|0x80010515000000E0ULL
comma
l_int|0x80010515001E00E4ULL
comma
l_int|0x8002051500000000ULL
comma
l_int|0x80020515000000E0ULL
comma
l_int|0x80020515F21000E4ULL
comma
multiline_comment|/* Set PADLOOPBACKN */
l_int|0x8002051500000000ULL
comma
l_int|0x80020515000000E0ULL
comma
l_int|0x80020515B20000E4ULL
comma
l_int|0x8003051500000000ULL
comma
l_int|0x80030515000000E0ULL
comma
l_int|0x80030515B20000E4ULL
comma
l_int|0x8004051500000000ULL
comma
l_int|0x80040515000000E0ULL
comma
l_int|0x80040515B20000E4ULL
comma
l_int|0x8005051500000000ULL
comma
l_int|0x80050515000000E0ULL
comma
l_int|0x80050515B20000E4ULL
comma
id|SWITCH_SIGN
comma
multiline_comment|/* Remove PADLOOPBACKN */
l_int|0x8002051500000000ULL
comma
l_int|0x80020515000000E0ULL
comma
l_int|0x80020515F20000E4ULL
comma
l_int|0x8003051500000000ULL
comma
l_int|0x80030515000000E0ULL
comma
l_int|0x80030515F20000E4ULL
comma
l_int|0x8004051500000000ULL
comma
l_int|0x80040515000000E0ULL
comma
l_int|0x80040515F20000E4ULL
comma
l_int|0x8005051500000000ULL
comma
l_int|0x80050515000000E0ULL
comma
l_int|0x80050515F20000E4ULL
comma
id|END_SIGN
)brace
suffix:semicolon
multiline_comment|/* &n; * Constants for Fixing the MacAddress problem seen mostly on&n; * Alpha machines.&n; */
DECL|variable|fix_mac
r_static
id|u64
id|fix_mac
(braket
)braket
op_assign
(brace
l_int|0x0060000000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0040600000000000ULL
comma
l_int|0x0000600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
l_int|0x0020600000000000ULL
comma
l_int|0x0000600000000000ULL
comma
l_int|0x0040600000000000ULL
comma
l_int|0x0060600000000000ULL
comma
id|END_SIGN
)brace
suffix:semicolon
multiline_comment|/* Module Loadable parameters. */
DECL|variable|tx_fifo_num
r_static
r_int
r_int
id|tx_fifo_num
op_assign
l_int|1
suffix:semicolon
DECL|variable|tx_fifo_len
r_static
r_int
r_int
id|tx_fifo_len
(braket
id|MAX_TX_FIFOS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|MAX_TX_FIFOS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|0
)brace
suffix:semicolon
DECL|variable|rx_ring_num
r_static
r_int
r_int
id|rx_ring_num
op_assign
l_int|1
suffix:semicolon
DECL|variable|rx_ring_sz
r_static
r_int
r_int
id|rx_ring_sz
(braket
id|MAX_RX_RINGS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|MAX_RX_RINGS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|0
)brace
suffix:semicolon
DECL|variable|Stats_refresh_time
r_static
r_int
r_int
id|Stats_refresh_time
op_assign
l_int|4
suffix:semicolon
DECL|variable|rmac_pause_time
r_static
r_int
r_int
id|rmac_pause_time
op_assign
l_int|65535
suffix:semicolon
DECL|variable|mc_pause_threshold_q0q3
r_static
r_int
r_int
id|mc_pause_threshold_q0q3
op_assign
l_int|187
suffix:semicolon
DECL|variable|mc_pause_threshold_q4q7
r_static
r_int
r_int
id|mc_pause_threshold_q4q7
op_assign
l_int|187
suffix:semicolon
DECL|variable|shared_splits
r_static
r_int
r_int
id|shared_splits
suffix:semicolon
DECL|variable|tmac_util_period
r_static
r_int
r_int
id|tmac_util_period
op_assign
l_int|5
suffix:semicolon
DECL|variable|rmac_util_period
r_static
r_int
r_int
id|rmac_util_period
op_assign
l_int|5
suffix:semicolon
macro_line|#ifndef CONFIG_S2IO_NAPI
DECL|variable|indicate_max_pkts
r_static
r_int
r_int
id|indicate_max_pkts
suffix:semicolon
macro_line|#endif
multiline_comment|/* &n; * S2IO device table.&n; * This table lists all the devices that this driver supports. &n; */
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|s2io_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_S2IO
comma
id|PCI_DEVICE_ID_S2IO_WIN
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
id|PCI_VENDOR_ID_S2IO
comma
id|PCI_DEVICE_ID_S2IO_UNI
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|s2io_tbl
)paren
suffix:semicolon
DECL|variable|s2io_driver
r_static
r_struct
id|pci_driver
id|s2io_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;S2IO&quot;
comma
dot
id|id_table
op_assign
id|s2io_tbl
comma
dot
id|probe
op_assign
id|s2io_init_nic
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|s2io_rem_nic
)paren
comma
)brace
suffix:semicolon
multiline_comment|/* A simplifier macro used both by init and free shared_mem Fns(). */
DECL|macro|TXD_MEM_PAGE_CNT
mdefine_line|#define TXD_MEM_PAGE_CNT(len, per_each) ((len+per_each - 1) / per_each)
multiline_comment|/**&n; * init_shared_mem - Allocation and Initialization of Memory&n; * @nic: Device private variable.&n; * Description: The function allocates all the memory areas shared &n; * between the NIC and the driver. This includes Tx descriptors, &n; * Rx descriptors and the statistics block.&n; */
DECL|function|init_shared_mem
r_static
r_int
id|init_shared_mem
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
id|u32
id|size
suffix:semicolon
r_void
op_star
id|tmp_v_addr
comma
op_star
id|tmp_v_addr_next
suffix:semicolon
id|dma_addr_t
id|tmp_p_addr
comma
id|tmp_p_addr_next
suffix:semicolon
id|RxD_block_t
op_star
id|pre_rxd_blk
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|blk_cnt
suffix:semicolon
r_int
id|lst_size
comma
id|lst_per_page
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|nic-&gt;dev
suffix:semicolon
macro_line|#ifdef CONFIG_2BUFF_MODE
id|u64
id|tmp
suffix:semicolon
id|buffAdd_t
op_star
id|ba
suffix:semicolon
macro_line|#endif
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
multiline_comment|/* Allocation and initialization of TXDLs in FIOFs */
id|size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;tx_fifo_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|size
op_add_assign
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OG
id|MAX_AVAILABLE_TXDS
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Total number of Tx FIFOs &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;exceeds the maximum value &quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;that can be used&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILURE
suffix:semicolon
)brace
id|lst_size
op_assign
(paren
r_sizeof
(paren
id|TxD_t
)paren
op_star
id|config-&gt;max_txds
)paren
suffix:semicolon
id|lst_per_page
op_assign
id|PAGE_SIZE
op_div
id|lst_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;tx_fifo_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|fifo_len
op_assign
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
suffix:semicolon
r_int
id|list_holder_size
op_assign
id|fifo_len
op_star
r_sizeof
(paren
id|list_info_hold_t
)paren
suffix:semicolon
id|nic-&gt;list_info
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
id|list_holder_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nic-&gt;list_info
(braket
id|i
)braket
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Malloc failed for list_info&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|nic-&gt;list_info
(braket
id|i
)braket
comma
l_int|0
comma
id|list_holder_size
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;tx_fifo_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|page_num
op_assign
id|TXD_MEM_PAGE_CNT
c_func
(paren
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
comma
id|lst_per_page
)paren
suffix:semicolon
id|mac_control-&gt;tx_curr_put_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;tx_curr_put_info
(braket
id|i
)braket
dot
id|fifo_len
op_assign
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
op_minus
l_int|1
suffix:semicolon
id|mac_control-&gt;tx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;tx_curr_get_info
(braket
id|i
)braket
dot
id|fifo_len
op_assign
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|page_num
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
id|k
op_assign
l_int|0
suffix:semicolon
id|dma_addr_t
id|tmp_p
suffix:semicolon
r_void
op_star
id|tmp_v
suffix:semicolon
id|tmp_v
op_assign
id|pci_alloc_consistent
c_func
(paren
id|nic-&gt;pdev
comma
id|PAGE_SIZE
comma
op_amp
id|tmp_p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp_v
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;pci_alloc_consistent &quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;failed for TxDL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_while
c_loop
(paren
id|k
OL
id|lst_per_page
)paren
(brace
r_int
id|l
op_assign
(paren
id|j
op_star
id|lst_per_page
)paren
op_plus
id|k
suffix:semicolon
r_if
c_cond
(paren
id|l
op_eq
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
)paren
r_goto
id|end_txd_alloc
suffix:semicolon
id|nic-&gt;list_info
(braket
id|i
)braket
(braket
id|l
)braket
dot
id|list_virt_addr
op_assign
id|tmp_v
op_plus
(paren
id|k
op_star
id|lst_size
)paren
suffix:semicolon
id|nic-&gt;list_info
(braket
id|i
)braket
(braket
id|l
)braket
dot
id|list_phy_addr
op_assign
id|tmp_p
op_plus
(paren
id|k
op_star
id|lst_size
)paren
suffix:semicolon
id|k
op_increment
suffix:semicolon
)brace
)brace
)brace
id|end_txd_alloc
suffix:colon
multiline_comment|/* Allocation and initialization of RXDs in Rings */
id|size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_mod
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: RxD count of &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Ring%d is not a multiple of &quot;
comma
id|i
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;RxDs per Block&quot;
)paren
suffix:semicolon
r_return
id|FAILURE
suffix:semicolon
)brace
id|size
op_add_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
suffix:semicolon
id|nic-&gt;block_count
(braket
id|i
)braket
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_div
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|nic-&gt;pkt_cnt
(braket
id|i
)braket
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_minus
id|nic-&gt;block_count
(braket
id|i
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|block_index
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|ring_len
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_minus
l_int|1
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|i
)braket
dot
id|block_index
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|i
)braket
dot
id|ring_len
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_minus
l_int|1
suffix:semicolon
id|blk_cnt
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_div
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*  Allocating all the Rx blocks */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|blk_cnt
suffix:semicolon
id|j
op_increment
)paren
(brace
macro_line|#ifndef CONFIG_2BUFF_MODE
id|size
op_assign
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|RxD_t
)paren
)paren
suffix:semicolon
macro_line|#else
id|size
op_assign
id|SIZE_OF_BLOCK
suffix:semicolon
macro_line|#endif
id|tmp_v_addr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|nic-&gt;pdev
comma
id|size
comma
op_amp
id|tmp_p_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_v_addr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * In case of failure, free_shared_mem() &n;&t;&t;&t;&t; * is called, which should free any &n;&t;&t;&t;&t; * memory that was alloced till the &n;&t;&t;&t;&t; * failure happened.&n;&t;&t;&t;&t; */
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|block_virt_addr
op_assign
id|tmp_v_addr
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tmp_v_addr
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|block_virt_addr
op_assign
id|tmp_v_addr
suffix:semicolon
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|block_dma_addr
op_assign
id|tmp_p_addr
suffix:semicolon
)brace
multiline_comment|/* Interlinking all Rx Blocks */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|blk_cnt
suffix:semicolon
id|j
op_increment
)paren
(brace
id|tmp_v_addr
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|block_virt_addr
suffix:semicolon
id|tmp_v_addr_next
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
(paren
id|j
op_plus
l_int|1
)paren
op_mod
id|blk_cnt
)braket
dot
id|block_virt_addr
suffix:semicolon
id|tmp_p_addr
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|block_dma_addr
suffix:semicolon
id|tmp_p_addr_next
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
(paren
id|j
op_plus
l_int|1
)paren
op_mod
id|blk_cnt
)braket
dot
id|block_dma_addr
suffix:semicolon
id|pre_rxd_blk
op_assign
(paren
id|RxD_block_t
op_star
)paren
id|tmp_v_addr
suffix:semicolon
id|pre_rxd_blk-&gt;reserved_1
op_assign
id|END_OF_BLOCK
suffix:semicolon
multiline_comment|/* last RxD &n;&t;&t;&t;&t;&t;&t;&t;&t; * marker.&n;&t;&t;&t;&t;&t;&t;&t;&t; */
macro_line|#ifndef&t;CONFIG_2BUFF_MODE
id|pre_rxd_blk-&gt;reserved_2_pNext_RxD_block
op_assign
(paren
r_int
r_int
)paren
id|tmp_v_addr_next
suffix:semicolon
macro_line|#endif
id|pre_rxd_blk-&gt;pNext_RxD_Blk_physical
op_assign
(paren
id|u64
)paren
id|tmp_p_addr_next
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_2BUFF_MODE
multiline_comment|/* &n;&t; * Allocation of Storages for buffer addresses in 2BUFF mode&n;&t; * and the buffers as well.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|blk_cnt
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_div
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|nic-&gt;ba
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
(paren
r_sizeof
(paren
id|buffAdd_t
op_star
)paren
op_star
id|blk_cnt
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nic-&gt;ba
(braket
id|i
)braket
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|blk_cnt
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
id|k
op_assign
l_int|0
suffix:semicolon
id|nic-&gt;ba
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
id|kmalloc
c_func
(paren
(paren
r_sizeof
(paren
id|buffAdd_t
)paren
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nic-&gt;ba
(braket
id|i
)braket
(braket
id|j
)braket
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_while
c_loop
(paren
id|k
op_ne
id|MAX_RXDS_PER_BLOCK
)paren
(brace
id|ba
op_assign
op_amp
id|nic-&gt;ba
(braket
id|i
)braket
(braket
id|j
)braket
(braket
id|k
)braket
suffix:semicolon
id|ba-&gt;ba_0_org
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
(paren
id|BUF0_LEN
op_plus
id|ALIGN_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ba-&gt;ba_0_org
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|tmp
op_assign
(paren
id|u64
)paren
id|ba-&gt;ba_0_org
suffix:semicolon
id|tmp
op_add_assign
id|ALIGN_SIZE
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|ALIGN_SIZE
)paren
suffix:semicolon
id|ba-&gt;ba_0
op_assign
(paren
r_void
op_star
)paren
id|tmp
suffix:semicolon
id|ba-&gt;ba_1_org
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
(paren
id|BUF1_LEN
op_plus
id|ALIGN_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ba-&gt;ba_1_org
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|tmp
op_assign
(paren
id|u64
)paren
id|ba-&gt;ba_1_org
suffix:semicolon
id|tmp
op_add_assign
id|ALIGN_SIZE
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|ALIGN_SIZE
)paren
suffix:semicolon
id|ba-&gt;ba_1
op_assign
(paren
r_void
op_star
)paren
id|tmp
suffix:semicolon
id|k
op_increment
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/* Allocation and initialization of Statistics block */
id|size
op_assign
r_sizeof
(paren
id|StatInfo_t
)paren
suffix:semicolon
id|mac_control-&gt;stats_mem
op_assign
id|pci_alloc_consistent
(paren
id|nic-&gt;pdev
comma
id|size
comma
op_amp
id|mac_control-&gt;stats_mem_phy
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mac_control-&gt;stats_mem
)paren
(brace
multiline_comment|/* &n;&t;&t; * In case of failure, free_shared_mem() is called, which &n;&t;&t; * should free any memory that was alloced till the &n;&t;&t; * failure happened.&n;&t;&t; */
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|mac_control-&gt;stats_mem_sz
op_assign
id|size
suffix:semicolon
id|tmp_v_addr
op_assign
id|mac_control-&gt;stats_mem
suffix:semicolon
id|mac_control-&gt;stats_info
op_assign
(paren
id|StatInfo_t
op_star
)paren
id|tmp_v_addr
suffix:semicolon
id|memset
c_func
(paren
id|tmp_v_addr
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INIT_DBG
comma
l_string|&quot;%s:Ring Mem PHY: 0x%llx&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
r_int
r_int
)paren
id|tmp_p_addr
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**  &n; * free_shared_mem - Free the allocated Memory &n; * @nic:  Device private variable.&n; * Description: This function is to free all memory locations allocated by&n; * the init_shared_mem() function and return it to the kernel.&n; */
DECL|function|free_shared_mem
r_static
r_void
id|free_shared_mem
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
r_int
id|i
comma
id|j
comma
id|blk_cnt
comma
id|size
suffix:semicolon
r_void
op_star
id|tmp_v_addr
suffix:semicolon
id|dma_addr_t
id|tmp_p_addr
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
r_int
id|lst_size
comma
id|lst_per_page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nic
)paren
r_return
suffix:semicolon
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
id|lst_size
op_assign
(paren
r_sizeof
(paren
id|TxD_t
)paren
op_star
id|config-&gt;max_txds
)paren
suffix:semicolon
id|lst_per_page
op_assign
id|PAGE_SIZE
op_div
id|lst_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;tx_fifo_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|page_num
op_assign
id|TXD_MEM_PAGE_CNT
c_func
(paren
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
comma
id|lst_per_page
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|page_num
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
id|mem_blks
op_assign
(paren
id|j
op_star
id|lst_per_page
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nic-&gt;list_info
(braket
id|i
)braket
(braket
id|mem_blks
)braket
dot
id|list_virt_addr
)paren
r_break
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|nic-&gt;pdev
comma
id|PAGE_SIZE
comma
id|nic-&gt;list_info
(braket
id|i
)braket
(braket
id|mem_blks
)braket
dot
id|list_virt_addr
comma
id|nic-&gt;list_info
(braket
id|i
)braket
(braket
id|mem_blks
)braket
dot
id|list_phy_addr
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|nic-&gt;list_info
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_2BUFF_MODE
id|size
op_assign
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|RxD_t
)paren
)paren
suffix:semicolon
macro_line|#else
id|size
op_assign
id|SIZE_OF_BLOCK
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|blk_cnt
op_assign
id|nic-&gt;block_count
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|blk_cnt
suffix:semicolon
id|j
op_increment
)paren
(brace
id|tmp_v_addr
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|block_virt_addr
suffix:semicolon
id|tmp_p_addr
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|block_dma_addr
suffix:semicolon
r_if
c_cond
(paren
id|tmp_v_addr
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|nic-&gt;pdev
comma
id|size
comma
id|tmp_v_addr
comma
id|tmp_p_addr
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_2BUFF_MODE
multiline_comment|/* Freeing buffer storage addresses in 2BUFF mode. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|blk_cnt
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_div
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|blk_cnt
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
id|k
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nic-&gt;ba
(braket
id|i
)braket
(braket
id|j
)braket
)paren
r_continue
suffix:semicolon
r_while
c_loop
(paren
id|k
op_ne
id|MAX_RXDS_PER_BLOCK
)paren
(brace
id|buffAdd_t
op_star
id|ba
op_assign
op_amp
id|nic-&gt;ba
(braket
id|i
)braket
(braket
id|j
)braket
(braket
id|k
)braket
suffix:semicolon
id|kfree
c_func
(paren
id|ba-&gt;ba_0_org
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ba-&gt;ba_1_org
)paren
suffix:semicolon
id|k
op_increment
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|nic-&gt;ba
(braket
id|i
)braket
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nic-&gt;ba
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
id|nic-&gt;ba
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|mac_control-&gt;stats_mem
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|nic-&gt;pdev
comma
id|mac_control-&gt;stats_mem_sz
comma
id|mac_control-&gt;stats_mem
comma
id|mac_control-&gt;stats_mem_phy
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**  &n; *  init_nic - Initialization of hardware &n; *  @nic: device peivate variable&n; *  Description: The function sequentially configures every block &n; *  of the H/W from their reset values. &n; *  Return Value:  SUCCESS on success and &n; *  &squot;-1&squot; on failure (endian settings incorrect).&n; */
DECL|function|init_nic
r_static
r_int
id|init_nic
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|nic-&gt;dev
suffix:semicolon
r_register
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
r_void
op_star
id|add
suffix:semicolon
id|u32
id|time
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
r_int
id|mdio_cnt
op_assign
l_int|0
comma
id|dtx_cnt
op_assign
l_int|0
suffix:semicolon
r_int
r_int
r_int
id|print_var
comma
id|mem_share
suffix:semicolon
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
multiline_comment|/* &n;&t; * Set proper endian settings and verify the same by &n;&t; * reading the PIF Feed-back register.&n;&t; */
macro_line|#ifdef  __BIG_ENDIAN
multiline_comment|/*&n;&t; * The device by default set to a big endian format, so &n;&t; * a big endian driver need not set anything.&n;&t; */
id|writeq
c_func
(paren
l_int|0xffffffffffffffffULL
comma
op_amp
id|bar0-&gt;swapper_ctrl
)paren
suffix:semicolon
id|val64
op_assign
(paren
id|SWAPPER_CTRL_PIF_R_FE
op_or
id|SWAPPER_CTRL_PIF_R_SE
op_or
id|SWAPPER_CTRL_PIF_W_FE
op_or
id|SWAPPER_CTRL_PIF_W_SE
op_or
id|SWAPPER_CTRL_TXP_FE
op_or
id|SWAPPER_CTRL_TXP_SE
op_or
id|SWAPPER_CTRL_TXD_R_FE
op_or
id|SWAPPER_CTRL_TXD_W_FE
op_or
id|SWAPPER_CTRL_TXF_R_FE
op_or
id|SWAPPER_CTRL_RXD_R_FE
op_or
id|SWAPPER_CTRL_RXD_W_FE
op_or
id|SWAPPER_CTRL_RXF_W_FE
op_or
id|SWAPPER_CTRL_XMSI_FE
op_or
id|SWAPPER_CTRL_XMSI_SE
op_or
id|SWAPPER_CTRL_STATS_FE
op_or
id|SWAPPER_CTRL_STATS_SE
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;swapper_ctrl
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* &n;&t; * Initially we enable all bits to make it accessible by &n;&t; * the driver, then we selectively enable only those bits &n;&t; * that we want to set.&n;&t; */
id|writeq
c_func
(paren
l_int|0xffffffffffffffffULL
comma
op_amp
id|bar0-&gt;swapper_ctrl
)paren
suffix:semicolon
id|val64
op_assign
(paren
id|SWAPPER_CTRL_PIF_R_FE
op_or
id|SWAPPER_CTRL_PIF_R_SE
op_or
id|SWAPPER_CTRL_PIF_W_FE
op_or
id|SWAPPER_CTRL_PIF_W_SE
op_or
id|SWAPPER_CTRL_TXP_FE
op_or
id|SWAPPER_CTRL_TXP_SE
op_or
id|SWAPPER_CTRL_TXD_R_FE
op_or
id|SWAPPER_CTRL_TXD_R_SE
op_or
id|SWAPPER_CTRL_TXD_W_FE
op_or
id|SWAPPER_CTRL_TXD_W_SE
op_or
id|SWAPPER_CTRL_TXF_R_FE
op_or
id|SWAPPER_CTRL_RXD_R_FE
op_or
id|SWAPPER_CTRL_RXD_R_SE
op_or
id|SWAPPER_CTRL_RXD_W_FE
op_or
id|SWAPPER_CTRL_RXD_W_SE
op_or
id|SWAPPER_CTRL_RXF_W_FE
op_or
id|SWAPPER_CTRL_XMSI_FE
op_or
id|SWAPPER_CTRL_XMSI_SE
op_or
id|SWAPPER_CTRL_STATS_FE
op_or
id|SWAPPER_CTRL_STATS_SE
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;swapper_ctrl
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* &n;&t; * Verifying if endian settings are accurate by &n;&t; * reading a feedback register.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;pif_rd_swapper_fb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_ne
l_int|0x0123456789ABCDEFULL
)paren
(brace
multiline_comment|/* Endian settings are incorrect, calls for another dekko. */
id|print_var
op_assign
(paren
r_int
r_int
r_int
)paren
id|val64
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INIT_DBG
comma
l_string|&quot;%s: Endian settings are wrong&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;, feedback read %llx&bslash;n&quot;
comma
id|print_var
)paren
suffix:semicolon
r_return
id|FAILURE
suffix:semicolon
)brace
multiline_comment|/* Remove XGXS from reset state */
id|val64
op_assign
l_int|0
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;sw_reset
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;sw_reset
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/*  Enable Receiving broadcasts */
id|add
op_assign
(paren
r_void
op_star
)paren
op_amp
id|bar0-&gt;mac_cfg
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_cfg
)paren
suffix:semicolon
id|val64
op_or_assign
id|MAC_RMAC_BCAST_ENABLE
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_CFG_KEY
c_func
(paren
l_int|0x4C0D
)paren
comma
op_amp
id|bar0-&gt;rmac_cfg_key
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|val64
comma
id|add
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_CFG_KEY
c_func
(paren
l_int|0x4C0D
)paren
comma
op_amp
id|bar0-&gt;rmac_cfg_key
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
(paren
id|val64
op_rshift
l_int|32
)paren
comma
(paren
id|add
op_plus
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* Read registers in all blocks */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_int_mask
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mc_int_mask
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;xgxs_int_mask
)paren
suffix:semicolon
multiline_comment|/*  Set MTU */
id|val64
op_assign
id|dev-&gt;mtu
suffix:semicolon
id|writeq
c_func
(paren
id|vBIT
c_func
(paren
id|val64
comma
l_int|2
comma
l_int|14
)paren
comma
op_amp
id|bar0-&gt;rmac_max_pyld_len
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Configuring the XAUI Interface of Xena. &n;&t; * ***************************************&n;&t; * To Configure the Xena&squot;s XAUI, one has to write a series &n;&t; * of 64 bit values into two registers in a particular &n;&t; * sequence. Hence a macro &squot;SWITCH_SIGN&squot; has been defined &n;&t; * which will be defined in the array of configuration values &n;&t; * (default_dtx_cfg &amp; default_mdio_cfg) at appropriate places &n;&t; * to switch writing from one regsiter to another. We continue &n;&t; * writing these values until we encounter the &squot;END_SIGN&squot; macro.&n;&t; * For example, After making a series of 21 writes into &n;&t; * dtx_control register the &squot;SWITCH_SIGN&squot; appears and hence we &n;&t; * start writing into mdio_control until we encounter END_SIGN.&n;&t; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|dtx_cfg
suffix:colon
r_while
c_loop
(paren
id|default_dtx_cfg
(braket
id|dtx_cnt
)braket
op_ne
id|END_SIGN
)paren
(brace
r_if
c_cond
(paren
id|default_dtx_cfg
(braket
id|dtx_cnt
)braket
op_eq
id|SWITCH_SIGN
)paren
(brace
id|dtx_cnt
op_increment
suffix:semicolon
r_goto
id|mdio_cfg
suffix:semicolon
)brace
id|SPECIAL_REG_WRITE
c_func
(paren
id|default_dtx_cfg
(braket
id|dtx_cnt
)braket
comma
op_amp
id|bar0-&gt;dtx_control
comma
id|UF
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;dtx_control
)paren
suffix:semicolon
id|dtx_cnt
op_increment
suffix:semicolon
)brace
id|mdio_cfg
suffix:colon
r_while
c_loop
(paren
id|default_mdio_cfg
(braket
id|mdio_cnt
)braket
op_ne
id|END_SIGN
)paren
(brace
r_if
c_cond
(paren
id|default_mdio_cfg
(braket
id|mdio_cnt
)braket
op_eq
id|SWITCH_SIGN
)paren
(brace
id|mdio_cnt
op_increment
suffix:semicolon
r_goto
id|dtx_cfg
suffix:semicolon
)brace
id|SPECIAL_REG_WRITE
c_func
(paren
id|default_mdio_cfg
(braket
id|mdio_cnt
)braket
comma
op_amp
id|bar0-&gt;mdio_control
comma
id|UF
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mdio_control
)paren
suffix:semicolon
id|mdio_cnt
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|default_dtx_cfg
(braket
id|dtx_cnt
)braket
op_eq
id|END_SIGN
)paren
op_logical_and
(paren
id|default_mdio_cfg
(braket
id|mdio_cnt
)braket
op_eq
id|END_SIGN
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_else
(brace
r_goto
id|dtx_cfg
suffix:semicolon
)brace
)brace
multiline_comment|/*  Tx DMA Initialization */
id|val64
op_assign
l_int|0
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_0
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_1
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_2
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_3
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;tx_fifo_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val64
op_or_assign
id|vBIT
c_func
(paren
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
op_minus
l_int|1
comma
(paren
(paren
id|i
op_star
l_int|32
)paren
op_plus
l_int|19
)paren
comma
l_int|13
)paren
op_or
id|vBIT
c_func
(paren
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_priority
comma
(paren
(paren
id|i
op_star
l_int|32
)paren
op_plus
l_int|5
)paren
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
(paren
id|config-&gt;tx_fifo_num
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|2
op_eq
l_int|0
)paren
id|i
op_increment
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|1
suffix:colon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_0
)paren
suffix:semicolon
id|val64
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_1
)paren
suffix:semicolon
id|val64
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_2
)paren
suffix:semicolon
id|val64
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_3
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Enable Tx FIFO partition 0. */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;tx_fifo_partition_0
)paren
suffix:semicolon
id|val64
op_or_assign
id|BIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* To enable the FIFO partition. */
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_fifo_partition_0
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;tx_fifo_partition_0
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INIT_DBG
comma
l_string|&quot;Fifo partition at: 0x%p is: 0x%llx&bslash;n&quot;
comma
op_amp
id|bar0-&gt;tx_fifo_partition_0
comma
(paren
r_int
r_int
r_int
)paren
id|val64
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Initialization of Tx_PA_CONFIG register to ignore packet &n;&t; * integrity checking.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;tx_pa_cfg
)paren
suffix:semicolon
id|val64
op_or_assign
id|TX_PA_CFG_IGNORE_FRM_ERR
op_or
id|TX_PA_CFG_IGNORE_SNAP_OUI
op_or
id|TX_PA_CFG_IGNORE_LLC_CTRL
op_or
id|TX_PA_CFG_IGNORE_L2_ERR
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_pa_cfg
)paren
suffix:semicolon
multiline_comment|/* Rx DMA intialization. */
id|val64
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val64
op_or_assign
id|vBIT
c_func
(paren
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|ring_priority
comma
(paren
l_int|5
op_plus
(paren
id|i
op_star
l_int|8
)paren
)paren
comma
l_int|3
)paren
suffix:semicolon
)brace
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rx_queue_priority
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Allocating equal share of memory to all the &n;&t; * configured Rings.&n;&t; */
id|val64
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
id|mem_share
op_assign
(paren
l_int|64
op_div
id|config-&gt;rx_ring_num
op_plus
l_int|64
op_mod
id|config-&gt;rx_ring_num
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_QUEUE_CFG_Q0_SZ
c_func
(paren
id|mem_share
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_int|1
suffix:colon
id|mem_share
op_assign
(paren
l_int|64
op_div
id|config-&gt;rx_ring_num
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_QUEUE_CFG_Q1_SZ
c_func
(paren
id|mem_share
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_int|2
suffix:colon
id|mem_share
op_assign
(paren
l_int|64
op_div
id|config-&gt;rx_ring_num
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_QUEUE_CFG_Q2_SZ
c_func
(paren
id|mem_share
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_int|3
suffix:colon
id|mem_share
op_assign
(paren
l_int|64
op_div
id|config-&gt;rx_ring_num
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_QUEUE_CFG_Q3_SZ
c_func
(paren
id|mem_share
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_int|4
suffix:colon
id|mem_share
op_assign
(paren
l_int|64
op_div
id|config-&gt;rx_ring_num
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_QUEUE_CFG_Q4_SZ
c_func
(paren
id|mem_share
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_int|5
suffix:colon
id|mem_share
op_assign
(paren
l_int|64
op_div
id|config-&gt;rx_ring_num
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_QUEUE_CFG_Q5_SZ
c_func
(paren
id|mem_share
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_int|6
suffix:colon
id|mem_share
op_assign
(paren
l_int|64
op_div
id|config-&gt;rx_ring_num
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_QUEUE_CFG_Q6_SZ
c_func
(paren
id|mem_share
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_int|7
suffix:colon
id|mem_share
op_assign
(paren
l_int|64
op_div
id|config-&gt;rx_ring_num
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_QUEUE_CFG_Q7_SZ
c_func
(paren
id|mem_share
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rx_queue_cfg
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Initializing the Tx round robin registers to 0.&n;&t; * Filling Tx and Rx round robin registers as per the &n;&t; * number of FIFOs and Rings is still TODO.&n;&t; */
id|writeq
c_func
(paren
l_int|0
comma
op_amp
id|bar0-&gt;tx_w_round_robin_0
)paren
suffix:semicolon
id|writeq
c_func
(paren
l_int|0
comma
op_amp
id|bar0-&gt;tx_w_round_robin_1
)paren
suffix:semicolon
id|writeq
c_func
(paren
l_int|0
comma
op_amp
id|bar0-&gt;tx_w_round_robin_2
)paren
suffix:semicolon
id|writeq
c_func
(paren
l_int|0
comma
op_amp
id|bar0-&gt;tx_w_round_robin_3
)paren
suffix:semicolon
id|writeq
c_func
(paren
l_int|0
comma
op_amp
id|bar0-&gt;tx_w_round_robin_4
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * TODO&n;&t; * Disable Rx steering. Hard coding all packets be steered to&n;&t; * Queue 0 for now. &n;&t; */
id|val64
op_assign
l_int|0x8080808080808080ULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rts_qos_steering
)paren
suffix:semicolon
multiline_comment|/* UDP Fix */
id|val64
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rts_frm_len_n
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Set rts_frm_len register for fifo 0 */
id|writeq
c_func
(paren
id|MAC_RTS_FRM_LEN_SET
c_func
(paren
id|dev-&gt;mtu
op_plus
l_int|22
)paren
comma
op_amp
id|bar0-&gt;rts_frm_len_n
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Enable statistics */
id|writeq
c_func
(paren
id|mac_control-&gt;stats_mem_phy
comma
op_amp
id|bar0-&gt;stat_addr
)paren
suffix:semicolon
id|val64
op_assign
id|SET_UPDT_PERIOD
c_func
(paren
id|Stats_refresh_time
)paren
op_or
id|STAT_CFG_STAT_RO
op_or
id|STAT_CFG_STAT_EN
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;stat_cfg
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Initializing the sampling rate for the device to calculate the&n;&t; * bandwidth utilization.&n;&t; */
id|val64
op_assign
id|MAC_TX_LINK_UTIL_VAL
c_func
(paren
id|tmac_util_period
)paren
op_or
id|MAC_RX_LINK_UTIL_VAL
c_func
(paren
id|rmac_util_period
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mac_link_util
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Initializing the Transmit and Receive Traffic Interrupt &n;&t; * Scheme.&n;&t; */
multiline_comment|/* TTI Initialization */
id|val64
op_assign
id|TTI_DATA1_MEM_TX_TIMER_VAL
c_func
(paren
l_int|0xFFF
)paren
op_or
id|TTI_DATA1_MEM_TX_URNG_A
c_func
(paren
l_int|0xA
)paren
op_or
id|TTI_DATA1_MEM_TX_URNG_B
c_func
(paren
l_int|0x10
)paren
op_or
id|TTI_DATA1_MEM_TX_URNG_C
c_func
(paren
l_int|0x30
)paren
op_or
id|TTI_DATA1_MEM_TX_TIMER_AC_EN
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tti_data1_mem
)paren
suffix:semicolon
id|val64
op_assign
id|TTI_DATA2_MEM_TX_UFC_A
c_func
(paren
l_int|0x10
)paren
op_or
id|TTI_DATA2_MEM_TX_UFC_B
c_func
(paren
l_int|0x20
)paren
op_or
id|TTI_DATA2_MEM_TX_UFC_C
c_func
(paren
l_int|0x40
)paren
op_or
id|TTI_DATA2_MEM_TX_UFC_D
c_func
(paren
l_int|0x80
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tti_data2_mem
)paren
suffix:semicolon
id|val64
op_assign
id|TTI_CMD_MEM_WE
op_or
id|TTI_CMD_MEM_STROBE_NEW_CMD
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tti_command_mem
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Once the operation completes, the Strobe bit of the command&n;&t; * register will be reset. We poll for this particular condition&n;&t; * We wait for a maximum of 500ms for the operation to complete,&n;&t; * if it&squot;s not complete by then we return error.&n;&t; */
id|time
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|TRUE
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;tti_command_mem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val64
op_amp
id|TTI_CMD_MEM_STROBE_NEW_CMD
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time
OG
l_int|10
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: TTI init Failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|time
op_increment
suffix:semicolon
)brace
multiline_comment|/* RTI Initialization */
id|val64
op_assign
id|RTI_DATA1_MEM_RX_TIMER_VAL
c_func
(paren
l_int|0xFFF
)paren
op_or
id|RTI_DATA1_MEM_RX_URNG_A
c_func
(paren
l_int|0xA
)paren
op_or
id|RTI_DATA1_MEM_RX_URNG_B
c_func
(paren
l_int|0x10
)paren
op_or
id|RTI_DATA1_MEM_RX_URNG_C
c_func
(paren
l_int|0x30
)paren
op_or
id|RTI_DATA1_MEM_RX_TIMER_AC_EN
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rti_data1_mem
)paren
suffix:semicolon
id|val64
op_assign
id|RTI_DATA2_MEM_RX_UFC_A
c_func
(paren
l_int|0x1
)paren
op_or
id|RTI_DATA2_MEM_RX_UFC_B
c_func
(paren
l_int|0x2
)paren
op_or
id|RTI_DATA2_MEM_RX_UFC_C
c_func
(paren
l_int|0x40
)paren
op_or
id|RTI_DATA2_MEM_RX_UFC_D
c_func
(paren
l_int|0x80
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rti_data2_mem
)paren
suffix:semicolon
id|val64
op_assign
id|RTI_CMD_MEM_WE
op_or
id|RTI_CMD_MEM_STROBE_NEW_CMD
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rti_command_mem
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Once the operation completes, the Strobe bit of the command&n;&t; * register will be reset. We poll for this particular condition&n;&t; * We wait for a maximum of 500ms for the operation to complete,&n;&t; * if it&squot;s not complete by then we return error.&n;&t; */
id|time
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|TRUE
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rti_command_mem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val64
op_amp
id|TTI_CMD_MEM_STROBE_NEW_CMD
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time
OG
l_int|10
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: RTI init Failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|time
op_increment
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * Initializing proper values as Pause threshold into all &n;&t; * the 8 Queues on Rx side.&n;&t; */
id|writeq
c_func
(paren
l_int|0xffbbffbbffbbffbbULL
comma
op_amp
id|bar0-&gt;mc_pause_thresh_q0q3
)paren
suffix:semicolon
id|writeq
c_func
(paren
l_int|0xffbbffbbffbbffbbULL
comma
op_amp
id|bar0-&gt;mc_pause_thresh_q4q7
)paren
suffix:semicolon
multiline_comment|/* Disable RMAC PAD STRIPPING */
id|add
op_assign
(paren
r_void
op_star
)paren
op_amp
id|bar0-&gt;mac_cfg
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_cfg
)paren
suffix:semicolon
id|val64
op_and_assign
op_complement
(paren
id|MAC_CFG_RMAC_STRIP_PAD
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_CFG_KEY
c_func
(paren
l_int|0x4C0D
)paren
comma
op_amp
id|bar0-&gt;rmac_cfg_key
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
(paren
id|val64
)paren
comma
id|add
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_CFG_KEY
c_func
(paren
l_int|0x4C0D
)paren
comma
op_amp
id|bar0-&gt;rmac_cfg_key
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
(paren
id|val64
op_rshift
l_int|32
)paren
comma
(paren
id|add
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_cfg
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Set the time value to be inserted in the pause frame &n;&t; * generated by xena.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rmac_pause_cfg
)paren
suffix:semicolon
id|val64
op_and_assign
op_complement
(paren
id|RMAC_PAUSE_HG_PTIME
c_func
(paren
l_int|0xffff
)paren
)paren
suffix:semicolon
id|val64
op_or_assign
id|RMAC_PAUSE_HG_PTIME
c_func
(paren
id|nic-&gt;mac_control.rmac_pause_time
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rmac_pause_cfg
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Set the Threshold Limit for Generating the pause frame&n;&t; * If the amount of data in any Queue exceeds ratio of&n;&t; * (mac_control.mc_pause_threshold_q0q3 or q4q7)/256&n;&t; * pause frame is generated&n;&t; */
id|val64
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val64
op_or_assign
(paren
(paren
(paren
id|u64
)paren
l_int|0xFF00
op_or
id|nic-&gt;mac_control
dot
id|mc_pause_threshold_q0q3
)paren
op_lshift
(paren
id|i
op_star
l_int|2
op_star
l_int|8
)paren
)paren
suffix:semicolon
)brace
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_pause_thresh_q0q3
)paren
suffix:semicolon
id|val64
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val64
op_or_assign
(paren
(paren
(paren
id|u64
)paren
l_int|0xFF00
op_or
id|nic-&gt;mac_control
dot
id|mc_pause_threshold_q4q7
)paren
op_lshift
(paren
id|i
op_star
l_int|2
op_star
l_int|8
)paren
)paren
suffix:semicolon
)brace
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_pause_thresh_q4q7
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * TxDMA will stop Read request if the number of read split has &n;&t; * exceeded the limit pointed by shared_splits&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;pic_control
)paren
suffix:semicolon
id|val64
op_or_assign
id|PIC_CNTL_SHARED_SPLITS
c_func
(paren
id|shared_splits
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;pic_control
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**  &n; *  en_dis_able_nic_intrs - Enable or Disable the interrupts &n; *  @nic: device private variable,&n; *  @mask: A mask indicating which Intr block must be modified and,&n; *  @flag: A flag indicating whether to enable or disable the Intrs.&n; *  Description: This function will either disable or enable the interrupts&n; *  depending on the flag argument. The mask argument can be used to &n; *  enable/disable any Intr block. &n; *  Return Value: NONE.&n; */
DECL|function|en_dis_able_nic_intrs
r_static
r_void
id|en_dis_able_nic_intrs
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
comma
id|u16
id|mask
comma
r_int
id|flag
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
r_register
id|u64
id|val64
op_assign
l_int|0
comma
id|temp64
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  Top level interrupt classification */
multiline_comment|/*  PIC Interrupts */
r_if
c_cond
(paren
(paren
id|mask
op_amp
(paren
id|TX_PIC_INTR
op_or
id|RX_PIC_INTR
)paren
)paren
)paren
(brace
multiline_comment|/*  Enable PIC Intrs in the general intr mask register */
id|val64
op_assign
id|TXPIC_INT_M
op_or
id|PIC_RX_INT_M
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|ENABLE_INTRS
)paren
(brace
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
multiline_comment|/*  &n;&t;&t;&t; * Disabled all PCIX, Flash, MDIO, IIC and GPIO&n;&t;&t;&t; * interrupts for now. &n;&t;&t;&t; * TODO &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;pic_int_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * No MSI Support is available presently, so TTI and&n;&t;&t;&t; * RTI interrupts are also disabled.&n;&t;&t;&t; */
)brace
r_else
r_if
c_cond
(paren
id|flag
op_eq
id|DISABLE_INTRS
)paren
(brace
multiline_comment|/*  &n;&t;&t;&t; * Disable PIC Intrs in the general &n;&t;&t;&t; * intr mask register &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;pic_int_mask
)paren
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|val64
op_or_assign
id|temp64
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  DMA Interrupts */
multiline_comment|/*  Enabling/Disabling Tx DMA interrupts */
r_if
c_cond
(paren
id|mask
op_amp
id|TX_DMA_INTR
)paren
(brace
multiline_comment|/* Enable TxDMA Intrs in the general intr mask register */
id|val64
op_assign
id|TXDMA_INT_M
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|ENABLE_INTRS
)paren
(brace
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Keep all interrupts other than PFC interrupt &n;&t;&t;&t; * and PCC interrupt disabled in DMA level.&n;&t;&t;&t; */
id|val64
op_assign
id|DISABLE_ALL_INTRS
op_amp
op_complement
(paren
id|TXDMA_PFC_INT_M
op_or
id|TXDMA_PCC_INT_M
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;txdma_int_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Enable only the MISC error 1 interrupt in PFC block &n;&t;&t;&t; */
id|val64
op_assign
id|DISABLE_ALL_INTRS
op_amp
(paren
op_complement
id|PFC_MISC_ERR_1
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;pfc_err_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Enable only the FB_ECC error interrupt in PCC block &n;&t;&t;&t; */
id|val64
op_assign
id|DISABLE_ALL_INTRS
op_amp
(paren
op_complement
id|PCC_FB_ECC_ERR
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;pcc_err_mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_eq
id|DISABLE_INTRS
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * Disable TxDMA Intrs in the general intr mask &n;&t;&t;&t; * register &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;txdma_int_mask
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;pfc_err_mask
)paren
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|val64
op_or_assign
id|temp64
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  Enabling/Disabling Rx DMA interrupts */
r_if
c_cond
(paren
id|mask
op_amp
id|RX_DMA_INTR
)paren
(brace
multiline_comment|/*  Enable RxDMA Intrs in the general intr mask register */
id|val64
op_assign
id|RXDMA_INT_M
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|ENABLE_INTRS
)paren
(brace
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * All RxDMA block interrupts are disabled for now &n;&t;&t;&t; * TODO &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;rxdma_int_mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_eq
id|DISABLE_INTRS
)paren
(brace
multiline_comment|/*  &n;&t;&t;&t; * Disable RxDMA Intrs in the general intr mask &n;&t;&t;&t; * register &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;rxdma_int_mask
)paren
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|val64
op_or_assign
id|temp64
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  MAC Interrupts */
multiline_comment|/*  Enabling/Disabling MAC interrupts */
r_if
c_cond
(paren
id|mask
op_amp
(paren
id|TX_MAC_INTR
op_or
id|RX_MAC_INTR
)paren
)paren
(brace
id|val64
op_assign
id|TXMAC_INT_M
op_or
id|RXMAC_INT_M
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|ENABLE_INTRS
)paren
(brace
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * All MAC block error interrupts are disabled for now &n;&t;&t;&t; * except the link status change interrupt.&n;&t;&t;&t; * TODO&n;&t;&t;&t; */
id|val64
op_assign
id|MAC_INT_STATUS_RMAC_INT
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;mac_int_mask
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_rmac_err_mask
)paren
suffix:semicolon
id|val64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|RMAC_LINK_STATE_CHANGE_INT
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mac_rmac_err_mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_eq
id|DISABLE_INTRS
)paren
(brace
multiline_comment|/*  &n;&t;&t;&t; * Disable MAC Intrs in the general intr mask register &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;mac_int_mask
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;mac_rmac_err_mask
)paren
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|val64
op_or_assign
id|temp64
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  XGXS Interrupts */
r_if
c_cond
(paren
id|mask
op_amp
(paren
id|TX_XGXS_INTR
op_or
id|RX_XGXS_INTR
)paren
)paren
(brace
id|val64
op_assign
id|TXXGXS_INT_M
op_or
id|RXXGXS_INT_M
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|ENABLE_INTRS
)paren
(brace
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * All XGXS block error interrupts are disabled for now&n;&t;&t;&t; * TODO &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;xgxs_int_mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_eq
id|DISABLE_INTRS
)paren
(brace
multiline_comment|/*  &n;&t;&t;&t; * Disable MC Intrs in the general intr mask register &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;xgxs_int_mask
)paren
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|val64
op_or_assign
id|temp64
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  Memory Controller(MC) interrupts */
r_if
c_cond
(paren
id|mask
op_amp
id|MC_INTR
)paren
(brace
id|val64
op_assign
id|MC_INT_M
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|ENABLE_INTRS
)paren
(brace
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * All MC block error interrupts are disabled for now&n;&t;&t;&t; * TODO &n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;mc_int_mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_eq
id|DISABLE_INTRS
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Disable MC Intrs in the general intr mask register&n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;mc_int_mask
)paren
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|val64
op_or_assign
id|temp64
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  Tx traffic interrupts */
r_if
c_cond
(paren
id|mask
op_amp
id|TX_TRAFFIC_INTR
)paren
(brace
id|val64
op_assign
id|TXTRAFFIC_INT_M
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|ENABLE_INTRS
)paren
(brace
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Enable all the Tx side interrupts&n;&t;&t;&t; * writing 0 Enables all 64 TX interrupt levels &n;&t;&t;&t; */
id|writeq
c_func
(paren
l_int|0x0
comma
op_amp
id|bar0-&gt;tx_traffic_mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_eq
id|DISABLE_INTRS
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * Disable Tx Traffic Intrs in the general intr mask &n;&t;&t;&t; * register.&n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;tx_traffic_mask
)paren
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|val64
op_or_assign
id|temp64
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  Rx traffic interrupts */
r_if
c_cond
(paren
id|mask
op_amp
id|RX_TRAFFIC_INTR
)paren
(brace
id|val64
op_assign
id|RXTRAFFIC_INT_M
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|ENABLE_INTRS
)paren
(brace
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|temp64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|temp64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
multiline_comment|/* writing 0 Enables all 8 RX interrupt levels */
id|writeq
c_func
(paren
l_int|0x0
comma
op_amp
id|bar0-&gt;rx_traffic_mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_eq
id|DISABLE_INTRS
)paren
(brace
multiline_comment|/*  &n;&t;&t;&t; * Disable Rx Traffic Intrs in the general intr mask &n;&t;&t;&t; * register.&n;&t;&t;&t; */
id|writeq
c_func
(paren
id|DISABLE_ALL_INTRS
comma
op_amp
id|bar0-&gt;rx_traffic_mask
)paren
suffix:semicolon
id|temp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
id|val64
op_or_assign
id|temp64
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;general_int_mask
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**  &n; *  verify_xena_quiescence - Checks whether the H/W is ready &n; *  @val64 :  Value read from adapter status register.&n; *  @flag : indicates if the adapter enable bit was ever written once&n; *  before.&n; *  Description: Returns whether the H/W is ready to go or not. Depending&n; *  on whether adapter enable bit was written or not the comparison &n; *  differs and the calling function passes the input argument flag to&n; *  indicate this.&n; *  Return: 1 If xena is quiescence &n; *          0 If Xena is not quiescence&n; */
DECL|function|verify_xena_quiescence
r_static
r_int
id|verify_xena_quiescence
c_func
(paren
id|u64
id|val64
comma
r_int
id|flag
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|u64
id|tmp64
op_assign
op_complement
(paren
(paren
id|u64
)paren
id|val64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp64
op_amp
(paren
id|ADAPTER_STATUS_TDMA_READY
op_or
id|ADAPTER_STATUS_RDMA_READY
op_or
id|ADAPTER_STATUS_PFC_READY
op_or
id|ADAPTER_STATUS_TMAC_BUF_EMPTY
op_or
id|ADAPTER_STATUS_PIC_QUIESCENT
op_or
id|ADAPTER_STATUS_MC_DRAM_READY
op_or
id|ADAPTER_STATUS_MC_QUEUES_READY
op_or
id|ADAPTER_STATUS_M_PLL_LOCK
op_or
id|ADAPTER_STATUS_P_PLL_LOCK
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|flag
op_eq
id|FALSE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val64
op_amp
id|ADAPTER_STATUS_RMAC_PCC_IDLE
)paren
op_logical_and
(paren
(paren
id|val64
op_amp
id|ADAPTER_STATUS_RC_PRC_QUIESCENT
)paren
op_eq
id|ADAPTER_STATUS_RC_PRC_QUIESCENT
)paren
)paren
(brace
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
(paren
id|val64
op_amp
id|ADAPTER_STATUS_RMAC_PCC_IDLE
)paren
op_eq
id|ADAPTER_STATUS_RMAC_PCC_IDLE
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|val64
op_amp
id|ADAPTER_STATUS_RC_PRC_QUIESCENT
)paren
op_logical_or
(paren
(paren
id|val64
op_amp
id|ADAPTER_STATUS_RC_PRC_QUIESCENT
)paren
op_eq
id|ADAPTER_STATUS_RC_PRC_QUIESCENT
)paren
)paren
)paren
(brace
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * fix_mac_address -  Fix for Mac addr problem on Alpha platforms&n; * @sp: Pointer to device specifc structure&n; * Description : &n; * New procedure to clear mac address reading  problems on Alpha platforms&n; *&n; */
DECL|function|fix_mac_address
r_void
id|fix_mac_address
c_func
(paren
id|nic_t
op_star
id|sp
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u64
id|val64
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|fix_mac
(braket
id|i
)braket
op_ne
id|END_SIGN
)paren
(brace
id|writeq
c_func
(paren
id|fix_mac
(braket
id|i
op_increment
)braket
comma
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *  start_nic - Turns the device on   &n; *  @nic : device private variable.&n; *  Description: &n; *  This function actually turns the device on. Before this  function is &n; *  called,all Registers are configured from their reset states &n; *  and shared memory is allocated but the NIC is still quiescent. On &n; *  calling this function, the device interrupts are cleared and the NIC is&n; *  literally switched on by writing into the adapter control register.&n; *  Return Value: &n; *  SUCCESS on success and -1 on failure.&n; */
DECL|function|start_nic
r_static
r_int
id|start_nic
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|nic-&gt;dev
suffix:semicolon
r_register
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
id|u16
id|interruptible
comma
id|i
suffix:semicolon
id|u16
id|subid
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
multiline_comment|/*  PRC Initialization and configuration */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeq
c_func
(paren
(paren
id|u64
)paren
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
l_int|0
)braket
dot
id|block_dma_addr
comma
op_amp
id|bar0-&gt;prc_rxd0_n
(braket
id|i
)braket
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;prc_ctrl_n
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_2BUFF_MODE
id|val64
op_or_assign
id|PRC_CTRL_RC_ENABLED
suffix:semicolon
macro_line|#else
id|val64
op_or_assign
id|PRC_CTRL_RC_ENABLED
op_or
id|PRC_CTRL_RING_MODE_3
suffix:semicolon
macro_line|#endif
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;prc_ctrl_n
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_2BUFF_MODE
multiline_comment|/* Enabling 2 buffer mode by writing into Rx_pa_cfg reg. */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rx_pa_cfg
)paren
suffix:semicolon
id|val64
op_or_assign
id|RX_PA_CFG_IGNORE_L2_ERR
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rx_pa_cfg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* &n;&t; * Enabling MC-RLDRAM. After enabling the device, we timeout&n;&t; * for around 100ms, which is approximately the time required&n;&t; * for the device to be ready for operation.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mc_rldram_mrs
)paren
suffix:semicolon
id|val64
op_or_assign
id|MC_RLDRAM_QUEUE_SIZE_ENABLE
op_or
id|MC_RLDRAM_MRS_ENABLE
suffix:semicolon
id|SPECIAL_REG_WRITE
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_mrs
comma
id|UF
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mc_rldram_mrs
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Delay by around 100 ms. */
multiline_comment|/* Enabling ECC Protection. */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|val64
op_and_assign
op_complement
id|ADAPTER_ECC_EN
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Clearing any possible Link state change interrupts that &n;&t; * could have popped up just before Enabling the card.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_rmac_err_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
)paren
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mac_rmac_err_reg
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Verify if the device is ready to be enabled, if so enable &n;&t; * it.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|verify_xena_quiescence
c_func
(paren
id|val64
comma
id|nic-&gt;device_enabled_once
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: device is not ready, &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Adapter status reads: 0x%llx&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|val64
)paren
suffix:semicolon
r_return
id|FAILURE
suffix:semicolon
)brace
multiline_comment|/*  Enable select interrupts */
id|interruptible
op_assign
id|TX_TRAFFIC_INTR
op_or
id|RX_TRAFFIC_INTR
op_or
id|TX_MAC_INTR
op_or
id|RX_MAC_INTR
suffix:semicolon
id|en_dis_able_nic_intrs
c_func
(paren
id|nic
comma
id|interruptible
comma
id|ENABLE_INTRS
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * With some switches, link might be already up at this point.&n;&t; * Because of this weird behavior, when we enable laser, &n;&t; * we may not get link. We need to handle this. We cannot &n;&t; * figure out which switch is misbehaving. So we are forced to &n;&t; * make a global change. &n;&t; */
multiline_comment|/* Enabling Laser. */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|val64
op_or_assign
id|ADAPTER_EOI_TX_ON
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
multiline_comment|/* SXE-002: Initialize link and activity LED */
id|subid
op_assign
id|nic-&gt;pdev-&gt;subsystem_device
suffix:semicolon
r_if
c_cond
(paren
(paren
id|subid
op_amp
l_int|0xFF
)paren
op_ge
l_int|0x07
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_or_assign
l_int|0x0000800000000000ULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_assign
l_int|0x0411040400000000ULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
(paren
r_void
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|bar0
op_plus
l_int|0x2700
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * Don&squot;t see link state interrupts on certain switches, so &n;&t; * directly scheduling a link state task from here.&n;&t; */
id|schedule_work
c_func
(paren
op_amp
id|nic-&gt;set_link_task
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Here we are performing soft reset on XGXS to &n;&t; * force link down. Since link is already up, we will get&n;&t; * link state change interrupt after this reset&n;&t; */
id|SPECIAL_REG_WRITE
c_func
(paren
l_int|0x80010515001E0000ULL
comma
op_amp
id|bar0-&gt;dtx_control
comma
id|UF
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;dtx_control
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|SPECIAL_REG_WRITE
c_func
(paren
l_int|0x80010515001E00E0ULL
comma
op_amp
id|bar0-&gt;dtx_control
comma
id|UF
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;dtx_control
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|SPECIAL_REG_WRITE
c_func
(paren
l_int|0x80070515001F00E4ULL
comma
op_amp
id|bar0-&gt;dtx_control
comma
id|UF
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;dtx_control
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/** &n; *  free_tx_buffers - Free all queued Tx buffers &n; *  @nic : device private variable.&n; *  Description: &n; *  Free all queued Tx buffers.&n; *  Return Value: void &n;*/
DECL|function|free_tx_buffers
r_void
id|free_tx_buffers
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|nic-&gt;dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|TxD_t
op_star
id|txdp
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;tx_fifo_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
op_minus
l_int|1
suffix:semicolon
id|j
op_increment
)paren
(brace
id|txdp
op_assign
(paren
id|TxD_t
op_star
)paren
id|nic-&gt;list_info
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|list_virt_addr
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|txdp
op_member_access_from_pointer
id|Host_Control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|txdp
comma
l_int|0
comma
r_sizeof
(paren
id|TxD_t
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|memset
c_func
(paren
id|txdp
comma
l_int|0
comma
r_sizeof
(paren
id|TxD_t
)paren
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
id|DBG_PRINT
c_func
(paren
id|INTR_DBG
comma
l_string|&quot;%s:forcibly freeing %d skbs on FIFO%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cnt
comma
id|i
)paren
suffix:semicolon
id|mac_control-&gt;tx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;tx_curr_put_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/**  &n; *   stop_nic -  To stop the nic  &n; *   @nic ; device private variable.&n; *   Description: &n; *   This function does exactly the opposite of what the start_nic() &n; *   function does. This function is called to stop the device.&n; *   Return Value:&n; *   void.&n; */
DECL|function|stop_nic
r_static
r_void
id|stop_nic
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
r_register
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
id|u16
id|interruptible
comma
id|i
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
multiline_comment|/*  Disable all interrupts */
id|interruptible
op_assign
id|TX_TRAFFIC_INTR
op_or
id|RX_TRAFFIC_INTR
op_or
id|TX_MAC_INTR
op_or
id|RX_MAC_INTR
suffix:semicolon
id|en_dis_able_nic_intrs
c_func
(paren
id|nic
comma
id|interruptible
comma
id|DISABLE_INTRS
)paren
suffix:semicolon
multiline_comment|/*  Disable PRCs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;prc_ctrl_n
(braket
id|i
)braket
)paren
suffix:semicolon
id|val64
op_and_assign
op_complement
(paren
(paren
id|u64
)paren
id|PRC_CTRL_RC_ENABLED
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;prc_ctrl_n
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**  &n; *  fill_rx_buffers - Allocates the Rx side skbs &n; *  @nic:  device private variable&n; *  @ring_no: ring number &n; *  Description: &n; *  The function allocates Rx side skbs and puts the physical&n; *  address of these buffers into the RxD buffer pointers, so that the NIC&n; *  can DMA the received frame into these locations.&n; *  The NIC supports 3 receive modes, viz&n; *  1. single buffer,&n; *  2. three buffer and&n; *  3. Five buffer modes.&n; *  Each mode defines how many fragments the received frame will be split &n; *  up into by the NIC. The frame is split into L3 header, L4 Header, &n; *  L4 payload in three buffer mode and in 5 buffer mode, L4 payload itself&n; *  is split into 3 fragments. As of now only single buffer mode is&n; *  supported.&n; *   Return Value:&n; *  SUCCESS on success or an appropriate -ve value on failure.&n; */
DECL|function|fill_rx_buffers
r_int
id|fill_rx_buffers
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
comma
r_int
id|ring_no
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|nic-&gt;dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|RxD_t
op_star
id|rxdp
suffix:semicolon
r_int
id|off
comma
id|off1
comma
id|size
comma
id|block_no
comma
id|block_no1
suffix:semicolon
r_int
id|offset
comma
id|offset1
suffix:semicolon
id|u32
id|alloc_tab
op_assign
l_int|0
suffix:semicolon
id|u32
id|alloc_cnt
op_assign
id|nic-&gt;pkt_cnt
(braket
id|ring_no
)braket
op_minus
id|atomic_read
c_func
(paren
op_amp
id|nic-&gt;rx_bufs_left
(braket
id|ring_no
)braket
)paren
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
macro_line|#ifdef CONFIG_2BUFF_MODE
id|RxD_t
op_star
id|rxdpnext
suffix:semicolon
r_int
id|nextblk
suffix:semicolon
id|u64
id|tmp
suffix:semicolon
id|buffAdd_t
op_star
id|ba
suffix:semicolon
id|dma_addr_t
id|rxdpphys
suffix:semicolon
macro_line|#endif
macro_line|#ifndef CONFIG_S2IO_NAPI
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
id|size
op_assign
id|dev-&gt;mtu
op_plus
id|HEADER_ETHERNET_II_802_3_SIZE
op_plus
id|HEADER_802_2_SIZE
op_plus
id|HEADER_SNAP_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|alloc_tab
OL
id|alloc_cnt
)paren
(brace
id|block_no
op_assign
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|block_index
suffix:semicolon
id|block_no1
op_assign
id|mac_control-&gt;rx_curr_get_info
(braket
id|ring_no
)braket
dot
id|block_index
suffix:semicolon
id|off
op_assign
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|offset
suffix:semicolon
id|off1
op_assign
id|mac_control-&gt;rx_curr_get_info
(braket
id|ring_no
)braket
dot
id|offset
suffix:semicolon
macro_line|#ifndef CONFIG_2BUFF_MODE
id|offset
op_assign
id|block_no
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
op_plus
id|off
suffix:semicolon
id|offset1
op_assign
id|block_no1
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
op_plus
id|off1
suffix:semicolon
macro_line|#else
id|offset
op_assign
id|block_no
op_star
(paren
id|MAX_RXDS_PER_BLOCK
)paren
op_plus
id|off
suffix:semicolon
id|offset1
op_assign
id|block_no1
op_star
(paren
id|MAX_RXDS_PER_BLOCK
)paren
op_plus
id|off1
suffix:semicolon
macro_line|#endif
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|ring_no
)braket
(braket
id|block_no
)braket
dot
id|block_virt_addr
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_eq
id|offset1
)paren
op_logical_and
(paren
id|rxdp-&gt;Host_Control
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|INTR_DBG
comma
l_string|&quot;%s: Get and Put&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INTR_DBG
comma
l_string|&quot; info equated&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
macro_line|#ifndef&t;CONFIG_2BUFF_MODE
r_if
c_cond
(paren
id|rxdp-&gt;Control_1
op_eq
id|END_OF_BLOCK
)paren
(brace
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|block_index
op_increment
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|block_index
op_mod_assign
id|nic-&gt;block_count
(braket
id|ring_no
)braket
suffix:semicolon
id|block_no
op_assign
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|block_index
suffix:semicolon
id|off
op_increment
suffix:semicolon
id|off
op_mod_assign
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|offset
op_assign
id|off
suffix:semicolon
id|rxdp
op_assign
(paren
id|RxD_t
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp-&gt;Control_2
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INTR_DBG
comma
l_string|&quot;%s: Next block at: %p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rxdp
)paren
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_S2IO_NAPI
id|spin_lock_irqsave
c_func
(paren
op_amp
id|nic-&gt;put_lock
comma
id|flags
)paren
suffix:semicolon
id|nic-&gt;put_pos
(braket
id|ring_no
)braket
op_assign
(paren
id|block_no
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|off
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|nic-&gt;put_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
macro_line|#else
r_if
c_cond
(paren
id|rxdp-&gt;Host_Control
op_eq
id|END_OF_BLOCK
)paren
(brace
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|block_index
op_increment
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|block_index
op_mod_assign
id|nic-&gt;block_count
(braket
id|ring_no
)braket
suffix:semicolon
id|block_no
op_assign
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|block_index
suffix:semicolon
id|off
op_assign
l_int|0
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INTR_DBG
comma
l_string|&quot;%s: block%d at: 0x%llx&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|block_no
comma
(paren
r_int
r_int
r_int
)paren
id|rxdp-&gt;Control_1
)paren
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|offset
op_assign
id|off
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|ring_no
)braket
(braket
id|block_no
)braket
dot
id|block_virt_addr
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_S2IO_NAPI
id|spin_lock_irqsave
c_func
(paren
op_amp
id|nic-&gt;put_lock
comma
id|flags
)paren
suffix:semicolon
id|nic-&gt;put_pos
(braket
id|ring_no
)braket
op_assign
(paren
id|block_no
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|off
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|nic-&gt;put_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
macro_line|#ifndef&t;CONFIG_2BUFF_MODE
r_if
c_cond
(paren
id|rxdp-&gt;Control_1
op_amp
id|RXD_OWN_XENA
)paren
macro_line|#else
r_if
c_cond
(paren
id|rxdp-&gt;Control_2
op_amp
id|BIT
c_func
(paren
l_int|0
)paren
)paren
macro_line|#endif
(brace
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|offset
op_assign
id|off
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
macro_line|#ifdef&t;CONFIG_2BUFF_MODE
multiline_comment|/* &n;&t;&t; * RxDs Spanning cache lines will be replenished only &n;&t;&t; * if the succeeding RxD is also owned by Host. It &n;&t;&t; * will always be the ((8*i)+3) and ((8*i)+6) &n;&t;&t; * descriptors for the 48 byte descriptor. The offending &n;&t;&t; * decsriptor is of-course the 3rd descriptor.&n;&t;&t; */
id|rxdpphys
op_assign
id|nic-&gt;rx_blocks
(braket
id|ring_no
)braket
(braket
id|block_no
)braket
dot
id|block_dma_addr
op_plus
(paren
id|off
op_star
r_sizeof
(paren
id|RxD_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|u64
)paren
(paren
id|rxdpphys
)paren
)paren
op_mod
l_int|128
OG
l_int|80
)paren
(brace
id|rxdpnext
op_assign
id|nic-&gt;rx_blocks
(braket
id|ring_no
)braket
(braket
id|block_no
)braket
dot
id|block_virt_addr
op_plus
(paren
id|off
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxdpnext-&gt;Host_Control
op_eq
id|END_OF_BLOCK
)paren
(brace
id|nextblk
op_assign
(paren
id|block_no
op_plus
l_int|1
)paren
op_mod
(paren
id|nic-&gt;block_count
(braket
id|ring_no
)braket
)paren
suffix:semicolon
id|rxdpnext
op_assign
id|nic-&gt;rx_blocks
(braket
id|ring_no
)braket
(braket
id|nextblk
)braket
dot
id|block_virt_addr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rxdpnext-&gt;Control_2
op_amp
id|BIT
c_func
(paren
l_int|0
)paren
)paren
r_goto
id|end
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifndef&t;CONFIG_2BUFF_MODE
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|size
op_plus
id|NET_IP_ALIGN
)paren
suffix:semicolon
macro_line|#else
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|dev-&gt;mtu
op_plus
id|ALIGN_SIZE
op_plus
id|BUF0_LEN
op_plus
l_int|4
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Out of &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;memory to allocate SKBs&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#ifndef&t;CONFIG_2BUFF_MODE
id|skb_reserve
c_func
(paren
id|skb
comma
id|NET_IP_ALIGN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|rxdp
comma
l_int|0
comma
r_sizeof
(paren
id|RxD_t
)paren
)paren
suffix:semicolon
id|rxdp-&gt;Buffer0_ptr
op_assign
id|pci_map_single
(paren
id|nic-&gt;pdev
comma
id|skb-&gt;data
comma
id|size
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rxdp-&gt;Control_2
op_and_assign
(paren
op_complement
id|MASK_BUFFER0_SIZE
)paren
suffix:semicolon
id|rxdp-&gt;Control_2
op_or_assign
id|SET_BUFFER0_SIZE
c_func
(paren
id|size
)paren
suffix:semicolon
id|rxdp-&gt;Host_Control
op_assign
(paren
r_int
r_int
)paren
(paren
id|skb
)paren
suffix:semicolon
id|rxdp-&gt;Control_1
op_or_assign
id|RXD_OWN_XENA
suffix:semicolon
id|off
op_increment
suffix:semicolon
id|off
op_mod_assign
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|offset
op_assign
id|off
suffix:semicolon
macro_line|#else
id|ba
op_assign
op_amp
id|nic-&gt;ba
(braket
id|ring_no
)braket
(braket
id|block_no
)braket
(braket
id|off
)braket
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|BUF0_LEN
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|u64
)paren
id|skb-&gt;data
suffix:semicolon
id|tmp
op_add_assign
id|ALIGN_SIZE
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|ALIGN_SIZE
suffix:semicolon
id|skb-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|tmp
suffix:semicolon
id|skb-&gt;tail
op_assign
(paren
r_void
op_star
)paren
id|tmp
suffix:semicolon
id|memset
c_func
(paren
id|rxdp
comma
l_int|0
comma
r_sizeof
(paren
id|RxD_t
)paren
)paren
suffix:semicolon
id|rxdp-&gt;Buffer2_ptr
op_assign
id|pci_map_single
(paren
id|nic-&gt;pdev
comma
id|skb-&gt;data
comma
id|dev-&gt;mtu
op_plus
id|BUF0_LEN
op_plus
l_int|4
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rxdp-&gt;Buffer0_ptr
op_assign
id|pci_map_single
c_func
(paren
id|nic-&gt;pdev
comma
id|ba-&gt;ba_0
comma
id|BUF0_LEN
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rxdp-&gt;Buffer1_ptr
op_assign
id|pci_map_single
c_func
(paren
id|nic-&gt;pdev
comma
id|ba-&gt;ba_1
comma
id|BUF1_LEN
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rxdp-&gt;Control_2
op_assign
id|SET_BUFFER2_SIZE
c_func
(paren
id|dev-&gt;mtu
op_plus
l_int|4
)paren
suffix:semicolon
id|rxdp-&gt;Control_2
op_or_assign
id|SET_BUFFER0_SIZE
c_func
(paren
id|BUF0_LEN
)paren
suffix:semicolon
id|rxdp-&gt;Control_2
op_or_assign
id|SET_BUFFER1_SIZE
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* dummy. */
id|rxdp-&gt;Control_2
op_or_assign
id|BIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set Buffer_Empty bit. */
id|rxdp-&gt;Host_Control
op_assign
(paren
id|u64
)paren
(paren
(paren
r_int
r_int
)paren
(paren
id|skb
)paren
)paren
suffix:semicolon
id|rxdp-&gt;Control_1
op_or_assign
id|RXD_OWN_XENA
suffix:semicolon
id|off
op_increment
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|ring_no
)braket
dot
id|offset
op_assign
id|off
suffix:semicolon
macro_line|#endif
id|atomic_inc
c_func
(paren
op_amp
id|nic-&gt;rx_bufs_left
(braket
id|ring_no
)braket
)paren
suffix:semicolon
id|alloc_tab
op_increment
suffix:semicolon
)brace
id|end
suffix:colon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**&n; *  free_rx_buffers - Frees all Rx buffers   &n; *  @sp: device private variable.&n; *  Description: &n; *  This function will free all Rx buffers allocated by host.&n; *  Return Value:&n; *  NONE.&n; */
DECL|function|free_rx_buffers
r_static
r_void
id|free_rx_buffers
c_func
(paren
r_struct
id|s2io_nic
op_star
id|sp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|sp-&gt;dev
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|blk
op_assign
l_int|0
comma
id|off
comma
id|buf_cnt
op_assign
l_int|0
suffix:semicolon
id|RxD_t
op_star
id|rxdp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
macro_line|#ifdef CONFIG_2BUFF_MODE
id|buffAdd_t
op_star
id|ba
suffix:semicolon
macro_line|#endif
id|mac_control
op_assign
op_amp
id|sp-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|sp-&gt;config
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|blk
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
suffix:semicolon
id|j
op_increment
)paren
(brace
id|off
op_assign
id|j
op_mod
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|rxdp
op_assign
id|sp-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|blk
)braket
dot
id|block_virt_addr
op_plus
id|off
suffix:semicolon
macro_line|#ifndef CONFIG_2BUFF_MODE
r_if
c_cond
(paren
id|rxdp-&gt;Control_1
op_eq
id|END_OF_BLOCK
)paren
(brace
id|rxdp
op_assign
(paren
id|RxD_t
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp
op_member_access_from_pointer
id|Control_2
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
id|blk
op_increment
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|rxdp-&gt;Host_Control
op_eq
id|END_OF_BLOCK
)paren
(brace
id|blk
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|rxdp-&gt;Control_1
op_amp
id|RXD_OWN_XENA
)paren
)paren
(brace
id|memset
c_func
(paren
id|rxdp
comma
l_int|0
comma
r_sizeof
(paren
id|RxD_t
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp
op_member_access_from_pointer
id|Host_Control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
macro_line|#ifndef CONFIG_2BUFF_MODE
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer0_ptr
comma
id|dev-&gt;mtu
op_plus
id|HEADER_ETHERNET_II_802_3_SIZE
op_plus
id|HEADER_802_2_SIZE
op_plus
id|HEADER_SNAP_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
macro_line|#else
id|ba
op_assign
op_amp
id|sp-&gt;ba
(braket
id|i
)braket
(braket
id|blk
)braket
(braket
id|off
)braket
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer0_ptr
comma
id|BUF0_LEN
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer1_ptr
comma
id|BUF1_LEN
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|sp-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer2_ptr
comma
id|dev-&gt;mtu
op_plus
id|BUF0_LEN
op_plus
l_int|4
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|sp-&gt;rx_bufs_left
(braket
id|i
)braket
)paren
suffix:semicolon
id|buf_cnt
op_increment
suffix:semicolon
)brace
id|memset
c_func
(paren
id|rxdp
comma
l_int|0
comma
r_sizeof
(paren
id|RxD_t
)paren
)paren
suffix:semicolon
)brace
id|mac_control-&gt;rx_curr_put_info
(braket
id|i
)braket
dot
id|block_index
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|block_index
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_put_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|sp-&gt;rx_bufs_left
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INIT_DBG
comma
l_string|&quot;%s:Freed 0x%x Rx Buffers on ring%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|buf_cnt
comma
id|i
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * s2io_poll - Rx interrupt handler for NAPI support&n; * @dev : pointer to the device structure.&n; * @budget : The number of packets that were budgeted to be processed &n; * during  one pass through the &squot;Poll&quot; function.&n; * Description:&n; * Comes into picture only if NAPI support has been incorporated. It does&n; * the same thing that rx_intr_handler does, but not in a interrupt context&n; * also It will process only a given number of packets.&n; * Return value:&n; * 0 on success and 1 if there are No Rx packets to be processed.&n; */
macro_line|#ifdef CONFIG_S2IO_NAPI
DECL|function|s2io_poll
r_static
r_int
id|s2io_poll
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
op_star
id|budget
)paren
(brace
id|nic_t
op_star
id|nic
op_assign
id|dev-&gt;priv
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
r_int
id|pkts_to_process
op_assign
op_star
id|budget
comma
id|pkt_cnt
op_assign
l_int|0
suffix:semicolon
r_register
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
id|rx_curr_get_info_t
id|get_info
comma
id|put_info
suffix:semicolon
r_int
id|i
comma
id|get_block
comma
id|put_block
comma
id|get_offset
comma
id|put_offset
comma
id|ring_bufs
suffix:semicolon
macro_line|#ifndef CONFIG_2BUFF_MODE
id|u16
id|val16
comma
id|cksum
suffix:semicolon
macro_line|#endif
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|RxD_t
op_star
id|rxdp
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
macro_line|#ifdef CONFIG_2BUFF_MODE
id|buffAdd_t
op_star
id|ba
suffix:semicolon
macro_line|#endif
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
r_if
c_cond
(paren
id|pkts_to_process
OG
id|dev-&gt;quota
)paren
id|pkts_to_process
op_assign
id|dev-&gt;quota
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rx_traffic_int
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rx_traffic_int
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|get_info
op_assign
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
suffix:semicolon
id|get_block
op_assign
id|get_info.block_index
suffix:semicolon
id|put_info
op_assign
id|mac_control-&gt;rx_curr_put_info
(braket
id|i
)braket
suffix:semicolon
id|put_block
op_assign
id|put_info.block_index
suffix:semicolon
id|ring_bufs
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|get_block
)braket
dot
id|block_virt_addr
op_plus
id|get_info.offset
suffix:semicolon
macro_line|#ifndef&t;CONFIG_2BUFF_MODE
id|get_offset
op_assign
(paren
id|get_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|get_info.offset
suffix:semicolon
id|put_offset
op_assign
(paren
id|put_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|put_info.offset
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
(paren
id|rxdp-&gt;Control_1
op_amp
id|RXD_OWN_XENA
)paren
)paren
op_logical_and
(paren
(paren
(paren
id|get_offset
op_plus
l_int|1
)paren
op_mod
id|ring_bufs
)paren
op_ne
id|put_offset
)paren
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|pkts_to_process
OL
l_int|0
)paren
(brace
r_goto
id|no_rx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rxdp-&gt;Control_1
op_eq
id|END_OF_BLOCK
)paren
(brace
id|rxdp
op_assign
(paren
id|RxD_t
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp
op_member_access_from_pointer
id|Control_2
)paren
suffix:semicolon
id|get_info.offset
op_increment
suffix:semicolon
id|get_info.offset
op_mod_assign
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|get_block
op_increment
suffix:semicolon
id|get_block
op_mod_assign
id|nic-&gt;block_count
(braket
id|i
)braket
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|block_index
op_assign
id|get_block
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|get_offset
op_assign
(paren
id|get_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|get_info.offset
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp
op_member_access_from_pointer
id|Host_Control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: The skb is &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Null in Rx Intr&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|no_rx
suffix:semicolon
)brace
id|val64
op_assign
id|RXD_GET_BUFFER0_SIZE
c_func
(paren
id|rxdp-&gt;Control_2
)paren
suffix:semicolon
id|val16
op_assign
(paren
id|u16
)paren
(paren
id|val64
op_rshift
l_int|48
)paren
suffix:semicolon
id|cksum
op_assign
id|RXD_GET_L4_CKSUM
c_func
(paren
id|rxdp-&gt;Control_1
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer0_ptr
comma
id|dev-&gt;mtu
op_plus
id|HEADER_ETHERNET_II_802_3_SIZE
op_plus
id|HEADER_802_2_SIZE
op_plus
id|HEADER_SNAP_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rx_osm_handler
c_func
(paren
id|nic
comma
id|val16
comma
id|rxdp
comma
id|i
)paren
suffix:semicolon
id|pkt_cnt
op_increment
suffix:semicolon
id|get_info.offset
op_increment
suffix:semicolon
id|get_info.offset
op_mod_assign
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|get_block
)braket
dot
id|block_virt_addr
op_plus
id|get_info.offset
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
)brace
macro_line|#else
id|get_offset
op_assign
(paren
id|get_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|get_info.offset
suffix:semicolon
id|put_offset
op_assign
(paren
id|put_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|put_info.offset
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
op_logical_neg
(paren
id|rxdp-&gt;Control_1
op_amp
id|RXD_OWN_XENA
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|rxdp-&gt;Control_2
op_amp
id|BIT
c_func
(paren
l_int|0
)paren
)paren
)paren
op_logical_and
(paren
(paren
(paren
id|get_offset
op_plus
l_int|1
)paren
op_mod
id|ring_bufs
)paren
op_ne
id|put_offset
)paren
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|pkts_to_process
OL
l_int|0
)paren
(brace
r_goto
id|no_rx
suffix:semicolon
)brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp-&gt;Host_Control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: The skb is &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Null in Rx Intr&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|no_rx
suffix:semicolon
)brace
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer0_ptr
comma
id|BUF0_LEN
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer1_ptr
comma
id|BUF1_LEN
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer2_ptr
comma
id|dev-&gt;mtu
op_plus
id|BUF0_LEN
op_plus
l_int|4
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|ba
op_assign
op_amp
id|nic-&gt;ba
(braket
id|i
)braket
(braket
id|get_block
)braket
(braket
id|get_info.offset
)braket
suffix:semicolon
id|rx_osm_handler
c_func
(paren
id|nic
comma
id|rxdp
comma
id|i
comma
id|ba
)paren
suffix:semicolon
id|get_info.offset
op_increment
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|get_block
)braket
dot
id|block_virt_addr
op_plus
id|get_info.offset
suffix:semicolon
r_if
c_cond
(paren
id|get_info.offset
op_logical_and
(paren
op_logical_neg
(paren
id|get_info.offset
op_mod
id|MAX_RXDS_PER_BLOCK
)paren
)paren
)paren
(brace
id|get_info.offset
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
id|get_block
op_increment
suffix:semicolon
id|get_block
op_mod_assign
id|nic-&gt;block_count
(braket
id|i
)braket
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|block_index
op_assign
id|get_block
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|get_block
)braket
dot
id|block_virt_addr
suffix:semicolon
)brace
id|get_offset
op_assign
(paren
id|get_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|get_info.offset
suffix:semicolon
id|pkt_cnt
op_increment
suffix:semicolon
)brace
macro_line|#endif
)brace
r_if
c_cond
(paren
op_logical_neg
id|pkt_cnt
)paren
id|pkt_cnt
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;quota
op_sub_assign
id|pkt_cnt
suffix:semicolon
op_star
id|budget
op_sub_assign
id|pkt_cnt
suffix:semicolon
id|netif_rx_complete
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fill_rx_buffers
c_func
(paren
id|nic
comma
id|i
)paren
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s:Out of memory&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot; in Rx Poll!!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Re enable the Rx interrupts. */
id|en_dis_able_nic_intrs
c_func
(paren
id|nic
comma
id|RX_TRAFFIC_INTR
comma
id|ENABLE_INTRS
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|no_rx
suffix:colon
id|dev-&gt;quota
op_sub_assign
id|pkt_cnt
suffix:semicolon
op_star
id|budget
op_sub_assign
id|pkt_cnt
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fill_rx_buffers
c_func
(paren
id|nic
comma
id|i
)paren
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s:Out of memory&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot; in Rx Poll!!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/**  &n; *  rx_intr_handler - Rx interrupt handler&n; *  @nic: device private variable.&n; *  Description: &n; *  If the interrupt is because of a received frame or if the &n; *  receive ring contains fresh as yet un-processed frames,this function is&n; *  called. It picks out the RxD at which place the last Rx processing had &n; *  stopped and sends the skb to the OSM&squot;s Rx handler and then increments &n; *  the offset.&n; *  Return Value:&n; *  NONE.&n; */
DECL|function|rx_intr_handler
r_static
r_void
id|rx_intr_handler
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|nic-&gt;dev
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
id|rx_curr_get_info_t
id|get_info
comma
id|put_info
suffix:semicolon
id|RxD_t
op_star
id|rxdp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifndef CONFIG_2BUFF_MODE
id|u16
id|val16
comma
id|cksum
suffix:semicolon
macro_line|#endif
r_register
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
r_int
id|get_block
comma
id|get_offset
comma
id|put_block
comma
id|put_offset
comma
id|ring_bufs
suffix:semicolon
r_int
id|i
comma
id|pkt_cnt
op_assign
l_int|0
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
macro_line|#ifdef CONFIG_2BUFF_MODE
id|buffAdd_t
op_star
id|ba
suffix:semicolon
macro_line|#endif
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
multiline_comment|/* &n;&t; * rx_traffic_int reg is an R1 register, hence we read and write back &n;&t; * the samevalue in the register to clear it.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rx_traffic_int
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rx_traffic_int
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|get_info
op_assign
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
suffix:semicolon
id|get_block
op_assign
id|get_info.block_index
suffix:semicolon
id|put_info
op_assign
id|mac_control-&gt;rx_curr_put_info
(braket
id|i
)braket
suffix:semicolon
id|put_block
op_assign
id|put_info.block_index
suffix:semicolon
id|ring_bufs
op_assign
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|get_block
)braket
dot
id|block_virt_addr
op_plus
id|get_info.offset
suffix:semicolon
macro_line|#ifndef&t;CONFIG_2BUFF_MODE
id|get_offset
op_assign
(paren
id|get_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|get_info.offset
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nic-&gt;put_lock
)paren
suffix:semicolon
id|put_offset
op_assign
id|nic-&gt;put_pos
(braket
id|i
)braket
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nic-&gt;put_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
(paren
id|rxdp-&gt;Control_1
op_amp
id|RXD_OWN_XENA
)paren
)paren
op_logical_and
(paren
(paren
(paren
id|get_offset
op_plus
l_int|1
)paren
op_mod
id|ring_bufs
)paren
op_ne
id|put_offset
)paren
)paren
(brace
r_if
c_cond
(paren
id|rxdp-&gt;Control_1
op_eq
id|END_OF_BLOCK
)paren
(brace
id|rxdp
op_assign
(paren
id|RxD_t
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp-&gt;Control_2
)paren
suffix:semicolon
id|get_info.offset
op_increment
suffix:semicolon
id|get_info.offset
op_mod_assign
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|get_block
op_increment
suffix:semicolon
id|get_block
op_mod_assign
id|nic-&gt;block_count
(braket
id|i
)braket
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|block_index
op_assign
id|get_block
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|get_offset
op_assign
(paren
id|get_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|get_info.offset
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp-&gt;Host_Control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: The skb is &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Null in Rx Intr&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|val64
op_assign
id|RXD_GET_BUFFER0_SIZE
c_func
(paren
id|rxdp-&gt;Control_2
)paren
suffix:semicolon
id|val16
op_assign
(paren
id|u16
)paren
(paren
id|val64
op_rshift
l_int|48
)paren
suffix:semicolon
id|cksum
op_assign
id|RXD_GET_L4_CKSUM
c_func
(paren
id|rxdp-&gt;Control_1
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer0_ptr
comma
id|dev-&gt;mtu
op_plus
id|HEADER_ETHERNET_II_802_3_SIZE
op_plus
id|HEADER_802_2_SIZE
op_plus
id|HEADER_SNAP_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rx_osm_handler
c_func
(paren
id|nic
comma
id|val16
comma
id|rxdp
comma
id|i
)paren
suffix:semicolon
id|get_info.offset
op_increment
suffix:semicolon
id|get_info.offset
op_mod_assign
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|get_block
)braket
dot
id|block_virt_addr
op_plus
id|get_info.offset
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
id|pkt_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|indicate_max_pkts
)paren
op_logical_and
(paren
id|pkt_cnt
OG
id|indicate_max_pkts
)paren
)paren
r_break
suffix:semicolon
)brace
macro_line|#else
id|get_offset
op_assign
(paren
id|get_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|get_info.offset
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nic-&gt;put_lock
)paren
suffix:semicolon
id|put_offset
op_assign
id|nic-&gt;put_pos
(braket
id|i
)braket
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nic-&gt;put_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
op_logical_neg
(paren
id|rxdp-&gt;Control_1
op_amp
id|RXD_OWN_XENA
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|rxdp-&gt;Control_2
op_amp
id|BIT
c_func
(paren
l_int|0
)paren
)paren
)paren
op_logical_and
(paren
(paren
(paren
id|get_offset
op_plus
l_int|1
)paren
op_mod
id|ring_bufs
)paren
op_ne
id|put_offset
)paren
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp-&gt;Host_Control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: The skb is &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Null in Rx Intr&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer0_ptr
comma
id|BUF0_LEN
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer1_ptr
comma
id|BUF1_LEN
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|rxdp-&gt;Buffer2_ptr
comma
id|dev-&gt;mtu
op_plus
id|BUF0_LEN
op_plus
l_int|4
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|ba
op_assign
op_amp
id|nic-&gt;ba
(braket
id|i
)braket
(braket
id|get_block
)braket
(braket
id|get_info.offset
)braket
suffix:semicolon
id|rx_osm_handler
c_func
(paren
id|nic
comma
id|rxdp
comma
id|i
comma
id|ba
)paren
suffix:semicolon
id|get_info.offset
op_increment
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|get_block
)braket
dot
id|block_virt_addr
op_plus
id|get_info.offset
suffix:semicolon
r_if
c_cond
(paren
id|get_info.offset
op_logical_and
(paren
op_logical_neg
(paren
id|get_info.offset
op_mod
id|MAX_RXDS_PER_BLOCK
)paren
)paren
)paren
(brace
id|get_info.offset
op_assign
l_int|0
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
id|get_block
op_increment
suffix:semicolon
id|get_block
op_mod_assign
id|nic-&gt;block_count
(braket
id|i
)braket
suffix:semicolon
id|mac_control-&gt;rx_curr_get_info
(braket
id|i
)braket
dot
id|block_index
op_assign
id|get_block
suffix:semicolon
id|rxdp
op_assign
id|nic-&gt;rx_blocks
(braket
id|i
)braket
(braket
id|get_block
)braket
dot
id|block_virt_addr
suffix:semicolon
)brace
id|get_offset
op_assign
(paren
id|get_block
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
)paren
op_plus
id|get_info.offset
suffix:semicolon
id|pkt_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|indicate_max_pkts
)paren
op_logical_and
(paren
id|pkt_cnt
OG
id|indicate_max_pkts
)paren
)paren
r_break
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|indicate_max_pkts
)paren
op_logical_and
(paren
id|pkt_cnt
OG
id|indicate_max_pkts
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/**  &n; *  tx_intr_handler - Transmit interrupt handler&n; *  @nic : device private variable&n; *  Description: &n; *  If an interrupt was raised to indicate DMA complete of the &n; *  Tx packet, this function is called. It identifies the last TxD &n; *  whose buffer was freed and frees all skbs whose data have already &n; *  DMA&squot;ed into the NICs internal memory.&n; *  Return Value:&n; *  NONE&n; */
DECL|function|tx_intr_handler
r_static
r_void
id|tx_intr_handler
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|nic-&gt;dev
suffix:semicolon
id|tx_curr_get_info_t
id|get_info
comma
id|put_info
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|TxD_t
op_star
id|txdlp
suffix:semicolon
r_register
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u16
id|j
comma
id|frg_cnt
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|mac_control
op_assign
op_amp
id|nic-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|nic-&gt;config
suffix:semicolon
multiline_comment|/* &n;&t; * tx_traffic_int reg is an R1 register, hence we read and write &n;&t; * back the samevalue in the register to clear it.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;tx_traffic_int
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;tx_traffic_int
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;tx_fifo_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|get_info
op_assign
id|mac_control-&gt;tx_curr_get_info
(braket
id|i
)braket
suffix:semicolon
id|put_info
op_assign
id|mac_control-&gt;tx_curr_put_info
(braket
id|i
)braket
suffix:semicolon
id|txdlp
op_assign
(paren
id|TxD_t
op_star
)paren
id|nic-&gt;list_info
(braket
id|i
)braket
(braket
id|get_info.offset
)braket
dot
id|list_virt_addr
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
(paren
id|txdlp-&gt;Control_1
op_amp
id|TXD_LIST_OWN_XENA
)paren
)paren
op_logical_and
(paren
id|get_info.offset
op_ne
id|put_info.offset
)paren
op_logical_and
(paren
id|txdlp-&gt;Host_Control
)paren
)paren
(brace
multiline_comment|/* Check for TxD errors */
r_if
c_cond
(paren
id|txdlp-&gt;Control_1
op_amp
id|TXD_T_CODE
)paren
(brace
r_int
r_int
r_int
id|err
suffix:semicolon
id|err
op_assign
id|txdlp-&gt;Control_1
op_amp
id|TXD_T_CODE
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;***TxD error %llx&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|txdlp-&gt;Host_Control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Null skb &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;in Tx Free Intr&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nic-&gt;tx_pkt_count
op_increment
suffix:semicolon
id|frg_cnt
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
multiline_comment|/*  For unfragmented skb */
id|pci_unmap_single
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|txdlp-&gt;Buffer_Pointer
comma
id|skb-&gt;len
op_minus
id|skb-&gt;data_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frg_cnt
)paren
(brace
id|TxD_t
op_star
id|temp
op_assign
id|txdlp
suffix:semicolon
id|txdlp
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|frg_cnt
suffix:semicolon
id|j
op_increment
comma
id|txdlp
op_increment
)paren
(brace
id|skb_frag_t
op_star
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|j
)braket
suffix:semicolon
id|pci_unmap_page
c_func
(paren
id|nic-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|txdlp
op_member_access_from_pointer
id|Buffer_Pointer
comma
id|frag-&gt;size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
id|txdlp
op_assign
id|temp
suffix:semicolon
)brace
id|memset
c_func
(paren
id|txdlp
comma
l_int|0
comma
(paren
r_sizeof
(paren
id|TxD_t
)paren
op_star
id|config-&gt;max_txds
)paren
)paren
suffix:semicolon
multiline_comment|/* Updating the statistics block */
id|nic-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|nic-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|get_info.offset
op_increment
suffix:semicolon
id|get_info.offset
op_mod_assign
id|get_info.fifo_len
op_plus
l_int|1
suffix:semicolon
id|txdlp
op_assign
(paren
id|TxD_t
op_star
)paren
id|nic-&gt;list_info
(braket
id|i
)braket
(braket
id|get_info.offset
)braket
dot
id|list_virt_addr
suffix:semicolon
id|mac_control-&gt;tx_curr_get_info
(braket
id|i
)braket
dot
id|offset
op_assign
id|get_info.offset
suffix:semicolon
)brace
)brace
id|spin_lock
c_func
(paren
op_amp
id|nic-&gt;tx_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nic-&gt;tx_lock
)paren
suffix:semicolon
)brace
multiline_comment|/**  &n; *  alarm_intr_handler - Alarm Interrrupt handler&n; *  @nic: device private variable&n; *  Description: If the interrupt was neither because of Rx packet or Tx &n; *  complete, this function is called. If the interrupt was to indicate&n; *  a loss of link, the OSM link status handler is invoked for any other &n; *  alarm interrupt the block that raised the interrupt is displayed &n; *  and a H/W reset is issued.&n; *  Return Value:&n; *  NONE&n;*/
DECL|function|alarm_intr_handler
r_static
r_void
id|alarm_intr_handler
c_func
(paren
r_struct
id|s2io_nic
op_star
id|nic
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|nic-&gt;dev
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
r_register
id|u64
id|val64
op_assign
l_int|0
comma
id|err_reg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Handling link status change error Intr */
id|err_reg
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_rmac_err_reg
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|err_reg
comma
op_amp
id|bar0-&gt;mac_rmac_err_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err_reg
op_amp
id|RMAC_LINK_STATE_CHANGE_INT
)paren
(brace
id|schedule_work
c_func
(paren
op_amp
id|nic-&gt;set_link_task
)paren
suffix:semicolon
)brace
multiline_comment|/* In case of a serious error, the device will be Reset. */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;serr_source
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_amp
id|SERR_SOURCE_ANY
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Device indicates &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;serious error!!&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|nic-&gt;rst_timer_task
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Also as mentioned in the latest Errata sheets if the PCC_FB_ECC&n;&t; * Error occurs, the adapter will be recycled by disabling the&n;&t; * adapter enable bit and enabling it again after the device &n;&t; * becomes Quiescent.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;pcc_err_reg
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;pcc_err_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_amp
id|PCC_FB_ECC_DB_ERR
)paren
(brace
id|u64
id|ac
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|ac
op_and_assign
op_complement
(paren
id|ADAPTER_CNTL_EN
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|ac
comma
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|ac
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|nic-&gt;set_link_task
)paren
suffix:semicolon
)brace
multiline_comment|/* Other type of interrupts are not being handled now,  TODO */
)brace
multiline_comment|/** &n; *  wait_for_cmd_complete - waits for a command to complete.&n; *  @sp : private member of the device structure, which is a pointer to the &n; *  s2io_nic structure.&n; *  Description: Function that waits for a command to Write into RMAC &n; *  ADDR DATA registers to be completed and returns either success or &n; *  error depending on whether the command was complete or not. &n; *  Return value:&n; *   SUCCESS on success and FAILURE on failure.&n; */
DECL|function|wait_for_cmd_complete
r_int
id|wait_for_cmd_complete
c_func
(paren
id|nic_t
op_star
id|sp
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
r_int
id|ret
op_assign
id|FAILURE
comma
id|cnt
op_assign
l_int|0
suffix:semicolon
id|u64
id|val64
suffix:semicolon
r_while
c_loop
(paren
id|TRUE
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rmac_addr_cmd_mem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val64
op_amp
id|RMAC_ADDR_CMD_MEM_STROBE_CMD_EXECUTING
)paren
)paren
(brace
id|ret
op_assign
id|SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_increment
OG
l_int|10
)paren
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/** &n; *  s2io_reset - Resets the card. &n; *  @sp : private member of the device structure.&n; *  Description: Function to Reset the card. This function then also&n; *  restores the previously saved PCI configuration space registers as &n; *  the card reset also resets the configuration space.&n; *  Return value:&n; *  void.&n; */
DECL|function|s2io_reset
r_void
id|s2io_reset
c_func
(paren
id|nic_t
op_star
id|sp
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u64
id|val64
suffix:semicolon
id|u16
id|subid
suffix:semicolon
id|val64
op_assign
id|SW_RESET_ALL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;sw_reset
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * At this stage, if the PCI write is indeed completed, the &n;&t; * card is reset and so is the PCI Config space of the device. &n;&t; * So a read cannot be issued at this stage on any of the &n;&t; * registers to ensure the write into &quot;sw_reset&quot; register&n;&t; * has gone through.&n;&t; * Question: Is there any system call that will explicitly force&n;&t; * all the write commands still pending on the bus to be pushed&n;&t; * through?&n;&t; * As of now I&squot;am just giving a 250ms delay and hoping that the&n;&t; * PCI write to sw_reset register is done by this time.&n;&t; */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Restore the PCI state saved during initializarion. */
id|pci_restore_state
c_func
(paren
id|sp-&gt;pdev
)paren
suffix:semicolon
id|s2io_init_pci
c_func
(paren
id|sp
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* SXE-002: Configure link and activity LED to turn it off */
id|subid
op_assign
id|sp-&gt;pdev-&gt;subsystem_device
suffix:semicolon
r_if
c_cond
(paren
(paren
id|subid
op_amp
l_int|0xFF
)paren
op_ge
l_int|0x07
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_or_assign
l_int|0x0000800000000000ULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_assign
l_int|0x0411040400000000ULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
(paren
r_void
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|bar0
op_plus
l_int|0x2700
)paren
)paren
suffix:semicolon
)brace
id|sp-&gt;device_enabled_once
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_set_swapper - to set the swapper controle on the card &n; *  @sp : private member of the device structure, &n; *  pointer to the s2io_nic structure.&n; *  Description: Function to set the swapper control on the card &n; *  correctly depending on the &squot;endianness&squot; of the system.&n; *  Return value:&n; *  SUCCESS on success and FAILURE on failure.&n; */
DECL|function|s2io_set_swapper
r_int
id|s2io_set_swapper
c_func
(paren
id|nic_t
op_star
id|sp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|sp-&gt;dev
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u64
id|val64
suffix:semicolon
multiline_comment|/* &n;&t; * Set proper endian settings and verify the same by reading&n;&t; * the PIF Feed-back register.&n;&t; */
macro_line|#ifdef  __BIG_ENDIAN
multiline_comment|/* &n;&t; * The device by default set to a big endian format, so a &n;&t; * big endian driver need not set anything.&n;&t; */
id|writeq
c_func
(paren
l_int|0xffffffffffffffffULL
comma
op_amp
id|bar0-&gt;swapper_ctrl
)paren
suffix:semicolon
id|val64
op_assign
(paren
id|SWAPPER_CTRL_PIF_R_FE
op_or
id|SWAPPER_CTRL_PIF_R_SE
op_or
id|SWAPPER_CTRL_PIF_W_FE
op_or
id|SWAPPER_CTRL_PIF_W_SE
op_or
id|SWAPPER_CTRL_TXP_FE
op_or
id|SWAPPER_CTRL_TXP_SE
op_or
id|SWAPPER_CTRL_TXD_R_FE
op_or
id|SWAPPER_CTRL_TXD_W_FE
op_or
id|SWAPPER_CTRL_TXF_R_FE
op_or
id|SWAPPER_CTRL_RXD_R_FE
op_or
id|SWAPPER_CTRL_RXD_W_FE
op_or
id|SWAPPER_CTRL_RXF_W_FE
op_or
id|SWAPPER_CTRL_XMSI_FE
op_or
id|SWAPPER_CTRL_XMSI_SE
op_or
id|SWAPPER_CTRL_STATS_FE
op_or
id|SWAPPER_CTRL_STATS_SE
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;swapper_ctrl
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* &n;&t; * Initially we enable all bits to make it accessible by the&n;&t; * driver, then we selectively enable only those bits that &n;&t; * we want to set.&n;&t; */
id|writeq
c_func
(paren
l_int|0xffffffffffffffffULL
comma
op_amp
id|bar0-&gt;swapper_ctrl
)paren
suffix:semicolon
id|val64
op_assign
(paren
id|SWAPPER_CTRL_PIF_R_FE
op_or
id|SWAPPER_CTRL_PIF_R_SE
op_or
id|SWAPPER_CTRL_PIF_W_FE
op_or
id|SWAPPER_CTRL_PIF_W_SE
op_or
id|SWAPPER_CTRL_TXP_FE
op_or
id|SWAPPER_CTRL_TXP_SE
op_or
id|SWAPPER_CTRL_TXD_R_FE
op_or
id|SWAPPER_CTRL_TXD_R_SE
op_or
id|SWAPPER_CTRL_TXD_W_FE
op_or
id|SWAPPER_CTRL_TXD_W_SE
op_or
id|SWAPPER_CTRL_TXF_R_FE
op_or
id|SWAPPER_CTRL_RXD_R_FE
op_or
id|SWAPPER_CTRL_RXD_R_SE
op_or
id|SWAPPER_CTRL_RXD_W_FE
op_or
id|SWAPPER_CTRL_RXD_W_SE
op_or
id|SWAPPER_CTRL_RXF_W_FE
op_or
id|SWAPPER_CTRL_XMSI_FE
op_or
id|SWAPPER_CTRL_XMSI_SE
op_or
id|SWAPPER_CTRL_STATS_FE
op_or
id|SWAPPER_CTRL_STATS_SE
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;swapper_ctrl
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* &n;&t; * Verifying if endian settings are accurate by reading a &n;&t; * feedback register.&n;&t; */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;pif_rd_swapper_fb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_ne
l_int|0x0123456789ABCDEFULL
)paren
(brace
multiline_comment|/* Endian settings are incorrect, calls for another dekko. */
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Endian settings are wrong, &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;feedback read %llx&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|val64
)paren
suffix:semicolon
r_return
id|FAILURE
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/* ********************************************************* *&n; * Functions defined below concern the OS part of the driver *&n; * ********************************************************* */
multiline_comment|/**  &n; *  s2io_open - open entry point of the driver&n; *  @dev : pointer to the device structure.&n; *  Description:&n; *  This function is the open entry point of the driver. It mainly calls a&n; *  function to allocate Rx buffers and inserts them into the buffer&n; *  descriptors and then enables the Rx part of the NIC. &n; *  Return value:&n; *  0 on success and an appropriate (-)ve integer as defined in errno.h&n; *   file on failure.&n; */
DECL|function|s2io_open
r_int
id|s2io_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t; * Make sure you have link off by default every time &n;&t; * Nic is initialized&n;&t; */
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;last_link_state
op_assign
id|LINK_DOWN
suffix:semicolon
multiline_comment|/* Initialize H/W and enable interrupts */
r_if
c_cond
(paren
id|s2io_card_up
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: H/W initialization failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* After proper initialization of H/W, register ISR */
id|err
op_assign
id|request_irq
c_func
(paren
(paren
r_int
)paren
id|sp-&gt;irq
comma
id|s2io_isr
comma
id|SA_SHIRQ
comma
id|sp-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|s2io_reset
c_func
(paren
id|sp
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: ISR registration failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s2io_set_mac_addr
c_func
(paren
id|dev
comma
id|dev-&gt;dev_addr
)paren
op_eq
id|FAILURE
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Set Mac Address Failed&bslash;n&quot;
)paren
suffix:semicolon
id|s2io_reset
c_func
(paren
id|sp
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_close -close entry point of the driver&n; *  @dev : device pointer.&n; *  Description:&n; *  This is the stop entry point of the driver. It needs to undo exactly&n; *  whatever was done by the open entry point,thus it&squot;s usually referred to&n; *  as the close function.Among other things this function mainly stops the&n; *  Rx side of the NIC and frees all the Rx buffers in the Rx rings.&n; *  Return value:&n; *  0 on success and an appropriate (-)ve integer as defined in errno.h&n; *  file on failure.&n; */
DECL|function|s2io_close
r_int
id|s2io_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Reset card, kill tasklet and free Tx and Rx buffers. */
id|s2io_card_down
c_func
(paren
id|sp
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|sp-&gt;device_close_flag
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Device is shut down. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_xmit - Tx entry point of te driver&n; *  @skb : the socket buffer containing the Tx data.&n; *  @dev : device pointer.&n; *  Description :&n; *  This function is the Tx entry point of the driver. S2IO NIC supports&n; *  certain protocol assist features on Tx side, namely  CSO, S/G, LSO.&n; *  NOTE: when device cant queue the pkt,just the trans_start variable will&n; *  not be upadted.&n; *  Return value:&n; *  0 on success &amp; 1 on failure.&n; */
DECL|function|s2io_xmit
r_int
id|s2io_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u16
id|frg_cnt
comma
id|frg_len
comma
id|i
comma
id|queue
comma
id|queue_len
comma
id|put_off
comma
id|get_off
suffix:semicolon
r_register
id|u64
id|val64
suffix:semicolon
id|TxD_t
op_star
id|txdp
suffix:semicolon
id|TxFIFO_element_t
op_star
id|tx_fifo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef NETIF_F_TSO
r_int
id|mss
suffix:semicolon
macro_line|#endif
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|mac_control
op_assign
op_amp
id|sp-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|sp-&gt;config
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|TX_DBG
comma
l_string|&quot;%s: In S2IO Tx routine&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sp-&gt;card_state
)paren
op_eq
id|CARD_DOWN
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Card going down for reset&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|queue
op_assign
l_int|0
suffix:semicolon
id|put_off
op_assign
(paren
id|u16
)paren
id|mac_control-&gt;tx_curr_put_info
(braket
id|queue
)braket
dot
id|offset
suffix:semicolon
id|get_off
op_assign
(paren
id|u16
)paren
id|mac_control-&gt;tx_curr_get_info
(braket
id|queue
)braket
dot
id|offset
suffix:semicolon
id|txdp
op_assign
(paren
id|TxD_t
op_star
)paren
id|sp-&gt;list_info
(braket
id|queue
)braket
(braket
id|put_off
)braket
dot
id|list_virt_addr
suffix:semicolon
id|queue_len
op_assign
id|mac_control-&gt;tx_curr_put_info
(braket
id|queue
)braket
dot
id|fifo_len
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Avoid &quot;put&quot; pointer going beyond &quot;get&quot; pointer */
r_if
c_cond
(paren
id|txdp-&gt;Host_Control
op_logical_or
(paren
(paren
(paren
id|put_off
op_plus
l_int|1
)paren
op_mod
id|queue_len
)paren
op_eq
id|get_off
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Error in xmit, No free TXDs.&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef NETIF_F_TSO
id|mss
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|tso_size
suffix:semicolon
r_if
c_cond
(paren
id|mss
)paren
(brace
id|txdp-&gt;Control_1
op_or_assign
id|TXD_TCP_LSO_EN
suffix:semicolon
id|txdp-&gt;Control_1
op_or_assign
id|TXD_TCP_LSO_MSS
c_func
(paren
id|mss
)paren
suffix:semicolon
)brace
macro_line|#endif
id|frg_cnt
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|frg_len
op_assign
id|skb-&gt;len
op_minus
id|skb-&gt;data_len
suffix:semicolon
id|txdp-&gt;Host_Control
op_assign
(paren
r_int
r_int
)paren
id|skb
suffix:semicolon
id|txdp-&gt;Buffer_Pointer
op_assign
id|pci_map_single
(paren
id|sp-&gt;pdev
comma
id|skb-&gt;data
comma
id|frg_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
(brace
id|txdp-&gt;Control_2
op_or_assign
(paren
id|TXD_TX_CKO_IPV4_EN
op_or
id|TXD_TX_CKO_TCP_EN
op_or
id|TXD_TX_CKO_UDP_EN
)paren
suffix:semicolon
)brace
id|txdp-&gt;Control_2
op_or_assign
id|config-&gt;tx_intr_type
suffix:semicolon
id|txdp-&gt;Control_1
op_or_assign
(paren
id|TXD_BUFFER0_SIZE
c_func
(paren
id|frg_len
)paren
op_or
id|TXD_GATHER_CODE_FIRST
)paren
suffix:semicolon
id|txdp-&gt;Control_1
op_or_assign
id|TXD_LIST_OWN_XENA
suffix:semicolon
multiline_comment|/* For fragmented SKB. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|frg_cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb_frag_t
op_star
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|i
)braket
suffix:semicolon
id|txdp
op_increment
suffix:semicolon
id|txdp-&gt;Buffer_Pointer
op_assign
(paren
id|u64
)paren
id|pci_map_page
(paren
id|sp-&gt;pdev
comma
id|frag-&gt;page
comma
id|frag-&gt;page_offset
comma
id|frag-&gt;size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|txdp-&gt;Control_1
op_or_assign
id|TXD_BUFFER0_SIZE
c_func
(paren
id|frag-&gt;size
)paren
suffix:semicolon
)brace
id|txdp-&gt;Control_1
op_or_assign
id|TXD_GATHER_CODE_LAST
suffix:semicolon
id|tx_fifo
op_assign
id|mac_control-&gt;tx_FIFO_start
(braket
id|queue
)braket
suffix:semicolon
id|val64
op_assign
id|sp-&gt;list_info
(braket
id|queue
)braket
(braket
id|put_off
)braket
dot
id|list_phy_addr
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|tx_fifo-&gt;TxDL_Pointer
)paren
suffix:semicolon
id|val64
op_assign
(paren
id|TX_FIFO_LAST_TXD_NUM
c_func
(paren
id|frg_cnt
)paren
op_or
id|TX_FIFO_FIRST_LIST
op_or
id|TX_FIFO_LAST_LIST
)paren
suffix:semicolon
macro_line|#ifdef NETIF_F_TSO
r_if
c_cond
(paren
id|mss
)paren
id|val64
op_or_assign
id|TX_FIFO_SPECIAL_FUNC
suffix:semicolon
macro_line|#endif
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|tx_fifo-&gt;List_Control
)paren
suffix:semicolon
multiline_comment|/* Perform a PCI read to flush previous writes */
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_status
)paren
suffix:semicolon
id|put_off
op_increment
suffix:semicolon
id|put_off
op_mod_assign
id|mac_control-&gt;tx_curr_put_info
(braket
id|queue
)braket
dot
id|fifo_len
op_plus
l_int|1
suffix:semicolon
id|mac_control-&gt;tx_curr_put_info
(braket
id|queue
)braket
dot
id|offset
op_assign
id|put_off
suffix:semicolon
multiline_comment|/* Avoid &quot;put&quot; pointer going beyond &quot;get&quot; pointer */
r_if
c_cond
(paren
(paren
(paren
id|put_off
op_plus
l_int|1
)paren
op_mod
id|queue_len
)paren
op_eq
id|get_off
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|TX_DBG
comma
l_string|&quot;No free TxDs for xmit, Put: 0x%x Get:0x%x&bslash;n&quot;
comma
id|put_off
comma
id|get_off
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_isr - ISR handler of the device .&n; *  @irq: the irq of the device.&n; *  @dev_id: a void pointer to the dev structure of the NIC.&n; *  @pt_regs: pointer to the registers pushed on the stack.&n; *  Description:  This function is the ISR handler of the device. It &n; *  identifies the reason for the interrupt and calls the relevant &n; *  service routines. As a contongency measure, this ISR allocates the &n; *  recv buffers, if their numbers are below the panic value which is&n; *  presently set to 25% of the original number of rcv buffers allocated.&n; *  Return value:&n; *   IRQ_HANDLED: will be returned if IRQ was handled by this routine &n; *   IRQ_NONE: will be returned if interrupt is not from our device&n; */
DECL|function|s2io_isr
r_static
id|irqreturn_t
id|s2io_isr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
macro_line|#ifndef CONFIG_S2IO_NAPI
r_int
id|i
comma
id|ret
suffix:semicolon
macro_line|#endif
id|u64
id|reason
op_assign
l_int|0
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|mac_control
op_assign
op_amp
id|sp-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|sp-&gt;config
suffix:semicolon
multiline_comment|/* &n;&t; * Identify the cause for interrupt and call the appropriate&n;&t; * interrupt handler. Causes for the interrupt could be;&n;&t; * 1. Rx of packet.&n;&t; * 2. Tx complete.&n;&t; * 3. Link down.&n;&t; * 4. Error in any functional blocks of the NIC. &n;&t; */
id|reason
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;general_int_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reason
)paren
(brace
multiline_comment|/* The interrupt was not raised by Xena. */
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/* If Intr is because of Tx Traffic */
r_if
c_cond
(paren
id|reason
op_amp
id|GEN_INTR_TXTRAFFIC
)paren
(brace
id|tx_intr_handler
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/* If Intr is because of an error */
r_if
c_cond
(paren
id|reason
op_amp
(paren
id|GEN_ERROR_INTR
)paren
)paren
id|alarm_intr_handler
c_func
(paren
id|sp
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_S2IO_NAPI
r_if
c_cond
(paren
id|reason
op_amp
id|GEN_INTR_RXTRAFFIC
)paren
(brace
r_if
c_cond
(paren
id|netif_rx_schedule_prep
c_func
(paren
id|dev
)paren
)paren
(brace
id|en_dis_able_nic_intrs
c_func
(paren
id|sp
comma
id|RX_TRAFFIC_INTR
comma
id|DISABLE_INTRS
)paren
suffix:semicolon
id|__netif_rx_schedule
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
multiline_comment|/* If Intr is because of Rx Traffic */
r_if
c_cond
(paren
id|reason
op_amp
id|GEN_INTR_RXTRAFFIC
)paren
(brace
id|rx_intr_handler
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* &n;&t; * If the Rx buffer count is below the panic threshold then &n;&t; * reallocate the buffers from the interrupt handler itself, &n;&t; * else schedule a tasklet to reallocate the buffers.&n;&t; */
macro_line|#ifndef CONFIG_S2IO_NAPI
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|rxb_size
op_assign
id|atomic_read
c_func
(paren
op_amp
id|sp-&gt;rx_bufs_left
(braket
id|i
)braket
)paren
suffix:semicolon
r_int
id|level
op_assign
id|rx_buffer_level
c_func
(paren
id|sp
comma
id|rxb_size
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|level
op_eq
id|PANIC
)paren
op_logical_and
(paren
op_logical_neg
id|TASKLET_IN_USE
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|INTR_DBG
comma
l_string|&quot;%s: Rx BD hit &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INTR_DBG
comma
l_string|&quot;PANIC levels&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|fill_rx_buffers
c_func
(paren
id|sp
comma
id|i
)paren
)paren
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s:Out of memory&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot; in ISR!!&bslash;n&quot;
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
op_amp
id|sp-&gt;tasklet_status
)paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
op_amp
id|sp-&gt;tasklet_status
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|level
op_eq
id|LOW
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|sp-&gt;task
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_get_stats - Updates the device statistics structure. &n; *  @dev : pointer to the device structure.&n; *  Description:&n; *  This function updates the device statistics structure in the s2io_nic &n; *  structure and returns a pointer to the same.&n; *  Return value:&n; *  pointer to the updated net_device_stats structure.&n; */
DECL|function|s2io_get_stats
r_struct
id|net_device_stats
op_star
id|s2io_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|mac_control
op_assign
op_amp
id|sp-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|sp-&gt;config
suffix:semicolon
id|sp-&gt;stats.tx_errors
op_assign
id|mac_control-&gt;stats_info-&gt;tmac_any_err_frms
suffix:semicolon
id|sp-&gt;stats.rx_errors
op_assign
id|mac_control-&gt;stats_info-&gt;rmac_drop_frms
suffix:semicolon
id|sp-&gt;stats.multicast
op_assign
id|mac_control-&gt;stats_info-&gt;rmac_vld_mcst_frms
suffix:semicolon
id|sp-&gt;stats.rx_length_errors
op_assign
id|mac_control-&gt;stats_info-&gt;rmac_long_frms
suffix:semicolon
r_return
(paren
op_amp
id|sp-&gt;stats
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_set_multicast - entry point for multicast address enable/disable.&n; *  @dev : pointer to the device structure&n; *  Description:&n; *  This function is a driver entry point which gets called by the kernel &n; *  whenever multicast addresses must be enabled/disabled. This also gets &n; *  called to set/reset promiscuous mode. Depending on the deivce flag, we&n; *  determine, if multicast address must be enabled or if promiscuous mode&n; *  is to be disabled etc.&n; *  Return value:&n; *  void.&n; */
DECL|function|s2io_set_multicast
r_static
r_void
id|s2io_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|j
comma
id|prev_cnt
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u64
id|val64
op_assign
l_int|0
comma
id|multi_mac
op_assign
l_int|0x010203040506ULL
comma
id|mask
op_assign
l_int|0xfeffffffffffULL
suffix:semicolon
id|u64
id|dis_addr
op_assign
l_int|0xffffffffffffULL
comma
id|mac_addr
op_assign
l_int|0
suffix:semicolon
r_void
op_star
id|add
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_and
(paren
op_logical_neg
id|sp-&gt;m_cast_flg
)paren
)paren
(brace
multiline_comment|/*  Enable all Multicast addresses */
id|writeq
c_func
(paren
id|RMAC_ADDR_DATA0_MEM_ADDR
c_func
(paren
id|multi_mac
)paren
comma
op_amp
id|bar0-&gt;rmac_addr_data0_mem
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_ADDR_DATA1_MEM_MASK
c_func
(paren
id|mask
)paren
comma
op_amp
id|bar0-&gt;rmac_addr_data1_mem
)paren
suffix:semicolon
id|val64
op_assign
id|RMAC_ADDR_CMD_MEM_WE
op_or
id|RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD
op_or
id|RMAC_ADDR_CMD_MEM_OFFSET
c_func
(paren
id|MAC_MC_ALL_MC_ADDR_OFFSET
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rmac_addr_cmd_mem
)paren
suffix:semicolon
multiline_comment|/* Wait till command completes */
id|wait_for_cmd_complete
c_func
(paren
id|sp
)paren
suffix:semicolon
id|sp-&gt;m_cast_flg
op_assign
l_int|1
suffix:semicolon
id|sp-&gt;all_multi_pos
op_assign
id|MAC_MC_ALL_MC_ADDR_OFFSET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_and
(paren
id|sp-&gt;m_cast_flg
)paren
)paren
(brace
multiline_comment|/*  Disable all Multicast addresses */
id|writeq
c_func
(paren
id|RMAC_ADDR_DATA0_MEM_ADDR
c_func
(paren
id|dis_addr
)paren
comma
op_amp
id|bar0-&gt;rmac_addr_data0_mem
)paren
suffix:semicolon
id|val64
op_assign
id|RMAC_ADDR_CMD_MEM_WE
op_or
id|RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD
op_or
id|RMAC_ADDR_CMD_MEM_OFFSET
c_func
(paren
id|sp-&gt;all_multi_pos
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rmac_addr_cmd_mem
)paren
suffix:semicolon
multiline_comment|/* Wait till command completes */
id|wait_for_cmd_complete
c_func
(paren
id|sp
)paren
suffix:semicolon
id|sp-&gt;m_cast_flg
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;all_multi_pos
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_logical_and
(paren
op_logical_neg
id|sp-&gt;promisc_flg
)paren
)paren
(brace
multiline_comment|/*  Put the NIC into promiscuous mode */
id|add
op_assign
(paren
r_void
op_star
)paren
op_amp
id|bar0-&gt;mac_cfg
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_cfg
)paren
suffix:semicolon
id|val64
op_or_assign
id|MAC_CFG_RMAC_PROM_ENABLE
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_CFG_KEY
c_func
(paren
l_int|0x4C0D
)paren
comma
op_amp
id|bar0-&gt;rmac_cfg_key
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|val64
comma
id|add
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_CFG_KEY
c_func
(paren
l_int|0x4C0D
)paren
comma
op_amp
id|bar0-&gt;rmac_cfg_key
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
(paren
id|val64
op_rshift
l_int|32
)paren
comma
(paren
id|add
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_cfg
)paren
suffix:semicolon
id|sp-&gt;promisc_flg
op_assign
l_int|1
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: entered promiscuous mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_logical_and
(paren
id|sp-&gt;promisc_flg
)paren
)paren
(brace
multiline_comment|/*  Remove the NIC from promiscuous mode */
id|add
op_assign
(paren
r_void
op_star
)paren
op_amp
id|bar0-&gt;mac_cfg
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_cfg
)paren
suffix:semicolon
id|val64
op_and_assign
op_complement
id|MAC_CFG_RMAC_PROM_ENABLE
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_CFG_KEY
c_func
(paren
l_int|0x4C0D
)paren
comma
op_amp
id|bar0-&gt;rmac_cfg_key
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|val64
comma
id|add
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|RMAC_CFG_KEY
c_func
(paren
l_int|0x4C0D
)paren
comma
op_amp
id|bar0-&gt;rmac_cfg_key
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
(paren
id|val64
op_rshift
l_int|32
)paren
comma
(paren
id|add
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mac_cfg
)paren
suffix:semicolon
id|sp-&gt;promisc_flg
op_assign
l_int|0
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: left promiscuous mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*  Update individual M_CAST address list */
r_if
c_cond
(paren
(paren
op_logical_neg
id|sp-&gt;m_cast_flg
)paren
op_logical_and
id|dev-&gt;mc_count
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;mc_count
OG
(paren
id|MAX_ADDRS_SUPPORTED
op_minus
id|MAC_MC_ADDR_START_OFFSET
op_minus
l_int|1
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: No more Rx filters &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;can be added, please enable &quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;ALL_MULTI instead&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|prev_cnt
op_assign
id|sp-&gt;mc_addr_count
suffix:semicolon
id|sp-&gt;mc_addr_count
op_assign
id|dev-&gt;mc_count
suffix:semicolon
multiline_comment|/* Clear out the previous list of Mc in the H/W. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|prev_cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeq
c_func
(paren
id|RMAC_ADDR_DATA0_MEM_ADDR
c_func
(paren
id|dis_addr
)paren
comma
op_amp
id|bar0-&gt;rmac_addr_data0_mem
)paren
suffix:semicolon
id|val64
op_assign
id|RMAC_ADDR_CMD_MEM_WE
op_or
id|RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD
op_or
id|RMAC_ADDR_CMD_MEM_OFFSET
(paren
id|MAC_MC_ADDR_START_OFFSET
op_plus
id|i
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rmac_addr_cmd_mem
)paren
suffix:semicolon
multiline_comment|/* Wait for command completes */
r_if
c_cond
(paren
id|wait_for_cmd_complete
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Adding &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Multicasts failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Create the new Rx filter list and update the same in H/W. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
id|memcpy
c_func
(paren
id|sp-&gt;usr_addrs
(braket
id|i
)braket
dot
id|addr
comma
id|mclist-&gt;dmi_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ETH_ALEN
suffix:semicolon
id|j
op_increment
)paren
(brace
id|mac_addr
op_or_assign
id|mclist-&gt;dmi_addr
(braket
id|j
)braket
suffix:semicolon
id|mac_addr
op_lshift_assign
l_int|8
suffix:semicolon
)brace
id|writeq
c_func
(paren
id|RMAC_ADDR_DATA0_MEM_ADDR
c_func
(paren
id|mac_addr
)paren
comma
op_amp
id|bar0-&gt;rmac_addr_data0_mem
)paren
suffix:semicolon
id|val64
op_assign
id|RMAC_ADDR_CMD_MEM_WE
op_or
id|RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD
op_or
id|RMAC_ADDR_CMD_MEM_OFFSET
(paren
id|i
op_plus
id|MAC_MC_ADDR_START_OFFSET
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rmac_addr_cmd_mem
)paren
suffix:semicolon
multiline_comment|/* Wait for command completes */
r_if
c_cond
(paren
id|wait_for_cmd_complete
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Adding &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Multicasts failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/**&n; *  s2io_set_mac_addr - Programs the Xframe mac address &n; *  @dev : pointer to the device structure.&n; *  @addr: a uchar pointer to the new mac address which is to be set.&n; *  Description : This procedure will program the Xframe to receive &n; *  frames with new Mac Address&n; *  Return value: SUCCESS on success and an appropriate (-)ve integer &n; *  as defined in errno.h file on failure.&n; */
DECL|function|s2io_set_mac_addr
r_int
id|s2io_set_mac_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
op_star
id|addr
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
r_register
id|u64
id|val64
comma
id|mac_addr
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* &n;&t; * Set the new MAC address as the new unicast filter and reflect this&n;&t; * change on the device address registered with the OS. It will be&n;&t; * at offset 0. &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mac_addr
op_lshift_assign
l_int|8
suffix:semicolon
id|mac_addr
op_or_assign
id|addr
(braket
id|i
)braket
suffix:semicolon
)brace
id|writeq
c_func
(paren
id|RMAC_ADDR_DATA0_MEM_ADDR
c_func
(paren
id|mac_addr
)paren
comma
op_amp
id|bar0-&gt;rmac_addr_data0_mem
)paren
suffix:semicolon
id|val64
op_assign
id|RMAC_ADDR_CMD_MEM_WE
op_or
id|RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD
op_or
id|RMAC_ADDR_CMD_MEM_OFFSET
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rmac_addr_cmd_mem
)paren
suffix:semicolon
multiline_comment|/* Wait till command completes */
r_if
c_cond
(paren
id|wait_for_cmd_complete
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: set_mac_addr failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|FAILURE
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_ethtool_sset - Sets different link parameters. &n; * @sp : private member of the device structure, which is a pointer to the  * s2io_nic structure.&n; * @info: pointer to the structure with parameters given by ethtool to set&n; * link information.&n; * Description:&n; * The function sets different link parameters provided by the user onto &n; * the NIC.&n; * Return value:&n; * 0 on success.&n;*/
DECL|function|s2io_ethtool_sset
r_static
r_int
id|s2io_ethtool_sset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|info
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
)paren
op_logical_or
(paren
id|info-&gt;speed
op_ne
id|SPEED_10000
)paren
op_logical_or
(paren
id|info-&gt;duplex
op_ne
id|DUPLEX_FULL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_else
(brace
id|s2io_close
c_func
(paren
id|sp-&gt;dev
)paren
suffix:semicolon
id|s2io_open
c_func
(paren
id|sp-&gt;dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_ethtol_gset - Return link specific information. &n; * @sp : private member of the device structure, pointer to the&n; *      s2io_nic structure.&n; * @info : pointer to the structure with parameters given by ethtool&n; * to return link information.&n; * Description:&n; * Returns link specific information like speed, duplex etc.. to ethtool.&n; * Return value :&n; * return 0 on success.&n; */
DECL|function|s2io_ethtool_gset
r_int
id|s2io_ethtool_gset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|info
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|info-&gt;supported
op_assign
(paren
id|SUPPORTED_10000baseT_Full
op_or
id|SUPPORTED_FIBRE
)paren
suffix:semicolon
id|info-&gt;advertising
op_assign
(paren
id|SUPPORTED_10000baseT_Full
op_or
id|SUPPORTED_FIBRE
)paren
suffix:semicolon
id|info-&gt;port
op_assign
id|PORT_FIBRE
suffix:semicolon
multiline_comment|/* info-&gt;transceiver?? TODO */
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|sp-&gt;dev
)paren
)paren
(brace
id|info-&gt;speed
op_assign
l_int|10000
suffix:semicolon
id|info-&gt;duplex
op_assign
id|DUPLEX_FULL
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;speed
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;duplex
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|info-&gt;autoneg
op_assign
id|AUTONEG_DISABLE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_ethtool_gdrvinfo - Returns driver specific information. &n; * @sp : private member of the device structure, which is a pointer to the &n; * s2io_nic structure.&n; * @info : pointer to the structure with parameters given by ethtool to&n; * return driver information.&n; * Description:&n; * Returns driver specefic information like name, version etc.. to ethtool.&n; * Return value:&n; *  void&n; */
DECL|function|s2io_ethtool_gdrvinfo
r_static
r_void
id|s2io_ethtool_gdrvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|strncpy
c_func
(paren
id|info-&gt;driver
comma
id|s2io_driver_name
comma
r_sizeof
(paren
id|s2io_driver_name
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info-&gt;version
comma
id|s2io_driver_version
comma
r_sizeof
(paren
id|s2io_driver_version
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info-&gt;fw_version
comma
l_string|&quot;&quot;
comma
l_int|32
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info-&gt;bus_info
comma
id|sp-&gt;pdev-&gt;slot_name
comma
l_int|32
)paren
suffix:semicolon
id|info-&gt;regdump_len
op_assign
id|XENA_REG_SPACE
suffix:semicolon
id|info-&gt;eedump_len
op_assign
id|XENA_EEPROM_SPACE
suffix:semicolon
id|info-&gt;testinfo_len
op_assign
id|S2IO_TEST_LEN
suffix:semicolon
id|info-&gt;n_stats
op_assign
id|S2IO_STAT_LEN
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_ethtool_gregs - dumps the entire space of Xfame into the buffer.&n; *  @sp: private member of the device structure, which is a pointer to the &n; *  s2io_nic structure.&n; *  @regs : pointer to the structure with parameters given by ethtool for &n; *  dumping the registers.&n; *  @reg_space: The input argumnet into which all the registers are dumped.&n; *  Description:&n; *  Dumps the entire register space of xFrame NIC into the user given&n; *  buffer area.&n; * Return value :&n; * void .&n;*/
DECL|function|s2io_ethtool_gregs
r_static
r_void
id|s2io_ethtool_gregs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_regs
op_star
id|regs
comma
r_void
op_star
id|space
)paren
(brace
r_int
id|i
suffix:semicolon
id|u64
id|reg
suffix:semicolon
id|u8
op_star
id|reg_space
op_assign
(paren
id|u8
op_star
)paren
id|space
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|regs-&gt;len
op_assign
id|XENA_REG_SPACE
suffix:semicolon
id|regs-&gt;version
op_assign
id|sp-&gt;pdev-&gt;subsystem_device
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|regs-&gt;len
suffix:semicolon
id|i
op_add_assign
l_int|8
)paren
(brace
id|reg
op_assign
id|readq
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|sp-&gt;bar0
op_plus
id|i
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|reg_space
op_plus
id|i
)paren
comma
op_amp
id|reg
comma
l_int|8
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *  s2io_phy_id  - timer function that alternates adapter LED.&n; *  @data : address of the private member of the device structure, which &n; *  is a pointer to the s2io_nic structure, provided as an u32.&n; * Description: This is actually the timer function that alternates the &n; * adapter LED bit of the adapter control bit to set/reset every time on &n; * invocation. The timer is set for 1/2 a second, hence tha NIC blinks &n; *  once every second.&n;*/
DECL|function|s2io_phy_id
r_static
r_void
id|s2io_phy_id
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
(paren
id|nic_t
op_star
)paren
id|data
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
id|u16
id|subid
suffix:semicolon
id|subid
op_assign
id|sp-&gt;pdev-&gt;subsystem_device
suffix:semicolon
r_if
c_cond
(paren
(paren
id|subid
op_amp
l_int|0xFF
)paren
op_ge
l_int|0x07
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_xor_assign
id|GPIO_CTRL_GPIO_0
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
)brace
r_else
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|val64
op_xor_assign
id|ADAPTER_LED_ON
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|sp-&gt;id_timer
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_ethtool_idnic - To physically identify the nic on the system.&n; * @sp : private member of the device structure, which is a pointer to the&n; * s2io_nic structure.&n; * @id : pointer to the structure with identification parameters given by &n; * ethtool.&n; * Description: Used to physically identify the NIC on the system.&n; * The Link LED will blink for a time specified by the user for &n; * identification.&n; * NOTE: The Link has to be Up to be able to blink the LED. Hence &n; * identification is possible only if it&squot;s link is up.&n; * Return value:&n; * int , returns 0 on success&n; */
DECL|function|s2io_ethtool_idnic
r_static
r_int
id|s2io_ethtool_idnic
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|data
)paren
(brace
id|u64
id|val64
op_assign
l_int|0
comma
id|last_gpio_ctrl_val
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u16
id|subid
suffix:semicolon
id|subid
op_assign
id|sp-&gt;pdev-&gt;subsystem_device
suffix:semicolon
id|last_gpio_ctrl_val
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|subid
op_amp
l_int|0xFF
)paren
OL
l_int|0x07
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val64
op_amp
id|ADAPTER_CNTL_EN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Adapter Link down, cannot blink LED&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sp-&gt;id_timer.function
op_eq
l_int|NULL
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|sp-&gt;id_timer
)paren
suffix:semicolon
id|sp-&gt;id_timer.function
op_assign
id|s2io_phy_id
suffix:semicolon
id|sp-&gt;id_timer.data
op_assign
(paren
r_int
r_int
)paren
id|sp
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|sp-&gt;id_timer
comma
id|jiffies
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
id|schedule_timeout
c_func
(paren
id|data
op_star
id|HZ
)paren
suffix:semicolon
r_else
id|schedule_timeout
c_func
(paren
id|MAX_SCHEDULE_TIMEOUT
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|sp-&gt;id_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CARDS_WITH_FAULTY_LINK_INDICATORS
c_func
(paren
id|subid
)paren
)paren
(brace
id|writeq
c_func
(paren
id|last_gpio_ctrl_val
comma
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|last_gpio_ctrl_val
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_ethtool_getpause_data -Pause frame frame generation and reception.&n; * @sp : private member of the device structure, which is a pointer to the  * s2io_nic structure.&n; * @ep : pointer to the structure with pause parameters given by ethtool.&n; * Description:&n; * Returns the Pause frame generation and reception capability of the NIC.&n; * Return value:&n; *  void&n; */
DECL|function|s2io_ethtool_getpause_data
r_static
r_void
id|s2io_ethtool_getpause_data
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_pauseparam
op_star
id|ep
)paren
(brace
id|u64
id|val64
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rmac_pause_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_amp
id|RMAC_PAUSE_GEN_ENABLE
)paren
id|ep-&gt;tx_pause
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_amp
id|RMAC_PAUSE_RX_ENABLE
)paren
id|ep-&gt;rx_pause
op_assign
id|TRUE
suffix:semicolon
id|ep-&gt;autoneg
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_ethtool_setpause_data -  set/reset pause frame generation.&n; * @sp : private member of the device structure, which is a pointer to the &n; *      s2io_nic structure.&n; * @ep : pointer to the structure with pause parameters given by ethtool.&n; * Description:&n; * It can be used to set or reset Pause frame generation or reception&n; * support of the NIC.&n; * Return value:&n; * int, returns 0 on Success&n; */
DECL|function|s2io_ethtool_setpause_data
r_int
id|s2io_ethtool_setpause_data
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_pauseparam
op_star
id|ep
)paren
(brace
id|u64
id|val64
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rmac_pause_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;tx_pause
)paren
id|val64
op_or_assign
id|RMAC_PAUSE_GEN_ENABLE
suffix:semicolon
r_else
id|val64
op_and_assign
op_complement
id|RMAC_PAUSE_GEN_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;rx_pause
)paren
id|val64
op_or_assign
id|RMAC_PAUSE_RX_ENABLE
suffix:semicolon
r_else
id|val64
op_and_assign
op_complement
id|RMAC_PAUSE_RX_ENABLE
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rmac_pause_cfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * read_eeprom - reads 4 bytes of data from user given offset.&n; * @sp : private member of the device structure, which is a pointer to the &n; *      s2io_nic structure.&n; * @off : offset at which the data must be written&n; * @data : Its an output parameter where the data read at the given&n; * &t;offset is stored.&n; * Description:&n; * Will read 4 bytes of data from the user given offset and return the &n; * read data.&n; * NOTE: Will allow to read only part of the EEPROM visible through the&n; *   I2C bus.&n; * Return value:&n; *  -1 on failure and 0 on success.&n; */
DECL|macro|S2IO_DEV_ID
mdefine_line|#define S2IO_DEV_ID&t;&t;5
DECL|function|read_eeprom
r_static
r_int
id|read_eeprom
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_int
id|off
comma
id|u32
op_star
id|data
)paren
(brace
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
id|u32
id|exit_cnt
op_assign
l_int|0
suffix:semicolon
id|u64
id|val64
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|val64
op_assign
id|I2C_CONTROL_DEV_ID
c_func
(paren
id|S2IO_DEV_ID
)paren
op_or
id|I2C_CONTROL_ADDR
c_func
(paren
id|off
)paren
op_or
id|I2C_CONTROL_BYTE_CNT
c_func
(paren
l_int|0x3
)paren
op_or
id|I2C_CONTROL_READ
op_or
id|I2C_CONTROL_CNTL_START
suffix:semicolon
id|SPECIAL_REG_WRITE
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;i2c_control
comma
id|LF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|exit_cnt
OL
l_int|5
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;i2c_control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I2C_CONTROL_CNTL_END
c_func
(paren
id|val64
)paren
)paren
(brace
op_star
id|data
op_assign
id|I2C_CONTROL_GET_DATA
c_func
(paren
id|val64
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|exit_cnt
op_increment
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *  write_eeprom - actually writes the relevant part of the data value.&n; *  @sp : private member of the device structure, which is a pointer to the&n; *       s2io_nic structure.&n; *  @off : offset at which the data must be written&n; *  @data : The data that is to be written&n; *  @cnt : Number of bytes of the data that are actually to be written into &n; *  the Eeprom. (max of 3)&n; * Description:&n; *  Actually writes the relevant part of the data value into the Eeprom&n; *  through the I2C bus.&n; * Return value:&n; *  0 on success, -1 on failure.&n; */
DECL|function|write_eeprom
r_static
r_int
id|write_eeprom
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_int
id|off
comma
id|u32
id|data
comma
r_int
id|cnt
)paren
(brace
r_int
id|exit_cnt
op_assign
l_int|0
comma
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
id|u64
id|val64
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|val64
op_assign
id|I2C_CONTROL_DEV_ID
c_func
(paren
id|S2IO_DEV_ID
)paren
op_or
id|I2C_CONTROL_ADDR
c_func
(paren
id|off
)paren
op_or
id|I2C_CONTROL_BYTE_CNT
c_func
(paren
id|cnt
)paren
op_or
id|I2C_CONTROL_SET_DATA
c_func
(paren
id|data
)paren
op_or
id|I2C_CONTROL_CNTL_START
suffix:semicolon
id|SPECIAL_REG_WRITE
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;i2c_control
comma
id|LF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|exit_cnt
OL
l_int|5
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;i2c_control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I2C_CONTROL_CNTL_END
c_func
(paren
id|val64
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val64
op_amp
id|I2C_CONTROL_NACK
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|exit_cnt
op_increment
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_ethtool_geeprom  - reads the value stored in the Eeprom.&n; *  @sp : private member of the device structure, which is a pointer to the *       s2io_nic structure.&n; *  @eeprom : pointer to the user level structure provided by ethtool, &n; *  containing all relevant information.&n; *  @data_buf : user defined value to be written into Eeprom.&n; *  Description: Reads the values stored in the Eeprom at given offset&n; *  for a given length. Stores these values int the input argument data&n; *  buffer &squot;data_buf&squot; and returns these to the caller (ethtool.)&n; *  Return value:&n; *  int  0 on success&n; */
DECL|function|s2io_ethtool_geeprom
r_int
id|s2io_ethtool_geeprom
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_eeprom
op_star
id|eeprom
comma
id|u8
op_star
id|data_buf
)paren
(brace
id|u32
id|data
comma
id|i
comma
id|valid
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|eeprom-&gt;magic
op_assign
id|sp-&gt;pdev-&gt;vendor
op_or
(paren
id|sp-&gt;pdev-&gt;device
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|eeprom-&gt;offset
op_plus
id|eeprom-&gt;len
)paren
OG
(paren
id|XENA_EEPROM_SPACE
)paren
)paren
id|eeprom-&gt;len
op_assign
id|XENA_EEPROM_SPACE
op_minus
id|eeprom-&gt;offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|eeprom-&gt;len
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|read_eeprom
c_func
(paren
id|sp
comma
(paren
id|eeprom-&gt;offset
op_plus
id|i
)paren
comma
op_amp
id|data
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Read of EEPROM failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|valid
op_assign
id|INV
c_func
(paren
id|data
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|data_buf
op_plus
id|i
)paren
comma
op_amp
id|valid
comma
l_int|4
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_ethtool_seeprom - tries to write the user provided value in Eeprom&n; *  @sp : private member of the device structure, which is a pointer to the&n; *  s2io_nic structure.&n; *  @eeprom : pointer to the user level structure provided by ethtool, &n; *  containing all relevant information.&n; *  @data_buf ; user defined value to be written into Eeprom.&n; *  Description:&n; *  Tries to write the user provided value in the Eeprom, at the offset&n; *  given by the user.&n; *  Return value:&n; *  0 on success, -EFAULT on failure.&n; */
DECL|function|s2io_ethtool_seeprom
r_static
r_int
id|s2io_ethtool_seeprom
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_eeprom
op_star
id|eeprom
comma
id|u8
op_star
id|data_buf
)paren
(brace
r_int
id|len
op_assign
id|eeprom-&gt;len
comma
id|cnt
op_assign
l_int|0
suffix:semicolon
id|u32
id|valid
op_assign
l_int|0
comma
id|data
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|eeprom-&gt;magic
op_ne
(paren
id|sp-&gt;pdev-&gt;vendor
op_or
(paren
id|sp-&gt;pdev-&gt;device
op_lshift
l_int|16
)paren
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;ETHTOOL_WRITE_EEPROM Err: Magic value &quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;is wrong, Its not 0x%x&bslash;n&quot;
comma
id|eeprom-&gt;magic
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
)paren
(brace
id|data
op_assign
(paren
id|u32
)paren
id|data_buf
(braket
id|cnt
)braket
op_amp
l_int|0x000000FF
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
(brace
id|valid
op_assign
(paren
id|u32
)paren
(paren
id|data
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
r_else
id|valid
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|write_eeprom
c_func
(paren
id|sp
comma
(paren
id|eeprom-&gt;offset
op_plus
id|cnt
)paren
comma
id|valid
comma
l_int|0
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;ETHTOOL_WRITE_EEPROM Err: Cannot &quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;write into the specified offset&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|cnt
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_register_test - reads and writes into all clock domains. &n; * @sp : private member of the device structure, which is a pointer to the &n; * s2io_nic structure.&n; * @data : variable that returns the result of each of the test conducted b&n; * by the driver.&n; * Description:&n; * Read and write into all clock domains. The NIC has 3 clock domains,&n; * see that registers in all the three regions are accessible.&n; * Return value:&n; * 0 on success.&n; */
DECL|function|s2io_register_test
r_static
r_int
id|s2io_register_test
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_uint64
op_star
id|data
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
r_int
id|fail
op_assign
l_int|0
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;pcc_enable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_ne
l_int|0xff00000000000000ULL
)paren
(brace
id|fail
op_assign
l_int|1
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INFO_DBG
comma
l_string|&quot;Read Test level 1 fails&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rmac_pause_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_ne
l_int|0xc000ffff00000000ULL
)paren
(brace
id|fail
op_assign
l_int|1
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INFO_DBG
comma
l_string|&quot;Read Test level 2 fails&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rx_queue_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_ne
l_int|0x0808080808080808ULL
)paren
(brace
id|fail
op_assign
l_int|1
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INFO_DBG
comma
l_string|&quot;Read Test level 3 fails&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;xgxs_efifo_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_ne
l_int|0x000000001923141EULL
)paren
(brace
id|fail
op_assign
l_int|1
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INFO_DBG
comma
l_string|&quot;Read Test level 4 fails&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|val64
op_assign
l_int|0x5A5A5A5A5A5A5A5AULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;xmsi_data
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;xmsi_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_ne
l_int|0x5A5A5A5A5A5A5A5AULL
)paren
(brace
id|fail
op_assign
l_int|1
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Write Test level 1 fails&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|val64
op_assign
l_int|0xA5A5A5A5A5A5A5A5ULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;xmsi_data
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;xmsi_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_ne
l_int|0xA5A5A5A5A5A5A5A5ULL
)paren
(brace
id|fail
op_assign
l_int|1
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Write Test level 2 fails&bslash;n&quot;
)paren
suffix:semicolon
)brace
op_star
id|data
op_assign
id|fail
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_eeprom_test - to verify that EEprom in the xena can be programmed. &n; * @sp : private member of the device structure, which is a pointer to the&n; * s2io_nic structure.&n; * @data:variable that returns the result of each of the test conducted by&n; * the driver.&n; * Description:&n; * Verify that EEPROM in the xena can be programmed using I2C_CONTROL &n; * register.&n; * Return value:&n; * 0 on success.&n; */
DECL|function|s2io_eeprom_test
r_static
r_int
id|s2io_eeprom_test
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_uint64
op_star
id|data
)paren
(brace
r_int
id|fail
op_assign
l_int|0
suffix:semicolon
id|u32
id|ret_data
suffix:semicolon
multiline_comment|/* Test Write Error at offset 0 */
r_if
c_cond
(paren
op_logical_neg
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0
comma
l_int|0
comma
l_int|3
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Test Write at offset 4f0 */
r_if
c_cond
(paren
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x4F0
comma
l_int|0x01234567
comma
l_int|3
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|read_eeprom
c_func
(paren
id|sp
comma
l_int|0x4F0
comma
op_amp
id|ret_data
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret_data
op_ne
l_int|0x01234567
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Reset the EEPROM data go FFFF */
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x4F0
comma
l_int|0xFFFFFFFF
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Test Write Request Error at offset 0x7c */
r_if
c_cond
(paren
op_logical_neg
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x07C
comma
l_int|0
comma
l_int|3
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Test Write Request at offset 0x7fc */
r_if
c_cond
(paren
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x7FC
comma
l_int|0x01234567
comma
l_int|3
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|read_eeprom
c_func
(paren
id|sp
comma
l_int|0x7FC
comma
op_amp
id|ret_data
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret_data
op_ne
l_int|0x01234567
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Reset the EEPROM data go FFFF */
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x7FC
comma
l_int|0xFFFFFFFF
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Test Write Error at offset 0x80 */
r_if
c_cond
(paren
op_logical_neg
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x080
comma
l_int|0
comma
l_int|3
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Test Write Error at offset 0xfc */
r_if
c_cond
(paren
op_logical_neg
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x0FC
comma
l_int|0
comma
l_int|3
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Test Write Error at offset 0x100 */
r_if
c_cond
(paren
op_logical_neg
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x100
comma
l_int|0
comma
l_int|3
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Test Write Error at offset 4ec */
r_if
c_cond
(paren
op_logical_neg
id|write_eeprom
c_func
(paren
id|sp
comma
l_int|0x4EC
comma
l_int|0
comma
l_int|3
)paren
)paren
id|fail
op_assign
l_int|1
suffix:semicolon
op_star
id|data
op_assign
id|fail
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_bist_test - invokes the MemBist test of the card .&n; * @sp : private member of the device structure, which is a pointer to the &n; * s2io_nic structure.&n; * @data:variable that returns the result of each of the test conducted by &n; * the driver.&n; * Description:&n; * This invokes the MemBist test of the card. We give around&n; * 2 secs time for the Test to complete. If it&squot;s still not complete&n; * within this peiod, we consider that the test failed. &n; * Return value:&n; * 0 on success and -1 on failure.&n; */
DECL|function|s2io_bist_test
r_static
r_int
id|s2io_bist_test
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_uint64
op_star
id|data
)paren
(brace
id|u8
id|bist
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
comma
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|sp-&gt;pdev
comma
id|PCI_BIST
comma
op_amp
id|bist
)paren
suffix:semicolon
id|bist
op_or_assign
id|PCI_BIST_START
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCI_BIST
comma
id|bist
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cnt
OL
l_int|20
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|sp-&gt;pdev
comma
id|PCI_BIST
comma
op_amp
id|bist
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bist
op_amp
id|PCI_BIST_START
)paren
)paren
(brace
op_star
id|data
op_assign
(paren
id|bist
op_amp
id|PCI_BIST_CODE_MASK
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io-link_test - verifies the link state of the nic  &n; * @sp ; private member of the device structure, which is a pointer to the &n; * s2io_nic structure.&n; * @data: variable that returns the result of each of the test conducted by&n; * the driver.&n; * Description:&n; * The function verifies the link state of the NIC and updates the input &n; * argument &squot;data&squot; appropriately.&n; * Return value:&n; * 0 on success.&n; */
DECL|function|s2io_link_test
r_static
r_int
id|s2io_link_test
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_uint64
op_star
id|data
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u64
id|val64
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_amp
id|ADAPTER_STATUS_RMAC_LOCAL_FAULT
)paren
op_star
id|data
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_rldram_test - offline test for access to the RldRam chip on the NIC &n; * @sp - private member of the device structure, which is a pointer to the  &n; * s2io_nic structure.&n; * @data - variable that returns the result of each of the test &n; * conducted by the driver.&n; * Description:&n; *  This is one of the offline test that tests the read and write &n; *  access to the RldRam chip on the NIC.&n; * Return value:&n; *  0 on success.&n; */
DECL|function|s2io_rldram_test
r_static
r_int
id|s2io_rldram_test
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_uint64
op_star
id|data
)paren
(brace
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|u64
id|val64
suffix:semicolon
r_int
id|cnt
comma
id|iteration
op_assign
l_int|0
comma
id|test_pass
op_assign
l_int|0
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|val64
op_and_assign
op_complement
id|ADAPTER_ECC_EN
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
id|val64
op_or_assign
id|MC_RLDRAM_TEST_MODE
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mc_rldram_mrs
)paren
suffix:semicolon
id|val64
op_or_assign
id|MC_RLDRAM_QUEUE_SIZE_ENABLE
suffix:semicolon
id|SPECIAL_REG_WRITE
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_mrs
comma
id|UF
)paren
suffix:semicolon
id|val64
op_or_assign
id|MC_RLDRAM_MRS_ENABLE
suffix:semicolon
id|SPECIAL_REG_WRITE
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_mrs
comma
id|UF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|iteration
OL
l_int|2
)paren
(brace
id|val64
op_assign
l_int|0x55555555aaaa0000ULL
suffix:semicolon
r_if
c_cond
(paren
id|iteration
op_eq
l_int|1
)paren
(brace
id|val64
op_xor_assign
l_int|0xFFFFFFFFFFFF0000ULL
suffix:semicolon
)brace
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_d0
)paren
suffix:semicolon
id|val64
op_assign
l_int|0xaaaa5a5555550000ULL
suffix:semicolon
r_if
c_cond
(paren
id|iteration
op_eq
l_int|1
)paren
(brace
id|val64
op_xor_assign
l_int|0xFFFFFFFFFFFF0000ULL
suffix:semicolon
)brace
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_d1
)paren
suffix:semicolon
id|val64
op_assign
l_int|0x55aaaaaaaa5a0000ULL
suffix:semicolon
r_if
c_cond
(paren
id|iteration
op_eq
l_int|1
)paren
(brace
id|val64
op_xor_assign
l_int|0xFFFFFFFFFFFF0000ULL
suffix:semicolon
)brace
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_d2
)paren
suffix:semicolon
id|val64
op_assign
(paren
id|u64
)paren
(paren
l_int|0x0000003fffff0000ULL
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_add
)paren
suffix:semicolon
id|val64
op_assign
id|MC_RLDRAM_TEST_MODE
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
id|val64
op_or_assign
id|MC_RLDRAM_TEST_MODE
op_or
id|MC_RLDRAM_TEST_WRITE
op_or
id|MC_RLDRAM_TEST_GO
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|5
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_amp
id|MC_RLDRAM_TEST_DONE
)paren
r_break
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
op_eq
l_int|5
)paren
r_break
suffix:semicolon
id|val64
op_assign
id|MC_RLDRAM_TEST_MODE
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
id|val64
op_or_assign
id|MC_RLDRAM_TEST_MODE
op_or
id|MC_RLDRAM_TEST_GO
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|5
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_amp
id|MC_RLDRAM_TEST_DONE
)paren
r_break
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
op_eq
l_int|5
)paren
r_break
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;mc_rldram_test_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val64
op_amp
id|MC_RLDRAM_TEST_PASS
)paren
id|test_pass
op_assign
l_int|1
suffix:semicolon
id|iteration
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|test_pass
)paren
op_star
id|data
op_assign
l_int|1
suffix:semicolon
r_else
op_star
id|data
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_ethtool_test - conducts 6 tsets to determine the health of card.&n; *  @sp : private member of the device structure, which is a pointer to the&n; *  s2io_nic structure.&n; *  @ethtest : pointer to a ethtool command specific structure that will be&n; *  returned to the user.&n; *  @data : variable that returns the result of each of the test &n; * conducted by the driver.&n; * Description:&n; *  This function conducts 6 tests ( 4 offline and 2 online) to determine&n; *  the health of the card.&n; * Return value:&n; *  void&n; */
DECL|function|s2io_ethtool_test
r_static
r_void
id|s2io_ethtool_test
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_test
op_star
id|ethtest
comma
r_uint64
op_star
id|data
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|orig_state
op_assign
id|netif_running
c_func
(paren
id|sp-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ethtest-&gt;flags
op_eq
id|ETH_TEST_FL_OFFLINE
)paren
(brace
multiline_comment|/* Offline Tests. */
r_if
c_cond
(paren
id|orig_state
)paren
(brace
id|s2io_close
c_func
(paren
id|sp-&gt;dev
)paren
suffix:semicolon
id|s2io_set_swapper
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
r_else
id|s2io_set_swapper
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s2io_register_test
c_func
(paren
id|sp
comma
op_amp
id|data
(braket
l_int|0
)braket
)paren
)paren
id|ethtest-&gt;flags
op_or_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
id|s2io_reset
c_func
(paren
id|sp
)paren
suffix:semicolon
id|s2io_set_swapper
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s2io_rldram_test
c_func
(paren
id|sp
comma
op_amp
id|data
(braket
l_int|3
)braket
)paren
)paren
id|ethtest-&gt;flags
op_or_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
id|s2io_reset
c_func
(paren
id|sp
)paren
suffix:semicolon
id|s2io_set_swapper
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s2io_eeprom_test
c_func
(paren
id|sp
comma
op_amp
id|data
(braket
l_int|1
)braket
)paren
)paren
id|ethtest-&gt;flags
op_or_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|s2io_bist_test
c_func
(paren
id|sp
comma
op_amp
id|data
(braket
l_int|4
)braket
)paren
)paren
id|ethtest-&gt;flags
op_or_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|orig_state
)paren
id|s2io_open
c_func
(paren
id|sp-&gt;dev
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Online Tests. */
r_if
c_cond
(paren
op_logical_neg
id|orig_state
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: is not up, cannot run test&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s2io_link_test
c_func
(paren
id|sp
comma
op_amp
id|data
(braket
l_int|2
)braket
)paren
)paren
id|ethtest-&gt;flags
op_or_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|s2io_get_ethtool_stats
r_static
r_void
id|s2io_get_ethtool_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_stats
op_star
id|estats
comma
id|u64
op_star
id|tmp_stats
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|StatInfo_t
op_star
id|stat_info
op_assign
id|sp-&gt;mac_control.stats_info
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_data_octets
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_drop_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_mcst_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_bcst_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_pause_ctrl_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_any_err_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_vld_ip_octets
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_vld_ip
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_drop_ip
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_icmp
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_rst_tcp
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_tcp
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;tmac_udp
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_vld_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_data_octets
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_fcs_err_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_drop_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_vld_mcst_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_vld_bcst_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_in_rng_len_err_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_long_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_pause_ctrl_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_discarded_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_usized_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_osized_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_frag_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_jabber_frms
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_ip
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_ip_octets
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_hdr_err_ip
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_drop_ip
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_icmp
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_tcp
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_udp
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_err_drp_udp
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_pause_cnt
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_accepted_ip
suffix:semicolon
id|tmp_stats
(braket
id|i
op_increment
)braket
op_assign
id|stat_info-&gt;rmac_err_tcp
suffix:semicolon
)brace
DECL|function|s2io_ethtool_get_regs_len
r_int
id|s2io_ethtool_get_regs_len
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
(paren
id|XENA_REG_SPACE
)paren
suffix:semicolon
)brace
DECL|function|s2io_ethtool_get_rx_csum
id|u32
id|s2io_ethtool_get_rx_csum
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
(paren
id|sp-&gt;rx_csum
)paren
suffix:semicolon
)brace
DECL|function|s2io_ethtool_set_rx_csum
r_int
id|s2io_ethtool_set_rx_csum
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|data
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
id|sp-&gt;rx_csum
op_assign
l_int|1
suffix:semicolon
r_else
id|sp-&gt;rx_csum
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s2io_get_eeprom_len
r_int
id|s2io_get_eeprom_len
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
(paren
id|XENA_EEPROM_SPACE
)paren
suffix:semicolon
)brace
DECL|function|s2io_ethtool_self_test_count
r_int
id|s2io_ethtool_self_test_count
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
(paren
id|S2IO_TEST_LEN
)paren
suffix:semicolon
)brace
DECL|function|s2io_ethtool_get_strings
r_void
id|s2io_ethtool_get_strings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|stringset
comma
id|u8
op_star
id|data
)paren
(brace
r_switch
c_cond
(paren
id|stringset
)paren
(brace
r_case
id|ETH_SS_TEST
suffix:colon
id|memcpy
c_func
(paren
id|data
comma
id|s2io_gstrings
comma
id|S2IO_STRINGS_LEN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_SS_STATS
suffix:colon
id|memcpy
c_func
(paren
id|data
comma
op_amp
id|ethtool_stats_keys
comma
r_sizeof
(paren
id|ethtool_stats_keys
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|s2io_ethtool_get_stats_count
r_static
r_int
id|s2io_ethtool_get_stats_count
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
(paren
id|S2IO_STAT_LEN
)paren
suffix:semicolon
)brace
DECL|function|s2io_ethtool_op_set_tx_csum
r_int
id|s2io_ethtool_op_set_tx_csum
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|data
)paren
(brace
r_if
c_cond
(paren
id|data
)paren
id|dev-&gt;features
op_or_assign
id|NETIF_F_IP_CSUM
suffix:semicolon
r_else
id|dev-&gt;features
op_and_assign
op_complement
id|NETIF_F_IP_CSUM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|netdev_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|netdev_ethtool_ops
op_assign
(brace
dot
id|get_settings
op_assign
id|s2io_ethtool_gset
comma
dot
id|set_settings
op_assign
id|s2io_ethtool_sset
comma
dot
id|get_drvinfo
op_assign
id|s2io_ethtool_gdrvinfo
comma
dot
id|get_regs_len
op_assign
id|s2io_ethtool_get_regs_len
comma
dot
id|get_regs
op_assign
id|s2io_ethtool_gregs
comma
dot
id|get_link
op_assign
id|ethtool_op_get_link
comma
dot
id|get_eeprom_len
op_assign
id|s2io_get_eeprom_len
comma
dot
id|get_eeprom
op_assign
id|s2io_ethtool_geeprom
comma
dot
id|set_eeprom
op_assign
id|s2io_ethtool_seeprom
comma
dot
id|get_pauseparam
op_assign
id|s2io_ethtool_getpause_data
comma
dot
id|set_pauseparam
op_assign
id|s2io_ethtool_setpause_data
comma
dot
id|get_rx_csum
op_assign
id|s2io_ethtool_get_rx_csum
comma
dot
id|set_rx_csum
op_assign
id|s2io_ethtool_set_rx_csum
comma
dot
id|get_tx_csum
op_assign
id|ethtool_op_get_tx_csum
comma
dot
id|set_tx_csum
op_assign
id|s2io_ethtool_op_set_tx_csum
comma
dot
id|get_sg
op_assign
id|ethtool_op_get_sg
comma
dot
id|set_sg
op_assign
id|ethtool_op_set_sg
comma
macro_line|#ifdef NETIF_F_TSO
dot
id|get_tso
op_assign
id|ethtool_op_get_tso
comma
dot
id|set_tso
op_assign
id|ethtool_op_set_tso
comma
macro_line|#endif
dot
id|self_test_count
op_assign
id|s2io_ethtool_self_test_count
comma
dot
id|self_test
op_assign
id|s2io_ethtool_test
comma
dot
id|get_strings
op_assign
id|s2io_ethtool_get_strings
comma
dot
id|phys_id
op_assign
id|s2io_ethtool_idnic
comma
dot
id|get_stats_count
op_assign
id|s2io_ethtool_get_stats_count
comma
dot
id|get_ethtool_stats
op_assign
id|s2io_get_ethtool_stats
)brace
suffix:semicolon
multiline_comment|/**&n; *  s2io_ioctl - Entry point for the Ioctl &n; *  @dev :  Device pointer.&n; *  @ifr :  An IOCTL specefic structure, that can contain a pointer to&n; *  a proprietary structure used to pass information to the driver.&n; *  @cmd :  This is used to distinguish between the different commands that&n; *  can be passed to the IOCTL functions.&n; *  Description:&n; *  This function has support for ethtool, adding multiple MAC addresses on &n; *  the NIC and some DBG commands for the util tool.&n; *  Return value:&n; *  Currently the IOCTL supports no operations, hence by default this&n; *  function returns OP NOT SUPPORTED value.&n; */
DECL|function|s2io_ioctl
r_int
id|s2io_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_change_mtu - entry point to change MTU size for the device.&n; *   @dev : device pointer.&n; *   @new_mtu : the new MTU size for the device.&n; *   Description: A driver entry point to change MTU size for the device.&n; *   Before changing the MTU the device must be stopped.&n; *  Return value:&n; *   0 on success and an appropriate (-)ve integer as defined in errno.h&n; *   file on failure.&n; */
DECL|function|s2io_change_mtu
r_int
id|s2io_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
r_register
id|u64
id|val64
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Must be stopped to &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;change its MTU &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|new_mtu
OL
id|MIN_MTU
)paren
op_logical_or
(paren
id|new_mtu
OG
id|S2IO_JUMBO_SIZE
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: MTU size is invalid.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* Set the new MTU into the PYLD register of the NIC */
id|val64
op_assign
id|new_mtu
suffix:semicolon
id|writeq
c_func
(paren
id|vBIT
c_func
(paren
id|val64
comma
l_int|2
comma
l_int|14
)paren
comma
op_amp
id|bar0-&gt;rmac_max_pyld_len
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_tasklet - Bottom half of the ISR.&n; *  @dev_adr : address of the device structure in dma_addr_t format.&n; *  Description:&n; *  This is the tasklet or the bottom half of the ISR. This is&n; *  an extension of the ISR which is scheduled by the scheduler to be run &n; *  when the load on the CPU is low. All low priority tasks of the ISR can&n; *  be pushed into the tasklet. For now the tasklet is used only to &n; *  replenish the Rx buffers in the Rx buffer descriptors.&n; *  Return value:&n; *  void.&n; */
DECL|function|s2io_tasklet
r_static
r_void
id|s2io_tasklet
c_func
(paren
r_int
r_int
id|dev_addr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_addr
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|mac_control
op_assign
op_amp
id|sp-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|sp-&gt;config
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|TASKLET_IN_USE
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_assign
id|fill_rx_buffers
c_func
(paren
id|sp
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Out of &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;memory in tasklet&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EFILL
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Rx Ring %d is full&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
op_amp
id|sp-&gt;tasklet_status
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * s2io_set_link - Set the LInk status&n; * @data: long pointer to device private structue&n; * Description: Sets the link status for the adapter&n; */
DECL|function|s2io_set_link
r_static
r_void
id|s2io_set_link
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|nic_t
op_star
id|nic
op_assign
(paren
id|nic_t
op_star
)paren
id|data
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|nic-&gt;dev
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|nic-&gt;bar0
suffix:semicolon
r_register
id|u64
id|val64
suffix:semicolon
id|u16
id|subid
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
(paren
id|nic-&gt;link_state
)paren
)paren
)paren
(brace
multiline_comment|/* The card is being reset, no point doing anything */
r_return
suffix:semicolon
)brace
id|subid
op_assign
id|nic-&gt;pdev-&gt;subsystem_device
suffix:semicolon
multiline_comment|/* &n;&t; * Allow a small delay for the NICs self initiated &n;&t; * cleanup to complete.&n;&t; */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verify_xena_quiescence
c_func
(paren
id|val64
comma
id|nic-&gt;device_enabled_once
)paren
)paren
(brace
r_if
c_cond
(paren
id|LINK_IS_UP
c_func
(paren
id|val64
)paren
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
id|val64
op_or_assign
id|ADAPTER_CNTL_EN
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CARDS_WITH_FAULTY_LINK_INDICATORS
c_func
(paren
id|subid
)paren
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_or_assign
id|GPIO_CTRL_GPIO_0
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
)brace
r_else
(brace
id|val64
op_or_assign
id|ADAPTER_LED_ON
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;adapter_control
)paren
suffix:semicolon
)brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|LINK_IS_UP
c_func
(paren
id|val64
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s:&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot; Link down&quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;after &quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;enabling &quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;device &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nic-&gt;device_enabled_once
op_eq
id|FALSE
)paren
(brace
id|nic-&gt;device_enabled_once
op_assign
id|TRUE
suffix:semicolon
)brace
id|s2io_link
c_func
(paren
id|nic
comma
id|LINK_UP
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|CARDS_WITH_FAULTY_LINK_INDICATORS
c_func
(paren
id|subid
)paren
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_and_assign
op_complement
id|GPIO_CTRL_GPIO_0
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
)brace
id|s2io_link
c_func
(paren
id|nic
comma
id|LINK_DOWN
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* NIC is not Quiescent. */
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Error: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;device is not Quiescent&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
(paren
id|nic-&gt;link_state
)paren
)paren
suffix:semicolon
)brace
DECL|function|s2io_card_down
r_static
r_void
id|s2io_card_down
c_func
(paren
id|nic_t
op_star
id|sp
)paren
(brace
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_register
id|u64
id|val64
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If s2io_set_link task is executing, wait till it completes. */
r_while
c_loop
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
(paren
id|sp-&gt;link_state
)paren
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|sp-&gt;card_state
comma
id|CARD_DOWN
)paren
suffix:semicolon
multiline_comment|/* disable Tx and Rx traffic on the NIC */
id|stop_nic
c_func
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* Kill tasklet. */
id|tasklet_kill
c_func
(paren
op_amp
id|sp-&gt;task
)paren
suffix:semicolon
multiline_comment|/* Check if the device is Quiescent and then Reset the NIC */
r_do
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;adapter_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verify_xena_quiescence
c_func
(paren
id|val64
comma
id|sp-&gt;device_enabled_once
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_eq
l_int|10
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;s2io_close:Device not Quiescent &quot;
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;adaper status reads 0x%llx&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|val64
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
id|s2io_reset
c_func
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* Free all unused Tx and Rx buffers */
id|free_tx_buffers
c_func
(paren
id|sp
)paren
suffix:semicolon
id|free_rx_buffers
c_func
(paren
id|sp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
(paren
id|sp-&gt;link_state
)paren
)paren
suffix:semicolon
)brace
DECL|function|s2io_card_up
r_static
r_int
id|s2io_card_up
c_func
(paren
id|nic_t
op_star
id|sp
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|sp-&gt;dev
suffix:semicolon
multiline_comment|/* Initialize the H/W I/O registers */
r_if
c_cond
(paren
id|init_nic
c_func
(paren
id|sp
)paren
op_ne
l_int|0
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: H/W initialization failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * Initializing the Rx buffers. For now we are considering only 1 &n;&t; * Rx ring and initializing buffers into 30 Rx blocks&n;&t; */
id|mac_control
op_assign
op_amp
id|sp-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|sp-&gt;config
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|fill_rx_buffers
c_func
(paren
id|sp
comma
id|i
)paren
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Out of memory in Open&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|s2io_reset
c_func
(paren
id|sp
)paren
suffix:semicolon
id|free_rx_buffers
c_func
(paren
id|sp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|DBG_PRINT
c_func
(paren
id|INFO_DBG
comma
l_string|&quot;Buf in ring:%d is %d:&bslash;n&quot;
comma
id|i
comma
id|atomic_read
c_func
(paren
op_amp
id|sp-&gt;rx_bufs_left
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Setting its receive mode */
id|s2io_set_multicast
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Enable tasklet for the device */
id|tasklet_init
c_func
(paren
op_amp
id|sp-&gt;task
comma
id|s2io_tasklet
comma
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Enable Rx Traffic and interrupts on the NIC */
r_if
c_cond
(paren
id|start_nic
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Starting NIC failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|sp-&gt;task
)paren
suffix:semicolon
id|s2io_reset
c_func
(paren
id|sp
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_rx_buffers
c_func
(paren
id|sp
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|sp-&gt;card_state
comma
id|CARD_UP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** &n; * s2io_restart_nic - Resets the NIC.&n; * @data : long pointer to the device private structure&n; * Description:&n; * This function is scheduled to be run by the s2io_tx_watchdog&n; * function after 0.5 secs to reset the NIC. The idea is to reduce &n; * the run time of the watch dog routine which is run holding a&n; * spin lock.&n; */
DECL|function|s2io_restart_nic
r_static
r_void
id|s2io_restart_nic
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|s2io_card_down
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s2io_card_up
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Device bring up failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: was reset by Tx watchdog timer&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; *  s2io_tx_watchdog - Watchdog for transmit side. &n; *  @dev : Pointer to net device structure&n; *  Description:&n; *  This function is triggered if the Tx Queue is stopped&n; *  for a pre-defined amount of time when the Interface is still up.&n; *  If the Interface is jammed in such a situation, the hardware is&n; *  reset (by s2io_close) and restarted again (by s2io_open) to&n; *  overcome any problem that might have been caused in the hardware.&n; *  Return value:&n; *  void&n; */
DECL|function|s2io_tx_watchdog
r_static
r_void
id|s2io_tx_watchdog
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|nic_t
op_star
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|dev
)paren
)paren
(brace
id|schedule_work
c_func
(paren
op_amp
id|sp-&gt;rst_timer_task
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *   rx_osm_handler - To perform some OS related operations on SKB.&n; *   @sp: private member of the device structure,pointer to s2io_nic structure.&n; *   @skb : the socket buffer pointer.&n; *   @len : length of the packet&n; *   @cksum : FCS checksum of the frame.&n; *   @ring_no : the ring from which this RxD was extracted.&n; *   Description: &n; *   This function is called by the Tx interrupt serivce routine to perform&n; *   some OS related operations on the SKB before passing it to the upper&n; *   layers. It mainly checks if the checksum is OK, if so adds it to the&n; *   SKBs cksum variable, increments the Rx packet count and passes the SKB&n; *   to the upper layer. If the checksum is wrong, it increments the Rx&n; *   packet error count, frees the SKB and returns error.&n; *   Return value:&n; *   SUCCESS on success and -1 on failure.&n; */
macro_line|#ifndef CONFIG_2BUFF_MODE
DECL|function|rx_osm_handler
r_static
r_int
id|rx_osm_handler
c_func
(paren
id|nic_t
op_star
id|sp
comma
id|u16
id|len
comma
id|RxD_t
op_star
id|rxdp
comma
r_int
id|ring_no
)paren
macro_line|#else
r_static
r_int
id|rx_osm_handler
c_func
(paren
id|nic_t
op_star
id|sp
comma
id|RxD_t
op_star
id|rxdp
comma
r_int
id|ring_no
comma
id|buffAdd_t
op_star
id|ba
)paren
macro_line|#endif
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|sp-&gt;dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|rxdp-&gt;Host_Control
)paren
suffix:semicolon
id|u16
id|l3_csum
comma
id|l4_csum
suffix:semicolon
macro_line|#ifdef CONFIG_2BUFF_MODE
r_int
id|buf0_len
comma
id|buf2_len
suffix:semicolon
r_int
r_char
op_star
id|buff
suffix:semicolon
macro_line|#endif
id|l3_csum
op_assign
id|RXD_GET_L3_CKSUM
c_func
(paren
id|rxdp-&gt;Control_1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rxdp-&gt;Control_1
op_amp
id|TCP_OR_UDP_FRAME
)paren
op_logical_and
(paren
id|sp-&gt;rx_csum
)paren
)paren
(brace
id|l4_csum
op_assign
id|RXD_GET_L4_CKSUM
c_func
(paren
id|rxdp-&gt;Control_1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l3_csum
op_eq
id|L3_CKSUM_OK
)paren
op_logical_and
(paren
id|l4_csum
op_eq
id|L4_CKSUM_OK
)paren
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * NIC verifies if the Checksum of the received&n;&t;&t;&t; * frame is Ok or not and accordingly returns&n;&t;&t;&t; * a flag in the RxD.&n;&t;&t;&t; */
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &n;&t;&t;&t; * Packet with erroneous checksum, let the &n;&t;&t;&t; * upper layers deal with it.&n;&t;&t;&t; */
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
)brace
)brace
r_else
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rxdp-&gt;Control_1
op_amp
id|RXD_T_CODE
)paren
(brace
r_int
r_int
r_int
id|err
op_assign
id|rxdp-&gt;Control_1
op_amp
id|RXD_T_CODE
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Rx error Value: 0x%llx&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|err
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_2BUFF_MODE
id|buf0_len
op_assign
id|RXD_GET_BUFFER0_SIZE
c_func
(paren
id|rxdp-&gt;Control_2
)paren
suffix:semicolon
id|buf2_len
op_assign
id|RXD_GET_BUFFER2_SIZE
c_func
(paren
id|rxdp-&gt;Control_2
)paren
suffix:semicolon
macro_line|#endif
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
macro_line|#ifndef CONFIG_2BUFF_MODE
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
macro_line|#else
id|buff
op_assign
id|skb_push
c_func
(paren
id|skb
comma
id|buf0_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
comma
id|ba-&gt;ba_0
comma
id|buf0_len
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|buf2_len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_S2IO_NAPI
id|netif_receive_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#else
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|sp-&gt;rx_pkt_count
op_increment
suffix:semicolon
id|sp-&gt;stats.rx_packets
op_increment
suffix:semicolon
macro_line|#ifndef CONFIG_2BUFF_MODE
id|sp-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
macro_line|#else
id|sp-&gt;stats.rx_bytes
op_add_assign
id|buf0_len
op_plus
id|buf2_len
suffix:semicolon
macro_line|#endif
id|atomic_dec
c_func
(paren
op_amp
id|sp-&gt;rx_bufs_left
(braket
id|ring_no
)braket
)paren
suffix:semicolon
id|rxdp-&gt;Host_Control
op_assign
l_int|0
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_link - stops/starts the Tx queue.&n; *  @sp : private member of the device structure, which is a pointer to the&n; *  s2io_nic structure.&n; *  @link : inidicates whether link is UP/DOWN.&n; *  Description:&n; *  This function stops/starts the Tx queue depending on whether the link&n; *  status of the NIC is is down or up. This is called by the Alarm &n; *  interrupt handler whenever a link change interrupt comes up. &n; *  Return value:&n; *  void.&n; */
DECL|function|s2io_link
r_void
id|s2io_link
c_func
(paren
id|nic_t
op_star
id|sp
comma
r_int
id|link
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|sp-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|link
op_ne
id|sp-&gt;last_link_state
)paren
(brace
r_if
c_cond
(paren
id|link
op_eq
id|LINK_DOWN
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Link down&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Link Up&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|sp-&gt;last_link_state
op_assign
id|link
suffix:semicolon
)brace
multiline_comment|/**&n; *  get_xena_rev_id - to identify revision ID of xena. &n; *  @pdev : PCI Dev structure&n; *  Description:&n; *  Function to identify the Revision ID of xena.&n; *  Return value:&n; *  returns the revision ID of the device.&n; */
DECL|function|get_xena_rev_id
r_int
id|get_xena_rev_id
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u8
id|id
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
(paren
id|u8
op_star
)paren
op_amp
id|id
)paren
suffix:semicolon
r_return
id|id
suffix:semicolon
)brace
multiline_comment|/**&n; *  s2io_init_pci -Initialization of PCI and PCI-X configuration registers . &n; *  @sp : private member of the device structure, which is a pointer to the &n; *  s2io_nic structure.&n; *  Description:&n; *  This function initializes a few of the PCI and PCI-X configuration registers&n; *  with recommended values.&n; *  Return value:&n; *  void&n; */
DECL|function|s2io_init_pci
r_static
r_void
id|s2io_init_pci
c_func
(paren
id|nic_t
op_star
id|sp
)paren
(brace
id|u16
id|pci_cmd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Enable Data Parity Error Recovery in PCI-X command register. */
id|pci_read_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
op_amp
(paren
id|sp-&gt;pcix_cmd
)paren
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
(paren
id|sp-&gt;pcix_cmd
op_or
l_int|1
)paren
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
op_amp
(paren
id|sp-&gt;pcix_cmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the PErr Response bit in PCI command register. */
id|pci_read_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|pci_cmd
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCI_COMMAND
comma
(paren
id|pci_cmd
op_or
id|PCI_COMMAND_PARITY
)paren
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|pci_cmd
)paren
suffix:semicolon
multiline_comment|/* Set MMRB count to 1024 in PCI-X Command register. */
id|sp-&gt;pcix_cmd
op_and_assign
l_int|0xFFF3
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
(paren
id|sp-&gt;pcix_cmd
op_or
(paren
l_int|0x1
op_lshift
l_int|2
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* MMRBC 1K */
id|pci_read_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
op_amp
(paren
id|sp-&gt;pcix_cmd
)paren
)paren
suffix:semicolon
multiline_comment|/*  Setting Maximum outstanding splits based on system type. */
id|sp-&gt;pcix_cmd
op_and_assign
l_int|0xFF8F
suffix:semicolon
id|sp-&gt;pcix_cmd
op_or_assign
id|XENA_MAX_OUTSTANDING_SPLITS
c_func
(paren
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* 2 splits. */
id|pci_write_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
id|sp-&gt;pcix_cmd
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
op_amp
(paren
id|sp-&gt;pcix_cmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Forcibly disabling relaxed ordering capability of the card. */
id|sp-&gt;pcix_cmd
op_and_assign
l_int|0xfffd
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
id|sp-&gt;pcix_cmd
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|sp-&gt;pdev
comma
id|PCIX_COMMAND_REGISTER
comma
op_amp
(paren
id|sp-&gt;pcix_cmd
)paren
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Raghavendra Koushik &lt;raghavendra.koushik@s2io.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|tx_fifo_num
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|tx_fifo_len
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|rx_ring_num
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|rx_ring_sz
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|Stats_refresh_time
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|rmac_pause_time
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|mc_pause_threshold_q0q3
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|mc_pause_threshold_q4q7
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|shared_splits
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|tmac_util_period
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|rmac_util_period
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_S2IO_NAPI
id|module_param
c_func
(paren
id|indicate_max_pkts
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/**&n; *  s2io_init_nic - Initialization of the adapter . &n; *  @pdev : structure containing the PCI related information of the device.&n; *  @pre: List of PCI devices supported by the driver listed in s2io_tbl.&n; *  Description:&n; *  The function initializes an adapter identified by the pci_dec structure.&n; *  All OS related initialization including memory and device structure and &n; *  initlaization of the device private variable is done. Also the swapper &n; *  control register is initialized to enable read and write into the I/O &n; *  registers of the device.&n; *  Return value:&n; *  returns 0 on success and negative on failure.&n; */
r_static
r_int
id|__devinit
DECL|function|s2io_init_nic
id|s2io_init_nic
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pre
)paren
(brace
id|nic_t
op_star
id|sp
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_char
op_star
id|dev_name
op_assign
l_string|&quot;S2IO 10GE NIC&quot;
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|ret
suffix:semicolon
r_int
id|dma_flag
op_assign
id|FALSE
suffix:semicolon
id|u32
id|mac_up
comma
id|mac_down
suffix:semicolon
id|u64
id|val64
op_assign
l_int|0
comma
id|tmp64
op_assign
l_int|0
suffix:semicolon
id|XENA_dev_config_t
op_star
id|bar0
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|subid
suffix:semicolon
id|mac_info_t
op_star
id|mac_control
suffix:semicolon
r_struct
id|config_param
op_star
id|config
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Loading S2IO driver with %s&bslash;n&quot;
comma
id|s2io_driver_version
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;s2io_init_nic: pci_enable_device failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffffffffffULL
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|INIT_DBG
comma
l_string|&quot;s2io_init_nic: Using 64bit DMA&bslash;n&quot;
)paren
suffix:semicolon
id|dma_flag
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_consistent_dma_mask
(paren
id|pdev
comma
l_int|0xffffffffffffffffULL
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Unable to obtain 64bit DMA for &bslash;&n;&t;&t;&t;&t;&t;consistent allocations&bslash;n&quot;
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffUL
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|INIT_DBG
comma
l_string|&quot;s2io_init_nic: Using 32bit DMA&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|s2io_driver_name
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Request Regions failed&bslash;n&quot;
)paren
comma
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
id|nic_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Device allocation failed&bslash;n&quot;
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
multiline_comment|/*  Private member variable initialized to s2io NIC structure */
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|sp
comma
l_int|0
comma
r_sizeof
(paren
id|nic_t
)paren
)paren
suffix:semicolon
id|sp-&gt;dev
op_assign
id|dev
suffix:semicolon
id|sp-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|sp-&gt;vendor_id
op_assign
id|pdev-&gt;vendor
suffix:semicolon
id|sp-&gt;device_id
op_assign
id|pdev-&gt;device
suffix:semicolon
id|sp-&gt;high_dma_flag
op_assign
id|dma_flag
suffix:semicolon
id|sp-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|sp-&gt;device_enabled_once
op_assign
id|FALSE
suffix:semicolon
id|strcpy
c_func
(paren
id|sp-&gt;name
comma
id|dev_name
)paren
suffix:semicolon
multiline_comment|/* Initialize some PCI/PCI-X fields of the NIC. */
id|s2io_init_pci
c_func
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Setting the device configuration parameters.&n;&t; * Most of these parameters can be specified by the user during &n;&t; * module insertion as they are module loadable parameters. If &n;&t; * these parameters are not not specified during load time, they &n;&t; * are initialized with default values.&n;&t; */
id|mac_control
op_assign
op_amp
id|sp-&gt;mac_control
suffix:semicolon
id|config
op_assign
op_amp
id|sp-&gt;config
suffix:semicolon
multiline_comment|/* Tx side parameters. */
id|tx_fifo_len
(braket
l_int|0
)braket
op_assign
id|DEFAULT_FIFO_LEN
suffix:semicolon
multiline_comment|/* Default value. */
id|config-&gt;tx_fifo_num
op_assign
id|tx_fifo_num
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TX_FIFOS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
op_assign
id|tx_fifo_len
(braket
id|i
)braket
suffix:semicolon
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_priority
op_assign
id|i
suffix:semicolon
)brace
id|config-&gt;tx_intr_type
op_assign
id|TXD_INT_TYPE_UTILZ
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;tx_fifo_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|f_no_snoop
op_assign
(paren
id|NO_SNOOP_TXD
op_or
id|NO_SNOOP_TXD_BUFFER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|config-&gt;tx_cfg
(braket
id|i
)braket
dot
id|fifo_len
OL
l_int|65
)paren
(brace
id|config-&gt;tx_intr_type
op_assign
id|TXD_INT_TYPE_PER_LIST
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|config-&gt;max_txds
op_assign
id|MAX_SKB_FRAGS
suffix:semicolon
multiline_comment|/* Rx side parameters. */
id|rx_ring_sz
(braket
l_int|0
)braket
op_assign
id|SMALL_BLK_CNT
suffix:semicolon
multiline_comment|/* Default value. */
id|config-&gt;rx_ring_num
op_assign
id|rx_ring_num
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_RX_RINGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|num_rxd
op_assign
id|rx_ring_sz
(braket
id|i
)braket
op_star
(paren
id|MAX_RXDS_PER_BLOCK
op_plus
l_int|1
)paren
suffix:semicolon
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|ring_priority
op_assign
id|i
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|ring_org
op_assign
id|RING_ORG_BUFF1
suffix:semicolon
id|config-&gt;rx_cfg
(braket
id|i
)braket
dot
id|f_no_snoop
op_assign
(paren
id|NO_SNOOP_RXD
op_or
id|NO_SNOOP_RXD_BUFFER
)paren
suffix:semicolon
)brace
multiline_comment|/*  Setting Mac Control parameters */
id|mac_control-&gt;rmac_pause_time
op_assign
id|rmac_pause_time
suffix:semicolon
id|mac_control-&gt;mc_pause_threshold_q0q3
op_assign
id|mc_pause_threshold_q0q3
suffix:semicolon
id|mac_control-&gt;mc_pause_threshold_q4q7
op_assign
id|mc_pause_threshold_q4q7
suffix:semicolon
multiline_comment|/* Initialize Ring buffer parameters. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;rx_ring_num
suffix:semicolon
id|i
op_increment
)paren
id|atomic_set
c_func
(paren
op_amp
id|sp-&gt;rx_bufs_left
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*  initialize the shared memory used by the NIC and the host */
r_if
c_cond
(paren
id|init_shared_mem
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: Memory allocation failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|mem_alloc_failed
suffix:semicolon
)brace
id|sp-&gt;bar0
op_assign
(paren
id|caddr_t
)paren
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sp-&gt;bar0
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: S2IO: cannot remap io mem1&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|bar0_remap_failed
suffix:semicolon
)brace
id|sp-&gt;bar1
op_assign
(paren
id|caddr_t
)paren
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sp-&gt;bar1
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: S2IO: cannot remap io mem2&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|bar1_remap_failed
suffix:semicolon
)brace
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|sp-&gt;bar0
suffix:semicolon
multiline_comment|/* Initializing the BAR1 address as the start of the FIFO pointer. */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|MAX_TX_FIFOS
suffix:semicolon
id|j
op_increment
)paren
(brace
id|mac_control-&gt;tx_FIFO_start
(braket
id|j
)braket
op_assign
(paren
id|TxFIFO_element_t
op_star
)paren
(paren
id|sp-&gt;bar1
op_plus
(paren
id|j
op_star
l_int|0x00020000
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*  Driver entry points */
id|dev-&gt;open
op_assign
op_amp
id|s2io_open
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|s2io_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|s2io_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|s2io_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|s2io_set_multicast
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|s2io_ioctl
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
op_amp
id|s2io_change_mtu
suffix:semicolon
id|SET_ETHTOOL_OPS
c_func
(paren
id|dev
comma
op_amp
id|netdev_ethtool_ops
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * will use eth_mac_addr() for  dev-&gt;set_mac_address&n;&t; * mac address will be set every time dev-&gt;open() is called&n;&t; */
macro_line|#ifdef CONFIG_S2IO_NAPI
id|dev-&gt;poll
op_assign
id|s2io_poll
suffix:semicolon
id|dev-&gt;weight
op_assign
l_int|90
suffix:semicolon
macro_line|#endif
id|dev-&gt;features
op_or_assign
id|NETIF_F_SG
op_or
id|NETIF_F_IP_CSUM
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;high_dma_flag
op_eq
id|TRUE
)paren
id|dev-&gt;features
op_or_assign
id|NETIF_F_HIGHDMA
suffix:semicolon
macro_line|#ifdef NETIF_F_TSO
id|dev-&gt;features
op_or_assign
id|NETIF_F_TSO
suffix:semicolon
macro_line|#endif
id|dev-&gt;tx_timeout
op_assign
op_amp
id|s2io_tx_watchdog
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|WATCH_DOG_TIMEOUT
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|sp-&gt;rst_timer_task
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|s2io_restart_nic
comma
id|dev
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|sp-&gt;set_link_task
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|s2io_set_link
comma
id|sp
)paren
suffix:semicolon
id|pci_save_state
c_func
(paren
id|sp-&gt;pdev
)paren
suffix:semicolon
multiline_comment|/* Setting swapper control on the NIC, for proper reset operation */
r_if
c_cond
(paren
id|s2io_set_swapper
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s:swapper settings are wrong&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|set_swap_failed
suffix:semicolon
)brace
multiline_comment|/* Fix for all &quot;FFs&quot; MAC address problems observed on Alpha platforms */
id|fix_mac_address
c_func
(paren
id|sp
)paren
suffix:semicolon
id|s2io_reset
c_func
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setting swapper control on the NIC, so the MAC address can be read.&n;&t; */
r_if
c_cond
(paren
id|s2io_set_swapper
c_func
(paren
id|sp
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;%s: S2IO: swapper settings are wrong&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|set_swap_failed
suffix:semicolon
)brace
multiline_comment|/*  &n;&t; * MAC address initialization.&n;&t; * For now only one mac address will be read and used.&n;&t; */
id|bar0
op_assign
(paren
id|XENA_dev_config_t
op_star
)paren
id|sp-&gt;bar0
suffix:semicolon
id|val64
op_assign
id|RMAC_ADDR_CMD_MEM_RD
op_or
id|RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD
op_or
id|RMAC_ADDR_CMD_MEM_OFFSET
c_func
(paren
l_int|0
op_plus
id|MAC_MAC_ADDR_START_OFFSET
)paren
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;rmac_addr_cmd_mem
)paren
suffix:semicolon
id|wait_for_cmd_complete
c_func
(paren
id|sp
)paren
suffix:semicolon
id|tmp64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;rmac_addr_data0_mem
)paren
suffix:semicolon
id|mac_down
op_assign
(paren
id|u32
)paren
id|tmp64
suffix:semicolon
id|mac_up
op_assign
(paren
id|u32
)paren
(paren
id|tmp64
op_rshift
l_int|32
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
comma
l_int|0
comma
r_sizeof
(paren
id|ETH_ALEN
)paren
)paren
suffix:semicolon
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|3
)braket
op_assign
(paren
id|u8
)paren
(paren
id|mac_up
)paren
suffix:semicolon
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|2
)braket
op_assign
(paren
id|u8
)paren
(paren
id|mac_up
op_rshift
l_int|8
)paren
suffix:semicolon
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|mac_up
op_rshift
l_int|16
)paren
suffix:semicolon
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
(paren
id|mac_up
op_rshift
l_int|24
)paren
suffix:semicolon
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|5
)braket
op_assign
(paren
id|u8
)paren
(paren
id|mac_down
op_rshift
l_int|16
)paren
suffix:semicolon
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|4
)braket
op_assign
(paren
id|u8
)paren
(paren
id|mac_down
op_rshift
l_int|24
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INIT_DBG
comma
l_string|&quot;DEFAULT MAC ADDR:0x%02x-%02x-%02x-%02x-%02x-%02x&bslash;n&quot;
comma
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|0
)braket
comma
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|1
)braket
comma
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|2
)braket
comma
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|3
)braket
comma
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|4
)braket
comma
id|sp-&gt;def_mac_addr
(braket
l_int|0
)braket
dot
id|mac_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/*  Set the factory defined MAC address initially   */
id|dev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|sp-&gt;def_mac_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the tasklet status and link state flags &n;&t; * and the card statte parameter&n;&t; */
id|atomic_set
c_func
(paren
op_amp
(paren
id|sp-&gt;card_state
)paren
comma
l_int|0
)paren
suffix:semicolon
id|sp-&gt;tasklet_status
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;link_state
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize spinlocks */
id|spin_lock_init
c_func
(paren
op_amp
id|sp-&gt;tx_lock
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_S2IO_NAPI
id|spin_lock_init
c_func
(paren
op_amp
id|sp-&gt;put_lock
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* &n;&t; * SXE-002: Configure link and activity LED to init state &n;&t; * on driver load. &n;&t; */
id|subid
op_assign
id|sp-&gt;pdev-&gt;subsystem_device
suffix:semicolon
r_if
c_cond
(paren
(paren
id|subid
op_amp
l_int|0xFF
)paren
op_ge
l_int|0x07
)paren
(brace
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_or_assign
l_int|0x0000800000000000ULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
id|val64
op_assign
l_int|0x0411040400000000ULL
suffix:semicolon
id|writeq
c_func
(paren
id|val64
comma
(paren
id|u64
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|bar0
op_plus
l_int|0x2700
)paren
)paren
suffix:semicolon
id|val64
op_assign
id|readq
c_func
(paren
op_amp
id|bar0-&gt;gpio_control
)paren
suffix:semicolon
)brace
id|sp-&gt;rx_csum
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Rx chksum verify enabled by default */
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Device registration failed&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|register_failed
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * Make Link state as off at this point, when the Link change &n;&t; * interrupt comes the state will be automatically changed to &n;&t; * the right state.&n;&t; */
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;last_link_state
op_assign
id|LINK_DOWN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|register_failed
suffix:colon
id|set_swap_failed
suffix:colon
id|iounmap
c_func
(paren
id|sp-&gt;bar1
)paren
suffix:semicolon
id|bar1_remap_failed
suffix:colon
id|iounmap
c_func
(paren
id|sp-&gt;bar0
)paren
suffix:semicolon
id|bar0_remap_failed
suffix:colon
id|mem_alloc_failed
suffix:colon
id|free_shared_mem
c_func
(paren
id|sp
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_rem_nic - Free the PCI device &n; * @pdev: structure containing the PCI related information of the device.&n; * Description: This function is called by the Pci subsystem to release a &n; * PCI device and free up all resource held up by the device. This could&n; * be in response to a Hot plug event or when the driver is to be removed &n; * from memory.&n; */
DECL|function|s2io_rem_nic
r_static
r_void
id|__devexit
id|s2io_rem_nic
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|nic_t
op_star
id|sp
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|DBG_PRINT
c_func
(paren
id|ERR_DBG
comma
l_string|&quot;Driver Data is NULL!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_shared_mem
c_func
(paren
id|sp
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|sp-&gt;bar0
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|sp-&gt;bar1
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_starter - Entry point for the driver&n; * Description: This function is the entry point for the driver. It verifies&n; * the module loadable parameters and initializes PCI configuration space.&n; */
DECL|function|s2io_starter
r_int
id|__init
id|s2io_starter
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|s2io_driver
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * s2io_closer - Cleanup routine for the driver &n; * Description: This function is the cleanup routine for the driver. It unregist * ers the driver.&n; */
DECL|function|s2io_closer
r_void
id|s2io_closer
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|s2io_driver
)paren
suffix:semicolon
id|DBG_PRINT
c_func
(paren
id|INIT_DBG
comma
l_string|&quot;cleanup done&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|s2io_starter
id|module_init
c_func
(paren
id|s2io_starter
)paren
suffix:semicolon
DECL|variable|s2io_closer
id|module_exit
c_func
(paren
id|s2io_closer
)paren
suffix:semicolon
eof
