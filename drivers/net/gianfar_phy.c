multiline_comment|/* &n; * drivers/net/gianfar_phy.c&n; *&n; * Gianfar Ethernet Driver -- PHY handling&n; * Driver for FEC on MPC8540 and TSEC on MPC8540/MPC8560&n; * Based on 8260_io/fcc_enet.c&n; *&n; * Author: Andy Fleming&n; * Maintainer: Kumar Gala (kumar.gala@freescale.com)&n; *&n; * Copyright 2004 Freescale Semiconductor, Inc&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &quot;gianfar.h&quot;
macro_line|#include &quot;gianfar_phy.h&quot;
multiline_comment|/* Write value to the PHY for this device to the register at regnum, */
multiline_comment|/* waiting until the write is done before it returns.  All PHY */
multiline_comment|/* configuration has to be done through the TSEC1 MIIM regs */
DECL|function|write_phy_reg
r_void
id|write_phy_reg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|regnum
comma
id|u16
id|value
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
(paren
r_struct
id|gfar_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|gfar
op_star
id|regbase
op_assign
id|priv-&gt;phyregs
suffix:semicolon
r_struct
id|ocp_gfar_data
op_star
id|einfo
op_assign
id|priv-&gt;einfo
suffix:semicolon
multiline_comment|/* Set the PHY address and the register address we want to write */
id|gfar_write
c_func
(paren
op_amp
id|regbase-&gt;miimadd
comma
(paren
(paren
id|einfo-&gt;phyid
)paren
op_lshift
l_int|8
)paren
op_or
id|regnum
)paren
suffix:semicolon
multiline_comment|/* Write out the value we want */
id|gfar_write
c_func
(paren
op_amp
id|regbase-&gt;miimcon
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* Wait for the transaction to finish */
r_while
c_loop
(paren
id|gfar_read
c_func
(paren
op_amp
id|regbase-&gt;miimind
)paren
op_amp
id|MIIMIND_BUSY
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Reads from register regnum in the PHY for device dev, */
multiline_comment|/* returning the value.  Clears miimcom first.  All PHY */
multiline_comment|/* configuration has to be done through the TSEC1 MIIM regs */
DECL|function|read_phy_reg
id|u16
id|read_phy_reg
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|regnum
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
(paren
r_struct
id|gfar_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|gfar
op_star
id|regbase
op_assign
id|priv-&gt;phyregs
suffix:semicolon
r_struct
id|ocp_gfar_data
op_star
id|einfo
op_assign
id|priv-&gt;einfo
suffix:semicolon
id|u16
id|value
suffix:semicolon
multiline_comment|/* Set the PHY address and the register address we want to read */
id|gfar_write
c_func
(paren
op_amp
id|regbase-&gt;miimadd
comma
(paren
(paren
id|einfo-&gt;phyid
)paren
op_lshift
l_int|8
)paren
op_or
id|regnum
)paren
suffix:semicolon
multiline_comment|/* Clear miimcom, and then initiate a read */
id|gfar_write
c_func
(paren
op_amp
id|regbase-&gt;miimcom
comma
l_int|0
)paren
suffix:semicolon
id|gfar_write
c_func
(paren
op_amp
id|regbase-&gt;miimcom
comma
id|MIIM_READ_COMMAND
)paren
suffix:semicolon
multiline_comment|/* Wait for the transaction to finish */
r_while
c_loop
(paren
id|gfar_read
c_func
(paren
op_amp
id|regbase-&gt;miimind
)paren
op_amp
(paren
id|MIIMIND_NOTVALID
op_or
id|MIIMIND_BUSY
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Grab the value of the register from miimstat */
id|value
op_assign
id|gfar_read
c_func
(paren
op_amp
id|regbase-&gt;miimstat
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/* returns which value to write to the control register. */
multiline_comment|/* For 10/100 the value is slightly different. */
DECL|function|mii_cr_init
id|u16
id|mii_cr_init
c_func
(paren
id|u16
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
(paren
r_struct
id|gfar_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ocp_gfar_data
op_star
id|einfo
op_assign
id|priv-&gt;einfo
suffix:semicolon
r_if
c_cond
(paren
id|einfo-&gt;flags
op_amp
id|GFAR_HAS_GIGABIT
)paren
r_return
id|MIIM_CONTROL_INIT
suffix:semicolon
r_else
r_return
id|MIIM_CR_INIT
suffix:semicolon
)brace
DECL|macro|BRIEF_GFAR_ERRORS
mdefine_line|#define BRIEF_GFAR_ERRORS
multiline_comment|/* Wait for auto-negotiation to complete */
DECL|function|mii_parse_sr
id|u16
id|mii_parse_sr
c_func
(paren
id|u16
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
(paren
r_struct
id|gfar_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|timeout
op_assign
id|GFAR_AN_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
id|MIIM_STATUS_LINK
)paren
id|priv-&gt;link
op_assign
l_int|1
suffix:semicolon
r_else
id|priv-&gt;link
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Only auto-negotiate if the link has just gone up */
r_if
c_cond
(paren
id|priv-&gt;link
op_logical_and
op_logical_neg
id|priv-&gt;oldlink
)paren
(brace
r_while
c_loop
(paren
(paren
op_logical_neg
(paren
id|mii_reg
op_amp
id|MIIM_STATUS_AN_DONE
)paren
)paren
op_logical_and
id|timeout
op_decrement
)paren
id|mii_reg
op_assign
id|read_phy_reg
c_func
(paren
id|dev
comma
id|MIIM_STATUS
)paren
suffix:semicolon
macro_line|#if defined(BRIEF_GFAR_ERRORS)
r_if
c_cond
(paren
id|mii_reg
op_amp
id|MIIM_STATUS_AN_DONE
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Auto-negotiation done&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Auto-negotiation timed out&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Determine the speed and duplex which was negotiated */
DECL|function|mii_parse_88E1011_psr
id|u16
id|mii_parse_88E1011_psr
c_func
(paren
id|u16
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
(paren
r_struct
id|gfar_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|speed
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;link
)paren
(brace
r_if
c_cond
(paren
id|mii_reg
op_amp
id|MIIM_88E1011_PHYSTAT_DUPLEX
)paren
id|priv-&gt;duplexity
op_assign
l_int|1
suffix:semicolon
r_else
id|priv-&gt;duplexity
op_assign
l_int|0
suffix:semicolon
id|speed
op_assign
(paren
id|mii_reg
op_amp
id|MIIM_88E1011_PHYSTAT_SPEED
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
id|MIIM_88E1011_PHYSTAT_GBIT
suffix:colon
id|priv-&gt;speed
op_assign
l_int|1000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIIM_88E1011_PHYSTAT_100
suffix:colon
id|priv-&gt;speed
op_assign
l_int|100
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|priv-&gt;speed
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|priv-&gt;speed
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;duplexity
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mii_parse_cis8201
id|u16
id|mii_parse_cis8201
c_func
(paren
id|u16
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
(paren
r_struct
id|gfar_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|speed
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;link
)paren
(brace
r_if
c_cond
(paren
id|mii_reg
op_amp
id|MIIM_CIS8201_AUXCONSTAT_DUPLEX
)paren
id|priv-&gt;duplexity
op_assign
l_int|1
suffix:semicolon
r_else
id|priv-&gt;duplexity
op_assign
l_int|0
suffix:semicolon
id|speed
op_assign
id|mii_reg
op_amp
id|MIIM_CIS8201_AUXCONSTAT_SPEED
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
id|MIIM_CIS8201_AUXCONSTAT_GBIT
suffix:colon
id|priv-&gt;speed
op_assign
l_int|1000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIIM_CIS8201_AUXCONSTAT_100
suffix:colon
id|priv-&gt;speed
op_assign
l_int|100
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|priv-&gt;speed
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|priv-&gt;speed
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;duplexity
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mii_parse_dm9161_scsr
id|u16
id|mii_parse_dm9161_scsr
c_func
(paren
id|u16
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gfar_private
op_star
id|priv
op_assign
(paren
r_struct
id|gfar_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
(paren
id|MIIM_DM9161_SCSR_100F
op_or
id|MIIM_DM9161_SCSR_100H
)paren
)paren
id|priv-&gt;speed
op_assign
l_int|100
suffix:semicolon
r_else
id|priv-&gt;speed
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
(paren
id|MIIM_DM9161_SCSR_100F
op_or
id|MIIM_DM9161_SCSR_10F
)paren
)paren
id|priv-&gt;duplexity
op_assign
l_int|1
suffix:semicolon
r_else
id|priv-&gt;duplexity
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dm9161_wait
id|u16
id|dm9161_wait
c_func
(paren
id|u16
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|timeout
op_assign
id|HZ
suffix:semicolon
r_int
id|secondary
op_assign
l_int|10
suffix:semicolon
id|u16
id|temp
suffix:semicolon
r_do
(brace
multiline_comment|/* Davicom takes a bit to come up after a reset,&n;&t;&t; * so wait here for a bit */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|temp
op_assign
id|read_phy_reg
c_func
(paren
id|dev
comma
id|MIIM_STATUS
)paren
suffix:semicolon
id|secondary
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
op_logical_neg
(paren
id|temp
op_amp
id|MIIM_STATUS_AN_DONE
)paren
)paren
op_logical_and
id|secondary
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|phy_info_M88E1011S
r_static
r_struct
id|phy_info
id|phy_info_M88E1011S
op_assign
(brace
l_int|0x01410c6
comma
l_string|&quot;Marvell 88E1011S&quot;
comma
l_int|4
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* config */
multiline_comment|/* Reset and configure the PHY */
(brace
id|MIIM_CONTROL
comma
id|MIIM_CONTROL_INIT
comma
id|mii_cr_init
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* startup */
multiline_comment|/* Status is read once to clear old link state */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Auto-negotiate */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
id|mii_parse_sr
)brace
comma
multiline_comment|/* Read the status */
(brace
id|MIIM_88E1011_PHY_STATUS
comma
id|miim_read
comma
id|mii_parse_88E1011_psr
)brace
comma
multiline_comment|/* Clear the IEVENT register */
(brace
id|MIIM_88E1011_IEVENT
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Set up the mask */
(brace
id|MIIM_88E1011_IMASK
comma
id|MIIM_88E1011_IMASK_INIT
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* ack_int */
multiline_comment|/* Clear the interrupt */
(brace
id|MIIM_88E1011_IEVENT
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Disable interrupts */
(brace
id|MIIM_88E1011_IMASK
comma
id|MIIM_88E1011_IMASK_CLEAR
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* handle_int */
multiline_comment|/* Read the Status (2x to make sure link is right) */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Check the status */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
id|mii_parse_sr
)brace
comma
(brace
id|MIIM_88E1011_PHY_STATUS
comma
id|miim_read
comma
id|mii_parse_88E1011_psr
)brace
comma
multiline_comment|/* Enable Interrupts */
(brace
id|MIIM_88E1011_IMASK
comma
id|MIIM_88E1011_IMASK_INIT
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* shutdown */
(brace
id|MIIM_88E1011_IEVENT
comma
id|miim_read
comma
l_int|NULL
)brace
comma
(brace
id|MIIM_88E1011_IMASK
comma
id|MIIM_88E1011_IMASK_CLEAR
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* Cicada 8204 */
DECL|variable|phy_info_cis8204
r_static
r_struct
id|phy_info
id|phy_info_cis8204
op_assign
(brace
l_int|0x3f11
comma
l_string|&quot;Cicada Cis8204&quot;
comma
l_int|6
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* config */
multiline_comment|/* Override PHY config settings */
(brace
id|MIIM_CIS8201_AUX_CONSTAT
comma
id|MIIM_CIS8201_AUXCONSTAT_INIT
comma
l_int|NULL
)brace
comma
multiline_comment|/* Set up the interface mode */
(brace
id|MIIM_CIS8201_EXT_CON1
comma
id|MIIM_CIS8201_EXTCON1_INIT
comma
l_int|NULL
)brace
comma
multiline_comment|/* Configure some basic stuff */
(brace
id|MIIM_CONTROL
comma
id|MIIM_CONTROL_INIT
comma
id|mii_cr_init
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* startup */
multiline_comment|/* Read the Status (2x to make sure link is right) */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Auto-negotiate */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
id|mii_parse_sr
)brace
comma
multiline_comment|/* Read the status */
(brace
id|MIIM_CIS8201_AUX_CONSTAT
comma
id|miim_read
comma
id|mii_parse_cis8201
)brace
comma
multiline_comment|/* Clear the status register */
(brace
id|MIIM_CIS8204_ISTAT
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Enable interrupts */
(brace
id|MIIM_CIS8204_IMASK
comma
id|MIIM_CIS8204_IMASK_MASK
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* ack_int */
multiline_comment|/* Clear the status register */
(brace
id|MIIM_CIS8204_ISTAT
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Disable interrupts */
(brace
id|MIIM_CIS8204_IMASK
comma
l_int|0x0
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* handle_int */
multiline_comment|/* Read the Status (2x to make sure link is right) */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Auto-negotiate */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
id|mii_parse_sr
)brace
comma
multiline_comment|/* Read the status */
(brace
id|MIIM_CIS8201_AUX_CONSTAT
comma
id|miim_read
comma
id|mii_parse_cis8201
)brace
comma
multiline_comment|/* Enable interrupts */
(brace
id|MIIM_CIS8204_IMASK
comma
id|MIIM_CIS8204_IMASK_MASK
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* shutdown */
multiline_comment|/* Clear the status register */
(brace
id|MIIM_CIS8204_ISTAT
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Disable interrupts */
(brace
id|MIIM_CIS8204_IMASK
comma
l_int|0x0
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* Cicada 8201 */
DECL|variable|phy_info_cis8201
r_static
r_struct
id|phy_info
id|phy_info_cis8201
op_assign
(brace
l_int|0xfc41
comma
l_string|&quot;CIS8201&quot;
comma
l_int|4
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* config */
multiline_comment|/* Override PHY config settings */
(brace
id|MIIM_CIS8201_AUX_CONSTAT
comma
id|MIIM_CIS8201_AUXCONSTAT_INIT
comma
l_int|NULL
)brace
comma
multiline_comment|/* Set up the interface mode */
(brace
id|MIIM_CIS8201_EXT_CON1
comma
id|MIIM_CIS8201_EXTCON1_INIT
comma
l_int|NULL
)brace
comma
multiline_comment|/* Configure some basic stuff */
(brace
id|MIIM_CONTROL
comma
id|MIIM_CONTROL_INIT
comma
id|mii_cr_init
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* startup */
multiline_comment|/* Read the Status (2x to make sure link is right) */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
l_int|NULL
)brace
comma
multiline_comment|/* Auto-negotiate */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
id|mii_parse_sr
)brace
comma
multiline_comment|/* Read the status */
(brace
id|MIIM_CIS8201_AUX_CONSTAT
comma
id|miim_read
comma
id|mii_parse_cis8201
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* ack_int */
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* handle_int */
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* shutdown */
(brace
id|miim_end
comma
)brace
)brace
comma
)brace
suffix:semicolon
DECL|variable|phy_info_dm9161
r_static
r_struct
id|phy_info
id|phy_info_dm9161
op_assign
(brace
l_int|0x0181b88
comma
l_string|&quot;Davicom DM9161E&quot;
comma
l_int|4
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* config */
(brace
id|MIIM_CONTROL
comma
id|MIIM_DM9161_CR_STOP
comma
l_int|NULL
)brace
comma
multiline_comment|/* Do not bypass the scrambler/descrambler */
(brace
id|MIIM_DM9161_SCR
comma
id|MIIM_DM9161_SCR_INIT
comma
l_int|NULL
)brace
comma
multiline_comment|/* Clear 10BTCSR to default */
(brace
id|MIIM_DM9161_10BTCSR
comma
id|MIIM_DM9161_10BTCSR_INIT
comma
l_int|NULL
)brace
comma
multiline_comment|/* Configure some basic stuff */
(brace
id|MIIM_CONTROL
comma
id|MIIM_CR_INIT
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* startup */
multiline_comment|/* Restart Auto Negotiation */
(brace
id|MIIM_CONTROL
comma
id|MIIM_DM9161_CR_RSTAN
comma
l_int|NULL
)brace
comma
multiline_comment|/* Status is read once to clear old link state */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
id|dm9161_wait
)brace
comma
multiline_comment|/* Auto-negotiate */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
id|mii_parse_sr
)brace
comma
multiline_comment|/* Read the status */
(brace
id|MIIM_DM9161_SCSR
comma
id|miim_read
comma
id|mii_parse_dm9161_scsr
)brace
comma
multiline_comment|/* Clear any pending interrupts */
(brace
id|MIIM_DM9161_INTR
comma
id|miim_read
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* ack_int */
(brace
id|MIIM_DM9161_INTR
comma
id|miim_read
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* handle_int */
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
l_int|NULL
)brace
comma
(brace
id|MIIM_STATUS
comma
id|miim_read
comma
id|mii_parse_sr
)brace
comma
(brace
id|MIIM_DM9161_SCSR
comma
id|miim_read
comma
id|mii_parse_dm9161_scsr
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
(paren
r_const
r_struct
id|phy_cmd
(braket
)braket
)paren
(brace
multiline_comment|/* shutdown */
(brace
id|MIIM_DM9161_INTR
comma
id|miim_read
comma
l_int|NULL
)brace
comma
(brace
id|miim_end
comma
)brace
)brace
comma
)brace
suffix:semicolon
DECL|variable|phy_info
r_static
r_struct
id|phy_info
op_star
id|phy_info
(braket
)braket
op_assign
(brace
op_amp
id|phy_info_cis8201
comma
op_amp
id|phy_info_cis8204
comma
op_amp
id|phy_info_M88E1011S
comma
op_amp
id|phy_info_dm9161
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Use the PHY ID registers to determine what type of PHY is attached&n; * to device dev.  return a struct phy_info structure describing that PHY&n; */
DECL|function|get_phy_info
r_struct
id|phy_info
op_star
id|get_phy_info
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|u16
id|phy_reg
suffix:semicolon
id|u32
id|phy_ID
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|phy_info
op_star
id|theInfo
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Grab the bits from PHYIR1, and put them in the upper half */
id|phy_reg
op_assign
id|read_phy_reg
c_func
(paren
id|dev
comma
id|MIIM_PHYIR1
)paren
suffix:semicolon
id|phy_ID
op_assign
(paren
id|phy_reg
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* Grab the bits from PHYIR2, and put them in the lower half */
id|phy_reg
op_assign
id|read_phy_reg
c_func
(paren
id|dev
comma
id|MIIM_PHYIR2
)paren
suffix:semicolon
id|phy_ID
op_or_assign
(paren
id|phy_reg
op_amp
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* loop through all the known PHY types, and find one that */
multiline_comment|/* matches the ID we read from the PHY. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|phy_info
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|phy_info
(braket
id|i
)braket
op_member_access_from_pointer
id|id
op_eq
(paren
id|phy_ID
op_rshift
id|phy_info
(braket
id|i
)braket
op_member_access_from_pointer
id|shift
)paren
)paren
id|theInfo
op_assign
id|phy_info
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|theInfo
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: PHY id %x is not supported!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy_ID
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: PHY is %s (%x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|theInfo-&gt;name
comma
id|phy_ID
)paren
suffix:semicolon
)brace
r_return
id|theInfo
suffix:semicolon
)brace
multiline_comment|/* Take a list of struct phy_cmd, and, depending on the values, either */
multiline_comment|/* read or write, using a helper function if provided */
multiline_comment|/* It is assumed that all lists of struct phy_cmd will be terminated by */
multiline_comment|/* mii_end. */
DECL|function|phy_run_commands
r_void
id|phy_run_commands
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_const
r_struct
id|phy_cmd
op_star
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|result
suffix:semicolon
r_struct
id|gfar_private
op_star
id|priv
op_assign
(paren
r_struct
id|gfar_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|gfar
op_star
id|phyregs
op_assign
id|priv-&gt;phyregs
suffix:semicolon
multiline_comment|/* Reset the management interface */
id|gfar_write
c_func
(paren
op_amp
id|phyregs-&gt;miimcfg
comma
id|MIIMCFG_RESET
)paren
suffix:semicolon
multiline_comment|/* Setup the MII Mgmt clock speed */
id|gfar_write
c_func
(paren
op_amp
id|phyregs-&gt;miimcfg
comma
id|MIIMCFG_INIT_VALUE
)paren
suffix:semicolon
multiline_comment|/* Wait until the bus is free */
r_while
c_loop
(paren
id|gfar_read
c_func
(paren
op_amp
id|phyregs-&gt;miimind
)paren
op_amp
id|MIIMIND_BUSY
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;mii_reg
op_ne
id|miim_end
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* The command is a read if mii_data is miim_read */
r_if
c_cond
(paren
id|cmd-&gt;mii_data
op_eq
id|miim_read
)paren
(brace
multiline_comment|/* Read the value of the PHY reg */
id|result
op_assign
id|read_phy_reg
c_func
(paren
id|dev
comma
id|cmd-&gt;mii_reg
)paren
suffix:semicolon
multiline_comment|/* If a function was supplied, we need to let it process */
multiline_comment|/* the result. */
r_if
c_cond
(paren
id|cmd-&gt;funct
op_ne
l_int|NULL
)paren
(paren
op_star
(paren
id|cmd-&gt;funct
)paren
)paren
(paren
id|result
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Otherwise, it&squot;s a write */
multiline_comment|/* If a function was supplied, it will provide &n;&t;&t;&t; * the value to write */
multiline_comment|/* Otherwise, the value was supplied in cmd-&gt;mii_data */
r_if
c_cond
(paren
id|cmd-&gt;funct
op_ne
l_int|NULL
)paren
id|result
op_assign
(paren
op_star
(paren
id|cmd-&gt;funct
)paren
)paren
(paren
l_int|0
comma
id|dev
)paren
suffix:semicolon
r_else
id|result
op_assign
id|cmd-&gt;mii_data
suffix:semicolon
multiline_comment|/* Write the appropriate value to the PHY reg */
id|write_phy_reg
c_func
(paren
id|dev
comma
id|cmd-&gt;mii_reg
comma
id|result
)paren
suffix:semicolon
)brace
id|cmd
op_increment
suffix:semicolon
)brace
)brace
eof
