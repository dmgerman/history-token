multiline_comment|/*&n; * sgiseeq.c: Seeq8003 ethernet driver for SGI machines.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/sgi/hpc3.h&gt;
macro_line|#include &lt;asm/sgi/ip22.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
macro_line|#include &quot;sgiseeq.h&quot;
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;sgiseeq.c: David S. Miller (dm@engr.sgi.com)&bslash;n&quot;
suffix:semicolon
DECL|variable|sgiseeqstr
r_static
r_char
op_star
id|sgiseeqstr
op_assign
l_string|&quot;SGI Seeq8003&quot;
suffix:semicolon
multiline_comment|/*&n; * If you want speed, you do something silly, it always has worked for me.  So,&n; * with that in mind, I&squot;ve decided to make this driver look completely like a&n; * stupid Lance from a driver architecture perspective.  Only difference is that&n; * here our &quot;ring buffer&quot; looks and acts like a real Lance one does but is&n; * layed out like how the HPC DMA and the Seeq want it to.  You&squot;d be surprised&n; * how a stupid idea like this can pay off in performance, not to mention&n; * making this driver 2,000 times easier to write. ;-)&n; */
multiline_comment|/* Tune these if we tend to run out often etc. */
DECL|macro|SEEQ_RX_BUFFERS
mdefine_line|#define SEEQ_RX_BUFFERS  16
DECL|macro|SEEQ_TX_BUFFERS
mdefine_line|#define SEEQ_TX_BUFFERS  16
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ       1584
DECL|macro|NEXT_RX
mdefine_line|#define NEXT_RX(i)  (((i) + 1) &amp; (SEEQ_RX_BUFFERS - 1))
DECL|macro|NEXT_TX
mdefine_line|#define NEXT_TX(i)  (((i) + 1) &amp; (SEEQ_TX_BUFFERS - 1))
DECL|macro|PREV_RX
mdefine_line|#define PREV_RX(i)  (((i) - 1) &amp; (SEEQ_RX_BUFFERS - 1))
DECL|macro|PREV_TX
mdefine_line|#define PREV_TX(i)  (((i) - 1) &amp; (SEEQ_TX_BUFFERS - 1))
DECL|macro|TX_BUFFS_AVAIL
mdefine_line|#define TX_BUFFS_AVAIL(sp) ((sp-&gt;tx_old &lt;= sp-&gt;tx_new) ? &bslash;&n;&t;&t;&t;    sp-&gt;tx_old + (SEEQ_TX_BUFFERS - 1) - sp-&gt;tx_new : &bslash;&n;&t;&t;&t;    sp-&gt;tx_old - sp-&gt;tx_new - 1)
DECL|macro|DEBUG
mdefine_line|#define DEBUG
DECL|struct|sgiseeq_rx_desc
r_struct
id|sgiseeq_rx_desc
(brace
DECL|member|rdma
r_volatile
r_struct
id|hpc_dma_desc
id|rdma
suffix:semicolon
DECL|member|buf_vaddr
r_volatile
r_int
r_int
id|buf_vaddr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sgiseeq_tx_desc
r_struct
id|sgiseeq_tx_desc
(brace
DECL|member|tdma
r_volatile
r_struct
id|hpc_dma_desc
id|tdma
suffix:semicolon
DECL|member|buf_vaddr
r_volatile
r_int
r_int
id|buf_vaddr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Warning: This structure is layed out in a certain way because HPC dma&n; *          descriptors must be 8-byte aligned.  So don&squot;t touch this without&n; *          some care.&n; */
DECL|struct|sgiseeq_init_block
r_struct
id|sgiseeq_init_block
(brace
multiline_comment|/* Note the name ;-) */
DECL|member|rxvector
r_struct
id|sgiseeq_rx_desc
id|rxvector
(braket
id|SEEQ_RX_BUFFERS
)braket
suffix:semicolon
DECL|member|txvector
r_struct
id|sgiseeq_tx_desc
id|txvector
(braket
id|SEEQ_TX_BUFFERS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sgiseeq_private
r_struct
id|sgiseeq_private
(brace
DECL|member|srings
r_struct
id|sgiseeq_init_block
op_star
id|srings
suffix:semicolon
multiline_comment|/* Ptrs to the descriptors in uncached space. */
DECL|member|rx_desc
r_struct
id|sgiseeq_rx_desc
op_star
id|rx_desc
suffix:semicolon
DECL|member|tx_desc
r_struct
id|sgiseeq_tx_desc
op_star
id|tx_desc
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|hregs
r_struct
id|hpc3_ethregs
op_star
id|hregs
suffix:semicolon
DECL|member|sregs
r_struct
id|sgiseeq_regs
op_star
id|sregs
suffix:semicolon
multiline_comment|/* Ring entry counters. */
DECL|member|rx_new
DECL|member|tx_new
r_int
r_int
id|rx_new
comma
id|tx_new
suffix:semicolon
DECL|member|rx_old
DECL|member|tx_old
r_int
r_int
id|rx_old
comma
id|tx_old
suffix:semicolon
DECL|member|is_edlc
r_int
id|is_edlc
suffix:semicolon
DECL|member|control
r_int
r_char
id|control
suffix:semicolon
DECL|member|mode
r_int
r_char
id|mode
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|next_module
r_struct
id|net_device
op_star
id|next_module
suffix:semicolon
DECL|member|tx_lock
id|spinlock_t
id|tx_lock
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* A list of all installed seeq devices, for removing the driver module. */
DECL|variable|root_sgiseeq_dev
r_static
r_struct
id|net_device
op_star
id|root_sgiseeq_dev
suffix:semicolon
DECL|function|hpc3_eth_reset
r_static
r_inline
r_void
id|hpc3_eth_reset
c_func
(paren
r_struct
id|hpc3_ethregs
op_star
id|hregs
)paren
(brace
id|hregs-&gt;rx_reset
op_assign
id|HPC3_ERXRST_CRESET
op_or
id|HPC3_ERXRST_CLRIRQ
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|hregs-&gt;rx_reset
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|reset_hpc3_and_seeq
r_static
r_inline
r_void
id|reset_hpc3_and_seeq
c_func
(paren
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
id|hregs-&gt;rx_ctrl
op_assign
id|hregs-&gt;tx_ctrl
op_assign
l_int|0
suffix:semicolon
id|hpc3_eth_reset
c_func
(paren
id|hregs
)paren
suffix:semicolon
)brace
DECL|macro|RSTAT_GO_BITS
mdefine_line|#define RSTAT_GO_BITS (SEEQ_RCMD_IGOOD | SEEQ_RCMD_IEOF | SEEQ_RCMD_ISHORT | &bslash;&n;&t;&t;       SEEQ_RCMD_IDRIB | SEEQ_RCMD_ICRC)
DECL|function|seeq_go
r_static
r_inline
r_void
id|seeq_go
c_func
(paren
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
id|sregs-&gt;rstat
op_assign
id|sp-&gt;mode
op_or
id|RSTAT_GO_BITS
suffix:semicolon
id|hregs-&gt;rx_ctrl
op_assign
id|HPC3_ERXCTRL_ACTIVE
suffix:semicolon
)brace
DECL|function|__sgiseeq_set_mac_address
r_static
r_inline
r_void
id|__sgiseeq_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sregs-&gt;tstat
op_assign
id|SEEQ_TCMD_RB0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|sregs-&gt;rw.eth_addr
(braket
id|i
)braket
op_assign
id|dev-&gt;dev_addr
(braket
id|i
)braket
suffix:semicolon
)brace
DECL|function|sgiseeq_set_mac_address
r_static
r_int
id|sgiseeq_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|sockaddr
op_star
id|sa
op_assign
id|addr
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|sa-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|sp-&gt;tx_lock
)paren
suffix:semicolon
id|__sgiseeq_set_mac_address
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|sp-&gt;tx_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|TCNTINFO_INIT
mdefine_line|#define TCNTINFO_INIT (HPCDMA_EOX | HPCDMA_ETXD)
DECL|macro|RCNTCFG_INIT
mdefine_line|#define RCNTCFG_INIT  (HPCDMA_OWN | HPCDMA_EORP | HPCDMA_XIE)
DECL|macro|RCNTINFO_INIT
mdefine_line|#define RCNTINFO_INIT (RCNTCFG_INIT | (PKT_BUF_SZ &amp; HPCDMA_BCNT))
DECL|function|seeq_init_ring
r_static
r_int
id|seeq_init_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|sp-&gt;rx_new
op_assign
id|sp-&gt;tx_new
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;rx_old
op_assign
id|sp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|__sgiseeq_set_mac_address
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Setup tx ring. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEEQ_TX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sp-&gt;tx_desc
(braket
id|i
)braket
dot
id|tdma.pbuf
)paren
(brace
r_int
r_int
id|buffer
suffix:semicolon
id|buffer
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|PKT_BUF_SZ
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sp-&gt;tx_desc
(braket
id|i
)braket
dot
id|buf_vaddr
op_assign
id|CKSEG1ADDR
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|sp-&gt;tx_desc
(braket
id|i
)braket
dot
id|tdma.pbuf
op_assign
id|CPHYSADDR
c_func
(paren
id|buffer
)paren
suffix:semicolon
)brace
id|sp-&gt;tx_desc
(braket
id|i
)braket
dot
id|tdma.cntinfo
op_assign
id|TCNTINFO_INIT
suffix:semicolon
)brace
multiline_comment|/* And now the rx ring. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEEQ_RX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sp-&gt;rx_desc
(braket
id|i
)braket
dot
id|rdma.pbuf
)paren
(brace
r_int
r_int
id|buffer
suffix:semicolon
id|buffer
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|PKT_BUF_SZ
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sp-&gt;rx_desc
(braket
id|i
)braket
dot
id|buf_vaddr
op_assign
id|CKSEG1ADDR
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|sp-&gt;rx_desc
(braket
id|i
)braket
dot
id|rdma.pbuf
op_assign
id|CPHYSADDR
c_func
(paren
id|buffer
)paren
suffix:semicolon
)brace
id|sp-&gt;rx_desc
(braket
id|i
)braket
dot
id|rdma.cntinfo
op_assign
id|RCNTINFO_INIT
suffix:semicolon
)brace
id|sp-&gt;rx_desc
(braket
id|i
op_minus
l_int|1
)braket
dot
id|rdma.cntinfo
op_or_assign
id|HPCDMA_EOR
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
DECL|variable|gpriv
r_static
r_struct
id|sgiseeq_private
op_star
id|gpriv
suffix:semicolon
DECL|variable|gdev
r_static
r_struct
id|net_device
op_star
id|gdev
suffix:semicolon
DECL|function|sgiseeq_dump_rings
r_void
id|sgiseeq_dump_rings
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|once
suffix:semicolon
r_struct
id|sgiseeq_rx_desc
op_star
id|r
op_assign
id|gpriv-&gt;rx_desc
suffix:semicolon
r_struct
id|sgiseeq_tx_desc
op_star
id|t
op_assign
id|gpriv-&gt;tx_desc
suffix:semicolon
r_struct
id|hpc3_ethregs
op_star
id|hregs
op_assign
id|gpriv-&gt;hregs
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|once
)paren
r_return
suffix:semicolon
id|once
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RING DUMP:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEEQ_RX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RX [%d]: @(%p) [%08x,%08x,%08x] &quot;
comma
id|i
comma
(paren
op_amp
id|r
(braket
id|i
)braket
)paren
comma
id|r
(braket
id|i
)braket
dot
id|rdma.pbuf
comma
id|r
(braket
id|i
)braket
dot
id|rdma.cntinfo
comma
id|r
(braket
id|i
)braket
dot
id|rdma.pnext
)paren
suffix:semicolon
id|i
op_add_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;-- [%d]: @(%p) [%08x,%08x,%08x]&bslash;n&quot;
comma
id|i
comma
(paren
op_amp
id|r
(braket
id|i
)braket
)paren
comma
id|r
(braket
id|i
)braket
dot
id|rdma.pbuf
comma
id|r
(braket
id|i
)braket
dot
id|rdma.cntinfo
comma
id|r
(braket
id|i
)braket
dot
id|rdma.pnext
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEEQ_TX_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TX [%d]: @(%p) [%08x,%08x,%08x] &quot;
comma
id|i
comma
(paren
op_amp
id|t
(braket
id|i
)braket
)paren
comma
id|t
(braket
id|i
)braket
dot
id|tdma.pbuf
comma
id|t
(braket
id|i
)braket
dot
id|tdma.cntinfo
comma
id|t
(braket
id|i
)braket
dot
id|tdma.pnext
)paren
suffix:semicolon
id|i
op_add_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;-- [%d]: @(%p) [%08x,%08x,%08x]&bslash;n&quot;
comma
id|i
comma
(paren
op_amp
id|t
(braket
id|i
)braket
)paren
comma
id|t
(braket
id|i
)braket
dot
id|tdma.pbuf
comma
id|t
(braket
id|i
)braket
dot
id|tdma.cntinfo
comma
id|t
(braket
id|i
)braket
dot
id|tdma.pnext
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;INFO: [rx_new = %d rx_old=%d] [tx_new = %d tx_old = %d]&bslash;n&quot;
comma
id|gpriv-&gt;rx_new
comma
id|gpriv-&gt;rx_old
comma
id|gpriv-&gt;tx_new
comma
id|gpriv-&gt;tx_old
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RREGS: rx_cbptr[%08x] rx_ndptr[%08x] rx_ctrl[%08x]&bslash;n&quot;
comma
id|hregs-&gt;rx_cbptr
comma
id|hregs-&gt;rx_ndptr
comma
id|hregs-&gt;rx_ctrl
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TREGS: tx_cbptr[%08x] tx_ndptr[%08x] tx_ctrl[%08x]&bslash;n&quot;
comma
id|hregs-&gt;tx_cbptr
comma
id|hregs-&gt;tx_ndptr
comma
id|hregs-&gt;tx_ctrl
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|TSTAT_INIT_SEEQ
mdefine_line|#define TSTAT_INIT_SEEQ (SEEQ_TCMD_IPT|SEEQ_TCMD_I16|SEEQ_TCMD_IC|SEEQ_TCMD_IUF)
DECL|macro|TSTAT_INIT_EDLC
mdefine_line|#define TSTAT_INIT_EDLC ((TSTAT_INIT_SEEQ) | SEEQ_TCMD_RB2)
DECL|macro|RDMACFG_INIT
mdefine_line|#define RDMACFG_INIT    (HPC3_ERXDCFG_FRXDC | HPC3_ERXDCFG_FEOP | HPC3_ERXDCFG_FIRQ)
DECL|function|init_seeq
r_static
r_int
id|init_seeq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_struct
id|hpc3_ethregs
op_star
id|hregs
op_assign
id|sp-&gt;hregs
suffix:semicolon
r_int
id|err
suffix:semicolon
id|reset_hpc3_and_seeq
c_func
(paren
id|hregs
comma
id|sregs
)paren
suffix:semicolon
id|err
op_assign
id|seeq_init_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Setup to field the proper interrupt types. */
r_if
c_cond
(paren
id|sp-&gt;is_edlc
)paren
(brace
id|sregs-&gt;tstat
op_assign
id|TSTAT_INIT_EDLC
suffix:semicolon
id|sregs-&gt;rw.wregs.control
op_assign
id|sp-&gt;control
suffix:semicolon
id|sregs-&gt;rw.wregs.frame_gap
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|sregs-&gt;tstat
op_assign
id|TSTAT_INIT_SEEQ
suffix:semicolon
)brace
id|hregs-&gt;rx_dconfig
op_or_assign
id|RDMACFG_INIT
suffix:semicolon
id|hregs-&gt;rx_ndptr
op_assign
id|CPHYSADDR
c_func
(paren
id|sp-&gt;rx_desc
)paren
suffix:semicolon
id|hregs-&gt;tx_ndptr
op_assign
id|CPHYSADDR
c_func
(paren
id|sp-&gt;tx_desc
)paren
suffix:semicolon
id|seeq_go
c_func
(paren
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|record_rx_errors
r_static
r_inline
r_void
id|record_rx_errors
c_func
(paren
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_int
r_char
id|status
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_RSTAT_OVERF
op_logical_or
id|status
op_amp
id|SEEQ_RSTAT_SFRAME
)paren
id|sp-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_RSTAT_CERROR
)paren
id|sp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_RSTAT_DERROR
)paren
id|sp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_RSTAT_REOF
)paren
id|sp-&gt;stats.rx_errors
op_increment
suffix:semicolon
)brace
DECL|function|rx_maybe_restart
r_static
r_inline
r_void
id|rx_maybe_restart
c_func
(paren
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hregs-&gt;rx_ctrl
op_amp
id|HPC3_ERXCTRL_ACTIVE
)paren
)paren
(brace
id|hregs-&gt;rx_ndptr
op_assign
id|CPHYSADDR
c_func
(paren
id|sp-&gt;rx_desc
op_plus
id|sp-&gt;rx_new
)paren
suffix:semicolon
id|seeq_go
c_func
(paren
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
)brace
)brace
DECL|macro|for_each_rx
mdefine_line|#define for_each_rx(rd, sp) for((rd) = &amp;(sp)-&gt;rx_desc[(sp)-&gt;rx_new]; &bslash;&n;&t;&t;&t;&t;!((rd)-&gt;rdma.cntinfo &amp; HPCDMA_OWN); &bslash;&n;&t;&t;&t;&t;(rd) = &amp;(sp)-&gt;rx_desc[(sp)-&gt;rx_new])
DECL|function|sgiseeq_rx
r_static
r_inline
r_void
id|sgiseeq_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_struct
id|sgiseeq_rx_desc
op_star
id|rd
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|pkt_status
suffix:semicolon
r_int
r_char
op_star
id|pkt_pointer
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|orig_end
op_assign
id|PREV_RX
c_func
(paren
id|sp-&gt;rx_new
)paren
suffix:semicolon
multiline_comment|/* Service every received packet. */
id|for_each_rx
c_func
(paren
id|rd
comma
id|sp
)paren
(brace
id|len
op_assign
id|PKT_BUF_SZ
op_minus
(paren
id|rd-&gt;rdma.cntinfo
op_amp
id|HPCDMA_BCNT
)paren
op_minus
l_int|3
suffix:semicolon
id|pkt_pointer
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
r_int
)paren
id|rd-&gt;buf_vaddr
suffix:semicolon
id|pkt_status
op_assign
id|pkt_pointer
(braket
id|len
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pkt_status
op_amp
id|SEEQ_RSTAT_FIG
)paren
(brace
multiline_comment|/* Packet is OK. */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Copy out of kseg1 to avoid silly cache flush. */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|pkt_pointer
op_plus
l_int|2
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want to receive our own packets */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth_hdr
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|h_source
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
)paren
(brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|sp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|sp-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Silently drop my own packets */
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sp-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|record_rx_errors
c_func
(paren
id|sp
comma
id|pkt_status
)paren
suffix:semicolon
)brace
multiline_comment|/* Return the entry to the ring pool. */
id|rd-&gt;rdma.cntinfo
op_assign
id|RCNTINFO_INIT
suffix:semicolon
id|sp-&gt;rx_new
op_assign
id|NEXT_RX
c_func
(paren
id|sp-&gt;rx_new
)paren
suffix:semicolon
)brace
id|sp-&gt;rx_desc
(braket
id|orig_end
)braket
dot
id|rdma.cntinfo
op_and_assign
op_complement
(paren
id|HPCDMA_EOR
)paren
suffix:semicolon
id|sp-&gt;rx_desc
(braket
id|PREV_RX
c_func
(paren
id|sp-&gt;rx_new
)paren
)braket
dot
id|rdma.cntinfo
op_or_assign
id|HPCDMA_EOR
suffix:semicolon
id|rx_maybe_restart
c_func
(paren
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
)brace
DECL|function|tx_maybe_reset_collisions
r_static
r_inline
r_void
id|tx_maybe_reset_collisions
c_func
(paren
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;is_edlc
)paren
(brace
id|sregs-&gt;rw.wregs.control
op_assign
id|sp-&gt;control
op_amp
op_complement
(paren
id|SEEQ_CTRL_XCNT
)paren
suffix:semicolon
id|sregs-&gt;rw.wregs.control
op_assign
id|sp-&gt;control
suffix:semicolon
)brace
)brace
DECL|function|kick_tx
r_static
r_inline
r_void
id|kick_tx
c_func
(paren
r_struct
id|sgiseeq_tx_desc
op_star
id|td
comma
r_struct
id|hpc3_ethregs
op_star
id|hregs
)paren
(brace
multiline_comment|/* If the HPC aint doin nothin, and there are more packets&n;&t; * with ETXD cleared and XIU set we must make very certain&n;&t; * that we restart the HPC else we risk locking up the&n;&t; * adapter.  The following code is only safe iff the HPCDMA&n;&t; * is not active!&n;&t; */
r_while
c_loop
(paren
(paren
id|td-&gt;tdma.cntinfo
op_amp
(paren
id|HPCDMA_XIU
op_or
id|HPCDMA_ETXD
)paren
)paren
op_eq
(paren
id|HPCDMA_XIU
op_or
id|HPCDMA_ETXD
)paren
)paren
id|td
op_assign
(paren
r_struct
id|sgiseeq_tx_desc
op_star
)paren
(paren
r_int
)paren
id|CKSEG1ADDR
c_func
(paren
id|td-&gt;tdma.pnext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;tdma.cntinfo
op_amp
id|HPCDMA_XIU
)paren
(brace
id|hregs-&gt;tx_ndptr
op_assign
id|CPHYSADDR
c_func
(paren
id|td
)paren
suffix:semicolon
id|hregs-&gt;tx_ctrl
op_assign
id|HPC3_ETXCTRL_ACTIVE
suffix:semicolon
)brace
)brace
DECL|function|sgiseeq_tx
r_static
r_inline
r_void
id|sgiseeq_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sgiseeq_private
op_star
id|sp
comma
r_struct
id|hpc3_ethregs
op_star
id|hregs
comma
r_struct
id|sgiseeq_regs
op_star
id|sregs
)paren
(brace
r_struct
id|sgiseeq_tx_desc
op_star
id|td
suffix:semicolon
r_int
r_int
id|status
op_assign
id|hregs-&gt;tx_ctrl
suffix:semicolon
r_int
id|j
suffix:semicolon
id|tx_maybe_reset_collisions
c_func
(paren
id|sp
comma
id|sregs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
(paren
id|HPC3_ETXCTRL_ACTIVE
op_or
id|SEEQ_TSTAT_PTRANS
)paren
)paren
)paren
(brace
multiline_comment|/* Oops, HPC detected some sort of error. */
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_TSTAT_R16
)paren
id|sp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_TSTAT_UFLOW
)paren
id|sp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SEEQ_TSTAT_LCLS
)paren
id|sp-&gt;stats.collisions
op_increment
suffix:semicolon
)brace
multiline_comment|/* Ack &squot;em... */
r_for
c_loop
(paren
id|j
op_assign
id|sp-&gt;tx_old
suffix:semicolon
id|j
op_ne
id|sp-&gt;tx_new
suffix:semicolon
id|j
op_assign
id|NEXT_TX
c_func
(paren
id|j
)paren
)paren
(brace
id|td
op_assign
op_amp
id|sp-&gt;tx_desc
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|td-&gt;tdma.cntinfo
op_amp
(paren
id|HPCDMA_XIU
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|td-&gt;tdma.cntinfo
op_amp
(paren
id|HPCDMA_ETXD
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|HPC3_ETXCTRL_ACTIVE
)paren
)paren
(brace
id|hregs-&gt;tx_ndptr
op_assign
id|CPHYSADDR
c_func
(paren
id|td
)paren
suffix:semicolon
id|hregs-&gt;tx_ctrl
op_assign
id|HPC3_ETXCTRL_ACTIVE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|sp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|sp-&gt;tx_old
op_assign
id|NEXT_TX
c_func
(paren
id|sp-&gt;tx_old
)paren
suffix:semicolon
id|td-&gt;tdma.cntinfo
op_and_assign
op_complement
(paren
id|HPCDMA_XIU
op_or
id|HPCDMA_XIE
)paren
suffix:semicolon
id|td-&gt;tdma.cntinfo
op_or_assign
id|HPCDMA_EOX
suffix:semicolon
)brace
)brace
DECL|function|sgiseeq_interrupt
r_static
id|irqreturn_t
id|sgiseeq_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|hpc3_ethregs
op_star
id|hregs
op_assign
id|sp-&gt;hregs
suffix:semicolon
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sp-&gt;tx_lock
)paren
suffix:semicolon
multiline_comment|/* Ack the IRQ and set software state. */
id|hregs-&gt;rx_reset
op_assign
id|HPC3_ERXRST_CLRIRQ
suffix:semicolon
multiline_comment|/* Always check for received packets. */
id|sgiseeq_rx
c_func
(paren
id|dev
comma
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
multiline_comment|/* Only check for tx acks if we have something queued. */
r_if
c_cond
(paren
id|sp-&gt;tx_old
op_ne
id|sp-&gt;tx_new
)paren
id|sgiseeq_tx
c_func
(paren
id|dev
comma
id|sp
comma
id|hregs
comma
id|sregs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|sp
)paren
OG
l_int|0
)paren
op_logical_and
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|sp-&gt;tx_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|sgiseeq_open
r_static
r_int
id|sgiseeq_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
r_int
r_int
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sgiseeq_interrupt
comma
l_int|0
comma
id|sgiseeqstr
comma
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Seeq8003: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|err
op_assign
id|init_seeq
c_func
(paren
id|dev
comma
id|sp
comma
id|sregs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_free_irq
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|irq
comma
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|sgiseeq_close
r_static
r_int
id|sgiseeq_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Shutdown the Seeq. */
id|reset_hpc3_and_seeq
c_func
(paren
id|sp-&gt;hregs
comma
id|sregs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sgiseeq_reset
r_static
r_inline
r_int
id|sgiseeq_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|sgiseeq_regs
op_star
id|sregs
op_assign
id|sp-&gt;sregs
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|init_seeq
c_func
(paren
id|dev
comma
id|sp
comma
id|sregs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sgiseeq_my_reset
r_void
id|sgiseeq_my_reset
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RESET!&bslash;n&quot;
)paren
suffix:semicolon
id|sgiseeq_reset
c_func
(paren
id|gdev
)paren
suffix:semicolon
)brace
DECL|function|sgiseeq_start_xmit
r_static
r_int
id|sgiseeq_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|hpc3_ethregs
op_star
id|hregs
op_assign
id|sp-&gt;hregs
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sgiseeq_tx_desc
op_star
id|td
suffix:semicolon
r_int
id|skblen
comma
id|len
comma
id|entry
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Setup... */
id|skblen
op_assign
id|skb-&gt;len
suffix:semicolon
id|len
op_assign
(paren
id|skblen
op_le
id|ETH_ZLEN
)paren
ques
c_cond
id|ETH_ZLEN
suffix:colon
id|skblen
suffix:semicolon
id|sp-&gt;stats.tx_bytes
op_add_assign
id|len
suffix:semicolon
id|entry
op_assign
id|sp-&gt;tx_new
suffix:semicolon
id|td
op_assign
op_amp
id|sp-&gt;tx_desc
(braket
id|entry
)braket
suffix:semicolon
multiline_comment|/* Create entry.  There are so many races with adding a new&n;&t; * descriptor to the chain:&n;&t; * 1) Assume that the HPC is off processing a DMA chain while&n;&t; *    we are changing all of the following.&n;&t; * 2) Do no allow the HPC to look at a new descriptor until&n;&t; *    we have completely set up it&squot;s state.  This means, do&n;&t; *    not clear HPCDMA_EOX in the current last descritptor&n;&t; *    until the one we are adding looks consistent and could&n;&t; *    be processes right now.&n;&t; * 3) The tx interrupt code must notice when we&squot;ve added a new&n;&t; *    entry and the HPC got to the end of the chain before we&n;&t; *    added this new entry and restarted it.&n;&t; */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
r_int
)paren
id|td-&gt;buf_vaddr
comma
id|skb-&gt;data
comma
id|skblen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|skblen
)paren
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
(paren
r_int
)paren
id|td-&gt;buf_vaddr
op_plus
id|skb-&gt;len
comma
l_int|0
comma
id|len
op_minus
id|skblen
)paren
suffix:semicolon
id|td-&gt;tdma.cntinfo
op_assign
(paren
id|len
op_amp
id|HPCDMA_BCNT
)paren
op_or
id|HPCDMA_XIU
op_or
id|HPCDMA_EOXP
op_or
id|HPCDMA_XIE
op_or
id|HPCDMA_EOX
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;tx_old
op_ne
id|sp-&gt;tx_new
)paren
(brace
r_struct
id|sgiseeq_tx_desc
op_star
id|backend
suffix:semicolon
id|backend
op_assign
op_amp
id|sp-&gt;tx_desc
(braket
id|PREV_TX
c_func
(paren
id|sp-&gt;tx_new
)paren
)braket
suffix:semicolon
id|backend-&gt;tdma.cntinfo
op_and_assign
op_complement
id|HPCDMA_EOX
suffix:semicolon
)brace
id|sp-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|sp-&gt;tx_new
)paren
suffix:semicolon
multiline_comment|/* Advance. */
multiline_comment|/* Maybe kick the HPC back into motion. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|hregs-&gt;tx_ctrl
op_amp
id|HPC3_ETXCTRL_ACTIVE
)paren
)paren
id|kick_tx
c_func
(paren
op_amp
id|sp-&gt;tx_desc
(braket
id|sp-&gt;tx_old
)braket
comma
id|hregs
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|TX_BUFFS_AVAIL
c_func
(paren
id|sp
)paren
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|timeout
r_static
r_void
id|timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|sgiseeq_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|sgiseeq_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|sgiseeq_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_amp
id|sp-&gt;stats
suffix:semicolon
)brace
DECL|function|sgiseeq_set_multicast
r_static
r_void
id|sgiseeq_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sgiseeq_private
op_star
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|oldmode
op_assign
id|sp-&gt;mode
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|sp-&gt;mode
op_assign
id|SEEQ_RCMD_RANY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
id|dev-&gt;mc_count
)paren
id|sp-&gt;mode
op_assign
id|SEEQ_RCMD_RBMCAST
suffix:semicolon
r_else
id|sp-&gt;mode
op_assign
id|SEEQ_RCMD_RBCAST
suffix:semicolon
multiline_comment|/* XXX I know this sucks, but is there a better way to reprogram&n;&t; * XXX the receiver? At least, this shouldn&squot;t happen too often.&n;&t; */
r_if
c_cond
(paren
id|oldmode
op_ne
id|sp-&gt;mode
)paren
id|sgiseeq_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|setup_tx_ring
r_static
r_inline
r_void
id|setup_tx_ring
c_func
(paren
r_struct
id|sgiseeq_tx_desc
op_star
id|buf
comma
r_int
id|nbufs
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
(paren
id|nbufs
op_minus
l_int|1
)paren
)paren
(brace
id|buf
(braket
id|i
)braket
dot
id|tdma.pnext
op_assign
id|CPHYSADDR
c_func
(paren
id|buf
op_plus
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|buf
(braket
id|i
)braket
dot
id|tdma.pbuf
op_assign
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|buf
(braket
id|i
)braket
dot
id|tdma.pnext
op_assign
id|CPHYSADDR
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|function|setup_rx_ring
r_static
r_inline
r_void
id|setup_rx_ring
c_func
(paren
r_struct
id|sgiseeq_rx_desc
op_star
id|buf
comma
r_int
id|nbufs
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
(paren
id|nbufs
op_minus
l_int|1
)paren
)paren
(brace
id|buf
(braket
id|i
)braket
dot
id|rdma.pnext
op_assign
id|CPHYSADDR
c_func
(paren
id|buf
op_plus
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|buf
(braket
id|i
)braket
dot
id|rdma.pbuf
op_assign
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|buf
(braket
id|i
)braket
dot
id|rdma.pbuf
op_assign
l_int|0
suffix:semicolon
id|buf
(braket
id|i
)braket
dot
id|rdma.pnext
op_assign
id|CPHYSADDR
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|macro|ALIGNED
mdefine_line|#define ALIGNED(x)  ((((unsigned long)(x)) + 0xf) &amp; ~(0xf))
DECL|function|sgiseeq_init
r_static
r_int
id|sgiseeq_init
c_func
(paren
r_struct
id|hpc3_regs
op_star
id|regs
comma
r_int
id|irq
)paren
(brace
r_struct
id|sgiseeq_init_block
op_star
id|sr
suffix:semicolon
r_struct
id|sgiseeq_private
op_star
id|sp
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|sgiseeq_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Sgiseeq: Etherdev alloc failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|sp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Make private data page aligned */
id|sr
op_assign
(paren
r_struct
id|sgiseeq_init_block
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Sgiseeq: Page alloc failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_free_dev
suffix:semicolon
)brace
id|sp-&gt;srings
op_assign
id|sr
suffix:semicolon
DECL|macro|EADDR_NVOFS
mdefine_line|#define EADDR_NVOFS     250
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|tmp
op_assign
id|ip22_nvram_read
c_func
(paren
id|EADDR_NVOFS
op_div
l_int|2
op_plus
id|i
)paren
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
op_star
id|i
)braket
op_assign
id|tmp
op_rshift
l_int|8
suffix:semicolon
id|dev-&gt;dev_addr
(braket
l_int|2
op_star
id|i
op_plus
l_int|1
)braket
op_assign
id|tmp
op_amp
l_int|0xff
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|gpriv
op_assign
id|sp
suffix:semicolon
id|gdev
op_assign
id|dev
suffix:semicolon
macro_line|#endif
id|sp-&gt;sregs
op_assign
(paren
r_struct
id|sgiseeq_regs
op_star
)paren
op_amp
id|hpc3c0-&gt;eth_ext
(braket
l_int|0
)braket
suffix:semicolon
id|sp-&gt;hregs
op_assign
op_amp
id|hpc3c0-&gt;ethregs
suffix:semicolon
id|sp-&gt;name
op_assign
id|sgiseeqstr
suffix:semicolon
id|sp-&gt;mode
op_assign
id|SEEQ_RCMD_RBCAST
suffix:semicolon
id|sp-&gt;rx_desc
op_assign
(paren
r_struct
id|sgiseeq_rx_desc
op_star
)paren
id|CKSEG1ADDR
c_func
(paren
id|ALIGNED
c_func
(paren
op_amp
id|sp-&gt;srings-&gt;rxvector
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|sp-&gt;srings-&gt;rxvector
comma
r_sizeof
(paren
id|sp-&gt;srings-&gt;rxvector
)paren
)paren
suffix:semicolon
id|sp-&gt;tx_desc
op_assign
(paren
r_struct
id|sgiseeq_tx_desc
op_star
)paren
id|CKSEG1ADDR
c_func
(paren
id|ALIGNED
c_func
(paren
op_amp
id|sp-&gt;srings-&gt;txvector
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|sp-&gt;srings-&gt;txvector
comma
r_sizeof
(paren
id|sp-&gt;srings-&gt;txvector
)paren
)paren
suffix:semicolon
multiline_comment|/* A couple calculations now, saves many cycles later. */
id|setup_rx_ring
c_func
(paren
id|sp-&gt;rx_desc
comma
id|SEEQ_RX_BUFFERS
)paren
suffix:semicolon
id|setup_tx_ring
c_func
(paren
id|sp-&gt;tx_desc
comma
id|SEEQ_TX_BUFFERS
)paren
suffix:semicolon
multiline_comment|/* Reset the chip. */
id|hpc3_eth_reset
c_func
(paren
id|sp-&gt;hregs
)paren
suffix:semicolon
id|sp-&gt;is_edlc
op_assign
op_logical_neg
(paren
id|sp-&gt;sregs-&gt;rw.rregs.collision_tx
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;is_edlc
)paren
id|sp-&gt;control
op_assign
id|SEEQ_CTRL_XCNT
op_or
id|SEEQ_CTRL_ACCNT
op_or
id|SEEQ_CTRL_SFLAG
op_or
id|SEEQ_CTRL_ESHORT
op_or
id|SEEQ_CTRL_ENCARR
suffix:semicolon
id|dev-&gt;open
op_assign
id|sgiseeq_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|sgiseeq_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|sgiseeq_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
(paren
l_int|200
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|sgiseeq_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|sgiseeq_set_multicast
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|sgiseeq_set_mac_address
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Sgiseeq: Cannot register net device, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_free_page
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: SGI Seeq8003 &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot;&bslash;n&squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|sp-&gt;next_module
op_assign
id|root_sgiseeq_dev
suffix:semicolon
id|root_sgiseeq_dev
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_free_page
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|sp
)paren
suffix:semicolon
id|err_out_free_dev
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|sgiseeq_probe
r_static
r_int
id|__init
id|sgiseeq_probe
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
multiline_comment|/* On board adapter on 1st HPC is always present */
r_return
id|sgiseeq_init
c_func
(paren
id|hpc3c0
comma
id|SGI_ENET_IRQ
)paren
suffix:semicolon
)brace
DECL|function|sgiseeq_exit
r_static
r_void
id|__exit
id|sgiseeq_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|next
comma
op_star
id|dev
suffix:semicolon
r_struct
id|sgiseeq_private
op_star
id|sp
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|root_sgiseeq_dev
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|next
)paren
(brace
id|sp
op_assign
(paren
r_struct
id|sgiseeq_private
op_star
)paren
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|next
op_assign
id|sp-&gt;next_module
suffix:semicolon
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
id|dev
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|sp
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|variable|sgiseeq_probe
id|module_init
c_func
(paren
id|sgiseeq_probe
)paren
suffix:semicolon
DECL|variable|sgiseeq_exit
id|module_exit
c_func
(paren
id|sgiseeq_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
