multiline_comment|/* typhoon.c: A Linux Ethernet device driver for 3Com 3CR990 family of NICs */
multiline_comment|/*&n;&t;Written 2002-2004 by David Dillow &lt;dave@thedillows.org&gt;&n;&t;Based on code written 1998-2000 by Donald Becker &lt;becker@scyld.com&gt; and&n;&t;Linux 2.2.x driver by David P. McLean &lt;davidpmclean@yahoo.com&gt;.&n;&n;&t;This software may be used and distributed according to the terms of&n;&t;the GNU General Public License (GPL), incorporated herein by reference.&n;&t;Drivers based on or derived from this code fall under the GPL and must&n;&t;retain the authorship, copyright and license notice.  This file is not&n;&t;a complete program and may only be used when the entire operating&n;&t;system is licensed under the GPL.&n;&n;&t;This software is available on a public web site. It may enable&n;&t;cryptographic capabilities of the 3Com hardware, and may be&n;&t;exported from the United States under License Exception &quot;TSU&quot;&n;&t;pursuant to 15 C.F.R. Section 740.13(e).&n;&n;&t;This work was funded by the National Library of Medicine under&n;&t;the Department of Energy project number 0274DD06D1 and NLM project&n;&t;number Y1-LM-2015-01.&n;&n;&t;This driver is designed for the 3Com 3CR990 Family of cards with the&n;&t;3XP Processor. It has been tested on x86 and sparc64.&n;&n;&t;KNOWN ISSUES:&n;&t;*) The current firmware always strips the VLAN tag off, even if&n;&t;&t;we tell it not to. You should filter VLANs at the switch&n;&t;&t;as a workaround (good practice in any event) until we can&n;&t;&t;get this fixed.&n;&t;*) Cannot DMA Rx packets to a 2 byte aligned address. Also firmware&n;&t;&t;issue. Hopefully 3Com will fix it.&n;&t;*) Waiting for a command response takes 8ms due to non-preemptable&n;&t;&t;polling. Only significant for getting stats and creating&n;&t;&t;SAs, but an ugly wart never the less.&n;&n;&t;TODO:&n;&t;*) Doesn&squot;t do IPSEC offloading. Yet. Keep yer pants on, it&squot;s coming.&n;&t;*) Add more support for ethtool (especially for NIC stats)&n;&t;*) Allow disabling of RX checksum offloading&n;&t;*) Fix MAC changing to work while the interface is up&n;&t;&t;(Need to put commands on the TX ring, which changes&n;&t;&t;the locking)&n;&t;*) Add in FCS to {rx,tx}_bytes, since the hardware doesn&squot;t. See&n;&t;&t;http://oss.sgi.com/cgi-bin/mesg.cgi?a=netdev&amp;i=20031215152211.7003fe8e.rddunlap%40osdl.org&n;*/
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-frames scheme.&n; * Setting to &gt; 1518 effectively disables this feature.&n; */
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
op_assign
l_int|200
suffix:semicolon
multiline_comment|/* end user-configurable values */
multiline_comment|/* Maximum number of multicast addresses to filter (vs. rx-all-multicast).&n; */
DECL|variable|multicast_filter_limit
r_static
r_const
r_int
id|multicast_filter_limit
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Operational parameters that are set at compile time. */
multiline_comment|/* Keep the ring sizes a power of two for compile efficiency.&n; * The compiler will convert &lt;unsigned&gt;&squot;%&squot;&lt;2^N&gt; into a bit mask.&n; * Making the Tx ring too large decreases the effectiveness of channel&n; * bonding and packet priority.&n; * There are no ill effects from too-large receive rings.&n; *&n; * We don&squot;t currently use the Hi Tx ring so, don&squot;t make it very big.&n; *&n; * Beware that if we start using the Hi Tx ring, we will need to change&n; * typhoon_num_free_tx() and typhoon_tx_complete() to account for that.&n; */
DECL|macro|TXHI_ENTRIES
mdefine_line|#define TXHI_ENTRIES&t;&t;2
DECL|macro|TXLO_ENTRIES
mdefine_line|#define TXLO_ENTRIES&t;&t;128
DECL|macro|RX_ENTRIES
mdefine_line|#define RX_ENTRIES&t;&t;32
DECL|macro|COMMAND_ENTRIES
mdefine_line|#define COMMAND_ENTRIES&t;&t;16
DECL|macro|RESPONSE_ENTRIES
mdefine_line|#define RESPONSE_ENTRIES&t;32
DECL|macro|COMMAND_RING_SIZE
mdefine_line|#define COMMAND_RING_SIZE&t;(COMMAND_ENTRIES * sizeof(struct cmd_desc))
DECL|macro|RESPONSE_RING_SIZE
mdefine_line|#define RESPONSE_RING_SIZE&t;(RESPONSE_ENTRIES * sizeof(struct resp_desc))
multiline_comment|/* The 3XP will preload and remove 64 entries from the free buffer&n; * list, and we need one entry to keep the ring from wrapping, so &n; * to keep this a power of two, we use 128 entries.&n; */
DECL|macro|RXFREE_ENTRIES
mdefine_line|#define RXFREE_ENTRIES&t;&t;128
DECL|macro|RXENT_ENTRIES
mdefine_line|#define RXENT_ENTRIES&t;&t;(RXFREE_ENTRIES - 1)
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT  (2*HZ)
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;&t;1536
DECL|macro|DRV_MODULE_NAME
mdefine_line|#define DRV_MODULE_NAME&t;&t;&quot;typhoon&quot;
DECL|macro|DRV_MODULE_VERSION
mdefine_line|#define DRV_MODULE_VERSION &t;&quot;1.5.4&quot;
DECL|macro|DRV_MODULE_RELDATE
mdefine_line|#define DRV_MODULE_RELDATE&t;&quot;04/09/09&quot;
DECL|macro|PFX
mdefine_line|#define PFX&t;&t;&t;DRV_MODULE_NAME &quot;: &quot;
DECL|macro|ERR_PFX
mdefine_line|#define ERR_PFX&t;&t;&t;KERN_ERR PFX
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/if_vlan.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &quot;typhoon.h&quot;
macro_line|#include &quot;typhoon-firmware.h&quot;
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;typhoon.c: version &quot;
id|DRV_MODULE_VERSION
l_string|&quot; (&quot;
id|DRV_MODULE_RELDATE
l_string|&quot;)&bslash;n&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David Dillow &lt;dave@thedillows.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;3Com Typhoon Family (3C990, 3CR990, and variants)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#if defined(NETIF_F_TSO) &amp;&amp; MAX_SKB_FRAGS &gt; 32
macro_line|#warning Typhoon only supports 32 entries in its SG list for TSO, disabling TSO
DECL|macro|NETIF_F_TSO
macro_line|#undef NETIF_F_TSO
macro_line|#endif
macro_line|#if TXLO_ENTRIES &lt;= (2 * MAX_SKB_FRAGS)
macro_line|#error TX ring too small!
macro_line|#endif
DECL|struct|typhoon_card_info
r_struct
id|typhoon_card_info
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|capabilities
r_int
id|capabilities
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|TYPHOON_CRYPTO_NONE
mdefine_line|#define TYPHOON_CRYPTO_NONE&t;&t;0x00
DECL|macro|TYPHOON_CRYPTO_DES
mdefine_line|#define TYPHOON_CRYPTO_DES&t;&t;0x01
DECL|macro|TYPHOON_CRYPTO_3DES
mdefine_line|#define TYPHOON_CRYPTO_3DES&t;&t;0x02
DECL|macro|TYPHOON_CRYPTO_VARIABLE
mdefine_line|#define&t;TYPHOON_CRYPTO_VARIABLE&t;&t;0x04
DECL|macro|TYPHOON_FIBER
mdefine_line|#define TYPHOON_FIBER&t;&t;&t;0x08
DECL|macro|TYPHOON_WAKEUP_NEEDS_RESET
mdefine_line|#define TYPHOON_WAKEUP_NEEDS_RESET&t;0x10
DECL|enum|typhoon_cards
r_enum
id|typhoon_cards
(brace
DECL|enumerator|TYPHOON_TX
DECL|enumerator|TYPHOON_TX95
DECL|enumerator|TYPHOON_TX97
DECL|enumerator|TYPHOON_SVR
id|TYPHOON_TX
op_assign
l_int|0
comma
id|TYPHOON_TX95
comma
id|TYPHOON_TX97
comma
id|TYPHOON_SVR
comma
DECL|enumerator|TYPHOON_SVR95
DECL|enumerator|TYPHOON_SVR97
DECL|enumerator|TYPHOON_TXM
DECL|enumerator|TYPHOON_BSVR
id|TYPHOON_SVR95
comma
id|TYPHOON_SVR97
comma
id|TYPHOON_TXM
comma
id|TYPHOON_BSVR
comma
DECL|enumerator|TYPHOON_FX95
DECL|enumerator|TYPHOON_FX97
DECL|enumerator|TYPHOON_FX95SVR
DECL|enumerator|TYPHOON_FX97SVR
id|TYPHOON_FX95
comma
id|TYPHOON_FX97
comma
id|TYPHOON_FX95SVR
comma
id|TYPHOON_FX97SVR
comma
DECL|enumerator|TYPHOON_FXM
id|TYPHOON_FXM
comma
)brace
suffix:semicolon
multiline_comment|/* directly indexed by enum typhoon_cards, above */
DECL|variable|__devinitdata
r_static
r_struct
id|typhoon_card_info
id|typhoon_card_info
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;3Com Typhoon (3C990-TX)&quot;
comma
id|TYPHOON_CRYPTO_NONE
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3CR990-TX-95)&quot;
comma
id|TYPHOON_CRYPTO_DES
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3CR990-TX-97)&quot;
comma
id|TYPHOON_CRYPTO_DES
op_or
id|TYPHOON_CRYPTO_3DES
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3C990SVR)&quot;
comma
id|TYPHOON_CRYPTO_NONE
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3CR990SVR95)&quot;
comma
id|TYPHOON_CRYPTO_DES
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3CR990SVR97)&quot;
comma
id|TYPHOON_CRYPTO_DES
op_or
id|TYPHOON_CRYPTO_3DES
)brace
comma
(brace
l_string|&quot;3Com Typhoon2 (3C990B-TX-M)&quot;
comma
id|TYPHOON_CRYPTO_VARIABLE
)brace
comma
(brace
l_string|&quot;3Com Typhoon2 (3C990BSVR)&quot;
comma
id|TYPHOON_CRYPTO_VARIABLE
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3CR990-FX-95)&quot;
comma
id|TYPHOON_CRYPTO_DES
op_or
id|TYPHOON_FIBER
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3CR990-FX-97)&quot;
comma
id|TYPHOON_CRYPTO_DES
op_or
id|TYPHOON_CRYPTO_3DES
op_or
id|TYPHOON_FIBER
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3CR990-FX-95 Server)&quot;
comma
id|TYPHOON_CRYPTO_DES
op_or
id|TYPHOON_FIBER
)brace
comma
(brace
l_string|&quot;3Com Typhoon (3CR990-FX-97 Server)&quot;
comma
id|TYPHOON_CRYPTO_DES
op_or
id|TYPHOON_CRYPTO_3DES
op_or
id|TYPHOON_FIBER
)brace
comma
(brace
l_string|&quot;3Com Typhoon2 (3C990B-FX-97)&quot;
comma
id|TYPHOON_CRYPTO_VARIABLE
op_or
id|TYPHOON_FIBER
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* Notes on the new subsystem numbering scheme:&n; * bits 0-1 indicate crypto capabilites: (0) variable, (1) DES, or (2) 3DES&n; * bit 4 indicates if this card has secured firmware (we don&squot;t support it)&n; * bit 8 indicates if this is a (0) copper or (1) fiber card&n; * bits 12-16 indicate card type: (0) client and (1) server&n; */
DECL|variable|typhoon_pci_tbl
r_static
r_struct
id|pci_device_id
id|typhoon_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_TX
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990_TX_95
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_TX95
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990_TX_97
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_TX97
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990B
comma
id|PCI_ANY_ID
comma
l_int|0x1000
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_TXM
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990B
comma
id|PCI_ANY_ID
comma
l_int|0x1102
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_FXM
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990B
comma
id|PCI_ANY_ID
comma
l_int|0x2000
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_BSVR
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990_FX
comma
id|PCI_ANY_ID
comma
l_int|0x1101
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_FX95
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990_FX
comma
id|PCI_ANY_ID
comma
l_int|0x1102
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_FX97
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990_FX
comma
id|PCI_ANY_ID
comma
l_int|0x2101
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_FX95SVR
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990_FX
comma
id|PCI_ANY_ID
comma
l_int|0x2102
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_FX97SVR
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990SVR95
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_SVR95
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990SVR97
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_SVR97
)brace
comma
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3CR990SVR
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TYPHOON_SVR
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|typhoon_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* Define the shared memory area&n; * Align everything the 3XP will normally be using.&n; * We&squot;ll need to move/align txHi if we start using that ring.&n; */
DECL|macro|__3xp_aligned
mdefine_line|#define __3xp_aligned&t;____cacheline_aligned
DECL|struct|typhoon_shared
r_struct
id|typhoon_shared
(brace
DECL|member|iface
r_struct
id|typhoon_interface
id|iface
suffix:semicolon
DECL|member|__3xp_aligned
r_struct
id|typhoon_indexes
id|indexes
id|__3xp_aligned
suffix:semicolon
DECL|member|__3xp_aligned
r_struct
id|tx_desc
id|txLo
(braket
id|TXLO_ENTRIES
)braket
id|__3xp_aligned
suffix:semicolon
DECL|member|__3xp_aligned
r_struct
id|rx_desc
id|rxLo
(braket
id|RX_ENTRIES
)braket
id|__3xp_aligned
suffix:semicolon
DECL|member|__3xp_aligned
r_struct
id|rx_desc
id|rxHi
(braket
id|RX_ENTRIES
)braket
id|__3xp_aligned
suffix:semicolon
DECL|member|__3xp_aligned
r_struct
id|cmd_desc
id|cmd
(braket
id|COMMAND_ENTRIES
)braket
id|__3xp_aligned
suffix:semicolon
DECL|member|__3xp_aligned
r_struct
id|resp_desc
id|resp
(braket
id|RESPONSE_ENTRIES
)braket
id|__3xp_aligned
suffix:semicolon
DECL|member|__3xp_aligned
r_struct
id|rx_free
id|rxBuff
(braket
id|RXFREE_ENTRIES
)braket
id|__3xp_aligned
suffix:semicolon
DECL|member|zeroWord
id|u32
id|zeroWord
suffix:semicolon
DECL|member|txHi
r_struct
id|tx_desc
id|txHi
(braket
id|TXHI_ENTRIES
)braket
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|rxbuff_ent
r_struct
id|rxbuff_ent
(brace
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|member|dma_addr
id|dma_addr_t
id|dma_addr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|typhoon
r_struct
id|typhoon
(brace
multiline_comment|/* Tx cache line section */
DECL|member|____cacheline_aligned
r_struct
id|transmit_ring
id|txLoRing
id|____cacheline_aligned
suffix:semicolon
DECL|member|tx_pdev
r_struct
id|pci_dev
op_star
id|tx_pdev
suffix:semicolon
DECL|member|tx_ioaddr
r_void
id|__iomem
op_star
id|tx_ioaddr
suffix:semicolon
DECL|member|txlo_dma_addr
id|u32
id|txlo_dma_addr
suffix:semicolon
multiline_comment|/* Irq/Rx cache line section */
DECL|member|____cacheline_aligned
r_void
id|__iomem
op_star
id|ioaddr
id|____cacheline_aligned
suffix:semicolon
DECL|member|indexes
r_struct
id|typhoon_indexes
op_star
id|indexes
suffix:semicolon
DECL|member|awaiting_resp
id|u8
id|awaiting_resp
suffix:semicolon
DECL|member|duplex
id|u8
id|duplex
suffix:semicolon
DECL|member|speed
id|u8
id|speed
suffix:semicolon
DECL|member|card_state
id|u8
id|card_state
suffix:semicolon
DECL|member|rxLoRing
r_struct
id|basic_ring
id|rxLoRing
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
DECL|member|state_lock
id|spinlock_t
id|state_lock
suffix:semicolon
DECL|member|vlgrp
r_struct
id|vlan_group
op_star
id|vlgrp
suffix:semicolon
DECL|member|rxHiRing
r_struct
id|basic_ring
id|rxHiRing
suffix:semicolon
DECL|member|rxBuffRing
r_struct
id|basic_ring
id|rxBuffRing
suffix:semicolon
DECL|member|rxbuffers
r_struct
id|rxbuff_ent
id|rxbuffers
(braket
id|RXENT_ENTRIES
)braket
suffix:semicolon
multiline_comment|/* general section */
DECL|member|____cacheline_aligned
id|spinlock_t
id|command_lock
id|____cacheline_aligned
suffix:semicolon
DECL|member|cmdRing
r_struct
id|basic_ring
id|cmdRing
suffix:semicolon
DECL|member|respRing
r_struct
id|basic_ring
id|respRing
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|stats_saved
r_struct
id|net_device_stats
id|stats_saved
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|shared
r_struct
id|typhoon_shared
op_star
id|shared
suffix:semicolon
DECL|member|shared_dma
id|dma_addr_t
id|shared_dma
suffix:semicolon
DECL|member|xcvr_select
id|u16
id|xcvr_select
suffix:semicolon
DECL|member|wol_events
id|u16
id|wol_events
suffix:semicolon
DECL|member|offload
id|u32
id|offload
suffix:semicolon
multiline_comment|/* unused stuff (future use) */
DECL|member|capabilities
r_int
id|capabilities
suffix:semicolon
DECL|member|txHiRing
r_struct
id|transmit_ring
id|txHiRing
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|completion_wait_values
r_enum
id|completion_wait_values
(brace
DECL|enumerator|NoWait
DECL|enumerator|WaitNoSleep
DECL|enumerator|WaitSleep
id|NoWait
op_assign
l_int|0
comma
id|WaitNoSleep
comma
id|WaitSleep
comma
)brace
suffix:semicolon
multiline_comment|/* These are the values for the typhoon.card_state variable.&n; * These determine where the statistics will come from in get_stats().&n; * The sleep image does not support the statistics we need.&n; */
DECL|enum|state_values
r_enum
id|state_values
(brace
DECL|enumerator|Sleeping
DECL|enumerator|Running
id|Sleeping
op_assign
l_int|0
comma
id|Running
comma
)brace
suffix:semicolon
multiline_comment|/* PCI writes are not guaranteed to be posted in order, but outstanding writes&n; * cannot pass a read, so this forces current writes to post.&n; */
DECL|macro|typhoon_post_pci_writes
mdefine_line|#define typhoon_post_pci_writes(x) &bslash;&n;&t;do { readl(x + TYPHOON_REG_HEARTBEAT); } while(0)
multiline_comment|/* We&squot;ll wait up to six seconds for a reset, and half a second normally.&n; */
DECL|macro|TYPHOON_UDELAY
mdefine_line|#define TYPHOON_UDELAY&t;&t;&t;50
DECL|macro|TYPHOON_RESET_TIMEOUT_SLEEP
mdefine_line|#define TYPHOON_RESET_TIMEOUT_SLEEP&t;(6 * HZ)
DECL|macro|TYPHOON_RESET_TIMEOUT_NOSLEEP
mdefine_line|#define TYPHOON_RESET_TIMEOUT_NOSLEEP&t;((6 * 1000000) / TYPHOON_UDELAY)
DECL|macro|TYPHOON_WAIT_TIMEOUT
mdefine_line|#define TYPHOON_WAIT_TIMEOUT&t;&t;((1000000 / 2) / TYPHOON_UDELAY)
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2, 5, 28)
DECL|macro|typhoon_synchronize_irq
mdefine_line|#define typhoon_synchronize_irq(x) synchronize_irq()
macro_line|#else
DECL|macro|typhoon_synchronize_irq
mdefine_line|#define typhoon_synchronize_irq(x) synchronize_irq(x)
macro_line|#endif
macro_line|#if defined(NETIF_F_TSO)
DECL|macro|skb_tso_size
mdefine_line|#define skb_tso_size(x)&t;&t;(skb_shinfo(x)-&gt;tso_size)
DECL|macro|TSO_NUM_DESCRIPTORS
mdefine_line|#define TSO_NUM_DESCRIPTORS&t;2
DECL|macro|TSO_OFFLOAD_ON
mdefine_line|#define TSO_OFFLOAD_ON&t;&t;TYPHOON_OFFLOAD_TCP_SEGMENT
macro_line|#else
DECL|macro|NETIF_F_TSO
mdefine_line|#define NETIF_F_TSO &t;&t;0
DECL|macro|skb_tso_size
mdefine_line|#define skb_tso_size(x) &t;0
DECL|macro|TSO_NUM_DESCRIPTORS
mdefine_line|#define TSO_NUM_DESCRIPTORS&t;0
DECL|macro|TSO_OFFLOAD_ON
mdefine_line|#define TSO_OFFLOAD_ON&t;&t;0
macro_line|#endif
r_static
r_inline
r_void
DECL|function|typhoon_inc_index
id|typhoon_inc_index
c_func
(paren
id|u32
op_star
id|index
comma
r_const
r_int
id|count
comma
r_const
r_int
id|num_entries
)paren
(brace
multiline_comment|/* Increment a ring index -- we can use this for all rings execept&n;&t; * the Rx rings, as they use different size descriptors&n;&t; * otherwise, everything is the same size as a cmd_desc&n;&t; */
op_star
id|index
op_add_assign
id|count
op_star
r_sizeof
(paren
r_struct
id|cmd_desc
)paren
suffix:semicolon
op_star
id|index
op_mod_assign
id|num_entries
op_star
r_sizeof
(paren
r_struct
id|cmd_desc
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|typhoon_inc_cmd_index
id|typhoon_inc_cmd_index
c_func
(paren
id|u32
op_star
id|index
comma
r_const
r_int
id|count
)paren
(brace
id|typhoon_inc_index
c_func
(paren
id|index
comma
id|count
comma
id|COMMAND_ENTRIES
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|typhoon_inc_resp_index
id|typhoon_inc_resp_index
c_func
(paren
id|u32
op_star
id|index
comma
r_const
r_int
id|count
)paren
(brace
id|typhoon_inc_index
c_func
(paren
id|index
comma
id|count
comma
id|RESPONSE_ENTRIES
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|typhoon_inc_rxfree_index
id|typhoon_inc_rxfree_index
c_func
(paren
id|u32
op_star
id|index
comma
r_const
r_int
id|count
)paren
(brace
id|typhoon_inc_index
c_func
(paren
id|index
comma
id|count
comma
id|RXFREE_ENTRIES
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|typhoon_inc_tx_index
id|typhoon_inc_tx_index
c_func
(paren
id|u32
op_star
id|index
comma
r_const
r_int
id|count
)paren
(brace
multiline_comment|/* if we start using the Hi Tx ring, this needs updateing */
id|typhoon_inc_index
c_func
(paren
id|index
comma
id|count
comma
id|TXLO_ENTRIES
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|typhoon_inc_rx_index
id|typhoon_inc_rx_index
c_func
(paren
id|u32
op_star
id|index
comma
r_const
r_int
id|count
)paren
(brace
multiline_comment|/* sizeof(struct rx_desc) != sizeof(struct cmd_desc) */
op_star
id|index
op_add_assign
id|count
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
op_star
id|index
op_mod_assign
id|RX_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_reset
id|typhoon_reset
c_func
(paren
r_void
id|__iomem
op_star
id|ioaddr
comma
r_int
id|wait_type
)paren
(brace
r_int
id|i
comma
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|wait_type
op_eq
id|WaitNoSleep
)paren
(brace
id|timeout
op_assign
id|TYPHOON_RESET_TIMEOUT_NOSLEEP
suffix:semicolon
)brace
r_else
id|timeout
op_assign
id|TYPHOON_RESET_TIMEOUT_SLEEP
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_INTR_ALL
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_MASK
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_INTR_ALL
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_STATUS
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_RESET_ALL
comma
id|ioaddr
op_plus
id|TYPHOON_REG_SOFT_RESET
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_RESET_NONE
comma
id|ioaddr
op_plus
id|TYPHOON_REG_SOFT_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_type
op_ne
id|NoWait
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_STATUS
)paren
op_eq
id|TYPHOON_STATUS_WAITING_FOR_HOST
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wait_type
op_eq
id|WaitSleep
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|udelay
c_func
(paren
id|TYPHOON_UDELAY
)paren
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|out
suffix:colon
id|writel
c_func
(paren
id|TYPHOON_INTR_ALL
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_MASK
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_INTR_ALL
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_STATUS
)paren
suffix:semicolon
multiline_comment|/* The 3XP seems to need a little extra time to complete the load&n;&t; * of the sleep image before we can reliably boot it. Failure to&n;&t; * do this occasionally results in a hung adapter after boot in&n;&t; * typhoon_init_one() while trying to read the MAC address or&n;&t; * putting the card to sleep. 3Com&squot;s driver waits 5ms, but&n;&t; * that seems to be overkill. However, if we can sleep, we might&n;&t; * as well give it that much time. Otherwise, we&squot;ll give it 500us,&n;&t; * which should be enough (I&squot;ve see it work well at 100us, but still&n;&t; * saw occasional problems.)&n;&t; */
r_if
c_cond
(paren
id|wait_type
op_eq
id|WaitSleep
)paren
(brace
id|msleep
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_else
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_wait_status
id|typhoon_wait_status
c_func
(paren
r_void
id|__iomem
op_star
id|ioaddr
comma
id|u32
id|wait_value
)paren
(brace
r_int
id|i
comma
id|err
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TYPHOON_WAIT_TIMEOUT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_STATUS
)paren
op_eq
id|wait_value
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|udelay
c_func
(paren
id|TYPHOON_UDELAY
)paren
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|typhoon_media_status
id|typhoon_media_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|resp_desc
op_star
id|resp
)paren
(brace
r_if
c_cond
(paren
id|resp-&gt;parm1
op_amp
id|TYPHOON_MEDIA_STAT_NO_LINK
)paren
(brace
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|typhoon_hello
id|typhoon_hello
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
r_struct
id|basic_ring
op_star
id|ring
op_assign
op_amp
id|tp-&gt;cmdRing
suffix:semicolon
r_struct
id|cmd_desc
op_star
id|cmd
suffix:semicolon
multiline_comment|/* We only get a hello request if we&squot;ve not sent anything to the&n;&t; * card in a long while. If the lock is held, then we&squot;re in the&n;&t; * process of issuing a command, so we don&squot;t need to respond.&n;&t; */
r_if
c_cond
(paren
id|spin_trylock
c_func
(paren
op_amp
id|tp-&gt;command_lock
)paren
)paren
(brace
id|cmd
op_assign
(paren
r_struct
id|cmd_desc
op_star
)paren
(paren
id|ring-&gt;ringBase
op_plus
id|ring-&gt;lastWrite
)paren
suffix:semicolon
id|typhoon_inc_cmd_index
c_func
(paren
op_amp
id|ring-&gt;lastWrite
comma
l_int|1
)paren
suffix:semicolon
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
id|cmd
comma
id|TYPHOON_CMD_HELLO_RESP
)paren
suffix:semicolon
id|smp_wmb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ring-&gt;lastWrite
comma
id|tp-&gt;ioaddr
op_plus
id|TYPHOON_REG_CMD_READY
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tp-&gt;command_lock
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|typhoon_process_response
id|typhoon_process_response
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
r_int
id|resp_size
comma
r_struct
id|resp_desc
op_star
id|resp_save
)paren
(brace
r_struct
id|typhoon_indexes
op_star
id|indexes
op_assign
id|tp-&gt;indexes
suffix:semicolon
r_struct
id|resp_desc
op_star
id|resp
suffix:semicolon
id|u8
op_star
id|base
op_assign
id|tp-&gt;respRing.ringBase
suffix:semicolon
r_int
id|count
comma
id|len
comma
id|wrap_len
suffix:semicolon
id|u32
id|cleared
suffix:semicolon
id|u32
id|ready
suffix:semicolon
id|cleared
op_assign
id|le32_to_cpu
c_func
(paren
id|indexes-&gt;respCleared
)paren
suffix:semicolon
id|ready
op_assign
id|le32_to_cpu
c_func
(paren
id|indexes-&gt;respReady
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cleared
op_ne
id|ready
)paren
(brace
id|resp
op_assign
(paren
r_struct
id|resp_desc
op_star
)paren
(paren
id|base
op_plus
id|cleared
)paren
suffix:semicolon
id|count
op_assign
id|resp-&gt;numDesc
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|resp_save
op_logical_and
id|resp-&gt;seqNo
)paren
(brace
r_if
c_cond
(paren
id|count
OG
id|resp_size
)paren
(brace
id|resp_save-&gt;flags
op_assign
id|TYPHOON_RESP_ERROR
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|wrap_len
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|count
op_star
r_sizeof
(paren
op_star
id|resp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|cleared
op_plus
id|len
OG
id|RESPONSE_RING_SIZE
)paren
)paren
(brace
id|wrap_len
op_assign
id|cleared
op_plus
id|len
op_minus
id|RESPONSE_RING_SIZE
suffix:semicolon
id|len
op_assign
id|RESPONSE_RING_SIZE
op_minus
id|cleared
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|resp_save
comma
id|resp
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|wrap_len
)paren
)paren
(brace
id|resp_save
op_add_assign
id|len
op_div
r_sizeof
(paren
op_star
id|resp
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|resp_save
comma
id|base
comma
id|wrap_len
)paren
suffix:semicolon
)brace
id|resp_save
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|resp-&gt;cmd
op_eq
id|TYPHOON_CMD_READ_MEDIA_STATUS
)paren
(brace
id|typhoon_media_status
c_func
(paren
id|tp-&gt;dev
comma
id|resp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|resp-&gt;cmd
op_eq
id|TYPHOON_CMD_HELLO_RESP
)paren
(brace
id|typhoon_hello
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: dumping unexpected response &quot;
l_string|&quot;0x%04x:%d:0x%02x:0x%04x:%08x:%08x&bslash;n&quot;
comma
id|tp-&gt;name
comma
id|le16_to_cpu
c_func
(paren
id|resp-&gt;cmd
)paren
comma
id|resp-&gt;numDesc
comma
id|resp-&gt;flags
comma
id|le16_to_cpu
c_func
(paren
id|resp-&gt;parm1
)paren
comma
id|le32_to_cpu
c_func
(paren
id|resp-&gt;parm2
)paren
comma
id|le32_to_cpu
c_func
(paren
id|resp-&gt;parm3
)paren
)paren
suffix:semicolon
)brace
id|cleanup
suffix:colon
id|typhoon_inc_resp_index
c_func
(paren
op_amp
id|cleared
comma
id|count
)paren
suffix:semicolon
)brace
id|indexes-&gt;respCleared
op_assign
id|cpu_to_le32
c_func
(paren
id|cleared
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|resp_save
op_eq
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|typhoon_num_free
id|typhoon_num_free
c_func
(paren
r_int
id|lastWrite
comma
r_int
id|lastRead
comma
r_int
id|ringSize
)paren
(brace
multiline_comment|/* this works for all descriptors but rx_desc, as they are a&n;&t; * different size than the cmd_desc -- everyone else is the same&n;&t; */
id|lastWrite
op_div_assign
r_sizeof
(paren
r_struct
id|cmd_desc
)paren
suffix:semicolon
id|lastRead
op_div_assign
r_sizeof
(paren
r_struct
id|cmd_desc
)paren
suffix:semicolon
r_return
(paren
id|ringSize
op_plus
id|lastRead
op_minus
id|lastWrite
op_minus
l_int|1
)paren
op_mod
id|ringSize
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|typhoon_num_free_cmd
id|typhoon_num_free_cmd
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
r_int
id|lastWrite
op_assign
id|tp-&gt;cmdRing.lastWrite
suffix:semicolon
r_int
id|cmdCleared
op_assign
id|le32_to_cpu
c_func
(paren
id|tp-&gt;indexes-&gt;cmdCleared
)paren
suffix:semicolon
r_return
id|typhoon_num_free
c_func
(paren
id|lastWrite
comma
id|cmdCleared
comma
id|COMMAND_ENTRIES
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|typhoon_num_free_resp
id|typhoon_num_free_resp
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
r_int
id|respReady
op_assign
id|le32_to_cpu
c_func
(paren
id|tp-&gt;indexes-&gt;respReady
)paren
suffix:semicolon
r_int
id|respCleared
op_assign
id|le32_to_cpu
c_func
(paren
id|tp-&gt;indexes-&gt;respCleared
)paren
suffix:semicolon
r_return
id|typhoon_num_free
c_func
(paren
id|respReady
comma
id|respCleared
comma
id|RESPONSE_ENTRIES
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|typhoon_num_free_tx
id|typhoon_num_free_tx
c_func
(paren
r_struct
id|transmit_ring
op_star
id|ring
)paren
(brace
multiline_comment|/* if we start using the Hi Tx ring, this needs updating */
r_return
id|typhoon_num_free
c_func
(paren
id|ring-&gt;lastWrite
comma
id|ring-&gt;lastRead
comma
id|TXLO_ENTRIES
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_issue_command
id|typhoon_issue_command
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
r_int
id|num_cmd
comma
r_struct
id|cmd_desc
op_star
id|cmd
comma
r_int
id|num_resp
comma
r_struct
id|resp_desc
op_star
id|resp
)paren
(brace
r_struct
id|typhoon_indexes
op_star
id|indexes
op_assign
id|tp-&gt;indexes
suffix:semicolon
r_struct
id|basic_ring
op_star
id|ring
op_assign
op_amp
id|tp-&gt;cmdRing
suffix:semicolon
r_struct
id|resp_desc
id|local_resp
suffix:semicolon
r_int
id|i
comma
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|got_resp
suffix:semicolon
r_int
id|freeCmd
comma
id|freeResp
suffix:semicolon
r_int
id|len
comma
id|wrap_len
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|tp-&gt;command_lock
)paren
suffix:semicolon
id|freeCmd
op_assign
id|typhoon_num_free_cmd
c_func
(paren
id|tp
)paren
suffix:semicolon
id|freeResp
op_assign
id|typhoon_num_free_resp
c_func
(paren
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freeCmd
OL
id|num_cmd
op_logical_or
id|freeResp
OL
id|num_resp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: no descs for cmd, had (needed) %d (%d) cmd, &quot;
l_string|&quot;%d (%d) resp&bslash;n&quot;
comma
id|tp-&gt;name
comma
id|freeCmd
comma
id|num_cmd
comma
id|freeResp
comma
id|num_resp
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd-&gt;flags
op_amp
id|TYPHOON_CMD_RESPOND
)paren
(brace
multiline_comment|/* If we&squot;re expecting a response, but the caller hasn&squot;t given&n;&t;&t; * us a place to put it, we&squot;ll provide one.&n;&t;&t; */
id|tp-&gt;awaiting_resp
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|resp
op_eq
l_int|NULL
)paren
(brace
id|resp
op_assign
op_amp
id|local_resp
suffix:semicolon
id|num_resp
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|wrap_len
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|num_cmd
op_star
r_sizeof
(paren
op_star
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ring-&gt;lastWrite
op_plus
id|len
OG
id|COMMAND_RING_SIZE
)paren
)paren
(brace
id|wrap_len
op_assign
id|ring-&gt;lastWrite
op_plus
id|len
op_minus
id|COMMAND_RING_SIZE
suffix:semicolon
id|len
op_assign
id|COMMAND_RING_SIZE
op_minus
id|ring-&gt;lastWrite
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ring-&gt;ringBase
op_plus
id|ring-&gt;lastWrite
comma
id|cmd
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|wrap_len
)paren
)paren
(brace
r_struct
id|cmd_desc
op_star
id|wrap_ptr
op_assign
id|cmd
suffix:semicolon
id|wrap_ptr
op_add_assign
id|len
op_div
r_sizeof
(paren
op_star
id|cmd
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ring-&gt;ringBase
comma
id|wrap_ptr
comma
id|wrap_len
)paren
suffix:semicolon
)brace
id|typhoon_inc_cmd_index
c_func
(paren
op_amp
id|ring-&gt;lastWrite
comma
id|num_cmd
)paren
suffix:semicolon
multiline_comment|/* &quot;I feel a presence... another warrior is on the the mesa.&quot;&n;&t; */
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ring-&gt;lastWrite
comma
id|tp-&gt;ioaddr
op_plus
id|TYPHOON_REG_CMD_READY
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|tp-&gt;ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd-&gt;flags
op_amp
id|TYPHOON_CMD_RESPOND
)paren
op_eq
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Ugh. We&squot;ll be here about 8ms, spinning our thumbs, unable to&n;&t; * preempt or do anything other than take interrupts. So, don&squot;t&n;&t; * wait for a response unless you have to.&n;&t; *&n;&t; * I&squot;ve thought about trying to sleep here, but we&squot;re called&n;&t; * from many contexts that don&squot;t allow that. Also, given the way&n;&t; * 3Com has implemented irq coalescing, we would likely timeout --&n;&t; * this has been observed in real life!&n;&t; *&n;&t; * The big killer is we have to wait to get stats from the card,&n;&t; * though we could go to a periodic refresh of those if we don&squot;t&n;&t; * mind them getting somewhat stale. The rest of the waiting&n;&t; * commands occur during open/close/suspend/resume, so they aren&squot;t&n;&t; * time critical. Creating SAs in the future will also have to&n;&t; * wait here.&n;&t; */
id|got_resp
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TYPHOON_WAIT_TIMEOUT
op_logical_and
op_logical_neg
id|got_resp
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|indexes-&gt;respCleared
op_ne
id|indexes-&gt;respReady
)paren
(brace
id|got_resp
op_assign
id|typhoon_process_response
c_func
(paren
id|tp
comma
id|num_resp
comma
id|resp
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
id|TYPHOON_UDELAY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|got_resp
)paren
(brace
id|err
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Collect the error response even if we don&squot;t care about the&n;&t; * rest of the response&n;&t; */
r_if
c_cond
(paren
id|resp-&gt;flags
op_amp
id|TYPHOON_RESP_ERROR
)paren
(brace
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|tp-&gt;awaiting_resp
)paren
(brace
id|tp-&gt;awaiting_resp
op_assign
l_int|0
suffix:semicolon
id|smp_wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Ugh. If a response was added to the ring between&n;&t;&t; * the call to typhoon_process_response() and the clearing&n;&t;&t; * of tp-&gt;awaiting_resp, we could have missed the interrupt&n;&t;&t; * and it could hang in the ring an indeterminate amount of&n;&t;&t; * time. So, check for it, and interrupt ourselves if this&n;&t;&t; * is the case.&n;&t;&t; */
r_if
c_cond
(paren
id|indexes-&gt;respCleared
op_ne
id|indexes-&gt;respReady
)paren
(brace
id|writel
c_func
(paren
l_int|1
comma
id|tp-&gt;ioaddr
op_plus
id|TYPHOON_REG_SELF_INTERRUPT
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|tp-&gt;command_lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_vlan_rx_register
id|typhoon_vlan_rx_register
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|vlan_group
op_star
id|grp
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
r_int
id|err
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;vlgrp
op_ne
op_logical_neg
id|grp
)paren
(brace
multiline_comment|/* We&squot;ve either been turned on for the first time, or we&squot;ve&n;&t;&t; * been turned off. Update the 3XP.&n;&t;&t; */
r_if
c_cond
(paren
id|grp
)paren
(brace
id|tp-&gt;offload
op_or_assign
id|TYPHOON_OFFLOAD_VLAN
suffix:semicolon
)brace
r_else
id|tp-&gt;offload
op_and_assign
op_complement
id|TYPHOON_OFFLOAD_VLAN
suffix:semicolon
multiline_comment|/* If the interface is up, the runtime is running -- and we&n;&t;&t; * must be up for the vlan core to call us.&n;&t;&t; *&n;&t;&t; * Do the command outside of the spin lock, as it is slow.&n;&t;&t; */
id|INIT_COMMAND_WITH_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_SET_OFFLOAD_TASKS
)paren
suffix:semicolon
id|xp_cmd.parm2
op_assign
id|tp-&gt;offload
suffix:semicolon
id|xp_cmd.parm3
op_assign
id|tp-&gt;offload
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: vlan offload error %d&bslash;n&quot;
comma
id|tp-&gt;name
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* now make the change visible */
id|tp-&gt;vlgrp
op_assign
id|grp
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_vlan_rx_kill_vid
id|typhoon_vlan_rx_kill_vid
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|vid
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;vlgrp
)paren
(brace
id|tp-&gt;vlgrp-&gt;vlan_devices
(braket
id|vid
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|typhoon_tso_fill
id|typhoon_tso_fill
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|transmit_ring
op_star
id|txRing
comma
id|u32
id|ring_dma
)paren
(brace
r_struct
id|tcpopt_desc
op_star
id|tcpd
suffix:semicolon
id|u32
id|tcpd_offset
op_assign
id|ring_dma
suffix:semicolon
id|tcpd
op_assign
(paren
r_struct
id|tcpopt_desc
op_star
)paren
(paren
id|txRing-&gt;ringBase
op_plus
id|txRing-&gt;lastWrite
)paren
suffix:semicolon
id|tcpd_offset
op_add_assign
id|txRing-&gt;lastWrite
suffix:semicolon
id|tcpd_offset
op_add_assign
m_offsetof
(paren
r_struct
id|tcpopt_desc
comma
id|bytesTx
)paren
suffix:semicolon
id|typhoon_inc_tx_index
c_func
(paren
op_amp
id|txRing-&gt;lastWrite
comma
l_int|1
)paren
suffix:semicolon
id|tcpd-&gt;flags
op_assign
id|TYPHOON_OPT_DESC
op_or
id|TYPHOON_OPT_TCP_SEG
suffix:semicolon
id|tcpd-&gt;numDesc
op_assign
l_int|1
suffix:semicolon
id|tcpd-&gt;mss_flags
op_assign
id|cpu_to_le16
c_func
(paren
id|skb_tso_size
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|tcpd-&gt;mss_flags
op_or_assign
id|TYPHOON_TSO_FIRST
op_or
id|TYPHOON_TSO_LAST
suffix:semicolon
id|tcpd-&gt;respAddrLo
op_assign
id|cpu_to_le32
c_func
(paren
id|tcpd_offset
)paren
suffix:semicolon
id|tcpd-&gt;bytesTx
op_assign
id|cpu_to_le32
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|tcpd-&gt;status
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_start_tx
id|typhoon_start_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|transmit_ring
op_star
id|txRing
suffix:semicolon
r_struct
id|tx_desc
op_star
id|txd
comma
op_star
id|first_txd
suffix:semicolon
id|dma_addr_t
id|skb_dma
suffix:semicolon
r_int
id|numDesc
suffix:semicolon
multiline_comment|/* we have two rings to choose from, but we only use txLo for now&n;&t; * If we start using the Hi ring as well, we&squot;ll need to update&n;&t; * typhoon_stop_runtime(), typhoon_interrupt(), typhoon_num_free_tx(),&n;&t; * and TXHI_ENTIRES to match, as well as update the TSO code below&n;&t; * to get the right DMA address&n;&t; */
id|txRing
op_assign
op_amp
id|tp-&gt;txLoRing
suffix:semicolon
multiline_comment|/* We need one descriptor for each fragment of the sk_buff, plus the&n;&t; * one for the -&gt;data area of it.&n;&t; *&n;&t; * The docs say a maximum of 16 fragment descriptors per TCP option&n;&t; * descriptor, then make a new packet descriptor and option descriptor&n;&t; * for the next 16 fragments. The engineers say just an option&n;&t; * descriptor is needed. I&squot;ve tested up to 26 fragments with a single&n;&t; * packet descriptor/option descriptor combo, so I use that for now.&n;&t; *&n;&t; * If problems develop with TSO, check this first.&n;&t; */
id|numDesc
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|skb_tso_size
c_func
(paren
id|skb
)paren
)paren
(brace
id|numDesc
op_increment
suffix:semicolon
)brace
multiline_comment|/* When checking for free space in the ring, we need to also&n;&t; * account for the initial Tx descriptor, and we always must leave&n;&t; * at least one descriptor unused in the ring so that it doesn&squot;t&n;&t; * wrap and look empty.&n;&t; *&n;&t; * The only time we should loop here is when we hit the race&n;&t; * between marking the queue awake and updating the cleared index.&n;&t; * Just loop and it will appear. This comes from the acenic driver.&n;&t; */
r_while
c_loop
(paren
id|unlikely
c_func
(paren
id|typhoon_num_free_tx
c_func
(paren
id|txRing
)paren
OL
(paren
id|numDesc
op_plus
l_int|2
)paren
)paren
)paren
(brace
id|smp_rmb
c_func
(paren
)paren
suffix:semicolon
)brace
id|first_txd
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
(paren
id|txRing-&gt;ringBase
op_plus
id|txRing-&gt;lastWrite
)paren
suffix:semicolon
id|typhoon_inc_tx_index
c_func
(paren
op_amp
id|txRing-&gt;lastWrite
comma
l_int|1
)paren
suffix:semicolon
id|first_txd-&gt;flags
op_assign
id|TYPHOON_TX_DESC
op_or
id|TYPHOON_DESC_VALID
suffix:semicolon
id|first_txd-&gt;numDesc
op_assign
l_int|0
suffix:semicolon
id|first_txd-&gt;len
op_assign
l_int|0
suffix:semicolon
id|first_txd-&gt;addr
op_assign
(paren
id|u64
)paren
(paren
(paren
r_int
r_int
)paren
id|skb
)paren
op_amp
l_int|0xffffffff
suffix:semicolon
id|first_txd-&gt;addrHi
op_assign
(paren
id|u64
)paren
(paren
(paren
r_int
r_int
)paren
id|skb
)paren
op_rshift
l_int|32
suffix:semicolon
id|first_txd-&gt;processFlags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
(brace
multiline_comment|/* The 3XP will figure out if this is UDP/TCP */
id|first_txd-&gt;processFlags
op_or_assign
id|TYPHOON_TX_PF_TCP_CHKSUM
suffix:semicolon
id|first_txd-&gt;processFlags
op_or_assign
id|TYPHOON_TX_PF_UDP_CHKSUM
suffix:semicolon
id|first_txd-&gt;processFlags
op_or_assign
id|TYPHOON_TX_PF_IP_CHKSUM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vlan_tx_tag_present
c_func
(paren
id|skb
)paren
)paren
(brace
id|first_txd-&gt;processFlags
op_or_assign
id|TYPHOON_TX_PF_INSERT_VLAN
op_or
id|TYPHOON_TX_PF_VLAN_PRIORITY
suffix:semicolon
id|first_txd-&gt;processFlags
op_or_assign
id|cpu_to_le32
c_func
(paren
id|htons
c_func
(paren
id|vlan_tx_tag_get
c_func
(paren
id|skb
)paren
)paren
op_lshift
id|TYPHOON_TX_PF_VLAN_TAG_SHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_tso_size
c_func
(paren
id|skb
)paren
)paren
(brace
id|first_txd-&gt;processFlags
op_or_assign
id|TYPHOON_TX_PF_TCP_SEGMENT
suffix:semicolon
id|first_txd-&gt;numDesc
op_increment
suffix:semicolon
id|typhoon_tso_fill
c_func
(paren
id|skb
comma
id|txRing
comma
id|tp-&gt;txlo_dma_addr
)paren
suffix:semicolon
)brace
id|txd
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
(paren
id|txRing-&gt;ringBase
op_plus
id|txRing-&gt;lastWrite
)paren
suffix:semicolon
id|typhoon_inc_tx_index
c_func
(paren
op_amp
id|txRing-&gt;lastWrite
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* No need to worry about padding packet -- the firmware pads&n;&t; * it with zeros to ETH_ZLEN for us.&n;&t; */
r_if
c_cond
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
op_eq
l_int|0
)paren
(brace
id|skb_dma
op_assign
id|pci_map_single
c_func
(paren
id|tp-&gt;tx_pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|txd-&gt;flags
op_assign
id|TYPHOON_FRAG_DESC
op_or
id|TYPHOON_DESC_VALID
suffix:semicolon
id|txd-&gt;len
op_assign
id|cpu_to_le16
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|txd-&gt;addr
op_assign
id|cpu_to_le32
c_func
(paren
id|skb_dma
)paren
suffix:semicolon
id|txd-&gt;addrHi
op_assign
l_int|0
suffix:semicolon
id|first_txd-&gt;numDesc
op_increment
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
comma
id|len
suffix:semicolon
id|len
op_assign
id|skb_headlen
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb_dma
op_assign
id|pci_map_single
c_func
(paren
id|tp-&gt;tx_pdev
comma
id|skb-&gt;data
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|txd-&gt;flags
op_assign
id|TYPHOON_FRAG_DESC
op_or
id|TYPHOON_DESC_VALID
suffix:semicolon
id|txd-&gt;len
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
id|txd-&gt;addr
op_assign
id|cpu_to_le32
c_func
(paren
id|skb_dma
)paren
suffix:semicolon
id|txd-&gt;addrHi
op_assign
l_int|0
suffix:semicolon
id|first_txd-&gt;numDesc
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb_frag_t
op_star
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|i
)braket
suffix:semicolon
r_void
op_star
id|frag_addr
suffix:semicolon
id|txd
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
(paren
id|txRing-&gt;ringBase
op_plus
id|txRing-&gt;lastWrite
)paren
suffix:semicolon
id|typhoon_inc_tx_index
c_func
(paren
op_amp
id|txRing-&gt;lastWrite
comma
l_int|1
)paren
suffix:semicolon
id|len
op_assign
id|frag-&gt;size
suffix:semicolon
id|frag_addr
op_assign
(paren
r_void
op_star
)paren
id|page_address
c_func
(paren
id|frag-&gt;page
)paren
op_plus
id|frag-&gt;page_offset
suffix:semicolon
id|skb_dma
op_assign
id|pci_map_single
c_func
(paren
id|tp-&gt;tx_pdev
comma
id|frag_addr
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|txd-&gt;flags
op_assign
id|TYPHOON_FRAG_DESC
op_or
id|TYPHOON_DESC_VALID
suffix:semicolon
id|txd-&gt;len
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
id|txd-&gt;addr
op_assign
id|cpu_to_le32
c_func
(paren
id|skb_dma
)paren
suffix:semicolon
id|txd-&gt;addrHi
op_assign
l_int|0
suffix:semicolon
id|first_txd-&gt;numDesc
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Kick the 3XP&n;&t; */
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|txRing-&gt;lastWrite
comma
id|tp-&gt;tx_ioaddr
op_plus
id|txRing-&gt;writeRegister
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* If we don&squot;t have room to put the worst case packet on the&n;&t; * queue, then we must stop the queue. We need 2 extra&n;&t; * descriptors -- one to prevent ring wrap, and one for the&n;&t; * Tx header.&n;&t; */
id|numDesc
op_assign
id|MAX_SKB_FRAGS
op_plus
id|TSO_NUM_DESCRIPTORS
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_num_free_tx
c_func
(paren
id|txRing
)paren
OL
(paren
id|numDesc
op_plus
l_int|2
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* A Tx complete IRQ could have gotten inbetween, making&n;&t;&t; * the ring free again. Only need to recheck here, since&n;&t;&t; * Tx is serialized.&n;&t;&t; */
r_if
c_cond
(paren
id|typhoon_num_free_tx
c_func
(paren
id|txRing
)paren
op_ge
(paren
id|numDesc
op_plus
l_int|2
)paren
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_set_rx_mode
id|typhoon_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
id|u32
id|mc_filter
(braket
l_int|2
)braket
suffix:semicolon
id|u16
id|filter
suffix:semicolon
id|filter
op_assign
id|TYPHOON_RX_FILTER_DIRECTED
op_or
id|TYPHOON_RX_FILTER_BROADCAST
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|filter
op_or_assign
id|TYPHOON_RX_FILTER_PROMISCOUS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to match, or accept all multicasts. */
id|filter
op_or_assign
id|TYPHOON_RX_FILTER_ALL_MCAST
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;mc_count
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
r_int
id|bit
op_assign
id|ether_crc
c_func
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|mc_filter
(braket
id|bit
op_rshift
l_int|5
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|bit
op_amp
l_int|0x1f
)paren
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_SET_MULTICAST_HASH
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|TYPHOON_MCAST_HASH_SET
suffix:semicolon
id|xp_cmd.parm2
op_assign
id|cpu_to_le32
c_func
(paren
id|mc_filter
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|xp_cmd.parm3
op_assign
id|cpu_to_le32
c_func
(paren
id|mc_filter
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|filter
op_or_assign
id|TYPHOON_RX_FILTER_MCAST_HASH
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_SET_RX_FILTER
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|filter
suffix:semicolon
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_do_get_stats
id|typhoon_do_get_stats
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|tp-&gt;stats
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|saved
op_assign
op_amp
id|tp-&gt;stats_saved
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
r_struct
id|resp_desc
id|xp_resp
(braket
l_int|7
)braket
suffix:semicolon
r_struct
id|stats_resp
op_star
id|s
op_assign
(paren
r_struct
id|stats_resp
op_star
)paren
id|xp_resp
suffix:semicolon
r_int
id|err
suffix:semicolon
id|INIT_COMMAND_WITH_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_READ_STATS
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|7
comma
id|xp_resp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* 3Com&squot;s Linux driver uses txMultipleCollisions as it&squot;s&n;&t; * collisions value, but there is some other collision info as well...&n;&t; *&n;&t; * The extra status reported would be a good candidate for&n;&t; * ethtool_ops-&gt;get_{strings,stats}()&n;&t; */
id|stats-&gt;tx_packets
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;txPackets
)paren
suffix:semicolon
id|stats-&gt;tx_bytes
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;txBytes
)paren
suffix:semicolon
id|stats-&gt;tx_errors
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;txCarrierLost
)paren
suffix:semicolon
id|stats-&gt;tx_carrier_errors
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;txCarrierLost
)paren
suffix:semicolon
id|stats-&gt;collisions
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;txMultipleCollisions
)paren
suffix:semicolon
id|stats-&gt;rx_packets
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;rxPacketsGood
)paren
suffix:semicolon
id|stats-&gt;rx_bytes
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;rxBytesGood
)paren
suffix:semicolon
id|stats-&gt;rx_fifo_errors
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;rxFifoOverruns
)paren
suffix:semicolon
id|stats-&gt;rx_errors
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;rxFifoOverruns
)paren
op_plus
id|le32_to_cpu
c_func
(paren
id|s-&gt;BadSSD
)paren
op_plus
id|le32_to_cpu
c_func
(paren
id|s-&gt;rxCrcErrors
)paren
suffix:semicolon
id|stats-&gt;rx_crc_errors
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;rxCrcErrors
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_assign
id|le32_to_cpu
c_func
(paren
id|s-&gt;rxOversized
)paren
suffix:semicolon
id|tp-&gt;speed
op_assign
(paren
id|s-&gt;linkStatus
op_amp
id|TYPHOON_LINK_100MBPS
)paren
ques
c_cond
id|SPEED_100
suffix:colon
id|SPEED_10
suffix:semicolon
id|tp-&gt;duplex
op_assign
(paren
id|s-&gt;linkStatus
op_amp
id|TYPHOON_LINK_FULL_DUPLEX
)paren
ques
c_cond
id|DUPLEX_FULL
suffix:colon
id|DUPLEX_HALF
suffix:semicolon
multiline_comment|/* add in the saved statistics&n;&t; */
id|stats-&gt;tx_packets
op_add_assign
id|saved-&gt;tx_packets
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|saved-&gt;tx_bytes
suffix:semicolon
id|stats-&gt;tx_errors
op_add_assign
id|saved-&gt;tx_errors
suffix:semicolon
id|stats-&gt;collisions
op_add_assign
id|saved-&gt;collisions
suffix:semicolon
id|stats-&gt;rx_packets
op_add_assign
id|saved-&gt;rx_packets
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|saved-&gt;rx_bytes
suffix:semicolon
id|stats-&gt;rx_fifo_errors
op_add_assign
id|saved-&gt;rx_fifo_errors
suffix:semicolon
id|stats-&gt;rx_errors
op_add_assign
id|saved-&gt;rx_errors
suffix:semicolon
id|stats-&gt;rx_crc_errors
op_add_assign
id|saved-&gt;rx_crc_errors
suffix:semicolon
id|stats-&gt;rx_length_errors
op_add_assign
id|saved-&gt;rx_length_errors
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|net_device_stats
op_star
DECL|function|typhoon_get_stats
id|typhoon_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|tp-&gt;stats
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|saved
op_assign
op_amp
id|tp-&gt;stats_saved
suffix:semicolon
id|smp_rmb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;card_state
op_eq
id|Sleeping
)paren
(brace
r_return
id|saved
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_do_get_stats
c_func
(paren
id|tp
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: error getting stats&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|saved
suffix:semicolon
)brace
r_return
id|stats
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_set_mac_address
id|typhoon_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|sockaddr
op_star
id|saddr
op_assign
(paren
r_struct
id|sockaddr
op_star
)paren
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|saddr-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_get_drvinfo
id|typhoon_get_drvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
id|tp-&gt;pdev
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
r_struct
id|resp_desc
id|xp_resp
(braket
l_int|3
)braket
suffix:semicolon
id|smp_rmb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;card_state
op_eq
id|Sleeping
)paren
(brace
id|strcpy
c_func
(paren
id|info-&gt;fw_version
comma
l_string|&quot;Sleep image&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|INIT_COMMAND_WITH_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_READ_VERSIONS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|3
comma
id|xp_resp
)paren
OL
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|info-&gt;fw_version
comma
l_string|&quot;Unknown runtime&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|info-&gt;fw_version
comma
(paren
r_char
op_star
)paren
op_amp
id|xp_resp
(braket
l_int|1
)braket
comma
l_int|32
)paren
suffix:semicolon
id|info-&gt;fw_version
(braket
l_int|31
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|strcpy
c_func
(paren
id|info-&gt;driver
comma
id|DRV_MODULE_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;version
comma
id|DRV_MODULE_VERSION
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;bus_info
comma
id|pci_name
c_func
(paren
id|pci_dev
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_get_settings
id|typhoon_get_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cmd-&gt;supported
op_assign
id|SUPPORTED_100baseT_Half
op_or
id|SUPPORTED_100baseT_Full
op_or
id|SUPPORTED_Autoneg
suffix:semicolon
r_switch
c_cond
(paren
id|tp-&gt;xcvr_select
)paren
(brace
r_case
id|TYPHOON_XCVR_10HALF
suffix:colon
id|cmd-&gt;advertising
op_assign
id|ADVERTISED_10baseT_Half
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPHOON_XCVR_10FULL
suffix:colon
id|cmd-&gt;advertising
op_assign
id|ADVERTISED_10baseT_Full
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPHOON_XCVR_100HALF
suffix:colon
id|cmd-&gt;advertising
op_assign
id|ADVERTISED_100baseT_Half
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPHOON_XCVR_100FULL
suffix:colon
id|cmd-&gt;advertising
op_assign
id|ADVERTISED_100baseT_Full
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPHOON_XCVR_AUTONEG
suffix:colon
id|cmd-&gt;advertising
op_assign
id|ADVERTISED_10baseT_Half
op_or
id|ADVERTISED_10baseT_Full
op_or
id|ADVERTISED_100baseT_Half
op_or
id|ADVERTISED_100baseT_Full
op_or
id|ADVERTISED_Autoneg
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;capabilities
op_amp
id|TYPHOON_FIBER
)paren
(brace
id|cmd-&gt;supported
op_or_assign
id|SUPPORTED_FIBRE
suffix:semicolon
id|cmd-&gt;advertising
op_or_assign
id|ADVERTISED_FIBRE
suffix:semicolon
id|cmd-&gt;port
op_assign
id|PORT_FIBRE
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;supported
op_or_assign
id|SUPPORTED_10baseT_Half
op_or
id|SUPPORTED_10baseT_Full
op_or
id|SUPPORTED_TP
suffix:semicolon
id|cmd-&gt;advertising
op_or_assign
id|ADVERTISED_TP
suffix:semicolon
id|cmd-&gt;port
op_assign
id|PORT_TP
suffix:semicolon
)brace
multiline_comment|/* need to get stats to make these link speed/duplex valid */
id|typhoon_do_get_stats
c_func
(paren
id|tp
)paren
suffix:semicolon
id|cmd-&gt;speed
op_assign
id|tp-&gt;speed
suffix:semicolon
id|cmd-&gt;duplex
op_assign
id|tp-&gt;duplex
suffix:semicolon
id|cmd-&gt;phy_address
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;transceiver
op_assign
id|XCVR_INTERNAL
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;xcvr_select
op_eq
id|TYPHOON_XCVR_AUTONEG
)paren
(brace
id|cmd-&gt;autoneg
op_assign
id|AUTONEG_ENABLE
suffix:semicolon
)brace
r_else
id|cmd-&gt;autoneg
op_assign
id|AUTONEG_DISABLE
suffix:semicolon
id|cmd-&gt;maxtxpkt
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;maxrxpkt
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_set_settings
id|typhoon_set_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
r_int
id|xcvr
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
)paren
(brace
id|xcvr
op_assign
id|TYPHOON_XCVR_AUTONEG
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_HALF
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;speed
op_eq
id|SPEED_10
)paren
(brace
id|xcvr
op_assign
id|TYPHOON_XCVR_10HALF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;speed
op_eq
id|SPEED_100
)paren
(brace
id|xcvr
op_assign
id|TYPHOON_XCVR_100HALF
suffix:semicolon
)brace
r_else
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;duplex
op_eq
id|DUPLEX_FULL
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;speed
op_eq
id|SPEED_10
)paren
(brace
id|xcvr
op_assign
id|TYPHOON_XCVR_10FULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;speed
op_eq
id|SPEED_100
)paren
(brace
id|xcvr
op_assign
id|TYPHOON_XCVR_100FULL
suffix:semicolon
)brace
r_else
r_goto
id|out
suffix:semicolon
)brace
r_else
r_goto
id|out
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_XCVR_SELECT
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|cpu_to_le16
c_func
(paren
id|xcvr
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|tp-&gt;xcvr_select
op_assign
id|xcvr
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
)paren
(brace
id|tp-&gt;speed
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* invalid */
id|tp-&gt;duplex
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* invalid */
)brace
r_else
(brace
id|tp-&gt;speed
op_assign
id|cmd-&gt;speed
suffix:semicolon
id|tp-&gt;duplex
op_assign
id|cmd-&gt;duplex
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_get_wol
id|typhoon_get_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_wolinfo
op_star
id|wol
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|wol-&gt;supported
op_assign
id|WAKE_PHY
op_or
id|WAKE_MAGIC
suffix:semicolon
id|wol-&gt;wolopts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;wol_events
op_amp
id|TYPHOON_WAKE_LINK_EVENT
)paren
(brace
id|wol-&gt;wolopts
op_or_assign
id|WAKE_PHY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;wol_events
op_amp
id|TYPHOON_WAKE_MAGIC_PKT
)paren
(brace
id|wol-&gt;wolopts
op_or_assign
id|WAKE_MAGIC
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|wol-&gt;sopass
comma
l_int|0
comma
r_sizeof
(paren
id|wol-&gt;sopass
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_set_wol
id|typhoon_set_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_wolinfo
op_star
id|wol
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wol-&gt;wolopts
op_amp
op_complement
(paren
id|WAKE_PHY
op_or
id|WAKE_MAGIC
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tp-&gt;wol_events
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|wol-&gt;wolopts
op_amp
id|WAKE_PHY
)paren
(brace
id|tp-&gt;wol_events
op_or_assign
id|TYPHOON_WAKE_LINK_EVENT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wol-&gt;wolopts
op_amp
id|WAKE_MAGIC
)paren
(brace
id|tp-&gt;wol_events
op_or_assign
id|TYPHOON_WAKE_MAGIC_PKT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|u32
DECL|function|typhoon_get_rx_csum
id|typhoon_get_rx_csum
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* For now, we don&squot;t allow turning off RX checksums.&n;&t; */
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_get_ringparam
id|typhoon_get_ringparam
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_ringparam
op_star
id|ering
)paren
(brace
id|ering-&gt;rx_max_pending
op_assign
id|RXENT_ENTRIES
suffix:semicolon
id|ering-&gt;rx_mini_max_pending
op_assign
l_int|0
suffix:semicolon
id|ering-&gt;rx_jumbo_max_pending
op_assign
l_int|0
suffix:semicolon
id|ering-&gt;tx_max_pending
op_assign
id|TXLO_ENTRIES
op_minus
l_int|1
suffix:semicolon
id|ering-&gt;rx_pending
op_assign
id|RXENT_ENTRIES
suffix:semicolon
id|ering-&gt;rx_mini_pending
op_assign
l_int|0
suffix:semicolon
id|ering-&gt;rx_jumbo_pending
op_assign
l_int|0
suffix:semicolon
id|ering-&gt;tx_pending
op_assign
id|TXLO_ENTRIES
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|typhoon_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|typhoon_ethtool_ops
op_assign
(brace
dot
id|get_settings
op_assign
id|typhoon_get_settings
comma
dot
id|set_settings
op_assign
id|typhoon_set_settings
comma
dot
id|get_drvinfo
op_assign
id|typhoon_get_drvinfo
comma
dot
id|get_wol
op_assign
id|typhoon_get_wol
comma
dot
id|set_wol
op_assign
id|typhoon_set_wol
comma
dot
id|get_link
op_assign
id|ethtool_op_get_link
comma
dot
id|get_rx_csum
op_assign
id|typhoon_get_rx_csum
comma
dot
id|get_tx_csum
op_assign
id|ethtool_op_get_tx_csum
comma
dot
id|set_tx_csum
op_assign
id|ethtool_op_set_tx_csum
comma
dot
id|get_sg
op_assign
id|ethtool_op_get_sg
comma
dot
id|set_sg
op_assign
id|ethtool_op_set_sg
comma
dot
id|get_tso
op_assign
id|ethtool_op_get_tso
comma
dot
id|set_tso
op_assign
id|ethtool_op_set_tso
comma
dot
id|get_ringparam
op_assign
id|typhoon_get_ringparam
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|typhoon_wait_interrupt
id|typhoon_wait_interrupt
c_func
(paren
r_void
id|__iomem
op_star
id|ioaddr
)paren
(brace
r_int
id|i
comma
id|err
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TYPHOON_WAIT_TIMEOUT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_STATUS
)paren
op_amp
id|TYPHOON_INTR_BOOTCMD
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|udelay
c_func
(paren
id|TYPHOON_UDELAY
)paren
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
id|out
suffix:colon
id|writel
c_func
(paren
id|TYPHOON_INTR_BOOTCMD
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_STATUS
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|macro|shared_offset
mdefine_line|#define shared_offset(x)&t;offsetof(struct typhoon_shared, x)
r_static
r_void
DECL|function|typhoon_init_interface
id|typhoon_init_interface
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
r_struct
id|typhoon_interface
op_star
id|iface
op_assign
op_amp
id|tp-&gt;shared-&gt;iface
suffix:semicolon
id|dma_addr_t
id|shared_dma
suffix:semicolon
id|memset
c_func
(paren
id|tp-&gt;shared
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|typhoon_shared
)paren
)paren
suffix:semicolon
multiline_comment|/* The *Hi members of iface are all init&squot;d to zero by the memset().&n;&t; */
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|indexes
)paren
suffix:semicolon
id|iface-&gt;ringIndex
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|txLo
)paren
suffix:semicolon
id|iface-&gt;txLoAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|iface-&gt;txLoSize
op_assign
id|cpu_to_le32
c_func
(paren
id|TXLO_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
)paren
suffix:semicolon
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|txHi
)paren
suffix:semicolon
id|iface-&gt;txHiAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|iface-&gt;txHiSize
op_assign
id|cpu_to_le32
c_func
(paren
id|TXHI_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
)paren
suffix:semicolon
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|rxBuff
)paren
suffix:semicolon
id|iface-&gt;rxBuffAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|iface-&gt;rxBuffSize
op_assign
id|cpu_to_le32
c_func
(paren
id|RXFREE_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|rx_free
)paren
)paren
suffix:semicolon
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|rxLo
)paren
suffix:semicolon
id|iface-&gt;rxLoAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|iface-&gt;rxLoSize
op_assign
id|cpu_to_le32
c_func
(paren
id|RX_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
)paren
suffix:semicolon
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|rxHi
)paren
suffix:semicolon
id|iface-&gt;rxHiAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|iface-&gt;rxHiSize
op_assign
id|cpu_to_le32
c_func
(paren
id|RX_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
)paren
suffix:semicolon
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|iface-&gt;cmdAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|iface-&gt;cmdSize
op_assign
id|cpu_to_le32
c_func
(paren
id|COMMAND_RING_SIZE
)paren
suffix:semicolon
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|resp
)paren
suffix:semicolon
id|iface-&gt;respAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|iface-&gt;respSize
op_assign
id|cpu_to_le32
c_func
(paren
id|RESPONSE_RING_SIZE
)paren
suffix:semicolon
id|shared_dma
op_assign
id|tp-&gt;shared_dma
op_plus
id|shared_offset
c_func
(paren
id|zeroWord
)paren
suffix:semicolon
id|iface-&gt;zeroAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|shared_dma
)paren
suffix:semicolon
id|tp-&gt;indexes
op_assign
op_amp
id|tp-&gt;shared-&gt;indexes
suffix:semicolon
id|tp-&gt;txLoRing.ringBase
op_assign
(paren
id|u8
op_star
)paren
id|tp-&gt;shared-&gt;txLo
suffix:semicolon
id|tp-&gt;txHiRing.ringBase
op_assign
(paren
id|u8
op_star
)paren
id|tp-&gt;shared-&gt;txHi
suffix:semicolon
id|tp-&gt;rxLoRing.ringBase
op_assign
(paren
id|u8
op_star
)paren
id|tp-&gt;shared-&gt;rxLo
suffix:semicolon
id|tp-&gt;rxHiRing.ringBase
op_assign
(paren
id|u8
op_star
)paren
id|tp-&gt;shared-&gt;rxHi
suffix:semicolon
id|tp-&gt;rxBuffRing.ringBase
op_assign
(paren
id|u8
op_star
)paren
id|tp-&gt;shared-&gt;rxBuff
suffix:semicolon
id|tp-&gt;cmdRing.ringBase
op_assign
(paren
id|u8
op_star
)paren
id|tp-&gt;shared-&gt;cmd
suffix:semicolon
id|tp-&gt;respRing.ringBase
op_assign
(paren
id|u8
op_star
)paren
id|tp-&gt;shared-&gt;resp
suffix:semicolon
id|tp-&gt;txLoRing.writeRegister
op_assign
id|TYPHOON_REG_TX_LO_READY
suffix:semicolon
id|tp-&gt;txHiRing.writeRegister
op_assign
id|TYPHOON_REG_TX_HI_READY
suffix:semicolon
id|tp-&gt;txlo_dma_addr
op_assign
id|iface-&gt;txLoAddr
suffix:semicolon
id|tp-&gt;card_state
op_assign
id|Sleeping
suffix:semicolon
id|smp_wmb
c_func
(paren
)paren
suffix:semicolon
id|tp-&gt;offload
op_assign
id|TYPHOON_OFFLOAD_IP_CHKSUM
op_or
id|TYPHOON_OFFLOAD_TCP_CHKSUM
suffix:semicolon
id|tp-&gt;offload
op_or_assign
id|TYPHOON_OFFLOAD_UDP_CHKSUM
op_or
id|TSO_OFFLOAD_ON
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|tp-&gt;command_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_init_rings
id|typhoon_init_rings
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
id|memset
c_func
(paren
id|tp-&gt;indexes
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|typhoon_indexes
)paren
)paren
suffix:semicolon
id|tp-&gt;txLoRing.lastWrite
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;txHiRing.lastWrite
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;rxLoRing.lastWrite
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;rxHiRing.lastWrite
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;rxBuffRing.lastWrite
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;cmdRing.lastWrite
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;cmdRing.lastWrite
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;txLoRing.lastRead
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;txHiRing.lastRead
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_download_firmware
id|typhoon_download_firmware
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
r_void
id|__iomem
op_star
id|ioaddr
op_assign
id|tp-&gt;ioaddr
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|tp-&gt;pdev
suffix:semicolon
r_struct
id|typhoon_file_header
op_star
id|fHdr
suffix:semicolon
r_struct
id|typhoon_section_header
op_star
id|sHdr
suffix:semicolon
id|u8
op_star
id|image_data
suffix:semicolon
r_void
op_star
id|dpage
suffix:semicolon
id|dma_addr_t
id|dpage_dma
suffix:semicolon
r_int
r_int
id|csum
suffix:semicolon
id|u32
id|irqEnabled
suffix:semicolon
id|u32
id|irqMasked
suffix:semicolon
id|u32
id|numSections
suffix:semicolon
id|u32
id|section_len
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|u32
id|load_addr
suffix:semicolon
id|u32
id|hmac
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|fHdr
op_assign
(paren
r_struct
id|typhoon_file_header
op_star
)paren
id|typhoon_firmware_image
suffix:semicolon
id|image_data
op_assign
(paren
id|u8
op_star
)paren
id|fHdr
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|fHdr-&gt;tag
comma
l_string|&quot;TYPHOON&quot;
comma
l_int|8
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Invalid firmware image!&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/* Cannot just map the firmware image using pci_map_single() as&n;&t; * the firmware is part of the kernel/module image, so we allocate&n;&t; * some consistent memory to copy the sections into, as it is simpler,&n;&t; * and short-lived. If we ever split out and require a userland&n;&t; * firmware loader, then we can revisit this.&n;&t; */
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|dpage
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|PAGE_SIZE
comma
op_amp
id|dpage_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dpage
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: no DMA mem for firmware&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|irqEnabled
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_ENABLE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|irqEnabled
op_or
id|TYPHOON_INTR_BOOTCMD
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_ENABLE
)paren
suffix:semicolon
id|irqMasked
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_MASK
)paren
suffix:semicolon
id|writel
c_func
(paren
id|irqMasked
op_or
id|TYPHOON_INTR_BOOTCMD
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_MASK
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_wait_status
c_func
(paren
id|ioaddr
comma
id|TYPHOON_STATUS_WAITING_FOR_HOST
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: card ready timeout&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
r_goto
id|err_out_irq
suffix:semicolon
)brace
id|numSections
op_assign
id|le32_to_cpu
c_func
(paren
id|fHdr-&gt;numSections
)paren
suffix:semicolon
id|load_addr
op_assign
id|le32_to_cpu
c_func
(paren
id|fHdr-&gt;startAddr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_INTR_BOOTCMD
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_STATUS
)paren
suffix:semicolon
id|writel
c_func
(paren
id|load_addr
comma
id|ioaddr
op_plus
id|TYPHOON_REG_DOWNLOAD_BOOT_ADDR
)paren
suffix:semicolon
id|hmac
op_assign
id|le32_to_cpu
c_func
(paren
id|fHdr-&gt;hmacDigest
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hmac
comma
id|ioaddr
op_plus
id|TYPHOON_REG_DOWNLOAD_HMAC_0
)paren
suffix:semicolon
id|hmac
op_assign
id|le32_to_cpu
c_func
(paren
id|fHdr-&gt;hmacDigest
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hmac
comma
id|ioaddr
op_plus
id|TYPHOON_REG_DOWNLOAD_HMAC_1
)paren
suffix:semicolon
id|hmac
op_assign
id|le32_to_cpu
c_func
(paren
id|fHdr-&gt;hmacDigest
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hmac
comma
id|ioaddr
op_plus
id|TYPHOON_REG_DOWNLOAD_HMAC_2
)paren
suffix:semicolon
id|hmac
op_assign
id|le32_to_cpu
c_func
(paren
id|fHdr-&gt;hmacDigest
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hmac
comma
id|ioaddr
op_plus
id|TYPHOON_REG_DOWNLOAD_HMAC_3
)paren
suffix:semicolon
id|hmac
op_assign
id|le32_to_cpu
c_func
(paren
id|fHdr-&gt;hmacDigest
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hmac
comma
id|ioaddr
op_plus
id|TYPHOON_REG_DOWNLOAD_HMAC_4
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_BOOTCMD_RUNTIME_IMAGE
comma
id|ioaddr
op_plus
id|TYPHOON_REG_COMMAND
)paren
suffix:semicolon
id|image_data
op_add_assign
r_sizeof
(paren
r_struct
id|typhoon_file_header
)paren
suffix:semicolon
multiline_comment|/* The readl() in typhoon_wait_interrupt() will force the&n;&t; * last write to the command register to post, so&n;&t; * we don&squot;t need a typhoon_post_pci_writes() after it.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numSections
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sHdr
op_assign
(paren
r_struct
id|typhoon_section_header
op_star
)paren
id|image_data
suffix:semicolon
id|image_data
op_add_assign
r_sizeof
(paren
r_struct
id|typhoon_section_header
)paren
suffix:semicolon
id|load_addr
op_assign
id|le32_to_cpu
c_func
(paren
id|sHdr-&gt;startAddr
)paren
suffix:semicolon
id|section_len
op_assign
id|le32_to_cpu
c_func
(paren
id|sHdr-&gt;len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|section_len
)paren
(brace
id|len
op_assign
id|min_t
c_func
(paren
id|u32
comma
id|section_len
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_wait_interrupt
c_func
(paren
id|ioaddr
)paren
OL
l_int|0
op_logical_or
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_STATUS
)paren
op_ne
id|TYPHOON_STATUS_WAITING_FOR_SEGMENT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: segment ready timeout&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
r_goto
id|err_out_irq
suffix:semicolon
)brace
multiline_comment|/* Do an pseudo IPv4 checksum on the data -- first&n;&t;&t;&t; * need to convert each u16 to cpu order before&n;&t;&t;&t; * summing. Fortunately, due to the properties of&n;&t;&t;&t; * the checksum, we can do this once, at the end.&n;&t;&t;&t; */
id|csum
op_assign
id|csum_partial_copy_nocheck
c_func
(paren
id|image_data
comma
id|dpage
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|csum
op_assign
id|csum_fold
c_func
(paren
id|csum
)paren
suffix:semicolon
id|csum
op_assign
id|le16_to_cpu
c_func
(paren
id|csum
)paren
suffix:semicolon
id|writel
c_func
(paren
id|len
comma
id|ioaddr
op_plus
id|TYPHOON_REG_BOOT_LENGTH
)paren
suffix:semicolon
id|writel
c_func
(paren
id|csum
comma
id|ioaddr
op_plus
id|TYPHOON_REG_BOOT_CHECKSUM
)paren
suffix:semicolon
id|writel
c_func
(paren
id|load_addr
comma
id|ioaddr
op_plus
id|TYPHOON_REG_BOOT_DEST_ADDR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TYPHOON_REG_BOOT_DATA_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dpage_dma
comma
id|ioaddr
op_plus
id|TYPHOON_REG_BOOT_DATA_LO
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_BOOTCMD_SEG_AVAILABLE
comma
id|ioaddr
op_plus
id|TYPHOON_REG_COMMAND
)paren
suffix:semicolon
id|image_data
op_add_assign
id|len
suffix:semicolon
id|load_addr
op_add_assign
id|len
suffix:semicolon
id|section_len
op_sub_assign
id|len
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|typhoon_wait_interrupt
c_func
(paren
id|ioaddr
)paren
OL
l_int|0
op_logical_or
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_STATUS
)paren
op_ne
id|TYPHOON_STATUS_WAITING_FOR_SEGMENT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: final segment ready timeout&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
r_goto
id|err_out_irq
suffix:semicolon
)brace
id|writel
c_func
(paren
id|TYPHOON_BOOTCMD_DNLD_COMPLETE
comma
id|ioaddr
op_plus
id|TYPHOON_REG_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_wait_status
c_func
(paren
id|ioaddr
comma
id|TYPHOON_STATUS_WAITING_FOR_BOOT
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: boot ready timeout, status 0x%0x&bslash;n&quot;
comma
id|tp-&gt;name
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_STATUS
)paren
)paren
suffix:semicolon
r_goto
id|err_out_irq
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|err_out_irq
suffix:colon
id|writel
c_func
(paren
id|irqMasked
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_MASK
)paren
suffix:semicolon
id|writel
c_func
(paren
id|irqEnabled
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_ENABLE
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|PAGE_SIZE
comma
id|dpage
comma
id|dpage_dma
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_boot_3XP
id|typhoon_boot_3XP
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
id|u32
id|initial_status
)paren
(brace
r_void
id|__iomem
op_star
id|ioaddr
op_assign
id|tp-&gt;ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_wait_status
c_func
(paren
id|ioaddr
comma
id|initial_status
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: boot ready timeout&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
r_goto
id|out_timeout
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TYPHOON_REG_BOOT_RECORD_ADDR_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tp-&gt;shared_dma
comma
id|ioaddr
op_plus
id|TYPHOON_REG_BOOT_RECORD_ADDR_LO
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_BOOTCMD_REG_BOOT_RECORD
comma
id|ioaddr
op_plus
id|TYPHOON_REG_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_wait_status
c_func
(paren
id|ioaddr
comma
id|TYPHOON_STATUS_RUNNING
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: boot finish timeout (status 0x%x)&bslash;n&quot;
comma
id|tp-&gt;name
comma
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_STATUS
)paren
)paren
suffix:semicolon
r_goto
id|out_timeout
suffix:semicolon
)brace
multiline_comment|/* Clear the Transmit and Command ready registers&n;&t; */
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TYPHOON_REG_TX_HI_READY
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TYPHOON_REG_CMD_READY
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|TYPHOON_REG_TX_LO_READY
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_BOOTCMD_BOOT
comma
id|ioaddr
op_plus
id|TYPHOON_REG_COMMAND
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_timeout
suffix:colon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_static
id|u32
DECL|function|typhoon_clean_tx
id|typhoon_clean_tx
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
r_struct
id|transmit_ring
op_star
id|txRing
comma
r_volatile
id|u32
op_star
id|index
)paren
(brace
id|u32
id|lastRead
op_assign
id|txRing-&gt;lastRead
suffix:semicolon
r_struct
id|tx_desc
op_star
id|tx
suffix:semicolon
id|dma_addr_t
id|skb_dma
suffix:semicolon
r_int
id|dma_len
suffix:semicolon
r_int
id|type
suffix:semicolon
r_while
c_loop
(paren
id|lastRead
op_ne
id|le32_to_cpu
c_func
(paren
op_star
id|index
)paren
)paren
(brace
id|tx
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
(paren
id|txRing-&gt;ringBase
op_plus
id|lastRead
)paren
suffix:semicolon
id|type
op_assign
id|tx-&gt;flags
op_amp
id|TYPHOON_TYPE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|TYPHOON_TX_DESC
)paren
(brace
multiline_comment|/* This tx_desc describes a packet.&n;&t;&t;&t; */
r_int
r_int
id|ptr
op_assign
id|tx-&gt;addr
op_or
(paren
(paren
id|u64
)paren
id|tx-&gt;addrHi
op_lshift
l_int|32
)paren
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|ptr
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|TYPHOON_FRAG_DESC
)paren
(brace
multiline_comment|/* This tx_desc describes a memory mapping. Free it.&n;&t;&t;&t; */
id|skb_dma
op_assign
(paren
id|dma_addr_t
)paren
id|le32_to_cpu
c_func
(paren
id|tx-&gt;addr
)paren
suffix:semicolon
id|dma_len
op_assign
id|le16_to_cpu
c_func
(paren
id|tx-&gt;len
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|tp-&gt;pdev
comma
id|skb_dma
comma
id|dma_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
id|tx-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|typhoon_inc_tx_index
c_func
(paren
op_amp
id|lastRead
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|lastRead
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_tx_complete
id|typhoon_tx_complete
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
r_struct
id|transmit_ring
op_star
id|txRing
comma
r_volatile
id|u32
op_star
id|index
)paren
(brace
id|u32
id|lastRead
suffix:semicolon
r_int
id|numDesc
op_assign
id|MAX_SKB_FRAGS
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* This will need changing if we start to use the Hi Tx ring. */
id|lastRead
op_assign
id|typhoon_clean_tx
c_func
(paren
id|tp
comma
id|txRing
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|tp-&gt;dev
)paren
op_logical_and
id|typhoon_num_free
c_func
(paren
id|txRing-&gt;lastWrite
comma
id|lastRead
comma
id|TXLO_ENTRIES
)paren
OG
(paren
id|numDesc
op_plus
l_int|2
)paren
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|tp-&gt;dev
)paren
suffix:semicolon
)brace
id|txRing-&gt;lastRead
op_assign
id|lastRead
suffix:semicolon
id|smp_wmb
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_recycle_rx_skb
id|typhoon_recycle_rx_skb
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
id|u32
id|idx
)paren
(brace
r_struct
id|typhoon_indexes
op_star
id|indexes
op_assign
id|tp-&gt;indexes
suffix:semicolon
r_struct
id|rxbuff_ent
op_star
id|rxb
op_assign
op_amp
id|tp-&gt;rxbuffers
(braket
id|idx
)braket
suffix:semicolon
r_struct
id|basic_ring
op_star
id|ring
op_assign
op_amp
id|tp-&gt;rxBuffRing
suffix:semicolon
r_struct
id|rx_free
op_star
id|r
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ring-&gt;lastWrite
op_plus
r_sizeof
(paren
op_star
id|r
)paren
)paren
op_mod
(paren
id|RXFREE_ENTRIES
op_star
r_sizeof
(paren
op_star
id|r
)paren
)paren
op_eq
id|indexes-&gt;rxBuffCleared
)paren
(brace
multiline_comment|/* no room in ring, just drop the skb&n;&t;&t; */
id|dev_kfree_skb_any
c_func
(paren
id|rxb-&gt;skb
)paren
suffix:semicolon
id|rxb-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
id|r
op_assign
(paren
r_struct
id|rx_free
op_star
)paren
(paren
id|ring-&gt;ringBase
op_plus
id|ring-&gt;lastWrite
)paren
suffix:semicolon
id|typhoon_inc_rxfree_index
c_func
(paren
op_amp
id|ring-&gt;lastWrite
comma
l_int|1
)paren
suffix:semicolon
id|r-&gt;virtAddr
op_assign
id|idx
suffix:semicolon
id|r-&gt;physAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|rxb-&gt;dma_addr
)paren
suffix:semicolon
multiline_comment|/* Tell the card about it */
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|indexes-&gt;rxBuffReady
op_assign
id|cpu_to_le32
c_func
(paren
id|ring-&gt;lastWrite
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_alloc_rx_skb
id|typhoon_alloc_rx_skb
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
id|u32
id|idx
)paren
(brace
r_struct
id|typhoon_indexes
op_star
id|indexes
op_assign
id|tp-&gt;indexes
suffix:semicolon
r_struct
id|rxbuff_ent
op_star
id|rxb
op_assign
op_amp
id|tp-&gt;rxbuffers
(braket
id|idx
)braket
suffix:semicolon
r_struct
id|basic_ring
op_star
id|ring
op_assign
op_amp
id|tp-&gt;rxBuffRing
suffix:semicolon
r_struct
id|rx_free
op_star
id|r
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|rxb-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ring-&gt;lastWrite
op_plus
r_sizeof
(paren
op_star
id|r
)paren
)paren
op_mod
(paren
id|RXFREE_ENTRIES
op_star
r_sizeof
(paren
op_star
id|r
)paren
)paren
op_eq
id|indexes-&gt;rxBuffCleared
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Please, 3com, fix the firmware to allow DMA to a unaligned&n;&t; * address! Pretty please?&n;&t; */
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
macro_line|#endif
id|skb-&gt;dev
op_assign
id|tp-&gt;dev
suffix:semicolon
id|dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|tp-&gt;pdev
comma
id|skb-&gt;tail
comma
id|PKT_BUF_SZ
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/* Since no card does 64 bit DAC, the high bits will never&n;&t; * change from zero.&n;&t; */
id|r
op_assign
(paren
r_struct
id|rx_free
op_star
)paren
(paren
id|ring-&gt;ringBase
op_plus
id|ring-&gt;lastWrite
)paren
suffix:semicolon
id|typhoon_inc_rxfree_index
c_func
(paren
op_amp
id|ring-&gt;lastWrite
comma
l_int|1
)paren
suffix:semicolon
id|r-&gt;virtAddr
op_assign
id|idx
suffix:semicolon
id|r-&gt;physAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
id|rxb-&gt;skb
op_assign
id|skb
suffix:semicolon
id|rxb-&gt;dma_addr
op_assign
id|dma_addr
suffix:semicolon
multiline_comment|/* Tell the card about it */
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|indexes-&gt;rxBuffReady
op_assign
id|cpu_to_le32
c_func
(paren
id|ring-&gt;lastWrite
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_rx
id|typhoon_rx
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
r_struct
id|basic_ring
op_star
id|rxRing
comma
r_volatile
id|u32
op_star
id|ready
comma
r_volatile
id|u32
op_star
id|cleared
comma
r_int
id|budget
)paren
(brace
r_struct
id|rx_desc
op_star
id|rx
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|new_skb
suffix:semicolon
r_struct
id|rxbuff_ent
op_star
id|rxb
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|u32
id|local_ready
suffix:semicolon
id|u32
id|rxaddr
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
id|u32
id|idx
suffix:semicolon
id|u32
id|csum_bits
suffix:semicolon
r_int
id|received
suffix:semicolon
id|received
op_assign
l_int|0
suffix:semicolon
id|local_ready
op_assign
id|le32_to_cpu
c_func
(paren
op_star
id|ready
)paren
suffix:semicolon
id|rxaddr
op_assign
id|le32_to_cpu
c_func
(paren
op_star
id|cleared
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rxaddr
op_ne
id|local_ready
op_logical_and
id|budget
OG
l_int|0
)paren
(brace
id|rx
op_assign
(paren
r_struct
id|rx_desc
op_star
)paren
(paren
id|rxRing-&gt;ringBase
op_plus
id|rxaddr
)paren
suffix:semicolon
id|idx
op_assign
id|rx-&gt;addr
suffix:semicolon
id|rxb
op_assign
op_amp
id|tp-&gt;rxbuffers
(braket
id|idx
)braket
suffix:semicolon
id|skb
op_assign
id|rxb-&gt;skb
suffix:semicolon
id|dma_addr
op_assign
id|rxb-&gt;dma_addr
suffix:semicolon
id|rxaddr
op_add_assign
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
id|rxaddr
op_mod_assign
id|RX_ENTRIES
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx-&gt;flags
op_amp
id|TYPHOON_RX_ERROR
)paren
(brace
id|typhoon_recycle_rx_skb
c_func
(paren
id|tp
comma
id|idx
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pkt_len
op_assign
id|le16_to_cpu
c_func
(paren
id|rx-&gt;frameLen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt_len
OL
id|rx_copybreak
op_logical_and
(paren
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|new_skb-&gt;dev
op_assign
id|tp-&gt;dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
l_int|2
)paren
suffix:semicolon
id|pci_dma_sync_single_for_cpu
c_func
(paren
id|tp-&gt;pdev
comma
id|dma_addr
comma
id|PKT_BUF_SZ
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|new_skb
comma
id|skb-&gt;tail
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|pci_dma_sync_single_for_device
c_func
(paren
id|tp-&gt;pdev
comma
id|dma_addr
comma
id|PKT_BUF_SZ
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
id|pkt_len
)paren
suffix:semicolon
id|typhoon_recycle_rx_skb
c_func
(paren
id|tp
comma
id|idx
)paren
suffix:semicolon
)brace
r_else
(brace
id|new_skb
op_assign
id|skb
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
id|pkt_len
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|tp-&gt;pdev
comma
id|dma_addr
comma
id|PKT_BUF_SZ
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|typhoon_alloc_rx_skb
c_func
(paren
id|tp
comma
id|idx
)paren
suffix:semicolon
)brace
id|new_skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|new_skb
comma
id|tp-&gt;dev
)paren
suffix:semicolon
id|csum_bits
op_assign
id|rx-&gt;rxStatus
op_amp
(paren
id|TYPHOON_RX_IP_CHK_GOOD
op_or
id|TYPHOON_RX_UDP_CHK_GOOD
op_or
id|TYPHOON_RX_TCP_CHK_GOOD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csum_bits
op_eq
(paren
id|TYPHOON_RX_IP_CHK_GOOD
op_or
id|TYPHOON_RX_TCP_CHK_GOOD
)paren
op_logical_or
id|csum_bits
op_eq
(paren
id|TYPHOON_RX_IP_CHK_GOOD
op_or
id|TYPHOON_RX_UDP_CHK_GOOD
)paren
)paren
(brace
id|new_skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
r_else
id|new_skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;vlgrp
op_ne
l_int|NULL
op_logical_and
id|rx-&gt;rxStatus
op_amp
id|TYPHOON_RX_VLAN
)paren
(brace
id|vlan_hwaccel_receive_skb
c_func
(paren
id|new_skb
comma
id|tp-&gt;vlgrp
comma
id|ntohl
c_func
(paren
id|rx-&gt;vlanTag
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
)brace
r_else
id|netif_receive_skb
c_func
(paren
id|new_skb
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
id|tp-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|received
op_increment
suffix:semicolon
id|budget
op_decrement
suffix:semicolon
)brace
op_star
id|cleared
op_assign
id|cpu_to_le32
c_func
(paren
id|rxaddr
)paren
suffix:semicolon
r_return
id|received
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_fill_free_ring
id|typhoon_fill_free_ring
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
id|u32
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RXENT_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|rxbuff_ent
op_star
id|rxb
op_assign
op_amp
id|tp-&gt;rxbuffers
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rxb-&gt;skb
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_alloc_rx_skb
c_func
(paren
id|tp
comma
id|i
)paren
OL
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_static
r_int
DECL|function|typhoon_poll
id|typhoon_poll
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
op_star
id|total_budget
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|typhoon_indexes
op_star
id|indexes
op_assign
id|tp-&gt;indexes
suffix:semicolon
r_int
id|orig_budget
op_assign
op_star
id|total_budget
suffix:semicolon
r_int
id|budget
comma
id|work_done
comma
id|done
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;awaiting_resp
op_logical_and
id|indexes-&gt;respReady
op_ne
id|indexes-&gt;respCleared
)paren
(brace
id|typhoon_process_response
c_func
(paren
id|tp
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|indexes-&gt;txLoCleared
)paren
op_ne
id|tp-&gt;txLoRing.lastRead
)paren
(brace
id|typhoon_tx_complete
c_func
(paren
id|tp
comma
op_amp
id|tp-&gt;txLoRing
comma
op_amp
id|indexes-&gt;txLoCleared
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|orig_budget
OG
id|dev-&gt;quota
)paren
(brace
id|orig_budget
op_assign
id|dev-&gt;quota
suffix:semicolon
)brace
id|budget
op_assign
id|orig_budget
suffix:semicolon
id|work_done
op_assign
l_int|0
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|indexes-&gt;rxHiCleared
op_ne
id|indexes-&gt;rxHiReady
)paren
(brace
id|work_done
op_assign
id|typhoon_rx
c_func
(paren
id|tp
comma
op_amp
id|tp-&gt;rxHiRing
comma
op_amp
id|indexes-&gt;rxHiReady
comma
op_amp
id|indexes-&gt;rxHiCleared
comma
id|budget
)paren
suffix:semicolon
id|budget
op_sub_assign
id|work_done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|indexes-&gt;rxLoCleared
op_ne
id|indexes-&gt;rxLoReady
)paren
(brace
id|work_done
op_add_assign
id|typhoon_rx
c_func
(paren
id|tp
comma
op_amp
id|tp-&gt;rxLoRing
comma
op_amp
id|indexes-&gt;rxLoReady
comma
op_amp
id|indexes-&gt;rxLoCleared
comma
id|budget
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|work_done
)paren
(brace
op_star
id|total_budget
op_sub_assign
id|work_done
suffix:semicolon
id|dev-&gt;quota
op_sub_assign
id|work_done
suffix:semicolon
r_if
c_cond
(paren
id|work_done
op_ge
id|orig_budget
)paren
(brace
id|done
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|indexes-&gt;rxBuffCleared
)paren
op_eq
id|tp-&gt;rxBuffRing.lastWrite
)paren
(brace
multiline_comment|/* rxBuff ring is empty, try to fill it. */
id|typhoon_fill_free_ring
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|done
)paren
(brace
id|netif_rx_complete
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_INTR_NONE
comma
id|tp-&gt;ioaddr
op_plus
id|TYPHOON_REG_INTR_MASK
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|tp-&gt;ioaddr
)paren
suffix:semicolon
)brace
r_return
(paren
id|done
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|typhoon_interrupt
id|typhoon_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|rgs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_instance
suffix:semicolon
r_struct
id|typhoon
op_star
id|tp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr
op_assign
id|tp-&gt;ioaddr
suffix:semicolon
id|u32
id|intr_status
suffix:semicolon
id|intr_status
op_assign
id|readl
c_func
(paren
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|intr_status
op_amp
id|TYPHOON_INTR_HOST_INT
)paren
)paren
(brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|writel
c_func
(paren
id|intr_status
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_rx_schedule_prep
c_func
(paren
id|dev
)paren
)paren
(brace
id|writel
c_func
(paren
id|TYPHOON_INTR_ALL
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_MASK
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|__netif_rx_schedule
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Error, poll already scheduled&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_free_rx_rings
id|typhoon_free_rx_rings
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
id|u32
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RXENT_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|rxbuff_ent
op_star
id|rxb
op_assign
op_amp
id|tp-&gt;rxbuffers
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rxb-&gt;skb
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|tp-&gt;pdev
comma
id|rxb-&gt;dma_addr
comma
id|PKT_BUF_SZ
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|rxb-&gt;skb
)paren
suffix:semicolon
id|rxb-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_static
r_int
DECL|function|typhoon_sleep
id|typhoon_sleep
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
r_int
id|state
comma
id|u16
id|events
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|tp-&gt;pdev
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr
op_assign
id|tp-&gt;ioaddr
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
r_int
id|err
suffix:semicolon
id|INIT_COMMAND_WITH_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_ENABLE_WAKE_EVENTS
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|events
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: typhoon_sleep(): wake events cmd err %d&bslash;n&quot;
comma
id|tp-&gt;name
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_GOTO_SLEEP
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: typhoon_sleep(): sleep cmd err %d&bslash;n&quot;
comma
id|tp-&gt;name
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_wait_status
c_func
(paren
id|ioaddr
comma
id|TYPHOON_STATUS_SLEEPING
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/* Since we cannot monitor the status of the link while sleeping,&n;&t; * tell the world it went away.&n;&t; */
id|netif_carrier_off
c_func
(paren
id|tp-&gt;dev
)paren
suffix:semicolon
id|pci_enable_wake
c_func
(paren
id|tp-&gt;pdev
comma
id|state
comma
l_int|1
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|pci_choose_state
c_func
(paren
id|pdev
comma
id|state
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_wakeup
id|typhoon_wakeup
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
r_int
id|wait_type
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|tp-&gt;pdev
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr
op_assign
id|tp-&gt;ioaddr
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|PCI_D0
)paren
suffix:semicolon
id|pci_restore_state
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* Post 2.x.x versions of the Sleep Image require a reset before&n;&t; * we can download the Runtime Image. But let&squot;s not make users of&n;&t; * the old firmware pay for the reset.&n;&t; */
id|writel
c_func
(paren
id|TYPHOON_BOOTCMD_WAKEUP
comma
id|ioaddr
op_plus
id|TYPHOON_REG_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_wait_status
c_func
(paren
id|ioaddr
comma
id|TYPHOON_STATUS_WAITING_FOR_HOST
)paren
OL
l_int|0
op_logical_or
(paren
id|tp-&gt;capabilities
op_amp
id|TYPHOON_WAKEUP_NEEDS_RESET
)paren
)paren
(brace
r_return
id|typhoon_reset
c_func
(paren
id|ioaddr
comma
id|wait_type
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_start_runtime
id|typhoon_start_runtime
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|tp-&gt;dev
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr
op_assign
id|tp-&gt;ioaddr
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
r_int
id|err
suffix:semicolon
id|typhoon_init_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
id|typhoon_fill_free_ring
c_func
(paren
id|tp
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_download_firmware
c_func
(paren
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: cannot load runtime on 3XP&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_boot_3XP
c_func
(paren
id|tp
comma
id|TYPHOON_STATUS_WAITING_FOR_BOOT
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: cannot boot 3XP&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_SET_MAX_PKT_SIZE
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|cpu_to_le16
c_func
(paren
id|PKT_BUF_SZ
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error_out
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_SET_MAC_ADDRESS
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|cpu_to_le16
c_func
(paren
id|ntohs
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|xp_cmd.parm2
op_assign
id|cpu_to_le32
c_func
(paren
id|ntohl
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error_out
suffix:semicolon
)brace
multiline_comment|/* Disable IRQ coalescing -- we can reenable it when 3Com gives&n;&t; * us some more information on how to control it.&n;&t; */
id|INIT_COMMAND_WITH_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_IRQ_COALESCE_CTRL
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error_out
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_XCVR_SELECT
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|tp-&gt;xcvr_select
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error_out
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_VLAN_TYPE_WRITE
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|ETH_P_8021Q
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error_out
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_SET_OFFLOAD_TASKS
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
id|xp_cmd.parm2
op_assign
id|tp-&gt;offload
suffix:semicolon
id|xp_cmd.parm3
op_assign
id|tp-&gt;offload
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error_out
suffix:semicolon
)brace
id|typhoon_set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_TX_ENABLE
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error_out
suffix:semicolon
)brace
id|INIT_COMMAND_WITH_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_RX_ENABLE
)paren
suffix:semicolon
id|err
op_assign
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error_out
suffix:semicolon
)brace
id|tp-&gt;card_state
op_assign
id|Running
suffix:semicolon
id|smp_wmb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_INTR_ENABLE_ALL
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_ENABLE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TYPHOON_INTR_NONE
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_MASK
)paren
suffix:semicolon
id|typhoon_post_pci_writes
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error_out
suffix:colon
id|typhoon_reset
c_func
(paren
id|ioaddr
comma
id|WaitNoSleep
)paren
suffix:semicolon
id|typhoon_free_rx_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
id|typhoon_init_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_stop_runtime
id|typhoon_stop_runtime
c_func
(paren
r_struct
id|typhoon
op_star
id|tp
comma
r_int
id|wait_type
)paren
(brace
r_struct
id|typhoon_indexes
op_star
id|indexes
op_assign
id|tp-&gt;indexes
suffix:semicolon
r_struct
id|transmit_ring
op_star
id|txLo
op_assign
op_amp
id|tp-&gt;txLoRing
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr
op_assign
id|tp-&gt;ioaddr
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Disable interrupts early, since we can&squot;t schedule a poll&n;&t; * when called with !netif_running(). This will be posted&n;&t; * when we force the posting of the command.&n;&t; */
id|writel
c_func
(paren
id|TYPHOON_INTR_NONE
comma
id|ioaddr
op_plus
id|TYPHOON_REG_INTR_ENABLE
)paren
suffix:semicolon
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_RX_DISABLE
)paren
suffix:semicolon
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Wait 1/2 sec for any outstanding transmits to occur&n;&t; * We&squot;ll cleanup after the reset if this times out.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TYPHOON_WAIT_TIMEOUT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|indexes-&gt;txLoCleared
op_eq
id|cpu_to_le32
c_func
(paren
id|txLo-&gt;lastWrite
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
id|TYPHOON_UDELAY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|TYPHOON_WAIT_TIMEOUT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: halt timed out waiting for Tx to complete&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_TX_DISABLE
)paren
suffix:semicolon
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* save the statistics so when we bring the interface up again,&n;&t; * the values reported to userspace are correct.&n;&t; */
id|tp-&gt;card_state
op_assign
id|Sleeping
suffix:semicolon
id|smp_wmb
c_func
(paren
)paren
suffix:semicolon
id|typhoon_do_get_stats
c_func
(paren
id|tp
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tp-&gt;stats_saved
comma
op_amp
id|tp-&gt;stats
comma
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
)paren
suffix:semicolon
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_HALT
)paren
suffix:semicolon
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_wait_status
c_func
(paren
id|ioaddr
comma
id|TYPHOON_STATUS_HALTED
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: timed out waiting for 3XP to halt&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_reset
c_func
(paren
id|ioaddr
comma
id|wait_type
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to reset 3XP&bslash;n&quot;
comma
id|tp-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/* cleanup any outstanding Tx packets */
r_if
c_cond
(paren
id|indexes-&gt;txLoCleared
op_ne
id|cpu_to_le32
c_func
(paren
id|txLo-&gt;lastWrite
)paren
)paren
(brace
id|indexes-&gt;txLoCleared
op_assign
id|cpu_to_le32
c_func
(paren
id|txLo-&gt;lastWrite
)paren
suffix:semicolon
id|typhoon_clean_tx
c_func
(paren
id|tp
comma
op_amp
id|tp-&gt;txLoRing
comma
op_amp
id|indexes-&gt;txLoCleared
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|typhoon_tx_timeout
id|typhoon_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_reset
c_func
(paren
id|tp-&gt;ioaddr
comma
id|WaitNoSleep
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: could not reset in tx timeout&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|truely_dead
suffix:semicolon
)brace
multiline_comment|/* If we ever start using the Hi ring, it will need cleaning too */
id|typhoon_clean_tx
c_func
(paren
id|tp
comma
op_amp
id|tp-&gt;txLoRing
comma
op_amp
id|tp-&gt;indexes-&gt;txLoCleared
)paren
suffix:semicolon
id|typhoon_free_rx_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_start_runtime
c_func
(paren
id|tp
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: could not start runtime in tx timeout&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|truely_dead
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
id|truely_dead
suffix:colon
multiline_comment|/* Reset the hardware, and turn off carrier to avoid more timeouts */
id|typhoon_reset
c_func
(paren
id|tp-&gt;ioaddr
comma
id|NoWait
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_open
id|typhoon_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|typhoon_wakeup
c_func
(paren
id|tp
comma
id|WaitSleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to wakeup device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|out_sleep
suffix:semicolon
)brace
id|err
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|typhoon_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|out_sleep
suffix:semicolon
)brace
id|err
op_assign
id|typhoon_start_runtime
c_func
(paren
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|out_irq
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_irq
suffix:colon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|out_sleep
suffix:colon
r_if
c_cond
(paren
id|typhoon_boot_3XP
c_func
(paren
id|tp
comma
id|TYPHOON_STATUS_WAITING_FOR_HOST
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to reboot into sleep img&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|typhoon_reset
c_func
(paren
id|tp-&gt;ioaddr
comma
id|NoWait
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_sleep
c_func
(paren
id|tp
comma
l_int|3
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to go back to sleep&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_close
id|typhoon_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_stop_runtime
c_func
(paren
id|tp
comma
id|WaitSleep
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to stop runtime&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure there is no irq handler running on a different CPU. */
id|typhoon_synchronize_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|typhoon_free_rx_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
id|typhoon_init_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_boot_3XP
c_func
(paren
id|tp
comma
id|TYPHOON_STATUS_WAITING_FOR_HOST
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to boot sleep image&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_sleep
c_func
(paren
id|tp
comma
l_int|3
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to put card to sleep&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
r_static
r_int
DECL|function|typhoon_resume
id|typhoon_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* If we&squot;re down, resume when we are upped.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_wakeup
c_func
(paren
id|tp
comma
id|WaitNoSleep
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: critical: could not wake up in resume&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_start_runtime
c_func
(paren
id|tp
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: critical: could not start runtime in &quot;
l_string|&quot;resume&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|reset
suffix:semicolon
)brace
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|reset
suffix:colon
id|typhoon_reset
c_func
(paren
id|tp-&gt;ioaddr
comma
id|NoWait
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_suspend
id|typhoon_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
multiline_comment|/* If we&squot;re down, we&squot;re already suspended.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;vlgrp
op_logical_and
id|tp-&gt;wol_events
op_amp
id|TYPHOON_WAKE_MAGIC_PKT
)paren
(brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: cannot do WAKE_MAGIC with VLANS&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;state_lock
)paren
suffix:semicolon
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_stop_runtime
c_func
(paren
id|tp
comma
id|WaitNoSleep
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to stop runtime&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|need_resume
suffix:semicolon
)brace
id|typhoon_free_rx_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
id|typhoon_init_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_boot_3XP
c_func
(paren
id|tp
comma
id|TYPHOON_STATUS_WAITING_FOR_HOST
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to boot sleep image&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|need_resume
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_SET_MAC_ADDRESS
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|cpu_to_le16
c_func
(paren
id|ntohs
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|xp_cmd.parm2
op_assign
id|cpu_to_le32
c_func
(paren
id|ntohl
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to set mac address in suspend&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|need_resume
suffix:semicolon
)brace
id|INIT_COMMAND_NO_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_SET_RX_FILTER
)paren
suffix:semicolon
id|xp_cmd.parm1
op_assign
id|TYPHOON_RX_FILTER_DIRECTED
op_or
id|TYPHOON_RX_FILTER_BROADCAST
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|0
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to set rx filter in suspend&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|need_resume
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_sleep
c_func
(paren
id|tp
comma
id|state
comma
id|tp-&gt;wol_events
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to put card to sleep&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|need_resume
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|need_resume
suffix:colon
id|typhoon_resume
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_static
r_int
DECL|function|typhoon_enable_wake
id|typhoon_enable_wake
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
comma
r_int
id|enable
)paren
(brace
r_return
id|pci_enable_wake
c_func
(paren
id|pdev
comma
id|state
comma
id|enable
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
id|__devinit
DECL|function|typhoon_init_one
id|typhoon_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
id|did_version
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|typhoon
op_star
id|tp
suffix:semicolon
r_int
id|card_id
op_assign
(paren
r_int
)paren
id|ent-&gt;driver_data
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_void
id|__iomem
op_star
id|ioaddr_mapped
suffix:semicolon
r_void
op_star
id|shared
suffix:semicolon
id|dma_addr_t
id|shared_dma
suffix:semicolon
r_struct
id|cmd_desc
id|xp_cmd
suffix:semicolon
r_struct
id|resp_desc
id|xp_resp
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|did_version
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
)brace
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
op_star
id|tp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: unable to alloc new net device&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: unable to enable device&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|error_out_dev
suffix:semicolon
)brace
id|err
op_assign
id|pci_set_mwi
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: unable to set MWI&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|error_out_disable
suffix:semicolon
)brace
id|err
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: No usable DMA configuration&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|error_out_mwi
suffix:semicolon
)brace
multiline_comment|/* sanity checks, resource #1 is our mmio area&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|1
)paren
op_amp
id|IORESOURCE_MEM
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: region #1 not a PCI MMIO resource, aborting&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error_out_mwi
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
OL
l_int|128
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: Invalid PCI MMIO region size, aborting&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error_out_mwi
suffix:semicolon
)brace
id|err
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;typhoon&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: could not request regions&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|error_out_mwi
suffix:semicolon
)brace
multiline_comment|/* map our MMIO region&n;&t; */
id|ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|ioaddr_mapped
op_assign
id|ioremap
c_func
(paren
id|ioaddr
comma
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr_mapped
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: cannot remap MMIO, aborting&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error_out_regions
suffix:semicolon
)brace
multiline_comment|/* allocate pci dma space for rx and tx descriptor rings&n;&t; */
id|shared
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|typhoon_shared
)paren
comma
op_amp
id|shared_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shared
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: could not allocate DMA memory&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error_out_remap
suffix:semicolon
)brace
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tp-&gt;shared
op_assign
(paren
r_struct
id|typhoon_shared
op_star
)paren
id|shared
suffix:semicolon
id|tp-&gt;shared_dma
op_assign
id|shared_dma
suffix:semicolon
id|tp-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|tp-&gt;tx_pdev
op_assign
id|pdev
suffix:semicolon
id|tp-&gt;ioaddr
op_assign
id|ioaddr_mapped
suffix:semicolon
id|tp-&gt;tx_ioaddr
op_assign
id|ioaddr_mapped
suffix:semicolon
id|tp-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* need to be able to restore PCI state after a suspend */
id|pci_save_state
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* Init sequence:&n;&t; * 1) Reset the adapter to clear any bad juju&n;&t; * 2) Reload the sleep image&n;&t; * 3) Boot the sleep image&n;&t; * 4) Get the hardware address.&n;&t; * 5) Put the card to sleep.&n;&t; */
r_if
c_cond
(paren
id|typhoon_reset
c_func
(paren
id|ioaddr_mapped
comma
id|WaitSleep
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: could not reset 3XP&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error_out_dma
suffix:semicolon
)brace
multiline_comment|/* Now that we&squot;ve reset the 3XP and are sure it&squot;s not going to&n;&t; * write all over memory, enable bus mastering.&n;&t; */
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* dev-&gt;name is not valid until we register, but we need to&n;&t; * use some common routines to initialize the card. So that those&n;&t; * routines print the right name, we keep our oun pointer to the name&n;&t; */
id|tp-&gt;name
op_assign
id|pci_name
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|typhoon_init_interface
c_func
(paren
id|tp
)paren
suffix:semicolon
id|typhoon_init_rings
c_func
(paren
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_boot_3XP
c_func
(paren
id|tp
comma
id|TYPHOON_STATUS_WAITING_FOR_HOST
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: cannot boot 3XP sleep image&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error_out_reset
suffix:semicolon
)brace
id|INIT_COMMAND_WITH_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_READ_MAC_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|1
comma
id|xp_resp
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: cannot read MAC address&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error_out_reset
suffix:semicolon
)brace
op_star
(paren
id|u16
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_assign
id|htons
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|xp_resp
(braket
l_int|0
)braket
dot
id|parm1
)paren
)paren
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
op_amp
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
id|htonl
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|xp_resp
(braket
l_int|0
)braket
dot
id|parm2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_valid_ether_addr
c_func
(paren
id|dev-&gt;dev_addr
)paren
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: Could not obtain valid ethernet address, &quot;
l_string|&quot;aborting&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|error_out_reset
suffix:semicolon
)brace
multiline_comment|/* Read the Sleep Image version last, so the response is valid&n;&t; * later when we print out the version reported.&n;&t; */
id|INIT_COMMAND_WITH_RESPONSE
c_func
(paren
op_amp
id|xp_cmd
comma
id|TYPHOON_CMD_READ_VERSIONS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|typhoon_issue_command
c_func
(paren
id|tp
comma
l_int|1
comma
op_amp
id|xp_cmd
comma
l_int|3
comma
id|xp_resp
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: Could not get Sleep Image version&bslash;n&quot;
comma
id|pdev-&gt;slot_name
)paren
suffix:semicolon
r_goto
id|error_out_reset
suffix:semicolon
)brace
id|tp-&gt;capabilities
op_assign
id|typhoon_card_info
(braket
id|card_id
)braket
dot
id|capabilities
suffix:semicolon
id|tp-&gt;xcvr_select
op_assign
id|TYPHOON_XCVR_AUTONEG
suffix:semicolon
multiline_comment|/* Typhoon 1.0 Sleep Images return one response descriptor to the&n;&t; * READ_VERSIONS command. Those versions are OK after waking up&n;&t; * from sleep without needing a reset. Typhoon 1.1+ Sleep Images&n;&t; * seem to need a little extra help to get started. Since we don&squot;t&n;&t; * know how to nudge it along, just kick it.&n;&t; */
r_if
c_cond
(paren
id|xp_resp
(braket
l_int|0
)braket
dot
id|numDesc
op_ne
l_int|0
)paren
(brace
id|tp-&gt;capabilities
op_or_assign
id|TYPHOON_WAKEUP_NEEDS_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
id|typhoon_sleep
c_func
(paren
id|tp
comma
l_int|3
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|ERR_PFX
l_string|&quot;%s: cannot put adapter to sleep&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error_out_reset
suffix:semicolon
)brace
multiline_comment|/* The chip-specific entries in the device structure. */
id|dev-&gt;open
op_assign
id|typhoon_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|typhoon_start_tx
suffix:semicolon
id|dev-&gt;stop
op_assign
id|typhoon_close
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|typhoon_set_rx_mode
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|typhoon_tx_timeout
suffix:semicolon
id|dev-&gt;poll
op_assign
id|typhoon_poll
suffix:semicolon
id|dev-&gt;weight
op_assign
l_int|16
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|typhoon_get_stats
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|typhoon_set_mac_address
suffix:semicolon
id|dev-&gt;vlan_rx_register
op_assign
id|typhoon_vlan_rx_register
suffix:semicolon
id|dev-&gt;vlan_rx_kill_vid
op_assign
id|typhoon_vlan_rx_kill_vid
suffix:semicolon
id|SET_ETHTOOL_OPS
c_func
(paren
id|dev
comma
op_amp
id|typhoon_ethtool_ops
)paren
suffix:semicolon
multiline_comment|/* We can handle scatter gather, up to 16 entries, and&n;&t; * we can do IP checksumming (only version 4, doh...)&n;&t; */
id|dev-&gt;features
op_or_assign
id|NETIF_F_SG
op_or
id|NETIF_F_IP_CSUM
suffix:semicolon
id|dev-&gt;features
op_or_assign
id|NETIF_F_HW_VLAN_TX
op_or
id|NETIF_F_HW_VLAN_RX
suffix:semicolon
id|dev-&gt;features
op_or_assign
id|NETIF_F_TSO
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
(brace
r_goto
id|error_out_reset
suffix:semicolon
)brace
multiline_comment|/* fixup our local name */
id|tp-&gt;name
op_assign
id|dev-&gt;name
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s at 0x%lx, &quot;
comma
id|dev-&gt;name
comma
id|typhoon_card_info
(braket
id|card_id
)braket
dot
id|name
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%2.2x&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* xp_resp still contains the response to the READ_VERSIONS command.&n;&t; * For debugging, let the user know what version he has.&n;&t; */
r_if
c_cond
(paren
id|xp_resp
(braket
l_int|0
)braket
dot
id|numDesc
op_eq
l_int|0
)paren
(brace
multiline_comment|/* This is the Typhoon 1.0 type Sleep Image, last 16 bits&n;&t;&t; * of version is Month/Day of build.&n;&t;&t; */
id|u16
id|monthday
op_assign
id|le32_to_cpu
c_func
(paren
id|xp_resp
(braket
l_int|0
)braket
dot
id|parm2
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Typhoon 1.0 Sleep Image built &quot;
l_string|&quot;%02u/%02u/2000&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|monthday
op_rshift
l_int|8
comma
id|monthday
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|xp_resp
(braket
l_int|0
)braket
dot
id|numDesc
op_eq
l_int|2
)paren
(brace
multiline_comment|/* This is the Typhoon 1.1+ type Sleep Image&n;&t;&t; */
id|u32
id|sleep_ver
op_assign
id|le32_to_cpu
c_func
(paren
id|xp_resp
(braket
l_int|0
)braket
dot
id|parm2
)paren
suffix:semicolon
id|u8
op_star
id|ver_string
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|xp_resp
(braket
l_int|1
)braket
suffix:semicolon
id|ver_string
(braket
l_int|25
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Typhoon 1.1+ Sleep Image version &quot;
l_string|&quot;%u.%u.%u.%u %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|HIPQUAD
c_func
(paren
id|sleep_ver
)paren
comma
id|ver_string
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unknown Sleep Image version &quot;
l_string|&quot;(%u:%04x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|xp_resp
(braket
l_int|0
)braket
dot
id|numDesc
comma
id|le32_to_cpu
c_func
(paren
id|xp_resp
(braket
l_int|0
)braket
dot
id|parm2
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error_out_reset
suffix:colon
id|typhoon_reset
c_func
(paren
id|ioaddr_mapped
comma
id|NoWait
)paren
suffix:semicolon
id|error_out_dma
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|typhoon_shared
)paren
comma
id|shared
comma
id|shared_dma
)paren
suffix:semicolon
id|error_out_remap
suffix:colon
id|iounmap
c_func
(paren
id|ioaddr_mapped
)paren
suffix:semicolon
id|error_out_regions
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|error_out_mwi
suffix:colon
id|pci_clear_mwi
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|error_out_disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|error_out_dev
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|error_out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
r_static
r_void
id|__devexit
DECL|function|typhoon_remove_one
id|typhoon_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|typhoon
op_star
id|tp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|PCI_D0
)paren
suffix:semicolon
id|pci_restore_state
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|typhoon_reset
c_func
(paren
id|tp-&gt;ioaddr
comma
id|NoWait
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|tp-&gt;ioaddr
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|typhoon_shared
)paren
comma
id|tp-&gt;shared
comma
id|tp-&gt;shared_dma
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_clear_mwi
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|variable|typhoon_driver
r_static
r_struct
id|pci_driver
id|typhoon_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_MODULE_NAME
comma
dot
id|id_table
op_assign
id|typhoon_pci_tbl
comma
dot
id|probe
op_assign
id|typhoon_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|typhoon_remove_one
)paren
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|typhoon_suspend
comma
dot
id|resume
op_assign
id|typhoon_resume
comma
dot
id|enable_wake
op_assign
id|typhoon_enable_wake
comma
macro_line|#endif
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|typhoon_init
id|typhoon_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|typhoon_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|typhoon_cleanup
id|typhoon_cleanup
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|typhoon_driver
)paren
suffix:semicolon
)brace
DECL|variable|typhoon_init
id|module_init
c_func
(paren
id|typhoon_init
)paren
suffix:semicolon
DECL|variable|typhoon_cleanup
id|module_exit
c_func
(paren
id|typhoon_cleanup
)paren
suffix:semicolon
eof
