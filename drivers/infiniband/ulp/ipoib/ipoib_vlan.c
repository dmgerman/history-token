multiline_comment|/*&n; * Copyright (c) 2004 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: ipoib_vlan.c 1349 2004-12-16 21:09:43Z roland $&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;ipoib.h&quot;
DECL|function|show_parent
r_static
id|ssize_t
id|show_parent
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|container_of
c_func
(paren
id|class_dev
comma
r_struct
id|net_device
comma
id|class_dev
)paren
suffix:semicolon
r_struct
id|ipoib_dev_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|priv-&gt;parent-&gt;name
)paren
suffix:semicolon
)brace
r_static
id|CLASS_DEVICE_ATTR
c_func
(paren
id|parent
comma
id|S_IRUGO
comma
id|show_parent
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|ipoib_vlan_add
r_int
id|ipoib_vlan_add
c_func
(paren
r_struct
id|net_device
op_star
id|pdev
comma
r_int
r_int
id|pkey
)paren
(brace
r_struct
id|ipoib_dev_priv
op_star
id|ppriv
comma
op_star
id|priv
suffix:semicolon
r_char
id|intf_name
(braket
id|IFNAMSIZ
)braket
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|ppriv
op_assign
id|netdev_priv
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ppriv-&gt;vlan_mutex
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * First ensure this isn&squot;t a duplicate. We check the parent device and&n;&t; * then all of the child interfaces to make sure the Pkey doesn&squot;t match.&n;&t; */
r_if
c_cond
(paren
id|ppriv-&gt;pkey
op_eq
id|pkey
)paren
(brace
id|result
op_assign
op_minus
id|ENOTUNIQ
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|priv
comma
op_amp
id|ppriv-&gt;child_intfs
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;pkey
op_eq
id|pkey
)paren
(brace
id|result
op_assign
op_minus
id|ENOTUNIQ
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
)brace
id|snprintf
c_func
(paren
id|intf_name
comma
r_sizeof
id|intf_name
comma
l_string|&quot;%s.%04x&quot;
comma
id|ppriv-&gt;dev-&gt;name
comma
id|pkey
)paren
suffix:semicolon
id|priv
op_assign
id|ipoib_intf_alloc
c_func
(paren
id|intf_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
(brace
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|IPOIB_FLAG_SUBINTERFACE
comma
op_amp
id|priv-&gt;flags
)paren
suffix:semicolon
id|priv-&gt;pkey
op_assign
id|pkey
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;dev-&gt;dev_addr
comma
id|ppriv-&gt;dev-&gt;dev_addr
comma
id|INFINIBAND_ALEN
)paren
suffix:semicolon
id|priv-&gt;dev-&gt;broadcast
(braket
l_int|8
)braket
op_assign
id|pkey
op_rshift
l_int|8
suffix:semicolon
id|priv-&gt;dev-&gt;broadcast
(braket
l_int|9
)braket
op_assign
id|pkey
op_amp
l_int|0xff
suffix:semicolon
id|result
op_assign
id|ipoib_dev_init
c_func
(paren
id|priv-&gt;dev
comma
id|ppriv-&gt;ca
comma
id|ppriv-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|ipoib_warn
c_func
(paren
id|ppriv
comma
l_string|&quot;failed to initialize subinterface: &quot;
l_string|&quot;device %s, port %d&quot;
comma
id|ppriv-&gt;ca-&gt;name
comma
id|ppriv-&gt;port
)paren
suffix:semicolon
r_goto
id|device_init_failed
suffix:semicolon
)brace
id|result
op_assign
id|register_netdev
c_func
(paren
id|priv-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;failed to initialize; error %i&quot;
comma
id|result
)paren
suffix:semicolon
r_goto
id|register_failed
suffix:semicolon
)brace
id|priv-&gt;parent
op_assign
id|ppriv-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|ipoib_create_debug_file
c_func
(paren
id|priv-&gt;dev
)paren
)paren
r_goto
id|debug_failed
suffix:semicolon
r_if
c_cond
(paren
id|ipoib_add_pkey_attr
c_func
(paren
id|priv-&gt;dev
)paren
)paren
r_goto
id|sysfs_failed
suffix:semicolon
r_if
c_cond
(paren
id|class_device_create_file
c_func
(paren
op_amp
id|priv-&gt;dev-&gt;class_dev
comma
op_amp
id|class_device_attr_parent
)paren
)paren
r_goto
id|sysfs_failed
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|priv-&gt;list
comma
op_amp
id|ppriv-&gt;child_intfs
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ppriv-&gt;vlan_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|sysfs_failed
suffix:colon
id|ipoib_delete_debug_file
c_func
(paren
id|priv-&gt;dev
)paren
suffix:semicolon
id|debug_failed
suffix:colon
id|unregister_netdev
c_func
(paren
id|priv-&gt;dev
)paren
suffix:semicolon
id|register_failed
suffix:colon
id|ipoib_dev_cleanup
c_func
(paren
id|priv-&gt;dev
)paren
suffix:semicolon
id|device_init_failed
suffix:colon
id|free_netdev
c_func
(paren
id|priv-&gt;dev
)paren
suffix:semicolon
id|err
suffix:colon
id|up
c_func
(paren
op_amp
id|ppriv-&gt;vlan_mutex
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ipoib_vlan_delete
r_int
id|ipoib_vlan_delete
c_func
(paren
r_struct
id|net_device
op_star
id|pdev
comma
r_int
r_int
id|pkey
)paren
(brace
r_struct
id|ipoib_dev_priv
op_star
id|ppriv
comma
op_star
id|priv
comma
op_star
id|tpriv
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|ppriv
op_assign
id|netdev_priv
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ppriv-&gt;vlan_mutex
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|priv
comma
id|tpriv
comma
op_amp
id|ppriv-&gt;child_intfs
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;pkey
op_eq
id|pkey
)paren
(brace
id|unregister_netdev
c_func
(paren
id|priv-&gt;dev
)paren
suffix:semicolon
id|ipoib_dev_cleanup
c_func
(paren
id|priv-&gt;dev
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|priv-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|priv
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|ppriv-&gt;vlan_mutex
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
