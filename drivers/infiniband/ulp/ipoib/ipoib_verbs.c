multiline_comment|/*&n; * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: ipoib_verbs.c 1349 2004-12-16 21:09:43Z roland $&n; */
macro_line|#include &lt;ib_cache.h&gt;
macro_line|#include &quot;ipoib.h&quot;
DECL|function|ipoib_mcast_attach
r_int
id|ipoib_mcast_attach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|mlid
comma
r_union
id|ib_gid
op_star
id|mgid
)paren
(brace
r_struct
id|ipoib_dev_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ib_qp_attr
op_star
id|qp_attr
suffix:semicolon
r_int
id|attr_mask
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u16
id|pkey_index
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|qp_attr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|qp_attr
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qp_attr
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ib_find_cached_pkey
c_func
(paren
id|priv-&gt;ca
comma
id|priv-&gt;port
comma
id|priv-&gt;pkey
comma
op_amp
id|pkey_index
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|IPOIB_PKEY_ASSIGNED
comma
op_amp
id|priv-&gt;flags
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|IPOIB_PKEY_ASSIGNED
comma
op_amp
id|priv-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* set correct QKey for QP */
id|qp_attr-&gt;qkey
op_assign
id|priv-&gt;qkey
suffix:semicolon
id|attr_mask
op_assign
id|IB_QP_QKEY
suffix:semicolon
id|ret
op_assign
id|ib_modify_qp
c_func
(paren
id|priv-&gt;qp
comma
id|qp_attr
comma
id|attr_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;failed to modify QP, ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* attach QP to multicast group */
id|down
c_func
(paren
op_amp
id|priv-&gt;mcast_mutex
)paren
suffix:semicolon
id|ret
op_assign
id|ib_attach_mcast
c_func
(paren
id|priv-&gt;qp
comma
id|mgid
comma
id|mlid
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|priv-&gt;mcast_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;failed to attach to multicast group, ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|qp_attr
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipoib_mcast_detach
r_int
id|ipoib_mcast_detach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u16
id|mlid
comma
r_union
id|ib_gid
op_star
id|mgid
)paren
(brace
r_struct
id|ipoib_dev_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|down
c_func
(paren
op_amp
id|priv-&gt;mcast_mutex
)paren
suffix:semicolon
id|ret
op_assign
id|ib_detach_mcast
c_func
(paren
id|priv-&gt;qp
comma
id|mgid
comma
id|mlid
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|priv-&gt;mcast_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;ib_detach_mcast failed (result = %d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipoib_qp_create
r_int
id|ipoib_qp_create
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ipoib_dev_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u16
id|pkey_index
suffix:semicolon
r_struct
id|ib_qp_attr
id|qp_attr
suffix:semicolon
r_int
id|attr_mask
suffix:semicolon
multiline_comment|/*&n;&t; * Search through the port P_Key table for the requested pkey value.&n;&t; * The port has to be assigned to the respective IB partition in&n;&t; * advance.&n;&t; */
id|ret
op_assign
id|ib_find_cached_pkey
c_func
(paren
id|priv-&gt;ca
comma
id|priv-&gt;port
comma
id|priv-&gt;pkey
comma
op_amp
id|pkey_index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|clear_bit
c_func
(paren
id|IPOIB_PKEY_ASSIGNED
comma
op_amp
id|priv-&gt;flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|IPOIB_PKEY_ASSIGNED
comma
op_amp
id|priv-&gt;flags
)paren
suffix:semicolon
id|qp_attr.qp_state
op_assign
id|IB_QPS_INIT
suffix:semicolon
id|qp_attr.qkey
op_assign
l_int|0
suffix:semicolon
id|qp_attr.port_num
op_assign
id|priv-&gt;port
suffix:semicolon
id|qp_attr.pkey_index
op_assign
id|pkey_index
suffix:semicolon
id|attr_mask
op_assign
id|IB_QP_QKEY
op_or
id|IB_QP_PORT
op_or
id|IB_QP_PKEY_INDEX
op_or
id|IB_QP_STATE
suffix:semicolon
id|ret
op_assign
id|ib_modify_qp
c_func
(paren
id|priv-&gt;qp
comma
op_amp
id|qp_attr
comma
id|attr_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;failed to modify QP to init, ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|qp_attr.qp_state
op_assign
id|IB_QPS_RTR
suffix:semicolon
multiline_comment|/* Can&squot;t set this in a INIT-&gt;RTR transition */
id|attr_mask
op_and_assign
op_complement
id|IB_QP_PORT
suffix:semicolon
id|ret
op_assign
id|ib_modify_qp
c_func
(paren
id|priv-&gt;qp
comma
op_amp
id|qp_attr
comma
id|attr_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;failed to modify QP to RTR, ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|qp_attr.qp_state
op_assign
id|IB_QPS_RTS
suffix:semicolon
id|qp_attr.sq_psn
op_assign
l_int|0
suffix:semicolon
id|attr_mask
op_or_assign
id|IB_QP_SQ_PSN
suffix:semicolon
id|attr_mask
op_and_assign
op_complement
id|IB_QP_PKEY_INDEX
suffix:semicolon
id|ret
op_assign
id|ib_modify_qp
c_func
(paren
id|priv-&gt;qp
comma
op_amp
id|qp_attr
comma
id|attr_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;failed to modify QP to RTS, ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_fail
suffix:colon
id|ib_destroy_qp
c_func
(paren
id|priv-&gt;qp
)paren
suffix:semicolon
id|priv-&gt;qp
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ipoib_transport_dev_init
r_int
id|ipoib_transport_dev_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ib_device
op_star
id|ca
)paren
(brace
r_struct
id|ipoib_dev_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ib_qp_init_attr
id|init_attr
op_assign
(brace
dot
id|cap
op_assign
(brace
dot
id|max_send_wr
op_assign
id|IPOIB_TX_RING_SIZE
comma
dot
id|max_recv_wr
op_assign
id|IPOIB_RX_RING_SIZE
comma
dot
id|max_send_sge
op_assign
l_int|1
comma
dot
id|max_recv_sge
op_assign
l_int|1
)brace
comma
dot
id|sq_sig_type
op_assign
id|IB_SIGNAL_ALL_WR
comma
dot
id|qp_type
op_assign
id|IB_QPT_UD
)brace
suffix:semicolon
id|priv-&gt;pd
op_assign
id|ib_alloc_pd
c_func
(paren
id|priv-&gt;ca
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|priv-&gt;pd
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: failed to allocate PD&bslash;n&quot;
comma
id|ca-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|priv-&gt;cq
op_assign
id|ib_create_cq
c_func
(paren
id|priv-&gt;ca
comma
id|ipoib_ib_completion
comma
l_int|NULL
comma
id|dev
comma
id|IPOIB_TX_RING_SIZE
op_plus
id|IPOIB_RX_RING_SIZE
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|priv-&gt;cq
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: failed to create CQ&bslash;n&quot;
comma
id|ca-&gt;name
)paren
suffix:semicolon
r_goto
id|out_free_pd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ib_req_notify_cq
c_func
(paren
id|priv-&gt;cq
comma
id|IB_CQ_NEXT_COMP
)paren
)paren
r_goto
id|out_free_cq
suffix:semicolon
id|priv-&gt;mr
op_assign
id|ib_get_dma_mr
c_func
(paren
id|priv-&gt;pd
comma
id|IB_ACCESS_LOCAL_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|priv-&gt;mr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: ib_get_dma_mr failed&bslash;n&quot;
comma
id|ca-&gt;name
)paren
suffix:semicolon
r_goto
id|out_free_cq
suffix:semicolon
)brace
id|init_attr.send_cq
op_assign
id|priv-&gt;cq
suffix:semicolon
id|init_attr.recv_cq
op_assign
id|priv-&gt;cq
comma
id|priv-&gt;qp
op_assign
id|ib_create_qp
c_func
(paren
id|priv-&gt;pd
comma
op_amp
id|init_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|priv-&gt;qp
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: failed to create QP&bslash;n&quot;
comma
id|ca-&gt;name
)paren
suffix:semicolon
r_goto
id|out_free_mr
suffix:semicolon
)brace
id|priv-&gt;dev-&gt;dev_addr
(braket
l_int|1
)braket
op_assign
(paren
id|priv-&gt;qp-&gt;qp_num
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|priv-&gt;dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
(paren
id|priv-&gt;qp-&gt;qp_num
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|priv-&gt;dev-&gt;dev_addr
(braket
l_int|3
)braket
op_assign
(paren
id|priv-&gt;qp-&gt;qp_num
)paren
op_amp
l_int|0xff
suffix:semicolon
id|priv-&gt;tx_sge.lkey
op_assign
id|priv-&gt;mr-&gt;lkey
suffix:semicolon
id|priv-&gt;tx_wr.opcode
op_assign
id|IB_WR_SEND
suffix:semicolon
id|priv-&gt;tx_wr.sg_list
op_assign
op_amp
id|priv-&gt;tx_sge
suffix:semicolon
id|priv-&gt;tx_wr.num_sge
op_assign
l_int|1
suffix:semicolon
id|priv-&gt;tx_wr.send_flags
op_assign
id|IB_SEND_SIGNALED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free_mr
suffix:colon
id|ib_dereg_mr
c_func
(paren
id|priv-&gt;mr
)paren
suffix:semicolon
id|out_free_cq
suffix:colon
id|ib_destroy_cq
c_func
(paren
id|priv-&gt;cq
)paren
suffix:semicolon
id|out_free_pd
suffix:colon
id|ib_dealloc_pd
c_func
(paren
id|priv-&gt;pd
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|ipoib_transport_dev_cleanup
r_void
id|ipoib_transport_dev_cleanup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ipoib_dev_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;qp
)paren
(brace
r_if
c_cond
(paren
id|ib_destroy_qp
c_func
(paren
id|priv-&gt;qp
)paren
)paren
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;ib_qp_destroy failed&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;qp
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPOIB_PKEY_ASSIGNED
comma
op_amp
id|priv-&gt;flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ib_dereg_mr
c_func
(paren
id|priv-&gt;mr
)paren
)paren
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;ib_dereg_mr failed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ib_destroy_cq
c_func
(paren
id|priv-&gt;cq
)paren
)paren
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;ib_cq_destroy failed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ib_dealloc_pd
c_func
(paren
id|priv-&gt;pd
)paren
)paren
id|ipoib_warn
c_func
(paren
id|priv
comma
l_string|&quot;ib_dealloc_pd failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ipoib_event
r_void
id|ipoib_event
c_func
(paren
r_struct
id|ib_event_handler
op_star
id|handler
comma
r_struct
id|ib_event
op_star
id|record
)paren
(brace
r_struct
id|ipoib_dev_priv
op_star
id|priv
op_assign
id|container_of
c_func
(paren
id|handler
comma
r_struct
id|ipoib_dev_priv
comma
id|event_handler
)paren
suffix:semicolon
r_if
c_cond
(paren
id|record-&gt;event
op_eq
id|IB_EVENT_PORT_ACTIVE
op_logical_or
id|record-&gt;event
op_eq
id|IB_EVENT_LID_CHANGE
op_logical_or
id|record-&gt;event
op_eq
id|IB_EVENT_SM_CHANGE
)paren
(brace
id|ipoib_dbg
c_func
(paren
id|priv
comma
l_string|&quot;Port active event&bslash;n&quot;
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|priv-&gt;flush_task
)paren
suffix:semicolon
)brace
)brace
eof
