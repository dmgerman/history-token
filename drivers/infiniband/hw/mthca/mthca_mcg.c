multiline_comment|/*&n; * Copyright (c) 2004 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: mthca_mcg.c 1349 2004-12-16 21:09:43Z roland $&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;mthca_dev.h&quot;
macro_line|#include &quot;mthca_cmd.h&quot;
r_enum
(brace
DECL|enumerator|MTHCA_QP_PER_MGM
id|MTHCA_QP_PER_MGM
op_assign
l_int|4
op_star
(paren
id|MTHCA_MGM_ENTRY_SIZE
op_div
l_int|16
op_minus
l_int|2
)paren
)brace
suffix:semicolon
DECL|struct|mthca_mgm
r_struct
id|mthca_mgm
(brace
DECL|member|next_gid_index
id|u32
id|next_gid_index
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|gid
id|u8
id|gid
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|qp
id|u32
id|qp
(braket
id|MTHCA_QP_PER_MGM
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|zero_gid
r_static
r_const
id|u8
id|zero_gid
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* automatically initialized to 0 */
multiline_comment|/*&n; * Caller must hold MCG table semaphore.  gid and mgm parameters must&n; * be properly aligned for command interface.&n; *&n; *  Returns 0 unless a firmware command error occurs.&n; *&n; * If GID is found in MGM or MGM is empty, *index = *hash, *prev = -1&n; * and *mgm holds MGM entry.&n; *&n; * if GID is found in AMGM, *index = index in AMGM, *prev = index of&n; * previous entry in hash chain and *mgm holds AMGM entry.&n; *&n; * If no AMGM exists for given gid, *index = -1, *prev = index of last&n; * entry in hash chain and *mgm holds end of hash chain.&n; */
DECL|function|find_mgm
r_static
r_int
id|find_mgm
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
id|u8
op_star
id|gid
comma
r_struct
id|mthca_mgm
op_star
id|mgm
comma
id|u16
op_star
id|hash
comma
r_int
op_star
id|prev
comma
r_int
op_star
id|index
)paren
(brace
r_void
op_star
id|mailbox
suffix:semicolon
id|u8
op_star
id|mgid
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|mailbox
op_assign
id|kmalloc
c_func
(paren
l_int|16
op_plus
id|MTHCA_CMD_MAILBOX_EXTRA
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mailbox
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|mgid
op_assign
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mgid
comma
id|gid
comma
l_int|16
)paren
suffix:semicolon
id|err
op_assign
id|mthca_MGID_HASH
c_func
(paren
id|dev
comma
id|mgid
comma
id|hash
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;MGID_HASH returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
)paren
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;Hash for %04x:%04x:%04x:%04x:&quot;
l_string|&quot;%04x:%04x:%04x:%04x is %04x&bslash;n&quot;
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid
)paren
(braket
l_int|0
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid
)paren
(braket
l_int|1
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid
)paren
(braket
l_int|2
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid
)paren
(braket
l_int|3
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid
)paren
(braket
l_int|4
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid
)paren
(braket
l_int|5
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid
)paren
(braket
l_int|6
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid
)paren
(braket
l_int|7
)braket
)paren
comma
op_star
id|hash
)paren
suffix:semicolon
op_star
id|index
op_assign
op_star
id|hash
suffix:semicolon
op_star
id|prev
op_assign
op_minus
l_int|1
suffix:semicolon
r_do
(brace
id|err
op_assign
id|mthca_READ_MGM
c_func
(paren
id|dev
comma
op_star
id|index
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;READ_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|mgm-&gt;gid
comma
id|zero_gid
comma
l_int|16
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
id|index
op_ne
op_star
id|hash
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Found zero MGID in AMGM.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|mgm-&gt;gid
comma
id|gid
comma
l_int|16
)paren
)paren
r_goto
id|out
suffix:semicolon
op_star
id|prev
op_assign
op_star
id|index
suffix:semicolon
op_star
id|index
op_assign
id|be32_to_cpu
c_func
(paren
id|mgm-&gt;next_gid_index
)paren
op_rshift
l_int|5
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|index
)paren
suffix:semicolon
op_star
id|index
op_assign
op_minus
l_int|1
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_multicast_attach
r_int
id|mthca_multicast_attach
c_func
(paren
r_struct
id|ib_qp
op_star
id|ibqp
comma
r_union
id|ib_gid
op_star
id|gid
comma
id|u16
id|lid
)paren
(brace
r_struct
id|mthca_dev
op_star
id|dev
op_assign
id|to_mdev
c_func
(paren
id|ibqp-&gt;device
)paren
suffix:semicolon
r_void
op_star
id|mailbox
suffix:semicolon
r_struct
id|mthca_mgm
op_star
id|mgm
suffix:semicolon
id|u16
id|hash
suffix:semicolon
r_int
id|index
comma
id|prev
suffix:semicolon
r_int
id|link
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|mailbox
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|mgm
op_plus
id|MTHCA_CMD_MAILBOX_EXTRA
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mailbox
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|mgm
op_assign
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|dev-&gt;mcg_table.sem
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|err
op_assign
id|find_mgm
c_func
(paren
id|dev
comma
id|gid-&gt;raw
comma
id|mgm
comma
op_amp
id|hash
comma
op_amp
id|prev
comma
op_amp
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|index
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|mgm-&gt;gid
comma
id|zero_gid
comma
l_int|16
)paren
)paren
id|memcpy
c_func
(paren
id|mgm-&gt;gid
comma
id|gid-&gt;raw
comma
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|link
op_assign
l_int|1
suffix:semicolon
id|index
op_assign
id|mthca_alloc
c_func
(paren
op_amp
id|dev-&gt;mcg_table.alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
op_minus
l_int|1
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;No AMGM entries left&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|mthca_READ_MGM
c_func
(paren
id|dev
comma
id|index
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;READ_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|mgm-&gt;gid
comma
id|gid-&gt;raw
comma
l_int|16
)paren
suffix:semicolon
id|mgm-&gt;next_gid_index
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MTHCA_QP_PER_MGM
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|mgm-&gt;qp
(braket
id|i
)braket
op_amp
id|cpu_to_be32
c_func
(paren
l_int|1
op_lshift
l_int|31
)paren
)paren
)paren
(brace
id|mgm-&gt;qp
(braket
id|i
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|ibqp-&gt;qp_num
op_or
(paren
l_int|1
op_lshift
l_int|31
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|MTHCA_QP_PER_MGM
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;MGM at index %x is full.&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|mthca_WRITE_MGM
c_func
(paren
id|dev
comma
id|index
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;WRITE_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
id|mthca_READ_MGM
c_func
(paren
id|dev
comma
id|prev
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;READ_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mgm-&gt;next_gid_index
op_assign
id|cpu_to_be32
c_func
(paren
id|index
op_lshift
l_int|5
)paren
suffix:semicolon
id|err
op_assign
id|mthca_WRITE_MGM
c_func
(paren
id|dev
comma
id|prev
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;WRITE_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|dev-&gt;mcg_table.sem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_multicast_detach
r_int
id|mthca_multicast_detach
c_func
(paren
r_struct
id|ib_qp
op_star
id|ibqp
comma
r_union
id|ib_gid
op_star
id|gid
comma
id|u16
id|lid
)paren
(brace
r_struct
id|mthca_dev
op_star
id|dev
op_assign
id|to_mdev
c_func
(paren
id|ibqp-&gt;device
)paren
suffix:semicolon
r_void
op_star
id|mailbox
suffix:semicolon
r_struct
id|mthca_mgm
op_star
id|mgm
suffix:semicolon
id|u16
id|hash
suffix:semicolon
r_int
id|prev
comma
id|index
suffix:semicolon
r_int
id|i
comma
id|loc
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|mailbox
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|mgm
op_plus
id|MTHCA_CMD_MAILBOX_EXTRA
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mailbox
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|mgm
op_assign
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|dev-&gt;mcg_table.sem
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|err
op_assign
id|find_mgm
c_func
(paren
id|dev
comma
id|gid-&gt;raw
comma
id|mgm
comma
op_amp
id|hash
comma
op_amp
id|prev
comma
op_amp
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
op_minus
l_int|1
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;MGID %04x:%04x:%04x:%04x:%04x:%04x:%04x:%04x &quot;
l_string|&quot;not found&bslash;n&quot;
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid-&gt;raw
)paren
(braket
l_int|0
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid-&gt;raw
)paren
(braket
l_int|1
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid-&gt;raw
)paren
(braket
l_int|2
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid-&gt;raw
)paren
(braket
l_int|3
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid-&gt;raw
)paren
(braket
l_int|4
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid-&gt;raw
)paren
(braket
l_int|5
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid-&gt;raw
)paren
(braket
l_int|6
)braket
)paren
comma
id|be16_to_cpu
c_func
(paren
(paren
(paren
id|u16
op_star
)paren
id|gid-&gt;raw
)paren
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|loc
op_assign
op_minus
l_int|1
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MTHCA_QP_PER_MGM
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|mgm-&gt;qp
(braket
id|i
)braket
op_eq
id|cpu_to_be32
c_func
(paren
id|ibqp-&gt;qp_num
op_or
(paren
l_int|1
op_lshift
l_int|31
)paren
)paren
)paren
id|loc
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mgm-&gt;qp
(braket
id|i
)braket
op_amp
id|cpu_to_be32
c_func
(paren
l_int|1
op_lshift
l_int|31
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|loc
op_eq
op_minus
l_int|1
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;QP %06x not found in MGM&bslash;n&quot;
comma
id|ibqp-&gt;qp_num
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mgm-&gt;qp
(braket
id|loc
)braket
op_assign
id|mgm-&gt;qp
(braket
id|i
op_minus
l_int|1
)braket
suffix:semicolon
id|mgm-&gt;qp
(braket
id|i
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|mthca_WRITE_MGM
c_func
(paren
id|dev
comma
id|index
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;WRITE_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
l_int|1
)paren
r_goto
id|out
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Remove entry from MGM */
r_if
c_cond
(paren
id|be32_to_cpu
c_func
(paren
id|mgm-&gt;next_gid_index
)paren
op_rshift
l_int|5
)paren
(brace
id|err
op_assign
id|mthca_READ_MGM
c_func
(paren
id|dev
comma
id|be32_to_cpu
c_func
(paren
id|mgm-&gt;next_gid_index
)paren
op_rshift
l_int|5
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;READ_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
id|memset
c_func
(paren
id|mgm-&gt;gid
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|err
op_assign
id|mthca_WRITE_MGM
c_func
(paren
id|dev
comma
id|index
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;WRITE_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Remove entry from AMGM */
id|index
op_assign
id|be32_to_cpu
c_func
(paren
id|mgm-&gt;next_gid_index
)paren
op_rshift
l_int|5
suffix:semicolon
id|err
op_assign
id|mthca_READ_MGM
c_func
(paren
id|dev
comma
id|prev
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;READ_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mgm-&gt;next_gid_index
op_assign
id|cpu_to_be32
c_func
(paren
id|index
op_lshift
l_int|5
)paren
suffix:semicolon
id|err
op_assign
id|mthca_WRITE_MGM
c_func
(paren
id|dev
comma
id|prev
comma
id|mgm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;WRITE_MGM returned status %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|dev-&gt;mcg_table.sem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_init_mcg_table
r_int
id|__devinit
id|mthca_init_mcg_table
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|mthca_alloc_init
c_func
(paren
op_amp
id|dev-&gt;mcg_table.alloc
comma
id|dev-&gt;limits.num_amgms
comma
id|dev-&gt;limits.num_amgms
op_minus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|dev-&gt;mcg_table.sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mthca_cleanup_mcg_table
r_void
id|__devexit
id|mthca_cleanup_mcg_table
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
id|mthca_alloc_cleanup
c_func
(paren
op_amp
id|dev-&gt;mcg_table.alloc
)paren
suffix:semicolon
)brace
eof
