multiline_comment|/*&n; * Copyright (c) 2004 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: mthca_av.c 1349 2004-12-16 21:09:43Z roland $&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;ib_verbs.h&gt;
macro_line|#include &lt;ib_cache.h&gt;
macro_line|#include &quot;mthca_dev.h&quot;
DECL|struct|mthca_av
r_struct
id|mthca_av
(brace
DECL|member|port_pd
id|u32
id|port_pd
suffix:semicolon
DECL|member|reserved1
id|u8
id|reserved1
suffix:semicolon
DECL|member|g_slid
id|u8
id|g_slid
suffix:semicolon
DECL|member|dlid
id|u16
id|dlid
suffix:semicolon
DECL|member|reserved2
id|u8
id|reserved2
suffix:semicolon
DECL|member|gid_index
id|u8
id|gid_index
suffix:semicolon
DECL|member|msg_sr
id|u8
id|msg_sr
suffix:semicolon
DECL|member|hop_limit
id|u8
id|hop_limit
suffix:semicolon
DECL|member|sl_tclass_flowlabel
id|u32
id|sl_tclass_flowlabel
suffix:semicolon
DECL|member|dgid
id|u32
id|dgid
(braket
l_int|4
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|mthca_create_ah
r_int
id|mthca_create_ah
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_pd
op_star
id|pd
comma
r_struct
id|ib_ah_attr
op_star
id|ah_attr
comma
r_struct
id|mthca_ah
op_star
id|ah
)paren
(brace
id|u32
id|index
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|mthca_av
op_star
id|av
op_assign
l_int|NULL
suffix:semicolon
id|ah-&gt;type
op_assign
id|MTHCA_AH_PCI_POOL
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;hca_type
op_eq
id|ARBEL_NATIVE
)paren
(brace
id|ah-&gt;av
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|ah-&gt;av
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ah-&gt;av
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ah-&gt;type
op_assign
id|MTHCA_AH_KMALLOC
suffix:semicolon
id|av
op_assign
id|ah-&gt;av
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|pd-&gt;sqp_count
)paren
op_logical_and
op_logical_neg
(paren
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_DDR_HIDDEN
)paren
)paren
(brace
id|index
op_assign
id|mthca_alloc
c_func
(paren
op_amp
id|dev-&gt;av_table.alloc
)paren
suffix:semicolon
multiline_comment|/* fall back to allocate in host memory */
r_if
c_cond
(paren
id|index
op_eq
op_minus
l_int|1
)paren
r_goto
id|on_hca_fail
suffix:semicolon
id|av
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|av
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|av
)paren
r_goto
id|on_hca_fail
suffix:semicolon
id|ah-&gt;type
op_assign
id|MTHCA_AH_ON_HCA
suffix:semicolon
id|ah-&gt;avdma
op_assign
id|dev-&gt;av_table.ddr_av_base
op_plus
id|index
op_star
id|MTHCA_AV_SIZE
suffix:semicolon
)brace
id|on_hca_fail
suffix:colon
r_if
c_cond
(paren
id|ah-&gt;type
op_eq
id|MTHCA_AH_PCI_POOL
)paren
(brace
id|ah-&gt;av
op_assign
id|pci_pool_alloc
c_func
(paren
id|dev-&gt;av_table.pool
comma
id|SLAB_KERNEL
comma
op_amp
id|ah-&gt;avdma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ah-&gt;av
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|av
op_assign
id|ah-&gt;av
suffix:semicolon
)brace
id|ah-&gt;key
op_assign
id|pd-&gt;ntmr.ibmr.lkey
suffix:semicolon
id|memset
c_func
(paren
id|av
comma
l_int|0
comma
id|MTHCA_AV_SIZE
)paren
suffix:semicolon
id|av-&gt;port_pd
op_assign
id|cpu_to_be32
c_func
(paren
id|pd-&gt;pd_num
op_or
(paren
id|ah_attr-&gt;port_num
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|av-&gt;g_slid
op_assign
id|ah_attr-&gt;src_path_bits
suffix:semicolon
id|av-&gt;dlid
op_assign
id|cpu_to_be16
c_func
(paren
id|ah_attr-&gt;dlid
)paren
suffix:semicolon
id|av-&gt;msg_sr
op_assign
(paren
l_int|3
op_lshift
l_int|4
)paren
op_or
multiline_comment|/* 2K message */
id|ah_attr-&gt;static_rate
suffix:semicolon
id|av-&gt;sl_tclass_flowlabel
op_assign
id|cpu_to_be32
c_func
(paren
id|ah_attr-&gt;sl
op_lshift
l_int|28
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ah_attr-&gt;ah_flags
op_amp
id|IB_AH_GRH
)paren
(brace
id|av-&gt;g_slid
op_or_assign
l_int|0x80
suffix:semicolon
id|av-&gt;gid_index
op_assign
(paren
id|ah_attr-&gt;port_num
op_minus
l_int|1
)paren
op_star
id|dev-&gt;limits.gid_table_len
op_plus
id|ah_attr-&gt;grh.sgid_index
suffix:semicolon
id|av-&gt;hop_limit
op_assign
id|ah_attr-&gt;grh.hop_limit
suffix:semicolon
id|av-&gt;sl_tclass_flowlabel
op_or_assign
id|cpu_to_be32
c_func
(paren
(paren
id|ah_attr-&gt;grh.traffic_class
op_lshift
l_int|20
)paren
op_or
id|ah_attr-&gt;grh.flow_label
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|av-&gt;dgid
comma
id|ah_attr-&gt;grh.dgid.raw
comma
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Arbel workaround -- low byte of GID must be 2 */
id|av-&gt;dgid
(braket
l_int|3
)braket
op_assign
id|cpu_to_be32
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
)paren
(brace
r_int
id|j
suffix:semicolon
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;Created UDAV at %p/%08lx:&bslash;n&quot;
comma
id|av
comma
(paren
r_int
r_int
)paren
id|ah-&gt;avdma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
op_increment
id|j
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  [%2x] %08x&bslash;n&quot;
comma
id|j
op_star
l_int|4
comma
id|be32_to_cpu
c_func
(paren
(paren
(paren
id|u32
op_star
)paren
id|av
)paren
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ah-&gt;type
op_eq
id|MTHCA_AH_ON_HCA
)paren
(brace
id|memcpy_toio
c_func
(paren
id|dev-&gt;av_table.av_map
op_plus
id|index
op_star
id|MTHCA_AV_SIZE
comma
id|av
comma
id|MTHCA_AV_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|av
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mthca_destroy_ah
r_int
id|mthca_destroy_ah
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_ah
op_star
id|ah
)paren
(brace
r_switch
c_cond
(paren
id|ah-&gt;type
)paren
(brace
r_case
id|MTHCA_AH_ON_HCA
suffix:colon
id|mthca_free
c_func
(paren
op_amp
id|dev-&gt;av_table.alloc
comma
(paren
id|ah-&gt;avdma
op_minus
id|dev-&gt;av_table.ddr_av_base
)paren
op_div
id|MTHCA_AV_SIZE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_AH_PCI_POOL
suffix:colon
id|pci_pool_free
c_func
(paren
id|dev-&gt;av_table.pool
comma
id|ah-&gt;av
comma
id|ah-&gt;avdma
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_AH_KMALLOC
suffix:colon
id|kfree
c_func
(paren
id|ah-&gt;av
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mthca_read_ah
r_int
id|mthca_read_ah
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_ah
op_star
id|ah
comma
r_struct
id|ib_ud_header
op_star
id|header
)paren
(brace
r_if
c_cond
(paren
id|ah-&gt;type
op_eq
id|MTHCA_AH_ON_HCA
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|header-&gt;lrh.service_level
op_assign
id|be32_to_cpu
c_func
(paren
id|ah-&gt;av-&gt;sl_tclass_flowlabel
)paren
op_rshift
l_int|28
suffix:semicolon
id|header-&gt;lrh.destination_lid
op_assign
id|ah-&gt;av-&gt;dlid
suffix:semicolon
id|header-&gt;lrh.source_lid
op_assign
id|ah-&gt;av-&gt;g_slid
op_amp
l_int|0x7f
suffix:semicolon
r_if
c_cond
(paren
id|ah-&gt;av-&gt;g_slid
op_amp
l_int|0x80
)paren
(brace
id|header-&gt;grh_present
op_assign
l_int|1
suffix:semicolon
id|header-&gt;grh.traffic_class
op_assign
(paren
id|be32_to_cpu
c_func
(paren
id|ah-&gt;av-&gt;sl_tclass_flowlabel
)paren
op_rshift
l_int|20
)paren
op_amp
l_int|0xff
suffix:semicolon
id|header-&gt;grh.flow_label
op_assign
id|ah-&gt;av-&gt;sl_tclass_flowlabel
op_amp
id|cpu_to_be32
c_func
(paren
l_int|0xfffff
)paren
suffix:semicolon
id|ib_get_cached_gid
c_func
(paren
op_amp
id|dev-&gt;ib_dev
comma
id|be32_to_cpu
c_func
(paren
id|ah-&gt;av-&gt;port_pd
)paren
op_rshift
l_int|24
comma
id|ah-&gt;av-&gt;gid_index
comma
op_amp
id|header-&gt;grh.source_gid
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|header-&gt;grh.destination_gid.raw
comma
id|ah-&gt;av-&gt;dgid
comma
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|header-&gt;grh_present
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mthca_init_av_table
r_int
id|__devinit
id|mthca_init_av_table
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;hca_type
op_eq
id|ARBEL_NATIVE
)paren
r_return
l_int|0
suffix:semicolon
id|err
op_assign
id|mthca_alloc_init
c_func
(paren
op_amp
id|dev-&gt;av_table.alloc
comma
id|dev-&gt;av_table.num_ddr_avs
comma
id|dev-&gt;av_table.num_ddr_avs
op_minus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|dev-&gt;av_table.pool
op_assign
id|pci_pool_create
c_func
(paren
l_string|&quot;mthca_av&quot;
comma
id|dev-&gt;pdev
comma
id|MTHCA_AV_SIZE
comma
id|MTHCA_AV_SIZE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;av_table.pool
)paren
r_goto
id|out_free_alloc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_DDR_HIDDEN
)paren
)paren
(brace
id|dev-&gt;av_table.av_map
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|dev-&gt;pdev
comma
l_int|4
)paren
op_plus
id|dev-&gt;av_table.ddr_av_base
op_minus
id|dev-&gt;ddr_start
comma
id|dev-&gt;av_table.num_ddr_avs
op_star
id|MTHCA_AV_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;av_table.av_map
)paren
r_goto
id|out_free_pool
suffix:semicolon
)brace
r_else
id|dev-&gt;av_table.av_map
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free_pool
suffix:colon
id|pci_pool_destroy
c_func
(paren
id|dev-&gt;av_table.pool
)paren
suffix:semicolon
id|out_free_alloc
suffix:colon
id|mthca_alloc_cleanup
c_func
(paren
op_amp
id|dev-&gt;av_table.alloc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|mthca_cleanup_av_table
r_void
id|__devexit
id|mthca_cleanup_av_table
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;hca_type
op_eq
id|ARBEL_NATIVE
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;av_table.av_map
)paren
id|iounmap
c_func
(paren
id|dev-&gt;av_table.av_map
)paren
suffix:semicolon
id|pci_pool_destroy
c_func
(paren
id|dev-&gt;av_table.pool
)paren
suffix:semicolon
id|mthca_alloc_cleanup
c_func
(paren
op_amp
id|dev-&gt;av_table.alloc
)paren
suffix:semicolon
)brace
eof
