multiline_comment|/*&n; * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: mthca_main.c 1396 2004-12-28 04:10:27Z roland $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#ifdef CONFIG_INFINIBAND_MTHCA_SSE_DOORBELL
macro_line|#include &lt;asm/cpufeature.h&gt;
macro_line|#endif
macro_line|#include &quot;mthca_dev.h&quot;
macro_line|#include &quot;mthca_config_reg.h&quot;
macro_line|#include &quot;mthca_cmd.h&quot;
macro_line|#include &quot;mthca_profile.h&quot;
macro_line|#include &quot;mthca_memfree.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Roland Dreier&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Mellanox InfiniBand HCA low-level driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
DECL|variable|DRV_VERSION
id|MODULE_VERSION
c_func
(paren
id|DRV_VERSION
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PCI_MSI
DECL|variable|msi_x
r_static
r_int
id|msi_x
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|msi_x
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|msi_x
comma
l_string|&quot;attempt to use MSI-X if nonzero&quot;
)paren
suffix:semicolon
DECL|variable|msi
r_static
r_int
id|msi
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|msi
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|msi
comma
l_string|&quot;attempt to use MSI if nonzero&quot;
)paren
suffix:semicolon
macro_line|#else /* CONFIG_PCI_MSI */
DECL|macro|msi_x
mdefine_line|#define msi_x (0)
DECL|macro|msi
mdefine_line|#define msi   (0)
macro_line|#endif /* CONFIG_PCI_MSI */
DECL|variable|__devinitdata
r_static
r_const
r_char
id|mthca_version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;ib_mthca: Mellanox InfiniBand HCA driver v&quot;
id|DRV_VERSION
l_string|&quot; (&quot;
id|DRV_RELDATE
l_string|&quot;)&bslash;n&quot;
suffix:semicolon
DECL|variable|default_profile
r_static
r_struct
id|mthca_profile
id|default_profile
op_assign
(brace
dot
id|num_qp
op_assign
l_int|1
op_lshift
l_int|16
comma
dot
id|rdb_per_qp
op_assign
l_int|4
comma
dot
id|num_cq
op_assign
l_int|1
op_lshift
l_int|16
comma
dot
id|num_mcg
op_assign
l_int|1
op_lshift
l_int|13
comma
dot
id|num_mpt
op_assign
l_int|1
op_lshift
l_int|17
comma
dot
id|num_mtt
op_assign
l_int|1
op_lshift
l_int|20
comma
dot
id|num_udav
op_assign
l_int|1
op_lshift
l_int|15
comma
multiline_comment|/* Tavor only */
dot
id|uarc_size
op_assign
l_int|1
op_lshift
l_int|18
comma
multiline_comment|/* Arbel only */
)brace
suffix:semicolon
DECL|function|mthca_tune_pci
r_static
r_int
id|__devinit
id|mthca_tune_pci
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
)paren
(brace
r_int
id|cap
suffix:semicolon
id|u16
id|val
suffix:semicolon
multiline_comment|/* First try to max out Read Byte Count */
id|cap
op_assign
id|pci_find_capability
c_func
(paren
id|mdev-&gt;pdev
comma
id|PCI_CAP_ID_PCIX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cap
)paren
(brace
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|mdev-&gt;pdev
comma
id|cap
op_plus
id|PCI_X_CMD
comma
op_amp
id|val
)paren
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t read PCI-X command register, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|val
op_assign
(paren
id|val
op_amp
op_complement
id|PCI_X_CMD_MAX_READ
)paren
op_or
(paren
l_int|3
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_word
c_func
(paren
id|mdev-&gt;pdev
comma
id|cap
op_plus
id|PCI_X_CMD
comma
id|val
)paren
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t write PCI-X command register, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|mdev-&gt;hca_type
op_eq
id|TAVOR
)paren
id|mthca_info
c_func
(paren
id|mdev
comma
l_string|&quot;No PCI-X capability, not setting RBC.&bslash;n&quot;
)paren
suffix:semicolon
id|cap
op_assign
id|pci_find_capability
c_func
(paren
id|mdev-&gt;pdev
comma
id|PCI_CAP_ID_EXP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cap
)paren
(brace
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|mdev-&gt;pdev
comma
id|cap
op_plus
id|PCI_EXP_DEVCTL
comma
op_amp
id|val
)paren
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t read PCI Express device control &quot;
l_string|&quot;register, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|val
op_assign
(paren
id|val
op_amp
op_complement
id|PCI_EXP_DEVCTL_READRQ
)paren
op_or
(paren
l_int|5
op_lshift
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_word
c_func
(paren
id|mdev-&gt;pdev
comma
id|cap
op_plus
id|PCI_EXP_DEVCTL
comma
id|val
)paren
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t write PCI Express device control &quot;
l_string|&quot;register, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|mdev-&gt;hca_type
op_eq
id|ARBEL_NATIVE
op_logical_or
id|mdev-&gt;hca_type
op_eq
id|ARBEL_COMPAT
)paren
id|mthca_info
c_func
(paren
id|mdev
comma
l_string|&quot;No PCI Express capability, &quot;
l_string|&quot;not setting Max Read Request Size.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mthca_dev_lim
r_static
r_int
id|__devinit
id|mthca_dev_lim
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
comma
r_struct
id|mthca_dev_lim
op_star
id|dev_lim
)paren
(brace
r_int
id|err
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|err
op_assign
id|mthca_QUERY_DEV_LIM
c_func
(paren
id|mdev
comma
id|dev_lim
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_DEV_LIM command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_DEV_LIM returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_lim-&gt;min_page_sz
OG
id|PAGE_SIZE
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;HCA minimum page size of %d bigger than &quot;
l_string|&quot;kernel PAGE_SIZE of %ld, aborting.&bslash;n&quot;
comma
id|dev_lim-&gt;min_page_sz
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_lim-&gt;num_ports
OG
id|MTHCA_MAX_PORTS
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;HCA has %d ports, but we only support %d, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|dev_lim-&gt;num_ports
comma
id|MTHCA_MAX_PORTS
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|mdev-&gt;limits.num_ports
op_assign
id|dev_lim-&gt;num_ports
suffix:semicolon
id|mdev-&gt;limits.vl_cap
op_assign
id|dev_lim-&gt;max_vl
suffix:semicolon
id|mdev-&gt;limits.mtu_cap
op_assign
id|dev_lim-&gt;max_mtu
suffix:semicolon
id|mdev-&gt;limits.gid_table_len
op_assign
id|dev_lim-&gt;max_gids
suffix:semicolon
id|mdev-&gt;limits.pkey_table_len
op_assign
id|dev_lim-&gt;max_pkeys
suffix:semicolon
id|mdev-&gt;limits.local_ca_ack_delay
op_assign
id|dev_lim-&gt;local_ca_ack_delay
suffix:semicolon
id|mdev-&gt;limits.max_sg
op_assign
id|dev_lim-&gt;max_sg
suffix:semicolon
id|mdev-&gt;limits.reserved_qps
op_assign
id|dev_lim-&gt;reserved_qps
suffix:semicolon
id|mdev-&gt;limits.reserved_srqs
op_assign
id|dev_lim-&gt;reserved_srqs
suffix:semicolon
id|mdev-&gt;limits.reserved_eecs
op_assign
id|dev_lim-&gt;reserved_eecs
suffix:semicolon
id|mdev-&gt;limits.reserved_cqs
op_assign
id|dev_lim-&gt;reserved_cqs
suffix:semicolon
id|mdev-&gt;limits.reserved_eqs
op_assign
id|dev_lim-&gt;reserved_eqs
suffix:semicolon
id|mdev-&gt;limits.reserved_mtts
op_assign
id|dev_lim-&gt;reserved_mtts
suffix:semicolon
id|mdev-&gt;limits.reserved_mrws
op_assign
id|dev_lim-&gt;reserved_mrws
suffix:semicolon
id|mdev-&gt;limits.reserved_uars
op_assign
id|dev_lim-&gt;reserved_uars
suffix:semicolon
id|mdev-&gt;limits.reserved_pds
op_assign
id|dev_lim-&gt;reserved_pds
suffix:semicolon
r_if
c_cond
(paren
id|dev_lim-&gt;flags
op_amp
id|DEV_LIM_FLAG_SRQ
)paren
id|mdev-&gt;mthca_flags
op_or_assign
id|MTHCA_FLAG_SRQ
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mthca_init_tavor
r_static
r_int
id|__devinit
id|mthca_init_tavor
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
)paren
(brace
id|u8
id|status
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|mthca_dev_lim
id|dev_lim
suffix:semicolon
r_struct
id|mthca_profile
id|profile
suffix:semicolon
r_struct
id|mthca_init_hca_param
id|init_hca
suffix:semicolon
r_struct
id|mthca_adapter
id|adapter
suffix:semicolon
id|err
op_assign
id|mthca_SYS_EN
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;SYS_EN command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;SYS_EN returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|mthca_QUERY_FW
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_FW command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_FW returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
id|err
op_assign
id|mthca_QUERY_DDR
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_DDR command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_DDR returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
id|err
op_assign
id|mthca_dev_lim
c_func
(paren
id|mdev
comma
op_amp
id|dev_lim
)paren
suffix:semicolon
id|profile
op_assign
id|default_profile
suffix:semicolon
id|profile.num_uar
op_assign
id|dev_lim.uar_size
op_div
id|PAGE_SIZE
suffix:semicolon
id|profile.uarc_size
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|mthca_make_profile
c_func
(paren
id|mdev
comma
op_amp
id|profile
comma
op_amp
id|dev_lim
comma
op_amp
id|init_hca
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|err_disable
suffix:semicolon
id|err
op_assign
id|mthca_INIT_HCA
c_func
(paren
id|mdev
comma
op_amp
id|init_hca
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;INIT_HCA command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;INIT_HCA returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
id|err
op_assign
id|mthca_QUERY_ADAPTER
c_func
(paren
id|mdev
comma
op_amp
id|adapter
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_ADAPTER command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_close
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_ADAPTER returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_close
suffix:semicolon
)brace
id|mdev-&gt;eq_table.inta_pin
op_assign
id|adapter.inta_pin
suffix:semicolon
id|mdev-&gt;rev_id
op_assign
id|adapter.revision_id
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_close
suffix:colon
id|mthca_CLOSE_HCA
c_func
(paren
id|mdev
comma
l_int|0
comma
op_amp
id|status
)paren
suffix:semicolon
id|err_disable
suffix:colon
id|mthca_SYS_DIS
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_load_fw
r_static
r_int
id|__devinit
id|mthca_load_fw
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
)paren
(brace
id|u8
id|status
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* FIXME: use HCA-attached memory for FW if present */
id|mdev-&gt;fw.arbel.fw_icm
op_assign
id|mthca_alloc_icm
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.fw_pages
comma
id|GFP_HIGHUSER
op_or
id|__GFP_NOWARN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;fw.arbel.fw_icm
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t allocate FW area, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|err
op_assign
id|mthca_MAP_FA
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.fw_icm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;MAP_FA command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_free
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;MAP_FA returned status 0x%02x, aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_free
suffix:semicolon
)brace
id|err
op_assign
id|mthca_RUN_FW
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;RUN_FW command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_unmap_fa
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;RUN_FW returned status 0x%02x, aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_unmap_fa
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_unmap_fa
suffix:colon
id|mthca_UNMAP_FA
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
id|err_free
suffix:colon
id|mthca_free_icm
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.fw_icm
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_init_icm
r_static
r_int
id|__devinit
id|mthca_init_icm
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
comma
r_struct
id|mthca_dev_lim
op_star
id|dev_lim
comma
r_struct
id|mthca_init_hca_param
op_star
id|init_hca
comma
id|u64
id|icm_size
)paren
(brace
id|u64
id|aux_pages
suffix:semicolon
id|u8
id|status
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|mthca_SET_ICM_SIZE
c_func
(paren
id|mdev
comma
id|icm_size
comma
op_amp
id|aux_pages
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;SET_ICM_SIZE command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;SET_ICM_SIZE returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|mthca_dbg
c_func
(paren
id|mdev
comma
l_string|&quot;%lld KB of HCA context requires %lld KB aux memory.&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|icm_size
op_rshift
l_int|10
comma
(paren
r_int
r_int
r_int
)paren
id|aux_pages
op_lshift
l_int|2
)paren
suffix:semicolon
id|mdev-&gt;fw.arbel.aux_icm
op_assign
id|mthca_alloc_icm
c_func
(paren
id|mdev
comma
id|aux_pages
comma
id|GFP_HIGHUSER
op_or
id|__GFP_NOWARN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;fw.arbel.aux_icm
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t allocate aux memory, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|err
op_assign
id|mthca_MAP_ICM_AUX
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.aux_icm
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;MAP_ICM_AUX command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_free_aux
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;MAP_ICM_AUX returned status 0x%02x, aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_free_aux
suffix:semicolon
)brace
id|err
op_assign
id|mthca_map_eq_icm
c_func
(paren
id|mdev
comma
id|init_hca-&gt;eqc_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Failed to map EQ context memory, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_unmap_aux
suffix:semicolon
)brace
id|mdev-&gt;mr_table.mtt_table
op_assign
id|mthca_alloc_icm_table
c_func
(paren
id|mdev
comma
id|init_hca-&gt;mtt_base
comma
id|mdev-&gt;limits.num_mtt_segs
op_star
id|init_hca-&gt;mtt_seg_sz
comma
id|mdev-&gt;limits.reserved_mtts
op_star
id|init_hca-&gt;mtt_seg_sz
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;mr_table.mtt_table
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Failed to map MTT context memory, aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_unmap_eq
suffix:semicolon
)brace
id|mdev-&gt;mr_table.mpt_table
op_assign
id|mthca_alloc_icm_table
c_func
(paren
id|mdev
comma
id|init_hca-&gt;mpt_base
comma
id|mdev-&gt;limits.num_mpts
op_star
id|dev_lim-&gt;mpt_entry_sz
comma
id|mdev-&gt;limits.reserved_mrws
op_star
id|dev_lim-&gt;mpt_entry_sz
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;mr_table.mpt_table
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Failed to map MPT context memory, aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_unmap_mtt
suffix:semicolon
)brace
id|mdev-&gt;qp_table.qp_table
op_assign
id|mthca_alloc_icm_table
c_func
(paren
id|mdev
comma
id|init_hca-&gt;qpc_base
comma
id|mdev-&gt;limits.num_qps
op_star
id|dev_lim-&gt;qpc_entry_sz
comma
id|mdev-&gt;limits.reserved_qps
op_star
id|dev_lim-&gt;qpc_entry_sz
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;qp_table.qp_table
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Failed to map QP context memory, aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_unmap_mpt
suffix:semicolon
)brace
id|mdev-&gt;qp_table.eqp_table
op_assign
id|mthca_alloc_icm_table
c_func
(paren
id|mdev
comma
id|init_hca-&gt;eqpc_base
comma
id|mdev-&gt;limits.num_qps
op_star
id|dev_lim-&gt;eqpc_entry_sz
comma
id|mdev-&gt;limits.reserved_qps
op_star
id|dev_lim-&gt;eqpc_entry_sz
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;qp_table.eqp_table
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Failed to map EQP context memory, aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_unmap_qp
suffix:semicolon
)brace
id|mdev-&gt;cq_table.table
op_assign
id|mthca_alloc_icm_table
c_func
(paren
id|mdev
comma
id|init_hca-&gt;cqc_base
comma
id|mdev-&gt;limits.num_cqs
op_star
id|dev_lim-&gt;cqc_entry_sz
comma
id|mdev-&gt;limits.reserved_cqs
op_star
id|dev_lim-&gt;cqc_entry_sz
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;cq_table.table
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Failed to map CQ context memory, aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_unmap_eqp
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_unmap_eqp
suffix:colon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;qp_table.eqp_table
)paren
suffix:semicolon
id|err_unmap_qp
suffix:colon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;qp_table.qp_table
)paren
suffix:semicolon
id|err_unmap_mpt
suffix:colon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;mr_table.mpt_table
)paren
suffix:semicolon
id|err_unmap_mtt
suffix:colon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;mr_table.mtt_table
)paren
suffix:semicolon
id|err_unmap_eq
suffix:colon
id|mthca_unmap_eq_icm
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|err_unmap_aux
suffix:colon
id|mthca_UNMAP_ICM_AUX
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
id|err_free_aux
suffix:colon
id|mthca_free_icm
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.aux_icm
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_init_arbel
r_static
r_int
id|__devinit
id|mthca_init_arbel
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
)paren
(brace
r_struct
id|mthca_dev_lim
id|dev_lim
suffix:semicolon
r_struct
id|mthca_profile
id|profile
suffix:semicolon
r_struct
id|mthca_init_hca_param
id|init_hca
suffix:semicolon
r_struct
id|mthca_adapter
id|adapter
suffix:semicolon
id|u64
id|icm_size
suffix:semicolon
id|u8
id|status
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|mthca_QUERY_FW
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_FW command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_FW returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|mthca_ENABLE_LAM
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;ENABLE_LAM command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_eq
id|MTHCA_CMD_STAT_LAM_NOT_PRE
)paren
(brace
id|mthca_dbg
c_func
(paren
id|mdev
comma
l_string|&quot;No HCA-attached memory (running in MemFree mode)&bslash;n&quot;
)paren
suffix:semicolon
id|mdev-&gt;mthca_flags
op_or_assign
id|MTHCA_FLAG_NO_LAM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;ENABLE_LAM returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|mthca_load_fw
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Failed to start FW, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
id|err
op_assign
id|mthca_dev_lim
c_func
(paren
id|mdev
comma
op_amp
id|dev_lim
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_DEV_LIM command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_stop_fw
suffix:semicolon
)brace
id|profile
op_assign
id|default_profile
suffix:semicolon
id|profile.num_uar
op_assign
id|dev_lim.uar_size
op_div
id|PAGE_SIZE
suffix:semicolon
id|profile.num_udav
op_assign
l_int|0
suffix:semicolon
id|icm_size
op_assign
id|mthca_make_profile
c_func
(paren
id|mdev
comma
op_amp
id|profile
comma
op_amp
id|dev_lim
comma
op_amp
id|init_hca
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|icm_size
OL
l_int|0
)paren
(brace
id|err
op_assign
id|icm_size
suffix:semicolon
r_goto
id|err_stop_fw
suffix:semicolon
)brace
id|err
op_assign
id|mthca_init_icm
c_func
(paren
id|mdev
comma
op_amp
id|dev_lim
comma
op_amp
id|init_hca
comma
id|icm_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_stop_fw
suffix:semicolon
id|err
op_assign
id|mthca_INIT_HCA
c_func
(paren
id|mdev
comma
op_amp
id|init_hca
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;INIT_HCA command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_free_icm
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;INIT_HCA returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_free_icm
suffix:semicolon
)brace
id|err
op_assign
id|mthca_QUERY_ADAPTER
c_func
(paren
id|mdev
comma
op_amp
id|adapter
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_ADAPTER command failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_free_icm
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;QUERY_ADAPTER returned status 0x%02x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_free_icm
suffix:semicolon
)brace
id|mdev-&gt;eq_table.inta_pin
op_assign
id|adapter.inta_pin
suffix:semicolon
id|mdev-&gt;rev_id
op_assign
id|adapter.revision_id
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_free_icm
suffix:colon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;cq_table.table
)paren
suffix:semicolon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;qp_table.eqp_table
)paren
suffix:semicolon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;qp_table.qp_table
)paren
suffix:semicolon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;mr_table.mpt_table
)paren
suffix:semicolon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;mr_table.mtt_table
)paren
suffix:semicolon
id|mthca_unmap_eq_icm
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_UNMAP_ICM_AUX
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
id|mthca_free_icm
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.aux_icm
)paren
suffix:semicolon
id|err_stop_fw
suffix:colon
id|mthca_UNMAP_FA
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
id|mthca_free_icm
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.fw_icm
)paren
suffix:semicolon
id|err_disable
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mdev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_NO_LAM
)paren
)paren
id|mthca_DISABLE_LAM
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_init_hca
r_static
r_int
id|__devinit
id|mthca_init_hca
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
)paren
(brace
r_if
c_cond
(paren
id|mdev-&gt;hca_type
op_eq
id|ARBEL_NATIVE
)paren
r_return
id|mthca_init_arbel
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_else
r_return
id|mthca_init_tavor
c_func
(paren
id|mdev
)paren
suffix:semicolon
)brace
DECL|function|mthca_setup_hca
r_static
r_int
id|__devinit
id|mthca_setup_hca
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|MTHCA_INIT_DOORBELL_LOCK
c_func
(paren
op_amp
id|dev-&gt;doorbell_lock
)paren
suffix:semicolon
id|err
op_assign
id|mthca_init_pd_table
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to initialize &quot;
l_string|&quot;protection domain table, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|mthca_init_mr_table
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to initialize &quot;
l_string|&quot;memory region table, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_pd_table_free
suffix:semicolon
)brace
id|err
op_assign
id|mthca_pd_alloc
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;driver_pd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to create driver PD, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_mr_table_free
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;hca_type
op_eq
id|ARBEL_NATIVE
)paren
(brace
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;Sorry, native MT25208 mode support is not done, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_pd_free
suffix:semicolon
)brace
id|err
op_assign
id|mthca_init_eq_table
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to initialize &quot;
l_string|&quot;event queue table, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_pd_free
suffix:semicolon
)brace
id|err
op_assign
id|mthca_cmd_use_events
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to switch to event-driven &quot;
l_string|&quot;firmware commands, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_eq_table_free
suffix:semicolon
)brace
id|err
op_assign
id|mthca_NOP
c_func
(paren
id|dev
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_or
id|status
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;NOP command failed to generate interrupt, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mthca_flags
op_amp
(paren
id|MTHCA_FLAG_MSI
op_or
id|MTHCA_FLAG_MSI_X
)paren
)paren
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Try again with MSI/MSI-X disabled.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;BIOS or ACPI interrupt routing problem?&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_cmd_poll
suffix:semicolon
)brace
r_else
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;NOP command IRQ test passed&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|mthca_init_cq_table
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to initialize &quot;
l_string|&quot;completion queue table, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_cmd_poll
suffix:semicolon
)brace
id|err
op_assign
id|mthca_init_qp_table
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to initialize &quot;
l_string|&quot;queue pair table, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_cq_table_free
suffix:semicolon
)brace
id|err
op_assign
id|mthca_init_av_table
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to initialize &quot;
l_string|&quot;address vector table, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_qp_table_free
suffix:semicolon
)brace
id|err
op_assign
id|mthca_init_mcg_table
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to initialize &quot;
l_string|&quot;multicast group table, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_av_table_free
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_av_table_free
suffix:colon
id|mthca_cleanup_av_table
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_qp_table_free
suffix:colon
id|mthca_cleanup_qp_table
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_cq_table_free
suffix:colon
id|mthca_cleanup_cq_table
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_cmd_poll
suffix:colon
id|mthca_cmd_use_polling
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_eq_table_free
suffix:colon
id|mthca_cleanup_eq_table
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_pd_free
suffix:colon
id|mthca_pd_free
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;driver_pd
)paren
suffix:semicolon
id|err_mr_table_free
suffix:colon
id|mthca_cleanup_mr_table
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_pd_table_free
suffix:colon
id|mthca_cleanup_pd_table
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_request_regions
r_static
r_int
id|__devinit
id|mthca_request_regions
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|ddr_hidden
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * We request our first BAR in two chunks, since the MSI-X&n;&t; * vector table is right in the middle.&n;&t; *&n;&t; * This is why we can&squot;t just use pci_request_regions() -- if&n;&t; * we did then setting up MSI-X would fail, since the PCI core&n;&t; * wants to do request_mem_region on the MSI-X vector table.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_HCR_BASE
comma
id|MTHCA_HCR_SIZE
comma
id|DRV_NAME
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_hcr_failed
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_ECR_BASE
comma
id|MTHCA_MAP_ECR_SIZE
comma
id|DRV_NAME
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_ecr_failed
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_CLR_INT_BASE
comma
id|MTHCA_CLR_INT_SIZE
comma
id|DRV_NAME
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_int_failed
suffix:semicolon
)brace
id|err
op_assign
id|pci_request_region
c_func
(paren
id|pdev
comma
l_int|2
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_bar2_failed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ddr_hidden
)paren
(brace
id|err
op_assign
id|pci_request_region
c_func
(paren
id|pdev
comma
l_int|4
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_bar4_failed
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_bar4_failed
suffix:colon
id|pci_release_region
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|err_bar2_failed
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_CLR_INT_BASE
comma
id|MTHCA_CLR_INT_SIZE
)paren
suffix:semicolon
id|err_int_failed
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_ECR_BASE
comma
id|MTHCA_MAP_ECR_SIZE
)paren
suffix:semicolon
id|err_ecr_failed
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_HCR_BASE
comma
id|MTHCA_HCR_SIZE
)paren
suffix:semicolon
id|err_hcr_failed
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_release_regions
r_static
r_void
id|mthca_release_regions
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|ddr_hidden
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ddr_hidden
)paren
id|pci_release_region
c_func
(paren
id|pdev
comma
l_int|4
)paren
suffix:semicolon
id|pci_release_region
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_CLR_INT_BASE
comma
id|MTHCA_CLR_INT_SIZE
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_ECR_BASE
comma
id|MTHCA_MAP_ECR_SIZE
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_HCR_BASE
comma
id|MTHCA_HCR_SIZE
)paren
suffix:semicolon
)brace
DECL|function|mthca_enable_msi_x
r_static
r_int
id|__devinit
id|mthca_enable_msi_x
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
)paren
(brace
r_struct
id|msix_entry
id|entries
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|err
suffix:semicolon
id|entries
(braket
l_int|0
)braket
dot
id|entry
op_assign
l_int|0
suffix:semicolon
id|entries
(braket
l_int|1
)braket
dot
id|entry
op_assign
l_int|1
suffix:semicolon
id|entries
(braket
l_int|2
)braket
dot
id|entry
op_assign
l_int|2
suffix:semicolon
id|err
op_assign
id|pci_enable_msix
c_func
(paren
id|mdev-&gt;pdev
comma
id|entries
comma
id|ARRAY_SIZE
c_func
(paren
id|entries
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
id|mthca_info
c_func
(paren
id|mdev
comma
l_string|&quot;Only %d MSI-X vectors available, &quot;
l_string|&quot;not using MSI-X&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|mdev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_COMP
)braket
dot
id|msi_x_vector
op_assign
id|entries
(braket
l_int|0
)braket
dot
id|vector
suffix:semicolon
id|mdev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_ASYNC
)braket
dot
id|msi_x_vector
op_assign
id|entries
(braket
l_int|1
)braket
dot
id|vector
suffix:semicolon
id|mdev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_CMD
)braket
dot
id|msi_x_vector
op_assign
id|entries
(braket
l_int|2
)braket
dot
id|vector
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mthca_close_hca
r_static
r_void
id|mthca_close_hca
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
)paren
(brace
id|u8
id|status
suffix:semicolon
id|mthca_CLOSE_HCA
c_func
(paren
id|mdev
comma
l_int|0
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdev-&gt;hca_type
op_eq
id|ARBEL_NATIVE
)paren
(brace
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;cq_table.table
)paren
suffix:semicolon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;qp_table.eqp_table
)paren
suffix:semicolon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;qp_table.qp_table
)paren
suffix:semicolon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;mr_table.mpt_table
)paren
suffix:semicolon
id|mthca_free_icm_table
c_func
(paren
id|mdev
comma
id|mdev-&gt;mr_table.mtt_table
)paren
suffix:semicolon
id|mthca_unmap_eq_icm
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_UNMAP_ICM_AUX
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
id|mthca_free_icm
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.aux_icm
)paren
suffix:semicolon
id|mthca_UNMAP_FA
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
id|mthca_free_icm
c_func
(paren
id|mdev
comma
id|mdev-&gt;fw.arbel.fw_icm
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mdev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_NO_LAM
)paren
)paren
id|mthca_DISABLE_LAM
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
)brace
r_else
id|mthca_SYS_DIS
c_func
(paren
id|mdev
comma
op_amp
id|status
)paren
suffix:semicolon
)brace
DECL|function|mthca_init_one
r_static
r_int
id|__devinit
id|mthca_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_static
r_int
id|mthca_version_printed
op_assign
l_int|0
suffix:semicolon
r_int
id|ddr_hidden
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_int
id|mthca_base
suffix:semicolon
r_struct
id|mthca_dev
op_star
id|mdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mthca_version_printed
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|mthca_version
)paren
suffix:semicolon
op_increment
id|mthca_version_printed
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Initializing %s (%s)&bslash;n&quot;
comma
id|pci_pretty_name
c_func
(paren
id|pdev
)paren
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Cannot enable PCI device, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check for BARs.  We expect 0: 1MB, 2: 8MB, 4: DDR (may not&n;&t; * be present)&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_MEM
)paren
op_logical_or
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_ne
l_int|1
op_lshift
l_int|20
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Missing DCS, aborting.&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_disable_pdev
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|2
)paren
op_amp
id|IORESOURCE_MEM
)paren
op_logical_or
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|2
)paren
op_ne
l_int|1
op_lshift
l_int|23
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Missing UAR, aborting.&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_disable_pdev
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|4
)paren
op_amp
id|IORESOURCE_MEM
)paren
)paren
id|ddr_hidden
op_assign
l_int|1
suffix:semicolon
id|err
op_assign
id|mthca_request_regions
c_func
(paren
id|pdev
comma
id|ddr_hidden
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Cannot obtain PCI resources, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_disable_pdev
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_64BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dev_warn
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Warning: couldn&squot;t set 64-bit PCI DMA mask.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Can&squot;t set PCI DMA mask, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_free_res
suffix:semicolon
)brace
)brace
id|err
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_64BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dev_warn
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Warning: couldn&squot;t set 64-bit &quot;
l_string|&quot;consistent PCI DMA mask.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Can&squot;t set consistent PCI DMA mask, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_free_res
suffix:semicolon
)brace
)brace
id|mdev
op_assign
(paren
r_struct
id|mthca_dev
op_star
)paren
id|ib_alloc_device
c_func
(paren
r_sizeof
op_star
id|mdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Device struct alloc failed, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_free_res
suffix:semicolon
)brace
id|mdev-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|mdev-&gt;hca_type
op_assign
id|id-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|ddr_hidden
)paren
id|mdev-&gt;mthca_flags
op_or_assign
id|MTHCA_FLAG_DDR_HIDDEN
suffix:semicolon
multiline_comment|/*&n;&t; * Now reset the HCA before we touch the PCI capabilities or&n;&t; * attempt a firmware command, since a boot ROM may have left&n;&t; * the HCA in an undefined state.&n;&t; */
id|err
op_assign
id|mthca_reset
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Failed to reset HCA, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_free_dev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msi_x
op_logical_and
op_logical_neg
id|mthca_enable_msi_x
c_func
(paren
id|mdev
)paren
)paren
id|mdev-&gt;mthca_flags
op_or_assign
id|MTHCA_FLAG_MSI_X
suffix:semicolon
r_if
c_cond
(paren
id|msi
op_logical_and
op_logical_neg
(paren
id|mdev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI_X
)paren
op_logical_and
op_logical_neg
id|pci_enable_msi
c_func
(paren
id|pdev
)paren
)paren
id|mdev-&gt;mthca_flags
op_or_assign
id|MTHCA_FLAG_MSI
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|mdev-&gt;cmd.hcr_sem
comma
l_int|1
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|mdev-&gt;cmd.poll_sem
comma
l_int|1
)paren
suffix:semicolon
id|mdev-&gt;cmd.use_events
op_assign
l_int|0
suffix:semicolon
id|mthca_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|mdev-&gt;hcr
op_assign
id|ioremap
c_func
(paren
id|mthca_base
op_plus
id|MTHCA_HCR_BASE
comma
id|MTHCA_HCR_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;hcr
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t map command register, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_free_dev
suffix:semicolon
)brace
id|mdev-&gt;clr_base
op_assign
id|ioremap
c_func
(paren
id|mthca_base
op_plus
id|MTHCA_CLR_INT_BASE
comma
id|MTHCA_CLR_INT_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;clr_base
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t map interrupt clear register, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_iounmap
suffix:semicolon
)brace
id|mdev-&gt;ecr_base
op_assign
id|ioremap
c_func
(paren
id|mthca_base
op_plus
id|MTHCA_ECR_BASE
comma
id|MTHCA_ECR_SIZE
op_plus
id|MTHCA_ECR_CLR_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;ecr_base
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t map ecr register, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_iounmap_clr
suffix:semicolon
)brace
id|mthca_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|mdev-&gt;kar
op_assign
id|ioremap
c_func
(paren
id|mthca_base
op_plus
id|PAGE_SIZE
op_star
id|MTHCA_KAR_PAGE
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mdev-&gt;kar
)paren
(brace
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t map kernel access region, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_iounmap_ecr
suffix:semicolon
)brace
id|err
op_assign
id|mthca_tune_pci
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_iounmap_kar
suffix:semicolon
id|err
op_assign
id|mthca_init_hca
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_iounmap_kar
suffix:semicolon
id|err
op_assign
id|mthca_setup_hca
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_close
suffix:semicolon
id|err
op_assign
id|mthca_register_device
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_cleanup
suffix:semicolon
id|err
op_assign
id|mthca_create_agents
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_unregister
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|mdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_unregister
suffix:colon
id|mthca_unregister_device
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|err_cleanup
suffix:colon
id|mthca_cleanup_mcg_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_av_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_qp_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_cq_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cmd_use_polling
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_eq_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_pd_free
c_func
(paren
id|mdev
comma
op_amp
id|mdev-&gt;driver_pd
)paren
suffix:semicolon
id|mthca_cleanup_mr_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_pd_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|err_close
suffix:colon
id|mthca_close_hca
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|err_iounmap_kar
suffix:colon
id|iounmap
c_func
(paren
id|mdev-&gt;kar
)paren
suffix:semicolon
id|err_iounmap_ecr
suffix:colon
id|iounmap
c_func
(paren
id|mdev-&gt;ecr_base
)paren
suffix:semicolon
id|err_iounmap_clr
suffix:colon
id|iounmap
c_func
(paren
id|mdev-&gt;clr_base
)paren
suffix:semicolon
id|err_iounmap
suffix:colon
id|iounmap
c_func
(paren
id|mdev-&gt;hcr
)paren
suffix:semicolon
id|err_free_dev
suffix:colon
r_if
c_cond
(paren
id|mdev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI_X
)paren
id|pci_disable_msix
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI
)paren
id|pci_disable_msi
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|ib_dealloc_device
c_func
(paren
op_amp
id|mdev-&gt;ib_dev
)paren
suffix:semicolon
id|err_free_res
suffix:colon
id|mthca_release_regions
c_func
(paren
id|pdev
comma
id|ddr_hidden
)paren
suffix:semicolon
id|err_disable_pdev
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_remove_one
r_static
r_void
id|__devexit
id|mthca_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|mthca_dev
op_star
id|mdev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|u8
id|status
suffix:semicolon
r_int
id|p
suffix:semicolon
r_if
c_cond
(paren
id|mdev
)paren
(brace
id|mthca_free_agents
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_unregister_device
c_func
(paren
id|mdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|1
suffix:semicolon
id|p
op_le
id|mdev-&gt;limits.num_ports
suffix:semicolon
op_increment
id|p
)paren
id|mthca_CLOSE_IB
c_func
(paren
id|mdev
comma
id|p
comma
op_amp
id|status
)paren
suffix:semicolon
id|mthca_cleanup_mcg_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_av_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_qp_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_cq_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cmd_use_polling
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_eq_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_pd_free
c_func
(paren
id|mdev
comma
op_amp
id|mdev-&gt;driver_pd
)paren
suffix:semicolon
id|mthca_cleanup_mr_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_cleanup_pd_table
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|mthca_close_hca
c_func
(paren
id|mdev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|mdev-&gt;hcr
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|mdev-&gt;ecr_base
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|mdev-&gt;clr_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI_X
)paren
id|pci_disable_msix
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI
)paren
id|pci_disable_msi
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|ib_dealloc_device
c_func
(paren
op_amp
id|mdev-&gt;ib_dev
)paren
suffix:semicolon
id|mthca_release_regions
c_func
(paren
id|pdev
comma
id|mdev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_DDR_HIDDEN
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
DECL|variable|mthca_pci_table
r_static
r_struct
id|pci_device_id
id|mthca_pci_table
(braket
)braket
op_assign
(brace
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_MELLANOX
comma
id|PCI_DEVICE_ID_MELLANOX_TAVOR
)paren
comma
dot
id|driver_data
op_assign
id|TAVOR
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_TOPSPIN
comma
id|PCI_DEVICE_ID_MELLANOX_TAVOR
)paren
comma
dot
id|driver_data
op_assign
id|TAVOR
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_MELLANOX
comma
id|PCI_DEVICE_ID_MELLANOX_ARBEL_COMPAT
)paren
comma
dot
id|driver_data
op_assign
id|ARBEL_COMPAT
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_TOPSPIN
comma
id|PCI_DEVICE_ID_MELLANOX_ARBEL_COMPAT
)paren
comma
dot
id|driver_data
op_assign
id|ARBEL_COMPAT
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_MELLANOX
comma
id|PCI_DEVICE_ID_MELLANOX_ARBEL
)paren
comma
dot
id|driver_data
op_assign
id|ARBEL_NATIVE
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_TOPSPIN
comma
id|PCI_DEVICE_ID_MELLANOX_ARBEL
)paren
comma
dot
id|driver_data
op_assign
id|ARBEL_NATIVE
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|mthca_pci_table
)paren
suffix:semicolon
DECL|variable|mthca_driver
r_static
r_struct
id|pci_driver
id|mthca_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ib_mthca&quot;
comma
dot
id|id_table
op_assign
id|mthca_pci_table
comma
dot
id|probe
op_assign
id|mthca_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|mthca_remove_one
)paren
)brace
suffix:semicolon
DECL|function|mthca_init
r_static
r_int
id|__init
id|mthca_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * TODO: measure whether dynamically choosing doorbell code at&n;&t; * runtime affects our performance.  Is there a &quot;magic&quot; way to&n;&t; * choose without having to follow a function pointer every&n;&t; * time we ring a doorbell?&n;&t; */
macro_line|#ifdef CONFIG_INFINIBAND_MTHCA_SSE_DOORBELL
r_if
c_cond
(paren
op_logical_neg
id|cpu_has_xmm
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;mthca was compiled with SSE doorbell code, but&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;the current CPU does not support SSE.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Turn off CONFIG_INFINIBAND_MTHCA_SSE_DOORBELL &quot;
l_string|&quot;and recompile.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#endif
id|ret
op_assign
id|pci_register_driver
c_func
(paren
op_amp
id|mthca_driver
)paren
suffix:semicolon
r_return
id|ret
OL
l_int|0
ques
c_cond
id|ret
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|mthca_cleanup
r_static
r_void
id|__exit
id|mthca_cleanup
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|mthca_driver
)paren
suffix:semicolon
)brace
DECL|variable|mthca_init
id|module_init
c_func
(paren
id|mthca_init
)paren
suffix:semicolon
DECL|variable|mthca_cleanup
id|module_exit
c_func
(paren
id|mthca_cleanup
)paren
suffix:semicolon
eof
