multiline_comment|/*&n; * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: mthca_cq.c 1369 2004-12-20 16:17:07Z roland $&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;ib_pack.h&gt;
macro_line|#include &quot;mthca_dev.h&quot;
macro_line|#include &quot;mthca_cmd.h&quot;
r_enum
(brace
DECL|enumerator|MTHCA_MAX_DIRECT_CQ_SIZE
id|MTHCA_MAX_DIRECT_CQ_SIZE
op_assign
l_int|4
op_star
id|PAGE_SIZE
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|MTHCA_CQ_ENTRY_SIZE
id|MTHCA_CQ_ENTRY_SIZE
op_assign
l_int|0x20
)brace
suffix:semicolon
multiline_comment|/*&n; * Must be packed because start is 64 bits but only aligned to 32 bits.&n; */
DECL|struct|mthca_cq_context
r_struct
id|mthca_cq_context
(brace
DECL|member|flags
id|u32
id|flags
suffix:semicolon
DECL|member|start
id|u64
id|start
suffix:semicolon
DECL|member|logsize_usrpage
id|u32
id|logsize_usrpage
suffix:semicolon
DECL|member|error_eqn
id|u32
id|error_eqn
suffix:semicolon
DECL|member|comp_eqn
id|u32
id|comp_eqn
suffix:semicolon
DECL|member|pd
id|u32
id|pd
suffix:semicolon
DECL|member|lkey
id|u32
id|lkey
suffix:semicolon
DECL|member|last_notified_index
id|u32
id|last_notified_index
suffix:semicolon
DECL|member|solicit_producer_index
id|u32
id|solicit_producer_index
suffix:semicolon
DECL|member|consumer_index
id|u32
id|consumer_index
suffix:semicolon
DECL|member|producer_index
id|u32
id|producer_index
suffix:semicolon
DECL|member|cqn
id|u32
id|cqn
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
(braket
l_int|3
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|MTHCA_CQ_STATUS_OK
mdefine_line|#define MTHCA_CQ_STATUS_OK          ( 0 &lt;&lt; 28)
DECL|macro|MTHCA_CQ_STATUS_OVERFLOW
mdefine_line|#define MTHCA_CQ_STATUS_OVERFLOW    ( 9 &lt;&lt; 28)
DECL|macro|MTHCA_CQ_STATUS_WRITE_FAIL
mdefine_line|#define MTHCA_CQ_STATUS_WRITE_FAIL  (10 &lt;&lt; 28)
DECL|macro|MTHCA_CQ_FLAG_TR
mdefine_line|#define MTHCA_CQ_FLAG_TR            ( 1 &lt;&lt; 18)
DECL|macro|MTHCA_CQ_FLAG_OI
mdefine_line|#define MTHCA_CQ_FLAG_OI            ( 1 &lt;&lt; 17)
DECL|macro|MTHCA_CQ_STATE_DISARMED
mdefine_line|#define MTHCA_CQ_STATE_DISARMED     ( 0 &lt;&lt;  8)
DECL|macro|MTHCA_CQ_STATE_ARMED
mdefine_line|#define MTHCA_CQ_STATE_ARMED        ( 1 &lt;&lt;  8)
DECL|macro|MTHCA_CQ_STATE_ARMED_SOL
mdefine_line|#define MTHCA_CQ_STATE_ARMED_SOL    ( 4 &lt;&lt;  8)
DECL|macro|MTHCA_EQ_STATE_FIRED
mdefine_line|#define MTHCA_EQ_STATE_FIRED        (10 &lt;&lt;  8)
r_enum
(brace
DECL|enumerator|MTHCA_ERROR_CQE_OPCODE_MASK
id|MTHCA_ERROR_CQE_OPCODE_MASK
op_assign
l_int|0xfe
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|SYNDROME_LOCAL_LENGTH_ERR
id|SYNDROME_LOCAL_LENGTH_ERR
op_assign
l_int|0x01
comma
DECL|enumerator|SYNDROME_LOCAL_QP_OP_ERR
id|SYNDROME_LOCAL_QP_OP_ERR
op_assign
l_int|0x02
comma
DECL|enumerator|SYNDROME_LOCAL_EEC_OP_ERR
id|SYNDROME_LOCAL_EEC_OP_ERR
op_assign
l_int|0x03
comma
DECL|enumerator|SYNDROME_LOCAL_PROT_ERR
id|SYNDROME_LOCAL_PROT_ERR
op_assign
l_int|0x04
comma
DECL|enumerator|SYNDROME_WR_FLUSH_ERR
id|SYNDROME_WR_FLUSH_ERR
op_assign
l_int|0x05
comma
DECL|enumerator|SYNDROME_MW_BIND_ERR
id|SYNDROME_MW_BIND_ERR
op_assign
l_int|0x06
comma
DECL|enumerator|SYNDROME_BAD_RESP_ERR
id|SYNDROME_BAD_RESP_ERR
op_assign
l_int|0x10
comma
DECL|enumerator|SYNDROME_LOCAL_ACCESS_ERR
id|SYNDROME_LOCAL_ACCESS_ERR
op_assign
l_int|0x11
comma
DECL|enumerator|SYNDROME_REMOTE_INVAL_REQ_ERR
id|SYNDROME_REMOTE_INVAL_REQ_ERR
op_assign
l_int|0x12
comma
DECL|enumerator|SYNDROME_REMOTE_ACCESS_ERR
id|SYNDROME_REMOTE_ACCESS_ERR
op_assign
l_int|0x13
comma
DECL|enumerator|SYNDROME_REMOTE_OP_ERR
id|SYNDROME_REMOTE_OP_ERR
op_assign
l_int|0x14
comma
DECL|enumerator|SYNDROME_RETRY_EXC_ERR
id|SYNDROME_RETRY_EXC_ERR
op_assign
l_int|0x15
comma
DECL|enumerator|SYNDROME_RNR_RETRY_EXC_ERR
id|SYNDROME_RNR_RETRY_EXC_ERR
op_assign
l_int|0x16
comma
DECL|enumerator|SYNDROME_LOCAL_RDD_VIOL_ERR
id|SYNDROME_LOCAL_RDD_VIOL_ERR
op_assign
l_int|0x20
comma
DECL|enumerator|SYNDROME_REMOTE_INVAL_RD_REQ_ERR
id|SYNDROME_REMOTE_INVAL_RD_REQ_ERR
op_assign
l_int|0x21
comma
DECL|enumerator|SYNDROME_REMOTE_ABORTED_ERR
id|SYNDROME_REMOTE_ABORTED_ERR
op_assign
l_int|0x22
comma
DECL|enumerator|SYNDROME_INVAL_EECN_ERR
id|SYNDROME_INVAL_EECN_ERR
op_assign
l_int|0x23
comma
DECL|enumerator|SYNDROME_INVAL_EEC_STATE_ERR
id|SYNDROME_INVAL_EEC_STATE_ERR
op_assign
l_int|0x24
)brace
suffix:semicolon
DECL|struct|mthca_cqe
r_struct
id|mthca_cqe
(brace
DECL|member|my_qpn
id|u32
id|my_qpn
suffix:semicolon
DECL|member|my_ee
id|u32
id|my_ee
suffix:semicolon
DECL|member|rqpn
id|u32
id|rqpn
suffix:semicolon
DECL|member|sl_g_mlpath
id|u16
id|sl_g_mlpath
suffix:semicolon
DECL|member|rlid
id|u16
id|rlid
suffix:semicolon
DECL|member|imm_etype_pkey_eec
id|u32
id|imm_etype_pkey_eec
suffix:semicolon
DECL|member|byte_cnt
id|u32
id|byte_cnt
suffix:semicolon
DECL|member|wqe
id|u32
id|wqe
suffix:semicolon
DECL|member|opcode
id|u8
id|opcode
suffix:semicolon
DECL|member|is_send
id|u8
id|is_send
suffix:semicolon
DECL|member|reserved
id|u8
id|reserved
suffix:semicolon
DECL|member|owner
id|u8
id|owner
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|mthca_err_cqe
r_struct
id|mthca_err_cqe
(brace
DECL|member|my_qpn
id|u32
id|my_qpn
suffix:semicolon
DECL|member|reserved1
id|u32
id|reserved1
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|syndrome
id|u8
id|syndrome
suffix:semicolon
DECL|member|reserved2
id|u8
id|reserved2
suffix:semicolon
DECL|member|db_cnt
id|u16
id|db_cnt
suffix:semicolon
DECL|member|reserved3
id|u32
id|reserved3
suffix:semicolon
DECL|member|wqe
id|u32
id|wqe
suffix:semicolon
DECL|member|opcode
id|u8
id|opcode
suffix:semicolon
DECL|member|reserved4
id|u8
id|reserved4
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|owner
id|u8
id|owner
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|MTHCA_CQ_ENTRY_OWNER_SW
mdefine_line|#define MTHCA_CQ_ENTRY_OWNER_SW      (0 &lt;&lt; 7)
DECL|macro|MTHCA_CQ_ENTRY_OWNER_HW
mdefine_line|#define MTHCA_CQ_ENTRY_OWNER_HW      (1 &lt;&lt; 7)
DECL|macro|MTHCA_CQ_DB_INC_CI
mdefine_line|#define MTHCA_CQ_DB_INC_CI       (1 &lt;&lt; 24)
DECL|macro|MTHCA_CQ_DB_REQ_NOT
mdefine_line|#define MTHCA_CQ_DB_REQ_NOT      (2 &lt;&lt; 24)
DECL|macro|MTHCA_CQ_DB_REQ_NOT_SOL
mdefine_line|#define MTHCA_CQ_DB_REQ_NOT_SOL  (3 &lt;&lt; 24)
DECL|macro|MTHCA_CQ_DB_SET_CI
mdefine_line|#define MTHCA_CQ_DB_SET_CI       (4 &lt;&lt; 24)
DECL|macro|MTHCA_CQ_DB_REQ_NOT_MULT
mdefine_line|#define MTHCA_CQ_DB_REQ_NOT_MULT (5 &lt;&lt; 24)
DECL|function|get_cqe
r_static
r_inline
r_struct
id|mthca_cqe
op_star
id|get_cqe
c_func
(paren
r_struct
id|mthca_cq
op_star
id|cq
comma
r_int
id|entry
)paren
(brace
r_if
c_cond
(paren
id|cq-&gt;is_direct
)paren
r_return
id|cq-&gt;queue.direct.buf
op_plus
(paren
id|entry
op_star
id|MTHCA_CQ_ENTRY_SIZE
)paren
suffix:semicolon
r_else
r_return
id|cq-&gt;queue.page_list
(braket
id|entry
op_star
id|MTHCA_CQ_ENTRY_SIZE
op_div
id|PAGE_SIZE
)braket
dot
id|buf
op_plus
(paren
id|entry
op_star
id|MTHCA_CQ_ENTRY_SIZE
)paren
op_mod
id|PAGE_SIZE
suffix:semicolon
)brace
DECL|function|cqe_sw
r_static
r_inline
r_int
id|cqe_sw
c_func
(paren
r_struct
id|mthca_cq
op_star
id|cq
comma
r_int
id|i
)paren
(brace
r_return
op_logical_neg
(paren
id|MTHCA_CQ_ENTRY_OWNER_HW
op_amp
id|get_cqe
c_func
(paren
id|cq
comma
id|i
)paren
op_member_access_from_pointer
id|owner
)paren
suffix:semicolon
)brace
DECL|function|next_cqe_sw
r_static
r_inline
r_int
id|next_cqe_sw
c_func
(paren
r_struct
id|mthca_cq
op_star
id|cq
)paren
(brace
r_return
id|cqe_sw
c_func
(paren
id|cq
comma
id|cq-&gt;cons_index
)paren
suffix:semicolon
)brace
DECL|function|set_cqe_hw
r_static
r_inline
r_void
id|set_cqe_hw
c_func
(paren
r_struct
id|mthca_cq
op_star
id|cq
comma
r_int
id|entry
)paren
(brace
id|get_cqe
c_func
(paren
id|cq
comma
id|entry
)paren
op_member_access_from_pointer
id|owner
op_assign
id|MTHCA_CQ_ENTRY_OWNER_HW
suffix:semicolon
)brace
DECL|function|inc_cons_index
r_static
r_inline
r_void
id|inc_cons_index
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_cq
op_star
id|cq
comma
r_int
id|nent
)paren
(brace
id|u32
id|doorbell
(braket
l_int|2
)braket
suffix:semicolon
id|doorbell
(braket
l_int|0
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|MTHCA_CQ_DB_INC_CI
op_or
id|cq-&gt;cqn
)paren
suffix:semicolon
id|doorbell
(braket
l_int|1
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|nent
op_minus
l_int|1
)paren
suffix:semicolon
id|mthca_write64
c_func
(paren
id|doorbell
comma
id|dev-&gt;kar
op_plus
id|MTHCA_CQ_DOORBELL
comma
id|MTHCA_GET_DOORBELL_LOCK
c_func
(paren
op_amp
id|dev-&gt;doorbell_lock
)paren
)paren
suffix:semicolon
)brace
DECL|function|mthca_cq_event
r_void
id|mthca_cq_event
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
id|u32
id|cqn
)paren
(brace
r_struct
id|mthca_cq
op_star
id|cq
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
id|cq
op_assign
id|mthca_array_get
c_func
(paren
op_amp
id|dev-&gt;cq_table.cq
comma
id|cqn
op_amp
(paren
id|dev-&gt;limits.num_cqs
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cq
)paren
id|atomic_inc
c_func
(paren
op_amp
id|cq-&gt;refcount
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cq
)paren
(brace
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;Completion event for bogus CQ %08x&bslash;n&quot;
comma
id|cqn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cq-&gt;ibcq
dot
id|comp_handler
c_func
(paren
op_amp
id|cq-&gt;ibcq
comma
id|cq-&gt;ibcq.cq_context
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|cq-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|cq-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|mthca_cq_clean
r_void
id|mthca_cq_clean
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
id|u32
id|cqn
comma
id|u32
id|qpn
)paren
(brace
r_struct
id|mthca_cq
op_star
id|cq
suffix:semicolon
r_struct
id|mthca_cqe
op_star
id|cqe
suffix:semicolon
r_int
id|prod_index
suffix:semicolon
r_int
id|nfreed
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
id|cq
op_assign
id|mthca_array_get
c_func
(paren
op_amp
id|dev-&gt;cq_table.cq
comma
id|cqn
op_amp
(paren
id|dev-&gt;limits.num_cqs
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cq
)paren
id|atomic_inc
c_func
(paren
op_amp
id|cq-&gt;refcount
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cq
)paren
r_return
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|cq-&gt;lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * First we need to find the current producer index, so we&n;&t; * know where to start cleaning from.  It doesn&squot;t matter if HW&n;&t; * adds new entries after this loop -- the QP we&squot;re worried&n;&t; * about is already in RESET, so the new entries won&squot;t come&n;&t; * from our QP and therefore don&squot;t need to be checked.&n;&t; */
r_for
c_loop
(paren
id|prod_index
op_assign
id|cq-&gt;cons_index
suffix:semicolon
id|cqe_sw
c_func
(paren
id|cq
comma
id|prod_index
op_amp
id|cq-&gt;ibcq.cqe
)paren
suffix:semicolon
op_increment
id|prod_index
)paren
r_if
c_cond
(paren
id|prod_index
op_eq
id|cq-&gt;cons_index
op_plus
id|cq-&gt;ibcq.cqe
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;Cleaning QPN %06x from CQN %06x; ci %d, pi %d&bslash;n&quot;
comma
id|qpn
comma
id|cqn
comma
id|cq-&gt;cons_index
comma
id|prod_index
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now sweep backwards through the CQ, removing CQ entries&n;&t; * that match our QP by copying older entries on top of them.&n;&t; */
r_while
c_loop
(paren
id|prod_index
OG
id|cq-&gt;cons_index
)paren
(brace
id|cqe
op_assign
id|get_cqe
c_func
(paren
id|cq
comma
(paren
id|prod_index
op_minus
l_int|1
)paren
op_amp
id|cq-&gt;ibcq.cqe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqe-&gt;my_qpn
op_eq
id|cpu_to_be32
c_func
(paren
id|qpn
)paren
)paren
op_increment
id|nfreed
suffix:semicolon
r_else
r_if
c_cond
(paren
id|nfreed
)paren
id|memcpy
c_func
(paren
id|get_cqe
c_func
(paren
id|cq
comma
(paren
id|prod_index
op_minus
l_int|1
op_plus
id|nfreed
)paren
op_amp
id|cq-&gt;ibcq.cqe
)paren
comma
id|cqe
comma
id|MTHCA_CQ_ENTRY_SIZE
)paren
suffix:semicolon
op_decrement
id|prod_index
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nfreed
)paren
(brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|inc_cons_index
c_func
(paren
id|dev
comma
id|cq
comma
id|nfreed
)paren
suffix:semicolon
id|cq-&gt;cons_index
op_assign
(paren
id|cq-&gt;cons_index
op_plus
id|nfreed
)paren
op_amp
id|cq-&gt;ibcq.cqe
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|cq-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|cq-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|cq-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|handle_error_cqe
r_static
r_int
id|handle_error_cqe
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_cq
op_star
id|cq
comma
r_struct
id|mthca_qp
op_star
id|qp
comma
r_int
id|wqe_index
comma
r_int
id|is_send
comma
r_struct
id|mthca_err_cqe
op_star
id|cqe
comma
r_struct
id|ib_wc
op_star
id|entry
comma
r_int
op_star
id|free_cqe
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|dbd
suffix:semicolon
id|u32
id|new_wqe
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_logical_and
id|cqe-&gt;syndrome
op_ne
id|SYNDROME_WR_FLUSH_ERR
)paren
(brace
r_int
id|j
suffix:semicolon
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%x/%d: error CQE -&gt; QPN %06x, WQE @ %08x&bslash;n&quot;
comma
id|cq-&gt;cqn
comma
id|cq-&gt;cons_index
comma
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;my_qpn
)paren
comma
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;wqe
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
op_increment
id|j
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  [%2x] %08x&bslash;n&quot;
comma
id|j
op_star
l_int|4
comma
id|be32_to_cpu
c_func
(paren
(paren
(paren
id|u32
op_star
)paren
id|cqe
)paren
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * For completions in error, only work request ID, status (and&n;&t; * freed resource count for RD) have to be set.&n;&t; */
r_switch
c_cond
(paren
id|cqe-&gt;syndrome
)paren
(brace
r_case
id|SYNDROME_LOCAL_LENGTH_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_LOC_LEN_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_LOCAL_QP_OP_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_LOC_QP_OP_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_LOCAL_EEC_OP_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_LOC_EEC_OP_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_LOCAL_PROT_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_LOC_PROT_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_WR_FLUSH_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_WR_FLUSH_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_MW_BIND_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_MW_BIND_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_BAD_RESP_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_BAD_RESP_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_LOCAL_ACCESS_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_LOC_ACCESS_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_REMOTE_INVAL_REQ_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_REM_INV_REQ_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_REMOTE_ACCESS_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_REM_ACCESS_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_REMOTE_OP_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_REM_OP_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_RETRY_EXC_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_RETRY_EXC_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_RNR_RETRY_EXC_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_RNR_RETRY_EXC_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_LOCAL_RDD_VIOL_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_LOC_RDD_VIOL_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_REMOTE_INVAL_RD_REQ_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_REM_INV_RD_REQ_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_REMOTE_ABORTED_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_REM_ABORT_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_INVAL_EECN_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_INV_EECN_ERR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNDROME_INVAL_EEC_STATE_ERR
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_INV_EEC_STATE_ERR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|entry-&gt;status
op_assign
id|IB_WC_GENERAL_ERR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|err
op_assign
id|mthca_free_err_wqe
c_func
(paren
id|qp
comma
id|is_send
comma
id|wqe_index
comma
op_amp
id|dbd
comma
op_amp
id|new_wqe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * If we&squot;re at the end of the WQE chain, or we&squot;ve used up our&n;&t; * doorbell count, free the CQE.  Otherwise just update it for&n;&t; * the next poll operation.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|new_wqe
op_amp
id|cpu_to_be32
c_func
(paren
l_int|0x3f
)paren
)paren
op_logical_or
(paren
op_logical_neg
id|cqe-&gt;db_cnt
op_logical_and
id|dbd
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|cqe-&gt;db_cnt
op_assign
id|cpu_to_be16
c_func
(paren
id|be16_to_cpu
c_func
(paren
id|cqe-&gt;db_cnt
)paren
op_minus
id|dbd
)paren
suffix:semicolon
id|cqe-&gt;wqe
op_assign
id|new_wqe
suffix:semicolon
id|cqe-&gt;syndrome
op_assign
id|SYNDROME_WR_FLUSH_ERR
suffix:semicolon
op_star
id|free_cqe
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dump_cqe
r_static
r_void
id|dump_cqe
c_func
(paren
r_struct
id|mthca_cqe
op_star
id|cqe
)paren
(brace
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
op_increment
id|j
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  [%2x] %08x&bslash;n&quot;
comma
id|j
op_star
l_int|4
comma
id|be32_to_cpu
c_func
(paren
(paren
(paren
id|u32
op_star
)paren
id|cqe
)paren
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|mthca_poll_one
r_static
r_inline
r_int
id|mthca_poll_one
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_cq
op_star
id|cq
comma
r_struct
id|mthca_qp
op_star
op_star
id|cur_qp
comma
r_int
op_star
id|freed
comma
r_struct
id|ib_wc
op_star
id|entry
)paren
(brace
r_struct
id|mthca_wq
op_star
id|wq
suffix:semicolon
r_struct
id|mthca_cqe
op_star
id|cqe
suffix:semicolon
r_int
id|wqe_index
suffix:semicolon
r_int
id|is_error
op_assign
l_int|0
suffix:semicolon
r_int
id|is_send
suffix:semicolon
r_int
id|free_cqe
op_assign
l_int|1
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|next_cqe_sw
c_func
(paren
id|cq
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure we read CQ entry contents after we&squot;ve checked the&n;&t; * ownership bit.&n;&t; */
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|cqe
op_assign
id|get_cqe
c_func
(paren
id|cq
comma
id|cq-&gt;cons_index
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
(brace
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%x/%d: CQE -&gt; QPN %06x, WQE @ %08x&bslash;n&quot;
comma
id|cq-&gt;cqn
comma
id|cq-&gt;cons_index
comma
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;my_qpn
)paren
comma
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;wqe
)paren
)paren
suffix:semicolon
id|dump_cqe
c_func
(paren
id|cqe
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cqe-&gt;opcode
op_amp
id|MTHCA_ERROR_CQE_OPCODE_MASK
)paren
op_eq
id|MTHCA_ERROR_CQE_OPCODE_MASK
)paren
(brace
id|is_error
op_assign
l_int|1
suffix:semicolon
id|is_send
op_assign
id|cqe-&gt;opcode
op_amp
l_int|1
suffix:semicolon
)brace
r_else
id|is_send
op_assign
id|cqe-&gt;is_send
op_amp
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|cur_qp
op_logical_or
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;my_qpn
)paren
op_ne
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|qpn
)paren
(brace
r_if
c_cond
(paren
op_star
id|cur_qp
)paren
(brace
r_if
c_cond
(paren
op_star
id|freed
)paren
(brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|inc_cons_index
c_func
(paren
id|dev
comma
id|cq
comma
op_star
id|freed
)paren
suffix:semicolon
op_star
id|freed
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|wait
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;qp_table.lock
)paren
suffix:semicolon
op_star
id|cur_qp
op_assign
id|mthca_array_get
c_func
(paren
op_amp
id|dev-&gt;qp_table.qp
comma
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;my_qpn
)paren
op_amp
(paren
id|dev-&gt;limits.num_qps
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cur_qp
)paren
id|atomic_inc
c_func
(paren
op_amp
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|refcount
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;qp_table.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|cur_qp
)paren
(brace
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;CQ entry for unknown QP %06x&bslash;n&quot;
comma
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;my_qpn
)paren
op_amp
l_int|0xffffff
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_send
)paren
(brace
id|wq
op_assign
op_amp
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|sq
suffix:semicolon
id|wqe_index
op_assign
(paren
(paren
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;wqe
)paren
op_minus
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|send_wqe_offset
)paren
op_rshift
id|wq-&gt;wqe_shift
)paren
suffix:semicolon
id|entry-&gt;wr_id
op_assign
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|wrid
(braket
id|wqe_index
op_plus
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|rq.max
)braket
suffix:semicolon
)brace
r_else
(brace
id|wq
op_assign
op_amp
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
id|wqe_index
op_assign
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;wqe
)paren
op_rshift
id|wq-&gt;wqe_shift
suffix:semicolon
id|entry-&gt;wr_id
op_assign
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|wrid
(braket
id|wqe_index
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wq-&gt;last_comp
OL
id|wqe_index
)paren
id|wq-&gt;cur
op_sub_assign
id|wqe_index
op_minus
id|wq-&gt;last_comp
suffix:semicolon
r_else
id|wq-&gt;cur
op_sub_assign
id|wq-&gt;max
op_minus
id|wq-&gt;last_comp
op_plus
id|wqe_index
suffix:semicolon
id|wq-&gt;last_comp
op_assign
id|wqe_index
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s completion for QP %06x, index %d (nr %d)&bslash;n&quot;
comma
id|is_send
ques
c_cond
l_string|&quot;Send&quot;
suffix:colon
l_string|&quot;Receive&quot;
comma
(paren
op_star
id|cur_qp
)paren
op_member_access_from_pointer
id|qpn
comma
id|wqe_index
comma
id|wq-&gt;max
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_error
)paren
(brace
id|err
op_assign
id|handle_error_cqe
c_func
(paren
id|dev
comma
id|cq
comma
op_star
id|cur_qp
comma
id|wqe_index
comma
id|is_send
comma
(paren
r_struct
id|mthca_err_cqe
op_star
)paren
id|cqe
comma
id|entry
comma
op_amp
id|free_cqe
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_send
)paren
(brace
id|entry-&gt;opcode
op_assign
id|IB_WC_SEND
suffix:semicolon
multiline_comment|/* XXX */
)brace
r_else
(brace
id|entry-&gt;byte_len
op_assign
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;byte_cnt
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cqe-&gt;opcode
op_amp
l_int|0x1f
)paren
(brace
r_case
id|IB_OPCODE_SEND_LAST_WITH_IMMEDIATE
suffix:colon
r_case
id|IB_OPCODE_SEND_ONLY_WITH_IMMEDIATE
suffix:colon
id|entry-&gt;wc_flags
op_assign
id|IB_WC_WITH_IMM
suffix:semicolon
id|entry-&gt;imm_data
op_assign
id|cqe-&gt;imm_etype_pkey_eec
suffix:semicolon
id|entry-&gt;opcode
op_assign
id|IB_WC_RECV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IB_OPCODE_RDMA_WRITE_LAST_WITH_IMMEDIATE
suffix:colon
r_case
id|IB_OPCODE_RDMA_WRITE_ONLY_WITH_IMMEDIATE
suffix:colon
id|entry-&gt;wc_flags
op_assign
id|IB_WC_WITH_IMM
suffix:semicolon
id|entry-&gt;imm_data
op_assign
id|cqe-&gt;imm_etype_pkey_eec
suffix:semicolon
id|entry-&gt;opcode
op_assign
id|IB_WC_RECV_RDMA_WITH_IMM
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|entry-&gt;wc_flags
op_assign
l_int|0
suffix:semicolon
id|entry-&gt;opcode
op_assign
id|IB_WC_RECV
suffix:semicolon
r_break
suffix:semicolon
)brace
id|entry-&gt;slid
op_assign
id|be16_to_cpu
c_func
(paren
id|cqe-&gt;rlid
)paren
suffix:semicolon
id|entry-&gt;sl
op_assign
id|be16_to_cpu
c_func
(paren
id|cqe-&gt;sl_g_mlpath
)paren
op_rshift
l_int|12
suffix:semicolon
id|entry-&gt;src_qp
op_assign
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;rqpn
)paren
op_amp
l_int|0xffffff
suffix:semicolon
id|entry-&gt;dlid_path_bits
op_assign
id|be16_to_cpu
c_func
(paren
id|cqe-&gt;sl_g_mlpath
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|entry-&gt;pkey_index
op_assign
id|be32_to_cpu
c_func
(paren
id|cqe-&gt;imm_etype_pkey_eec
)paren
op_rshift
l_int|16
suffix:semicolon
id|entry-&gt;wc_flags
op_or_assign
id|be16_to_cpu
c_func
(paren
id|cqe-&gt;sl_g_mlpath
)paren
op_amp
l_int|0x80
ques
c_cond
id|IB_WC_GRH
suffix:colon
l_int|0
suffix:semicolon
)brace
id|entry-&gt;status
op_assign
id|IB_WC_SUCCESS
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|free_cqe
)paren
(brace
id|set_cqe_hw
c_func
(paren
id|cq
comma
id|cq-&gt;cons_index
)paren
suffix:semicolon
op_increment
(paren
op_star
id|freed
)paren
suffix:semicolon
id|cq-&gt;cons_index
op_assign
(paren
id|cq-&gt;cons_index
op_plus
l_int|1
)paren
op_amp
id|cq-&gt;ibcq.cqe
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_poll_cq
r_int
id|mthca_poll_cq
c_func
(paren
r_struct
id|ib_cq
op_star
id|ibcq
comma
r_int
id|num_entries
comma
r_struct
id|ib_wc
op_star
id|entry
)paren
(brace
r_struct
id|mthca_dev
op_star
id|dev
op_assign
id|to_mdev
c_func
(paren
id|ibcq-&gt;device
)paren
suffix:semicolon
r_struct
id|mthca_cq
op_star
id|cq
op_assign
id|to_mcq
c_func
(paren
id|ibcq
)paren
suffix:semicolon
r_struct
id|mthca_qp
op_star
id|qp
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|freed
op_assign
l_int|0
suffix:semicolon
r_int
id|npolled
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|npolled
op_assign
l_int|0
suffix:semicolon
id|npolled
OL
id|num_entries
suffix:semicolon
op_increment
id|npolled
)paren
(brace
id|err
op_assign
id|mthca_poll_one
c_func
(paren
id|dev
comma
id|cq
comma
op_amp
id|qp
comma
op_amp
id|freed
comma
id|entry
op_plus
id|npolled
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freed
)paren
(brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|inc_cons_index
c_func
(paren
id|dev
comma
id|cq
comma
id|freed
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qp
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|qp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|qp-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|qp-&gt;wait
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cq-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
id|EAGAIN
ques
c_cond
id|npolled
suffix:colon
id|err
suffix:semicolon
)brace
DECL|function|mthca_arm_cq
r_void
id|mthca_arm_cq
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_cq
op_star
id|cq
comma
r_int
id|solicited
)paren
(brace
id|u32
id|doorbell
(braket
l_int|2
)braket
suffix:semicolon
id|doorbell
(braket
l_int|0
)braket
op_assign
id|cpu_to_be32
c_func
(paren
(paren
id|solicited
ques
c_cond
id|MTHCA_CQ_DB_REQ_NOT_SOL
suffix:colon
id|MTHCA_CQ_DB_REQ_NOT
)paren
op_or
id|cq-&gt;cqn
)paren
suffix:semicolon
id|doorbell
(braket
l_int|1
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
id|mthca_write64
c_func
(paren
id|doorbell
comma
id|dev-&gt;kar
op_plus
id|MTHCA_CQ_DOORBELL
comma
id|MTHCA_GET_DOORBELL_LOCK
c_func
(paren
op_amp
id|dev-&gt;doorbell_lock
)paren
)paren
suffix:semicolon
)brace
DECL|function|mthca_init_cq
r_int
id|mthca_init_cq
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_int
id|nent
comma
r_struct
id|mthca_cq
op_star
id|cq
)paren
(brace
r_int
id|size
op_assign
id|nent
op_star
id|MTHCA_CQ_ENTRY_SIZE
suffix:semicolon
id|dma_addr_t
id|t
suffix:semicolon
r_void
op_star
id|mailbox
op_assign
l_int|NULL
suffix:semicolon
r_int
id|npages
comma
id|shift
suffix:semicolon
id|u64
op_star
id|dma_list
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mthca_cq_context
op_star
id|cq_context
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|u8
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
id|might_sleep
c_func
(paren
)paren
suffix:semicolon
id|mailbox
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mthca_cq_context
)paren
op_plus
id|MTHCA_CMD_MAILBOX_EXTRA
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mailbox
)paren
r_goto
id|err_out
suffix:semicolon
id|cq_context
op_assign
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
id|MTHCA_MAX_DIRECT_CQ_SIZE
)paren
(brace
r_if
c_cond
(paren
l_int|0
)paren
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;Creating direct CQ of size %d&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
id|cq-&gt;is_direct
op_assign
l_int|1
suffix:semicolon
id|npages
op_assign
l_int|1
suffix:semicolon
id|shift
op_assign
id|get_order
c_func
(paren
id|size
)paren
op_plus
id|PAGE_SHIFT
suffix:semicolon
id|cq-&gt;queue.direct.buf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|dev-&gt;pdev
comma
id|size
comma
op_amp
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cq-&gt;queue.direct.buf
)paren
r_goto
id|err_out
suffix:semicolon
id|pci_unmap_addr_set
c_func
(paren
op_amp
id|cq-&gt;queue.direct
comma
id|mapping
comma
id|t
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cq-&gt;queue.direct.buf
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_while
c_loop
(paren
id|t
op_amp
(paren
(paren
l_int|1
op_lshift
id|shift
)paren
op_minus
l_int|1
)paren
)paren
(brace
op_decrement
id|shift
suffix:semicolon
id|npages
op_mul_assign
l_int|2
suffix:semicolon
)brace
id|dma_list
op_assign
id|kmalloc
c_func
(paren
id|npages
op_star
r_sizeof
op_star
id|dma_list
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma_list
)paren
r_goto
id|err_out_free
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
op_increment
id|i
)paren
id|dma_list
(braket
id|i
)braket
op_assign
id|t
op_plus
id|i
op_star
(paren
l_int|1
op_lshift
id|shift
)paren
suffix:semicolon
)brace
r_else
(brace
id|cq-&gt;is_direct
op_assign
l_int|0
suffix:semicolon
id|npages
op_assign
(paren
id|size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
id|shift
op_assign
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;Creating indirect CQ with %d pages&bslash;n&quot;
comma
id|npages
)paren
suffix:semicolon
id|dma_list
op_assign
id|kmalloc
c_func
(paren
id|npages
op_star
r_sizeof
op_star
id|dma_list
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma_list
)paren
r_goto
id|err_out
suffix:semicolon
id|cq-&gt;queue.page_list
op_assign
id|kmalloc
c_func
(paren
id|npages
op_star
r_sizeof
op_star
id|cq-&gt;queue.page_list
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cq-&gt;queue.page_list
)paren
r_goto
id|err_out
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
op_increment
id|i
)paren
id|cq-&gt;queue.page_list
(braket
id|i
)braket
dot
id|buf
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
op_increment
id|i
)paren
(brace
id|cq-&gt;queue.page_list
(braket
id|i
)braket
dot
id|buf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|dev-&gt;pdev
comma
id|PAGE_SIZE
comma
op_amp
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cq-&gt;queue.page_list
(braket
id|i
)braket
dot
id|buf
)paren
r_goto
id|err_out_free
suffix:semicolon
id|dma_list
(braket
id|i
)braket
op_assign
id|t
suffix:semicolon
id|pci_unmap_addr_set
c_func
(paren
op_amp
id|cq-&gt;queue.page_list
(braket
id|i
)braket
comma
id|mapping
comma
id|t
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cq-&gt;queue.page_list
(braket
id|i
)braket
dot
id|buf
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nent
suffix:semicolon
op_increment
id|i
)paren
id|set_cqe_hw
c_func
(paren
id|cq
comma
id|i
)paren
suffix:semicolon
id|cq-&gt;cqn
op_assign
id|mthca_alloc
c_func
(paren
op_amp
id|dev-&gt;cq_table.alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cq-&gt;cqn
op_eq
op_minus
l_int|1
)paren
r_goto
id|err_out_free
suffix:semicolon
id|err
op_assign
id|mthca_mr_alloc_phys
c_func
(paren
id|dev
comma
id|dev-&gt;driver_pd.pd_num
comma
id|dma_list
comma
id|shift
comma
id|npages
comma
l_int|0
comma
id|size
comma
id|MTHCA_MPT_FLAG_LOCAL_WRITE
op_or
id|MTHCA_MPT_FLAG_LOCAL_READ
comma
op_amp
id|cq-&gt;mr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_free_cq
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|cq-&gt;lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|cq-&gt;refcount
comma
l_int|1
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cq-&gt;wait
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cq_context
comma
l_int|0
comma
r_sizeof
op_star
id|cq_context
)paren
suffix:semicolon
id|cq_context-&gt;flags
op_assign
id|cpu_to_be32
c_func
(paren
id|MTHCA_CQ_STATUS_OK
op_or
id|MTHCA_CQ_STATE_DISARMED
op_or
id|MTHCA_CQ_FLAG_TR
)paren
suffix:semicolon
id|cq_context-&gt;start
op_assign
id|cpu_to_be64
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|cq_context-&gt;logsize_usrpage
op_assign
id|cpu_to_be32
c_func
(paren
(paren
id|ffs
c_func
(paren
id|nent
)paren
op_minus
l_int|1
)paren
op_lshift
l_int|24
op_or
id|MTHCA_KAR_PAGE
)paren
suffix:semicolon
id|cq_context-&gt;error_eqn
op_assign
id|cpu_to_be32
c_func
(paren
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_ASYNC
)braket
dot
id|eqn
)paren
suffix:semicolon
id|cq_context-&gt;comp_eqn
op_assign
id|cpu_to_be32
c_func
(paren
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_COMP
)braket
dot
id|eqn
)paren
suffix:semicolon
id|cq_context-&gt;pd
op_assign
id|cpu_to_be32
c_func
(paren
id|dev-&gt;driver_pd.pd_num
)paren
suffix:semicolon
id|cq_context-&gt;lkey
op_assign
id|cpu_to_be32
c_func
(paren
id|cq-&gt;mr.ibmr.lkey
)paren
suffix:semicolon
id|cq_context-&gt;cqn
op_assign
id|cpu_to_be32
c_func
(paren
id|cq-&gt;cqn
)paren
suffix:semicolon
id|err
op_assign
id|mthca_SW2HW_CQ
c_func
(paren
id|dev
comma
id|cq_context
comma
id|cq-&gt;cqn
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;SW2HW_CQ failed (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|err_out_free_mr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;SW2HW_CQ returned status 0x%02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_out_free_mr
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mthca_array_set
c_func
(paren
op_amp
id|dev-&gt;cq_table.cq
comma
id|cq-&gt;cqn
op_amp
(paren
id|dev-&gt;limits.num_cqs
op_minus
l_int|1
)paren
comma
id|cq
)paren
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
r_goto
id|err_out_free_mr
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
id|cq-&gt;cons_index
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|dma_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_free_mr
suffix:colon
id|mthca_free_mr
c_func
(paren
id|dev
comma
op_amp
id|cq-&gt;mr
)paren
suffix:semicolon
id|err_out_free_cq
suffix:colon
id|mthca_free
c_func
(paren
op_amp
id|dev-&gt;cq_table.alloc
comma
id|cq-&gt;cqn
)paren
suffix:semicolon
id|err_out_free
suffix:colon
r_if
c_cond
(paren
id|cq-&gt;is_direct
)paren
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pdev
comma
id|size
comma
id|cq-&gt;queue.direct.buf
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|cq-&gt;queue.direct
comma
id|mapping
)paren
)paren
suffix:semicolon
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|cq-&gt;queue.page_list
(braket
id|i
)braket
dot
id|buf
)paren
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pdev
comma
id|PAGE_SIZE
comma
id|cq-&gt;queue.page_list
(braket
id|i
)braket
dot
id|buf
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|cq-&gt;queue.page_list
(braket
id|i
)braket
comma
id|mapping
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cq-&gt;queue.page_list
)paren
suffix:semicolon
)brace
id|err_out
suffix:colon
id|kfree
c_func
(paren
id|dma_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_free_cq
r_void
id|mthca_free_cq
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_cq
op_star
id|cq
)paren
(brace
r_void
op_star
id|mailbox
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|might_sleep
c_func
(paren
)paren
suffix:semicolon
id|mailbox
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mthca_cq_context
)paren
op_plus
id|MTHCA_CMD_MAILBOX_EXTRA
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mailbox
)paren
(brace
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;No memory for mailbox to free CQ.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|err
op_assign
id|mthca_HW2SW_CQ
c_func
(paren
id|dev
comma
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
comma
id|cq-&gt;cqn
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;HW2SW_CQ failed (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
)paren
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;HW2SW_CQ returned status 0x%02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
(brace
id|u32
op_star
id|ctx
op_assign
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_int
id|j
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;context for CQN %x (cons index %x, next sw %d)&bslash;n&quot;
comma
id|cq-&gt;cqn
comma
id|cq-&gt;cons_index
comma
id|next_cqe_sw
c_func
(paren
id|cq
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|16
suffix:semicolon
op_increment
id|j
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;[%2x] %08x&bslash;n&quot;
comma
id|j
op_star
l_int|4
comma
id|be32_to_cpu
c_func
(paren
id|ctx
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
id|mthca_array_clear
c_func
(paren
op_amp
id|dev-&gt;cq_table.cq
comma
id|cq-&gt;cqn
op_amp
(paren
id|dev-&gt;limits.num_cqs
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|cq-&gt;refcount
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|cq-&gt;wait
comma
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|cq-&gt;refcount
)paren
)paren
suffix:semicolon
id|mthca_free_mr
c_func
(paren
id|dev
comma
op_amp
id|cq-&gt;mr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cq-&gt;is_direct
)paren
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pdev
comma
(paren
id|cq-&gt;ibcq.cqe
op_plus
l_int|1
)paren
op_star
id|MTHCA_CQ_ENTRY_SIZE
comma
id|cq-&gt;queue.direct.buf
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|cq-&gt;queue.direct
comma
id|mapping
)paren
)paren
suffix:semicolon
r_else
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
(paren
id|cq-&gt;ibcq.cqe
op_plus
l_int|1
)paren
op_star
id|MTHCA_CQ_ENTRY_SIZE
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
op_increment
id|i
)paren
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pdev
comma
id|PAGE_SIZE
comma
id|cq-&gt;queue.page_list
(braket
id|i
)braket
dot
id|buf
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|cq-&gt;queue.page_list
(braket
id|i
)braket
comma
id|mapping
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cq-&gt;queue.page_list
)paren
suffix:semicolon
)brace
id|mthca_free
c_func
(paren
op_amp
id|dev-&gt;cq_table.alloc
comma
id|cq-&gt;cqn
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
)brace
DECL|function|mthca_init_cq_table
r_int
id|__devinit
id|mthca_init_cq_table
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;cq_table.lock
)paren
suffix:semicolon
id|err
op_assign
id|mthca_alloc_init
c_func
(paren
op_amp
id|dev-&gt;cq_table.alloc
comma
id|dev-&gt;limits.num_cqs
comma
(paren
l_int|1
op_lshift
l_int|24
)paren
op_minus
l_int|1
comma
id|dev-&gt;limits.reserved_cqs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|err
op_assign
id|mthca_array_init
c_func
(paren
op_amp
id|dev-&gt;cq_table.cq
comma
id|dev-&gt;limits.num_cqs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|mthca_alloc_cleanup
c_func
(paren
op_amp
id|dev-&gt;cq_table.alloc
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_cleanup_cq_table
r_void
id|__devexit
id|mthca_cleanup_cq_table
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
id|mthca_array_cleanup
c_func
(paren
op_amp
id|dev-&gt;cq_table.cq
comma
id|dev-&gt;limits.num_cqs
)paren
suffix:semicolon
id|mthca_alloc_cleanup
c_func
(paren
op_amp
id|dev-&gt;cq_table.alloc
)paren
suffix:semicolon
)brace
eof
