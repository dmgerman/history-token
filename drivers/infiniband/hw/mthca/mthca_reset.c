multiline_comment|/*&n; * Copyright (c) 2004 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: mthca_reset.c 1349 2004-12-16 21:09:43Z roland $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &quot;mthca_dev.h&quot;
macro_line|#include &quot;mthca_cmd.h&quot;
DECL|function|mthca_reset
r_int
id|mthca_reset
c_func
(paren
r_struct
id|mthca_dev
op_star
id|mdev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|u32
op_star
id|hca_header
op_assign
l_int|NULL
suffix:semicolon
id|u32
op_star
id|bridge_header
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|pci_dev
op_star
id|bridge
op_assign
l_int|NULL
suffix:semicolon
DECL|macro|MTHCA_RESET_OFFSET
mdefine_line|#define MTHCA_RESET_OFFSET 0xf0010
DECL|macro|MTHCA_RESET_VALUE
mdefine_line|#define MTHCA_RESET_VALUE  cpu_to_be32(1)
multiline_comment|/*&n;&t; * Reset the chip.  This is somewhat ugly because we have to&n;&t; * save off the PCI header before reset and then restore it&n;&t; * after the chip reboots.  We skip config space offsets 22&n;&t; * and 23 since those have a special meaning.&n;&t; *&n;&t; * To make matters worse, for Tavor (PCI-X HCA) we have to&n;&t; * find the associated bridge device and save off its PCI&n;&t; * header as well.&n;&t; */
r_if
c_cond
(paren
id|mdev-&gt;hca_type
op_eq
id|TAVOR
)paren
(brace
multiline_comment|/* Look for the bridge -- its device ID will be 2 more&n;&t;&t;   than HCA&squot;s device ID. */
r_while
c_loop
(paren
(paren
id|bridge
op_assign
id|pci_get_device
c_func
(paren
id|mdev-&gt;pdev-&gt;vendor
comma
id|mdev-&gt;pdev-&gt;device
op_plus
l_int|2
comma
id|bridge
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|bridge-&gt;hdr_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
op_logical_and
id|bridge-&gt;subordinate
op_eq
id|mdev-&gt;pdev-&gt;bus
)paren
(brace
id|mthca_dbg
c_func
(paren
id|mdev
comma
l_string|&quot;Found bridge: %s (%s)&bslash;n&quot;
comma
id|pci_pretty_name
c_func
(paren
id|bridge
)paren
comma
id|pci_name
c_func
(paren
id|bridge
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|bridge
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Didn&squot;t find a bridge for a Tavor device --&n;&t;&t;&t; * assume we&squot;re in no-bridge mode and hope for&n;&t;&t;&t; * the best.&n;&t;&t;&t; */
id|mthca_warn
c_func
(paren
id|mdev
comma
l_string|&quot;No bridge found for %s (%s)&bslash;n&quot;
comma
id|pci_pretty_name
c_func
(paren
id|mdev-&gt;pdev
)paren
comma
id|pci_name
c_func
(paren
id|mdev-&gt;pdev
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* For Arbel do we need to save off the full 4K PCI Express header?? */
id|hca_header
op_assign
id|kmalloc
c_func
(paren
l_int|256
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hca_header
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t allocate memory to save HCA &quot;
l_string|&quot;PCI header, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|22
op_logical_or
id|i
op_eq
l_int|23
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pci_read_config_dword
c_func
(paren
id|mdev-&gt;pdev
comma
id|i
op_star
l_int|4
comma
id|hca_header
op_plus
id|i
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t save HCA &quot;
l_string|&quot;PCI header, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|bridge
)paren
(brace
id|bridge_header
op_assign
id|kmalloc
c_func
(paren
l_int|256
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge_header
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t allocate memory to save HCA &quot;
l_string|&quot;bridge PCI header, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|22
op_logical_or
id|i
op_eq
l_int|23
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pci_read_config_dword
c_func
(paren
id|bridge
comma
id|i
op_star
l_int|4
comma
id|bridge_header
op_plus
id|i
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t save HCA bridge &quot;
l_string|&quot;PCI header, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* actually hit reset */
(brace
r_void
id|__iomem
op_star
id|reset
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|mdev-&gt;pdev
comma
l_int|0
)paren
op_plus
id|MTHCA_RESET_OFFSET
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reset
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t map HCA reset register, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|writel
c_func
(paren
id|MTHCA_RESET_VALUE
comma
id|reset
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|reset
)paren
suffix:semicolon
)brace
multiline_comment|/* Docs say to wait one second before accessing device */
id|msleep
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* Now wait for PCI device to start responding again */
(brace
id|u32
id|v
suffix:semicolon
r_int
id|c
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
l_int|100
suffix:semicolon
op_increment
id|c
)paren
(brace
r_if
c_cond
(paren
id|pci_read_config_dword
c_func
(paren
id|bridge
ques
c_cond
id|bridge
suffix:colon
id|mdev-&gt;pdev
comma
l_int|0
comma
op_amp
id|v
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t access HCA after reset, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v
op_ne
l_int|0xffffffff
)paren
r_goto
id|good
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;PCI device did not come back after reset, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|good
suffix:colon
multiline_comment|/* Now restore the PCI headers */
r_if
c_cond
(paren
id|bridge
)paren
(brace
multiline_comment|/*&n;&t;&t; * Bridge control register is at 0x3e, so we&squot;ll&n;&t;&t; * naturally restore it last in this loop.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i
op_star
l_int|4
op_eq
id|PCI_COMMAND
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|i
op_star
l_int|4
comma
id|bridge_header
(braket
id|i
)braket
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t restore HCA bridge reg %x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_COMMAND
comma
id|bridge_header
(braket
id|PCI_COMMAND
op_div
l_int|4
)braket
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t restore HCA bridge COMMAND, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i
op_star
l_int|4
op_eq
id|PCI_COMMAND
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_config_dword
c_func
(paren
id|mdev-&gt;pdev
comma
id|i
op_star
l_int|4
comma
id|hca_header
(braket
id|i
)braket
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t restore HCA reg %x, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pci_write_config_dword
c_func
(paren
id|mdev-&gt;pdev
comma
id|PCI_COMMAND
comma
id|hca_header
(braket
id|PCI_COMMAND
op_div
l_int|4
)braket
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|mthca_err
c_func
(paren
id|mdev
comma
l_string|&quot;Couldn&squot;t restore HCA COMMAND, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|bridge
)paren
id|pci_dev_put
c_func
(paren
id|bridge
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge_header
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hca_header
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
eof
