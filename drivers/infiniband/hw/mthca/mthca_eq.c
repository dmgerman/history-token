multiline_comment|/*&n; * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: mthca_eq.c 1382 2004-12-24 02:21:02Z roland $&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &quot;mthca_dev.h&quot;
macro_line|#include &quot;mthca_cmd.h&quot;
macro_line|#include &quot;mthca_config_reg.h&quot;
r_enum
(brace
DECL|enumerator|MTHCA_NUM_ASYNC_EQE
id|MTHCA_NUM_ASYNC_EQE
op_assign
l_int|0x80
comma
DECL|enumerator|MTHCA_NUM_CMD_EQE
id|MTHCA_NUM_CMD_EQE
op_assign
l_int|0x80
comma
DECL|enumerator|MTHCA_EQ_ENTRY_SIZE
id|MTHCA_EQ_ENTRY_SIZE
op_assign
l_int|0x20
)brace
suffix:semicolon
multiline_comment|/*&n; * Must be packed because start is 64 bits but only aligned to 32 bits.&n; */
DECL|struct|mthca_eq_context
r_struct
id|mthca_eq_context
(brace
DECL|member|flags
id|u32
id|flags
suffix:semicolon
DECL|member|start
id|u64
id|start
suffix:semicolon
DECL|member|logsize_usrpage
id|u32
id|logsize_usrpage
suffix:semicolon
DECL|member|pd
id|u32
id|pd
suffix:semicolon
DECL|member|reserved1
id|u8
id|reserved1
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|intr
id|u8
id|intr
suffix:semicolon
DECL|member|lost_count
id|u32
id|lost_count
suffix:semicolon
DECL|member|lkey
id|u32
id|lkey
suffix:semicolon
DECL|member|reserved2
id|u32
id|reserved2
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|consumer_index
id|u32
id|consumer_index
suffix:semicolon
DECL|member|producer_index
id|u32
id|producer_index
suffix:semicolon
DECL|member|reserved3
id|u32
id|reserved3
(braket
l_int|4
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|MTHCA_EQ_STATUS_OK
mdefine_line|#define MTHCA_EQ_STATUS_OK          ( 0 &lt;&lt; 28)
DECL|macro|MTHCA_EQ_STATUS_OVERFLOW
mdefine_line|#define MTHCA_EQ_STATUS_OVERFLOW    ( 9 &lt;&lt; 28)
DECL|macro|MTHCA_EQ_STATUS_WRITE_FAIL
mdefine_line|#define MTHCA_EQ_STATUS_WRITE_FAIL  (10 &lt;&lt; 28)
DECL|macro|MTHCA_EQ_OWNER_SW
mdefine_line|#define MTHCA_EQ_OWNER_SW           ( 0 &lt;&lt; 24)
DECL|macro|MTHCA_EQ_OWNER_HW
mdefine_line|#define MTHCA_EQ_OWNER_HW           ( 1 &lt;&lt; 24)
DECL|macro|MTHCA_EQ_FLAG_TR
mdefine_line|#define MTHCA_EQ_FLAG_TR            ( 1 &lt;&lt; 18)
DECL|macro|MTHCA_EQ_FLAG_OI
mdefine_line|#define MTHCA_EQ_FLAG_OI            ( 1 &lt;&lt; 17)
DECL|macro|MTHCA_EQ_STATE_ARMED
mdefine_line|#define MTHCA_EQ_STATE_ARMED        ( 1 &lt;&lt;  8)
DECL|macro|MTHCA_EQ_STATE_FIRED
mdefine_line|#define MTHCA_EQ_STATE_FIRED        ( 2 &lt;&lt;  8)
DECL|macro|MTHCA_EQ_STATE_ALWAYS_ARMED
mdefine_line|#define MTHCA_EQ_STATE_ALWAYS_ARMED ( 3 &lt;&lt;  8)
r_enum
(brace
DECL|enumerator|MTHCA_EVENT_TYPE_COMP
id|MTHCA_EVENT_TYPE_COMP
op_assign
l_int|0x00
comma
DECL|enumerator|MTHCA_EVENT_TYPE_PATH_MIG
id|MTHCA_EVENT_TYPE_PATH_MIG
op_assign
l_int|0x01
comma
DECL|enumerator|MTHCA_EVENT_TYPE_COMM_EST
id|MTHCA_EVENT_TYPE_COMM_EST
op_assign
l_int|0x02
comma
DECL|enumerator|MTHCA_EVENT_TYPE_SQ_DRAINED
id|MTHCA_EVENT_TYPE_SQ_DRAINED
op_assign
l_int|0x03
comma
DECL|enumerator|MTHCA_EVENT_TYPE_SRQ_LAST_WQE
id|MTHCA_EVENT_TYPE_SRQ_LAST_WQE
op_assign
l_int|0x13
comma
DECL|enumerator|MTHCA_EVENT_TYPE_CQ_ERROR
id|MTHCA_EVENT_TYPE_CQ_ERROR
op_assign
l_int|0x04
comma
DECL|enumerator|MTHCA_EVENT_TYPE_WQ_CATAS_ERROR
id|MTHCA_EVENT_TYPE_WQ_CATAS_ERROR
op_assign
l_int|0x05
comma
DECL|enumerator|MTHCA_EVENT_TYPE_EEC_CATAS_ERROR
id|MTHCA_EVENT_TYPE_EEC_CATAS_ERROR
op_assign
l_int|0x06
comma
DECL|enumerator|MTHCA_EVENT_TYPE_PATH_MIG_FAILED
id|MTHCA_EVENT_TYPE_PATH_MIG_FAILED
op_assign
l_int|0x07
comma
DECL|enumerator|MTHCA_EVENT_TYPE_WQ_INVAL_REQ_ERROR
id|MTHCA_EVENT_TYPE_WQ_INVAL_REQ_ERROR
op_assign
l_int|0x10
comma
DECL|enumerator|MTHCA_EVENT_TYPE_WQ_ACCESS_ERROR
id|MTHCA_EVENT_TYPE_WQ_ACCESS_ERROR
op_assign
l_int|0x11
comma
DECL|enumerator|MTHCA_EVENT_TYPE_SRQ_CATAS_ERROR
id|MTHCA_EVENT_TYPE_SRQ_CATAS_ERROR
op_assign
l_int|0x12
comma
DECL|enumerator|MTHCA_EVENT_TYPE_LOCAL_CATAS_ERROR
id|MTHCA_EVENT_TYPE_LOCAL_CATAS_ERROR
op_assign
l_int|0x08
comma
DECL|enumerator|MTHCA_EVENT_TYPE_PORT_CHANGE
id|MTHCA_EVENT_TYPE_PORT_CHANGE
op_assign
l_int|0x09
comma
DECL|enumerator|MTHCA_EVENT_TYPE_EQ_OVERFLOW
id|MTHCA_EVENT_TYPE_EQ_OVERFLOW
op_assign
l_int|0x0f
comma
DECL|enumerator|MTHCA_EVENT_TYPE_ECC_DETECT
id|MTHCA_EVENT_TYPE_ECC_DETECT
op_assign
l_int|0x0e
comma
DECL|enumerator|MTHCA_EVENT_TYPE_CMD
id|MTHCA_EVENT_TYPE_CMD
op_assign
l_int|0x0a
)brace
suffix:semicolon
DECL|macro|MTHCA_ASYNC_EVENT_MASK
mdefine_line|#define MTHCA_ASYNC_EVENT_MASK ((1ULL &lt;&lt; MTHCA_EVENT_TYPE_PATH_MIG)           | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_COMM_EST)           | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_SQ_DRAINED)         | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_CQ_ERROR)           | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_WQ_CATAS_ERROR)     | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_EEC_CATAS_ERROR)    | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_PATH_MIG_FAILED)    | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_WQ_INVAL_REQ_ERROR) | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_WQ_ACCESS_ERROR)    | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_LOCAL_CATAS_ERROR)  | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_PORT_CHANGE)        | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_ECC_DETECT))
DECL|macro|MTHCA_SRQ_EVENT_MASK
mdefine_line|#define MTHCA_SRQ_EVENT_MASK    (1ULL &lt;&lt; MTHCA_EVENT_TYPE_SRQ_CATAS_ERROR)    | &bslash;&n;&t;&t;&t;&t;(1ULL &lt;&lt; MTHCA_EVENT_TYPE_SRQ_LAST_WQE)
DECL|macro|MTHCA_CMD_EVENT_MASK
mdefine_line|#define MTHCA_CMD_EVENT_MASK    (1ULL &lt;&lt; MTHCA_EVENT_TYPE_CMD)
DECL|macro|MTHCA_EQ_DB_INC_CI
mdefine_line|#define MTHCA_EQ_DB_INC_CI     (1 &lt;&lt; 24)
DECL|macro|MTHCA_EQ_DB_REQ_NOT
mdefine_line|#define MTHCA_EQ_DB_REQ_NOT    (2 &lt;&lt; 24)
DECL|macro|MTHCA_EQ_DB_DISARM_CQ
mdefine_line|#define MTHCA_EQ_DB_DISARM_CQ  (3 &lt;&lt; 24)
DECL|macro|MTHCA_EQ_DB_SET_CI
mdefine_line|#define MTHCA_EQ_DB_SET_CI     (4 &lt;&lt; 24)
DECL|macro|MTHCA_EQ_DB_ALWAYS_ARM
mdefine_line|#define MTHCA_EQ_DB_ALWAYS_ARM (5 &lt;&lt; 24)
DECL|struct|mthca_eqe
r_struct
id|mthca_eqe
(brace
DECL|member|reserved1
id|u8
id|reserved1
suffix:semicolon
DECL|member|type
id|u8
id|type
suffix:semicolon
DECL|member|reserved2
id|u8
id|reserved2
suffix:semicolon
DECL|member|subtype
id|u8
id|subtype
suffix:semicolon
r_union
(brace
DECL|member|raw
id|u32
id|raw
(braket
l_int|6
)braket
suffix:semicolon
r_struct
(brace
DECL|member|cqn
id|u32
id|cqn
suffix:semicolon
DECL|member|comp
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
id|comp
suffix:semicolon
r_struct
(brace
DECL|member|reserved1
id|u16
id|reserved1
suffix:semicolon
DECL|member|token
id|u16
id|token
suffix:semicolon
DECL|member|reserved2
id|u32
id|reserved2
suffix:semicolon
DECL|member|reserved3
id|u8
id|reserved3
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|status
id|u8
id|status
suffix:semicolon
DECL|member|out_param
id|u64
id|out_param
suffix:semicolon
DECL|member|cmd
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
id|cmd
suffix:semicolon
r_struct
(brace
DECL|member|qpn
id|u32
id|qpn
suffix:semicolon
DECL|member|qp
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
id|qp
suffix:semicolon
r_struct
(brace
DECL|member|cqn
id|u32
id|cqn
suffix:semicolon
DECL|member|reserved1
id|u32
id|reserved1
suffix:semicolon
DECL|member|reserved2
id|u8
id|reserved2
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|syndrome
id|u8
id|syndrome
suffix:semicolon
DECL|member|cq_err
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
id|cq_err
suffix:semicolon
r_struct
(brace
DECL|member|reserved1
id|u32
id|reserved1
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|port
id|u32
id|port
suffix:semicolon
DECL|member|port_change
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
id|port_change
suffix:semicolon
DECL|member|event
)brace
id|event
suffix:semicolon
DECL|member|reserved3
id|u8
id|reserved3
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|owner
id|u8
id|owner
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|MTHCA_EQ_ENTRY_OWNER_SW
mdefine_line|#define  MTHCA_EQ_ENTRY_OWNER_SW      (0 &lt;&lt; 7)
DECL|macro|MTHCA_EQ_ENTRY_OWNER_HW
mdefine_line|#define  MTHCA_EQ_ENTRY_OWNER_HW      (1 &lt;&lt; 7)
DECL|function|async_mask
r_static
r_inline
id|u64
id|async_mask
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
r_return
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_SRQ
ques
c_cond
id|MTHCA_ASYNC_EVENT_MASK
op_or
id|MTHCA_SRQ_EVENT_MASK
suffix:colon
id|MTHCA_ASYNC_EVENT_MASK
suffix:semicolon
)brace
DECL|function|set_eq_ci
r_static
r_inline
r_void
id|set_eq_ci
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_eq
op_star
id|eq
comma
id|u32
id|ci
)paren
(brace
id|u32
id|doorbell
(braket
l_int|2
)braket
suffix:semicolon
id|doorbell
(braket
l_int|0
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|MTHCA_EQ_DB_SET_CI
op_or
id|eq-&gt;eqn
)paren
suffix:semicolon
id|doorbell
(braket
l_int|1
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|ci
op_amp
(paren
id|eq-&gt;nent
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|mthca_write64
c_func
(paren
id|doorbell
comma
id|dev-&gt;kar
op_plus
id|MTHCA_EQ_DOORBELL
comma
id|MTHCA_GET_DOORBELL_LOCK
c_func
(paren
op_amp
id|dev-&gt;doorbell_lock
)paren
)paren
suffix:semicolon
)brace
DECL|function|eq_req_not
r_static
r_inline
r_void
id|eq_req_not
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_int
id|eqn
)paren
(brace
id|u32
id|doorbell
(braket
l_int|2
)braket
suffix:semicolon
id|doorbell
(braket
l_int|0
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|MTHCA_EQ_DB_REQ_NOT
op_or
id|eqn
)paren
suffix:semicolon
id|doorbell
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|mthca_write64
c_func
(paren
id|doorbell
comma
id|dev-&gt;kar
op_plus
id|MTHCA_EQ_DOORBELL
comma
id|MTHCA_GET_DOORBELL_LOCK
c_func
(paren
op_amp
id|dev-&gt;doorbell_lock
)paren
)paren
suffix:semicolon
)brace
DECL|function|disarm_cq
r_static
r_inline
r_void
id|disarm_cq
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_int
id|eqn
comma
r_int
id|cqn
)paren
(brace
id|u32
id|doorbell
(braket
l_int|2
)braket
suffix:semicolon
id|doorbell
(braket
l_int|0
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|MTHCA_EQ_DB_DISARM_CQ
op_or
id|eqn
)paren
suffix:semicolon
id|doorbell
(braket
l_int|1
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|cqn
)paren
suffix:semicolon
id|mthca_write64
c_func
(paren
id|doorbell
comma
id|dev-&gt;kar
op_plus
id|MTHCA_EQ_DOORBELL
comma
id|MTHCA_GET_DOORBELL_LOCK
c_func
(paren
op_amp
id|dev-&gt;doorbell_lock
)paren
)paren
suffix:semicolon
)brace
DECL|function|get_eqe
r_static
r_inline
r_struct
id|mthca_eqe
op_star
id|get_eqe
c_func
(paren
r_struct
id|mthca_eq
op_star
id|eq
comma
id|u32
id|entry
)paren
(brace
r_int
r_int
id|off
op_assign
(paren
id|entry
op_amp
(paren
id|eq-&gt;nent
op_minus
l_int|1
)paren
)paren
op_star
id|MTHCA_EQ_ENTRY_SIZE
suffix:semicolon
r_return
id|eq-&gt;page_list
(braket
id|off
op_div
id|PAGE_SIZE
)braket
dot
id|buf
op_plus
id|off
op_mod
id|PAGE_SIZE
suffix:semicolon
)brace
DECL|function|next_eqe_sw
r_static
r_inline
r_struct
id|mthca_eqe
op_star
id|next_eqe_sw
c_func
(paren
r_struct
id|mthca_eq
op_star
id|eq
)paren
(brace
r_struct
id|mthca_eqe
op_star
id|eqe
suffix:semicolon
id|eqe
op_assign
id|get_eqe
c_func
(paren
id|eq
comma
id|eq-&gt;cons_index
)paren
suffix:semicolon
r_return
(paren
id|MTHCA_EQ_ENTRY_OWNER_HW
op_amp
id|eqe-&gt;owner
)paren
ques
c_cond
l_int|NULL
suffix:colon
id|eqe
suffix:semicolon
)brace
DECL|function|set_eqe_hw
r_static
r_inline
r_void
id|set_eqe_hw
c_func
(paren
r_struct
id|mthca_eqe
op_star
id|eqe
)paren
(brace
id|eqe-&gt;owner
op_assign
id|MTHCA_EQ_ENTRY_OWNER_HW
suffix:semicolon
)brace
DECL|function|port_change
r_static
r_void
id|port_change
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_int
id|port
comma
r_int
id|active
)paren
(brace
r_struct
id|ib_event
id|record
suffix:semicolon
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;Port change to %s for port %d&bslash;n&quot;
comma
id|active
ques
c_cond
l_string|&quot;active&quot;
suffix:colon
l_string|&quot;down&quot;
comma
id|port
)paren
suffix:semicolon
id|record.device
op_assign
op_amp
id|dev-&gt;ib_dev
suffix:semicolon
id|record.event
op_assign
id|active
ques
c_cond
id|IB_EVENT_PORT_ACTIVE
suffix:colon
id|IB_EVENT_PORT_ERR
suffix:semicolon
id|record.element.port_num
op_assign
id|port
suffix:semicolon
id|ib_dispatch_event
c_func
(paren
op_amp
id|record
)paren
suffix:semicolon
)brace
DECL|function|mthca_eq_int
r_static
r_void
id|mthca_eq_int
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_eq
op_star
id|eq
)paren
(brace
r_struct
id|mthca_eqe
op_star
id|eqe
suffix:semicolon
r_int
id|disarm_cqn
suffix:semicolon
r_int
id|eqes_found
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|eqe
op_assign
id|next_eqe_sw
c_func
(paren
id|eq
)paren
)paren
)paren
(brace
r_int
id|set_ci
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Make sure we read EQ entry contents after we&squot;ve&n;&t;&t; * checked the ownership bit.&n;&t;&t; */
id|rmb
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|eqe-&gt;type
)paren
(brace
r_case
id|MTHCA_EVENT_TYPE_COMP
suffix:colon
id|disarm_cqn
op_assign
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.comp.cqn
)paren
op_amp
l_int|0xffffff
suffix:semicolon
id|disarm_cq
c_func
(paren
id|dev
comma
id|eq-&gt;eqn
comma
id|disarm_cqn
)paren
suffix:semicolon
id|mthca_cq_event
c_func
(paren
id|dev
comma
id|disarm_cqn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_PATH_MIG
suffix:colon
id|mthca_qp_event
c_func
(paren
id|dev
comma
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.qp.qpn
)paren
op_amp
l_int|0xffffff
comma
id|IB_EVENT_PATH_MIG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_COMM_EST
suffix:colon
id|mthca_qp_event
c_func
(paren
id|dev
comma
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.qp.qpn
)paren
op_amp
l_int|0xffffff
comma
id|IB_EVENT_COMM_EST
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_SQ_DRAINED
suffix:colon
id|mthca_qp_event
c_func
(paren
id|dev
comma
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.qp.qpn
)paren
op_amp
l_int|0xffffff
comma
id|IB_EVENT_SQ_DRAINED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_WQ_CATAS_ERROR
suffix:colon
id|mthca_qp_event
c_func
(paren
id|dev
comma
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.qp.qpn
)paren
op_amp
l_int|0xffffff
comma
id|IB_EVENT_QP_FATAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_PATH_MIG_FAILED
suffix:colon
id|mthca_qp_event
c_func
(paren
id|dev
comma
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.qp.qpn
)paren
op_amp
l_int|0xffffff
comma
id|IB_EVENT_PATH_MIG_ERR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_WQ_INVAL_REQ_ERROR
suffix:colon
id|mthca_qp_event
c_func
(paren
id|dev
comma
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.qp.qpn
)paren
op_amp
l_int|0xffffff
comma
id|IB_EVENT_QP_REQ_ERR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_WQ_ACCESS_ERROR
suffix:colon
id|mthca_qp_event
c_func
(paren
id|dev
comma
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.qp.qpn
)paren
op_amp
l_int|0xffffff
comma
id|IB_EVENT_QP_ACCESS_ERR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_CMD
suffix:colon
id|mthca_cmd_event
c_func
(paren
id|dev
comma
id|be16_to_cpu
c_func
(paren
id|eqe-&gt;event.cmd.token
)paren
comma
id|eqe-&gt;event.cmd.status
comma
id|be64_to_cpu
c_func
(paren
id|eqe-&gt;event.cmd.out_param
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * cmd_event() may add more commands.&n;&t;&t;&t; * The card will think the queue has overflowed if&n;&t;&t;&t; * we don&squot;t tell it we&squot;ve been processing events.&n;&t;&t;&t; */
id|set_ci
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_PORT_CHANGE
suffix:colon
id|port_change
c_func
(paren
id|dev
comma
(paren
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.port_change.port
)paren
op_rshift
l_int|28
)paren
op_amp
l_int|3
comma
id|eqe-&gt;subtype
op_eq
l_int|0x4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_CQ_ERROR
suffix:colon
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;CQ %s on CQN %08x&bslash;n&quot;
comma
id|eqe-&gt;event.cq_err.syndrome
op_eq
l_int|1
ques
c_cond
l_string|&quot;overrun&quot;
suffix:colon
l_string|&quot;access violation&quot;
comma
id|be32_to_cpu
c_func
(paren
id|eqe-&gt;event.cq_err.cqn
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_EQ_OVERFLOW
suffix:colon
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;EQ overrun on EQN %d&bslash;n&quot;
comma
id|eq-&gt;eqn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTHCA_EVENT_TYPE_EEC_CATAS_ERROR
suffix:colon
r_case
id|MTHCA_EVENT_TYPE_SRQ_CATAS_ERROR
suffix:colon
r_case
id|MTHCA_EVENT_TYPE_LOCAL_CATAS_ERROR
suffix:colon
r_case
id|MTHCA_EVENT_TYPE_ECC_DETECT
suffix:colon
r_default
suffix:colon
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;Unhandled event %02x(%02x) on EQ %d&bslash;n&quot;
comma
id|eqe-&gt;type
comma
id|eqe-&gt;subtype
comma
id|eq-&gt;eqn
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|set_eqe_hw
c_func
(paren
id|eqe
)paren
suffix:semicolon
op_increment
id|eq-&gt;cons_index
suffix:semicolon
id|eqes_found
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|set_ci
)paren
(brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* see comment below */
id|set_eq_ci
c_func
(paren
id|dev
comma
id|eq
comma
id|eq-&gt;cons_index
)paren
suffix:semicolon
id|set_ci
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * This barrier makes sure that all updates to&n;&t; * ownership bits done by set_eqe_hw() hit memory&n;&t; * before the consumer index is updated.  set_eq_ci()&n;&t; * allows the HCA to possibly write more EQ entries,&n;&t; * and we want to avoid the exceedingly unlikely&n;&t; * possibility of the HCA writing an entry and then&n;&t; * having set_eqe_hw() overwrite the owner field.&n;&t; */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|eqes_found
)paren
)paren
(brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|set_eq_ci
c_func
(paren
id|dev
comma
id|eq
comma
id|eq-&gt;cons_index
)paren
suffix:semicolon
)brace
id|eq_req_not
c_func
(paren
id|dev
comma
id|eq-&gt;eqn
)paren
suffix:semicolon
)brace
DECL|function|mthca_interrupt
r_static
id|irqreturn_t
id|mthca_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|mthca_dev
op_star
id|dev
op_assign
id|dev_ptr
suffix:semicolon
id|u32
id|ecr
suffix:semicolon
r_int
id|work
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;eq_table.clr_mask
)paren
id|writel
c_func
(paren
id|dev-&gt;eq_table.clr_mask
comma
id|dev-&gt;eq_table.clr_int
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ecr
op_assign
id|readl
c_func
(paren
id|dev-&gt;hcr
op_plus
id|MTHCA_ECR_OFFSET
op_plus
l_int|4
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|work
op_assign
l_int|1
suffix:semicolon
id|writel
c_func
(paren
id|ecr
comma
id|dev-&gt;hcr
op_plus
id|MTHCA_ECR_CLR_OFFSET
op_plus
l_int|4
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MTHCA_NUM_EQ
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|ecr
op_amp
id|dev-&gt;eq_table.eq
(braket
id|i
)braket
dot
id|ecr_mask
)paren
id|mthca_eq_int
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;eq_table.eq
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
id|IRQ_RETVAL
c_func
(paren
id|work
)paren
suffix:semicolon
)brace
DECL|function|mthca_msi_x_interrupt
r_static
id|irqreturn_t
id|mthca_msi_x_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|eq_ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|mthca_eq
op_star
id|eq
op_assign
id|eq_ptr
suffix:semicolon
r_struct
id|mthca_dev
op_star
id|dev
op_assign
id|eq-&gt;dev
suffix:semicolon
id|mthca_eq_int
c_func
(paren
id|dev
comma
id|eq
)paren
suffix:semicolon
multiline_comment|/* MSI-X vectors always belong to us */
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|mthca_create_eq
r_static
r_int
id|__devinit
id|mthca_create_eq
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_int
id|nent
comma
id|u8
id|intr
comma
r_struct
id|mthca_eq
op_star
id|eq
)paren
(brace
r_int
id|npages
op_assign
(paren
id|nent
op_star
id|MTHCA_EQ_ENTRY_SIZE
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
id|u64
op_star
id|dma_list
op_assign
l_int|NULL
suffix:semicolon
id|dma_addr_t
id|t
suffix:semicolon
r_void
op_star
id|mailbox
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mthca_eq_context
op_star
id|eq_context
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u8
id|status
suffix:semicolon
multiline_comment|/* Make sure EQ size is aligned to a power of 2 size. */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nent
suffix:semicolon
id|i
op_lshift_assign
l_int|1
)paren
suffix:semicolon
multiline_comment|/* nothing */
id|nent
op_assign
id|i
suffix:semicolon
id|eq-&gt;dev
op_assign
id|dev
suffix:semicolon
id|eq-&gt;page_list
op_assign
id|kmalloc
c_func
(paren
id|npages
op_star
r_sizeof
op_star
id|eq-&gt;page_list
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|eq-&gt;page_list
)paren
r_goto
id|err_out
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
op_increment
id|i
)paren
id|eq-&gt;page_list
(braket
id|i
)braket
dot
id|buf
op_assign
l_int|NULL
suffix:semicolon
id|dma_list
op_assign
id|kmalloc
c_func
(paren
id|npages
op_star
r_sizeof
op_star
id|dma_list
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma_list
)paren
r_goto
id|err_out_free
suffix:semicolon
id|mailbox
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|eq_context
op_plus
id|MTHCA_CMD_MAILBOX_EXTRA
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mailbox
)paren
r_goto
id|err_out_free
suffix:semicolon
id|eq_context
op_assign
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
op_increment
id|i
)paren
(brace
id|eq-&gt;page_list
(braket
id|i
)braket
dot
id|buf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|dev-&gt;pdev
comma
id|PAGE_SIZE
comma
op_amp
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|eq-&gt;page_list
(braket
id|i
)braket
dot
id|buf
)paren
r_goto
id|err_out_free
suffix:semicolon
id|dma_list
(braket
id|i
)braket
op_assign
id|t
suffix:semicolon
id|pci_unmap_addr_set
c_func
(paren
op_amp
id|eq-&gt;page_list
(braket
id|i
)braket
comma
id|mapping
comma
id|t
)paren
suffix:semicolon
id|memset
c_func
(paren
id|eq-&gt;page_list
(braket
id|i
)braket
dot
id|buf
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nent
suffix:semicolon
op_increment
id|i
)paren
id|set_eqe_hw
c_func
(paren
id|get_eqe
c_func
(paren
id|eq
comma
id|i
)paren
)paren
suffix:semicolon
id|eq-&gt;eqn
op_assign
id|mthca_alloc
c_func
(paren
op_amp
id|dev-&gt;eq_table.alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eq-&gt;eqn
op_eq
op_minus
l_int|1
)paren
r_goto
id|err_out_free
suffix:semicolon
id|err
op_assign
id|mthca_mr_alloc_phys
c_func
(paren
id|dev
comma
id|dev-&gt;driver_pd.pd_num
comma
id|dma_list
comma
id|PAGE_SHIFT
comma
id|npages
comma
l_int|0
comma
id|npages
op_star
id|PAGE_SIZE
comma
id|MTHCA_MPT_FLAG_LOCAL_WRITE
op_or
id|MTHCA_MPT_FLAG_LOCAL_READ
comma
op_amp
id|eq-&gt;mr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_free_eq
suffix:semicolon
id|eq-&gt;nent
op_assign
id|nent
suffix:semicolon
id|memset
c_func
(paren
id|eq_context
comma
l_int|0
comma
r_sizeof
op_star
id|eq_context
)paren
suffix:semicolon
id|eq_context-&gt;flags
op_assign
id|cpu_to_be32
c_func
(paren
id|MTHCA_EQ_STATUS_OK
op_or
id|MTHCA_EQ_OWNER_HW
op_or
id|MTHCA_EQ_STATE_ARMED
op_or
id|MTHCA_EQ_FLAG_TR
)paren
suffix:semicolon
id|eq_context-&gt;start
op_assign
id|cpu_to_be64
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|eq_context-&gt;logsize_usrpage
op_assign
id|cpu_to_be32
c_func
(paren
(paren
id|ffs
c_func
(paren
id|nent
)paren
op_minus
l_int|1
)paren
op_lshift
l_int|24
op_or
id|MTHCA_KAR_PAGE
)paren
suffix:semicolon
id|eq_context-&gt;pd
op_assign
id|cpu_to_be32
c_func
(paren
id|dev-&gt;driver_pd.pd_num
)paren
suffix:semicolon
id|eq_context-&gt;intr
op_assign
id|intr
suffix:semicolon
id|eq_context-&gt;lkey
op_assign
id|cpu_to_be32
c_func
(paren
id|eq-&gt;mr.ibmr.lkey
)paren
suffix:semicolon
id|err
op_assign
id|mthca_SW2HW_EQ
c_func
(paren
id|dev
comma
id|eq_context
comma
id|eq-&gt;eqn
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;SW2HW_EQ failed (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|err_out_free_mr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;SW2HW_EQ returned status 0x%02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_out_free_mr
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|dma_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
id|eq-&gt;ecr_mask
op_assign
id|swab32
c_func
(paren
l_int|1
op_lshift
id|eq-&gt;eqn
)paren
suffix:semicolon
id|eq-&gt;cons_index
op_assign
l_int|0
suffix:semicolon
id|eq_req_not
c_func
(paren
id|dev
comma
id|eq-&gt;eqn
)paren
suffix:semicolon
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;Allocated EQ %d with %d entries&bslash;n&quot;
comma
id|eq-&gt;eqn
comma
id|nent
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
id|err_out_free_mr
suffix:colon
id|mthca_free_mr
c_func
(paren
id|dev
comma
op_amp
id|eq-&gt;mr
)paren
suffix:semicolon
id|err_out_free_eq
suffix:colon
id|mthca_free
c_func
(paren
op_amp
id|dev-&gt;eq_table.alloc
comma
id|eq-&gt;eqn
)paren
suffix:semicolon
id|err_out_free
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|eq-&gt;page_list
(braket
id|i
)braket
dot
id|buf
)paren
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pdev
comma
id|PAGE_SIZE
comma
id|eq-&gt;page_list
(braket
id|i
)braket
dot
id|buf
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|eq-&gt;page_list
(braket
id|i
)braket
comma
id|mapping
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|eq-&gt;page_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dma_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_free_eq
r_static
r_void
id|mthca_free_eq
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
r_struct
id|mthca_eq
op_star
id|eq
)paren
(brace
r_void
op_star
id|mailbox
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u8
id|status
suffix:semicolon
r_int
id|npages
op_assign
(paren
id|eq-&gt;nent
op_star
id|MTHCA_EQ_ENTRY_SIZE
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mailbox
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mthca_eq_context
)paren
op_plus
id|MTHCA_CMD_MAILBOX_EXTRA
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mailbox
)paren
r_return
suffix:semicolon
id|err
op_assign
id|mthca_HW2SW_EQ
c_func
(paren
id|dev
comma
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
comma
id|eq-&gt;eqn
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;HW2SW_EQ failed (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;HW2SW_EQ returned status 0x%02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
(brace
id|mthca_dbg
c_func
(paren
id|dev
comma
l_string|&quot;Dumping EQ context %02x:&bslash;n&quot;
comma
id|eq-&gt;eqn
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
r_struct
id|mthca_eq_context
)paren
op_div
l_int|4
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|4
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;[%02x] &quot;
comma
id|i
op_star
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|be32_to_cpup
c_func
(paren
id|MAILBOX_ALIGN
c_func
(paren
id|mailbox
)paren
op_plus
id|i
op_star
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|4
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|mthca_free_mr
c_func
(paren
id|dev
comma
op_amp
id|eq-&gt;mr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
op_increment
id|i
)paren
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pdev
comma
id|PAGE_SIZE
comma
id|eq-&gt;page_list
(braket
id|i
)braket
dot
id|buf
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|eq-&gt;page_list
(braket
id|i
)braket
comma
id|mapping
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|eq-&gt;page_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mailbox
)paren
suffix:semicolon
)brace
DECL|function|mthca_free_irqs
r_static
r_void
id|mthca_free_irqs
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;eq_table.have_irq
)paren
id|free_irq
c_func
(paren
id|dev-&gt;pdev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MTHCA_NUM_EQ
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|dev-&gt;eq_table.eq
(braket
id|i
)braket
dot
id|have_irq
)paren
id|free_irq
c_func
(paren
id|dev-&gt;eq_table.eq
(braket
id|i
)braket
dot
id|msi_x_vector
comma
id|dev-&gt;eq_table.eq
op_plus
id|i
)paren
suffix:semicolon
)brace
DECL|function|mthca_map_eq_icm
r_int
id|__devinit
id|mthca_map_eq_icm
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
comma
id|u64
id|icm_virt
)paren
(brace
r_int
id|ret
suffix:semicolon
id|u8
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * We assume that mapping one page is enough for the whole EQ&n;&t; * context table.  This is fine with all current HCAs, because&n;&t; * we only use 32 EQs and each EQ uses 32 bytes of context&n;&t; * memory, or 1 KB total.&n;&t; */
id|dev-&gt;eq_table.icm_virt
op_assign
id|icm_virt
suffix:semicolon
id|dev-&gt;eq_table.icm_page
op_assign
id|alloc_page
c_func
(paren
id|GFP_HIGHUSER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;eq_table.icm_page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;eq_table.icm_dma
op_assign
id|pci_map_page
c_func
(paren
id|dev-&gt;pdev
comma
id|dev-&gt;eq_table.icm_page
comma
l_int|0
comma
id|PAGE_SIZE
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dma_mapping_error
c_func
(paren
id|dev-&gt;eq_table.icm_dma
)paren
)paren
(brace
id|__free_page
c_func
(paren
id|dev-&gt;eq_table.icm_page
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ret
op_assign
id|mthca_MAP_ICM_page
c_func
(paren
id|dev
comma
id|dev-&gt;eq_table.icm_dma
comma
id|icm_virt
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
id|status
)paren
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|pci_unmap_page
c_func
(paren
id|dev-&gt;pdev
comma
id|dev-&gt;eq_table.icm_dma
comma
id|PAGE_SIZE
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|__free_page
c_func
(paren
id|dev-&gt;eq_table.icm_page
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|mthca_unmap_eq_icm
r_void
id|__devexit
id|mthca_unmap_eq_icm
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
id|u8
id|status
suffix:semicolon
id|mthca_UNMAP_ICM
c_func
(paren
id|dev
comma
id|dev-&gt;eq_table.icm_virt
comma
id|PAGE_SIZE
op_div
l_int|4096
comma
op_amp
id|status
)paren
suffix:semicolon
id|pci_unmap_page
c_func
(paren
id|dev-&gt;pdev
comma
id|dev-&gt;eq_table.icm_dma
comma
id|PAGE_SIZE
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|__free_page
c_func
(paren
id|dev-&gt;eq_table.icm_page
)paren
suffix:semicolon
)brace
DECL|function|mthca_init_eq_table
r_int
id|__devinit
id|mthca_init_eq_table
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|u8
id|intr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|err
op_assign
id|mthca_alloc_init
c_func
(paren
op_amp
id|dev-&gt;eq_table.alloc
comma
id|dev-&gt;limits.num_eqs
comma
id|dev-&gt;limits.num_eqs
op_minus
l_int|1
comma
id|dev-&gt;limits.reserved_eqs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI
op_logical_or
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI_X
)paren
(brace
id|dev-&gt;eq_table.clr_mask
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;eq_table.clr_mask
op_assign
id|swab32
c_func
(paren
l_int|1
op_lshift
(paren
id|dev-&gt;eq_table.inta_pin
op_amp
l_int|31
)paren
)paren
suffix:semicolon
id|dev-&gt;eq_table.clr_int
op_assign
id|dev-&gt;clr_base
op_plus
(paren
id|dev-&gt;eq_table.inta_pin
OL
l_int|31
ques
c_cond
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
id|intr
op_assign
(paren
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI
)paren
ques
c_cond
l_int|128
suffix:colon
id|dev-&gt;eq_table.inta_pin
suffix:semicolon
id|err
op_assign
id|mthca_create_eq
c_func
(paren
id|dev
comma
id|dev-&gt;limits.num_cqs
comma
(paren
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI_X
)paren
ques
c_cond
l_int|128
suffix:colon
id|intr
comma
op_amp
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_COMP
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_free
suffix:semicolon
id|err
op_assign
id|mthca_create_eq
c_func
(paren
id|dev
comma
id|MTHCA_NUM_ASYNC_EQE
comma
(paren
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI_X
)paren
ques
c_cond
l_int|129
suffix:colon
id|intr
comma
op_amp
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_ASYNC
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_comp
suffix:semicolon
id|err
op_assign
id|mthca_create_eq
c_func
(paren
id|dev
comma
id|MTHCA_NUM_CMD_EQE
comma
(paren
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI_X
)paren
ques
c_cond
l_int|130
suffix:colon
id|intr
comma
op_amp
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_CMD
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_async
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mthca_flags
op_amp
id|MTHCA_FLAG_MSI_X
)paren
(brace
r_static
r_const
r_char
op_star
id|eq_name
(braket
)braket
op_assign
(brace
(braket
id|MTHCA_EQ_COMP
)braket
op_assign
id|DRV_NAME
l_string|&quot; (comp)&quot;
comma
(braket
id|MTHCA_EQ_ASYNC
)braket
op_assign
id|DRV_NAME
l_string|&quot; (async)&quot;
comma
(braket
id|MTHCA_EQ_CMD
)braket
op_assign
id|DRV_NAME
l_string|&quot; (cmd)&quot;
)brace
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MTHCA_NUM_EQ
suffix:semicolon
op_increment
id|i
)paren
(brace
id|err
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;eq_table.eq
(braket
id|i
)braket
dot
id|msi_x_vector
comma
id|mthca_msi_x_interrupt
comma
l_int|0
comma
id|eq_name
(braket
id|i
)braket
comma
id|dev-&gt;eq_table.eq
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_cmd
suffix:semicolon
id|dev-&gt;eq_table.eq
(braket
id|i
)braket
dot
id|have_irq
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;pdev-&gt;irq
comma
id|mthca_interrupt
comma
id|SA_SHIRQ
comma
id|DRV_NAME
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_cmd
suffix:semicolon
id|dev-&gt;eq_table.have_irq
op_assign
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|mthca_MAP_EQ
c_func
(paren
id|dev
comma
id|async_mask
c_func
(paren
id|dev
)paren
comma
l_int|0
comma
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_ASYNC
)braket
dot
id|eqn
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;MAP_EQ for async EQ %d failed (%d)&bslash;n&quot;
comma
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_ASYNC
)braket
dot
id|eqn
comma
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;MAP_EQ for async EQ %d returned status 0x%02x&bslash;n&quot;
comma
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_ASYNC
)braket
dot
id|eqn
comma
id|status
)paren
suffix:semicolon
id|err
op_assign
id|mthca_MAP_EQ
c_func
(paren
id|dev
comma
id|MTHCA_CMD_EVENT_MASK
comma
l_int|0
comma
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_CMD
)braket
dot
id|eqn
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;MAP_EQ for cmd EQ %d failed (%d)&bslash;n&quot;
comma
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_CMD
)braket
dot
id|eqn
comma
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|mthca_warn
c_func
(paren
id|dev
comma
l_string|&quot;MAP_EQ for cmd EQ %d returned status 0x%02x&bslash;n&quot;
comma
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_CMD
)braket
dot
id|eqn
comma
id|status
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_cmd
suffix:colon
id|mthca_free_irqs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mthca_free_eq
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_CMD
)braket
)paren
suffix:semicolon
id|err_out_async
suffix:colon
id|mthca_free_eq
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_ASYNC
)braket
)paren
suffix:semicolon
id|err_out_comp
suffix:colon
id|mthca_free_eq
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_COMP
)braket
)paren
suffix:semicolon
id|err_out_free
suffix:colon
id|mthca_alloc_cleanup
c_func
(paren
op_amp
id|dev-&gt;eq_table.alloc
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|mthca_cleanup_eq_table
r_void
id|__devexit
id|mthca_cleanup_eq_table
c_func
(paren
r_struct
id|mthca_dev
op_star
id|dev
)paren
(brace
id|u8
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mthca_free_irqs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mthca_MAP_EQ
c_func
(paren
id|dev
comma
id|async_mask
c_func
(paren
id|dev
)paren
comma
l_int|1
comma
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_ASYNC
)braket
dot
id|eqn
comma
op_amp
id|status
)paren
suffix:semicolon
id|mthca_MAP_EQ
c_func
(paren
id|dev
comma
id|MTHCA_CMD_EVENT_MASK
comma
l_int|1
comma
id|dev-&gt;eq_table.eq
(braket
id|MTHCA_EQ_CMD
)braket
dot
id|eqn
comma
op_amp
id|status
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MTHCA_NUM_EQ
suffix:semicolon
op_increment
id|i
)paren
id|mthca_free_eq
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;eq_table.eq
(braket
id|i
)braket
)paren
suffix:semicolon
id|mthca_alloc_cleanup
c_func
(paren
op_amp
id|dev-&gt;eq_table.alloc
)paren
suffix:semicolon
)brace
eof
