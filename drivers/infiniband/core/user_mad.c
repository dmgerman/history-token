multiline_comment|/*&n; * Copyright (c) 2004 Topspin Communications.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: user_mad.c 1389 2004-12-27 22:56:47Z roland $&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/cdev.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/rwsem.h&gt;
macro_line|#include &lt;linux/kref.h&gt;
macro_line|#include &lt;linux/ioctl32.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;ib_mad.h&gt;
macro_line|#include &lt;ib_user_mad.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Roland Dreier&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;InfiniBand userspace MAD packet access&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
r_enum
(brace
DECL|enumerator|IB_UMAD_MAX_PORTS
id|IB_UMAD_MAX_PORTS
op_assign
l_int|256
comma
DECL|enumerator|IB_UMAD_MAX_AGENTS
id|IB_UMAD_MAX_AGENTS
op_assign
l_int|32
)brace
suffix:semicolon
DECL|struct|ib_umad_port
r_struct
id|ib_umad_port
(brace
DECL|member|devnum
r_int
id|devnum
suffix:semicolon
DECL|member|dev
r_struct
id|cdev
id|dev
suffix:semicolon
DECL|member|class_dev
r_struct
id|class_device
id|class_dev
suffix:semicolon
DECL|member|ib_dev
r_struct
id|ib_device
op_star
id|ib_dev
suffix:semicolon
DECL|member|umad_dev
r_struct
id|ib_umad_device
op_star
id|umad_dev
suffix:semicolon
DECL|member|port_num
id|u8
id|port_num
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ib_umad_device
r_struct
id|ib_umad_device
(brace
DECL|member|start_port
DECL|member|end_port
r_int
id|start_port
comma
id|end_port
suffix:semicolon
DECL|member|ref
r_struct
id|kref
id|ref
suffix:semicolon
DECL|member|port
r_struct
id|ib_umad_port
id|port
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ib_umad_file
r_struct
id|ib_umad_file
(brace
DECL|member|port
r_struct
id|ib_umad_port
op_star
id|port
suffix:semicolon
DECL|member|recv_lock
id|spinlock_t
id|recv_lock
suffix:semicolon
DECL|member|recv_list
r_struct
id|list_head
id|recv_list
suffix:semicolon
DECL|member|recv_wait
id|wait_queue_head_t
id|recv_wait
suffix:semicolon
DECL|member|agent_mutex
r_struct
id|rw_semaphore
id|agent_mutex
suffix:semicolon
DECL|member|agent
r_struct
id|ib_mad_agent
op_star
id|agent
(braket
id|IB_UMAD_MAX_AGENTS
)braket
suffix:semicolon
DECL|member|mr
r_struct
id|ib_mr
op_star
id|mr
(braket
id|IB_UMAD_MAX_AGENTS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ib_umad_packet
r_struct
id|ib_umad_packet
(brace
DECL|member|mad
r_struct
id|ib_user_mad
id|mad
suffix:semicolon
DECL|member|ah
r_struct
id|ib_ah
op_star
id|ah
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
id|DECLARE_PCI_UNMAP_ADDR
c_func
(paren
id|mapping
)paren
)brace
suffix:semicolon
DECL|variable|base_dev
r_static
id|dev_t
id|base_dev
suffix:semicolon
DECL|variable|map_lock
r_static
id|spinlock_t
id|map_lock
suffix:semicolon
r_static
id|DECLARE_BITMAP
c_func
(paren
id|dev_map
comma
id|IB_UMAD_MAX_PORTS
)paren
suffix:semicolon
r_static
r_void
id|ib_umad_add_one
c_func
(paren
r_struct
id|ib_device
op_star
id|device
)paren
suffix:semicolon
r_static
r_void
id|ib_umad_remove_one
c_func
(paren
r_struct
id|ib_device
op_star
id|device
)paren
suffix:semicolon
DECL|function|queue_packet
r_static
r_int
id|queue_packet
c_func
(paren
r_struct
id|ib_umad_file
op_star
id|file
comma
r_struct
id|ib_mad_agent
op_star
id|agent
comma
r_struct
id|ib_umad_packet
op_star
id|packet
)paren
(brace
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
r_for
c_loop
(paren
id|packet-&gt;mad.id
op_assign
l_int|0
suffix:semicolon
id|packet-&gt;mad.id
OL
id|IB_UMAD_MAX_AGENTS
suffix:semicolon
id|packet-&gt;mad.id
op_increment
)paren
r_if
c_cond
(paren
id|agent
op_eq
id|file-&gt;agent
(braket
id|packet-&gt;mad.id
)braket
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|file-&gt;recv_lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|packet-&gt;list
comma
op_amp
id|file-&gt;recv_list
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|file-&gt;recv_lock
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|file-&gt;recv_wait
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|send_handler
r_static
r_void
id|send_handler
c_func
(paren
r_struct
id|ib_mad_agent
op_star
id|agent
comma
r_struct
id|ib_mad_send_wc
op_star
id|send_wc
)paren
(brace
r_struct
id|ib_umad_file
op_star
id|file
op_assign
id|agent-&gt;context
suffix:semicolon
r_struct
id|ib_umad_packet
op_star
id|packet
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|send_wc-&gt;wr_id
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|agent-&gt;device-&gt;dma_device
comma
id|pci_unmap_addr
c_func
(paren
id|packet
comma
id|mapping
)paren
comma
r_sizeof
id|packet-&gt;mad.data
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|ib_destroy_ah
c_func
(paren
id|packet-&gt;ah
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_wc-&gt;status
op_eq
id|IB_WC_RESP_TIMEOUT_ERR
)paren
(brace
id|packet-&gt;mad.status
op_assign
id|ETIMEDOUT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_packet
c_func
(paren
id|file
comma
id|agent
comma
id|packet
)paren
)paren
r_return
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|packet
)paren
suffix:semicolon
)brace
DECL|function|recv_handler
r_static
r_void
id|recv_handler
c_func
(paren
r_struct
id|ib_mad_agent
op_star
id|agent
comma
r_struct
id|ib_mad_recv_wc
op_star
id|mad_recv_wc
)paren
(brace
r_struct
id|ib_umad_file
op_star
id|file
op_assign
id|agent-&gt;context
suffix:semicolon
r_struct
id|ib_umad_packet
op_star
id|packet
suffix:semicolon
r_if
c_cond
(paren
id|mad_recv_wc-&gt;wc-&gt;status
op_ne
id|IB_WC_SUCCESS
)paren
r_goto
id|out
suffix:semicolon
id|packet
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|packet
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|packet
comma
l_int|0
comma
r_sizeof
op_star
id|packet
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|packet-&gt;mad.data
comma
id|mad_recv_wc-&gt;recv_buf.mad
comma
r_sizeof
id|packet-&gt;mad.data
)paren
suffix:semicolon
id|packet-&gt;mad.status
op_assign
l_int|0
suffix:semicolon
id|packet-&gt;mad.qpn
op_assign
id|cpu_to_be32
c_func
(paren
id|mad_recv_wc-&gt;wc-&gt;src_qp
)paren
suffix:semicolon
id|packet-&gt;mad.lid
op_assign
id|cpu_to_be16
c_func
(paren
id|mad_recv_wc-&gt;wc-&gt;slid
)paren
suffix:semicolon
id|packet-&gt;mad.sl
op_assign
id|mad_recv_wc-&gt;wc-&gt;sl
suffix:semicolon
id|packet-&gt;mad.path_bits
op_assign
id|mad_recv_wc-&gt;wc-&gt;dlid_path_bits
suffix:semicolon
id|packet-&gt;mad.grh_present
op_assign
op_logical_neg
op_logical_neg
(paren
id|mad_recv_wc-&gt;wc-&gt;wc_flags
op_amp
id|IB_WC_GRH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;mad.grh_present
)paren
(brace
multiline_comment|/* XXX parse GRH */
id|packet-&gt;mad.gid_index
op_assign
l_int|0
suffix:semicolon
id|packet-&gt;mad.hop_limit
op_assign
l_int|0
suffix:semicolon
id|packet-&gt;mad.traffic_class
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|packet-&gt;mad.gid
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|packet-&gt;mad.flow_label
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|queue_packet
c_func
(paren
id|file
comma
id|agent
comma
id|packet
)paren
)paren
id|kfree
c_func
(paren
id|packet
)paren
suffix:semicolon
id|out
suffix:colon
id|ib_free_recv_mad
c_func
(paren
id|mad_recv_wc
)paren
suffix:semicolon
)brace
DECL|function|ib_umad_read
r_static
id|ssize_t
id|ib_umad_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|ib_umad_file
op_star
id|file
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_struct
id|ib_umad_packet
op_star
id|packet
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
r_sizeof
(paren
r_struct
id|ib_user_mad
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|file-&gt;recv_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|list_empty
c_func
(paren
op_amp
id|file-&gt;recv_list
)paren
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|file-&gt;recv_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|wait_event_interruptible
c_func
(paren
id|file-&gt;recv_wait
comma
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|file-&gt;recv_list
)paren
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|file-&gt;recv_lock
)paren
suffix:semicolon
)brace
id|packet
op_assign
id|list_entry
c_func
(paren
id|file-&gt;recv_list.next
comma
r_struct
id|ib_umad_packet
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|packet-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|file-&gt;recv_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|packet-&gt;mad
comma
r_sizeof
id|packet-&gt;mad
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_else
id|ret
op_assign
r_sizeof
id|packet-&gt;mad
suffix:semicolon
id|kfree
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ib_umad_write
r_static
id|ssize_t
id|ib_umad_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|ib_umad_file
op_star
id|file
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_struct
id|ib_umad_packet
op_star
id|packet
suffix:semicolon
r_struct
id|ib_mad_agent
op_star
id|agent
suffix:semicolon
r_struct
id|ib_ah_attr
id|ah_attr
suffix:semicolon
r_struct
id|ib_sge
id|gather_list
suffix:semicolon
r_struct
id|ib_send_wr
op_star
id|bad_wr
comma
id|wr
op_assign
(brace
dot
id|opcode
op_assign
id|IB_WR_SEND
comma
dot
id|sg_list
op_assign
op_amp
id|gather_list
comma
dot
id|num_sge
op_assign
l_int|1
comma
dot
id|send_flags
op_assign
id|IB_SEND_SIGNALED
comma
)brace
suffix:semicolon
id|u8
id|method
suffix:semicolon
id|u64
op_star
id|tid
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
r_sizeof
(paren
r_struct
id|ib_user_mad
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|packet
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|packet
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|packet-&gt;mad
comma
id|buf
comma
r_sizeof
id|packet-&gt;mad
)paren
)paren
(brace
id|kfree
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|packet-&gt;mad.id
OL
l_int|0
op_logical_or
id|packet-&gt;mad.id
op_ge
id|IB_UMAD_MAX_AGENTS
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|down_read
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
id|agent
op_assign
id|file-&gt;agent
(braket
id|packet-&gt;mad.id
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|agent
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_up
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If userspace is generating a request that will generate a&n;&t; * response, we need to make sure the high-order part of the&n;&t; * transaction ID matches the agent being used to send the&n;&t; * MAD.&n;&t; */
id|method
op_assign
(paren
(paren
r_struct
id|ib_mad_hdr
op_star
)paren
id|packet-&gt;mad.data
)paren
op_member_access_from_pointer
id|method
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|method
op_amp
id|IB_MGMT_METHOD_RESP
)paren
op_logical_and
id|method
op_ne
id|IB_MGMT_METHOD_TRAP_REPRESS
op_logical_and
id|method
op_ne
id|IB_MGMT_METHOD_SEND
)paren
(brace
id|tid
op_assign
op_amp
(paren
(paren
r_struct
id|ib_mad_hdr
op_star
)paren
id|packet-&gt;mad.data
)paren
op_member_access_from_pointer
id|tid
suffix:semicolon
op_star
id|tid
op_assign
id|cpu_to_be64
c_func
(paren
(paren
(paren
id|u64
)paren
id|agent-&gt;hi_tid
)paren
op_lshift
l_int|32
op_or
(paren
id|be64_to_cpup
c_func
(paren
id|tid
)paren
op_amp
l_int|0xffffffff
)paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|ah_attr
comma
l_int|0
comma
r_sizeof
id|ah_attr
)paren
suffix:semicolon
id|ah_attr.dlid
op_assign
id|be16_to_cpu
c_func
(paren
id|packet-&gt;mad.lid
)paren
suffix:semicolon
id|ah_attr.sl
op_assign
id|packet-&gt;mad.sl
suffix:semicolon
id|ah_attr.src_path_bits
op_assign
id|packet-&gt;mad.path_bits
suffix:semicolon
id|ah_attr.port_num
op_assign
id|file-&gt;port-&gt;port_num
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;mad.grh_present
)paren
(brace
id|ah_attr.ah_flags
op_assign
id|IB_AH_GRH
suffix:semicolon
id|memcpy
c_func
(paren
id|ah_attr.grh.dgid.raw
comma
id|packet-&gt;mad.gid
comma
l_int|16
)paren
suffix:semicolon
id|ah_attr.grh.flow_label
op_assign
id|packet-&gt;mad.flow_label
suffix:semicolon
id|ah_attr.grh.hop_limit
op_assign
id|packet-&gt;mad.hop_limit
suffix:semicolon
id|ah_attr.grh.traffic_class
op_assign
id|packet-&gt;mad.traffic_class
suffix:semicolon
)brace
id|packet-&gt;ah
op_assign
id|ib_create_ah
c_func
(paren
id|agent-&gt;qp-&gt;pd
comma
op_amp
id|ah_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|packet-&gt;ah
)paren
)paren
(brace
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|packet-&gt;ah
)paren
suffix:semicolon
r_goto
id|err_up
suffix:semicolon
)brace
id|gather_list.addr
op_assign
id|dma_map_single
c_func
(paren
id|agent-&gt;device-&gt;dma_device
comma
id|packet-&gt;mad.data
comma
r_sizeof
id|packet-&gt;mad.data
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|gather_list.length
op_assign
r_sizeof
id|packet-&gt;mad.data
suffix:semicolon
id|gather_list.lkey
op_assign
id|file-&gt;mr
(braket
id|packet-&gt;mad.id
)braket
op_member_access_from_pointer
id|lkey
suffix:semicolon
id|pci_unmap_addr_set
c_func
(paren
id|packet
comma
id|mapping
comma
id|gather_list.addr
)paren
suffix:semicolon
id|wr.wr.ud.mad_hdr
op_assign
(paren
r_struct
id|ib_mad_hdr
op_star
)paren
id|packet-&gt;mad.data
suffix:semicolon
id|wr.wr.ud.ah
op_assign
id|packet-&gt;ah
suffix:semicolon
id|wr.wr.ud.remote_qpn
op_assign
id|be32_to_cpu
c_func
(paren
id|packet-&gt;mad.qpn
)paren
suffix:semicolon
id|wr.wr.ud.remote_qkey
op_assign
id|be32_to_cpu
c_func
(paren
id|packet-&gt;mad.qkey
)paren
suffix:semicolon
id|wr.wr.ud.timeout_ms
op_assign
id|packet-&gt;mad.timeout_ms
suffix:semicolon
id|wr.wr_id
op_assign
(paren
r_int
r_int
)paren
id|packet
suffix:semicolon
id|ret
op_assign
id|ib_post_send_mad
c_func
(paren
id|agent
comma
op_amp
id|wr
comma
op_amp
id|bad_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|dma_unmap_single
c_func
(paren
id|agent-&gt;device-&gt;dma_device
comma
id|pci_unmap_addr
c_func
(paren
id|packet
comma
id|mapping
)paren
comma
r_sizeof
id|packet-&gt;mad.data
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
r_goto
id|err_up
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
r_return
r_sizeof
id|packet-&gt;mad
suffix:semicolon
id|err_up
suffix:colon
id|up_read
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
id|err
suffix:colon
id|kfree
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ib_umad_poll
r_static
r_int
r_int
id|ib_umad_poll
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|ib_umad_file
op_star
id|file
op_assign
id|filp-&gt;private_data
suffix:semicolon
multiline_comment|/* we will always be able to post a MAD send */
r_int
r_int
id|mask
op_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
id|poll_wait
c_func
(paren
id|filp
comma
op_amp
id|file-&gt;recv_wait
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|file-&gt;recv_list
)paren
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|ib_umad_reg_agent
r_static
r_int
id|ib_umad_reg_agent
c_func
(paren
r_struct
id|ib_umad_file
op_star
id|file
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ib_user_mad_reg_req
id|ureq
suffix:semicolon
r_struct
id|ib_mad_reg_req
id|req
suffix:semicolon
r_struct
id|ib_mad_agent
op_star
id|agent
suffix:semicolon
r_int
id|agent_id
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ureq
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
id|ureq
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ureq.qpn
op_ne
l_int|0
op_logical_and
id|ureq.qpn
op_ne
l_int|1
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|agent_id
op_assign
l_int|0
suffix:semicolon
id|agent_id
OL
id|IB_UMAD_MAX_AGENTS
suffix:semicolon
op_increment
id|agent_id
)paren
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;agent
(braket
id|agent_id
)braket
)paren
r_goto
id|found
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|found
suffix:colon
id|req.mgmt_class
op_assign
id|ureq.mgmt_class
suffix:semicolon
id|req.mgmt_class_version
op_assign
id|ureq.mgmt_class_version
suffix:semicolon
id|memcpy
c_func
(paren
id|req.method_mask
comma
id|ureq.method_mask
comma
r_sizeof
id|req.method_mask
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|req.oui
comma
id|ureq.oui
comma
r_sizeof
id|req.oui
)paren
suffix:semicolon
id|agent
op_assign
id|ib_register_mad_agent
c_func
(paren
id|file-&gt;port-&gt;ib_dev
comma
id|file-&gt;port-&gt;port_num
comma
id|ureq.qpn
ques
c_cond
id|IB_QPT_GSI
suffix:colon
id|IB_QPT_SMI
comma
op_amp
id|req
comma
l_int|0
comma
id|send_handler
comma
id|recv_handler
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|agent
)paren
)paren
(brace
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|agent
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|file-&gt;agent
(braket
id|agent_id
)braket
op_assign
id|agent
suffix:semicolon
id|file-&gt;mr
(braket
id|agent_id
)braket
op_assign
id|ib_get_dma_mr
c_func
(paren
id|agent-&gt;qp-&gt;pd
comma
id|IB_ACCESS_LOCAL_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|file-&gt;mr
(braket
id|agent_id
)braket
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|agent_id
comma
(paren
id|u32
id|__user
op_star
)paren
(paren
id|arg
op_plus
m_offsetof
(paren
r_struct
id|ib_user_mad_reg_req
comma
id|id
)paren
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|err_mr
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|err_mr
suffix:colon
id|ib_dereg_mr
c_func
(paren
id|file-&gt;mr
(braket
id|agent_id
)braket
)paren
suffix:semicolon
id|err
suffix:colon
id|file-&gt;agent
(braket
id|agent_id
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ib_unregister_mad_agent
c_func
(paren
id|agent
)paren
suffix:semicolon
id|out
suffix:colon
id|up_write
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ib_umad_unreg_agent
r_static
r_int
id|ib_umad_unreg_agent
c_func
(paren
r_struct
id|ib_umad_file
op_star
id|file
comma
r_int
r_int
id|arg
)paren
(brace
id|u32
id|id
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|id
comma
(paren
id|u32
id|__user
op_star
)paren
id|arg
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|id
OL
l_int|0
op_logical_or
id|id
op_ge
id|IB_UMAD_MAX_AGENTS
op_logical_or
op_logical_neg
id|file-&gt;agent
(braket
id|id
)braket
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ib_dereg_mr
c_func
(paren
id|file-&gt;mr
(braket
id|id
)braket
)paren
suffix:semicolon
id|ib_unregister_mad_agent
c_func
(paren
id|file-&gt;agent
(braket
id|id
)braket
)paren
suffix:semicolon
id|file-&gt;agent
(braket
id|id
)braket
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
id|up_write
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ib_umad_ioctl
r_static
r_int
id|ib_umad_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IB_USER_MAD_REGISTER_AGENT
suffix:colon
r_return
id|ib_umad_reg_agent
c_func
(paren
id|filp-&gt;private_data
comma
id|arg
)paren
suffix:semicolon
r_case
id|IB_USER_MAD_UNREGISTER_AGENT
suffix:colon
r_return
id|ib_umad_unreg_agent
c_func
(paren
id|filp-&gt;private_data
comma
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
DECL|function|ib_umad_open
r_static
r_int
id|ib_umad_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|ib_umad_port
op_star
id|port
op_assign
id|container_of
c_func
(paren
id|inode-&gt;i_cdev
comma
r_struct
id|ib_umad_port
comma
id|dev
)paren
suffix:semicolon
r_struct
id|ib_umad_file
op_star
id|file
suffix:semicolon
id|file
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|file
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|file
comma
l_int|0
comma
r_sizeof
op_star
id|file
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|file-&gt;recv_lock
)paren
suffix:semicolon
id|init_rwsem
c_func
(paren
op_amp
id|file-&gt;agent_mutex
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|file-&gt;recv_list
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|file-&gt;recv_wait
)paren
suffix:semicolon
id|file-&gt;port
op_assign
id|port
suffix:semicolon
id|filp-&gt;private_data
op_assign
id|file
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ib_umad_close
r_static
r_int
id|ib_umad_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|ib_umad_file
op_star
id|file
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IB_UMAD_MAX_AGENTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|file-&gt;agent
(braket
id|i
)braket
)paren
(brace
id|ib_dereg_mr
c_func
(paren
id|file-&gt;mr
(braket
id|i
)braket
)paren
suffix:semicolon
id|ib_unregister_mad_agent
c_func
(paren
id|file-&gt;agent
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|umad_fops
r_static
r_struct
id|file_operations
id|umad_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|ib_umad_read
comma
dot
id|write
op_assign
id|ib_umad_write
comma
dot
id|poll
op_assign
id|ib_umad_poll
comma
dot
id|ioctl
op_assign
id|ib_umad_ioctl
comma
dot
id|open
op_assign
id|ib_umad_open
comma
dot
id|release
op_assign
id|ib_umad_close
)brace
suffix:semicolon
DECL|variable|umad_client
r_static
r_struct
id|ib_client
id|umad_client
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;umad&quot;
comma
dot
id|add
op_assign
id|ib_umad_add_one
comma
dot
id|remove
op_assign
id|ib_umad_remove_one
)brace
suffix:semicolon
DECL|function|show_dev
r_static
id|ssize_t
id|show_dev
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ib_umad_port
op_star
id|port
op_assign
id|container_of
c_func
(paren
id|class_dev
comma
r_struct
id|ib_umad_port
comma
id|class_dev
)paren
suffix:semicolon
r_return
id|print_dev_t
c_func
(paren
id|buf
comma
id|port-&gt;dev.dev
)paren
suffix:semicolon
)brace
r_static
id|CLASS_DEVICE_ATTR
c_func
(paren
id|dev
comma
id|S_IRUGO
comma
id|show_dev
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|show_ibdev
r_static
id|ssize_t
id|show_ibdev
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ib_umad_port
op_star
id|port
op_assign
id|container_of
c_func
(paren
id|class_dev
comma
r_struct
id|ib_umad_port
comma
id|class_dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|port-&gt;ib_dev-&gt;name
)paren
suffix:semicolon
)brace
r_static
id|CLASS_DEVICE_ATTR
c_func
(paren
id|ibdev
comma
id|S_IRUGO
comma
id|show_ibdev
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|show_port
r_static
id|ssize_t
id|show_port
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ib_umad_port
op_star
id|port
op_assign
id|container_of
c_func
(paren
id|class_dev
comma
r_struct
id|ib_umad_port
comma
id|class_dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|port-&gt;port_num
)paren
suffix:semicolon
)brace
r_static
id|CLASS_DEVICE_ATTR
c_func
(paren
id|port
comma
id|S_IRUGO
comma
id|show_port
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|ib_umad_release_dev
r_static
r_void
id|ib_umad_release_dev
c_func
(paren
r_struct
id|kref
op_star
id|ref
)paren
(brace
r_struct
id|ib_umad_device
op_star
id|dev
op_assign
id|container_of
c_func
(paren
id|ref
comma
r_struct
id|ib_umad_device
comma
id|ref
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ib_umad_release_port
r_static
r_void
id|ib_umad_release_port
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
)paren
(brace
r_struct
id|ib_umad_port
op_star
id|port
op_assign
id|container_of
c_func
(paren
id|class_dev
comma
r_struct
id|ib_umad_port
comma
id|class_dev
)paren
suffix:semicolon
id|cdev_del
c_func
(paren
op_amp
id|port-&gt;dev
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|port-&gt;devnum
comma
id|dev_map
)paren
suffix:semicolon
id|kref_put
c_func
(paren
op_amp
id|port-&gt;umad_dev-&gt;ref
comma
id|ib_umad_release_dev
)paren
suffix:semicolon
)brace
DECL|variable|umad_class
r_static
r_struct
r_class
id|umad_class
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;infiniband_mad&quot;
comma
dot
id|release
op_assign
id|ib_umad_release_port
)brace
suffix:semicolon
DECL|function|show_abi_version
r_static
id|ssize_t
id|show_abi_version
c_func
(paren
r_struct
r_class
op_star
r_class
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|IB_USER_MAD_ABI_VERSION
)paren
suffix:semicolon
)brace
r_static
id|CLASS_ATTR
c_func
(paren
id|abi_version
comma
id|S_IRUGO
comma
id|show_abi_version
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|ib_umad_add_one
r_static
r_void
id|ib_umad_add_one
c_func
(paren
r_struct
id|ib_device
op_star
id|device
)paren
(brace
r_struct
id|ib_umad_device
op_star
id|umad_dev
suffix:semicolon
r_int
id|s
comma
id|e
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;node_type
op_eq
id|IB_NODE_SWITCH
)paren
id|s
op_assign
id|e
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|s
op_assign
l_int|1
suffix:semicolon
id|e
op_assign
id|device-&gt;phys_port_cnt
suffix:semicolon
)brace
id|umad_dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|umad_dev
op_plus
(paren
id|e
op_minus
id|s
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|ib_umad_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|umad_dev
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|umad_dev
comma
l_int|0
comma
r_sizeof
op_star
id|umad_dev
op_plus
(paren
id|e
op_minus
id|s
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|ib_umad_port
)paren
)paren
suffix:semicolon
id|kref_init
c_func
(paren
op_amp
id|umad_dev-&gt;ref
)paren
suffix:semicolon
id|umad_dev-&gt;start_port
op_assign
id|s
suffix:semicolon
id|umad_dev-&gt;end_port
op_assign
id|e
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|s
suffix:semicolon
id|i
op_le
id|e
suffix:semicolon
op_increment
id|i
)paren
(brace
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|umad_dev
op_assign
id|umad_dev
suffix:semicolon
id|kref_get
c_func
(paren
op_amp
id|umad_dev-&gt;ref
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|map_lock
)paren
suffix:semicolon
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|devnum
op_assign
id|find_first_zero_bit
c_func
(paren
id|dev_map
comma
id|IB_UMAD_MAX_PORTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|devnum
op_ge
id|IB_UMAD_MAX_PORTS
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|map_lock
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|devnum
comma
id|dev_map
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|map_lock
)paren
suffix:semicolon
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|ib_dev
op_assign
id|device
suffix:semicolon
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|port_num
op_assign
id|i
suffix:semicolon
id|cdev_init
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|dev
comma
op_amp
id|umad_fops
)paren
suffix:semicolon
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|dev.owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|kobject_set_name
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|dev.kobj
comma
l_string|&quot;umad%d&quot;
comma
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|devnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev_add
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|dev
comma
id|base_dev
op_plus
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|devnum
comma
l_int|1
)paren
)paren
r_goto
id|err
suffix:semicolon
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|class_dev
dot
r_class
op_assign
op_amp
id|umad_class
suffix:semicolon
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|class_dev.dev
op_assign
id|device-&gt;dma_device
suffix:semicolon
id|snprintf
c_func
(paren
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|class_dev.class_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;umad%d&quot;
comma
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|devnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|class_device_register
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|class_dev
)paren
)paren
r_goto
id|err_class
suffix:semicolon
r_if
c_cond
(paren
id|class_device_create_file
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|class_dev
comma
op_amp
id|class_device_attr_dev
)paren
)paren
r_goto
id|err_class
suffix:semicolon
r_if
c_cond
(paren
id|class_device_create_file
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|class_dev
comma
op_amp
id|class_device_attr_ibdev
)paren
)paren
r_goto
id|err_class
suffix:semicolon
r_if
c_cond
(paren
id|class_device_create_file
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|class_dev
comma
op_amp
id|class_device_attr_port
)paren
)paren
r_goto
id|err_class
suffix:semicolon
)brace
id|ib_set_client_data
c_func
(paren
id|device
comma
op_amp
id|umad_client
comma
id|umad_dev
)paren
suffix:semicolon
r_return
suffix:semicolon
id|err_class
suffix:colon
id|cdev_del
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|dev
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|devnum
comma
id|dev_map
)paren
suffix:semicolon
id|err
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
id|s
)paren
id|class_device_unregister
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
op_minus
id|s
)braket
dot
id|class_dev
)paren
suffix:semicolon
id|kref_put
c_func
(paren
op_amp
id|umad_dev-&gt;ref
comma
id|ib_umad_release_dev
)paren
suffix:semicolon
)brace
DECL|function|ib_umad_remove_one
r_static
r_void
id|ib_umad_remove_one
c_func
(paren
r_struct
id|ib_device
op_star
id|device
)paren
(brace
r_struct
id|ib_umad_device
op_star
id|umad_dev
op_assign
id|ib_get_client_data
c_func
(paren
id|device
comma
op_amp
id|umad_client
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|umad_dev
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|umad_dev-&gt;end_port
op_minus
id|umad_dev-&gt;start_port
suffix:semicolon
op_increment
id|i
)paren
id|class_device_unregister
c_func
(paren
op_amp
id|umad_dev-&gt;port
(braket
id|i
)braket
dot
id|class_dev
)paren
suffix:semicolon
id|kref_put
c_func
(paren
op_amp
id|umad_dev-&gt;ref
comma
id|ib_umad_release_dev
)paren
suffix:semicolon
)brace
DECL|function|ib_umad_init
r_static
r_int
id|__init
id|ib_umad_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|map_lock
)paren
suffix:semicolon
id|ret
op_assign
id|alloc_chrdev_region
c_func
(paren
op_amp
id|base_dev
comma
l_int|0
comma
id|IB_UMAD_MAX_PORTS
comma
l_string|&quot;infiniband_mad&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;user_mad: couldn&squot;t get device number&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|class_register
c_func
(paren
op_amp
id|umad_class
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;user_mad: couldn&squot;t create class infiniband_mad&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_chrdev
suffix:semicolon
)brace
id|ret
op_assign
id|class_create_file
c_func
(paren
op_amp
id|umad_class
comma
op_amp
id|class_attr_abi_version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;user_mad: couldn&squot;t create abi_version attribute&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_class
suffix:semicolon
)brace
id|ret
op_assign
id|ib_register_client
c_func
(paren
op_amp
id|umad_client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;user_mad: couldn&squot;t register ib_umad client&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_class
suffix:semicolon
)brace
multiline_comment|/* Our ioctls are 32/64 clean */
id|ret
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|IB_USER_MAD_REGISTER_AGENT
comma
l_int|NULL
)paren
suffix:semicolon
id|ret
op_or_assign
id|register_ioctl32_conversion
c_func
(paren
id|IB_USER_MAD_UNREGISTER_AGENT
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;user_mad: couldn&squot;t register ioctl32 conversions&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_client
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_client
suffix:colon
id|ib_unregister_client
c_func
(paren
op_amp
id|umad_client
)paren
suffix:semicolon
id|out_class
suffix:colon
id|class_unregister
c_func
(paren
op_amp
id|umad_class
)paren
suffix:semicolon
id|out_chrdev
suffix:colon
id|unregister_chrdev_region
c_func
(paren
id|base_dev
comma
id|IB_UMAD_MAX_PORTS
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ib_umad_cleanup
r_static
r_void
id|__exit
id|ib_umad_cleanup
c_func
(paren
r_void
)paren
(brace
id|unregister_ioctl32_conversion
c_func
(paren
id|IB_USER_MAD_REGISTER_AGENT
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|IB_USER_MAD_UNREGISTER_AGENT
)paren
suffix:semicolon
id|ib_unregister_client
c_func
(paren
op_amp
id|umad_client
)paren
suffix:semicolon
id|class_unregister
c_func
(paren
op_amp
id|umad_class
)paren
suffix:semicolon
id|unregister_chrdev_region
c_func
(paren
id|base_dev
comma
id|IB_UMAD_MAX_PORTS
)paren
suffix:semicolon
)brace
DECL|variable|ib_umad_init
id|module_init
c_func
(paren
id|ib_umad_init
)paren
suffix:semicolon
DECL|variable|ib_umad_cleanup
id|module_exit
c_func
(paren
id|ib_umad_cleanup
)paren
suffix:semicolon
eof
