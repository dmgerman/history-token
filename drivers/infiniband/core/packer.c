multiline_comment|/*&n; * Copyright (c) 2004 Topspin Corporation.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: packer.c 1349 2004-12-16 21:09:43Z roland $&n; */
macro_line|#include &lt;ib_pack.h&gt;
DECL|function|value_read
r_static
id|u64
id|value_read
c_func
(paren
r_int
id|offset
comma
r_int
id|size
comma
r_void
op_star
id|structure
)paren
(brace
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
r_return
op_star
(paren
id|u8
op_star
)paren
(paren
id|structure
op_plus
id|offset
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
id|be16_to_cpup
c_func
(paren
(paren
id|__be16
op_star
)paren
(paren
id|structure
op_plus
id|offset
)paren
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
id|be32_to_cpup
c_func
(paren
(paren
id|__be32
op_star
)paren
(paren
id|structure
op_plus
id|offset
)paren
)paren
suffix:semicolon
r_case
l_int|8
suffix:colon
r_return
id|be64_to_cpup
c_func
(paren
(paren
id|__be64
op_star
)paren
(paren
id|structure
op_plus
id|offset
)paren
)paren
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Field size %d bits not handled&bslash;n&quot;
comma
id|size
op_star
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ib_pack - Pack a structure into a buffer&n; * @desc:Array of structure field descriptions&n; * @desc_len:Number of entries in @desc&n; * @structure:Structure to pack from&n; * @buf:Buffer to pack into&n; *&n; * ib_pack() packs a list of structure fields into a buffer,&n; * controlled by the array of fields in @desc.&n; */
DECL|function|ib_pack
r_void
id|ib_pack
c_func
(paren
r_const
r_struct
id|ib_field
op_star
id|desc
comma
r_int
id|desc_len
comma
r_void
op_star
id|structure
comma
r_void
op_star
id|buf
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|desc_len
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_le
l_int|32
)paren
(brace
r_int
id|shift
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|__be32
id|mask
suffix:semicolon
id|__be32
op_star
id|addr
suffix:semicolon
id|shift
op_assign
l_int|32
op_minus
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_minus
id|desc
(braket
id|i
)braket
dot
id|size_bits
suffix:semicolon
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|struct_size_bytes
)paren
id|val
op_assign
id|value_read
c_func
(paren
id|desc
(braket
id|i
)braket
dot
id|struct_offset_bytes
comma
id|desc
(braket
id|i
)braket
dot
id|struct_size_bytes
comma
id|structure
)paren
op_lshift
id|shift
suffix:semicolon
r_else
id|val
op_assign
l_int|0
suffix:semicolon
id|mask
op_assign
id|cpu_to_be32
c_func
(paren
(paren
(paren
l_int|1ull
op_lshift
id|desc
(braket
id|i
)braket
dot
id|size_bits
)paren
op_minus
l_int|1
)paren
op_lshift
id|shift
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|__be32
op_star
)paren
id|buf
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_words
suffix:semicolon
op_star
id|addr
op_assign
(paren
op_star
id|addr
op_amp
op_complement
id|mask
)paren
op_or
(paren
id|cpu_to_be32
c_func
(paren
id|val
)paren
op_amp
id|mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_le
l_int|64
)paren
(brace
r_int
id|shift
suffix:semicolon
id|u64
id|val
suffix:semicolon
id|__be64
id|mask
suffix:semicolon
id|__be64
op_star
id|addr
suffix:semicolon
id|shift
op_assign
l_int|64
op_minus
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_minus
id|desc
(braket
id|i
)braket
dot
id|size_bits
suffix:semicolon
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|struct_size_bytes
)paren
id|val
op_assign
id|value_read
c_func
(paren
id|desc
(braket
id|i
)braket
dot
id|struct_offset_bytes
comma
id|desc
(braket
id|i
)braket
dot
id|struct_size_bytes
comma
id|structure
)paren
op_lshift
id|shift
suffix:semicolon
r_else
id|val
op_assign
l_int|0
suffix:semicolon
id|mask
op_assign
id|cpu_to_be64
c_func
(paren
(paren
(paren
l_int|1ull
op_lshift
id|desc
(braket
id|i
)braket
dot
id|size_bits
)paren
op_minus
l_int|1
)paren
op_lshift
id|shift
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|__be64
op_star
)paren
(paren
(paren
id|__be32
op_star
)paren
id|buf
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_words
)paren
suffix:semicolon
op_star
id|addr
op_assign
(paren
op_star
id|addr
op_amp
op_complement
id|mask
)paren
op_or
(paren
id|cpu_to_be64
c_func
(paren
id|val
)paren
op_amp
id|mask
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_mod
l_int|8
op_logical_or
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_mod
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Structure field %s of size %d &quot;
l_string|&quot;bits is not byte-aligned&bslash;n&quot;
comma
id|desc
(braket
id|i
)braket
dot
id|field_name
comma
id|desc
(braket
id|i
)braket
dot
id|size_bits
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|struct_size_bytes
)paren
id|memcpy
c_func
(paren
id|buf
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_words
op_star
l_int|4
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_div
l_int|8
comma
id|structure
op_plus
id|desc
(braket
id|i
)braket
dot
id|struct_offset_bytes
comma
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_div
l_int|8
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|buf
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_words
op_star
l_int|4
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_div
l_int|8
comma
l_int|0
comma
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_div
l_int|8
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|ib_pack
id|EXPORT_SYMBOL
c_func
(paren
id|ib_pack
)paren
suffix:semicolon
DECL|function|value_write
r_static
r_void
id|value_write
c_func
(paren
r_int
id|offset
comma
r_int
id|size
comma
id|u64
id|val
comma
r_void
op_star
id|structure
)paren
(brace
r_switch
c_cond
(paren
id|size
op_star
l_int|8
)paren
(brace
r_case
l_int|8
suffix:colon
op_star
(paren
id|u8
op_star
)paren
(paren
id|structure
op_plus
id|offset
)paren
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
op_star
(paren
id|__be16
op_star
)paren
(paren
id|structure
op_plus
id|offset
)paren
op_assign
id|cpu_to_be16
c_func
(paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
op_star
(paren
id|__be32
op_star
)paren
(paren
id|structure
op_plus
id|offset
)paren
op_assign
id|cpu_to_be32
c_func
(paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
op_star
(paren
id|__be64
op_star
)paren
(paren
id|structure
op_plus
id|offset
)paren
op_assign
id|cpu_to_be64
c_func
(paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Field size %d bits not handled&bslash;n&quot;
comma
id|size
op_star
l_int|8
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ib_unpack - Unpack a buffer into a structure&n; * @desc:Array of structure field descriptions&n; * @desc_len:Number of entries in @desc&n; * @buf:Buffer to unpack from&n; * @structure:Structure to unpack into&n; *&n; * ib_pack() unpacks a list of structure fields from a buffer,&n; * controlled by the array of fields in @desc.&n; */
DECL|function|ib_unpack
r_void
id|ib_unpack
c_func
(paren
r_const
r_struct
id|ib_field
op_star
id|desc
comma
r_int
id|desc_len
comma
r_void
op_star
id|buf
comma
r_void
op_star
id|structure
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|desc_len
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|desc
(braket
id|i
)braket
dot
id|struct_size_bytes
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_le
l_int|32
)paren
(brace
r_int
id|shift
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|u32
id|mask
suffix:semicolon
id|__be32
op_star
id|addr
suffix:semicolon
id|shift
op_assign
l_int|32
op_minus
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_minus
id|desc
(braket
id|i
)braket
dot
id|size_bits
suffix:semicolon
id|mask
op_assign
(paren
(paren
l_int|1ull
op_lshift
id|desc
(braket
id|i
)braket
dot
id|size_bits
)paren
op_minus
l_int|1
)paren
op_lshift
id|shift
suffix:semicolon
id|addr
op_assign
(paren
id|__be32
op_star
)paren
id|buf
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_words
suffix:semicolon
id|val
op_assign
(paren
id|be32_to_cpup
c_func
(paren
id|addr
)paren
op_amp
id|mask
)paren
op_rshift
id|shift
suffix:semicolon
id|value_write
c_func
(paren
id|desc
(braket
id|i
)braket
dot
id|struct_offset_bytes
comma
id|desc
(braket
id|i
)braket
dot
id|struct_size_bytes
comma
id|val
comma
id|structure
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_le
l_int|64
)paren
(brace
r_int
id|shift
suffix:semicolon
id|u64
id|val
suffix:semicolon
id|u64
id|mask
suffix:semicolon
id|__be64
op_star
id|addr
suffix:semicolon
id|shift
op_assign
l_int|64
op_minus
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_minus
id|desc
(braket
id|i
)braket
dot
id|size_bits
suffix:semicolon
id|mask
op_assign
(paren
(paren
l_int|1ull
op_lshift
id|desc
(braket
id|i
)braket
dot
id|size_bits
)paren
op_minus
l_int|1
)paren
op_lshift
id|shift
suffix:semicolon
id|addr
op_assign
(paren
id|__be64
op_star
)paren
id|buf
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_words
suffix:semicolon
id|val
op_assign
(paren
id|be64_to_cpup
c_func
(paren
id|addr
)paren
op_amp
id|mask
)paren
op_rshift
id|shift
suffix:semicolon
id|value_write
c_func
(paren
id|desc
(braket
id|i
)braket
dot
id|struct_offset_bytes
comma
id|desc
(braket
id|i
)braket
dot
id|struct_size_bytes
comma
id|val
comma
id|structure
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_mod
l_int|8
op_logical_or
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_mod
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Structure field %s of size %d &quot;
l_string|&quot;bits is not byte-aligned&bslash;n&quot;
comma
id|desc
(braket
id|i
)braket
dot
id|field_name
comma
id|desc
(braket
id|i
)braket
dot
id|size_bits
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|structure
op_plus
id|desc
(braket
id|i
)braket
dot
id|struct_offset_bytes
comma
id|buf
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_words
op_star
l_int|4
op_plus
id|desc
(braket
id|i
)braket
dot
id|offset_bits
op_div
l_int|8
comma
id|desc
(braket
id|i
)braket
dot
id|size_bits
op_div
l_int|8
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|ib_unpack
id|EXPORT_SYMBOL
c_func
(paren
id|ib_unpack
)paren
suffix:semicolon
eof
