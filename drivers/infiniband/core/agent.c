multiline_comment|/*&n; * Copyright (c) 2004 Mellanox Technologies Ltd.  All rights reserved.&n; * Copyright (c) 2004 Infinicon Corporation.  All rights reserved.&n; * Copyright (c) 2004 Intel Corporation.  All rights reserved.&n; * Copyright (c) 2004 Topspin Corporation.  All rights reserved.&n; * Copyright (c) 2004 Voltaire Corporation.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: agent.c 1389 2004-12-27 22:56:47Z roland $&n; */
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;asm/bug.h&gt;
macro_line|#include &lt;ib_smi.h&gt;
macro_line|#include &quot;smi.h&quot;
macro_line|#include &quot;agent_priv.h&quot;
macro_line|#include &quot;mad_priv.h&quot;
DECL|variable|ib_agent_port_list_lock
id|spinlock_t
id|ib_agent_port_list_lock
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|ib_agent_port_list
)paren
suffix:semicolon
r_extern
id|kmem_cache_t
op_star
id|ib_mad_cache
suffix:semicolon
multiline_comment|/*&n; * Caller must hold ib_agent_port_list_lock&n; */
r_static
r_inline
r_struct
id|ib_agent_port_private
op_star
DECL|function|__ib_get_agent_port
id|__ib_get_agent_port
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
comma
r_struct
id|ib_mad_agent
op_star
id|mad_agent
)paren
(brace
r_struct
id|ib_agent_port_private
op_star
id|entry
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
(paren
op_logical_neg
op_logical_neg
id|device
op_xor
op_logical_neg
op_logical_neg
id|mad_agent
)paren
)paren
suffix:semicolon
multiline_comment|/* Exactly one MUST be (!NULL) */
r_if
c_cond
(paren
id|device
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|ib_agent_port_list
comma
id|port_list
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;smp_agent-&gt;device
op_eq
id|device
op_logical_and
id|entry-&gt;port_num
op_eq
id|port_num
)paren
r_return
id|entry
suffix:semicolon
)brace
)brace
r_else
(brace
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|ib_agent_port_list
comma
id|port_list
)paren
(brace
r_if
c_cond
(paren
(paren
id|entry-&gt;smp_agent
op_eq
id|mad_agent
)paren
op_logical_or
(paren
id|entry-&gt;perf_mgmt_agent
op_eq
id|mad_agent
)paren
)paren
r_return
id|entry
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_inline
r_struct
id|ib_agent_port_private
op_star
DECL|function|ib_get_agent_port
id|ib_get_agent_port
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
comma
r_struct
id|ib_mad_agent
op_star
id|mad_agent
)paren
(brace
r_struct
id|ib_agent_port_private
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ib_agent_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|__ib_get_agent_port
c_func
(paren
id|device
comma
id|port_num
comma
id|mad_agent
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ib_agent_port_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
DECL|function|smi_check_local_dr_smp
r_int
id|smi_check_local_dr_smp
c_func
(paren
r_struct
id|ib_smp
op_star
id|smp
comma
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
)paren
(brace
r_struct
id|ib_agent_port_private
op_star
id|port_priv
suffix:semicolon
r_if
c_cond
(paren
id|smp-&gt;mgmt_class
op_ne
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)paren
r_return
l_int|1
suffix:semicolon
id|port_priv
op_assign
id|ib_get_agent_port
c_func
(paren
id|device
comma
id|port_num
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port_priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|SPFX
l_string|&quot;smi_check_local_dr_smp %s port %d &quot;
l_string|&quot;not open&bslash;n&quot;
comma
id|device-&gt;name
comma
id|port_num
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
id|smi_check_local_smp
c_func
(paren
id|port_priv-&gt;smp_agent
comma
id|smp
)paren
suffix:semicolon
)brace
DECL|function|agent_mad_send
r_static
r_int
id|agent_mad_send
c_func
(paren
r_struct
id|ib_mad_agent
op_star
id|mad_agent
comma
r_struct
id|ib_agent_port_private
op_star
id|port_priv
comma
r_struct
id|ib_mad_private
op_star
id|mad_priv
comma
r_struct
id|ib_grh
op_star
id|grh
comma
r_struct
id|ib_wc
op_star
id|wc
)paren
(brace
r_struct
id|ib_agent_send_wr
op_star
id|agent_send_wr
suffix:semicolon
r_struct
id|ib_sge
id|gather_list
suffix:semicolon
r_struct
id|ib_send_wr
id|send_wr
suffix:semicolon
r_struct
id|ib_send_wr
op_star
id|bad_send_wr
suffix:semicolon
r_struct
id|ib_ah_attr
id|ah_attr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
id|agent_send_wr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|agent_send_wr
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|agent_send_wr
)paren
r_goto
id|out
suffix:semicolon
id|agent_send_wr-&gt;mad
op_assign
id|mad_priv
suffix:semicolon
multiline_comment|/* PCI mapping */
id|gather_list.addr
op_assign
id|dma_map_single
c_func
(paren
id|mad_agent-&gt;device-&gt;dma_device
comma
op_amp
id|mad_priv-&gt;mad
comma
r_sizeof
(paren
id|mad_priv-&gt;mad
)paren
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|gather_list.length
op_assign
r_sizeof
(paren
id|mad_priv-&gt;mad
)paren
suffix:semicolon
id|gather_list.lkey
op_assign
id|port_priv-&gt;mr.lkey
suffix:semicolon
id|send_wr.next
op_assign
l_int|NULL
suffix:semicolon
id|send_wr.opcode
op_assign
id|IB_WR_SEND
suffix:semicolon
id|send_wr.sg_list
op_assign
op_amp
id|gather_list
suffix:semicolon
id|send_wr.num_sge
op_assign
l_int|1
suffix:semicolon
id|send_wr.wr.ud.remote_qpn
op_assign
id|wc-&gt;src_qp
suffix:semicolon
multiline_comment|/* DQPN */
id|send_wr.wr.ud.timeout_ms
op_assign
l_int|0
suffix:semicolon
id|send_wr.send_flags
op_assign
id|IB_SEND_SIGNALED
op_or
id|IB_SEND_SOLICITED
suffix:semicolon
id|ah_attr.dlid
op_assign
id|wc-&gt;slid
suffix:semicolon
id|ah_attr.port_num
op_assign
id|mad_agent-&gt;port_num
suffix:semicolon
id|ah_attr.src_path_bits
op_assign
id|wc-&gt;dlid_path_bits
suffix:semicolon
id|ah_attr.sl
op_assign
id|wc-&gt;sl
suffix:semicolon
id|ah_attr.static_rate
op_assign
l_int|0
suffix:semicolon
id|ah_attr.ah_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No GRH */
r_if
c_cond
(paren
id|mad_priv-&gt;mad.mad.mad_hdr.mgmt_class
op_eq
id|IB_MGMT_CLASS_PERF_MGMT
)paren
(brace
r_if
c_cond
(paren
id|wc-&gt;wc_flags
op_amp
id|IB_WC_GRH
)paren
(brace
id|ah_attr.ah_flags
op_assign
id|IB_AH_GRH
suffix:semicolon
multiline_comment|/* Should sgid be looked up ? */
id|ah_attr.grh.sgid_index
op_assign
l_int|0
suffix:semicolon
id|ah_attr.grh.hop_limit
op_assign
id|grh-&gt;hop_limit
suffix:semicolon
id|ah_attr.grh.flow_label
op_assign
id|be32_to_cpup
c_func
(paren
op_amp
id|grh-&gt;version_tclass_flow
)paren
op_amp
l_int|0xfffff
suffix:semicolon
id|ah_attr.grh.traffic_class
op_assign
(paren
id|be32_to_cpup
c_func
(paren
op_amp
id|grh-&gt;version_tclass_flow
)paren
op_rshift
l_int|20
)paren
op_amp
l_int|0xff
suffix:semicolon
id|memcpy
c_func
(paren
id|ah_attr.grh.dgid.raw
comma
id|grh-&gt;sgid.raw
comma
r_sizeof
(paren
id|ah_attr.grh.dgid
)paren
)paren
suffix:semicolon
)brace
)brace
id|agent_send_wr-&gt;ah
op_assign
id|ib_create_ah
c_func
(paren
id|mad_agent-&gt;qp-&gt;pd
comma
op_amp
id|ah_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|agent_send_wr-&gt;ah
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|SPFX
l_string|&quot;No memory for address handle&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|agent_send_wr
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|send_wr.wr.ud.ah
op_assign
id|agent_send_wr-&gt;ah
suffix:semicolon
r_if
c_cond
(paren
id|mad_priv-&gt;mad.mad.mad_hdr.mgmt_class
op_eq
id|IB_MGMT_CLASS_PERF_MGMT
)paren
(brace
id|send_wr.wr.ud.pkey_index
op_assign
id|wc-&gt;pkey_index
suffix:semicolon
id|send_wr.wr.ud.remote_qkey
op_assign
id|IB_QP1_QKEY
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* for SMPs */
id|send_wr.wr.ud.pkey_index
op_assign
l_int|0
suffix:semicolon
id|send_wr.wr.ud.remote_qkey
op_assign
l_int|0
suffix:semicolon
)brace
id|send_wr.wr.ud.mad_hdr
op_assign
op_amp
id|mad_priv-&gt;mad.mad.mad_hdr
suffix:semicolon
id|send_wr.wr_id
op_assign
(paren
r_int
r_int
)paren
id|agent_send_wr
suffix:semicolon
id|pci_unmap_addr_set
c_func
(paren
id|agent_send_wr
comma
id|mapping
comma
id|gather_list.addr
)paren
suffix:semicolon
multiline_comment|/* Send */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_priv-&gt;send_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ib_post_send_mad
c_func
(paren
id|mad_agent
comma
op_amp
id|send_wr
comma
op_amp
id|bad_send_wr
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_priv-&gt;send_list_lock
comma
id|flags
)paren
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|mad_agent-&gt;device-&gt;dma_device
comma
id|pci_unmap_addr
c_func
(paren
id|agent_send_wr
comma
id|mapping
)paren
comma
r_sizeof
(paren
id|mad_priv-&gt;mad
)paren
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|ib_destroy_ah
c_func
(paren
id|agent_send_wr-&gt;ah
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|agent_send_wr
)paren
suffix:semicolon
)brace
r_else
(brace
id|list_add_tail
c_func
(paren
op_amp
id|agent_send_wr-&gt;send_list
comma
op_amp
id|port_priv-&gt;send_posted_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_priv-&gt;send_list_lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|agent_send
r_int
id|agent_send
c_func
(paren
r_struct
id|ib_mad_private
op_star
id|mad
comma
r_struct
id|ib_grh
op_star
id|grh
comma
r_struct
id|ib_wc
op_star
id|wc
comma
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
)paren
(brace
r_struct
id|ib_agent_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_mad_agent
op_star
id|mad_agent
suffix:semicolon
id|port_priv
op_assign
id|ib_get_agent_port
c_func
(paren
id|device
comma
id|port_num
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port_priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|SPFX
l_string|&quot;agent_send %s port %d not open&bslash;n&quot;
comma
id|device-&gt;name
comma
id|port_num
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Get mad agent based on mgmt_class in MAD */
r_switch
c_cond
(paren
id|mad-&gt;mad.mad.mad_hdr.mgmt_class
)paren
(brace
r_case
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
suffix:colon
r_case
id|IB_MGMT_CLASS_SUBN_LID_ROUTED
suffix:colon
id|mad_agent
op_assign
id|port_priv-&gt;smp_agent
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IB_MGMT_CLASS_PERF_MGMT
suffix:colon
id|mad_agent
op_assign
id|port_priv-&gt;perf_mgmt_agent
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_return
id|agent_mad_send
c_func
(paren
id|mad_agent
comma
id|port_priv
comma
id|mad
comma
id|grh
comma
id|wc
)paren
suffix:semicolon
)brace
DECL|function|agent_send_handler
r_static
r_void
id|agent_send_handler
c_func
(paren
r_struct
id|ib_mad_agent
op_star
id|mad_agent
comma
r_struct
id|ib_mad_send_wc
op_star
id|mad_send_wc
)paren
(brace
r_struct
id|ib_agent_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_agent_send_wr
op_star
id|agent_send_wr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Find matching MAD agent */
id|port_priv
op_assign
id|ib_get_agent_port
c_func
(paren
l_int|NULL
comma
l_int|0
comma
id|mad_agent
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port_priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|SPFX
l_string|&quot;agent_send_handler: no matching MAD &quot;
l_string|&quot;agent %p&bslash;n&quot;
comma
id|mad_agent
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|agent_send_wr
op_assign
(paren
r_struct
id|ib_agent_send_wr
op_star
)paren
(paren
r_int
r_int
)paren
id|mad_send_wc-&gt;wr_id
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_priv-&gt;send_list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Remove completed send from posted send MAD list */
id|list_del
c_func
(paren
op_amp
id|agent_send_wr-&gt;send_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_priv-&gt;send_list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Unmap PCI */
id|dma_unmap_single
c_func
(paren
id|mad_agent-&gt;device-&gt;dma_device
comma
id|pci_unmap_addr
c_func
(paren
id|agent_send_wr
comma
id|mapping
)paren
comma
r_sizeof
(paren
id|agent_send_wr-&gt;mad-&gt;mad
)paren
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|ib_destroy_ah
c_func
(paren
id|agent_send_wr-&gt;ah
)paren
suffix:semicolon
multiline_comment|/* Release allocated memory */
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|agent_send_wr-&gt;mad
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|agent_send_wr
)paren
suffix:semicolon
)brace
DECL|function|ib_agent_port_open
r_int
id|ib_agent_port_open
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|ib_agent_port_private
op_star
id|port_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* First, check if port already open for SMI */
id|port_priv
op_assign
id|ib_get_agent_port
c_func
(paren
id|device
comma
id|port_num
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|SPFX
l_string|&quot;%s port %d already open&bslash;n&quot;
comma
id|device-&gt;name
comma
id|port_num
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Create new device info */
id|port_priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|port_priv
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port_priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|SPFX
l_string|&quot;No memory for ib_agent_port_private&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|port_priv
comma
l_int|0
comma
r_sizeof
op_star
id|port_priv
)paren
suffix:semicolon
id|port_priv-&gt;port_num
op_assign
id|port_num
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|port_priv-&gt;send_list_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|port_priv-&gt;send_posted_list
)paren
suffix:semicolon
multiline_comment|/* Obtain send only MAD agent for SM class (SMI QP) */
id|port_priv-&gt;smp_agent
op_assign
id|ib_register_mad_agent
c_func
(paren
id|device
comma
id|port_num
comma
id|IB_QPT_SMI
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|agent_send_handler
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|port_priv-&gt;smp_agent
)paren
)paren
(brace
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|port_priv-&gt;smp_agent
)paren
suffix:semicolon
r_goto
id|error2
suffix:semicolon
)brace
multiline_comment|/* Obtain send only MAD agent for PerfMgmt class (GSI QP) */
id|port_priv-&gt;perf_mgmt_agent
op_assign
id|ib_register_mad_agent
c_func
(paren
id|device
comma
id|port_num
comma
id|IB_QPT_GSI
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|agent_send_handler
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|port_priv-&gt;perf_mgmt_agent
)paren
)paren
(brace
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|port_priv-&gt;perf_mgmt_agent
)paren
suffix:semicolon
r_goto
id|error3
suffix:semicolon
)brace
id|port_priv-&gt;mr
op_assign
id|ib_get_dma_mr
c_func
(paren
id|port_priv-&gt;smp_agent-&gt;qp-&gt;pd
comma
id|IB_ACCESS_LOCAL_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|port_priv-&gt;mr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|SPFX
l_string|&quot;Couldn&squot;t get DMA MR&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|port_priv-&gt;mr
)paren
suffix:semicolon
r_goto
id|error4
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ib_agent_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|port_priv-&gt;port_list
comma
op_amp
id|ib_agent_port_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ib_agent_port_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error4
suffix:colon
id|ib_unregister_mad_agent
c_func
(paren
id|port_priv-&gt;perf_mgmt_agent
)paren
suffix:semicolon
id|error3
suffix:colon
id|ib_unregister_mad_agent
c_func
(paren
id|port_priv-&gt;smp_agent
)paren
suffix:semicolon
id|error2
suffix:colon
id|kfree
c_func
(paren
id|port_priv
)paren
suffix:semicolon
id|error1
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ib_agent_port_close
r_int
id|ib_agent_port_close
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
)paren
(brace
r_struct
id|ib_agent_port_private
op_star
id|port_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ib_agent_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|port_priv
op_assign
id|__ib_get_agent_port
c_func
(paren
id|device
comma
id|port_num
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_priv
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ib_agent_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|SPFX
l_string|&quot;Port %d not found&bslash;n&quot;
comma
id|port_num
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|port_priv-&gt;port_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ib_agent_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|ib_dereg_mr
c_func
(paren
id|port_priv-&gt;mr
)paren
suffix:semicolon
id|ib_unregister_mad_agent
c_func
(paren
id|port_priv-&gt;perf_mgmt_agent
)paren
suffix:semicolon
id|ib_unregister_mad_agent
c_func
(paren
id|port_priv-&gt;smp_agent
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|port_priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
