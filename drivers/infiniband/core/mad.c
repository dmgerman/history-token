multiline_comment|/*&n; * Copyright (c) 2004, 2005 Voltaire, Inc. All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: mad.c 1389 2004-12-27 22:56:47Z roland $&n; */
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;ib_mad.h&gt;
macro_line|#include &quot;mad_priv.h&quot;
macro_line|#include &quot;smi.h&quot;
macro_line|#include &quot;agent.h&quot;
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;kernel IB MAD API&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Hal Rosenstock&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sean Hefty&quot;
)paren
suffix:semicolon
DECL|variable|ib_mad_cache
id|kmem_cache_t
op_star
id|ib_mad_cache
suffix:semicolon
DECL|variable|ib_mad_port_list
r_static
r_struct
id|list_head
id|ib_mad_port_list
suffix:semicolon
DECL|variable|ib_mad_client_id
r_static
id|u32
id|ib_mad_client_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Port list lock */
DECL|variable|ib_mad_port_list_lock
r_static
id|spinlock_t
id|ib_mad_port_list_lock
suffix:semicolon
multiline_comment|/* Forward declarations */
r_static
r_int
id|method_in_use
c_func
(paren
r_struct
id|ib_mad_mgmt_method_table
op_star
op_star
id|method
comma
r_struct
id|ib_mad_reg_req
op_star
id|mad_reg_req
)paren
suffix:semicolon
r_static
r_void
id|remove_mad_reg_req
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|priv
)paren
suffix:semicolon
r_static
r_struct
id|ib_mad_agent_private
op_star
id|find_mad_agent
c_func
(paren
r_struct
id|ib_mad_port_private
op_star
id|port_priv
comma
r_struct
id|ib_mad
op_star
id|mad
comma
r_int
id|solicited
)paren
suffix:semicolon
r_static
r_int
id|ib_mad_post_receive_mads
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
comma
r_struct
id|ib_mad_private
op_star
id|mad
)paren
suffix:semicolon
r_static
r_void
id|cancel_mads
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
)paren
suffix:semicolon
r_static
r_void
id|ib_mad_complete_send_wr
c_func
(paren
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
comma
r_struct
id|ib_mad_send_wc
op_star
id|mad_send_wc
)paren
suffix:semicolon
r_static
r_void
id|timeout_sends
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|cancel_sends
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|local_completions
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|solicited_mad
c_func
(paren
r_struct
id|ib_mad
op_star
id|mad
)paren
suffix:semicolon
r_static
r_int
id|add_nonoui_reg_req
c_func
(paren
r_struct
id|ib_mad_reg_req
op_star
id|mad_reg_req
comma
r_struct
id|ib_mad_agent_private
op_star
id|agent_priv
comma
id|u8
id|mgmt_class
)paren
suffix:semicolon
r_static
r_int
id|add_oui_reg_req
c_func
(paren
r_struct
id|ib_mad_reg_req
op_star
id|mad_reg_req
comma
r_struct
id|ib_mad_agent_private
op_star
id|agent_priv
)paren
suffix:semicolon
multiline_comment|/*&n; * Returns a ib_mad_port_private structure or NULL for a device/port&n; * Assumes ib_mad_port_list_lock is being held&n; */
r_static
r_inline
r_struct
id|ib_mad_port_private
op_star
DECL|function|__ib_get_mad_port
id|__ib_get_mad_port
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|entry
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|ib_mad_port_list
comma
id|port_list
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;device
op_eq
id|device
op_logical_and
id|entry-&gt;port_num
op_eq
id|port_num
)paren
r_return
id|entry
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Wrapper function to return a ib_mad_port_private structure or NULL&n; * for a device/port&n; */
r_static
r_inline
r_struct
id|ib_mad_port_private
op_star
DECL|function|ib_get_mad_port
id|ib_get_mad_port
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ib_mad_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|entry
op_assign
id|__ib_get_mad_port
c_func
(paren
id|device
comma
id|port_num
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ib_mad_port_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
DECL|function|convert_mgmt_class
r_static
r_inline
id|u8
id|convert_mgmt_class
c_func
(paren
id|u8
id|mgmt_class
)paren
(brace
multiline_comment|/* Alias IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE to 0 */
r_return
id|mgmt_class
op_eq
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
ques
c_cond
l_int|0
suffix:colon
id|mgmt_class
suffix:semicolon
)brace
DECL|function|get_spl_qp_index
r_static
r_int
id|get_spl_qp_index
c_func
(paren
r_enum
id|ib_qp_type
id|qp_type
)paren
(brace
r_switch
c_cond
(paren
id|qp_type
)paren
(brace
r_case
id|IB_QPT_SMI
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|IB_QPT_GSI
suffix:colon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|vendor_class_index
r_static
r_int
id|vendor_class_index
c_func
(paren
id|u8
id|mgmt_class
)paren
(brace
r_return
id|mgmt_class
op_minus
id|IB_MGMT_CLASS_VENDOR_RANGE2_START
suffix:semicolon
)brace
DECL|function|is_vendor_class
r_static
r_int
id|is_vendor_class
c_func
(paren
id|u8
id|mgmt_class
)paren
(brace
r_if
c_cond
(paren
(paren
id|mgmt_class
OL
id|IB_MGMT_CLASS_VENDOR_RANGE2_START
)paren
op_logical_or
(paren
id|mgmt_class
OG
id|IB_MGMT_CLASS_VENDOR_RANGE2_END
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|is_vendor_oui
r_static
r_int
id|is_vendor_oui
c_func
(paren
r_char
op_star
id|oui
)paren
(brace
r_if
c_cond
(paren
id|oui
(braket
l_int|0
)braket
op_logical_or
id|oui
(braket
l_int|1
)braket
op_logical_or
id|oui
(braket
l_int|2
)braket
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|is_vendor_method_in_use
r_static
r_int
id|is_vendor_method_in_use
c_func
(paren
r_struct
id|ib_mad_mgmt_vendor_class
op_star
id|vendor_class
comma
r_struct
id|ib_mad_reg_req
op_star
id|mad_reg_req
)paren
(brace
r_struct
id|ib_mad_mgmt_method_table
op_star
id|method
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MGMT_OUI
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|vendor_class-&gt;oui
(braket
id|i
)braket
comma
id|mad_reg_req-&gt;oui
comma
l_int|3
)paren
)paren
(brace
id|method
op_assign
id|vendor_class-&gt;method_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|method
)paren
(brace
r_if
c_cond
(paren
id|method_in_use
c_func
(paren
op_amp
id|method
comma
id|mad_reg_req
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ib_register_mad_agent - Register to send/receive MADs&n; */
DECL|function|ib_register_mad_agent
r_struct
id|ib_mad_agent
op_star
id|ib_register_mad_agent
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
id|u8
id|port_num
comma
r_enum
id|ib_qp_type
id|qp_type
comma
r_struct
id|ib_mad_reg_req
op_star
id|mad_reg_req
comma
id|u8
id|rmpp_version
comma
id|ib_mad_send_handler
id|send_handler
comma
id|ib_mad_recv_handler
id|recv_handler
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_mad_agent
op_star
id|ret
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
suffix:semicolon
r_struct
id|ib_mad_reg_req
op_star
id|reg_req
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ib_mad_mgmt_class_table
op_star
r_class
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class_table
op_star
id|vendor
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class
op_star
id|vendor_class
suffix:semicolon
r_struct
id|ib_mad_mgmt_method_table
op_star
id|method
suffix:semicolon
r_int
id|ret2
comma
id|qpn
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|mgmt_class
comma
id|vclass
suffix:semicolon
multiline_comment|/* Validate parameters */
id|qpn
op_assign
id|get_spl_qp_index
c_func
(paren
id|qp_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpn
op_eq
op_minus
l_int|1
)paren
r_goto
id|error1
suffix:semicolon
r_if
c_cond
(paren
id|rmpp_version
)paren
r_goto
id|error1
suffix:semicolon
multiline_comment|/* XXX: until RMPP implemented */
multiline_comment|/* Validate MAD registration request if supplied */
r_if
c_cond
(paren
id|mad_reg_req
)paren
(brace
r_if
c_cond
(paren
id|mad_reg_req-&gt;mgmt_class_version
op_ge
id|MAX_MGMT_VERSION
)paren
r_goto
id|error1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|recv_handler
)paren
r_goto
id|error1
suffix:semicolon
r_if
c_cond
(paren
id|mad_reg_req-&gt;mgmt_class
op_ge
id|MAX_MGMT_CLASS
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE is the only&n;&t;&t;&t; * one in this range currently allowed&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mad_reg_req-&gt;mgmt_class
op_ne
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)paren
r_goto
id|error1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mad_reg_req-&gt;mgmt_class
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Class 0 is reserved in IBA and is used for&n;&t;&t;&t; * aliasing of IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE&n;&t;&t;&t; */
r_goto
id|error1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is_vendor_class
c_func
(paren
id|mad_reg_req-&gt;mgmt_class
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If class is in &quot;new&quot; vendor range,&n;&t;&t;&t; * ensure supplied OUI is not zero&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|is_vendor_oui
c_func
(paren
id|mad_reg_req-&gt;oui
)paren
)paren
r_goto
id|error1
suffix:semicolon
)brace
multiline_comment|/* Make sure class supplied is consistent with QP type */
r_if
c_cond
(paren
id|qp_type
op_eq
id|IB_QPT_SMI
)paren
(brace
r_if
c_cond
(paren
(paren
id|mad_reg_req-&gt;mgmt_class
op_ne
id|IB_MGMT_CLASS_SUBN_LID_ROUTED
)paren
op_logical_and
(paren
id|mad_reg_req-&gt;mgmt_class
op_ne
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)paren
)paren
r_goto
id|error1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|mad_reg_req-&gt;mgmt_class
op_eq
id|IB_MGMT_CLASS_SUBN_LID_ROUTED
)paren
op_logical_or
(paren
id|mad_reg_req-&gt;mgmt_class
op_eq
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)paren
)paren
r_goto
id|error1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No registration request supplied */
r_if
c_cond
(paren
op_logical_neg
id|send_handler
)paren
r_goto
id|error1
suffix:semicolon
)brace
multiline_comment|/* Validate device and port */
id|port_priv
op_assign
id|ib_get_mad_port
c_func
(paren
id|device
comma
id|port_num
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port_priv
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
multiline_comment|/* Allocate structures */
id|mad_agent_priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|mad_agent_priv
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_agent_priv
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mad_reg_req
)paren
(brace
id|reg_req
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|reg_req
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reg_req
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
r_goto
id|error2
suffix:semicolon
)brace
multiline_comment|/* Make a copy of the MAD registration request */
id|memcpy
c_func
(paren
id|reg_req
comma
id|mad_reg_req
comma
r_sizeof
op_star
id|reg_req
)paren
suffix:semicolon
)brace
multiline_comment|/* Now, fill in the various structures */
id|memset
c_func
(paren
id|mad_agent_priv
comma
l_int|0
comma
r_sizeof
op_star
id|mad_agent_priv
)paren
suffix:semicolon
id|mad_agent_priv-&gt;qp_info
op_assign
op_amp
id|port_priv-&gt;qp_info
(braket
id|qpn
)braket
suffix:semicolon
id|mad_agent_priv-&gt;reg_req
op_assign
id|reg_req
suffix:semicolon
id|mad_agent_priv-&gt;rmpp_version
op_assign
id|rmpp_version
suffix:semicolon
id|mad_agent_priv-&gt;agent.device
op_assign
id|device
suffix:semicolon
id|mad_agent_priv-&gt;agent.recv_handler
op_assign
id|recv_handler
suffix:semicolon
id|mad_agent_priv-&gt;agent.send_handler
op_assign
id|send_handler
suffix:semicolon
id|mad_agent_priv-&gt;agent.context
op_assign
id|context
suffix:semicolon
id|mad_agent_priv-&gt;agent.qp
op_assign
id|port_priv-&gt;qp_info
(braket
id|qpn
)braket
dot
id|qp
suffix:semicolon
id|mad_agent_priv-&gt;agent.port_num
op_assign
id|port_num
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_priv-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|mad_agent_priv-&gt;agent.hi_tid
op_assign
op_increment
id|ib_mad_client_id
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure MAD registration (if supplied)&n;&t; * is non overlapping with any existing ones&n;&t; */
r_if
c_cond
(paren
id|mad_reg_req
)paren
(brace
id|mgmt_class
op_assign
id|convert_mgmt_class
c_func
(paren
id|mad_reg_req-&gt;mgmt_class
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_vendor_class
c_func
(paren
id|mgmt_class
)paren
)paren
(brace
r_class
op_assign
id|port_priv-&gt;version
(braket
id|mad_reg_req
op_member_access_from_pointer
id|mgmt_class_version
)braket
dot
r_class
suffix:semicolon
r_if
c_cond
(paren
r_class
)paren
(brace
id|method
op_assign
r_class
op_member_access_from_pointer
id|method_table
(braket
id|mgmt_class
)braket
suffix:semicolon
r_if
c_cond
(paren
id|method
)paren
(brace
r_if
c_cond
(paren
id|method_in_use
c_func
(paren
op_amp
id|method
comma
id|mad_reg_req
)paren
)paren
r_goto
id|error3
suffix:semicolon
)brace
)brace
id|ret2
op_assign
id|add_nonoui_reg_req
c_func
(paren
id|mad_reg_req
comma
id|mad_agent_priv
comma
id|mgmt_class
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &quot;New&quot; vendor class range */
id|vendor
op_assign
id|port_priv-&gt;version
(braket
id|mad_reg_req
op_member_access_from_pointer
id|mgmt_class_version
)braket
dot
id|vendor
suffix:semicolon
r_if
c_cond
(paren
id|vendor
)paren
(brace
id|vclass
op_assign
id|vendor_class_index
c_func
(paren
id|mgmt_class
)paren
suffix:semicolon
id|vendor_class
op_assign
id|vendor-&gt;vendor_class
(braket
id|vclass
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vendor_class
)paren
(brace
r_if
c_cond
(paren
id|is_vendor_method_in_use
c_func
(paren
id|vendor_class
comma
id|mad_reg_req
)paren
)paren
r_goto
id|error3
suffix:semicolon
)brace
)brace
id|ret2
op_assign
id|add_oui_reg_req
c_func
(paren
id|mad_reg_req
comma
id|mad_agent_priv
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret2
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
id|ret2
)paren
suffix:semicolon
r_goto
id|error3
suffix:semicolon
)brace
)brace
multiline_comment|/* Add mad agent into port&squot;s agent list */
id|list_add_tail
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent_list
comma
op_amp
id|port_priv-&gt;agent_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_priv-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mad_agent_priv-&gt;send_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait_list
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|mad_agent_priv-&gt;timed_work
comma
id|timeout_sends
comma
id|mad_agent_priv
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mad_agent_priv-&gt;local_list
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|mad_agent_priv-&gt;local_work
comma
id|local_completions
comma
id|mad_agent_priv
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mad_agent_priv-&gt;canceled_list
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|mad_agent_priv-&gt;canceled_work
comma
id|cancel_sends
comma
id|mad_agent_priv
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
comma
l_int|1
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait
)paren
suffix:semicolon
r_return
op_amp
id|mad_agent_priv-&gt;agent
suffix:semicolon
id|error3
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_priv-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|reg_req
)paren
suffix:semicolon
id|error2
suffix:colon
id|kfree
c_func
(paren
id|mad_agent_priv
)paren
suffix:semicolon
id|error1
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|ib_register_mad_agent
id|EXPORT_SYMBOL
c_func
(paren
id|ib_register_mad_agent
)paren
suffix:semicolon
DECL|function|is_snooping_sends
r_static
r_inline
r_int
id|is_snooping_sends
c_func
(paren
r_int
id|mad_snoop_flags
)paren
(brace
r_return
(paren
id|mad_snoop_flags
op_amp
(paren
multiline_comment|/*IB_MAD_SNOOP_POSTED_SENDS |&n;&t;&t; IB_MAD_SNOOP_RMPP_SENDS |*/
id|IB_MAD_SNOOP_SEND_COMPLETIONS
multiline_comment|/*|&n;&t;&t; IB_MAD_SNOOP_RMPP_SEND_COMPLETIONS*/
)paren
)paren
suffix:semicolon
)brace
DECL|function|is_snooping_recvs
r_static
r_inline
r_int
id|is_snooping_recvs
c_func
(paren
r_int
id|mad_snoop_flags
)paren
(brace
r_return
(paren
id|mad_snoop_flags
op_amp
(paren
id|IB_MAD_SNOOP_RECVS
multiline_comment|/*|&n;&t;&t; IB_MAD_SNOOP_RMPP_RECVS*/
)paren
)paren
suffix:semicolon
)brace
DECL|function|register_snoop_agent
r_static
r_int
id|register_snoop_agent
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
comma
r_struct
id|ib_mad_snoop_private
op_star
id|mad_snoop_priv
)paren
(brace
r_struct
id|ib_mad_snoop_private
op_star
op_star
id|new_snoop_table
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Check for empty slot in array. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|qp_info-&gt;snoop_table_size
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|qp_info-&gt;snoop_table
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|qp_info-&gt;snoop_table_size
)paren
(brace
multiline_comment|/* Grow table. */
id|new_snoop_table
op_assign
id|kmalloc
c_func
(paren
r_sizeof
id|mad_snoop_priv
op_star
id|qp_info-&gt;snoop_table_size
op_plus
l_int|1
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_snoop_table
)paren
(brace
id|i
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qp_info-&gt;snoop_table
)paren
(brace
id|memcpy
c_func
(paren
id|new_snoop_table
comma
id|qp_info-&gt;snoop_table
comma
r_sizeof
id|mad_snoop_priv
op_star
id|qp_info-&gt;snoop_table_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|qp_info-&gt;snoop_table
)paren
suffix:semicolon
)brace
id|qp_info-&gt;snoop_table
op_assign
id|new_snoop_table
suffix:semicolon
id|qp_info-&gt;snoop_table_size
op_increment
suffix:semicolon
)brace
id|qp_info-&gt;snoop_table
(braket
id|i
)braket
op_assign
id|mad_snoop_priv
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|qp_info-&gt;snoop_count
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|ib_register_mad_snoop
r_struct
id|ib_mad_agent
op_star
id|ib_register_mad_snoop
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
id|u8
id|port_num
comma
r_enum
id|ib_qp_type
id|qp_type
comma
r_int
id|mad_snoop_flags
comma
id|ib_mad_snoop_handler
id|snoop_handler
comma
id|ib_mad_recv_handler
id|recv_handler
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_mad_agent
op_star
id|ret
suffix:semicolon
r_struct
id|ib_mad_snoop_private
op_star
id|mad_snoop_priv
suffix:semicolon
r_int
id|qpn
suffix:semicolon
multiline_comment|/* Validate parameters */
r_if
c_cond
(paren
(paren
id|is_snooping_sends
c_func
(paren
id|mad_snoop_flags
)paren
op_logical_and
op_logical_neg
id|snoop_handler
)paren
op_logical_or
(paren
id|is_snooping_recvs
c_func
(paren
id|mad_snoop_flags
)paren
op_logical_and
op_logical_neg
id|recv_handler
)paren
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
id|qpn
op_assign
id|get_spl_qp_index
c_func
(paren
id|qp_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qpn
op_eq
op_minus
l_int|1
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
id|port_priv
op_assign
id|ib_get_mad_port
c_func
(paren
id|device
comma
id|port_num
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port_priv
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
multiline_comment|/* Allocate structures */
id|mad_snoop_priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|mad_snoop_priv
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_snoop_priv
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
multiline_comment|/* Now, fill in the various structures */
id|memset
c_func
(paren
id|mad_snoop_priv
comma
l_int|0
comma
r_sizeof
op_star
id|mad_snoop_priv
)paren
suffix:semicolon
id|mad_snoop_priv-&gt;qp_info
op_assign
op_amp
id|port_priv-&gt;qp_info
(braket
id|qpn
)braket
suffix:semicolon
id|mad_snoop_priv-&gt;agent.device
op_assign
id|device
suffix:semicolon
id|mad_snoop_priv-&gt;agent.recv_handler
op_assign
id|recv_handler
suffix:semicolon
id|mad_snoop_priv-&gt;agent.snoop_handler
op_assign
id|snoop_handler
suffix:semicolon
id|mad_snoop_priv-&gt;agent.context
op_assign
id|context
suffix:semicolon
id|mad_snoop_priv-&gt;agent.qp
op_assign
id|port_priv-&gt;qp_info
(braket
id|qpn
)braket
dot
id|qp
suffix:semicolon
id|mad_snoop_priv-&gt;agent.port_num
op_assign
id|port_num
suffix:semicolon
id|mad_snoop_priv-&gt;mad_snoop_flags
op_assign
id|mad_snoop_flags
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;wait
)paren
suffix:semicolon
id|mad_snoop_priv-&gt;snoop_index
op_assign
id|register_snoop_agent
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
id|qpn
)braket
comma
id|mad_snoop_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mad_snoop_priv-&gt;snoop_index
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|ERR_PTR
c_func
(paren
id|mad_snoop_priv-&gt;snoop_index
)paren
suffix:semicolon
r_goto
id|error2
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;refcount
comma
l_int|1
)paren
suffix:semicolon
r_return
op_amp
id|mad_snoop_priv-&gt;agent
suffix:semicolon
id|error2
suffix:colon
id|kfree
c_func
(paren
id|mad_snoop_priv
)paren
suffix:semicolon
id|error1
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|ib_register_mad_snoop
id|EXPORT_SYMBOL
c_func
(paren
id|ib_register_mad_snoop
)paren
suffix:semicolon
DECL|function|unregister_mad_agent
r_static
r_void
id|unregister_mad_agent
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Note that we could still be handling received MADs */
multiline_comment|/*&n;&t; * Canceling all sends results in dropping received response&n;&t; * MADs, preventing us from queuing additional work&n;&t; */
id|cancel_mads
c_func
(paren
id|mad_agent_priv
)paren
suffix:semicolon
id|port_priv
op_assign
id|mad_agent_priv-&gt;qp_info-&gt;port_priv
suffix:semicolon
id|cancel_delayed_work
c_func
(paren
op_amp
id|mad_agent_priv-&gt;timed_work
)paren
suffix:semicolon
id|flush_workqueue
c_func
(paren
id|port_priv-&gt;wq
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_priv-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|remove_mad_reg_req
c_func
(paren
id|mad_agent_priv
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_priv-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* XXX: Cleanup pending RMPP receives for this agent */
id|atomic_dec
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|mad_agent_priv-&gt;wait
comma
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mad_agent_priv-&gt;reg_req
)paren
id|kfree
c_func
(paren
id|mad_agent_priv-&gt;reg_req
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mad_agent_priv
)paren
suffix:semicolon
)brace
DECL|function|unregister_mad_snoop
r_static
r_void
id|unregister_mad_snoop
c_func
(paren
r_struct
id|ib_mad_snoop_private
op_star
id|mad_snoop_priv
)paren
(brace
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|qp_info
op_assign
id|mad_snoop_priv-&gt;qp_info
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
id|qp_info-&gt;snoop_table
(braket
id|mad_snoop_priv-&gt;snoop_index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|qp_info-&gt;snoop_count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;refcount
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|mad_snoop_priv-&gt;wait
comma
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;refcount
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mad_snoop_priv
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ib_unregister_mad_agent - Unregisters a client from using MAD services&n; */
DECL|function|ib_unregister_mad_agent
r_int
id|ib_unregister_mad_agent
c_func
(paren
r_struct
id|ib_mad_agent
op_star
id|mad_agent
)paren
(brace
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
suffix:semicolon
r_struct
id|ib_mad_snoop_private
op_star
id|mad_snoop_priv
suffix:semicolon
multiline_comment|/* If the TID is zero, the agent can only snoop. */
r_if
c_cond
(paren
id|mad_agent-&gt;hi_tid
)paren
(brace
id|mad_agent_priv
op_assign
id|container_of
c_func
(paren
id|mad_agent
comma
r_struct
id|ib_mad_agent_private
comma
id|agent
)paren
suffix:semicolon
id|unregister_mad_agent
c_func
(paren
id|mad_agent_priv
)paren
suffix:semicolon
)brace
r_else
(brace
id|mad_snoop_priv
op_assign
id|container_of
c_func
(paren
id|mad_agent
comma
r_struct
id|ib_mad_snoop_private
comma
id|agent
)paren
suffix:semicolon
id|unregister_mad_snoop
c_func
(paren
id|mad_snoop_priv
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ib_unregister_mad_agent
id|EXPORT_SYMBOL
c_func
(paren
id|ib_unregister_mad_agent
)paren
suffix:semicolon
DECL|function|dequeue_mad
r_static
r_void
id|dequeue_mad
c_func
(paren
r_struct
id|ib_mad_list_head
op_star
id|mad_list
)paren
(brace
r_struct
id|ib_mad_queue
op_star
id|mad_queue
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|mad_list-&gt;mad_queue
)paren
suffix:semicolon
id|mad_queue
op_assign
id|mad_list-&gt;mad_queue
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_list-&gt;list
)paren
suffix:semicolon
id|mad_queue-&gt;count
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snoop_send
r_static
r_void
id|snoop_send
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
comma
r_struct
id|ib_send_wr
op_star
id|send_wr
comma
r_struct
id|ib_mad_send_wc
op_star
id|mad_send_wc
comma
r_int
id|mad_snoop_flags
)paren
(brace
r_struct
id|ib_mad_snoop_private
op_star
id|mad_snoop_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|qp_info-&gt;snoop_table_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mad_snoop_priv
op_assign
id|qp_info-&gt;snoop_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_snoop_priv
op_logical_or
op_logical_neg
(paren
id|mad_snoop_priv-&gt;mad_snoop_flags
op_amp
id|mad_snoop_flags
)paren
)paren
r_continue
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;refcount
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
id|mad_snoop_priv-&gt;agent
dot
id|snoop_handler
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;agent
comma
id|send_wr
comma
id|mad_send_wc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snoop_recv
r_static
r_void
id|snoop_recv
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
comma
r_struct
id|ib_mad_recv_wc
op_star
id|mad_recv_wc
comma
r_int
id|mad_snoop_flags
)paren
(brace
r_struct
id|ib_mad_snoop_private
op_star
id|mad_snoop_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|qp_info-&gt;snoop_table_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mad_snoop_priv
op_assign
id|qp_info-&gt;snoop_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_snoop_priv
op_logical_or
op_logical_neg
(paren
id|mad_snoop_priv-&gt;mad_snoop_flags
op_amp
id|mad_snoop_flags
)paren
)paren
r_continue
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;refcount
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
id|mad_snoop_priv-&gt;agent
dot
id|recv_handler
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;agent
comma
id|mad_recv_wc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|mad_snoop_priv-&gt;wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|build_smp_wc
r_static
r_void
id|build_smp_wc
c_func
(paren
id|u64
id|wr_id
comma
id|u16
id|slid
comma
id|u16
id|pkey_index
comma
id|u8
id|port_num
comma
r_struct
id|ib_wc
op_star
id|wc
)paren
(brace
id|memset
c_func
(paren
id|wc
comma
l_int|0
comma
r_sizeof
op_star
id|wc
)paren
suffix:semicolon
id|wc-&gt;wr_id
op_assign
id|wr_id
suffix:semicolon
id|wc-&gt;status
op_assign
id|IB_WC_SUCCESS
suffix:semicolon
id|wc-&gt;opcode
op_assign
id|IB_WC_RECV
suffix:semicolon
id|wc-&gt;pkey_index
op_assign
id|pkey_index
suffix:semicolon
id|wc-&gt;byte_len
op_assign
r_sizeof
(paren
r_struct
id|ib_mad
)paren
op_plus
r_sizeof
(paren
r_struct
id|ib_grh
)paren
suffix:semicolon
id|wc-&gt;src_qp
op_assign
id|IB_QP0
suffix:semicolon
id|wc-&gt;qp_num
op_assign
id|IB_QP0
suffix:semicolon
id|wc-&gt;slid
op_assign
id|slid
suffix:semicolon
id|wc-&gt;sl
op_assign
l_int|0
suffix:semicolon
id|wc-&gt;dlid_path_bits
op_assign
l_int|0
suffix:semicolon
id|wc-&gt;port_num
op_assign
id|port_num
suffix:semicolon
)brace
multiline_comment|/*&n; * Return 0 if SMP is to be sent&n; * Return 1 if SMP was consumed locally (whether or not solicited)&n; * Return &lt; 0 if error&n; */
DECL|function|handle_outgoing_dr_smp
r_static
r_int
id|handle_outgoing_dr_smp
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
comma
r_struct
id|ib_smp
op_star
id|smp
comma
r_struct
id|ib_send_wr
op_star
id|send_wr
)paren
(brace
r_int
id|ret
comma
id|solicited
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ib_mad_local_private
op_star
id|local
suffix:semicolon
r_struct
id|ib_mad_private
op_star
id|mad_priv
suffix:semicolon
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_mad_agent_private
op_star
id|recv_mad_agent
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ib_device
op_star
id|device
op_assign
id|mad_agent_priv-&gt;agent.device
suffix:semicolon
id|u8
id|port_num
op_assign
id|mad_agent_priv-&gt;agent.port_num
suffix:semicolon
r_struct
id|ib_wc
id|mad_wc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smi_handle_dr_smp_send
c_func
(paren
id|smp
comma
id|device-&gt;node_type
comma
id|port_num
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Invalid directed route&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check to post send on QP or process locally */
id|ret
op_assign
id|smi_check_local_dr_smp
c_func
(paren
id|smp
comma
id|device
comma
id|port_num
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_or
op_logical_neg
id|device-&gt;process_mad
)paren
r_goto
id|out
suffix:semicolon
id|local
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|local
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|local
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for ib_mad_local_private&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|local-&gt;mad_priv
op_assign
l_int|NULL
suffix:semicolon
id|local-&gt;recv_mad_agent
op_assign
l_int|NULL
suffix:semicolon
id|mad_priv
op_assign
id|kmem_cache_alloc
c_func
(paren
id|ib_mad_cache
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_priv
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for local response MAD&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|local
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|build_smp_wc
c_func
(paren
id|send_wr-&gt;wr_id
comma
id|smp-&gt;dr_slid
comma
id|send_wr-&gt;wr.ud.pkey_index
comma
id|send_wr-&gt;wr.ud.port_num
comma
op_amp
id|mad_wc
)paren
suffix:semicolon
multiline_comment|/* No GRH for DR SMP */
id|ret
op_assign
id|device
op_member_access_from_pointer
id|process_mad
c_func
(paren
id|device
comma
l_int|0
comma
id|port_num
comma
op_amp
id|mad_wc
comma
l_int|NULL
comma
(paren
r_struct
id|ib_mad
op_star
)paren
id|smp
comma
(paren
r_struct
id|ib_mad
op_star
)paren
op_amp
id|mad_priv-&gt;mad
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IB_MAD_RESULT_SUCCESS
op_or
id|IB_MAD_RESULT_REPLY
suffix:colon
multiline_comment|/*&n;&t;&t; * See if response is solicited and&n;&t;&t; * there is a recv handler&n;&t;&t; */
r_if
c_cond
(paren
id|solicited_mad
c_func
(paren
op_amp
id|mad_priv-&gt;mad.mad
)paren
op_logical_and
id|mad_agent_priv-&gt;agent.recv_handler
)paren
(brace
id|local-&gt;mad_priv
op_assign
id|mad_priv
suffix:semicolon
id|local-&gt;recv_mad_agent
op_assign
id|mad_agent_priv
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Reference MAD agent until receive&n;&t;&t;&t; * side of local completion handled&n;&t;&t;&t; */
id|atomic_inc
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
)brace
r_else
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|mad_priv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IB_MAD_RESULT_SUCCESS
op_or
id|IB_MAD_RESULT_CONSUMED
suffix:colon
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|mad_priv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IB_MAD_RESULT_SUCCESS
suffix:colon
multiline_comment|/* Treat like an incoming receive MAD */
id|solicited
op_assign
id|solicited_mad
c_func
(paren
op_amp
id|mad_priv-&gt;mad.mad
)paren
suffix:semicolon
id|port_priv
op_assign
id|ib_get_mad_port
c_func
(paren
id|mad_agent_priv-&gt;agent.device
comma
id|mad_agent_priv-&gt;agent.port_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_priv
)paren
(brace
id|mad_priv-&gt;mad.mad.mad_hdr.tid
op_assign
(paren
(paren
r_struct
id|ib_mad
op_star
)paren
id|smp
)paren
op_member_access_from_pointer
id|mad_hdr.tid
suffix:semicolon
id|recv_mad_agent
op_assign
id|find_mad_agent
c_func
(paren
id|port_priv
comma
op_amp
id|mad_priv-&gt;mad.mad
comma
id|solicited
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|port_priv
op_logical_or
op_logical_neg
id|recv_mad_agent
)paren
(brace
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|mad_priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|local
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|local-&gt;mad_priv
op_assign
id|mad_priv
suffix:semicolon
id|local-&gt;recv_mad_agent
op_assign
id|recv_mad_agent
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|mad_priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|local
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|local-&gt;send_wr
op_assign
op_star
id|send_wr
suffix:semicolon
id|local-&gt;send_wr.sg_list
op_assign
id|local-&gt;sg_list
suffix:semicolon
id|memcpy
c_func
(paren
id|local-&gt;sg_list
comma
id|send_wr-&gt;sg_list
comma
r_sizeof
op_star
id|send_wr-&gt;sg_list
op_star
id|send_wr-&gt;num_sge
)paren
suffix:semicolon
id|local-&gt;send_wr.next
op_assign
l_int|NULL
suffix:semicolon
id|local-&gt;tid
op_assign
id|send_wr-&gt;wr.ud.mad_hdr-&gt;tid
suffix:semicolon
id|local-&gt;wr_id
op_assign
id|send_wr-&gt;wr_id
suffix:semicolon
multiline_comment|/* Reference MAD agent until send side of local completion handled */
id|atomic_inc
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
multiline_comment|/* Queue local completion to local list */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|local-&gt;completion_list
comma
op_amp
id|mad_agent_priv-&gt;local_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|mad_agent_priv-&gt;qp_info-&gt;port_priv-&gt;wq
comma
op_amp
id|mad_agent_priv-&gt;local_work
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ib_send_mad
r_static
r_int
id|ib_send_mad
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
comma
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
)paren
(brace
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
suffix:semicolon
r_struct
id|ib_send_wr
op_star
id|bad_send_wr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Replace user&squot;s WR ID with our own to find WR upon completion */
id|qp_info
op_assign
id|mad_agent_priv-&gt;qp_info
suffix:semicolon
id|mad_send_wr-&gt;wr_id
op_assign
id|mad_send_wr-&gt;send_wr.wr_id
suffix:semicolon
id|mad_send_wr-&gt;send_wr.wr_id
op_assign
(paren
r_int
r_int
)paren
op_amp
id|mad_send_wr-&gt;mad_list
suffix:semicolon
id|mad_send_wr-&gt;mad_list.mad_queue
op_assign
op_amp
id|qp_info-&gt;send_queue
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qp_info-&gt;send_queue.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qp_info-&gt;send_queue.count
op_increment
OL
id|qp_info-&gt;send_queue.max_active
)paren
(brace
id|list_add_tail
c_func
(paren
op_amp
id|mad_send_wr-&gt;mad_list.list
comma
op_amp
id|qp_info-&gt;send_queue.list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;send_queue.lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|ib_post_send
c_func
(paren
id|mad_agent_priv-&gt;agent.qp
comma
op_amp
id|mad_send_wr-&gt;send_wr
comma
op_amp
id|bad_send_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ib_post_send failed: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|dequeue_mad
c_func
(paren
op_amp
id|mad_send_wr-&gt;mad_list
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|list_add_tail
c_func
(paren
op_amp
id|mad_send_wr-&gt;mad_list.list
comma
op_amp
id|qp_info-&gt;overflow_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;send_queue.lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * ib_post_send_mad - Posts MAD(s) to the send queue of the QP associated&n; *  with the registered client&n; */
DECL|function|ib_post_send_mad
r_int
id|ib_post_send_mad
c_func
(paren
r_struct
id|ib_mad_agent
op_star
id|mad_agent
comma
r_struct
id|ib_send_wr
op_star
id|send_wr
comma
r_struct
id|ib_send_wr
op_star
op_star
id|bad_send_wr
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
suffix:semicolon
multiline_comment|/* Validate supplied parameters */
r_if
c_cond
(paren
op_logical_neg
id|bad_send_wr
)paren
r_goto
id|error1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_agent
op_logical_or
op_logical_neg
id|send_wr
)paren
r_goto
id|error2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_agent-&gt;send_handler
)paren
r_goto
id|error2
suffix:semicolon
id|mad_agent_priv
op_assign
id|container_of
c_func
(paren
id|mad_agent
comma
r_struct
id|ib_mad_agent_private
comma
id|agent
)paren
suffix:semicolon
multiline_comment|/* Walk list of send WRs and post each on send list */
r_while
c_loop
(paren
id|send_wr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ib_send_wr
op_star
id|next_send_wr
suffix:semicolon
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
r_struct
id|ib_smp
op_star
id|smp
suffix:semicolon
multiline_comment|/* Validate more parameters */
r_if
c_cond
(paren
id|send_wr-&gt;num_sge
OG
id|IB_MAD_SEND_REQ_MAX_SG
)paren
r_goto
id|error2
suffix:semicolon
r_if
c_cond
(paren
id|send_wr-&gt;wr.ud.timeout_ms
op_logical_and
op_logical_neg
id|mad_agent-&gt;recv_handler
)paren
r_goto
id|error2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_wr-&gt;wr.ud.mad_hdr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;MAD header must be supplied &quot;
l_string|&quot;in WR %p&bslash;n&quot;
comma
id|send_wr
)paren
suffix:semicolon
r_goto
id|error2
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Save pointer to next work request to post in case the&n;&t;&t; * current one completes, and the user modifies the work&n;&t;&t; * request associated with the completion&n;&t;&t; */
id|next_send_wr
op_assign
(paren
r_struct
id|ib_send_wr
op_star
)paren
id|send_wr-&gt;next
suffix:semicolon
id|smp
op_assign
(paren
r_struct
id|ib_smp
op_star
)paren
id|send_wr-&gt;wr.ud.mad_hdr
suffix:semicolon
r_if
c_cond
(paren
id|smp-&gt;mgmt_class
op_eq
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)paren
(brace
id|ret
op_assign
id|handle_outgoing_dr_smp
c_func
(paren
id|mad_agent_priv
comma
id|smp
comma
id|send_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
multiline_comment|/* error */
r_goto
id|error2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ret
op_eq
l_int|1
)paren
multiline_comment|/* locally consumed */
r_goto
id|next
suffix:semicolon
)brace
multiline_comment|/* Allocate MAD send WR tracking structure */
id|mad_send_wr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|mad_send_wr
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_send_wr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for &quot;
l_string|&quot;ib_mad_send_wr_private&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error2
suffix:semicolon
)brace
id|mad_send_wr-&gt;send_wr
op_assign
op_star
id|send_wr
suffix:semicolon
id|mad_send_wr-&gt;send_wr.sg_list
op_assign
id|mad_send_wr-&gt;sg_list
suffix:semicolon
id|memcpy
c_func
(paren
id|mad_send_wr-&gt;sg_list
comma
id|send_wr-&gt;sg_list
comma
r_sizeof
op_star
id|send_wr-&gt;sg_list
op_star
id|send_wr-&gt;num_sge
)paren
suffix:semicolon
id|mad_send_wr-&gt;send_wr.next
op_assign
l_int|NULL
suffix:semicolon
id|mad_send_wr-&gt;tid
op_assign
id|send_wr-&gt;wr.ud.mad_hdr-&gt;tid
suffix:semicolon
id|mad_send_wr-&gt;agent
op_assign
id|mad_agent
suffix:semicolon
multiline_comment|/* Timeout will be updated after send completes */
id|mad_send_wr-&gt;timeout
op_assign
id|msecs_to_jiffies
c_func
(paren
id|send_wr-&gt;wr
dot
id|ud.timeout_ms
)paren
suffix:semicolon
id|mad_send_wr-&gt;retry
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* One reference for each work request to QP + response */
id|mad_send_wr-&gt;refcount
op_assign
l_int|1
op_plus
(paren
id|mad_send_wr-&gt;timeout
OG
l_int|0
)paren
suffix:semicolon
id|mad_send_wr-&gt;status
op_assign
id|IB_WC_SUCCESS
suffix:semicolon
multiline_comment|/* Reference MAD agent until send completes */
id|atomic_inc
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
comma
op_amp
id|mad_agent_priv-&gt;send_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|ib_send_mad
c_func
(paren
id|mad_agent_priv
comma
id|mad_send_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* Fail send request */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
r_goto
id|error2
suffix:semicolon
)brace
id|next
suffix:colon
id|send_wr
op_assign
id|next_send_wr
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error2
suffix:colon
op_star
id|bad_send_wr
op_assign
id|send_wr
suffix:semicolon
id|error1
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|ib_post_send_mad
id|EXPORT_SYMBOL
c_func
(paren
id|ib_post_send_mad
)paren
suffix:semicolon
multiline_comment|/*&n; * ib_free_recv_mad - Returns data buffers used to receive&n; *  a MAD to the access layer&n; */
DECL|function|ib_free_recv_mad
r_void
id|ib_free_recv_mad
c_func
(paren
r_struct
id|ib_mad_recv_wc
op_star
id|mad_recv_wc
)paren
(brace
r_struct
id|ib_mad_recv_buf
op_star
id|entry
suffix:semicolon
r_struct
id|ib_mad_private_header
op_star
id|mad_priv_hdr
suffix:semicolon
r_struct
id|ib_mad_private
op_star
id|priv
suffix:semicolon
id|mad_priv_hdr
op_assign
id|container_of
c_func
(paren
id|mad_recv_wc
comma
r_struct
id|ib_mad_private_header
comma
id|recv_wc
)paren
suffix:semicolon
id|priv
op_assign
id|container_of
c_func
(paren
id|mad_priv_hdr
comma
r_struct
id|ib_mad_private
comma
id|header
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Walk receive buffer list associated with this WC&n;&t; * No need to remove them from list of receive buffers&n;&t; */
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|mad_recv_wc-&gt;recv_buf.list
comma
id|list
)paren
(brace
multiline_comment|/* Free previous receive buffer */
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|priv
)paren
suffix:semicolon
id|mad_priv_hdr
op_assign
id|container_of
c_func
(paren
id|mad_recv_wc
comma
r_struct
id|ib_mad_private_header
comma
id|recv_wc
)paren
suffix:semicolon
id|priv
op_assign
id|container_of
c_func
(paren
id|mad_priv_hdr
comma
r_struct
id|ib_mad_private
comma
id|header
)paren
suffix:semicolon
)brace
multiline_comment|/* Free last buffer */
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|priv
)paren
suffix:semicolon
)brace
DECL|variable|ib_free_recv_mad
id|EXPORT_SYMBOL
c_func
(paren
id|ib_free_recv_mad
)paren
suffix:semicolon
DECL|function|ib_coalesce_recv_mad
r_void
id|ib_coalesce_recv_mad
c_func
(paren
r_struct
id|ib_mad_recv_wc
op_star
id|mad_recv_wc
comma
r_void
op_star
id|buf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ib_coalesce_recv_mad() not implemented yet&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|ib_coalesce_recv_mad
id|EXPORT_SYMBOL
c_func
(paren
id|ib_coalesce_recv_mad
)paren
suffix:semicolon
DECL|function|ib_redirect_mad_qp
r_struct
id|ib_mad_agent
op_star
id|ib_redirect_mad_qp
c_func
(paren
r_struct
id|ib_qp
op_star
id|qp
comma
id|u8
id|rmpp_version
comma
id|ib_mad_send_handler
id|send_handler
comma
id|ib_mad_recv_handler
id|recv_handler
comma
r_void
op_star
id|context
)paren
(brace
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* XXX: for now */
)brace
DECL|variable|ib_redirect_mad_qp
id|EXPORT_SYMBOL
c_func
(paren
id|ib_redirect_mad_qp
)paren
suffix:semicolon
DECL|function|ib_process_mad_wc
r_int
id|ib_process_mad_wc
c_func
(paren
r_struct
id|ib_mad_agent
op_star
id|mad_agent
comma
r_struct
id|ib_wc
op_star
id|wc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ib_process_mad_wc() not implemented yet&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ib_process_mad_wc
id|EXPORT_SYMBOL
c_func
(paren
id|ib_process_mad_wc
)paren
suffix:semicolon
DECL|function|method_in_use
r_static
r_int
id|method_in_use
c_func
(paren
r_struct
id|ib_mad_mgmt_method_table
op_star
op_star
id|method
comma
r_struct
id|ib_mad_reg_req
op_star
id|mad_reg_req
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|find_first_bit
c_func
(paren
id|mad_reg_req-&gt;method_mask
comma
id|IB_MGMT_MAX_METHODS
)paren
suffix:semicolon
id|i
OL
id|IB_MGMT_MAX_METHODS
suffix:semicolon
id|i
op_assign
id|find_next_bit
c_func
(paren
id|mad_reg_req-&gt;method_mask
comma
id|IB_MGMT_MAX_METHODS
comma
l_int|1
op_plus
id|i
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|method
)paren
op_member_access_from_pointer
id|agent
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Method %d already in use&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|allocate_method_table
r_static
r_int
id|allocate_method_table
c_func
(paren
r_struct
id|ib_mad_mgmt_method_table
op_star
op_star
id|method
)paren
(brace
multiline_comment|/* Allocate management method table */
op_star
id|method
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
op_star
id|method
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|method
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for &quot;
l_string|&quot;ib_mad_mgmt_method_table&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Clear management method table */
id|memset
c_func
(paren
op_star
id|method
comma
l_int|0
comma
r_sizeof
op_star
op_star
id|method
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Check to see if there are any methods still in use&n; */
DECL|function|check_method_table
r_static
r_int
id|check_method_table
c_func
(paren
r_struct
id|ib_mad_mgmt_method_table
op_star
id|method
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IB_MGMT_MAX_METHODS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|method-&gt;agent
(braket
id|i
)braket
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Check to see if there are any method tables for this class still in use&n; */
DECL|function|check_class_table
r_static
r_int
id|check_class_table
c_func
(paren
r_struct
id|ib_mad_mgmt_class_table
op_star
r_class
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MGMT_CLASS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
r_class
op_member_access_from_pointer
id|method_table
(braket
id|i
)braket
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|check_vendor_class
r_static
r_int
id|check_vendor_class
c_func
(paren
r_struct
id|ib_mad_mgmt_vendor_class
op_star
id|vendor_class
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MGMT_OUI
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|vendor_class-&gt;method_table
(braket
id|i
)braket
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_vendor_oui
r_static
r_int
id|find_vendor_oui
c_func
(paren
r_struct
id|ib_mad_mgmt_vendor_class
op_star
id|vendor_class
comma
r_char
op_star
id|oui
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MGMT_OUI
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Is there matching OUI for this vendor class ? */
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|vendor_class-&gt;oui
(braket
id|i
)braket
comma
id|oui
comma
l_int|3
)paren
)paren
r_return
id|i
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|check_vendor_table
r_static
r_int
id|check_vendor_table
c_func
(paren
r_struct
id|ib_mad_mgmt_vendor_class_table
op_star
id|vendor
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MGMT_VENDOR_RANGE2
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|vendor-&gt;vendor_class
(braket
id|i
)braket
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|remove_methods_mad_agent
r_static
r_void
id|remove_methods_mad_agent
c_func
(paren
r_struct
id|ib_mad_mgmt_method_table
op_star
id|method
comma
r_struct
id|ib_mad_agent_private
op_star
id|agent
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Remove any methods for this mad agent */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IB_MGMT_MAX_METHODS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|method-&gt;agent
(braket
id|i
)braket
op_eq
id|agent
)paren
(brace
id|method-&gt;agent
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|function|add_nonoui_reg_req
r_static
r_int
id|add_nonoui_reg_req
c_func
(paren
r_struct
id|ib_mad_reg_req
op_star
id|mad_reg_req
comma
r_struct
id|ib_mad_agent_private
op_star
id|agent_priv
comma
id|u8
id|mgmt_class
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_mad_mgmt_class_table
op_star
op_star
r_class
suffix:semicolon
r_struct
id|ib_mad_mgmt_method_table
op_star
op_star
id|method
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|port_priv
op_assign
id|agent_priv-&gt;qp_info-&gt;port_priv
suffix:semicolon
r_class
op_assign
op_amp
id|port_priv-&gt;version
(braket
id|mad_reg_req-&gt;mgmt_class_version
)braket
dot
r_class
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
r_class
)paren
(brace
multiline_comment|/* Allocate management class table for &quot;new&quot; class version */
op_star
r_class
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
op_star
r_class
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
r_class
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for &quot;
l_string|&quot;ib_mad_mgmt_class_table&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
multiline_comment|/* Clear management class table */
id|memset
c_func
(paren
op_star
r_class
comma
l_int|0
comma
r_sizeof
(paren
op_star
op_star
r_class
)paren
)paren
suffix:semicolon
multiline_comment|/* Allocate method table for this management class */
id|method
op_assign
op_amp
(paren
op_star
r_class
)paren
op_member_access_from_pointer
id|method_table
(braket
id|mgmt_class
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|allocate_method_table
c_func
(paren
id|method
)paren
)paren
)paren
r_goto
id|error2
suffix:semicolon
)brace
r_else
(brace
id|method
op_assign
op_amp
(paren
op_star
r_class
)paren
op_member_access_from_pointer
id|method_table
(braket
id|mgmt_class
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|method
)paren
(brace
multiline_comment|/* Allocate method table for this management class */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|allocate_method_table
c_func
(paren
id|method
)paren
)paren
)paren
r_goto
id|error1
suffix:semicolon
)brace
)brace
multiline_comment|/* Now, make sure methods are not already in use */
r_if
c_cond
(paren
id|method_in_use
c_func
(paren
id|method
comma
id|mad_reg_req
)paren
)paren
r_goto
id|error3
suffix:semicolon
multiline_comment|/* Finally, add in methods being registered */
r_for
c_loop
(paren
id|i
op_assign
id|find_first_bit
c_func
(paren
id|mad_reg_req-&gt;method_mask
comma
id|IB_MGMT_MAX_METHODS
)paren
suffix:semicolon
id|i
OL
id|IB_MGMT_MAX_METHODS
suffix:semicolon
id|i
op_assign
id|find_next_bit
c_func
(paren
id|mad_reg_req-&gt;method_mask
comma
id|IB_MGMT_MAX_METHODS
comma
l_int|1
op_plus
id|i
)paren
)paren
(brace
(paren
op_star
id|method
)paren
op_member_access_from_pointer
id|agent
(braket
id|i
)braket
op_assign
id|agent_priv
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error3
suffix:colon
multiline_comment|/* Remove any methods for this mad agent */
id|remove_methods_mad_agent
c_func
(paren
op_star
id|method
comma
id|agent_priv
)paren
suffix:semicolon
multiline_comment|/* Now, check to see if there are any methods in use */
r_if
c_cond
(paren
op_logical_neg
id|check_method_table
c_func
(paren
op_star
id|method
)paren
)paren
(brace
multiline_comment|/* If not, release management method table */
id|kfree
c_func
(paren
op_star
id|method
)paren
suffix:semicolon
op_star
id|method
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error1
suffix:semicolon
id|error2
suffix:colon
id|kfree
c_func
(paren
op_star
r_class
)paren
suffix:semicolon
op_star
r_class
op_assign
l_int|NULL
suffix:semicolon
id|error1
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|add_oui_reg_req
r_static
r_int
id|add_oui_reg_req
c_func
(paren
r_struct
id|ib_mad_reg_req
op_star
id|mad_reg_req
comma
r_struct
id|ib_mad_agent_private
op_star
id|agent_priv
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class_table
op_star
op_star
id|vendor_table
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class_table
op_star
id|vendor
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class
op_star
id|vendor_class
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ib_mad_mgmt_method_table
op_star
op_star
id|method
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|u8
id|vclass
suffix:semicolon
multiline_comment|/* &quot;New&quot; vendor (with OUI) class */
id|vclass
op_assign
id|vendor_class_index
c_func
(paren
id|mad_reg_req-&gt;mgmt_class
)paren
suffix:semicolon
id|port_priv
op_assign
id|agent_priv-&gt;qp_info-&gt;port_priv
suffix:semicolon
id|vendor_table
op_assign
op_amp
id|port_priv-&gt;version
(braket
id|mad_reg_req-&gt;mgmt_class_version
)braket
dot
id|vendor
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|vendor_table
)paren
(brace
multiline_comment|/* Allocate mgmt vendor class table for &quot;new&quot; class version */
id|vendor
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|vendor
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vendor
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for &quot;
l_string|&quot;ib_mad_mgmt_vendor_class_table&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
multiline_comment|/* Clear management vendor class table */
id|memset
c_func
(paren
id|vendor
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|vendor
)paren
)paren
suffix:semicolon
op_star
id|vendor_table
op_assign
id|vendor
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|vendor_table
)paren
op_member_access_from_pointer
id|vendor_class
(braket
id|vclass
)braket
)paren
(brace
multiline_comment|/* Allocate table for this management vendor class */
id|vendor_class
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|vendor_class
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vendor_class
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for &quot;
l_string|&quot;ib_mad_mgmt_vendor_class&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error2
suffix:semicolon
)brace
id|memset
c_func
(paren
id|vendor_class
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|vendor_class
)paren
)paren
suffix:semicolon
(paren
op_star
id|vendor_table
)paren
op_member_access_from_pointer
id|vendor_class
(braket
id|vclass
)braket
op_assign
id|vendor_class
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MGMT_OUI
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Is there matching OUI for this vendor class ? */
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
(paren
op_star
id|vendor_table
)paren
op_member_access_from_pointer
id|vendor_class
(braket
id|vclass
)braket
op_member_access_from_pointer
id|oui
(braket
id|i
)braket
comma
id|mad_reg_req-&gt;oui
comma
l_int|3
)paren
)paren
(brace
id|method
op_assign
op_amp
(paren
op_star
id|vendor_table
)paren
op_member_access_from_pointer
id|vendor_class
(braket
id|vclass
)braket
op_member_access_from_pointer
id|method_table
(braket
id|i
)braket
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
op_star
id|method
)paren
suffix:semicolon
r_goto
id|check_in_use
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MGMT_OUI
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* OUI slot available ? */
r_if
c_cond
(paren
op_logical_neg
id|is_vendor_oui
c_func
(paren
(paren
op_star
id|vendor_table
)paren
op_member_access_from_pointer
id|vendor_class
(braket
id|vclass
)braket
op_member_access_from_pointer
id|oui
(braket
id|i
)braket
)paren
)paren
(brace
id|method
op_assign
op_amp
(paren
op_star
id|vendor_table
)paren
op_member_access_from_pointer
id|vendor_class
(braket
id|vclass
)braket
op_member_access_from_pointer
id|method_table
(braket
id|i
)braket
suffix:semicolon
id|BUG_ON
c_func
(paren
op_star
id|method
)paren
suffix:semicolon
multiline_comment|/* Allocate method table for this OUI */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|allocate_method_table
c_func
(paren
id|method
)paren
)paren
)paren
r_goto
id|error3
suffix:semicolon
id|memcpy
c_func
(paren
(paren
op_star
id|vendor_table
)paren
op_member_access_from_pointer
id|vendor_class
(braket
id|vclass
)braket
op_member_access_from_pointer
id|oui
(braket
id|i
)braket
comma
id|mad_reg_req-&gt;oui
comma
l_int|3
)paren
suffix:semicolon
r_goto
id|check_in_use
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;All OUI slots in use&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error3
suffix:semicolon
id|check_in_use
suffix:colon
multiline_comment|/* Now, make sure methods are not already in use */
r_if
c_cond
(paren
id|method_in_use
c_func
(paren
id|method
comma
id|mad_reg_req
)paren
)paren
r_goto
id|error4
suffix:semicolon
multiline_comment|/* Finally, add in methods being registered */
r_for
c_loop
(paren
id|i
op_assign
id|find_first_bit
c_func
(paren
id|mad_reg_req-&gt;method_mask
comma
id|IB_MGMT_MAX_METHODS
)paren
suffix:semicolon
id|i
OL
id|IB_MGMT_MAX_METHODS
suffix:semicolon
id|i
op_assign
id|find_next_bit
c_func
(paren
id|mad_reg_req-&gt;method_mask
comma
id|IB_MGMT_MAX_METHODS
comma
l_int|1
op_plus
id|i
)paren
)paren
(brace
(paren
op_star
id|method
)paren
op_member_access_from_pointer
id|agent
(braket
id|i
)braket
op_assign
id|agent_priv
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error4
suffix:colon
multiline_comment|/* Remove any methods for this mad agent */
id|remove_methods_mad_agent
c_func
(paren
op_star
id|method
comma
id|agent_priv
)paren
suffix:semicolon
multiline_comment|/* Now, check to see if there are any methods in use */
r_if
c_cond
(paren
op_logical_neg
id|check_method_table
c_func
(paren
op_star
id|method
)paren
)paren
(brace
multiline_comment|/* If not, release management method table */
id|kfree
c_func
(paren
op_star
id|method
)paren
suffix:semicolon
op_star
id|method
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|error3
suffix:colon
r_if
c_cond
(paren
id|vendor_class
)paren
(brace
(paren
op_star
id|vendor_table
)paren
op_member_access_from_pointer
id|vendor_class
(braket
id|vclass
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|vendor_class
)paren
suffix:semicolon
)brace
id|error2
suffix:colon
r_if
c_cond
(paren
id|vendor
)paren
(brace
op_star
id|vendor_table
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|vendor
)paren
suffix:semicolon
)brace
id|error1
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|remove_mad_reg_req
r_static
r_void
id|remove_mad_reg_req
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|agent_priv
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_mad_mgmt_class_table
op_star
r_class
suffix:semicolon
r_struct
id|ib_mad_mgmt_method_table
op_star
id|method
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class_table
op_star
id|vendor
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class
op_star
id|vendor_class
suffix:semicolon
r_int
id|index
suffix:semicolon
id|u8
id|mgmt_class
suffix:semicolon
multiline_comment|/*&n;&t; * Was MAD registration request supplied&n;&t; * with original registration ?&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|agent_priv-&gt;reg_req
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|port_priv
op_assign
id|agent_priv-&gt;qp_info-&gt;port_priv
suffix:semicolon
id|mgmt_class
op_assign
id|convert_mgmt_class
c_func
(paren
id|agent_priv-&gt;reg_req-&gt;mgmt_class
)paren
suffix:semicolon
r_class
op_assign
id|port_priv-&gt;version
(braket
id|agent_priv-&gt;reg_req-&gt;mgmt_class_version
)braket
dot
r_class
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_class
)paren
r_goto
id|vendor_check
suffix:semicolon
id|method
op_assign
r_class
op_member_access_from_pointer
id|method_table
(braket
id|mgmt_class
)braket
suffix:semicolon
r_if
c_cond
(paren
id|method
)paren
(brace
multiline_comment|/* Remove any methods for this mad agent */
id|remove_methods_mad_agent
c_func
(paren
id|method
comma
id|agent_priv
)paren
suffix:semicolon
multiline_comment|/* Now, check to see if there are any methods still in use */
r_if
c_cond
(paren
op_logical_neg
id|check_method_table
c_func
(paren
id|method
)paren
)paren
(brace
multiline_comment|/* If not, release management method table */
id|kfree
c_func
(paren
id|method
)paren
suffix:semicolon
r_class
op_member_access_from_pointer
id|method_table
(braket
id|mgmt_class
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Any management classes left ? */
r_if
c_cond
(paren
op_logical_neg
id|check_class_table
c_func
(paren
r_class
)paren
)paren
(brace
multiline_comment|/* If not, release management class table */
id|kfree
c_func
(paren
r_class
)paren
suffix:semicolon
id|port_priv-&gt;version
(braket
id|agent_priv-&gt;reg_req
op_member_access_from_pointer
id|mgmt_class_version
)braket
dot
r_class
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
id|vendor_check
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|is_vendor_class
c_func
(paren
id|mgmt_class
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* normalize mgmt_class to vendor range 2 */
id|mgmt_class
op_assign
id|vendor_class_index
c_func
(paren
id|agent_priv-&gt;reg_req-&gt;mgmt_class
)paren
suffix:semicolon
id|vendor
op_assign
id|port_priv-&gt;version
(braket
id|agent_priv-&gt;reg_req-&gt;mgmt_class_version
)braket
dot
id|vendor
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vendor
)paren
r_goto
id|out
suffix:semicolon
id|vendor_class
op_assign
id|vendor-&gt;vendor_class
(braket
id|mgmt_class
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vendor_class
)paren
(brace
id|index
op_assign
id|find_vendor_oui
c_func
(paren
id|vendor_class
comma
id|agent_priv-&gt;reg_req-&gt;oui
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|method
op_assign
id|vendor_class-&gt;method_table
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|method
)paren
(brace
multiline_comment|/* Remove any methods for this mad agent */
id|remove_methods_mad_agent
c_func
(paren
id|method
comma
id|agent_priv
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Now, check to see if there are&n;&t;&t;&t; * any methods still in use&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|check_method_table
c_func
(paren
id|method
)paren
)paren
(brace
multiline_comment|/* If not, release management method table */
id|kfree
c_func
(paren
id|method
)paren
suffix:semicolon
id|vendor_class-&gt;method_table
(braket
id|index
)braket
op_assign
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|vendor_class-&gt;oui
(braket
id|index
)braket
comma
l_int|0
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Any OUIs left ? */
r_if
c_cond
(paren
op_logical_neg
id|check_vendor_class
c_func
(paren
id|vendor_class
)paren
)paren
(brace
multiline_comment|/* If not, release vendor class table */
id|kfree
c_func
(paren
id|vendor_class
)paren
suffix:semicolon
id|vendor-&gt;vendor_class
(braket
id|mgmt_class
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Any other vendor classes left ? */
r_if
c_cond
(paren
op_logical_neg
id|check_vendor_table
c_func
(paren
id|vendor
)paren
)paren
(brace
id|kfree
c_func
(paren
id|vendor
)paren
suffix:semicolon
id|port_priv-&gt;version
(braket
id|agent_priv-&gt;reg_req
op_member_access_from_pointer
id|mgmt_class_version
)braket
dot
id|vendor
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
id|out
suffix:colon
r_return
suffix:semicolon
)brace
DECL|function|response_mad
r_static
r_int
id|response_mad
c_func
(paren
r_struct
id|ib_mad
op_star
id|mad
)paren
(brace
multiline_comment|/* Trap represses are responses although response bit is reset */
r_return
(paren
(paren
id|mad-&gt;mad_hdr.method
op_eq
id|IB_MGMT_METHOD_TRAP_REPRESS
)paren
op_logical_or
(paren
id|mad-&gt;mad_hdr.method
op_amp
id|IB_MGMT_METHOD_RESP
)paren
)paren
suffix:semicolon
)brace
DECL|function|solicited_mad
r_static
r_int
id|solicited_mad
c_func
(paren
r_struct
id|ib_mad
op_star
id|mad
)paren
(brace
multiline_comment|/* CM MADs are never solicited */
r_if
c_cond
(paren
id|mad-&gt;mad_hdr.mgmt_class
op_eq
id|IB_MGMT_CLASS_CM
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* XXX: Determine whether MAD is using RMPP */
multiline_comment|/* Not using RMPP */
multiline_comment|/* Is this MAD a response to a previous MAD ? */
r_return
id|response_mad
c_func
(paren
id|mad
)paren
suffix:semicolon
)brace
r_static
r_struct
id|ib_mad_agent_private
op_star
DECL|function|find_mad_agent
id|find_mad_agent
c_func
(paren
r_struct
id|ib_mad_port_private
op_star
id|port_priv
comma
r_struct
id|ib_mad
op_star
id|mad
comma
r_int
id|solicited
)paren
(brace
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_priv-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Whether MAD was solicited determines type of routing to&n;&t; * MAD client.&n;&t; */
r_if
c_cond
(paren
id|solicited
)paren
(brace
id|u32
id|hi_tid
suffix:semicolon
r_struct
id|ib_mad_agent_private
op_star
id|entry
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Routing is based on high 32 bits of transaction ID&n;&t;&t; * of MAD.&n;&t;&t; */
id|hi_tid
op_assign
id|be64_to_cpu
c_func
(paren
id|mad-&gt;mad_hdr.tid
)paren
op_rshift
l_int|32
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|port_priv-&gt;agent_list
comma
id|agent_list
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;agent.hi_tid
op_eq
id|hi_tid
)paren
(brace
id|mad_agent
op_assign
id|entry
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_struct
id|ib_mad_mgmt_class_table
op_star
r_class
suffix:semicolon
r_struct
id|ib_mad_mgmt_method_table
op_star
id|method
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class_table
op_star
id|vendor
suffix:semicolon
r_struct
id|ib_mad_mgmt_vendor_class
op_star
id|vendor_class
suffix:semicolon
r_struct
id|ib_vendor_mad
op_star
id|vendor_mad
suffix:semicolon
r_int
id|index
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Routing is based on version, class, and method&n;&t;&t; * For &quot;newer&quot; vendor MADs, also based on OUI&n;&t;&t; */
r_if
c_cond
(paren
id|mad-&gt;mad_hdr.class_version
op_ge
id|MAX_MGMT_VERSION
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_vendor_class
c_func
(paren
id|mad-&gt;mad_hdr.mgmt_class
)paren
)paren
(brace
r_class
op_assign
id|port_priv-&gt;version
(braket
id|mad-&gt;mad_hdr.class_version
)braket
dot
r_class
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_class
)paren
r_goto
id|out
suffix:semicolon
id|method
op_assign
r_class
op_member_access_from_pointer
id|method_table
(braket
id|convert_mgmt_class
c_func
(paren
id|mad-&gt;mad_hdr.mgmt_class
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|method
)paren
id|mad_agent
op_assign
id|method-&gt;agent
(braket
id|mad-&gt;mad_hdr.method
op_amp
op_complement
id|IB_MGMT_METHOD_RESP
)braket
suffix:semicolon
)brace
r_else
(brace
id|vendor
op_assign
id|port_priv-&gt;version
(braket
id|mad-&gt;mad_hdr.class_version
)braket
dot
id|vendor
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vendor
)paren
r_goto
id|out
suffix:semicolon
id|vendor_class
op_assign
id|vendor-&gt;vendor_class
(braket
id|vendor_class_index
c_func
(paren
id|mad-&gt;mad_hdr.mgmt_class
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vendor_class
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Find matching OUI */
id|vendor_mad
op_assign
(paren
r_struct
id|ib_vendor_mad
op_star
)paren
id|mad
suffix:semicolon
id|index
op_assign
id|find_vendor_oui
c_func
(paren
id|vendor_class
comma
id|vendor_mad-&gt;oui
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
op_minus
l_int|1
)paren
r_goto
id|out
suffix:semicolon
id|method
op_assign
id|vendor_class-&gt;method_table
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|method
)paren
(brace
id|mad_agent
op_assign
id|method-&gt;agent
(braket
id|mad-&gt;mad_hdr.method
op_amp
op_complement
id|IB_MGMT_METHOD_RESP
)braket
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|mad_agent
)paren
(brace
r_if
c_cond
(paren
id|mad_agent-&gt;agent.recv_handler
)paren
id|atomic_inc
c_func
(paren
op_amp
id|mad_agent-&gt;refcount
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
id|PFX
l_string|&quot;No receive handler for client &quot;
l_string|&quot;%p on port %d&bslash;n&quot;
comma
op_amp
id|mad_agent-&gt;agent
comma
id|port_priv-&gt;port_num
)paren
suffix:semicolon
id|mad_agent
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_priv-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mad_agent
suffix:semicolon
)brace
DECL|function|validate_mad
r_static
r_int
id|validate_mad
c_func
(paren
r_struct
id|ib_mad
op_star
id|mad
comma
id|u32
id|qp_num
)paren
(brace
r_int
id|valid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Make sure MAD base version is understood */
r_if
c_cond
(paren
id|mad-&gt;mad_hdr.base_version
op_ne
id|IB_MGMT_BASE_VERSION
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;MAD received with unsupported base &quot;
l_string|&quot;version %d&bslash;n&quot;
comma
id|mad-&gt;mad_hdr.base_version
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Filter SMI packets sent to other than QP0 */
r_if
c_cond
(paren
(paren
id|mad-&gt;mad_hdr.mgmt_class
op_eq
id|IB_MGMT_CLASS_SUBN_LID_ROUTED
)paren
op_logical_or
(paren
id|mad-&gt;mad_hdr.mgmt_class
op_eq
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)paren
)paren
(brace
r_if
c_cond
(paren
id|qp_num
op_eq
l_int|0
)paren
id|valid
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Filter GSI packets sent to QP0 */
r_if
c_cond
(paren
id|qp_num
op_ne
l_int|0
)paren
id|valid
op_assign
l_int|1
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|valid
suffix:semicolon
)brace
multiline_comment|/*&n; * Return start of fully reassembled MAD, or NULL, if MAD isn&squot;t assembled yet&n; */
r_static
r_struct
id|ib_mad_private
op_star
DECL|function|reassemble_recv
id|reassemble_recv
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
comma
r_struct
id|ib_mad_private
op_star
id|recv
)paren
(brace
multiline_comment|/* Until we have RMPP, all receives are reassembled!... */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|recv-&gt;header.recv_wc.recv_buf.list
)paren
suffix:semicolon
r_return
id|recv
suffix:semicolon
)brace
r_static
r_struct
id|ib_mad_send_wr_private
op_star
DECL|function|find_send_req
id|find_send_req
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
comma
id|u64
id|tid
)paren
(brace
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|mad_send_wr
comma
op_amp
id|mad_agent_priv-&gt;wait_list
comma
id|agent_list
)paren
(brace
r_if
c_cond
(paren
id|mad_send_wr-&gt;tid
op_eq
id|tid
)paren
r_return
id|mad_send_wr
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * It&squot;s possible to receive the response before we&squot;ve&n;&t; * been notified that the send has completed&n;&t; */
id|list_for_each_entry
c_func
(paren
id|mad_send_wr
comma
op_amp
id|mad_agent_priv-&gt;send_list
comma
id|agent_list
)paren
(brace
r_if
c_cond
(paren
id|mad_send_wr-&gt;tid
op_eq
id|tid
op_logical_and
id|mad_send_wr-&gt;timeout
)paren
(brace
multiline_comment|/* Verify request has not been canceled */
r_return
(paren
id|mad_send_wr-&gt;status
op_eq
id|IB_WC_SUCCESS
)paren
ques
c_cond
id|mad_send_wr
suffix:colon
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ib_mad_complete_recv
r_static
r_void
id|ib_mad_complete_recv
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
comma
r_struct
id|ib_mad_private
op_star
id|recv
comma
r_int
id|solicited
)paren
(brace
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
r_struct
id|ib_mad_send_wc
id|mad_send_wc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Fully reassemble receive before processing */
id|recv
op_assign
id|reassemble_recv
c_func
(paren
id|mad_agent_priv
comma
id|recv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|recv
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Complete corresponding request */
r_if
c_cond
(paren
id|solicited
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mad_send_wr
op_assign
id|find_send_req
c_func
(paren
id|mad_agent_priv
comma
id|recv-&gt;mad.mad.mad_hdr.tid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_send_wr
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ib_free_recv_mad
c_func
(paren
op_amp
id|recv-&gt;header.recv_wc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Timeout = 0 means that we won&squot;t wait for a response */
id|mad_send_wr-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Defined behavior is to complete response before request */
id|recv-&gt;header.recv_wc.wc-&gt;wr_id
op_assign
id|mad_send_wr-&gt;wr_id
suffix:semicolon
id|mad_agent_priv-&gt;agent
dot
id|recv_handler
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent
comma
op_amp
id|recv-&gt;header.recv_wc
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
id|mad_send_wc.status
op_assign
id|IB_WC_SUCCESS
suffix:semicolon
id|mad_send_wc.vendor_err
op_assign
l_int|0
suffix:semicolon
id|mad_send_wc.wr_id
op_assign
id|mad_send_wr-&gt;wr_id
suffix:semicolon
id|ib_mad_complete_send_wr
c_func
(paren
id|mad_send_wr
comma
op_amp
id|mad_send_wc
)paren
suffix:semicolon
)brace
r_else
(brace
id|mad_agent_priv-&gt;agent
dot
id|recv_handler
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent
comma
op_amp
id|recv-&gt;header.recv_wc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait
)paren
suffix:semicolon
)brace
)brace
DECL|function|ib_mad_recv_done_handler
r_static
r_void
id|ib_mad_recv_done_handler
c_func
(paren
r_struct
id|ib_mad_port_private
op_star
id|port_priv
comma
r_struct
id|ib_wc
op_star
id|wc
)paren
(brace
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
suffix:semicolon
r_struct
id|ib_mad_private_header
op_star
id|mad_priv_hdr
suffix:semicolon
r_struct
id|ib_mad_private
op_star
id|recv
comma
op_star
id|response
suffix:semicolon
r_struct
id|ib_mad_list_head
op_star
id|mad_list
suffix:semicolon
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent
suffix:semicolon
r_int
id|solicited
suffix:semicolon
id|response
op_assign
id|kmem_cache_alloc
c_func
(paren
id|ib_mad_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|response
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ib_mad_recv_done_handler no memory &quot;
l_string|&quot;for response buffer&bslash;n&quot;
)paren
suffix:semicolon
id|mad_list
op_assign
(paren
r_struct
id|ib_mad_list_head
op_star
)paren
(paren
r_int
r_int
)paren
id|wc-&gt;wr_id
suffix:semicolon
id|qp_info
op_assign
id|mad_list-&gt;mad_queue-&gt;qp_info
suffix:semicolon
id|dequeue_mad
c_func
(paren
id|mad_list
)paren
suffix:semicolon
id|mad_priv_hdr
op_assign
id|container_of
c_func
(paren
id|mad_list
comma
r_struct
id|ib_mad_private_header
comma
id|mad_list
)paren
suffix:semicolon
id|recv
op_assign
id|container_of
c_func
(paren
id|mad_priv_hdr
comma
r_struct
id|ib_mad_private
comma
id|header
)paren
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|port_priv-&gt;device-&gt;dma_device
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|recv-&gt;header
comma
id|mapping
)paren
comma
r_sizeof
(paren
r_struct
id|ib_mad_private
)paren
op_minus
r_sizeof
(paren
r_struct
id|ib_mad_private_header
)paren
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
multiline_comment|/* Setup MAD receive work completion from &quot;normal&quot; work completion */
id|recv-&gt;header.recv_wc.wc
op_assign
id|wc
suffix:semicolon
id|recv-&gt;header.recv_wc.mad_len
op_assign
r_sizeof
(paren
r_struct
id|ib_mad
)paren
suffix:semicolon
id|recv-&gt;header.recv_wc.recv_buf.mad
op_assign
op_amp
id|recv-&gt;mad.mad
suffix:semicolon
id|recv-&gt;header.recv_wc.recv_buf.grh
op_assign
op_amp
id|recv-&gt;grh
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|qp_info-&gt;snoop_count
)paren
)paren
id|snoop_recv
c_func
(paren
id|qp_info
comma
op_amp
id|recv-&gt;header.recv_wc
comma
id|IB_MAD_SNOOP_RECVS
)paren
suffix:semicolon
multiline_comment|/* Validate MAD */
r_if
c_cond
(paren
op_logical_neg
id|validate_mad
c_func
(paren
op_amp
id|recv-&gt;mad.mad
comma
id|qp_info-&gt;qp-&gt;qp_num
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;mad.mad.mad_hdr.mgmt_class
op_eq
id|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|smi_handle_dr_smp_recv
c_func
(paren
op_amp
id|recv-&gt;mad.smp
comma
id|port_priv-&gt;device-&gt;node_type
comma
id|port_priv-&gt;port_num
comma
id|port_priv-&gt;device-&gt;phys_port_cnt
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smi_check_forward_dr_smp
c_func
(paren
op_amp
id|recv-&gt;mad.smp
)paren
)paren
r_goto
id|local
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smi_handle_dr_smp_send
c_func
(paren
op_amp
id|recv-&gt;mad.smp
comma
id|port_priv-&gt;device-&gt;node_type
comma
id|port_priv-&gt;port_num
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smi_check_local_dr_smp
c_func
(paren
op_amp
id|recv-&gt;mad.smp
comma
id|port_priv-&gt;device
comma
id|port_priv-&gt;port_num
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
id|local
suffix:colon
multiline_comment|/* Give driver &quot;right of first refusal&quot; on incoming MAD */
r_if
c_cond
(paren
id|port_priv-&gt;device-&gt;process_mad
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|response
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for response MAD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Is it better to assume that&n;&t;&t;&t; * it wouldn&squot;t be processed ?&n;&t;&t;&t; */
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|port_priv-&gt;device
op_member_access_from_pointer
id|process_mad
c_func
(paren
id|port_priv-&gt;device
comma
l_int|0
comma
id|port_priv-&gt;port_num
comma
id|wc
comma
op_amp
id|recv-&gt;grh
comma
op_amp
id|recv-&gt;mad.mad
comma
op_amp
id|response-&gt;mad.mad
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|IB_MAD_RESULT_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|ret
op_amp
id|IB_MAD_RESULT_CONSUMED
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_amp
id|IB_MAD_RESULT_REPLY
)paren
(brace
multiline_comment|/* Send response */
r_if
c_cond
(paren
op_logical_neg
id|agent_send
c_func
(paren
id|response
comma
op_amp
id|recv-&gt;grh
comma
id|wc
comma
id|port_priv-&gt;device
comma
id|port_priv-&gt;port_num
)paren
)paren
id|response
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Determine corresponding MAD agent for incoming receive MAD */
id|solicited
op_assign
id|solicited_mad
c_func
(paren
op_amp
id|recv-&gt;mad.mad
)paren
suffix:semicolon
id|mad_agent
op_assign
id|find_mad_agent
c_func
(paren
id|port_priv
comma
op_amp
id|recv-&gt;mad.mad
comma
id|solicited
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mad_agent
)paren
(brace
id|ib_mad_complete_recv
c_func
(paren
id|mad_agent
comma
id|recv
comma
id|solicited
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * recv is freed up in error cases in ib_mad_complete_recv&n;&t;&t; * or via recv_handler in ib_mad_complete_recv()&n;&t;&t; */
id|recv
op_assign
l_int|NULL
suffix:semicolon
)brace
id|out
suffix:colon
multiline_comment|/* Post another receive request for this QP */
r_if
c_cond
(paren
id|response
)paren
(brace
id|ib_mad_post_receive_mads
c_func
(paren
id|qp_info
comma
id|response
)paren
suffix:semicolon
r_if
c_cond
(paren
id|recv
)paren
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|recv
)paren
suffix:semicolon
)brace
r_else
id|ib_mad_post_receive_mads
c_func
(paren
id|qp_info
comma
id|recv
)paren
suffix:semicolon
)brace
DECL|function|adjust_timeout
r_static
r_void
id|adjust_timeout
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
)paren
(brace
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
r_int
r_int
id|delay
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait_list
)paren
)paren
(brace
id|cancel_delayed_work
c_func
(paren
op_amp
id|mad_agent_priv-&gt;timed_work
)paren
suffix:semicolon
)brace
r_else
(brace
id|mad_send_wr
op_assign
id|list_entry
c_func
(paren
id|mad_agent_priv-&gt;wait_list.next
comma
r_struct
id|ib_mad_send_wr_private
comma
id|agent_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|mad_agent_priv-&gt;timeout
comma
id|mad_send_wr-&gt;timeout
)paren
)paren
(brace
id|mad_agent_priv-&gt;timeout
op_assign
id|mad_send_wr-&gt;timeout
suffix:semicolon
id|cancel_delayed_work
c_func
(paren
op_amp
id|mad_agent_priv-&gt;timed_work
)paren
suffix:semicolon
id|delay
op_assign
id|mad_send_wr-&gt;timeout
op_minus
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|delay
op_le
l_int|0
)paren
id|delay
op_assign
l_int|1
suffix:semicolon
id|queue_delayed_work
c_func
(paren
id|mad_agent_priv-&gt;qp_info
op_member_access_from_pointer
id|port_priv-&gt;wq
comma
op_amp
id|mad_agent_priv-&gt;timed_work
comma
id|delay
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|wait_for_response
r_static
r_void
id|wait_for_response
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
comma
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
)paren
(brace
r_struct
id|ib_mad_send_wr_private
op_star
id|temp_mad_send_wr
suffix:semicolon
r_struct
id|list_head
op_star
id|list_item
suffix:semicolon
r_int
r_int
id|delay
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
)paren
suffix:semicolon
id|delay
op_assign
id|mad_send_wr-&gt;timeout
suffix:semicolon
id|mad_send_wr-&gt;timeout
op_add_assign
id|jiffies
suffix:semicolon
id|list_for_each_prev
c_func
(paren
id|list_item
comma
op_amp
id|mad_agent_priv-&gt;wait_list
)paren
(brace
id|temp_mad_send_wr
op_assign
id|list_entry
c_func
(paren
id|list_item
comma
r_struct
id|ib_mad_send_wr_private
comma
id|agent_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|mad_send_wr-&gt;timeout
comma
id|temp_mad_send_wr-&gt;timeout
)paren
)paren
r_break
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
comma
id|list_item
)paren
suffix:semicolon
multiline_comment|/* Reschedule a work item if we have a shorter timeout */
r_if
c_cond
(paren
id|mad_agent_priv-&gt;wait_list.next
op_eq
op_amp
id|mad_send_wr-&gt;agent_list
)paren
(brace
id|cancel_delayed_work
c_func
(paren
op_amp
id|mad_agent_priv-&gt;timed_work
)paren
suffix:semicolon
id|queue_delayed_work
c_func
(paren
id|mad_agent_priv-&gt;qp_info-&gt;port_priv-&gt;wq
comma
op_amp
id|mad_agent_priv-&gt;timed_work
comma
id|delay
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Process a send work completion&n; */
DECL|function|ib_mad_complete_send_wr
r_static
r_void
id|ib_mad_complete_send_wr
c_func
(paren
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
comma
r_struct
id|ib_mad_send_wc
op_star
id|mad_send_wc
)paren
(brace
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|mad_agent_priv
op_assign
id|container_of
c_func
(paren
id|mad_send_wr-&gt;agent
comma
r_struct
id|ib_mad_agent_private
comma
id|agent
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mad_send_wc-&gt;status
op_ne
id|IB_WC_SUCCESS
op_logical_and
id|mad_send_wr-&gt;status
op_eq
id|IB_WC_SUCCESS
)paren
(brace
id|mad_send_wr-&gt;status
op_assign
id|mad_send_wc-&gt;status
suffix:semicolon
id|mad_send_wr-&gt;refcount
op_sub_assign
(paren
id|mad_send_wr-&gt;timeout
OG
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|mad_send_wr-&gt;refcount
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|mad_send_wr-&gt;refcount
op_eq
l_int|1
op_logical_and
id|mad_send_wr-&gt;timeout
op_logical_and
id|mad_send_wr-&gt;status
op_eq
id|IB_WC_SUCCESS
)paren
(brace
id|wait_for_response
c_func
(paren
id|mad_agent_priv
comma
id|mad_send_wr
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Remove send from MAD agent and notify client of completion */
id|list_del
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
)paren
suffix:semicolon
id|adjust_timeout
c_func
(paren
id|mad_agent_priv
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mad_send_wr-&gt;status
op_ne
id|IB_WC_SUCCESS
)paren
id|mad_send_wc-&gt;status
op_assign
id|mad_send_wr-&gt;status
suffix:semicolon
id|mad_agent_priv-&gt;agent
dot
id|send_handler
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent
comma
id|mad_send_wc
)paren
suffix:semicolon
multiline_comment|/* Release reference on agent taken when sending */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mad_send_wr
)paren
suffix:semicolon
)brace
DECL|function|ib_mad_send_done_handler
r_static
r_void
id|ib_mad_send_done_handler
c_func
(paren
r_struct
id|ib_mad_port_private
op_star
id|port_priv
comma
r_struct
id|ib_wc
op_star
id|wc
)paren
(brace
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
comma
op_star
id|queued_send_wr
suffix:semicolon
r_struct
id|ib_mad_list_head
op_star
id|mad_list
suffix:semicolon
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
suffix:semicolon
r_struct
id|ib_mad_queue
op_star
id|send_queue
suffix:semicolon
r_struct
id|ib_send_wr
op_star
id|bad_send_wr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|mad_list
op_assign
(paren
r_struct
id|ib_mad_list_head
op_star
)paren
(paren
r_int
r_int
)paren
id|wc-&gt;wr_id
suffix:semicolon
id|mad_send_wr
op_assign
id|container_of
c_func
(paren
id|mad_list
comma
r_struct
id|ib_mad_send_wr_private
comma
id|mad_list
)paren
suffix:semicolon
id|send_queue
op_assign
id|mad_list-&gt;mad_queue
suffix:semicolon
id|qp_info
op_assign
id|send_queue-&gt;qp_info
suffix:semicolon
id|retry
suffix:colon
id|queued_send_wr
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|send_queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_list-&gt;list
)paren
suffix:semicolon
multiline_comment|/* Move queued send to the send queue */
r_if
c_cond
(paren
id|send_queue-&gt;count
op_decrement
OG
id|send_queue-&gt;max_active
)paren
(brace
id|mad_list
op_assign
id|container_of
c_func
(paren
id|qp_info-&gt;overflow_list.next
comma
r_struct
id|ib_mad_list_head
comma
id|list
)paren
suffix:semicolon
id|queued_send_wr
op_assign
id|container_of
c_func
(paren
id|mad_list
comma
r_struct
id|ib_mad_send_wr_private
comma
id|mad_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_list-&gt;list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mad_list-&gt;list
comma
op_amp
id|send_queue-&gt;list
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|send_queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Restore client wr_id in WC and complete send */
id|wc-&gt;wr_id
op_assign
id|mad_send_wr-&gt;wr_id
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|qp_info-&gt;snoop_count
)paren
)paren
id|snoop_send
c_func
(paren
id|qp_info
comma
op_amp
id|mad_send_wr-&gt;send_wr
comma
(paren
r_struct
id|ib_mad_send_wc
op_star
)paren
id|wc
comma
id|IB_MAD_SNOOP_SEND_COMPLETIONS
)paren
suffix:semicolon
id|ib_mad_complete_send_wr
c_func
(paren
id|mad_send_wr
comma
(paren
r_struct
id|ib_mad_send_wc
op_star
)paren
id|wc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|queued_send_wr
)paren
(brace
id|ret
op_assign
id|ib_post_send
c_func
(paren
id|qp_info-&gt;qp
comma
op_amp
id|queued_send_wr-&gt;send_wr
comma
op_amp
id|bad_send_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ib_post_send failed: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|mad_send_wr
op_assign
id|queued_send_wr
suffix:semicolon
id|wc-&gt;status
op_assign
id|IB_WC_LOC_QP_OP_ERR
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
)brace
)brace
DECL|function|mark_sends_for_retry
r_static
r_void
id|mark_sends_for_retry
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
)paren
(brace
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
r_struct
id|ib_mad_list_head
op_star
id|mad_list
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|qp_info-&gt;send_queue.lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|mad_list
comma
op_amp
id|qp_info-&gt;send_queue.list
comma
id|list
)paren
(brace
id|mad_send_wr
op_assign
id|container_of
c_func
(paren
id|mad_list
comma
r_struct
id|ib_mad_send_wr_private
comma
id|mad_list
)paren
suffix:semicolon
id|mad_send_wr-&gt;retry
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|qp_info-&gt;send_queue.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mad_error_handler
r_static
r_void
id|mad_error_handler
c_func
(paren
r_struct
id|ib_mad_port_private
op_star
id|port_priv
comma
r_struct
id|ib_wc
op_star
id|wc
)paren
(brace
r_struct
id|ib_mad_list_head
op_star
id|mad_list
suffix:semicolon
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
suffix:semicolon
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Determine if failure was a send or receive */
id|mad_list
op_assign
(paren
r_struct
id|ib_mad_list_head
op_star
)paren
(paren
r_int
r_int
)paren
id|wc-&gt;wr_id
suffix:semicolon
id|qp_info
op_assign
id|mad_list-&gt;mad_queue-&gt;qp_info
suffix:semicolon
r_if
c_cond
(paren
id|mad_list-&gt;mad_queue
op_eq
op_amp
id|qp_info-&gt;recv_queue
)paren
multiline_comment|/*&n;&t;&t; * Receive errors indicate that the QP has entered the error&n;&t;&t; * state - error handling/shutdown code will cleanup&n;&t;&t; */
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Send errors will transition the QP to SQE - move&n;&t; * QP to RTS and repost flushed work requests&n;&t; */
id|mad_send_wr
op_assign
id|container_of
c_func
(paren
id|mad_list
comma
r_struct
id|ib_mad_send_wr_private
comma
id|mad_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wc-&gt;status
op_eq
id|IB_WC_WR_FLUSH_ERR
)paren
(brace
r_if
c_cond
(paren
id|mad_send_wr-&gt;retry
)paren
(brace
multiline_comment|/* Repost send */
r_struct
id|ib_send_wr
op_star
id|bad_send_wr
suffix:semicolon
id|mad_send_wr-&gt;retry
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|ib_post_send
c_func
(paren
id|qp_info-&gt;qp
comma
op_amp
id|mad_send_wr-&gt;send_wr
comma
op_amp
id|bad_send_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|ib_mad_send_done_handler
c_func
(paren
id|port_priv
comma
id|wc
)paren
suffix:semicolon
)brace
r_else
id|ib_mad_send_done_handler
c_func
(paren
id|port_priv
comma
id|wc
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|ib_qp_attr
op_star
id|attr
suffix:semicolon
multiline_comment|/* Transition QP to RTS and fail offending send */
id|attr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|attr
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|attr
)paren
(brace
id|attr-&gt;qp_state
op_assign
id|IB_QPS_RTS
suffix:semicolon
id|attr-&gt;cur_qp_state
op_assign
id|IB_QPS_SQE
suffix:semicolon
id|ret
op_assign
id|ib_modify_qp
c_func
(paren
id|qp_info-&gt;qp
comma
id|attr
comma
id|IB_QP_STATE
op_or
id|IB_QP_CUR_STATE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;mad_error_handler - &quot;
l_string|&quot;ib_modify_qp to RTS : %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_else
id|mark_sends_for_retry
c_func
(paren
id|qp_info
)paren
suffix:semicolon
)brace
id|ib_mad_send_done_handler
c_func
(paren
id|port_priv
comma
id|wc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * IB MAD completion callback&n; */
DECL|function|ib_mad_completion_handler
r_static
r_void
id|ib_mad_completion_handler
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_struct
id|ib_wc
id|wc
suffix:semicolon
id|port_priv
op_assign
(paren
r_struct
id|ib_mad_port_private
op_star
)paren
id|data
suffix:semicolon
id|ib_req_notify_cq
c_func
(paren
id|port_priv-&gt;cq
comma
id|IB_CQ_NEXT_COMP
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ib_poll_cq
c_func
(paren
id|port_priv-&gt;cq
comma
l_int|1
comma
op_amp
id|wc
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|wc.status
op_eq
id|IB_WC_SUCCESS
)paren
(brace
r_switch
c_cond
(paren
id|wc.opcode
)paren
(brace
r_case
id|IB_WC_SEND
suffix:colon
id|ib_mad_send_done_handler
c_func
(paren
id|port_priv
comma
op_amp
id|wc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IB_WC_RECV
suffix:colon
id|ib_mad_recv_done_handler
c_func
(paren
id|port_priv
comma
op_amp
id|wc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG_ON
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|mad_error_handler
c_func
(paren
id|port_priv
comma
op_amp
id|wc
)paren
suffix:semicolon
)brace
)brace
DECL|function|cancel_mads
r_static
r_void
id|cancel_mads
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
comma
op_star
id|temp_mad_send_wr
suffix:semicolon
r_struct
id|ib_mad_send_wc
id|mad_send_wc
suffix:semicolon
r_struct
id|list_head
id|cancel_list
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|cancel_list
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|mad_send_wr
comma
id|temp_mad_send_wr
comma
op_amp
id|mad_agent_priv-&gt;send_list
comma
id|agent_list
)paren
(brace
r_if
c_cond
(paren
id|mad_send_wr-&gt;status
op_eq
id|IB_WC_SUCCESS
)paren
(brace
id|mad_send_wr-&gt;status
op_assign
id|IB_WC_WR_FLUSH_ERR
suffix:semicolon
id|mad_send_wr-&gt;refcount
op_sub_assign
(paren
id|mad_send_wr-&gt;timeout
OG
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Empty wait list to prevent receives from finding a request */
id|list_splice_init
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait_list
comma
op_amp
id|cancel_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Report all cancelled requests */
id|mad_send_wc.status
op_assign
id|IB_WC_WR_FLUSH_ERR
suffix:semicolon
id|mad_send_wc.vendor_err
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|mad_send_wr
comma
id|temp_mad_send_wr
comma
op_amp
id|cancel_list
comma
id|agent_list
)paren
(brace
id|mad_send_wc.wr_id
op_assign
id|mad_send_wr-&gt;wr_id
suffix:semicolon
id|mad_agent_priv-&gt;agent
dot
id|send_handler
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent
comma
op_amp
id|mad_send_wc
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mad_send_wr
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
)brace
)brace
r_static
r_struct
id|ib_mad_send_wr_private
op_star
DECL|function|find_send_by_wr_id
id|find_send_by_wr_id
c_func
(paren
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
comma
id|u64
id|wr_id
)paren
(brace
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|mad_send_wr
comma
op_amp
id|mad_agent_priv-&gt;wait_list
comma
id|agent_list
)paren
(brace
r_if
c_cond
(paren
id|mad_send_wr-&gt;wr_id
op_eq
id|wr_id
)paren
r_return
id|mad_send_wr
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|mad_send_wr
comma
op_amp
id|mad_agent_priv-&gt;send_list
comma
id|agent_list
)paren
(brace
r_if
c_cond
(paren
id|mad_send_wr-&gt;wr_id
op_eq
id|wr_id
)paren
r_return
id|mad_send_wr
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|cancel_sends
r_void
id|cancel_sends
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
suffix:semicolon
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
r_struct
id|ib_mad_send_wc
id|mad_send_wc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|mad_agent_priv
op_assign
id|data
suffix:semicolon
id|mad_send_wc.status
op_assign
id|IB_WC_WR_FLUSH_ERR
suffix:semicolon
id|mad_send_wc.vendor_err
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|mad_agent_priv-&gt;canceled_list
)paren
)paren
(brace
id|mad_send_wr
op_assign
id|list_entry
c_func
(paren
id|mad_agent_priv-&gt;canceled_list.next
comma
r_struct
id|ib_mad_send_wr_private
comma
id|agent_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mad_send_wc.wr_id
op_assign
id|mad_send_wr-&gt;wr_id
suffix:semicolon
id|mad_agent_priv-&gt;agent
dot
id|send_handler
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent
comma
op_amp
id|mad_send_wc
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mad_send_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ib_cancel_mad
r_void
id|ib_cancel_mad
c_func
(paren
r_struct
id|ib_mad_agent
op_star
id|mad_agent
comma
id|u64
id|wr_id
)paren
(brace
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
suffix:semicolon
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|mad_agent_priv
op_assign
id|container_of
c_func
(paren
id|mad_agent
comma
r_struct
id|ib_mad_agent_private
comma
id|agent
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mad_send_wr
op_assign
id|find_send_by_wr_id
c_func
(paren
id|mad_agent_priv
comma
id|wr_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_send_wr
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mad_send_wr-&gt;status
op_eq
id|IB_WC_SUCCESS
)paren
id|mad_send_wr-&gt;refcount
op_sub_assign
(paren
id|mad_send_wr-&gt;timeout
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mad_send_wr-&gt;refcount
op_ne
l_int|0
)paren
(brace
id|mad_send_wr-&gt;status
op_assign
id|IB_WC_WR_FLUSH_ERR
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
comma
op_amp
id|mad_agent_priv-&gt;canceled_list
)paren
suffix:semicolon
id|adjust_timeout
c_func
(paren
id|mad_agent_priv
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|mad_agent_priv-&gt;qp_info-&gt;port_priv-&gt;wq
comma
op_amp
id|mad_agent_priv-&gt;canceled_work
)paren
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
)brace
DECL|variable|ib_cancel_mad
id|EXPORT_SYMBOL
c_func
(paren
id|ib_cancel_mad
)paren
suffix:semicolon
DECL|function|local_completions
r_static
r_void
id|local_completions
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
suffix:semicolon
r_struct
id|ib_mad_local_private
op_star
id|local
suffix:semicolon
r_struct
id|ib_mad_agent_private
op_star
id|recv_mad_agent
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ib_wc
id|wc
suffix:semicolon
r_struct
id|ib_mad_send_wc
id|mad_send_wc
suffix:semicolon
id|mad_agent_priv
op_assign
(paren
r_struct
id|ib_mad_agent_private
op_star
)paren
id|data
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|mad_agent_priv-&gt;local_list
)paren
)paren
(brace
id|local
op_assign
id|list_entry
c_func
(paren
id|mad_agent_priv-&gt;local_list.next
comma
r_struct
id|ib_mad_local_private
comma
id|completion_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local-&gt;mad_priv
)paren
(brace
id|recv_mad_agent
op_assign
id|local-&gt;recv_mad_agent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|recv_mad_agent
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No receive MAD agent for local completion&bslash;n&quot;
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|local-&gt;mad_priv
)paren
suffix:semicolon
r_goto
id|local_send_completion
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Defined behavior is to complete response&n;&t;&t;&t; * before request&n;&t;&t;&t; */
id|build_smp_wc
c_func
(paren
id|local-&gt;wr_id
comma
id|IB_LID_PERMISSIVE
comma
l_int|0
multiline_comment|/* pkey index */
comma
id|recv_mad_agent-&gt;agent.port_num
comma
op_amp
id|wc
)paren
suffix:semicolon
id|local-&gt;mad_priv-&gt;header.recv_wc.wc
op_assign
op_amp
id|wc
suffix:semicolon
id|local-&gt;mad_priv-&gt;header.recv_wc.mad_len
op_assign
r_sizeof
(paren
r_struct
id|ib_mad
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|local-&gt;mad_priv-&gt;header.recv_wc.recv_buf.list
)paren
suffix:semicolon
id|local-&gt;mad_priv-&gt;header.recv_wc.recv_buf.grh
op_assign
l_int|NULL
suffix:semicolon
id|local-&gt;mad_priv-&gt;header.recv_wc.recv_buf.mad
op_assign
op_amp
id|local-&gt;mad_priv-&gt;mad.mad
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|recv_mad_agent-&gt;qp_info-&gt;snoop_count
)paren
)paren
id|snoop_recv
c_func
(paren
id|recv_mad_agent-&gt;qp_info
comma
op_amp
id|local-&gt;mad_priv-&gt;header.recv_wc
comma
id|IB_MAD_SNOOP_RECVS
)paren
suffix:semicolon
id|recv_mad_agent-&gt;agent
dot
id|recv_handler
c_func
(paren
op_amp
id|recv_mad_agent-&gt;agent
comma
op_amp
id|local-&gt;mad_priv-&gt;header.recv_wc
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|recv_mad_agent-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|recv_mad_agent-&gt;refcount
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|recv_mad_agent-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|local_send_completion
suffix:colon
multiline_comment|/* Complete send */
id|mad_send_wc.status
op_assign
id|IB_WC_SUCCESS
suffix:semicolon
id|mad_send_wc.vendor_err
op_assign
l_int|0
suffix:semicolon
id|mad_send_wc.wr_id
op_assign
id|local-&gt;wr_id
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|mad_agent_priv-&gt;qp_info-&gt;snoop_count
)paren
)paren
id|snoop_send
c_func
(paren
id|mad_agent_priv-&gt;qp_info
comma
op_amp
id|local-&gt;send_wr
comma
op_amp
id|mad_send_wc
comma
id|IB_MAD_SNOOP_SEND_COMPLETIONS
)paren
suffix:semicolon
id|mad_agent_priv-&gt;agent
dot
id|send_handler
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent
comma
op_amp
id|mad_send_wc
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|local-&gt;completion_list
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|local
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|timeout_sends
r_static
r_void
id|timeout_sends
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ib_mad_agent_private
op_star
id|mad_agent_priv
suffix:semicolon
r_struct
id|ib_mad_send_wr_private
op_star
id|mad_send_wr
suffix:semicolon
r_struct
id|ib_mad_send_wc
id|mad_send_wc
suffix:semicolon
r_int
r_int
id|flags
comma
id|delay
suffix:semicolon
id|mad_agent_priv
op_assign
(paren
r_struct
id|ib_mad_agent_private
op_star
)paren
id|data
suffix:semicolon
id|mad_send_wc.status
op_assign
id|IB_WC_RESP_TIMEOUT_ERR
suffix:semicolon
id|mad_send_wc.vendor_err
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|mad_agent_priv-&gt;wait_list
)paren
)paren
(brace
id|mad_send_wr
op_assign
id|list_entry
c_func
(paren
id|mad_agent_priv-&gt;wait_list.next
comma
r_struct
id|ib_mad_send_wr_private
comma
id|agent_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|mad_send_wr-&gt;timeout
comma
id|jiffies
)paren
)paren
(brace
id|delay
op_assign
id|mad_send_wr-&gt;timeout
op_minus
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|delay
op_le
l_int|0
)paren
id|delay
op_assign
l_int|1
suffix:semicolon
id|queue_delayed_work
c_func
(paren
id|mad_agent_priv-&gt;qp_info
op_member_access_from_pointer
id|port_priv-&gt;wq
comma
op_amp
id|mad_agent_priv-&gt;timed_work
comma
id|delay
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|mad_send_wr-&gt;agent_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mad_send_wc.wr_id
op_assign
id|mad_send_wr-&gt;wr_id
suffix:semicolon
id|mad_agent_priv-&gt;agent
dot
id|send_handler
c_func
(paren
op_amp
id|mad_agent_priv-&gt;agent
comma
op_amp
id|mad_send_wc
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mad_send_wr
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mad_agent_priv-&gt;refcount
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mad_agent_priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ib_mad_thread_completion_handler
r_static
r_void
id|ib_mad_thread_completion_handler
c_func
(paren
r_struct
id|ib_cq
op_star
id|cq
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
op_assign
id|cq-&gt;cq_context
suffix:semicolon
id|queue_work
c_func
(paren
id|port_priv-&gt;wq
comma
op_amp
id|port_priv-&gt;work
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate receive MADs and post receive WRs for them&n; */
DECL|function|ib_mad_post_receive_mads
r_static
r_int
id|ib_mad_post_receive_mads
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
comma
r_struct
id|ib_mad_private
op_star
id|mad
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|post
comma
id|ret
suffix:semicolon
r_struct
id|ib_mad_private
op_star
id|mad_priv
suffix:semicolon
r_struct
id|ib_sge
id|sg_list
suffix:semicolon
r_struct
id|ib_recv_wr
id|recv_wr
comma
op_star
id|bad_recv_wr
suffix:semicolon
r_struct
id|ib_mad_queue
op_star
id|recv_queue
op_assign
op_amp
id|qp_info-&gt;recv_queue
suffix:semicolon
multiline_comment|/* Initialize common scatter list fields */
id|sg_list.length
op_assign
r_sizeof
op_star
id|mad_priv
op_minus
r_sizeof
id|mad_priv-&gt;header
suffix:semicolon
id|sg_list.lkey
op_assign
id|qp_info-&gt;port_priv-&gt;mr.lkey
suffix:semicolon
multiline_comment|/* Initialize common receive WR fields */
id|recv_wr.next
op_assign
l_int|NULL
suffix:semicolon
id|recv_wr.sg_list
op_assign
op_amp
id|sg_list
suffix:semicolon
id|recv_wr.num_sge
op_assign
l_int|1
suffix:semicolon
r_do
(brace
multiline_comment|/* Allocate and map receive buffer */
r_if
c_cond
(paren
id|mad
)paren
(brace
id|mad_priv
op_assign
id|mad
suffix:semicolon
id|mad
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|mad_priv
op_assign
id|kmem_cache_alloc
c_func
(paren
id|ib_mad_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mad_priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for receive buffer&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|sg_list.addr
op_assign
id|dma_map_single
c_func
(paren
id|qp_info-&gt;port_priv
op_member_access_from_pointer
id|device-&gt;dma_device
comma
op_amp
id|mad_priv-&gt;grh
comma
r_sizeof
op_star
id|mad_priv
op_minus
r_sizeof
id|mad_priv-&gt;header
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|pci_unmap_addr_set
c_func
(paren
op_amp
id|mad_priv-&gt;header
comma
id|mapping
comma
id|sg_list.addr
)paren
suffix:semicolon
id|recv_wr.wr_id
op_assign
(paren
r_int
r_int
)paren
op_amp
id|mad_priv-&gt;header.mad_list
suffix:semicolon
id|mad_priv-&gt;header.mad_list.mad_queue
op_assign
id|recv_queue
suffix:semicolon
multiline_comment|/* Post receive WR */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|recv_queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|post
op_assign
(paren
op_increment
id|recv_queue-&gt;count
OL
id|recv_queue-&gt;max_active
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mad_priv-&gt;header.mad_list.list
comma
op_amp
id|recv_queue-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|recv_queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|ib_post_recv
c_func
(paren
id|qp_info-&gt;qp
comma
op_amp
id|recv_wr
comma
op_amp
id|bad_recv_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|recv_queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mad_priv-&gt;header.mad_list.list
)paren
suffix:semicolon
id|recv_queue-&gt;count
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|recv_queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|qp_info-&gt;port_priv-&gt;device-&gt;dma_device
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|mad_priv-&gt;header
comma
id|mapping
)paren
comma
r_sizeof
op_star
id|mad_priv
op_minus
r_sizeof
id|mad_priv-&gt;header
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|mad_priv
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ib_post_recv failed: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|post
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Return all the posted receive MADs&n; */
DECL|function|cleanup_recv_queue
r_static
r_void
id|cleanup_recv_queue
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
)paren
(brace
r_struct
id|ib_mad_private_header
op_star
id|mad_priv_hdr
suffix:semicolon
r_struct
id|ib_mad_private
op_star
id|recv
suffix:semicolon
r_struct
id|ib_mad_list_head
op_star
id|mad_list
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|qp_info-&gt;recv_queue.list
)paren
)paren
(brace
id|mad_list
op_assign
id|list_entry
c_func
(paren
id|qp_info-&gt;recv_queue.list.next
comma
r_struct
id|ib_mad_list_head
comma
id|list
)paren
suffix:semicolon
id|mad_priv_hdr
op_assign
id|container_of
c_func
(paren
id|mad_list
comma
r_struct
id|ib_mad_private_header
comma
id|mad_list
)paren
suffix:semicolon
id|recv
op_assign
id|container_of
c_func
(paren
id|mad_priv_hdr
comma
r_struct
id|ib_mad_private
comma
id|header
)paren
suffix:semicolon
multiline_comment|/* Remove from posted receive MAD list */
id|list_del
c_func
(paren
op_amp
id|mad_list-&gt;list
)paren
suffix:semicolon
multiline_comment|/* Undo PCI mapping */
id|dma_unmap_single
c_func
(paren
id|qp_info-&gt;port_priv-&gt;device-&gt;dma_device
comma
id|pci_unmap_addr
c_func
(paren
op_amp
id|recv-&gt;header
comma
id|mapping
)paren
comma
r_sizeof
(paren
r_struct
id|ib_mad_private
)paren
op_minus
r_sizeof
(paren
r_struct
id|ib_mad_private_header
)paren
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|ib_mad_cache
comma
id|recv
)paren
suffix:semicolon
)brace
id|qp_info-&gt;recv_queue.count
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Start the port&n; */
DECL|function|ib_mad_port_start
r_static
r_int
id|ib_mad_port_start
c_func
(paren
r_struct
id|ib_mad_port_private
op_star
id|port_priv
)paren
(brace
r_int
id|ret
comma
id|i
suffix:semicolon
r_struct
id|ib_qp_attr
op_star
id|attr
suffix:semicolon
r_struct
id|ib_qp
op_star
id|qp
suffix:semicolon
id|attr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|attr
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|attr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t kmalloc ib_qp_attr&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IB_MAD_QPS_CORE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|qp
op_assign
id|port_priv-&gt;qp_info
(braket
id|i
)braket
dot
id|qp
suffix:semicolon
multiline_comment|/*&n;&t;&t; * PKey index for QP1 is irrelevant but&n;&t;&t; * one is needed for the Reset to Init transition&n;&t;&t; */
id|attr-&gt;qp_state
op_assign
id|IB_QPS_INIT
suffix:semicolon
id|attr-&gt;pkey_index
op_assign
l_int|0
suffix:semicolon
id|attr-&gt;qkey
op_assign
(paren
id|qp-&gt;qp_num
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
id|IB_QP1_QKEY
suffix:semicolon
id|ret
op_assign
id|ib_modify_qp
c_func
(paren
id|qp
comma
id|attr
comma
id|IB_QP_STATE
op_or
id|IB_QP_PKEY_INDEX
op_or
id|IB_QP_QKEY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t change QP%d state to &quot;
l_string|&quot;INIT: %d&bslash;n&quot;
comma
id|i
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|attr-&gt;qp_state
op_assign
id|IB_QPS_RTR
suffix:semicolon
id|ret
op_assign
id|ib_modify_qp
c_func
(paren
id|qp
comma
id|attr
comma
id|IB_QP_STATE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t change QP%d state to &quot;
l_string|&quot;RTR: %d&bslash;n&quot;
comma
id|i
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|attr-&gt;qp_state
op_assign
id|IB_QPS_RTS
suffix:semicolon
id|attr-&gt;sq_psn
op_assign
id|IB_MAD_SEND_Q_PSN
suffix:semicolon
id|ret
op_assign
id|ib_modify_qp
c_func
(paren
id|qp
comma
id|attr
comma
id|IB_QP_STATE
op_or
id|IB_QP_SQ_PSN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t change QP%d state to &quot;
l_string|&quot;RTS: %d&bslash;n&quot;
comma
id|i
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|ib_req_notify_cq
c_func
(paren
id|port_priv-&gt;cq
comma
id|IB_CQ_NEXT_COMP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Failed to request completion &quot;
l_string|&quot;notification: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IB_MAD_QPS_CORE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_assign
id|ib_mad_post_receive_mads
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t post receive WRs&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|kfree
c_func
(paren
id|attr
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|qp_event_handler
r_static
r_void
id|qp_event_handler
c_func
(paren
r_struct
id|ib_event
op_star
id|event
comma
r_void
op_star
id|qp_context
)paren
(brace
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
op_assign
id|qp_context
suffix:semicolon
multiline_comment|/* It&squot;s worse than that! He&squot;s dead, Jim! */
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Fatal error (%d) on MAD QP (%d)&bslash;n&quot;
comma
id|event-&gt;event
comma
id|qp_info-&gt;qp-&gt;qp_num
)paren
suffix:semicolon
)brace
DECL|function|init_mad_queue
r_static
r_void
id|init_mad_queue
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
comma
r_struct
id|ib_mad_queue
op_star
id|mad_queue
)paren
(brace
id|mad_queue-&gt;qp_info
op_assign
id|qp_info
suffix:semicolon
id|mad_queue-&gt;count
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|mad_queue-&gt;lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mad_queue-&gt;list
)paren
suffix:semicolon
)brace
DECL|function|init_mad_qp
r_static
r_void
id|init_mad_qp
c_func
(paren
r_struct
id|ib_mad_port_private
op_star
id|port_priv
comma
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
)paren
(brace
id|qp_info-&gt;port_priv
op_assign
id|port_priv
suffix:semicolon
id|init_mad_queue
c_func
(paren
id|qp_info
comma
op_amp
id|qp_info-&gt;send_queue
)paren
suffix:semicolon
id|init_mad_queue
c_func
(paren
id|qp_info
comma
op_amp
id|qp_info-&gt;recv_queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|qp_info-&gt;overflow_list
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|qp_info-&gt;snoop_lock
)paren
suffix:semicolon
id|qp_info-&gt;snoop_table
op_assign
l_int|NULL
suffix:semicolon
id|qp_info-&gt;snoop_table_size
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|qp_info-&gt;snoop_count
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|create_mad_qp
r_static
r_int
id|create_mad_qp
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
comma
r_enum
id|ib_qp_type
id|qp_type
)paren
(brace
r_struct
id|ib_qp_init_attr
id|qp_init_attr
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|qp_init_attr
comma
l_int|0
comma
r_sizeof
id|qp_init_attr
)paren
suffix:semicolon
id|qp_init_attr.send_cq
op_assign
id|qp_info-&gt;port_priv-&gt;cq
suffix:semicolon
id|qp_init_attr.recv_cq
op_assign
id|qp_info-&gt;port_priv-&gt;cq
suffix:semicolon
id|qp_init_attr.sq_sig_type
op_assign
id|IB_SIGNAL_ALL_WR
suffix:semicolon
id|qp_init_attr.cap.max_send_wr
op_assign
id|IB_MAD_QP_SEND_SIZE
suffix:semicolon
id|qp_init_attr.cap.max_recv_wr
op_assign
id|IB_MAD_QP_RECV_SIZE
suffix:semicolon
id|qp_init_attr.cap.max_send_sge
op_assign
id|IB_MAD_SEND_REQ_MAX_SG
suffix:semicolon
id|qp_init_attr.cap.max_recv_sge
op_assign
id|IB_MAD_RECV_REQ_MAX_SG
suffix:semicolon
id|qp_init_attr.qp_type
op_assign
id|qp_type
suffix:semicolon
id|qp_init_attr.port_num
op_assign
id|qp_info-&gt;port_priv-&gt;port_num
suffix:semicolon
id|qp_init_attr.qp_context
op_assign
id|qp_info
suffix:semicolon
id|qp_init_attr.event_handler
op_assign
id|qp_event_handler
suffix:semicolon
id|qp_info-&gt;qp
op_assign
id|ib_create_qp
c_func
(paren
id|qp_info-&gt;port_priv-&gt;pd
comma
op_amp
id|qp_init_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|qp_info-&gt;qp
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t create ib_mad QP%d&bslash;n&quot;
comma
id|get_spl_qp_index
c_func
(paren
id|qp_type
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|qp_info-&gt;qp
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Use minimum queue sizes unless the CQ is resized */
id|qp_info-&gt;send_queue.max_active
op_assign
id|IB_MAD_QP_SEND_SIZE
suffix:semicolon
id|qp_info-&gt;recv_queue.max_active
op_assign
id|IB_MAD_QP_RECV_SIZE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|destroy_mad_qp
r_static
r_void
id|destroy_mad_qp
c_func
(paren
r_struct
id|ib_mad_qp_info
op_star
id|qp_info
)paren
(brace
id|ib_destroy_qp
c_func
(paren
id|qp_info-&gt;qp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qp_info-&gt;snoop_table
)paren
id|kfree
c_func
(paren
id|qp_info-&gt;snoop_table
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Open the port&n; * Create the QP, PD, MR, and CQ if needed&n; */
DECL|function|ib_mad_port_open
r_static
r_int
id|ib_mad_port_open
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
)paren
(brace
r_int
id|ret
comma
id|cq_size
suffix:semicolon
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
id|name
(braket
r_sizeof
l_string|&quot;ib_mad123&quot;
)braket
suffix:semicolon
multiline_comment|/* First, check if port already open at MAD layer */
id|port_priv
op_assign
id|ib_get_mad_port
c_func
(paren
id|device
comma
id|port_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;%s port %d already open&bslash;n&quot;
comma
id|device-&gt;name
comma
id|port_num
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Create new device info */
id|port_priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|port_priv
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port_priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No memory for ib_mad_port_private&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|port_priv
comma
l_int|0
comma
r_sizeof
op_star
id|port_priv
)paren
suffix:semicolon
id|port_priv-&gt;device
op_assign
id|device
suffix:semicolon
id|port_priv-&gt;port_num
op_assign
id|port_num
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|port_priv-&gt;reg_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|port_priv-&gt;agent_list
)paren
suffix:semicolon
id|init_mad_qp
c_func
(paren
id|port_priv
comma
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|init_mad_qp
c_func
(paren
id|port_priv
comma
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|cq_size
op_assign
(paren
id|IB_MAD_QP_SEND_SIZE
op_plus
id|IB_MAD_QP_RECV_SIZE
)paren
op_star
l_int|2
suffix:semicolon
id|port_priv-&gt;cq
op_assign
id|ib_create_cq
c_func
(paren
id|port_priv-&gt;device
comma
(paren
id|ib_comp_handler
)paren
id|ib_mad_thread_completion_handler
comma
l_int|NULL
comma
id|port_priv
comma
id|cq_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|port_priv-&gt;cq
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t create ib_mad CQ&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|port_priv-&gt;cq
)paren
suffix:semicolon
r_goto
id|error3
suffix:semicolon
)brace
id|port_priv-&gt;pd
op_assign
id|ib_alloc_pd
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|port_priv-&gt;pd
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t create ib_mad PD&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|port_priv-&gt;pd
)paren
suffix:semicolon
r_goto
id|error4
suffix:semicolon
)brace
id|port_priv-&gt;mr
op_assign
id|ib_get_dma_mr
c_func
(paren
id|port_priv-&gt;pd
comma
id|IB_ACCESS_LOCAL_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|port_priv-&gt;mr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t get ib_mad DMA MR&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|port_priv-&gt;mr
)paren
suffix:semicolon
r_goto
id|error5
suffix:semicolon
)brace
id|ret
op_assign
id|create_mad_qp
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|0
)braket
comma
id|IB_QPT_SMI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|error6
suffix:semicolon
id|ret
op_assign
id|create_mad_qp
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|1
)braket
comma
id|IB_QPT_GSI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|error7
suffix:semicolon
id|snprintf
c_func
(paren
id|name
comma
r_sizeof
id|name
comma
l_string|&quot;ib_mad%d&quot;
comma
id|port_num
)paren
suffix:semicolon
id|port_priv-&gt;wq
op_assign
id|create_singlethread_workqueue
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port_priv-&gt;wq
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error8
suffix:semicolon
)brace
id|INIT_WORK
c_func
(paren
op_amp
id|port_priv-&gt;work
comma
id|ib_mad_completion_handler
comma
id|port_priv
)paren
suffix:semicolon
id|ret
op_assign
id|ib_mad_port_start
c_func
(paren
id|port_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t start port&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error9
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ib_mad_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|port_priv-&gt;port_list
comma
op_amp
id|ib_mad_port_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ib_mad_port_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error9
suffix:colon
id|destroy_workqueue
c_func
(paren
id|port_priv-&gt;wq
)paren
suffix:semicolon
id|error8
suffix:colon
id|destroy_mad_qp
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|error7
suffix:colon
id|destroy_mad_qp
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|error6
suffix:colon
id|ib_dereg_mr
c_func
(paren
id|port_priv-&gt;mr
)paren
suffix:semicolon
id|error5
suffix:colon
id|ib_dealloc_pd
c_func
(paren
id|port_priv-&gt;pd
)paren
suffix:semicolon
id|error4
suffix:colon
id|ib_destroy_cq
c_func
(paren
id|port_priv-&gt;cq
)paren
suffix:semicolon
id|cleanup_recv_queue
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|cleanup_recv_queue
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|error3
suffix:colon
id|kfree
c_func
(paren
id|port_priv
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Close the port&n; * If there are no classes using the port, free the port&n; * resources (CQ, MR, PD, QP) and remove the port&squot;s info structure&n; */
DECL|function|ib_mad_port_close
r_static
r_int
id|ib_mad_port_close
c_func
(paren
r_struct
id|ib_device
op_star
id|device
comma
r_int
id|port_num
)paren
(brace
r_struct
id|ib_mad_port_private
op_star
id|port_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ib_mad_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|port_priv
op_assign
id|__ib_get_mad_port
c_func
(paren
id|device
comma
id|port_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_priv
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ib_mad_port_list_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Port %d not found&bslash;n&quot;
comma
id|port_num
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|port_priv-&gt;port_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ib_mad_port_list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Stop processing completions. */
id|flush_workqueue
c_func
(paren
id|port_priv-&gt;wq
)paren
suffix:semicolon
id|destroy_workqueue
c_func
(paren
id|port_priv-&gt;wq
)paren
suffix:semicolon
id|destroy_mad_qp
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|destroy_mad_qp
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ib_dereg_mr
c_func
(paren
id|port_priv-&gt;mr
)paren
suffix:semicolon
id|ib_dealloc_pd
c_func
(paren
id|port_priv-&gt;pd
)paren
suffix:semicolon
id|ib_destroy_cq
c_func
(paren
id|port_priv-&gt;cq
)paren
suffix:semicolon
id|cleanup_recv_queue
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|cleanup_recv_queue
c_func
(paren
op_amp
id|port_priv-&gt;qp_info
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* XXX: Handle deallocation of MAD registration tables */
id|kfree
c_func
(paren
id|port_priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ib_mad_init_device
r_static
r_void
id|ib_mad_init_device
c_func
(paren
r_struct
id|ib_device
op_star
id|device
)paren
(brace
r_int
id|ret
comma
id|num_ports
comma
id|cur_port
comma
id|i
comma
id|ret2
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;node_type
op_eq
id|IB_NODE_SWITCH
)paren
(brace
id|num_ports
op_assign
l_int|1
suffix:semicolon
id|cur_port
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|num_ports
op_assign
id|device-&gt;phys_port_cnt
suffix:semicolon
id|cur_port
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ports
suffix:semicolon
id|i
op_increment
comma
id|cur_port
op_increment
)paren
(brace
id|ret
op_assign
id|ib_mad_port_open
c_func
(paren
id|device
comma
id|cur_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t open %s port %d&bslash;n&quot;
comma
id|device-&gt;name
comma
id|cur_port
)paren
suffix:semicolon
r_goto
id|error_device_open
suffix:semicolon
)brace
id|ret
op_assign
id|ib_agent_port_open
c_func
(paren
id|device
comma
id|cur_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t open %s port %d &quot;
l_string|&quot;for agents&bslash;n&quot;
comma
id|device-&gt;name
comma
id|cur_port
)paren
suffix:semicolon
r_goto
id|error_device_open
suffix:semicolon
)brace
)brace
r_goto
id|error_device_query
suffix:semicolon
id|error_device_open
suffix:colon
r_while
c_loop
(paren
id|i
OG
l_int|0
)paren
(brace
id|cur_port
op_decrement
suffix:semicolon
id|ret2
op_assign
id|ib_agent_port_close
c_func
(paren
id|device
comma
id|cur_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t close %s port %d &quot;
l_string|&quot;for agents&bslash;n&quot;
comma
id|device-&gt;name
comma
id|cur_port
)paren
suffix:semicolon
)brace
id|ret2
op_assign
id|ib_mad_port_close
c_func
(paren
id|device
comma
id|cur_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t close %s port %d&bslash;n&quot;
comma
id|device-&gt;name
comma
id|cur_port
)paren
suffix:semicolon
)brace
id|i
op_decrement
suffix:semicolon
)brace
id|error_device_query
suffix:colon
r_return
suffix:semicolon
)brace
DECL|function|ib_mad_remove_device
r_static
r_void
id|ib_mad_remove_device
c_func
(paren
r_struct
id|ib_device
op_star
id|device
)paren
(brace
r_int
id|ret
op_assign
l_int|0
comma
id|i
comma
id|num_ports
comma
id|cur_port
comma
id|ret2
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;node_type
op_eq
id|IB_NODE_SWITCH
)paren
(brace
id|num_ports
op_assign
l_int|1
suffix:semicolon
id|cur_port
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|num_ports
op_assign
id|device-&gt;phys_port_cnt
suffix:semicolon
id|cur_port
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ports
suffix:semicolon
id|i
op_increment
comma
id|cur_port
op_increment
)paren
(brace
id|ret2
op_assign
id|ib_agent_port_close
c_func
(paren
id|device
comma
id|cur_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t close %s port %d &quot;
l_string|&quot;for agents&bslash;n&quot;
comma
id|device-&gt;name
comma
id|cur_port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|ret2
suffix:semicolon
)brace
id|ret2
op_assign
id|ib_mad_port_close
c_func
(paren
id|device
comma
id|cur_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t close %s port %d&bslash;n&quot;
comma
id|device-&gt;name
comma
id|cur_port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|ret2
suffix:semicolon
)brace
)brace
)brace
DECL|variable|mad_client
r_static
r_struct
id|ib_client
id|mad_client
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;mad&quot;
comma
dot
id|add
op_assign
id|ib_mad_init_device
comma
dot
id|remove
op_assign
id|ib_mad_remove_device
)brace
suffix:semicolon
DECL|function|ib_mad_init_module
r_static
r_int
id|__init
id|ib_mad_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ib_mad_port_list_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ib_agent_port_list_lock
)paren
suffix:semicolon
id|ib_mad_cache
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;ib_mad&quot;
comma
r_sizeof
(paren
r_struct
id|ib_mad_private
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ib_mad_cache
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t create ib_mad cache&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error1
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ib_mad_port_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ib_register_client
c_func
(paren
op_amp
id|mad_client
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t register ib_mad client&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error2
suffix:colon
id|kmem_cache_destroy
c_func
(paren
id|ib_mad_cache
)paren
suffix:semicolon
id|error1
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ib_mad_cleanup_module
r_static
r_void
id|__exit
id|ib_mad_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|ib_unregister_client
c_func
(paren
op_amp
id|mad_client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|ib_mad_cache
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;Failed to destroy ib_mad cache&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|ib_mad_init_module
id|module_init
c_func
(paren
id|ib_mad_init_module
)paren
suffix:semicolon
DECL|variable|ib_mad_cleanup_module
id|module_exit
c_func
(paren
id|ib_mad_cleanup_module
)paren
suffix:semicolon
eof
