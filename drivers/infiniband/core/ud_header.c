multiline_comment|/*&n; * Copyright (c) 2004 Topspin Corporation.  All rights reserved.&n; *&n; * This software is available to you under a choice of one of two&n; * licenses.  You may choose to be licensed under the terms of the GNU&n; * General Public License (GPL) Version 2, available from the file&n; * COPYING in the main directory of this source tree, or the&n; * OpenIB.org BSD license below:&n; *&n; *     Redistribution and use in source and binary forms, with or&n; *     without modification, are permitted provided that the following&n; *     conditions are met:&n; *&n; *      - Redistributions of source code must retain the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer.&n; *&n; *      - Redistributions in binary form must reproduce the above&n; *        copyright notice, this list of conditions and the following&n; *        disclaimer in the documentation and/or other materials&n; *        provided with the distribution.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS&n; * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN&n; * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN&n; * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE&n; * SOFTWARE.&n; *&n; * $Id: ud_header.c 1349 2004-12-16 21:09:43Z roland $&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;ib_pack.h&gt;
DECL|macro|STRUCT_FIELD
mdefine_line|#define STRUCT_FIELD(header, field) &bslash;&n;&t;.struct_offset_bytes = offsetof(struct ib_unpacked_ ## header, field),      &bslash;&n;&t;.struct_size_bytes   = sizeof ((struct ib_unpacked_ ## header *) 0)-&gt;field, &bslash;&n;&t;.field_name          = #header &quot;:&quot; #field
DECL|variable|lrh_table
r_static
r_const
r_struct
id|ib_field
id|lrh_table
(braket
)braket
op_assign
(brace
(brace
id|STRUCT_FIELD
c_func
(paren
id|lrh
comma
id|virtual_lane
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|4
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|lrh
comma
id|link_version
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|4
comma
dot
id|size_bits
op_assign
l_int|4
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|lrh
comma
id|service_level
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|8
comma
dot
id|size_bits
op_assign
l_int|4
)brace
comma
(brace
id|RESERVED
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|12
comma
dot
id|size_bits
op_assign
l_int|2
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|lrh
comma
id|link_next_header
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|14
comma
dot
id|size_bits
op_assign
l_int|2
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|lrh
comma
id|destination_lid
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|16
comma
dot
id|size_bits
op_assign
l_int|16
)brace
comma
(brace
id|RESERVED
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|5
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|lrh
comma
id|packet_length
)paren
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|5
comma
dot
id|size_bits
op_assign
l_int|11
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|lrh
comma
id|source_lid
)paren
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|16
comma
dot
id|size_bits
op_assign
l_int|16
)brace
)brace
suffix:semicolon
DECL|variable|grh_table
r_static
r_const
r_struct
id|ib_field
id|grh_table
(braket
)braket
op_assign
(brace
(brace
id|STRUCT_FIELD
c_func
(paren
id|grh
comma
id|ip_version
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|4
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|grh
comma
id|traffic_class
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|4
comma
dot
id|size_bits
op_assign
l_int|8
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|grh
comma
id|flow_label
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|12
comma
dot
id|size_bits
op_assign
l_int|20
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|grh
comma
id|payload_length
)paren
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|16
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|grh
comma
id|next_header
)paren
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|16
comma
dot
id|size_bits
op_assign
l_int|8
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|grh
comma
id|hop_limit
)paren
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|24
comma
dot
id|size_bits
op_assign
l_int|8
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|grh
comma
id|source_gid
)paren
comma
dot
id|offset_words
op_assign
l_int|2
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|128
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|grh
comma
id|destination_gid
)paren
comma
dot
id|offset_words
op_assign
l_int|6
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|128
)brace
)brace
suffix:semicolon
DECL|variable|bth_table
r_static
r_const
r_struct
id|ib_field
id|bth_table
(braket
)braket
op_assign
(brace
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|opcode
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|8
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|solicited_event
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|8
comma
dot
id|size_bits
op_assign
l_int|1
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|mig_req
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|9
comma
dot
id|size_bits
op_assign
l_int|1
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|pad_count
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|10
comma
dot
id|size_bits
op_assign
l_int|2
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|transport_header_version
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|12
comma
dot
id|size_bits
op_assign
l_int|4
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|pkey
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|16
comma
dot
id|size_bits
op_assign
l_int|16
)brace
comma
(brace
id|RESERVED
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|8
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|destination_qpn
)paren
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|8
comma
dot
id|size_bits
op_assign
l_int|24
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|ack_req
)paren
comma
dot
id|offset_words
op_assign
l_int|2
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|1
)brace
comma
(brace
id|RESERVED
comma
dot
id|offset_words
op_assign
l_int|2
comma
dot
id|offset_bits
op_assign
l_int|1
comma
dot
id|size_bits
op_assign
l_int|7
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|bth
comma
id|psn
)paren
comma
dot
id|offset_words
op_assign
l_int|2
comma
dot
id|offset_bits
op_assign
l_int|8
comma
dot
id|size_bits
op_assign
l_int|24
)brace
)brace
suffix:semicolon
DECL|variable|deth_table
r_static
r_const
r_struct
id|ib_field
id|deth_table
(braket
)braket
op_assign
(brace
(brace
id|STRUCT_FIELD
c_func
(paren
id|deth
comma
id|qkey
)paren
comma
dot
id|offset_words
op_assign
l_int|0
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|32
)brace
comma
(brace
id|RESERVED
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|0
comma
dot
id|size_bits
op_assign
l_int|8
)brace
comma
(brace
id|STRUCT_FIELD
c_func
(paren
id|deth
comma
id|source_qpn
)paren
comma
dot
id|offset_words
op_assign
l_int|1
comma
dot
id|offset_bits
op_assign
l_int|8
comma
dot
id|size_bits
op_assign
l_int|24
)brace
)brace
suffix:semicolon
multiline_comment|/**&n; * ib_ud_header_init - Initialize UD header structure&n; * @payload_bytes:Length of packet payload&n; * @grh_present:GRH flag (if non-zero, GRH will be included)&n; * @header:Structure to initialize&n; *&n; * ib_ud_header_init() initializes the lrh.link_version, lrh.link_next_header,&n; * lrh.packet_length, grh.ip_version, grh.payload_length,&n; * grh.next_header, bth.opcode, bth.pad_count and&n; * bth.transport_header_version fields of a &amp;struct ib_ud_header given&n; * the payload length and whether a GRH will be included.&n; */
DECL|function|ib_ud_header_init
r_void
id|ib_ud_header_init
c_func
(paren
r_int
id|payload_bytes
comma
r_int
id|grh_present
comma
r_struct
id|ib_ud_header
op_star
id|header
)paren
(brace
r_int
id|header_len
suffix:semicolon
id|memset
c_func
(paren
id|header
comma
l_int|0
comma
r_sizeof
op_star
id|header
)paren
suffix:semicolon
id|header_len
op_assign
id|IB_LRH_BYTES
op_plus
id|IB_BTH_BYTES
op_plus
id|IB_DETH_BYTES
suffix:semicolon
r_if
c_cond
(paren
id|grh_present
)paren
(brace
id|header_len
op_add_assign
id|IB_GRH_BYTES
suffix:semicolon
)brace
id|header-&gt;lrh.link_version
op_assign
l_int|0
suffix:semicolon
id|header-&gt;lrh.link_next_header
op_assign
id|grh_present
ques
c_cond
id|IB_LNH_IBA_GLOBAL
suffix:colon
id|IB_LNH_IBA_LOCAL
suffix:semicolon
id|header-&gt;lrh.packet_length
op_assign
(paren
id|IB_LRH_BYTES
op_plus
id|IB_BTH_BYTES
op_plus
id|IB_DETH_BYTES
op_plus
id|payload_bytes
op_plus
l_int|4
op_plus
multiline_comment|/* ICRC     */
l_int|3
)paren
op_div
l_int|4
suffix:semicolon
multiline_comment|/* round up */
id|header-&gt;grh_present
op_assign
id|grh_present
suffix:semicolon
r_if
c_cond
(paren
id|grh_present
)paren
(brace
id|header-&gt;lrh.packet_length
op_add_assign
id|IB_GRH_BYTES
op_div
l_int|4
suffix:semicolon
id|header-&gt;grh.ip_version
op_assign
l_int|6
suffix:semicolon
id|header-&gt;grh.payload_length
op_assign
id|cpu_to_be16
c_func
(paren
(paren
id|IB_BTH_BYTES
op_plus
id|IB_DETH_BYTES
op_plus
id|payload_bytes
op_plus
l_int|4
op_plus
multiline_comment|/* ICRC     */
l_int|3
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
multiline_comment|/* round up */
id|header-&gt;grh.next_header
op_assign
l_int|0x1b
suffix:semicolon
)brace
id|cpu_to_be16s
c_func
(paren
op_amp
id|header-&gt;lrh.packet_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;immediate_present
)paren
id|header-&gt;bth.opcode
op_assign
id|IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE
suffix:semicolon
r_else
id|header-&gt;bth.opcode
op_assign
id|IB_OPCODE_UD_SEND_ONLY
suffix:semicolon
id|header-&gt;bth.pad_count
op_assign
(paren
l_int|4
op_minus
id|payload_bytes
)paren
op_amp
l_int|3
suffix:semicolon
id|header-&gt;bth.transport_header_version
op_assign
l_int|0
suffix:semicolon
)brace
DECL|variable|ib_ud_header_init
id|EXPORT_SYMBOL
c_func
(paren
id|ib_ud_header_init
)paren
suffix:semicolon
multiline_comment|/**&n; * ib_ud_header_pack - Pack UD header struct into wire format&n; * @header:UD header struct&n; * @buf:Buffer to pack into&n; *&n; * ib_ud_header_pack() packs the UD header structure @header into wire&n; * format in the buffer @buf.&n; */
DECL|function|ib_ud_header_pack
r_int
id|ib_ud_header_pack
c_func
(paren
r_struct
id|ib_ud_header
op_star
id|header
comma
r_void
op_star
id|buf
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|ib_pack
c_func
(paren
id|lrh_table
comma
id|ARRAY_SIZE
c_func
(paren
id|lrh_table
)paren
comma
op_amp
id|header-&gt;lrh
comma
id|buf
)paren
suffix:semicolon
id|len
op_add_assign
id|IB_LRH_BYTES
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;grh_present
)paren
(brace
id|ib_pack
c_func
(paren
id|grh_table
comma
id|ARRAY_SIZE
c_func
(paren
id|grh_table
)paren
comma
op_amp
id|header-&gt;grh
comma
id|buf
op_plus
id|len
)paren
suffix:semicolon
id|len
op_add_assign
id|IB_GRH_BYTES
suffix:semicolon
)brace
id|ib_pack
c_func
(paren
id|bth_table
comma
id|ARRAY_SIZE
c_func
(paren
id|bth_table
)paren
comma
op_amp
id|header-&gt;bth
comma
id|buf
op_plus
id|len
)paren
suffix:semicolon
id|len
op_add_assign
id|IB_BTH_BYTES
suffix:semicolon
id|ib_pack
c_func
(paren
id|deth_table
comma
id|ARRAY_SIZE
c_func
(paren
id|deth_table
)paren
comma
op_amp
id|header-&gt;deth
comma
id|buf
op_plus
id|len
)paren
suffix:semicolon
id|len
op_add_assign
id|IB_DETH_BYTES
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;immediate_present
)paren
(brace
id|memcpy
c_func
(paren
id|buf
op_plus
id|len
comma
op_amp
id|header-&gt;immediate_data
comma
r_sizeof
id|header-&gt;immediate_data
)paren
suffix:semicolon
id|len
op_add_assign
r_sizeof
id|header-&gt;immediate_data
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ib_ud_header_pack
id|EXPORT_SYMBOL
c_func
(paren
id|ib_ud_header_pack
)paren
suffix:semicolon
multiline_comment|/**&n; * ib_ud_header_unpack - Unpack UD header struct from wire format&n; * @header:UD header struct&n; * @buf:Buffer to pack into&n; *&n; * ib_ud_header_pack() unpacks the UD header structure @header from wire&n; * format in the buffer @buf.&n; */
DECL|function|ib_ud_header_unpack
r_int
id|ib_ud_header_unpack
c_func
(paren
r_void
op_star
id|buf
comma
r_struct
id|ib_ud_header
op_star
id|header
)paren
(brace
id|ib_unpack
c_func
(paren
id|lrh_table
comma
id|ARRAY_SIZE
c_func
(paren
id|lrh_table
)paren
comma
id|buf
comma
op_amp
id|header-&gt;lrh
)paren
suffix:semicolon
id|buf
op_add_assign
id|IB_LRH_BYTES
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;lrh.link_version
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Invalid LRH.link_version %d&bslash;n&quot;
comma
id|header-&gt;lrh.link_version
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|header-&gt;lrh.link_next_header
)paren
(brace
r_case
id|IB_LNH_IBA_LOCAL
suffix:colon
id|header-&gt;grh_present
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IB_LNH_IBA_GLOBAL
suffix:colon
id|header-&gt;grh_present
op_assign
l_int|1
suffix:semicolon
id|ib_unpack
c_func
(paren
id|grh_table
comma
id|ARRAY_SIZE
c_func
(paren
id|grh_table
)paren
comma
id|buf
comma
op_amp
id|header-&gt;grh
)paren
suffix:semicolon
id|buf
op_add_assign
id|IB_GRH_BYTES
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;grh.ip_version
op_ne
l_int|6
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Invalid GRH.ip_version %d&bslash;n&quot;
comma
id|header-&gt;grh.ip_version
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|header-&gt;grh.next_header
op_ne
l_int|0x1b
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Invalid GRH.next_header 0x%02x&bslash;n&quot;
comma
id|header-&gt;grh.next_header
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Invalid LRH.link_next_header %d&bslash;n&quot;
comma
id|header-&gt;lrh.link_next_header
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ib_unpack
c_func
(paren
id|bth_table
comma
id|ARRAY_SIZE
c_func
(paren
id|bth_table
)paren
comma
id|buf
comma
op_amp
id|header-&gt;bth
)paren
suffix:semicolon
id|buf
op_add_assign
id|IB_BTH_BYTES
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;bth.opcode
)paren
(brace
r_case
id|IB_OPCODE_UD_SEND_ONLY
suffix:colon
id|header-&gt;immediate_present
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE
suffix:colon
id|header-&gt;immediate_present
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Invalid BTH.opcode 0x%02x&bslash;n&quot;
comma
id|header-&gt;bth.opcode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|header-&gt;bth.transport_header_version
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Invalid BTH.transport_header_version %d&bslash;n&quot;
comma
id|header-&gt;bth.transport_header_version
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ib_unpack
c_func
(paren
id|deth_table
comma
id|ARRAY_SIZE
c_func
(paren
id|deth_table
)paren
comma
id|buf
comma
op_amp
id|header-&gt;deth
)paren
suffix:semicolon
id|buf
op_add_assign
id|IB_DETH_BYTES
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;immediate_present
)paren
id|memcpy
c_func
(paren
op_amp
id|header-&gt;immediate_data
comma
id|buf
comma
r_sizeof
id|header-&gt;immediate_data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ib_ud_header_unpack
id|EXPORT_SYMBOL
c_func
(paren
id|ib_ud_header_unpack
)paren
suffix:semicolon
eof
