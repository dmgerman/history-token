multiline_comment|/*&n; * Fake PCI Hot Plug Controller Driver&n; *&n; * Copyright (C) 2003 Greg Kroah-Hartman &lt;greg@kroah.com&gt;&n; * Copyright (C) 2003 IBM Corp.&n; * Copyright (C) 2003 Rolf Eike Beer &lt;eike-kernel@sf-tec.de&gt;&n; *&n; * Based on ideas and code from:&n; * &t;Vladimir Kondratiev &lt;vladimir.kondratiev@intel.com&gt;&n; *&t;Rolf Eike Beer &lt;eike-kernel@sf-tec.de&gt;&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation, version 2 of the License.&n; *&n; * Send feedback to &lt;greg@kroah.com&gt;&n; */
multiline_comment|/*&n; *&n; * This driver will &quot;emulate&quot; removing PCI devices from the system.  If&n; * the &quot;power&quot; file is written to with &quot;0&quot; then the specified PCI device&n; * will be completely removed from the kernel.&n; *&n; * WARNING, this does NOT turn off the power to the PCI device.  This is&n; * a &quot;logical&quot; removal, not a physical or electrical removal.&n; *&n; * Use this module at your own risk, you have been warned!&n; *&n; * Enabling PCI devices is left as an exercise for the reader...&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;pci_hotplug.h&quot;
macro_line|#include &quot;../pci.h&quot;
macro_line|#if !defined(CONFIG_HOTPLUG_PCI_FAKE_MODULE)
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME&t;&quot;fakephp&quot;
macro_line|#else
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME&t;THIS_MODULE-&gt;name
macro_line|#endif
DECL|macro|dbg
mdefine_line|#define dbg(format, arg...)&t;&t;&t;&t;&t;&bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;if (debug)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;printk(KERN_DEBUG &quot;%s: &quot; format,&t;&bslash;&n;&t;&t;&t;&t;MY_NAME , ## arg); &t;&t;&bslash;&n;&t;} while (0)
DECL|macro|err
mdefine_line|#define err(format, arg...) printk(KERN_ERR &quot;%s: &quot; format, MY_NAME , ## arg)
DECL|macro|info
mdefine_line|#define info(format, arg...) printk(KERN_INFO &quot;%s: &quot; format, MY_NAME , ## arg)
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Greg Kroah-Hartman &lt;greg@kroah.com&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;Fake PCI Hot Plug Controller Driver&quot;
DECL|struct|dummy_slot
r_struct
id|dummy_slot
(brace
DECL|member|node
r_struct
id|list_head
id|node
suffix:semicolon
DECL|member|slot
r_struct
id|hotplug_slot
op_star
id|slot
suffix:semicolon
DECL|member|dev
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|slot_list
)paren
suffix:semicolon
r_static
r_int
id|enable_slot
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
suffix:semicolon
r_static
r_int
id|disable_slot
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
suffix:semicolon
DECL|variable|dummy_hotplug_slot_ops
r_static
r_struct
id|hotplug_slot_ops
id|dummy_hotplug_slot_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|enable_slot
op_assign
id|enable_slot
comma
dot
id|disable_slot
op_assign
id|disable_slot
comma
)brace
suffix:semicolon
DECL|function|dummy_release
r_static
r_void
id|dummy_release
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
(brace
r_struct
id|dummy_slot
op_star
id|dslot
op_assign
id|slot
op_member_access_from_pointer
r_private
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|dslot-&gt;node
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dslot-&gt;slot-&gt;info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dslot-&gt;slot
)paren
suffix:semicolon
id|pci_dev_put
c_func
(paren
id|dslot-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dslot
)paren
suffix:semicolon
)brace
DECL|function|add_slot
r_static
r_int
id|add_slot
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|dummy_slot
op_star
id|dslot
suffix:semicolon
r_struct
id|hotplug_slot
op_star
id|slot
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|slot
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
r_goto
id|error
suffix:semicolon
id|memset
c_func
(paren
id|slot
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|slot
)paren
)paren
suffix:semicolon
id|slot-&gt;info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;info
)paren
r_goto
id|error_slot
suffix:semicolon
id|memset
c_func
(paren
id|slot-&gt;info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
)paren
suffix:semicolon
id|slot-&gt;info-&gt;power_status
op_assign
l_int|1
suffix:semicolon
id|slot-&gt;info-&gt;max_bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
id|slot-&gt;info-&gt;cur_bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
id|slot-&gt;name
op_assign
op_amp
id|dev-&gt;dev.bus_id
(braket
l_int|0
)braket
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;slot-&gt;name = %s&bslash;n&quot;
comma
id|slot-&gt;name
)paren
suffix:semicolon
id|dslot
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dummy_slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dslot
)paren
r_goto
id|error_info
suffix:semicolon
id|slot-&gt;ops
op_assign
op_amp
id|dummy_hotplug_slot_ops
suffix:semicolon
id|slot-&gt;release
op_assign
op_amp
id|dummy_release
suffix:semicolon
id|slot
op_member_access_from_pointer
r_private
op_assign
id|dslot
suffix:semicolon
id|retval
op_assign
id|pci_hp_register
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;pci_hp_register failed with error %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_goto
id|error_dslot
suffix:semicolon
)brace
id|dslot-&gt;slot
op_assign
id|slot
suffix:semicolon
id|dslot-&gt;dev
op_assign
id|pci_dev_get
c_func
(paren
id|dev
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|dslot-&gt;node
comma
op_amp
id|slot_list
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
id|error_dslot
suffix:colon
id|kfree
c_func
(paren
id|dslot
)paren
suffix:semicolon
id|error_info
suffix:colon
id|kfree
c_func
(paren
id|slot-&gt;info
)paren
suffix:semicolon
id|error_slot
suffix:colon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
id|error
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|pci_scan_buses
r_static
r_int
id|__init
id|pci_scan_buses
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_get_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|retval
op_assign
id|add_slot
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|pci_dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|remove_slot
r_static
r_void
id|remove_slot
c_func
(paren
r_struct
id|dummy_slot
op_star
id|dslot
)paren
(brace
r_int
id|retval
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;removing slot %s&bslash;n&quot;
comma
id|dslot-&gt;slot-&gt;name
)paren
suffix:semicolon
id|retval
op_assign
id|pci_hp_deregister
c_func
(paren
id|dslot-&gt;slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|err
c_func
(paren
l_string|&quot;Problem unregistering a slot %s&bslash;n&quot;
comma
id|dslot-&gt;slot-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Rescan slot.&n; * Tries hard not to re-enable already existing devices&n; * also handles scanning of subfunctions&n; *&n; * @param temp   Device template. Should be set: bus and devfn.&n; */
DECL|function|pci_rescan_slot
r_static
r_void
id|pci_rescan_slot
c_func
(paren
r_struct
id|pci_dev
op_star
id|temp
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
op_assign
id|temp-&gt;bus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_int
id|func
suffix:semicolon
id|u8
id|hdr_type
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_read_config_byte
c_func
(paren
id|temp
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|hdr_type
)paren
)paren
(brace
id|temp-&gt;hdr_type
op_assign
id|hdr_type
op_amp
l_int|0x7f
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_find_slot
c_func
(paren
id|bus-&gt;number
comma
id|temp-&gt;devfn
)paren
)paren
(brace
id|dev
op_assign
id|pci_scan_single_device
c_func
(paren
id|bus
comma
id|temp-&gt;devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;New device on %s function %x:%x&bslash;n&quot;
comma
id|bus-&gt;name
comma
id|temp-&gt;devfn
op_rshift
l_int|3
comma
id|temp-&gt;devfn
op_amp
l_int|7
)paren
suffix:semicolon
id|pci_bus_add_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|add_slot
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* multifunction device? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|hdr_type
op_amp
l_int|0x80
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* continue scanning for other functions */
r_for
c_loop
(paren
id|func
op_assign
l_int|1
comma
id|temp-&gt;devfn
op_increment
suffix:semicolon
id|func
OL
l_int|8
suffix:semicolon
id|func
op_increment
comma
id|temp-&gt;devfn
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|temp
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|hdr_type
)paren
)paren
r_continue
suffix:semicolon
id|temp-&gt;hdr_type
op_assign
id|hdr_type
op_amp
l_int|0x7f
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_find_slot
c_func
(paren
id|bus-&gt;number
comma
id|temp-&gt;devfn
)paren
)paren
(brace
id|dev
op_assign
id|pci_scan_single_device
c_func
(paren
id|bus
comma
id|temp-&gt;devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;New device on %s function %x:%x&bslash;n&quot;
comma
id|bus-&gt;name
comma
id|temp-&gt;devfn
op_rshift
l_int|3
comma
id|temp-&gt;devfn
op_amp
l_int|7
)paren
suffix:semicolon
id|pci_bus_add_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|add_slot
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
multiline_comment|/**&n; * Rescan PCI bus.&n; * call pci_rescan_slot for each possible function of the bus&n; *&n; * @param bus&n; */
DECL|function|pci_rescan_bus
r_static
r_void
id|pci_rescan_bus
c_func
(paren
r_const
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_int
r_int
id|devfn
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;bus
op_assign
(paren
r_struct
id|pci_bus
op_star
)paren
id|bus
suffix:semicolon
id|dev-&gt;sysdata
op_assign
id|bus-&gt;sysdata
suffix:semicolon
r_for
c_loop
(paren
id|devfn
op_assign
l_int|0
suffix:semicolon
id|devfn
OL
l_int|0x100
suffix:semicolon
id|devfn
op_add_assign
l_int|8
)paren
(brace
id|dev-&gt;devfn
op_assign
id|devfn
suffix:semicolon
id|pci_rescan_slot
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* recursively scan all buses */
DECL|function|pci_rescan_buses
r_static
r_void
id|pci_rescan_buses
c_func
(paren
r_const
r_struct
id|list_head
op_star
id|list
)paren
(brace
r_const
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
id|list
)paren
(brace
r_const
r_struct
id|pci_bus
op_star
id|b
op_assign
id|pci_bus_b
c_func
(paren
id|l
)paren
suffix:semicolon
id|pci_rescan_bus
c_func
(paren
id|b
)paren
suffix:semicolon
id|pci_rescan_buses
c_func
(paren
op_amp
id|b-&gt;children
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* initiate rescan of all pci buses */
DECL|function|pci_rescan
r_static
r_inline
r_void
id|pci_rescan
c_func
(paren
r_void
)paren
(brace
id|pci_rescan_buses
c_func
(paren
op_amp
id|pci_root_buses
)paren
suffix:semicolon
)brace
DECL|function|enable_slot
r_static
r_int
id|enable_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
multiline_comment|/* mis-use enable_slot for rescanning of the pci bus */
id|pci_rescan
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* find the hotplug_slot for the pci_dev */
DECL|function|get_slot_from_dev
r_static
r_struct
id|hotplug_slot
op_star
id|get_slot_from_dev
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|dummy_slot
op_star
id|dslot
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dslot
comma
op_amp
id|slot_list
comma
id|node
)paren
(brace
r_if
c_cond
(paren
id|dslot-&gt;dev
op_eq
id|dev
)paren
r_return
id|dslot-&gt;slot
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|disable_slot
r_static
r_int
id|disable_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
(brace
r_struct
id|dummy_slot
op_star
id|dslot
suffix:semicolon
r_struct
id|hotplug_slot
op_star
id|hslot
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_int
id|func
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dslot
op_assign
id|slot
op_member_access_from_pointer
r_private
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;name
)paren
suffix:semicolon
multiline_comment|/* don&squot;t disable bridged devices just yet, we can&squot;t handle them easily... */
r_if
c_cond
(paren
id|dslot-&gt;dev-&gt;subordinate
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t remove PCI devices with other PCI devices behind it yet.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* search for subfunctions and disable them first */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dslot-&gt;dev-&gt;devfn
op_amp
l_int|7
)paren
)paren
(brace
r_for
c_loop
(paren
id|func
op_assign
l_int|1
suffix:semicolon
id|func
OL
l_int|8
suffix:semicolon
id|func
op_increment
)paren
(brace
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|dslot-&gt;dev-&gt;bus-&gt;number
comma
id|dslot-&gt;dev-&gt;devfn
op_plus
id|func
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|hslot
op_assign
id|get_slot_from_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hslot
)paren
id|disable_slot
c_func
(paren
id|hslot
)paren
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Hotplug slot not found for subfunction of PCI device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
id|dbg
c_func
(paren
l_string|&quot;No device in slot found&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* remove the device from the pci core */
id|pci_remove_bus_device
c_func
(paren
id|dslot-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* blow away this sysfs entry and other parts. */
id|remove_slot
c_func
(paren
id|dslot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_slots
r_static
r_void
id|cleanup_slots
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|next
suffix:semicolon
r_struct
id|dummy_slot
op_star
id|dslot
suffix:semicolon
id|list_for_each_safe
(paren
id|tmp
comma
id|next
comma
op_amp
id|slot_list
)paren
(brace
id|dslot
op_assign
id|list_entry
(paren
id|tmp
comma
r_struct
id|dummy_slot
comma
id|node
)paren
suffix:semicolon
id|remove_slot
c_func
(paren
id|dslot
)paren
suffix:semicolon
)brace
)brace
DECL|function|dummyphp_init
r_static
r_int
id|__init
id|dummyphp_init
c_func
(paren
r_void
)paren
(brace
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pci_scan_buses
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|dummyphp_exit
r_static
r_void
id|__exit
id|dummyphp_exit
c_func
(paren
r_void
)paren
(brace
id|cleanup_slots
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|dummyphp_init
id|module_init
c_func
(paren
id|dummyphp_init
)paren
suffix:semicolon
DECL|variable|dummyphp_exit
id|module_exit
c_func
(paren
id|dummyphp_exit
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_bool
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debugging mode enabled or not&quot;
)paren
suffix:semicolon
eof
