multiline_comment|/*&n; * PCI Express PCI Hot Plug Driver&n; *&n; * Copyright (C) 1995,2001 Compaq Computer Corporation&n; * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (C) 2001 IBM Corp.&n; * Copyright (C) 2003-2004 Intel Corporation&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;greg@kroah.com&gt;,&lt;dely.l.sy@intel.com&gt;&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;../pci.h&quot;
macro_line|#include &quot;pciehp.h&quot;
macro_line|#ifdef DEBUG
DECL|macro|DBG_K_TRACE_ENTRY
mdefine_line|#define DBG_K_TRACE_ENTRY      ((unsigned int)0x00000001)&t;/* On function entry */
DECL|macro|DBG_K_TRACE_EXIT
mdefine_line|#define DBG_K_TRACE_EXIT       ((unsigned int)0x00000002)&t;/* On function exit */
DECL|macro|DBG_K_INFO
mdefine_line|#define DBG_K_INFO             ((unsigned int)0x00000004)&t;/* Info messages */
DECL|macro|DBG_K_ERROR
mdefine_line|#define DBG_K_ERROR            ((unsigned int)0x00000008)&t;/* Error messages */
DECL|macro|DBG_K_TRACE
mdefine_line|#define DBG_K_TRACE            (DBG_K_TRACE_ENTRY|DBG_K_TRACE_EXIT)
DECL|macro|DBG_K_STANDARD
mdefine_line|#define DBG_K_STANDARD         (DBG_K_INFO|DBG_K_ERROR|DBG_K_TRACE)
multiline_comment|/* Redefine this flagword to set debug level */
DECL|macro|DEBUG_LEVEL
mdefine_line|#define DEBUG_LEVEL            DBG_K_STANDARD
DECL|macro|DEFINE_DBG_BUFFER
mdefine_line|#define DEFINE_DBG_BUFFER     char __dbg_str_buf[256];
DECL|macro|DBG_PRINT
mdefine_line|#define DBG_PRINT( dbg_flags, args... )              &bslash;&n;&t;do {                                             &bslash;&n;&t;  if ( DEBUG_LEVEL &amp; ( dbg_flags ) )             &bslash;&n;&t;  {                                              &bslash;&n;&t;    int len;                                     &bslash;&n;&t;    len = sprintf( __dbg_str_buf, &quot;%s:%d: %s: &quot;, &bslash;&n;&t;&t;  __FILE__, __LINE__, __FUNCTION__ );    &bslash;&n;&t;    sprintf( __dbg_str_buf + len, args );        &bslash;&n;&t;    printk( KERN_NOTICE &quot;%s&bslash;n&quot;, __dbg_str_buf ); &bslash;&n;&t;  }                                              &bslash;&n;&t;} while (0)
DECL|macro|DBG_ENTER_ROUTINE
mdefine_line|#define DBG_ENTER_ROUTINE&t;DBG_PRINT (DBG_K_TRACE_ENTRY, &quot;%s&quot;, &quot;[Entry]&quot;);
DECL|macro|DBG_LEAVE_ROUTINE
mdefine_line|#define DBG_LEAVE_ROUTINE&t;DBG_PRINT (DBG_K_TRACE_EXIT, &quot;%s&quot;, &quot;[Exit]&quot;);
macro_line|#else
DECL|macro|DEFINE_DBG_BUFFER
mdefine_line|#define DEFINE_DBG_BUFFER
DECL|macro|DBG_ENTER_ROUTINE
mdefine_line|#define DBG_ENTER_ROUTINE
DECL|macro|DBG_LEAVE_ROUTINE
mdefine_line|#define DBG_LEAVE_ROUTINE
macro_line|#endif&t;&t;&t;&t;/* DEBUG */
DECL|struct|ctrl_reg
r_struct
id|ctrl_reg
(brace
DECL|member|cap_id
id|u8
id|cap_id
suffix:semicolon
DECL|member|nxt_ptr
id|u8
id|nxt_ptr
suffix:semicolon
DECL|member|cap_reg
id|u16
id|cap_reg
suffix:semicolon
DECL|member|dev_cap
id|u32
id|dev_cap
suffix:semicolon
DECL|member|dev_ctrl
id|u16
id|dev_ctrl
suffix:semicolon
DECL|member|dev_status
id|u16
id|dev_status
suffix:semicolon
DECL|member|lnk_cap
id|u32
id|lnk_cap
suffix:semicolon
DECL|member|lnk_ctrl
id|u16
id|lnk_ctrl
suffix:semicolon
DECL|member|lnk_status
id|u16
id|lnk_status
suffix:semicolon
DECL|member|slot_cap
id|u32
id|slot_cap
suffix:semicolon
DECL|member|slot_ctrl
id|u16
id|slot_ctrl
suffix:semicolon
DECL|member|slot_status
id|u16
id|slot_status
suffix:semicolon
DECL|member|root_ctrl
id|u16
id|root_ctrl
suffix:semicolon
DECL|member|rsvp
id|u16
id|rsvp
suffix:semicolon
DECL|member|root_status
id|u32
id|root_status
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
multiline_comment|/* offsets to the controller registers based on the above structure layout */
DECL|enum|ctrl_offsets
r_enum
id|ctrl_offsets
(brace
DECL|enumerator|PCIECAPID
id|PCIECAPID
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|cap_id
)paren
comma
DECL|enumerator|NXTCAPPTR
id|NXTCAPPTR
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|nxt_ptr
)paren
comma
DECL|enumerator|CAPREG
id|CAPREG
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|cap_reg
)paren
comma
DECL|enumerator|DEVCAP
id|DEVCAP
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|dev_cap
)paren
comma
DECL|enumerator|DEVCTRL
id|DEVCTRL
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|dev_ctrl
)paren
comma
DECL|enumerator|DEVSTATUS
id|DEVSTATUS
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|dev_status
)paren
comma
DECL|enumerator|LNKCAP
id|LNKCAP
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|lnk_cap
)paren
comma
DECL|enumerator|LNKCTRL
id|LNKCTRL
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|lnk_ctrl
)paren
comma
DECL|enumerator|LNKSTATUS
id|LNKSTATUS
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|lnk_status
)paren
comma
DECL|enumerator|SLOTCAP
id|SLOTCAP
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|slot_cap
)paren
comma
DECL|enumerator|SLOTCTRL
id|SLOTCTRL
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|slot_ctrl
)paren
comma
DECL|enumerator|SLOTSTATUS
id|SLOTSTATUS
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|slot_status
)paren
comma
DECL|enumerator|ROOTCTRL
id|ROOTCTRL
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|root_ctrl
)paren
comma
DECL|enumerator|ROOTSTATUS
id|ROOTSTATUS
op_assign
m_offsetof
(paren
r_struct
id|ctrl_reg
comma
id|root_status
)paren
comma
)brace
suffix:semicolon
DECL|variable|pcie_cap_base
r_static
r_int
id|pcie_cap_base
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Base of the PCI Express capability item structure */
DECL|macro|PCIE_CAP_ID
mdefine_line|#define PCIE_CAP_ID&t;( pcie_cap_base + PCIECAPID )
DECL|macro|NXT_CAP_PTR
mdefine_line|#define NXT_CAP_PTR&t;( pcie_cap_base + NXTCAPPTR )
DECL|macro|CAP_REG
mdefine_line|#define CAP_REG&t;&t;( pcie_cap_base + CAPREG )
DECL|macro|DEV_CAP
mdefine_line|#define DEV_CAP&t;&t;( pcie_cap_base + DEVCAP )
DECL|macro|DEV_CTRL
mdefine_line|#define DEV_CTRL&t;( pcie_cap_base + DEVCTRL )
DECL|macro|DEV_STATUS
mdefine_line|#define DEV_STATUS&t;( pcie_cap_base + DEVSTATUS )
DECL|macro|LNK_CAP
mdefine_line|#define LNK_CAP&t;&t;( pcie_cap_base + LNKCAP )
DECL|macro|LNK_CTRL
mdefine_line|#define LNK_CTRL&t;( pcie_cap_base + LNKCTRL )
DECL|macro|LNK_STATUS
mdefine_line|#define LNK_STATUS&t;( pcie_cap_base + LNKSTATUS )
DECL|macro|SLOT_CAP
mdefine_line|#define SLOT_CAP&t;( pcie_cap_base + SLOTCAP )
DECL|macro|SLOT_CTRL
mdefine_line|#define SLOT_CTRL&t;( pcie_cap_base + SLOTCTRL )
DECL|macro|SLOT_STATUS
mdefine_line|#define SLOT_STATUS&t;( pcie_cap_base + SLOTSTATUS )
DECL|macro|ROOT_CTRL
mdefine_line|#define ROOT_CTRL&t;( pcie_cap_base + ROOTCTRL )
DECL|macro|ROOT_STATUS
mdefine_line|#define ROOT_STATUS&t;( pcie_cap_base + ROOTSTATUS )
DECL|macro|hp_register_read_word
mdefine_line|#define hp_register_read_word(pdev, reg , value)&t;&t;&bslash;&n;&t;pci_read_config_word(pdev, reg, &amp;value)
DECL|macro|hp_register_read_dword
mdefine_line|#define hp_register_read_dword(pdev, reg , value)&t;&t;&bslash;&n;&t;pci_read_config_dword(pdev, reg, &amp;value)
DECL|macro|hp_register_write_word
mdefine_line|#define hp_register_write_word(pdev, reg , value)&t;&t;&bslash;&n;&t;pci_write_config_word(pdev, reg, value)
DECL|macro|hp_register_dwrite_word
mdefine_line|#define hp_register_dwrite_word(pdev, reg , value)&t;&t;&bslash;&n;&t;pci_write_config_dword(pdev, reg, value)
multiline_comment|/* Field definitions in PCI Express Capabilities Register */
DECL|macro|CAP_VER
mdefine_line|#define CAP_VER&t;&t;&t;0x000F
DECL|macro|DEV_PORT_TYPE
mdefine_line|#define DEV_PORT_TYPE&t;&t;0x00F0
DECL|macro|SLOT_IMPL
mdefine_line|#define SLOT_IMPL&t;&t;0x0100
DECL|macro|MSG_NUM
mdefine_line|#define MSG_NUM&t;&t;&t;0x3E00
multiline_comment|/* Device or Port Type */
DECL|macro|NAT_ENDPT
mdefine_line|#define NAT_ENDPT&t;&t;0x00
DECL|macro|LEG_ENDPT
mdefine_line|#define LEG_ENDPT&t;&t;0x01
DECL|macro|ROOT_PORT
mdefine_line|#define ROOT_PORT&t;&t;0x04
DECL|macro|UP_STREAM
mdefine_line|#define UP_STREAM&t;&t;0x05
DECL|macro|DN_STREAM
mdefine_line|#define&t;DN_STREAM&t;&t;0x06
DECL|macro|PCIE_PCI_BRDG
mdefine_line|#define PCIE_PCI_BRDG&t;&t;0x07
DECL|macro|PCI_PCIE_BRDG
mdefine_line|#define PCI_PCIE_BRDG&t;&t;0x10
multiline_comment|/* Field definitions in Device Capabilities Register */
DECL|macro|DATTN_BUTTN_PRSN
mdefine_line|#define DATTN_BUTTN_PRSN&t;0x1000
DECL|macro|DATTN_LED_PRSN
mdefine_line|#define DATTN_LED_PRSN&t;&t;0x2000
DECL|macro|DPWR_LED_PRSN
mdefine_line|#define DPWR_LED_PRSN&t;&t;0x4000
multiline_comment|/* Field definitions in Link Capabilities Register */
DECL|macro|MAX_LNK_SPEED
mdefine_line|#define MAX_LNK_SPEED&t;&t;0x000F
DECL|macro|MAX_LNK_WIDTH
mdefine_line|#define MAX_LNK_WIDTH&t;&t;0x03F0
multiline_comment|/* Link Width Encoding */
DECL|macro|LNK_X1
mdefine_line|#define LNK_X1&t;&t;0x01
DECL|macro|LNK_X2
mdefine_line|#define LNK_X2&t;&t;0x02
DECL|macro|LNK_X4
mdefine_line|#define LNK_X4&t;&t;0x04&t;
DECL|macro|LNK_X8
mdefine_line|#define LNK_X8&t;&t;0x08
DECL|macro|LNK_X12
mdefine_line|#define LNK_X12&t;&t;0x0C
DECL|macro|LNK_X16
mdefine_line|#define LNK_X16&t;&t;0x10&t;
DECL|macro|LNK_X32
mdefine_line|#define LNK_X32&t;&t;0x20
multiline_comment|/*Field definitions of Link Status Register */
DECL|macro|LNK_SPEED
mdefine_line|#define LNK_SPEED&t;0x000F
DECL|macro|NEG_LINK_WD
mdefine_line|#define NEG_LINK_WD&t;0x03F0
DECL|macro|LNK_TRN_ERR
mdefine_line|#define LNK_TRN_ERR&t;0x0400
DECL|macro|LNK_TRN
mdefine_line|#define&t;LNK_TRN&t;&t;0x0800
DECL|macro|SLOT_CLK_CONF
mdefine_line|#define SLOT_CLK_CONF&t;0x1000
multiline_comment|/* Field definitions in Slot Capabilities Register */
DECL|macro|ATTN_BUTTN_PRSN
mdefine_line|#define ATTN_BUTTN_PRSN&t;0x00000001
DECL|macro|PWR_CTRL_PRSN
mdefine_line|#define&t;PWR_CTRL_PRSN&t;0x00000002
DECL|macro|MRL_SENS_PRSN
mdefine_line|#define MRL_SENS_PRSN&t;0x00000004
DECL|macro|ATTN_LED_PRSN
mdefine_line|#define ATTN_LED_PRSN&t;0x00000008
DECL|macro|PWR_LED_PRSN
mdefine_line|#define PWR_LED_PRSN&t;0x00000010
DECL|macro|HP_SUPR_RM_SUP
mdefine_line|#define HP_SUPR_RM_SUP&t;0x00000020
DECL|macro|HP_CAP
mdefine_line|#define HP_CAP&t;&t;0x00000040
DECL|macro|SLOT_PWR_VALUE
mdefine_line|#define SLOT_PWR_VALUE&t;0x000003F8
DECL|macro|SLOT_PWR_LIMIT
mdefine_line|#define SLOT_PWR_LIMIT&t;0x00000C00
DECL|macro|PSN
mdefine_line|#define PSN&t;&t;0xFFF80000&t;/* PSN: Physical Slot Number */
multiline_comment|/* Field definitions in Slot Control Register */
DECL|macro|ATTN_BUTTN_ENABLE
mdefine_line|#define ATTN_BUTTN_ENABLE&t;&t;0x0001
DECL|macro|PWR_FAULT_DETECT_ENABLE
mdefine_line|#define PWR_FAULT_DETECT_ENABLE&t;&t;0x0002
DECL|macro|MRL_DETECT_ENABLE
mdefine_line|#define MRL_DETECT_ENABLE&t;&t;0x0004
DECL|macro|PRSN_DETECT_ENABLE
mdefine_line|#define PRSN_DETECT_ENABLE&t;&t;0x0008
DECL|macro|CMD_CMPL_INTR_ENABLE
mdefine_line|#define CMD_CMPL_INTR_ENABLE&t;&t;0x0010
DECL|macro|HP_INTR_ENABLE
mdefine_line|#define HP_INTR_ENABLE&t;&t;&t;0x0020
DECL|macro|ATTN_LED_CTRL
mdefine_line|#define ATTN_LED_CTRL&t;&t;&t;0x00C0
DECL|macro|PWR_LED_CTRL
mdefine_line|#define PWR_LED_CTRL&t;&t;&t;0x0300
DECL|macro|PWR_CTRL
mdefine_line|#define PWR_CTRL&t;&t;&t;0x0400
multiline_comment|/* Attention indicator and Power indicator states */
DECL|macro|LED_ON
mdefine_line|#define LED_ON&t;&t;0x01
DECL|macro|LED_BLINK
mdefine_line|#define LED_BLINK&t;0x10
DECL|macro|LED_OFF
mdefine_line|#define LED_OFF&t;&t;0x11
multiline_comment|/* Power Control Command */
DECL|macro|POWER_ON
mdefine_line|#define POWER_ON&t;0
DECL|macro|POWER_OFF
mdefine_line|#define POWER_OFF&t;0x0400
multiline_comment|/* Field definitions in Slot Status Register */
DECL|macro|ATTN_BUTTN_PRESSED
mdefine_line|#define ATTN_BUTTN_PRESSED&t;0x0001
DECL|macro|PWR_FAULT_DETECTED
mdefine_line|#define PWR_FAULT_DETECTED&t;0x0002
DECL|macro|MRL_SENS_CHANGED
mdefine_line|#define MRL_SENS_CHANGED&t;0x0004
DECL|macro|PRSN_DETECT_CHANGED
mdefine_line|#define PRSN_DETECT_CHANGED&t;0x0008
DECL|macro|CMD_COMPLETED
mdefine_line|#define CMD_COMPLETED&t;&t;0x0010
DECL|macro|MRL_STATE
mdefine_line|#define MRL_STATE&t;&t;0x0020
DECL|macro|PRSN_STATE
mdefine_line|#define PRSN_STATE&t;&t;0x0040
DECL|struct|php_ctlr_state_s
r_struct
id|php_ctlr_state_s
(brace
DECL|member|pnext
r_struct
id|php_ctlr_state_s
op_star
id|pnext
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* spinlock&squot;s */
DECL|member|slot_device_offset
id|u32
id|slot_device_offset
suffix:semicolon
DECL|member|num_slots
id|u32
id|num_slots
suffix:semicolon
DECL|member|int_poll_timer
r_struct
id|timer_list
id|int_poll_timer
suffix:semicolon
multiline_comment|/* Added for poll event */
DECL|member|attention_button_callback
id|php_intr_callback_t
id|attention_button_callback
suffix:semicolon
DECL|member|switch_change_callback
id|php_intr_callback_t
id|switch_change_callback
suffix:semicolon
DECL|member|presence_change_callback
id|php_intr_callback_t
id|presence_change_callback
suffix:semicolon
DECL|member|power_fault_callback
id|php_intr_callback_t
id|power_fault_callback
suffix:semicolon
DECL|member|callback_instance_id
r_void
op_star
id|callback_instance_id
suffix:semicolon
DECL|member|creg
r_struct
id|ctrl_reg
op_star
id|creg
suffix:semicolon
multiline_comment|/* Ptr to controller register space */
)brace
suffix:semicolon
DECL|variable|hpc_event_lock
r_static
id|spinlock_t
id|hpc_event_lock
suffix:semicolon
id|DEFINE_DBG_BUFFER
multiline_comment|/* Debug string buffer for entire HPC defined here */
DECL|variable|php_ctlr_list_head
r_static
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr_list_head
suffix:semicolon
multiline_comment|/* HPC state linked list */
DECL|variable|ctlr_seq_num
r_static
r_int
id|ctlr_seq_num
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Controller sequence # */
DECL|variable|list_lock
r_static
id|spinlock_t
id|list_lock
suffix:semicolon
r_static
id|irqreturn_t
id|pcie_isr
c_func
(paren
r_int
id|IRQ
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|start_int_poll_timer
c_func
(paren
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
comma
r_int
id|seconds
)paren
suffix:semicolon
multiline_comment|/* This is the interrupt polling timeout function. */
DECL|function|int_poll_timeout
r_static
r_void
id|int_poll_timeout
c_func
(paren
r_int
r_int
id|lphp_ctlr
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|lphp_ctlr
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Poll for interrupt events.  regs == NULL =&gt; polling */
id|pcie_isr
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
id|php_ctlr
comma
l_int|NULL
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|php_ctlr-&gt;int_poll_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_time
)paren
id|pciehp_poll_time
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* reset timer to poll in 2 secs if user doesn&squot;t specify at module installation*/
id|start_int_poll_timer
c_func
(paren
id|php_ctlr
comma
id|pciehp_poll_time
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* This function starts the interrupt polling timer. */
DECL|function|start_int_poll_timer
r_static
r_void
id|start_int_poll_timer
c_func
(paren
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
comma
r_int
id|seconds
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|seconds
op_le
l_int|0
)paren
op_logical_or
(paren
id|seconds
OG
l_int|60
)paren
)paren
id|seconds
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Clamp to sane value */
id|php_ctlr-&gt;int_poll_timer.function
op_assign
op_amp
id|int_poll_timeout
suffix:semicolon
id|php_ctlr-&gt;int_poll_timer.data
op_assign
(paren
r_int
r_int
)paren
id|php_ctlr
suffix:semicolon
multiline_comment|/* Instance data */
id|php_ctlr-&gt;int_poll_timer.expires
op_assign
id|jiffies
op_plus
id|seconds
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|php_ctlr-&gt;int_poll_timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|pcie_write_cmd
r_static
r_int
id|pcie_write_cmd
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u16
id|cmd
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
id|DBG_ENTER_ROUTINE
id|dbg
c_func
(paren
l_string|&quot;%s : Enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slot_status
op_amp
id|CMD_COMPLETED
)paren
op_eq
id|CMD_COMPLETED
)paren
(brace
multiline_comment|/* After 1 sec and CMD_COMPLETED still not set, just proceed forward to issue &n;&t;&t;   the next command according to spec.  Just print out the error message */
id|dbg
c_func
(paren
l_string|&quot;%s : CMD_COMPLETED not clear after 1 sec.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: Before hp_register_write_word SLOT_CTRL %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmd
)paren
suffix:semicolon
id|retval
op_assign
id|hp_register_write_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|cmd
op_or
id|CMD_CMPL_INTR_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_CTRL %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmd
op_or
id|CMD_CMPL_INTR_ENABLE
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s : Exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_check_lnk_status
r_static
r_int
id|hpc_check_lnk_status
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|lnk_status
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|LNK_STATUS
comma
id|lnk_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word LNK_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: lnk_status = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|lnk_status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lnk_status
op_amp
id|LNK_TRN
)paren
op_logical_or
(paren
id|lnk_status
op_amp
id|LNK_TRN_ERR
)paren
op_logical_or
op_logical_neg
(paren
id|lnk_status
op_amp
id|NEG_LINK_WD
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : Link Training Error occurs &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_attention_status
r_static
r_int
id|hpc_get_attention_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|status
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_ctrl
suffix:semicolon
id|u8
id|atten_led_state
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x, value read %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
id|atten_led_state
op_assign
(paren
id|slot_ctrl
op_amp
id|ATTN_LED_CTRL
)paren
op_rshift
l_int|6
suffix:semicolon
r_switch
c_cond
(paren
id|atten_led_state
)paren
(brace
r_case
l_int|0
suffix:colon
op_star
id|status
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* Reserved */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
op_star
id|status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* On */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|status
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Blink */
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
op_star
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Off */
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|status
op_assign
l_int|0xFF
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_get_power_status
r_static
r_int
id|hpc_get_power_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|status
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_ctrl
suffix:semicolon
id|u8
id|pwr_state
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x value read %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
id|pwr_state
op_assign
(paren
id|slot_ctrl
op_amp
id|PWR_CTRL
)paren
op_rshift
l_int|10
suffix:semicolon
r_switch
c_cond
(paren
id|pwr_state
)paren
(brace
r_case
l_int|0
suffix:colon
op_star
id|status
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
op_star
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|status
op_assign
l_int|0xFF
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_latch_status
r_static
r_int
id|hpc_get_latch_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|status
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
op_star
id|status
op_assign
(paren
(paren
(paren
id|slot_status
op_amp
id|MRL_STATE
)paren
op_rshift
l_int|5
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_get_adapter_status
r_static
r_int
id|hpc_get_adapter_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|status
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
id|u8
id|card_state
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|card_state
op_assign
(paren
id|u8
)paren
(paren
(paren
id|slot_status
op_amp
id|PRSN_STATE
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
op_star
id|status
op_assign
(paren
id|card_state
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_query_power_fault
r_static
r_int
id|hpc_query_power_fault
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
id|u8
id|pwr_fault
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|pwr_fault
op_assign
(paren
id|u8
)paren
(paren
(paren
id|slot_status
op_amp
id|PWR_FAULT_DETECTED
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|status
op_assign
(paren
id|pwr_fault
op_ne
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|DBG_LEAVE_ROUTINE
multiline_comment|/* Note: Logic 0 =&gt; fault */
r_return
id|status
suffix:semicolon
)brace
DECL|function|hpc_set_attention_status
r_static
r_int
id|hpc_set_attention_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_cmd
op_assign
l_int|0
suffix:semicolon
id|u16
id|slot_ctrl
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_ctrl
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* turn off */
id|slot_cmd
op_assign
(paren
id|slot_ctrl
op_amp
op_complement
id|ATTN_LED_CTRL
)paren
op_or
l_int|0x00C0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* turn on */
id|slot_cmd
op_assign
(paren
id|slot_ctrl
op_amp
op_complement
id|ATTN_LED_CTRL
)paren
op_or
l_int|0x0040
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* turn blink */
id|slot_cmd
op_assign
(paren
id|slot_ctrl
op_amp
op_complement
id|ATTN_LED_CTRL
)paren
op_or
l_int|0x0080
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
id|slot_cmd
op_assign
id|slot_cmd
op_or
id|HP_INTR_ENABLE
suffix:semicolon
id|pcie_write_cmd
c_func
(paren
id|slot
comma
id|slot_cmd
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x write cmd %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|hpc_set_green_led_on
r_static
r_void
id|hpc_set_green_led_on
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_cmd
suffix:semicolon
id|u16
id|slot_ctrl
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_ctrl
)paren
suffix:semicolon
id|slot_cmd
op_assign
(paren
id|slot_ctrl
op_amp
op_complement
id|PWR_LED_CTRL
)paren
op_or
l_int|0x0100
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
id|slot_cmd
op_assign
id|slot_cmd
op_or
id|HP_INTR_ENABLE
suffix:semicolon
id|pcie_write_cmd
c_func
(paren
id|slot
comma
id|slot_cmd
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x write cmd %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|hpc_set_green_led_off
r_static
r_void
id|hpc_set_green_led_off
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_cmd
suffix:semicolon
id|u16
id|slot_ctrl
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_ctrl
)paren
suffix:semicolon
id|slot_cmd
op_assign
(paren
id|slot_ctrl
op_amp
op_complement
id|PWR_LED_CTRL
)paren
op_or
l_int|0x0300
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
id|slot_cmd
op_assign
id|slot_cmd
op_or
id|HP_INTR_ENABLE
suffix:semicolon
id|pcie_write_cmd
c_func
(paren
id|slot
comma
id|slot_cmd
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x write cmd %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|hpc_set_green_led_blink
r_static
r_void
id|hpc_set_green_led_blink
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_cmd
suffix:semicolon
id|u16
id|slot_ctrl
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_ctrl
)paren
suffix:semicolon
id|slot_cmd
op_assign
(paren
id|slot_ctrl
op_amp
op_complement
id|PWR_LED_CTRL
)paren
op_or
l_int|0x0200
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
id|slot_cmd
op_assign
id|slot_cmd
op_or
id|HP_INTR_ENABLE
suffix:semicolon
id|pcie_write_cmd
c_func
(paren
id|slot
comma
id|slot_cmd
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x write cmd %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|pcie_get_ctlr_slot_config
r_int
id|pcie_get_ctlr_slot_config
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_int
op_star
id|num_ctlr_slots
comma
multiline_comment|/* number of slots in this HPC; only 1 in PCIE  */
r_int
op_star
id|first_device_num
comma
multiline_comment|/* PCI dev num of the first slot in this PCIE&t;*/
r_int
op_star
id|physical_slot_num
comma
multiline_comment|/* phy slot num of the first slot in this PCIE&t;*/
id|u8
op_star
id|ctrlcap
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u32
id|slot_cap
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|first_device_num
op_assign
l_int|0
suffix:semicolon
op_star
id|num_ctlr_slots
op_assign
l_int|1
suffix:semicolon
id|rc
op_assign
id|hp_register_read_dword
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CAP
comma
id|slot_cap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_dword SLOT_CAP failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|physical_slot_num
op_assign
id|slot_cap
op_rshift
l_int|19
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: PSN %d &bslash;n&quot;
comma
id|__FUNCTION__
comma
op_star
id|physical_slot_num
)paren
suffix:semicolon
op_star
id|ctrlcap
op_assign
id|slot_cap
op_amp
l_int|0x0000007f
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_release_ctlr
r_static
r_void
id|hpc_release_ctlr
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_struct
id|php_ctlr_state_s
op_star
id|p
comma
op_star
id|p_prev
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pciehp_poll_mode
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|php_ctlr-&gt;int_poll_timer
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|php_ctlr-&gt;irq
)paren
(brace
id|free_irq
c_func
(paren
id|php_ctlr-&gt;irq
comma
id|ctrl
)paren
suffix:semicolon
id|php_ctlr-&gt;irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcie_mch_quirk
)paren
id|pci_disable_msi
c_func
(paren
id|php_ctlr-&gt;pci_dev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|php_ctlr-&gt;pci_dev
)paren
id|php_ctlr-&gt;pci_dev
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|p
op_assign
id|php_ctlr_list_head
suffix:semicolon
id|p_prev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|php_ctlr
)paren
(brace
r_if
c_cond
(paren
id|p_prev
)paren
id|p_prev-&gt;pnext
op_assign
id|p-&gt;pnext
suffix:semicolon
r_else
id|php_ctlr_list_head
op_assign
id|p-&gt;pnext
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|p_prev
op_assign
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;pnext
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|php_ctlr
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
)brace
DECL|function|hpc_power_on_slot
r_static
r_int
id|hpc_power_on_slot
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_cmd
suffix:semicolon
id|u16
id|slot_ctrl
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
id|dbg
c_func
(paren
l_string|&quot;%s: &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: slot-&gt;hp_slot %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hp_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x, value read %xn&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
id|slot_cmd
op_assign
(paren
id|slot_ctrl
op_amp
op_complement
id|PWR_CTRL
)paren
op_or
id|POWER_ON
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
id|slot_cmd
op_assign
id|slot_cmd
op_or
id|HP_INTR_ENABLE
suffix:semicolon
id|retval
op_assign
id|pcie_write_cmd
c_func
(paren
id|slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Write %x command failed!&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x write cmd %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_cmd
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_power_off_slot
r_static
r_int
id|hpc_power_off_slot
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|slot_cmd
suffix:semicolon
id|u16
id|slot_ctrl
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
id|dbg
c_func
(paren
l_string|&quot;%s: &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: slot-&gt;hp_slot %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hp_slot
)paren
suffix:semicolon
id|slot-&gt;hp_slot
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x, value read %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
id|slot_cmd
op_assign
(paren
id|slot_ctrl
op_amp
op_complement
id|PWR_CTRL
)paren
op_or
id|POWER_OFF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
id|slot_cmd
op_assign
id|slot_cmd
op_or
id|HP_INTR_ENABLE
suffix:semicolon
id|retval
op_assign
id|pcie_write_cmd
c_func
(paren
id|slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Write command failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x write cmd %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_cmd
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|pcie_isr
r_static
id|irqreturn_t
id|pcie_isr
c_func
(paren
r_int
id|IRQ
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|controller
op_star
id|ctrl
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
suffix:semicolon
id|u8
id|schedule_flag
op_assign
l_int|0
suffix:semicolon
id|u16
id|slot_status
comma
id|intr_detect
comma
id|intr_loc
suffix:semicolon
id|u16
id|temp_word
suffix:semicolon
r_int
id|hp_slot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* only 1 slot per PCI Express port */
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_id
)paren
r_return
id|IRQ_NONE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
(brace
id|ctrl
op_assign
id|dev_id
suffix:semicolon
id|php_ctlr
op_assign
id|ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
)brace
r_else
(brace
id|php_ctlr
op_assign
id|dev_id
suffix:semicolon
id|ctrl
op_assign
(paren
r_struct
id|controller
op_star
)paren
id|php_ctlr-&gt;callback_instance_id
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ctrl
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: dev_id %p ctlr == NULL&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_void
op_star
)paren
id|dev_id
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: php_ctlr == NULL&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|intr_detect
op_assign
(paren
id|ATTN_BUTTN_PRESSED
op_or
id|PWR_FAULT_DETECTED
op_or
id|MRL_SENS_CHANGED
op_or
id|PRSN_DETECT_CHANGED
op_or
id|CMD_COMPLETED
)paren
suffix:semicolon
id|intr_loc
op_assign
id|slot_status
op_amp
id|intr_detect
suffix:semicolon
multiline_comment|/* Check to see if it was our interrupt */
r_if
c_cond
(paren
op_logical_neg
id|intr_loc
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: intr_loc %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|intr_loc
)paren
suffix:semicolon
multiline_comment|/* Mask Hot-plug Interrupt Enable */
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
(brace
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: Set Mask Hot-plug Interrupt Enable&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: hp_register_read_word SLOT_CTRL with value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
id|temp_word
op_assign
(paren
id|temp_word
op_amp
op_complement
id|HP_INTR_ENABLE
op_amp
op_complement
id|CMD_CMPL_INTR_ENABLE
)paren
op_or
l_int|0x00
suffix:semicolon
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: hp_register_write_word SLOT_CTRL with value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: hp_register_read_word SLOT_STATUS with value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_status
)paren
suffix:semicolon
multiline_comment|/* Clear command complete interrupt caused by this write */
id|temp_word
op_assign
l_int|0x1f
suffix:semicolon
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: hp_register_write_word SLOT_STATUS with value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_loc
op_amp
id|CMD_COMPLETED
)paren
(brace
multiline_comment|/* &n;&t;&t; * Command Complete Interrupt Pending &n;&t;&t; */
id|dbg
c_func
(paren
l_string|&quot;%s: In Command Complete Interrupt Pending&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ctrl-&gt;queue
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|php_ctlr-&gt;switch_change_callback
)paren
op_logical_and
(paren
id|intr_loc
op_amp
id|MRL_SENS_CHANGED
)paren
)paren
id|schedule_flag
op_add_assign
id|php_ctlr
op_member_access_from_pointer
id|switch_change_callback
c_func
(paren
id|hp_slot
comma
id|php_ctlr-&gt;callback_instance_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|php_ctlr-&gt;attention_button_callback
)paren
op_logical_and
(paren
id|intr_loc
op_amp
id|ATTN_BUTTN_PRESSED
)paren
)paren
id|schedule_flag
op_add_assign
id|php_ctlr
op_member_access_from_pointer
id|attention_button_callback
c_func
(paren
id|hp_slot
comma
id|php_ctlr-&gt;callback_instance_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|php_ctlr-&gt;presence_change_callback
)paren
op_logical_and
(paren
id|intr_loc
op_amp
id|PRSN_DETECT_CHANGED
)paren
)paren
id|schedule_flag
op_add_assign
id|php_ctlr
op_member_access_from_pointer
id|presence_change_callback
c_func
(paren
id|hp_slot
comma
id|php_ctlr-&gt;callback_instance_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|php_ctlr-&gt;power_fault_callback
)paren
op_logical_and
(paren
id|intr_loc
op_amp
id|PWR_FAULT_DETECTED
)paren
)paren
id|schedule_flag
op_add_assign
id|php_ctlr
op_member_access_from_pointer
id|power_fault_callback
c_func
(paren
id|hp_slot
comma
id|php_ctlr-&gt;callback_instance_id
)paren
suffix:semicolon
multiline_comment|/* Clear all events after serving them */
id|temp_word
op_assign
l_int|0x1F
suffix:semicolon
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/* Unmask Hot-plug Interrupt Enable */
r_if
c_cond
(paren
op_logical_neg
id|pciehp_poll_mode
)paren
(brace
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: Unmask Hot-plug Interrupt Enable&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: hp_register_read_word SLOT_CTRL with value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
id|temp_word
op_assign
(paren
id|temp_word
op_amp
op_complement
id|HP_INTR_ENABLE
)paren
op_or
id|HP_INTR_ENABLE
suffix:semicolon
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: hp_register_write_word SLOT_CTRL with value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: hp_register_read_word SLOT_STATUS with value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_status
)paren
suffix:semicolon
multiline_comment|/* Clear command complete interrupt caused by this write */
id|temp_word
op_assign
l_int|0x1F
suffix:semicolon
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: hp_register_write_word SLOT_STATUS with value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|hpc_get_max_lnk_speed
r_static
r_int
id|hpc_get_max_lnk_speed
(paren
r_struct
id|slot
op_star
id|slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_enum
id|pcie_link_speed
id|lnk_speed
suffix:semicolon
id|u32
id|lnk_cap
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_dword
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|LNK_CAP
comma
id|lnk_cap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_dword  LNK_CAP failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|lnk_cap
op_amp
l_int|0x000F
)paren
(brace
r_case
l_int|1
suffix:colon
id|lnk_speed
op_assign
id|PCIE_2PT5GB
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|lnk_speed
op_assign
id|PCIE_LNK_SPEED_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|value
op_assign
id|lnk_speed
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Max link speed = %d&bslash;n&quot;
comma
id|lnk_speed
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_max_lnk_width
r_static
r_int
id|hpc_get_max_lnk_width
(paren
r_struct
id|slot
op_star
id|slot
comma
r_enum
id|pcie_link_width
op_star
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_enum
id|pcie_link_width
id|lnk_wdth
suffix:semicolon
id|u32
id|lnk_cap
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_dword
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|LNK_CAP
comma
id|lnk_cap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_dword  LNK_CAP failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_switch
c_cond
(paren
(paren
id|lnk_cap
op_amp
l_int|0x03F0
)paren
op_rshift
l_int|4
)paren
(brace
r_case
l_int|0
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_WIDTH_RESRV
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_WIDTH_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|value
op_assign
id|lnk_wdth
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Max link width = %d&bslash;n&quot;
comma
id|lnk_wdth
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_cur_lnk_speed
r_static
r_int
id|hpc_get_cur_lnk_speed
(paren
r_struct
id|slot
op_star
id|slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_enum
id|pcie_link_speed
id|lnk_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|u16
id|lnk_status
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|LNK_STATUS
comma
id|lnk_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word LNK_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|lnk_status
op_amp
l_int|0x0F
)paren
(brace
r_case
l_int|1
suffix:colon
id|lnk_speed
op_assign
id|PCIE_2PT5GB
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|lnk_speed
op_assign
id|PCIE_LNK_SPEED_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|value
op_assign
id|lnk_speed
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Current link speed = %d&bslash;n&quot;
comma
id|lnk_speed
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_cur_lnk_width
r_static
r_int
id|hpc_get_cur_lnk_width
(paren
r_struct
id|slot
op_star
id|slot
comma
r_enum
id|pcie_link_width
op_star
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_enum
id|pcie_link_width
id|lnk_wdth
op_assign
id|PCIE_LNK_WIDTH_UNKNOWN
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|u16
id|lnk_status
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|LNK_STATUS
comma
id|lnk_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word LNK_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_switch
c_cond
(paren
(paren
id|lnk_status
op_amp
l_int|0x03F0
)paren
op_rshift
l_int|4
)paren
(brace
r_case
l_int|0
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_WIDTH_RESRV
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_X32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|lnk_wdth
op_assign
id|PCIE_LNK_WIDTH_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|value
op_assign
id|lnk_wdth
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Current link width = %d&bslash;n&quot;
comma
id|lnk_wdth
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|pciehp_hpc_ops
r_static
r_struct
id|hpc_ops
id|pciehp_hpc_ops
op_assign
(brace
dot
id|power_on_slot
op_assign
id|hpc_power_on_slot
comma
dot
id|power_off_slot
op_assign
id|hpc_power_off_slot
comma
dot
id|set_attention_status
op_assign
id|hpc_set_attention_status
comma
dot
id|get_power_status
op_assign
id|hpc_get_power_status
comma
dot
id|get_attention_status
op_assign
id|hpc_get_attention_status
comma
dot
id|get_latch_status
op_assign
id|hpc_get_latch_status
comma
dot
id|get_adapter_status
op_assign
id|hpc_get_adapter_status
comma
dot
id|get_max_bus_speed
op_assign
id|hpc_get_max_lnk_speed
comma
dot
id|get_cur_bus_speed
op_assign
id|hpc_get_cur_lnk_speed
comma
dot
id|get_max_lnk_width
op_assign
id|hpc_get_max_lnk_width
comma
dot
id|get_cur_lnk_width
op_assign
id|hpc_get_cur_lnk_width
comma
dot
id|query_power_fault
op_assign
id|hpc_query_power_fault
comma
dot
id|green_led_on
op_assign
id|hpc_set_green_led_on
comma
dot
id|green_led_off
op_assign
id|hpc_set_green_led_off
comma
dot
id|green_led_blink
op_assign
id|hpc_set_green_led_blink
comma
dot
id|release_ctlr
op_assign
id|hpc_release_ctlr
comma
dot
id|check_lnk_status
op_assign
id|hpc_check_lnk_status
comma
)brace
suffix:semicolon
DECL|function|pcie_init
r_int
id|pcie_init
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pcie_device
op_star
id|dev
comma
id|php_intr_callback_t
id|attention_button_callback
comma
id|php_intr_callback_t
id|switch_change_callback
comma
id|php_intr_callback_t
id|presence_change_callback
comma
id|php_intr_callback_t
id|power_fault_callback
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
comma
op_star
id|p
suffix:semicolon
r_void
op_star
id|instance_id
op_assign
id|ctrl
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
id|u16
id|temp_word
suffix:semicolon
id|u16
id|cap_reg
suffix:semicolon
id|u16
id|intr_enable
op_assign
l_int|0
suffix:semicolon
id|u32
id|slot_cap
suffix:semicolon
r_int
id|cap_base
comma
id|saved_cap_base
suffix:semicolon
id|u16
id|slot_status
comma
id|slot_ctrl
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|DBG_ENTER_ROUTINE
id|spin_lock_init
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|php_ctlr_state_s
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
multiline_comment|/* allocate controller state data */
id|err
c_func
(paren
l_string|&quot;%s: HPC controller memory allocation error!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
id|memset
c_func
(paren
id|php_ctlr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|php_ctlr_state_s
)paren
)paren
suffix:semicolon
id|pdev
op_assign
id|dev-&gt;port
suffix:semicolon
id|php_ctlr-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
multiline_comment|/* save pci_dev in context */
id|dbg
c_func
(paren
l_string|&quot;%s: pdev-&gt;vendor %x pdev-&gt;device %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pdev-&gt;vendor
comma
id|pdev-&gt;device
)paren
suffix:semicolon
id|saved_cap_base
op_assign
id|pcie_cap_base
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cap_base
op_assign
id|pci_find_capability
c_func
(paren
id|pdev
comma
id|PCI_CAP_ID_EXP
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: Can&squot;t find PCI_CAP_ID_EXP (0x10)&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|pcie_cap_base
op_assign
id|cap_base
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: pcie_cap_base %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pcie_cap_base
)paren
suffix:semicolon
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|pdev
comma
id|CAP_REG
comma
id|cap_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word CAP_REG failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: CAP_REG offset %x cap_reg %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|CAP_REG
comma
id|cap_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|cap_reg
op_amp
id|SLOT_IMPL
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|cap_reg
op_amp
id|DEV_PORT_TYPE
)paren
op_ne
l_int|0x0040
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s : This is not a root port or the port is not connected to a slot&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|rc
op_assign
id|hp_register_read_dword
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CAP
comma
id|slot_cap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word CAP_REG failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CAP offset %x slot_cap %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CAP
comma
id|slot_cap
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|slot_cap
op_amp
id|HP_CAP
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s : This slot is not hot-plug capable&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
multiline_comment|/* For debugging purpose */
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_STATUS offset %x slot_status %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL offset %x slot_ctrl %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|slot_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|hpc_event_lock
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;pdev = %p: b:d:f:irq=0x%x:%x:%x:%x&bslash;n&quot;
comma
id|pdev
comma
id|pdev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rc
op_assign
l_int|0
suffix:semicolon
id|rc
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|rc
op_increment
)paren
r_if
c_cond
(paren
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|rc
)paren
OG
l_int|0
)paren
id|dbg
c_func
(paren
l_string|&quot;pci resource[%d] start=0x%lx(len=0x%lx)&bslash;n&quot;
comma
id|rc
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|rc
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|rc
)paren
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;HPC vendor_id %x device_id %x ss_vid %x ss_did %x&bslash;n&quot;
comma
id|pdev-&gt;vendor
comma
id|pdev-&gt;device
comma
id|pdev-&gt;subsystem_vendor
comma
id|pdev-&gt;subsystem_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|abort_free_ctlr
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
multiline_comment|/* setup wait queue */
id|init_waitqueue_head
c_func
(paren
op_amp
id|ctrl-&gt;queue
)paren
suffix:semicolon
multiline_comment|/* find the IRQ */
id|php_ctlr-&gt;irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;HPC interrupt = %d&bslash;n&quot;
comma
id|php_ctlr-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Save interrupt callback info */
id|php_ctlr-&gt;attention_button_callback
op_assign
id|attention_button_callback
suffix:semicolon
id|php_ctlr-&gt;switch_change_callback
op_assign
id|switch_change_callback
suffix:semicolon
id|php_ctlr-&gt;presence_change_callback
op_assign
id|presence_change_callback
suffix:semicolon
id|php_ctlr-&gt;power_fault_callback
op_assign
id|power_fault_callback
suffix:semicolon
id|php_ctlr-&gt;callback_instance_id
op_assign
id|instance_id
suffix:semicolon
multiline_comment|/* return PCI Controller Info */
id|php_ctlr-&gt;slot_device_offset
op_assign
l_int|0
suffix:semicolon
id|php_ctlr-&gt;num_slots
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Mask Hot-plug Interrupt Enable */
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|pdev
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x value read %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
id|temp_word
op_assign
(paren
id|temp_word
op_amp
op_complement
id|HP_INTR_ENABLE
op_amp
op_complement
id|CMD_CMPL_INTR_ENABLE
)paren
op_or
l_int|0x00
suffix:semicolon
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|pdev
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s : Mask HPIE hp_register_write_word SLOT_CTRL %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: Mask HPIE SLOT_STATUS offset %x reads slot_status %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
id|temp_word
op_assign
l_int|0x1F
suffix:semicolon
multiline_comment|/* Clear all events */
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_STATUS offset %x writes slot_status %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_STATUS
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pciehp_poll_mode
)paren
(brace
multiline_comment|/* Install interrupt polling code */
multiline_comment|/* Install and start the interrupt polling timer */
id|init_timer
c_func
(paren
op_amp
id|php_ctlr-&gt;int_poll_timer
)paren
suffix:semicolon
id|start_int_poll_timer
c_func
(paren
id|php_ctlr
comma
l_int|10
)paren
suffix:semicolon
multiline_comment|/* start with 10 second delay */
)brace
r_else
(brace
multiline_comment|/* Installs the interrupt handler */
id|rc
op_assign
id|request_irq
c_func
(paren
id|php_ctlr-&gt;irq
comma
id|pcie_isr
comma
id|SA_SHIRQ
comma
id|MY_NAME
comma
(paren
r_void
op_star
)paren
id|ctrl
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: request_irq %d for hpc%d (returns %d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|php_ctlr-&gt;irq
comma
id|ctlr_seq_num
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t get irq %d for the hotplug controller&bslash;n&quot;
comma
id|php_ctlr-&gt;irq
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
)brace
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|pdev
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_CTRL %x value read %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: slot_cap %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_cap
)paren
suffix:semicolon
id|intr_enable
op_assign
id|intr_enable
op_or
id|PRSN_DETECT_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|ATTN_BUTTN
c_func
(paren
id|slot_cap
)paren
)paren
id|intr_enable
op_assign
id|intr_enable
op_or
id|ATTN_BUTTN_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|POWER_CTRL
c_func
(paren
id|slot_cap
)paren
)paren
id|intr_enable
op_assign
id|intr_enable
op_or
id|PWR_FAULT_DETECT_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|MRL_SENS
c_func
(paren
id|slot_cap
)paren
)paren
id|intr_enable
op_assign
id|intr_enable
op_or
id|MRL_DETECT_ENABLE
suffix:semicolon
id|temp_word
op_assign
(paren
id|temp_word
op_amp
op_complement
id|intr_enable
)paren
op_or
id|intr_enable
suffix:semicolon
r_if
c_cond
(paren
id|pciehp_poll_mode
)paren
(brace
id|temp_word
op_assign
(paren
id|temp_word
op_amp
op_complement
id|HP_INTR_ENABLE
)paren
op_or
l_int|0x0
suffix:semicolon
)brace
r_else
(brace
id|temp_word
op_assign
(paren
id|temp_word
op_amp
op_complement
id|HP_INTR_ENABLE
)paren
op_or
id|HP_INTR_ENABLE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: temp_word %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
multiline_comment|/* Unmask Hot-plug Interrupt Enable for the interrupt notification mechanism case */
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|pdev
comma
id|SLOT_CTRL
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_CTRL failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s : Unmask HPIE hp_register_write_word SLOT_CTRL with %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
id|rc
op_assign
id|hp_register_read_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_read_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: Unmask HPIE SLOT_STATUS offset %x reads slot_status %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_STATUS
comma
id|slot_status
)paren
suffix:semicolon
id|temp_word
op_assign
l_int|0x1F
suffix:semicolon
multiline_comment|/* Clear all events */
id|rc
op_assign
id|hp_register_write_word
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
id|SLOT_STATUS
comma
id|temp_word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : hp_register_write_word SLOT_STATUS failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: SLOT_STATUS offset %x writes slot_status %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SLOT_STATUS
comma
id|temp_word
)paren
suffix:semicolon
multiline_comment|/*  Add this HPC instance into the HPC list */
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|php_ctlr_list_head
op_eq
l_int|0
)paren
(brace
id|php_ctlr_list_head
op_assign
id|php_ctlr
suffix:semicolon
id|p
op_assign
id|php_ctlr_list_head
suffix:semicolon
id|p-&gt;pnext
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|php_ctlr_list_head
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;pnext
)paren
id|p
op_assign
id|p-&gt;pnext
suffix:semicolon
id|p-&gt;pnext
op_assign
id|php_ctlr
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|ctlr_seq_num
op_increment
suffix:semicolon
id|ctrl-&gt;hpc_ctlr_handle
op_assign
id|php_ctlr
suffix:semicolon
id|ctrl-&gt;hpc_ops
op_assign
op_amp
id|pciehp_hpc_ops
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
multiline_comment|/* We end up here for the many possible ways to fail this API.  */
id|abort_free_ctlr
suffix:colon
id|pcie_cap_base
op_assign
id|saved_cap_base
suffix:semicolon
id|kfree
c_func
(paren
id|php_ctlr
)paren
suffix:semicolon
m_abort
suffix:colon
id|DBG_LEAVE_ROUTINE
r_return
op_minus
l_int|1
suffix:semicolon
)brace
eof
