multiline_comment|/*&n; * IBM Hot Plug Controller Driver&n; *&n; * Written By: Chuck Cole, Jyoti Shah, Tong Yu, Irene Zubarev, IBM Corporation&n; *&n; * Copyright (C) 2001,2003 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (C) 2001-2003 IBM Corp.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;gregkh@us.ibm.com&gt;&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &quot;../pci.h&quot;
macro_line|#include &quot;../../../arch/i386/pci/pci.h&quot;&t;/* for struct irq_routing_table */
macro_line|#include &quot;ibmphp.h&quot;
DECL|macro|attn_on
mdefine_line|#define attn_on(sl)  ibmphp_hpc_writeslot (sl, HPC_SLOT_ATTNON)
DECL|macro|attn_off
mdefine_line|#define attn_off(sl) ibmphp_hpc_writeslot (sl, HPC_SLOT_ATTNOFF)
DECL|macro|attn_LED_blink
mdefine_line|#define attn_LED_blink(sl) ibmphp_hpc_writeslot (sl, HPC_SLOT_BLINKLED)
DECL|macro|get_ctrl_revision
mdefine_line|#define get_ctrl_revision(sl, rev) ibmphp_hpc_readslot (sl, READ_REVLEVEL, rev)
DECL|macro|get_hpc_options
mdefine_line|#define get_hpc_options(sl, opt) ibmphp_hpc_readslot (sl, READ_HPCOPTIONS, opt)
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;0.6&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;IBM Hot Plug PCI Controller Driver&quot;
DECL|variable|ibmphp_debug
r_int
id|ibmphp_debug
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
id|MODULE_PARM
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|debug
comma
l_string|&quot;Debugging mode enabled or not&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
DECL|variable|ibmphp_pci_bus
r_struct
id|pci_bus
op_star
id|ibmphp_pci_bus
suffix:semicolon
DECL|variable|max_slots
r_static
r_int
id|max_slots
suffix:semicolon
DECL|variable|irqs
r_static
r_int
id|irqs
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* PIC mode IRQ&squot;s we&squot;re using so far (in case MPS tables don&squot;t provide default info for empty slots */
DECL|variable|init_flag
r_static
r_int
id|init_flag
suffix:semicolon
multiline_comment|/*&n;static int get_max_adapter_speed_1 (struct hotplug_slot *, u8 *, u8);&n;&n;static inline int get_max_adapter_speed (struct hotplug_slot *hs, u8 *value)&n;{&n;&t;return get_max_adapter_speed_1 (hs, value, 1);&n;}&n;*/
DECL|function|get_cur_bus_info
r_static
r_inline
r_int
id|get_cur_bus_info
(paren
r_struct
id|slot
op_star
op_star
id|sl
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|slot
op_star
id|slot_cur
op_assign
op_star
id|sl
suffix:semicolon
id|debug
(paren
l_string|&quot;options = %x&bslash;n&quot;
comma
id|slot_cur-&gt;ctrl-&gt;options
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;revision = %x&bslash;n&quot;
comma
id|slot_cur-&gt;ctrl-&gt;revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|READ_BUS_STATUS
(paren
id|slot_cur-&gt;ctrl
)paren
)paren
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
id|slot_cur
comma
id|READ_BUSSTATUS
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|slot_cur-&gt;bus_on-&gt;current_speed
op_assign
id|CURRENT_BUS_SPEED
(paren
id|slot_cur-&gt;busstatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|READ_BUS_MODE
(paren
id|slot_cur-&gt;ctrl
)paren
)paren
id|slot_cur-&gt;bus_on-&gt;current_bus_mode
op_assign
id|CURRENT_BUS_MODE
(paren
id|slot_cur-&gt;busstatus
)paren
suffix:semicolon
r_else
id|slot_cur-&gt;bus_on-&gt;current_bus_mode
op_assign
l_int|0xFF
suffix:semicolon
id|debug
(paren
l_string|&quot;busstatus = %x, bus_speed = %x, bus_mode = %x&bslash;n&quot;
comma
id|slot_cur-&gt;busstatus
comma
id|slot_cur-&gt;bus_on-&gt;current_speed
comma
id|slot_cur-&gt;bus_on-&gt;current_bus_mode
)paren
suffix:semicolon
op_star
id|sl
op_assign
id|slot_cur
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|slot_update
r_static
r_inline
r_int
id|slot_update
(paren
r_struct
id|slot
op_star
op_star
id|sl
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
op_star
id|sl
comma
id|READ_ALLSTAT
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|init_flag
)paren
id|rc
op_assign
id|get_cur_bus_info
c_func
(paren
id|sl
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_max_slots
r_static
r_int
id|__init
id|get_max_slots
(paren
r_void
)paren
(brace
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|u8
id|slot_count
op_assign
l_int|0
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
id|slot_cur
op_assign
id|list_entry
(paren
id|tmp
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
multiline_comment|/* sometimes the hot-pluggable slots start with 4 (not always from 1) */
id|slot_count
op_assign
id|max
(paren
id|slot_count
comma
id|slot_cur-&gt;number
)paren
suffix:semicolon
)brace
r_return
id|slot_count
suffix:semicolon
)brace
multiline_comment|/* This routine will put the correct slot-&gt;device information per slot.  It&squot;s&n; * called from initialization of the slot structures. It will also assign&n; * interrupt numbers per each slot.&n; * Parameters: struct slot&n; * Returns 0 or errors&n; */
DECL|function|ibmphp_init_devno
r_int
id|ibmphp_init_devno
(paren
r_struct
id|slot
op_star
op_star
id|cur_slot
)paren
(brace
r_struct
id|irq_routing_table
op_star
id|rtable
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|loop
suffix:semicolon
r_int
id|i
suffix:semicolon
id|rtable
op_assign
id|pcibios_get_irq_routing_table
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rtable
)paren
(brace
id|err
(paren
l_string|&quot;no BIOS routing table...&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|len
op_assign
(paren
id|rtable-&gt;size
op_minus
r_sizeof
(paren
r_struct
id|irq_routing_table
)paren
)paren
op_div
r_sizeof
(paren
r_struct
id|irq_info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
id|len
suffix:semicolon
id|loop
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|number
op_eq
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|slot
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|bus
op_eq
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|bus
)paren
(brace
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|device
op_assign
id|PCI_SLOT
(paren
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|devfn
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
id|i
)braket
op_assign
id|IO_APIC_get_PCI_irq_vector
(paren
(paren
r_int
)paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|bus
comma
(paren
r_int
)paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|device
comma
id|i
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;(*cur_slot)-&gt;irq[0] = %x&bslash;n&quot;
comma
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;(*cur_slot)-&gt;irq[1] = %x&bslash;n&quot;
comma
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;(*cur_slot)-&gt;irq[2] = %x&bslash;n&quot;
comma
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;(*cur_slot)-&gt;irq[3] = %x&bslash;n&quot;
comma
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;exlusive_irqs = %x&bslash;n&quot;
comma
id|rtable-&gt;exclusive_irqs
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[0].bitmap = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|0
)braket
dot
id|bitmap
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[1].bitmap = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|1
)braket
dot
id|bitmap
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[2].bitmap = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|2
)braket
dot
id|bitmap
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[3].bitmap = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|3
)braket
dot
id|bitmap
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[0].link= %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|0
)braket
dot
id|link
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[1].link = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|1
)braket
dot
id|link
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[2].link = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|2
)braket
dot
id|link
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[3].link = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|3
)braket
dot
id|link
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;end of init_devno&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|power_on
r_static
r_inline
r_int
id|power_on
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
id|u8
id|cmd
op_assign
id|HPC_SLOT_ON
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|ibmphp_hpc_writeslot
(paren
id|slot_cur
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
(paren
l_string|&quot;power on failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CTLR_RESULT
(paren
id|slot_cur-&gt;ctrl-&gt;status
)paren
)paren
(brace
id|err
(paren
l_string|&quot;command not completed successfully in power_on&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|long_delay
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* For ServeRAID cards, and some 66 PCI */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|power_off
r_static
r_inline
r_int
id|power_off
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
id|u8
id|cmd
op_assign
id|HPC_SLOT_OFF
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|ibmphp_hpc_writeslot
(paren
id|slot_cur
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
(paren
l_string|&quot;power off failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CTLR_RESULT
(paren
id|slot_cur-&gt;ctrl-&gt;status
)paren
)paren
(brace
id|err
(paren
l_string|&quot;command not completed successfully in power_off&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|set_attention_status
r_static
r_int
id|set_attention_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
id|value
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
id|u8
id|cmd
suffix:semicolon
id|debug
(paren
l_string|&quot;set_attention_status - Entry hotplug_slot[%lx] value[%x]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
id|cmd
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// avoid compiler warning
r_if
c_cond
(paren
id|hotplug_slot
)paren
(brace
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
id|HPC_SLOT_ATTN_OFF
suffix:colon
id|cmd
op_assign
id|HPC_SLOT_ATTNOFF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_SLOT_ATTN_ON
suffix:colon
id|cmd
op_assign
id|HPC_SLOT_ATTNON
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_SLOT_ATTN_BLINK
suffix:colon
id|cmd
op_assign
id|HPC_SLOT_BLINKLED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|err
(paren
l_string|&quot;set_attention_status - Error : invalid input [%x]&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
id|rc
op_assign
id|ibmphp_hpc_writeslot
c_func
(paren
id|pslot
comma
id|cmd
)paren
suffix:semicolon
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;set_attention_status - Exit rc[%d]&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_attention_status
r_static
r_int
id|get_attention_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
r_struct
id|slot
id|myslot
suffix:semicolon
id|debug
(paren
l_string|&quot;get_attention_status - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
(paren
id|ulong
)paren
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
c_func
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
(paren
id|myslot.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
id|ibmphp_hpc_readslot
c_func
(paren
id|pslot
comma
id|READ_EXTSLOTSTATUS
comma
op_amp
(paren
id|myslot.ext_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
op_star
id|value
op_assign
id|SLOT_ATTN
(paren
id|myslot.status
comma
id|myslot.ext_status
)paren
suffix:semicolon
)brace
)brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;get_attention_status - Exit rc[%d] value[%x]&bslash;n&quot;
comma
id|rc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_latch_status
r_static
r_int
id|get_latch_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
r_struct
id|slot
id|myslot
suffix:semicolon
id|debug
(paren
l_string|&quot;get_latch_status - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
(paren
id|ulong
)paren
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
c_func
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
(paren
id|myslot.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
op_star
id|value
op_assign
id|SLOT_LATCH
(paren
id|myslot.status
)paren
suffix:semicolon
)brace
)brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;get_latch_status - Exit rc[%d] rc[%x] value[%x]&bslash;n&quot;
comma
id|rc
comma
id|rc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_power_status
r_static
r_int
id|get_power_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
r_struct
id|slot
id|myslot
suffix:semicolon
id|debug
(paren
l_string|&quot;get_power_status - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
(paren
id|ulong
)paren
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
c_func
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
(paren
id|myslot.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
op_star
id|value
op_assign
id|SLOT_PWRGD
(paren
id|myslot.status
)paren
suffix:semicolon
)brace
)brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;get_power_status - Exit rc[%d] rc[%x] value[%x]&bslash;n&quot;
comma
id|rc
comma
id|rc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_adapter_present
r_static
r_int
id|get_adapter_present
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
id|u8
id|present
suffix:semicolon
r_struct
id|slot
id|myslot
suffix:semicolon
id|debug
(paren
l_string|&quot;get_adapter_status - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
(paren
id|ulong
)paren
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
c_func
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
(paren
id|myslot.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|present
op_assign
id|SLOT_PRESENT
(paren
id|myslot.status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|present
op_eq
id|HPC_SLOT_EMPTY
)paren
op_star
id|value
op_assign
l_int|0
suffix:semicolon
r_else
op_star
id|value
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;get_adapter_present - Exit rc[%d] value[%x]&bslash;n&quot;
comma
id|rc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_max_bus_speed
r_static
r_int
id|get_max_bus_speed
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
id|u8
id|mode
op_assign
l_int|0
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Entry hotplug_slot[%p] pvalue[%p]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot
comma
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
id|mode
op_assign
id|pslot-&gt;supported_bus_mode
suffix:semicolon
op_star
id|value
op_assign
id|pslot-&gt;supported_speed
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|value
)paren
(brace
r_case
id|BUS_SPEED_33
suffix:colon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_66
suffix:colon
r_if
c_cond
(paren
id|mode
op_eq
id|BUS_MODE_PCIX
)paren
op_star
id|value
op_add_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_100
suffix:colon
r_case
id|BUS_SPEED_133
suffix:colon
op_star
id|value
op_assign
id|pslot-&gt;supported_speed
op_plus
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Note (will need to change): there would be soon 256, 512 also */
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Exit rc[%d] value[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_cur_bus_speed
r_static
r_int
id|get_cur_bus_speed
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
id|u8
id|mode
op_assign
l_int|0
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Entry hotplug_slot[%p] pvalue[%p]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot
comma
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|rc
op_assign
id|get_cur_bus_info
(paren
op_amp
id|pslot
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|mode
op_assign
id|pslot-&gt;bus_on-&gt;current_bus_mode
suffix:semicolon
op_star
id|value
op_assign
id|pslot-&gt;bus_on-&gt;current_speed
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|value
)paren
(brace
r_case
id|BUS_SPEED_33
suffix:colon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_66
suffix:colon
r_if
c_cond
(paren
id|mode
op_eq
id|BUS_MODE_PCIX
)paren
op_star
id|value
op_add_assign
l_int|0x01
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mode
op_eq
id|BUS_MODE_PCI
)paren
suffix:semicolon
r_else
op_star
id|value
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_100
suffix:colon
r_case
id|BUS_SPEED_133
suffix:colon
op_star
id|value
op_add_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Note of change: there would also be 256, 512 soon */
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
)brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Exit rc[%d] value[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n;static int get_max_adapter_speed_1 (struct hotplug_slot *hotplug_slot, u8 * value, u8 flag)&n;{&n;&t;int rc = -ENODEV;&n;&t;struct slot *pslot;&n;&t;struct slot myslot;&n;&n;&t;debug (&quot;get_max_adapter_speed_1 - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;, (ulong)hotplug_slot, (ulong) value);&n;&n;&t;if (flag)&n;&t;&t;ibmphp_lock_operations ();&n;&n;&t;if (hotplug_slot &amp;&amp; value) {&n;&t;&t;pslot = (struct slot *) hotplug_slot-&gt;private;&n;&t;&t;if (pslot) {&n;&t;&t;&t;memcpy ((void *) &amp;myslot, (void *) pslot, sizeof (struct slot));&n;&t;&t;&t;rc = ibmphp_hpc_readslot(pslot, READ_SLOTSTATUS, &amp;(myslot.status));&n;&n;&t;&t;&t;if (!(SLOT_LATCH (myslot.status)) &amp;&amp; (SLOT_PRESENT (myslot.status))) {&n;&t;&t;&t;&t;rc = ibmphp_hpc_readslot(pslot, READ_EXTSLOTSTATUS, &amp;(myslot.ext_status));&n;&t;&t;&t;&t;if (!rc)&n;&t;&t;&t;&t;&t;*value = SLOT_SPEED (myslot.ext_status);&n;&t;&t;&t;} else&n;&t;&t;&t;&t;*value = MAX_ADAPTER_NONE;&n;                }&n;&t;}&n;&n;&t;if (flag)&n;&t;&t;ibmphp_unlock_operations ();&n;&n;&t;debug(&quot;get_max_adapter_speed_1 - Exit rc[%d] value[%x]&bslash;n&quot;, rc, *value);&n;&t;return rc;&n;}&n;&n;static int get_bus_name (struct hotplug_slot *hotplug_slot, char * value)&n;{&n;&t;int rc = -ENODEV;&n;&t;struct slot *pslot = NULL;&n;&n;&t;debug (&quot;get_bus_name - Entry hotplug_slot[%lx]&bslash;n&quot;, (ulong)hotplug_slot);&n;&n;&t;ibmphp_lock_operations ();&n;&n;&t;if (hotplug_slot) {&n;&t;&t;pslot = (struct slot *) hotplug_slot-&gt;private;&n;&t;&t;if (pslot) {&n;&t;&t;&t;rc = 0;&n;&t;&t;&t;snprintf (value, 100, &quot;Bus %x&quot;, pslot-&gt;bus);&n;&t;&t;}&n;&t;} else&n;&t;&t;rc = -ENODEV;&n;&n;&t;ibmphp_unlock_operations ();&n;&t;debug (&quot;get_bus_name - Exit rc[%d] value[%x]&bslash;n&quot;, rc, *value);&n;&t;return rc;&n;}&n;*/
multiline_comment|/*******************************************************************************&n; * This routine will initialize the ops data structure used in the validate&n; * function. It will also power off empty slots that are powered on since BIOS&n; * leaves those on, albeit disconnected&n; ******************************************************************************/
DECL|function|init_ops
r_static
r_int
id|__init
id|init_ops
(paren
r_void
)paren
(brace
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
id|slot_cur
op_assign
id|list_entry
(paren
id|tmp
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_cur
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|debug
(paren
l_string|&quot;BEFORE GETTING SLOT STATUS, slot # %x&bslash;n&quot;
comma
id|slot_cur-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;ctrl-&gt;revision
op_eq
l_int|0xFF
)paren
r_if
c_cond
(paren
id|get_ctrl_revision
(paren
id|slot_cur
comma
op_amp
id|slot_cur-&gt;ctrl-&gt;revision
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;bus_on-&gt;current_speed
op_eq
l_int|0xFF
)paren
r_if
c_cond
(paren
id|get_cur_bus_info
(paren
op_amp
id|slot_cur
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;ctrl-&gt;options
op_eq
l_int|0xFF
)paren
r_if
c_cond
(paren
id|get_hpc_options
(paren
id|slot_cur
comma
op_amp
id|slot_cur-&gt;ctrl-&gt;options
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|retval
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|debug
(paren
l_string|&quot;status = %x&bslash;n&quot;
comma
id|slot_cur-&gt;status
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;ext_status = %x&bslash;n&quot;
comma
id|slot_cur-&gt;ext_status
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;SLOT_POWER = %x&bslash;n&quot;
comma
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;SLOT_PRESENT = %x&bslash;n&quot;
comma
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;SLOT_LATCH = %x&bslash;n&quot;
comma
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SLOT_PWRGD
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
(brace
id|debug
(paren
l_string|&quot;BEFORE POWER OFF COMMAND&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|power_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/*&t;&t;retval = slot_update (&amp;slot_cur);&n;&t; *&t;&t;if (retval)&n;&t; *&t;&t;&t;return retval;&n;&t; *&t;&t;ibmphp_update_slot_info (slot_cur);&n;&t; */
)brace
)brace
id|init_flag
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This operation will check whether the slot is within the bounds and&n; * the operation is valid to perform on that slot&n; * Parameters: slot, operation&n; * Returns: 0 or error codes&n; */
DECL|function|validate
r_static
r_int
id|validate
(paren
r_struct
id|slot
op_star
id|slot_cur
comma
r_int
id|opn
)paren
(brace
r_int
id|number
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_cur
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|number
op_assign
id|slot_cur-&gt;number
suffix:semicolon
r_if
c_cond
(paren
(paren
id|number
OG
id|max_slots
)paren
op_logical_or
(paren
id|number
OL
l_int|0
)paren
)paren
r_return
op_minus
id|EBADSLT
suffix:semicolon
id|debug
(paren
l_string|&quot;slot_number in validate is %d&bslash;n&quot;
comma
id|slot_cur-&gt;number
)paren
suffix:semicolon
id|retval
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_switch
c_cond
(paren
id|opn
)paren
(brace
r_case
id|ENABLE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|SLOT_PWRGD
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
(paren
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISABLE
suffix:colon
r_if
c_cond
(paren
(paren
id|SLOT_PWRGD
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
(paren
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|err
(paren
l_string|&quot;validate failed....&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/********************************************************************************&n; * This routine is for updating the data structures in the hotplug core&n; * Parameters: struct slot&n; * Returns: 0 or error&n; *******************************************************************************/
DECL|function|ibmphp_update_slot_info
r_int
id|ibmphp_update_slot_info
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
r_struct
id|hotplug_slot_info
op_star
id|info
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|u8
id|bus_speed
suffix:semicolon
id|u8
id|mode
suffix:semicolon
id|info
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|info-&gt;power_status
op_assign
id|SLOT_PWRGD
(paren
id|slot_cur-&gt;status
)paren
suffix:semicolon
id|info-&gt;attention_status
op_assign
id|SLOT_ATTN
(paren
id|slot_cur-&gt;status
comma
id|slot_cur-&gt;ext_status
)paren
suffix:semicolon
id|info-&gt;latch_status
op_assign
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
(brace
id|info-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
singleline_comment|//&t;&t;info-&gt;max_adapter_speed_status = MAX_ADAPTER_NONE;
)brace
r_else
(brace
id|info-&gt;adapter_status
op_assign
l_int|1
suffix:semicolon
singleline_comment|//&t;&t;get_max_adapter_speed_1 (slot_cur-&gt;hotplug_slot, &amp;info-&gt;max_adapter_speed_status, 0);
)brace
id|bus_speed
op_assign
id|slot_cur-&gt;bus_on-&gt;current_speed
suffix:semicolon
id|mode
op_assign
id|slot_cur-&gt;bus_on-&gt;current_bus_mode
suffix:semicolon
r_switch
c_cond
(paren
id|bus_speed
)paren
(brace
r_case
id|BUS_SPEED_33
suffix:colon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_66
suffix:colon
r_if
c_cond
(paren
id|mode
op_eq
id|BUS_MODE_PCIX
)paren
id|bus_speed
op_add_assign
l_int|0x01
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mode
op_eq
id|BUS_MODE_PCI
)paren
suffix:semicolon
r_else
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_100
suffix:colon
r_case
id|BUS_SPEED_133
suffix:colon
id|bus_speed
op_add_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
)brace
id|info-&gt;cur_bus_speed
op_assign
id|bus_speed
suffix:semicolon
id|info-&gt;max_bus_speed
op_assign
id|slot_cur-&gt;hotplug_slot-&gt;info-&gt;max_bus_speed
suffix:semicolon
singleline_comment|// To do: bus_names 
id|rc
op_assign
id|pci_hp_change_slot_info
(paren
id|slot_cur-&gt;hotplug_slot
comma
id|info
)paren
suffix:semicolon
id|kfree
(paren
id|info
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; * This function will return the pci_func, given bus and devfunc, or NULL.  It&n; * is called from visit routines&n; ******************************************************************************/
DECL|function|ibm_slot_find
r_static
r_struct
id|pci_func
op_star
id|ibm_slot_find
(paren
id|u8
id|busno
comma
id|u8
id|device
comma
id|u8
id|function
)paren
(brace
r_struct
id|pci_func
op_star
id|func_cur
suffix:semicolon
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
id|slot_cur
op_assign
id|list_entry
(paren
id|tmp
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;func
)paren
(brace
id|func_cur
op_assign
id|slot_cur-&gt;func
suffix:semicolon
r_while
c_loop
(paren
id|func_cur
)paren
(brace
r_if
c_cond
(paren
(paren
id|func_cur-&gt;busno
op_eq
id|busno
)paren
op_logical_and
(paren
id|func_cur-&gt;device
op_eq
id|device
)paren
op_logical_and
(paren
id|func_cur-&gt;function
op_eq
id|function
)paren
)paren
r_return
id|func_cur
suffix:semicolon
id|func_cur
op_assign
id|func_cur-&gt;next
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*************************************************************&n; * This routine frees up memory used by struct slot, including&n; * the pointers to pci_func, bus, hotplug_slot, controller,&n; * and deregistering from the hotplug core&n; *************************************************************/
DECL|function|free_slots
r_static
r_void
id|free_slots
(paren
r_void
)paren
(brace
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|next
suffix:semicolon
id|debug
(paren
l_string|&quot;%s -- enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|list_for_each_safe
(paren
id|tmp
comma
id|next
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
id|slot_cur
op_assign
id|list_entry
(paren
id|tmp
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
id|pci_hp_deregister
(paren
id|slot_cur-&gt;hotplug_slot
)paren
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;%s -- exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|ibm_unconfigure_device
r_static
r_void
id|ibm_unconfigure_device
c_func
(paren
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_struct
id|pci_dev
op_star
id|temp
suffix:semicolon
id|u8
id|j
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;inside %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;func-&gt;device = %x, func-&gt;function = %x&bslash;n&quot;
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;func-&gt;device &lt;&lt; 3 | 0x0  = %x&bslash;n&quot;
comma
id|func-&gt;device
op_lshift
l_int|3
op_or
l_int|0x0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|0x08
suffix:semicolon
id|j
op_increment
)paren
(brace
id|temp
op_assign
id|pci_find_slot
c_func
(paren
id|func-&gt;busno
comma
(paren
id|func-&gt;device
op_lshift
l_int|3
)paren
op_or
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
)paren
id|pci_remove_bus_device
c_func
(paren
id|temp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The following function is to fix kernel bug regarding &n; * getting bus entries, here we manually add those primary &n; * bus entries to kernel bus structure whenever apply&n; */
DECL|function|bus_structure_fixup
r_static
id|u8
id|bus_structure_fixup
(paren
id|u8
id|busno
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|u16
id|l
suffix:semicolon
r_if
c_cond
(paren
id|pci_find_bus
c_func
(paren
l_int|0
comma
id|busno
)paren
op_logical_or
op_logical_neg
(paren
id|ibmphp_find_same_bus_num
(paren
id|busno
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|bus
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|bus
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|err
(paren
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dev
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|kfree
(paren
id|bus
)paren
suffix:semicolon
id|err
(paren
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|bus-&gt;number
op_assign
id|busno
suffix:semicolon
id|bus-&gt;ops
op_assign
id|ibmphp_pci_bus-&gt;ops
suffix:semicolon
id|dev-&gt;bus
op_assign
id|bus
suffix:semicolon
r_for
c_loop
(paren
id|dev-&gt;devfn
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;devfn
OL
l_int|256
suffix:semicolon
id|dev-&gt;devfn
op_add_assign
l_int|8
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pci_read_config_word
(paren
id|dev
comma
id|PCI_VENDOR_ID
comma
op_amp
id|l
)paren
op_logical_and
id|l
op_ne
l_int|0x0000
op_logical_and
id|l
op_ne
l_int|0xffff
)paren
(brace
id|debug
(paren
l_string|&quot;%s - Inside bus_struture_fixup()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|pci_scan_bus
(paren
id|busno
comma
id|ibmphp_pci_bus-&gt;ops
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|kfree
(paren
id|dev
)paren
suffix:semicolon
id|kfree
(paren
id|bus
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibm_configure_device
r_static
r_int
id|ibm_configure_device
(paren
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_int
r_char
id|bus
suffix:semicolon
r_struct
id|pci_bus
op_star
id|child
suffix:semicolon
r_int
id|num
suffix:semicolon
r_int
id|flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this is to make sure we don&squot;t double scan the bus, for bridged devices primarily */
r_if
c_cond
(paren
op_logical_neg
(paren
id|bus_structure_fixup
(paren
id|func-&gt;busno
)paren
)paren
)paren
id|flag
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;dev
op_eq
l_int|NULL
)paren
id|func-&gt;dev
op_assign
id|pci_find_slot
(paren
id|func-&gt;busno
comma
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;dev
op_eq
l_int|NULL
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
op_assign
id|pci_find_bus
c_func
(paren
l_int|0
comma
id|func-&gt;busno
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
r_return
l_int|0
suffix:semicolon
id|num
op_assign
id|pci_scan_slot
c_func
(paren
id|bus
comma
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num
)paren
id|pci_bus_add_devices
c_func
(paren
id|bus
)paren
suffix:semicolon
id|func-&gt;dev
op_assign
id|pci_find_slot
c_func
(paren
id|func-&gt;busno
comma
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;dev
op_eq
l_int|NULL
)paren
(brace
id|err
(paren
l_string|&quot;ERROR... : pci_dev still NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|flag
)paren
op_logical_and
(paren
id|func-&gt;dev-&gt;hdr_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
)paren
(brace
id|pci_read_config_byte
(paren
id|func-&gt;dev
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|bus
)paren
suffix:semicolon
id|child
op_assign
(paren
r_struct
id|pci_bus
op_star
)paren
id|pci_add_new_bus
(paren
id|func-&gt;dev-&gt;bus
comma
(paren
id|func-&gt;dev
)paren
comma
id|bus
)paren
suffix:semicolon
id|pci_do_scan_bus
(paren
id|child
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*******************************************************&n; * Returns whether the bus is empty or not &n; *******************************************************/
DECL|function|is_bus_empty
r_static
r_int
id|is_bus_empty
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|slot
op_star
id|tmp_slot
suffix:semicolon
id|u8
id|i
op_assign
id|slot_cur-&gt;bus_on-&gt;slot_min
suffix:semicolon
r_while
c_loop
(paren
id|i
op_le
id|slot_cur-&gt;bus_on-&gt;slot_max
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|slot_cur-&gt;number
)paren
(brace
id|i
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|tmp_slot
op_assign
id|ibmphp_get_slot_from_physical_num
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp_slot
)paren
r_return
l_int|0
suffix:semicolon
id|rc
op_assign
id|slot_update
(paren
op_amp
id|tmp_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SLOT_PRESENT
(paren
id|tmp_slot-&gt;status
)paren
op_logical_and
id|SLOT_PWRGD
(paren
id|tmp_slot-&gt;status
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/***********************************************************&n; * If the HPC permits and the bus currently empty, tries to set the &n; * bus speed and mode at the maximum card and bus capability&n; * Parameters: slot&n; * Returns: bus is set (0) or error code&n; ***********************************************************/
DECL|function|set_bus
r_static
r_int
id|set_bus
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u8
id|speed
suffix:semicolon
id|u8
id|cmd
op_assign
l_int|0x0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - entry slot # %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_cur-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SET_BUS_STATUS
(paren
id|slot_cur-&gt;ctrl
)paren
op_logical_and
id|is_bus_empty
(paren
id|slot_cur
)paren
)paren
(brace
id|rc
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|speed
op_assign
id|SLOT_SPEED
(paren
id|slot_cur-&gt;ext_status
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;ext_status = %x, speed = %x&bslash;n&quot;
comma
id|slot_cur-&gt;ext_status
comma
id|speed
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
id|HPC_SLOT_SPEED_33
suffix:colon
id|cmd
op_assign
id|HPC_BUS_33CONVMODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_SLOT_SPEED_66
suffix:colon
r_if
c_cond
(paren
id|SLOT_PCIX
(paren
id|slot_cur-&gt;ext_status
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|slot_cur-&gt;supported_speed
op_ge
id|BUS_SPEED_66
)paren
op_logical_and
(paren
id|slot_cur-&gt;supported_bus_mode
op_eq
id|BUS_MODE_PCIX
)paren
)paren
id|cmd
op_assign
id|HPC_BUS_66PCIXMODE
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|SLOT_BUS_MODE
(paren
id|slot_cur-&gt;ext_status
)paren
)paren
multiline_comment|/* if max slot/bus capability is 66 pci&n;&t;&t;&t;&t;&t;and there&squot;s no bus mode mismatch, then&n;&t;&t;&t;&t;&t;the adapter supports 66 pci */
id|cmd
op_assign
id|HPC_BUS_66CONVMODE
suffix:semicolon
r_else
id|cmd
op_assign
id|HPC_BUS_33CONVMODE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|slot_cur-&gt;supported_speed
op_ge
id|BUS_SPEED_66
)paren
id|cmd
op_assign
id|HPC_BUS_66CONVMODE
suffix:semicolon
r_else
id|cmd
op_assign
id|HPC_BUS_33CONVMODE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HPC_SLOT_SPEED_133
suffix:colon
r_switch
c_cond
(paren
id|slot_cur-&gt;supported_speed
)paren
(brace
r_case
id|BUS_SPEED_33
suffix:colon
id|cmd
op_assign
id|HPC_BUS_33CONVMODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_66
suffix:colon
r_if
c_cond
(paren
id|slot_cur-&gt;supported_bus_mode
op_eq
id|BUS_MODE_PCIX
)paren
id|cmd
op_assign
id|HPC_BUS_66PCIXMODE
suffix:semicolon
r_else
id|cmd
op_assign
id|HPC_BUS_66CONVMODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_100
suffix:colon
id|cmd
op_assign
id|HPC_BUS_100PCIXMODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_133
suffix:colon
multiline_comment|/* This is to take care of the bug in CIOBX chip */
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SERVERWORKS
comma
l_int|0x0101
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
id|ibmphp_hpc_writeslot
(paren
id|slot_cur
comma
id|HPC_BUS_100PCIXMODE
)paren
suffix:semicolon
id|cmd
op_assign
id|HPC_BUS_133PCIXMODE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
(paren
l_string|&quot;Wrong bus speed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|err
(paren
l_string|&quot;wrong slot speed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;setting bus speed for slot %d, cmd %x&bslash;n&quot;
comma
id|slot_cur-&gt;number
comma
id|cmd
)paren
suffix:semicolon
id|retval
op_assign
id|ibmphp_hpc_writeslot
(paren
id|slot_cur
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
(paren
l_string|&quot;setting bus speed failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CTLR_RESULT
(paren
id|slot_cur-&gt;ctrl-&gt;status
)paren
)paren
(brace
id|err
(paren
l_string|&quot;command not completed successfully in set_bus&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
multiline_comment|/* This is for x440, once Brandon fixes the firmware, &n;&t;will not need this delay */
id|long_delay
(paren
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s -Exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This routine checks the bus limitations that the slot is on from the BIOS.&n; * This is used in deciding whether or not to power up the slot.  &n; * (electrical/spec limitations. For example, &gt;1 133 MHz or &gt;2 66 PCI cards on&n; * same bus) &n; * Parameters: slot&n; * Returns: 0 = no limitations, -EINVAL = exceeded limitations on the bus&n; */
DECL|function|check_limitations
r_static
r_int
id|check_limitations
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
id|u8
id|i
suffix:semicolon
r_struct
id|slot
op_star
id|tmp_slot
suffix:semicolon
id|u8
id|count
op_assign
l_int|0
suffix:semicolon
id|u8
id|limitation
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|slot_cur-&gt;bus_on-&gt;slot_min
suffix:semicolon
id|i
op_le
id|slot_cur-&gt;bus_on-&gt;slot_max
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp_slot
op_assign
id|ibmphp_get_slot_from_physical_num
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp_slot
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SLOT_PWRGD
(paren
id|tmp_slot-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_CONNECT
(paren
id|tmp_slot-&gt;status
)paren
)paren
)paren
id|count
op_increment
suffix:semicolon
)brace
id|get_cur_bus_info
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|slot_cur-&gt;bus_on-&gt;current_speed
)paren
(brace
r_case
id|BUS_SPEED_33
suffix:colon
id|limitation
op_assign
id|slot_cur-&gt;bus_on-&gt;slots_at_33_conv
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_66
suffix:colon
r_if
c_cond
(paren
id|slot_cur-&gt;bus_on-&gt;current_bus_mode
op_eq
id|BUS_MODE_PCIX
)paren
id|limitation
op_assign
id|slot_cur-&gt;bus_on-&gt;slots_at_66_pcix
suffix:semicolon
r_else
id|limitation
op_assign
id|slot_cur-&gt;bus_on-&gt;slots_at_66_conv
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_100
suffix:colon
id|limitation
op_assign
id|slot_cur-&gt;bus_on-&gt;slots_at_100_pcix
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_SPEED_133
suffix:colon
id|limitation
op_assign
id|slot_cur-&gt;bus_on-&gt;slots_at_133_pcix
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|count
op_plus
l_int|1
)paren
OG
id|limitation
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|print_card_capability
r_static
r_inline
r_void
id|print_card_capability
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
id|info
(paren
l_string|&quot;capability of the card is &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slot_cur-&gt;ext_status
op_amp
id|CARD_INFO
)paren
op_eq
id|PCIX133
)paren
id|info
(paren
l_string|&quot;   133 MHz PCI-X&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_cur-&gt;ext_status
op_amp
id|CARD_INFO
)paren
op_eq
id|PCIX66
)paren
id|info
(paren
l_string|&quot;    66 MHz PCI-X&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_cur-&gt;ext_status
op_amp
id|CARD_INFO
)paren
op_eq
id|PCI66
)paren
id|info
(paren
l_string|&quot;    66 MHz PCI&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|info
(paren
l_string|&quot;    33 MHz PCI&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* This routine will power on the slot, configure the device(s) and find the&n; * drivers for them.&n; * Parameters: hotplug_slot&n; * Returns: 0 or failure codes&n; */
DECL|function|enable_slot
r_static
r_int
id|enable_slot
(paren
r_struct
id|hotplug_slot
op_star
id|hs
)paren
(brace
r_int
id|rc
comma
id|i
comma
id|rcpr
suffix:semicolon
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
id|u8
id|function
suffix:semicolon
r_struct
id|pci_func
op_star
id|tmp_func
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;ENABLING SLOT........&bslash;n&quot;
)paren
suffix:semicolon
id|slot_cur
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hs
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|validate
(paren
id|slot_cur
comma
id|ENABLE
)paren
)paren
)paren
(brace
id|err
(paren
l_string|&quot;validate function failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_nopower
suffix:semicolon
)brace
id|attn_LED_blink
(paren
id|slot_cur
)paren
suffix:semicolon
id|rc
op_assign
id|set_bus
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;was not able to set the bus&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_nopower
suffix:semicolon
)brace
multiline_comment|/*-----------------debugging------------------------------*/
id|get_cur_bus_info
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;the current bus speed right after set_bus = %x&bslash;n&quot;
comma
id|slot_cur-&gt;bus_on-&gt;current_speed
)paren
suffix:semicolon
multiline_comment|/*----------------------------------------------------------*/
id|rc
op_assign
id|check_limitations
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;Adding this card exceeds the limitations of this bus.&bslash;n&quot;
)paren
suffix:semicolon
id|err
(paren
l_string|&quot;(i.e., &gt;1 133MHz cards running on same bus, or &quot;
l_string|&quot;&gt;2 66 PCI cards running on same bus&bslash;n.&quot;
)paren
suffix:semicolon
id|err
(paren
l_string|&quot;Try hot-adding into another bus&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error_nopower
suffix:semicolon
)brace
id|rc
op_assign
id|power_on
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;something wrong when powering up... please see below for details&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* need to turn off before on, otherwise, blinking overwrites */
id|attn_off
c_func
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* Check to see the error of why it failed */
r_if
c_cond
(paren
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_PWRGD
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
id|err
(paren
l_string|&quot;power fault occurred trying to power up&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|SLOT_BUS_SPEED
(paren
id|slot_cur-&gt;status
)paren
)paren
(brace
id|err
(paren
l_string|&quot;bus speed mismatch occurred.  please check current bus speed and card capability&bslash;n&quot;
)paren
suffix:semicolon
id|print_card_capability
(paren
id|slot_cur
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SLOT_BUS_MODE
(paren
id|slot_cur-&gt;ext_status
)paren
)paren
(brace
id|err
(paren
l_string|&quot;bus mode mismatch occurred.  please check current bus mode and card capability&bslash;n&quot;
)paren
suffix:semicolon
id|print_card_capability
(paren
id|slot_cur
)paren
suffix:semicolon
)brace
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;after power_on&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*-----------------------debugging---------------------------*/
id|get_cur_bus_info
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;the current bus speed right after power_on = %x&bslash;n&quot;
comma
id|slot_cur-&gt;bus_on-&gt;current_speed
)paren
suffix:semicolon
multiline_comment|/*----------------------------------------------------------*/
id|rc
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|error_power
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_PWRGD
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
(brace
id|err
(paren
l_string|&quot;power fault occurred trying to power up...&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_power
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
op_logical_and
(paren
id|SLOT_BUS_SPEED
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
(brace
id|err
(paren
l_string|&quot;bus speed mismatch occurred.  please check current bus speed and card capability&bslash;n&quot;
)paren
suffix:semicolon
id|print_card_capability
(paren
id|slot_cur
)paren
suffix:semicolon
r_goto
id|error_power
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t think this case will happen after above checks... but just in case, for paranoia sake */
r_if
c_cond
(paren
op_logical_neg
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
(brace
id|err
(paren
l_string|&quot;power on failed...&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_power
suffix:semicolon
)brace
id|slot_cur-&gt;func
op_assign
(paren
r_struct
id|pci_func
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|pci_func
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_cur-&gt;func
)paren
(brace
multiline_comment|/* We cannot do update_slot_info here, since no memory for&n;&t;&t; * kmalloc n.e.ways, and update_slot_info allocates some */
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error_power
suffix:semicolon
)brace
id|memset
(paren
id|slot_cur-&gt;func
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|slot_cur-&gt;func-&gt;busno
op_assign
id|slot_cur-&gt;bus
suffix:semicolon
id|slot_cur-&gt;func-&gt;device
op_assign
id|slot_cur-&gt;device
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|slot_cur-&gt;func-&gt;irq
(braket
id|i
)braket
op_assign
id|slot_cur-&gt;irq
(braket
id|i
)braket
suffix:semicolon
id|debug
(paren
l_string|&quot;b4 configure_card, slot_cur-&gt;bus = %x, slot_cur-&gt;device = %x&bslash;n&quot;
comma
id|slot_cur-&gt;bus
comma
id|slot_cur-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_configure_card
(paren
id|slot_cur-&gt;func
comma
id|slot_cur-&gt;number
)paren
)paren
(brace
id|err
(paren
l_string|&quot;configure_card was unsuccessful...&bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_unconfigure_card
(paren
op_amp
id|slot_cur
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* true because don&squot;t need to actually deallocate resources, just remove references */
id|debug
(paren
l_string|&quot;after unconfigure_card&bslash;n&quot;
)paren
suffix:semicolon
id|slot_cur-&gt;func
op_assign
l_int|NULL
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error_power
suffix:semicolon
)brace
id|function
op_assign
l_int|0x00
suffix:semicolon
r_do
(brace
id|tmp_func
op_assign
id|ibm_slot_find
(paren
id|slot_cur-&gt;bus
comma
id|slot_cur-&gt;func-&gt;device
comma
id|function
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_func
op_logical_and
op_logical_neg
(paren
id|tmp_func-&gt;dev
)paren
)paren
id|ibm_configure_device
(paren
id|tmp_func
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tmp_func
)paren
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|ibmphp_print_test
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
m_exit
suffix:colon
id|ibmphp_unlock_operations
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
id|error_nopower
suffix:colon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
multiline_comment|/* need to turn off if was blinking b4 */
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|error_cont
suffix:colon
id|rcpr
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcpr
)paren
(brace
id|rc
op_assign
id|rcpr
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
id|error_power
suffix:colon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
multiline_comment|/* need to turn off if was blinking b4 */
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|rcpr
op_assign
id|power_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcpr
)paren
(brace
id|rc
op_assign
id|rcpr
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_goto
id|error_cont
suffix:semicolon
)brace
multiline_comment|/**************************************************************&n;* HOT REMOVING ADAPTER CARD                                   *&n;* INPUT: POINTER TO THE HOTPLUG SLOT STRUCTURE                *&n;* OUTPUT: SUCCESS 0 ; FAILURE: UNCONFIGURE , VALIDATE         *&n;          DISABLE POWER ,                                    *&n;**************************************************************/
DECL|function|ibmphp_disable_slot
r_int
id|ibmphp_disable_slot
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ibmphp_lock_operations
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_do_disable_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
id|ibmphp_unlock_operations
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ibmphp_do_disable_slot
r_int
id|ibmphp_do_disable_slot
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u8
id|flag
suffix:semicolon
id|debug
(paren
l_string|&quot;DISABLING SLOT...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slot_cur
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|slot_cur-&gt;ctrl
op_eq
l_int|NULL
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|flag
op_assign
id|slot_cur-&gt;flag
suffix:semicolon
id|slot_cur-&gt;flag
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|TRUE
)paren
(brace
id|rc
op_assign
id|validate
(paren
id|slot_cur
comma
id|DISABLE
)paren
suffix:semicolon
multiline_comment|/* checking if powered off already &amp; valid slot # */
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|error
suffix:semicolon
)brace
id|attn_LED_blink
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;func
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* We need this for fncs&squot;s that were there on bootup */
id|slot_cur-&gt;func
op_assign
(paren
r_struct
id|pci_func
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|pci_func
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_cur-&gt;func
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|slot_cur-&gt;func
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|slot_cur-&gt;func-&gt;busno
op_assign
id|slot_cur-&gt;bus
suffix:semicolon
id|slot_cur-&gt;func-&gt;device
op_assign
id|slot_cur-&gt;device
suffix:semicolon
)brace
id|ibm_unconfigure_device
c_func
(paren
id|slot_cur-&gt;func
)paren
suffix:semicolon
multiline_comment|/* If we got here from latch suddenly opening on operating card or &n;&t;a power fault, there&squot;s no power to the card, so cannot&n;&t;read from it to determine what resources it occupied.  This operation&n;&t;is forbidden anyhow.  The best we can do is remove it from kernel&n;&t;lists at least */
r_if
c_cond
(paren
op_logical_neg
id|flag
)paren
(brace
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|rc
op_assign
id|ibmphp_unconfigure_card
(paren
op_amp
id|slot_cur
comma
l_int|0
)paren
suffix:semicolon
id|slot_cur-&gt;func
op_assign
l_int|NULL
suffix:semicolon
id|debug
(paren
l_string|&quot;in disable_slot. after unconfigure_card&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;could not unconfigure card.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|rc
op_assign
id|ibmphp_hpc_writeslot
(paren
id|slot_cur
comma
id|HPC_SLOT_OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|error
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|rc
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
m_exit
suffix:semicolon
id|rc
op_assign
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_print_test
(paren
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|rc
suffix:semicolon
id|error
suffix:colon
multiline_comment|/*  Need to turn off if was blinking b4 */
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
)paren
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
DECL|variable|ibmphp_hotplug_slot_ops
r_struct
id|hotplug_slot_ops
id|ibmphp_hotplug_slot_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|set_attention_status
op_assign
id|set_attention_status
comma
dot
id|enable_slot
op_assign
id|enable_slot
comma
dot
id|disable_slot
op_assign
id|ibmphp_disable_slot
comma
dot
id|hardware_test
op_assign
l_int|NULL
comma
dot
id|get_power_status
op_assign
id|get_power_status
comma
dot
id|get_attention_status
op_assign
id|get_attention_status
comma
dot
id|get_latch_status
op_assign
id|get_latch_status
comma
dot
id|get_adapter_status
op_assign
id|get_adapter_present
comma
dot
id|get_max_bus_speed
op_assign
id|get_max_bus_speed
comma
dot
id|get_cur_bus_speed
op_assign
id|get_cur_bus_speed
comma
multiline_comment|/*&t;.get_max_adapter_speed =&t;get_max_adapter_speed,&n;&t;.get_bus_name_status =&t;&t;get_bus_name,&n;*/
)brace
suffix:semicolon
DECL|function|ibmphp_unload
r_static
r_void
id|ibmphp_unload
(paren
r_void
)paren
(brace
id|free_slots
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after slots&bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_free_resources
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after resources&bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_free_bus_info_queue
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after bus info&bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_free_ebda_hpc_queue
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after ebda hpc&bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_free_ebda_pci_rsrc_queue
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after ebda pci rsrc&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|ibmphp_pci_bus
)paren
suffix:semicolon
)brace
DECL|function|ibmphp_init
r_static
r_int
id|__init
id|ibmphp_init
(paren
r_void
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|init_flag
op_assign
l_int|1
suffix:semicolon
id|info
(paren
id|DRIVER_DESC
l_string|&quot; version: &quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_pci_bus
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|ibmphp_pci_bus
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ibmphp_pci_bus
)paren
(brace
id|err
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|bus
op_assign
id|pci_find_bus
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|err
(paren
l_string|&quot;Can&squot;t find the root pci bus, can not continue&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memcpy
(paren
id|ibmphp_pci_bus
comma
id|bus
comma
r_sizeof
(paren
op_star
id|ibmphp_pci_bus
)paren
)paren
suffix:semicolon
id|ibmphp_debug
op_assign
id|debug
suffix:semicolon
id|ibmphp_hpc_initvars
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|irqs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibmphp_access_ebda
(paren
)paren
)paren
)paren
r_goto
id|error
suffix:semicolon
id|debug
(paren
l_string|&quot;after ibmphp_access_ebda ()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibmphp_rsrc_init
(paren
)paren
)paren
)paren
r_goto
id|error
suffix:semicolon
id|debug
(paren
l_string|&quot;AFTER Resource &amp; EBDA INITIALIZATIONS&bslash;n&quot;
)paren
suffix:semicolon
id|max_slots
op_assign
id|get_max_slots
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibmphp_register_pci
(paren
)paren
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|init_ops
(paren
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ibmphp_print_test
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibmphp_hpc_start_poll_thread
(paren
)paren
)paren
)paren
(brace
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* lock ourselves into memory with a module &n;&t; * count of -1 so that no one can unload us. */
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|rc
suffix:semicolon
id|error
suffix:colon
id|ibmphp_unload
(paren
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
DECL|function|ibmphp_exit
r_static
r_void
id|__exit
id|ibmphp_exit
(paren
r_void
)paren
(brace
id|ibmphp_hpc_stop_poll_thread
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after polling&bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_unload
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|ibmphp_init
id|module_init
(paren
id|ibmphp_init
)paren
suffix:semicolon
DECL|variable|ibmphp_exit
id|module_exit
(paren
id|ibmphp_exit
)paren
suffix:semicolon
eof
