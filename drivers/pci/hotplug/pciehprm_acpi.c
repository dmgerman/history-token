multiline_comment|/*&n; * PCIEHPRM ACPI: PHP Resource Manager for ACPI platform&n; *&n; * Copyright (C) 2003-2004 Intel Corporation&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;dely.l.sy@intel.com&gt;&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;linux/efi.h&gt;
macro_line|#include &lt;linux/pci-acpi.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#ifdef&t;CONFIG_IA64
macro_line|#include &lt;asm/iosapic.h&gt;
macro_line|#endif
macro_line|#include &lt;acpi/acpi.h&gt;
macro_line|#include &lt;acpi/acpi_bus.h&gt;
macro_line|#include &lt;acpi/actypes.h&gt;
macro_line|#include &quot;pciehp.h&quot;
macro_line|#include &quot;pciehprm.h&quot;
DECL|macro|PCI_MAX_BUS
mdefine_line|#define&t;PCI_MAX_BUS&t;&t;0x100
DECL|macro|ACPI_STA_DEVICE_PRESENT
mdefine_line|#define&t;ACPI_STA_DEVICE_PRESENT&t;0x01
DECL|macro|METHOD_NAME__SUN
mdefine_line|#define&t;METHOD_NAME__SUN&t;&quot;_SUN&quot;
DECL|macro|METHOD_NAME__HPP
mdefine_line|#define&t;METHOD_NAME__HPP&t;&quot;_HPP&quot;
DECL|macro|METHOD_NAME_OSHP
mdefine_line|#define&t;METHOD_NAME_OSHP&t;&quot;OSHP&quot;
multiline_comment|/* Status code for running acpi method to gain native control */
DECL|macro|NC_NOT_RUN
mdefine_line|#define NC_NOT_RUN&t;0
DECL|macro|OSC_NOT_EXIST
mdefine_line|#define OSC_NOT_EXIST&t;1
DECL|macro|OSC_RUN_FAILED
mdefine_line|#define OSC_RUN_FAILED&t;2
DECL|macro|OSHP_NOT_EXIST
mdefine_line|#define OSHP_NOT_EXIST&t;3
DECL|macro|OSHP_RUN_FAILED
mdefine_line|#define OSHP_RUN_FAILED&t;4
DECL|macro|NC_RUN_SUCCESS
mdefine_line|#define NC_RUN_SUCCESS&t;5
DECL|macro|PHP_RES_BUS
mdefine_line|#define&t;PHP_RES_BUS&t;&t;0xA0
DECL|macro|PHP_RES_IO
mdefine_line|#define&t;PHP_RES_IO&t;&t;0xA1
DECL|macro|PHP_RES_MEM
mdefine_line|#define&t;PHP_RES_MEM&t;&t;0xA2
DECL|macro|PHP_RES_PMEM
mdefine_line|#define&t;PHP_RES_PMEM&t;&t;0xA3
DECL|macro|BRIDGE_TYPE_P2P
mdefine_line|#define&t;BRIDGE_TYPE_P2P&t;&t;0x00
DECL|macro|BRIDGE_TYPE_HOST
mdefine_line|#define&t;BRIDGE_TYPE_HOST&t;0x01
multiline_comment|/* this should go to drivers/acpi/include/ */
DECL|struct|acpi__hpp
r_struct
id|acpi__hpp
(brace
DECL|member|cache_line_size
id|u8
id|cache_line_size
suffix:semicolon
DECL|member|latency_timer
id|u8
id|latency_timer
suffix:semicolon
DECL|member|enable_serr
id|u8
id|enable_serr
suffix:semicolon
DECL|member|enable_perr
id|u8
id|enable_perr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_php_slot
r_struct
id|acpi_php_slot
(brace
DECL|member|next
r_struct
id|acpi_php_slot
op_star
id|next
suffix:semicolon
DECL|member|bridge
r_struct
id|acpi_bridge
op_star
id|bridge
suffix:semicolon
DECL|member|handle
id|acpi_handle
id|handle
suffix:semicolon
DECL|member|seg
r_int
id|seg
suffix:semicolon
DECL|member|bus
r_int
id|bus
suffix:semicolon
DECL|member|dev
r_int
id|dev
suffix:semicolon
DECL|member|fun
r_int
id|fun
suffix:semicolon
DECL|member|sun
id|u32
id|sun
suffix:semicolon
DECL|member|mem_head
r_struct
id|pci_resource
op_star
id|mem_head
suffix:semicolon
DECL|member|p_mem_head
r_struct
id|pci_resource
op_star
id|p_mem_head
suffix:semicolon
DECL|member|io_head
r_struct
id|pci_resource
op_star
id|io_head
suffix:semicolon
DECL|member|bus_head
r_struct
id|pci_resource
op_star
id|bus_head
suffix:semicolon
DECL|member|slot_ops
r_void
op_star
id|slot_ops
suffix:semicolon
multiline_comment|/* _STA, _EJx, etc */
DECL|member|slot
r_struct
id|slot
op_star
id|slot
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* per func */
DECL|struct|acpi_bridge
r_struct
id|acpi_bridge
(brace
DECL|member|parent
r_struct
id|acpi_bridge
op_star
id|parent
suffix:semicolon
DECL|member|next
r_struct
id|acpi_bridge
op_star
id|next
suffix:semicolon
DECL|member|child
r_struct
id|acpi_bridge
op_star
id|child
suffix:semicolon
DECL|member|handle
id|acpi_handle
id|handle
suffix:semicolon
DECL|member|seg
r_int
id|seg
suffix:semicolon
DECL|member|pbus
r_int
id|pbus
suffix:semicolon
multiline_comment|/* pdev-&gt;bus-&gt;number&t;&t;*/
DECL|member|pdevice
r_int
id|pdevice
suffix:semicolon
multiline_comment|/* PCI_SLOT(pdev-&gt;devfn)&t;*/
DECL|member|pfunction
r_int
id|pfunction
suffix:semicolon
multiline_comment|/* PCI_DEVFN(pdev-&gt;devfn)&t;*/
DECL|member|bus
r_int
id|bus
suffix:semicolon
multiline_comment|/* pdev-&gt;subordinate-&gt;number&t;*/
DECL|member|_hpp
r_struct
id|acpi__hpp
op_star
id|_hpp
suffix:semicolon
DECL|member|slots
r_struct
id|acpi_php_slot
op_star
id|slots
suffix:semicolon
DECL|member|tmem_head
r_struct
id|pci_resource
op_star
id|tmem_head
suffix:semicolon
multiline_comment|/* total from crs&t;*/
DECL|member|tp_mem_head
r_struct
id|pci_resource
op_star
id|tp_mem_head
suffix:semicolon
multiline_comment|/* total from crs&t;*/
DECL|member|tio_head
r_struct
id|pci_resource
op_star
id|tio_head
suffix:semicolon
multiline_comment|/* total from crs&t;*/
DECL|member|tbus_head
r_struct
id|pci_resource
op_star
id|tbus_head
suffix:semicolon
multiline_comment|/* total from crs&t;*/
DECL|member|mem_head
r_struct
id|pci_resource
op_star
id|mem_head
suffix:semicolon
multiline_comment|/* available&t;*/
DECL|member|p_mem_head
r_struct
id|pci_resource
op_star
id|p_mem_head
suffix:semicolon
multiline_comment|/* available&t;*/
DECL|member|io_head
r_struct
id|pci_resource
op_star
id|io_head
suffix:semicolon
multiline_comment|/* available&t;*/
DECL|member|bus_head
r_struct
id|pci_resource
op_star
id|bus_head
suffix:semicolon
multiline_comment|/* available&t;*/
DECL|member|scanned
r_int
id|scanned
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|acpi_bridges_head
r_static
r_struct
id|acpi_bridge
op_star
id|acpi_bridges_head
suffix:semicolon
DECL|function|acpi_path_name
r_static
id|u8
op_star
id|acpi_path_name
c_func
(paren
id|acpi_handle
id|handle
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_static
id|u8
id|path_name
(braket
id|ACPI_PATHNAME_MAX
)braket
suffix:semicolon
r_struct
id|acpi_buffer
id|ret_buf
op_assign
(brace
id|ACPI_PATHNAME_MAX
comma
id|path_name
)brace
suffix:semicolon
id|memset
c_func
(paren
id|path_name
comma
l_int|0
comma
r_sizeof
(paren
id|path_name
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_get_name
c_func
(paren
id|handle
comma
id|ACPI_FULL_PATHNAME
comma
op_amp
id|ret_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_else
r_return
id|path_name
suffix:semicolon
)brace
r_static
r_void
id|acpi_get__hpp
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
suffix:semicolon
r_static
r_int
id|acpi_run_oshp
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
suffix:semicolon
DECL|variable|osc_run_status
r_static
r_int
id|osc_run_status
op_assign
id|NC_NOT_RUN
suffix:semicolon
DECL|variable|oshp_run_status
r_static
r_int
id|oshp_run_status
op_assign
id|NC_NOT_RUN
suffix:semicolon
DECL|function|acpi_add_slot_to_php_slots
r_static
r_int
id|acpi_add_slot_to_php_slots
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
r_int
id|bus_num
comma
id|acpi_handle
id|handle
comma
id|u32
id|adr
comma
id|u32
id|sun
)paren
(brace
r_struct
id|acpi_php_slot
op_star
id|aps
suffix:semicolon
r_static
r_int
id|samesun
op_assign
op_minus
l_int|1
suffix:semicolon
id|aps
op_assign
(paren
r_struct
id|acpi_php_slot
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|acpi_php_slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aps
)paren
(brace
id|err
(paren
l_string|&quot;acpi_pciehprm: alloc for aps fail&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|aps
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_php_slot
)paren
)paren
suffix:semicolon
id|aps-&gt;handle
op_assign
id|handle
suffix:semicolon
id|aps-&gt;bus
op_assign
id|bus_num
suffix:semicolon
id|aps-&gt;dev
op_assign
(paren
id|adr
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|aps-&gt;fun
op_assign
id|adr
op_amp
l_int|0xffff
suffix:semicolon
id|aps-&gt;sun
op_assign
id|sun
suffix:semicolon
id|aps-&gt;next
op_assign
id|ab-&gt;slots
suffix:semicolon
multiline_comment|/* cling to the bridge */
id|aps-&gt;bridge
op_assign
id|ab
suffix:semicolon
id|ab-&gt;slots
op_assign
id|aps
suffix:semicolon
id|ab-&gt;scanned
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ab-&gt;_hpp
)paren
id|acpi_get__hpp
c_func
(paren
id|ab
)paren
suffix:semicolon
r_if
c_cond
(paren
id|osc_run_status
op_eq
id|OSC_NOT_EXIST
)paren
id|oshp_run_status
op_assign
id|acpi_run_oshp
c_func
(paren
id|ab
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun
op_ne
id|samesun
)paren
(brace
id|info
c_func
(paren
l_string|&quot;acpi_pciehprm:   Slot sun(%x) at s:b:d:f=0x%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|aps-&gt;sun
comma
id|ab-&gt;seg
comma
id|aps-&gt;bus
comma
id|aps-&gt;dev
comma
id|aps-&gt;fun
)paren
suffix:semicolon
id|samesun
op_assign
id|sun
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|acpi_get__hpp
r_static
r_void
id|acpi_get__hpp
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|u8
id|nui
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|acpi_buffer
id|ret_buf
op_assign
(brace
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
r_union
id|acpi_object
op_star
id|ext_obj
comma
op_star
id|package
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|ab-&gt;handle
)paren
suffix:semicolon
r_int
id|i
comma
id|len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* get _hpp */
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|ab-&gt;handle
comma
id|METHOD_NAME__HPP
comma
l_int|NULL
comma
op_amp
id|ret_buf
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|AE_BUFFER_OVERFLOW
suffix:colon
id|ret_buf.pointer
op_assign
id|kmalloc
(paren
id|ret_buf.length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret_buf.pointer
)paren
(brace
id|err
(paren
l_string|&quot;acpi_pciehprm:%s alloc for _HPP fail&bslash;n&quot;
comma
id|path_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|ab-&gt;handle
comma
id|METHOD_NAME__HPP
comma
l_int|NULL
comma
op_amp
id|ret_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s _HPP fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|ext_obj
op_assign
(paren
r_union
id|acpi_object
op_star
)paren
id|ret_buf.pointer
suffix:semicolon
r_if
c_cond
(paren
id|ext_obj-&gt;type
op_ne
id|ACPI_TYPE_PACKAGE
)paren
(brace
id|err
(paren
l_string|&quot;acpi_pciehprm:%s _HPP obj not a package&bslash;n&quot;
comma
id|path_name
)paren
suffix:semicolon
r_goto
id|free_and_return
suffix:semicolon
)brace
id|len
op_assign
id|ext_obj-&gt;package.count
suffix:semicolon
id|package
op_assign
(paren
r_union
id|acpi_object
op_star
)paren
id|ret_buf.pointer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|len
)paren
op_logical_or
(paren
id|i
OL
l_int|4
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ext_obj
op_assign
(paren
r_union
id|acpi_object
op_star
)paren
op_amp
id|package-&gt;package.elements
(braket
id|i
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|ext_obj-&gt;type
)paren
(brace
r_case
id|ACPI_TYPE_INTEGER
suffix:colon
id|nui
(braket
id|i
)braket
op_assign
(paren
id|u8
)paren
id|ext_obj-&gt;integer.value
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
(paren
l_string|&quot;acpi_pciehprm:%s _HPP obj type incorrect&bslash;n&quot;
comma
id|path_name
)paren
suffix:semicolon
r_goto
id|free_and_return
suffix:semicolon
)brace
)brace
id|ab-&gt;_hpp
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|acpi__hpp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ab-&gt;_hpp
)paren
(brace
id|err
(paren
l_string|&quot;acpi_pciehprm:%s alloc for _HPP failed&bslash;n&quot;
comma
id|path_name
)paren
suffix:semicolon
r_goto
id|free_and_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ab-&gt;_hpp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi__hpp
)paren
)paren
suffix:semicolon
id|ab-&gt;_hpp-&gt;cache_line_size
op_assign
id|nui
(braket
l_int|0
)braket
suffix:semicolon
id|ab-&gt;_hpp-&gt;latency_timer
op_assign
id|nui
(braket
l_int|1
)braket
suffix:semicolon
id|ab-&gt;_hpp-&gt;enable_serr
op_assign
id|nui
(braket
l_int|2
)braket
suffix:semicolon
id|ab-&gt;_hpp-&gt;enable_perr
op_assign
id|nui
(braket
l_int|3
)braket
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  _HPP: cache_line_size=0x%x&bslash;n&quot;
comma
id|ab-&gt;_hpp-&gt;cache_line_size
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  _HPP: latency timer  =0x%x&bslash;n&quot;
comma
id|ab-&gt;_hpp-&gt;latency_timer
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  _HPP: enable SERR    =0x%x&bslash;n&quot;
comma
id|ab-&gt;_hpp-&gt;enable_serr
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  _HPP: enable PERR    =0x%x&bslash;n&quot;
comma
id|ab-&gt;_hpp-&gt;enable_perr
)paren
suffix:semicolon
id|free_and_return
suffix:colon
id|kfree
c_func
(paren
id|ret_buf.pointer
)paren
suffix:semicolon
)brace
DECL|function|acpi_run_oshp
r_static
r_int
id|acpi_run_oshp
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|ab-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* run OSHP */
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|ab-&gt;handle
comma
id|METHOD_NAME_OSHP
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s OSHP fails=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
id|oshp_run_status
op_assign
(paren
id|status
op_eq
id|AE_NOT_FOUND
)paren
ques
c_cond
id|OSHP_NOT_EXIST
suffix:colon
id|OSHP_RUN_FAILED
suffix:semicolon
)brace
r_else
(brace
id|oshp_run_status
op_assign
id|NC_RUN_SUCCESS
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:%s OSHP passes =0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:%s oshp_run_status =0x%x&bslash;n&quot;
comma
id|path_name
comma
id|oshp_run_status
)paren
suffix:semicolon
)brace
r_return
id|oshp_run_status
suffix:semicolon
)brace
DECL|function|acpi_evaluate_crs
r_static
id|acpi_status
id|acpi_evaluate_crs
c_func
(paren
id|acpi_handle
id|handle
comma
r_struct
id|acpi_resource
op_star
op_star
id|retbuf
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_buffer
id|crsbuf
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|handle
)paren
suffix:semicolon
id|crsbuf.length
op_assign
l_int|0
suffix:semicolon
id|crsbuf.pointer
op_assign
l_int|NULL
suffix:semicolon
id|status
op_assign
id|acpi_get_current_resources
(paren
id|handle
comma
op_amp
id|crsbuf
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|AE_BUFFER_OVERFLOW
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* found */
r_case
id|AE_NOT_FOUND
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:%s _CRS not found&bslash;n&quot;
comma
id|path_name
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
r_default
suffix:colon
id|err
(paren
l_string|&quot;acpi_pciehprm:%s _CRS fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|crsbuf.pointer
op_assign
id|kmalloc
(paren
id|crsbuf.length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|crsbuf.pointer
)paren
(brace
id|err
(paren
l_string|&quot;acpi_pciehprm: alloc %ld bytes for %s _CRS fail&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|crsbuf.length
comma
id|path_name
)paren
suffix:semicolon
r_return
id|AE_NO_MEMORY
suffix:semicolon
)brace
id|status
op_assign
id|acpi_get_current_resources
(paren
id|handle
comma
op_amp
id|crsbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm: %s _CRS fail=0x%x.&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|crsbuf.pointer
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
op_star
id|retbuf
op_assign
id|crsbuf.pointer
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|free_pci_resource
r_static
r_void
id|free_pci_resource
(paren
r_struct
id|pci_resource
op_star
id|aprh
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
id|aprh
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|next
)paren
(brace
id|next
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
)brace
)brace
DECL|function|print_pci_resource
r_static
r_void
id|print_pci_resource
(paren
r_struct
id|pci_resource
op_star
id|aprh
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
id|aprh
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
id|dbg
c_func
(paren
l_string|&quot;        base= 0x%x length= 0x%x&bslash;n&quot;
comma
id|res-&gt;base
comma
id|res-&gt;length
)paren
suffix:semicolon
)brace
DECL|function|print_slot_resources
r_static
r_void
id|print_slot_resources
c_func
(paren
r_struct
id|acpi_php_slot
op_star
id|aps
)paren
(brace
r_if
c_cond
(paren
id|aps-&gt;bus_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    BUS Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|aps-&gt;bus_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aps-&gt;io_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    IO Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|aps-&gt;io_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aps-&gt;mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    MEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|aps-&gt;mem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aps-&gt;p_mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    PMEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|aps-&gt;p_mem_head
)paren
suffix:semicolon
)brace
)brace
DECL|function|print_pci_resources
r_static
r_void
id|print_pci_resources
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_if
c_cond
(paren
id|ab-&gt;tbus_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    Total BUS Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ab-&gt;tbus_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;bus_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    BUS Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ab-&gt;bus_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;tio_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    Total IO Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ab-&gt;tio_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;io_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    IO Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ab-&gt;io_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;tmem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    Total MEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ab-&gt;tmem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    MEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ab-&gt;mem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;tp_mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    Total PMEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ab-&gt;tp_mem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;p_mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    PMEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ab-&gt;p_mem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;_hpp
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;    _HPP: cache_line_size=0x%x&bslash;n&quot;
comma
id|ab-&gt;_hpp-&gt;cache_line_size
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;    _HPP: latency timer  =0x%x&bslash;n&quot;
comma
id|ab-&gt;_hpp-&gt;latency_timer
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;    _HPP: enable SERR    =0x%x&bslash;n&quot;
comma
id|ab-&gt;_hpp-&gt;enable_serr
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;    _HPP: enable PERR    =0x%x&bslash;n&quot;
comma
id|ab-&gt;_hpp-&gt;enable_perr
)paren
suffix:semicolon
)brace
)brace
DECL|function|pciehprm_delete_resource
r_static
r_int
id|pciehprm_delete_resource
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|aprh
comma
id|ulong
id|base
comma
id|ulong
id|size
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_struct
id|pci_resource
op_star
id|prevnode
suffix:semicolon
r_struct
id|pci_resource
op_star
id|split_node
suffix:semicolon
id|ulong
id|tbase
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
id|aprh
)paren
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
op_star
id|aprh
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;base
OG
id|base
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;base
op_plus
id|res-&gt;length
)paren
OL
(paren
id|base
op_plus
id|size
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;base
OL
id|base
)paren
(brace
id|tbase
op_assign
id|base
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;length
op_minus
(paren
id|tbase
op_minus
id|res-&gt;base
)paren
)paren
OL
id|size
)paren
r_continue
suffix:semicolon
id|split_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|split_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|split_node-&gt;base
op_assign
id|res-&gt;base
suffix:semicolon
id|split_node-&gt;length
op_assign
id|tbase
op_minus
id|res-&gt;base
suffix:semicolon
id|res-&gt;base
op_assign
id|tbase
suffix:semicolon
id|res-&gt;length
op_sub_assign
id|split_node-&gt;length
suffix:semicolon
id|split_node-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
id|res-&gt;next
op_assign
id|split_node
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res-&gt;length
op_ge
id|size
)paren
(brace
id|split_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|split_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|split_node-&gt;base
op_assign
id|res-&gt;base
op_plus
id|size
suffix:semicolon
id|split_node-&gt;length
op_assign
id|res-&gt;length
op_minus
id|size
suffix:semicolon
id|res-&gt;length
op_assign
id|size
suffix:semicolon
id|split_node-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
id|res-&gt;next
op_assign
id|split_node
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|aprh
op_eq
id|res
)paren
(brace
op_star
id|aprh
op_assign
id|res-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|prevnode
op_assign
op_star
id|aprh
suffix:semicolon
r_while
c_loop
(paren
id|prevnode-&gt;next
op_ne
id|res
)paren
id|prevnode
op_assign
id|prevnode-&gt;next
suffix:semicolon
id|prevnode-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
)brace
id|res-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pciehprm_delete_resources
r_static
r_int
id|pciehprm_delete_resources
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|aprh
comma
r_struct
id|pci_resource
op_star
id|this
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
id|this
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
id|pciehprm_delete_resource
c_func
(paren
id|aprh
comma
id|res-&gt;base
comma
id|res-&gt;length
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pciehprm_add_resource
r_static
r_int
id|pciehprm_add_resource
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|aprh
comma
id|ulong
id|base
comma
id|ulong
id|size
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
op_star
id|aprh
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|res-&gt;base
op_plus
id|res-&gt;length
)paren
op_eq
id|base
)paren
(brace
id|res-&gt;length
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
l_int|0L
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res-&gt;next
op_eq
op_star
id|aprh
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
)paren
(brace
id|res
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|err
(paren
l_string|&quot;acpi_pciehprm: alloc for res fail&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|res
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_resource
)paren
)paren
suffix:semicolon
id|res-&gt;base
op_assign
id|base
suffix:semicolon
id|res-&gt;length
op_assign
id|size
suffix:semicolon
id|res-&gt;next
op_assign
op_star
id|aprh
suffix:semicolon
op_star
id|aprh
op_assign
id|res
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pciehprm_add_resources
r_static
r_int
id|pciehprm_add_resources
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|aprh
comma
r_struct
id|pci_resource
op_star
id|this
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
id|this
suffix:semicolon
id|res
op_logical_and
op_logical_neg
id|rc
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
id|rc
op_assign
id|pciehprm_add_resource
c_func
(paren
id|aprh
comma
id|res-&gt;base
comma
id|res-&gt;length
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|acpi_parse_io
r_static
r_void
id|acpi_parse_io
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
r_union
id|acpi_resource_data
op_star
id|data
)paren
(brace
r_struct
id|acpi_resource_io
op_star
id|dataio
suffix:semicolon
id|dataio
op_assign
(paren
r_struct
id|acpi_resource_io
op_star
)paren
id|data
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Io Resource&bslash;n&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  %d bit decode&bslash;n&quot;
comma
id|ACPI_DECODE_16
op_eq
id|dataio-&gt;io_decode
ques
c_cond
l_int|16
suffix:colon
l_int|10
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Range minimum base: %08X&bslash;n&quot;
comma
id|dataio-&gt;min_base_address
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Range maximum base: %08X&bslash;n&quot;
comma
id|dataio-&gt;max_base_address
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Alignment: %08X&bslash;n&quot;
comma
id|dataio-&gt;alignment
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Range Length: %08X&bslash;n&quot;
comma
id|dataio-&gt;range_length
)paren
suffix:semicolon
)brace
DECL|function|acpi_parse_fixed_io
r_static
r_void
id|acpi_parse_fixed_io
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
r_union
id|acpi_resource_data
op_star
id|data
)paren
(brace
r_struct
id|acpi_resource_fixed_io
op_star
id|datafio
suffix:semicolon
id|datafio
op_assign
(paren
r_struct
id|acpi_resource_fixed_io
op_star
)paren
id|data
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Fixed Io Resource&bslash;n&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Range base address: %08X&quot;
comma
id|datafio-&gt;base_address
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Range length: %08X&quot;
comma
id|datafio-&gt;range_length
)paren
suffix:semicolon
)brace
DECL|function|acpi_parse_address16_32
r_static
r_void
id|acpi_parse_address16_32
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
r_union
id|acpi_resource_data
op_star
id|data
comma
id|acpi_resource_type
id|id
)paren
(brace
multiline_comment|/* &n;&t; * acpi_resource_address16 == acpi_resource_address32&n;&t; * acpi_resource_address16 *data16 = (acpi_resource_address16 *) data;&n;&t; */
r_struct
id|acpi_resource_address32
op_star
id|data32
op_assign
(paren
r_struct
id|acpi_resource_address32
op_star
)paren
id|data
suffix:semicolon
r_struct
id|pci_resource
op_star
op_star
id|aprh
comma
op_star
op_star
id|tprh
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|ACPI_RSTYPE_ADDRESS16
)paren
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:16-Bit Address Space Resource&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:32-Bit Address Space Resource&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|data32-&gt;resource_type
)paren
(brace
r_case
id|ACPI_MEMORY_RANGE
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Resource Type: Memory Range&bslash;n&quot;
)paren
suffix:semicolon
id|aprh
op_assign
op_amp
id|ab-&gt;mem_head
suffix:semicolon
id|tprh
op_assign
op_amp
id|ab-&gt;tmem_head
suffix:semicolon
r_switch
c_cond
(paren
id|data32-&gt;attribute.memory.cache_attribute
)paren
(brace
r_case
id|ACPI_NON_CACHEABLE_MEMORY
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: Noncacheable memory&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_CACHABLE_MEMORY
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: Cacheable memory&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_WRITE_COMBINING_MEMORY
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: Write-combining memory&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_PREFETCHABLE_MEMORY
suffix:colon
id|aprh
op_assign
op_amp
id|ab-&gt;p_mem_head
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: Prefetchable memory&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: Invalid cache attribute&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: Read%s&bslash;n&quot;
comma
id|ACPI_READ_WRITE_MEMORY
op_eq
id|data32-&gt;attribute.memory.read_write_attribute
ques
c_cond
l_string|&quot;/Write&quot;
suffix:colon
l_string|&quot; Only&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_IO_RANGE
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Resource Type: I/O Range&bslash;n&quot;
)paren
suffix:semicolon
id|aprh
op_assign
op_amp
id|ab-&gt;io_head
suffix:semicolon
id|tprh
op_assign
op_amp
id|ab-&gt;tio_head
suffix:semicolon
r_switch
c_cond
(paren
id|data32-&gt;attribute.io.range_attribute
)paren
(brace
r_case
id|ACPI_NON_ISA_ONLY_RANGES
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: Non-ISA Io Addresses&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_ISA_ONLY_RANGES
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: ISA Io Addresses&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_ENTIRE_RANGE
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: ISA and non-ISA Io Addresses&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Type Specific: Invalid range attribute&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_BUS_NUMBER_RANGE
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Resource Type: Bus Number Range(fixed)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* fixup to be compatible with the rest of php driver */
id|data32-&gt;min_address_range
op_increment
suffix:semicolon
id|data32-&gt;address_length
op_decrement
suffix:semicolon
id|aprh
op_assign
op_amp
id|ab-&gt;bus_head
suffix:semicolon
id|tprh
op_assign
op_amp
id|ab-&gt;tbus_head
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;  Resource Type: Invalid resource type. Exiting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;  Resource %s&bslash;n&quot;
comma
id|ACPI_CONSUMER
op_eq
id|data32-&gt;producer_consumer
ques
c_cond
l_string|&quot;Consumer&quot;
suffix:colon
l_string|&quot;Producer&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  %s decode&bslash;n&quot;
comma
id|ACPI_SUB_DECODE
op_eq
id|data32-&gt;decode
ques
c_cond
l_string|&quot;Subtractive&quot;
suffix:colon
l_string|&quot;Positive&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Min address is %s fixed&bslash;n&quot;
comma
id|ACPI_ADDRESS_FIXED
op_eq
id|data32-&gt;min_address_fixed
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Max address is %s fixed&bslash;n&quot;
comma
id|ACPI_ADDRESS_FIXED
op_eq
id|data32-&gt;max_address_fixed
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Granularity: %08X&bslash;n&quot;
comma
id|data32-&gt;granularity
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Address range min: %08X&bslash;n&quot;
comma
id|data32-&gt;min_address_range
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Address range max: %08X&bslash;n&quot;
comma
id|data32-&gt;max_address_range
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Address translation offset: %08X&bslash;n&quot;
comma
id|data32-&gt;address_translation_offset
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Address Length: %08X&bslash;n&quot;
comma
id|data32-&gt;address_length
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0xFF
op_ne
id|data32-&gt;resource_source.index
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;  Resource Source Index: %X&bslash;n&quot;
comma
id|data32-&gt;resource_source.index
)paren
suffix:semicolon
multiline_comment|/* dbg(&quot;  Resource Source: %s&bslash;n&quot;, data32-&gt;resource_source.string_ptr); */
)brace
id|pciehprm_add_resource
c_func
(paren
id|aprh
comma
id|data32-&gt;min_address_range
comma
id|data32-&gt;address_length
)paren
suffix:semicolon
)brace
DECL|function|acpi_parse_crs
r_static
id|acpi_status
id|acpi_parse_crs
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
r_struct
id|acpi_resource
op_star
id|crsbuf
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_struct
id|acpi_resource
op_star
id|resource
op_assign
id|crsbuf
suffix:semicolon
id|u8
id|count
op_assign
l_int|0
suffix:semicolon
id|u8
id|done
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm: PCI bus 0x%x Resource structure %x.&bslash;n&quot;
comma
id|ab-&gt;bus
comma
id|count
op_increment
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|resource-&gt;id
)paren
(brace
r_case
id|ACPI_RSTYPE_IRQ
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Irq -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_DMA
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;DMA -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_START_DPF
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Start DPF -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_END_DPF
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;End DPF -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_IO
suffix:colon
id|acpi_parse_io
(paren
id|ab
comma
op_amp
id|resource-&gt;data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_FIXED_IO
suffix:colon
id|acpi_parse_fixed_io
(paren
id|ab
comma
op_amp
id|resource-&gt;data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_VENDOR
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Vendor -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_END_TAG
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;End_tag -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_MEM24
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Mem24 -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_MEM32
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Mem32 -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_FIXED_MEM32
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Fixed Mem32 -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_ADDRESS16
suffix:colon
id|acpi_parse_address16_32
c_func
(paren
id|ab
comma
op_amp
id|resource-&gt;data
comma
id|ACPI_RSTYPE_ADDRESS16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_ADDRESS32
suffix:colon
id|acpi_parse_address16_32
c_func
(paren
id|ab
comma
op_amp
id|resource-&gt;data
comma
id|ACPI_RSTYPE_ADDRESS32
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_ADDRESS64
suffix:colon
id|info
c_func
(paren
l_string|&quot;Address64 -------- Resource unparsed&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_EXT_IRQ
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Ext Irq -------- Resource&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Invalid -------- resource type 0x%x&bslash;n&quot;
comma
id|resource-&gt;id
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|resource
op_assign
(paren
r_struct
id|acpi_resource
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|resource
op_plus
id|resource-&gt;length
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|acpi_get_crs
r_static
id|acpi_status
id|acpi_get_crs
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_resource
op_star
id|crsbuf
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_crs
c_func
(paren
id|ab-&gt;handle
comma
op_amp
id|crsbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|status
op_assign
id|acpi_parse_crs
c_func
(paren
id|ab
comma
id|crsbuf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|crsbuf
)paren
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
id|ab-&gt;bus_head
)paren
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
id|ab-&gt;io_head
)paren
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
id|ab-&gt;mem_head
)paren
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
id|ab-&gt;p_mem_head
)paren
suffix:semicolon
id|pciehprm_add_resources
(paren
op_amp
id|ab-&gt;tbus_head
comma
id|ab-&gt;bus_head
)paren
suffix:semicolon
id|pciehprm_add_resources
(paren
op_amp
id|ab-&gt;tio_head
comma
id|ab-&gt;io_head
)paren
suffix:semicolon
id|pciehprm_add_resources
(paren
op_amp
id|ab-&gt;tmem_head
comma
id|ab-&gt;mem_head
)paren
suffix:semicolon
id|pciehprm_add_resources
(paren
op_amp
id|ab-&gt;tp_mem_head
comma
id|ab-&gt;p_mem_head
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* find acpi_bridge downword from ab.  */
r_static
r_struct
id|acpi_bridge
op_star
DECL|function|find_acpi_bridge_by_bus
id|find_acpi_bridge_by_bus
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
r_int
id|seg
comma
r_int
id|bus
multiline_comment|/* pdev-&gt;subordinate-&gt;number */
)paren
(brace
r_struct
id|acpi_bridge
op_star
id|lab
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ab
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ab-&gt;bus
op_eq
id|bus
)paren
op_logical_and
(paren
id|ab-&gt;seg
op_eq
id|seg
)paren
)paren
r_return
id|ab
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;child
)paren
id|lab
op_assign
id|find_acpi_bridge_by_bus
c_func
(paren
id|ab-&gt;child
comma
id|seg
comma
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lab
)paren
r_if
c_cond
(paren
id|ab-&gt;next
)paren
id|lab
op_assign
id|find_acpi_bridge_by_bus
c_func
(paren
id|ab-&gt;next
comma
id|seg
comma
id|bus
)paren
suffix:semicolon
r_return
id|lab
suffix:semicolon
)brace
multiline_comment|/*&n; * Build a device tree of ACPI PCI Bridges&n; */
DECL|function|pciehprm_acpi_register_a_bridge
r_static
r_void
id|pciehprm_acpi_register_a_bridge
(paren
r_struct
id|acpi_bridge
op_star
op_star
id|head
comma
r_struct
id|acpi_bridge
op_star
id|pab
comma
multiline_comment|/* parent bridge to which child bridge is added */
r_struct
id|acpi_bridge
op_star
id|cab
multiline_comment|/* child bridge to add */
)paren
(brace
r_struct
id|acpi_bridge
op_star
id|lpab
suffix:semicolon
r_struct
id|acpi_bridge
op_star
id|lcab
suffix:semicolon
id|lpab
op_assign
id|find_acpi_bridge_by_bus
c_func
(paren
op_star
id|head
comma
id|pab-&gt;seg
comma
id|pab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lpab
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pab-&gt;type
op_amp
id|BRIDGE_TYPE_HOST
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;PCI parent bridge s:b(%x:%x) not in list.&bslash;n&quot;
comma
id|pab-&gt;seg
comma
id|pab-&gt;bus
)paren
suffix:semicolon
id|pab-&gt;next
op_assign
op_star
id|head
suffix:semicolon
op_star
id|head
op_assign
id|pab
suffix:semicolon
id|lpab
op_assign
id|pab
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cab-&gt;type
op_amp
id|BRIDGE_TYPE_HOST
)paren
op_logical_and
(paren
id|pab
op_eq
id|cab
)paren
)paren
r_return
suffix:semicolon
id|lcab
op_assign
id|find_acpi_bridge_by_bus
c_func
(paren
op_star
id|head
comma
id|cab-&gt;seg
comma
id|cab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcab
)paren
(brace
r_if
c_cond
(paren
(paren
id|pab-&gt;bus
op_ne
id|lcab-&gt;parent-&gt;bus
)paren
op_logical_or
(paren
id|lcab-&gt;bus
op_ne
id|cab-&gt;bus
)paren
)paren
id|err
c_func
(paren
l_string|&quot;PCI child bridge s:b(%x:%x) in list with diff parent.&bslash;n&quot;
comma
id|cab-&gt;seg
comma
id|cab-&gt;bus
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|lcab
op_assign
id|cab
suffix:semicolon
id|lcab-&gt;parent
op_assign
id|lpab
suffix:semicolon
id|lcab-&gt;next
op_assign
id|lpab-&gt;child
suffix:semicolon
id|lpab-&gt;child
op_assign
id|lcab
suffix:semicolon
)brace
DECL|function|pciehprm_acpi_build_php_slots_callback
r_static
id|acpi_status
id|pciehprm_acpi_build_php_slots_callback
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|Level
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|retval
)paren
(brace
id|ulong
id|bus_num
suffix:semicolon
id|ulong
id|seg_num
suffix:semicolon
id|ulong
id|sun
comma
id|adr
suffix:semicolon
id|ulong
id|padr
op_assign
l_int|0
suffix:semicolon
id|acpi_handle
id|phandle
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_bridge
op_star
id|pab
op_assign
(paren
r_struct
id|acpi_bridge
op_star
)paren
id|context
suffix:semicolon
r_struct
id|acpi_bridge
op_star
id|lab
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|handle
)paren
suffix:semicolon
multiline_comment|/* get _SUN */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
id|METHOD_NAME__SUN
comma
l_int|NULL
comma
op_amp
id|sun
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|AE_NOT_FOUND
suffix:colon
r_return
id|AE_OK
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s _SUN fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
multiline_comment|/* get _ADR. _ADR must exist if _SUN exists */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
id|METHOD_NAME__ADR
comma
l_int|NULL
comma
op_amp
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s _ADR fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:%s sun=0x%08x adr=0x%08x&bslash;n&quot;
comma
id|path_name
comma
(paren
id|u32
)paren
id|sun
comma
(paren
id|u32
)paren
id|adr
)paren
suffix:semicolon
id|status
op_assign
id|acpi_get_parent
c_func
(paren
id|handle
comma
op_amp
id|phandle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s get_parent fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|bus_num
op_assign
id|pab-&gt;bus
suffix:semicolon
id|seg_num
op_assign
id|pab-&gt;seg
suffix:semicolon
r_if
c_cond
(paren
id|pab-&gt;bus
op_eq
id|bus_num
)paren
(brace
id|lab
op_assign
id|pab
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;WARN: pab is not parent&bslash;n&quot;
)paren
suffix:semicolon
id|lab
op_assign
id|find_acpi_bridge_by_bus
c_func
(paren
id|pab
comma
id|seg_num
comma
id|bus_num
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lab
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm: alloc new P2P bridge(%x) for sun(%08x)&bslash;n&quot;
comma
(paren
id|u32
)paren
id|bus_num
comma
(paren
id|u32
)paren
id|sun
)paren
suffix:semicolon
id|lab
op_assign
(paren
r_struct
id|acpi_bridge
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpi_bridge
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lab
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm: alloc for ab fail&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|AE_NO_MEMORY
suffix:semicolon
)brace
id|memset
c_func
(paren
id|lab
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_bridge
)paren
)paren
suffix:semicolon
id|lab-&gt;handle
op_assign
id|phandle
suffix:semicolon
id|lab-&gt;pbus
op_assign
id|pab-&gt;bus
suffix:semicolon
id|lab-&gt;pdevice
op_assign
(paren
r_int
)paren
(paren
id|padr
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|lab-&gt;pfunction
op_assign
(paren
r_int
)paren
(paren
id|padr
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|lab-&gt;bus
op_assign
(paren
r_int
)paren
id|bus_num
suffix:semicolon
id|lab-&gt;scanned
op_assign
l_int|0
suffix:semicolon
id|lab-&gt;type
op_assign
id|BRIDGE_TYPE_P2P
suffix:semicolon
id|pciehprm_acpi_register_a_bridge
(paren
op_amp
id|acpi_bridges_head
comma
id|pab
comma
id|lab
)paren
suffix:semicolon
)brace
r_else
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm: found P2P bridge(%x) for sun(%08x)&bslash;n&quot;
comma
(paren
id|u32
)paren
id|bus_num
comma
(paren
id|u32
)paren
id|sun
)paren
suffix:semicolon
)brace
id|acpi_add_slot_to_php_slots
c_func
(paren
id|lab
comma
(paren
r_int
)paren
id|bus_num
comma
id|handle
comma
(paren
id|u32
)paren
id|adr
comma
(paren
id|u32
)paren
id|sun
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
DECL|function|pciehprm_acpi_build_php_slots
r_static
r_int
id|pciehprm_acpi_build_php_slots
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
id|u32
id|depth
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|ab-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Walk down this pci bridge to get _SUNs if any behind P2P */
id|status
op_assign
id|acpi_walk_namespace
(paren
id|ACPI_TYPE_DEVICE
comma
id|ab-&gt;handle
comma
id|depth
comma
id|pciehprm_acpi_build_php_slots_callback
comma
id|ab
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:%s walk for _SUN on pci bridge seg:bus(%x:%x) fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|ab-&gt;seg
comma
id|ab-&gt;bus
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|build_a_bridge
r_static
r_void
id|build_a_bridge
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|pab
comma
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|ab-&gt;handle
)paren
suffix:semicolon
id|pciehprm_acpi_register_a_bridge
(paren
op_amp
id|acpi_bridges_head
comma
id|pab
comma
id|ab
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ab-&gt;type
)paren
(brace
r_case
id|BRIDGE_TYPE_HOST
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm: Registered PCI HOST Bridge(%02x)    on s:b:d:f(%02x:%02x:%02x:%02x) [%s]&bslash;n&quot;
comma
id|ab-&gt;bus
comma
id|ab-&gt;seg
comma
id|ab-&gt;pbus
comma
id|ab-&gt;pdevice
comma
id|ab-&gt;pfunction
comma
id|path_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRIDGE_TYPE_P2P
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm: Registered PCI  P2P Bridge(%02x-%02x) on s:b:d:f(%02x:%02x:%02x:%02x) [%s]&bslash;n&quot;
comma
id|ab-&gt;pbus
comma
id|ab-&gt;bus
comma
id|ab-&gt;seg
comma
id|ab-&gt;pbus
comma
id|ab-&gt;pdevice
comma
id|ab-&gt;pfunction
comma
id|path_name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* build any immediate PHP slots under this pci bridge */
id|pciehprm_acpi_build_php_slots
c_func
(paren
id|ab
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|add_p2p_bridge
r_static
r_struct
id|acpi_bridge
op_star
id|add_p2p_bridge
c_func
(paren
id|acpi_handle
id|handle
comma
r_struct
id|acpi_bridge
op_star
id|pab
comma
multiline_comment|/* parent */
id|ulong
id|adr
)paren
(brace
r_struct
id|acpi_bridge
op_star
id|ab
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|ulong
id|devnum
comma
id|funcnum
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|handle
)paren
suffix:semicolon
id|ab
op_assign
(paren
r_struct
id|acpi_bridge
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|acpi_bridge
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ab
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm: alloc for ab fail&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ab
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_bridge
)paren
)paren
suffix:semicolon
id|devnum
op_assign
(paren
id|adr
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|funcnum
op_assign
id|adr
op_amp
l_int|0xffff
suffix:semicolon
id|pdev
op_assign
id|pci_find_slot
c_func
(paren
id|pab-&gt;bus
comma
id|PCI_DEVFN
c_func
(paren
id|devnum
comma
id|funcnum
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
op_logical_or
op_logical_neg
id|pdev-&gt;subordinate
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s is not a P2P Bridge&bslash;n&quot;
comma
id|path_name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ab
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ab-&gt;handle
op_assign
id|handle
suffix:semicolon
id|ab-&gt;seg
op_assign
id|pab-&gt;seg
suffix:semicolon
id|ab-&gt;pbus
op_assign
id|pab-&gt;bus
suffix:semicolon
multiline_comment|/* or pdev-&gt;bus-&gt;number */
id|ab-&gt;pdevice
op_assign
id|devnum
suffix:semicolon
multiline_comment|/* or PCI_SLOT(pdev-&gt;devfn) */
id|ab-&gt;pfunction
op_assign
id|funcnum
suffix:semicolon
multiline_comment|/* or PCI_FUNC(pdev-&gt;devfn) */
id|ab-&gt;bus
op_assign
id|pdev-&gt;subordinate-&gt;number
suffix:semicolon
id|ab-&gt;scanned
op_assign
l_int|0
suffix:semicolon
id|ab-&gt;type
op_assign
id|BRIDGE_TYPE_P2P
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm: P2P(%x-%x) on pci=b:d:f(%x:%x:%x) acpi=b:d:f(%x:%x:%x) [%s]&bslash;n&quot;
comma
id|pab-&gt;bus
comma
id|ab-&gt;bus
comma
id|pdev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|pab-&gt;bus
comma
(paren
id|u32
)paren
id|devnum
comma
(paren
id|u32
)paren
id|funcnum
comma
id|path_name
)paren
suffix:semicolon
id|build_a_bridge
c_func
(paren
id|pab
comma
id|ab
)paren
suffix:semicolon
r_return
id|ab
suffix:semicolon
)brace
DECL|function|scan_p2p_bridge
r_static
id|acpi_status
id|scan_p2p_bridge
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|Level
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|retval
)paren
(brace
r_struct
id|acpi_bridge
op_star
id|pab
op_assign
(paren
r_struct
id|acpi_bridge
op_star
)paren
id|context
suffix:semicolon
r_struct
id|acpi_bridge
op_star
id|ab
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|ulong
id|adr
op_assign
l_int|0
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|handle
)paren
suffix:semicolon
id|ulong
id|devnum
comma
id|funcnum
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
multiline_comment|/* get device, function */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
id|METHOD_NAME__ADR
comma
l_int|NULL
comma
op_amp
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_ne
id|AE_NOT_FOUND
)paren
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s _ADR fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|devnum
op_assign
(paren
id|adr
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|funcnum
op_assign
id|adr
op_amp
l_int|0xffff
suffix:semicolon
id|pdev
op_assign
id|pci_find_slot
c_func
(paren
id|pab-&gt;bus
comma
id|PCI_DEVFN
c_func
(paren
id|devnum
comma
id|funcnum
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
r_return
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;subordinate
)paren
r_return
id|AE_OK
suffix:semicolon
id|ab
op_assign
id|add_p2p_bridge
c_func
(paren
id|handle
comma
id|pab
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab
)paren
(brace
id|status
op_assign
id|acpi_walk_namespace
(paren
id|ACPI_TYPE_DEVICE
comma
id|handle
comma
(paren
id|u32
)paren
l_int|1
comma
id|scan_p2p_bridge
comma
id|ab
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:%s find_p2p fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
DECL|function|add_host_bridge
r_static
r_struct
id|acpi_bridge
op_star
id|add_host_bridge
c_func
(paren
id|acpi_handle
id|handle
comma
id|ulong
id|segnum
comma
id|ulong
id|busnum
)paren
(brace
id|ulong
id|adr
op_assign
l_int|0
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_bridge
op_star
id|ab
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|handle
)paren
suffix:semicolon
multiline_comment|/* get device, function: host br adr is always 0000 though.  */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
id|METHOD_NAME__ADR
comma
l_int|NULL
comma
op_amp
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s _ADR fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm: ROOT PCI seg(0x%x)bus(0x%x)dev(0x%x)func(0x%x) [%s]&bslash;n&quot;
comma
(paren
id|u32
)paren
id|segnum
comma
(paren
id|u32
)paren
id|busnum
comma
(paren
id|u32
)paren
(paren
id|adr
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
comma
(paren
id|u32
)paren
id|adr
op_amp
l_int|0xffff
comma
id|path_name
)paren
suffix:semicolon
id|ab
op_assign
(paren
r_struct
id|acpi_bridge
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|acpi_bridge
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ab
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm: alloc for ab fail&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ab
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_bridge
)paren
)paren
suffix:semicolon
id|ab-&gt;handle
op_assign
id|handle
suffix:semicolon
id|ab-&gt;seg
op_assign
(paren
r_int
)paren
id|segnum
suffix:semicolon
id|ab-&gt;bus
op_assign
id|ab-&gt;pbus
op_assign
(paren
r_int
)paren
id|busnum
suffix:semicolon
id|ab-&gt;pdevice
op_assign
(paren
r_int
)paren
(paren
id|adr
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|ab-&gt;pfunction
op_assign
(paren
r_int
)paren
(paren
id|adr
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|ab-&gt;scanned
op_assign
l_int|0
suffix:semicolon
id|ab-&gt;type
op_assign
id|BRIDGE_TYPE_HOST
suffix:semicolon
multiline_comment|/* get root pci bridge&squot;s current resources */
id|status
op_assign
id|acpi_get_crs
c_func
(paren
id|ab
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s evaluate _CRS fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ab
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|status
op_assign
id|pci_osc_control_set
(paren
id|OSC_PCI_EXPRESS_NATIVE_HP_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: status %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
id|osc_run_status
op_assign
(paren
id|status
op_eq
id|AE_NOT_FOUND
)paren
ques
c_cond
id|OSC_NOT_EXIST
suffix:colon
id|OSC_RUN_FAILED
suffix:semicolon
)brace
r_else
(brace
id|osc_run_status
op_assign
id|NC_RUN_SUCCESS
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: osc_run_status %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|osc_run_status
)paren
suffix:semicolon
id|build_a_bridge
c_func
(paren
id|ab
comma
id|ab
)paren
suffix:semicolon
r_return
id|ab
suffix:semicolon
)brace
DECL|function|acpi_scan_from_root_pci_callback
r_static
id|acpi_status
id|acpi_scan_from_root_pci_callback
(paren
id|acpi_handle
id|handle
comma
id|u32
id|Level
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|retval
)paren
(brace
id|ulong
id|segnum
op_assign
l_int|0
suffix:semicolon
id|ulong
id|busnum
op_assign
l_int|0
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_bridge
op_star
id|ab
suffix:semicolon
id|u8
op_star
id|path_name
op_assign
id|acpi_path_name
c_func
(paren
id|handle
)paren
suffix:semicolon
multiline_comment|/* get bus number of this pci root bridge */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
id|METHOD_NAME__SEG
comma
l_int|NULL
comma
op_amp
id|segnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_ne
id|AE_NOT_FOUND
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s evaluate _SEG fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|segnum
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get bus number of this pci root bridge */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
id|METHOD_NAME__BBN
comma
l_int|NULL
comma
op_amp
id|busnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:%s evaluate _BBN fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
id|ab
op_assign
id|add_host_bridge
c_func
(paren
id|handle
comma
id|segnum
comma
id|busnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab
)paren
(brace
id|status
op_assign
id|acpi_walk_namespace
(paren
id|ACPI_TYPE_DEVICE
comma
id|handle
comma
l_int|1
comma
id|scan_p2p_bridge
comma
id|ab
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|dbg
c_func
(paren
l_string|&quot;acpi_pciehprm:%s find_p2p fail=0x%x&bslash;n&quot;
comma
id|path_name
comma
id|status
)paren
suffix:semicolon
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
DECL|function|pciehprm_acpi_scan_pci
r_static
r_int
id|pciehprm_acpi_scan_pci
(paren
r_void
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * TBD: traverse LDM device tree with the help of&n;&t; *  unified ACPI augmented for php device population.&n;&t; */
id|status
op_assign
id|acpi_get_devices
(paren
id|PCI_ROOT_HID_STRING
comma
id|acpi_scan_from_root_pci_callback
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;acpi_pciehprm:get_device PCI ROOT HID fail=0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pciehprm_init
r_int
id|pciehprm_init
c_func
(paren
r_enum
id|php_ctlr_type
id|ctlr_type
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|ctlr_type
op_ne
id|PCI
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;pciehprm ACPI init &lt;enter&gt;&bslash;n&quot;
)paren
suffix:semicolon
id|acpi_bridges_head
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* construct PCI bus:device tree of acpi_handles */
id|rc
op_assign
id|pciehprm_acpi_scan_pci
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|oshp_run_status
op_ne
id|NC_RUN_SUCCESS
)paren
op_logical_and
(paren
id|osc_run_status
op_ne
id|NC_RUN_SUCCESS
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Fails to gain control of native hot-plug&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;pciehprm ACPI init %s&bslash;n&quot;
comma
(paren
id|rc
)paren
ques
c_cond
l_string|&quot;fail&quot;
suffix:colon
l_string|&quot;success&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|free_a_slot
r_static
r_void
id|free_a_slot
c_func
(paren
r_struct
id|acpi_php_slot
op_star
id|aps
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;        free a php func of slot(0x%02x) on PCI b:d:f=0x%02x:%02x:%02x&bslash;n&quot;
comma
id|aps-&gt;sun
comma
id|aps-&gt;bus
comma
id|aps-&gt;dev
comma
id|aps-&gt;fun
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|aps-&gt;io_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|aps-&gt;bus_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|aps-&gt;mem_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|aps-&gt;p_mem_head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aps
)paren
suffix:semicolon
)brace
DECL|function|free_a_bridge
r_static
r_void
id|free_a_bridge
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_struct
id|acpi_php_slot
op_star
id|aps
comma
op_star
id|next
suffix:semicolon
r_switch
c_cond
(paren
id|ab-&gt;type
)paren
(brace
r_case
id|BRIDGE_TYPE_HOST
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Free ACPI PCI HOST Bridge(%x) [%s] on s:b:d:f(%x:%x:%x:%x)&bslash;n&quot;
comma
id|ab-&gt;bus
comma
id|acpi_path_name
c_func
(paren
id|ab-&gt;handle
)paren
comma
id|ab-&gt;seg
comma
id|ab-&gt;pbus
comma
id|ab-&gt;pdevice
comma
id|ab-&gt;pfunction
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRIDGE_TYPE_P2P
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;Free ACPI PCI P2P Bridge(%x-%x) [%s] on s:b:d:f(%x:%x:%x:%x)&bslash;n&quot;
comma
id|ab-&gt;pbus
comma
id|ab-&gt;bus
comma
id|acpi_path_name
c_func
(paren
id|ab-&gt;handle
)paren
comma
id|ab-&gt;seg
comma
id|ab-&gt;pbus
comma
id|ab-&gt;pdevice
comma
id|ab-&gt;pfunction
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* free slots first */
r_for
c_loop
(paren
id|aps
op_assign
id|ab-&gt;slots
suffix:semicolon
id|aps
suffix:semicolon
id|aps
op_assign
id|next
)paren
(brace
id|next
op_assign
id|aps-&gt;next
suffix:semicolon
id|free_a_slot
c_func
(paren
id|aps
)paren
suffix:semicolon
)brace
id|free_pci_resource
(paren
id|ab-&gt;io_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|ab-&gt;tio_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|ab-&gt;bus_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|ab-&gt;tbus_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|ab-&gt;mem_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|ab-&gt;tmem_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|ab-&gt;p_mem_head
)paren
suffix:semicolon
id|free_pci_resource
(paren
id|ab-&gt;tp_mem_head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ab
)paren
suffix:semicolon
)brace
DECL|function|pciehprm_free_bridges
r_static
r_void
id|pciehprm_free_bridges
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ab
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;child
)paren
id|pciehprm_free_bridges
(paren
id|ab-&gt;child
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;next
)paren
id|pciehprm_free_bridges
(paren
id|ab-&gt;next
)paren
suffix:semicolon
id|free_a_bridge
c_func
(paren
id|ab
)paren
suffix:semicolon
)brace
DECL|function|pciehprm_cleanup
r_void
id|pciehprm_cleanup
c_func
(paren
r_void
)paren
(brace
id|pciehprm_free_bridges
(paren
id|acpi_bridges_head
)paren
suffix:semicolon
)brace
DECL|function|get_number_of_slots
r_static
r_int
id|get_number_of_slots
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
r_int
id|selfonly
)paren
(brace
r_struct
id|acpi_php_slot
op_star
id|aps
suffix:semicolon
r_int
id|prev_slot
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|slot_num
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|aps
op_assign
id|ab-&gt;slots
suffix:semicolon
id|aps
suffix:semicolon
id|aps
op_assign
id|aps-&gt;next
)paren
r_if
c_cond
(paren
id|aps-&gt;dev
op_ne
id|prev_slot
)paren
(brace
id|prev_slot
op_assign
id|aps-&gt;dev
suffix:semicolon
id|slot_num
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;child
)paren
id|slot_num
op_add_assign
id|get_number_of_slots
(paren
id|ab-&gt;child
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|selfonly
)paren
r_return
id|slot_num
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;next
)paren
id|slot_num
op_add_assign
id|get_number_of_slots
(paren
id|ab-&gt;next
comma
l_int|0
)paren
suffix:semicolon
r_return
id|slot_num
suffix:semicolon
)brace
DECL|function|print_acpi_resources
r_static
r_int
id|print_acpi_resources
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_struct
id|acpi_php_slot
op_star
id|aps
suffix:semicolon
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|ab-&gt;type
)paren
(brace
r_case
id|BRIDGE_TYPE_HOST
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;PCI HOST Bridge (%x) [%s]&bslash;n&quot;
comma
id|ab-&gt;bus
comma
id|acpi_path_name
c_func
(paren
id|ab-&gt;handle
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRIDGE_TYPE_P2P
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;PCI P2P Bridge (%x-%x) [%s]&bslash;n&quot;
comma
id|ab-&gt;pbus
comma
id|ab-&gt;bus
comma
id|acpi_path_name
c_func
(paren
id|ab-&gt;handle
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|print_pci_resources
(paren
id|ab
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
op_minus
l_int|1
comma
id|aps
op_assign
id|ab-&gt;slots
suffix:semicolon
id|aps
suffix:semicolon
id|aps
op_assign
id|aps-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|aps-&gt;dev
op_eq
id|i
)paren
r_continue
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Slot sun(%x) s:b:d:f(%02x:%02x:%02x:%02x)&bslash;n&quot;
comma
id|aps-&gt;sun
comma
id|aps-&gt;seg
comma
id|aps-&gt;bus
comma
id|aps-&gt;dev
comma
id|aps-&gt;fun
)paren
suffix:semicolon
id|print_slot_resources
c_func
(paren
id|aps
)paren
suffix:semicolon
id|i
op_assign
id|aps-&gt;dev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;child
)paren
id|print_acpi_resources
(paren
id|ab-&gt;child
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;next
)paren
id|print_acpi_resources
(paren
id|ab-&gt;next
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pciehprm_print_pirt
r_int
id|pciehprm_print_pirt
c_func
(paren
r_void
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;PCIEHPRM ACPI Slots&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_bridges_head
)paren
id|print_acpi_resources
(paren
id|acpi_bridges_head
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_acpi_slot
r_static
r_struct
id|acpi_php_slot
op_star
id|get_acpi_slot
(paren
r_struct
id|acpi_bridge
op_star
id|ab
comma
id|u32
id|sun
)paren
(brace
r_struct
id|acpi_php_slot
op_star
id|aps
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|aps
op_assign
id|ab-&gt;slots
suffix:semicolon
id|aps
suffix:semicolon
id|aps
op_assign
id|aps-&gt;next
)paren
r_if
c_cond
(paren
id|aps-&gt;sun
op_eq
id|sun
)paren
r_return
id|aps
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aps
op_logical_and
id|ab-&gt;child
)paren
(brace
id|aps
op_assign
(paren
r_struct
id|acpi_php_slot
op_star
)paren
id|get_acpi_slot
(paren
id|ab-&gt;child
comma
id|sun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aps
)paren
r_return
id|aps
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|aps
op_logical_and
id|ab-&gt;next
)paren
(brace
id|aps
op_assign
(paren
r_struct
id|acpi_php_slot
op_star
)paren
id|get_acpi_slot
(paren
id|ab-&gt;next
comma
id|sun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aps
)paren
r_return
id|aps
suffix:semicolon
)brace
r_return
id|aps
suffix:semicolon
)brace
macro_line|#if 0
r_void
op_star
id|pciehprm_get_slot
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|acpi_bridge
op_star
id|ab
op_assign
id|acpi_bridges_head
suffix:semicolon
r_struct
id|acpi_php_slot
op_star
id|aps
op_assign
id|get_acpi_slot
(paren
id|ab
comma
id|slot-&gt;number
)paren
suffix:semicolon
id|aps-&gt;slot
op_assign
id|slot
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Got acpi slot sun(%x): s:b:d:f(%x:%x:%x:%x)&bslash;n&quot;
comma
id|aps-&gt;sun
comma
id|aps-&gt;seg
comma
id|aps-&gt;bus
comma
id|aps-&gt;dev
comma
id|aps-&gt;fun
)paren
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
id|aps
suffix:semicolon
)brace
macro_line|#endif
DECL|function|pciehprm_dump_func_res
r_static
r_void
id|pciehprm_dump_func_res
c_func
(paren
r_struct
id|pci_func
op_star
id|fun
)paren
(brace
r_struct
id|pci_func
op_star
id|func
op_assign
id|fun
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;bus_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    BUS Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|func-&gt;bus_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func-&gt;io_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    IO Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|func-&gt;io_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func-&gt;mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    MEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|func-&gt;mem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func-&gt;p_mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    PMEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|func-&gt;p_mem_head
)paren
suffix:semicolon
)brace
)brace
DECL|function|pciehprm_dump_ctrl_res
r_static
r_void
id|pciehprm_dump_ctrl_res
c_func
(paren
r_struct
id|controller
op_star
id|ctlr
)paren
(brace
r_struct
id|controller
op_star
id|ctrl
op_assign
id|ctlr
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;bus_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    BUS Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ctrl-&gt;bus_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl-&gt;io_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    IO Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ctrl-&gt;io_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl-&gt;mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    MEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ctrl-&gt;mem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl-&gt;p_mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    PMEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ctrl-&gt;p_mem_head
)paren
suffix:semicolon
)brace
)brace
DECL|function|pciehprm_get_used_resources
r_static
r_int
id|pciehprm_get_used_resources
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_return
id|pciehp_save_used_resources
(paren
id|ctrl
comma
id|func
comma
op_logical_neg
id|DISABLE_CARD
)paren
suffix:semicolon
)brace
DECL|function|configure_existing_function
r_static
r_int
id|configure_existing_function
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/* see how much resources the func has used. */
id|rc
op_assign
id|pciehprm_get_used_resources
(paren
id|ctrl
comma
id|func
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
multiline_comment|/* subtract the resources used by the func from ctrl resources */
id|rc
op_assign
id|pciehprm_delete_resources
(paren
op_amp
id|ctrl-&gt;bus_head
comma
id|func-&gt;bus_head
)paren
suffix:semicolon
id|rc
op_or_assign
id|pciehprm_delete_resources
(paren
op_amp
id|ctrl-&gt;io_head
comma
id|func-&gt;io_head
)paren
suffix:semicolon
id|rc
op_or_assign
id|pciehprm_delete_resources
(paren
op_amp
id|ctrl-&gt;mem_head
comma
id|func-&gt;mem_head
)paren
suffix:semicolon
id|rc
op_or_assign
id|pciehprm_delete_resources
(paren
op_amp
id|ctrl-&gt;p_mem_head
comma
id|func-&gt;p_mem_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|warn
c_func
(paren
l_string|&quot;aCEF: cannot del used resources&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|err
c_func
(paren
l_string|&quot;aCEF: cannot get used resources&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|bind_pci_resources_to_slots
r_static
r_int
id|bind_pci_resources_to_slots
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|pci_func
op_star
id|func
comma
id|new_func
suffix:semicolon
r_int
id|busn
op_assign
id|ctrl-&gt;slot_bus
suffix:semicolon
r_int
id|devn
comma
id|funn
suffix:semicolon
id|u32
id|vid
suffix:semicolon
r_for
c_loop
(paren
id|devn
op_assign
l_int|0
suffix:semicolon
id|devn
OL
l_int|32
suffix:semicolon
id|devn
op_increment
)paren
(brace
r_for
c_loop
(paren
id|funn
op_assign
l_int|0
suffix:semicolon
id|funn
OL
l_int|8
suffix:semicolon
id|funn
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;if (devn == ctrl-&gt;device &amp;&amp; funn == ctrl-&gt;function)&n;&t;&t;&t;&t;continue;&n;&t;&t;&t;*/
multiline_comment|/* find out if this entry is for an occupied slot */
id|vid
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|pci_bus_read_config_dword
c_func
(paren
id|ctrl-&gt;pci_dev-&gt;subordinate
comma
id|PCI_DEVFN
c_func
(paren
id|devn
comma
id|funn
)paren
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vid
op_ne
l_int|0xFFFFFFFF
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: vid = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|vid
)paren
suffix:semicolon
id|func
op_assign
id|pciehp_slot_find
c_func
(paren
id|busn
comma
id|devn
comma
id|funn
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|func
)paren
(brace
id|memset
c_func
(paren
op_amp
id|new_func
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|new_func.bus
op_assign
id|busn
suffix:semicolon
id|new_func.device
op_assign
id|devn
suffix:semicolon
id|new_func.function
op_assign
id|funn
suffix:semicolon
id|new_func.is_a_board
op_assign
l_int|1
suffix:semicolon
id|configure_existing_function
c_func
(paren
id|ctrl
comma
op_amp
id|new_func
)paren
suffix:semicolon
id|pciehprm_dump_func_res
c_func
(paren
op_amp
id|new_func
)paren
suffix:semicolon
)brace
r_else
(brace
id|configure_existing_function
c_func
(paren
id|ctrl
comma
id|func
)paren
suffix:semicolon
id|pciehprm_dump_func_res
c_func
(paren
id|func
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;aCCF:existing PCI 0x%x Func ResourceDump&bslash;n&quot;
comma
id|ctrl-&gt;bus
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bind_pci_resources
r_static
r_int
id|bind_pci_resources
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;bus_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;bapr:  BUS Resources add on PCI 0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
id|status
op_assign
id|pciehprm_add_resources
(paren
op_amp
id|ctrl-&gt;bus_head
comma
id|ab-&gt;bus_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pciehprm_delete_resources
(paren
op_amp
id|ab-&gt;bus_head
comma
id|ctrl-&gt;bus_head
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;bapr:  cannot sub BUS Resource on PCI 0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|err
c_func
(paren
l_string|&quot;bapr:  BUS Resource add on PCI 0x%x: fail=0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
r_else
id|info
c_func
(paren
l_string|&quot;bapr:  No BUS Resource on PCI 0x%x.&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;io_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;bapr:  IO Resources add on PCI 0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
id|status
op_assign
id|pciehprm_add_resources
(paren
op_amp
id|ctrl-&gt;io_head
comma
id|ab-&gt;io_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pciehprm_delete_resources
(paren
op_amp
id|ab-&gt;io_head
comma
id|ctrl-&gt;io_head
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;bapr:  cannot sub IO Resource on PCI 0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|err
c_func
(paren
l_string|&quot;bapr:  IO Resource add on PCI 0x%x: fail=0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
r_else
id|info
c_func
(paren
l_string|&quot;bapr:  No  IO Resource on PCI 0x%x.&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;bapr:  MEM Resources add on PCI 0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
id|status
op_assign
id|pciehprm_add_resources
(paren
op_amp
id|ctrl-&gt;mem_head
comma
id|ab-&gt;mem_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pciehprm_delete_resources
(paren
op_amp
id|ab-&gt;mem_head
comma
id|ctrl-&gt;mem_head
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;bapr:  cannot sub MEM Resource on PCI 0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|err
c_func
(paren
l_string|&quot;bapr:  MEM Resource add on PCI 0x%x: fail=0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
r_else
id|info
c_func
(paren
l_string|&quot;bapr:  No MEM Resource on PCI 0x%x.&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;p_mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;bapr:  PMEM Resources add on PCI 0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
id|status
op_assign
id|pciehprm_add_resources
(paren
op_amp
id|ctrl-&gt;p_mem_head
comma
id|ab-&gt;p_mem_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pciehprm_delete_resources
(paren
op_amp
id|ab-&gt;p_mem_head
comma
id|ctrl-&gt;p_mem_head
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;bapr:  cannot sub PMEM Resource on PCI 0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|err
c_func
(paren
l_string|&quot;bapr:  PMEM Resource add on PCI 0x%x: fail=0x%x&bslash;n&quot;
comma
id|ab-&gt;bus
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
r_else
id|info
c_func
(paren
l_string|&quot;bapr:  No PMEM Resource on PCI 0x%x.&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|no_pci_resources
r_static
r_int
id|no_pci_resources
c_func
(paren
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_return
op_logical_neg
(paren
id|ab-&gt;p_mem_head
op_logical_or
id|ab-&gt;mem_head
op_logical_or
id|ab-&gt;io_head
op_logical_or
id|ab-&gt;bus_head
)paren
suffix:semicolon
)brace
DECL|function|find_pci_bridge_resources
r_static
r_int
id|find_pci_bridge_resources
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_func
id|func
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|func
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|func.bus
op_assign
id|ab-&gt;pbus
suffix:semicolon
id|func.device
op_assign
id|ab-&gt;pdevice
suffix:semicolon
id|func.function
op_assign
id|ab-&gt;pfunction
suffix:semicolon
id|func.is_a_board
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Get used resources for this PCI bridge */
id|rc
op_assign
id|pciehp_save_used_resources
(paren
id|ctrl
comma
op_amp
id|func
comma
op_logical_neg
id|DISABLE_CARD
)paren
suffix:semicolon
id|ab-&gt;io_head
op_assign
id|func.io_head
suffix:semicolon
id|ab-&gt;mem_head
op_assign
id|func.mem_head
suffix:semicolon
id|ab-&gt;p_mem_head
op_assign
id|func.p_mem_head
suffix:semicolon
id|ab-&gt;bus_head
op_assign
id|func.bus_head
suffix:semicolon
r_if
c_cond
(paren
id|ab-&gt;bus_head
)paren
id|pciehprm_delete_resource
c_func
(paren
op_amp
id|ab-&gt;bus_head
comma
id|ctrl-&gt;pci_dev-&gt;subordinate-&gt;number
comma
l_int|1
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_pci_resources_from_bridge
r_static
r_int
id|get_pci_resources_from_bridge
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;grfb:  Get Resources for PCI 0x%x from actual PCI bridge 0x%x.&bslash;n&quot;
comma
id|ctrl-&gt;bus
comma
id|ab-&gt;bus
)paren
suffix:semicolon
id|rc
op_assign
id|find_pci_bridge_resources
(paren
id|ctrl
comma
id|ab
)paren
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
id|ab-&gt;bus_head
)paren
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
id|ab-&gt;io_head
)paren
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
id|ab-&gt;mem_head
)paren
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
id|ab-&gt;p_mem_head
)paren
suffix:semicolon
id|pciehprm_add_resources
(paren
op_amp
id|ab-&gt;tbus_head
comma
id|ab-&gt;bus_head
)paren
suffix:semicolon
id|pciehprm_add_resources
(paren
op_amp
id|ab-&gt;tio_head
comma
id|ab-&gt;io_head
)paren
suffix:semicolon
id|pciehprm_add_resources
(paren
op_amp
id|ab-&gt;tmem_head
comma
id|ab-&gt;mem_head
)paren
suffix:semicolon
id|pciehprm_add_resources
(paren
op_amp
id|ab-&gt;tp_mem_head
comma
id|ab-&gt;p_mem_head
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_pci_resources
r_static
r_int
id|get_pci_resources
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|acpi_bridge
op_star
id|ab
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|no_pci_resources
c_func
(paren
id|ab
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;spbr:PCI 0x%x has no resources. Get parent resources.&bslash;n&quot;
comma
id|ab-&gt;bus
)paren
suffix:semicolon
id|rc
op_assign
id|get_pci_resources_from_bridge
c_func
(paren
id|ctrl
comma
id|ab
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Get resources for this ctrl.&n; *  1. get total resources from ACPI _CRS or bridge (this ctrl)&n; *  2. find used resources of existing adapters&n; *&t;3. subtract used resources from total resources&n; */
DECL|function|pciehprm_find_available_resources
r_int
id|pciehprm_find_available_resources
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_bridge
op_star
id|ab
suffix:semicolon
id|ab
op_assign
id|find_acpi_bridge_by_bus
c_func
(paren
id|acpi_bridges_head
comma
id|ctrl-&gt;seg
comma
id|ctrl-&gt;pci_dev-&gt;subordinate-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ab
)paren
(brace
id|err
c_func
(paren
l_string|&quot;pfar:cannot locate acpi bridge of PCI 0x%x.&bslash;n&quot;
comma
id|ctrl-&gt;pci_dev-&gt;subordinate-&gt;number
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|no_pci_resources
c_func
(paren
id|ab
)paren
)paren
(brace
id|rc
op_assign
id|get_pci_resources
c_func
(paren
id|ctrl
comma
id|ab
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;pfar:cannot get pci resources of PCI 0x%x.&bslash;n&quot;
comma
id|ctrl-&gt;pci_dev-&gt;subordinate-&gt;number
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|rc
op_assign
id|bind_pci_resources
c_func
(paren
id|ctrl
comma
id|ab
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;pfar:pre-Bind PCI 0x%x Ctrl Resource Dump&bslash;n&quot;
comma
id|ctrl-&gt;pci_dev-&gt;subordinate-&gt;number
)paren
suffix:semicolon
id|pciehprm_dump_ctrl_res
c_func
(paren
id|ctrl
)paren
suffix:semicolon
id|bind_pci_resources_to_slots
(paren
id|ctrl
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;pfar:post-Bind PCI 0x%x Ctrl Resource Dump&bslash;n&quot;
comma
id|ctrl-&gt;pci_dev-&gt;subordinate-&gt;number
)paren
suffix:semicolon
id|pciehprm_dump_ctrl_res
c_func
(paren
id|ctrl
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|pciehprm_set_hpp
r_int
id|pciehprm_set_hpp
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
comma
id|u8
id|card_type
)paren
(brace
r_struct
id|acpi_bridge
op_star
id|ab
suffix:semicolon
r_struct
id|pci_bus
id|lpci_bus
comma
op_star
id|pci_bus
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
id|u8
id|cls
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* default cache line size&t;*/
id|u8
id|lt
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* default latency timer&t;*/
id|u8
id|ep
op_assign
l_int|0
suffix:semicolon
id|u8
id|es
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|lpci_bus
comma
id|ctrl-&gt;pci_bus
comma
r_sizeof
(paren
id|lpci_bus
)paren
)paren
suffix:semicolon
id|pci_bus
op_assign
op_amp
id|lpci_bus
suffix:semicolon
id|pci_bus-&gt;number
op_assign
id|func-&gt;bus
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|ab
op_assign
id|find_acpi_bridge_by_bus
c_func
(paren
id|acpi_bridges_head
comma
id|ctrl-&gt;seg
comma
id|ctrl-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab
)paren
(brace
r_if
c_cond
(paren
id|ab-&gt;_hpp
)paren
(brace
id|lt
op_assign
(paren
id|u8
)paren
id|ab-&gt;_hpp-&gt;latency_timer
suffix:semicolon
id|cls
op_assign
(paren
id|u8
)paren
id|ab-&gt;_hpp-&gt;cache_line_size
suffix:semicolon
id|ep
op_assign
(paren
id|u8
)paren
id|ab-&gt;_hpp-&gt;enable_perr
suffix:semicolon
id|es
op_assign
(paren
id|u8
)paren
id|ab-&gt;_hpp-&gt;enable_serr
suffix:semicolon
)brace
r_else
id|dbg
c_func
(paren
l_string|&quot;_hpp: no _hpp for B/D/F=%#x/%#x/%#x. use default value&bslash;n&quot;
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
)brace
r_else
id|dbg
c_func
(paren
l_string|&quot;_hpp: no acpi bridge for B/D/F = %#x/%#x/%#x. use default value&bslash;n&quot;
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
multiline_comment|/* set subordinate Latency Timer */
id|rc
op_or_assign
id|pci_bus_write_config_byte
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_SEC_LATENCY_TIMER
comma
id|lt
)paren
suffix:semicolon
)brace
multiline_comment|/* set base Latency Timer */
id|rc
op_or_assign
id|pci_bus_write_config_byte
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_LATENCY_TIMER
comma
id|lt
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  set latency timer  =0x%02x: %x&bslash;n&quot;
comma
id|lt
comma
id|rc
)paren
suffix:semicolon
id|rc
op_or_assign
id|pci_bus_write_config_byte
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_CACHE_LINE_SIZE
comma
id|cls
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  set cache_line_size=0x%02x: %x&bslash;n&quot;
comma
id|cls
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|pciehprm_enable_card
r_void
id|pciehprm_enable_card
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
comma
id|u8
id|card_type
)paren
(brace
id|u16
id|command
comma
id|cmd
comma
id|bcommand
comma
id|bcmd
suffix:semicolon
r_struct
id|pci_bus
id|lpci_bus
comma
op_star
id|pci_bus
suffix:semicolon
r_struct
id|acpi_bridge
op_star
id|ab
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|lpci_bus
comma
id|ctrl-&gt;pci_bus
comma
r_sizeof
(paren
id|lpci_bus
)paren
)paren
suffix:semicolon
id|pci_bus
op_assign
op_amp
id|lpci_bus
suffix:semicolon
id|pci_bus-&gt;number
op_assign
id|func-&gt;bus
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|rc
op_assign
id|pci_bus_read_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
id|rc
op_assign
id|pci_bus_read_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_BRIDGE_CONTROL
comma
op_amp
id|bcommand
)paren
suffix:semicolon
)brace
id|cmd
op_assign
id|command
op_assign
id|command
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_INVALIDATE
op_or
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
suffix:semicolon
id|bcmd
op_assign
id|bcommand
op_assign
id|bcommand
op_or
id|PCI_BRIDGE_CTL_NO_ISA
suffix:semicolon
id|ab
op_assign
id|find_acpi_bridge_by_bus
c_func
(paren
id|acpi_bridges_head
comma
id|ctrl-&gt;seg
comma
id|ctrl-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ab
)paren
(brace
r_if
c_cond
(paren
id|ab-&gt;_hpp
)paren
(brace
r_if
c_cond
(paren
id|ab-&gt;_hpp-&gt;enable_perr
)paren
(brace
id|command
op_or_assign
id|PCI_COMMAND_PARITY
suffix:semicolon
id|bcommand
op_or_assign
id|PCI_BRIDGE_CTL_PARITY
suffix:semicolon
)brace
r_else
(brace
id|command
op_and_assign
op_complement
id|PCI_COMMAND_PARITY
suffix:semicolon
id|bcommand
op_and_assign
op_complement
id|PCI_BRIDGE_CTL_PARITY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ab-&gt;_hpp-&gt;enable_serr
)paren
(brace
id|command
op_or_assign
id|PCI_COMMAND_SERR
suffix:semicolon
id|bcommand
op_or_assign
id|PCI_BRIDGE_CTL_SERR
suffix:semicolon
)brace
r_else
(brace
id|command
op_and_assign
op_complement
id|PCI_COMMAND_SERR
suffix:semicolon
id|bcommand
op_and_assign
op_complement
id|PCI_BRIDGE_CTL_SERR
suffix:semicolon
)brace
)brace
r_else
id|dbg
c_func
(paren
l_string|&quot;no _hpp for B/D/F = %#x/%#x/%#x.&bslash;n&quot;
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
)brace
r_else
id|dbg
c_func
(paren
l_string|&quot;no acpi bridge for B/D/F = %#x/%#x/%#x.&bslash;n&quot;
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
op_ne
id|cmd
)paren
(brace
id|rc
op_assign
id|pci_bus_write_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|card_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
op_logical_and
(paren
id|bcommand
op_ne
id|bcmd
)paren
)paren
(brace
id|rc
op_assign
id|pci_bus_write_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_BRIDGE_CONTROL
comma
id|bcommand
)paren
suffix:semicolon
)brace
)brace
eof
