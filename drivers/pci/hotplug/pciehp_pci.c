multiline_comment|/*&n; * PCI Express Hot Plug Controller Driver&n; *&n; * Copyright (C) 1995,2001 Compaq Computer Corporation&n; * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (C) 2001 IBM Corp.&n; * Copyright (C) 2003-2004 Intel Corporation&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;greg@kroah.com&gt;, &lt;dely.l.sy@intel.com&gt;&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &quot;../pci.h&quot;
macro_line|#include &quot;pciehp.h&quot;
macro_line|#ifndef CONFIG_IA64
macro_line|#include &quot;../../../arch/i386/pci/pci.h&quot;    /* horrible hack showing how processor dependant we are... */
macro_line|#endif
DECL|function|pciehp_configure_device
r_int
id|pciehp_configure_device
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_int
r_char
id|bus
suffix:semicolon
r_struct
id|pci_bus
op_star
id|child
suffix:semicolon
r_int
id|num
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;pci_dev
op_eq
l_int|NULL
)paren
id|func-&gt;pci_dev
op_assign
id|pci_find_slot
c_func
(paren
id|func-&gt;bus
comma
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
)paren
suffix:semicolon
multiline_comment|/* Still NULL ? Well then scan for it ! */
r_if
c_cond
(paren
id|func-&gt;pci_dev
op_eq
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: pci_dev still null. do pci_scan_slot&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|num
op_assign
id|pci_scan_slot
c_func
(paren
id|ctrl-&gt;pci_dev-&gt;subordinate
comma
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num
)paren
id|pci_bus_add_devices
c_func
(paren
id|ctrl-&gt;pci_dev-&gt;subordinate
)paren
suffix:semicolon
id|func-&gt;pci_dev
op_assign
id|pci_find_slot
c_func
(paren
id|func-&gt;bus
comma
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;pci_dev
op_eq
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;ERROR: pci_dev still null&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|func-&gt;pci_dev-&gt;hdr_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|func-&gt;pci_dev
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|bus
)paren
suffix:semicolon
id|child
op_assign
(paren
r_struct
id|pci_bus
op_star
)paren
id|pci_add_new_bus
c_func
(paren
id|func-&gt;pci_dev-&gt;bus
comma
(paren
id|func-&gt;pci_dev
)paren
comma
id|bus
)paren
suffix:semicolon
id|pci_do_scan_bus
c_func
(paren
id|child
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pciehp_unconfigure_device
r_int
id|pciehp_unconfigure_device
c_func
(paren
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|j
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: bus/dev/func = %x/%x/%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|pci_dev
op_star
id|temp
op_assign
id|pci_find_slot
c_func
(paren
id|func-&gt;bus
comma
(paren
id|func-&gt;device
op_lshift
l_int|3
)paren
op_or
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
)paren
(brace
id|pci_remove_bus_device
c_func
(paren
id|temp
)paren
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * pciehp_set_irq&n; *&n; * @bus_num: bus number of PCI device&n; * @dev_num: device number of PCI device&n; * @slot: pointer to u8 where slot number will be returned&n; */
DECL|function|pciehp_set_irq
r_int
id|pciehp_set_irq
(paren
id|u8
id|bus_num
comma
id|u8
id|dev_num
comma
id|u8
id|int_pin
comma
id|u8
id|irq_num
)paren
(brace
macro_line|#if defined(CONFIG_X86) &amp;&amp; !defined(CONFIG_X86_IO_APIC) &amp;&amp; !defined(CONFIG_X86_64)
r_int
id|rc
suffix:semicolon
id|u16
id|temp_word
suffix:semicolon
r_struct
id|pci_dev
id|fakedev
suffix:semicolon
r_struct
id|pci_bus
id|fakebus
suffix:semicolon
id|fakedev.devfn
op_assign
id|dev_num
op_lshift
l_int|3
suffix:semicolon
id|fakedev.bus
op_assign
op_amp
id|fakebus
suffix:semicolon
id|fakebus.number
op_assign
id|bus_num
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: dev %d, bus %d, pin %d, num %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev_num
comma
id|bus_num
comma
id|int_pin
comma
id|irq_num
)paren
suffix:semicolon
id|rc
op_assign
id|pcibios_set_irq_routing
c_func
(paren
op_amp
id|fakedev
comma
id|int_pin
op_minus
l_int|0x0a
comma
id|irq_num
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: rc %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
r_return
op_logical_neg
id|rc
suffix:semicolon
multiline_comment|/* set the Edge Level Control Register (ELCR) */
id|temp_word
op_assign
id|inb
c_func
(paren
l_int|0x4d0
)paren
suffix:semicolon
id|temp_word
op_or_assign
id|inb
c_func
(paren
l_int|0x4d1
)paren
op_lshift
l_int|8
suffix:semicolon
id|temp_word
op_or_assign
l_int|0x01
op_lshift
id|irq_num
suffix:semicolon
multiline_comment|/* This should only be for x86 as it sets the Edge Level Control Register */
id|outb
c_func
(paren
(paren
id|u8
)paren
(paren
id|temp_word
op_amp
l_int|0xFF
)paren
comma
l_int|0x4d0
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|u8
)paren
(paren
(paren
id|temp_word
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
comma
l_int|0x4d1
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* More PCI configuration routines; this time centered around hotplug controller */
multiline_comment|/*&n; * pciehp_save_config&n; *&n; * Reads configuration for all slots in a PCI bus and saves info.&n; *&n; * Note:  For non-hot plug busses, the slot # saved is the device #&n; *&n; * returns 0 if success&n; */
DECL|function|pciehp_save_config
r_int
id|pciehp_save_config
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_int
id|busnumber
comma
r_int
id|num_ctlr_slots
comma
r_int
id|first_device_num
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u8
id|class_code
suffix:semicolon
id|u8
id|header_type
suffix:semicolon
id|u32
id|ID
suffix:semicolon
id|u8
id|secondary_bus
suffix:semicolon
r_struct
id|pci_func
op_star
id|new_slot
suffix:semicolon
r_int
id|sub_bus
suffix:semicolon
r_int
id|max_functions
suffix:semicolon
r_int
id|function
suffix:semicolon
id|u8
id|DevError
suffix:semicolon
r_int
id|device
op_assign
l_int|0
suffix:semicolon
r_int
id|cloop
op_assign
l_int|0
suffix:semicolon
r_int
id|stop_it
suffix:semicolon
r_int
id|index
suffix:semicolon
r_int
id|is_hot_plug
op_assign
id|num_ctlr_slots
op_logical_or
id|first_device_num
suffix:semicolon
r_struct
id|pci_bus
id|lpci_bus
comma
op_star
id|pci_bus
suffix:semicolon
r_int
id|FirstSupported
comma
id|LastSupported
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|lpci_bus
comma
id|ctrl-&gt;pci_dev-&gt;subordinate
comma
r_sizeof
(paren
id|lpci_bus
)paren
)paren
suffix:semicolon
id|pci_bus
op_assign
op_amp
id|lpci_bus
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: num_ctlr_slots = %d, first_device_num = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|num_ctlr_slots
comma
id|first_device_num
)paren
suffix:semicolon
multiline_comment|/*   Decide which slots are supported */
r_if
c_cond
(paren
id|is_hot_plug
)paren
(brace
multiline_comment|/*********************************&n;&t;&t; *  is_hot_plug is the slot mask&n;&t;&t; *********************************/
id|FirstSupported
op_assign
id|first_device_num
suffix:semicolon
id|LastSupported
op_assign
id|FirstSupported
op_plus
id|num_ctlr_slots
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|FirstSupported
op_assign
l_int|0
suffix:semicolon
id|LastSupported
op_assign
l_int|0x1F
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;FirstSupported = %d, LastSupported = %d&bslash;n&quot;
comma
id|FirstSupported
comma
id|LastSupported
)paren
suffix:semicolon
multiline_comment|/*   Save PCI configuration space for all devices in supported slots */
id|dbg
c_func
(paren
l_string|&quot;%s: pci_bus-&gt;number = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pci_bus-&gt;number
)paren
suffix:semicolon
id|pci_bus-&gt;number
op_assign
id|busnumber
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: bus = %x, dev = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|busnumber
comma
id|device
)paren
suffix:semicolon
r_for
c_loop
(paren
id|device
op_assign
id|FirstSupported
suffix:semicolon
id|device
op_le
id|LastSupported
suffix:semicolon
id|device
op_increment
)paren
(brace
id|ID
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|rc
op_assign
id|pci_bus_read_config_dword
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
l_int|0
)paren
comma
id|PCI_VENDOR_ID
comma
op_amp
id|ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ID
op_ne
l_int|0xFFFFFFFF
)paren
(brace
multiline_comment|/*  device in slot */
id|dbg
c_func
(paren
l_string|&quot;%s: ID = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ID
)paren
suffix:semicolon
id|rc
op_assign
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
l_int|0
)paren
comma
l_int|0x0B
comma
op_amp
id|class_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
l_int|0
)paren
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|header_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;class_code = %x, header_type = %x&bslash;n&quot;
comma
id|class_code
comma
id|header_type
)paren
suffix:semicolon
multiline_comment|/* If multi-function device, set max_functions to 8 */
r_if
c_cond
(paren
id|header_type
op_amp
l_int|0x80
)paren
id|max_functions
op_assign
l_int|8
suffix:semicolon
r_else
id|max_functions
op_assign
l_int|1
suffix:semicolon
id|function
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|DevError
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: In do loop&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|header_type
op_amp
l_int|0x7F
)paren
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
multiline_comment|/* P-P Bridge */
multiline_comment|/* Recurse the subordinate bus&n;&t;&t;&t;&t;&t; * get the subordinate bus number&n;&t;&t;&t;&t;&t; */
id|rc
op_assign
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|secondary_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
id|sub_bus
op_assign
(paren
r_int
)paren
id|secondary_bus
suffix:semicolon
multiline_comment|/* Save secondary bus cfg spc with this recursive call. */
id|rc
op_assign
id|pciehp_save_config
c_func
(paren
id|ctrl
comma
id|sub_bus
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
)brace
)brace
id|index
op_assign
l_int|0
suffix:semicolon
id|new_slot
op_assign
id|pciehp_slot_find
c_func
(paren
id|busnumber
comma
id|device
comma
id|index
op_increment
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: new_slot = %p bus %x dev %x fun %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|new_slot
comma
id|busnumber
comma
id|device
comma
id|index
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|new_slot
op_logical_and
(paren
id|new_slot-&gt;function
op_ne
(paren
id|u8
)paren
id|function
)paren
)paren
(brace
id|new_slot
op_assign
id|pciehp_slot_find
c_func
(paren
id|busnumber
comma
id|device
comma
id|index
op_increment
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: while loop, new_slot = %p bus %x dev %x fun %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|new_slot
comma
id|busnumber
comma
id|device
comma
id|index
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|new_slot
)paren
(brace
multiline_comment|/* Setup slot structure. */
id|new_slot
op_assign
id|pciehp_slot_create
c_func
(paren
id|busnumber
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: if, new_slot = %p bus %x dev %x fun %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|new_slot
comma
id|busnumber
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_slot
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
)brace
id|new_slot-&gt;bus
op_assign
(paren
id|u8
)paren
id|busnumber
suffix:semicolon
id|new_slot-&gt;device
op_assign
(paren
id|u8
)paren
id|device
suffix:semicolon
id|new_slot-&gt;function
op_assign
(paren
id|u8
)paren
id|function
suffix:semicolon
id|new_slot-&gt;is_a_board
op_assign
l_int|1
suffix:semicolon
id|new_slot-&gt;switch_save
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* In case of unsupported board */
id|new_slot-&gt;status
op_assign
id|DevError
suffix:semicolon
id|new_slot-&gt;pci_dev
op_assign
id|pci_find_slot
c_func
(paren
id|new_slot-&gt;bus
comma
(paren
id|new_slot-&gt;device
op_lshift
l_int|3
)paren
op_or
id|new_slot-&gt;function
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;new_slot-&gt;pci_dev = %p&bslash;n&quot;
comma
id|new_slot-&gt;pci_dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cloop
op_assign
l_int|0
suffix:semicolon
id|cloop
OL
l_int|0x20
suffix:semicolon
id|cloop
op_increment
)paren
(brace
id|rc
op_assign
id|pci_bus_read_config_dword
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
comma
id|cloop
op_lshift
l_int|2
comma
(paren
id|u32
op_star
)paren
op_amp
(paren
id|new_slot-&gt;config_space
(braket
id|cloop
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* dbg(&quot;new_slot-&gt;config_space[%x] = %x&bslash;n&quot;, cloop, new_slot-&gt;config_space[cloop]); */
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
)brace
id|function
op_increment
suffix:semicolon
id|stop_it
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  this loop skips to the next present function&n;&t;&t;&t;&t; *  reading in Class Code and Header type.&n;&t;&t;&t;&t; */
r_while
c_loop
(paren
(paren
id|function
OL
id|max_functions
)paren
op_logical_and
(paren
op_logical_neg
id|stop_it
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: In while loop &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|rc
op_assign
id|pci_bus_read_config_dword
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
comma
id|PCI_VENDOR_ID
comma
op_amp
id|ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ID
op_eq
l_int|0xFFFFFFFF
)paren
(brace
multiline_comment|/* nothing there. */
id|function
op_increment
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Nothing there&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Something there */
id|rc
op_assign
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
comma
l_int|0x0B
comma
op_amp
id|class_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|header_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;class_code = %x, header_type = %x&bslash;n&quot;
comma
id|class_code
comma
id|header_type
)paren
suffix:semicolon
id|stop_it
op_increment
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|function
OL
id|max_functions
)paren
suffix:semicolon
)brace
multiline_comment|/* End of IF (device in slot?) */
r_else
r_if
c_cond
(paren
id|is_hot_plug
)paren
(brace
multiline_comment|/* Setup slot structure with entry for empty slot */
id|new_slot
op_assign
id|pciehp_slot_create
c_func
(paren
id|busnumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_slot
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;new_slot = %p, bus = %x, dev = %x, fun = %x&bslash;n&quot;
comma
id|new_slot
comma
id|new_slot-&gt;bus
comma
id|new_slot-&gt;device
comma
id|new_slot-&gt;function
)paren
suffix:semicolon
id|new_slot-&gt;bus
op_assign
(paren
id|u8
)paren
id|busnumber
suffix:semicolon
id|new_slot-&gt;device
op_assign
(paren
id|u8
)paren
id|device
suffix:semicolon
id|new_slot-&gt;function
op_assign
l_int|0
suffix:semicolon
id|new_slot-&gt;is_a_board
op_assign
l_int|0
suffix:semicolon
id|new_slot-&gt;presence_save
op_assign
l_int|0
suffix:semicolon
id|new_slot-&gt;switch_save
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* End of FOR loop */
id|dbg
c_func
(paren
l_string|&quot;%s: Exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * pciehp_save_slot_config&n; *&n; * Saves configuration info for all PCI devices in a given slot&n; * including subordinate busses.&n; *&n; * returns 0 if success&n; */
DECL|function|pciehp_save_slot_config
r_int
id|pciehp_save_slot_config
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|new_slot
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u8
id|class_code
suffix:semicolon
id|u8
id|header_type
suffix:semicolon
id|u32
id|ID
suffix:semicolon
id|u8
id|secondary_bus
suffix:semicolon
r_int
id|sub_bus
suffix:semicolon
r_int
id|max_functions
suffix:semicolon
r_int
id|function
suffix:semicolon
r_int
id|cloop
op_assign
l_int|0
suffix:semicolon
r_int
id|stop_it
suffix:semicolon
r_struct
id|pci_bus
id|lpci_bus
comma
op_star
id|pci_bus
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|lpci_bus
comma
id|ctrl-&gt;pci_dev-&gt;subordinate
comma
r_sizeof
(paren
id|lpci_bus
)paren
)paren
suffix:semicolon
id|pci_bus
op_assign
op_amp
id|lpci_bus
suffix:semicolon
id|pci_bus-&gt;number
op_assign
id|new_slot-&gt;bus
suffix:semicolon
id|ID
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|pci_bus_read_config_dword
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|new_slot-&gt;device
comma
l_int|0
)paren
comma
id|PCI_VENDOR_ID
comma
op_amp
id|ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ID
op_ne
l_int|0xFFFFFFFF
)paren
(brace
multiline_comment|/*  device in slot */
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|new_slot-&gt;device
comma
l_int|0
)paren
comma
l_int|0x0B
comma
op_amp
id|class_code
)paren
suffix:semicolon
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|new_slot-&gt;device
comma
l_int|0
)paren
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|header_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header_type
op_amp
l_int|0x80
)paren
multiline_comment|/* Multi-function device */
id|max_functions
op_assign
l_int|8
suffix:semicolon
r_else
id|max_functions
op_assign
l_int|1
suffix:semicolon
id|function
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
(paren
id|header_type
op_amp
l_int|0x7F
)paren
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
multiline_comment|/* PCI-PCI Bridge */
multiline_comment|/*  Recurse the subordinate bus */
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|new_slot-&gt;device
comma
id|function
)paren
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|secondary_bus
)paren
suffix:semicolon
id|sub_bus
op_assign
(paren
r_int
)paren
id|secondary_bus
suffix:semicolon
multiline_comment|/* Save the config headers for the secondary bus. */
id|rc
op_assign
id|pciehp_save_config
c_func
(paren
id|ctrl
comma
id|sub_bus
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* End of IF */
id|new_slot-&gt;status
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cloop
op_assign
l_int|0
suffix:semicolon
id|cloop
OL
l_int|0x20
suffix:semicolon
id|cloop
op_increment
)paren
(brace
id|pci_bus_read_config_dword
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|new_slot-&gt;device
comma
id|function
)paren
comma
id|cloop
op_lshift
l_int|2
comma
(paren
id|u32
op_star
)paren
op_amp
(paren
id|new_slot-&gt;config_space
(braket
id|cloop
)braket
)paren
)paren
suffix:semicolon
)brace
id|function
op_increment
suffix:semicolon
id|stop_it
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  this loop skips to the next present function&n;&t;&t;&t; *  reading in the Class Code and the Header type.&n;&t;&t;&t; */
r_while
c_loop
(paren
(paren
id|function
OL
id|max_functions
)paren
op_logical_and
(paren
op_logical_neg
id|stop_it
)paren
)paren
(brace
id|pci_bus_read_config_dword
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|new_slot-&gt;device
comma
id|function
)paren
comma
id|PCI_VENDOR_ID
comma
op_amp
id|ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ID
op_eq
l_int|0xFFFFFFFF
)paren
(brace
multiline_comment|/* nothing there. */
id|function
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Something there */
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|new_slot-&gt;device
comma
id|function
)paren
comma
l_int|0x0B
comma
op_amp
id|class_code
)paren
suffix:semicolon
id|pci_bus_read_config_byte
c_func
(paren
id|pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|new_slot-&gt;device
comma
id|function
)paren
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|header_type
)paren
suffix:semicolon
id|stop_it
op_increment
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|function
OL
id|max_functions
)paren
suffix:semicolon
)brace
multiline_comment|/* End of IF (device in slot?) */
r_else
(brace
r_return
l_int|2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * pciehp_save_used_resources&n; *&n; * Stores used resource information for existing boards.  this is&n; * for boards that were in the system when this driver was loaded.&n; * this function is for hot plug ADD&n; *&n; * returns 0 if success&n; * if disable  == 1(DISABLE_CARD),&n; *  it loops for all functions of the slot and disables them.&n; * else, it just get resources of the function and return.&n; */
DECL|function|pciehp_save_used_resources
r_int
id|pciehp_save_used_resources
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
comma
r_int
id|disable
)paren
(brace
id|u8
id|cloop
suffix:semicolon
id|u8
id|header_type
suffix:semicolon
id|u8
id|secondary_bus
suffix:semicolon
id|u8
id|temp_byte
suffix:semicolon
id|u16
id|command
suffix:semicolon
id|u16
id|save_command
suffix:semicolon
id|u16
id|w_base
comma
id|w_length
suffix:semicolon
id|u32
id|temp_register
suffix:semicolon
id|u32
id|save_base
suffix:semicolon
id|u32
id|base
comma
id|length
suffix:semicolon
id|u64
id|base64
op_assign
l_int|0
suffix:semicolon
r_int
id|index
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
r_struct
id|pci_resource
op_star
id|mem_node
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|pci_resource
op_star
id|p_mem_node
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|pci_resource
op_star
id|t_mem_node
suffix:semicolon
r_struct
id|pci_resource
op_star
id|io_node
suffix:semicolon
r_struct
id|pci_resource
op_star
id|bus_node
suffix:semicolon
r_struct
id|pci_bus
id|lpci_bus
comma
op_star
id|pci_bus
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|lpci_bus
comma
id|ctrl-&gt;pci_dev-&gt;subordinate
comma
r_sizeof
(paren
id|lpci_bus
)paren
)paren
suffix:semicolon
id|pci_bus
op_assign
op_amp
id|lpci_bus
suffix:semicolon
r_if
c_cond
(paren
id|disable
)paren
id|func
op_assign
id|pciehp_slot_find
c_func
(paren
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|index
op_increment
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|func
op_ne
l_int|NULL
)paren
op_logical_and
id|func-&gt;is_a_board
)paren
(brace
id|pci_bus-&gt;number
op_assign
id|func-&gt;bus
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
multiline_comment|/* Save the command register */
id|pci_bus_read_config_word
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
op_amp
id|save_command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disable
)paren
(brace
multiline_comment|/* disable card */
id|command
op_assign
l_int|0x00
suffix:semicolon
id|pci_bus_write_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
)brace
multiline_comment|/* Check for Bridge */
id|pci_bus_read_config_byte
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|header_type
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|header_type
op_amp
l_int|0x7F
)paren
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
multiline_comment|/* PCI-PCI Bridge */
id|dbg
c_func
(paren
l_string|&quot;Save_used_res of PCI bridge b:d=0x%x:%x, sc=0x%x&bslash;n&quot;
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|save_command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disable
)paren
(brace
multiline_comment|/* Clear Bridge Control Register */
id|command
op_assign
l_int|0x00
suffix:semicolon
id|pci_bus_write_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_BRIDGE_CONTROL
comma
id|command
)paren
suffix:semicolon
)brace
id|pci_bus_read_config_byte
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|secondary_bus
)paren
suffix:semicolon
id|pci_bus_read_config_byte
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_SUBORDINATE_BUS
comma
op_amp
id|temp_byte
)paren
suffix:semicolon
id|bus_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|bus_node-&gt;base
op_assign
(paren
id|ulong
)paren
id|secondary_bus
suffix:semicolon
id|bus_node-&gt;length
op_assign
(paren
id|ulong
)paren
(paren
id|temp_byte
op_minus
id|secondary_bus
op_plus
l_int|1
)paren
suffix:semicolon
id|bus_node-&gt;next
op_assign
id|func-&gt;bus_head
suffix:semicolon
id|func-&gt;bus_head
op_assign
id|bus_node
suffix:semicolon
multiline_comment|/* Save IO base and Limit registers */
id|pci_bus_read_config_byte
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_IO_BASE
comma
op_amp
id|temp_byte
)paren
suffix:semicolon
id|base
op_assign
id|temp_byte
suffix:semicolon
id|pci_bus_read_config_byte
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_IO_LIMIT
comma
op_amp
id|temp_byte
)paren
suffix:semicolon
id|length
op_assign
id|temp_byte
suffix:semicolon
r_if
c_cond
(paren
(paren
id|base
op_le
id|length
)paren
op_logical_and
(paren
op_logical_neg
id|disable
op_logical_or
(paren
id|save_command
op_amp
id|PCI_COMMAND_IO
)paren
)paren
)paren
(brace
id|io_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|io_node-&gt;base
op_assign
(paren
id|ulong
)paren
(paren
id|base
op_amp
id|PCI_IO_RANGE_MASK
)paren
op_lshift
l_int|8
suffix:semicolon
id|io_node-&gt;length
op_assign
(paren
id|ulong
)paren
(paren
id|length
op_minus
id|base
op_plus
l_int|0x10
)paren
op_lshift
l_int|8
suffix:semicolon
id|io_node-&gt;next
op_assign
id|func-&gt;io_head
suffix:semicolon
id|func-&gt;io_head
op_assign
id|io_node
suffix:semicolon
)brace
multiline_comment|/* Save memory base and Limit registers */
id|pci_bus_read_config_word
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_MEMORY_BASE
comma
op_amp
id|w_base
)paren
suffix:semicolon
id|pci_bus_read_config_word
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_MEMORY_LIMIT
comma
op_amp
id|w_length
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|w_base
op_le
id|w_length
)paren
op_logical_and
(paren
op_logical_neg
id|disable
op_logical_or
(paren
id|save_command
op_amp
id|PCI_COMMAND_MEMORY
)paren
)paren
)paren
(brace
id|mem_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|mem_node-&gt;base
op_assign
(paren
id|ulong
)paren
id|w_base
op_lshift
l_int|16
suffix:semicolon
id|mem_node-&gt;length
op_assign
(paren
id|ulong
)paren
(paren
id|w_length
op_minus
id|w_base
op_plus
l_int|0x10
)paren
op_lshift
l_int|16
suffix:semicolon
id|mem_node-&gt;next
op_assign
id|func-&gt;mem_head
suffix:semicolon
id|func-&gt;mem_head
op_assign
id|mem_node
suffix:semicolon
)brace
multiline_comment|/* Save prefetchable memory base and Limit registers */
id|pci_bus_read_config_word
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_PREF_MEMORY_BASE
comma
op_amp
id|w_base
)paren
suffix:semicolon
id|pci_bus_read_config_word
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_PREF_MEMORY_LIMIT
comma
op_amp
id|w_length
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|w_base
op_le
id|w_length
)paren
op_logical_and
(paren
op_logical_neg
id|disable
op_logical_or
(paren
id|save_command
op_amp
id|PCI_COMMAND_MEMORY
)paren
)paren
)paren
(brace
id|p_mem_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p_mem_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|p_mem_node-&gt;base
op_assign
(paren
id|ulong
)paren
id|w_base
op_lshift
l_int|16
suffix:semicolon
id|p_mem_node-&gt;length
op_assign
(paren
id|ulong
)paren
(paren
id|w_length
op_minus
id|w_base
op_plus
l_int|0x10
)paren
op_lshift
l_int|16
suffix:semicolon
id|p_mem_node-&gt;next
op_assign
id|func-&gt;p_mem_head
suffix:semicolon
id|func-&gt;p_mem_head
op_assign
id|p_mem_node
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|header_type
op_amp
l_int|0x7F
)paren
op_eq
id|PCI_HEADER_TYPE_NORMAL
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Save_used_res of PCI adapter b:d=0x%x:%x, sc=0x%x&bslash;n&quot;
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|save_command
)paren
suffix:semicolon
multiline_comment|/* Figure out IO and memory base lengths */
r_for
c_loop
(paren
id|cloop
op_assign
id|PCI_BASE_ADDRESS_0
suffix:semicolon
id|cloop
op_le
id|PCI_BASE_ADDRESS_5
suffix:semicolon
id|cloop
op_add_assign
l_int|4
)paren
(brace
id|pci_bus_read_config_dword
(paren
id|pci_bus
comma
id|devfn
comma
id|cloop
comma
op_amp
id|save_base
)paren
suffix:semicolon
id|temp_register
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|pci_bus_write_config_dword
(paren
id|pci_bus
comma
id|devfn
comma
id|cloop
comma
id|temp_register
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|pci_bus
comma
id|devfn
comma
id|cloop
comma
op_amp
id|temp_register
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disable
)paren
(brace
id|pci_bus_write_config_dword
(paren
id|pci_bus
comma
id|devfn
comma
id|cloop
comma
id|save_base
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|temp_register
)paren
r_continue
suffix:semicolon
id|base
op_assign
id|temp_register
suffix:semicolon
r_if
c_cond
(paren
(paren
id|base
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
op_logical_and
(paren
op_logical_neg
id|disable
op_logical_or
(paren
id|save_command
op_amp
id|PCI_COMMAND_IO
)paren
)paren
)paren
(brace
multiline_comment|/* IO base */
multiline_comment|/* set temp_register = amount of IO space requested */
id|base
op_assign
id|base
op_amp
l_int|0xFFFFFFFCL
suffix:semicolon
id|base
op_assign
(paren
op_complement
id|base
)paren
op_plus
l_int|1
suffix:semicolon
id|io_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|io_node-&gt;base
op_assign
(paren
id|ulong
)paren
id|save_base
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|io_node-&gt;length
op_assign
(paren
id|ulong
)paren
id|base
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;sur adapter: IO bar=0x%x(length=0x%x)&bslash;n&quot;
comma
id|io_node-&gt;base
comma
id|io_node-&gt;length
)paren
suffix:semicolon
id|io_node-&gt;next
op_assign
id|func-&gt;io_head
suffix:semicolon
id|func-&gt;io_head
op_assign
id|io_node
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* map Memory */
r_int
id|prefetchable
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* struct pci_resources **res_node; */
r_char
op_star
id|res_type_str
op_assign
l_string|&quot;PMEM&quot;
suffix:semicolon
id|u32
id|temp_register2
suffix:semicolon
id|t_mem_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|t_mem_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|base
op_amp
id|PCI_BASE_ADDRESS_MEM_PREFETCH
)paren
op_logical_and
(paren
op_logical_neg
id|disable
op_logical_or
(paren
id|save_command
op_amp
id|PCI_COMMAND_MEMORY
)paren
)paren
)paren
(brace
id|prefetchable
op_assign
l_int|0
suffix:semicolon
id|mem_node
op_assign
id|t_mem_node
suffix:semicolon
id|res_type_str
op_increment
suffix:semicolon
)brace
r_else
id|p_mem_node
op_assign
id|t_mem_node
suffix:semicolon
id|base
op_assign
id|base
op_amp
l_int|0xFFFFFFF0L
suffix:semicolon
id|base
op_assign
(paren
op_complement
id|base
)paren
op_plus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|temp_register
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_MASK
)paren
(brace
r_case
id|PCI_BASE_ADDRESS_MEM_TYPE_32
suffix:colon
r_if
c_cond
(paren
id|prefetchable
)paren
(brace
id|p_mem_node-&gt;base
op_assign
(paren
id|ulong
)paren
id|save_base
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|p_mem_node-&gt;length
op_assign
(paren
id|ulong
)paren
id|base
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;sur adapter: 32 %s bar=0x%x(length=0x%x)&bslash;n&quot;
comma
id|res_type_str
comma
id|p_mem_node-&gt;base
comma
id|p_mem_node-&gt;length
)paren
suffix:semicolon
id|p_mem_node-&gt;next
op_assign
id|func-&gt;p_mem_head
suffix:semicolon
id|func-&gt;p_mem_head
op_assign
id|p_mem_node
suffix:semicolon
)brace
r_else
(brace
id|mem_node-&gt;base
op_assign
(paren
id|ulong
)paren
id|save_base
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|mem_node-&gt;length
op_assign
(paren
id|ulong
)paren
id|base
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;sur adapter: 32 %s bar=0x%x(length=0x%x)&bslash;n&quot;
comma
id|res_type_str
comma
id|mem_node-&gt;base
comma
id|mem_node-&gt;length
)paren
suffix:semicolon
id|mem_node-&gt;next
op_assign
id|func-&gt;mem_head
suffix:semicolon
id|func-&gt;mem_head
op_assign
id|mem_node
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PCI_BASE_ADDRESS_MEM_TYPE_64
suffix:colon
id|pci_bus_read_config_dword
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|cloop
op_plus
l_int|4
comma
op_amp
id|temp_register2
)paren
suffix:semicolon
id|base64
op_assign
id|temp_register2
suffix:semicolon
id|base64
op_assign
(paren
id|base64
op_lshift
l_int|32
)paren
op_or
id|save_base
suffix:semicolon
r_if
c_cond
(paren
id|temp_register2
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;sur adapter: 64 %s high dword of base64(0x%x:%x) masked to 0&bslash;n&quot;
comma
id|res_type_str
comma
id|temp_register2
comma
(paren
id|u32
)paren
id|base64
)paren
suffix:semicolon
id|base64
op_and_assign
l_int|0x00000000FFFFFFFFL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prefetchable
)paren
(brace
id|p_mem_node-&gt;base
op_assign
id|base64
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|p_mem_node-&gt;length
op_assign
id|base
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;sur adapter: 64 %s base=0x%x(len=0x%x)&bslash;n&quot;
comma
id|res_type_str
comma
id|p_mem_node-&gt;base
comma
id|p_mem_node-&gt;length
)paren
suffix:semicolon
id|p_mem_node-&gt;next
op_assign
id|func-&gt;p_mem_head
suffix:semicolon
id|func-&gt;p_mem_head
op_assign
id|p_mem_node
suffix:semicolon
)brace
r_else
(brace
id|mem_node-&gt;base
op_assign
id|base64
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|mem_node-&gt;length
op_assign
id|base
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;sur adapter: 64 %s base=0x%x(len=0x%x)&bslash;n&quot;
comma
id|res_type_str
comma
id|mem_node-&gt;base
comma
id|mem_node-&gt;length
)paren
suffix:semicolon
id|mem_node-&gt;next
op_assign
id|func-&gt;mem_head
suffix:semicolon
id|func-&gt;mem_head
op_assign
id|mem_node
suffix:semicolon
)brace
id|cloop
op_add_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;asur: reserved BAR type=0x%x&bslash;n&quot;
comma
id|temp_register
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* End of base register loop */
)brace
r_else
(brace
multiline_comment|/* Some other unknown header type */
id|dbg
c_func
(paren
l_string|&quot;Save_used_res of PCI unknown type b:d=0x%x:%x. skip.&bslash;n&quot;
comma
id|func-&gt;bus
comma
id|func-&gt;device
)paren
suffix:semicolon
)brace
multiline_comment|/* find the next device in this slot */
r_if
c_cond
(paren
op_logical_neg
id|disable
)paren
r_break
suffix:semicolon
id|func
op_assign
id|pciehp_slot_find
c_func
(paren
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|index
op_increment
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * kfree_resource_list: release memory of all list members&n; * @res: resource list to free&n; */
r_static
r_inline
r_void
DECL|function|return_resource_list
id|return_resource_list
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|func
comma
r_struct
id|pci_resource
op_star
op_star
id|res
)paren
(brace
r_struct
id|pci_resource
op_star
id|node
suffix:semicolon
r_struct
id|pci_resource
op_star
id|t_node
suffix:semicolon
id|node
op_assign
op_star
id|func
suffix:semicolon
op_star
id|func
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|node
)paren
(brace
id|t_node
op_assign
id|node-&gt;next
suffix:semicolon
id|return_resource
c_func
(paren
id|res
comma
id|node
)paren
suffix:semicolon
id|node
op_assign
id|t_node
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * pciehp_return_board_resources&n; *&n; * this routine returns all resources allocated to a board to&n; * the available pool.&n; *&n; * returns 0 if success&n; */
DECL|function|pciehp_return_board_resources
r_int
id|pciehp_return_board_resources
c_func
(paren
r_struct
id|pci_func
op_star
id|func
comma
r_struct
id|resource_lists
op_star
id|resources
)paren
(brace
r_int
id|rc
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|func
)paren
r_return
l_int|1
suffix:semicolon
id|return_resource_list
c_func
(paren
op_amp
(paren
id|func-&gt;io_head
)paren
comma
op_amp
(paren
id|resources-&gt;io_head
)paren
)paren
suffix:semicolon
id|return_resource_list
c_func
(paren
op_amp
(paren
id|func-&gt;mem_head
)paren
comma
op_amp
(paren
id|resources-&gt;mem_head
)paren
)paren
suffix:semicolon
id|return_resource_list
c_func
(paren
op_amp
(paren
id|func-&gt;p_mem_head
)paren
comma
op_amp
(paren
id|resources-&gt;p_mem_head
)paren
)paren
suffix:semicolon
id|return_resource_list
c_func
(paren
op_amp
(paren
id|func-&gt;bus_head
)paren
comma
op_amp
(paren
id|resources-&gt;bus_head
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
(paren
id|resources-&gt;mem_head
)paren
)paren
suffix:semicolon
id|rc
op_or_assign
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
(paren
id|resources-&gt;p_mem_head
)paren
)paren
suffix:semicolon
id|rc
op_or_assign
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
(paren
id|resources-&gt;io_head
)paren
)paren
suffix:semicolon
id|rc
op_or_assign
id|pciehp_resource_sort_and_combine
c_func
(paren
op_amp
(paren
id|resources-&gt;bus_head
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * kfree_resource_list: release memory of all list members&n; * @res: resource list to free&n; */
r_static
r_inline
r_void
DECL|function|kfree_resource_list
id|kfree_resource_list
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|r
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
comma
op_star
id|tres
suffix:semicolon
id|res
op_assign
op_star
id|r
suffix:semicolon
op_star
id|r
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * pciehp_destroy_resource_list: put node back in the resource list&n; * @resources: list to put nodes back&n; */
DECL|function|pciehp_destroy_resource_list
r_void
id|pciehp_destroy_resource_list
c_func
(paren
r_struct
id|resource_lists
op_star
id|resources
)paren
(brace
id|kfree_resource_list
c_func
(paren
op_amp
(paren
id|resources-&gt;io_head
)paren
)paren
suffix:semicolon
id|kfree_resource_list
c_func
(paren
op_amp
(paren
id|resources-&gt;mem_head
)paren
)paren
suffix:semicolon
id|kfree_resource_list
c_func
(paren
op_amp
(paren
id|resources-&gt;p_mem_head
)paren
)paren
suffix:semicolon
id|kfree_resource_list
c_func
(paren
op_amp
(paren
id|resources-&gt;bus_head
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * pciehp_destroy_board_resources: put node back in the resource list&n; * @resources: list to put nodes back&n; */
DECL|function|pciehp_destroy_board_resources
r_void
id|pciehp_destroy_board_resources
c_func
(paren
r_struct
id|pci_func
op_star
id|func
)paren
(brace
id|kfree_resource_list
c_func
(paren
op_amp
(paren
id|func-&gt;io_head
)paren
)paren
suffix:semicolon
id|kfree_resource_list
c_func
(paren
op_amp
(paren
id|func-&gt;mem_head
)paren
)paren
suffix:semicolon
id|kfree_resource_list
c_func
(paren
op_amp
(paren
id|func-&gt;p_mem_head
)paren
)paren
suffix:semicolon
id|kfree_resource_list
c_func
(paren
op_amp
(paren
id|func-&gt;bus_head
)paren
)paren
suffix:semicolon
)brace
eof
