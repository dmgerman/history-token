multiline_comment|/*&n; * RPA Virtual I/O device functions &n; * Copyright (C) 2004 Linda Xie &lt;lxie@us.ibm.com&gt;&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;lxie@us.ibm.com&gt;&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kobject.h&gt;
macro_line|#include &lt;linux/sysfs.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/rtas.h&gt;
macro_line|#include &quot;rpaphp.h&quot;
DECL|function|removable_read_file
r_static
id|ssize_t
id|removable_read_file
(paren
r_struct
id|hotplug_slot
op_star
id|php_slot
comma
r_char
op_star
id|buf
)paren
(brace
id|u8
id|value
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_struct
id|slot
op_star
id|slot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|php_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
r_return
id|retval
suffix:semicolon
id|value
op_assign
id|slot-&gt;removable
suffix:semicolon
id|retval
op_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|hotplug_slot_attr_removable
r_static
r_struct
id|hotplug_slot_attribute
id|hotplug_slot_attr_removable
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;phy_removable&quot;
comma
dot
id|mode
op_assign
id|S_IFREG
op_or
id|S_IRUGO
)brace
comma
dot
id|show
op_assign
id|removable_read_file
comma
)brace
suffix:semicolon
DECL|function|rpaphp_sysfs_add_attr_removable
r_static
r_void
id|rpaphp_sysfs_add_attr_removable
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
(brace
id|sysfs_create_file
c_func
(paren
op_amp
id|slot-&gt;kobj
comma
op_amp
id|hotplug_slot_attr_removable.attr
)paren
suffix:semicolon
)brace
DECL|function|rpaphp_sysfs_remove_attr_removable
r_static
r_void
id|rpaphp_sysfs_remove_attr_removable
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
(brace
id|sysfs_remove_file
c_func
(paren
op_amp
id|slot-&gt;kobj
comma
op_amp
id|hotplug_slot_attr_removable.attr
)paren
suffix:semicolon
)brace
DECL|function|location_read_file
r_static
id|ssize_t
id|location_read_file
(paren
r_struct
id|hotplug_slot
op_star
id|php_slot
comma
r_char
op_star
id|buf
)paren
(brace
r_char
op_star
id|value
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_struct
id|slot
op_star
id|slot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|php_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
r_return
id|retval
suffix:semicolon
id|value
op_assign
id|slot-&gt;location
suffix:semicolon
id|retval
op_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|hotplug_slot_attr_location
r_static
r_struct
id|hotplug_slot_attribute
id|hotplug_slot_attr_location
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;phy_location&quot;
comma
dot
id|mode
op_assign
id|S_IFREG
op_or
id|S_IRUGO
)brace
comma
dot
id|show
op_assign
id|location_read_file
comma
)brace
suffix:semicolon
DECL|function|rpaphp_sysfs_add_attr_location
r_static
r_void
id|rpaphp_sysfs_add_attr_location
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
(brace
id|sysfs_create_file
c_func
(paren
op_amp
id|slot-&gt;kobj
comma
op_amp
id|hotplug_slot_attr_location.attr
)paren
suffix:semicolon
)brace
DECL|function|rpaphp_sysfs_remove_attr_location
r_static
r_void
id|rpaphp_sysfs_remove_attr_location
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
(brace
id|sysfs_remove_file
c_func
(paren
op_amp
id|slot-&gt;kobj
comma
op_amp
id|hotplug_slot_attr_location.attr
)paren
suffix:semicolon
)brace
multiline_comment|/* free up the memory used by a slot */
DECL|function|rpaphp_release_slot
r_static
r_void
id|rpaphp_release_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
id|dealloc_slot_struct
c_func
(paren
id|slot
)paren
suffix:semicolon
)brace
DECL|function|dealloc_slot_struct
r_void
id|dealloc_slot_struct
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|alloc_slot_struct
r_struct
id|slot
op_star
id|alloc_slot_struct
c_func
(paren
r_struct
id|device_node
op_star
id|dn
comma
r_int
id|drc_index
comma
r_char
op_star
id|drc_name
comma
r_int
id|power_domain
)paren
(brace
r_struct
id|slot
op_star
id|slot
suffix:semicolon
id|slot
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
r_goto
id|error_nomem
suffix:semicolon
id|memset
c_func
(paren
id|slot
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|slot-&gt;hotplug_slot
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;hotplug_slot
)paren
r_goto
id|error_slot
suffix:semicolon
id|memset
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hotplug_slot
)paren
)paren
suffix:semicolon
id|slot-&gt;hotplug_slot-&gt;info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;hotplug_slot-&gt;info
)paren
r_goto
id|error_hpslot
suffix:semicolon
id|memset
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
)paren
suffix:semicolon
id|slot-&gt;hotplug_slot-&gt;name
op_assign
id|kmalloc
c_func
(paren
id|BUS_ID_SIZE
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;hotplug_slot-&gt;name
)paren
r_goto
id|error_info
suffix:semicolon
id|slot-&gt;location
op_assign
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|drc_name
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;location
)paren
r_goto
id|error_name
suffix:semicolon
id|slot-&gt;name
op_assign
id|slot-&gt;hotplug_slot-&gt;name
suffix:semicolon
id|slot-&gt;dn
op_assign
id|dn
suffix:semicolon
id|slot-&gt;index
op_assign
id|drc_index
suffix:semicolon
id|strcpy
c_func
(paren
id|slot-&gt;location
comma
id|drc_name
)paren
suffix:semicolon
id|slot-&gt;power_domain
op_assign
id|power_domain
suffix:semicolon
id|slot-&gt;hotplug_slot
op_member_access_from_pointer
r_private
op_assign
id|slot
suffix:semicolon
id|slot-&gt;hotplug_slot-&gt;ops
op_assign
op_amp
id|rpaphp_hotplug_slot_ops
suffix:semicolon
id|slot-&gt;hotplug_slot-&gt;release
op_assign
op_amp
id|rpaphp_release_slot
suffix:semicolon
r_return
(paren
id|slot
)paren
suffix:semicolon
id|error_name
suffix:colon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|error_info
suffix:colon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;info
)paren
suffix:semicolon
id|error_hpslot
suffix:colon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|error_slot
suffix:colon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
id|error_nomem
suffix:colon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|is_registered
r_static
r_int
id|is_registered
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|slot
op_star
id|tmp_slot
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp_slot
comma
op_amp
id|rpaphp_slot_head
comma
id|rpaphp_slot_list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|tmp_slot-&gt;name
comma
id|slot-&gt;name
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|deregister_slot
r_int
id|deregister_slot
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|hotplug_slot
op_star
id|php_slot
op_assign
id|slot-&gt;hotplug_slot
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - Entry: deregistering slot=%s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;name
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|slot-&gt;rpaphp_slot_list
)paren
suffix:semicolon
multiline_comment|/* remove &quot;phy_location&quot; file */
id|rpaphp_sysfs_remove_attr_location
c_func
(paren
id|php_slot
)paren
suffix:semicolon
multiline_comment|/* remove &quot;phy_removable&quot; file */
id|rpaphp_sysfs_remove_attr_removable
c_func
(paren
id|php_slot
)paren
suffix:semicolon
id|retval
op_assign
id|pci_hp_deregister
c_func
(paren
id|php_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|err
c_func
(paren
l_string|&quot;Problem unregistering a slot %s&bslash;n&quot;
comma
id|slot-&gt;name
)paren
suffix:semicolon
r_else
id|num_slots
op_decrement
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - Exit: rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|register_slot
r_int
id|register_slot
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|retval
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s registering slot:path[%s] index[%x], name[%s] pdomain[%x] type[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;dn-&gt;full_name
comma
id|slot-&gt;index
comma
id|slot-&gt;name
comma
id|slot-&gt;power_domain
comma
id|slot-&gt;type
)paren
suffix:semicolon
multiline_comment|/* should not try to register the same slot twice */
r_if
c_cond
(paren
id|is_registered
c_func
(paren
id|slot
)paren
)paren
(brace
multiline_comment|/* should&squot;t be here */
id|err
c_func
(paren
l_string|&quot;register_slot: slot[%s] is already registered&bslash;n&quot;
comma
id|slot-&gt;name
)paren
suffix:semicolon
id|rpaphp_release_slot
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|retval
op_assign
id|pci_hp_register
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;pci_hp_register failed with error %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
id|rpaphp_release_slot
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* create &quot;phy_locatoin&quot; file */
id|rpaphp_sysfs_add_attr_location
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
multiline_comment|/* create &quot;phy_removable&quot; file */
id|rpaphp_sysfs_add_attr_removable
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
multiline_comment|/* add slot to our internal list */
id|dbg
c_func
(paren
l_string|&quot;%s adding slot[%s] to rpaphp_slot_list&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;name
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|slot-&gt;rpaphp_slot_list
comma
op_amp
id|rpaphp_slot_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;dev_type
op_eq
id|VIO_DEV
)paren
id|info
c_func
(paren
l_string|&quot;Slot [%s](VIO location=%s) registered&bslash;n&quot;
comma
id|slot-&gt;name
comma
id|slot-&gt;location
)paren
suffix:semicolon
r_else
id|info
c_func
(paren
l_string|&quot;Slot [%s](PCI location=%s) registered&bslash;n&quot;
comma
id|slot-&gt;name
comma
id|slot-&gt;location
)paren
suffix:semicolon
id|num_slots
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rpaphp_get_power_status
r_int
id|rpaphp_get_power_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
l_int|0
comma
id|level
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;type
op_eq
id|HOTPLUG
)paren
(brace
id|rc
op_assign
id|rtas_get_power_level
c_func
(paren
id|slot-&gt;power_domain
comma
op_amp
id|level
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s the power level of slot %s(pwd-domain:0x%x) is %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;name
comma
id|slot-&gt;power_domain
comma
id|level
)paren
suffix:semicolon
op_star
id|value
op_assign
id|level
suffix:semicolon
)brace
r_else
id|err
c_func
(paren
l_string|&quot;failed to get power-level for slot(%s), rc=0x%x&bslash;n&quot;
comma
id|slot-&gt;location
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;%s report POWER_ON for EMBEDDED or PHB slot %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;location
)paren
suffix:semicolon
op_star
id|value
op_assign
(paren
id|u8
)paren
id|POWER_ON
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|rpaphp_set_attention_status
r_int
id|rpaphp_set_attention_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
id|status
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/* status: LED_OFF or LED_ON */
id|rc
op_assign
id|rtas_set_indicator
c_func
(paren
id|DR_INDICATOR
comma
id|slot-&gt;index
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;slot(name=%s location=%s index=0x%x) set attention-status(%d) failed! rc=0x%x&bslash;n&quot;
comma
id|slot-&gt;name
comma
id|slot-&gt;location
comma
id|slot-&gt;index
comma
id|status
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
