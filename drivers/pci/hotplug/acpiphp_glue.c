multiline_comment|/*&n; * ACPI PCI HotPlug glue functions to ACPI CA subsystem&n; *&n; * Copyright (C) 2002,2003 Takayoshi Kochi (t-kochi@bq.jp.nec.com)&n; * Copyright (C) 2002 Hiroshi Aono (h-aono@ap.jp.nec.com)&n; * Copyright (C) 2002,2003 NEC Corporation&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;t-kochi@bq.jp.nec.com&gt;&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &quot;../pci.h&quot;
macro_line|#include &quot;pci_hotplug.h&quot;
macro_line|#include &quot;acpiphp.h&quot;
r_static
id|LIST_HEAD
c_func
(paren
id|bridge_list
)paren
suffix:semicolon
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME &quot;acpiphp_glue&quot;
r_static
r_void
id|handle_hotplug_event_bridge
(paren
id|acpi_handle
comma
id|u32
comma
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|handle_hotplug_event_func
(paren
id|acpi_handle
comma
id|u32
comma
r_void
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * initialization &amp; terminatation routines&n; */
multiline_comment|/**&n; * is_ejectable - determine if a slot is ejectable&n; * @handle: handle to acpi namespace&n; *&n; * Ejectable slot should satisfy at least these conditions:&n; *&n; *  1. has _ADR method&n; *  2. has _EJ0 method&n; *&n; * optionally&n; *&n; *  1. has _STA method&n; *  2. has _PS0 method&n; *  3. has _PS3 method&n; *  4. ..&n; *&n; */
DECL|function|is_ejectable
r_static
r_int
id|is_ejectable
c_func
(paren
id|acpi_handle
id|handle
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|acpi_handle
id|tmp
suffix:semicolon
id|status
op_assign
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_ADR&quot;
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|status
op_assign
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_EJ0&quot;
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* callback routine to check the existence of ejectable slots */
r_static
id|acpi_status
DECL|function|is_ejectable_slot
id|is_ejectable_slot
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|lvl
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|rv
)paren
(brace
r_int
op_star
id|count
op_assign
(paren
r_int
op_star
)paren
id|context
suffix:semicolon
r_if
c_cond
(paren
id|is_ejectable
c_func
(paren
id|handle
)paren
)paren
(brace
(paren
op_star
id|count
)paren
op_increment
suffix:semicolon
multiline_comment|/* only one ejectable slot is enough */
r_return
id|AE_CTRL_TERMINATE
suffix:semicolon
)brace
r_else
(brace
r_return
id|AE_OK
suffix:semicolon
)brace
)brace
multiline_comment|/* callback routine to register each ACPI PCI slot object */
r_static
id|acpi_status
DECL|function|register_slot
id|register_slot
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|lvl
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|rv
)paren
(brace
r_struct
id|acpiphp_bridge
op_star
id|bridge
op_assign
(paren
r_struct
id|acpiphp_bridge
op_star
)paren
id|context
suffix:semicolon
r_struct
id|acpiphp_slot
op_star
id|slot
suffix:semicolon
r_struct
id|acpiphp_func
op_star
id|newfunc
suffix:semicolon
id|acpi_handle
id|tmp
suffix:semicolon
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_int
r_int
id|adr
comma
id|sun
suffix:semicolon
r_int
id|device
comma
id|function
suffix:semicolon
r_static
r_int
id|num_slots
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX if we support I/O node hotplug... */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
l_string|&quot;_ADR&quot;
comma
l_int|NULL
comma
op_amp
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
id|status
op_assign
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_EJ0&quot;
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
id|device
op_assign
(paren
id|adr
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|function
op_assign
id|adr
op_amp
l_int|0xffff
suffix:semicolon
id|newfunc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpiphp_func
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newfunc
)paren
r_return
id|AE_NO_MEMORY
suffix:semicolon
id|memset
c_func
(paren
id|newfunc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpiphp_func
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|newfunc-&gt;sibling
)paren
suffix:semicolon
id|newfunc-&gt;handle
op_assign
id|handle
suffix:semicolon
id|newfunc-&gt;function
op_assign
id|function
suffix:semicolon
id|newfunc-&gt;flags
op_assign
id|FUNC_HAS_EJ0
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_STA&quot;
comma
op_amp
id|tmp
)paren
)paren
)paren
id|newfunc-&gt;flags
op_or_assign
id|FUNC_HAS_STA
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_PS0&quot;
comma
op_amp
id|tmp
)paren
)paren
)paren
id|newfunc-&gt;flags
op_or_assign
id|FUNC_HAS_PS0
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_PS3&quot;
comma
op_amp
id|tmp
)paren
)paren
)paren
id|newfunc-&gt;flags
op_or_assign
id|FUNC_HAS_PS3
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
l_string|&quot;_SUN&quot;
comma
l_int|NULL
comma
op_amp
id|sun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|sun
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* search for objects that share the same slot */
r_for
c_loop
(paren
id|slot
op_assign
id|bridge-&gt;slots
suffix:semicolon
id|slot
suffix:semicolon
id|slot
op_assign
id|slot-&gt;next
)paren
r_if
c_cond
(paren
id|slot-&gt;device
op_eq
id|device
)paren
(brace
r_if
c_cond
(paren
id|slot-&gt;sun
op_ne
id|sun
)paren
id|warn
c_func
(paren
l_string|&quot;sibling found, but _SUN doesn&squot;t match!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
(brace
id|slot
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpiphp_slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
(brace
id|kfree
c_func
(paren
id|newfunc
)paren
suffix:semicolon
r_return
id|AE_NO_MEMORY
suffix:semicolon
)brace
id|memset
c_func
(paren
id|slot
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpiphp_slot
)paren
)paren
suffix:semicolon
id|slot-&gt;bridge
op_assign
id|bridge
suffix:semicolon
id|slot-&gt;id
op_assign
id|num_slots
op_increment
suffix:semicolon
id|slot-&gt;device
op_assign
id|device
suffix:semicolon
id|slot-&gt;sun
op_assign
id|sun
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|slot-&gt;funcs
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|slot-&gt;crit_sect
)paren
suffix:semicolon
id|slot-&gt;next
op_assign
id|bridge-&gt;slots
suffix:semicolon
id|bridge-&gt;slots
op_assign
id|slot
suffix:semicolon
id|bridge-&gt;nr_slots
op_increment
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;found ACPI PCI Hotplug slot at PCI %02x:%02x Slot:%d&bslash;n&quot;
comma
id|slot-&gt;bridge-&gt;bus
comma
id|slot-&gt;device
comma
id|slot-&gt;sun
)paren
suffix:semicolon
)brace
id|newfunc-&gt;slot
op_assign
id|slot
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|newfunc-&gt;sibling
comma
op_amp
id|slot-&gt;funcs
)paren
suffix:semicolon
multiline_comment|/* associate corresponding pci_dev */
id|newfunc-&gt;pci_dev
op_assign
id|pci_find_slot
c_func
(paren
id|bridge-&gt;bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newfunc-&gt;pci_dev
)paren
(brace
r_if
c_cond
(paren
id|acpiphp_init_func_resource
c_func
(paren
id|newfunc
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|newfunc
)paren
suffix:semicolon
r_return
id|AE_ERROR
suffix:semicolon
)brace
id|slot-&gt;flags
op_or_assign
(paren
id|SLOT_ENABLED
op_or
id|SLOT_POWEREDON
)paren
suffix:semicolon
)brace
multiline_comment|/* install notify handler */
id|status
op_assign
id|acpi_install_notify_handler
c_func
(paren
id|handle
comma
id|ACPI_SYSTEM_NOTIFY
comma
id|handle_hotplug_event_func
comma
id|newfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;failed to register interrupt notify handler&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
multiline_comment|/* see if it&squot;s worth looking at this bridge */
DECL|function|detect_ejectable_slots
r_static
r_int
id|detect_ejectable_slots
c_func
(paren
id|acpi_handle
op_star
id|bridge_handle
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_int
id|count
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* only check slots defined directly below bridge object */
id|status
op_assign
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_DEVICE
comma
id|bridge_handle
comma
(paren
id|u32
)paren
l_int|1
comma
id|is_ejectable_slot
comma
(paren
r_void
op_star
)paren
op_amp
id|count
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* decode ACPI _CRS data and convert into our internal resource list&n; * TBD: _TRA, etc.&n; */
r_static
id|acpi_status
DECL|function|decode_acpi_resource
id|decode_acpi_resource
c_func
(paren
r_struct
id|acpi_resource
op_star
id|resource
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|acpiphp_bridge
op_star
id|bridge
op_assign
(paren
r_struct
id|acpiphp_bridge
op_star
)paren
id|context
suffix:semicolon
r_struct
id|acpi_resource_address64
id|address
suffix:semicolon
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_if
c_cond
(paren
id|resource-&gt;id
op_ne
id|ACPI_RSTYPE_ADDRESS16
op_logical_and
id|resource-&gt;id
op_ne
id|ACPI_RSTYPE_ADDRESS32
op_logical_and
id|resource-&gt;id
op_ne
id|ACPI_RSTYPE_ADDRESS64
)paren
r_return
id|AE_OK
suffix:semicolon
id|acpi_resource_to_address64
c_func
(paren
id|resource
comma
op_amp
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|address.producer_consumer
op_eq
id|ACPI_PRODUCER
op_logical_and
id|address.address_length
OG
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;resource type: %d: 0x%llx - 0x%llx&bslash;n&quot;
comma
id|address.resource_type
comma
(paren
r_int
r_int
r_int
)paren
id|address.min_address_range
comma
(paren
r_int
r_int
r_int
)paren
id|address.max_address_range
)paren
suffix:semicolon
id|res
op_assign
id|acpiphp_make_resource
c_func
(paren
id|address.min_address_range
comma
id|address.address_length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|err
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|address.resource_type
)paren
(brace
r_case
id|ACPI_MEMORY_RANGE
suffix:colon
r_if
c_cond
(paren
id|address.attribute.memory.cache_attribute
op_eq
id|ACPI_PREFETCHABLE_MEMORY
)paren
(brace
id|res-&gt;next
op_assign
id|bridge-&gt;p_mem_head
suffix:semicolon
id|bridge-&gt;p_mem_head
op_assign
id|res
suffix:semicolon
)brace
r_else
(brace
id|res-&gt;next
op_assign
id|bridge-&gt;mem_head
suffix:semicolon
id|bridge-&gt;mem_head
op_assign
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_IO_RANGE
suffix:colon
id|res-&gt;next
op_assign
id|bridge-&gt;io_head
suffix:semicolon
id|bridge-&gt;io_head
op_assign
id|res
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_BUS_NUMBER_RANGE
suffix:colon
id|res-&gt;next
op_assign
id|bridge-&gt;bus_head
suffix:semicolon
id|bridge-&gt;bus_head
op_assign
id|res
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* invalid type */
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
multiline_comment|/* decode ACPI 2.0 _HPP hot plug parameters */
DECL|function|decode_hpp
r_static
r_void
id|decode_hpp
c_func
(paren
r_struct
id|acpiphp_bridge
op_star
id|bridge
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
dot
id|length
op_assign
id|ACPI_ALLOCATE_BUFFER
comma
dot
id|pointer
op_assign
l_int|NULL
)brace
suffix:semicolon
r_union
id|acpi_object
op_star
id|package
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* default numbers */
id|bridge-&gt;hpp.cache_line_size
op_assign
l_int|0x10
suffix:semicolon
id|bridge-&gt;hpp.latency_timer
op_assign
l_int|0x40
suffix:semicolon
id|bridge-&gt;hpp.enable_SERR
op_assign
l_int|0
suffix:semicolon
id|bridge-&gt;hpp.enable_PERR
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|bridge-&gt;handle
comma
l_string|&quot;_HPP&quot;
comma
l_int|NULL
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;_HPP evaluation failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|package
op_assign
(paren
r_union
id|acpi_object
op_star
)paren
id|buffer.pointer
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|package
op_logical_or
id|package-&gt;type
op_ne
id|ACPI_TYPE_PACKAGE
op_logical_or
id|package-&gt;package.count
op_ne
l_int|4
op_logical_or
op_logical_neg
id|package-&gt;package.elements
)paren
(brace
id|err
c_func
(paren
l_string|&quot;invalid _HPP object; ignoring&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|package-&gt;package.elements
(braket
id|i
)braket
dot
id|type
op_ne
id|ACPI_TYPE_INTEGER
)paren
(brace
id|err
c_func
(paren
l_string|&quot;invalid _HPP parameter type; ignoring&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
)brace
id|bridge-&gt;hpp.cache_line_size
op_assign
id|package-&gt;package.elements
(braket
l_int|0
)braket
dot
id|integer.value
suffix:semicolon
id|bridge-&gt;hpp.latency_timer
op_assign
id|package-&gt;package.elements
(braket
l_int|1
)braket
dot
id|integer.value
suffix:semicolon
id|bridge-&gt;hpp.enable_SERR
op_assign
id|package-&gt;package.elements
(braket
l_int|2
)braket
dot
id|integer.value
suffix:semicolon
id|bridge-&gt;hpp.enable_PERR
op_assign
id|package-&gt;package.elements
(braket
l_int|3
)braket
dot
id|integer.value
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;_HPP parameter = (%02x, %02x, %02x, %02x)&bslash;n&quot;
comma
id|bridge-&gt;hpp.cache_line_size
comma
id|bridge-&gt;hpp.latency_timer
comma
id|bridge-&gt;hpp.enable_SERR
comma
id|bridge-&gt;hpp.enable_PERR
)paren
suffix:semicolon
id|bridge-&gt;flags
op_or_assign
id|BRIDGE_HAS_HPP
suffix:semicolon
id|err_exit
suffix:colon
id|kfree
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize miscellaneous stuff for both root and PCI-to-PCI bridge */
DECL|function|init_bridge_misc
r_static
r_void
id|init_bridge_misc
c_func
(paren
r_struct
id|acpiphp_bridge
op_star
id|bridge
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
multiline_comment|/* decode ACPI 2.0 _HPP (hot plug parameters) */
id|decode_hpp
c_func
(paren
id|bridge
)paren
suffix:semicolon
multiline_comment|/* subtract all resources already allocated */
id|acpiphp_detect_pci_resource
c_func
(paren
id|bridge
)paren
suffix:semicolon
multiline_comment|/* register all slot objects under this bridge */
id|status
op_assign
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_DEVICE
comma
id|bridge-&gt;handle
comma
(paren
id|u32
)paren
l_int|1
comma
id|register_slot
comma
id|bridge
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* install notify handler */
id|status
op_assign
id|acpi_install_notify_handler
c_func
(paren
id|bridge-&gt;handle
comma
id|ACPI_SYSTEM_NOTIFY
comma
id|handle_hotplug_event_bridge
comma
id|bridge
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;failed to register interrupt notify handler&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|bridge-&gt;list
comma
op_amp
id|bridge_list
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Bridge resource:&bslash;n&quot;
)paren
suffix:semicolon
id|acpiphp_dump_resource
c_func
(paren
id|bridge
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate and initialize host bridge data structure */
DECL|function|add_host_bridge
r_static
r_void
id|add_host_bridge
c_func
(paren
id|acpi_handle
op_star
id|handle
comma
r_int
id|seg
comma
r_int
id|bus
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpiphp_bridge
op_star
id|bridge
suffix:semicolon
id|bridge
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpiphp_bridge
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bridge
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|bridge
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpiphp_bridge
)paren
)paren
suffix:semicolon
id|bridge-&gt;type
op_assign
id|BRIDGE_TYPE_HOST
suffix:semicolon
id|bridge-&gt;handle
op_assign
id|handle
suffix:semicolon
id|bridge-&gt;seg
op_assign
id|seg
suffix:semicolon
id|bridge-&gt;bus
op_assign
id|bus
suffix:semicolon
id|bridge-&gt;pci_bus
op_assign
id|pci_find_bus
c_func
(paren
id|seg
comma
id|bus
)paren
suffix:semicolon
id|bridge-&gt;res_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* to be overridden when we decode _CRS&t;*/
id|bridge-&gt;sub
op_assign
id|bridge-&gt;bus
suffix:semicolon
multiline_comment|/* decode resources */
id|status
op_assign
id|acpi_walk_resources
c_func
(paren
id|handle
comma
id|METHOD_NAME__CRS
comma
id|decode_acpi_resource
comma
id|bridge
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;failed to decode bridge resources&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|acpiphp_resource_sort_and_combine
c_func
(paren
op_amp
id|bridge-&gt;io_head
)paren
suffix:semicolon
id|acpiphp_resource_sort_and_combine
c_func
(paren
op_amp
id|bridge-&gt;mem_head
)paren
suffix:semicolon
id|acpiphp_resource_sort_and_combine
c_func
(paren
op_amp
id|bridge-&gt;p_mem_head
)paren
suffix:semicolon
id|acpiphp_resource_sort_and_combine
c_func
(paren
op_amp
id|bridge-&gt;bus_head
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ACPI _CRS resource:&bslash;n&quot;
)paren
suffix:semicolon
id|acpiphp_dump_resource
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bridge-&gt;bus_head
)paren
(brace
id|bridge-&gt;bus
op_assign
id|bridge-&gt;bus_head-&gt;base
suffix:semicolon
id|bridge-&gt;sub
op_assign
id|bridge-&gt;bus_head-&gt;base
op_plus
id|bridge-&gt;bus_head-&gt;length
op_minus
l_int|1
suffix:semicolon
)brace
id|init_bridge_misc
c_func
(paren
id|bridge
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate and initialize PCI-to-PCI bridge data structure */
DECL|function|add_p2p_bridge
r_static
r_void
id|add_p2p_bridge
c_func
(paren
id|acpi_handle
op_star
id|handle
comma
r_int
id|seg
comma
r_int
id|bus
comma
r_int
id|dev
comma
r_int
id|fn
)paren
(brace
r_struct
id|acpiphp_bridge
op_star
id|bridge
suffix:semicolon
id|u8
id|tmp8
suffix:semicolon
id|u16
id|tmp16
suffix:semicolon
id|u64
id|base64
comma
id|limit64
suffix:semicolon
id|u32
id|base
comma
id|limit
comma
id|base32u
comma
id|limit32u
suffix:semicolon
id|bridge
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpiphp_bridge
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bridge
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|bridge
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpiphp_bridge
)paren
)paren
suffix:semicolon
id|bridge-&gt;type
op_assign
id|BRIDGE_TYPE_P2P
suffix:semicolon
id|bridge-&gt;handle
op_assign
id|handle
suffix:semicolon
id|bridge-&gt;seg
op_assign
id|seg
suffix:semicolon
id|bridge-&gt;pci_dev
op_assign
id|pci_find_slot
c_func
(paren
id|bus
comma
id|PCI_DEVFN
c_func
(paren
id|dev
comma
id|fn
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge-&gt;pci_dev
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t get pci_dev&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bridge-&gt;pci_bus
op_assign
id|bridge-&gt;pci_dev-&gt;subordinate
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge-&gt;pci_bus
)paren
(brace
id|err
c_func
(paren
l_string|&quot;This is not a PCI-to-PCI bridge!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bridge-&gt;res_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|bridge-&gt;bus
op_assign
id|bridge-&gt;pci_bus-&gt;number
suffix:semicolon
id|bridge-&gt;sub
op_assign
id|bridge-&gt;pci_bus-&gt;subordinate
suffix:semicolon
multiline_comment|/*&n;&t; * decode resources under this P2P bridge&n;&t; */
multiline_comment|/* I/O resources */
id|pci_read_config_byte
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_IO_BASE
comma
op_amp
id|tmp8
)paren
suffix:semicolon
id|base
op_assign
id|tmp8
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_IO_LIMIT
comma
op_amp
id|tmp8
)paren
suffix:semicolon
id|limit
op_assign
id|tmp8
suffix:semicolon
r_switch
c_cond
(paren
id|base
op_amp
id|PCI_IO_RANGE_TYPE_MASK
)paren
(brace
r_case
id|PCI_IO_RANGE_TYPE_16
suffix:colon
id|base
op_assign
(paren
id|base
op_lshift
l_int|8
)paren
op_amp
l_int|0xf000
suffix:semicolon
id|limit
op_assign
(paren
(paren
id|limit
op_lshift
l_int|8
)paren
op_amp
l_int|0xf000
)paren
op_plus
l_int|0xfff
suffix:semicolon
id|bridge-&gt;io_head
op_assign
id|acpiphp_make_resource
c_func
(paren
(paren
id|u64
)paren
id|base
comma
id|limit
op_minus
id|base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge-&gt;io_head
)paren
(brace
id|err
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;16bit I/O range: %04x-%04x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|bridge-&gt;io_head-&gt;base
comma
(paren
id|u32
)paren
(paren
id|bridge-&gt;io_head-&gt;base
op_plus
id|bridge-&gt;io_head-&gt;length
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_IO_RANGE_TYPE_32
suffix:colon
id|pci_read_config_word
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_IO_BASE_UPPER16
comma
op_amp
id|tmp16
)paren
suffix:semicolon
id|base
op_assign
(paren
(paren
id|u32
)paren
id|tmp16
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|base
op_lshift
l_int|8
)paren
op_amp
l_int|0xf000
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_IO_LIMIT_UPPER16
comma
op_amp
id|tmp16
)paren
suffix:semicolon
id|limit
op_assign
(paren
(paren
(paren
id|u32
)paren
id|tmp16
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|limit
op_lshift
l_int|8
)paren
op_amp
l_int|0xf000
)paren
)paren
op_plus
l_int|0xfff
suffix:semicolon
id|bridge-&gt;io_head
op_assign
id|acpiphp_make_resource
c_func
(paren
(paren
id|u64
)paren
id|base
comma
id|limit
op_minus
id|base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge-&gt;io_head
)paren
(brace
id|err
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;32bit I/O range: %08x-%08x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|bridge-&gt;io_head-&gt;base
comma
(paren
id|u32
)paren
(paren
id|bridge-&gt;io_head-&gt;base
op_plus
id|bridge-&gt;io_head-&gt;length
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0f
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;I/O space unsupported&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|warn
c_func
(paren
l_string|&quot;Unknown I/O range type&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Memory resources (mandatory for P2P bridge) */
id|pci_read_config_word
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_MEMORY_BASE
comma
op_amp
id|tmp16
)paren
suffix:semicolon
id|base
op_assign
(paren
id|tmp16
op_amp
l_int|0xfff0
)paren
op_lshift
l_int|16
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_MEMORY_LIMIT
comma
op_amp
id|tmp16
)paren
suffix:semicolon
id|limit
op_assign
(paren
(paren
id|tmp16
op_amp
l_int|0xfff0
)paren
op_lshift
l_int|16
)paren
op_or
l_int|0xfffff
suffix:semicolon
id|bridge-&gt;mem_head
op_assign
id|acpiphp_make_resource
c_func
(paren
(paren
id|u64
)paren
id|base
comma
id|limit
op_minus
id|base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge-&gt;mem_head
)paren
(brace
id|err
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;32bit Memory range: %08x-%08x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|bridge-&gt;mem_head-&gt;base
comma
(paren
id|u32
)paren
(paren
id|bridge-&gt;mem_head-&gt;base
op_plus
id|bridge-&gt;mem_head-&gt;length
op_minus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Prefetchable Memory resources (optional) */
id|pci_read_config_word
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_PREF_MEMORY_BASE
comma
op_amp
id|tmp16
)paren
suffix:semicolon
id|base
op_assign
id|tmp16
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_PREF_MEMORY_LIMIT
comma
op_amp
id|tmp16
)paren
suffix:semicolon
id|limit
op_assign
id|tmp16
suffix:semicolon
r_switch
c_cond
(paren
id|base
op_amp
id|PCI_MEMORY_RANGE_TYPE_MASK
)paren
(brace
r_case
id|PCI_PREF_RANGE_TYPE_32
suffix:colon
id|base
op_assign
(paren
id|base
op_amp
l_int|0xfff0
)paren
op_lshift
l_int|16
suffix:semicolon
id|limit
op_assign
(paren
(paren
id|limit
op_amp
l_int|0xfff0
)paren
op_lshift
l_int|16
)paren
op_or
l_int|0xfffff
suffix:semicolon
id|bridge-&gt;p_mem_head
op_assign
id|acpiphp_make_resource
c_func
(paren
(paren
id|u64
)paren
id|base
comma
id|limit
op_minus
id|base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge-&gt;p_mem_head
)paren
(brace
id|err
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;32bit Prefetchable memory range: %08x-%08x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|bridge-&gt;p_mem_head-&gt;base
comma
(paren
id|u32
)paren
(paren
id|bridge-&gt;p_mem_head-&gt;base
op_plus
id|bridge-&gt;p_mem_head-&gt;length
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_PREF_RANGE_TYPE_64
suffix:colon
id|pci_read_config_dword
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_PREF_BASE_UPPER32
comma
op_amp
id|base32u
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|bridge-&gt;pci_dev
comma
id|PCI_PREF_LIMIT_UPPER32
comma
op_amp
id|limit32u
)paren
suffix:semicolon
id|base64
op_assign
(paren
(paren
id|u64
)paren
id|base32u
op_lshift
l_int|32
)paren
op_or
(paren
(paren
id|base
op_amp
l_int|0xfff0
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|limit64
op_assign
(paren
(paren
(paren
id|u64
)paren
id|limit32u
op_lshift
l_int|32
)paren
op_or
(paren
(paren
id|limit
op_amp
l_int|0xfff0
)paren
op_lshift
l_int|16
)paren
)paren
op_plus
l_int|0xfffff
suffix:semicolon
id|bridge-&gt;p_mem_head
op_assign
id|acpiphp_make_resource
c_func
(paren
id|base64
comma
id|limit64
op_minus
id|base64
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge-&gt;p_mem_head
)paren
(brace
id|err
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;64bit Prefetchable memory range: %08x%08x-%08x%08x&bslash;n&quot;
comma
(paren
id|u32
)paren
(paren
id|bridge-&gt;p_mem_head-&gt;base
op_rshift
l_int|32
)paren
comma
(paren
id|u32
)paren
(paren
id|bridge-&gt;p_mem_head-&gt;base
op_amp
l_int|0xffffffff
)paren
comma
(paren
id|u32
)paren
(paren
(paren
id|bridge-&gt;p_mem_head-&gt;base
op_plus
id|bridge-&gt;p_mem_head-&gt;length
op_minus
l_int|1
)paren
op_rshift
l_int|32
)paren
comma
(paren
id|u32
)paren
(paren
(paren
id|bridge-&gt;p_mem_head-&gt;base
op_plus
id|bridge-&gt;p_mem_head-&gt;length
op_minus
l_int|1
)paren
op_amp
l_int|0xffffffff
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0f
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|warn
c_func
(paren
l_string|&quot;Unknown prefetchale memory type&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|init_bridge_misc
c_func
(paren
id|bridge
)paren
suffix:semicolon
)brace
multiline_comment|/* callback routine to find P2P bridges */
r_static
id|acpi_status
DECL|function|find_p2p_bridge
id|find_p2p_bridge
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|lvl
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|rv
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|acpi_handle
id|dummy_handle
suffix:semicolon
r_int
r_int
op_star
id|segbus
op_assign
id|context
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_int
id|seg
comma
id|bus
comma
id|device
comma
id|function
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
multiline_comment|/* get PCI address */
id|seg
op_assign
(paren
op_star
id|segbus
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|bus
op_assign
op_star
id|segbus
op_amp
l_int|0xff
suffix:semicolon
id|status
op_assign
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_ADR&quot;
comma
op_amp
id|dummy_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
multiline_comment|/* continue */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
l_string|&quot;_ADR&quot;
comma
l_int|NULL
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: _ADR evaluation failure&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
id|device
op_assign
(paren
id|tmp
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|function
op_assign
id|tmp
op_amp
l_int|0xffff
suffix:semicolon
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|bus
comma
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;subordinate
)paren
r_return
id|AE_OK
suffix:semicolon
multiline_comment|/* check if this bridge has ejectable slots */
r_if
c_cond
(paren
id|detect_ejectable_slots
c_func
(paren
id|handle
)paren
OG
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;found PCI-to-PCI bridge at PCI %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|add_p2p_bridge
c_func
(paren
id|handle
comma
id|seg
comma
id|bus
comma
id|device
comma
id|function
)paren
suffix:semicolon
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
multiline_comment|/* find hot-pluggable slots, and then find P2P bridge */
DECL|function|add_bridge
r_static
r_int
id|add_bridge
c_func
(paren
id|acpi_handle
id|handle
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_int
id|seg
comma
id|bus
suffix:semicolon
id|acpi_handle
id|dummy_handle
suffix:semicolon
multiline_comment|/* if the bridge doesn&squot;t have _STA, we assume it is always there */
id|status
op_assign
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_STA&quot;
comma
op_amp
id|dummy_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
l_string|&quot;_STA&quot;
comma
l_int|NULL
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: _STA evaluation failure&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|ACPI_STA_FUNCTIONING
)paren
op_eq
l_int|0
)paren
multiline_comment|/* don&squot;t register this object */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get PCI segment number */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
l_string|&quot;_SEG&quot;
comma
l_int|NULL
comma
op_amp
id|tmp
)paren
suffix:semicolon
id|seg
op_assign
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
ques
c_cond
id|tmp
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* get PCI bus number */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
l_string|&quot;_BBN&quot;
comma
l_int|NULL
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|bus
op_assign
id|tmp
suffix:semicolon
)brace
r_else
(brace
id|warn
c_func
(paren
l_string|&quot;can&squot;t get bus number, assuming 0&bslash;n&quot;
)paren
suffix:semicolon
id|bus
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check if this bridge has ejectable slots */
r_if
c_cond
(paren
id|detect_ejectable_slots
c_func
(paren
id|handle
)paren
OG
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;found PCI host-bus bridge with hot-pluggable slots&bslash;n&quot;
)paren
suffix:semicolon
id|add_host_bridge
c_func
(paren
id|handle
comma
id|seg
comma
id|bus
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tmp
op_assign
id|seg
op_lshift
l_int|8
op_or
id|bus
suffix:semicolon
multiline_comment|/* search P2P bridges under this host bridge */
id|status
op_assign
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_DEVICE
comma
id|handle
comma
(paren
id|u32
)paren
l_int|1
comma
id|find_p2p_bridge
comma
op_amp
id|tmp
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;find_p2p_bridge faied (error code = 0x%x)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|remove_bridge
r_static
r_void
id|remove_bridge
c_func
(paren
id|acpi_handle
id|handle
)paren
(brace
multiline_comment|/* No-op for now .. */
)brace
DECL|function|power_on_slot
r_static
r_int
id|power_on_slot
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpiphp_func
op_star
id|func
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if already enabled, just skip */
r_if
c_cond
(paren
id|slot-&gt;flags
op_amp
id|SLOT_POWEREDON
)paren
r_goto
id|err_exit
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|slot-&gt;funcs
)paren
(brace
id|func
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|acpiphp_func
comma
id|sibling
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;flags
op_amp
id|FUNC_HAS_PS0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: executing _PS0&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|func-&gt;handle
comma
l_string|&quot;_PS0&quot;
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;%s: _PS0 failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* TBD: evaluate _STA to check if the slot is enabled */
id|slot-&gt;flags
op_or_assign
id|SLOT_POWEREDON
suffix:semicolon
id|err_exit
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|power_off_slot
r_static
r_int
id|power_off_slot
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpiphp_func
op_star
id|func
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|acpi_object_list
id|arg_list
suffix:semicolon
r_union
id|acpi_object
id|arg
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if already disabled, just skip */
r_if
c_cond
(paren
(paren
id|slot-&gt;flags
op_amp
id|SLOT_POWEREDON
)paren
op_eq
l_int|0
)paren
r_goto
id|err_exit
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|slot-&gt;funcs
)paren
(brace
id|func
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|acpiphp_func
comma
id|sibling
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;pci_dev
op_logical_and
(paren
id|func-&gt;flags
op_amp
id|FUNC_HAS_PS3
)paren
)paren
(brace
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|func-&gt;handle
comma
l_string|&quot;_PS3&quot;
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;%s: _PS3 failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
)brace
id|list_for_each
(paren
id|l
comma
op_amp
id|slot-&gt;funcs
)paren
(brace
id|func
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|acpiphp_func
comma
id|sibling
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want to call _EJ0 on non-existing functions. */
r_if
c_cond
(paren
id|func-&gt;pci_dev
op_logical_and
(paren
id|func-&gt;flags
op_amp
id|FUNC_HAS_EJ0
)paren
)paren
(brace
multiline_comment|/* _EJ0 method take one argument */
id|arg_list.count
op_assign
l_int|1
suffix:semicolon
id|arg_list.pointer
op_assign
op_amp
id|arg
suffix:semicolon
id|arg.type
op_assign
id|ACPI_TYPE_INTEGER
suffix:semicolon
id|arg.integer.value
op_assign
l_int|1
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|func-&gt;handle
comma
l_string|&quot;_EJ0&quot;
comma
op_amp
id|arg_list
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;%s: _EJ0 failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* TBD: evaluate _STA to check if the slot is disabled */
id|slot-&gt;flags
op_and_assign
(paren
op_complement
id|SLOT_POWEREDON
)paren
suffix:semicolon
id|err_exit
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * enable_device - enable, configure a slot&n; * @slot: slot to be enabled&n; *&n; * This function should be called per *physical slot*,&n; * not per each slot object in ACPI namespace.&n; *&n; */
DECL|function|enable_device
r_static
r_int
id|enable_device
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
id|u8
id|bus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_struct
id|pci_bus
op_star
id|child
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|acpiphp_func
op_star
id|func
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|num
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;flags
op_amp
id|SLOT_ENABLED
)paren
r_goto
id|err_exit
suffix:semicolon
multiline_comment|/* sanity check: dev should be NULL when hot-plugged in */
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|slot-&gt;bridge-&gt;bus
comma
id|PCI_DEVFN
c_func
(paren
id|slot-&gt;device
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
multiline_comment|/* This case shouldn&squot;t happen */
id|err
c_func
(paren
l_string|&quot;pci_dev structure already exists.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
multiline_comment|/* allocate resources to device */
id|retval
op_assign
id|acpiphp_configure_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err_exit
suffix:semicolon
multiline_comment|/* returned `dev&squot; is the *first function* only! */
id|num
op_assign
id|pci_scan_slot
c_func
(paren
id|slot-&gt;bridge-&gt;pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|slot-&gt;device
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num
)paren
id|pci_bus_add_devices
c_func
(paren
id|slot-&gt;bridge-&gt;pci_bus
)paren
suffix:semicolon
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|slot-&gt;bridge-&gt;bus
comma
id|PCI_DEVFN
c_func
(paren
id|slot-&gt;device
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|err
c_func
(paren
l_string|&quot;No new device found&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;hdr_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|bus
)paren
suffix:semicolon
id|child
op_assign
(paren
r_struct
id|pci_bus
op_star
)paren
id|pci_add_new_bus
c_func
(paren
id|dev-&gt;bus
comma
id|dev
comma
id|bus
)paren
suffix:semicolon
id|pci_do_scan_bus
c_func
(paren
id|child
)paren
suffix:semicolon
)brace
multiline_comment|/* associate pci_dev to our representation */
id|list_for_each
(paren
id|l
comma
op_amp
id|slot-&gt;funcs
)paren
(brace
id|func
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|acpiphp_func
comma
id|sibling
)paren
suffix:semicolon
id|func-&gt;pci_dev
op_assign
id|pci_find_slot
c_func
(paren
id|slot-&gt;bridge-&gt;bus
comma
id|PCI_DEVFN
c_func
(paren
id|slot-&gt;device
comma
id|func-&gt;function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|func-&gt;pci_dev
)paren
r_continue
suffix:semicolon
multiline_comment|/* configure device */
id|retval
op_assign
id|acpiphp_configure_function
c_func
(paren
id|func
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err_exit
suffix:semicolon
)brace
id|slot-&gt;flags
op_or_assign
id|SLOT_ENABLED
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Available resources:&bslash;n&quot;
)paren
suffix:semicolon
id|acpiphp_dump_resource
c_func
(paren
id|slot-&gt;bridge
)paren
suffix:semicolon
id|err_exit
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * disable_device - disable a slot&n; */
DECL|function|disable_device
r_static
r_int
id|disable_device
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpiphp_func
op_star
id|func
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
multiline_comment|/* is this slot already disabled? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|slot-&gt;flags
op_amp
id|SLOT_ENABLED
)paren
)paren
r_goto
id|err_exit
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|slot-&gt;funcs
)paren
(brace
id|func
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|acpiphp_func
comma
id|sibling
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;pci_dev
)paren
id|acpiphp_unconfigure_function
c_func
(paren
id|func
)paren
suffix:semicolon
)brace
id|slot-&gt;flags
op_and_assign
(paren
op_complement
id|SLOT_ENABLED
)paren
suffix:semicolon
id|err_exit
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * get_slot_status - get ACPI slot status&n; *&n; * if a slot has _STA for each function and if any one of them&n; * returned non-zero status, return it&n; *&n; * if a slot doesn&squot;t have _STA and if any one of its functions&squot;&n; * configuration space is configured, return 0x0f as a _STA&n; *&n; * otherwise return 0&n; */
DECL|function|get_slot_status
r_static
r_int
r_int
id|get_slot_status
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_int
r_int
id|sta
op_assign
l_int|0
suffix:semicolon
id|u32
id|dvid
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|acpiphp_func
op_star
id|func
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|slot-&gt;funcs
)paren
(brace
id|func
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|acpiphp_func
comma
id|sibling
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;flags
op_amp
id|FUNC_HAS_STA
)paren
(brace
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|func-&gt;handle
comma
l_string|&quot;_STA&quot;
comma
l_int|NULL
comma
op_amp
id|sta
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
op_logical_and
id|sta
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
id|pci_bus_read_config_dword
c_func
(paren
id|slot-&gt;bridge-&gt;pci_bus
comma
id|PCI_DEVFN
c_func
(paren
id|slot-&gt;device
comma
id|func-&gt;function
)paren
comma
id|PCI_VENDOR_ID
comma
op_amp
id|dvid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvid
op_ne
l_int|0xffffffff
)paren
(brace
id|sta
op_assign
id|ACPI_STA_ALL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
(paren
r_int
r_int
)paren
id|sta
suffix:semicolon
)brace
multiline_comment|/*&n; * ACPI event handlers&n; */
multiline_comment|/**&n; * handle_hotplug_event_bridge - handle ACPI event on bridges&n; *&n; * @handle: Notify()&squot;ed acpi_handle&n; * @type: Notify code&n; * @context: pointer to acpiphp_bridge structure&n; *&n; * handles ACPI event notification on {host,p2p} bridges&n; *&n; */
DECL|function|handle_hotplug_event_bridge
r_static
r_void
id|handle_hotplug_event_bridge
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|type
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|acpiphp_bridge
op_star
id|bridge
suffix:semicolon
r_char
id|objname
(braket
l_int|64
)braket
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
dot
id|length
op_assign
r_sizeof
(paren
id|objname
)paren
comma
dot
id|pointer
op_assign
id|objname
)brace
suffix:semicolon
id|bridge
op_assign
(paren
r_struct
id|acpiphp_bridge
op_star
)paren
id|context
suffix:semicolon
id|acpi_get_name
c_func
(paren
id|handle
comma
id|ACPI_FULL_PATHNAME
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ACPI_NOTIFY_BUS_CHECK
suffix:colon
multiline_comment|/* bus re-enumerate */
id|dbg
c_func
(paren
l_string|&quot;%s: Bus check notify on %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|objname
)paren
suffix:semicolon
id|acpiphp_check_bridge
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_DEVICE_CHECK
suffix:colon
multiline_comment|/* device check */
id|dbg
c_func
(paren
l_string|&quot;%s: Device check notify on %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|objname
)paren
suffix:semicolon
id|acpiphp_check_bridge
c_func
(paren
id|bridge
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_DEVICE_WAKE
suffix:colon
multiline_comment|/* wake event */
id|dbg
c_func
(paren
l_string|&quot;%s: Device wake notify on %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|objname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_EJECT_REQUEST
suffix:colon
multiline_comment|/* request device eject */
id|dbg
c_func
(paren
l_string|&quot;%s: Device eject notify on %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|objname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_FREQUENCY_MISMATCH
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Device %s cannot be configured due&quot;
l_string|&quot; to a frequency mismatch&bslash;n&quot;
comma
id|objname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_BUS_MODE_MISMATCH
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Device %s cannot be configured due&quot;
l_string|&quot; to a bus mode mismatch&bslash;n&quot;
comma
id|objname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_POWER_FAULT
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Device %s has suffered a power fault&bslash;n&quot;
comma
id|objname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|warn
c_func
(paren
l_string|&quot;notify_handler: unknown event type 0x%x for %s&bslash;n&quot;
comma
id|type
comma
id|objname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * handle_hotplug_event_func - handle ACPI event on functions (i.e. slots)&n; *&n; * @handle: Notify()&squot;ed acpi_handle&n; * @type: Notify code&n; * @context: pointer to acpiphp_func structure&n; *&n; * handles ACPI event notification on slots&n; *&n; */
DECL|function|handle_hotplug_event_func
r_static
r_void
id|handle_hotplug_event_func
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|type
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|acpiphp_func
op_star
id|func
suffix:semicolon
r_char
id|objname
(braket
l_int|64
)braket
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
dot
id|length
op_assign
r_sizeof
(paren
id|objname
)paren
comma
dot
id|pointer
op_assign
id|objname
)brace
suffix:semicolon
id|acpi_get_name
c_func
(paren
id|handle
comma
id|ACPI_FULL_PATHNAME
comma
op_amp
id|buffer
)paren
suffix:semicolon
id|func
op_assign
(paren
r_struct
id|acpiphp_func
op_star
)paren
id|context
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ACPI_NOTIFY_BUS_CHECK
suffix:colon
multiline_comment|/* bus re-enumerate */
id|dbg
c_func
(paren
l_string|&quot;%s: Bus check notify on %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|objname
)paren
suffix:semicolon
id|acpiphp_enable_slot
c_func
(paren
id|func-&gt;slot
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_DEVICE_CHECK
suffix:colon
multiline_comment|/* device check : re-enumerate from parent bus */
id|dbg
c_func
(paren
l_string|&quot;%s: Device check notify on %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|objname
)paren
suffix:semicolon
id|acpiphp_check_bridge
c_func
(paren
id|func-&gt;slot-&gt;bridge
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_DEVICE_WAKE
suffix:colon
multiline_comment|/* wake event */
id|dbg
c_func
(paren
l_string|&quot;%s: Device wake notify on %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|objname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_EJECT_REQUEST
suffix:colon
multiline_comment|/* request device eject */
id|dbg
c_func
(paren
l_string|&quot;%s: Device eject notify on %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|objname
)paren
suffix:semicolon
id|acpiphp_disable_slot
c_func
(paren
id|func-&gt;slot
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|warn
c_func
(paren
l_string|&quot;notify_handler: unknown event type 0x%x for %s&bslash;n&quot;
comma
id|type
comma
id|objname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|acpi_pci_hp_driver
r_static
r_struct
id|acpi_pci_driver
id|acpi_pci_hp_driver
op_assign
(brace
dot
id|add
op_assign
id|add_bridge
comma
dot
id|remove
op_assign
id|remove_bridge
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * acpiphp_glue_init - initializes all PCI hotplug - ACPI glue data structures&n; *&n; */
DECL|function|acpiphp_glue_init
r_int
id|__init
id|acpiphp_glue_init
c_func
(paren
r_void
)paren
(brace
r_int
id|num
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|pci_root_buses
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|num
op_assign
id|acpi_pci_register_driver
c_func
(paren
op_amp
id|acpi_pci_hp_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num
op_le
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * acpiphp_glue_exit - terminates all PCI hotplug - ACPI glue data structures&n; *&n; * This function frees all data allocated in acpiphp_glue_init()&n; */
DECL|function|acpiphp_glue_exit
r_void
id|__exit
id|acpiphp_glue_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|l1
comma
op_star
id|l2
comma
op_star
id|n1
comma
op_star
id|n2
suffix:semicolon
r_struct
id|acpiphp_bridge
op_star
id|bridge
suffix:semicolon
r_struct
id|acpiphp_slot
op_star
id|slot
comma
op_star
id|next
suffix:semicolon
r_struct
id|acpiphp_func
op_star
id|func
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|list_for_each_safe
(paren
id|l1
comma
id|n1
comma
op_amp
id|bridge_list
)paren
(brace
id|bridge
op_assign
(paren
r_struct
id|acpiphp_bridge
op_star
)paren
id|l1
suffix:semicolon
id|slot
op_assign
id|bridge-&gt;slots
suffix:semicolon
r_while
c_loop
(paren
id|slot
)paren
(brace
id|next
op_assign
id|slot-&gt;next
suffix:semicolon
id|list_for_each_safe
(paren
id|l2
comma
id|n2
comma
op_amp
id|slot-&gt;funcs
)paren
(brace
id|func
op_assign
id|list_entry
c_func
(paren
id|l2
comma
r_struct
id|acpiphp_func
comma
id|sibling
)paren
suffix:semicolon
id|acpiphp_free_resource
c_func
(paren
op_amp
id|func-&gt;io_head
)paren
suffix:semicolon
id|acpiphp_free_resource
c_func
(paren
op_amp
id|func-&gt;mem_head
)paren
suffix:semicolon
id|acpiphp_free_resource
c_func
(paren
op_amp
id|func-&gt;p_mem_head
)paren
suffix:semicolon
id|acpiphp_free_resource
c_func
(paren
op_amp
id|func-&gt;bus_head
)paren
suffix:semicolon
id|status
op_assign
id|acpi_remove_notify_handler
c_func
(paren
id|func-&gt;handle
comma
id|ACPI_SYSTEM_NOTIFY
comma
id|handle_hotplug_event_func
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|err
c_func
(paren
l_string|&quot;failed to remove notify handler&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|func
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
id|slot
op_assign
id|next
suffix:semicolon
)brace
id|status
op_assign
id|acpi_remove_notify_handler
c_func
(paren
id|bridge-&gt;handle
comma
id|ACPI_SYSTEM_NOTIFY
comma
id|handle_hotplug_event_bridge
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|err
c_func
(paren
l_string|&quot;failed to remove notify handler&bslash;n&quot;
)paren
suffix:semicolon
id|acpiphp_free_resource
c_func
(paren
op_amp
id|bridge-&gt;io_head
)paren
suffix:semicolon
id|acpiphp_free_resource
c_func
(paren
op_amp
id|bridge-&gt;mem_head
)paren
suffix:semicolon
id|acpiphp_free_resource
c_func
(paren
op_amp
id|bridge-&gt;p_mem_head
)paren
suffix:semicolon
id|acpiphp_free_resource
c_func
(paren
op_amp
id|bridge-&gt;bus_head
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bridge
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * acpiphp_get_num_slots - count number of slots in a system&n; */
DECL|function|acpiphp_get_num_slots
r_int
id|__init
id|acpiphp_get_num_slots
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|node
suffix:semicolon
r_struct
id|acpiphp_bridge
op_star
id|bridge
suffix:semicolon
r_int
id|num_slots
suffix:semicolon
id|num_slots
op_assign
l_int|0
suffix:semicolon
id|list_for_each
(paren
id|node
comma
op_amp
id|bridge_list
)paren
(brace
id|bridge
op_assign
(paren
r_struct
id|acpiphp_bridge
op_star
)paren
id|node
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Bus%d %dslot(s)&bslash;n&quot;
comma
id|bridge-&gt;bus
comma
id|bridge-&gt;nr_slots
)paren
suffix:semicolon
id|num_slots
op_add_assign
id|bridge-&gt;nr_slots
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Total %dslots&bslash;n&quot;
comma
id|num_slots
)paren
suffix:semicolon
r_return
id|num_slots
suffix:semicolon
)brace
multiline_comment|/**&n; * acpiphp_for_each_slot - call function for each slot&n; * @fn: callback function&n; * @data: context to be passed to callback function&n; *&n; */
DECL|function|acpiphp_for_each_slot
r_int
id|acpiphp_for_each_slot
c_func
(paren
id|acpiphp_callback
id|fn
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|list_head
op_star
id|node
suffix:semicolon
r_struct
id|acpiphp_bridge
op_star
id|bridge
suffix:semicolon
r_struct
id|acpiphp_slot
op_star
id|slot
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|list_for_each
(paren
id|node
comma
op_amp
id|bridge_list
)paren
(brace
id|bridge
op_assign
(paren
r_struct
id|acpiphp_bridge
op_star
)paren
id|node
suffix:semicolon
r_for
c_loop
(paren
id|slot
op_assign
id|bridge-&gt;slots
suffix:semicolon
id|slot
suffix:semicolon
id|slot
op_assign
id|slot-&gt;next
)paren
(brace
id|retval
op_assign
id|fn
c_func
(paren
id|slot
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|err_exit
suffix:semicolon
)brace
)brace
id|err_exit
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* search matching slot from id  */
DECL|function|get_slot_from_id
r_struct
id|acpiphp_slot
op_star
id|get_slot_from_id
c_func
(paren
r_int
id|id
)paren
(brace
r_struct
id|list_head
op_star
id|node
suffix:semicolon
r_struct
id|acpiphp_bridge
op_star
id|bridge
suffix:semicolon
r_struct
id|acpiphp_slot
op_star
id|slot
suffix:semicolon
id|list_for_each
(paren
id|node
comma
op_amp
id|bridge_list
)paren
(brace
id|bridge
op_assign
(paren
r_struct
id|acpiphp_bridge
op_star
)paren
id|node
suffix:semicolon
r_for
c_loop
(paren
id|slot
op_assign
id|bridge-&gt;slots
suffix:semicolon
id|slot
suffix:semicolon
id|slot
op_assign
id|slot-&gt;next
)paren
r_if
c_cond
(paren
id|slot-&gt;id
op_eq
id|id
)paren
r_return
id|slot
suffix:semicolon
)brace
multiline_comment|/* should never happen! */
id|err
c_func
(paren
l_string|&quot;%s: no object for id %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * acpiphp_enable_slot - power on slot&n; */
DECL|function|acpiphp_enable_slot
r_int
id|acpiphp_enable_slot
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
r_int
id|retval
suffix:semicolon
id|down
c_func
(paren
op_amp
id|slot-&gt;crit_sect
)paren
suffix:semicolon
multiline_comment|/* wake up all functions */
id|retval
op_assign
id|power_on_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err_exit
suffix:semicolon
r_if
c_cond
(paren
id|get_slot_status
c_func
(paren
id|slot
)paren
op_eq
id|ACPI_STA_ALL
)paren
multiline_comment|/* configure all functions */
id|retval
op_assign
id|enable_device
c_func
(paren
id|slot
)paren
suffix:semicolon
id|err_exit
suffix:colon
id|up
c_func
(paren
op_amp
id|slot-&gt;crit_sect
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * acpiphp_disable_slot - power off slot&n; */
DECL|function|acpiphp_disable_slot
r_int
id|acpiphp_disable_slot
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|slot-&gt;crit_sect
)paren
suffix:semicolon
multiline_comment|/* unconfigure all functions */
id|retval
op_assign
id|disable_device
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err_exit
suffix:semicolon
multiline_comment|/* power off all functions */
id|retval
op_assign
id|power_off_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err_exit
suffix:semicolon
id|acpiphp_resource_sort_and_combine
c_func
(paren
op_amp
id|slot-&gt;bridge-&gt;io_head
)paren
suffix:semicolon
id|acpiphp_resource_sort_and_combine
c_func
(paren
op_amp
id|slot-&gt;bridge-&gt;mem_head
)paren
suffix:semicolon
id|acpiphp_resource_sort_and_combine
c_func
(paren
op_amp
id|slot-&gt;bridge-&gt;p_mem_head
)paren
suffix:semicolon
id|acpiphp_resource_sort_and_combine
c_func
(paren
op_amp
id|slot-&gt;bridge-&gt;bus_head
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Available resources:&bslash;n&quot;
)paren
suffix:semicolon
id|acpiphp_dump_resource
c_func
(paren
id|slot-&gt;bridge
)paren
suffix:semicolon
id|err_exit
suffix:colon
id|up
c_func
(paren
op_amp
id|slot-&gt;crit_sect
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * acpiphp_check_bridge - re-enumerate devices&n; *&n; * Iterate over all slots under this bridge and make sure that if a&n; * card is present they are enabled, and if not they are disabled.&n; */
DECL|function|acpiphp_check_bridge
r_int
id|acpiphp_check_bridge
c_func
(paren
r_struct
id|acpiphp_bridge
op_star
id|bridge
)paren
(brace
r_struct
id|acpiphp_slot
op_star
id|slot
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|enabled
comma
id|disabled
suffix:semicolon
id|enabled
op_assign
id|disabled
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|slot
op_assign
id|bridge-&gt;slots
suffix:semicolon
id|slot
suffix:semicolon
id|slot
op_assign
id|slot-&gt;next
)paren
(brace
r_int
r_int
id|status
op_assign
id|get_slot_status
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;flags
op_amp
id|SLOT_ENABLED
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
id|ACPI_STA_ALL
)paren
r_continue
suffix:semicolon
id|retval
op_assign
id|acpiphp_disable_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error occurred in disabling&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
id|disabled
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|status
op_ne
id|ACPI_STA_ALL
)paren
r_continue
suffix:semicolon
id|retval
op_assign
id|acpiphp_enable_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error occurred in enabling&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_exit
suffix:semicolon
)brace
id|enabled
op_increment
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: %d enabled, %d disabled&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|enabled
comma
id|disabled
)paren
suffix:semicolon
id|err_exit
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * slot enabled:  1&n; * slot disabled: 0&n; */
DECL|function|acpiphp_get_power_status
id|u8
id|acpiphp_get_power_status
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
r_int
r_int
id|sta
suffix:semicolon
id|sta
op_assign
id|get_slot_status
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
(paren
id|sta
op_amp
id|ACPI_STA_ENABLED
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * attention LED ON: 1&n; *&t;&t;OFF: 0&n; *&n; * TBD&n; * no direct attention led status information via ACPI&n; *&n; */
DECL|function|acpiphp_get_attention_status
id|u8
id|acpiphp_get_attention_status
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * latch closed:  1&n; * latch   open:  0&n; */
DECL|function|acpiphp_get_latch_status
id|u8
id|acpiphp_get_latch_status
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
r_int
r_int
id|sta
suffix:semicolon
id|sta
op_assign
id|get_slot_status
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
(paren
id|sta
op_amp
id|ACPI_STA_SHOW_IN_UI
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * adapter presence : 1&n; *          absence : 0&n; */
DECL|function|acpiphp_get_adapter_status
id|u8
id|acpiphp_get_adapter_status
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
r_int
r_int
id|sta
suffix:semicolon
id|sta
op_assign
id|get_slot_status
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
(paren
id|sta
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * pci address (seg/bus/dev)&n; */
DECL|function|acpiphp_get_address
id|u32
id|acpiphp_get_address
c_func
(paren
r_struct
id|acpiphp_slot
op_star
id|slot
)paren
(brace
id|u32
id|address
suffix:semicolon
id|address
op_assign
(paren
(paren
id|slot-&gt;bridge-&gt;seg
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|slot-&gt;bridge-&gt;bus
)paren
op_lshift
l_int|8
)paren
op_or
id|slot-&gt;device
suffix:semicolon
r_return
id|address
suffix:semicolon
)brace
eof
