multiline_comment|/*&n; * CompactPCI Hot Plug Driver PCI functions&n; *&n; * Copyright (C) 2002 by SOMA Networks, Inc.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;scottm@somanetworks.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &quot;../pci.h&quot;
macro_line|#include &quot;pci_hotplug.h&quot;
macro_line|#include &quot;cpci_hotplug.h&quot;
macro_line|#if !defined(MODULE)
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME&t;&quot;cpci_hotplug&quot;
macro_line|#else
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME&t;THIS_MODULE-&gt;name
macro_line|#endif
r_extern
r_int
id|cpci_debug
suffix:semicolon
DECL|macro|dbg
mdefine_line|#define dbg(format, arg...)&t;&t;&t;&t;&t;&bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;if(cpci_debug)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;printk (KERN_DEBUG &quot;%s: &quot; format &quot;&bslash;n&quot;,&t;&bslash;&n;&t;&t;&t;&t;MY_NAME , ## arg); &t;&t;&bslash;&n;&t;} while(0)
DECL|macro|err
mdefine_line|#define err(format, arg...) printk(KERN_ERR &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
DECL|macro|info
mdefine_line|#define info(format, arg...) printk(KERN_INFO &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
DECL|macro|warn
mdefine_line|#define warn(format, arg...) printk(KERN_WARNING &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
DECL|macro|ROUND_UP
mdefine_line|#define ROUND_UP(x, a)&t;&t;(((x) + (a) - 1) &amp; ~((a) - 1))
DECL|function|cpci_get_attention_status
id|u8
id|cpci_get_attention_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|hs_csr
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|hs_csr
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|hs_csr
op_amp
l_int|0x0008
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|cpci_set_attention_status
r_int
id|cpci_set_attention_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
r_int
id|status
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|hs_csr
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|hs_csr
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|hs_csr
op_or_assign
id|HS_CSR_LOO
suffix:semicolon
)brace
r_else
(brace
id|hs_csr
op_and_assign
op_complement
id|HS_CSR_LOO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_write_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
id|hs_csr
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|cpci_get_hs_csr
id|u16
id|cpci_get_hs_csr
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|hs_csr
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
l_int|0xFFFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|hs_csr
)paren
)paren
(brace
r_return
l_int|0xFFFF
suffix:semicolon
)brace
r_return
id|hs_csr
suffix:semicolon
)brace
macro_line|#if 0
id|u16
id|cpci_set_hs_csr
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u16
id|hs_csr
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|new_hs_csr
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
l_int|0xFFFF
suffix:semicolon
)brace
multiline_comment|/* Write out the new value */
r_if
c_cond
(paren
id|pci_bus_write_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
id|hs_csr
)paren
)paren
(brace
r_return
l_int|0xFFFF
suffix:semicolon
)brace
multiline_comment|/* Read back what we just wrote out */
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|new_hs_csr
)paren
)paren
(brace
r_return
l_int|0xFFFF
suffix:semicolon
)brace
r_return
id|new_hs_csr
suffix:semicolon
)brace
macro_line|#endif
DECL|function|cpci_check_and_clear_ins
r_int
id|cpci_check_and_clear_ins
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|hs_csr
suffix:semicolon
r_int
id|ins
op_assign
l_int|0
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|hs_csr
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hs_csr
op_amp
id|HS_CSR_INS
)paren
(brace
multiline_comment|/* Clear INS (by setting it) */
r_if
c_cond
(paren
id|pci_bus_write_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
id|hs_csr
)paren
)paren
(brace
id|ins
op_assign
l_int|0
suffix:semicolon
)brace
id|ins
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ins
suffix:semicolon
)brace
DECL|function|cpci_check_ext
r_int
id|cpci_check_ext
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|hs_csr
suffix:semicolon
r_int
id|ext
op_assign
l_int|0
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|hs_csr
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hs_csr
op_amp
id|HS_CSR_EXT
)paren
(brace
id|ext
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ext
suffix:semicolon
)brace
DECL|function|cpci_clear_ext
r_int
id|cpci_clear_ext
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|hs_csr
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|hs_csr
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hs_csr
op_amp
id|HS_CSR_EXT
)paren
(brace
multiline_comment|/* Clear EXT (by setting it) */
r_if
c_cond
(paren
id|pci_bus_write_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
id|hs_csr
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpci_led_on
r_int
id|cpci_led_on
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|hs_csr
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|hs_csr
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|hs_csr
op_amp
id|HS_CSR_LOO
)paren
op_ne
id|HS_CSR_LOO
)paren
(brace
multiline_comment|/* Set LOO */
id|hs_csr
op_or_assign
id|HS_CSR_LOO
suffix:semicolon
r_if
c_cond
(paren
id|pci_bus_write_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
id|hs_csr
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not set LOO for slot %s&quot;
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpci_led_off
r_int
id|cpci_led_off
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|hs_cap
suffix:semicolon
id|u16
id|hs_csr
suffix:semicolon
id|hs_cap
op_assign
id|pci_bus_find_capability
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|PCI_CAP_ID_CHSWP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hs_cap
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_bus_read_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
op_amp
id|hs_csr
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hs_csr
op_amp
id|HS_CSR_LOO
)paren
(brace
multiline_comment|/* Clear LOO */
id|hs_csr
op_and_assign
op_complement
id|HS_CSR_LOO
suffix:semicolon
r_if
c_cond
(paren
id|pci_bus_write_config_word
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
comma
id|hs_cap
op_plus
l_int|2
comma
id|hs_csr
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not clear LOO for slot %s&quot;
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Device configuration functions&n; */
DECL|function|cpci_configure_dev
r_static
r_int
id|cpci_configure_dev
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u8
id|irq_pin
suffix:semicolon
r_int
id|r
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* NOTE: device already setup from prior scan */
multiline_comment|/* FIXME: How would we know if we need to enable the expansion ROM? */
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_ROM_ADDRESS
comma
l_int|0x00L
)paren
suffix:semicolon
multiline_comment|/* Assign resources */
id|dbg
c_func
(paren
l_string|&quot;assigning resources for %02x:%02x.%x&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
l_int|0
suffix:semicolon
id|r
OL
l_int|6
suffix:semicolon
id|r
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
id|dev-&gt;resource
op_plus
id|r
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
)paren
(brace
id|pci_assign_resource
c_func
(paren
id|dev
comma
id|r
)paren
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;finished assigning resources for %02x:%02x.%x&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
multiline_comment|/* Does this function have an interrupt at all? */
id|dbg
c_func
(paren
l_string|&quot;checking for function interrupt&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|irq_pin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_pin
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;function uses interrupt pin %d&quot;
comma
id|irq_pin
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Need to explicitly set irq field to 0 so that it&squot;ll get assigned&n;&t; * by the pcibios platform dependent code called by pci_enable_device.&n;&t; */
id|dev-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;enabling device&quot;
)paren
suffix:semicolon
id|pci_enable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* XXX check return */
id|dbg
c_func
(paren
l_string|&quot;now dev-&gt;irq = %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_pin
op_logical_and
id|dev-&gt;irq
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
multiline_comment|/* Can&squot;t use pci_insert_device at the moment, do it manually for now */
id|pci_proc_attach_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;notifying drivers&quot;
)paren
suffix:semicolon
singleline_comment|//pci_announce_device_to_drivers(dev);
id|dbg
c_func
(paren
l_string|&quot;%s - exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpci_configure_bridge
r_static
r_int
id|cpci_configure_bridge
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|pci_bus
op_star
id|child
suffix:semicolon
r_struct
id|resource
op_star
id|r
suffix:semicolon
id|u8
id|max
comma
id|n
suffix:semicolon
id|u16
id|command
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Do basic bridge initialization */
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0x40
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - write of PCI_LATENCY_TIMER failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_SEC_LATENCY_TIMER
comma
l_int|0x40
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - write of PCI_SEC_LATENCY_TIMER failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_CACHE_LINE_SIZE
comma
id|L1_CACHE_BYTES
op_div
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s - write of PCI_CACHE_LINE_SIZE failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set parent bridge&squot;s subordinate field so that configuration space&n;&t; * access will work in pci_scan_bridge and friends.&n;&t; */
id|max
op_assign
id|pci_max_busnr
c_func
(paren
)paren
suffix:semicolon
id|bus-&gt;subordinate
op_assign
id|max
op_plus
l_int|1
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|bus-&gt;self
comma
id|PCI_SUBORDINATE_BUS
comma
id|max
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Scan behind bridge */
id|n
op_assign
id|pci_scan_bridge
c_func
(paren
id|bus
comma
id|dev
comma
id|max
comma
l_int|2
)paren
suffix:semicolon
id|child
op_assign
id|pci_find_bus
c_func
(paren
l_int|0
comma
id|max
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|child
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|pci_proc_attach_bus
c_func
(paren
id|child
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Update parent bridge&squot;s subordinate field if there were more bridges&n;&t; * behind the bridge that was scanned.&n;&t; */
r_if
c_cond
(paren
id|n
OG
id|max
)paren
(brace
id|bus-&gt;subordinate
op_assign
id|n
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|bus-&gt;self
comma
id|PCI_SUBORDINATE_BUS
comma
id|n
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Update the bridge resources of the bridge to accommodate devices&n;&t; * behind it.&n;&t; */
id|pci_bus_size_bridges
c_func
(paren
id|child
)paren
suffix:semicolon
id|pci_bus_assign_resources
c_func
(paren
id|child
)paren
suffix:semicolon
multiline_comment|/* Enable resource mapping via command register */
id|command
op_assign
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_INVALIDATE
op_or
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_SERR
suffix:semicolon
id|r
op_assign
id|child-&gt;resource
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|r
op_logical_and
id|r-&gt;start
)paren
(brace
id|command
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
)brace
id|r
op_assign
id|child-&gt;resource
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|r
op_logical_and
id|r-&gt;start
)paren
(brace
id|command
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
id|r
op_assign
id|child-&gt;resource
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|r
op_logical_and
id|r-&gt;start
)paren
(brace
id|command
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
id|rc
op_assign
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error setting command register&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Set bridge control register */
id|command
op_assign
id|PCI_BRIDGE_CTL_PARITY
op_or
id|PCI_BRIDGE_CTL_SERR
op_or
id|PCI_BRIDGE_CTL_NO_ISA
suffix:semicolon
id|rc
op_assign
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_BRIDGE_CONTROL
comma
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error setting bridge control register&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|configure_visit_pci_dev
r_static
r_int
id|configure_visit_pci_dev
c_func
(paren
r_struct
id|pci_dev_wrapped
op_star
id|wrapped_dev
comma
r_struct
id|pci_bus_wrapped
op_star
id|wrapped_bus
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|wrapped_dev-&gt;dev
suffix:semicolon
r_struct
id|pci_bus
op_star
id|bus
op_assign
id|wrapped_bus-&gt;bus
suffix:semicolon
r_struct
id|slot
op_star
id|slot
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We need to fix up the hotplug representation with the Linux&n;&t; * representation.&n;&t; */
r_if
c_cond
(paren
id|wrapped_dev-&gt;data
)paren
(brace
id|slot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|wrapped_dev-&gt;data
suffix:semicolon
id|slot-&gt;dev
op_assign
id|dev
suffix:semicolon
)brace
multiline_comment|/* If it&squot;s a bridge, scan behind it for devices */
r_if
c_cond
(paren
id|dev-&gt;hdr_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
id|rc
op_assign
id|cpci_configure_bridge
c_func
(paren
id|bus
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
)brace
multiline_comment|/* Actually configure device */
r_if
c_cond
(paren
id|dev
)paren
(brace
id|rc
op_assign
id|cpci_configure_dev
c_func
(paren
id|bus
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unconfigure_visit_pci_dev_phase2
r_static
r_int
id|unconfigure_visit_pci_dev_phase2
c_func
(paren
r_struct
id|pci_dev_wrapped
op_star
id|wrapped_dev
comma
r_struct
id|pci_bus_wrapped
op_star
id|wrapped_bus
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|wrapped_dev-&gt;dev
suffix:semicolon
r_struct
id|slot
op_star
id|slot
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Remove the Linux representation */
r_if
c_cond
(paren
id|pci_remove_device_safe
c_func
(paren
id|dev
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not remove device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now remove the hotplug representation.&n;&t; */
r_if
c_cond
(paren
id|wrapped_dev-&gt;data
)paren
(brace
id|slot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|wrapped_dev-&gt;data
suffix:semicolon
id|slot-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;No hotplug representation for %02x:%02x.%x&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unconfigure_visit_pci_bus_phase2
r_static
r_int
id|unconfigure_visit_pci_bus_phase2
c_func
(paren
r_struct
id|pci_bus_wrapped
op_star
id|wrapped_bus
comma
r_struct
id|pci_dev_wrapped
op_star
id|wrapped_dev
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
op_assign
id|wrapped_bus-&gt;bus
suffix:semicolon
r_struct
id|pci_bus
op_star
id|parent
op_assign
id|bus-&gt;self-&gt;bus
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* The cleanup code for proc entries regarding buses should be in the kernel... */
r_if
c_cond
(paren
id|bus-&gt;procdir
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;detach_pci_bus %s&quot;
comma
id|bus-&gt;procdir-&gt;name
)paren
suffix:semicolon
)brace
id|pci_proc_detach_bus
c_func
(paren
id|bus
)paren
suffix:semicolon
multiline_comment|/* The cleanup code should live in the kernel... */
id|bus-&gt;self-&gt;subordinate
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* unlink from parent bus */
id|list_del
c_func
(paren
op_amp
id|bus-&gt;node
)paren
suffix:semicolon
multiline_comment|/* Now, remove */
r_if
c_cond
(paren
id|bus
)paren
(brace
id|kfree
c_func
(paren
id|bus
)paren
suffix:semicolon
)brace
multiline_comment|/* Update parent&squot;s subordinate field */
r_if
c_cond
(paren
id|parent
)paren
(brace
id|u8
id|n
op_assign
id|pci_bus_max_busnr
c_func
(paren
id|parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
id|parent-&gt;subordinate
)paren
(brace
id|parent-&gt;subordinate
op_assign
id|n
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|parent-&gt;self
comma
id|PCI_SUBORDINATE_BUS
comma
id|n
)paren
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|configure_functions
r_static
r_struct
id|pci_visit
id|configure_functions
op_assign
(brace
dot
id|visit_pci_dev
op_assign
id|configure_visit_pci_dev
comma
)brace
suffix:semicolon
DECL|variable|unconfigure_functions_phase2
r_static
r_struct
id|pci_visit
id|unconfigure_functions_phase2
op_assign
(brace
dot
id|post_visit_pci_bus
op_assign
id|unconfigure_visit_pci_bus_phase2
comma
dot
id|post_visit_pci_dev
op_assign
id|unconfigure_visit_pci_dev_phase2
)brace
suffix:semicolon
DECL|function|cpci_configure_slot
r_int
id|cpci_configure_slot
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;dev
op_eq
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;pci_dev null, finding %02x:%02x:%x&quot;
comma
id|slot-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|slot-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|slot-&gt;devfn
)paren
)paren
suffix:semicolon
id|slot-&gt;dev
op_assign
id|pci_find_slot
c_func
(paren
id|slot-&gt;bus-&gt;number
comma
id|slot-&gt;devfn
)paren
suffix:semicolon
)brace
multiline_comment|/* Still NULL? Well then scan for it! */
r_if
c_cond
(paren
id|slot-&gt;dev
op_eq
l_int|NULL
)paren
(brace
r_int
id|n
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;pci_dev still null&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This will generate pci_dev structures for all functions, but&n;&t;&t; * we will only call this case when lookup fails.&n;&t;&t; */
id|n
op_assign
id|pci_scan_slot
c_func
(paren
id|slot-&gt;bus
comma
id|slot-&gt;devfn
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: pci_scan_slot returned %d&quot;
comma
id|__FUNCTION__
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|0
)paren
(brace
id|pci_bus_add_devices
c_func
(paren
id|slot-&gt;bus
)paren
suffix:semicolon
)brace
id|slot-&gt;dev
op_assign
id|pci_find_slot
c_func
(paren
id|slot-&gt;bus-&gt;number
comma
id|slot-&gt;devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;dev
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not find PCI device for slot %02x&quot;
comma
id|slot-&gt;number
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;slot-&gt;dev = %p&quot;
comma
id|slot-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;dev
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_struct
id|pci_dev_wrapped
id|wrapped_dev
suffix:semicolon
r_struct
id|pci_bus_wrapped
id|wrapped_bus
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|wrapped_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_dev_wrapped
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|wrapped_bus
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_bus_wrapped
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|slot-&gt;bus-&gt;number
comma
id|PCI_DEVFN
c_func
(paren
id|PCI_SLOT
c_func
(paren
id|slot-&gt;dev-&gt;devfn
)paren
comma
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
r_continue
suffix:semicolon
)brace
id|wrapped_dev.dev
op_assign
id|dev
suffix:semicolon
id|wrapped_bus.bus
op_assign
id|slot-&gt;dev-&gt;bus
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|wrapped_dev.data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|wrapped_dev.data
op_assign
(paren
r_void
op_star
)paren
id|slot
suffix:semicolon
id|rc
op_assign
id|pci_visit_dev
c_func
(paren
op_amp
id|configure_functions
comma
op_amp
id|wrapped_dev
comma
op_amp
id|wrapped_bus
)paren
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - exit, rc = %d&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|cpci_unconfigure_slot
r_int
id|cpci_unconfigure_slot
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|pci_dev_wrapped
id|wrapped_dev
suffix:semicolon
r_struct
id|pci_bus_wrapped
id|wrapped_bus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;dev
)paren
(brace
id|err
c_func
(paren
l_string|&quot;No device for slot %02x&bslash;n&quot;
comma
id|slot-&gt;number
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|wrapped_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_dev_wrapped
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|wrapped_bus
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_bus_wrapped
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|slot-&gt;bus-&gt;number
comma
id|PCI_DEVFN
c_func
(paren
id|PCI_SLOT
c_func
(paren
id|slot-&gt;devfn
)paren
comma
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|wrapped_dev.dev
op_assign
id|dev
suffix:semicolon
id|wrapped_bus.bus
op_assign
id|dev-&gt;bus
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|wrapped_dev.data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|wrapped_dev.data
op_assign
(paren
r_void
op_star
)paren
id|slot
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - unconfigure phase 2&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|rc
op_assign
id|pci_visit_dev
c_func
(paren
op_amp
id|unconfigure_functions_phase2
comma
op_amp
id|wrapped_dev
comma
op_amp
id|wrapped_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - exit, rc = %d&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
