multiline_comment|/*&n; * IBM Hot Plug Controller Driver&n; * &n; * Written By: Irene Zubarev, IBM Corporation&n; * &n; * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (C) 2001,2002 IBM Corp.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;gregkh@us.ibm.com&gt;&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &quot;ibmphp.h&quot;
r_static
r_int
id|configure_device
c_func
(paren
r_struct
id|pci_func
op_star
)paren
suffix:semicolon
r_static
r_int
id|configure_bridge
c_func
(paren
r_struct
id|pci_func
op_star
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
r_struct
id|res_needed
op_star
id|scan_behind_bridge
c_func
(paren
r_struct
id|pci_func
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
r_int
id|add_new_bus
(paren
r_struct
id|bus_node
op_star
comma
r_struct
id|resource_node
op_star
comma
r_struct
id|resource_node
op_star
comma
r_struct
id|resource_node
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
id|u8
id|find_sec_number
(paren
id|u8
id|primary_busno
comma
id|u8
id|slotno
)paren
suffix:semicolon
multiline_comment|/*&n; * NOTE..... If BIOS doesn&squot;t provide default routing, we assign:&n; * 9 for SCSI, 10 for LAN adapters, and 11 for everything else. &n; * If adapter is bridged, then we assign 11 to it and devices behind it.&n; * We also assign the same irq numbers for multi function devices.&n; * These are PIC mode, so shouldn&squot;t matter n.e.ways (hopefully)&n; */
DECL|function|assign_alt_irq
r_static
r_void
id|assign_alt_irq
(paren
r_struct
id|pci_func
op_star
id|cur_func
comma
id|u8
id|class_code
)paren
(brace
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cur_func-&gt;irq
(braket
id|j
)braket
op_eq
l_int|0xff
)paren
(brace
r_switch
c_cond
(paren
id|class_code
)paren
(brace
r_case
id|PCI_BASE_CLASS_STORAGE
suffix:colon
id|cur_func-&gt;irq
(braket
id|j
)braket
op_assign
id|SCSI_IRQ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_BASE_CLASS_NETWORK
suffix:colon
id|cur_func-&gt;irq
(braket
id|j
)braket
op_assign
id|LAN_IRQ
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cur_func-&gt;irq
(braket
id|j
)braket
op_assign
id|OTHER_IRQ
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*&n; * Configures the device to be added (will allocate needed resources if it&n; * can), the device can be a bridge or a regular pci device, can also be&n; * multi-functional&n; * &n; * Input: function to be added&n; * &n; * TO DO:  The error case with Multifunction device or multi function bridge,&n; * if there is an error, will need to go through all previous functions and &n; * unconfigure....or can add some code into unconfigure_card....&n; */
DECL|function|ibmphp_configure_card
r_int
id|ibmphp_configure_card
(paren
r_struct
id|pci_func
op_star
id|func
comma
id|u8
id|slotno
)paren
(brace
id|u16
id|vendor_id
suffix:semicolon
id|u32
r_class
suffix:semicolon
id|u8
id|class_code
suffix:semicolon
id|u8
id|hdr_type
comma
id|device
comma
id|sec_number
suffix:semicolon
id|u8
id|function
suffix:semicolon
r_struct
id|pci_func
op_star
id|newfunc
suffix:semicolon
multiline_comment|/* for multi devices */
r_struct
id|pci_func
op_star
id|cur_func
comma
op_star
id|prev_func
suffix:semicolon
r_int
id|rc
comma
id|i
comma
id|j
suffix:semicolon
r_int
id|cleanup_count
suffix:semicolon
id|u8
id|flag
suffix:semicolon
id|u8
id|valid_device
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* to see if we are able to read from card any device info at all */
id|debug
(paren
l_string|&quot;inside configure_card, func-&gt;busno = %x&bslash;n&quot;
comma
id|func-&gt;busno
)paren
suffix:semicolon
id|device
op_assign
id|func-&gt;device
suffix:semicolon
id|cur_func
op_assign
id|func
suffix:semicolon
multiline_comment|/* We only get bus and device from IRQ routing table.  So at this point,&n;&t; * func-&gt;busno is correct, and func-&gt;device contains only device (at the 5 &n;&t; * highest bits)&n;&t; */
multiline_comment|/* For every function on the card */
r_for
c_loop
(paren
id|function
op_assign
l_int|0x00
suffix:semicolon
id|function
OL
l_int|0x08
suffix:semicolon
id|function
op_increment
)paren
(brace
r_int
r_int
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
suffix:semicolon
id|ibmphp_pci_bus-&gt;number
op_assign
id|cur_func-&gt;busno
suffix:semicolon
id|cur_func-&gt;function
op_assign
id|function
suffix:semicolon
id|debug
(paren
l_string|&quot;inside the loop, cur_func-&gt;busno = %x, cur_func-&gt;device = %x, cur_func-&gt;funcion = %x&bslash;n&quot;
comma
id|cur_func-&gt;busno
comma
id|cur_func-&gt;device
comma
id|cur_func-&gt;function
)paren
suffix:semicolon
id|pci_bus_read_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor_id
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;vendor_id is %x&bslash;n&quot;
comma
id|vendor_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendor_id
op_ne
id|PCI_VENDOR_ID_NOTVALID
)paren
(brace
multiline_comment|/* found correct device!!! */
id|debug
(paren
l_string|&quot;found valid device, vendor_id = %x&bslash;n&quot;
comma
id|vendor_id
)paren
suffix:semicolon
op_increment
id|valid_device
suffix:semicolon
multiline_comment|/* header: x x x x x x x x&n;&t;&t;&t; *         | |___________|=&gt; 1=PPB bridge, 0=normal device, 2=CardBus Bridge&n;&t;&t;&t; *         |_=&gt; 0 = single function device, 1 = multi-function device&n;&t;&t;&t; */
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|hdr_type
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_CLASS_REVISION
comma
op_amp
r_class
)paren
suffix:semicolon
id|class_code
op_assign
r_class
op_rshift
l_int|24
suffix:semicolon
id|debug
(paren
l_string|&quot;hrd_type = %x, class = %x, class_code %x&bslash;n&quot;
comma
id|hdr_type
comma
r_class
comma
id|class_code
)paren
suffix:semicolon
r_class
op_rshift_assign
l_int|8
suffix:semicolon
multiline_comment|/* to take revision out, class = class.subclass.prog i/f */
r_if
c_cond
(paren
r_class
op_eq
id|PCI_CLASS_NOT_DEFINED_VGA
)paren
(brace
id|err
(paren
l_string|&quot;The device %x is VGA compatible and as is not supported for hot plugging. &quot;
l_string|&quot;Please choose another device.&bslash;n&quot;
comma
id|cur_func-&gt;device
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
r_class
op_eq
id|PCI_CLASS_DISPLAY_VGA
)paren
(brace
id|err
(paren
l_string|&quot;The device %x is not supported for hot plugging. &quot;
l_string|&quot;Please choose another device.&bslash;n&quot;
comma
id|cur_func-&gt;device
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|hdr_type
)paren
(brace
r_case
id|PCI_HEADER_TYPE_NORMAL
suffix:colon
id|debug
(paren
l_string|&quot;single device case.... vendor id = %x, hdr_type = %x, class = %x&bslash;n&quot;
comma
id|vendor_id
comma
id|hdr_type
comma
r_class
)paren
suffix:semicolon
id|assign_alt_irq
(paren
id|cur_func
comma
id|class_code
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|configure_device
(paren
id|cur_func
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* We need to do this in case some other BARs were properly inserted */
id|err
(paren
l_string|&quot;was not able to configure devfunc %x on bus %x.&bslash;n&quot;
comma
id|cur_func-&gt;device
comma
id|cur_func-&gt;busno
)paren
suffix:semicolon
id|cleanup_count
op_assign
l_int|6
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|cur_func-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|function
op_assign
l_int|0x8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_HEADER_TYPE_MULTIDEVICE
suffix:colon
id|assign_alt_irq
(paren
id|cur_func
comma
id|class_code
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|configure_device
(paren
id|cur_func
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* We need to do this in case some other BARs were properly inserted */
id|err
(paren
l_string|&quot;was not able to configure devfunc %x on bus %x...bailing out&bslash;n&quot;
comma
id|cur_func-&gt;device
comma
id|cur_func-&gt;busno
)paren
suffix:semicolon
id|cleanup_count
op_assign
l_int|6
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|newfunc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|newfunc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newfunc
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|newfunc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|newfunc-&gt;busno
op_assign
id|cur_func-&gt;busno
suffix:semicolon
id|newfunc-&gt;device
op_assign
id|device
suffix:semicolon
id|cur_func-&gt;next
op_assign
id|newfunc
suffix:semicolon
id|cur_func
op_assign
id|newfunc
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
id|newfunc-&gt;irq
(braket
id|j
)braket
op_assign
id|cur_func-&gt;irq
(braket
id|j
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_HEADER_TYPE_MULTIBRIDGE
suffix:colon
r_class
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
r_class
op_ne
id|PCI_CLASS_BRIDGE_PCI
)paren
(brace
id|err
(paren
l_string|&quot;This %x is not PCI-to-PCI bridge, and as is not supported for hot-plugging. &quot;
l_string|&quot;Please insert another card.&bslash;n&quot;
comma
id|cur_func-&gt;device
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|assign_alt_irq
(paren
id|cur_func
comma
id|class_code
)paren
suffix:semicolon
id|rc
op_assign
id|configure_bridge
(paren
op_amp
id|cur_func
comma
id|slotno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
(brace
id|err
(paren
l_string|&quot;You chose to insert Single Bridge, or nested bridges, this is not supported...&bslash;n&quot;
)paren
suffix:semicolon
id|err
(paren
l_string|&quot;Bus %x, devfunc %x&bslash;n&quot;
comma
id|cur_func-&gt;busno
comma
id|cur_func-&gt;device
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* We need to do this in case some other BARs were properly inserted */
id|err
(paren
l_string|&quot;was not able to hot-add PPB properly.&bslash;n&quot;
)paren
suffix:semicolon
id|func-&gt;bus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* To indicate to the unconfigure function that this is a PPB */
id|cleanup_count
op_assign
l_int|2
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|sec_number
)paren
suffix:semicolon
id|flag
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|func-&gt;devices
(braket
id|i
)braket
)paren
(brace
id|newfunc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|newfunc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newfunc
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|newfunc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|newfunc-&gt;busno
op_assign
id|sec_number
suffix:semicolon
id|newfunc-&gt;device
op_assign
(paren
id|u8
)paren
id|i
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
id|newfunc-&gt;irq
(braket
id|j
)braket
op_assign
id|cur_func-&gt;irq
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|flag
)paren
(brace
r_for
c_loop
(paren
id|prev_func
op_assign
id|cur_func
suffix:semicolon
id|prev_func-&gt;next
suffix:semicolon
id|prev_func
op_assign
id|prev_func-&gt;next
)paren
suffix:semicolon
id|prev_func-&gt;next
op_assign
id|newfunc
suffix:semicolon
)brace
r_else
id|cur_func-&gt;next
op_assign
id|newfunc
suffix:semicolon
id|rc
op_assign
id|ibmphp_configure_card
(paren
id|newfunc
comma
id|slotno
)paren
suffix:semicolon
multiline_comment|/* This could only happen if kmalloc failed */
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* We need to do this in case bridge itself got configured properly, but devices behind it failed */
id|func-&gt;bus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* To indicate to the unconfigure function that this is a PPB */
id|cleanup_count
op_assign
l_int|2
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|flag
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
id|newfunc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|newfunc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newfunc
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|newfunc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|newfunc-&gt;busno
op_assign
id|cur_func-&gt;busno
suffix:semicolon
id|newfunc-&gt;device
op_assign
id|device
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
id|newfunc-&gt;irq
(braket
id|j
)braket
op_assign
id|cur_func-&gt;irq
(braket
id|j
)braket
suffix:semicolon
r_for
c_loop
(paren
id|prev_func
op_assign
id|cur_func
suffix:semicolon
id|prev_func-&gt;next
suffix:semicolon
id|prev_func
op_assign
id|prev_func-&gt;next
)paren
suffix:semicolon
id|prev_func-&gt;next
op_assign
id|newfunc
suffix:semicolon
id|cur_func
op_assign
id|newfunc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_HEADER_TYPE_BRIDGE
suffix:colon
r_class
op_rshift_assign
l_int|8
suffix:semicolon
id|debug
(paren
l_string|&quot;class now is %x&bslash;n&quot;
comma
r_class
)paren
suffix:semicolon
r_if
c_cond
(paren
r_class
op_ne
id|PCI_CLASS_BRIDGE_PCI
)paren
(brace
id|err
(paren
l_string|&quot;This %x is not PCI-to-PCI bridge, and as is not supported for hot-plugging. &quot;
l_string|&quot;Please insert another card.&bslash;n&quot;
comma
id|cur_func-&gt;device
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|assign_alt_irq
(paren
id|cur_func
comma
id|class_code
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;cur_func-&gt;busno b4 configure_bridge is %x&bslash;n&quot;
comma
id|cur_func-&gt;busno
)paren
suffix:semicolon
id|rc
op_assign
id|configure_bridge
(paren
op_amp
id|cur_func
comma
id|slotno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
(brace
id|err
(paren
l_string|&quot;You chose to insert Single Bridge, or nested bridges, this is not supported...&bslash;n&quot;
)paren
suffix:semicolon
id|err
(paren
l_string|&quot;Bus %x, devfunc %x&bslash;n&quot;
comma
id|cur_func-&gt;busno
comma
id|cur_func-&gt;device
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* We need to do this in case some other BARs were properly inserted */
id|func-&gt;bus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* To indicate to the unconfigure function that this is a PPB */
id|err
(paren
l_string|&quot;was not able to hot-add PPB properly.&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup_count
op_assign
l_int|2
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;cur_func-&gt;busno = %x, device = %x, function = %x&bslash;n&quot;
comma
id|cur_func-&gt;busno
comma
id|device
comma
id|function
)paren
suffix:semicolon
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|sec_number
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after configuring bridge..., sec_number = %x&bslash;n&quot;
comma
id|sec_number
)paren
suffix:semicolon
id|flag
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|func-&gt;devices
(braket
id|i
)braket
)paren
(brace
id|debug
(paren
l_string|&quot;inside for loop, device is %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|newfunc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|newfunc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newfunc
)paren
(brace
id|err
(paren
l_string|&quot; out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|newfunc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|newfunc-&gt;busno
op_assign
id|sec_number
suffix:semicolon
id|newfunc-&gt;device
op_assign
(paren
id|u8
)paren
id|i
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
id|newfunc-&gt;irq
(braket
id|j
)braket
op_assign
id|cur_func-&gt;irq
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|flag
)paren
(brace
r_for
c_loop
(paren
id|prev_func
op_assign
id|cur_func
suffix:semicolon
id|prev_func-&gt;next
suffix:semicolon
id|prev_func
op_assign
id|prev_func-&gt;next
)paren
suffix:semicolon
id|prev_func-&gt;next
op_assign
id|newfunc
suffix:semicolon
)brace
r_else
id|cur_func-&gt;next
op_assign
id|newfunc
suffix:semicolon
id|rc
op_assign
id|ibmphp_configure_card
(paren
id|newfunc
comma
id|slotno
)paren
suffix:semicolon
multiline_comment|/* Again, this case should not happen... For complete paranoia, will need to call remove_bus */
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* We need to do this in case some other BARs were properly inserted */
id|func-&gt;bus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* To indicate to the unconfigure function that this is a PPB */
id|cleanup_count
op_assign
l_int|2
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|flag
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
id|function
op_assign
l_int|0x8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
(paren
l_string|&quot;MAJOR PROBLEM!!!!, header type not supported? %x&bslash;n&quot;
comma
id|hdr_type
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end of switch */
)brace
multiline_comment|/* end of valid device */
)brace
multiline_comment|/* end of for */
r_if
c_cond
(paren
op_logical_neg
id|valid_device
)paren
(brace
id|err
(paren
l_string|&quot;Cannot find any valid devices on the card.  Or unable to read from card.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cleanup_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cur_func-&gt;io
(braket
id|i
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|cur_func-&gt;io
(braket
id|i
)braket
)paren
suffix:semicolon
id|cur_func-&gt;io
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cur_func-&gt;pfmem
(braket
id|i
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|cur_func-&gt;pfmem
(braket
id|i
)braket
)paren
suffix:semicolon
id|cur_func-&gt;pfmem
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cur_func-&gt;mem
(braket
id|i
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|cur_func-&gt;mem
(braket
id|i
)braket
)paren
suffix:semicolon
id|cur_func-&gt;mem
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * This function configures the pci BARs of a single device.  &n; * Input: pointer to the pci_func&n; * Output: configured PCI, 0, or error&n; */
DECL|function|configure_device
r_static
r_int
id|configure_device
(paren
r_struct
id|pci_func
op_star
id|func
)paren
(brace
id|u32
id|bar
(braket
l_int|6
)braket
suffix:semicolon
id|u32
id|address
(braket
)braket
op_assign
(brace
id|PCI_BASE_ADDRESS_0
comma
id|PCI_BASE_ADDRESS_1
comma
id|PCI_BASE_ADDRESS_2
comma
id|PCI_BASE_ADDRESS_3
comma
id|PCI_BASE_ADDRESS_4
comma
id|PCI_BASE_ADDRESS_5
comma
l_int|0
)brace
suffix:semicolon
id|u8
id|irq
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|len
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|resource_node
op_star
id|io
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|resource_node
op_star
id|mem
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|resource_node
op_star
id|mem_tmp
suffix:semicolon
r_struct
id|resource_node
op_star
id|pfmem
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - inside&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|ibmphp_pci_bus-&gt;number
op_assign
id|func-&gt;busno
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|address
(braket
id|count
)braket
suffix:semicolon
id|count
op_increment
)paren
(brace
multiline_comment|/* for 6 BARs */
multiline_comment|/* not sure if i need this.  per scott, said maybe need smth like this&n;&t;&t;   if devices don&squot;t adhere 100% to the spec, so don&squot;t want to write&n;&t;&t;   to the reserved bits&n;&n;&t;&t;pcibios_read_config_byte(cur_func-&gt;busno, cur_func-&gt;device, &n;&t;&t;PCI_BASE_ADDRESS_0 + 4 * count, &amp;tmp);&n;&t;&t;if (tmp &amp; 0x01) // IO&n;&t;&t;&t;pcibios_write_config_dword(cur_func-&gt;busno, cur_func-&gt;device, &n;&t;&t;&t;PCI_BASE_ADDRESS_0 + 4 * count, 0xFFFFFFFD);&n;&t;&t;else  // Memory&n;&t;&t;&t;pcibios_write_config_dword(cur_func-&gt;busno, cur_func-&gt;device, &n;&t;&t;&t;PCI_BASE_ADDRESS_0 + 4 * count, 0xFFFFFFFF);&n;&t;&t; */
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bar
(braket
id|count
)braket
)paren
multiline_comment|/* This BAR is not implemented */
r_continue
suffix:semicolon
id|debug
(paren
l_string|&quot;Device %x BAR %d wants %x&bslash;n&quot;
comma
id|func-&gt;device
comma
id|count
comma
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
multiline_comment|/* This is IO */
id|debug
(paren
l_string|&quot;inside IO SPACE&bslash;n&quot;
)paren
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFFC
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|debug
(paren
l_string|&quot;len[count] in IO %x, count %d&bslash;n&quot;
comma
id|len
(braket
id|count
)braket
comma
id|count
)paren
suffix:semicolon
id|io
(braket
id|count
)braket
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|resource_node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io
(braket
id|count
)braket
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|io
(braket
id|count
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|io
(braket
id|count
)braket
op_member_access_from_pointer
id|type
op_assign
id|IO
suffix:semicolon
id|io
(braket
id|count
)braket
op_member_access_from_pointer
id|busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|io
(braket
id|count
)braket
op_member_access_from_pointer
id|devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|io
(braket
id|count
)braket
op_member_access_from_pointer
id|len
op_assign
id|len
(braket
id|count
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
c_func
(paren
id|io
(braket
id|count
)braket
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|io
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;io
(braket
id|count
)braket
op_assign
id|io
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;cannot allocate requested io for bus %x device %x function %x len %x&bslash;n&quot;
comma
id|func-&gt;busno
comma
id|func-&gt;device
comma
id|func-&gt;function
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|io
(braket
id|count
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
id|func-&gt;io
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
multiline_comment|/* _______________This is for debugging purposes only_____________________ */
id|debug
(paren
l_string|&quot;b4 writing, the IO address is %x&bslash;n&quot;
comma
id|func-&gt;io
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after writing.... the start address is %x&bslash;n&quot;
comma
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
multiline_comment|/* _________________________________________________________________________*/
)brace
r_else
(brace
multiline_comment|/* This is Memory */
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_PREFETCH
)paren
(brace
multiline_comment|/* pfmem */
id|debug
(paren
l_string|&quot;PFMEM SPACE&bslash;n&quot;
)paren
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|debug
(paren
l_string|&quot;len[count] in PFMEM %x, count %d&bslash;n&quot;
comma
id|len
(braket
id|count
)braket
comma
id|count
)paren
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|resource_node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pfmem
(braket
id|count
)braket
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|pfmem
(braket
id|count
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|type
op_assign
id|PFMEM
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|len
op_assign
id|len
(braket
id|count
)braket
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|fromMem
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|pfmem
(braket
id|count
)braket
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|pfmem
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;pfmem
(braket
id|count
)braket
op_assign
id|pfmem
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
id|mem_tmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mem_tmp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_tmp
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|pfmem
(braket
id|count
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|mem_tmp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|mem_tmp-&gt;type
op_assign
id|MEM
suffix:semicolon
id|mem_tmp-&gt;busno
op_assign
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|busno
suffix:semicolon
id|mem_tmp-&gt;devfunc
op_assign
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|devfunc
suffix:semicolon
id|mem_tmp-&gt;len
op_assign
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
id|debug
(paren
l_string|&quot;there&squot;s no pfmem... going into mem.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|mem_tmp
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|mem_tmp
)paren
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|fromMem
op_assign
id|TRUE
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|rangeno
op_assign
id|mem_tmp-&gt;rangeno
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|start
op_assign
id|mem_tmp-&gt;start
suffix:semicolon
id|pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|end
op_assign
id|mem_tmp-&gt;end
suffix:semicolon
id|ibmphp_add_pfmem_from_mem
(paren
id|pfmem
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;pfmem
(braket
id|count
)braket
op_assign
id|pfmem
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;cannot allocate requested pfmem for bus %x, device %x, len %x&bslash;n&quot;
comma
id|func-&gt;busno
comma
id|func-&gt;device
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|mem_tmp
)paren
suffix:semicolon
id|kfree
(paren
id|pfmem
(braket
id|count
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
id|func-&gt;pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
multiline_comment|/*_______________This is for debugging purposes only______________________________*/
id|debug
(paren
l_string|&quot;b4 writing, start address is %x&bslash;n&quot;
comma
id|func-&gt;pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after writing, start address is %x&bslash;n&quot;
comma
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
multiline_comment|/*_________________________________________________________________________________*/
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|debug
(paren
l_string|&quot;inside the mem 64 case, count %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|count
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* on the 2nd dword, write all 0s, since we can&squot;t handle them n.e.ways */
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
l_int|0x00000000
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* regular memory */
id|debug
(paren
l_string|&quot;REGULAR MEM SPACE&bslash;n&quot;
)paren
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|debug
(paren
l_string|&quot;len[count] in Mem %x, count %d&bslash;n&quot;
comma
id|len
(braket
id|count
)braket
comma
id|count
)paren
suffix:semicolon
id|mem
(braket
id|count
)braket
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|resource_node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
(braket
id|count
)braket
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|mem
(braket
id|count
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|mem
(braket
id|count
)braket
op_member_access_from_pointer
id|type
op_assign
id|MEM
suffix:semicolon
id|mem
(braket
id|count
)braket
op_member_access_from_pointer
id|busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|mem
(braket
id|count
)braket
op_member_access_from_pointer
id|devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|mem
(braket
id|count
)braket
op_member_access_from_pointer
id|len
op_assign
id|len
(braket
id|count
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|mem
(braket
id|count
)braket
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|mem
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;mem
(braket
id|count
)braket
op_assign
id|mem
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;cannot allocate requested mem for bus %x, device %x, len %x&bslash;n&quot;
comma
id|func-&gt;busno
comma
id|func-&gt;device
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|mem
(braket
id|count
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
id|func-&gt;mem
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
multiline_comment|/* _______________________This is for debugging purposes only _______________________*/
id|debug
(paren
l_string|&quot;b4 writing, start address is %x&bslash;n&quot;
comma
id|func-&gt;mem
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after writing, the address is %x&bslash;n&quot;
comma
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
multiline_comment|/* __________________________________________________________________________________*/
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|debug
(paren
l_string|&quot;inside mem 64 case, reg. mem, count %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|count
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* on the 2nd dword, write all 0s, since we can&squot;t handle them n.e.ways */
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
l_int|0x00000000
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* end of mem */
)brace
multiline_comment|/* end of for */
id|func-&gt;bus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* To indicate that this is not a PPB */
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irq
OG
l_int|0x00
)paren
op_logical_and
(paren
id|irq
OL
l_int|0x05
)paren
)paren
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_INTERRUPT_LINE
comma
id|func-&gt;irq
(braket
id|irq
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_CACHE_LINE_SIZE
comma
id|CACHE
)paren
suffix:semicolon
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_LATENCY_TIMER
comma
id|LATENCY
)paren
suffix:semicolon
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_ROM_ADDRESS
comma
l_int|0x00L
)paren
suffix:semicolon
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
id|DEVICEENABLE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; * This routine configures a PCI-2-PCI bridge and the functions behind it&n; * Parameters: pci_func&n; * Returns: &n; ******************************************************************************/
DECL|function|configure_bridge
r_static
r_int
id|configure_bridge
(paren
r_struct
id|pci_func
op_star
op_star
id|func_passed
comma
id|u8
id|slotno
)paren
(brace
r_int
id|count
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|u8
id|sec_number
suffix:semicolon
id|u8
id|io_base
suffix:semicolon
id|u16
id|pfmem_base
suffix:semicolon
id|u32
id|bar
(braket
l_int|2
)braket
suffix:semicolon
id|u32
id|len
(braket
l_int|2
)braket
suffix:semicolon
id|u8
id|flag_io
op_assign
id|FALSE
suffix:semicolon
id|u8
id|flag_mem
op_assign
id|FALSE
suffix:semicolon
id|u8
id|flag_pfmem
op_assign
id|FALSE
suffix:semicolon
id|u8
id|need_io_upper
op_assign
id|FALSE
suffix:semicolon
id|u8
id|need_pfmem_upper
op_assign
id|FALSE
suffix:semicolon
r_struct
id|res_needed
op_star
id|amount_needed
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|resource_node
op_star
id|io
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|resource_node
op_star
id|bus_io
(braket
l_int|2
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|resource_node
op_star
id|mem
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|resource_node
op_star
id|bus_mem
(braket
l_int|2
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|resource_node
op_star
id|mem_tmp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|resource_node
op_star
id|pfmem
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|resource_node
op_star
id|bus_pfmem
(braket
l_int|2
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|bus_node
op_star
id|bus
suffix:semicolon
id|u32
id|address
(braket
)braket
op_assign
(brace
id|PCI_BASE_ADDRESS_0
comma
id|PCI_BASE_ADDRESS_1
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|pci_func
op_star
id|func
op_assign
op_star
id|func_passed
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
id|u8
id|irq
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;function
comma
id|func-&gt;device
)paren
suffix:semicolon
id|ibmphp_pci_bus-&gt;number
op_assign
id|func-&gt;busno
suffix:semicolon
multiline_comment|/* Configuring necessary info for the bridge so that we could see the devices&n;&t; * behind it&n;&t; */
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PRIMARY_BUS
comma
id|func-&gt;busno
)paren
suffix:semicolon
multiline_comment|/* _____________________For debugging purposes only __________________________&n;&t;pci_bus_config_byte (ibmphp_pci_bus, devfn, PCI_PRIMARY_BUS, &amp;pri_number);&n;&t;debug (&quot;primary # written into the bridge is %x&bslash;n&quot;, pri_number);&n;&t; ___________________________________________________________________________*/
multiline_comment|/* in EBDA, only get allocated 1 additional bus # per slot */
id|sec_number
op_assign
id|find_sec_number
(paren
id|func-&gt;busno
comma
id|slotno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sec_number
op_eq
l_int|0xff
)paren
(brace
id|err
(paren
l_string|&quot;cannot allocate secondary bus number for the bridged device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;after find_sec_number, the number we got is %x&bslash;n&quot;
comma
id|sec_number
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;AFTER FIND_SEC_NUMBER, func-&gt;busno IS %x&bslash;n&quot;
comma
id|func-&gt;busno
)paren
suffix:semicolon
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_SECONDARY_BUS
comma
id|sec_number
)paren
suffix:semicolon
multiline_comment|/* __________________For debugging purposes only __________________________________&n;&t;pci_bus_read_config_byte (ibmphp_pci_bus, devfn, PCI_SECONDARY_BUS, &amp;sec_number);&n;&t;debug (&quot;sec_number after write/read is %x&bslash;n&quot;, sec_number);&n;&t; ________________________________________________________________________________*/
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_SUBORDINATE_BUS
comma
id|sec_number
)paren
suffix:semicolon
multiline_comment|/* __________________For debugging purposes only ____________________________________&n;&t;pci_bus_read_config_byte (ibmphp_pci_bus, devfn, PCI_SUBORDINATE_BUS, &amp;sec_number);&n;&t;debug (&quot;subordinate number after write/read is %x&bslash;n&quot;, sec_number);&n;&t; __________________________________________________________________________________*/
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_CACHE_LINE_SIZE
comma
id|CACHE
)paren
suffix:semicolon
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_LATENCY_TIMER
comma
id|LATENCY
)paren
suffix:semicolon
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_SEC_LATENCY_TIMER
comma
id|LATENCY
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;func-&gt;busno is %x&bslash;n&quot;
comma
id|func-&gt;busno
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;sec_number after writing is %x&bslash;n&quot;
comma
id|sec_number
)paren
suffix:semicolon
multiline_comment|/* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&n;&t;   !!!!!!!!!!!!!!!NEED TO ADD!!!  FAST BACK-TO-BACK ENABLE!!!!!!!!!!!!!!!!!!!! &n;&t;   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
multiline_comment|/* First we need to allocate mem/io for the bridge itself in case it needs it */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|address
(braket
id|count
)braket
suffix:semicolon
id|count
op_increment
)paren
(brace
multiline_comment|/* for 2 BARs */
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bar
(braket
id|count
)braket
)paren
(brace
multiline_comment|/* This BAR is not implemented */
id|debug
(paren
l_string|&quot;so we come here then, eh?, count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
singleline_comment|//  tmp_bar = bar[count];
id|debug
(paren
l_string|&quot;Bar %d wants %x&bslash;n&quot;
comma
id|count
comma
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
multiline_comment|/* This is IO */
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFFC
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|debug
(paren
l_string|&quot;len[count] in IO = %x&bslash;n&quot;
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|bus_io
(braket
id|count
)braket
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|resource_node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus_io
(braket
id|count
)braket
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|bus_io
(braket
id|count
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|bus_io
(braket
id|count
)braket
op_member_access_from_pointer
id|type
op_assign
id|IO
suffix:semicolon
id|bus_io
(braket
id|count
)braket
op_member_access_from_pointer
id|busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|bus_io
(braket
id|count
)braket
op_member_access_from_pointer
id|devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|bus_io
(braket
id|count
)braket
op_member_access_from_pointer
id|len
op_assign
id|len
(braket
id|count
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|bus_io
(braket
id|count
)braket
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|bus_io
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;io
(braket
id|count
)braket
op_assign
id|bus_io
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;cannot allocate requested io for bus %x, device %x, len %x&bslash;n&quot;
comma
id|func-&gt;busno
comma
id|func-&gt;device
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|bus_io
(braket
id|count
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
id|func-&gt;io
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This is Memory */
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_PREFETCH
)paren
(brace
multiline_comment|/* pfmem */
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|debug
(paren
l_string|&quot;len[count] in PFMEM = %x&bslash;n&quot;
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|bus_pfmem
(braket
id|count
)braket
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|resource_node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus_pfmem
(braket
id|count
)braket
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|bus_pfmem
(braket
id|count
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|type
op_assign
id|PFMEM
suffix:semicolon
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|len
op_assign
id|len
(braket
id|count
)braket
suffix:semicolon
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|fromMem
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|bus_pfmem
(braket
id|count
)braket
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|bus_pfmem
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;pfmem
(braket
id|count
)braket
op_assign
id|bus_pfmem
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
id|mem_tmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mem_tmp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_tmp
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|mem_tmp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|mem_tmp-&gt;type
op_assign
id|MEM
suffix:semicolon
id|mem_tmp-&gt;busno
op_assign
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|busno
suffix:semicolon
id|mem_tmp-&gt;devfunc
op_assign
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|devfunc
suffix:semicolon
id|mem_tmp-&gt;len
op_assign
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|mem_tmp
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|mem_tmp
)paren
suffix:semicolon
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|fromMem
op_assign
id|TRUE
suffix:semicolon
id|bus_pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|rangeno
op_assign
id|mem_tmp-&gt;rangeno
suffix:semicolon
id|ibmphp_add_pfmem_from_mem
(paren
id|bus_pfmem
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;pfmem
(braket
id|count
)braket
op_assign
id|bus_pfmem
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;cannot allocate requested pfmem for bus %x, device %x, len %x&bslash;n&quot;
comma
id|func-&gt;busno
comma
id|func-&gt;device
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|mem_tmp
)paren
suffix:semicolon
id|kfree
(paren
id|bus_pfmem
(braket
id|count
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
id|func-&gt;pfmem
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|count
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* on the 2nd dword, write all 0s, since we can&squot;t handle them n.e.ways */
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
l_int|0x00000000
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* regular memory */
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|debug
(paren
l_string|&quot;len[count] in Memory is %x&bslash;n&quot;
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|bus_mem
(braket
id|count
)braket
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|resource_node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus_mem
(braket
id|count
)braket
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|bus_mem
(braket
id|count
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|bus_mem
(braket
id|count
)braket
op_member_access_from_pointer
id|type
op_assign
id|MEM
suffix:semicolon
id|bus_mem
(braket
id|count
)braket
op_member_access_from_pointer
id|busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|bus_mem
(braket
id|count
)braket
op_member_access_from_pointer
id|devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|bus_mem
(braket
id|count
)braket
op_member_access_from_pointer
id|len
op_assign
id|len
(braket
id|count
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|bus_mem
(braket
id|count
)braket
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|bus_mem
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;mem
(braket
id|count
)braket
op_assign
id|bus_mem
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;cannot allocate requested mem for bus %x, device %x, len %x&bslash;n&quot;
comma
id|func-&gt;busno
comma
id|func-&gt;device
comma
id|len
(braket
id|count
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|bus_mem
(braket
id|count
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
id|func-&gt;mem
(braket
id|count
)braket
op_member_access_from_pointer
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|count
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* on the 2nd dword, write all 0s, since we can&squot;t handle them n.e.ways */
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
l_int|0x00000000
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* end of mem */
)brace
multiline_comment|/* end of for  */
multiline_comment|/* Now need to see how much space the devices behind the bridge needed */
id|amount_needed
op_assign
id|scan_behind_bridge
(paren
id|func
comma
id|sec_number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amount_needed
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ibmphp_pci_bus-&gt;number
op_assign
id|func-&gt;busno
suffix:semicolon
id|debug
(paren
l_string|&quot;after coming back from scan_behind_bridge&bslash;n&quot;
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;amount_needed-&gt;not_correct = %x&bslash;n&quot;
comma
id|amount_needed-&gt;not_correct
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;amount_needed-&gt;io = %x&bslash;n&quot;
comma
id|amount_needed-&gt;io
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;amount_needed-&gt;mem = %x&bslash;n&quot;
comma
id|amount_needed-&gt;mem
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;amount_needed-&gt;pfmem =  %x&bslash;n&quot;
comma
id|amount_needed-&gt;pfmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amount_needed-&gt;not_correct
)paren
(brace
id|debug
(paren
l_string|&quot;amount_needed is not correct&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|address
(braket
id|count
)braket
suffix:semicolon
id|count
op_increment
)paren
(brace
multiline_comment|/* for 2 BARs */
r_if
c_cond
(paren
id|bus_io
(braket
id|count
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|bus_io
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;io
(braket
id|count
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bus_pfmem
(braket
id|count
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|bus_pfmem
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;pfmem
(braket
id|count
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bus_mem
(braket
id|count
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|bus_mem
(braket
id|count
)braket
)paren
suffix:semicolon
id|func-&gt;mem
(braket
id|count
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|kfree
(paren
id|amount_needed
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|amount_needed-&gt;io
)paren
(brace
id|debug
(paren
l_string|&quot;it doesn&squot;t want IO?&bslash;n&quot;
)paren
suffix:semicolon
id|flag_io
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|debug
(paren
l_string|&quot;it wants %x IO behind the bridge&bslash;n&quot;
comma
id|amount_needed-&gt;io
)paren
suffix:semicolon
id|io
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|io
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|io
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|io-&gt;type
op_assign
id|IO
suffix:semicolon
id|io-&gt;busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|io-&gt;devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|io-&gt;len
op_assign
id|amount_needed-&gt;io
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|io
comma
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|debug
(paren
l_string|&quot;were we able to add io&bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_add_resource
(paren
id|io
)paren
suffix:semicolon
id|flag_io
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|amount_needed-&gt;mem
)paren
(brace
id|debug
(paren
l_string|&quot;it doesn&squot;t want n.e.memory?&bslash;n&quot;
)paren
suffix:semicolon
id|flag_mem
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|debug
(paren
l_string|&quot;it wants %x memory behind the bridge&bslash;n&quot;
comma
id|amount_needed-&gt;mem
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mem
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|mem
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|mem-&gt;type
op_assign
id|MEM
suffix:semicolon
id|mem-&gt;busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|mem-&gt;devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|mem-&gt;len
op_assign
id|amount_needed-&gt;mem
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|mem
comma
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|mem
)paren
suffix:semicolon
id|flag_mem
op_assign
id|TRUE
suffix:semicolon
id|debug
(paren
l_string|&quot;were we able to add mem&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|amount_needed-&gt;pfmem
)paren
(brace
id|debug
(paren
l_string|&quot;it doesn&squot;t want n.e.pfmem mem?&bslash;n&quot;
)paren
suffix:semicolon
id|flag_pfmem
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|debug
(paren
l_string|&quot;it wants %x pfmemory behind the bridge&bslash;n&quot;
comma
id|amount_needed-&gt;pfmem
)paren
suffix:semicolon
id|pfmem
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|pfmem
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pfmem
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|pfmem
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|pfmem-&gt;type
op_assign
id|PFMEM
suffix:semicolon
id|pfmem-&gt;busno
op_assign
id|func-&gt;busno
suffix:semicolon
id|pfmem-&gt;devfunc
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|pfmem-&gt;len
op_assign
id|amount_needed-&gt;pfmem
suffix:semicolon
id|pfmem-&gt;fromMem
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|pfmem
comma
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|pfmem
)paren
suffix:semicolon
id|flag_pfmem
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|mem_tmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mem_tmp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_tmp
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|mem_tmp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource_node
)paren
)paren
suffix:semicolon
id|mem_tmp-&gt;type
op_assign
id|MEM
suffix:semicolon
id|mem_tmp-&gt;busno
op_assign
id|pfmem-&gt;busno
suffix:semicolon
id|mem_tmp-&gt;devfunc
op_assign
id|pfmem-&gt;devfunc
suffix:semicolon
id|mem_tmp-&gt;len
op_assign
id|pfmem-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_check_resource
(paren
id|mem_tmp
comma
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|ibmphp_add_resource
(paren
id|mem_tmp
)paren
suffix:semicolon
id|pfmem-&gt;fromMem
op_assign
id|TRUE
suffix:semicolon
id|pfmem-&gt;rangeno
op_assign
id|mem_tmp-&gt;rangeno
suffix:semicolon
id|ibmphp_add_pfmem_from_mem
(paren
id|pfmem
)paren
suffix:semicolon
id|flag_pfmem
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
)brace
id|debug
(paren
l_string|&quot;b4 if (flag_io &amp;&amp; flag_mem &amp;&amp; flag_pfmem)&bslash;n&quot;
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;flag_io = %x, flag_mem = %x, flag_pfmem = %x&bslash;n&quot;
comma
id|flag_io
comma
id|flag_mem
comma
id|flag_pfmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag_io
op_logical_and
id|flag_mem
op_logical_and
id|flag_pfmem
)paren
(brace
multiline_comment|/* If on bootup, there was a bridged card in this slot,&n;&t;&t; * then card was removed and ibmphp got unloaded and loaded&n;&t;&t; * back again, there&squot;s no way for us to remove the bus&n;&t;&t; * struct, so no need to kmalloc, can use existing node&n;&t;&t; */
id|bus
op_assign
id|ibmphp_find_res_bus
(paren
id|sec_number
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|bus
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|bus
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|bus
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|bus_node
)paren
)paren
suffix:semicolon
id|bus-&gt;busno
op_assign
id|sec_number
suffix:semicolon
id|debug
(paren
l_string|&quot;b4 adding new bus&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|add_new_bus
(paren
id|bus
comma
id|io
comma
id|mem
comma
id|pfmem
comma
id|func-&gt;busno
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|bus-&gt;rangeIO
)paren
op_logical_and
op_logical_neg
(paren
id|bus-&gt;rangeMem
)paren
op_logical_and
op_logical_neg
(paren
id|bus-&gt;rangePFMem
)paren
)paren
id|rc
op_assign
id|add_new_bus
(paren
id|bus
comma
id|io
comma
id|mem
comma
id|pfmem
comma
l_int|0xFF
)paren
suffix:semicolon
r_else
(brace
id|err
(paren
l_string|&quot;expected bus structure not empty?&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|ibmphp_remove_bus
(paren
id|bus
comma
id|func-&gt;busno
)paren
suffix:semicolon
id|kfree
(paren
id|amount_needed
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|retval
op_assign
id|rc
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_IO_BASE
comma
op_amp
id|io_base
)paren
suffix:semicolon
id|pci_bus_read_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PREF_MEMORY_BASE
comma
op_amp
id|pfmem_base
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|io_base
op_amp
id|PCI_IO_RANGE_TYPE_MASK
)paren
op_eq
id|PCI_IO_RANGE_TYPE_32
)paren
(brace
id|debug
(paren
l_string|&quot;io 32&bslash;n&quot;
)paren
suffix:semicolon
id|need_io_upper
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|io_base
op_amp
id|PCI_PREF_RANGE_TYPE_MASK
)paren
op_eq
id|PCI_PREF_RANGE_TYPE_64
)paren
(brace
id|debug
(paren
l_string|&quot;pfmem 64&bslash;n&quot;
)paren
suffix:semicolon
id|need_pfmem_upper
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus-&gt;noIORanges
)paren
(brace
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_IO_BASE
comma
l_int|0x00
op_or
id|bus-&gt;rangeIO-&gt;start
op_rshift
l_int|8
)paren
suffix:semicolon
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_IO_LIMIT
comma
l_int|0x00
op_or
id|bus-&gt;rangeIO-&gt;end
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* _______________This is for debugging purposes only ____________________&n;&t;&t;&t;pci_bus_read_config_byte (ibmphp_pci_bus, devfn, PCI_IO_BASE, &amp;temp);&n;&t;&t;&t;debug (&quot;io_base = %x&bslash;n&quot;, (temp &amp; PCI_IO_RANGE_TYPE_MASK) &lt;&lt; 8);&n;&t;&t;&t;pci_bus_read_config_byte (ibmphp_pci_bus, devfn, PCI_IO_LIMIT, &amp;temp);&n;&t;&t;&t;debug (&quot;io_limit = %x&bslash;n&quot;, (temp &amp; PCI_IO_RANGE_TYPE_MASK) &lt;&lt; 8);&n;&t;&t;&t; ________________________________________________________________________*/
r_if
c_cond
(paren
id|need_io_upper
)paren
(brace
multiline_comment|/* since can&squot;t support n.e.ways */
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_IO_BASE_UPPER16
comma
l_int|0x0000
)paren
suffix:semicolon
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_IO_LIMIT_UPPER16
comma
l_int|0x0000
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_IO_BASE
comma
l_int|0x00
)paren
suffix:semicolon
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_IO_LIMIT
comma
l_int|0x00
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus-&gt;noMemRanges
)paren
(brace
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_MEMORY_BASE
comma
l_int|0x0000
op_or
id|bus-&gt;rangeMem-&gt;start
op_rshift
l_int|16
)paren
suffix:semicolon
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_MEMORY_LIMIT
comma
l_int|0x0000
op_or
id|bus-&gt;rangeMem-&gt;end
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* ____________________This is for debugging purposes only ________________________&n;&t;&t;&t;pci_bus_read_config_word (ibmphp_pci_bus, devfn, PCI_MEMORY_BASE, &amp;temp);&n;&t;&t;&t;debug (&quot;mem_base = %x&bslash;n&quot;, (temp &amp; PCI_MEMORY_RANGE_TYPE_MASK) &lt;&lt; 16);&n;&t;&t;&t;pci_bus_read_config_word (ibmphp_pci_bus, devfn, PCI_MEMORY_LIMIT, &amp;temp);&n;&t;&t;&t;debug (&quot;mem_limit = %x&bslash;n&quot;, (temp &amp; PCI_MEMORY_RANGE_TYPE_MASK) &lt;&lt; 16);&n;&t;&t;&t; __________________________________________________________________________________*/
)brace
r_else
(brace
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_MEMORY_BASE
comma
l_int|0xffff
)paren
suffix:semicolon
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_MEMORY_LIMIT
comma
l_int|0x0000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus-&gt;noPFMemRanges
)paren
(brace
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PREF_MEMORY_BASE
comma
l_int|0x0000
op_or
id|bus-&gt;rangePFMem-&gt;start
op_rshift
l_int|16
)paren
suffix:semicolon
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PREF_MEMORY_LIMIT
comma
l_int|0x0000
op_or
id|bus-&gt;rangePFMem-&gt;end
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* __________________________This is for debugging purposes only _______________________&n;&t;&t;&t;pci_bus_read_config_word (ibmphp_pci_bus, devfn, PCI_PREF_MEMORY_BASE, &amp;temp);&n;&t;&t;&t;debug (&quot;pfmem_base = %x&quot;, (temp &amp; PCI_MEMORY_RANGE_TYPE_MASK) &lt;&lt; 16);&n;&t;&t;&t;pci_bus_read_config_word (ibmphp_pci_bus, devfn, PCI_PREF_MEMORY_LIMIT, &amp;temp);&n;&t;&t;&t;debug (&quot;pfmem_limit = %x&bslash;n&quot;, (temp &amp; PCI_MEMORY_RANGE_TYPE_MASK) &lt;&lt; 16);&n;&t;&t;&t; ______________________________________________________________________________________*/
r_if
c_cond
(paren
id|need_pfmem_upper
)paren
(brace
multiline_comment|/* since can&squot;t support n.e.ways */
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PREF_BASE_UPPER32
comma
l_int|0x00000000
)paren
suffix:semicolon
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PREF_LIMIT_UPPER32
comma
l_int|0x00000000
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PREF_MEMORY_BASE
comma
l_int|0xffff
)paren
suffix:semicolon
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PREF_MEMORY_LIMIT
comma
l_int|0x0000
)paren
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;b4 writing control information&bslash;n&quot;
)paren
suffix:semicolon
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irq
OG
l_int|0x00
)paren
op_logical_and
(paren
id|irq
OL
l_int|0x05
)paren
)paren
id|pci_bus_write_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_INTERRUPT_LINE
comma
id|func-&gt;irq
(braket
id|irq
op_minus
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/*    &n;&t;&t;pci_bus_write_config_byte (ibmphp_pci_bus, devfn, PCI_BRIDGE_CONTROL, ctrl);&n;&t;&t;pci_bus_write_config_byte (ibmphp_pci_bus, devfn, PCI_BRIDGE_CONTROL, PCI_BRIDGE_CTL_PARITY);&n;&t;&t;pci_bus_write_config_byte (ibmphp_pci_bus, devfn, PCI_BRIDGE_CONTROL, PCI_BRIDGE_CTL_SERR);&n;&t;&t; */
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
id|DEVICEENABLE
)paren
suffix:semicolon
id|pci_bus_write_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_BRIDGE_CONTROL
comma
l_int|0x07
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|amount_needed-&gt;devices
(braket
id|i
)braket
)paren
(brace
id|debug
(paren
l_string|&quot;device where devices[i] is 1 = %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|func-&gt;devices
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|func-&gt;bus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* For unconfiguring, to indicate it&squot;s PPB */
id|func_passed
op_assign
op_amp
id|func
suffix:semicolon
id|debug
(paren
l_string|&quot;func-&gt;busno b4 returning is %x&bslash;n&quot;
comma
id|func-&gt;busno
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;func-&gt;busno b4 returning in the other structure is %x&bslash;n&quot;
comma
(paren
op_star
id|func_passed
)paren
op_member_access_from_pointer
id|busno
)paren
suffix:semicolon
id|kfree
(paren
id|amount_needed
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;Configuring bridge was unsuccessful...&bslash;n&quot;
)paren
suffix:semicolon
id|mem_tmp
op_assign
l_int|NULL
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|error
suffix:colon
id|kfree
c_func
(paren
id|amount_needed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pfmem
)paren
id|ibmphp_remove_resource
(paren
id|pfmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io
)paren
id|ibmphp_remove_resource
(paren
id|io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
id|ibmphp_remove_resource
(paren
id|mem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* for 2 BARs */
r_if
c_cond
(paren
id|bus_io
(braket
id|i
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|bus_io
(braket
id|i
)braket
)paren
suffix:semicolon
id|func-&gt;io
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bus_pfmem
(braket
id|i
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|bus_pfmem
(braket
id|i
)braket
)paren
suffix:semicolon
id|func-&gt;pfmem
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bus_mem
(braket
id|i
)braket
)paren
(brace
id|ibmphp_remove_resource
(paren
id|bus_mem
(braket
id|i
)braket
)paren
suffix:semicolon
id|func-&gt;mem
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * This function adds up the amount of resources needed behind the PPB bridge&n; * and passes it to the configure_bridge function&n; * Input: bridge function&n; * Ouput: amount of resources needed&n; *****************************************************************************/
DECL|function|scan_behind_bridge
r_static
r_struct
id|res_needed
op_star
id|scan_behind_bridge
(paren
r_struct
id|pci_func
op_star
id|func
comma
id|u8
id|busno
)paren
(brace
r_int
id|count
comma
id|len
(braket
l_int|6
)braket
suffix:semicolon
id|u16
id|vendor_id
suffix:semicolon
id|u8
id|hdr_type
suffix:semicolon
id|u8
id|device
comma
id|function
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
r_int
id|howmany
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*this is to see if there are any devices behind the bridge */
id|u32
id|bar
(braket
l_int|6
)braket
comma
r_class
suffix:semicolon
id|u32
id|address
(braket
)braket
op_assign
(brace
id|PCI_BASE_ADDRESS_0
comma
id|PCI_BASE_ADDRESS_1
comma
id|PCI_BASE_ADDRESS_2
comma
id|PCI_BASE_ADDRESS_3
comma
id|PCI_BASE_ADDRESS_4
comma
id|PCI_BASE_ADDRESS_5
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|res_needed
op_star
id|amount
suffix:semicolon
id|amount
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|amount
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amount
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
(paren
id|amount
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|res_needed
)paren
)paren
suffix:semicolon
id|ibmphp_pci_bus-&gt;number
op_assign
id|busno
suffix:semicolon
id|debug
(paren
l_string|&quot;the bus_no behind the bridge is %x&bslash;n&quot;
comma
id|busno
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;scanning devices behind the bridge...&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|device
op_assign
l_int|0
suffix:semicolon
id|device
OL
l_int|32
suffix:semicolon
id|device
op_increment
)paren
(brace
id|amount-&gt;devices
(braket
id|device
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|function
op_assign
l_int|0
suffix:semicolon
id|function
OL
l_int|8
suffix:semicolon
id|function
op_increment
)paren
(brace
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
suffix:semicolon
id|pci_bus_read_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendor_id
op_ne
id|PCI_VENDOR_ID_NOTVALID
)paren
(brace
multiline_comment|/* found correct device!!! */
id|howmany
op_increment
suffix:semicolon
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|hdr_type
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_CLASS_REVISION
comma
op_amp
r_class
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;hdr_type behind the bridge is %x&bslash;n&quot;
comma
id|hdr_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdr_type
op_amp
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
id|err
(paren
l_string|&quot;embedded bridges not supported for hot-plugging.&bslash;n&quot;
)paren
suffix:semicolon
id|amount-&gt;not_correct
op_assign
id|TRUE
suffix:semicolon
r_return
id|amount
suffix:semicolon
)brace
r_class
op_rshift_assign
l_int|8
suffix:semicolon
multiline_comment|/* to take revision out, class = class.subclass.prog i/f */
r_if
c_cond
(paren
r_class
op_eq
id|PCI_CLASS_NOT_DEFINED_VGA
)paren
(brace
id|err
(paren
l_string|&quot;The device %x is VGA compatible and as is not supported for hot plugging. &quot;
l_string|&quot;Please choose another device.&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
id|amount-&gt;not_correct
op_assign
id|TRUE
suffix:semicolon
r_return
id|amount
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
r_class
op_eq
id|PCI_CLASS_DISPLAY_VGA
)paren
(brace
id|err
(paren
l_string|&quot;The device %x is not supported for hot plugging. &quot;
l_string|&quot;Please choose another device.&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
id|amount-&gt;not_correct
op_assign
id|TRUE
suffix:semicolon
r_return
id|amount
suffix:semicolon
)brace
id|amount-&gt;devices
(braket
id|device
)braket
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|address
(braket
id|count
)braket
suffix:semicolon
id|count
op_increment
)paren
(brace
multiline_comment|/* for 6 BARs */
multiline_comment|/*&n;&t;&t;&t;&t;&t;pci_bus_read_config_byte (ibmphp_pci_bus, devfn, address[count], &amp;tmp);&n;&t;&t;&t;&t;&t;if (tmp &amp; 0x01) // IO&n;&t;&t;&t;&t;&t;&t;pci_bus_write_config_dword (ibmphp_pci_bus, devfn, address[count], 0xFFFFFFFD);&n;&t;&t;&t;&t;&t;else // MEMORY&n;&t;&t;&t;&t;&t;&t;pci_bus_write_config_dword (ibmphp_pci_bus, devfn, address[count], 0xFFFFFFFF);&n;&t;&t;&t;&t;&t;*/
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;what is bar[count]? %x, count = %d&bslash;n&quot;
comma
id|bar
(braket
id|count
)braket
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bar
(braket
id|count
)braket
)paren
multiline_comment|/* This BAR is not implemented */
r_continue
suffix:semicolon
singleline_comment|//tmp_bar = bar[count];
id|debug
(paren
l_string|&quot;count %d device %x function %x wants %x resources&bslash;n&quot;
comma
id|count
comma
id|device
comma
id|function
comma
id|bar
(braket
id|count
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
multiline_comment|/* This is IO */
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFFC
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|amount-&gt;io
op_add_assign
id|len
(braket
id|count
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This is Memory */
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_PREFETCH
)paren
(brace
multiline_comment|/* pfmem */
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|amount-&gt;pfmem
op_add_assign
id|len
(braket
id|count
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
multiline_comment|/* takes up another dword */
id|count
op_add_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* regular memory */
id|len
(braket
id|count
)braket
op_assign
id|bar
(braket
id|count
)braket
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
id|len
(braket
id|count
)braket
op_assign
op_complement
id|len
(braket
id|count
)braket
op_plus
l_int|1
suffix:semicolon
id|amount-&gt;mem
op_add_assign
id|len
(braket
id|count
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bar
(braket
id|count
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|count
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* end for */
)brace
multiline_comment|/* end if (valid) */
)brace
multiline_comment|/* end for */
)brace
multiline_comment|/* end for */
r_if
c_cond
(paren
op_logical_neg
id|howmany
)paren
id|amount-&gt;not_correct
op_assign
id|TRUE
suffix:semicolon
r_else
id|amount-&gt;not_correct
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|amount-&gt;io
)paren
op_logical_and
(paren
id|amount-&gt;io
OL
id|IOBRIDGE
)paren
)paren
id|amount-&gt;io
op_assign
id|IOBRIDGE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|amount-&gt;mem
)paren
op_logical_and
(paren
id|amount-&gt;mem
OL
id|MEMBRIDGE
)paren
)paren
id|amount-&gt;mem
op_assign
id|MEMBRIDGE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|amount-&gt;pfmem
)paren
op_logical_and
(paren
id|amount-&gt;pfmem
OL
id|MEMBRIDGE
)paren
)paren
id|amount-&gt;pfmem
op_assign
id|MEMBRIDGE
suffix:semicolon
r_return
id|amount
suffix:semicolon
)brace
multiline_comment|/* The following 3 unconfigure_boot_ routines deal with the case when we had the card &n; * upon bootup in the system, since we don&squot;t allocate func to such case, we need to read &n; * the start addresses from pci config space and then find the corresponding entries in &n; * our resource lists.  The functions return either 0, -ENODEV, or -1 (general failure)&n; * Change: we also call these functions even if we configured the card ourselves (i.e., not&n; * the bootup case), since it should work same way&n; */
DECL|function|unconfigure_boot_device
r_static
r_int
id|unconfigure_boot_device
(paren
id|u8
id|busno
comma
id|u8
id|device
comma
id|u8
id|function
)paren
(brace
id|u32
id|start_address
suffix:semicolon
id|u32
id|address
(braket
)braket
op_assign
(brace
id|PCI_BASE_ADDRESS_0
comma
id|PCI_BASE_ADDRESS_1
comma
id|PCI_BASE_ADDRESS_2
comma
id|PCI_BASE_ADDRESS_3
comma
id|PCI_BASE_ADDRESS_4
comma
id|PCI_BASE_ADDRESS_5
comma
l_int|0
)brace
suffix:semicolon
r_int
id|count
suffix:semicolon
r_struct
id|resource_node
op_star
id|io
suffix:semicolon
r_struct
id|resource_node
op_star
id|mem
suffix:semicolon
r_struct
id|resource_node
op_star
id|pfmem
suffix:semicolon
r_struct
id|bus_node
op_star
id|bus
suffix:semicolon
id|u32
id|end_address
suffix:semicolon
id|u32
id|temp_end
suffix:semicolon
id|u32
id|size
suffix:semicolon
id|u32
id|tmp_address
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|bus
op_assign
id|ibmphp_find_res_bus
(paren
id|busno
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|debug
(paren
l_string|&quot;cannot find corresponding bus.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
suffix:semicolon
id|ibmphp_pci_bus-&gt;number
op_assign
id|busno
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|address
(braket
id|count
)braket
suffix:semicolon
id|count
op_increment
)paren
(brace
multiline_comment|/* for 6 BARs */
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|start_address
)paren
suffix:semicolon
multiline_comment|/* We can do this here, b/c by that time the device driver of the card has been stopped */
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|size
)paren
suffix:semicolon
id|pci_bus_write_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
id|start_address
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;start_address is %x&bslash;n&quot;
comma
id|start_address
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;busno, device, function %x %x %x&bslash;n&quot;
comma
id|busno
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|size
)paren
(brace
multiline_comment|/* This BAR is not implemented */
id|debug
(paren
l_string|&quot;is this bar no implemented?, count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|tmp_address
op_assign
id|start_address
suffix:semicolon
r_if
c_cond
(paren
id|start_address
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
multiline_comment|/* This is IO */
id|start_address
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|size
op_assign
id|size
op_amp
l_int|0xFFFFFFFC
suffix:semicolon
id|size
op_assign
op_complement
id|size
op_plus
l_int|1
suffix:semicolon
id|end_address
op_assign
id|start_address
op_plus
id|size
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_find_resource
(paren
id|bus
comma
id|start_address
comma
op_amp
id|io
comma
id|IO
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;cannot find corresponding IO resource to remove&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;io-&gt;start = %x&bslash;n&quot;
comma
id|io-&gt;start
)paren
suffix:semicolon
id|temp_end
op_assign
id|io-&gt;end
suffix:semicolon
id|start_address
op_assign
id|io-&gt;end
op_plus
l_int|1
suffix:semicolon
id|ibmphp_remove_resource
(paren
id|io
)paren
suffix:semicolon
multiline_comment|/* This is needed b/c of the old I/O restrictions in the BIOS */
r_while
c_loop
(paren
id|temp_end
OL
id|end_address
)paren
(brace
r_if
c_cond
(paren
id|ibmphp_find_resource
(paren
id|bus
comma
id|start_address
comma
op_amp
id|io
comma
id|IO
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;cannot find corresponding IO resource to remove&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;io-&gt;start = %x&bslash;n&quot;
comma
id|io-&gt;start
)paren
suffix:semicolon
id|temp_end
op_assign
id|io-&gt;end
suffix:semicolon
id|start_address
op_assign
id|io-&gt;end
op_plus
l_int|1
suffix:semicolon
id|ibmphp_remove_resource
(paren
id|io
)paren
suffix:semicolon
)brace
multiline_comment|/* ????????? DO WE NEED TO WRITE ANYTHING INTO THE PCI CONFIG SPACE BACK ?????????? */
)brace
r_else
(brace
multiline_comment|/* This is Memory */
r_if
c_cond
(paren
id|start_address
op_amp
id|PCI_BASE_ADDRESS_MEM_PREFETCH
)paren
(brace
multiline_comment|/* pfmem */
id|start_address
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|debug
(paren
l_string|&quot;start address of pfmem is %x&bslash;n&quot;
comma
id|start_address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_find_resource
(paren
id|bus
comma
id|start_address
comma
op_amp
id|pfmem
comma
id|PFMEM
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;cannot find corresponding PFMEM resource to remove&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pfmem
)paren
id|debug
(paren
l_string|&quot;pfmem-&gt;start = %x&bslash;n&quot;
comma
id|pfmem-&gt;start
)paren
suffix:semicolon
id|ibmphp_remove_resource
(paren
id|pfmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_address
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|count
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* regular memory */
id|start_address
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|debug
(paren
l_string|&quot;start address of mem is %x&bslash;n&quot;
comma
id|start_address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_find_resource
(paren
id|bus
comma
id|start_address
comma
op_amp
id|mem
comma
id|MEM
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;cannot find corresponding MEM resource to remove&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mem
)paren
id|debug
(paren
l_string|&quot;mem-&gt;start = %x&bslash;n&quot;
comma
id|mem-&gt;start
)paren
suffix:semicolon
id|ibmphp_remove_resource
(paren
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_address
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|count
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* end of mem */
)brace
multiline_comment|/* end of for */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unconfigure_boot_bridge
r_static
r_int
id|unconfigure_boot_bridge
(paren
id|u8
id|busno
comma
id|u8
id|device
comma
id|u8
id|function
)paren
(brace
r_int
id|count
suffix:semicolon
r_int
id|bus_no
comma
id|pri_no
comma
id|sub_no
comma
id|sec_no
op_assign
l_int|0
suffix:semicolon
id|u32
id|start_address
comma
id|tmp_address
suffix:semicolon
id|u8
id|sec_number
comma
id|sub_number
comma
id|pri_number
suffix:semicolon
r_struct
id|resource_node
op_star
id|io
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|resource_node
op_star
id|mem
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|resource_node
op_star
id|pfmem
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|bus_node
op_star
id|bus
suffix:semicolon
id|u32
id|address
(braket
)braket
op_assign
(brace
id|PCI_BASE_ADDRESS_0
comma
id|PCI_BASE_ADDRESS_1
comma
l_int|0
)brace
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
suffix:semicolon
id|ibmphp_pci_bus-&gt;number
op_assign
id|busno
suffix:semicolon
id|bus_no
op_assign
(paren
r_int
)paren
id|busno
suffix:semicolon
id|debug
(paren
l_string|&quot;busno is %x&bslash;n&quot;
comma
id|busno
)paren
suffix:semicolon
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_PRIMARY_BUS
comma
op_amp
id|pri_number
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - busno = %x, primary_number = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|busno
comma
id|pri_number
)paren
suffix:semicolon
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|sec_number
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;sec_number is %x&bslash;n&quot;
comma
id|sec_number
)paren
suffix:semicolon
id|sec_no
op_assign
(paren
r_int
)paren
id|sec_number
suffix:semicolon
id|pri_no
op_assign
(paren
r_int
)paren
id|pri_number
suffix:semicolon
r_if
c_cond
(paren
id|pri_no
op_ne
id|bus_no
)paren
(brace
id|err
(paren
l_string|&quot;primary numbers in our structures and pci config space don&squot;t match.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|sec_number
)paren
suffix:semicolon
id|sec_no
op_assign
(paren
r_int
)paren
id|sec_no
suffix:semicolon
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_SUBORDINATE_BUS
comma
op_amp
id|sub_number
)paren
suffix:semicolon
id|sub_no
op_assign
(paren
r_int
)paren
id|sub_number
suffix:semicolon
id|debug
(paren
l_string|&quot;sub_no is %d, sec_no is %d&bslash;n&quot;
comma
id|sub_no
comma
id|sec_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sec_no
op_ne
id|sub_number
)paren
(brace
id|err
(paren
l_string|&quot;there&squot;re more buses behind this bridge.  Hot removal is not supported.  Please choose another card&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|bus
op_assign
id|ibmphp_find_res_bus
(paren
id|sec_number
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;bus-&gt;busno is %x&bslash;n&quot;
comma
id|bus-&gt;busno
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;sec_number is %x&bslash;n&quot;
comma
id|sec_number
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|err
(paren
l_string|&quot;cannot find Bus structure for the bridged device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ibmphp_remove_bus
(paren
id|bus
comma
id|busno
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|address
(braket
id|count
)braket
suffix:semicolon
id|count
op_increment
)paren
(brace
multiline_comment|/* for 2 BARs */
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|address
(braket
id|count
)braket
comma
op_amp
id|start_address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start_address
)paren
(brace
multiline_comment|/* This BAR is not implemented */
r_continue
suffix:semicolon
)brace
id|tmp_address
op_assign
id|start_address
suffix:semicolon
r_if
c_cond
(paren
id|start_address
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
multiline_comment|/* This is IO */
id|start_address
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_find_resource
(paren
id|bus
comma
id|start_address
comma
op_amp
id|io
comma
id|IO
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;cannot find corresponding IO resource to remove&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|io
)paren
id|debug
(paren
l_string|&quot;io-&gt;start = %x&bslash;n&quot;
comma
id|io-&gt;start
)paren
suffix:semicolon
id|ibmphp_remove_resource
(paren
id|io
)paren
suffix:semicolon
multiline_comment|/* ????????? DO WE NEED TO WRITE ANYTHING INTO THE PCI CONFIG SPACE BACK ?????????? */
)brace
r_else
(brace
multiline_comment|/* This is Memory */
r_if
c_cond
(paren
id|start_address
op_amp
id|PCI_BASE_ADDRESS_MEM_PREFETCH
)paren
(brace
multiline_comment|/* pfmem */
id|start_address
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_find_resource
(paren
id|bus
comma
id|start_address
comma
op_amp
id|pfmem
comma
id|PFMEM
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;cannot find corresponding PFMEM resource to remove&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pfmem
)paren
id|debug
(paren
l_string|&quot;pfmem-&gt;start = %x&bslash;n&quot;
comma
id|pfmem-&gt;start
)paren
suffix:semicolon
id|ibmphp_remove_resource
(paren
id|pfmem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_address
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|count
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* regular memory */
id|start_address
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_find_resource
(paren
id|bus
comma
id|start_address
comma
op_amp
id|mem
comma
id|MEM
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;cannot find corresponding MEM resource to remove&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mem
)paren
id|debug
(paren
l_string|&quot;mem-&gt;start = %x&bslash;n&quot;
comma
id|mem-&gt;start
)paren
suffix:semicolon
id|ibmphp_remove_resource
(paren
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_address
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
(brace
multiline_comment|/* takes up another dword */
id|count
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* end of mem */
)brace
multiline_comment|/* end of for */
id|debug
(paren
l_string|&quot;%s - exiting, returning success&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unconfigure_boot_card
r_static
r_int
id|unconfigure_boot_card
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
id|u16
id|vendor_id
suffix:semicolon
id|u32
r_class
suffix:semicolon
id|u8
id|hdr_type
suffix:semicolon
id|u8
id|device
suffix:semicolon
id|u8
id|busno
suffix:semicolon
id|u8
id|function
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
id|u8
id|valid_device
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* To see if we are ever able to find valid device and read it */
id|debug
(paren
l_string|&quot;%s - enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|device
op_assign
id|slot_cur-&gt;device
suffix:semicolon
id|busno
op_assign
id|slot_cur-&gt;bus
suffix:semicolon
id|debug
(paren
l_string|&quot;b4 for loop, device is %x&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
multiline_comment|/* For every function on the card */
r_for
c_loop
(paren
id|function
op_assign
l_int|0x0
suffix:semicolon
id|function
OL
l_int|0x08
suffix:semicolon
id|function
op_increment
)paren
(brace
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|device
comma
id|function
)paren
suffix:semicolon
id|ibmphp_pci_bus-&gt;number
op_assign
id|busno
suffix:semicolon
id|pci_bus_read_config_word
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendor_id
op_ne
id|PCI_VENDOR_ID_NOTVALID
)paren
(brace
multiline_comment|/* found correct device!!! */
op_increment
id|valid_device
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - found correct device&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* header: x x x x x x x x&n;&t;&t;&t; *         | |___________|=&gt; 1=PPB bridge, 0=normal device, 2=CardBus Bridge&n;&t;&t;&t; *         |_=&gt; 0 = single function device, 1 = multi-function device&n;&t;&t;&t; */
id|pci_bus_read_config_byte
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|hdr_type
)paren
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|ibmphp_pci_bus
comma
id|devfn
comma
id|PCI_CLASS_REVISION
comma
op_amp
r_class
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;hdr_type %x, class %x&bslash;n&quot;
comma
id|hdr_type
comma
r_class
)paren
suffix:semicolon
r_class
op_rshift_assign
l_int|8
suffix:semicolon
multiline_comment|/* to take revision out, class = class.subclass.prog i/f */
r_if
c_cond
(paren
r_class
op_eq
id|PCI_CLASS_NOT_DEFINED_VGA
)paren
(brace
id|err
(paren
l_string|&quot;The device %x function %x is VGA compatible and is not supported for hot removing. &quot;
l_string|&quot;Please choose another device.&bslash;n&quot;
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
r_class
op_eq
id|PCI_CLASS_DISPLAY_VGA
)paren
(brace
id|err
(paren
l_string|&quot;The device %x function %x is not supported for hot removing. &quot;
l_string|&quot;Please choose another device.&bslash;n&quot;
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|hdr_type
)paren
(brace
r_case
id|PCI_HEADER_TYPE_NORMAL
suffix:colon
id|rc
op_assign
id|unconfigure_boot_device
(paren
id|busno
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;was not able to unconfigure device %x func %x on bus %x. bailing out...&bslash;n&quot;
comma
id|device
comma
id|function
comma
id|busno
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|function
op_assign
l_int|0x8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_HEADER_TYPE_MULTIDEVICE
suffix:colon
id|rc
op_assign
id|unconfigure_boot_device
(paren
id|busno
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;was not able to unconfigure device %x func %x on bus %x. bailing out...&bslash;n&quot;
comma
id|device
comma
id|function
comma
id|busno
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PCI_HEADER_TYPE_BRIDGE
suffix:colon
r_class
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
r_class
op_ne
id|PCI_CLASS_BRIDGE_PCI
)paren
(brace
id|err
(paren
l_string|&quot;This device %x function %x is not PCI-to-PCI bridge, &quot;
l_string|&quot;and is not supported for hot-removing. &quot;
l_string|&quot;Please try another card.&bslash;n&quot;
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|unconfigure_boot_bridge
(paren
id|busno
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;was not able to hot-remove PPB properly.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|function
op_assign
l_int|0x8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_HEADER_TYPE_MULTIBRIDGE
suffix:colon
r_class
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
r_class
op_ne
id|PCI_CLASS_BRIDGE_PCI
)paren
(brace
id|err
(paren
l_string|&quot;This device %x function %x is not PCI-to-PCI bridge, &quot;
l_string|&quot;and is not supported for hot-removing. &quot;
l_string|&quot;Please try another card.&bslash;n&quot;
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|unconfigure_boot_bridge
(paren
id|busno
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;was not able to hot-remove PPB properly.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|err
(paren
l_string|&quot;MAJOR PROBLEM!!!! Cannot read device&squot;s header&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end of switch */
)brace
multiline_comment|/* end of valid device */
)brace
multiline_comment|/* end of for */
r_if
c_cond
(paren
op_logical_neg
id|valid_device
)paren
(brace
id|err
(paren
l_string|&quot;Could not find device to unconfigure.  Or could not read the card.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * free the resources of the card (multi, single, or bridged)&n; * Parameters: slot, flag to say if this is for removing entire module or just&n; * unconfiguring the device&n; * TO DO:  will probably need to add some code in case there was some resource,&n; * to remove it... this is from when we have errors in the configure_card...&n; * &t;&t;&t;!!!!!!!!!!!!!!!!!!!!!!!!!FOR BUSES!!!!!!!!!!!!&n; * Returns: 0, -1, -ENODEV &n; */
DECL|function|ibmphp_unconfigure_card
r_int
id|ibmphp_unconfigure_card
(paren
r_struct
id|slot
op_star
op_star
id|slot_cur
comma
r_int
id|the_end
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_struct
id|slot
op_star
id|sl
op_assign
op_star
id|slot_cur
suffix:semicolon
r_struct
id|pci_func
op_star
id|cur_func
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|pci_func
op_star
id|temp_func
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|the_end
)paren
(brace
multiline_comment|/* Need to unconfigure the card */
id|rc
op_assign
id|unconfigure_boot_card
(paren
id|sl
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
op_logical_or
(paren
id|rc
op_eq
op_minus
id|EIO
)paren
op_logical_or
(paren
id|rc
op_eq
op_minus
id|EINVAL
)paren
)paren
(brace
multiline_comment|/* In all other cases, will still need to get rid of func structure if it exists */
r_return
id|rc
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sl-&gt;func
)paren
(brace
id|cur_func
op_assign
id|sl-&gt;func
suffix:semicolon
r_while
c_loop
(paren
id|cur_func
)paren
(brace
multiline_comment|/* TO DO: WILL MOST LIKELY NEED TO GET RID OF THE BUS STRUCTURE FROM RESOURCES AS WELL */
r_if
c_cond
(paren
id|cur_func-&gt;bus
)paren
(brace
multiline_comment|/* in other words, it&squot;s a PPB */
id|count
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|count
op_assign
l_int|6
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cur_func-&gt;io
(braket
id|i
)braket
)paren
(brace
id|debug
(paren
l_string|&quot;io[%d] exists&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|the_end
OG
l_int|0
)paren
id|ibmphp_remove_resource
(paren
id|cur_func-&gt;io
(braket
id|i
)braket
)paren
suffix:semicolon
id|cur_func-&gt;io
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cur_func-&gt;mem
(braket
id|i
)braket
)paren
(brace
id|debug
(paren
l_string|&quot;mem[%d] exists&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|the_end
OG
l_int|0
)paren
id|ibmphp_remove_resource
(paren
id|cur_func-&gt;mem
(braket
id|i
)braket
)paren
suffix:semicolon
id|cur_func-&gt;mem
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cur_func-&gt;pfmem
(braket
id|i
)braket
)paren
(brace
id|debug
(paren
l_string|&quot;pfmem[%d] exists&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|the_end
OG
l_int|0
)paren
id|ibmphp_remove_resource
(paren
id|cur_func-&gt;pfmem
(braket
id|i
)braket
)paren
suffix:semicolon
id|cur_func-&gt;pfmem
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|temp_func
op_assign
id|cur_func-&gt;next
suffix:semicolon
id|kfree
(paren
id|cur_func
)paren
suffix:semicolon
id|cur_func
op_assign
id|temp_func
suffix:semicolon
)brace
)brace
id|sl-&gt;func
op_assign
l_int|NULL
suffix:semicolon
op_star
id|slot_cur
op_assign
id|sl
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * add a new bus resulting from hot-plugging a PPB bridge with devices&n; *&n; * Input: bus and the amount of resources needed (we know we can assign those,&n; *        since they&squot;ve been checked already&n; * Output: bus added to the correct spot&n; *         0, -1, error &n; */
DECL|function|add_new_bus
r_static
r_int
id|add_new_bus
(paren
r_struct
id|bus_node
op_star
id|bus
comma
r_struct
id|resource_node
op_star
id|io
comma
r_struct
id|resource_node
op_star
id|mem
comma
r_struct
id|resource_node
op_star
id|pfmem
comma
id|u8
id|parent_busno
)paren
(brace
r_struct
id|range_node
op_star
id|io_range
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|range_node
op_star
id|mem_range
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|range_node
op_star
id|pfmem_range
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|bus_node
op_star
id|cur_bus
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Trying to find the parent bus number */
r_if
c_cond
(paren
id|parent_busno
op_ne
l_int|0xFF
)paren
(brace
id|cur_bus
op_assign
id|ibmphp_find_res_bus
(paren
id|parent_busno
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cur_bus
)paren
(brace
id|err
(paren
l_string|&quot;strange, cannot find bus which is supposed to be at the system... something is terribly wrong...&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|list_add
(paren
op_amp
id|bus-&gt;bus_list
comma
op_amp
id|cur_bus-&gt;bus_list
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|io
)paren
(brace
id|io_range
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|io_range
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io_range
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|io_range
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|range_node
)paren
)paren
suffix:semicolon
id|io_range-&gt;start
op_assign
id|io-&gt;start
suffix:semicolon
id|io_range-&gt;end
op_assign
id|io-&gt;end
suffix:semicolon
id|io_range-&gt;rangeno
op_assign
l_int|1
suffix:semicolon
id|bus-&gt;noIORanges
op_assign
l_int|1
suffix:semicolon
id|bus-&gt;rangeIO
op_assign
id|io_range
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mem
)paren
(brace
id|mem_range
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mem_range
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_range
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|mem_range
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|range_node
)paren
)paren
suffix:semicolon
id|mem_range-&gt;start
op_assign
id|mem-&gt;start
suffix:semicolon
id|mem_range-&gt;end
op_assign
id|mem-&gt;end
suffix:semicolon
id|mem_range-&gt;rangeno
op_assign
l_int|1
suffix:semicolon
id|bus-&gt;noMemRanges
op_assign
l_int|1
suffix:semicolon
id|bus-&gt;rangeMem
op_assign
id|mem_range
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pfmem
)paren
(brace
id|pfmem_range
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|pfmem_range
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pfmem_range
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|pfmem_range
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|range_node
)paren
)paren
suffix:semicolon
id|pfmem_range-&gt;start
op_assign
id|pfmem-&gt;start
suffix:semicolon
id|pfmem_range-&gt;end
op_assign
id|pfmem-&gt;end
suffix:semicolon
id|pfmem_range-&gt;rangeno
op_assign
l_int|1
suffix:semicolon
id|bus-&gt;noPFMemRanges
op_assign
l_int|1
suffix:semicolon
id|bus-&gt;rangePFMem
op_assign
id|pfmem_range
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * find the 1st available bus number for PPB to set as its secondary bus&n; * Parameters: bus_number of the primary bus&n; * Returns: bus_number of the secondary bus or 0xff in case of failure&n; */
DECL|function|find_sec_number
r_static
id|u8
id|find_sec_number
(paren
id|u8
id|primary_busno
comma
id|u8
id|slotno
)paren
(brace
r_int
id|min
comma
id|max
suffix:semicolon
id|u8
id|busno
suffix:semicolon
r_struct
id|bus_info
op_star
id|bus
suffix:semicolon
r_struct
id|bus_node
op_star
id|bus_cur
suffix:semicolon
id|bus
op_assign
id|ibmphp_find_same_bus_num
(paren
id|primary_busno
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|err
(paren
l_string|&quot;cannot get slot range of the bus from the BIOS&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0xff
suffix:semicolon
)brace
id|max
op_assign
id|bus-&gt;slot_max
suffix:semicolon
id|min
op_assign
id|bus-&gt;slot_min
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slotno
OG
id|max
)paren
op_logical_or
(paren
id|slotno
OL
id|min
)paren
)paren
(brace
id|err
(paren
l_string|&quot;got the wrong range&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0xff
suffix:semicolon
)brace
id|busno
op_assign
(paren
id|u8
)paren
(paren
id|slotno
op_minus
(paren
id|u8
)paren
id|min
)paren
suffix:semicolon
id|busno
op_add_assign
id|primary_busno
op_plus
l_int|0x01
suffix:semicolon
id|bus_cur
op_assign
id|ibmphp_find_res_bus
(paren
id|busno
)paren
suffix:semicolon
multiline_comment|/* either there is no such bus number, or there are no ranges, which&n;&t; * can only happen if we removed the bridged device in previous load&n;&t; * of the driver, and now only have the skeleton bus struct&n;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|bus_cur
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|bus_cur-&gt;rangeIO
)paren
op_logical_and
op_logical_neg
(paren
id|bus_cur-&gt;rangeMem
)paren
op_logical_and
op_logical_neg
(paren
id|bus_cur-&gt;rangePFMem
)paren
)paren
)paren
r_return
id|busno
suffix:semicolon
r_return
l_int|0xff
suffix:semicolon
)brace
eof
