multiline_comment|/*&n; * Standard PCI Hot Plug Driver&n; *&n; * Copyright (C) 1995,2001 Compaq Computer Corporation&n; * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (C) 2001 IBM Corp.&n; * Copyright (C) 2003-2004 Intel Corporation&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;greg@kroah.com&gt;,&lt;dely.l.sy@intel.com&gt;&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;shpchp.h&quot;
macro_line|#ifdef DEBUG
DECL|macro|DBG_K_TRACE_ENTRY
mdefine_line|#define DBG_K_TRACE_ENTRY      ((unsigned int)0x00000001)&t;/* On function entry */
DECL|macro|DBG_K_TRACE_EXIT
mdefine_line|#define DBG_K_TRACE_EXIT       ((unsigned int)0x00000002)&t;/* On function exit */
DECL|macro|DBG_K_INFO
mdefine_line|#define DBG_K_INFO             ((unsigned int)0x00000004)&t;/* Info messages */
DECL|macro|DBG_K_ERROR
mdefine_line|#define DBG_K_ERROR            ((unsigned int)0x00000008)&t;/* Error messages */
DECL|macro|DBG_K_TRACE
mdefine_line|#define DBG_K_TRACE            (DBG_K_TRACE_ENTRY|DBG_K_TRACE_EXIT)
DECL|macro|DBG_K_STANDARD
mdefine_line|#define DBG_K_STANDARD         (DBG_K_INFO|DBG_K_ERROR|DBG_K_TRACE)
multiline_comment|/* Redefine this flagword to set debug level */
DECL|macro|DEBUG_LEVEL
mdefine_line|#define DEBUG_LEVEL            DBG_K_STANDARD
DECL|macro|DEFINE_DBG_BUFFER
mdefine_line|#define DEFINE_DBG_BUFFER     char __dbg_str_buf[256];
DECL|macro|DBG_PRINT
mdefine_line|#define DBG_PRINT( dbg_flags, args... )              &bslash;&n;&t;do {                                             &bslash;&n;&t;  if ( DEBUG_LEVEL &amp; ( dbg_flags ) )             &bslash;&n;&t;  {                                              &bslash;&n;&t;    int len;                                     &bslash;&n;&t;    len = sprintf( __dbg_str_buf, &quot;%s:%d: %s: &quot;, &bslash;&n;&t;&t;  __FILE__, __LINE__, __FUNCTION__ );    &bslash;&n;&t;    sprintf( __dbg_str_buf + len, args );        &bslash;&n;&t;    printk( KERN_NOTICE &quot;%s&bslash;n&quot;, __dbg_str_buf ); &bslash;&n;&t;  }                                              &bslash;&n;&t;} while (0)
DECL|macro|DBG_ENTER_ROUTINE
mdefine_line|#define DBG_ENTER_ROUTINE&t;DBG_PRINT (DBG_K_TRACE_ENTRY, &quot;%s&quot;, &quot;[Entry]&quot;);
DECL|macro|DBG_LEAVE_ROUTINE
mdefine_line|#define DBG_LEAVE_ROUTINE&t;DBG_PRINT (DBG_K_TRACE_EXIT, &quot;%s&quot;, &quot;[Exit]&quot;);
macro_line|#else
DECL|macro|DEFINE_DBG_BUFFER
mdefine_line|#define DEFINE_DBG_BUFFER
DECL|macro|DBG_ENTER_ROUTINE
mdefine_line|#define DBG_ENTER_ROUTINE
DECL|macro|DBG_LEAVE_ROUTINE
mdefine_line|#define DBG_LEAVE_ROUTINE
macro_line|#endif&t;&t;&t;&t;/* DEBUG */
multiline_comment|/* Slot Available Register I field definition */
DECL|macro|SLOT_33MHZ
mdefine_line|#define SLOT_33MHZ&t;&t;0x0000001f
DECL|macro|SLOT_66MHZ_PCIX
mdefine_line|#define SLOT_66MHZ_PCIX&t;&t;0x00001f00
DECL|macro|SLOT_100MHZ_PCIX
mdefine_line|#define SLOT_100MHZ_PCIX&t;0x001f0000
DECL|macro|SLOT_133MHZ_PCIX
mdefine_line|#define SLOT_133MHZ_PCIX&t;0x1f000000
multiline_comment|/* Slot Available Register II field definition */
DECL|macro|SLOT_66MHZ
mdefine_line|#define SLOT_66MHZ&t;&t;0x0000001f
DECL|macro|SLOT_66MHZ_PCIX_266
mdefine_line|#define SLOT_66MHZ_PCIX_266&t;0x00000f00
DECL|macro|SLOT_100MHZ_PCIX_266
mdefine_line|#define SLOT_100MHZ_PCIX_266&t;0x0000f000
DECL|macro|SLOT_133MHZ_PCIX_266
mdefine_line|#define SLOT_133MHZ_PCIX_266&t;0x000f0000
DECL|macro|SLOT_66MHZ_PCIX_533
mdefine_line|#define SLOT_66MHZ_PCIX_533&t;0x00f00000
DECL|macro|SLOT_100MHZ_PCIX_533
mdefine_line|#define SLOT_100MHZ_PCIX_533&t;0x0f000000
DECL|macro|SLOT_133MHZ_PCIX_533
mdefine_line|#define SLOT_133MHZ_PCIX_533&t;0xf0000000
multiline_comment|/* Secondary Bus Configuration Register */
multiline_comment|/* For PI = 1, Bits 0 to 2 have been encoded as follows to show current bus speed/mode */
DECL|macro|PCI_33MHZ
mdefine_line|#define PCI_33MHZ&t;&t;0x0
DECL|macro|PCI_66MHZ
mdefine_line|#define PCI_66MHZ&t;&t;0x1
DECL|macro|PCIX_66MHZ
mdefine_line|#define PCIX_66MHZ&t;&t;0x2
DECL|macro|PCIX_100MHZ
mdefine_line|#define PCIX_100MHZ&t;&t;0x3
DECL|macro|PCIX_133MHZ
mdefine_line|#define PCIX_133MHZ&t;&t;0x4
multiline_comment|/* For PI = 2, Bits 0 to 3 have been encoded as follows to show current bus speed/mode */
DECL|macro|PCI_33MHZ
mdefine_line|#define PCI_33MHZ&t;&t;0x0
DECL|macro|PCI_66MHZ
mdefine_line|#define PCI_66MHZ&t;&t;0x1
DECL|macro|PCIX_66MHZ
mdefine_line|#define PCIX_66MHZ&t;&t;0x2
DECL|macro|PCIX_100MHZ
mdefine_line|#define PCIX_100MHZ&t;&t;0x3
DECL|macro|PCIX_133MHZ
mdefine_line|#define PCIX_133MHZ&t;&t;0x4
DECL|macro|PCIX_66MHZ_ECC
mdefine_line|#define PCIX_66MHZ_ECC&t;&t;0x5
DECL|macro|PCIX_100MHZ_ECC
mdefine_line|#define PCIX_100MHZ_ECC&t;&t;0x6
DECL|macro|PCIX_133MHZ_ECC
mdefine_line|#define PCIX_133MHZ_ECC&t;&t;0x7
DECL|macro|PCIX_66MHZ_266
mdefine_line|#define PCIX_66MHZ_266&t;&t;0x9
DECL|macro|PCIX_100MHZ_266
mdefine_line|#define PCIX_100MHZ_266&t;&t;0xa
DECL|macro|PCIX_133MHZ_266
mdefine_line|#define PCIX_133MHZ_266&t;&t;0xb
DECL|macro|PCIX_66MHZ_533
mdefine_line|#define PCIX_66MHZ_533&t;&t;0x11
DECL|macro|PCIX_100MHZ_533
mdefine_line|#define PCIX_100MHZ_533&t;&t;0x12
DECL|macro|PCIX_133MHZ_533
mdefine_line|#define PCIX_133MHZ_533&t;&t;0x13
multiline_comment|/* Slot Configuration */
DECL|macro|SLOT_NUM
mdefine_line|#define SLOT_NUM&t;&t;0x0000001F
DECL|macro|FIRST_DEV_NUM
mdefine_line|#define&t;FIRST_DEV_NUM&t;&t;0x00001F00
DECL|macro|PSN
mdefine_line|#define PSN&t;&t;&t;0x07FF0000
DECL|macro|UPDOWN
mdefine_line|#define&t;UPDOWN&t;&t;&t;0x20000000
DECL|macro|MRLSENSOR
mdefine_line|#define&t;MRLSENSOR&t;&t;0x40000000
DECL|macro|ATTN_BUTTON
mdefine_line|#define ATTN_BUTTON&t;&t;0x80000000
multiline_comment|/* Slot Status Field Definitions */
multiline_comment|/* Slot State */
DECL|macro|PWR_ONLY
mdefine_line|#define PWR_ONLY&t;&t;0x0001
DECL|macro|ENABLED
mdefine_line|#define ENABLED&t;&t;&t;0x0002
DECL|macro|DISABLED
mdefine_line|#define DISABLED&t;&t;0x0003
multiline_comment|/* Power Indicator State */
DECL|macro|PWR_LED_ON
mdefine_line|#define PWR_LED_ON&t;&t;0x0004
DECL|macro|PWR_LED_BLINK
mdefine_line|#define PWR_LED_BLINK&t;&t;0x0008
DECL|macro|PWR_LED_OFF
mdefine_line|#define PWR_LED_OFF&t;&t;0x000c
multiline_comment|/* Attention Indicator State */
DECL|macro|ATTEN_LED_ON
mdefine_line|#define ATTEN_LED_ON&t;&t;0x0010
DECL|macro|ATTEN_LED_BLINK
mdefine_line|#define&t;ATTEN_LED_BLINK&t;&t;0x0020
DECL|macro|ATTEN_LED_OFF
mdefine_line|#define ATTEN_LED_OFF&t;&t;0x0030
multiline_comment|/* Power Fault */
DECL|macro|pwr_fault
mdefine_line|#define pwr_fault&t;&t;0x0040
multiline_comment|/* Attention Button */
DECL|macro|ATTEN_BUTTON
mdefine_line|#define ATTEN_BUTTON&t;&t;0x0080
multiline_comment|/* MRL Sensor */
DECL|macro|MRL_SENSOR
mdefine_line|#define MRL_SENSOR&t;&t;0x0100
multiline_comment|/* 66 MHz Capable */
DECL|macro|IS_66MHZ_CAP
mdefine_line|#define IS_66MHZ_CAP&t;&t;0x0200
multiline_comment|/* PRSNT1#/PRSNT2# */
DECL|macro|SLOT_EMP
mdefine_line|#define SLOT_EMP&t;&t;0x0c00
multiline_comment|/* PCI-X Capability */
DECL|macro|NON_PCIX
mdefine_line|#define NON_PCIX&t;&t;0x0000
DECL|macro|PCIX_66
mdefine_line|#define PCIX_66&t;&t;&t;0x1000
DECL|macro|PCIX_133
mdefine_line|#define PCIX_133&t;&t;0x3000
DECL|macro|PCIX_266
mdefine_line|#define PCIX_266&t;&t;0x4000  /* For PI = 2 only */
DECL|macro|PCIX_533
mdefine_line|#define PCIX_533&t;&t;0x5000&t;/* For PI = 2 only */
multiline_comment|/* SHPC &squot;write&squot; operations/commands */
multiline_comment|/* Slot operation - 0x00h to 0x3Fh */
DECL|macro|NO_CHANGE
mdefine_line|#define NO_CHANGE&t;&t;0x00
multiline_comment|/* Slot state - Bits 0 &amp; 1 of controller command register */
DECL|macro|SET_SLOT_PWR
mdefine_line|#define SET_SLOT_PWR&t;&t;0x01&t;
DECL|macro|SET_SLOT_ENABLE
mdefine_line|#define SET_SLOT_ENABLE&t;&t;0x02&t;
DECL|macro|SET_SLOT_DISABLE
mdefine_line|#define SET_SLOT_DISABLE&t;0x03&t;
multiline_comment|/* Power indicator state - Bits 2 &amp; 3 of controller command register*/
DECL|macro|SET_PWR_ON
mdefine_line|#define SET_PWR_ON&t;&t;0x04&t;
DECL|macro|SET_PWR_BLINK
mdefine_line|#define SET_PWR_BLINK&t;&t;0x08&t;
DECL|macro|SET_PWR_OFF
mdefine_line|#define SET_PWR_OFF&t;&t;0x0C&t;
multiline_comment|/* Attention indicator state - Bits 4 &amp; 5 of controller command register*/
DECL|macro|SET_ATTN_ON
mdefine_line|#define SET_ATTN_ON&t;&t;0x010&t;
DECL|macro|SET_ATTN_BLINK
mdefine_line|#define SET_ATTN_BLINK&t;&t;0x020
DECL|macro|SET_ATTN_OFF
mdefine_line|#define SET_ATTN_OFF&t;&t;0x030&t;
multiline_comment|/* Set bus speed/mode A - 0x40h to 0x47h */
DECL|macro|SETA_PCI_33MHZ
mdefine_line|#define SETA_PCI_33MHZ&t;&t;0x40
DECL|macro|SETA_PCI_66MHZ
mdefine_line|#define SETA_PCI_66MHZ&t;&t;0x41
DECL|macro|SETA_PCIX_66MHZ
mdefine_line|#define SETA_PCIX_66MHZ&t;&t;0x42
DECL|macro|SETA_PCIX_100MHZ
mdefine_line|#define SETA_PCIX_100MHZ&t;0x43
DECL|macro|SETA_PCIX_133MHZ
mdefine_line|#define SETA_PCIX_133MHZ&t;0x44
DECL|macro|RESERV_1
mdefine_line|#define RESERV_1&t;&t;0x45
DECL|macro|RESERV_2
mdefine_line|#define RESERV_2&t;&t;0x46
DECL|macro|RESERV_3
mdefine_line|#define RESERV_3&t;&t;0x47
multiline_comment|/* Set bus speed/mode B - 0x50h to 0x5fh */
DECL|macro|SETB_PCI_33MHZ
mdefine_line|#define&t;SETB_PCI_33MHZ&t;&t;0x50
DECL|macro|SETB_PCI_66MHZ
mdefine_line|#define SETB_PCI_66MHZ&t;&t;0x51
DECL|macro|SETB_PCIX_66MHZ_PM
mdefine_line|#define SETB_PCIX_66MHZ_PM&t;0x52
DECL|macro|SETB_PCIX_100MHZ_PM
mdefine_line|#define SETB_PCIX_100MHZ_PM&t;0x53
DECL|macro|SETB_PCIX_133MHZ_PM
mdefine_line|#define SETB_PCIX_133MHZ_PM&t;0x54
DECL|macro|SETB_PCIX_66MHZ_EM
mdefine_line|#define SETB_PCIX_66MHZ_EM&t;0x55
DECL|macro|SETB_PCIX_100MHZ_EM
mdefine_line|#define SETB_PCIX_100MHZ_EM&t;0x56
DECL|macro|SETB_PCIX_133MHZ_EM
mdefine_line|#define SETB_PCIX_133MHZ_EM&t;0x57
DECL|macro|SETB_PCIX_66MHZ_266
mdefine_line|#define SETB_PCIX_66MHZ_266&t;0x58
DECL|macro|SETB_PCIX_100MHZ_266
mdefine_line|#define SETB_PCIX_100MHZ_266&t;0x59
DECL|macro|SETB_PCIX_133MHZ_266
mdefine_line|#define SETB_PCIX_133MHZ_266&t;0x5a
DECL|macro|SETB_PCIX_66MHZ_533
mdefine_line|#define SETB_PCIX_66MHZ_533&t;0x5b
DECL|macro|SETB_PCIX_100MHZ_533
mdefine_line|#define SETB_PCIX_100MHZ_533&t;0x5c
DECL|macro|SETB_PCIX_133MHZ_533
mdefine_line|#define SETB_PCIX_133MHZ_533&t;0x5d
multiline_comment|/* Power-on all slots - 0x48h */
DECL|macro|SET_PWR_ON_ALL
mdefine_line|#define SET_PWR_ON_ALL&t;&t;0x48
multiline_comment|/* Enable all slots&t;- 0x49h */
DECL|macro|SET_ENABLE_ALL
mdefine_line|#define SET_ENABLE_ALL&t;&t;0x49
multiline_comment|/*  SHPC controller command error code */
DECL|macro|SWITCH_OPEN
mdefine_line|#define SWITCH_OPEN&t;&t;0x1
DECL|macro|INVALID_CMD
mdefine_line|#define INVALID_CMD&t;&t;0x2
DECL|macro|INVALID_SPEED_MODE
mdefine_line|#define INVALID_SPEED_MODE&t;0x4
multiline_comment|/* For accessing SHPC Working Register Set */
DECL|macro|DWORD_SELECT
mdefine_line|#define DWORD_SELECT&t;&t;0x2
DECL|macro|DWORD_DATA
mdefine_line|#define DWORD_DATA&t;&t;0x4
DECL|macro|BASE_OFFSET
mdefine_line|#define BASE_OFFSET&t;&t;0x0
multiline_comment|/* Field Offset in Logical Slot Register - byte boundary */
DECL|macro|SLOT_EVENT_LATCH
mdefine_line|#define SLOT_EVENT_LATCH&t;0x2
DECL|macro|SLOT_SERR_INT_MASK
mdefine_line|#define SLOT_SERR_INT_MASK&t;0x3
DECL|variable|hpc_event_lock
r_static
id|spinlock_t
id|hpc_event_lock
suffix:semicolon
id|DEFINE_DBG_BUFFER
multiline_comment|/* Debug string buffer for entire HPC defined here */
DECL|variable|php_ctlr_list_head
r_static
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr_list_head
suffix:semicolon
multiline_comment|/* HPC state linked list */
DECL|variable|ctlr_seq_num
r_static
r_int
id|ctlr_seq_num
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Controller sequenc # */
DECL|variable|list_lock
r_static
id|spinlock_t
id|list_lock
suffix:semicolon
r_static
id|irqreturn_t
id|shpc_isr
c_func
(paren
r_int
id|IRQ
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|start_int_poll_timer
c_func
(paren
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
comma
r_int
id|seconds
)paren
suffix:semicolon
multiline_comment|/* This is the interrupt polling timeout function. */
DECL|function|int_poll_timeout
r_static
r_void
id|int_poll_timeout
c_func
(paren
r_int
r_int
id|lphp_ctlr
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|lphp_ctlr
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Poll for interrupt events.  regs == NULL =&gt; polling */
id|shpc_isr
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
id|php_ctlr
comma
l_int|NULL
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|php_ctlr-&gt;int_poll_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpchp_poll_time
)paren
id|shpchp_poll_time
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* reset timer to poll in 2 secs if user doesn&squot;t specify at module installation*/
id|start_int_poll_timer
c_func
(paren
id|php_ctlr
comma
id|shpchp_poll_time
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* This function starts the interrupt polling timer. */
DECL|function|start_int_poll_timer
r_static
r_void
id|start_int_poll_timer
c_func
(paren
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
comma
r_int
id|seconds
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|seconds
op_le
l_int|0
)paren
op_logical_or
(paren
id|seconds
OG
l_int|60
)paren
)paren
id|seconds
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Clamp to sane value */
id|php_ctlr-&gt;int_poll_timer.function
op_assign
op_amp
id|int_poll_timeout
suffix:semicolon
id|php_ctlr-&gt;int_poll_timer.data
op_assign
(paren
r_int
r_int
)paren
id|php_ctlr
suffix:semicolon
multiline_comment|/* Instance data */
id|php_ctlr-&gt;int_poll_timer.expires
op_assign
id|jiffies
op_plus
id|seconds
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|php_ctlr-&gt;int_poll_timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|shpc_write_cmd
r_static
r_int
id|shpc_write_cmd
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
id|t_slot
comma
id|u8
id|cmd
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|cmd_status
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|u16
id|temp_word
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cmd_status
op_assign
id|readw
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|CMD_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmd_status
op_amp
l_int|0x1
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/*  Check every 0.1 sec for a total of 1 sec*/
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
id|cmd_status
op_assign
id|readw
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|CMD_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_status
op_amp
l_int|0x1
)paren
(brace
multiline_comment|/* After 1 sec and and the controller is still busy */
id|err
c_func
(paren
l_string|&quot;%s : Controller is still busy after 1 sec.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_increment
id|t_slot
suffix:semicolon
id|temp_word
op_assign
(paren
id|t_slot
op_lshift
l_int|8
)paren
op_or
(paren
id|cmd
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: t_slot %x cmd %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|t_slot
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* To make sure the Controller Busy bit is 0 before we send out the&n;&t; * command. &n;&t; */
id|writew
c_func
(paren
id|temp_word
comma
id|php_ctlr-&gt;creg
op_plus
id|CMD
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: temp_word written %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_word
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_check_cmd_status
r_static
r_int
id|hpc_check_cmd_status
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|cmd_status
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|cmd_status
op_assign
id|readw
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|CMD_STATUS
)paren
op_amp
l_int|0x000F
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_status
op_rshift
l_int|1
)paren
(brace
r_case
l_int|0
suffix:colon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|retval
op_assign
id|SWITCH_OPEN
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s: Switch opened!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|retval
op_assign
id|INVALID_CMD
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC command!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|retval
op_assign
id|INVALID_SPEED_MODE
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s: Invalid bus speed/mode!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
id|cmd_status
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_attention_status
r_static
r_int
id|hpc_get_attention_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|status
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u32
id|slot_reg
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
id|u8
id|atten_led_state
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|slot_reg
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
l_int|4
op_star
(paren
id|slot-&gt;hp_slot
)paren
)paren
suffix:semicolon
id|slot_status
op_assign
(paren
id|u16
)paren
id|slot_reg
suffix:semicolon
id|atten_led_state
op_assign
(paren
id|slot_status
op_amp
l_int|0x0030
)paren
op_rshift
l_int|4
suffix:semicolon
r_switch
c_cond
(paren
id|atten_led_state
)paren
(brace
r_case
l_int|0
suffix:colon
op_star
id|status
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* Reserved */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
op_star
id|status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* On */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|status
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Blink */
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
op_star
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Off */
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|status
op_assign
l_int|0xFF
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_get_power_status
r_static
r_int
id|hpc_get_power_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|status
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u32
id|slot_reg
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
id|u8
id|slot_state
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|slot_reg
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
l_int|4
op_star
(paren
id|slot-&gt;hp_slot
)paren
)paren
suffix:semicolon
id|slot_status
op_assign
(paren
id|u16
)paren
id|slot_reg
suffix:semicolon
id|slot_state
op_assign
(paren
id|slot_status
op_amp
l_int|0x0003
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|slot_state
)paren
(brace
r_case
l_int|0
suffix:colon
op_star
id|status
op_assign
l_int|0xFF
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
op_star
id|status
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Powered only */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Enabled */
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
op_star
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Disabled */
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|status
op_assign
l_int|0xFF
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_latch_status
r_static
r_int
id|hpc_get_latch_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|status
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u32
id|slot_reg
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|slot_reg
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
l_int|4
op_star
(paren
id|slot-&gt;hp_slot
)paren
)paren
suffix:semicolon
id|slot_status
op_assign
(paren
id|u16
)paren
id|slot_reg
suffix:semicolon
op_star
id|status
op_assign
(paren
(paren
id|slot_status
op_amp
l_int|0x0100
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* 0 -&gt; close; 1 -&gt; open */
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_get_adapter_status
r_static
r_int
id|hpc_get_adapter_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|status
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u32
id|slot_reg
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
id|u8
id|card_state
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|slot_reg
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
l_int|4
op_star
(paren
id|slot-&gt;hp_slot
)paren
)paren
suffix:semicolon
id|slot_status
op_assign
(paren
id|u16
)paren
id|slot_reg
suffix:semicolon
id|card_state
op_assign
(paren
id|u8
)paren
(paren
(paren
id|slot_status
op_amp
l_int|0x0C00
)paren
op_rshift
l_int|10
)paren
suffix:semicolon
op_star
id|status
op_assign
(paren
id|card_state
op_ne
l_int|0x3
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_get_prog_int
r_static
r_int
id|hpc_get_prog_int
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|prog_int
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|prog_int
op_assign
id|readb
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|PROG_INTERFACE
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_get_adapter_speed
r_static
r_int
id|hpc_get_adapter_speed
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u32
id|slot_reg
suffix:semicolon
id|u16
id|slot_status
comma
id|sec_bus_status
suffix:semicolon
id|u8
id|m66_cap
comma
id|pcix_cap
comma
id|pi
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pi
op_assign
id|readb
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|PROG_INTERFACE
)paren
suffix:semicolon
id|slot_reg
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
l_int|4
op_star
(paren
id|slot-&gt;hp_slot
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: pi = %d, slot_reg = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pi
comma
id|slot_reg
)paren
suffix:semicolon
id|slot_status
op_assign
(paren
id|u16
)paren
id|slot_reg
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: slot_status = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_status
)paren
suffix:semicolon
id|sec_bus_status
op_assign
id|readw
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SEC_BUS_CONFIG
)paren
suffix:semicolon
id|pcix_cap
op_assign
(paren
id|u8
)paren
(paren
(paren
id|slot_status
op_amp
l_int|0x3000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s:  pcix_cap = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pcix_cap
)paren
suffix:semicolon
id|m66_cap
op_assign
(paren
id|u8
)paren
(paren
(paren
id|slot_status
op_amp
l_int|0x0200
)paren
op_rshift
l_int|9
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s:  m66_cap = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|m66_cap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pi
op_eq
l_int|2
)paren
(brace
r_switch
c_cond
(paren
id|pcix_cap
)paren
(brace
r_case
l_int|0
suffix:colon
op_star
id|value
op_assign
id|m66_cap
ques
c_cond
id|PCI_SPEED_66MHz
suffix:colon
id|PCI_SPEED_33MHz
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
op_star
id|value
op_assign
id|PCI_SPEED_66MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
op_star
id|value
op_assign
id|PCI_SPEED_133MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|value
op_assign
id|PCI_SPEED_133MHz_PCIX_266
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
op_star
id|value
op_assign
id|PCI_SPEED_133MHz_PCIX_533
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Reserved */
r_default
suffix:colon
op_star
id|value
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|pcix_cap
)paren
(brace
r_case
l_int|0
suffix:colon
op_star
id|value
op_assign
id|m66_cap
ques
c_cond
id|PCI_SPEED_66MHz
suffix:colon
id|PCI_SPEED_33MHz
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
op_star
id|value
op_assign
id|PCI_SPEED_66MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
op_star
id|value
op_assign
id|PCI_SPEED_133MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Reserved */
r_default
suffix:colon
op_star
id|value
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;Adapter speed = %d&bslash;n&quot;
comma
op_star
id|value
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_mode1_ECC_cap
r_static
r_int
id|hpc_get_mode1_ECC_cap
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
op_star
id|mode
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u16
id|sec_bus_status
suffix:semicolon
id|u8
id|pi
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pi
op_assign
id|readb
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|PROG_INTERFACE
)paren
suffix:semicolon
id|sec_bus_status
op_assign
id|readw
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SEC_BUS_CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pi
op_eq
l_int|2
)paren
(brace
op_star
id|mode
op_assign
(paren
id|sec_bus_status
op_amp
l_int|0x0100
)paren
op_rshift
l_int|7
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Mode 1 ECC cap = %d&bslash;n&quot;
comma
op_star
id|mode
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_query_power_fault
r_static
r_int
id|hpc_query_power_fault
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u32
id|slot_reg
suffix:semicolon
id|u16
id|slot_status
suffix:semicolon
id|u8
id|pwr_fault_state
comma
id|status
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|slot_reg
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
l_int|4
op_star
(paren
id|slot-&gt;hp_slot
)paren
)paren
suffix:semicolon
id|slot_status
op_assign
(paren
id|u16
)paren
id|slot_reg
suffix:semicolon
id|pwr_fault_state
op_assign
(paren
id|slot_status
op_amp
l_int|0x0040
)paren
op_rshift
l_int|7
suffix:semicolon
id|status
op_assign
(paren
id|pwr_fault_state
op_eq
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|DBG_LEAVE_ROUTINE
multiline_comment|/* Note: Logic 0 =&gt; fault */
r_return
id|status
suffix:semicolon
)brace
DECL|function|hpc_set_attention_status
r_static
r_int
id|hpc_set_attention_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
id|u8
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u8
id|slot_cmd
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
l_int|0
suffix:colon
id|slot_cmd
op_assign
l_int|0x30
suffix:semicolon
multiline_comment|/* OFF */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|slot_cmd
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* ON */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|slot_cmd
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* BLINK */
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|shpc_write_cmd
c_func
(paren
id|slot
comma
id|slot-&gt;hp_slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|hpc_set_green_led_on
r_static
r_void
id|hpc_set_green_led_on
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u8
id|slot_cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|slot_cmd
op_assign
l_int|0x04
suffix:semicolon
id|shpc_write_cmd
c_func
(paren
id|slot
comma
id|slot-&gt;hp_slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|hpc_set_green_led_off
r_static
r_void
id|hpc_set_green_led_off
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u8
id|slot_cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|slot_cmd
op_assign
l_int|0x0C
suffix:semicolon
id|shpc_write_cmd
c_func
(paren
id|slot
comma
id|slot-&gt;hp_slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|hpc_set_green_led_blink
r_static
r_void
id|hpc_set_green_led_blink
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u8
id|slot_cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|slot_cmd
op_assign
l_int|0x08
suffix:semicolon
id|shpc_write_cmd
c_func
(paren
id|slot
comma
id|slot-&gt;hp_slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|shpc_get_ctlr_slot_config
r_int
id|shpc_get_ctlr_slot_config
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_int
op_star
id|num_ctlr_slots
comma
multiline_comment|/* number of slots in this HPC&t;&t;&t;*/
r_int
op_star
id|first_device_num
comma
multiline_comment|/* PCI dev num of the first slot in this SHPC&t;*/
r_int
op_star
id|physical_slot_num
comma
multiline_comment|/* phy slot num of the first slot in this SHPC&t;*/
r_int
op_star
id|updown
comma
multiline_comment|/* physical_slot_num increament: 1 or -1&t;*/
r_int
op_star
id|flags
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|first_device_num
op_assign
id|php_ctlr-&gt;slot_device_offset
suffix:semicolon
multiline_comment|/* Obtained in shpc_init() */
op_star
id|num_ctlr_slots
op_assign
id|php_ctlr-&gt;num_slots
suffix:semicolon
multiline_comment|/* Obtained in shpc_init() */
op_star
id|physical_slot_num
op_assign
(paren
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT_CONFIG
)paren
op_amp
id|PSN
)paren
op_rshift
l_int|16
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: physical_slot_num = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
op_star
id|physical_slot_num
)paren
suffix:semicolon
op_star
id|updown
op_assign
(paren
(paren
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT_CONFIG
)paren
op_amp
id|UPDOWN
)paren
op_rshift
l_int|29
)paren
ques
c_cond
l_int|1
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpc_release_ctlr
r_static
r_void
id|hpc_release_ctlr
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_struct
id|php_ctlr_state_s
op_star
id|p
comma
op_star
id|p_prev
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|shpchp_poll_mode
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|php_ctlr-&gt;int_poll_timer
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|php_ctlr-&gt;irq
)paren
(brace
id|free_irq
c_func
(paren
id|php_ctlr-&gt;irq
comma
id|ctrl
)paren
suffix:semicolon
id|php_ctlr-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|pci_disable_msi
c_func
(paren
id|php_ctlr-&gt;pci_dev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|php_ctlr-&gt;pci_dev
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: before calling iounmap &amp; release_mem_region&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|php_ctlr-&gt;creg
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|php_ctlr-&gt;pci_dev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: before calling iounmap &amp; release_mem_region&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|php_ctlr-&gt;pci_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|p
op_assign
id|php_ctlr_list_head
suffix:semicolon
id|p_prev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|php_ctlr
)paren
(brace
r_if
c_cond
(paren
id|p_prev
)paren
id|p_prev-&gt;pnext
op_assign
id|p-&gt;pnext
suffix:semicolon
r_else
id|php_ctlr_list_head
op_assign
id|p-&gt;pnext
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|p_prev
op_assign
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;pnext
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|php_ctlr
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
)brace
DECL|function|hpc_power_on_slot
r_static
r_int
id|hpc_power_on_slot
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u8
id|slot_cmd
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|slot_cmd
op_assign
l_int|0x01
suffix:semicolon
id|retval
op_assign
id|shpc_write_cmd
c_func
(paren
id|slot
comma
id|slot-&gt;hp_slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Write command failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_slot_enable
r_static
r_int
id|hpc_slot_enable
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u8
id|slot_cmd
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* 3A =&gt; Slot - Enable, Power Indicator - Blink, Attention Indicator - Off */
id|slot_cmd
op_assign
l_int|0x3A
suffix:semicolon
id|retval
op_assign
id|shpc_write_cmd
c_func
(paren
id|slot
comma
id|slot-&gt;hp_slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Write command failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_slot_disable
r_static
r_int
id|hpc_slot_disable
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|u8
id|slot_cmd
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* 1F =&gt; Slot - Disable, Power Indicator - Off, Attention Indicator - On */
id|slot_cmd
op_assign
l_int|0x1F
suffix:semicolon
id|retval
op_assign
id|shpc_write_cmd
c_func
(paren
id|slot
comma
id|slot-&gt;hp_slot
comma
id|slot_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Write command failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_enable_all_slots
r_static
r_int
id|hpc_enable_all_slots
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|shpc_write_cmd
c_func
(paren
id|slot
comma
l_int|0
comma
id|SET_ENABLE_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Write command failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_pwr_on_all_slots
r_static
r_int
id|hpc_pwr_on_all_slots
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DBG_ENTER_ROUTINE
id|retval
op_assign
id|shpc_write_cmd
c_func
(paren
id|slot
comma
l_int|0
comma
id|SET_PWR_ON_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Write command failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_set_bus_speed_mode
r_static
r_int
id|hpc_set_bus_speed_mode
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
r_enum
id|pci_bus_speed
id|value
)paren
(brace
id|u8
id|slot_cmd
suffix:semicolon
id|u8
id|pi
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pi
op_assign
id|readb
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|PROG_INTERFACE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pi
op_eq
l_int|1
)paren
(brace
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
l_int|0
suffix:colon
id|slot_cmd
op_assign
id|SETA_PCI_33MHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|slot_cmd
op_assign
id|SETA_PCI_66MHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|slot_cmd
op_assign
id|SETA_PCIX_66MHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|slot_cmd
op_assign
id|SETA_PCIX_100MHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|slot_cmd
op_assign
id|SETA_PCIX_133MHZ
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|slot_cmd
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
l_int|0
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCI_33MHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCI_66MHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_66MHZ_PM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_100MHZ_PM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_133MHZ_PM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_66MHZ_EM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_100MHZ_EM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_133MHZ_EM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_66MHZ_266
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x9
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_100MHZ_266
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xa
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_133MHZ_266
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_66MHZ_533
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xc
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_100MHZ_533
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xd
suffix:colon
id|slot_cmd
op_assign
id|SETB_PCIX_133MHZ_533
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|slot_cmd
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
)brace
id|retval
op_assign
id|shpc_write_cmd
c_func
(paren
id|slot
comma
l_int|0
comma
id|slot_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Write command failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|shpc_isr
r_static
id|irqreturn_t
id|shpc_isr
c_func
(paren
r_int
id|IRQ
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|controller
op_star
id|ctrl
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
suffix:semicolon
id|u8
id|schedule_flag
op_assign
l_int|0
suffix:semicolon
id|u8
id|temp_byte
suffix:semicolon
id|u32
id|temp_dword
comma
id|intr_loc
comma
id|intr_loc2
suffix:semicolon
r_int
id|hp_slot
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_id
)paren
r_return
id|IRQ_NONE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpchp_poll_mode
)paren
(brace
id|ctrl
op_assign
(paren
r_struct
id|controller
op_star
)paren
id|dev_id
suffix:semicolon
id|php_ctlr
op_assign
id|ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
)brace
r_else
(brace
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|dev_id
suffix:semicolon
id|ctrl
op_assign
(paren
r_struct
id|controller
op_star
)paren
id|php_ctlr-&gt;callback_instance_id
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ctrl
)paren
r_return
id|IRQ_NONE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
op_logical_or
op_logical_neg
id|php_ctlr-&gt;creg
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/* Check to see if it was our interrupt */
id|intr_loc
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|INTR_LOC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intr_loc
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: shpc_isr proceeds&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: intr_loc = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|intr_loc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpchp_poll_mode
)paren
(brace
multiline_comment|/* Mask Global Interrupt Mask - see implementation note on p. 139 */
multiline_comment|/* of SHPC spec rev 1.0*/
id|temp_dword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Before masking global interrupt, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|temp_dword
op_or_assign
l_int|0x00000001
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: After masking global interrupt, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|writel
c_func
(paren
id|temp_dword
comma
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|intr_loc2
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|INTR_LOC
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: intr_loc2 = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|intr_loc2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_loc
op_amp
l_int|0x0001
)paren
(brace
multiline_comment|/* &n;&t;&t; * Command Complete Interrupt Pending &n;&t;&t; * RO only - clear by writing 0 to the Command Completion&n;&t;&t; * Detect bit in Controller SERR-INT register&n;&t;&t; */
id|temp_dword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Before clearing CCIP, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|temp_dword
op_and_assign
l_int|0xfffeffff
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: After clearing CCIP, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|writel
c_func
(paren
id|temp_dword
comma
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ctrl-&gt;queue
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|intr_loc
op_assign
(paren
id|intr_loc
op_rshift
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Unmask Global Interrupt Mask */
id|temp_dword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: 1-Before unmasking global interrupt, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|temp_dword
op_and_assign
l_int|0xfffffffe
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: 1-After unmasking global interrupt, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|writel
c_func
(paren
id|temp_dword
comma
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|hp_slot
op_assign
l_int|0
suffix:semicolon
id|hp_slot
OL
id|ctrl-&gt;num_slots
suffix:semicolon
id|hp_slot
op_increment
)paren
(brace
multiline_comment|/* To find out which slot has interrupt pending */
r_if
c_cond
(paren
(paren
id|intr_loc
op_rshift
id|hp_slot
)paren
op_amp
l_int|0x01
)paren
(brace
id|temp_dword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
(paren
l_int|4
op_star
id|hp_slot
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Slot %x with intr, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hp_slot
comma
id|temp_dword
)paren
suffix:semicolon
id|temp_byte
op_assign
(paren
id|temp_dword
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Slot with intr, temp_byte = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_byte
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|php_ctlr-&gt;switch_change_callback
)paren
op_logical_and
(paren
id|temp_byte
op_amp
l_int|0x08
)paren
)paren
id|schedule_flag
op_add_assign
id|php_ctlr
op_member_access_from_pointer
id|switch_change_callback
c_func
(paren
id|hp_slot
comma
id|php_ctlr-&gt;callback_instance_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|php_ctlr-&gt;attention_button_callback
)paren
op_logical_and
(paren
id|temp_byte
op_amp
l_int|0x04
)paren
)paren
id|schedule_flag
op_add_assign
id|php_ctlr
op_member_access_from_pointer
id|attention_button_callback
c_func
(paren
id|hp_slot
comma
id|php_ctlr-&gt;callback_instance_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|php_ctlr-&gt;presence_change_callback
)paren
op_logical_and
(paren
id|temp_byte
op_amp
l_int|0x01
)paren
)paren
id|schedule_flag
op_add_assign
id|php_ctlr
op_member_access_from_pointer
id|presence_change_callback
c_func
(paren
id|hp_slot
comma
id|php_ctlr-&gt;callback_instance_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|php_ctlr-&gt;power_fault_callback
)paren
op_logical_and
(paren
id|temp_byte
op_amp
l_int|0x12
)paren
)paren
id|schedule_flag
op_add_assign
id|php_ctlr
op_member_access_from_pointer
id|power_fault_callback
c_func
(paren
id|hp_slot
comma
id|php_ctlr-&gt;callback_instance_id
)paren
suffix:semicolon
multiline_comment|/* Clear all slot events */
id|temp_dword
op_assign
l_int|0xe01f3fff
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Clearing slot events, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|writel
c_func
(paren
id|temp_dword
comma
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
(paren
l_int|4
op_star
id|hp_slot
)paren
)paren
suffix:semicolon
id|intr_loc2
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|INTR_LOC
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: intr_loc2 = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|intr_loc2
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|shpchp_poll_mode
)paren
(brace
multiline_comment|/* Unmask Global Interrupt Mask */
id|temp_dword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: 2-Before unmasking global interrupt, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|temp_dword
op_and_assign
l_int|0xfffffffe
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: 2-After unmasking global interrupt, temp_dword = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|temp_dword
)paren
suffix:semicolon
id|writel
c_func
(paren
id|temp_dword
comma
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|hpc_get_max_bus_speed
r_static
r_int
id|hpc_get_max_bus_speed
(paren
r_struct
id|slot
op_star
id|slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_enum
id|pci_bus_speed
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|u8
id|pi
suffix:semicolon
id|u32
id|slot_avail1
comma
id|slot_avail2
suffix:semicolon
r_int
id|slot_num
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pi
op_assign
id|readb
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|PROG_INTERFACE
)paren
suffix:semicolon
id|slot_avail1
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT_AVAIL1
)paren
suffix:semicolon
id|slot_avail2
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT_AVAIL2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pi
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail2
op_amp
id|SLOT_133MHZ_PCIX_533
)paren
op_rshift
l_int|27
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_133MHZ_533
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail2
op_amp
id|SLOT_100MHZ_PCIX_533
)paren
op_rshift
l_int|23
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_100MHZ_533
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail2
op_amp
id|SLOT_66MHZ_PCIX_533
)paren
op_rshift
l_int|19
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_66MHZ_533
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail2
op_amp
id|SLOT_133MHZ_PCIX_266
)paren
op_rshift
l_int|15
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_133MHZ_266
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail2
op_amp
id|SLOT_100MHZ_PCIX_266
)paren
op_rshift
l_int|11
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_100MHZ_266
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail2
op_amp
id|SLOT_66MHZ_PCIX_266
)paren
op_rshift
l_int|7
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_66MHZ_266
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail1
op_amp
id|SLOT_133MHZ_PCIX
)paren
op_rshift
l_int|23
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_133MHZ
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail1
op_amp
id|SLOT_100MHZ_PCIX
)paren
op_rshift
l_int|15
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_100MHZ
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail1
op_amp
id|SLOT_66MHZ_PCIX
)paren
op_rshift
l_int|7
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_66MHZ
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
id|slot_avail2
op_amp
id|SLOT_66MHZ
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCI_66MHZ
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
id|slot_avail1
op_amp
id|SLOT_33MHZ
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCI_33MHZ
suffix:semicolon
r_else
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail1
op_amp
id|SLOT_133MHZ_PCIX
)paren
op_rshift
l_int|23
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_133MHZ
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail1
op_amp
id|SLOT_100MHZ_PCIX
)paren
op_rshift
l_int|15
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_100MHZ
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
(paren
id|slot_avail1
op_amp
id|SLOT_66MHZ_PCIX
)paren
op_rshift
l_int|7
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCIX_66MHZ
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
id|slot_avail2
op_amp
id|SLOT_66MHZ
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCI_66MHZ
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_num
op_assign
(paren
id|slot_avail1
op_amp
id|SLOT_33MHZ
)paren
)paren
op_ne
l_int|0
)paren
id|bus_speed
op_assign
id|PCI_33MHZ
suffix:semicolon
r_else
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
)brace
op_star
id|value
op_assign
id|bus_speed
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Max bus speed = %d&bslash;n&quot;
comma
id|bus_speed
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpc_get_cur_bus_speed
r_static
r_int
id|hpc_get_cur_bus_speed
(paren
r_struct
id|slot
op_star
id|slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
suffix:semicolon
r_enum
id|pci_bus_speed
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
id|u16
id|sec_bus_status
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|u8
id|pi
suffix:semicolon
id|DBG_ENTER_ROUTINE
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;ctrl-&gt;hpc_ctlr_handle
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC controller handle!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;hp_slot
op_ge
id|php_ctlr-&gt;num_slots
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Invalid HPC slot number!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pi
op_assign
id|readb
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|PROG_INTERFACE
)paren
suffix:semicolon
id|sec_bus_status
op_assign
id|readw
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SEC_BUS_CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pi
op_eq
l_int|2
)paren
(brace
r_switch
c_cond
(paren
id|sec_bus_status
op_amp
l_int|0x000f
)paren
(brace
r_case
l_int|0
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_33MHz
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_66MHz
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_66MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_100MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_133MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_66MHz_PCIX_ECC
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_100MHz_PCIX_ECC
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_133MHz_PCIX_ECC
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_66MHz_PCIX_266
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_100MHz_PCIX_266
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xa
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_133MHz_PCIX_266
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_66MHz_PCIX_533
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xc
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_100MHz_PCIX_533
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xd
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_133MHz_PCIX_533
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe
suffix:colon
r_case
l_int|0xf
suffix:colon
r_default
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* In the case where pi is undefined, default it to 1 */
r_switch
c_cond
(paren
id|sec_bus_status
op_amp
l_int|0x0007
)paren
(brace
r_case
l_int|0
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_33MHz
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_66MHz
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_66MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_100MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_133MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
multiline_comment|/*&t;Reserved */
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
multiline_comment|/*&t;Reserved */
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
multiline_comment|/*&t;Reserved */
r_break
suffix:semicolon
r_default
suffix:colon
id|bus_speed
op_assign
id|PCI_SPEED_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
op_star
id|value
op_assign
id|bus_speed
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Current bus speed = %d&bslash;n&quot;
comma
id|bus_speed
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|shpchp_hpc_ops
r_static
r_struct
id|hpc_ops
id|shpchp_hpc_ops
op_assign
(brace
dot
id|power_on_slot
op_assign
id|hpc_power_on_slot
comma
dot
id|slot_enable
op_assign
id|hpc_slot_enable
comma
dot
id|slot_disable
op_assign
id|hpc_slot_disable
comma
dot
id|enable_all_slots
op_assign
id|hpc_enable_all_slots
comma
dot
id|pwr_on_all_slots
op_assign
id|hpc_pwr_on_all_slots
comma
dot
id|set_bus_speed_mode
op_assign
id|hpc_set_bus_speed_mode
comma
dot
id|set_attention_status
op_assign
id|hpc_set_attention_status
comma
dot
id|get_power_status
op_assign
id|hpc_get_power_status
comma
dot
id|get_attention_status
op_assign
id|hpc_get_attention_status
comma
dot
id|get_latch_status
op_assign
id|hpc_get_latch_status
comma
dot
id|get_adapter_status
op_assign
id|hpc_get_adapter_status
comma
dot
id|get_max_bus_speed
op_assign
id|hpc_get_max_bus_speed
comma
dot
id|get_cur_bus_speed
op_assign
id|hpc_get_cur_bus_speed
comma
dot
id|get_adapter_speed
op_assign
id|hpc_get_adapter_speed
comma
dot
id|get_mode1_ECC_cap
op_assign
id|hpc_get_mode1_ECC_cap
comma
dot
id|get_prog_int
op_assign
id|hpc_get_prog_int
comma
dot
id|query_power_fault
op_assign
id|hpc_query_power_fault
comma
dot
id|green_led_on
op_assign
id|hpc_set_green_led_on
comma
dot
id|green_led_off
op_assign
id|hpc_set_green_led_off
comma
dot
id|green_led_blink
op_assign
id|hpc_set_green_led_blink
comma
dot
id|release_ctlr
op_assign
id|hpc_release_ctlr
comma
dot
id|check_cmd_status
op_assign
id|hpc_check_cmd_status
comma
)brace
suffix:semicolon
DECL|function|shpc_init
r_int
id|shpc_init
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
id|php_intr_callback_t
id|attention_button_callback
comma
id|php_intr_callback_t
id|switch_change_callback
comma
id|php_intr_callback_t
id|presence_change_callback
comma
id|php_intr_callback_t
id|power_fault_callback
)paren
(brace
r_struct
id|php_ctlr_state_s
op_star
id|php_ctlr
comma
op_star
id|p
suffix:semicolon
r_void
op_star
id|instance_id
op_assign
id|ctrl
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|u8
id|hp_slot
suffix:semicolon
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
id|u32
id|shpc_cap_offset
comma
id|shpc_base_offset
suffix:semicolon
id|u32
id|tempdword
comma
id|slot_reg
suffix:semicolon
id|u16
id|vendor_id
comma
id|device_id
suffix:semicolon
id|u8
id|i
suffix:semicolon
id|DBG_ENTER_ROUTINE
id|spin_lock_init
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|php_ctlr
op_assign
(paren
r_struct
id|php_ctlr_state_s
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|php_ctlr_state_s
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr
)paren
(brace
multiline_comment|/* allocate controller state data */
id|err
c_func
(paren
l_string|&quot;%s: HPC controller memory allocation error!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
id|memset
c_func
(paren
id|php_ctlr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|php_ctlr_state_s
)paren
)paren
suffix:semicolon
id|php_ctlr-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
multiline_comment|/* save pci_dev in context */
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor_id
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Vendor ID: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|vendor_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: unable to read PCI configuration data&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device_id
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Device ID: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|device_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: unable to read PCI configuration data&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|vendor_id
op_eq
id|PCI_VENDOR_ID_AMD
)paren
op_logical_or
(paren
id|device_id
op_eq
id|PCI_DEVICE_ID_AMD_GOLAM_7450
)paren
)paren
(brace
id|shpc_base_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* amd shpc driver doesn&squot;t use this; assume 0 */
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|shpc_cap_offset
op_assign
id|pci_find_capability
c_func
(paren
id|pdev
comma
id|PCI_CAP_ID_SHPC
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : shpc_cap_offset == 0&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: shpc_cap_offset = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|shpc_cap_offset
)paren
suffix:semicolon
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
(paren
id|u8
)paren
id|shpc_cap_offset
op_plus
id|DWORD_SELECT
comma
id|BASE_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : pci_word_config_byte failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|rc
op_assign
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
(paren
id|u8
)paren
id|shpc_cap_offset
op_plus
id|DWORD_DATA
comma
op_amp
id|shpc_base_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : pci_read_config_dword failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|14
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
(paren
id|u8
)paren
id|shpc_cap_offset
op_plus
id|DWORD_SELECT
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : pci_word_config_byte failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|rc
op_assign
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
(paren
id|u8
)paren
id|shpc_cap_offset
op_plus
id|DWORD_DATA
comma
op_amp
id|tempdword
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : pci_read_config_dword failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: offset %d: tempdword %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|i
comma
id|tempdword
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|first
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|hpc_event_lock
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;pdev = %p: b:d:f:irq=0x%x:%x:%x:%x&bslash;n&quot;
comma
id|pdev
comma
id|pdev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rc
op_assign
l_int|0
suffix:semicolon
id|rc
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|rc
op_increment
)paren
r_if
c_cond
(paren
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|rc
)paren
OG
l_int|0
)paren
id|dbg
c_func
(paren
l_string|&quot;pci resource[%d] start=0x%lx(len=0x%lx), shpc_base_offset %x&bslash;n&quot;
comma
id|rc
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|rc
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|rc
)paren
comma
id|shpc_base_offset
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;HPC vendor_id %x device_id %x ss_vid %x ss_did %x&bslash;n&quot;
comma
id|pdev-&gt;vendor
comma
id|pdev-&gt;device
comma
id|pdev-&gt;subsystem_vendor
comma
id|pdev-&gt;subsystem_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|abort_free_ctlr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|shpc_base_offset
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|MY_NAME
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: cannot reserve MMIO region&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|php_ctlr-&gt;creg
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|shpc_base_offset
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|php_ctlr-&gt;creg
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: cannot remap MMIO region %lx @ %lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|shpc_base_offset
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_plus
id|shpc_base_offset
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: php_ctlr-&gt;creg %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|php_ctlr-&gt;creg
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: physical addr %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_void
op_star
)paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
multiline_comment|/* Setup wait queue */
id|init_waitqueue_head
c_func
(paren
op_amp
id|ctrl-&gt;queue
)paren
suffix:semicolon
multiline_comment|/* Find the IRQ */
id|php_ctlr-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;HPC interrupt = %d&bslash;n&quot;
comma
id|php_ctlr-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Save interrupt callback info */
id|php_ctlr-&gt;attention_button_callback
op_assign
id|attention_button_callback
suffix:semicolon
id|php_ctlr-&gt;switch_change_callback
op_assign
id|switch_change_callback
suffix:semicolon
id|php_ctlr-&gt;presence_change_callback
op_assign
id|presence_change_callback
suffix:semicolon
id|php_ctlr-&gt;power_fault_callback
op_assign
id|power_fault_callback
suffix:semicolon
id|php_ctlr-&gt;callback_instance_id
op_assign
id|instance_id
suffix:semicolon
multiline_comment|/* Return PCI Controller Info */
id|php_ctlr-&gt;slot_device_offset
op_assign
(paren
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT_CONFIG
)paren
op_amp
id|FIRST_DEV_NUM
)paren
op_rshift
l_int|8
suffix:semicolon
id|php_ctlr-&gt;num_slots
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT_CONFIG
)paren
op_amp
id|SLOT_NUM
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: slot_device_offset %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|php_ctlr-&gt;slot_device_offset
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: num_slots %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|php_ctlr-&gt;num_slots
)paren
suffix:semicolon
multiline_comment|/* Mask Global Interrupt Mask &amp; Command Complete Interrupt Mask */
id|tempdword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: SERR_INTR_ENABLE = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tempdword
)paren
suffix:semicolon
id|tempdword
op_assign
l_int|0x0003000f
suffix:semicolon
id|writel
c_func
(paren
id|tempdword
comma
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|tempdword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: SERR_INTR_ENABLE = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tempdword
)paren
suffix:semicolon
multiline_comment|/* Mask the MRL sensor SERR Mask of individual slot in&n;&t; * Slot SERR-INT Mask &amp; clear all the existing event if any&n;&t; */
r_for
c_loop
(paren
id|hp_slot
op_assign
l_int|0
suffix:semicolon
id|hp_slot
OL
id|php_ctlr-&gt;num_slots
suffix:semicolon
id|hp_slot
op_increment
)paren
(brace
id|slot_reg
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
l_int|4
op_star
id|hp_slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Default Logical Slot Register %d value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hp_slot
comma
id|slot_reg
)paren
suffix:semicolon
id|tempdword
op_assign
l_int|0xffff3fff
suffix:semicolon
id|writel
c_func
(paren
id|tempdword
comma
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
(paren
l_int|4
op_star
id|hp_slot
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|shpchp_poll_mode
)paren
(brace
multiline_comment|/* Install interrupt polling code */
multiline_comment|/* Install and start the interrupt polling timer */
id|init_timer
c_func
(paren
op_amp
id|php_ctlr-&gt;int_poll_timer
)paren
suffix:semicolon
id|start_int_poll_timer
c_func
(paren
id|php_ctlr
comma
l_int|10
)paren
suffix:semicolon
multiline_comment|/* start with 10 second delay */
)brace
r_else
(brace
multiline_comment|/* Installs the interrupt handler */
id|rc
op_assign
id|pci_enable_msi
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Can&squot;t get msi for the hotplug controller&bslash;n&quot;
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;Use INTx for the hotplug controller&bslash;n&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: rc = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
id|php_ctlr-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|rc
op_assign
id|request_irq
c_func
(paren
id|php_ctlr-&gt;irq
comma
id|shpc_isr
comma
id|SA_SHIRQ
comma
id|MY_NAME
comma
(paren
r_void
op_star
)paren
id|ctrl
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: request_irq %d for hpc%d (returns %d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|php_ctlr-&gt;irq
comma
id|ctlr_seq_num
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t get irq %d for the hotplug controller&bslash;n&quot;
comma
id|php_ctlr-&gt;irq
)paren
suffix:semicolon
r_goto
id|abort_free_ctlr
suffix:semicolon
)brace
multiline_comment|/* Execute OSHP method here */
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: Before adding HPC to HPC list&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/*  Add this HPC instance into the HPC list */
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|php_ctlr_list_head
op_eq
l_int|0
)paren
(brace
id|php_ctlr_list_head
op_assign
id|php_ctlr
suffix:semicolon
id|p
op_assign
id|php_ctlr_list_head
suffix:semicolon
id|p-&gt;pnext
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|php_ctlr_list_head
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;pnext
)paren
id|p
op_assign
id|p-&gt;pnext
suffix:semicolon
id|p-&gt;pnext
op_assign
id|php_ctlr
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|ctlr_seq_num
op_increment
suffix:semicolon
id|ctrl-&gt;hpc_ctlr_handle
op_assign
id|php_ctlr
suffix:semicolon
id|ctrl-&gt;hpc_ops
op_assign
op_amp
id|shpchp_hpc_ops
suffix:semicolon
r_for
c_loop
(paren
id|hp_slot
op_assign
l_int|0
suffix:semicolon
id|hp_slot
OL
id|php_ctlr-&gt;num_slots
suffix:semicolon
id|hp_slot
op_increment
)paren
(brace
id|slot_reg
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
l_int|4
op_star
id|hp_slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: Default Logical Slot Register %d value %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hp_slot
comma
id|slot_reg
)paren
suffix:semicolon
id|tempdword
op_assign
l_int|0xe01f3fff
suffix:semicolon
id|writel
c_func
(paren
id|tempdword
comma
id|php_ctlr-&gt;creg
op_plus
id|SLOT1
op_plus
(paren
l_int|4
op_star
id|hp_slot
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|shpchp_poll_mode
)paren
(brace
multiline_comment|/* Unmask all general input interrupts and SERR */
id|tempdword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|tempdword
op_assign
l_int|0x0000000a
suffix:semicolon
id|writel
c_func
(paren
id|tempdword
comma
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|tempdword
op_assign
id|readl
c_func
(paren
id|php_ctlr-&gt;creg
op_plus
id|SERR_INTR_ENABLE
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: SERR_INTR_ENABLE = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tempdword
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s: Leaving shpc_init&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|DBG_LEAVE_ROUTINE
r_return
l_int|0
suffix:semicolon
multiline_comment|/* We end up here for the many possible ways to fail this API.  */
id|abort_free_ctlr
suffix:colon
id|kfree
c_func
(paren
id|php_ctlr
)paren
suffix:semicolon
m_abort
suffix:colon
id|DBG_LEAVE_ROUTINE
r_return
op_minus
l_int|1
suffix:semicolon
)brace
eof
