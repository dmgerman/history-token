multiline_comment|/*&n; * Compaq Hot Plug Controller Driver&n; *&n; * Copyright (C) 1995,2001 Compaq Computer Corporation&n; * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (C) 2001 IBM Corp.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;greg@kroah.com&gt;&n; *&n; * Jan 12, 2003 -&t;Added 66/100/133MHz PCI-X support,&n; * &t;&t;&t;Torben Mathiasen &lt;torben.mathiasen@hp.com&gt;&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;cpqphp.h&quot;
macro_line|#include &quot;cpqphp_nvram.h&quot;
macro_line|#include &quot;../../../arch/i386/pci/pci.h&quot;&t;/* horrible hack showing how processor dependent we are... */
multiline_comment|/* Global variables */
DECL|variable|cpqhp_debug
r_int
id|cpqhp_debug
suffix:semicolon
DECL|variable|cpqhp_legacy_mode
r_int
id|cpqhp_legacy_mode
suffix:semicolon
DECL|variable|cpqhp_ctrl_list
r_struct
id|controller
op_star
id|cpqhp_ctrl_list
suffix:semicolon
multiline_comment|/* = NULL */
DECL|variable|cpqhp_slot_list
r_struct
id|pci_func
op_star
id|cpqhp_slot_list
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* local variables */
DECL|variable|smbios_table
r_static
r_void
op_star
id|smbios_table
suffix:semicolon
DECL|variable|smbios_start
r_static
r_void
op_star
id|smbios_start
suffix:semicolon
DECL|variable|cpqhp_rom_start
r_static
r_void
op_star
id|cpqhp_rom_start
suffix:semicolon
DECL|variable|power_mode
r_static
r_int
id|power_mode
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;0.9.7&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Dan Zink &lt;dan.zink@compaq.com&gt;, Greg Kroah-Hartman &lt;greg@kroah.com&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;Compaq Hot Plug PCI Controller Driver&quot;
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|power_mode
comma
r_bool
comma
l_int|644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|power_mode
comma
l_string|&quot;Power mode enabled or not&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_bool
comma
l_int|644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debugging mode enabled or not&quot;
)paren
suffix:semicolon
DECL|macro|CPQHPC_MODULE_MINOR
mdefine_line|#define CPQHPC_MODULE_MINOR 208
r_static
r_int
id|one_time_init
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|set_attention_status
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
id|value
)paren
suffix:semicolon
r_static
r_int
id|process_SI
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
suffix:semicolon
r_static
r_int
id|process_SS
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
suffix:semicolon
r_static
r_int
id|hardware_test
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u32
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_power_status
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_attention_status
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_latch_status
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_adapter_status
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_max_bus_speed
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_cur_bus_speed
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
suffix:semicolon
DECL|variable|cpqphp_hotplug_slot_ops
r_static
r_struct
id|hotplug_slot_ops
id|cpqphp_hotplug_slot_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|set_attention_status
op_assign
id|set_attention_status
comma
dot
id|enable_slot
op_assign
id|process_SI
comma
dot
id|disable_slot
op_assign
id|process_SS
comma
dot
id|hardware_test
op_assign
id|hardware_test
comma
dot
id|get_power_status
op_assign
id|get_power_status
comma
dot
id|get_attention_status
op_assign
id|get_attention_status
comma
dot
id|get_latch_status
op_assign
id|get_latch_status
comma
dot
id|get_adapter_status
op_assign
id|get_adapter_status
comma
dot
id|get_max_bus_speed
op_assign
id|get_max_bus_speed
comma
dot
id|get_cur_bus_speed
op_assign
id|get_cur_bus_speed
comma
)brace
suffix:semicolon
DECL|function|is_slot64bit
r_static
r_inline
r_int
id|is_slot64bit
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|slot
op_logical_or
op_logical_neg
id|slot-&gt;p_sm_slot
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|slot-&gt;p_sm_slot
op_plus
id|SMBIOS_SLOT_WIDTH
)paren
op_eq
l_int|0x06
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|is_slot66mhz
r_static
r_inline
r_int
id|is_slot66mhz
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|slot
op_logical_or
op_logical_neg
id|slot-&gt;p_sm_slot
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|slot-&gt;p_sm_slot
op_plus
id|SMBIOS_SLOT_TYPE
)paren
op_eq
l_int|0x0E
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * detect_SMBIOS_pointer - find the system Management BIOS Table in the specified region of memory.&n; *&n; * @begin: begin pointer for region to be scanned.&n; * @end: end pointer for region to be scanned.&n; *&n; * Returns pointer to the head of the SMBIOS tables (or NULL)&n; *&n; */
DECL|function|detect_SMBIOS_pointer
r_static
r_void
op_star
id|detect_SMBIOS_pointer
c_func
(paren
r_void
op_star
id|begin
comma
r_void
op_star
id|end
)paren
(brace
r_void
op_star
id|fp
suffix:semicolon
r_void
op_star
id|endp
suffix:semicolon
id|u8
id|temp1
comma
id|temp2
comma
id|temp3
comma
id|temp4
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|endp
op_assign
(paren
id|end
op_minus
r_sizeof
(paren
id|u32
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|fp
op_assign
id|begin
suffix:semicolon
id|fp
op_le
id|endp
suffix:semicolon
id|fp
op_add_assign
l_int|16
)paren
(brace
id|temp1
op_assign
id|readb
c_func
(paren
id|fp
)paren
suffix:semicolon
id|temp2
op_assign
id|readb
c_func
(paren
id|fp
op_plus
l_int|1
)paren
suffix:semicolon
id|temp3
op_assign
id|readb
c_func
(paren
id|fp
op_plus
l_int|2
)paren
suffix:semicolon
id|temp4
op_assign
id|readb
c_func
(paren
id|fp
op_plus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp1
op_eq
l_char|&squot;_&squot;
op_logical_and
id|temp2
op_eq
l_char|&squot;S&squot;
op_logical_and
id|temp3
op_eq
l_char|&squot;M&squot;
op_logical_and
id|temp4
op_eq
l_char|&squot;_&squot;
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
id|fp
op_assign
l_int|NULL
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Discovered SMBIOS Entry point at %p&bslash;n&quot;
comma
id|fp
)paren
suffix:semicolon
r_return
id|fp
suffix:semicolon
)brace
multiline_comment|/**&n; * init_SERR - Initializes the per slot SERR generation.&n; *&n; * For unexpected switch opens&n; *&n; */
DECL|function|init_SERR
r_static
r_int
id|init_SERR
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
id|u32
id|tempdword
suffix:semicolon
id|u32
id|number_of_slots
suffix:semicolon
id|u8
id|physical_slot
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrl
)paren
r_return
l_int|1
suffix:semicolon
id|tempdword
op_assign
id|ctrl-&gt;first_slot
suffix:semicolon
id|number_of_slots
op_assign
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
op_amp
l_int|0x0F
suffix:semicolon
singleline_comment|// Loop through slots
r_while
c_loop
(paren
id|number_of_slots
)paren
(brace
id|physical_slot
op_assign
id|tempdword
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_SERR
)paren
suffix:semicolon
id|tempdword
op_increment
suffix:semicolon
id|number_of_slots
op_decrement
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* nice debugging output */
DECL|function|pci_print_IRQ_route
r_static
r_int
id|pci_print_IRQ_route
(paren
r_void
)paren
(brace
r_struct
id|irq_routing_table
op_star
id|routing_table
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|loop
suffix:semicolon
id|u8
id|tbus
comma
id|tdevice
comma
id|tslot
suffix:semicolon
id|routing_table
op_assign
id|pcibios_get_irq_routing_table
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|routing_table
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;No BIOS Routing Table??? Not good&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|len
op_assign
(paren
id|routing_table-&gt;size
op_minus
r_sizeof
(paren
r_struct
id|irq_routing_table
)paren
)paren
op_div
r_sizeof
(paren
r_struct
id|irq_info
)paren
suffix:semicolon
singleline_comment|// Make sure I got at least one entry
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|routing_table
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;bus dev func slot&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
id|len
suffix:semicolon
op_increment
id|loop
)paren
(brace
id|tbus
op_assign
id|routing_table-&gt;slots
(braket
id|loop
)braket
dot
id|bus
suffix:semicolon
id|tdevice
op_assign
id|routing_table-&gt;slots
(braket
id|loop
)braket
dot
id|devfn
suffix:semicolon
id|tslot
op_assign
id|routing_table-&gt;slots
(braket
id|loop
)braket
dot
id|slot
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%d %d %d %d&bslash;n&quot;
comma
id|tbus
comma
id|tdevice
op_rshift
l_int|3
comma
id|tdevice
op_amp
l_int|0x7
comma
id|tslot
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|routing_table
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * get_subsequent_smbios_entry&n; *&n; * Gets the first entry if previous == NULL&n; * Otherwise, returns the next entry&n; * Uses global SMBIOS Table pointer&n; *&n; * @curr: %NULL or pointer to previously returned structure&n; *&n; * returns a pointer to an SMBIOS structure or NULL if none found&n; */
DECL|function|get_subsequent_smbios_entry
r_static
r_void
op_star
id|get_subsequent_smbios_entry
c_func
(paren
r_void
op_star
id|smbios_start
comma
r_void
op_star
id|smbios_table
comma
r_void
op_star
id|curr
)paren
(brace
id|u8
id|bail
op_assign
l_int|0
suffix:semicolon
id|u8
id|previous_byte
op_assign
l_int|1
suffix:semicolon
r_void
op_star
id|p_temp
suffix:semicolon
r_void
op_star
id|p_max
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smbios_table
op_logical_or
op_logical_neg
id|curr
)paren
r_return
l_int|NULL
suffix:semicolon
singleline_comment|// set p_max to the end of the table
id|p_max
op_assign
id|smbios_start
op_plus
id|readw
c_func
(paren
id|smbios_table
op_plus
id|ST_LENGTH
)paren
suffix:semicolon
id|p_temp
op_assign
id|curr
suffix:semicolon
id|p_temp
op_add_assign
id|readb
c_func
(paren
id|curr
op_plus
id|SMBIOS_GENERIC_LENGTH
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p_temp
OL
id|p_max
)paren
op_logical_and
op_logical_neg
id|bail
)paren
(brace
singleline_comment|// Look for the double NULL terminator
singleline_comment|// The first condition is the previous byte and the second is the curr
r_if
c_cond
(paren
op_logical_neg
id|previous_byte
op_logical_and
op_logical_neg
(paren
id|readb
c_func
(paren
id|p_temp
)paren
)paren
)paren
(brace
id|bail
op_assign
l_int|1
suffix:semicolon
)brace
id|previous_byte
op_assign
id|readb
c_func
(paren
id|p_temp
)paren
suffix:semicolon
id|p_temp
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_temp
OL
id|p_max
)paren
(brace
r_return
id|p_temp
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * get_SMBIOS_entry&n; *&n; * @type:SMBIOS structure type to be returned&n; * @previous: %NULL or pointer to previously returned structure&n; *&n; * Gets the first entry of the specified type if previous == NULL&n; * Otherwise, returns the next entry of the given type.&n; * Uses global SMBIOS Table pointer&n; * Uses get_subsequent_smbios_entry&n; *&n; * returns a pointer to an SMBIOS structure or %NULL if none found&n; */
DECL|function|get_SMBIOS_entry
r_static
r_void
op_star
id|get_SMBIOS_entry
(paren
r_void
op_star
id|smbios_start
comma
r_void
op_star
id|smbios_table
comma
id|u8
id|type
comma
r_void
op_star
id|previous
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|smbios_table
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|previous
)paren
(brace
id|previous
op_assign
id|smbios_start
suffix:semicolon
)brace
r_else
(brace
id|previous
op_assign
id|get_subsequent_smbios_entry
c_func
(paren
id|smbios_start
comma
id|smbios_table
comma
id|previous
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|previous
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
id|previous
op_plus
id|SMBIOS_GENERIC_TYPE
)paren
op_ne
id|type
)paren
(brace
id|previous
op_assign
id|get_subsequent_smbios_entry
c_func
(paren
id|smbios_start
comma
id|smbios_table
comma
id|previous
)paren
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
id|previous
suffix:semicolon
)brace
DECL|function|release_slot
r_static
r_void
id|release_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
)brace
DECL|function|ctrl_slot_setup
r_static
r_int
id|ctrl_slot_setup
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_void
op_star
id|smbios_start
comma
r_void
op_star
id|smbios_table
)paren
(brace
r_struct
id|slot
op_star
id|new_slot
suffix:semicolon
id|u8
id|number_of_slots
suffix:semicolon
id|u8
id|slot_device
suffix:semicolon
id|u8
id|slot_number
suffix:semicolon
id|u8
id|ctrl_slot
suffix:semicolon
id|u32
id|tempdword
suffix:semicolon
r_void
op_star
id|slot_entry
op_assign
l_int|NULL
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|tempdword
op_assign
id|readl
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|INT_INPUT_CLEAR
)paren
suffix:semicolon
id|number_of_slots
op_assign
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|slot_device
op_assign
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
op_rshift
l_int|4
suffix:semicolon
id|slot_number
op_assign
id|ctrl-&gt;first_slot
suffix:semicolon
r_while
c_loop
(paren
id|number_of_slots
)paren
(brace
id|new_slot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_slot
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|new_slot
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|new_slot-&gt;hotplug_slot
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_slot-&gt;hotplug_slot
)paren
(brace
id|kfree
(paren
id|new_slot
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|new_slot-&gt;hotplug_slot
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hotplug_slot
)paren
)paren
suffix:semicolon
id|new_slot-&gt;hotplug_slot-&gt;info
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_slot-&gt;hotplug_slot-&gt;info
)paren
(brace
id|kfree
(paren
id|new_slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|kfree
(paren
id|new_slot
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|new_slot-&gt;hotplug_slot-&gt;info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
)paren
suffix:semicolon
id|new_slot-&gt;hotplug_slot-&gt;name
op_assign
id|kmalloc
(paren
id|SLOT_NAME_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_slot-&gt;hotplug_slot-&gt;name
)paren
(brace
id|kfree
(paren
id|new_slot-&gt;hotplug_slot-&gt;info
)paren
suffix:semicolon
id|kfree
(paren
id|new_slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|kfree
(paren
id|new_slot
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|new_slot-&gt;ctrl
op_assign
id|ctrl
suffix:semicolon
id|new_slot-&gt;bus
op_assign
id|ctrl-&gt;bus
suffix:semicolon
id|new_slot-&gt;device
op_assign
id|slot_device
suffix:semicolon
id|new_slot-&gt;number
op_assign
id|slot_number
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;slot-&gt;number = %d&bslash;n&quot;
comma
id|new_slot-&gt;number
)paren
suffix:semicolon
id|slot_entry
op_assign
id|get_SMBIOS_entry
c_func
(paren
id|smbios_start
comma
id|smbios_table
comma
l_int|9
comma
id|slot_entry
)paren
suffix:semicolon
r_while
c_loop
(paren
id|slot_entry
op_logical_and
(paren
id|readw
c_func
(paren
id|slot_entry
op_plus
id|SMBIOS_SLOT_NUMBER
)paren
op_ne
id|new_slot-&gt;number
)paren
)paren
(brace
id|slot_entry
op_assign
id|get_SMBIOS_entry
c_func
(paren
id|smbios_start
comma
id|smbios_table
comma
l_int|9
comma
id|slot_entry
)paren
suffix:semicolon
)brace
id|new_slot-&gt;p_sm_slot
op_assign
id|slot_entry
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|new_slot-&gt;task_event
)paren
suffix:semicolon
id|new_slot-&gt;task_event.expires
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|new_slot-&gt;task_event.function
op_assign
id|cpqhp_pushbutton_thread
suffix:semicolon
singleline_comment|//FIXME: these capabilities aren&squot;t used but if they are
singleline_comment|//       they need to be correctly implemented
id|new_slot-&gt;capabilities
op_or_assign
id|PCISLOT_REPLACE_SUPPORTED
suffix:semicolon
id|new_slot-&gt;capabilities
op_or_assign
id|PCISLOT_INTERLOCK_SUPPORTED
suffix:semicolon
r_if
c_cond
(paren
id|is_slot64bit
c_func
(paren
id|new_slot
)paren
)paren
id|new_slot-&gt;capabilities
op_or_assign
id|PCISLOT_64_BIT_SUPPORTED
suffix:semicolon
r_if
c_cond
(paren
id|is_slot66mhz
c_func
(paren
id|new_slot
)paren
)paren
id|new_slot-&gt;capabilities
op_or_assign
id|PCISLOT_66_MHZ_SUPPORTED
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;speed
op_eq
id|PCI_SPEED_66MHz
)paren
id|new_slot-&gt;capabilities
op_or_assign
id|PCISLOT_66_MHZ_OPERATION
suffix:semicolon
id|ctrl_slot
op_assign
id|slot_device
op_minus
(paren
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
singleline_comment|// Check presence
id|new_slot-&gt;capabilities
op_or_assign
(paren
(paren
(paren
(paren
op_complement
id|tempdword
)paren
op_rshift
l_int|23
)paren
op_or
(paren
(paren
op_complement
id|tempdword
)paren
op_rshift
l_int|15
)paren
)paren
op_rshift
id|ctrl_slot
)paren
op_amp
l_int|0x02
suffix:semicolon
singleline_comment|// Check the switch state
id|new_slot-&gt;capabilities
op_or_assign
(paren
(paren
op_complement
id|tempdword
op_amp
l_int|0xFF
)paren
op_rshift
id|ctrl_slot
)paren
op_amp
l_int|0x01
suffix:semicolon
singleline_comment|// Check the slot enable
id|new_slot-&gt;capabilities
op_or_assign
(paren
(paren
id|read_slot_enable
c_func
(paren
id|ctrl
)paren
op_lshift
l_int|2
)paren
op_rshift
id|ctrl_slot
)paren
op_amp
l_int|0x04
suffix:semicolon
multiline_comment|/* register this slot with the hotplug pci core */
id|new_slot-&gt;hotplug_slot-&gt;release
op_assign
op_amp
id|release_slot
suffix:semicolon
id|new_slot-&gt;hotplug_slot
op_member_access_from_pointer
r_private
op_assign
id|new_slot
suffix:semicolon
id|make_slot_name
(paren
id|new_slot-&gt;hotplug_slot-&gt;name
comma
id|SLOT_NAME_SIZE
comma
id|new_slot
)paren
suffix:semicolon
id|new_slot-&gt;hotplug_slot-&gt;ops
op_assign
op_amp
id|cpqphp_hotplug_slot_ops
suffix:semicolon
id|new_slot-&gt;hotplug_slot-&gt;info-&gt;power_status
op_assign
id|get_slot_enabled
c_func
(paren
id|ctrl
comma
id|new_slot
)paren
suffix:semicolon
id|new_slot-&gt;hotplug_slot-&gt;info-&gt;attention_status
op_assign
id|cpq_get_attention_status
c_func
(paren
id|ctrl
comma
id|new_slot
)paren
suffix:semicolon
id|new_slot-&gt;hotplug_slot-&gt;info-&gt;latch_status
op_assign
id|cpq_get_latch_status
c_func
(paren
id|ctrl
comma
id|new_slot
)paren
suffix:semicolon
id|new_slot-&gt;hotplug_slot-&gt;info-&gt;adapter_status
op_assign
id|get_presence_status
c_func
(paren
id|ctrl
comma
id|new_slot
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;registering bus %d, dev %d, number %d, ctrl-&gt;slot_device_offset %d, slot %d&bslash;n&quot;
comma
id|new_slot-&gt;bus
comma
id|new_slot-&gt;device
comma
id|new_slot-&gt;number
comma
id|ctrl-&gt;slot_device_offset
comma
id|slot_number
)paren
suffix:semicolon
id|result
op_assign
id|pci_hp_register
(paren
id|new_slot-&gt;hotplug_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|err
(paren
l_string|&quot;pci_hp_register failed with error %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|release_slot
c_func
(paren
id|new_slot-&gt;hotplug_slot
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|new_slot-&gt;next
op_assign
id|ctrl-&gt;slot
suffix:semicolon
id|ctrl-&gt;slot
op_assign
id|new_slot
suffix:semicolon
id|number_of_slots
op_decrement
suffix:semicolon
id|slot_device
op_increment
suffix:semicolon
id|slot_number
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ctrl_slot_cleanup
r_static
r_int
id|ctrl_slot_cleanup
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|slot
op_star
id|old_slot
comma
op_star
id|next_slot
suffix:semicolon
id|old_slot
op_assign
id|ctrl-&gt;slot
suffix:semicolon
id|ctrl-&gt;slot
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|old_slot
)paren
(brace
multiline_comment|/* memory will be freed by the release_slot callback */
id|next_slot
op_assign
id|old_slot-&gt;next
suffix:semicolon
id|pci_hp_deregister
(paren
id|old_slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|old_slot
op_assign
id|next_slot
suffix:semicolon
)brace
singleline_comment|//Free IRQ associated with hot plug device
id|free_irq
c_func
(paren
id|ctrl-&gt;interrupt
comma
id|ctrl
)paren
suffix:semicolon
singleline_comment|//Unmap the memory
id|iounmap
c_func
(paren
id|ctrl-&gt;hpc_reg
)paren
suffix:semicolon
singleline_comment|//Finally reclaim PCI mem
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|ctrl-&gt;pci_dev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|ctrl-&gt;pci_dev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//============================================================================
singleline_comment|// function:&t;get_slot_mapping
singleline_comment|//
singleline_comment|// Description: Attempts to determine a logical slot mapping for a PCI
singleline_comment|//&t;&t;device.  Won&squot;t work for more than one PCI-PCI bridge
singleline_comment|//&t;&t;in a slot.
singleline_comment|//
singleline_comment|// Input:&t;u8 bus_num - bus number of PCI device
singleline_comment|//&t;&t;u8 dev_num - device number of PCI device
singleline_comment|//&t;&t;u8 *slot - Pointer to u8 where slot number will
singleline_comment|//&t;&t;&t;be returned
singleline_comment|//
singleline_comment|// Output:&t;SUCCESS or FAILURE
singleline_comment|//=============================================================================
DECL|function|get_slot_mapping
r_static
r_int
id|get_slot_mapping
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
id|u8
id|bus_num
comma
id|u8
id|dev_num
comma
id|u8
op_star
id|slot
)paren
(brace
r_struct
id|irq_routing_table
op_star
id|PCIIRQRoutingInfoLength
suffix:semicolon
id|u32
id|work
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|loop
suffix:semicolon
id|u8
id|tbus
comma
id|tdevice
comma
id|tslot
comma
id|bridgeSlot
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: %p, %d, %d, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|bus
comma
id|bus_num
comma
id|dev_num
comma
id|slot
)paren
suffix:semicolon
id|bridgeSlot
op_assign
l_int|0xFF
suffix:semicolon
id|PCIIRQRoutingInfoLength
op_assign
id|pcibios_get_irq_routing_table
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PCIIRQRoutingInfoLength
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|len
op_assign
(paren
id|PCIIRQRoutingInfoLength-&gt;size
op_minus
r_sizeof
(paren
r_struct
id|irq_routing_table
)paren
)paren
op_div
r_sizeof
(paren
r_struct
id|irq_info
)paren
suffix:semicolon
singleline_comment|// Make sure I got at least one entry
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|PCIIRQRoutingInfoLength
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
id|len
suffix:semicolon
op_increment
id|loop
)paren
(brace
id|tbus
op_assign
id|PCIIRQRoutingInfoLength-&gt;slots
(braket
id|loop
)braket
dot
id|bus
suffix:semicolon
id|tdevice
op_assign
id|PCIIRQRoutingInfoLength-&gt;slots
(braket
id|loop
)braket
dot
id|devfn
op_rshift
l_int|3
suffix:semicolon
id|tslot
op_assign
id|PCIIRQRoutingInfoLength-&gt;slots
(braket
id|loop
)braket
dot
id|slot
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tbus
op_eq
id|bus_num
)paren
op_logical_and
(paren
id|tdevice
op_eq
id|dev_num
)paren
)paren
(brace
op_star
id|slot
op_assign
id|tslot
suffix:semicolon
id|kfree
c_func
(paren
id|PCIIRQRoutingInfoLength
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Didn&squot;t get a match on the target PCI device. Check if the
singleline_comment|// current IRQ table entry is a PCI-to-PCI bridge device.  If so,
singleline_comment|// and it&squot;s secondary bus matches the bus number for the target 
singleline_comment|// device, I need to save the bridge&squot;s slot number.  If I can&squot;t 
singleline_comment|// find an entry for the target device, I will have to assume it&squot;s 
singleline_comment|// on the other side of the bridge, and assign it the bridge&squot;s slot.
id|bus-&gt;number
op_assign
id|tbus
suffix:semicolon
id|pci_bus_read_config_dword
(paren
id|bus
comma
id|PCI_DEVFN
c_func
(paren
id|tdevice
comma
l_int|0
)paren
comma
id|PCI_REVISION_ID
comma
op_amp
id|work
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|work
op_rshift
l_int|8
)paren
op_eq
id|PCI_TO_PCI_BRIDGE_CLASS
)paren
(brace
id|pci_bus_read_config_dword
(paren
id|bus
comma
id|PCI_DEVFN
c_func
(paren
id|tdevice
comma
l_int|0
)paren
comma
id|PCI_PRIMARY_BUS
comma
op_amp
id|work
)paren
suffix:semicolon
singleline_comment|// See if bridge&squot;s secondary bus matches target bus.
r_if
c_cond
(paren
(paren
(paren
id|work
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
)paren
op_eq
(paren
r_int
)paren
id|bus_num
)paren
(brace
id|bridgeSlot
op_assign
id|tslot
suffix:semicolon
)brace
)brace
)brace
)brace
singleline_comment|// If we got here, we didn&squot;t find an entry in the IRQ mapping table 
singleline_comment|// for the target PCI device.  If we did determine that the target 
singleline_comment|// device is on the other side of a PCI-to-PCI bridge, return the 
singleline_comment|// slot number for the bridge.
r_if
c_cond
(paren
id|bridgeSlot
op_ne
l_int|0xFF
)paren
(brace
op_star
id|slot
op_assign
id|bridgeSlot
suffix:semicolon
id|kfree
c_func
(paren
id|PCIIRQRoutingInfoLength
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|PCIIRQRoutingInfoLength
)paren
suffix:semicolon
singleline_comment|// Couldn&squot;t find an entry in the routing table for this PCI device
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * cpqhp_set_attention_status - Turns the Amber LED for a slot on or off&n; *&n; */
DECL|function|cpqhp_set_attention_status
r_static
r_int
id|cpqhp_set_attention_status
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
comma
id|u32
id|status
)paren
(brace
id|u8
id|hp_slot
suffix:semicolon
id|hp_slot
op_assign
id|func-&gt;device
op_minus
id|ctrl-&gt;slot_device_offset
suffix:semicolon
r_if
c_cond
(paren
id|func
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
singleline_comment|// Wait for exclusive access to hardware
id|down
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|1
)paren
(brace
id|amber_LED_on
(paren
id|ctrl
comma
id|hp_slot
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|amber_LED_off
(paren
id|ctrl
comma
id|hp_slot
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Done with exclusive hardware access
id|up
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|set_SOGO
c_func
(paren
id|ctrl
)paren
suffix:semicolon
singleline_comment|// Wait for SOBS to be unset
id|wait_for_ctrl_irq
(paren
id|ctrl
)paren
suffix:semicolon
singleline_comment|// Done with exclusive hardware access
id|up
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * set_attention_status - Turns the Amber LED for a slot on or off&n; *&n; */
DECL|function|set_attention_status
r_static
r_int
id|set_attention_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
id|status
)paren
(brace
r_struct
id|pci_func
op_star
id|slot_func
suffix:semicolon
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
suffix:semicolon
id|u8
id|bus
suffix:semicolon
id|u8
id|devfn
suffix:semicolon
id|u8
id|device
suffix:semicolon
id|u8
id|function
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|cpqhp_get_bus_dev
c_func
(paren
id|ctrl
comma
op_amp
id|bus
comma
op_amp
id|devfn
comma
id|slot-&gt;number
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|device
op_assign
id|devfn
op_rshift
l_int|3
suffix:semicolon
id|function
op_assign
id|devfn
op_amp
l_int|0x7
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;bus, dev, fn = %d, %d, %d&bslash;n&quot;
comma
id|bus
comma
id|device
comma
id|function
)paren
suffix:semicolon
id|slot_func
op_assign
id|cpqhp_slot_find
c_func
(paren
id|bus
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_func
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|cpqhp_set_attention_status
c_func
(paren
id|ctrl
comma
id|slot_func
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|process_SI
r_static
r_int
id|process_SI
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_struct
id|pci_func
op_star
id|slot_func
suffix:semicolon
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|u8
id|bus
suffix:semicolon
id|u8
id|devfn
suffix:semicolon
id|u8
id|device
suffix:semicolon
id|u8
id|function
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpqhp_get_bus_dev
c_func
(paren
id|ctrl
comma
op_amp
id|bus
comma
op_amp
id|devfn
comma
id|slot-&gt;number
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|device
op_assign
id|devfn
op_rshift
l_int|3
suffix:semicolon
id|function
op_assign
id|devfn
op_amp
l_int|0x7
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;bus, dev, fn = %d, %d, %d&bslash;n&quot;
comma
id|bus
comma
id|device
comma
id|function
)paren
suffix:semicolon
id|slot_func
op_assign
id|cpqhp_slot_find
c_func
(paren
id|bus
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_func
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|slot_func-&gt;bus
op_assign
id|bus
suffix:semicolon
id|slot_func-&gt;device
op_assign
id|device
suffix:semicolon
id|slot_func-&gt;function
op_assign
id|function
suffix:semicolon
id|slot_func-&gt;configured
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;board_added(%p, %p)&bslash;n&quot;
comma
id|slot_func
comma
id|ctrl
)paren
suffix:semicolon
r_return
id|cpqhp_process_SI
c_func
(paren
id|ctrl
comma
id|slot_func
)paren
suffix:semicolon
)brace
DECL|function|process_SS
r_static
r_int
id|process_SS
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_struct
id|pci_func
op_star
id|slot_func
suffix:semicolon
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|u8
id|bus
suffix:semicolon
id|u8
id|devfn
suffix:semicolon
id|u8
id|device
suffix:semicolon
id|u8
id|function
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpqhp_get_bus_dev
c_func
(paren
id|ctrl
comma
op_amp
id|bus
comma
op_amp
id|devfn
comma
id|slot-&gt;number
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|device
op_assign
id|devfn
op_rshift
l_int|3
suffix:semicolon
id|function
op_assign
id|devfn
op_amp
l_int|0x7
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;bus, dev, fn = %d, %d, %d&bslash;n&quot;
comma
id|bus
comma
id|device
comma
id|function
)paren
suffix:semicolon
id|slot_func
op_assign
id|cpqhp_slot_find
c_func
(paren
id|bus
comma
id|device
comma
id|function
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_func
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;In power_down_board, slot_func = %p, ctrl = %p&bslash;n&quot;
comma
id|slot_func
comma
id|ctrl
)paren
suffix:semicolon
r_return
id|cpqhp_process_SS
c_func
(paren
id|ctrl
comma
id|slot_func
)paren
suffix:semicolon
)brace
DECL|function|hardware_test
r_static
r_int
id|hardware_test
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u32
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
r_return
id|cpqhp_hardware_test
(paren
id|ctrl
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|get_power_status
r_static
r_int
id|get_power_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
op_star
id|value
op_assign
id|get_slot_enabled
c_func
(paren
id|ctrl
comma
id|slot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_attention_status
r_static
r_int
id|get_attention_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
op_star
id|value
op_assign
id|cpq_get_attention_status
c_func
(paren
id|ctrl
comma
id|slot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_latch_status
r_static
r_int
id|get_latch_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
op_star
id|value
op_assign
id|cpq_get_latch_status
c_func
(paren
id|ctrl
comma
id|slot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_adapter_status
r_static
r_int
id|get_adapter_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
op_star
id|value
op_assign
id|get_presence_status
c_func
(paren
id|ctrl
comma
id|slot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_max_bus_speed
r_static
r_int
id|get_max_bus_speed
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
op_star
id|value
op_assign
id|ctrl-&gt;speed_capability
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_cur_bus_speed
r_static
r_int
id|get_cur_bus_speed
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
r_enum
id|pci_bus_speed
op_star
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
op_assign
id|slot-&gt;ctrl
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
op_star
id|value
op_assign
id|ctrl-&gt;speed
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpqhpc_probe
r_static
r_int
id|cpqhpc_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
id|u8
id|num_of_slots
op_assign
l_int|0
suffix:semicolon
id|u8
id|hp_slot
op_assign
l_int|0
suffix:semicolon
id|u8
id|device
suffix:semicolon
id|u8
id|rev
suffix:semicolon
id|u8
id|bus_cap
suffix:semicolon
id|u16
id|temp_word
suffix:semicolon
id|u16
id|vendor_id
suffix:semicolon
id|u16
id|subsystem_vid
suffix:semicolon
id|u16
id|subsystem_deviceid
suffix:semicolon
id|u32
id|rc
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
suffix:semicolon
r_struct
id|pci_func
op_star
id|func
suffix:semicolon
singleline_comment|// Need to read VID early b/c it&squot;s used to differentiate CPQ and INTC discovery
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
(paren
id|vendor_id
op_ne
id|PCI_VENDOR_ID_COMPAQ
)paren
op_logical_and
(paren
id|vendor_id
op_ne
id|PCI_VENDOR_ID_INTEL
)paren
)paren
)paren
(brace
id|err
c_func
(paren
id|msg_HPC_non_compaq_or_intel
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Vendor ID: %x&bslash;n&quot;
comma
id|vendor_id
)paren
suffix:semicolon
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|rev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;revision: %d&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
(paren
id|vendor_id
op_eq
id|PCI_VENDOR_ID_COMPAQ
)paren
op_logical_and
(paren
op_logical_neg
id|rev
)paren
)paren
)paren
(brace
id|err
c_func
(paren
id|msg_HPC_rev_error
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Check for the proper subsytem ID&squot;s&n;&t; * Intel uses a different SSID programming model than Compaq.  &n;&t; * For Intel, each SSID bit identifies a PHP capability.&n;&t; * Also Intel HPC&squot;s may have RID=0.&n;&t; */
r_if
c_cond
(paren
(paren
id|rev
OG
l_int|2
)paren
op_logical_or
(paren
id|vendor_id
op_eq
id|PCI_VENDOR_ID_INTEL
)paren
)paren
(brace
singleline_comment|// TODO: This code can be made to support non-Compaq or Intel subsystem IDs
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|subsystem_vid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : pci_read_config_word failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Subsystem Vendor ID: %x&bslash;n&quot;
comma
id|subsystem_vid
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|subsystem_vid
op_ne
id|PCI_VENDOR_ID_COMPAQ
)paren
op_logical_and
(paren
id|subsystem_vid
op_ne
id|PCI_VENDOR_ID_INTEL
)paren
)paren
(brace
id|err
c_func
(paren
id|msg_HPC_non_compaq_or_intel
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ctrl
op_assign
(paren
r_struct
id|controller
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|controller
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrl
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ctrl
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|controller
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|subsystem_deviceid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s : pci_read_config_word failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|err_free_ctrl
suffix:semicolon
)brace
id|info
c_func
(paren
l_string|&quot;Hot Plug Subsystem Device ID: %x&bslash;n&quot;
comma
id|subsystem_deviceid
)paren
suffix:semicolon
multiline_comment|/* Set Vendor ID, so it can be accessed later from other functions */
id|ctrl-&gt;vendor_id
op_assign
id|vendor_id
suffix:semicolon
r_switch
c_cond
(paren
id|subsystem_vid
)paren
(brace
r_case
id|PCI_VENDOR_ID_COMPAQ
suffix:colon
r_if
c_cond
(paren
id|rev
op_ge
l_int|0x13
)paren
(brace
multiline_comment|/* CIOBX */
id|ctrl-&gt;push_flag
op_assign
l_int|1
suffix:semicolon
id|ctrl-&gt;slot_switch_type
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Switch is present
id|ctrl-&gt;push_button
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Pushbutton is present
id|ctrl-&gt;pci_config_space
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Index/data access to working registers 0 = not supported, 1 = supported
id|ctrl-&gt;defeature_PHP
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PHP is supported
id|ctrl-&gt;pcix_support
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PCI-X supported
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|1
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
l_int|0x41
comma
op_amp
id|bus_cap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_cap
op_amp
l_int|0x80
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;bus max supports 133MHz PCI-X&bslash;n&quot;
)paren
suffix:semicolon
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_133MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus_cap
op_amp
l_int|0x40
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;bus max supports 100MHz PCI-X&bslash;n&quot;
)paren
suffix:semicolon
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_100MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus_cap
op_amp
l_int|20
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;bus max supports 66MHz PCI-X&bslash;n&quot;
)paren
suffix:semicolon
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_66MHz_PCIX
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus_cap
op_amp
l_int|10
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;bus max supports 66MHz PCI&bslash;n&quot;
)paren
suffix:semicolon
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_66MHz
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|subsystem_deviceid
)paren
(brace
r_case
id|PCI_SUB_HPC_ID
suffix:colon
multiline_comment|/* Original 6500/7000 implementation */
id|ctrl-&gt;slot_switch_type
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Switch is present
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_33MHz
suffix:semicolon
id|ctrl-&gt;push_button
op_assign
l_int|0
suffix:semicolon
singleline_comment|// No pushbutton
id|ctrl-&gt;pci_config_space
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Index/data access to working registers 0 = not supported, 1 = supported
id|ctrl-&gt;defeature_PHP
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PHP is supported
id|ctrl-&gt;pcix_support
op_assign
l_int|0
suffix:semicolon
singleline_comment|// PCI-X not supported
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|0
suffix:semicolon
singleline_comment|// N/A since PCI-X not supported
r_break
suffix:semicolon
r_case
id|PCI_SUB_HPC_ID2
suffix:colon
multiline_comment|/* First Pushbutton implementation */
id|ctrl-&gt;push_flag
op_assign
l_int|1
suffix:semicolon
id|ctrl-&gt;slot_switch_type
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Switch is present
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_33MHz
suffix:semicolon
id|ctrl-&gt;push_button
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Pushbutton is present
id|ctrl-&gt;pci_config_space
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Index/data access to working registers 0 = not supported, 1 = supported
id|ctrl-&gt;defeature_PHP
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PHP is supported
id|ctrl-&gt;pcix_support
op_assign
l_int|0
suffix:semicolon
singleline_comment|// PCI-X not supported
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|0
suffix:semicolon
singleline_comment|// N/A since PCI-X not supported
r_break
suffix:semicolon
r_case
id|PCI_SUB_HPC_ID_INTC
suffix:colon
multiline_comment|/* Third party (6500/7000) */
id|ctrl-&gt;slot_switch_type
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Switch is present
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_33MHz
suffix:semicolon
id|ctrl-&gt;push_button
op_assign
l_int|0
suffix:semicolon
singleline_comment|// No pushbutton
id|ctrl-&gt;pci_config_space
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Index/data access to working registers 0 = not supported, 1 = supported
id|ctrl-&gt;defeature_PHP
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PHP is supported
id|ctrl-&gt;pcix_support
op_assign
l_int|0
suffix:semicolon
singleline_comment|// PCI-X not supported
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|0
suffix:semicolon
singleline_comment|// N/A since PCI-X not supported
r_break
suffix:semicolon
r_case
id|PCI_SUB_HPC_ID3
suffix:colon
multiline_comment|/* First 66 Mhz implementation */
id|ctrl-&gt;push_flag
op_assign
l_int|1
suffix:semicolon
id|ctrl-&gt;slot_switch_type
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Switch is present
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_66MHz
suffix:semicolon
id|ctrl-&gt;push_button
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Pushbutton is present
id|ctrl-&gt;pci_config_space
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Index/data access to working registers 0 = not supported, 1 = supported
id|ctrl-&gt;defeature_PHP
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PHP is supported
id|ctrl-&gt;pcix_support
op_assign
l_int|0
suffix:semicolon
singleline_comment|// PCI-X not supported
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|0
suffix:semicolon
singleline_comment|// N/A since PCI-X not supported
r_break
suffix:semicolon
r_case
id|PCI_SUB_HPC_ID4
suffix:colon
multiline_comment|/* First PCI-X implementation, 100MHz */
id|ctrl-&gt;push_flag
op_assign
l_int|1
suffix:semicolon
id|ctrl-&gt;slot_switch_type
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Switch is present
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_100MHz_PCIX
suffix:semicolon
id|ctrl-&gt;push_button
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Pushbutton is present
id|ctrl-&gt;pci_config_space
op_assign
l_int|1
suffix:semicolon
singleline_comment|// Index/data access to working registers 0 = not supported, 1 = supported
id|ctrl-&gt;defeature_PHP
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PHP is supported
id|ctrl-&gt;pcix_support
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PCI-X supported
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
id|msg_HPC_not_supported
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_free_ctrl
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PCI_VENDOR_ID_INTEL
suffix:colon
multiline_comment|/* Check for speed capability (0=33, 1=66) */
r_if
c_cond
(paren
id|subsystem_deviceid
op_amp
l_int|0x0001
)paren
(brace
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_66MHz
suffix:semicolon
)brace
r_else
(brace
id|ctrl-&gt;speed_capability
op_assign
id|PCI_SPEED_33MHz
suffix:semicolon
)brace
multiline_comment|/* Check for push button */
r_if
c_cond
(paren
id|subsystem_deviceid
op_amp
l_int|0x0002
)paren
(brace
multiline_comment|/* no push button */
id|ctrl-&gt;push_button
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* push button supported */
id|ctrl-&gt;push_button
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Check for slot switch type (0=mechanical, 1=not mechanical) */
r_if
c_cond
(paren
id|subsystem_deviceid
op_amp
l_int|0x0004
)paren
(brace
multiline_comment|/* no switch */
id|ctrl-&gt;slot_switch_type
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* switch */
id|ctrl-&gt;slot_switch_type
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* PHP Status (0=De-feature PHP, 1=Normal operation) */
r_if
c_cond
(paren
id|subsystem_deviceid
op_amp
l_int|0x0008
)paren
(brace
id|ctrl-&gt;defeature_PHP
op_assign
l_int|1
suffix:semicolon
singleline_comment|// PHP supported
)brace
r_else
(brace
id|ctrl-&gt;defeature_PHP
op_assign
l_int|0
suffix:semicolon
singleline_comment|// PHP not supported
)brace
multiline_comment|/* Alternate Base Address Register Interface (0=not supported, 1=supported) */
r_if
c_cond
(paren
id|subsystem_deviceid
op_amp
l_int|0x0010
)paren
(brace
id|ctrl-&gt;alternate_base_address
op_assign
l_int|1
suffix:semicolon
singleline_comment|// supported
)brace
r_else
(brace
id|ctrl-&gt;alternate_base_address
op_assign
l_int|0
suffix:semicolon
singleline_comment|// not supported
)brace
multiline_comment|/* PCI Config Space Index (0=not supported, 1=supported) */
r_if
c_cond
(paren
id|subsystem_deviceid
op_amp
l_int|0x0020
)paren
(brace
id|ctrl-&gt;pci_config_space
op_assign
l_int|1
suffix:semicolon
singleline_comment|// supported
)brace
r_else
(brace
id|ctrl-&gt;pci_config_space
op_assign
l_int|0
suffix:semicolon
singleline_comment|// not supported
)brace
multiline_comment|/* PCI-X support */
r_if
c_cond
(paren
id|subsystem_deviceid
op_amp
l_int|0x0080
)paren
(brace
multiline_comment|/* PCI-X capable */
id|ctrl-&gt;pcix_support
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Frequency of operation in PCI-X mode */
r_if
c_cond
(paren
id|subsystem_deviceid
op_amp
l_int|0x0040
)paren
(brace
multiline_comment|/* 133MHz PCI-X if bit 7 is 1 */
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 100MHz PCI-X if bit 7 is 1 and bit 0 is 0, */
multiline_comment|/* 66MHz PCI-X if bit 7 is 1 and bit 0 is 1 */
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Conventional PCI */
id|ctrl-&gt;pcix_support
op_assign
l_int|0
suffix:semicolon
id|ctrl-&gt;pcix_speed_capability
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
id|msg_HPC_not_supported
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_free_ctrl
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
c_func
(paren
id|msg_HPC_not_supported
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
singleline_comment|// Tell the user that we found one.
id|info
c_func
(paren
l_string|&quot;Initializing the PCI hot plug controller residing on PCI bus %d&bslash;n&quot;
comma
id|pdev-&gt;bus-&gt;number
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;Hotplug controller capabilities:&bslash;n&quot;
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;    speed_capability       %d&bslash;n&quot;
comma
id|ctrl-&gt;speed_capability
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;    slot_switch_type       %s&bslash;n&quot;
comma
id|ctrl-&gt;slot_switch_type
op_eq
l_int|0
ques
c_cond
l_string|&quot;no switch&quot;
suffix:colon
l_string|&quot;switch present&quot;
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;    defeature_PHP          %s&bslash;n&quot;
comma
id|ctrl-&gt;defeature_PHP
op_eq
l_int|0
ques
c_cond
l_string|&quot;PHP not supported&quot;
suffix:colon
l_string|&quot;PHP supported&quot;
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;    alternate_base_address %s&bslash;n&quot;
comma
id|ctrl-&gt;alternate_base_address
op_eq
l_int|0
ques
c_cond
l_string|&quot;not supported&quot;
suffix:colon
l_string|&quot;supported&quot;
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;    pci_config_space       %s&bslash;n&quot;
comma
id|ctrl-&gt;pci_config_space
op_eq
l_int|0
ques
c_cond
l_string|&quot;not supported&quot;
suffix:colon
l_string|&quot;supported&quot;
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;    pcix_speed_capability  %s&bslash;n&quot;
comma
id|ctrl-&gt;pcix_speed_capability
op_eq
l_int|0
ques
c_cond
l_string|&quot;not supported&quot;
suffix:colon
l_string|&quot;supported&quot;
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;    pcix_support           %s&bslash;n&quot;
comma
id|ctrl-&gt;pcix_support
op_eq
l_int|0
ques
c_cond
l_string|&quot;not supported&quot;
suffix:colon
l_string|&quot;supported&quot;
)paren
suffix:semicolon
id|ctrl-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|ctrl
)paren
suffix:semicolon
multiline_comment|/* make our own copy of the pci bus structure, as we like tweaking it a lot */
id|ctrl-&gt;pci_bus
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|ctrl-&gt;pci_bus
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrl-&gt;pci_bus
)paren
(brace
id|err
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_free_ctrl
suffix:semicolon
)brace
id|memcpy
(paren
id|ctrl-&gt;pci_bus
comma
id|pdev-&gt;bus
comma
r_sizeof
(paren
op_star
id|ctrl-&gt;pci_bus
)paren
)paren
suffix:semicolon
id|ctrl-&gt;bus
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|ctrl-&gt;rev
op_assign
id|rev
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;bus device function rev: %d %d %d %d&bslash;n&quot;
comma
id|ctrl-&gt;bus
comma
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|ctrl-&gt;rev
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ctrl-&gt;queue
)paren
suffix:semicolon
multiline_comment|/* initialize our threads if they haven&squot;t already been started up */
id|rc
op_assign
id|one_time_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_goto
id|err_free_bus
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;pdev = %p&bslash;n&quot;
comma
id|pdev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;pci resource start %lx&bslash;n&quot;
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;pci resource len %lx&bslash;n&quot;
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|MY_NAME
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;cannot reserve MMIO region&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_free_bus
suffix:semicolon
)brace
id|ctrl-&gt;hpc_reg
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrl-&gt;hpc_reg
)paren
(brace
id|err
c_func
(paren
l_string|&quot;cannot remap MMIO region %lx @ %lx&bslash;n&quot;
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_free_mem_region
suffix:semicolon
)brace
singleline_comment|// Check for 66Mhz operation
id|ctrl-&gt;speed
op_assign
id|get_controller_speed
c_func
(paren
id|ctrl
)paren
suffix:semicolon
singleline_comment|//**************************************************
singleline_comment|//
singleline_comment|//              Save configuration headers for this and
singleline_comment|//              subordinate PCI buses
singleline_comment|//
singleline_comment|//**************************************************
singleline_comment|// find the physical slot number of the first hot plug slot
singleline_comment|// Get slot won&squot;t work for devices behind bridges, but
singleline_comment|// in this case it will always be called for the &quot;base&quot;
singleline_comment|// bus/dev/func of a slot.
singleline_comment|// CS: this is leveraging the PCIIRQ routing code from the kernel (pci-pc.c: get_irq_routing_table)
id|rc
op_assign
id|get_slot_mapping
c_func
(paren
id|ctrl-&gt;pci_bus
comma
id|pdev-&gt;bus-&gt;number
comma
(paren
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
op_rshift
l_int|4
)paren
comma
op_amp
(paren
id|ctrl-&gt;first_slot
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;get_slot_mapping: first_slot = %d, returned = %d&bslash;n&quot;
comma
id|ctrl-&gt;first_slot
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
id|msg_initialization_err
comma
id|rc
)paren
suffix:semicolon
r_goto
id|err_iounmap
suffix:semicolon
)brace
singleline_comment|// Store PCI Config Space for all devices on this bus
id|rc
op_assign
id|cpqhp_save_config
c_func
(paren
id|ctrl
comma
id|ctrl-&gt;bus
comma
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: unable to save PCI configuration data, error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_goto
id|err_iounmap
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get IO, memory, and IRQ resources for new devices&n;&t; */
singleline_comment|// The next line is required for cpqhp_find_available_resources
id|ctrl-&gt;interrupt
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;interrupt
OL
l_int|0x10
)paren
(brace
id|cpqhp_legacy_mode
op_assign
l_int|1
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;System seems to be configured for Full Table Mapped MPS mode&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ctrl-&gt;cfgspc_irq
op_assign
l_int|0
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|ctrl-&gt;cfgspc_irq
)paren
suffix:semicolon
id|rc
op_assign
id|cpqhp_find_available_resources
c_func
(paren
id|ctrl
comma
id|cpqhp_rom_start
)paren
suffix:semicolon
id|ctrl-&gt;add_support
op_assign
op_logical_neg
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;cpqhp_find_available_resources = 0x%x&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;unable to locate PCI configuration resources for hot plug add.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_iounmap
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Finish setting up the hot plug ctrl device&n;&t; */
id|ctrl-&gt;slot_device_offset
op_assign
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
op_rshift
l_int|4
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;NumSlots %d &bslash;n&quot;
comma
id|ctrl-&gt;slot_device_offset
)paren
suffix:semicolon
id|ctrl-&gt;next_event
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup the slot information structures */
id|rc
op_assign
id|ctrl_slot_setup
c_func
(paren
id|ctrl
comma
id|smbios_start
comma
id|smbios_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
id|msg_initialization_err
comma
l_int|6
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s: unable to save PCI configuration data, error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_goto
id|err_iounmap
suffix:semicolon
)brace
multiline_comment|/* Mask all general input interrupts */
id|writel
c_func
(paren
l_int|0xFFFFFFFFL
comma
id|ctrl-&gt;hpc_reg
op_plus
id|INT_MASK
)paren
suffix:semicolon
multiline_comment|/* set up the interrupt */
id|dbg
c_func
(paren
l_string|&quot;HPC interrupt = %d &bslash;n&quot;
comma
id|ctrl-&gt;interrupt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|ctrl-&gt;interrupt
comma
id|cpqhp_ctrl_intr
comma
id|SA_SHIRQ
comma
id|MY_NAME
comma
id|ctrl
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t get irq %d for the hotplug pci controller&bslash;n&quot;
comma
id|ctrl-&gt;interrupt
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_iounmap
suffix:semicolon
)brace
multiline_comment|/* Enable Shift Out interrupt and clear it, also enable SERR on power fault */
id|temp_word
op_assign
id|readw
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|MISC
)paren
suffix:semicolon
id|temp_word
op_or_assign
l_int|0x4006
suffix:semicolon
id|writew
c_func
(paren
id|temp_word
comma
id|ctrl-&gt;hpc_reg
op_plus
id|MISC
)paren
suffix:semicolon
singleline_comment|// Changed 05/05/97 to clear all interrupts at start
id|writel
c_func
(paren
l_int|0xFFFFFFFFL
comma
id|ctrl-&gt;hpc_reg
op_plus
id|INT_INPUT_CLEAR
)paren
suffix:semicolon
id|ctrl-&gt;ctrl_int_comp
op_assign
id|readl
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|INT_INPUT_CLEAR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0L
comma
id|ctrl-&gt;hpc_reg
op_plus
id|INT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpqhp_ctrl_list
)paren
(brace
id|cpqhp_ctrl_list
op_assign
id|ctrl
suffix:semicolon
id|ctrl-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|ctrl-&gt;next
op_assign
id|cpqhp_ctrl_list
suffix:semicolon
id|cpqhp_ctrl_list
op_assign
id|ctrl
suffix:semicolon
)brace
singleline_comment|// turn off empty slots here unless command line option &quot;ON&quot; set
singleline_comment|// Wait for exclusive access to hardware
id|down
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
id|num_of_slots
op_assign
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
op_amp
l_int|0x0F
suffix:semicolon
singleline_comment|// find first device number for the ctrl
id|device
op_assign
id|readb
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_MASK
)paren
op_rshift
l_int|4
suffix:semicolon
r_while
c_loop
(paren
id|num_of_slots
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;num_of_slots: %d&bslash;n&quot;
comma
id|num_of_slots
)paren
suffix:semicolon
id|func
op_assign
id|cpqhp_slot_find
c_func
(paren
id|ctrl-&gt;bus
comma
id|device
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|func
)paren
r_break
suffix:semicolon
id|hp_slot
op_assign
id|func-&gt;device
op_minus
id|ctrl-&gt;slot_device_offset
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;hp_slot: %d&bslash;n&quot;
comma
id|hp_slot
)paren
suffix:semicolon
singleline_comment|// We have to save the presence info for these slots
id|temp_word
op_assign
id|ctrl-&gt;ctrl_int_comp
op_rshift
l_int|16
suffix:semicolon
id|func-&gt;presence_save
op_assign
(paren
id|temp_word
op_rshift
id|hp_slot
)paren
op_amp
l_int|0x01
suffix:semicolon
id|func-&gt;presence_save
op_or_assign
(paren
id|temp_word
op_rshift
(paren
id|hp_slot
op_plus
l_int|7
)paren
)paren
op_amp
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;ctrl_int_comp
op_amp
(paren
l_int|0x1L
op_lshift
id|hp_slot
)paren
)paren
(brace
id|func-&gt;switch_save
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|func-&gt;switch_save
op_assign
l_int|0x10
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|power_mode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|func-&gt;is_a_board
)paren
(brace
id|green_LED_off
(paren
id|ctrl
comma
id|hp_slot
)paren
suffix:semicolon
id|slot_disable
(paren
id|ctrl
comma
id|hp_slot
)paren
suffix:semicolon
)brace
)brace
id|device
op_increment
suffix:semicolon
id|num_of_slots
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|power_mode
)paren
(brace
id|set_SOGO
c_func
(paren
id|ctrl
)paren
suffix:semicolon
singleline_comment|// Wait for SOBS to be unset
id|wait_for_ctrl_irq
(paren
id|ctrl
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|init_SERR
c_func
(paren
id|ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
c_func
(paren
l_string|&quot;init_SERR failed&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
r_goto
id|err_free_irq
suffix:semicolon
)brace
singleline_comment|// Done with exclusive hardware access
id|up
c_func
(paren
op_amp
id|ctrl-&gt;crit_sect
)paren
suffix:semicolon
id|cpqhp_create_ctrl_files
(paren
id|ctrl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|ctrl-&gt;interrupt
comma
id|ctrl
)paren
suffix:semicolon
id|err_iounmap
suffix:colon
id|iounmap
c_func
(paren
id|ctrl-&gt;hpc_reg
)paren
suffix:semicolon
id|err_free_mem_region
suffix:colon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|err_free_bus
suffix:colon
id|kfree
c_func
(paren
id|ctrl-&gt;pci_bus
)paren
suffix:semicolon
id|err_free_ctrl
suffix:colon
id|kfree
c_func
(paren
id|ctrl
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|one_time_init
r_static
r_int
id|one_time_init
c_func
(paren
r_void
)paren
(brace
r_int
id|loop
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|initialized
)paren
r_return
l_int|0
suffix:semicolon
id|power_mode
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
id|pci_print_IRQ_route
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|error
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Initialize + Start the notification mechanism &bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|cpqhp_event_start_thread
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|error
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Initialize slot lists&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|256
suffix:semicolon
id|loop
op_increment
)paren
(brace
id|cpqhp_slot_list
(braket
id|loop
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
singleline_comment|// FIXME: We also need to hook the NMI handler eventually.
singleline_comment|// this also needs to be worked with Christoph
singleline_comment|// register_NMI_handler();
singleline_comment|// Map rom address
id|cpqhp_rom_start
op_assign
id|ioremap
c_func
(paren
id|ROM_PHY_ADDR
comma
id|ROM_PHY_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpqhp_rom_start
)paren
(brace
id|err
(paren
l_string|&quot;Could not ioremap memory region for ROM&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Now, map the int15 entry point if we are on compaq specific hardware */
id|compaq_nvram_init
c_func
(paren
id|cpqhp_rom_start
)paren
suffix:semicolon
multiline_comment|/* Map smbios table entry point structure */
id|smbios_table
op_assign
id|detect_SMBIOS_pointer
c_func
(paren
id|cpqhp_rom_start
comma
id|cpqhp_rom_start
op_plus
id|ROM_PHY_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smbios_table
)paren
(brace
id|err
(paren
l_string|&quot;Could not find the SMBIOS pointer in memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|smbios_start
op_assign
id|ioremap
c_func
(paren
id|readl
c_func
(paren
id|smbios_table
op_plus
id|ST_ADDRESS
)paren
comma
id|readw
c_func
(paren
id|smbios_table
op_plus
id|ST_LENGTH
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smbios_start
)paren
(brace
id|err
(paren
l_string|&quot;Could not ioremap memory region taken from SMBIOS values&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|initialized
op_assign
l_int|1
suffix:semicolon
r_return
id|retval
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|cpqhp_rom_start
)paren
id|iounmap
c_func
(paren
id|cpqhp_rom_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smbios_start
)paren
id|iounmap
c_func
(paren
id|smbios_start
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|unload_cpqphpd
r_static
r_void
id|unload_cpqphpd
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_func
op_star
id|next
suffix:semicolon
r_struct
id|pci_func
op_star
id|TempSlot
suffix:semicolon
r_int
id|loop
suffix:semicolon
id|u32
id|rc
suffix:semicolon
r_struct
id|controller
op_star
id|ctrl
suffix:semicolon
r_struct
id|controller
op_star
id|tctrl
suffix:semicolon
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_struct
id|pci_resource
op_star
id|tres
suffix:semicolon
id|rc
op_assign
id|compaq_nvram_store
c_func
(paren
id|cpqhp_rom_start
)paren
suffix:semicolon
id|ctrl
op_assign
id|cpqhp_ctrl_list
suffix:semicolon
r_while
c_loop
(paren
id|ctrl
)paren
(brace
r_if
c_cond
(paren
id|ctrl-&gt;hpc_reg
)paren
(brace
id|u16
id|misc
suffix:semicolon
id|rc
op_assign
id|read_slot_enable
(paren
id|ctrl
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|ctrl-&gt;hpc_reg
op_plus
id|SLOT_SERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xFFFFFFC0L
op_or
op_complement
id|rc
comma
id|ctrl-&gt;hpc_reg
op_plus
id|INT_MASK
)paren
suffix:semicolon
id|misc
op_assign
id|readw
c_func
(paren
id|ctrl-&gt;hpc_reg
op_plus
id|MISC
)paren
suffix:semicolon
id|misc
op_and_assign
l_int|0xFFFD
suffix:semicolon
id|writew
c_func
(paren
id|misc
comma
id|ctrl-&gt;hpc_reg
op_plus
id|MISC
)paren
suffix:semicolon
)brace
id|ctrl_slot_cleanup
c_func
(paren
id|ctrl
)paren
suffix:semicolon
id|res
op_assign
id|ctrl-&gt;io_head
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
id|res
op_assign
id|ctrl-&gt;mem_head
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
id|res
op_assign
id|ctrl-&gt;p_mem_head
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
id|res
op_assign
id|ctrl-&gt;bus_head
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|ctrl-&gt;pci_bus
)paren
suffix:semicolon
id|tctrl
op_assign
id|ctrl
suffix:semicolon
id|ctrl
op_assign
id|ctrl-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tctrl
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|256
suffix:semicolon
id|loop
op_increment
)paren
(brace
id|next
op_assign
id|cpqhp_slot_list
(braket
id|loop
)braket
suffix:semicolon
r_while
c_loop
(paren
id|next
op_ne
l_int|NULL
)paren
(brace
id|res
op_assign
id|next-&gt;io_head
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
id|res
op_assign
id|next-&gt;mem_head
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
id|res
op_assign
id|next-&gt;p_mem_head
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
id|res
op_assign
id|next-&gt;bus_head
suffix:semicolon
r_while
c_loop
(paren
id|res
)paren
(brace
id|tres
op_assign
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tres
)paren
suffix:semicolon
)brace
id|TempSlot
op_assign
id|next
suffix:semicolon
id|next
op_assign
id|next-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|TempSlot
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// Stop the notification mechanism
id|cpqhp_event_stop_thread
c_func
(paren
)paren
suffix:semicolon
singleline_comment|//unmap the rom address
r_if
c_cond
(paren
id|cpqhp_rom_start
)paren
id|iounmap
c_func
(paren
id|cpqhp_rom_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smbios_start
)paren
id|iounmap
c_func
(paren
id|smbios_start
)paren
suffix:semicolon
)brace
DECL|variable|hpcd_pci_tbl
r_static
r_struct
id|pci_device_id
id|hpcd_pci_tbl
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* handle any PCI Hotplug controller */
dot
r_class
op_assign
(paren
(paren
id|PCI_CLASS_SYSTEM_PCI_HOTPLUG
op_lshift
l_int|8
)paren
op_or
l_int|0x00
)paren
comma
dot
id|class_mask
op_assign
op_complement
l_int|0
comma
multiline_comment|/* no matter who makes it */
dot
id|vendor
op_assign
id|PCI_ANY_ID
comma
dot
id|device
op_assign
id|PCI_ANY_ID
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|hpcd_pci_tbl
)paren
suffix:semicolon
DECL|variable|cpqhpc_driver
r_static
r_struct
id|pci_driver
id|cpqhpc_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;pci_hotplug&quot;
comma
dot
id|id_table
op_assign
id|hpcd_pci_tbl
comma
dot
id|probe
op_assign
id|cpqhpc_probe
comma
multiline_comment|/* remove:&t;cpqhpc_remove_one, */
)brace
suffix:semicolon
DECL|function|cpqhpc_init
r_static
r_int
id|__init
id|cpqhpc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|cpqhp_debug
op_assign
id|debug
suffix:semicolon
id|result
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|cpqhpc_driver
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;pci_module_init = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|info
(paren
id|DRIVER_DESC
l_string|&quot; version: &quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpqhpc_cleanup
r_static
r_void
id|__exit
id|cpqhpc_cleanup
c_func
(paren
r_void
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;unload_cpqphpd()&bslash;n&quot;
)paren
suffix:semicolon
id|unload_cpqphpd
c_func
(paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;pci_unregister_driver&bslash;n&quot;
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|cpqhpc_driver
)paren
suffix:semicolon
)brace
DECL|variable|cpqhpc_init
id|module_init
c_func
(paren
id|cpqhpc_init
)paren
suffix:semicolon
DECL|variable|cpqhpc_cleanup
id|module_exit
c_func
(paren
id|cpqhpc_cleanup
)paren
suffix:semicolon
eof
