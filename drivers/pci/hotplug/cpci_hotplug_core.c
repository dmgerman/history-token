multiline_comment|/*&n; * CompactPCI Hot Plug Driver&n; *&n; * Copyright (c) 2002 SOMA Networks, Inc.&n; * Copyright (c) 2001 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (c) 2001 IBM Corp.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;scottm@somanetworks.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &quot;pci_hotplug.h&quot;
macro_line|#include &quot;cpci_hotplug.h&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;0.2&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Scott Murray &lt;scottm@somanetworks.com&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;CompactPCI Hot Plug Core&quot;
macro_line|#if !defined(CONFIG_HOTPLUG_CPCI_MODULE)
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME&t;&quot;cpci_hotplug&quot;
macro_line|#else
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME&t;THIS_MODULE-&gt;name
macro_line|#endif
DECL|macro|dbg
mdefine_line|#define dbg(format, arg...)&t;&t;&t;&t;&t;&bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;if(cpci_debug)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;printk (KERN_DEBUG &quot;%s: &quot; format &quot;&bslash;n&quot;,&t;&bslash;&n;&t;&t;&t;&t;MY_NAME , ## arg); &t;&t;&bslash;&n;&t;} while(0)
DECL|macro|err
mdefine_line|#define err(format, arg...) printk(KERN_ERR &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
DECL|macro|info
mdefine_line|#define info(format, arg...) printk(KERN_INFO &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
DECL|macro|warn
mdefine_line|#define warn(format, arg...) printk(KERN_WARNING &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
multiline_comment|/* local variables */
DECL|variable|list_lock
r_static
id|spinlock_t
id|list_lock
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|slot_list
)paren
suffix:semicolon
DECL|variable|slots
r_static
r_int
id|slots
suffix:semicolon
DECL|variable|cpci_debug
r_int
id|cpci_debug
suffix:semicolon
DECL|variable|controller
r_static
r_struct
id|cpci_hp_controller
op_star
id|controller
suffix:semicolon
DECL|variable|event_semaphore
r_static
r_struct
id|semaphore
id|event_semaphore
suffix:semicolon
multiline_comment|/* mutex for process loop (up if something to process) */
DECL|variable|thread_exit
r_static
r_struct
id|semaphore
id|thread_exit
suffix:semicolon
multiline_comment|/* guard ensure thread has exited before calling it quits */
DECL|variable|thread_finished
r_static
r_int
id|thread_finished
op_assign
l_int|1
suffix:semicolon
r_static
r_int
id|enable_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
suffix:semicolon
r_static
r_int
id|disable_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
)paren
suffix:semicolon
r_static
r_int
id|set_attention_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_power_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_attention_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_latch_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|get_adapter_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|slot
comma
id|u8
op_star
id|value
)paren
suffix:semicolon
DECL|variable|cpci_hotplug_slot_ops
r_static
r_struct
id|hotplug_slot_ops
id|cpci_hotplug_slot_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|enable_slot
op_assign
id|enable_slot
comma
dot
id|disable_slot
op_assign
id|disable_slot
comma
dot
id|set_attention_status
op_assign
id|set_attention_status
comma
dot
id|hardware_test
op_assign
l_int|NULL
comma
dot
id|get_power_status
op_assign
id|get_power_status
comma
dot
id|get_attention_status
op_assign
id|get_attention_status
comma
dot
id|get_latch_status
op_assign
id|get_latch_status
comma
dot
id|get_adapter_status
op_assign
id|get_adapter_status
comma
)brace
suffix:semicolon
multiline_comment|/* Inline functions to check the sanity of a pointer that is passed to us */
r_static
r_inline
r_int
DECL|function|slot_paranoia_check
id|slot_paranoia_check
c_func
(paren
r_struct
id|slot
op_star
id|slot
comma
r_const
r_char
op_star
id|function
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - slot == NULL&quot;
comma
id|function
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;magic
op_ne
id|SLOT_MAGIC
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - bad magic number for slot&quot;
comma
id|function
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;hotplug_slot
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - slot-&gt;hotplug_slot == NULL!&quot;
comma
id|function
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_struct
id|slot
op_star
DECL|function|get_slot
id|get_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
r_const
r_char
op_star
id|function
)paren
(brace
r_struct
id|slot
op_star
id|slot
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hotplug_slot
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - hotplug_slot == NULL&quot;
comma
id|function
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|slot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|slot_paranoia_check
c_func
(paren
id|slot
comma
id|function
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|slot
suffix:semicolon
)brace
r_static
r_int
DECL|function|update_latch_status
id|update_latch_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
id|value
)paren
(brace
r_struct
id|hotplug_slot_info
id|info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hotplug_slot
op_logical_and
id|hotplug_slot-&gt;info
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|info
comma
id|hotplug_slot-&gt;info
comma
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
)paren
suffix:semicolon
id|info.latch_status
op_assign
id|value
suffix:semicolon
r_return
id|pci_hp_change_slot_info
c_func
(paren
id|hotplug_slot
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|update_adapter_status
id|update_adapter_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
id|value
)paren
(brace
r_struct
id|hotplug_slot_info
id|info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hotplug_slot
op_logical_and
id|hotplug_slot-&gt;info
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|info
comma
id|hotplug_slot-&gt;info
comma
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
)paren
suffix:semicolon
id|info.adapter_status
op_assign
id|value
suffix:semicolon
r_return
id|pci_hp_change_slot_info
c_func
(paren
id|hotplug_slot
comma
op_amp
id|info
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|enable_slot
id|enable_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|get_slot
c_func
(paren
id|hotplug_slot
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller-&gt;ops-&gt;set_power
)paren
(brace
id|retval
op_assign
id|controller-&gt;ops
op_member_access_from_pointer
id|set_power
c_func
(paren
id|slot
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|disable_slot
id|disable_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|get_slot
c_func
(paren
id|hotplug_slot
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - physical_slot = %s&quot;
comma
id|__FUNCTION__
comma
id|hotplug_slot-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Unconfigure device */
id|dbg
c_func
(paren
l_string|&quot;%s - unconfiguring slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|cpci_unconfigure_slot
c_func
(paren
id|slot
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - could not unconfigure slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - finished unconfiguring slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Clear EXT (by setting it) */
r_if
c_cond
(paren
id|cpci_clear_ext
c_func
(paren
id|slot
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - could not clear EXT for slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cpci_led_on
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller-&gt;ops-&gt;set_power
)paren
(brace
id|retval
op_assign
id|controller-&gt;ops
op_member_access_from_pointer
id|set_power
c_func
(paren
id|slot
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|update_adapter_status
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|0
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;failure to update adapter file&quot;
)paren
suffix:semicolon
)brace
id|slot-&gt;extracting
op_assign
l_int|0
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
id|u8
DECL|function|cpci_get_power_status
id|cpci_get_power_status
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
id|u8
id|power
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|controller-&gt;ops-&gt;get_power
)paren
(brace
id|power
op_assign
id|controller-&gt;ops
op_member_access_from_pointer
id|get_power
c_func
(paren
id|slot
)paren
suffix:semicolon
)brace
r_return
id|power
suffix:semicolon
)brace
r_static
r_int
DECL|function|get_power_status
id|get_power_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|get_slot
c_func
(paren
id|hotplug_slot
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
op_star
id|value
op_assign
id|cpci_get_power_status
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|get_attention_status
id|get_attention_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|get_slot
c_func
(paren
id|hotplug_slot
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
op_star
id|value
op_assign
id|cpci_get_attention_status
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_attention_status
id|set_attention_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
id|status
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|get_slot
c_func
(paren
id|hotplug_slot
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
l_int|0
suffix:colon
id|cpci_set_attention_status
c_func
(paren
id|slot
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_default
suffix:colon
id|cpci_set_attention_status
c_func
(paren
id|slot
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|get_latch_status
id|get_latch_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
id|hotplug_slot
op_eq
l_int|NULL
op_logical_or
id|hotplug_slot-&gt;info
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
op_star
id|value
op_assign
id|hotplug_slot-&gt;info-&gt;latch_status
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|get_adapter_status
id|get_adapter_status
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
id|hotplug_slot
op_eq
l_int|NULL
op_logical_or
id|hotplug_slot-&gt;info
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
op_star
id|value
op_assign
id|hotplug_slot-&gt;info-&gt;adapter_status
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|release_slot
r_static
r_void
id|release_slot
c_func
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_struct
id|slot
op_star
id|slot
op_assign
id|get_slot
c_func
(paren
id|hotplug_slot
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
)brace
DECL|macro|SLOT_NAME_SIZE
mdefine_line|#define SLOT_NAME_SIZE&t;6
r_static
r_void
DECL|function|make_slot_name
id|make_slot_name
c_func
(paren
r_struct
id|slot
op_star
id|slot
)paren
(brace
id|snprintf
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;name
comma
id|SLOT_NAME_SIZE
comma
l_string|&quot;%02x:%02x&quot;
comma
id|slot-&gt;bus-&gt;number
comma
id|slot-&gt;number
)paren
suffix:semicolon
)brace
r_int
DECL|function|cpci_hp_register_bus
id|cpci_hp_register_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
id|u8
id|first
comma
id|u8
id|last
)paren
(brace
r_struct
id|slot
op_star
id|slot
suffix:semicolon
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
suffix:semicolon
r_struct
id|hotplug_slot_info
op_star
id|info
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|controller
op_logical_and
id|bus
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last
OL
id|first
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Create a structure for each slot, and register that slot&n;&t; * with the pci_hotplug subsystem.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|first
suffix:semicolon
id|i
op_le
id|last
suffix:semicolon
op_increment
id|i
)paren
(brace
id|slot
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|slot
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|hotplug_slot
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hotplug_slot
)paren
(brace
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hotplug_slot
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hotplug_slot
)paren
)paren
suffix:semicolon
id|slot-&gt;hotplug_slot
op_assign
id|hotplug_slot
suffix:semicolon
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|kfree
c_func
(paren
id|hotplug_slot
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
)paren
suffix:semicolon
id|hotplug_slot-&gt;info
op_assign
id|info
suffix:semicolon
id|name
op_assign
id|kmalloc
c_func
(paren
id|SLOT_NAME_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
)paren
(brace
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hotplug_slot
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|hotplug_slot-&gt;name
op_assign
id|name
suffix:semicolon
id|slot-&gt;magic
op_assign
id|SLOT_MAGIC
suffix:semicolon
id|slot-&gt;bus
op_assign
id|bus
suffix:semicolon
id|slot-&gt;number
op_assign
id|i
suffix:semicolon
id|slot-&gt;devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|i
comma
l_int|0
)paren
suffix:semicolon
id|hotplug_slot
op_member_access_from_pointer
r_private
op_assign
id|slot
suffix:semicolon
id|hotplug_slot-&gt;release
op_assign
op_amp
id|release_slot
suffix:semicolon
id|make_slot_name
c_func
(paren
id|slot
)paren
suffix:semicolon
id|hotplug_slot-&gt;ops
op_assign
op_amp
id|cpci_hotplug_slot_ops
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Initialize the slot info structure with some known&n;&t;&t; * good values.&n;&t;&t; */
id|dbg
c_func
(paren
l_string|&quot;initializing slot %s&quot;
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|info-&gt;power_status
op_assign
id|cpci_get_power_status
c_func
(paren
id|slot
)paren
suffix:semicolon
id|info-&gt;attention_status
op_assign
id|cpci_get_attention_status
c_func
(paren
id|slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;registering slot %s&quot;
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|status
op_assign
id|pci_hp_register
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|err
c_func
(paren
l_string|&quot;pci_hp_register failed with error %d&quot;
comma
id|status
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hotplug_slot
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Add slot to our internal list */
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|slot-&gt;slot_list
comma
op_amp
id|slot_list
)paren
suffix:semicolon
id|slots
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
r_int
DECL|function|cpci_hp_unregister_bus
id|cpci_hp_unregister_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_struct
id|slot
op_star
id|slot
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|next
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slots
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|next
comma
op_amp
id|slot_list
)paren
(brace
id|slot
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|slot
comma
id|slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;bus
op_eq
id|bus
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;deregistering slot %s&quot;
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|status
op_assign
id|pci_hp_deregister
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|err
c_func
(paren
l_string|&quot;pci_hp_deregister failed with error %d&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|slot-&gt;slot_list
)paren
suffix:semicolon
id|slots
op_decrement
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_struct
id|slot
op_star
DECL|function|cpci_find_slot
id|cpci_find_slot
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
)paren
(brace
r_struct
id|slot
op_star
id|slot
suffix:semicolon
r_struct
id|slot
op_star
id|found
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slots
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|found
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|slot_list
)paren
(brace
id|slot
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|slot
comma
id|slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;bus
op_eq
id|bus
op_logical_and
id|slot-&gt;devfn
op_eq
id|devfn
)paren
(brace
id|found
op_assign
id|slot
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
multiline_comment|/* This is the interrupt mode interrupt handler */
id|irqreturn_t
DECL|function|cpci_hp_intr
id|cpci_hp_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;entered cpci_hp_intr&quot;
)paren
suffix:semicolon
multiline_comment|/* Check to see if it was our interrupt */
r_if
c_cond
(paren
(paren
id|controller-&gt;irq_flags
op_amp
id|SA_SHIRQ
)paren
op_logical_and
op_logical_neg
id|controller-&gt;ops
op_member_access_from_pointer
id|check_irq
c_func
(paren
id|controller-&gt;dev_id
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;exited cpci_hp_intr, not our interrupt&quot;
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/* Disable ENUM interrupt */
id|controller-&gt;ops
op_member_access_from_pointer
id|disable_irq
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Trigger processing by the event thread */
id|dbg
c_func
(paren
l_string|&quot;Signal event_semaphore&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|event_semaphore
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;exited cpci_hp_intr&quot;
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * According to PICMG 2.12 R2.0, section 6.3.2, upon&n; * initialization, the system driver shall clear the&n; * INS bits of the cold-inserted devices.&n; */
r_static
r_int
DECL|function|init_slots
id|init_slots
c_func
(paren
r_void
)paren
(brace
r_struct
id|slot
op_star
id|slot
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slots
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|slot_list
)paren
(brace
id|slot
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|slot
comma
id|slot_list
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - looking at slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpci_check_and_clear_ins
c_func
(paren
id|slot
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - cleared INS for slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|slot-&gt;bus-&gt;number
comma
id|PCI_DEVFN
c_func
(paren
id|slot-&gt;number
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_if
c_cond
(paren
id|update_adapter_status
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|1
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;failure to update adapter file&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|update_latch_status
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|1
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;failure to update latch file&quot;
)paren
suffix:semicolon
)brace
id|slot-&gt;dev
op_assign
id|dev
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;%s - no driver attached to device in slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|check_slots
id|check_slots
c_func
(paren
r_void
)paren
(brace
r_struct
id|slot
op_star
id|slot
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_int
id|extracted
suffix:semicolon
r_int
id|inserted
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slots
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;no slots registered, shutting down&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|extracted
op_assign
id|inserted
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|slot_list
)paren
(brace
id|slot
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|slot
comma
id|slot_list
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - looking at slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpci_check_and_clear_ins
c_func
(paren
id|slot
)paren
)paren
(brace
id|u16
id|hs_csr
suffix:semicolon
multiline_comment|/* Some broken hardware (e.g. PLX 9054AB) asserts ENUM# twice... */
r_if
c_cond
(paren
id|slot-&gt;dev
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;slot %s already inserted&quot;
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|inserted
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Process insertion */
id|dbg
c_func
(paren
l_string|&quot;%s - slot %s inserted&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
multiline_comment|/* GSM, debug */
id|hs_csr
op_assign
id|cpci_get_hs_csr
c_func
(paren
id|slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - slot %s HS_CSR (1) = %04x&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
comma
id|hs_csr
)paren
suffix:semicolon
multiline_comment|/* Configure device */
id|dbg
c_func
(paren
l_string|&quot;%s - configuring slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpci_configure_slot
c_func
(paren
id|slot
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - could not configure slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - finished configuring slot %s&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
multiline_comment|/* GSM, debug */
id|hs_csr
op_assign
id|cpci_get_hs_csr
c_func
(paren
id|slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - slot %s HS_CSR (2) = %04x&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
comma
id|hs_csr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|update_latch_status
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|1
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;failure to update latch file&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|update_adapter_status
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|1
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;failure to update adapter file&quot;
)paren
suffix:semicolon
)brace
id|cpci_led_off
c_func
(paren
id|slot
)paren
suffix:semicolon
multiline_comment|/* GSM, debug */
id|hs_csr
op_assign
id|cpci_get_hs_csr
c_func
(paren
id|slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - slot %s HS_CSR (3) = %04x&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
comma
id|hs_csr
)paren
suffix:semicolon
id|inserted
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cpci_check_ext
c_func
(paren
id|slot
)paren
)paren
(brace
id|u16
id|hs_csr
suffix:semicolon
multiline_comment|/* Process extraction request */
id|dbg
c_func
(paren
l_string|&quot;%s - slot %s extracted&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
multiline_comment|/* GSM, debug */
id|hs_csr
op_assign
id|cpci_get_hs_csr
c_func
(paren
id|slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - slot %s HS_CSR = %04x&quot;
comma
id|__FUNCTION__
comma
id|slot-&gt;hotplug_slot-&gt;name
comma
id|hs_csr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;extracting
)paren
(brace
r_if
c_cond
(paren
id|update_latch_status
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|0
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;failure to update latch file&quot;
)paren
suffix:semicolon
)brace
id|slot-&gt;extracting
op_assign
l_int|1
suffix:semicolon
)brace
id|extracted
op_increment
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inserted
op_logical_or
id|extracted
)paren
(brace
r_return
id|extracted
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;cannot find ENUM# source, shutting down&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* This is the interrupt mode worker thread body */
r_static
r_int
DECL|function|event_thread
id|event_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|slot
op_star
id|slot
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;cpci_hp_eventd&quot;
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - event thread started&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;event thread sleeping&quot;
)paren
suffix:semicolon
id|down_interruptible
c_func
(paren
op_amp
id|event_semaphore
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;event thread woken, thread_finished = %d&quot;
comma
id|thread_finished
)paren
suffix:semicolon
r_if
c_cond
(paren
id|thread_finished
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|controller-&gt;ops
op_member_access_from_pointer
id|query_enum
c_func
(paren
)paren
)paren
(brace
id|rc
op_assign
id|check_slots
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|0
)paren
(brace
multiline_comment|/* Give userspace a chance to handle extraction */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - error checking slots&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|thread_finished
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for someone yanking out a board */
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|slot_list
)paren
(brace
id|slot
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|slot
comma
id|slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;extracting
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Hmmm, we&squot;re likely hosed at this point, should we&n;&t;&t;&t;&t; * bother trying to tell the driver or not?&n;&t;&t;&t;&t; */
id|err
c_func
(paren
l_string|&quot;card in slot %s was improperly removed&quot;
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|update_adapter_status
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|0
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;failure to update adapter file&quot;
)paren
suffix:semicolon
)brace
id|slot-&gt;extracting
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Re-enable ENUM# interrupt */
id|dbg
c_func
(paren
l_string|&quot;%s - re-enabling irq&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|controller-&gt;ops
op_member_access_from_pointer
id|enable_irq
c_func
(paren
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - event thread signals exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|thread_exit
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is the polling mode worker thread body */
r_static
r_int
DECL|function|poll_thread
id|poll_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|slot
op_star
id|slot
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;cpci_hp_polld&quot;
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|thread_finished
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|controller-&gt;ops
op_member_access_from_pointer
id|query_enum
c_func
(paren
)paren
)paren
(brace
id|rc
op_assign
id|check_slots
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|0
)paren
(brace
multiline_comment|/* Give userspace a chance to handle extraction */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - error checking slots&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|thread_finished
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for someone yanking out a board */
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|slot_list
)paren
(brace
id|slot
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|slot
comma
id|slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;extracting
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Hmmm, we&squot;re likely hosed at this point, should we&n;&t;&t;&t;&t; * bother trying to tell the driver or not?&n;&t;&t;&t;&t; */
id|err
c_func
(paren
l_string|&quot;card in slot %s was improperly removed&quot;
comma
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|update_adapter_status
c_func
(paren
id|slot-&gt;hotplug_slot
comma
l_int|0
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;failure to update adapter file&quot;
)paren
suffix:semicolon
)brace
id|slot-&gt;extracting
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;poll thread signals exit&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|thread_exit
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|cpci_start_thread
id|cpci_start_thread
c_func
(paren
r_void
)paren
(brace
r_int
id|pid
suffix:semicolon
multiline_comment|/* initialize our semaphores */
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|event_semaphore
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|thread_exit
)paren
suffix:semicolon
id|thread_finished
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|controller-&gt;irq
)paren
(brace
id|pid
op_assign
id|kernel_thread
c_func
(paren
id|event_thread
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|pid
op_assign
id|kernel_thread
c_func
(paren
id|poll_thread
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pid
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t start up our thread&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Our thread pid = %d&quot;
comma
id|pid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|cpci_stop_thread
id|cpci_stop_thread
c_func
(paren
r_void
)paren
(brace
id|thread_finished
op_assign
l_int|1
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;thread finish command given&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller-&gt;irq
)paren
(brace
id|up
c_func
(paren
op_amp
id|event_semaphore
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;wait for thread to exit&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|thread_exit
)paren
suffix:semicolon
)brace
r_int
DECL|function|cpci_hp_register_controller
id|cpci_hp_register_controller
c_func
(paren
r_struct
id|cpci_hp_controller
op_star
id|new_controller
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
(brace
id|controller
op_assign
id|new_controller
suffix:semicolon
r_if
c_cond
(paren
id|controller-&gt;irq
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|controller-&gt;irq
comma
id|cpci_hp_intr
comma
id|controller-&gt;irq_flags
comma
id|MY_NAME
comma
id|controller-&gt;dev_id
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t get irq %d for the hotplug cPCI controller&quot;
comma
id|controller-&gt;irq
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - acquired controller irq %d&quot;
comma
id|__FUNCTION__
comma
id|controller-&gt;irq
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;cPCI hotplug controller already registered&quot;
)paren
suffix:semicolon
id|status
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
r_int
DECL|function|cpci_hp_unregister_controller
id|cpci_hp_unregister_controller
c_func
(paren
r_struct
id|cpci_hp_controller
op_star
id|old_controller
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|controller
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|thread_finished
)paren
(brace
id|cpci_stop_thread
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|controller-&gt;irq
)paren
(brace
id|free_irq
c_func
(paren
id|controller-&gt;irq
comma
id|controller-&gt;dev_id
)paren
suffix:semicolon
)brace
id|controller
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
r_int
DECL|function|cpci_hp_start
id|cpci_hp_start
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - enter&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slots
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first
)paren
(brace
id|status
op_assign
id|init_slots
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
r_return
id|status
suffix:semicolon
)brace
id|first
op_assign
l_int|0
suffix:semicolon
)brace
id|status
op_assign
id|cpci_start_thread
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
r_return
id|status
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - thread started&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller-&gt;irq
)paren
(brace
multiline_comment|/* Start enum interrupt processing */
id|dbg
c_func
(paren
l_string|&quot;%s - enabling irq&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|controller-&gt;ops
op_member_access_from_pointer
id|enable_irq
c_func
(paren
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|cpci_hp_stop
id|cpci_hp_stop
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|controller-&gt;irq
)paren
(brace
multiline_comment|/* Stop enum interrupt processing */
id|dbg
c_func
(paren
l_string|&quot;%s - disabling irq&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|controller-&gt;ops
op_member_access_from_pointer
id|disable_irq
c_func
(paren
)paren
suffix:semicolon
)brace
id|cpci_stop_thread
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|cleanup_slots
id|cleanup_slots
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|slot
op_star
id|slot
suffix:semicolon
multiline_comment|/*&n;&t; * Unregister all of our slots with the pci_hotplug subsystem,&n;&t; * and free up all memory that we had allocated.&n;&t; */
id|spin_lock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slots
)paren
(brace
r_goto
id|null_cleanup
suffix:semicolon
)brace
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|slot_list
)paren
(brace
id|slot
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|slot
comma
id|slot_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|slot-&gt;slot_list
)paren
suffix:semicolon
id|pci_hp_deregister
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot-&gt;hotplug_slot
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|slot
)paren
suffix:semicolon
)brace
id|null_cleanup
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_int
id|__init
DECL|function|cpci_hotplug_init
id|cpci_hotplug_init
c_func
(paren
r_int
id|debug
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|list_lock
)paren
suffix:semicolon
id|cpci_debug
op_assign
id|debug
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; version: &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
id|__exit
DECL|function|cpci_hotplug_exit
id|cpci_hotplug_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Clean everything up.&n;&t; */
id|cleanup_slots
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|cpci_hp_register_controller
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cpci_hp_register_controller
)paren
suffix:semicolon
DECL|variable|cpci_hp_unregister_controller
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cpci_hp_unregister_controller
)paren
suffix:semicolon
DECL|variable|cpci_hp_register_bus
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cpci_hp_register_bus
)paren
suffix:semicolon
DECL|variable|cpci_hp_unregister_bus
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cpci_hp_unregister_bus
)paren
suffix:semicolon
DECL|variable|cpci_find_slot
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cpci_find_slot
)paren
suffix:semicolon
DECL|variable|cpci_hp_start
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cpci_hp_start
)paren
suffix:semicolon
DECL|variable|cpci_hp_stop
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cpci_hp_stop
)paren
suffix:semicolon
eof
