multiline_comment|/*&n; * PCIEHPRM NONACPI: PHP Resource Manager for Non-ACPI/Legacy platform&n; *&n; * Copyright (C) 1995,2001 Compaq Computer Corporation&n; * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (C) 2001 IBM Corp.&n; * Copyright (C) 2003-2004 Intel Corporation&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;greg@kroah.com&gt;, &lt;dely.l.sy@intel.com&gt;&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifdef CONFIG_IA64
macro_line|#include &lt;asm/iosapic.h&gt;
macro_line|#endif
macro_line|#include &quot;pciehp.h&quot;
macro_line|#include &quot;pciehprm.h&quot;
macro_line|#include &quot;pciehprm_nonacpi.h&quot;
DECL|function|pciehprm_cleanup
r_void
id|pciehprm_cleanup
c_func
(paren
r_void
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|pciehprm_print_pirt
r_int
id|pciehprm_print_pirt
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pciehprm_get_physical_slot_number
r_int
id|pciehprm_get_physical_slot_number
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
id|u32
op_star
id|sun
comma
id|u8
id|busnum
comma
id|u8
id|devnum
)paren
(brace
op_star
id|sun
op_assign
(paren
id|u8
)paren
(paren
id|ctrl-&gt;first_slot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|print_pci_resource
r_static
r_void
id|print_pci_resource
(paren
r_struct
id|pci_resource
op_star
id|aprh
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
id|aprh
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
id|dbg
c_func
(paren
l_string|&quot;        base= 0x%x length= 0x%x&bslash;n&quot;
comma
id|res-&gt;base
comma
id|res-&gt;length
)paren
suffix:semicolon
)brace
DECL|function|phprm_dump_func_res
r_static
r_void
id|phprm_dump_func_res
c_func
(paren
r_struct
id|pci_func
op_star
id|fun
)paren
(brace
r_struct
id|pci_func
op_star
id|func
op_assign
id|fun
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;bus_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    BUS Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|func-&gt;bus_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func-&gt;io_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    IO Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|func-&gt;io_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func-&gt;mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    MEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|func-&gt;mem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func-&gt;p_mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    PMEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|func-&gt;p_mem_head
)paren
suffix:semicolon
)brace
)brace
DECL|function|phprm_get_used_resources
r_static
r_int
id|phprm_get_used_resources
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_return
id|pciehp_save_used_resources
(paren
id|ctrl
comma
id|func
comma
op_logical_neg
id|DISABLE_CARD
)paren
suffix:semicolon
)brace
DECL|function|phprm_delete_resource
r_static
r_int
id|phprm_delete_resource
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|aprh
comma
id|ulong
id|base
comma
id|ulong
id|size
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_struct
id|pci_resource
op_star
id|prevnode
suffix:semicolon
r_struct
id|pci_resource
op_star
id|split_node
suffix:semicolon
id|ulong
id|tbase
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
id|aprh
)paren
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
op_star
id|aprh
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;base
OG
id|base
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;base
op_plus
id|res-&gt;length
)paren
OL
(paren
id|base
op_plus
id|size
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;base
OL
id|base
)paren
(brace
id|tbase
op_assign
id|base
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;length
op_minus
(paren
id|tbase
op_minus
id|res-&gt;base
)paren
)paren
OL
id|size
)paren
r_continue
suffix:semicolon
id|split_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|split_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|split_node-&gt;base
op_assign
id|res-&gt;base
suffix:semicolon
id|split_node-&gt;length
op_assign
id|tbase
op_minus
id|res-&gt;base
suffix:semicolon
id|res-&gt;base
op_assign
id|tbase
suffix:semicolon
id|res-&gt;length
op_sub_assign
id|split_node-&gt;length
suffix:semicolon
id|split_node-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
id|res-&gt;next
op_assign
id|split_node
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res-&gt;length
op_ge
id|size
)paren
(brace
id|split_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|split_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|split_node-&gt;base
op_assign
id|res-&gt;base
op_plus
id|size
suffix:semicolon
id|split_node-&gt;length
op_assign
id|res-&gt;length
op_minus
id|size
suffix:semicolon
id|res-&gt;length
op_assign
id|size
suffix:semicolon
id|split_node-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
id|res-&gt;next
op_assign
id|split_node
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|aprh
op_eq
id|res
)paren
(brace
op_star
id|aprh
op_assign
id|res-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|prevnode
op_assign
op_star
id|aprh
suffix:semicolon
r_while
c_loop
(paren
id|prevnode-&gt;next
op_ne
id|res
)paren
id|prevnode
op_assign
id|prevnode-&gt;next
suffix:semicolon
id|prevnode-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
)brace
id|res-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|phprm_delete_resources
r_static
r_int
id|phprm_delete_resources
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|aprh
comma
r_struct
id|pci_resource
op_star
id|this
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
id|this
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
id|phprm_delete_resource
c_func
(paren
id|aprh
comma
id|res-&gt;base
comma
id|res-&gt;length
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|configure_existing_function
r_static
r_int
id|configure_existing_function
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/* see how much resources the func has used. */
id|rc
op_assign
id|phprm_get_used_resources
(paren
id|ctrl
comma
id|func
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
multiline_comment|/* subtract the resources used by the func from ctrl resources */
id|rc
op_assign
id|phprm_delete_resources
(paren
op_amp
id|ctrl-&gt;bus_head
comma
id|func-&gt;bus_head
)paren
suffix:semicolon
id|rc
op_or_assign
id|phprm_delete_resources
(paren
op_amp
id|ctrl-&gt;io_head
comma
id|func-&gt;io_head
)paren
suffix:semicolon
id|rc
op_or_assign
id|phprm_delete_resources
(paren
op_amp
id|ctrl-&gt;mem_head
comma
id|func-&gt;mem_head
)paren
suffix:semicolon
id|rc
op_or_assign
id|phprm_delete_resources
(paren
op_amp
id|ctrl-&gt;p_mem_head
comma
id|func-&gt;p_mem_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|warn
c_func
(paren
l_string|&quot;aCEF: cannot del used resources&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|err
c_func
(paren
l_string|&quot;aCEF: cannot get used resources&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|pciehprm_delete_resource
r_static
r_int
id|pciehprm_delete_resource
c_func
(paren
r_struct
id|pci_resource
op_star
op_star
id|aprh
comma
id|ulong
id|base
comma
id|ulong
id|size
)paren
(brace
r_struct
id|pci_resource
op_star
id|res
suffix:semicolon
r_struct
id|pci_resource
op_star
id|prevnode
suffix:semicolon
r_struct
id|pci_resource
op_star
id|split_node
suffix:semicolon
id|ulong
id|tbase
suffix:semicolon
id|pciehp_resource_sort_and_combine
c_func
(paren
id|aprh
)paren
suffix:semicolon
r_for
c_loop
(paren
id|res
op_assign
op_star
id|aprh
suffix:semicolon
id|res
suffix:semicolon
id|res
op_assign
id|res-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;base
OG
id|base
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;base
op_plus
id|res-&gt;length
)paren
OL
(paren
id|base
op_plus
id|size
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;base
OL
id|base
)paren
(brace
id|tbase
op_assign
id|base
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;length
op_minus
(paren
id|tbase
op_minus
id|res-&gt;base
)paren
)paren
OL
id|size
)paren
r_continue
suffix:semicolon
id|split_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|split_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|split_node-&gt;base
op_assign
id|res-&gt;base
suffix:semicolon
id|split_node-&gt;length
op_assign
id|tbase
op_minus
id|res-&gt;base
suffix:semicolon
id|res-&gt;base
op_assign
id|tbase
suffix:semicolon
id|res-&gt;length
op_sub_assign
id|split_node-&gt;length
suffix:semicolon
id|split_node-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
id|res-&gt;next
op_assign
id|split_node
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res-&gt;length
op_ge
id|size
)paren
(brace
id|split_node
op_assign
(paren
r_struct
id|pci_resource
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|split_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|split_node-&gt;base
op_assign
id|res-&gt;base
op_plus
id|size
suffix:semicolon
id|split_node-&gt;length
op_assign
id|res-&gt;length
op_minus
id|size
suffix:semicolon
id|res-&gt;length
op_assign
id|size
suffix:semicolon
id|split_node-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
id|res-&gt;next
op_assign
id|split_node
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|aprh
op_eq
id|res
)paren
(brace
op_star
id|aprh
op_assign
id|res-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|prevnode
op_assign
op_star
id|aprh
suffix:semicolon
r_while
c_loop
(paren
id|prevnode-&gt;next
op_ne
id|res
)paren
id|prevnode
op_assign
id|prevnode-&gt;next
suffix:semicolon
id|prevnode-&gt;next
op_assign
id|res-&gt;next
suffix:semicolon
)brace
id|res-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bind_pci_resources_to_slots
r_static
r_int
id|bind_pci_resources_to_slots
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|pci_func
op_star
id|func
suffix:semicolon
r_int
id|busn
op_assign
id|ctrl-&gt;slot_bus
suffix:semicolon
r_int
id|devn
comma
id|funn
suffix:semicolon
id|u32
id|vid
suffix:semicolon
r_for
c_loop
(paren
id|devn
op_assign
l_int|0
suffix:semicolon
id|devn
OL
l_int|32
suffix:semicolon
id|devn
op_increment
)paren
(brace
r_for
c_loop
(paren
id|funn
op_assign
l_int|0
suffix:semicolon
id|funn
OL
l_int|8
suffix:semicolon
id|funn
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;if (devn == ctrl-&gt;device &amp;&amp; funn == ctrl-&gt;function)&n;&t;&t;&t;&t;continue;&n;&t;&t;&t;*/
multiline_comment|/* find out if this entry is for an occupied slot */
id|vid
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|pci_bus_read_config_dword
c_func
(paren
id|ctrl-&gt;pci_dev-&gt;subordinate
comma
id|PCI_DEVFN
c_func
(paren
id|devn
comma
id|funn
)paren
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vid
op_ne
l_int|0xFFFFFFFF
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: vid = %x bus %x dev %x fun %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|vid
comma
id|busn
comma
id|devn
comma
id|funn
)paren
suffix:semicolon
id|func
op_assign
id|pciehp_slot_find
c_func
(paren
id|busn
comma
id|devn
comma
id|funn
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: func = %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|func
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|func
)paren
r_continue
suffix:semicolon
id|configure_existing_function
c_func
(paren
id|ctrl
comma
id|func
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;aCCF:existing PCI 0x%x Func ResourceDump&bslash;n&quot;
comma
id|ctrl-&gt;bus
)paren
suffix:semicolon
id|phprm_dump_func_res
c_func
(paren
id|func
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|phprm_dump_ctrl_res
r_static
r_void
id|phprm_dump_ctrl_res
c_func
(paren
r_struct
id|controller
op_star
id|ctlr
)paren
(brace
r_struct
id|controller
op_star
id|ctrl
op_assign
id|ctlr
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;bus_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    BUS Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ctrl-&gt;bus_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl-&gt;io_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    IO Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ctrl-&gt;io_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl-&gt;mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    MEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ctrl-&gt;mem_head
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl-&gt;p_mem_head
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;:    PMEM Resources:&bslash;n&quot;
)paren
suffix:semicolon
id|print_pci_resource
(paren
id|ctrl-&gt;p_mem_head
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * phprm_find_available_resources&n; *&n; *  Finds available memory, IO, and IRQ resources for programming&n; *  devices which may be added to the system&n; *  this function is for hot plug ADD!&n; *&n; * returns 0 if success&n; */
DECL|function|pciehprm_find_available_resources
r_int
id|pciehprm_find_available_resources
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|pci_func
id|func
suffix:semicolon
id|u32
id|rc
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|func
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|func.bus
op_assign
id|ctrl-&gt;bus
suffix:semicolon
id|func.device
op_assign
id|ctrl-&gt;device
suffix:semicolon
id|func.function
op_assign
id|ctrl-&gt;function
suffix:semicolon
id|func.is_a_board
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Get resources for this PCI bridge */
id|rc
op_assign
id|pciehp_save_used_resources
(paren
id|ctrl
comma
op_amp
id|func
comma
op_logical_neg
id|DISABLE_CARD
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: pciehp_save_used_resources rc = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func.mem_head
)paren
id|func.mem_head-&gt;next
op_assign
id|ctrl-&gt;mem_head
suffix:semicolon
id|ctrl-&gt;mem_head
op_assign
id|func.mem_head
suffix:semicolon
r_if
c_cond
(paren
id|func.p_mem_head
)paren
id|func.p_mem_head-&gt;next
op_assign
id|ctrl-&gt;p_mem_head
suffix:semicolon
id|ctrl-&gt;p_mem_head
op_assign
id|func.p_mem_head
suffix:semicolon
r_if
c_cond
(paren
id|func.io_head
)paren
id|func.io_head-&gt;next
op_assign
id|ctrl-&gt;io_head
suffix:semicolon
id|ctrl-&gt;io_head
op_assign
id|func.io_head
suffix:semicolon
r_if
c_cond
(paren
id|func.bus_head
)paren
(brace
id|func.bus_head-&gt;next
op_assign
id|ctrl-&gt;bus_head
suffix:semicolon
)brace
id|ctrl-&gt;bus_head
op_assign
id|func.bus_head
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;bus_head
)paren
id|pciehprm_delete_resource
c_func
(paren
op_amp
id|ctrl-&gt;bus_head
comma
id|ctrl-&gt;pci_dev-&gt;subordinate-&gt;number
comma
l_int|1
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s:pre-Bind PCI 0x%x Ctrl Resource Dump&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ctrl-&gt;bus
)paren
suffix:semicolon
id|phprm_dump_ctrl_res
c_func
(paren
id|ctrl
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: before bind_pci_resources_to slots&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|bind_pci_resources_to_slots
(paren
id|ctrl
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s:post-Bind PCI 0x%x Ctrl Resource Dump&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ctrl-&gt;bus
)paren
suffix:semicolon
id|phprm_dump_ctrl_res
c_func
(paren
id|ctrl
)paren
suffix:semicolon
r_return
(paren
id|rc
)paren
suffix:semicolon
)brace
DECL|function|pciehprm_set_hpp
r_int
id|pciehprm_set_hpp
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
comma
id|u8
id|card_type
)paren
(brace
id|u32
id|rc
suffix:semicolon
id|u8
id|temp_byte
suffix:semicolon
r_struct
id|pci_bus
id|lpci_bus
comma
op_star
id|pci_bus
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|lpci_bus
comma
id|ctrl-&gt;pci_bus
comma
r_sizeof
(paren
id|lpci_bus
)paren
)paren
suffix:semicolon
id|pci_bus
op_assign
op_amp
id|lpci_bus
suffix:semicolon
id|pci_bus-&gt;number
op_assign
id|func-&gt;bus
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|temp_byte
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* hard coded value for LT */
r_if
c_cond
(paren
id|card_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
multiline_comment|/* set subordinate Latency Timer */
id|rc
op_assign
id|pci_bus_write_config_byte
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_SEC_LATENCY_TIMER
comma
id|temp_byte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: set secondary LT error. b:d:f(%02x:%02x:%02x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
multiline_comment|/* set base Latency Timer */
id|rc
op_assign
id|pci_bus_write_config_byte
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_LATENCY_TIMER
comma
id|temp_byte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: set LT error. b:d:f(%02x:%02x:%02x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* set Cache Line size */
id|temp_byte
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* hard coded value for CLS */
id|rc
op_assign
id|pci_bus_write_config_byte
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_CACHE_LINE_SIZE
comma
id|temp_byte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: set CLS error. b:d:f(%02x:%02x:%02x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|func-&gt;bus
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
)brace
multiline_comment|/* set enable_perr */
multiline_comment|/* set enable_serr */
r_return
id|rc
suffix:semicolon
)brace
DECL|function|pciehprm_enable_card
r_void
id|pciehprm_enable_card
c_func
(paren
r_struct
id|controller
op_star
id|ctrl
comma
r_struct
id|pci_func
op_star
id|func
comma
id|u8
id|card_type
)paren
(brace
id|u16
id|command
comma
id|bcommand
suffix:semicolon
r_struct
id|pci_bus
id|lpci_bus
comma
op_star
id|pci_bus
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|lpci_bus
comma
id|ctrl-&gt;pci_bus
comma
r_sizeof
(paren
id|lpci_bus
)paren
)paren
suffix:semicolon
id|pci_bus
op_assign
op_amp
id|lpci_bus
suffix:semicolon
id|pci_bus-&gt;number
op_assign
id|func-&gt;bus
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|rc
op_assign
id|pci_bus_read_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_or_assign
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_SERR
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_INVALIDATE
op_or
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
suffix:semicolon
id|rc
op_assign
id|pci_bus_write_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
id|rc
op_assign
id|pci_bus_read_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_BRIDGE_CONTROL
comma
op_amp
id|bcommand
)paren
suffix:semicolon
id|bcommand
op_or_assign
id|PCI_BRIDGE_CTL_PARITY
op_or
id|PCI_BRIDGE_CTL_SERR
op_or
id|PCI_BRIDGE_CTL_NO_ISA
suffix:semicolon
id|rc
op_assign
id|pci_bus_write_config_word
c_func
(paren
id|pci_bus
comma
id|devfn
comma
id|PCI_BRIDGE_CONTROL
comma
id|bcommand
)paren
suffix:semicolon
)brace
)brace
DECL|function|legacy_pciehprm_init_pci
r_static
r_int
id|legacy_pciehprm_init_pci
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pciehprm_init
r_int
id|pciehprm_init
c_func
(paren
r_enum
id|php_ctlr_type
id|ctrl_type
)paren
(brace
r_int
id|retval
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl_type
)paren
(brace
r_case
id|PCI
suffix:colon
id|retval
op_assign
id|legacy_pciehprm_init_pci
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
eof
