multiline_comment|/*&n; * linux/drivers/pci/pci-sysfs-dynids.c&n; *  Copyright (C) 2003 Dell Computer Corporation&n; *  by Matt Domsch &lt;Matt_Domsch@dell.com&gt;&n; *&n; * sysfs interface for exporting dynamic device IDs&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/sysfs.h&gt;
macro_line|#include &lt;linux/pci-dynids.h&gt;
macro_line|#include &quot;pci.h&quot;
multiline_comment|/**&n; *&t;dynid_create_file - create sysfs file for a dynamic ID&n; *&t;@pdrv:&t;pci_driver&n; *&t;@dattr:&t;the attribute to create&n; */
DECL|function|dynid_create_file
r_static
r_int
id|dynid_create_file
c_func
(paren
r_struct
id|pci_driver
op_star
id|pdrv
comma
r_struct
id|dynid_attribute
op_star
id|dattr
)paren
(brace
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|get_driver
c_func
(paren
op_amp
id|pdrv-&gt;driver
)paren
)paren
(brace
id|error
op_assign
id|sysfs_create_file
c_func
(paren
op_amp
id|pdrv-&gt;dynids.kobj
comma
op_amp
id|dattr-&gt;attr
)paren
suffix:semicolon
id|put_driver
c_func
(paren
op_amp
id|pdrv-&gt;driver
)paren
suffix:semicolon
)brace
r_else
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;dynid_remove_file - remove sysfs file for a dynamic ID&n; *&t;@drv:&t;driver.&n; *&t;@id:&t;the id to to remove&n; */
DECL|function|dynid_remove_file
r_static
r_void
id|dynid_remove_file
c_func
(paren
r_struct
id|pci_driver
op_star
id|pdrv
comma
r_struct
id|dynid_attribute
op_star
id|dattr
)paren
(brace
r_if
c_cond
(paren
id|get_driver
c_func
(paren
op_amp
id|pdrv-&gt;driver
)paren
)paren
(brace
id|sysfs_remove_file
c_func
(paren
op_amp
id|pdrv-&gt;dynids.kobj
comma
op_amp
id|dattr-&gt;attr
)paren
suffix:semicolon
id|put_driver
c_func
(paren
op_amp
id|pdrv-&gt;driver
)paren
suffix:semicolon
)brace
)brace
DECL|macro|kobj_to_dynids
mdefine_line|#define kobj_to_dynids(obj) container_of(obj,struct pci_dynamic_id_kobj,kobj)
DECL|macro|dynids_to_pci_driver
mdefine_line|#define dynids_to_pci_driver(obj) container_of(obj,struct pci_driver,dynids)
DECL|macro|attr_to_dattr
mdefine_line|#define attr_to_dattr(_attr) container_of(_attr, struct dynid_attribute, attr)
r_static
r_inline
id|ssize_t
DECL|function|default_show_id
id|default_show_id
c_func
(paren
r_const
r_struct
id|pci_device_id
op_star
id|id
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%08x %08x %08x %08x %08x %08x&bslash;n&quot;
comma
id|id-&gt;vendor
comma
id|id-&gt;device
comma
id|id-&gt;subvendor
comma
id|id-&gt;subdevice
comma
id|id
op_member_access_from_pointer
r_class
comma
id|id-&gt;class_mask
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|dynid_show_id
id|dynid_show_id
c_func
(paren
r_struct
id|pci_driver
op_star
id|pdrv
comma
r_struct
id|dynid_attribute
op_star
id|dattr
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|pdrv-&gt;dynids.show_id
ques
c_cond
id|pdrv-&gt;dynids
dot
id|show_id
c_func
(paren
id|dattr-&gt;id
comma
id|dattr
comma
id|buf
)paren
suffix:colon
id|default_show_id
c_func
(paren
id|dattr-&gt;id
comma
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|default_show_new_id
id|default_show_new_id
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;echo vendor device subvendor subdevice class classmask&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;where each field is a 32-bit value in ABCD (hex) format (no leading 0x).&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Pass only as many fields as you need to override the defaults below.&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Default vendor, device, subvendor, and subdevice fields&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;are set to FFFFFFFF (PCI_ANY_ID).&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Default class and classmask fields are set to 0.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buf
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|__dattr_init
id|__dattr_init
c_func
(paren
r_struct
id|dynid_attribute
op_star
id|dattr
)paren
(brace
id|memset
c_func
(paren
id|dattr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dattr
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dattr-&gt;node
)paren
suffix:semicolon
id|dattr-&gt;attr.mode
op_assign
id|S_IRUGO
suffix:semicolon
id|dattr-&gt;attr.name
op_assign
id|dattr-&gt;name
suffix:semicolon
)brace
r_static
r_inline
id|ssize_t
DECL|function|default_store_new_id
id|default_store_new_id
c_func
(paren
r_struct
id|pci_driver
op_star
id|pdrv
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|dynid_attribute
op_star
id|dattr
suffix:semicolon
r_struct
id|pci_device_id
op_star
id|id
suffix:semicolon
id|__u32
id|vendor
op_assign
id|PCI_ANY_ID
comma
id|device
op_assign
id|PCI_ANY_ID
comma
id|subvendor
op_assign
id|PCI_ANY_ID
comma
id|subdevice
op_assign
id|PCI_ANY_ID
comma
r_class
op_assign
l_int|0
comma
id|class_mask
op_assign
l_int|0
suffix:semicolon
r_int
id|fields
op_assign
l_int|0
comma
id|error
op_assign
l_int|0
suffix:semicolon
id|fields
op_assign
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%x %x %x %x %x %x&quot;
comma
op_amp
id|vendor
comma
op_amp
id|device
comma
op_amp
id|subvendor
comma
op_amp
id|subdevice
comma
op_amp
r_class
comma
op_amp
id|class_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fields
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dattr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dattr
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dattr
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|__dattr_init
c_func
(paren
id|dattr
)paren
suffix:semicolon
id|id
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|id
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|id
)paren
(brace
id|kfree
c_func
(paren
id|dattr
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dattr-&gt;id
op_assign
id|id
suffix:semicolon
id|dattr-&gt;show
op_assign
id|dynid_show_id
suffix:semicolon
id|id-&gt;vendor
op_assign
id|vendor
suffix:semicolon
id|id-&gt;device
op_assign
id|device
suffix:semicolon
id|id-&gt;subvendor
op_assign
id|subvendor
suffix:semicolon
id|id-&gt;subdevice
op_assign
id|subdevice
suffix:semicolon
id|id
op_member_access_from_pointer
r_class
op_assign
r_class
suffix:semicolon
id|id-&gt;class_mask
op_assign
id|class_mask
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pdrv-&gt;dynids.lock
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|dattr-&gt;name
comma
id|KOBJ_NAME_LEN
comma
l_string|&quot;%d&quot;
comma
id|pdrv-&gt;dynids.nextname
)paren
suffix:semicolon
id|pdrv-&gt;dynids.nextname
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pdrv-&gt;dynids.lock
)paren
suffix:semicolon
id|error
op_assign
id|dynid_create_file
c_func
(paren
id|pdrv
comma
id|dattr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|kfree
c_func
(paren
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dattr
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|pdrv-&gt;dynids.lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|pdrv-&gt;dynids.list
comma
op_amp
id|dattr-&gt;node
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pdrv-&gt;dynids.lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|dynid_show_new_id
id|dynid_show_new_id
c_func
(paren
r_struct
id|pci_driver
op_star
id|pdrv
comma
r_struct
id|dynid_attribute
op_star
id|unused
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|pdrv-&gt;dynids.show_new_id
ques
c_cond
id|pdrv-&gt;dynids
dot
id|show_new_id
c_func
(paren
id|pdrv
comma
id|buf
)paren
suffix:colon
id|default_show_new_id
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|dynid_store_new_id
id|dynid_store_new_id
c_func
(paren
r_struct
id|pci_driver
op_star
id|pdrv
comma
r_struct
id|dynid_attribute
op_star
id|unused
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_return
id|pdrv-&gt;dynids.store_new_id
ques
c_cond
id|pdrv-&gt;dynids
dot
id|store_new_id
c_func
(paren
id|pdrv
comma
id|buf
comma
id|count
)paren
suffix:colon
id|default_store_new_id
c_func
(paren
id|pdrv
comma
id|buf
comma
id|count
)paren
suffix:semicolon
)brace
DECL|macro|DYNID_ATTR
mdefine_line|#define DYNID_ATTR(_name,_mode,_show,_store) &bslash;&n;struct dynid_attribute dynid_attr_##_name = { &t;&t;&bslash;&n;&t;.attr = {.name = __stringify(_name), .mode = _mode },&t;&bslash;&n;        .id   = NULL,                                   &bslash;&n;&t;.show&t;= _show,&t;&t;&t;&t;&bslash;&n;&t;.store&t;= _store,&t;&t;&t;&t;&bslash;&n;}
r_static
id|DYNID_ATTR
c_func
(paren
id|new_id
comma
id|S_IRUSR
op_or
id|S_IWUSR
comma
id|dynid_show_new_id
comma
id|dynid_store_new_id
)paren
suffix:semicolon
DECL|variable|dynids_def_attrs
r_static
r_struct
id|attribute
op_star
id|dynids_def_attrs
(braket
)braket
op_assign
(brace
op_amp
id|dynid_attr_new_id.attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
r_static
id|ssize_t
DECL|function|dynid_show
id|dynid_show
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|pci_dynamic_id_kobj
op_star
id|dynid_kobj
op_assign
id|kobj_to_dynids
c_func
(paren
id|kobj
)paren
suffix:semicolon
r_struct
id|pci_driver
op_star
id|pdrv
op_assign
id|dynids_to_pci_driver
c_func
(paren
id|dynid_kobj
)paren
suffix:semicolon
r_struct
id|dynid_attribute
op_star
id|dattr
op_assign
id|attr_to_dattr
c_func
(paren
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dattr-&gt;show
)paren
r_return
id|dattr
op_member_access_from_pointer
id|show
c_func
(paren
id|pdrv
comma
id|dattr
comma
id|buf
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|dynid_store
id|dynid_store
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|pci_dynamic_id_kobj
op_star
id|dynid_kobj
op_assign
id|kobj_to_dynids
c_func
(paren
id|kobj
)paren
suffix:semicolon
r_struct
id|pci_driver
op_star
id|pdrv
op_assign
id|dynids_to_pci_driver
c_func
(paren
id|dynid_kobj
)paren
suffix:semicolon
r_struct
id|dynid_attribute
op_star
id|dattr
op_assign
id|attr_to_dattr
c_func
(paren
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dattr-&gt;store
)paren
r_return
id|dattr
op_member_access_from_pointer
id|store
c_func
(paren
id|pdrv
comma
id|dattr
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
r_static
r_void
DECL|function|dynids_release
id|dynids_release
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
)paren
(brace
r_struct
id|pci_dynamic_id_kobj
op_star
id|dynids
op_assign
id|kobj_to_dynids
c_func
(paren
id|kobj
)paren
suffix:semicolon
r_struct
id|pci_driver
op_star
id|pdrv
op_assign
id|dynids_to_pci_driver
c_func
(paren
id|dynids
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|pos
comma
op_star
id|n
suffix:semicolon
r_struct
id|dynid_attribute
op_star
id|dattr
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dynids-&gt;lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|pos
comma
id|n
comma
op_amp
id|dynids-&gt;list
)paren
(brace
id|dattr
op_assign
id|list_entry
c_func
(paren
id|pos
comma
r_struct
id|dynid_attribute
comma
id|node
)paren
suffix:semicolon
id|dynid_remove_file
c_func
(paren
id|pdrv
comma
id|dattr
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|dattr-&gt;node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dattr-&gt;id
)paren
id|kfree
c_func
(paren
id|dattr-&gt;id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dattr
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dynids-&gt;lock
)paren
suffix:semicolon
)brace
DECL|variable|dynids_attr_ops
r_static
r_struct
id|sysfs_ops
id|dynids_attr_ops
op_assign
(brace
dot
id|show
op_assign
id|dynid_show
comma
dot
id|store
op_assign
id|dynid_store
comma
)brace
suffix:semicolon
DECL|variable|dynids_kobj_type
r_static
r_struct
id|kobj_type
id|dynids_kobj_type
op_assign
(brace
dot
id|release
op_assign
id|dynids_release
comma
dot
id|sysfs_ops
op_assign
op_amp
id|dynids_attr_ops
comma
dot
id|default_attrs
op_assign
id|dynids_def_attrs
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * pci_register_dynids - initialize and register driver dynamic_ids kobject&n; * @driver - the device_driver structure&n; * @dynids - the dynamic ids structure&n; */
r_int
DECL|function|pci_register_dynids
id|pci_register_dynids
c_func
(paren
r_struct
id|pci_driver
op_star
id|drv
)paren
(brace
r_struct
id|device_driver
op_star
id|driver
op_assign
op_amp
id|drv-&gt;driver
suffix:semicolon
r_struct
id|pci_dynamic_id_kobj
op_star
id|dynids
op_assign
op_amp
id|drv-&gt;dynids
suffix:semicolon
r_if
c_cond
(paren
id|drv-&gt;probe
)paren
(brace
id|dynids-&gt;kobj.parent
op_assign
op_amp
id|driver-&gt;kobj
suffix:semicolon
id|dynids-&gt;kobj.ktype
op_assign
op_amp
id|dynids_kobj_type
suffix:semicolon
id|snprintf
c_func
(paren
id|dynids-&gt;kobj.name
comma
id|KOBJ_NAME_LEN
comma
l_string|&quot;dynamic_id&quot;
)paren
suffix:semicolon
r_return
id|kobject_register
c_func
(paren
op_amp
id|dynids-&gt;kobj
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
eof
