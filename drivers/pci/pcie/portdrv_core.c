multiline_comment|/*&n; * File:&t;portdrv_core.c&n; * Purpose:&t;PCI Express Port Bus Driver&squot;s Core Functions&n; *&n; * Copyright (C) 2004 Intel&n; * Copyright (C) Tom Long Nguyen (tom.l.nguyen@intel.com)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/pcieport_if.h&gt;
macro_line|#include &quot;portdrv.h&quot;
r_extern
r_int
id|pcie_mch_quirk
suffix:semicolon
multiline_comment|/* MSI-quirk Indicator */
DECL|function|pcie_port_probe_service
r_static
r_int
id|pcie_port_probe_service
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pcie_device
op_star
id|pciedev
suffix:semicolon
r_struct
id|pcie_port_service_driver
op_star
id|driver
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;driver
)paren
r_return
id|status
suffix:semicolon
id|driver
op_assign
id|to_service_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
op_logical_or
op_logical_neg
id|driver-&gt;probe
)paren
r_return
id|status
suffix:semicolon
id|pciedev
op_assign
id|to_pcie_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|status
op_assign
id|driver
op_member_access_from_pointer
id|probe
c_func
(paren
id|pciedev
comma
id|driver-&gt;id_table
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Load service driver %s on pcie device %s&bslash;n&quot;
comma
id|driver-&gt;name
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
id|get_device
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|pcie_port_remove_service
r_static
r_int
id|pcie_port_remove_service
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pcie_device
op_star
id|pciedev
suffix:semicolon
r_struct
id|pcie_port_service_driver
op_star
id|driver
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;driver
)paren
r_return
l_int|0
suffix:semicolon
id|pciedev
op_assign
id|to_pcie_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|driver
op_assign
id|to_service_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver
op_logical_and
id|driver-&gt;remove
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Unload service driver %s on pcie device %s&bslash;n&quot;
comma
id|driver-&gt;name
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
id|driver
op_member_access_from_pointer
id|remove
c_func
(paren
id|pciedev
)paren
suffix:semicolon
id|put_device
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcie_port_shutdown_service
r_static
r_void
id|pcie_port_shutdown_service
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
)brace
DECL|function|pcie_port_suspend_service
r_static
r_int
id|pcie_port_suspend_service
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_struct
id|pcie_device
op_star
id|pciedev
suffix:semicolon
r_struct
id|pcie_port_service_driver
op_star
id|driver
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;driver
)paren
r_return
l_int|0
suffix:semicolon
id|pciedev
op_assign
id|to_pcie_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|driver
op_assign
id|to_service_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver
op_logical_and
id|driver-&gt;suspend
)paren
id|driver
op_member_access_from_pointer
id|suspend
c_func
(paren
id|pciedev
comma
id|state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcie_port_resume_service
r_static
r_int
id|pcie_port_resume_service
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|pcie_device
op_star
id|pciedev
suffix:semicolon
r_struct
id|pcie_port_service_driver
op_star
id|driver
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;driver
)paren
r_return
l_int|0
suffix:semicolon
id|pciedev
op_assign
id|to_pcie_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|driver
op_assign
id|to_service_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver
op_logical_and
id|driver-&gt;resume
)paren
id|driver
op_member_access_from_pointer
id|resume
c_func
(paren
id|pciedev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * release_pcie_device&n; *&t;&n; *&t;Being invoked automatically when device is being removed &n; *&t;in response to device_unregister(dev) call.&n; *&t;Release all resources being claimed.&n; */
DECL|function|release_pcie_device
r_static
r_void
id|release_pcie_device
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Free Port Service[%s]&bslash;n&quot;
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|to_pcie_device
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|is_msi_quirked
r_static
r_int
id|is_msi_quirked
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|port_type
comma
id|quirk
op_assign
l_int|0
suffix:semicolon
id|u16
id|reg16
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|pci_find_capability
c_func
(paren
id|dev
comma
id|PCI_CAP_ID_EXP
)paren
op_plus
id|PCIE_CAPABILITIES_REG
comma
op_amp
id|reg16
)paren
suffix:semicolon
id|port_type
op_assign
(paren
id|reg16
op_rshift
l_int|4
)paren
op_amp
id|PORT_TYPE_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|port_type
)paren
(brace
r_case
id|PCIE_RC_PORT
suffix:colon
r_if
c_cond
(paren
id|pcie_mch_quirk
op_eq
l_int|1
)paren
id|quirk
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCIE_SW_UPSTREAM_PORT
suffix:colon
r_case
id|PCIE_SW_DOWNSTREAM_PORT
suffix:colon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|quirk
suffix:semicolon
)brace
DECL|function|assign_interrupt_mode
r_static
r_int
id|assign_interrupt_mode
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
op_star
id|vectors
comma
r_int
id|mask
)paren
(brace
r_int
id|i
comma
id|pos
comma
id|nvec
comma
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_int
id|interrupt_mode
op_assign
id|PCIE_PORT_INTx_MODE
suffix:semicolon
multiline_comment|/* Set INTx as default */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|nvec
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCIE_PORT_DEVICE_MAXSERVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|nvec
op_increment
suffix:semicolon
id|vectors
(braket
id|i
)braket
op_assign
id|dev-&gt;irq
suffix:semicolon
)brace
multiline_comment|/* Check MSI quirk */
r_if
c_cond
(paren
id|is_msi_quirked
c_func
(paren
id|dev
)paren
)paren
r_return
id|interrupt_mode
suffix:semicolon
multiline_comment|/* Select MSI-X over MSI if supported */
id|pos
op_assign
id|pci_find_capability
c_func
(paren
id|dev
comma
id|PCI_CAP_ID_MSIX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
(brace
r_struct
id|msix_entry
id|msix_entries
(braket
id|PCIE_PORT_DEVICE_MAXSERVICES
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|2
)brace
comma
(brace
l_int|0
comma
l_int|3
)brace
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s Found MSIX capability&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|pci_enable_msix
c_func
(paren
id|dev
comma
id|msix_entries
comma
id|nvec
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
r_int
id|j
op_assign
l_int|0
suffix:semicolon
id|interrupt_mode
op_assign
id|PCIE_PORT_MSIX_MODE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCIE_PORT_DEVICE_MAXSERVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|vectors
(braket
id|i
)braket
op_assign
id|msix_entries
(braket
id|j
op_increment
)braket
dot
id|vector
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|pos
op_assign
id|pci_find_capability
c_func
(paren
id|dev
comma
id|PCI_CAP_ID_MSI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s Found MSI capability&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|pci_enable_msi
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|interrupt_mode
op_assign
id|PCIE_PORT_MSI_MODE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCIE_PORT_DEVICE_MAXSERVICES
suffix:semicolon
id|i
op_increment
)paren
id|vectors
(braket
id|i
)braket
op_assign
id|dev-&gt;irq
suffix:semicolon
)brace
)brace
)brace
r_return
id|interrupt_mode
suffix:semicolon
)brace
DECL|function|get_port_device_capability
r_static
r_int
id|get_port_device_capability
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|services
op_assign
l_int|0
comma
id|pos
suffix:semicolon
id|u16
id|reg16
suffix:semicolon
id|u32
id|reg32
suffix:semicolon
id|pos
op_assign
id|pci_find_capability
c_func
(paren
id|dev
comma
id|PCI_CAP_ID_EXP
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|pos
op_plus
id|PCIE_CAPABILITIES_REG
comma
op_amp
id|reg16
)paren
suffix:semicolon
multiline_comment|/* Hot-Plug Capable */
r_if
c_cond
(paren
id|reg16
op_amp
id|PORT_TO_SLOT_MASK
)paren
(brace
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|pos
op_plus
id|PCIE_SLOT_CAPABILITIES_REG
comma
op_amp
id|reg32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg32
op_amp
id|SLOT_HP_CAPABLE_MASK
)paren
id|services
op_or_assign
id|PCIE_PORT_SERVICE_HP
suffix:semicolon
)brace
multiline_comment|/* PME Capable */
id|pos
op_assign
id|pci_find_capability
c_func
(paren
id|dev
comma
id|PCI_CAP_ID_PME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
)paren
id|services
op_or_assign
id|PCIE_PORT_SERVICE_PME
suffix:semicolon
id|pos
op_assign
id|PCI_CFG_SPACE_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|pos
)paren
(brace
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|pos
comma
op_amp
id|reg32
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reg32
op_amp
l_int|0xffff
)paren
(brace
r_case
id|PCI_EXT_CAP_ID_ERR
suffix:colon
id|services
op_or_assign
id|PCIE_PORT_SERVICE_AER
suffix:semicolon
id|pos
op_assign
id|reg32
op_rshift
l_int|20
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_EXT_CAP_ID_VC
suffix:colon
id|services
op_or_assign
id|PCIE_PORT_SERVICE_VC
suffix:semicolon
id|pos
op_assign
id|reg32
op_rshift
l_int|20
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pos
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|services
suffix:semicolon
)brace
DECL|function|pcie_device_init
r_static
r_void
id|pcie_device_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|parent
comma
r_struct
id|pcie_device
op_star
id|dev
comma
r_int
id|port_type
comma
r_int
id|service_type
comma
r_int
id|irq
comma
r_int
id|irq_mode
)paren
(brace
r_struct
id|device
op_star
id|device
suffix:semicolon
id|dev-&gt;port
op_assign
id|parent
suffix:semicolon
id|dev-&gt;interrupt_mode
op_assign
id|irq_mode
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|dev-&gt;id.vendor
op_assign
id|parent-&gt;vendor
suffix:semicolon
id|dev-&gt;id.device
op_assign
id|parent-&gt;device
suffix:semicolon
id|dev-&gt;id.port_type
op_assign
id|port_type
suffix:semicolon
id|dev-&gt;id.service_type
op_assign
(paren
l_int|1
op_lshift
id|service_type
)paren
suffix:semicolon
multiline_comment|/* Initialize generic device interface */
id|device
op_assign
op_amp
id|dev-&gt;device
suffix:semicolon
id|memset
c_func
(paren
id|device
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|device-&gt;node
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|device-&gt;children
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|device-&gt;bus_list
)paren
suffix:semicolon
id|device-&gt;bus
op_assign
op_amp
id|pcie_port_bus_type
suffix:semicolon
id|device-&gt;driver
op_assign
l_int|NULL
suffix:semicolon
id|device-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
id|device-&gt;release
op_assign
id|release_pcie_device
suffix:semicolon
multiline_comment|/* callback to free pcie dev */
id|sprintf
c_func
(paren
op_amp
id|device-&gt;bus_id
(braket
l_int|0
)braket
comma
l_string|&quot;pcie%02x&quot;
comma
id|get_descriptor_id
c_func
(paren
id|port_type
comma
id|service_type
)paren
)paren
suffix:semicolon
id|device-&gt;parent
op_assign
op_amp
id|parent-&gt;dev
suffix:semicolon
)brace
DECL|function|alloc_pcie_device
r_static
r_struct
id|pcie_device
op_star
id|alloc_pcie_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|parent
comma
r_int
id|port_type
comma
r_int
id|service_type
comma
r_int
id|irq
comma
r_int
id|irq_mode
)paren
(brace
r_struct
id|pcie_device
op_star
id|device
suffix:semicolon
id|device
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pcie_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|device
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pcie_device
)paren
)paren
suffix:semicolon
id|pcie_device_init
c_func
(paren
id|parent
comma
id|device
comma
id|port_type
comma
id|service_type
comma
id|irq
comma
id|irq_mode
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Allocate Port Service[%s]&bslash;n&quot;
comma
id|device-&gt;device.bus_id
)paren
suffix:semicolon
r_return
id|device
suffix:semicolon
)brace
DECL|function|pcie_port_device_probe
r_int
id|pcie_port_device_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|pos
comma
id|type
suffix:semicolon
id|u16
id|reg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pos
op_assign
id|pci_find_capability
c_func
(paren
id|dev
comma
id|PCI_CAP_ID_EXP
)paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|pos
op_plus
id|PCIE_CAPABILITIES_REG
comma
op_amp
id|reg
)paren
suffix:semicolon
id|type
op_assign
(paren
id|reg
op_rshift
l_int|4
)paren
op_amp
id|PORT_TYPE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|PCIE_RC_PORT
op_logical_or
id|type
op_eq
id|PCIE_SW_UPSTREAM_PORT
op_logical_or
id|type
op_eq
id|PCIE_SW_DOWNSTREAM_PORT
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|pcie_port_device_register
r_int
id|pcie_port_device_register
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|status
comma
id|type
comma
id|capabilities
comma
id|irq_mode
comma
id|i
suffix:semicolon
r_int
id|vectors
(braket
id|PCIE_PORT_DEVICE_MAXSERVICES
)braket
suffix:semicolon
id|u16
id|reg16
suffix:semicolon
multiline_comment|/* Get port type */
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|pci_find_capability
c_func
(paren
id|dev
comma
id|PCI_CAP_ID_EXP
)paren
op_plus
id|PCIE_CAPABILITIES_REG
comma
op_amp
id|reg16
)paren
suffix:semicolon
id|type
op_assign
(paren
id|reg16
op_rshift
l_int|4
)paren
op_amp
id|PORT_TYPE_MASK
suffix:semicolon
multiline_comment|/* Now get port services */
id|capabilities
op_assign
id|get_port_device_capability
c_func
(paren
id|dev
)paren
suffix:semicolon
id|irq_mode
op_assign
id|assign_interrupt_mode
c_func
(paren
id|dev
comma
id|vectors
comma
id|capabilities
)paren
suffix:semicolon
multiline_comment|/* Allocate child services if any */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCIE_PORT_DEVICE_MAXSERVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|pcie_device
op_star
id|child
suffix:semicolon
r_if
c_cond
(paren
id|capabilities
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|child
op_assign
id|alloc_pcie_device
c_func
(paren
id|dev
comma
multiline_comment|/* parent */
id|type
comma
multiline_comment|/* port type */
id|i
comma
multiline_comment|/* service type */
id|vectors
(braket
id|i
)braket
comma
multiline_comment|/* irq */
id|irq_mode
multiline_comment|/* interrupt mode */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|child
)paren
(brace
id|status
op_assign
id|device_register
c_func
(paren
op_amp
id|child-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
c_func
(paren
id|child
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|get_device
c_func
(paren
op_amp
id|child-&gt;device
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
DECL|function|pcie_port_device_suspend
r_int
id|pcie_port_device_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|list_head
op_star
id|head
comma
op_star
id|tmp
suffix:semicolon
r_struct
id|device
op_star
id|parent
comma
op_star
id|child
suffix:semicolon
r_struct
id|device_driver
op_star
id|driver
suffix:semicolon
r_struct
id|pcie_port_service_driver
op_star
id|service_driver
suffix:semicolon
id|parent
op_assign
op_amp
id|dev-&gt;dev
suffix:semicolon
id|head
op_assign
op_amp
id|parent-&gt;children
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|head
op_ne
id|tmp
)paren
(brace
id|child
op_assign
id|container_of
c_func
(paren
id|tmp
comma
r_struct
id|device
comma
id|node
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|child-&gt;bus
op_ne
op_amp
id|pcie_port_bus_type
)paren
r_continue
suffix:semicolon
id|driver
op_assign
id|child-&gt;driver
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_continue
suffix:semicolon
id|service_driver
op_assign
id|to_service_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|service_driver-&gt;suspend
)paren
id|service_driver
op_member_access_from_pointer
id|suspend
c_func
(paren
id|to_pcie_device
c_func
(paren
id|child
)paren
comma
id|state
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcie_port_device_resume
r_int
id|pcie_port_device_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|list_head
op_star
id|head
comma
op_star
id|tmp
suffix:semicolon
r_struct
id|device
op_star
id|parent
comma
op_star
id|child
suffix:semicolon
r_struct
id|device_driver
op_star
id|driver
suffix:semicolon
r_struct
id|pcie_port_service_driver
op_star
id|service_driver
suffix:semicolon
id|parent
op_assign
op_amp
id|dev-&gt;dev
suffix:semicolon
id|head
op_assign
op_amp
id|parent-&gt;children
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|head
op_ne
id|tmp
)paren
(brace
id|child
op_assign
id|container_of
c_func
(paren
id|tmp
comma
r_struct
id|device
comma
id|node
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|child-&gt;bus
op_ne
op_amp
id|pcie_port_bus_type
)paren
r_continue
suffix:semicolon
id|driver
op_assign
id|child-&gt;driver
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_continue
suffix:semicolon
id|service_driver
op_assign
id|to_service_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|service_driver-&gt;resume
)paren
id|service_driver
op_member_access_from_pointer
id|resume
c_func
(paren
id|to_pcie_device
c_func
(paren
id|child
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|pcie_port_device_remove
r_void
id|pcie_port_device_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|list_head
op_star
id|head
comma
op_star
id|tmp
suffix:semicolon
r_struct
id|device
op_star
id|parent
comma
op_star
id|child
suffix:semicolon
r_struct
id|device_driver
op_star
id|driver
suffix:semicolon
r_struct
id|pcie_port_service_driver
op_star
id|service_driver
suffix:semicolon
r_int
id|interrupt_mode
op_assign
id|PCIE_PORT_INTx_MODE
suffix:semicolon
id|parent
op_assign
op_amp
id|dev-&gt;dev
suffix:semicolon
id|head
op_assign
op_amp
id|parent-&gt;children
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|head
op_ne
id|tmp
)paren
(brace
id|child
op_assign
id|container_of
c_func
(paren
id|tmp
comma
r_struct
id|device
comma
id|node
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|child-&gt;bus
op_ne
op_amp
id|pcie_port_bus_type
)paren
r_continue
suffix:semicolon
id|driver
op_assign
id|child-&gt;driver
suffix:semicolon
r_if
c_cond
(paren
id|driver
)paren
(brace
id|service_driver
op_assign
id|to_service_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|service_driver-&gt;remove
)paren
id|service_driver
op_member_access_from_pointer
id|remove
c_func
(paren
id|to_pcie_device
c_func
(paren
id|child
)paren
)paren
suffix:semicolon
)brace
id|interrupt_mode
op_assign
(paren
id|to_pcie_device
c_func
(paren
id|child
)paren
)paren
op_member_access_from_pointer
id|interrupt_mode
suffix:semicolon
id|put_device
c_func
(paren
id|child
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
id|child
)paren
suffix:semicolon
)brace
multiline_comment|/* Switch to INTx by default if MSI enabled */
r_if
c_cond
(paren
id|interrupt_mode
op_eq
id|PCIE_PORT_MSIX_MODE
)paren
id|pci_disable_msix
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|interrupt_mode
op_eq
id|PCIE_PORT_MSI_MODE
)paren
id|pci_disable_msi
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|pcie_port_bus_register
r_void
id|pcie_port_bus_register
c_func
(paren
r_void
)paren
(brace
id|bus_register
c_func
(paren
op_amp
id|pcie_port_bus_type
)paren
suffix:semicolon
)brace
DECL|function|pcie_port_bus_unregister
r_void
id|pcie_port_bus_unregister
c_func
(paren
r_void
)paren
(brace
id|bus_unregister
c_func
(paren
op_amp
id|pcie_port_bus_type
)paren
suffix:semicolon
)brace
DECL|function|pcie_port_service_register
r_int
id|pcie_port_service_register
c_func
(paren
r_struct
id|pcie_port_service_driver
op_star
r_new
)paren
(brace
r_new
op_member_access_from_pointer
id|driver.name
op_assign
(paren
r_char
op_star
)paren
r_new
op_member_access_from_pointer
id|name
suffix:semicolon
r_new
op_member_access_from_pointer
id|driver.bus
op_assign
op_amp
id|pcie_port_bus_type
suffix:semicolon
r_new
op_member_access_from_pointer
id|driver.probe
op_assign
id|pcie_port_probe_service
suffix:semicolon
r_new
op_member_access_from_pointer
id|driver.remove
op_assign
id|pcie_port_remove_service
suffix:semicolon
r_new
op_member_access_from_pointer
id|driver.shutdown
op_assign
id|pcie_port_shutdown_service
suffix:semicolon
r_new
op_member_access_from_pointer
id|driver.suspend
op_assign
id|pcie_port_suspend_service
suffix:semicolon
r_new
op_member_access_from_pointer
id|driver.resume
op_assign
id|pcie_port_resume_service
suffix:semicolon
r_return
id|driver_register
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|driver
)paren
suffix:semicolon
)brace
DECL|function|pcie_port_service_unregister
r_void
id|pcie_port_service_unregister
c_func
(paren
r_struct
id|pcie_port_service_driver
op_star
r_new
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|driver
)paren
suffix:semicolon
)brace
DECL|variable|pcie_port_service_register
id|EXPORT_SYMBOL
c_func
(paren
id|pcie_port_service_register
)paren
suffix:semicolon
DECL|variable|pcie_port_service_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|pcie_port_service_unregister
)paren
suffix:semicolon
eof
