multiline_comment|/*&n; * I2O Configuration Interface Driver&n; *&n; * (C) Copyright 1999-2002  Red Hat&n; *&n; * Written by Alan Cox, Building Number Three Ltd&n; *&n; * Fixes/additions:&n; *&t;Deepak Saxena (04/20/1999):&n; *&t;&t;Added basic ioctl() support&n; *&t;Deepak Saxena (06/07/1999):&n; *&t;&t;Added software download ioctl (still testing)&n; *&t;Auvo H&#xfffd;kkinen (09/10/1999):&n; *&t;&t;Changes to i2o_cfg_reply(), ioctl_parms()&n; *&t;&t;Added ioct_validate()&n; *&t;Taneli V&#xfffd;h&#xfffd;kangas (09/30/1999):&n; *&t;&t;Fixed ioctl_swdl()&n; *&t;Taneli V&#xfffd;h&#xfffd;kangas (10/04/1999):&n; *&t;&t;Changed ioctl_swdl(), implemented ioctl_swul() and ioctl_swdel()&n; *&t;Deepak Saxena (11/18/1999):&n; *&t;&t;Added event managmenet support&n; *&t;Alan Cox &lt;alan@redhat.com&gt;:&n; *&t;&t;2.4 rewrite ported to 2.5&n; *&t;Markus Lidel &lt;Markus.Lidel@shadowconnect.com&gt;:&n; *&t;&t;Added pass-thru support for Adaptec&squot;s raidutils&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/i2o.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/ioctl32.h&gt;
macro_line|#include &lt;linux/compat.h&gt;
macro_line|#include &lt;linux/syscalls.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|OSM_NAME
mdefine_line|#define OSM_NAME&t;&quot;config-osm&quot;
DECL|macro|OSM_VERSION
mdefine_line|#define OSM_VERSION&t;&quot;$Rev$&quot;
DECL|macro|OSM_DESCRIPTION
mdefine_line|#define OSM_DESCRIPTION&t;&quot;I2O Configuration OSM&quot;
r_extern
r_int
id|i2o_parm_issue
c_func
(paren
r_struct
id|i2o_device
op_star
comma
r_int
comma
r_void
op_star
comma
r_int
comma
r_void
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|i2o_config_lock
r_static
id|spinlock_t
id|i2o_config_lock
suffix:semicolon
DECL|macro|MODINC
mdefine_line|#define MODINC(x,y) ((x) = ((x) + 1) % (y))
DECL|struct|sg_simple_element
r_struct
id|sg_simple_element
(brace
DECL|member|flag_count
id|u32
id|flag_count
suffix:semicolon
DECL|member|addr_bus
id|u32
id|addr_bus
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|i2o_cfg_info
r_struct
id|i2o_cfg_info
(brace
DECL|member|fp
r_struct
id|file
op_star
id|fp
suffix:semicolon
DECL|member|fasync
r_struct
id|fasync_struct
op_star
id|fasync
suffix:semicolon
DECL|member|event_q
r_struct
id|i2o_evt_info
id|event_q
(braket
id|I2O_EVT_Q_LEN
)braket
suffix:semicolon
DECL|member|q_in
id|u16
id|q_in
suffix:semicolon
singleline_comment|// Queue head index
DECL|member|q_out
id|u16
id|q_out
suffix:semicolon
singleline_comment|// Queue tail index
DECL|member|q_len
id|u16
id|q_len
suffix:semicolon
singleline_comment|// Queue length
DECL|member|q_lost
id|u16
id|q_lost
suffix:semicolon
singleline_comment|// Number of lost events
DECL|member|q_id
id|ulong
id|q_id
suffix:semicolon
singleline_comment|// Event queue ID...used as tx_context
DECL|member|next
r_struct
id|i2o_cfg_info
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|open_files
r_static
r_struct
id|i2o_cfg_info
op_star
id|open_files
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|i2o_cfg_info_id
r_static
id|ulong
id|i2o_cfg_info_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *&t;Each of these describes an i2o message handler. They are&n; *&t;multiplexed by the i2o_core code&n; */
DECL|variable|i2o_config_driver
r_static
r_struct
id|i2o_driver
id|i2o_config_driver
op_assign
(brace
dot
id|name
op_assign
id|OSM_NAME
)brace
suffix:semicolon
DECL|function|i2o_cfg_getiops
r_static
r_int
id|i2o_cfg_getiops
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|u8
id|__user
op_star
id|user_iop_table
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|u8
id|tmp
(braket
id|MAX_I2O_CONTROLLERS
)braket
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|tmp
comma
l_int|0
comma
id|MAX_I2O_CONTROLLERS
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|c
comma
op_amp
id|i2o_controllers
comma
id|list
)paren
id|tmp
(braket
id|c-&gt;unit
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user_iop_table
comma
id|tmp
comma
id|MAX_I2O_CONTROLLERS
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_cfg_gethrt
r_static
r_int
id|i2o_cfg_gethrt
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_cmd_hrtlct
id|__user
op_star
id|cmd
op_assign
(paren
r_struct
id|i2o_cmd_hrtlct
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_cmd_hrtlct
id|kcmd
suffix:semicolon
id|i2o_hrt
op_star
id|hrt
suffix:semicolon
r_int
id|len
suffix:semicolon
id|u32
id|reslen
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kcmd
comma
id|cmd
comma
r_sizeof
(paren
r_struct
id|i2o_cmd_hrtlct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reslen
comma
id|kcmd.reslen
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|kcmd.resbuf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|kcmd.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|hrt
op_assign
(paren
id|i2o_hrt
op_star
)paren
id|c-&gt;hrt.virt
suffix:semicolon
id|len
op_assign
l_int|8
op_plus
(paren
(paren
id|hrt-&gt;entry_len
op_star
id|hrt-&gt;num_entries
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* We did a get user...so assuming mem is ok...is this bad? */
id|put_user
c_func
(paren
id|len
comma
id|kcmd.reslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|reslen
)paren
id|ret
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|kcmd.resbuf
comma
(paren
r_void
op_star
)paren
id|hrt
comma
id|len
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_cfg_getlct
r_static
r_int
id|i2o_cfg_getlct
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_cmd_hrtlct
id|__user
op_star
id|cmd
op_assign
(paren
r_struct
id|i2o_cmd_hrtlct
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_cmd_hrtlct
id|kcmd
suffix:semicolon
id|i2o_lct
op_star
id|lct
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|u32
id|reslen
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kcmd
comma
id|cmd
comma
r_sizeof
(paren
r_struct
id|i2o_cmd_hrtlct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reslen
comma
id|kcmd.reslen
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|kcmd.resbuf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|kcmd.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|lct
op_assign
(paren
id|i2o_lct
op_star
)paren
id|c-&gt;lct
suffix:semicolon
id|len
op_assign
(paren
r_int
r_int
)paren
id|lct-&gt;table_size
op_lshift
l_int|2
suffix:semicolon
id|put_user
c_func
(paren
id|len
comma
id|kcmd.reslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|reslen
)paren
id|ret
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_else
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|kcmd.resbuf
comma
id|lct
comma
id|len
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_cfg_parms
r_static
r_int
id|i2o_cfg_parms
c_func
(paren
r_int
r_int
id|arg
comma
r_int
r_int
id|type
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_device
op_star
id|dev
suffix:semicolon
r_struct
id|i2o_cmd_psetget
id|__user
op_star
id|cmd
op_assign
(paren
r_struct
id|i2o_cmd_psetget
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_cmd_psetget
id|kcmd
suffix:semicolon
id|u32
id|reslen
suffix:semicolon
id|u8
op_star
id|ops
suffix:semicolon
id|u8
op_star
id|res
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|u32
id|i2o_cmd
op_assign
(paren
id|type
op_eq
id|I2OPARMGET
ques
c_cond
id|I2O_CMD_UTIL_PARAMS_GET
suffix:colon
id|I2O_CMD_UTIL_PARAMS_SET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kcmd
comma
id|cmd
comma
r_sizeof
(paren
r_struct
id|i2o_cmd_psetget
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reslen
comma
id|kcmd.reslen
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|kcmd.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|dev
op_assign
id|i2o_iop_find_device
c_func
(paren
id|c
comma
id|kcmd.tid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|ops
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
id|kcmd.oplen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ops
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|ops
comma
id|kcmd.opbuf
comma
id|kcmd.oplen
)paren
)paren
(brace
id|kfree
c_func
(paren
id|ops
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * It&squot;s possible to have a _very_ large table&n;&t; * and that the user asks for all of it at once...&n;&t; */
id|res
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
l_int|65536
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|kfree
c_func
(paren
id|ops
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|len
op_assign
id|i2o_parm_issue
c_func
(paren
id|dev
comma
id|i2o_cmd
comma
id|ops
comma
id|kcmd.oplen
comma
id|res
comma
l_int|65536
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|put_user
c_func
(paren
id|len
comma
id|kcmd.reslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|reslen
)paren
id|ret
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_else
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|kcmd.resbuf
comma
id|res
comma
id|len
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_cfg_swdl
r_static
r_int
id|i2o_cfg_swdl
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_sw_xfer
id|kxfer
suffix:semicolon
r_struct
id|i2o_sw_xfer
id|__user
op_star
id|pxfer
op_assign
(paren
r_struct
id|i2o_sw_xfer
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
r_char
id|maxfrag
op_assign
l_int|0
comma
id|curfrag
op_assign
l_int|1
suffix:semicolon
r_struct
id|i2o_dma
id|buffer
suffix:semicolon
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_int
r_int
id|status
op_assign
l_int|0
comma
id|swlen
op_assign
l_int|0
comma
id|fragsize
op_assign
l_int|8192
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kxfer
comma
id|pxfer
comma
r_sizeof
(paren
r_struct
id|i2o_sw_xfer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|swlen
comma
id|kxfer.swlen
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|maxfrag
comma
id|kxfer.maxfrag
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|curfrag
comma
id|kxfer.curfrag
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|curfrag
op_eq
id|maxfrag
)paren
id|fragsize
op_assign
id|swlen
op_minus
(paren
id|maxfrag
op_minus
l_int|1
)paren
op_star
l_int|8192
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kxfer.buf
op_logical_or
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|kxfer.buf
comma
id|fragsize
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|kxfer.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|i2o_dma_alloc
c_func
(paren
op_amp
id|c-&gt;pdev-&gt;dev
comma
op_amp
id|buffer
comma
id|fragsize
comma
id|GFP_KERNEL
)paren
)paren
(brace
id|i2o_msg_nop
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|__copy_from_user
c_func
(paren
id|buffer.virt
comma
id|kxfer.buf
comma
id|fragsize
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_7
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_SW_DOWNLOAD
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_config_driver.context
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
(paren
(paren
id|u32
)paren
id|kxfer.flags
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|kxfer.sw_type
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|maxfrag
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|curfrag
)paren
)paren
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|swlen
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|kxfer.sw_id
comma
op_amp
id|msg-&gt;body
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xD0000000
op_or
id|fragsize
comma
op_amp
id|msg-&gt;body
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|buffer.phys
comma
op_amp
id|msg-&gt;body
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|osm_debug
c_func
(paren
l_string|&quot;swdl frag %d/%d (size %d)&bslash;n&quot;
comma
id|curfrag
comma
id|maxfrag
comma
id|fragsize
)paren
suffix:semicolon
id|status
op_assign
id|i2o_msg_post_wait_mem
c_func
(paren
id|c
comma
id|m
comma
l_int|60
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
op_minus
id|ETIMEDOUT
)paren
id|i2o_dma_free
c_func
(paren
op_amp
id|c-&gt;pdev-&gt;dev
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|I2O_POST_WAIT_OK
)paren
(brace
singleline_comment|// it fails if you try and send frags out of order
singleline_comment|// and for some yet unknown reasons too
id|osm_info
c_func
(paren
l_string|&quot;swdl failed, DetailedStatus = %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_cfg_swul
r_static
r_int
id|i2o_cfg_swul
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_sw_xfer
id|kxfer
suffix:semicolon
r_struct
id|i2o_sw_xfer
id|__user
op_star
id|pxfer
op_assign
(paren
r_struct
id|i2o_sw_xfer
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
r_char
id|maxfrag
op_assign
l_int|0
comma
id|curfrag
op_assign
l_int|1
suffix:semicolon
r_struct
id|i2o_dma
id|buffer
suffix:semicolon
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_int
r_int
id|status
op_assign
l_int|0
comma
id|swlen
op_assign
l_int|0
comma
id|fragsize
op_assign
l_int|8192
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kxfer
comma
id|pxfer
comma
r_sizeof
(paren
r_struct
id|i2o_sw_xfer
)paren
)paren
)paren
r_goto
id|return_fault
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|swlen
comma
id|kxfer.swlen
)paren
OL
l_int|0
)paren
r_goto
id|return_fault
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|maxfrag
comma
id|kxfer.maxfrag
)paren
OL
l_int|0
)paren
r_goto
id|return_fault
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|curfrag
comma
id|kxfer.curfrag
)paren
OL
l_int|0
)paren
r_goto
id|return_fault
suffix:semicolon
r_if
c_cond
(paren
id|curfrag
op_eq
id|maxfrag
)paren
id|fragsize
op_assign
id|swlen
op_minus
(paren
id|maxfrag
op_minus
l_int|1
)paren
op_star
l_int|8192
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kxfer.buf
)paren
r_goto
id|return_fault
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|kxfer.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|i2o_dma_alloc
c_func
(paren
op_amp
id|c-&gt;pdev-&gt;dev
comma
op_amp
id|buffer
comma
id|fragsize
comma
id|GFP_KERNEL
)paren
)paren
(brace
id|i2o_msg_nop
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|writel
c_func
(paren
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_7
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_SW_UPLOAD
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_config_driver.context
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|kxfer.flags
op_lshift
l_int|24
op_or
(paren
id|u32
)paren
id|kxfer
dot
id|sw_type
op_lshift
l_int|16
op_or
(paren
id|u32
)paren
id|maxfrag
op_lshift
l_int|8
op_or
(paren
id|u32
)paren
id|curfrag
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|swlen
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|kxfer.sw_id
comma
op_amp
id|msg-&gt;body
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xD0000000
op_or
id|fragsize
comma
op_amp
id|msg-&gt;body
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|buffer.phys
comma
op_amp
id|msg-&gt;body
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|osm_debug
c_func
(paren
l_string|&quot;swul frag %d/%d (size %d)&bslash;n&quot;
comma
id|curfrag
comma
id|maxfrag
comma
id|fragsize
)paren
suffix:semicolon
id|status
op_assign
id|i2o_msg_post_wait_mem
c_func
(paren
id|c
comma
id|m
comma
l_int|60
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|I2O_POST_WAIT_OK
)paren
(brace
r_if
c_cond
(paren
id|status
op_ne
op_minus
id|ETIMEDOUT
)paren
id|i2o_dma_free
c_func
(paren
op_amp
id|c-&gt;pdev-&gt;dev
comma
op_amp
id|buffer
)paren
suffix:semicolon
id|osm_info
c_func
(paren
l_string|&quot;swul failed, DetailedStatus = %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|kxfer.buf
comma
id|buffer.virt
comma
id|fragsize
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|i2o_dma_free
c_func
(paren
op_amp
id|c-&gt;pdev-&gt;dev
comma
op_amp
id|buffer
)paren
suffix:semicolon
id|return_ret
suffix:colon
r_return
id|ret
suffix:semicolon
id|return_fault
suffix:colon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|return_ret
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_cfg_swdel
r_static
r_int
id|i2o_cfg_swdel
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_sw_xfer
id|kxfer
suffix:semicolon
r_struct
id|i2o_sw_xfer
id|__user
op_star
id|pxfer
op_assign
(paren
r_struct
id|i2o_sw_xfer
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_int
r_int
id|swlen
suffix:semicolon
r_int
id|token
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kxfer
comma
id|pxfer
comma
r_sizeof
(paren
r_struct
id|i2o_sw_xfer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|swlen
comma
id|kxfer.swlen
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|kxfer.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|writel
c_func
(paren
id|SEVEN_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_SW_REMOVE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_config_driver.context
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|kxfer.flags
op_lshift
l_int|24
op_or
(paren
id|u32
)paren
id|kxfer.sw_type
op_lshift
l_int|16
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|swlen
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|kxfer.sw_id
comma
op_amp
id|msg-&gt;body
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|token
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|token
op_ne
id|I2O_POST_WAIT_OK
)paren
(brace
id|osm_info
c_func
(paren
l_string|&quot;swdel failed, DetailedStatus = %d&bslash;n&quot;
comma
id|token
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_cfg_validate
r_static
r_int
id|i2o_cfg_validate
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_int
id|token
suffix:semicolon
r_int
id|iop
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|writel
c_func
(paren
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_CONFIG_VALIDATE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|iop
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_config_driver.context
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|token
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|token
op_ne
id|I2O_POST_WAIT_OK
)paren
(brace
id|osm_info
c_func
(paren
l_string|&quot;Can&squot;t validate configuration, ErrorStatus = %d&bslash;n&quot;
comma
id|token
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_cfg_evt_reg
r_static
r_int
id|i2o_cfg_evt_reg
c_func
(paren
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|fp
)paren
(brace
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_struct
id|i2o_evt_id
id|__user
op_star
id|pdesc
op_assign
(paren
r_struct
id|i2o_evt_id
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_evt_id
id|kdesc
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_struct
id|i2o_device
op_star
id|d
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kdesc
comma
id|pdesc
comma
r_sizeof
(paren
r_struct
id|i2o_evt_id
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* IOP exists? */
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|kdesc.iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* Device exists? */
id|d
op_assign
id|i2o_iop_find_device
c_func
(paren
id|c
comma
id|kdesc.tid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|d
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|writel
c_func
(paren
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_UTIL_EVT_REGISTER
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|kdesc.tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_config_driver.context
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_cntxt_list_add
c_func
(paren
id|c
comma
id|fp-&gt;private_data
)paren
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|kdesc.evt_mask
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i2o_msg_post
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2o_cfg_evt_get
r_static
r_int
id|i2o_cfg_evt_get
c_func
(paren
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|fp
)paren
(brace
r_struct
id|i2o_cfg_info
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|i2o_evt_get
id|__user
op_star
id|uget
op_assign
(paren
r_struct
id|i2o_evt_get
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_evt_get
id|kget
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|open_files
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;q_id
op_eq
(paren
id|ulong
)paren
id|fp-&gt;private_data
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;q_len
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|kget.info
comma
op_amp
id|p-&gt;event_q
(braket
id|p-&gt;q_out
)braket
comma
r_sizeof
(paren
r_struct
id|i2o_evt_info
)paren
)paren
suffix:semicolon
id|MODINC
c_func
(paren
id|p-&gt;q_out
comma
id|I2O_EVT_Q_LEN
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;q_len
op_decrement
suffix:semicolon
id|kget.pending
op_assign
id|p-&gt;q_len
suffix:semicolon
id|kget.lost
op_assign
id|p-&gt;q_lost
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|uget
comma
op_amp
id|kget
comma
r_sizeof
(paren
r_struct
id|i2o_evt_get
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_COMPAT
DECL|function|i2o_cfg_passthru32
r_static
r_int
id|i2o_cfg_passthru32
c_func
(paren
r_int
id|fd
comma
r_int
id|cmnd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|i2o_cmd_passthru32
id|__user
op_star
id|cmd
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|u32
id|__user
op_star
id|user_msg
suffix:semicolon
id|u32
op_star
id|reply
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|__user
op_star
id|user_reply
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|size
op_assign
l_int|0
suffix:semicolon
id|u32
id|reply_size
op_assign
l_int|0
suffix:semicolon
id|u32
id|rcode
op_assign
l_int|0
suffix:semicolon
r_struct
id|i2o_dma
id|sg_list
(braket
id|SG_TABLESIZE
)braket
suffix:semicolon
id|u32
id|sg_offset
op_assign
l_int|0
suffix:semicolon
id|u32
id|sg_count
op_assign
l_int|0
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|i2o_status_block
op_star
id|sb
suffix:semicolon
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_int
r_int
id|iop
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|i2o_cmd_passthru32
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|iop
comma
op_amp
id|cmd-&gt;iop
)paren
op_logical_or
id|get_user
c_func
(paren
id|i
comma
op_amp
id|cmd-&gt;msg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|user_msg
op_assign
id|compat_ptr
c_func
(paren
id|i
)paren
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
id|osm_debug
c_func
(paren
l_string|&quot;controller %d not found&bslash;n&quot;
comma
id|iop
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|size
comma
op_amp
id|user_msg
(braket
l_int|0
)braket
)paren
)paren
(brace
id|osm_warn
c_func
(paren
l_string|&quot;unable to get size!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|size
op_assign
id|size
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|sb-&gt;inbound_frame_size
)paren
(brace
id|osm_warn
c_func
(paren
l_string|&quot;size of message &gt; inbound_frame_size&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|user_reply
op_assign
op_amp
id|user_msg
(braket
id|size
)braket
suffix:semicolon
id|size
op_lshift_assign
l_int|2
suffix:semicolon
singleline_comment|// Convert to bytes
multiline_comment|/* Copy in the user&squot;s I2O command */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|msg
comma
id|user_msg
comma
id|size
)paren
)paren
(brace
id|osm_warn
c_func
(paren
l_string|&quot;unable to copy user message&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|i2o_dump_message
c_func
(paren
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reply_size
comma
op_amp
id|user_reply
(braket
l_int|0
)braket
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|reply_size
op_rshift_assign
l_int|16
suffix:semicolon
id|reply_size
op_lshift_assign
l_int|2
suffix:semicolon
id|reply
op_assign
id|kmalloc
c_func
(paren
id|reply_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reply
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not allocate reply buffer&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|reply
comma
l_int|0
comma
id|reply_size
)paren
suffix:semicolon
id|sg_offset
op_assign
(paren
id|msg-&gt;u.head
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|writel
c_func
(paren
id|i2o_config_driver.context
comma
op_amp
id|msg-&gt;u.s.icntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_cntxt_list_add
c_func
(paren
id|c
comma
id|reply
)paren
comma
op_amp
id|msg-&gt;u.s.tcntxt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sg_list
comma
l_int|0
comma
r_sizeof
(paren
id|sg_list
(braket
l_int|0
)braket
)paren
op_star
id|SG_TABLESIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_offset
)paren
(brace
r_struct
id|sg_simple_element
op_star
id|sg
suffix:semicolon
r_if
c_cond
(paren
id|sg_offset
op_star
l_int|4
op_ge
id|size
)paren
(brace
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
singleline_comment|// TODO 64bit fix
id|sg
op_assign
(paren
r_struct
id|sg_simple_element
op_star
)paren
(paren
(paren
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
op_plus
id|sg_offset
)paren
suffix:semicolon
id|sg_count
op_assign
(paren
id|size
op_minus
id|sg_offset
op_star
l_int|4
)paren
op_div
r_sizeof
(paren
r_struct
id|sg_simple_element
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_count
OG
id|SG_TABLESIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:IOCTL SG List too large (%u)&bslash;n&quot;
comma
id|c-&gt;name
comma
id|sg_count
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|reply
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|sg_size
suffix:semicolon
r_struct
id|i2o_dma
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0x10000000
multiline_comment|/*I2O_SGL_FLAGS_SIMPLE_ADDRESS_ELEMENT */
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:Bad SG element %d - not simple (%x)&bslash;n&quot;
comma
id|c-&gt;name
comma
id|i
comma
id|sg
(braket
id|i
)braket
dot
id|flag_count
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sg_size
op_assign
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0xffffff
suffix:semicolon
id|p
op_assign
op_amp
(paren
id|sg_list
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Allocate memory for the transfer */
r_if
c_cond
(paren
id|i2o_dma_alloc
(paren
op_amp
id|c-&gt;pdev-&gt;dev
comma
id|p
comma
id|sg_size
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Could not allocate SG buffer - size = %d buffer number %d of %d&bslash;n&quot;
comma
id|c-&gt;name
comma
id|sg_size
comma
id|i
comma
id|sg_count
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/* Copy in the user&squot;s SG buffer if necessary */
r_if
c_cond
(paren
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0x04000000
multiline_comment|/*I2O_SGL_FLAGS_DIR */
)paren
(brace
singleline_comment|// TODO 64bit fix
r_if
c_cond
(paren
id|copy_from_user
(paren
id|p-&gt;virt
comma
(paren
r_void
id|__user
op_star
)paren
(paren
r_int
r_int
)paren
id|sg
(braket
id|i
)braket
dot
id|addr_bus
comma
id|sg_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Could not copy SG buf %d FROM user&bslash;n&quot;
comma
id|c-&gt;name
comma
id|i
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
)brace
singleline_comment|//TODO 64bit fix
id|sg
(braket
id|i
)braket
dot
id|addr_bus
op_assign
(paren
id|u32
)paren
id|p-&gt;phys
suffix:semicolon
)brace
)brace
id|rcode
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|60
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcode
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
id|sg_offset
)paren
(brace
id|u32
id|msg
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Copy back the Scatter Gather buffers back to user space */
id|u32
id|j
suffix:semicolon
singleline_comment|// TODO 64bit fix
r_struct
id|sg_simple_element
op_star
id|sg
suffix:semicolon
r_int
id|sg_size
suffix:semicolon
singleline_comment|// re-acquire the original message to handle correctly the sg copy operation
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
id|MSG_FRAME_SIZE
op_star
l_int|4
)paren
suffix:semicolon
singleline_comment|// get user msg size in u32s
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|size
comma
op_amp
id|user_msg
(braket
l_int|0
)braket
)paren
)paren
(brace
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|size
op_assign
id|size
op_rshift
l_int|16
suffix:semicolon
id|size
op_mul_assign
l_int|4
suffix:semicolon
multiline_comment|/* Copy in the user&squot;s I2O command */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|msg
comma
id|user_msg
comma
id|size
)paren
)paren
(brace
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sg_count
op_assign
(paren
id|size
op_minus
id|sg_offset
op_star
l_int|4
)paren
op_div
r_sizeof
(paren
r_struct
id|sg_simple_element
)paren
suffix:semicolon
singleline_comment|// TODO 64bit fix
id|sg
op_assign
(paren
r_struct
id|sg_simple_element
op_star
)paren
(paren
id|msg
op_plus
id|sg_offset
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|sg_count
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* Copy out the SG list to user&squot;s buffer if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sg
(braket
id|j
)braket
dot
id|flag_count
op_amp
l_int|0x4000000
multiline_comment|/*I2O_SGL_FLAGS_DIR */
)paren
)paren
(brace
id|sg_size
op_assign
id|sg
(braket
id|j
)braket
dot
id|flag_count
op_amp
l_int|0xffffff
suffix:semicolon
singleline_comment|// TODO 64bit fix
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_void
id|__user
op_star
)paren
(paren
id|u64
)paren
id|sg
(braket
id|j
)braket
dot
id|addr_bus
comma
id|sg_list
(braket
id|j
)braket
dot
id|virt
comma
id|sg_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy %p TO user %x&bslash;n&quot;
comma
id|c-&gt;name
comma
id|sg_list
(braket
id|j
)braket
dot
id|virt
comma
id|sg
(braket
id|j
)braket
dot
id|addr_bus
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Copy back the reply to user space */
r_if
c_cond
(paren
id|reply_size
)paren
(brace
singleline_comment|// we wrote our own values for context - now restore the user supplied ones
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|reply
op_plus
l_int|2
comma
id|user_msg
op_plus
l_int|2
comma
r_sizeof
(paren
id|u32
)paren
op_star
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy message context FROM user&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user_reply
comma
id|reply
comma
id|reply_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy reply TO user&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|cleanup
suffix:colon
id|kfree
c_func
(paren
id|reply
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
macro_line|#else
DECL|function|i2o_cfg_passthru
r_static
r_int
id|i2o_cfg_passthru
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2o_cmd_passthru
id|__user
op_star
id|cmd
op_assign
(paren
r_struct
id|i2o_cmd_passthru
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|u32
id|__user
op_star
id|user_msg
suffix:semicolon
id|u32
op_star
id|reply
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|__user
op_star
id|user_reply
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|size
op_assign
l_int|0
suffix:semicolon
id|u32
id|reply_size
op_assign
l_int|0
suffix:semicolon
id|u32
id|rcode
op_assign
l_int|0
suffix:semicolon
r_void
op_star
id|sg_list
(braket
id|SG_TABLESIZE
)braket
suffix:semicolon
id|u32
id|sg_offset
op_assign
l_int|0
suffix:semicolon
id|u32
id|sg_count
op_assign
l_int|0
suffix:semicolon
r_int
id|sg_index
op_assign
l_int|0
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
r_void
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
id|i2o_status_block
op_star
id|sb
suffix:semicolon
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_int
r_int
id|iop
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|iop
comma
op_amp
id|cmd-&gt;iop
)paren
op_logical_or
id|get_user
c_func
(paren
id|user_msg
comma
op_amp
id|cmd-&gt;msg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|c
op_assign
id|i2o_find_iop
c_func
(paren
id|iop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
id|osm_warn
c_func
(paren
l_string|&quot;controller %d not found&bslash;n&quot;
comma
id|iop
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|size
comma
op_amp
id|user_msg
(braket
l_int|0
)braket
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|size
op_assign
id|size
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|sb-&gt;inbound_frame_size
)paren
(brace
id|osm_warn
c_func
(paren
l_string|&quot;size of message &gt; inbound_frame_size&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|user_reply
op_assign
op_amp
id|user_msg
(braket
id|size
)braket
suffix:semicolon
id|size
op_lshift_assign
l_int|2
suffix:semicolon
singleline_comment|// Convert to bytes
multiline_comment|/* Copy in the user&squot;s I2O command */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|msg
comma
id|user_msg
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|reply_size
comma
op_amp
id|user_reply
(braket
l_int|0
)braket
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|reply_size
op_rshift_assign
l_int|16
suffix:semicolon
id|reply_size
op_lshift_assign
l_int|2
suffix:semicolon
id|reply
op_assign
id|kmalloc
c_func
(paren
id|reply_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reply
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not allocate reply buffer&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|reply
comma
l_int|0
comma
id|reply_size
)paren
suffix:semicolon
id|sg_offset
op_assign
(paren
id|msg-&gt;u.head
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|writel
c_func
(paren
id|i2o_config_driver.context
comma
op_amp
id|msg-&gt;u.s.icntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_cntxt_list_add
c_func
(paren
id|c
comma
id|reply
)paren
comma
op_amp
id|msg-&gt;u.s.tcntxt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sg_list
comma
l_int|0
comma
r_sizeof
(paren
id|sg_list
(braket
l_int|0
)braket
)paren
op_star
id|SG_TABLESIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_offset
)paren
(brace
r_struct
id|sg_simple_element
op_star
id|sg
suffix:semicolon
r_if
c_cond
(paren
id|sg_offset
op_star
l_int|4
op_ge
id|size
)paren
(brace
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
singleline_comment|// TODO 64bit fix
id|sg
op_assign
(paren
r_struct
id|sg_simple_element
op_star
)paren
(paren
(paren
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
op_plus
id|sg_offset
)paren
suffix:semicolon
id|sg_count
op_assign
(paren
id|size
op_minus
id|sg_offset
op_star
l_int|4
)paren
op_div
r_sizeof
(paren
r_struct
id|sg_simple_element
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_count
OG
id|SG_TABLESIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:IOCTL SG List too large (%u)&bslash;n&quot;
comma
id|c-&gt;name
comma
id|sg_count
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|reply
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|sg_size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0x10000000
multiline_comment|/*I2O_SGL_FLAGS_SIMPLE_ADDRESS_ELEMENT */
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:Bad SG element %d - not simple (%x)&bslash;n&quot;
comma
id|c-&gt;name
comma
id|i
comma
id|sg
(braket
id|i
)braket
dot
id|flag_count
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sg_size
op_assign
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0xffffff
suffix:semicolon
multiline_comment|/* Allocate memory for the transfer */
id|p
op_assign
id|kmalloc
c_func
(paren
id|sg_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Could not allocate SG buffer - size = %d buffer number %d of %d&bslash;n&quot;
comma
id|c-&gt;name
comma
id|sg_size
comma
id|i
comma
id|sg_count
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sg_list
(braket
id|sg_index
op_increment
)braket
op_assign
id|p
suffix:semicolon
singleline_comment|// sglist indexed with input frame, not our internal frame.
multiline_comment|/* Copy in the user&squot;s SG buffer if necessary */
r_if
c_cond
(paren
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0x04000000
multiline_comment|/*I2O_SGL_FLAGS_DIR */
)paren
(brace
singleline_comment|// TODO 64bit fix
r_if
c_cond
(paren
id|copy_from_user
(paren
id|p
comma
(paren
r_void
id|__user
op_star
)paren
id|sg
(braket
id|i
)braket
dot
id|addr_bus
comma
id|sg_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Could not copy SG buf %d FROM user&bslash;n&quot;
comma
id|c-&gt;name
comma
id|i
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
)brace
singleline_comment|//TODO 64bit fix
id|sg
(braket
id|i
)braket
dot
id|addr_bus
op_assign
id|virt_to_bus
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
)brace
id|rcode
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|60
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcode
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
id|sg_offset
)paren
(brace
id|u32
id|msg
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Copy back the Scatter Gather buffers back to user space */
id|u32
id|j
suffix:semicolon
singleline_comment|// TODO 64bit fix
r_struct
id|sg_simple_element
op_star
id|sg
suffix:semicolon
r_int
id|sg_size
suffix:semicolon
singleline_comment|// re-acquire the original message to handle correctly the sg copy operation
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
id|MSG_FRAME_SIZE
op_star
l_int|4
)paren
suffix:semicolon
singleline_comment|// get user msg size in u32s
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|size
comma
op_amp
id|user_msg
(braket
l_int|0
)braket
)paren
)paren
(brace
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|size
op_assign
id|size
op_rshift
l_int|16
suffix:semicolon
id|size
op_mul_assign
l_int|4
suffix:semicolon
multiline_comment|/* Copy in the user&squot;s I2O command */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|msg
comma
id|user_msg
comma
id|size
)paren
)paren
(brace
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sg_count
op_assign
(paren
id|size
op_minus
id|sg_offset
op_star
l_int|4
)paren
op_div
r_sizeof
(paren
r_struct
id|sg_simple_element
)paren
suffix:semicolon
singleline_comment|// TODO 64bit fix
id|sg
op_assign
(paren
r_struct
id|sg_simple_element
op_star
)paren
(paren
id|msg
op_plus
id|sg_offset
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|sg_count
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* Copy out the SG list to user&squot;s buffer if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sg
(braket
id|j
)braket
dot
id|flag_count
op_amp
l_int|0x4000000
multiline_comment|/*I2O_SGL_FLAGS_DIR */
)paren
)paren
(brace
id|sg_size
op_assign
id|sg
(braket
id|j
)braket
dot
id|flag_count
op_amp
l_int|0xffffff
suffix:semicolon
singleline_comment|// TODO 64bit fix
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_void
id|__user
op_star
)paren
id|sg
(braket
id|j
)braket
dot
id|addr_bus
comma
id|sg_list
(braket
id|j
)braket
comma
id|sg_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy %p TO user %x&bslash;n&quot;
comma
id|c-&gt;name
comma
id|sg_list
(braket
id|j
)braket
comma
id|sg
(braket
id|j
)braket
dot
id|addr_bus
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Copy back the reply to user space */
r_if
c_cond
(paren
id|reply_size
)paren
(brace
singleline_comment|// we wrote our own values for context - now restore the user supplied ones
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|reply
op_plus
l_int|2
comma
id|user_msg
op_plus
l_int|2
comma
r_sizeof
(paren
id|u32
)paren
op_star
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy message context FROM user&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user_reply
comma
id|reply
comma
id|reply_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy reply TO user&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|cleanup
suffix:colon
id|kfree
c_func
(paren
id|reply
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * IOCTL Handler&n; */
DECL|function|i2o_cfg_ioctl
r_static
r_int
id|i2o_cfg_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|fp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|I2OGETIOPS
suffix:colon
id|ret
op_assign
id|i2o_cfg_getiops
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OHRTGET
suffix:colon
id|ret
op_assign
id|i2o_cfg_gethrt
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OLCTGET
suffix:colon
id|ret
op_assign
id|i2o_cfg_getlct
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OPARMSET
suffix:colon
id|ret
op_assign
id|i2o_cfg_parms
c_func
(paren
id|arg
comma
id|I2OPARMSET
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OPARMGET
suffix:colon
id|ret
op_assign
id|i2o_cfg_parms
c_func
(paren
id|arg
comma
id|I2OPARMGET
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OSWDL
suffix:colon
id|ret
op_assign
id|i2o_cfg_swdl
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OSWUL
suffix:colon
id|ret
op_assign
id|i2o_cfg_swul
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OSWDEL
suffix:colon
id|ret
op_assign
id|i2o_cfg_swdel
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OVALIDATE
suffix:colon
id|ret
op_assign
id|i2o_cfg_validate
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OEVTREG
suffix:colon
id|ret
op_assign
id|i2o_cfg_evt_reg
c_func
(paren
id|arg
comma
id|fp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2OEVTGET
suffix:colon
id|ret
op_assign
id|i2o_cfg_evt_get
c_func
(paren
id|arg
comma
id|fp
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifndef CONFIG_COMPAT
r_case
id|I2OPASSTHRU
suffix:colon
id|ret
op_assign
id|i2o_cfg_passthru
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|osm_debug
c_func
(paren
l_string|&quot;unknown ioctl called!&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|cfg_open
r_static
r_int
id|cfg_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|i2o_cfg_info
op_star
id|tmp
op_assign
(paren
r_struct
id|i2o_cfg_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2o_cfg_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
(paren
id|i2o_cfg_info_id
op_increment
)paren
suffix:semicolon
id|tmp-&gt;fp
op_assign
id|file
suffix:semicolon
id|tmp-&gt;fasync
op_assign
l_int|NULL
suffix:semicolon
id|tmp-&gt;q_id
op_assign
(paren
id|ulong
)paren
id|file-&gt;private_data
suffix:semicolon
id|tmp-&gt;q_len
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;q_in
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;q_out
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;q_lost
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;next
op_assign
id|open_files
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
id|open_files
op_assign
id|tmp
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cfg_fasync
r_static
r_int
id|cfg_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|fp
comma
r_int
id|on
)paren
(brace
id|ulong
id|id
op_assign
(paren
id|ulong
)paren
id|fp-&gt;private_data
suffix:semicolon
r_struct
id|i2o_cfg_info
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|open_files
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;q_id
op_eq
id|id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_return
id|fasync_helper
c_func
(paren
id|fd
comma
id|fp
comma
id|on
comma
op_amp
id|p-&gt;fasync
)paren
suffix:semicolon
)brace
DECL|function|cfg_release
r_static
r_int
id|cfg_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|ulong
id|id
op_assign
(paren
id|ulong
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|i2o_cfg_info
op_star
id|p1
comma
op_star
id|p2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|p1
op_assign
id|p2
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p1
op_assign
id|open_files
suffix:semicolon
id|p1
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|p1-&gt;q_id
op_eq
id|id
)paren
(brace
r_if
c_cond
(paren
id|p1-&gt;fasync
)paren
id|cfg_fasync
c_func
(paren
op_minus
l_int|1
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p2
)paren
id|p2-&gt;next
op_assign
id|p1-&gt;next
suffix:semicolon
r_else
id|open_files
op_assign
id|p1-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|p1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p2
op_assign
id|p1
suffix:semicolon
id|p1
op_assign
id|p1-&gt;next
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|i2o_config_lock
comma
id|flags
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|config_fops
r_static
r_struct
id|file_operations
id|config_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|ioctl
op_assign
id|i2o_cfg_ioctl
comma
dot
id|open
op_assign
id|cfg_open
comma
dot
id|release
op_assign
id|cfg_release
comma
dot
id|fasync
op_assign
id|cfg_fasync
comma
)brace
suffix:semicolon
DECL|variable|i2o_miscdev
r_static
r_struct
id|miscdevice
id|i2o_miscdev
op_assign
(brace
id|I2O_MINOR
comma
l_string|&quot;i2octl&quot;
comma
op_amp
id|config_fops
)brace
suffix:semicolon
DECL|function|i2o_config_init
r_static
r_int
id|__init
id|i2o_config_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|OSM_DESCRIPTION
l_string|&quot; v&quot;
id|OSM_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|i2o_config_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|i2o_miscdev
)paren
OL
l_int|0
)paren
(brace
id|osm_err
c_func
(paren
l_string|&quot;can&squot;t register device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *      Install our handler&n;&t; */
r_if
c_cond
(paren
id|i2o_driver_register
c_func
(paren
op_amp
id|i2o_config_driver
)paren
)paren
(brace
id|osm_err
c_func
(paren
l_string|&quot;handler register failed.&bslash;n&quot;
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|i2o_miscdev
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_COMPAT
id|register_ioctl32_conversion
c_func
(paren
id|I2OPASSTHRU32
comma
id|i2o_cfg_passthru32
)paren
suffix:semicolon
id|register_ioctl32_conversion
c_func
(paren
id|I2OGETIOPS
comma
(paren
r_void
op_star
)paren
id|sys_ioctl
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2o_config_exit
r_static
r_void
id|i2o_config_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_COMPAT
id|unregister_ioctl32_conversion
c_func
(paren
id|I2OPASSTHRU32
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|I2OGETIOPS
)paren
suffix:semicolon
macro_line|#endif
id|misc_deregister
c_func
(paren
op_amp
id|i2o_miscdev
)paren
suffix:semicolon
id|i2o_driver_unregister
c_func
(paren
op_amp
id|i2o_config_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Red Hat Software&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|OSM_DESCRIPTION
id|MODULE_DESCRIPTION
c_func
(paren
id|OSM_DESCRIPTION
)paren
suffix:semicolon
DECL|variable|OSM_VERSION
id|MODULE_VERSION
c_func
(paren
id|OSM_VERSION
)paren
suffix:semicolon
DECL|variable|i2o_config_init
id|module_init
c_func
(paren
id|i2o_config_init
)paren
suffix:semicolon
DECL|variable|i2o_config_exit
id|module_exit
c_func
(paren
id|i2o_config_exit
)paren
suffix:semicolon
eof
