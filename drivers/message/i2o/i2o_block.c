multiline_comment|/*&n; *&t;Block OSM&n; *&n; * &t;Copyright (C) 1999-2002&t;Red Hat Software&n; *&n; *&t;Written by Alan Cox, Building Number Three Ltd&n; *&n; *&t;This program is free software; you can redistribute it and/or modify it&n; *&t;under the terms of the GNU General Public License as published by the&n; *&t;Free Software Foundation; either version 2 of the License, or (at your&n; *&t;option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful, but&n; *&t;WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *&t;General Public License for more details.&n; *&n; *&t;For the purpose of avoiding doubt the preferred form of the work&n; *&t;for making modifications shall be a standards compliant form such&n; *&t;gzipped tar and not one requiring a proprietary or patent encumbered&n; *&t;tool to unpack.&n; *&n; *&t;Fixes/additions:&n; *&t;&t;Steve Ralston:&n; *&t;&t;&t;Multiple device handling error fixes,&n; *&t;&t;&t;Added a queue depth.&n; *&t;&t;Alan Cox:&n; *&t;&t;&t;FC920 has an rmw bug. Dont or in the end marker.&n; *&t;&t;&t;Removed queue walk, fixed for 64bitness.&n; *&t;&t;&t;Rewrote much of the code over time&n; *&t;&t;&t;Added indirect block lists&n; *&t;&t;&t;Handle 64K limits on many controllers&n; *&t;&t;&t;Don&squot;t use indirects on the Promise (breaks)&n; *&t;&t;&t;Heavily chop down the queue depths&n; *&t;&t;Deepak Saxena:&n; *&t;&t;&t;Independent queues per IOP&n; *&t;&t;&t;Support for dynamic device creation/deletion&n; *&t;&t;&t;Code cleanup&n; *&t;    &t;&t;Support for larger I/Os through merge* functions&n; *&t;&t;&t;(taken from DAC960 driver)&n; *&t;&t;Boji T Kannanthanam:&n; *&t;&t;&t;Set the I2O Block devices to be detected in increasing&n; *&t;&t;&t;order of TIDs during boot.&n; *&t;&t;&t;Search and set the I2O block device that we boot off&n; *&t;&t;&t;from as the first device to be claimed (as /dev/i2o/hda)&n; *&t;&t;&t;Properly attach/detach I2O gendisk structure from the&n; *&t;&t;&t;system gendisk list. The I2O block devices now appear in&n; *&t;&t;&t;/proc/partitions.&n; *&t;&t;Markus Lidel &lt;Markus.Lidel@shadowconnect.com&gt;:&n; *&t;&t;&t;Minor bugfixes for 2.6.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/i2o.h&gt;
macro_line|#include &lt;linux/mempool.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &quot;i2o_block.h&quot;
DECL|variable|i2o_block_driver
r_static
r_struct
id|i2o_driver
id|i2o_block_driver
suffix:semicolon
multiline_comment|/* global Block OSM request mempool */
DECL|variable|i2o_blk_req_pool
r_static
r_struct
id|i2o_block_mempool
id|i2o_blk_req_pool
suffix:semicolon
multiline_comment|/* Block OSM class handling definition */
DECL|variable|i2o_block_class_id
r_static
r_struct
id|i2o_class_id
id|i2o_block_class_id
(braket
)braket
op_assign
(brace
(brace
id|I2O_CLASS_RANDOM_BLOCK_STORAGE
)brace
comma
(brace
id|I2O_CLASS_END
)brace
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_device_free - free the memory of the I2O Block device&n; *&t;@dev: I2O Block device, which should be cleaned up&n; *&n; *&t;Frees the request queue, gendisk and the i2o_block_device structure.&n; */
DECL|function|i2o_block_device_free
r_static
r_void
id|i2o_block_device_free
c_func
(paren
r_struct
id|i2o_block_device
op_star
id|dev
)paren
(brace
id|blk_cleanup_queue
c_func
(paren
id|dev-&gt;gd-&gt;queue
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|dev-&gt;gd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_remove - remove the I2O Block device from the system again&n; *&t;@dev: I2O Block device which should be removed&n; *&n; *&t;Remove gendisk from system and free all allocated memory.&n; *&n; *&t;Always returns 0.&n; */
DECL|function|i2o_block_remove
r_static
r_int
id|i2o_block_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|to_i2o_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|i2o_block_device
op_star
id|i2o_blk_dev
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;block-osm: Device removed %s&bslash;n&quot;
comma
id|i2o_blk_dev-&gt;gd-&gt;disk_name
)paren
suffix:semicolon
id|i2o_event_register
c_func
(paren
id|i2o_dev
comma
op_amp
id|i2o_block_driver
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|del_gendisk
c_func
(paren
id|i2o_blk_dev-&gt;gd
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|i2o_device_claim_release
c_func
(paren
id|i2o_dev
)paren
suffix:semicolon
id|i2o_block_device_free
c_func
(paren
id|i2o_blk_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_device flush - Flush all dirty data of I2O device dev&n; *&t;@dev: I2O device which should be flushed&n; *&n; *&t;Flushes all dirty data on device dev.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_device_flush
r_static
r_int
id|i2o_block_device_flush
c_func
(paren
r_struct
id|i2o_device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|dev-&gt;iop
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_BLOCK_CFLUSH
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|dev-&gt;lct_data.tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|60
op_lshift
l_int|16
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Flushing...&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i2o_msg_post_wait
c_func
(paren
id|dev-&gt;iop
comma
id|m
comma
l_int|60
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_device_mount - Mount (load) the media of device dev&n; *&t;@dev: I2O device which should receive the mount request&n; *&t;@media_id: Media Identifier&n; *&n; *&t;Load a media into drive. Identifier should be set to -1, because the&n; *&t;spec does not support any other value.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_device_mount
r_static
r_int
id|i2o_block_device_mount
c_func
(paren
r_struct
id|i2o_device
op_star
id|dev
comma
id|u32
id|media_id
)paren
(brace
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|dev-&gt;iop
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_BLOCK_MMOUNT
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|dev-&gt;lct_data.tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
op_minus
l_int|1
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Mounting...&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i2o_msg_post_wait
c_func
(paren
id|dev-&gt;iop
comma
id|m
comma
l_int|2
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_device_lock - Locks the media of device dev&n; *&t;@dev: I2O device which should receive the lock request&n; *&t;@media_id: Media Identifier&n; *&n; *&t;Lock media of device dev to prevent removal. The media identifier&n; *&t;should be set to -1, because the spec does not support any other value.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_device_lock
r_static
r_int
id|i2o_block_device_lock
c_func
(paren
r_struct
id|i2o_device
op_star
id|dev
comma
id|u32
id|media_id
)paren
(brace
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|dev-&gt;iop
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_BLOCK_MLOCK
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|dev-&gt;lct_data.tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
op_minus
l_int|1
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Locking...&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i2o_msg_post_wait
c_func
(paren
id|dev-&gt;iop
comma
id|m
comma
l_int|2
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_device_unlock - Unlocks the media of device dev&n; *&t;@dev: I2O device which should receive the unlocked request&n; *&t;@media_id: Media Identifier&n; *&n; *&t;Unlocks the media in device dev. The media identifier should be set to&n; *&t;-1, because the spec does not support any other value.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_device_unlock
r_static
r_int
id|i2o_block_device_unlock
c_func
(paren
r_struct
id|i2o_device
op_star
id|dev
comma
id|u32
id|media_id
)paren
(brace
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|dev-&gt;iop
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_BLOCK_MUNLOCK
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|dev-&gt;lct_data.tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|media_id
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Unlocking...&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i2o_msg_post_wait
c_func
(paren
id|dev-&gt;iop
comma
id|m
comma
l_int|2
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_device_power - Power management for device dev&n; *&t;@dev: I2O device which should receive the power management request&n; *&t;@operation: Operation which should be send&n; *&n; *&t;Send a power management request to the device dev.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_device_power
r_static
r_int
id|i2o_block_device_power
c_func
(paren
r_struct
id|i2o_block_device
op_star
id|dev
comma
id|u8
id|op
)paren
(brace
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|dev-&gt;i2o_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
op_assign
id|i2o_dev-&gt;iop
suffix:semicolon
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_BLOCK_POWER
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|i2o_dev-&gt;lct_data
dot
id|tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|op
op_lshift
l_int|24
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Power...&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|60
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|dev-&gt;power
op_assign
id|op
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_request_alloc - Allocate an I2O block request struct&n; *&n; *&t;Allocates an I2O block request struct and initialize the list.&n; *&n; *&t;Returns a i2o_block_request pointer on success or negative error code&n; *&t;on failure.&n; */
DECL|function|i2o_block_request_alloc
r_static
r_inline
r_struct
id|i2o_block_request
op_star
id|i2o_block_request_alloc
c_func
(paren
r_void
)paren
(brace
r_struct
id|i2o_block_request
op_star
id|ireq
suffix:semicolon
id|ireq
op_assign
id|mempool_alloc
c_func
(paren
id|i2o_blk_req_pool.pool
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ireq
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ireq-&gt;queue
)paren
suffix:semicolon
r_return
id|ireq
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_request_free - Frees a I2O block request&n; *&t;@ireq: I2O block request which should be freed&n; *&n; *&t;Fres the allocated memory (give it back to the request mempool).&n; */
DECL|function|i2o_block_request_free
r_static
r_inline
r_void
id|i2o_block_request_free
c_func
(paren
r_struct
id|i2o_block_request
op_star
id|ireq
)paren
(brace
id|mempool_free
c_func
(paren
id|ireq
comma
id|i2o_blk_req_pool.pool
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_sglist_alloc - Allocate the SG list and map it&n; *&t;@ireq: I2O block request&n; *&n; *&t;Builds the SG list and map it into to be accessable by the controller.&n; *&n; *&t;Returns the number of elements in the SG list or 0 on failure.&n; */
DECL|function|i2o_block_sglist_alloc
r_static
r_inline
r_int
id|i2o_block_sglist_alloc
c_func
(paren
r_struct
id|i2o_block_request
op_star
id|ireq
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|ireq-&gt;i2o_blk_dev-&gt;i2o_dev-&gt;iop-&gt;pdev-&gt;dev
suffix:semicolon
r_int
id|nents
suffix:semicolon
id|nents
op_assign
id|blk_rq_map_sg
c_func
(paren
id|ireq-&gt;req-&gt;q
comma
id|ireq-&gt;req
comma
id|ireq-&gt;sg_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|ireq-&gt;req
)paren
op_eq
id|READ
)paren
id|ireq-&gt;sg_dma_direction
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
r_else
id|ireq-&gt;sg_dma_direction
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
id|ireq-&gt;sg_nents
op_assign
id|dma_map_sg
c_func
(paren
id|dev
comma
id|ireq-&gt;sg_table
comma
id|nents
comma
id|ireq-&gt;sg_dma_direction
)paren
suffix:semicolon
r_return
id|ireq-&gt;sg_nents
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_sglist_free - Frees the SG list&n; *&t;@ireq: I2O block request from which the SG should be freed&n; *&n; *&t;Frees the SG list from the I2O block request.&n; */
DECL|function|i2o_block_sglist_free
r_static
r_inline
r_void
id|i2o_block_sglist_free
c_func
(paren
r_struct
id|i2o_block_request
op_star
id|ireq
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|ireq-&gt;i2o_blk_dev-&gt;i2o_dev-&gt;iop-&gt;pdev-&gt;dev
suffix:semicolon
id|dma_unmap_sg
c_func
(paren
id|dev
comma
id|ireq-&gt;sg_table
comma
id|ireq-&gt;sg_nents
comma
id|ireq-&gt;sg_dma_direction
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_prep_req_fn - Allocates I2O block device specific struct&n; *&t;@q: request queue for the request&n; *&t;@req: the request to prepare&n; *&n; *&t;Allocate the necessary i2o_block_request struct and connect it to&n; *&t;the request. This is needed that we not loose the SG list later on.&n; *&n; *&t;Returns BLKPREP_OK on success or BLKPREP_DEFER on failure.&n; */
DECL|function|i2o_block_prep_req_fn
r_static
r_int
id|i2o_block_prep_req_fn
c_func
(paren
r_struct
id|request_queue
op_star
id|q
comma
r_struct
id|request
op_star
id|req
)paren
(brace
r_struct
id|i2o_block_device
op_star
id|i2o_blk_dev
op_assign
id|q-&gt;queuedata
suffix:semicolon
r_struct
id|i2o_block_request
op_star
id|ireq
suffix:semicolon
multiline_comment|/* request is already processed by us, so return */
r_if
c_cond
(paren
id|req-&gt;flags
op_amp
id|REQ_SPECIAL
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;REQ_SPECIAL already set!&bslash;n&quot;
)paren
suffix:semicolon
id|req-&gt;flags
op_or_assign
id|REQ_DONTPREP
suffix:semicolon
r_return
id|BLKPREP_OK
suffix:semicolon
)brace
multiline_comment|/* connect the i2o_block_request to the request */
r_if
c_cond
(paren
op_logical_neg
id|req-&gt;special
)paren
(brace
id|ireq
op_assign
id|i2o_block_request_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|IS_ERR
c_func
(paren
id|ireq
)paren
)paren
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;unable to allocate i2o_block_request!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|BLKPREP_DEFER
suffix:semicolon
)brace
id|ireq-&gt;i2o_blk_dev
op_assign
id|i2o_blk_dev
suffix:semicolon
id|req-&gt;special
op_assign
id|ireq
suffix:semicolon
id|ireq-&gt;req
op_assign
id|req
suffix:semicolon
)brace
r_else
id|ireq
op_assign
id|req-&gt;special
suffix:semicolon
multiline_comment|/* do not come back here */
id|req-&gt;flags
op_or_assign
id|REQ_DONTPREP
op_or
id|REQ_SPECIAL
suffix:semicolon
r_return
id|BLKPREP_OK
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_delayed_request_fn - delayed request queue function&n; *&t;delayed_request: the delayed request with the queue to start&n; *&n; *&t;If the request queue is stopped for a disk, and there is no open&n; *&t;request, a new event is created, which calls this function to start&n; *&t;the queue after I2O_BLOCK_REQUEST_TIME. Otherwise the queue will never&n; *&t;be started again.&n; */
DECL|function|i2o_block_delayed_request_fn
r_static
r_void
id|i2o_block_delayed_request_fn
c_func
(paren
r_void
op_star
id|delayed_request
)paren
(brace
r_struct
id|i2o_block_delayed_request
op_star
id|dreq
op_assign
id|delayed_request
suffix:semicolon
r_struct
id|request_queue
op_star
id|q
op_assign
id|dreq-&gt;queue
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
id|blk_start_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dreq
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_reply - Block OSM reply handler.&n; *&t;@c: I2O controller from which the message arrives&n; *&t;@m: message id of reply&n; *&t;qmsg: the actuall I2O message reply&n; *&n; *&t;This function gets all the message replies.&n; *&n; */
DECL|function|i2o_block_reply
r_static
r_int
id|i2o_block_reply
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
id|u32
id|m
comma
r_struct
id|i2o_message
op_star
id|msg
)paren
(brace
r_struct
id|i2o_block_request
op_star
id|ireq
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
r_struct
id|i2o_block_device
op_star
id|dev
suffix:semicolon
r_struct
id|request_queue
op_star
id|q
suffix:semicolon
id|u8
id|st
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* FAILed message */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|13
)paren
)paren
)paren
(brace
r_struct
id|i2o_message
op_star
id|pmsg
suffix:semicolon
id|u32
id|pm
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FAILed message from controller&n;&t;&t; * We increment the error count and abort it&n;&t;&t; *&n;&t;&t; * In theory this will never happen.  The I2O block class&n;&t;&t; * specification states that block devices never return&n;&t;&t; * FAILs but instead use the REQ status field...but&n;&t;&t; * better be on the safe side since no one really follows&n;&t;&t; * the spec to the book :)&n;&t;&t; */
id|pm
op_assign
id|le32_to_cpu
c_func
(paren
id|msg-&gt;body
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|pmsg
op_assign
id|i2o_msg_in_to_virt
c_func
(paren
id|c
comma
id|pm
)paren
suffix:semicolon
id|req
op_assign
id|i2o_cntxt_list_get
c_func
(paren
id|c
comma
id|le32_to_cpu
c_func
(paren
id|pmsg-&gt;u.s.tcntxt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|req
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: NULL reply received!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ireq
op_assign
id|req-&gt;special
suffix:semicolon
id|dev
op_assign
id|ireq-&gt;i2o_blk_dev
suffix:semicolon
id|q
op_assign
id|dev-&gt;gd-&gt;queue
suffix:semicolon
id|req-&gt;errors
op_increment
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|end_that_request_chunk
c_func
(paren
id|req
comma
op_logical_neg
id|req-&gt;errors
comma
id|le32_to_cpu
c_func
(paren
id|pmsg-&gt;body
(braket
l_int|1
)braket
)paren
)paren
)paren
suffix:semicolon
id|end_that_request_last
c_func
(paren
id|req
)paren
suffix:semicolon
id|dev-&gt;open_queue_depth
op_decrement
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ireq-&gt;queue
)paren
suffix:semicolon
id|blk_start_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Now flush the message by making it a NOP */
id|i2o_msg_nop
c_func
(paren
id|c
comma
id|pm
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|req
op_assign
id|i2o_cntxt_list_get
c_func
(paren
id|c
comma
id|le32_to_cpu
c_func
(paren
id|msg-&gt;u.s.tcntxt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|req
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: NULL reply received!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ireq
op_assign
id|req-&gt;special
suffix:semicolon
id|dev
op_assign
id|ireq-&gt;i2o_blk_dev
suffix:semicolon
id|q
op_assign
id|dev-&gt;gd-&gt;queue
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|dev-&gt;i2o_dev
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * This is HACK, but Intel Integrated RAID allows user&n;&t;&t; * to delete a volume that is claimed, locked, and in use&n;&t;&t; * by the OS. We have to check for a reply from a&n;&t;&t; * non-existent device and flag it as an error or the system&n;&t;&t; * goes kaput...&n;&t;&t; */
id|req-&gt;errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;I2O Block: Data transfer to deleted device!&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|end_that_request_chunk
(paren
id|req
comma
op_logical_neg
id|req-&gt;errors
comma
id|le32_to_cpu
c_func
(paren
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
)paren
)paren
suffix:semicolon
id|end_that_request_last
c_func
(paren
id|req
)paren
suffix:semicolon
id|dev-&gt;open_queue_depth
op_decrement
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ireq-&gt;queue
)paren
suffix:semicolon
id|blk_start_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *      Lets see what is cooking. We stuffed the&n;&t; *      request in the context.&n;&t; */
id|st
op_assign
id|le32_to_cpu
c_func
(paren
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
op_rshift
l_int|24
suffix:semicolon
r_if
c_cond
(paren
id|st
op_ne
l_int|0
)paren
(brace
r_int
id|err
suffix:semicolon
r_char
op_star
id|bsa_errors
(braket
)braket
op_assign
(brace
l_string|&quot;Success&quot;
comma
l_string|&quot;Media Error&quot;
comma
l_string|&quot;Failure communicating to device&quot;
comma
l_string|&quot;Device Failure&quot;
comma
l_string|&quot;Device is not ready&quot;
comma
l_string|&quot;Media not present&quot;
comma
l_string|&quot;Media is locked by another user&quot;
comma
l_string|&quot;Media has failed&quot;
comma
l_string|&quot;Failure communicating to device&quot;
comma
l_string|&quot;Device bus failure&quot;
comma
l_string|&quot;Device is locked by another user&quot;
comma
l_string|&quot;Device is write protected&quot;
comma
l_string|&quot;Device has reset&quot;
comma
l_string|&quot;Volume has changed, waiting for acknowledgement&quot;
)brace
suffix:semicolon
id|err
op_assign
id|le32_to_cpu
c_func
(paren
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/*&n;&t;&t; *      Device not ready means two things. One is that the&n;&t;&t; *      the thing went offline (but not a removal media)&n;&t;&t; *&n;&t;&t; *      The second is that you have a SuperTrak 100 and the&n;&t;&t; *      firmware got constipated. Unlike standard i2o card&n;&t;&t; *      setups the supertrak returns an error rather than&n;&t;&t; *      blocking for the timeout in these cases.&n;&t;&t; *&n;&t;&t; *      Don&squot;t stick a supertrak100 into cache aggressive modes&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;/dev/%s error: %s&quot;
comma
id|dev-&gt;gd-&gt;disk_name
comma
id|bsa_errors
(braket
id|le32_to_cpu
c_func
(paren
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xffff
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
op_amp
l_int|0x00ff0000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot; - DDM attempted %d retries&quot;
comma
(paren
id|le32_to_cpu
c_func
(paren
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x00ff
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|req-&gt;errors
op_increment
suffix:semicolon
)brace
r_else
id|req-&gt;errors
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|end_that_request_chunk
(paren
id|req
comma
op_logical_neg
id|req-&gt;errors
comma
id|le32_to_cpu
c_func
(paren
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
)paren
)paren
(brace
id|add_disk_randomness
c_func
(paren
id|req-&gt;rq_disk
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
id|end_that_request_last
c_func
(paren
id|req
)paren
suffix:semicolon
id|dev-&gt;open_queue_depth
op_decrement
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ireq-&gt;queue
)paren
suffix:semicolon
id|blk_start_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
id|i2o_block_sglist_free
c_func
(paren
id|ireq
)paren
suffix:semicolon
id|i2o_block_request_free
c_func
(paren
id|ireq
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o_block: still remaining chunks&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
suffix:semicolon
DECL|function|i2o_block_event
r_static
r_void
id|i2o_block_event
c_func
(paren
r_struct
id|i2o_event
op_star
id|evt
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;block-osm: event received&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;SCSI-CAM for ioctl geometry mapping&n; *&t;Duplicated with SCSI - this should be moved into somewhere common&n; *&t;perhaps genhd ?&n; *&n; * LBA -&gt; CHS mapping table taken from:&n; *&n; * &quot;Incorporating the I2O Architecture into BIOS for Intel Architecture&n; *  Platforms&quot;&n; *&n; * This is an I2O document that is only available to I2O members,&n; * not developers.&n; *&n; * From my understanding, this is how all the I2O cards do this&n; *&n; * Disk Size      | Sectors | Heads | Cylinders&n; * ---------------+---------+-------+-------------------&n; * 1 &lt; X &lt;= 528M  | 63      | 16    | X/(63 * 16 * 512)&n; * 528M &lt; X &lt;= 1G | 63      | 32    | X/(63 * 32 * 512)&n; * 1 &lt; X &lt;528M    | 63      | 16    | X/(63 * 16 * 512)&n; * 1 &lt; X &lt;528M    | 63      | 16    | X/(63 * 16 * 512)&n; *&n; */
DECL|macro|BLOCK_SIZE_528M
mdefine_line|#define&t;BLOCK_SIZE_528M&t;&t;1081344
DECL|macro|BLOCK_SIZE_1G
mdefine_line|#define&t;BLOCK_SIZE_1G&t;&t;2097152
DECL|macro|BLOCK_SIZE_21G
mdefine_line|#define&t;BLOCK_SIZE_21G&t;&t;4403200
DECL|macro|BLOCK_SIZE_42G
mdefine_line|#define&t;BLOCK_SIZE_42G&t;&t;8806400
DECL|macro|BLOCK_SIZE_84G
mdefine_line|#define&t;BLOCK_SIZE_84G&t;&t;17612800
DECL|function|i2o_block_biosparam
r_static
r_void
id|i2o_block_biosparam
c_func
(paren
r_int
r_int
id|capacity
comma
r_int
r_int
op_star
id|cyls
comma
r_int
r_char
op_star
id|hds
comma
r_int
r_char
op_star
id|secs
)paren
(brace
r_int
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|sectors
op_assign
l_int|63L
suffix:semicolon
multiline_comment|/* Maximize sectors per track */
r_if
c_cond
(paren
id|capacity
op_le
id|BLOCK_SIZE_528M
)paren
id|heads
op_assign
l_int|16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|capacity
op_le
id|BLOCK_SIZE_1G
)paren
id|heads
op_assign
l_int|32
suffix:semicolon
r_else
r_if
c_cond
(paren
id|capacity
op_le
id|BLOCK_SIZE_21G
)paren
id|heads
op_assign
l_int|64
suffix:semicolon
r_else
r_if
c_cond
(paren
id|capacity
op_le
id|BLOCK_SIZE_42G
)paren
id|heads
op_assign
l_int|128
suffix:semicolon
r_else
id|heads
op_assign
l_int|255
suffix:semicolon
id|cylinders
op_assign
(paren
r_int
r_int
)paren
id|capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
op_star
id|cyls
op_assign
(paren
r_int
r_int
)paren
id|cylinders
suffix:semicolon
multiline_comment|/* Stuff return values */
op_star
id|secs
op_assign
(paren
r_int
r_char
)paren
id|sectors
suffix:semicolon
op_star
id|hds
op_assign
(paren
r_int
r_char
)paren
id|heads
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_block_open - Open the block device&n; *&n; *&t;Power up the device, mount and lock the media. This function is called,&n; *&t;if the block device is opened for access.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_open
r_static
r_int
id|i2o_block_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|i2o_block_device
op_star
id|dev
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;i2o_dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;power
OG
l_int|0x1f
)paren
id|i2o_block_device_power
c_func
(paren
id|dev
comma
l_int|0x02
)paren
suffix:semicolon
id|i2o_block_device_mount
c_func
(paren
id|dev-&gt;i2o_dev
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|i2o_block_device_lock
c_func
(paren
id|dev-&gt;i2o_dev
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Ready.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_release - Release the I2O block device&n; *&n; *&t;Unlock and unmount the media, and power down the device. Gets called if&n; *&t;the block device is closed.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_release
r_static
r_int
id|i2o_block_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk
suffix:semicolon
r_struct
id|i2o_block_device
op_star
id|dev
op_assign
id|disk-&gt;private_data
suffix:semicolon
id|u8
id|operation
suffix:semicolon
multiline_comment|/*&n;&t; * This is to deail with the case of an application&n;&t; * opening a device and then the device dissapears while&n;&t; * it&squot;s in use, and then the application tries to release&n;&t; * it.  ex: Unmounting a deleted RAID volume at reboot.&n;&t; * If we send messages, it will just cause FAILs since&n;&t; * the TID no longer exists.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;i2o_dev
)paren
r_return
l_int|0
suffix:semicolon
id|i2o_block_device_flush
c_func
(paren
id|dev-&gt;i2o_dev
)paren
suffix:semicolon
id|i2o_block_device_unlock
c_func
(paren
id|dev-&gt;i2o_dev
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
l_int|1
op_lshift
l_int|3
op_or
l_int|1
op_lshift
l_int|4
)paren
)paren
multiline_comment|/* Removable */
id|operation
op_assign
l_int|0x21
suffix:semicolon
r_else
id|operation
op_assign
l_int|0x24
suffix:semicolon
id|i2o_block_device_power
c_func
(paren
id|dev
comma
id|operation
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_block_ioctl - Issue device specific ioctl calls.&n; *&t;@cmd: ioctl command&n; *&t;@arg: arg&n; *&n; *&t;Handles ioctl request for the block device.&n; *&n; *&t;Return 0 on success or negative error on failure.&n; */
DECL|function|i2o_block_ioctl
r_static
r_int
id|i2o_block_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk
suffix:semicolon
r_struct
id|i2o_block_device
op_star
id|dev
op_assign
id|disk-&gt;private_data
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
multiline_comment|/* Anyone capable of this syscall can do *real bad* things */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|HDIO_GETGEO
suffix:colon
(brace
r_struct
id|hd_geometry
id|g
suffix:semicolon
id|i2o_block_biosparam
c_func
(paren
id|get_capacity
c_func
(paren
id|disk
)paren
comma
op_amp
id|g.cylinders
comma
op_amp
id|g.heads
comma
op_amp
id|g.sectors
)paren
suffix:semicolon
id|g.start
op_assign
id|get_start_sect
c_func
(paren
id|inode-&gt;i_bdev
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|g
comma
r_sizeof
(paren
id|g
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|BLKI2OGRSTRAT
suffix:colon
r_return
id|put_user
c_func
(paren
id|dev-&gt;rcache
comma
(paren
r_int
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|BLKI2OGWSTRAT
suffix:colon
r_return
id|put_user
c_func
(paren
id|dev-&gt;wcache
comma
(paren
r_int
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|BLKI2OSRSTRAT
suffix:colon
r_if
c_cond
(paren
id|arg
template_param
id|CACHE_SMARTFETCH
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;rcache
op_assign
id|arg
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BLKI2OSWSTRAT
suffix:colon
r_if
c_cond
(paren
id|arg
op_ne
l_int|0
op_logical_and
(paren
id|arg
template_param
id|CACHE_SMARTBACK
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;wcache
op_assign
id|arg
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_media_changed - Have we seen a media change?&n; *&t;@disk: gendisk which should be verified&n; *&n; *&t;Verifies if the media has changed.&n; *&n; *&t;Returns 1 if the media was changed or 0 otherwise.&n; */
DECL|function|i2o_block_media_changed
r_static
r_int
id|i2o_block_media_changed
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_struct
id|i2o_block_device
op_star
id|p
op_assign
id|disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;media_change_flag
)paren
(brace
id|p-&gt;media_change_flag
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_block_transfer - Transfer a request to/from the I2O controller&n; *&t;@req: the request which should be transfered&n; *&n; *&t;This function converts the request into a I2O message. The necessary&n; *&t;DMA buffers are allocated and after everything is setup post the message&n; *&t;to the I2O controller. No cleanup is done by this function. It is done&n; *&t;on the interrupt side when the reply arrives.&n; *&n; *&t;Return 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_transfer
r_static
r_int
id|i2o_block_transfer
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
(brace
r_struct
id|i2o_block_device
op_star
id|dev
op_assign
id|req-&gt;rq_disk-&gt;private_data
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
op_assign
id|dev-&gt;i2o_dev-&gt;iop
suffix:semicolon
r_int
id|tid
op_assign
id|dev-&gt;i2o_dev-&gt;lct_data.tid
suffix:semicolon
r_struct
id|i2o_message
id|__iomem
op_star
id|msg
suffix:semicolon
r_void
id|__iomem
op_star
id|mptr
suffix:semicolon
r_struct
id|i2o_block_request
op_star
id|ireq
op_assign
id|req-&gt;special
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|sgnum
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|u32
id|tcntxt
suffix:semicolon
id|u32
id|sg_flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|m
op_assign
id|i2o_msg_get
c_func
(paren
id|c
comma
op_amp
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
(brace
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|tcntxt
op_assign
id|i2o_cntxt_list_add
c_func
(paren
id|c
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tcntxt
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|nop_msg
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sgnum
op_assign
id|i2o_block_sglist_alloc
c_func
(paren
id|ireq
)paren
)paren
op_le
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|context_remove
suffix:semicolon
)brace
multiline_comment|/* Build the message based on the request. */
id|writel
c_func
(paren
id|i2o_block_driver.context
comma
op_amp
id|msg-&gt;u.s.icntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tcntxt
comma
op_amp
id|msg-&gt;u.s.tcntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
id|req-&gt;nr_sectors
op_lshift
l_int|9
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
(paren
(paren
id|u64
)paren
id|req-&gt;sector
)paren
op_lshift
l_int|9
)paren
op_amp
l_int|0xffffffff
comma
op_amp
id|msg-&gt;body
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|req-&gt;sector
op_rshift
l_int|23
comma
op_amp
id|msg-&gt;body
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|mptr
op_assign
op_amp
id|msg-&gt;body
(braket
l_int|4
)braket
suffix:semicolon
id|sg
op_assign
id|ireq-&gt;sg_table
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|READ
)paren
(brace
id|writel
c_func
(paren
id|I2O_CMD_BLOCK_READ
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|sg_flags
op_assign
l_int|0x10000000
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;rcache
)paren
(brace
r_case
id|CACHE_NULL
suffix:colon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CACHE_PREFETCH
suffix:colon
id|writel
c_func
(paren
l_int|0x201F0008
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CACHE_SMARTFETCH
suffix:colon
r_if
c_cond
(paren
id|req-&gt;nr_sectors
OG
l_int|16
)paren
id|writel
c_func
(paren
l_int|0x201F0008
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
l_int|0x001F0000
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|writel
c_func
(paren
id|I2O_CMD_BLOCK_WRITE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|sg_flags
op_assign
l_int|0x14000000
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;wcache
)paren
(brace
r_case
id|CACHE_NULL
suffix:colon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CACHE_WRITETHROUGH
suffix:colon
id|writel
c_func
(paren
l_int|0x001F0008
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CACHE_WRITEBACK
suffix:colon
id|writel
c_func
(paren
l_int|0x001F0010
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CACHE_SMARTBACK
suffix:colon
r_if
c_cond
(paren
id|req-&gt;nr_sectors
OG
l_int|16
)paren
id|writel
c_func
(paren
l_int|0x001F0004
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
l_int|0x001F0010
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CACHE_SMARTTHROUGH
suffix:colon
r_if
c_cond
(paren
id|req-&gt;nr_sectors
OG
l_int|16
)paren
id|writel
c_func
(paren
l_int|0x001F0004
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
l_int|0x001F0010
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
id|sgnum
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
id|sg_flags
op_or_assign
l_int|0x80000000
suffix:semicolon
id|writel
c_func
(paren
id|sg_flags
op_or
id|sg_dma_len
c_func
(paren
id|sg
)paren
comma
id|mptr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
comma
id|mptr
op_plus
l_int|4
)paren
suffix:semicolon
id|mptr
op_add_assign
l_int|8
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
id|writel
c_func
(paren
id|I2O_MESSAGE_SIZE
(paren
(paren
(paren
r_int
r_int
)paren
id|mptr
op_minus
(paren
r_int
r_int
)paren
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
op_rshift
l_int|2
)paren
op_or
id|SGL_OFFSET_8
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i2o_msg_post
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ireq-&gt;queue
comma
op_amp
id|dev-&gt;open_queue
)paren
suffix:semicolon
id|dev-&gt;open_queue_depth
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|context_remove
suffix:colon
id|i2o_cntxt_list_remove
c_func
(paren
id|c
comma
id|req
)paren
suffix:semicolon
id|nop_msg
suffix:colon
id|i2o_msg_nop
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_request_fn - request queue handling function&n; *&t;q: request queue from which the request could be fetched&n; *&n; *&t;Takes the next request from the queue, transfers it and if no error&n; *&t;occurs dequeue it from the queue. On arrival of the reply the message&n; *&t;will be processed further. If an error occurs requeue the request.&n; */
DECL|function|i2o_block_request_fn
r_static
r_void
id|i2o_block_request_fn
c_func
(paren
r_struct
id|request_queue
op_star
id|q
)paren
(brace
r_struct
id|request
op_star
id|req
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|blk_queue_plugged
c_func
(paren
id|q
)paren
)paren
(brace
id|req
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|blk_fs_request
c_func
(paren
id|req
)paren
)paren
(brace
r_struct
id|i2o_block_delayed_request
op_star
id|dreq
suffix:semicolon
r_struct
id|i2o_block_request
op_star
id|ireq
op_assign
id|req-&gt;special
suffix:semicolon
r_int
r_int
id|queue_depth
suffix:semicolon
id|queue_depth
op_assign
id|ireq-&gt;i2o_blk_dev-&gt;open_queue_depth
suffix:semicolon
r_if
c_cond
(paren
id|queue_depth
OL
id|I2O_BLOCK_MAX_OPEN_REQUESTS
)paren
r_if
c_cond
(paren
op_logical_neg
id|i2o_block_transfer
c_func
(paren
id|req
)paren
)paren
(brace
id|blkdev_dequeue_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|queue_depth
)paren
r_break
suffix:semicolon
multiline_comment|/* stop the queue and retry later */
id|dreq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dreq
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dreq
)paren
r_continue
suffix:semicolon
id|dreq-&gt;queue
op_assign
id|q
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|dreq-&gt;work
comma
id|i2o_block_delayed_request_fn
comma
id|dreq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;block-osm: transfer error&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_delayed_work
c_func
(paren
id|i2o_block_driver.event_queue
comma
op_amp
id|dreq-&gt;work
comma
id|I2O_BLOCK_RETRY_TIME
)paren
)paren
id|kfree
c_func
(paren
id|dreq
)paren
suffix:semicolon
r_else
(brace
id|blk_stop_queue
c_func
(paren
id|q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
suffix:semicolon
multiline_comment|/* I2O Block device operations definition */
DECL|variable|i2o_block_fops
r_static
r_struct
id|block_device_operations
id|i2o_block_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|i2o_block_open
comma
dot
id|release
op_assign
id|i2o_block_release
comma
dot
id|ioctl
op_assign
id|i2o_block_ioctl
comma
dot
id|media_changed
op_assign
id|i2o_block_media_changed
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_device_alloc - Allocate memory for a I2O Block device&n; *&n; *&t;Allocate memory for the i2o_block_device struct, gendisk and request&n; *&t;queue and initialize them as far as no additional information is needed.&n; *&n; *&t;Returns a pointer to the allocated I2O Block device on succes or a&n; *&t;negative error code on failure.&n; */
DECL|function|i2o_block_device_alloc
r_static
r_struct
id|i2o_block_device
op_star
id|i2o_block_device_alloc
c_func
(paren
r_void
)paren
(brace
r_struct
id|i2o_block_device
op_star
id|dev
suffix:semicolon
r_struct
id|gendisk
op_star
id|gd
suffix:semicolon
r_struct
id|request_queue
op_star
id|queue
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: Insufficient memory to allocate &quot;
l_string|&quot;I2O Block disk.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dev-&gt;open_queue
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;rcache
op_assign
id|CACHE_PREFETCH
suffix:semicolon
id|dev-&gt;wcache
op_assign
id|CACHE_WRITEBACK
suffix:semicolon
multiline_comment|/* allocate a gendisk with 16 partitions */
id|gd
op_assign
id|alloc_disk
c_func
(paren
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gd
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: Insufficient memory to allocate &quot;
l_string|&quot;gendisk.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup_dev
suffix:semicolon
)brace
multiline_comment|/* initialize the request queue */
id|queue
op_assign
id|blk_init_queue
c_func
(paren
id|i2o_block_request_fn
comma
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: Insufficient memory to allocate &quot;
l_string|&quot;request queue.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup_queue
suffix:semicolon
)brace
id|blk_queue_prep_rq
c_func
(paren
id|queue
comma
id|i2o_block_prep_req_fn
)paren
suffix:semicolon
id|gd-&gt;major
op_assign
id|I2O_MAJOR
suffix:semicolon
id|gd-&gt;queue
op_assign
id|queue
suffix:semicolon
id|gd-&gt;fops
op_assign
op_amp
id|i2o_block_fops
suffix:semicolon
id|gd-&gt;private_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;gd
op_assign
id|gd
suffix:semicolon
r_return
id|dev
suffix:semicolon
id|cleanup_queue
suffix:colon
id|put_disk
c_func
(paren
id|gd
)paren
suffix:semicolon
id|cleanup_dev
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|ERR_PTR
c_func
(paren
id|rc
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_probe - verify if dev is a I2O Block device and install it&n; *&t;@dev: device to verify if it is a I2O Block device&n; *&n; *&t;We only verify if the user_tid of the device is 0xfff and then install&n; *&t;the device. Otherwise it is used by some other device (e. g. RAID).&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_probe
r_static
r_int
id|i2o_block_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|i2o_device
op_star
id|i2o_dev
op_assign
id|to_i2o_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|i2o_block_device
op_star
id|i2o_blk_dev
suffix:semicolon
r_struct
id|i2o_controller
op_star
id|c
op_assign
id|i2o_dev-&gt;iop
suffix:semicolon
r_struct
id|gendisk
op_star
id|gd
suffix:semicolon
r_struct
id|request_queue
op_star
id|queue
suffix:semicolon
r_static
r_int
id|unit
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|u64
id|size
suffix:semicolon
id|u32
id|blocksize
suffix:semicolon
id|u16
id|power
suffix:semicolon
id|u32
id|flags
comma
id|status
suffix:semicolon
r_int
id|segments
suffix:semicolon
multiline_comment|/* skip devices which are used by IOP */
r_if
c_cond
(paren
id|i2o_dev-&gt;lct_data.user_tid
op_ne
l_int|0xfff
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;skipping used device %03x&bslash;n&quot;
comma
id|i2o_dev-&gt;lct_data.tid
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;block-osm: New device detected (TID: %03x)&bslash;n&quot;
comma
id|i2o_dev-&gt;lct_data.tid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_device_claim
c_func
(paren
id|i2o_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;block-osm: Unable to claim device. &quot;
l_string|&quot;Installation aborted&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|i2o_blk_dev
op_assign
id|i2o_block_device_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|i2o_blk_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: could not alloc a new I2O block&quot;
l_string|&quot;device&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|PTR_ERR
c_func
(paren
id|i2o_blk_dev
)paren
suffix:semicolon
r_goto
id|claim_release
suffix:semicolon
)brace
id|i2o_blk_dev-&gt;i2o_dev
op_assign
id|i2o_dev
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
id|i2o_blk_dev
)paren
suffix:semicolon
multiline_comment|/* setup gendisk */
id|gd
op_assign
id|i2o_blk_dev-&gt;gd
suffix:semicolon
id|gd-&gt;first_minor
op_assign
id|unit
op_lshift
l_int|4
suffix:semicolon
id|sprintf
c_func
(paren
id|gd-&gt;disk_name
comma
l_string|&quot;i2o/hd%c&quot;
comma
l_char|&squot;a&squot;
op_plus
id|unit
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|gd-&gt;devfs_name
comma
l_string|&quot;i2o/hd%c&quot;
comma
l_char|&squot;a&squot;
op_plus
id|unit
)paren
suffix:semicolon
id|gd-&gt;driverfs_dev
op_assign
op_amp
id|i2o_dev-&gt;device
suffix:semicolon
multiline_comment|/* setup request queue */
id|queue
op_assign
id|gd-&gt;queue
suffix:semicolon
id|queue-&gt;queuedata
op_assign
id|i2o_blk_dev
suffix:semicolon
id|blk_queue_max_phys_segments
c_func
(paren
id|queue
comma
id|I2O_MAX_SEGMENTS
)paren
suffix:semicolon
id|blk_queue_max_sectors
c_func
(paren
id|queue
comma
id|I2O_MAX_SECTORS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;short_req
)paren
id|segments
op_assign
l_int|8
suffix:semicolon
r_else
(brace
id|i2o_status_block
op_star
id|sb
suffix:semicolon
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
id|segments
op_assign
(paren
id|sb-&gt;inbound_frame_size
op_minus
r_sizeof
(paren
r_struct
id|i2o_message
)paren
op_div
l_int|4
op_minus
l_int|4
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|blk_queue_max_hw_segments
c_func
(paren
id|queue
comma
id|segments
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;max sectors:   %d&bslash;n&quot;
comma
id|I2O_MAX_SECTORS
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;phys segments: %d&bslash;n&quot;
comma
id|I2O_MAX_SEGMENTS
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;hw segments:   %d&bslash;n&quot;
comma
id|segments
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      Ask for the current media data. If that isn&squot;t supported&n;&t; *      then we ask for the device capacity data&n;&t; */
r_if
c_cond
(paren
id|i2o_parm_field_get
c_func
(paren
id|i2o_dev
comma
l_int|0x0004
comma
l_int|1
comma
op_amp
id|blocksize
comma
l_int|4
)paren
op_ne
l_int|0
op_logical_or
id|i2o_parm_field_get
c_func
(paren
id|i2o_dev
comma
l_int|0x0004
comma
l_int|0
comma
op_amp
id|size
comma
l_int|8
)paren
op_ne
l_int|0
)paren
(brace
id|i2o_parm_field_get
c_func
(paren
id|i2o_dev
comma
l_int|0x0000
comma
l_int|3
comma
op_amp
id|blocksize
comma
l_int|4
)paren
suffix:semicolon
id|i2o_parm_field_get
c_func
(paren
id|i2o_dev
comma
l_int|0x0000
comma
l_int|4
comma
op_amp
id|size
comma
l_int|8
)paren
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;blocksize:     %d&bslash;n&quot;
comma
id|blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_parm_field_get
c_func
(paren
id|i2o_dev
comma
l_int|0x0000
comma
l_int|2
comma
op_amp
id|power
comma
l_int|2
)paren
)paren
id|power
op_assign
l_int|0
suffix:semicolon
id|i2o_parm_field_get
c_func
(paren
id|i2o_dev
comma
l_int|0x0000
comma
l_int|5
comma
op_amp
id|flags
comma
l_int|4
)paren
suffix:semicolon
id|i2o_parm_field_get
c_func
(paren
id|i2o_dev
comma
l_int|0x0000
comma
l_int|6
comma
op_amp
id|status
comma
l_int|4
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
id|gd
comma
id|size
op_rshift
l_int|9
)paren
suffix:semicolon
id|i2o_event_register
c_func
(paren
id|i2o_dev
comma
op_amp
id|i2o_block_driver
comma
l_int|0
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|add_disk
c_func
(paren
id|gd
)paren
suffix:semicolon
id|unit
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|claim_release
suffix:colon
id|i2o_device_claim_release
c_func
(paren
id|i2o_dev
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Block OSM driver struct */
DECL|variable|i2o_block_driver
r_static
r_struct
id|i2o_driver
id|i2o_block_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;block-osm&quot;
comma
dot
id|event
op_assign
id|i2o_block_event
comma
dot
id|reply
op_assign
id|i2o_block_reply
comma
dot
id|classes
op_assign
id|i2o_block_class_id
comma
dot
id|driver
op_assign
(brace
dot
id|probe
op_assign
id|i2o_block_probe
comma
dot
id|remove
op_assign
id|i2o_block_remove
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_init - Block OSM initialization function&n; *&n; *&t;Allocate the slab and mempool for request structs, registers i2o_block&n; *&t;block device and finally register the Block OSM in the I2O core.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_block_init
r_static
r_int
id|__init
id|i2o_block_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
id|size
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;I2O Block Storage OSM v0.9&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;   (c) Copyright 1999-2001 Red Hat Software.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Allocate request mempool and slab */
id|size
op_assign
r_sizeof
(paren
r_struct
id|i2o_block_request
)paren
suffix:semicolon
id|i2o_blk_req_pool.slab
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;i2o_block_req&quot;
comma
id|size
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2o_blk_req_pool.slab
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: can&squot;t init request slab&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|i2o_blk_req_pool.pool
op_assign
id|mempool_create
c_func
(paren
id|I2O_REQ_MEMPOOL_SIZE
comma
id|mempool_alloc_slab
comma
id|mempool_free_slab
comma
id|i2o_blk_req_pool.slab
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2o_blk_req_pool.pool
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: can&squot;t init request mempool&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_slab
suffix:semicolon
)brace
multiline_comment|/* Register the block device interfaces */
id|rc
op_assign
id|register_blkdev
c_func
(paren
id|I2O_MAJOR
comma
l_string|&quot;i2o_block&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: unable to register block device&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|free_mempool
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;block-osm: registered device at major %d&bslash;n&quot;
comma
id|I2O_MAJOR
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Register Block OSM into I2O core */
id|rc
op_assign
id|i2o_driver_register
c_func
(paren
op_amp
id|i2o_block_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;block-osm: Could not register Block driver&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unregister_blkdev
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|unregister_blkdev
suffix:colon
id|unregister_blkdev
c_func
(paren
id|I2O_MAJOR
comma
l_string|&quot;i2o_block&quot;
)paren
suffix:semicolon
id|free_mempool
suffix:colon
id|mempool_destroy
c_func
(paren
id|i2o_blk_req_pool.pool
)paren
suffix:semicolon
id|free_slab
suffix:colon
id|kmem_cache_destroy
c_func
(paren
id|i2o_blk_req_pool.slab
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_block_exit - Block OSM exit function&n; *&n; *&t;Unregisters Block OSM from I2O core, unregisters i2o_block block device&n; *&t;and frees the mempool and slab.&n; */
DECL|function|i2o_block_exit
r_static
r_void
id|__exit
id|i2o_block_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Unregister I2O Block OSM from I2O core */
id|i2o_driver_unregister
c_func
(paren
op_amp
id|i2o_block_driver
)paren
suffix:semicolon
multiline_comment|/* Unregister block device */
id|unregister_blkdev
c_func
(paren
id|I2O_MAJOR
comma
l_string|&quot;i2o_block&quot;
)paren
suffix:semicolon
multiline_comment|/* Free request mempool and slab */
id|mempool_destroy
c_func
(paren
id|i2o_blk_req_pool.pool
)paren
suffix:semicolon
id|kmem_cache_destroy
c_func
(paren
id|i2o_blk_req_pool.slab
)paren
suffix:semicolon
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Red Hat&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;I2O Block Device OSM&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|i2o_block_init
id|module_init
c_func
(paren
id|i2o_block_init
)paren
suffix:semicolon
DECL|variable|i2o_block_exit
id|module_exit
c_func
(paren
id|i2o_block_exit
)paren
suffix:semicolon
eof
