multiline_comment|/*&n; *&t;Functions to handle I2O controllers and I2O message handling&n; *&n; *&t;Copyright (C) 1999-2002&t;Red Hat Software&n; *&n; *&t;Written by Alan Cox, Building Number Three Ltd&n; *&n; *&t;This program is free software; you can redistribute it and/or modify it&n; *&t;under the terms of the GNU General Public License as published by the&n; *&t;Free Software Foundation; either version 2 of the License, or (at your&n; *&t;option) any later version.&n; *&n; *&t;A lot of the I2O message side code from this is taken from the&n; *&t;Red Creek RCPCI45 adapter driver by Red Creek Communications&n; *&n; *&t;Fixes/additions:&n; *&t;&t;Philipp Rumpf&n; *&t;&t;Juha Siev&#xfffd;nen &lt;Juha.Sievanen@cs.Helsinki.FI&gt;&n; *&t;&t;Auvo H&#xfffd;kkinen &lt;Auvo.Hakkinen@cs.Helsinki.FI&gt;&n; *&t;&t;Deepak Saxena &lt;deepak@plexity.net&gt;&n; *&t;&t;Boji T Kannanthanam &lt;boji.t.kannanthanam@intel.com&gt;&n; *&t;&t;Alan Cox &lt;alan@redhat.com&gt;:&n; *&t;&t;&t;Ported to Linux 2.5.&n; *&t;&t;Markus Lidel &lt;Markus.Lidel@shadowconnect.com&gt;:&n; *&t;&t;&t;Minor fixes for 2.6.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/i2o.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
multiline_comment|/* global I2O controller list */
DECL|variable|i2o_controllers
id|LIST_HEAD
c_func
(paren
id|i2o_controllers
)paren
suffix:semicolon
multiline_comment|/*&n; * global I2O System Table. Contains information about all the IOPs in the&n; * system. Used to inform IOPs about each others existence.&n; */
DECL|variable|i2o_systab
r_static
r_struct
id|i2o_dma
id|i2o_systab
suffix:semicolon
multiline_comment|/* Module internal functions from other sources */
r_extern
r_struct
id|i2o_driver
id|i2o_exec_driver
suffix:semicolon
r_extern
r_int
id|i2o_exec_lct_get
c_func
(paren
r_struct
id|i2o_controller
op_star
)paren
suffix:semicolon
r_extern
r_void
id|i2o_device_remove
c_func
(paren
r_struct
id|i2o_device
op_star
)paren
suffix:semicolon
r_extern
r_int
id|__init
id|i2o_driver_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|__exit
id|i2o_driver_exit
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|__init
id|i2o_exec_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|__exit
id|i2o_exec_exit
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|__init
id|i2o_pci_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|__exit
id|i2o_pci_exit
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|i2o_device_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|i2o_device_exit
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_msg_nop - Returns a message which is not used&n; *&t;@c: I2O controller from which the message was created&n; *&t;@m: message which should be returned&n; *&n; *&t;If you fetch a message via i2o_msg_get, and can&squot;t use it, you must&n; *&t;return the message with this function. Otherwise the message frame&n; *&t;is lost.&n; */
DECL|function|i2o_msg_nop
r_void
id|i2o_msg_nop
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
id|u32
id|m
)paren
(brace
r_struct
id|i2o_message
op_star
id|msg
op_assign
id|c-&gt;in_queue.virt
op_plus
id|m
suffix:semicolon
id|writel
c_func
(paren
id|THREE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_UTIL_NOP
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|i2o_msg_post
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_msg_get_wait - obtain an I2O message from the IOP&n; *&t;@c: I2O controller&n; *&t;@msg: pointer to a I2O message pointer&n; *&t;@wait: how long to wait until timeout&n; *&n; *&t;This function waits up to wait seconds for a message slot to be&n; *&t;available.&n; *&n; *&t;On a success the message is returned and the pointer to the message is&n; *&t;set in msg. The returned message is the physical page frame offset&n; *&t;address from the read port (see the i2o spec). If no message is&n; *&t;available returns I2O_QUEUE_EMPTY and msg is leaved untouched.&n; */
DECL|function|i2o_msg_get_wait
id|u32
id|i2o_msg_get_wait
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_struct
id|i2o_message
op_star
op_star
id|msg
comma
r_int
id|wait
)paren
(brace
r_int
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|wait
op_star
id|HZ
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_while
c_loop
(paren
(paren
id|m
op_assign
id|i2o_msg_get
c_func
(paren
id|c
comma
id|msg
)paren
)paren
op_eq
id|I2O_QUEUE_EMPTY
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: Timeout waiting for message frame.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_return
id|I2O_QUEUE_EMPTY
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|m
suffix:semicolon
)brace
suffix:semicolon
macro_line|#if BITS_PER_LONG == 64
multiline_comment|/**&n; *      i2o_cntxt_list_add - Append a pointer to context list and return a id&n; *&t;@c: controller to which the context list belong&n; *&t;@ptr: pointer to add to the context list&n; *&n; *&t;Because the context field in I2O is only 32-bit large, on 64-bit the&n; *&t;pointer is to large to fit in the context field. The i2o_cntxt_list&n; *&t;functions therefore map pointers to context fields.&n; *&n; *&t;Returns context id &gt; 0 on success or 0 on failure.&n; */
DECL|function|i2o_cntxt_list_add
id|u32
id|i2o_cntxt_list_add
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|i2o_context_list_element
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;NULL pointer found!&bslash;n&quot;
)paren
suffix:semicolon
id|entry
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|entry
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: Could not allocate memory for context &quot;
l_string|&quot;list element&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|entry-&gt;ptr
op_assign
id|ptr
suffix:semicolon
id|entry-&gt;timestamp
op_assign
id|jiffies
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|entry-&gt;list
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|c-&gt;context_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|atomic_inc_and_test
c_func
(paren
op_amp
id|c-&gt;context_list_counter
)paren
)paren
)paren
id|atomic_inc
c_func
(paren
op_amp
id|c-&gt;context_list_counter
)paren
suffix:semicolon
id|entry-&gt;context
op_assign
id|atomic_read
c_func
(paren
op_amp
id|c-&gt;context_list_counter
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|entry-&gt;list
comma
op_amp
id|c-&gt;context_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|c-&gt;context_list_lock
comma
id|flags
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Add context to list %p -&gt; %d&bslash;n&quot;
comma
id|ptr
comma
id|context
)paren
suffix:semicolon
r_return
id|entry-&gt;context
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *      i2o_cntxt_list_remove - Remove a pointer from the context list&n; *&t;@c: controller to which the context list belong&n; *&t;@ptr: pointer which should be removed from the context list&n; *&n; *&t;Removes a previously added pointer from the context list and returns&n; *&t;the matching context id.&n; *&n; *&t;Returns context id on succes or 0 on failure.&n; */
DECL|function|i2o_cntxt_list_remove
id|u32
id|i2o_cntxt_list_remove
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|i2o_context_list_element
op_star
id|entry
suffix:semicolon
id|u32
id|context
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|c-&gt;context_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|c-&gt;context_list
comma
id|list
)paren
r_if
c_cond
(paren
id|entry-&gt;ptr
op_eq
id|ptr
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|entry-&gt;list
)paren
suffix:semicolon
id|context
op_assign
id|entry-&gt;context
suffix:semicolon
id|kfree
c_func
(paren
id|entry
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|c-&gt;context_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|context
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o: Could not remove nonexistent ptr &quot;
l_string|&quot;%p&bslash;n&quot;
comma
id|ptr
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;remove ptr from context list %d -&gt; %p&bslash;n&quot;
comma
id|context
comma
id|ptr
)paren
suffix:semicolon
r_return
id|context
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *      i2o_cntxt_list_get - Get a pointer from the context list and remove it&n; *&t;@c: controller to which the context list belong&n; *&t;@context: context id to which the pointer belong&n; *&n; *&t;Returns pointer to the matching context id on success or NULL on&n; *&t;failure.&n; */
DECL|function|i2o_cntxt_list_get
r_void
op_star
id|i2o_cntxt_list_get
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
id|u32
id|context
)paren
(brace
r_struct
id|i2o_context_list_element
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_void
op_star
id|ptr
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|c-&gt;context_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|c-&gt;context_list
comma
id|list
)paren
r_if
c_cond
(paren
id|entry-&gt;context
op_eq
id|context
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|entry-&gt;list
)paren
suffix:semicolon
id|ptr
op_assign
id|entry-&gt;ptr
suffix:semicolon
id|kfree
c_func
(paren
id|entry
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|c-&gt;context_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o: context id %d not found&bslash;n&quot;
comma
id|context
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;get ptr from context list %d -&gt; %p&bslash;n&quot;
comma
id|context
comma
id|ptr
)paren
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *      i2o_cntxt_list_get_ptr - Get a context id from the context list&n; *&t;@c: controller to which the context list belong&n; *&t;@ptr: pointer to which the context id should be fetched&n; *&n; *&t;Returns context id which matches to the pointer on succes or 0 on&n; *&t;failure.&n; */
DECL|function|i2o_cntxt_list_get_ptr
id|u32
id|i2o_cntxt_list_get_ptr
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|i2o_context_list_element
op_star
id|entry
suffix:semicolon
id|u32
id|context
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|c-&gt;context_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|c-&gt;context_list
comma
id|list
)paren
r_if
c_cond
(paren
id|entry-&gt;ptr
op_eq
id|ptr
)paren
(brace
id|context
op_assign
id|entry-&gt;context
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|c-&gt;context_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|context
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o: Could not find nonexistent ptr &quot;
l_string|&quot;%p&bslash;n&quot;
comma
id|ptr
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;get context id from context list %p -&gt; %d&bslash;n&quot;
comma
id|ptr
comma
id|context
)paren
suffix:semicolon
r_return
id|context
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/**&n; *&t;i2o_iop_find - Find an I2O controller by id&n; *&t;@unit: unit number of the I2O controller to search for&n; *&n; *&t;Lookup the I2O controller on the controller list.&n; *&n; *&t;Returns pointer to the I2O controller on success or NULL if not found.&n; */
DECL|function|i2o_find_iop
r_struct
id|i2o_controller
op_star
id|i2o_find_iop
c_func
(paren
r_int
id|unit
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|c
comma
op_amp
id|i2o_controllers
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;unit
op_eq
id|unit
)paren
r_return
id|c
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_find_device - Find a I2O device on an I2O controller&n; *&t;@c: I2O controller where the I2O device hangs on&n; *&t;@tid: TID of the I2O device to search for&n; *&n; *&t;Searches the devices of the I2O controller for a device with TID tid and&n; *&t;returns it.&n; *&n; *&t;Returns a pointer to the I2O device if found, otherwise NULL.&n; */
DECL|function|i2o_iop_find_device
r_struct
id|i2o_device
op_star
id|i2o_iop_find_device
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
comma
id|u16
id|tid
)paren
(brace
r_struct
id|i2o_device
op_star
id|dev
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;devices
comma
id|list
)paren
r_if
c_cond
(paren
id|dev-&gt;lct_data.tid
op_eq
id|tid
)paren
r_return
id|dev
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_quiesce_controller - quiesce controller&n; *&t;@c: controller&n; *&n; *&t;Quiesce an IOP. Causes IOP to make external operation quiescent&n; *&t;(i2o &squot;READY&squot; state). Internal operation of the IOP continues normally.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_iop_quiesce
r_static
r_int
id|i2o_iop_quiesce
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|i2o_status_block
op_star
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|i2o_status_get
c_func
(paren
id|c
)paren
suffix:semicolon
multiline_comment|/* SysQuiesce discarded if IOP not in READY or OPERATIONAL state */
r_if
c_cond
(paren
(paren
id|sb-&gt;iop_state
op_ne
id|ADAPTER_STATE_READY
)paren
op_logical_and
(paren
id|sb-&gt;iop_state
op_ne
id|ADAPTER_STATE_OPERATIONAL
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_SYS_QUIESCE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* Long timeout needed for quiesce if lots of devices */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|240
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to quiesce (status=%#x).&bslash;n&quot;
comma
id|c-&gt;name
comma
op_minus
id|rc
)paren
suffix:semicolon
r_else
id|pr_debug
c_func
(paren
l_string|&quot;%s: Quiesced.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_status_get
c_func
(paren
id|c
)paren
suffix:semicolon
singleline_comment|// Entered READY state
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_enable - move controller from ready to OPERATIONAL&n; *&t;@c: I2O controller&n; *&n; *&t;Enable IOP. This allows the IOP to resume external operations and&n; *&t;reverses the effect of a quiesce. Returns zero or an error code if&n; *&t;an error occurs.&n; */
DECL|function|i2o_iop_enable
r_static
r_int
id|i2o_iop_enable
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|i2o_status_block
op_star
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|i2o_status_get
c_func
(paren
id|c
)paren
suffix:semicolon
multiline_comment|/* Enable only allowed on READY state */
r_if
c_cond
(paren
id|sb-&gt;iop_state
op_ne
id|ADAPTER_STATE_READY
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_SYS_ENABLE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* How long of a timeout do we need? */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|240
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Could not enable (status=%#x).&bslash;n&quot;
comma
id|c-&gt;name
comma
op_minus
id|rc
)paren
suffix:semicolon
r_else
id|pr_debug
c_func
(paren
l_string|&quot;%s: Enabled.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_status_get
c_func
(paren
id|c
)paren
suffix:semicolon
singleline_comment|// entered OPERATIONAL state
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_quiesce_all - Quiesce all I2O controllers on the system&n; *&n; *&t;Quiesce all I2O controllers which are connected to the system.&n; */
DECL|function|i2o_iop_quiesce_all
r_static
r_inline
r_void
id|i2o_iop_quiesce_all
c_func
(paren
r_void
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
comma
op_star
id|tmp
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|c
comma
id|tmp
comma
op_amp
id|i2o_controllers
comma
id|list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;no_quiesce
)paren
id|i2o_iop_quiesce
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_enable_all - Enables all controllers on the system&n; *&n; *&t;Enables all I2O controllers which are connected to the system.&n; */
DECL|function|i2o_iop_enable_all
r_static
r_inline
r_void
id|i2o_iop_enable_all
c_func
(paren
r_void
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
comma
op_star
id|tmp
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|c
comma
id|tmp
comma
op_amp
id|i2o_controllers
comma
id|list
)paren
id|i2o_iop_enable
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_clear_controller - Bring I2O controller into HOLD state&n; *&t;@c: controller&n; *&n; *&t;Clear an IOP to HOLD state, ie. terminate external operations, clear all&n; *&t;input queues and prepare for a system restart. IOP&squot;s internal operation&n; *&t;continues normally and the outbound queue is alive. The IOP is not&n; *&t;expected to rebuild its LCT.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_iop_clear
r_static
r_int
id|i2o_iop_clear
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
multiline_comment|/* Quiesce all IOPs first */
id|i2o_iop_quiesce_all
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_ADAPTER_CLEAR
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|30
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to clear (status=%#x).&bslash;n&quot;
comma
id|c-&gt;name
comma
op_minus
id|rc
)paren
suffix:semicolon
r_else
id|pr_debug
c_func
(paren
l_string|&quot;%s: Cleared.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Enable all IOPs */
id|i2o_iop_enable_all
c_func
(paren
)paren
suffix:semicolon
id|i2o_status_get
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_iop_reset - reset an I2O controller&n; *&t;@c: controller to reset&n; *&n; *&t;Reset the IOP into INIT state and wait until IOP gets into RESET state.&n; *&t;Terminate all external operations, clear IOP&squot;s inbound and outbound&n; *&t;queues, terminate all DDMs, and reload the IOP&squot;s operating environment&n; *&t;and all local DDMs. The IOP rebuilds its LCT.&n; */
DECL|function|i2o_iop_reset
r_static
r_int
id|i2o_iop_reset
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|u8
op_star
id|status
op_assign
id|c-&gt;status.virt
suffix:semicolon
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|i2o_status_block
op_star
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Resetting controller&bslash;n&quot;
)paren
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|memset
c_func
(paren
id|status
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Quiesce all IOPs first */
id|i2o_iop_quiesce_all
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|EIGHT_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_ADAPTER_RESET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_exec_driver.context
comma
op_amp
id|msg-&gt;u.s.icntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;u.s.tcntxt
)paren
suffix:semicolon
singleline_comment|//FIXME: use reasonable transaction context
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_ptr_low
c_func
(paren
(paren
r_void
op_star
)paren
id|c-&gt;status.phys
)paren
comma
op_amp
id|msg-&gt;body
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_ptr_high
c_func
(paren
(paren
r_void
op_star
)paren
id|c-&gt;status.phys
)paren
comma
op_amp
id|msg-&gt;body
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|i2o_msg_post
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
multiline_comment|/* Wait for a reply */
id|timeout
op_assign
id|jiffies
op_plus
id|I2O_TIMEOUT_RESET
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
op_star
id|status
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP reset timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* Promise bug */
r_if
c_cond
(paren
id|status
(braket
l_int|1
)braket
op_logical_or
id|status
(braket
l_int|4
)braket
)paren
(brace
op_star
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|status
op_eq
id|I2O_CMD_IN_PROGRESS
)paren
(brace
multiline_comment|/*&n;&t;&t; * Once the reset is sent, the IOP goes into the INIT state&n;&t;&t; * which is indeterminate.  We need to wait until the IOP&n;&t;&t; * has rebooted before we can let the system talk to&n;&t;&t; * it. We read the inbound Free_List until a message is&n;&t;&t; * available. If we can&squot;t read one in the given ammount of&n;&t;&t; * time, we assume the IOP could not reboot properly.&n;&t;&t; */
id|pr_debug
c_func
(paren
l_string|&quot;%s: Reset in progress, waiting for reboot...&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_RESET
)paren
suffix:semicolon
r_while
c_loop
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP reset timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_RESET
)paren
suffix:semicolon
)brace
id|i2o_msg_nop
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
)brace
multiline_comment|/* from here all quiesce commands are safe */
id|c-&gt;no_quiesce
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If IopReset was rejected or didn&squot;t perform reset, try IopClear */
id|i2o_status_get
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|status
op_eq
id|I2O_CMD_REJECTED
op_logical_or
id|sb-&gt;iop_state
op_ne
id|ADAPTER_STATE_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Reset rejected, trying to clear&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_iop_clear
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
r_else
id|pr_debug
c_func
(paren
l_string|&quot;%s: Reset completed.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
m_exit
suffix:colon
multiline_comment|/* Enable all IOPs */
id|i2o_iop_enable_all
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_init_outbound_queue - setup the outbound message queue&n; *&t;@c: I2O controller&n; *&n; *&t;Clear and (re)initialize IOP&squot;s outbound queue and post the message&n; *&t;frames to the IOP.&n; *&n; *&t;Returns 0 on success or a negative errno code on failure.&n; */
DECL|function|i2o_iop_init_outbound_queue
r_int
id|i2o_iop_init_outbound_queue
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|u8
op_star
id|status
op_assign
id|c-&gt;status.virt
suffix:semicolon
id|u32
id|m
suffix:semicolon
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|ulong
id|timeout
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: Initializing Outbound Queue...&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|memset
c_func
(paren
id|status
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|EIGHT_WORD_MSG_SIZE
op_or
id|TRL_OFFSET_6
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_OUTBOUND_INIT
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_exec_driver.context
comma
op_amp
id|msg-&gt;u.s.icntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0106
comma
op_amp
id|msg-&gt;u.s.tcntxt
)paren
suffix:semicolon
multiline_comment|/* FIXME: why 0x0106, maybe in&n;&t;&t;&t;&t;&t;&t;   Spec? */
id|writel
c_func
(paren
id|PAGE_SIZE
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MSG_FRAME_SIZE
op_lshift
l_int|16
op_or
l_int|0x80
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* Outbound msg frame&n;&t;&t;&t;&t;&t;&t;&t;&t;   size in words and Initcode */
id|writel
c_func
(paren
l_int|0xd0000004
comma
op_amp
id|msg-&gt;body
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_ptr_low
c_func
(paren
(paren
r_void
op_star
)paren
id|c-&gt;status.phys
)paren
comma
op_amp
id|msg-&gt;body
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_ptr_high
c_func
(paren
(paren
r_void
op_star
)paren
id|c-&gt;status.phys
)paren
comma
op_amp
id|msg-&gt;body
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|i2o_msg_post
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|I2O_TIMEOUT_INIT_OUTBOUND_QUEUE
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
op_star
id|status
op_le
id|I2O_CMD_IN_PROGRESS
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Timeout Initializing&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
id|m
op_assign
id|c-&gt;out_queue.phys
suffix:semicolon
multiline_comment|/* Post frames */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NMBR_MSG_FRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|i2o_flush_reply
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Promise */
id|m
op_add_assign
id|MSG_FRAME_SIZE
op_star
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_iop_send_nop - send a core NOP message&n; *&t;@c: controller&n; *&n; *&t;Send a no-operation message with a reply set to cause no&n; *&t;action either. Needed for bringing up promise controllers.&n; */
DECL|function|i2o_iop_send_nop
r_static
r_int
id|i2o_iop_send_nop
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|i2o_msg_nop
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_iop_activate - Bring controller up to HOLD&n; *&t;@c: controller&n; *&n; *&t;This function brings an I2O controller into HOLD state. The adapter&n; *&t;is reset if necessary and then the queues and resource table are read.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_iop_activate
r_static
r_int
id|i2o_iop_activate
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|pci_dev
op_star
id|i960
op_assign
l_int|NULL
suffix:semicolon
id|i2o_status_block
op_star
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;promise
)paren
(brace
multiline_comment|/* Beat up the hardware first of all */
id|i960
op_assign
id|pci_find_slot
c_func
(paren
id|c-&gt;pdev-&gt;bus-&gt;number
comma
id|PCI_DEVFN
c_func
(paren
id|PCI_SLOT
c_func
(paren
id|c-&gt;pdev-&gt;devfn
)paren
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i960
)paren
id|pci_write_config_word
c_func
(paren
id|i960
comma
l_int|0x42
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Follow this sequence precisely or the controller&n;&t;&t;   ceases to perform useful functions until reboot */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_iop_send_nop
c_func
(paren
id|c
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_iop_reset
c_func
(paren
id|c
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* In INIT state, Wait Inbound Q to initialize (in i2o_status_get) */
multiline_comment|/* In READY state, Get status */
id|rc
op_assign
id|i2o_status_get
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unable to obtain status of %s, &quot;
l_string|&quot;attempting a reset.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_iop_reset
c_func
(paren
id|c
)paren
)paren
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb-&gt;i2o_version
OG
id|I2OVER15
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Not running vrs. 1.5. of the I2O &quot;
l_string|&quot;Specification.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sb-&gt;iop_state
)paren
(brace
r_case
id|ADAPTER_STATE_FAULTED
suffix:colon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: hardware fault&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ADAPTER_STATE_READY
suffix:colon
r_case
id|ADAPTER_STATE_OPERATIONAL
suffix:colon
r_case
id|ADAPTER_STATE_HOLD
suffix:colon
r_case
id|ADAPTER_STATE_FAILED
suffix:colon
id|pr_debug
c_func
(paren
l_string|&quot;already running, trying to reset...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2o_iop_reset
c_func
(paren
id|c
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|i2o_iop_init_outbound_queue
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;promise
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_iop_send_nop
c_func
(paren
id|c
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_status_get
c_func
(paren
id|c
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|i960
)paren
id|pci_write_config_word
c_func
(paren
id|i960
comma
l_int|0x42
comma
l_int|0x3FF
)paren
suffix:semicolon
)brace
multiline_comment|/* In HOLD state */
id|rc
op_assign
id|i2o_hrt_get
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_systab_set - Set the I2O System Table of the specified IOP&n; *&t;@c: I2O controller to which the system table should be send&n; *&n; *&t;Before the systab could be set i2o_systab_build() must be called.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_iop_systab_set
r_static
r_int
id|i2o_iop_systab_set
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|i2o_status_block
op_star
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|c-&gt;pdev-&gt;dev
suffix:semicolon
r_struct
id|resource
op_star
id|root
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;current_mem_size
OL
id|sb-&gt;desired_mem_size
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|c-&gt;mem_resource
suffix:semicolon
id|res-&gt;name
op_assign
id|c-&gt;pdev-&gt;bus-&gt;name
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
id|res-&gt;start
op_assign
l_int|0
suffix:semicolon
id|res-&gt;end
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: requires private memory resources.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|root
op_assign
id|pci_find_parent_resource
c_func
(paren
id|c-&gt;pdev
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t find parent resource!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root
op_logical_and
id|allocate_resource
c_func
(paren
id|root
comma
id|res
comma
id|sb-&gt;desired_mem_size
comma
id|sb-&gt;desired_mem_size
comma
id|sb-&gt;desired_mem_size
comma
l_int|1
op_lshift
l_int|20
comma
multiline_comment|/* Unspecified, so use 1Mb and play safe */
l_int|NULL
comma
l_int|NULL
)paren
op_ge
l_int|0
)paren
(brace
id|c-&gt;mem_alloc
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;current_mem_size
op_assign
l_int|1
op_plus
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|sb-&gt;current_mem_base
op_assign
id|res-&gt;start
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: allocated %ld bytes of PCI memory at 0x%08lX.&bslash;n&quot;
comma
id|c-&gt;name
comma
l_int|1
op_plus
id|res-&gt;end
op_minus
id|res-&gt;start
comma
id|res-&gt;start
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sb-&gt;current_io_size
OL
id|sb-&gt;desired_io_size
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|c-&gt;io_resource
suffix:semicolon
id|res-&gt;name
op_assign
id|c-&gt;pdev-&gt;bus-&gt;name
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|res-&gt;start
op_assign
l_int|0
suffix:semicolon
id|res-&gt;end
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: requires private memory resources.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|root
op_assign
id|pci_find_parent_resource
c_func
(paren
id|c-&gt;pdev
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t find parent resource!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root
op_logical_and
id|allocate_resource
c_func
(paren
id|root
comma
id|res
comma
id|sb-&gt;desired_io_size
comma
id|sb-&gt;desired_io_size
comma
id|sb-&gt;desired_io_size
comma
l_int|1
op_lshift
l_int|20
comma
multiline_comment|/* Unspecified, so use 1Mb and play safe */
l_int|NULL
comma
l_int|NULL
)paren
op_ge
l_int|0
)paren
(brace
id|c-&gt;io_alloc
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;current_io_size
op_assign
l_int|1
op_plus
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|sb-&gt;current_mem_base
op_assign
id|res-&gt;start
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: allocated %ld bytes of PCI I/O at 0x%08lX.&bslash;n&quot;
comma
id|c-&gt;name
comma
l_int|1
op_plus
id|res-&gt;end
op_minus
id|res-&gt;start
comma
id|res-&gt;start
)paren
suffix:semicolon
)brace
)brace
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|i2o_systab.phys
op_assign
id|dma_map_single
c_func
(paren
id|dev
comma
id|i2o_systab.virt
comma
id|i2o_systab.len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2o_systab.phys
)paren
(brace
id|i2o_msg_nop
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|writel
c_func
(paren
id|I2O_MESSAGE_SIZE
c_func
(paren
l_int|12
)paren
op_or
id|SGL_OFFSET_6
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_SYS_TAB_SET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Provide three SGL-elements:&n;&t; * System table (SysTab), Private memory space declaration and&n;&t; * Private i/o space declaration&n;&t; *&n;&t; * FIXME: is this still true?&n;&t; * Nasty one here. We can&squot;t use dma_alloc_coherent to send the&n;&t; * same table to everyone. We have to go remap it for them all&n;&t; */
id|writel
c_func
(paren
id|c-&gt;unit
op_plus
l_int|2
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x54000000
op_or
id|i2o_systab.len
comma
op_amp
id|msg-&gt;body
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_systab.phys
comma
op_amp
id|msg-&gt;body
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x54000000
op_or
id|sb-&gt;current_mem_size
comma
op_amp
id|msg-&gt;body
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|sb-&gt;current_mem_base
comma
op_amp
id|msg-&gt;body
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xd4000000
op_or
id|sb-&gt;current_io_size
comma
op_amp
id|msg-&gt;body
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|sb-&gt;current_io_base
comma
op_amp
id|msg-&gt;body
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|rc
op_assign
id|i2o_msg_post_wait
c_func
(paren
id|c
comma
id|m
comma
l_int|120
)paren
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|dev
comma
id|i2o_systab.phys
comma
id|i2o_systab.len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to set SysTab (status=%#x).&bslash;n&quot;
comma
id|c-&gt;name
comma
op_minus
id|rc
)paren
suffix:semicolon
r_else
id|pr_debug
c_func
(paren
l_string|&quot;%s: SysTab set.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_status_get
c_func
(paren
id|c
)paren
suffix:semicolon
singleline_comment|// Entered READY state
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_iop_online - Bring a controller online into OPERATIONAL state.&n; *&t;@c: I2O controller&n; *&n; *&t;Send the system table and enable the I2O controller.&n; *&n; *&t;Returns 0 on success or negativer error code on failure.&n; */
DECL|function|i2o_iop_online
r_static
r_int
id|i2o_iop_online
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|i2o_iop_systab_set
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* In READY state */
id|pr_debug
c_func
(paren
l_string|&quot;%s: Attempting to enable...&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|rc
op_assign
id|i2o_iop_enable
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_remove - Remove the I2O controller from the I2O core&n; *&t;@c: I2O controller&n; *&n; *&t;Remove the I2O controller from the I2O core. If devices are attached to&n; *&t;the controller remove these also and finally reset the controller.&n; */
DECL|function|i2o_iop_remove
r_void
id|i2o_iop_remove
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_device
op_star
id|dev
comma
op_star
id|tmp
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Deleting controller %s&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_driver_notify_controller_remove_all
c_func
(paren
id|c
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|c-&gt;list
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|dev
comma
id|tmp
comma
op_amp
id|c-&gt;devices
comma
id|list
)paren
id|i2o_device_remove
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Ask the IOP to switch to RESET state */
id|i2o_iop_reset
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_systab_build - Build system table&n; *&n; *&t;The system table contains information about all the IOPs in the system&n; *&t;(duh) and is used by the Executives on the IOPs to establish peer2peer&n; *&t;connections. We&squot;re not supporting peer2peer at the moment, but this&n; *&t;will be needed down the road for things like lan2lan forwarding.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_systab_build
r_static
r_int
id|i2o_systab_build
c_func
(paren
r_void
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
comma
op_star
id|tmp
suffix:semicolon
r_int
id|num_controllers
op_assign
l_int|0
suffix:semicolon
id|u32
id|change_ind
op_assign
l_int|0
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_struct
id|i2o_sys_tbl
op_star
id|systab
op_assign
id|i2o_systab.virt
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|c
comma
id|tmp
comma
op_amp
id|i2o_controllers
comma
id|list
)paren
id|num_controllers
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|systab
)paren
(brace
id|change_ind
op_assign
id|systab-&gt;change_ind
suffix:semicolon
id|kfree
c_func
(paren
id|i2o_systab.virt
)paren
suffix:semicolon
)brace
multiline_comment|/* Header + IOPs */
id|i2o_systab.len
op_assign
r_sizeof
(paren
r_struct
id|i2o_sys_tbl
)paren
op_plus
id|num_controllers
op_star
r_sizeof
(paren
r_struct
id|i2o_sys_tbl_entry
)paren
suffix:semicolon
id|systab
op_assign
id|i2o_systab.virt
op_assign
id|kmalloc
c_func
(paren
id|i2o_systab.len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|systab
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: unable to allocate memory for System &quot;
l_string|&quot;Table&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|systab
comma
l_int|0
comma
id|i2o_systab.len
)paren
suffix:semicolon
id|systab-&gt;version
op_assign
id|I2OVERSION
suffix:semicolon
id|systab-&gt;change_ind
op_assign
id|change_ind
op_plus
l_int|1
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|c
comma
id|tmp
comma
op_amp
id|i2o_controllers
comma
id|list
)paren
(brace
id|i2o_status_block
op_star
id|sb
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
id|num_controllers
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: controller added while building &quot;
l_string|&quot;system table&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sb
op_assign
id|c-&gt;status_block.virt
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Get updated IOP state so we have the latest information&n;&t;&t; *&n;&t;&t; * We should delete the controller at this point if it&n;&t;&t; * doesn&squot;t respond since if it&squot;s not on the system table&n;&t;&t; * it is techninically not part of the I2O subsystem...&n;&t;&t; */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|i2o_status_get
c_func
(paren
id|c
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Deleting b/c could not get status&quot;
l_string|&quot; while attempting to build system table&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_iop_remove
c_func
(paren
id|c
)paren
suffix:semicolon
r_continue
suffix:semicolon
singleline_comment|// try the next one
)brace
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|org_id
op_assign
id|sb-&gt;org_id
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|iop_id
op_assign
id|c-&gt;unit
op_plus
l_int|2
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|seg_num
op_assign
l_int|0
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|i2o_version
op_assign
id|sb-&gt;i2o_version
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|iop_state
op_assign
id|sb-&gt;iop_state
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|msg_type
op_assign
id|sb-&gt;msg_type
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|frame_size
op_assign
id|sb-&gt;inbound_frame_size
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|last_changed
op_assign
id|change_ind
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|iop_capabilities
op_assign
id|sb-&gt;iop_capabilities
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|inbound_low
op_assign
id|i2o_ptr_low
c_func
(paren
id|c-&gt;post_port
)paren
suffix:semicolon
id|systab-&gt;iops
(braket
id|count
)braket
dot
id|inbound_high
op_assign
id|i2o_ptr_high
c_func
(paren
id|c-&gt;post_port
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
id|systab-&gt;num_entries
op_assign
id|count
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_parse_hrt - Parse the hardware resource table.&n; *&t;@c: I2O controller&n; *&n; *&t;We don&squot;t do anything with it except dumping it (in debug mode).&n; *&n; *&t;Returns 0.&n; */
DECL|function|i2o_parse_hrt
r_static
r_int
id|i2o_parse_hrt
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|i2o_dump_hrt
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_status_get - Get the status block from the I2O controller&n; *&t;@c: I2O controller&n; *&n; *&t;Issue a status query on the controller. This updates the attached&n; *&t;status block. The status block could then be accessed through&n; *&t;c-&gt;status_block.&n; *&n; *&t;Returns 0 on sucess or negative error code on failure.&n; */
DECL|function|i2o_status_get
r_int
id|i2o_status_get
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|u8
op_star
id|status_block
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|status_block
op_assign
(paren
id|u8
op_star
)paren
id|c-&gt;status_block.virt
suffix:semicolon
id|memset
c_func
(paren
id|status_block
comma
l_int|0
comma
r_sizeof
(paren
id|i2o_status_block
)paren
)paren
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_STATUS_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_exec_driver.context
comma
op_amp
id|msg-&gt;u.s.icntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;u.s.tcntxt
)paren
suffix:semicolon
singleline_comment|// FIXME: use resonable transaction context
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_ptr_low
c_func
(paren
(paren
r_void
op_star
)paren
id|c-&gt;status_block.phys
)paren
comma
op_amp
id|msg-&gt;body
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|i2o_ptr_high
c_func
(paren
(paren
r_void
op_star
)paren
id|c-&gt;status_block.phys
)paren
comma
op_amp
id|msg-&gt;body
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
r_sizeof
(paren
id|i2o_status_block
)paren
comma
op_amp
id|msg-&gt;body
(braket
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* always 88 bytes */
id|i2o_msg_post
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
multiline_comment|/* Wait for a reply */
id|timeout
op_assign
id|jiffies
op_plus
id|I2O_TIMEOUT_STATUS_GET
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|status_block
(braket
l_int|87
)braket
op_ne
l_int|0xFF
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Get status timeout.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|i2o_debug_state
c_func
(paren
id|c
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;i2o_hrt_get - Get the Hardware Resource Table from the I2O controller&n; *&t;@c: I2O controller from which the HRT should be fetched&n; *&n; *&t;The HRT contains information about possible hidden devices but is&n; *&t;mostly useless to us.&n; *&n; *&t;Returns 0 on success or negativer error code on failure.&n; */
DECL|function|i2o_hrt_get
r_int
id|i2o_hrt_get
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i2o_hrt
op_star
id|hrt
op_assign
id|c-&gt;hrt.virt
suffix:semicolon
id|u32
id|size
op_assign
r_sizeof
(paren
id|i2o_hrt
)paren
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|c-&gt;pdev-&gt;dev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|I2O_HRT_GET_TRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_4
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_HRT_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xd0000000
op_or
id|c-&gt;hrt.len
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|c-&gt;hrt.phys
comma
op_amp
id|msg-&gt;body
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|rc
op_assign
id|i2o_msg_post_wait_mem
c_func
(paren
id|c
comma
id|m
comma
l_int|20
comma
op_amp
id|c-&gt;hrt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to get HRT (status=%#x)&bslash;n&quot;
comma
id|c-&gt;name
comma
op_minus
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|size
op_assign
id|hrt-&gt;num_entries
op_star
id|hrt-&gt;entry_len
op_lshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|c-&gt;hrt.len
)paren
(brace
r_if
c_cond
(paren
id|i2o_dma_realloc
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;hrt
comma
id|size
comma
id|GFP_KERNEL
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_else
id|hrt
op_assign
id|c-&gt;hrt.virt
suffix:semicolon
)brace
r_else
r_return
id|i2o_parse_hrt
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to get HRT after %d tries, giving up&bslash;n&quot;
comma
id|c-&gt;name
comma
id|I2O_HRT_GET_TRIES
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_iop_alloc - Allocate and initialize a i2o_controller struct&n; *&n; *&t;Allocate the necessary memory for a i2o_controller struct and&n; *&t;initialize the lists.&n; *&n; *&t;Returns a pointer to the I2O controller or a negative error code on&n; *&t;failure.&n; */
DECL|function|i2o_iop_alloc
r_struct
id|i2o_controller
op_star
id|i2o_iop_alloc
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|unit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0 and 1 are NULL IOP and Local Host */
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|c
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|c
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: Insufficient memory to allocate the &quot;
l_string|&quot;controller.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|c
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|c
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|c-&gt;devices
)paren
suffix:semicolon
id|c-&gt;lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|c-&gt;lct_lock
)paren
suffix:semicolon
id|c-&gt;unit
op_assign
id|unit
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|c-&gt;name
comma
l_string|&quot;iop%d&quot;
comma
id|c-&gt;unit
)paren
suffix:semicolon
macro_line|#if BITS_PER_LONG == 64
id|c-&gt;context_list_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|c-&gt;context_list_counter
comma
l_int|0
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|c-&gt;context_list
)paren
suffix:semicolon
macro_line|#endif
r_return
id|c
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_free - Free the i2o_controller struct&n; *&t;@c: I2O controller to free&n; */
DECL|function|i2o_iop_free
r_void
id|i2o_iop_free
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|kfree
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_add - Initialize the I2O controller and add him to the I2O core&n; *&t;@c: controller&n; *&n; *&t;Initialize the I2O controller and if no error occurs add him to the I2O&n; *&t;core.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_iop_add
r_int
id|i2o_iop_add
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_int
id|rc
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Activating I2O controller...&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: This may take a few minutes if there are many &quot;
l_string|&quot;devices&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_iop_activate
c_func
(paren
id|c
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: controller could not activated&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_iop_reset
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;building sys table %s...&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_systab_build
c_func
(paren
)paren
)paren
)paren
(brace
id|i2o_iop_reset
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;online controller %s...&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_iop_online
c_func
(paren
id|c
)paren
)paren
)paren
(brace
id|i2o_iop_reset
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;getting LCT %s...&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_exec_lct_get
c_func
(paren
id|c
)paren
)paren
)paren
(brace
id|i2o_iop_reset
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|c-&gt;list
comma
op_amp
id|i2o_controllers
)paren
suffix:semicolon
id|i2o_driver_notify_controller_add_all
c_func
(paren
id|c
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Controller added&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_event_register - Turn on/off event notification for a I2O device&n; *&t;@dev: I2O device which should receive the event registration request&n; *&t;@drv: driver which want to get notified&n; *&t;@tcntxt: transaction context to use with this notifier&n; *&t;@evt_mask: mask of events&n; *&n; *&t;Create and posts an event registration message to the task. No reply&n; *&t;is waited for, or expected. If you do not want further notifications,&n; *&t;call the i2o_event_register again with a evt_mask of 0.&n; *&n; *&t;Returns 0 on success or -ETIMEDOUT if no message could be fetched for&n; *&t;sending the request.&n; */
DECL|function|i2o_event_register
r_int
id|i2o_event_register
c_func
(paren
r_struct
id|i2o_device
op_star
id|dev
comma
r_struct
id|i2o_driver
op_star
id|drv
comma
r_int
id|tcntxt
comma
id|u32
id|evt_mask
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
op_assign
id|dev-&gt;iop
suffix:semicolon
r_struct
id|i2o_message
op_star
id|msg
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|m
op_assign
id|i2o_msg_get_wait
c_func
(paren
id|c
comma
op_amp
id|msg
comma
id|I2O_TIMEOUT_MESSAGE_GET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|I2O_QUEUE_EMPTY
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|writel
c_func
(paren
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_UTIL_EVT_REGISTER
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|dev-&gt;lct_data
dot
id|tid
comma
op_amp
id|msg-&gt;u.head
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|drv-&gt;context
comma
op_amp
id|msg-&gt;u.s.icntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tcntxt
comma
op_amp
id|msg-&gt;u.s.tcntxt
)paren
suffix:semicolon
id|writel
c_func
(paren
id|evt_mask
comma
op_amp
id|msg-&gt;body
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i2o_msg_post
c_func
(paren
id|c
comma
id|m
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_iop_init - I2O main initialization function&n; *&n; *&t;Initialize the I2O drivers (OSM) functions, register the Executive OSM,&n; *&t;initialize the I2O PCI part and finally initialize I2O device stuff.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_iop_init
r_static
r_int
id|__init
id|i2o_iop_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;I2O Core - (C) Copyright 1999 Red Hat Software&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|i2o_device_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
m_exit
suffix:semicolon
id|rc
op_assign
id|i2o_driver_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|device_exit
suffix:semicolon
id|rc
op_assign
id|i2o_exec_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|driver_exit
suffix:semicolon
id|rc
op_assign
id|i2o_pci_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|exec_exit
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|exec_exit
suffix:colon
id|i2o_exec_exit
c_func
(paren
)paren
suffix:semicolon
id|driver_exit
suffix:colon
id|i2o_driver_exit
c_func
(paren
)paren
suffix:semicolon
id|device_exit
suffix:colon
id|i2o_device_exit
c_func
(paren
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_iop_exit - I2O main exit function&n; *&n; *&t;Removes I2O controllers from PCI subsystem and shut down OSMs.&n; */
DECL|function|i2o_iop_exit
r_static
r_void
id|__exit
id|i2o_iop_exit
c_func
(paren
r_void
)paren
(brace
id|i2o_pci_exit
c_func
(paren
)paren
suffix:semicolon
id|i2o_exec_exit
c_func
(paren
)paren
suffix:semicolon
id|i2o_driver_exit
c_func
(paren
)paren
suffix:semicolon
id|i2o_device_exit
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|i2o_iop_init
id|module_init
c_func
(paren
id|i2o_iop_init
)paren
suffix:semicolon
DECL|variable|i2o_iop_exit
id|module_exit
c_func
(paren
id|i2o_iop_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Red Hat Software&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;I2O Core&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#if BITS_PER_LONG == 64
DECL|variable|i2o_cntxt_list_add
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_cntxt_list_add
)paren
suffix:semicolon
DECL|variable|i2o_cntxt_list_get
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_cntxt_list_get
)paren
suffix:semicolon
DECL|variable|i2o_cntxt_list_remove
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_cntxt_list_remove
)paren
suffix:semicolon
DECL|variable|i2o_cntxt_list_get_ptr
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_cntxt_list_get_ptr
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|i2o_msg_get_wait
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_msg_get_wait
)paren
suffix:semicolon
DECL|variable|i2o_msg_nop
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_msg_nop
)paren
suffix:semicolon
DECL|variable|i2o_find_iop
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_find_iop
)paren
suffix:semicolon
DECL|variable|i2o_iop_find_device
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_iop_find_device
)paren
suffix:semicolon
DECL|variable|i2o_event_register
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_event_register
)paren
suffix:semicolon
DECL|variable|i2o_status_get
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_status_get
)paren
suffix:semicolon
DECL|variable|i2o_hrt_get
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_hrt_get
)paren
suffix:semicolon
DECL|variable|i2o_controllers
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_controllers
)paren
suffix:semicolon
eof
