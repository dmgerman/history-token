multiline_comment|/*&n; *&t;PCI handling of I2O controller&n; *&n; * &t;Copyright (C) 1999-2002&t;Red Hat Software&n; *&n; *&t;Written by Alan Cox, Building Number Three Ltd&n; *&n; *&t;This program is free software; you can redistribute it and/or modify it&n; *&t;under the terms of the GNU General Public License as published by the&n; *&t;Free Software Foundation; either version 2 of the License, or (at your&n; *&t;option) any later version.&n; *&n; *&t;A lot of the I2O message side code from this is taken from the Red&n; *&t;Creek RCPCI45 adapter driver by Red Creek Communications&n; *&n; *&t;Fixes/additions:&n; *&t;&t;Philipp Rumpf&n; *&t;&t;Juha Siev&#xfffd;nen &lt;Juha.Sievanen@cs.Helsinki.FI&gt;&n; *&t;&t;Auvo H&#xfffd;kkinen &lt;Auvo.Hakkinen@cs.Helsinki.FI&gt;&n; *&t;&t;Deepak Saxena &lt;deepak@plexity.net&gt;&n; *&t;&t;Boji T Kannanthanam &lt;boji.t.kannanthanam@intel.com&gt;&n; *&t;&t;Alan Cox &lt;alan@redhat.com&gt;:&n; *&t;&t;&t;Ported to Linux 2.5.&n; *&t;&t;Markus Lidel &lt;Markus.Lidel@shadowconnect.com&gt;:&n; *&t;&t;&t;Minor fixes for 2.6.&n; *&t;&t;Markus Lidel &lt;Markus.Lidel@shadowconnect.com&gt;:&n; *&t;&t;&t;Support for sysfs included.&n; */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/i2o.h&gt;
macro_line|#ifdef CONFIG_MTRR
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif&t;&t;&t;&t;
singleline_comment|// CONFIG_MTRR
multiline_comment|/* Module internal functions from other sources */
r_extern
r_struct
id|i2o_controller
op_star
id|i2o_iop_alloc
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|i2o_iop_free
c_func
(paren
r_struct
id|i2o_controller
op_star
)paren
suffix:semicolon
r_extern
r_int
id|i2o_iop_add
c_func
(paren
r_struct
id|i2o_controller
op_star
)paren
suffix:semicolon
r_extern
r_void
id|i2o_iop_remove
c_func
(paren
r_struct
id|i2o_controller
op_star
)paren
suffix:semicolon
r_extern
r_int
id|i2o_driver_dispatch
c_func
(paren
r_struct
id|i2o_controller
op_star
comma
id|u32
comma
r_struct
id|i2o_message
op_star
)paren
suffix:semicolon
multiline_comment|/* PCI device id table for all I2O controllers */
DECL|variable|i2o_pci_ids
r_static
r_struct
id|pci_device_id
id|__devinitdata
id|i2o_pci_ids
(braket
)braket
op_assign
(brace
(brace
id|PCI_DEVICE_CLASS
c_func
(paren
id|PCI_CLASS_INTELLIGENT_I2O
op_lshift
l_int|8
comma
l_int|0xffff00
)paren
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_DPT
comma
l_int|0xa511
)paren
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_dma_realloc - Realloc DMA memory&n; *&t;@dev: struct device pointer to the PCI device of the I2O controller&n; *&t;@addr: pointer to a i2o_dma struct DMA buffer&n; *&t;@len: new length of memory&n; *&t;@gfp_mask: GFP mask&n; *&n; *&t;If there was something allocated in the addr, free it first. If len &gt; 0&n; *&t;than try to allocate it and write the addresses back to the addr&n; *&t;structure. If len == 0 set the virtual address to NULL.&n; *&n; *&t;Returns the 0 on success or negative error code on failure.&n; */
DECL|function|i2o_dma_realloc
r_int
id|i2o_dma_realloc
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|i2o_dma
op_star
id|addr
comma
r_int
id|len
comma
r_int
r_int
id|gfp_mask
)paren
(brace
id|i2o_dma_free
c_func
(paren
id|dev
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
r_return
id|i2o_dma_alloc
c_func
(paren
id|dev
comma
id|addr
comma
id|len
comma
id|gfp_mask
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_pci_free - Frees the DMA memory for the I2O controller&n; *&t;@c: I2O controller to free&n; *&n; *&t;Remove all allocated DMA memory and unmap memory IO regions. If MTRR&n; *&t;is enabled, also remove it again.&n; */
DECL|function|i2o_pci_free
r_static
r_void
id|__devexit
id|i2o_pci_free
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|dev
op_assign
op_amp
id|c-&gt;pdev-&gt;dev
suffix:semicolon
id|i2o_dma_free
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;out_queue
)paren
suffix:semicolon
id|i2o_dma_free
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;status_block
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;lct
)paren
id|kfree
c_func
(paren
id|c-&gt;lct
)paren
suffix:semicolon
id|i2o_dma_free
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;dlct
)paren
suffix:semicolon
id|i2o_dma_free
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;hrt
)paren
suffix:semicolon
id|i2o_dma_free
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;status
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
r_if
c_cond
(paren
id|c-&gt;mtrr_reg0
op_ge
l_int|0
)paren
id|mtrr_del
c_func
(paren
id|c-&gt;mtrr_reg0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;mtrr_reg1
op_ge
l_int|0
)paren
id|mtrr_del
c_func
(paren
id|c-&gt;mtrr_reg1
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|c-&gt;raptor
op_logical_and
id|c-&gt;in_queue.virt
)paren
id|iounmap
c_func
(paren
id|c-&gt;in_queue.virt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;base.virt
)paren
id|iounmap
c_func
(paren
id|c-&gt;base.virt
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_pci_alloc - Allocate DMA memory, map IO memory for I2O controller&n; *&t;@c: I2O controller&n; *&n; *&t;Allocate DMA memory for a PCI (or in theory AGP) I2O controller. All&n; *&t;IO mappings are also done here. If MTRR is enabled, also do add memory&n; *&t;regions here.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_pci_alloc
r_static
r_int
id|__devinit
id|i2o_pci_alloc
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|c-&gt;pdev
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|pdev-&gt;dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Skip I/O spaces */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
id|i
)paren
op_amp
id|IORESOURCE_IO
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;base.phys
)paren
(brace
id|c-&gt;base.phys
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|i
)paren
suffix:semicolon
id|c-&gt;base.len
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * If we know what card it is, set the size&n;&t;&t;&t;&t; * correctly. Code is taken from dpt_i2o.c&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
l_int|0xa501
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;subsystem_device
op_ge
l_int|0xc032
op_logical_and
id|pdev-&gt;subsystem_device
op_le
l_int|0xc03b
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;base.len
OG
l_int|0x400000
)paren
id|c-&gt;base.len
op_assign
l_int|0x400000
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|c-&gt;base.len
OG
l_int|0x100000
)paren
id|c-&gt;base.len
op_assign
l_int|0x100000
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;raptor
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
id|c-&gt;in_queue.phys
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|i
)paren
suffix:semicolon
id|c-&gt;in_queue.len
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|6
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: I2O controller has no memory regions&quot;
l_string|&quot; defined.&bslash;n&quot;
)paren
suffix:semicolon
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Map the I2O controller */
r_if
c_cond
(paren
id|c-&gt;raptor
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o: PCI I2O controller&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;     BAR0 at 0x%08lX size=%ld&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|c-&gt;base.phys
comma
(paren
r_int
r_int
)paren
id|c-&gt;base.len
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;     BAR1 at 0x%08lX size=%ld&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|c-&gt;in_queue.phys
comma
(paren
r_int
r_int
)paren
id|c-&gt;in_queue.len
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o: PCI I2O controller at %08lX size=%ld&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|c-&gt;base.phys
comma
(paren
r_int
r_int
)paren
id|c-&gt;base.len
)paren
suffix:semicolon
id|c-&gt;base.virt
op_assign
id|ioremap
c_func
(paren
id|c-&gt;base.phys
comma
id|c-&gt;base.len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;base.virt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: Unable to map controller.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c-&gt;raptor
)paren
(brace
id|c-&gt;in_queue.virt
op_assign
id|ioremap
c_func
(paren
id|c-&gt;in_queue.phys
comma
id|c-&gt;in_queue.len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;in_queue.virt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: Unable to map controller.&bslash;n&quot;
)paren
suffix:semicolon
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_else
id|c-&gt;in_queue
op_assign
id|c-&gt;base
suffix:semicolon
id|c-&gt;irq_mask
op_assign
id|c-&gt;base.virt
op_plus
l_int|0x34
suffix:semicolon
id|c-&gt;post_port
op_assign
id|c-&gt;base.virt
op_plus
l_int|0x40
suffix:semicolon
id|c-&gt;reply_port
op_assign
id|c-&gt;base.virt
op_plus
l_int|0x44
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
multiline_comment|/* Enable Write Combining MTRR for IOP&squot;s memory region */
id|c-&gt;mtrr_reg0
op_assign
id|mtrr_add
c_func
(paren
id|c-&gt;in_queue.phys
comma
id|c-&gt;in_queue.len
comma
id|MTRR_TYPE_WRCOMB
comma
l_int|1
)paren
suffix:semicolon
id|c-&gt;mtrr_reg1
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;mtrr_reg0
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o: could not enable write combining &quot;
l_string|&quot;MTRR&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o: using write combining MTRR&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If it is an INTEL i960 I/O processor then set the first 64K to&n;&t; * Uncacheable since the region contains the messaging unit which&n;&t; * shouldn&squot;t be cached.&n;&t; */
r_if
c_cond
(paren
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_INTEL
op_logical_or
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_DPT
)paren
op_logical_and
op_logical_neg
id|c-&gt;raptor
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o: MTRR workaround for Intel i960 processor&quot;
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|c-&gt;mtrr_reg1
op_assign
id|mtrr_add
c_func
(paren
id|c-&gt;base.phys
comma
l_int|0x10000
comma
id|MTRR_TYPE_UNCACHABLE
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;mtrr_reg1
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o_pci: Error in setting &quot;
l_string|&quot;MTRR_TYPE_UNCACHABLE&bslash;n&quot;
)paren
suffix:semicolon
id|mtrr_del
c_func
(paren
id|c-&gt;mtrr_reg0
comma
id|c-&gt;in_queue.phys
comma
id|c-&gt;in_queue.len
)paren
suffix:semicolon
id|c-&gt;mtrr_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|i2o_dma_alloc
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;status
comma
l_int|8
comma
id|GFP_KERNEL
)paren
)paren
(brace
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_dma_alloc
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;hrt
comma
r_sizeof
(paren
id|i2o_hrt
)paren
comma
id|GFP_KERNEL
)paren
)paren
(brace
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_dma_alloc
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;dlct
comma
l_int|8192
comma
id|GFP_KERNEL
)paren
)paren
(brace
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_dma_alloc
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;status_block
comma
r_sizeof
(paren
id|i2o_status_block
)paren
comma
id|GFP_KERNEL
)paren
)paren
(brace
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_dma_alloc
c_func
(paren
id|dev
comma
op_amp
id|c-&gt;out_queue
comma
id|MSG_POOL_SIZE
comma
id|GFP_KERNEL
)paren
)paren
(brace
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|c
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_pci_interrupt - Interrupt handler for I2O controller&n; *&t;@irq: interrupt line&n; *&t;@dev_id: pointer to the I2O controller&n; *&t;@r: pointer to registers&n; *&n; *&t;Handle an interrupt from a PCI based I2O controller. This turns out&n; *&t;to be rather simple. We keep the controller pointer in the cookie.&n; */
DECL|function|i2o_pci_interrupt
r_static
id|irqreturn_t
id|i2o_pci_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
op_assign
id|dev_id
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|c-&gt;pdev-&gt;dev
suffix:semicolon
r_struct
id|i2o_message
op_star
id|m
suffix:semicolon
id|u32
id|mv
suffix:semicolon
multiline_comment|/*&n;&t; * Old 960 steppings had a bug in the I2O unit that caused&n;&t; * the queue to appear empty when it wasn&squot;t.&n;&t; */
id|mv
op_assign
id|I2O_REPLY_READ32
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mv
op_eq
id|I2O_QUEUE_EMPTY
)paren
(brace
id|mv
op_assign
id|I2O_REPLY_READ32
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|mv
op_eq
id|I2O_QUEUE_EMPTY
)paren
)paren
(brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
r_else
id|pr_debug
c_func
(paren
l_string|&quot;960 bug detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mv
op_ne
id|I2O_QUEUE_EMPTY
)paren
(brace
multiline_comment|/*&n;&t;&t; * Map the message from the page frame map to kernel virtual.&n;&t;&t; * Because bus_to_virt is deprecated, we have calculate the&n;&t;&t; * location by ourself!&n;&t;&t; */
id|m
op_assign
id|i2o_msg_out_to_virt
c_func
(paren
id|c
comma
id|mv
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *      Ensure this message is seen coherently but cachably by&n;&t;&t; *      the processor&n;&t;&t; */
id|dma_sync_single_for_cpu
c_func
(paren
id|dev
comma
id|c-&gt;out_queue.phys
comma
id|MSG_FRAME_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/* dispatch it */
r_if
c_cond
(paren
id|i2o_driver_dispatch
c_func
(paren
id|c
comma
id|mv
comma
id|m
)paren
)paren
multiline_comment|/* flush it if result != 0 */
id|i2o_flush_reply
c_func
(paren
id|c
comma
id|mv
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * That 960 bug again...&n;&t;&t; */
id|mv
op_assign
id|I2O_REPLY_READ32
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mv
op_eq
id|I2O_QUEUE_EMPTY
)paren
id|mv
op_assign
id|I2O_REPLY_READ32
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_pci_irq_enable - Allocate interrupt for I2O controller&n; *&n; *&t;Allocate an interrupt for the I2O controller, and activate interrupts&n; *&t;on the I2O controller.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_pci_irq_enable
r_static
r_int
id|i2o_pci_irq_enable
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|c-&gt;pdev
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|I2O_IRQ_WRITE32
c_func
(paren
id|c
comma
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;irq
)paren
(brace
id|rc
op_assign
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|i2o_pci_interrupt
comma
id|SA_SHIRQ
comma
id|c-&gt;name
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to allocate interrupt %d.&quot;
l_string|&quot;&bslash;n&quot;
comma
id|c-&gt;name
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
id|I2O_IRQ_WRITE32
c_func
(paren
id|c
comma
l_int|0x00000000
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Installed at IRQ %d&bslash;n&quot;
comma
id|c-&gt;name
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_pci_irq_disable - Free interrupt for I2O controller&n; *&t;@c: I2O controller&n; *&n; *&t;Disable interrupts in I2O controller and then free interrupt.&n; */
DECL|function|i2o_pci_irq_disable
r_static
r_void
id|i2o_pci_irq_disable
c_func
(paren
r_struct
id|i2o_controller
op_star
id|c
)paren
(brace
id|I2O_IRQ_WRITE32
c_func
(paren
id|c
comma
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;pdev-&gt;irq
OG
l_int|0
)paren
id|free_irq
c_func
(paren
id|c-&gt;pdev-&gt;irq
comma
id|c
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_pci_probe - Probe the PCI device for an I2O controller&n; *&t;@dev: PCI device to test&n; *&t;@id: id which matched with the PCI device id table&n; *&n; *&t;Probe the PCI device for any device which is a memory of the&n; *&t;Intelligent, I2O class or an Adaptec Zero Channel Controller. We&n; *&t;attempt to set up each such device and register it with the core.&n; *&n; *&t;Returns 0 on success or negative error code on failure.&n; */
DECL|function|i2o_pci_probe
r_static
r_int
id|__devinit
id|i2o_pci_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o: Checking for PCI I2O controllers...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_amp
l_int|0xff
)paren
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o: I2O controller found but does not &quot;
l_string|&quot;support I2O 1.5 (skipping).&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o: I2O controller found but could not be&quot;
l_string|&quot; enabled.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o: I2O controller found on bus %d at %d.&bslash;n&quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_32BIT_MASK
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;i2o: I2O controller on bus %d at %d: No &quot;
l_string|&quot;suitable DMA available!&bslash;n&quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|disable
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|c
op_assign
id|i2o_iop_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|c
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: memory for I2O controller could not be &quot;
l_string|&quot;allocated&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|PTR_ERR
c_func
(paren
id|c
)paren
suffix:semicolon
r_goto
id|disable
suffix:semicolon
)brace
id|c-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|c-&gt;device
op_assign
id|pdev-&gt;dev
suffix:semicolon
multiline_comment|/* Cards that fall apart if you hit them with large I/O loads... */
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_NCR
op_logical_and
id|pdev-&gt;device
op_eq
l_int|0x0630
)paren
(brace
id|c-&gt;short_req
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o: Symbios FC920 workarounds activated.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;subsystem_vendor
op_eq
id|PCI_VENDOR_ID_PROMISE
)paren
(brace
id|c-&gt;promise
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2o: Promise workarounds activated.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Cards that go bananas if you quiesce them before you reset them. */
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_DPT
)paren
(brace
id|c-&gt;no_quiesce
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
l_int|0xa511
)paren
id|c-&gt;raptor
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_pci_alloc
c_func
(paren
id|c
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: DMA / IO allocation for I2O controller &quot;
l_string|&quot; failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|free_controller
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2o_pci_irq_enable
c_func
(paren
id|c
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2o: unable to enable interrupts for I2O &quot;
l_string|&quot;controller&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|free_pci
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2o_iop_add
c_func
(paren
id|c
)paren
)paren
)paren
r_goto
id|uninstall
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|uninstall
suffix:colon
id|i2o_pci_irq_disable
c_func
(paren
id|c
)paren
suffix:semicolon
id|free_pci
suffix:colon
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
id|free_controller
suffix:colon
id|i2o_iop_free
c_func
(paren
id|c
)paren
suffix:semicolon
id|disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;i2o_pci_remove - Removes a I2O controller from the system&n; *&t;pdev: I2O controller which should be removed&n; *&n; *&t;Reset the I2O controller, disable interrupts and remove all allocated&n; *&t;resources.&n; */
DECL|function|i2o_pci_remove
r_static
r_void
id|__devexit
id|i2o_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|i2o_controller
op_star
id|c
suffix:semicolon
id|c
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|i2o_iop_remove
c_func
(paren
id|c
)paren
suffix:semicolon
id|i2o_pci_irq_disable
c_func
(paren
id|c
)paren
suffix:semicolon
id|i2o_pci_free
c_func
(paren
id|c
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Controller removed.&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
id|i2o_iop_free
c_func
(paren
id|c
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* PCI driver for I2O controller */
DECL|variable|i2o_pci_driver
r_static
r_struct
id|pci_driver
id|i2o_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;I2O controller&quot;
comma
dot
id|id_table
op_assign
id|i2o_pci_ids
comma
dot
id|probe
op_assign
id|i2o_pci_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|i2o_pci_remove
)paren
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_pci_init - registers I2O PCI driver in PCI subsystem&n; *&n; *&t;Returns &gt; 0 on success or negative error code on failure.&n; */
DECL|function|i2o_pci_init
r_int
id|__init
id|i2o_pci_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_register_driver
c_func
(paren
op_amp
id|i2o_pci_driver
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;i2o_pci_exit - unregisters I2O PCI driver from PCI subsystem&n; */
DECL|function|i2o_pci_exit
r_void
id|__exit
id|i2o_pci_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|i2o_pci_driver
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|i2o_dma_realloc
id|EXPORT_SYMBOL
c_func
(paren
id|i2o_dma_realloc
)paren
suffix:semicolon
eof
