multiline_comment|/*&n; *  linux/drivers/message/fusion/mptbase.c&n; *      High performance SCSI + LAN / Fibre Channel device drivers.&n; *      This is the Fusion MPT base driver which supports multiple&n; *      (SCSI + LAN) specialized protocol drivers.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      There are lots of people not mentioned below that deserve credit&n; *      and thanks but won&squot;t get it here - sorry in advance that you&n; *      got overlooked.&n; *&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      A special thanks to Noah Romer (LSI Logic) for tons of work&n; *      and tough debugging on the LAN driver, especially early on;-)&n; *      And to Roger Hickerson (LSI Logic) for tirelessly supporting&n; *      this driver project.&n; *&n; *      All manner of help from Stephen Shirron (LSI Logic):&n; *      low-level FC analysis, debug + various fixes in FCxx firmware,&n; *      initial port to alpha platform, various driver code optimizations,&n; *      being a faithful sounding board on all sorts of issues &amp; ideas,&n; *      etc.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      Special thanks goes to the I2O LAN driver people at the&n; *      University of Helsinki, who, unbeknownst to them, provided&n; *      the inspiration and initial structure for this driver.&n; *&n; *      A really huge debt of gratitude is owed to Eddie C. Dost&n; *      for gobs of hard work fixing and optimizing LAN code.&n; *      THANK YOU!&n; *&n; *  Copyright (c) 1999-2001 LSI Logic Corporation&n; *  Originally By: Steven J. Ralston&n; *  (mailto:Steve.Ralston@lsil.com)&n; *&n; *  $Id: mptbase.c,v 1.53.4.1 2001/08/24 20:07:05 sralston Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#ifdef CONFIG_MTRR
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif
macro_line|#include &quot;mptbase.h&quot;
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|my_NAME
mdefine_line|#define my_NAME&t;&t;&quot;Fusion MPT base driver&quot;
DECL|macro|my_VERSION
mdefine_line|#define my_VERSION&t;MPT_LINUX_VERSION_COMMON
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptbase&quot;
DECL|variable|MODULEAUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|MODULEAUTHOR
)paren
suffix:semicolon
DECL|variable|my_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|my_NAME
)paren
suffix:semicolon
multiline_comment|/*&n; *  cmd line parameters&n; */
id|MODULE_PARM
c_func
(paren
id|PortIo
comma
l_string|&quot;0-1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|PortIo
comma
l_string|&quot;[0]=Use mmap, 1=Use port io&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|HardReset
comma
l_string|&quot;0-1i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|HardReset
comma
l_string|&quot;0=Disable HardReset, [1]=Enable HardReset&quot;
)paren
suffix:semicolon
DECL|variable|PortIo
r_static
r_int
id|PortIo
op_assign
l_int|0
suffix:semicolon
DECL|variable|HardReset
r_static
r_int
id|HardReset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Public data...&n; */
DECL|variable|mpt_lan_index
r_int
id|mpt_lan_index
op_assign
l_int|0
suffix:semicolon
DECL|variable|mpt_stm_index
r_int
id|mpt_stm_index
op_assign
l_int|0
suffix:semicolon
DECL|variable|mpt_v_ASCQ_TablePtr
r_void
op_star
id|mpt_v_ASCQ_TablePtr
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mpt_ScsiOpcodesPtr
r_const
r_char
op_star
op_star
id|mpt_ScsiOpcodesPtr
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mpt_ASCQ_TableSz
r_int
id|mpt_ASCQ_TableSz
op_assign
l_int|0
suffix:semicolon
DECL|macro|WHOINIT_UNKNOWN
mdefine_line|#define WHOINIT_UNKNOWN&t;&t;0xAA
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Private data...&n; */
multiline_comment|/* Adapter lookup table */
DECL|variable|mpt_adapters
r_static
id|MPT_ADAPTER
op_star
id|mpt_adapters
(braket
id|MPT_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|MptAdapters
r_static
id|MPT_ADAPTER_TRACKER
id|MptAdapters
suffix:semicolon
multiline_comment|/* Callback lookup table */
DECL|variable|MptCallbacks
r_static
id|MPT_CALLBACK
id|MptCallbacks
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
multiline_comment|/* Protocol driver class lookup table */
DECL|variable|MptDriverClass
r_static
r_int
id|MptDriverClass
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
multiline_comment|/* Event handler lookup table */
DECL|variable|MptEvHandlers
r_static
id|MPT_EVHANDLER
id|MptEvHandlers
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
multiline_comment|/* Reset handler lookup table */
DECL|variable|MptResetHandlers
r_static
id|MPT_RESETHANDLER
id|MptResetHandlers
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
DECL|variable|FusionInitCalled
r_static
r_int
id|FusionInitCalled
op_assign
l_int|0
suffix:semicolon
DECL|variable|mpt_base_index
r_static
r_int
id|mpt_base_index
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Forward protos...&n; */
r_static
r_void
id|mpt_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|bus_id
comma
r_struct
id|pt_regs
op_star
id|r
)paren
suffix:semicolon
r_static
r_int
id|mpt_base_reply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|req
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
suffix:semicolon
r_static
r_int
id|mpt_do_ioc_recovery
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|reason
)paren
suffix:semicolon
r_static
r_int
id|mpt_adapter_install
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_void
id|mpt_detect_929_bound_ports
c_func
(paren
id|MPT_ADAPTER
op_star
id|this
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_void
id|mpt_adapter_disable
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|freeup
)paren
suffix:semicolon
r_static
r_void
id|mpt_adapter_dispose
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|MptDisplayIocCapabilities
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|MakeIocReady
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|force
)paren
suffix:semicolon
r_static
id|u32
id|GetIocState
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|cooked
)paren
suffix:semicolon
r_static
r_int
id|GetIocFacts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|GetPortFacts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
suffix:semicolon
r_static
r_int
id|SendIocInit
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|SendPortEnable
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
suffix:semicolon
r_static
r_int
id|mpt_fc9x9_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|ignore
)paren
suffix:semicolon
r_static
r_int
id|KickStart
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|ignore
)paren
suffix:semicolon
r_static
r_int
id|SendIocReset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u8
id|reset_type
)paren
suffix:semicolon
r_static
r_int
id|PrimeIocFifos
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|HandShakeReqAndReply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reqBytes
comma
id|u32
op_star
id|req
comma
r_int
id|replyBytes
comma
id|u16
op_star
id|u16reply
comma
r_int
id|maxwait
)paren
suffix:semicolon
r_static
r_int
id|WaitForDoorbellAck
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
)paren
suffix:semicolon
r_static
r_int
id|WaitForDoorbellInt
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
)paren
suffix:semicolon
r_static
r_int
id|WaitForDoorbellReply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
)paren
suffix:semicolon
r_static
r_int
id|GetLanConfigPages
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|SendEventNotification
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u8
id|EvSwitch
)paren
suffix:semicolon
r_static
r_int
id|SendEventAck
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|evnp
)paren
suffix:semicolon
r_static
r_int
id|procmpt_create
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_static
r_int
id|procmpt_destroy
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|procmpt_read_summary
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|procmpt_read_dbg
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
multiline_comment|/*static int&t;procmpt_info(char *buf, char **start, off_t offset, int len);*/
r_static
r_int
id|ProcessEventNotification
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|evReply
comma
r_int
op_star
id|evHandlers
)paren
suffix:semicolon
r_static
r_void
id|mpt_fc_log_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|log_info
)paren
suffix:semicolon
r_static
r_void
id|mpt_sp_log_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|log_info
)paren
suffix:semicolon
DECL|variable|procmpt_root_dir
r_static
r_struct
id|proc_dir_entry
op_star
id|procmpt_root_dir
op_assign
l_int|NULL
suffix:semicolon
r_int
id|fusion_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|fusion_exit
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* 20000207 -sralston&n; *  GRRRRR...  IOSpace (port i/o) register access (for the 909) is back!&n; * 20000517 -sralston&n; *  Let&squot;s trying going back to default mmap register access...&n; */
DECL|function|CHIPREG_READ32
r_static
r_inline
id|u32
id|CHIPREG_READ32
c_func
(paren
r_volatile
id|u32
op_star
id|a
)paren
(brace
r_if
c_cond
(paren
id|PortIo
)paren
r_return
id|inl
c_func
(paren
(paren
r_int
r_int
)paren
id|a
)paren
suffix:semicolon
r_else
r_return
id|readl
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
DECL|function|CHIPREG_WRITE32
r_static
r_inline
r_void
id|CHIPREG_WRITE32
c_func
(paren
r_volatile
id|u32
op_star
id|a
comma
id|u32
id|v
)paren
(brace
r_if
c_cond
(paren
id|PortIo
)paren
id|outl
c_func
(paren
id|v
comma
(paren
r_int
r_int
)paren
id|a
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
id|v
comma
id|a
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_interrupt - MPT adapter (IOC) specific interrupt handler.&n; *&t;@irq: irq number (not used)&n; *&t;@bus_id: bus identifier cookie == pointer to MPT_ADAPTER structure&n; *&t;@r: pt_regs pointer (not used)&n; *&n; *&t;This routine is registered via the request_irq() kernel API call,&n; *&t;and handles all interrupts generated from a specific MPT adapter&n; *&t;(also referred to as a IO Controller or IOC).&n; *&t;This routine must clear the interrupt from the adapter and does&n; *&t;so by reading the reply FIFO.  Multiple replies may be processed&n; *&t;per single call to this routine; up to MPT_MAX_REPLIES_PER_ISR&n; *&t;which is currently set to 32 in mptbase.h.&n; *&n; *&t;This routine handles register-level access of the adapter but&n; *&t;dispatches (calls) a protocol-specific callback routine to handle&n; *&t;the protocol-specific details of the MPT request completion.&n; */
r_static
r_void
DECL|function|mpt_interrupt
id|mpt_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|bus_id
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mr
suffix:semicolon
id|u32
id|pa
suffix:semicolon
id|u32
op_star
id|m
suffix:semicolon
r_int
id|req_idx
suffix:semicolon
r_int
id|cb_idx
suffix:semicolon
r_int
id|type
suffix:semicolon
r_int
id|freeme
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|ioc
op_assign
id|bus_id
suffix:semicolon
multiline_comment|/*&n;&t; *  Drain the reply FIFO!&n;&t; *&n;&t; * NOTES: I&squot;ve seen up to 10 replies processed in this loop, so far...&n;&t; * Update: I&squot;ve seen up to 9182 replies processed in this loop! ??&n;&t; * Update: Limit ourselves to processing max of N replies&n;&t; *&t;(bottom of loop).&n;&t; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|pa
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;ReplyFifo
)paren
)paren
op_eq
l_int|0xFFFFFFFF
)paren
r_return
suffix:semicolon
id|cb_idx
op_assign
l_int|0
suffix:semicolon
id|freeme
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Check for non-TURBO reply!&n;&t;&t; */
r_if
c_cond
(paren
id|pa
op_amp
id|MPI_ADDRESS_REPLY_A_BIT
)paren
(brace
id|dma_addr_t
id|reply_dma_addr
suffix:semicolon
id|u16
id|ioc_stat
suffix:semicolon
multiline_comment|/* non-TURBO reply!  Hmmm, something may be up...&n;&t;&t;&t; *  Newest turbo reply mechanism; get address&n;&t;&t;&t; *  via left shift 1 (get rid of MPI_ADDRESS_REPLY_A_BIT)!&n;&t;&t;&t; */
id|reply_dma_addr
op_assign
(paren
id|pa
op_assign
(paren
id|pa
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Map DMA address of reply header to cpu address. */
id|m
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|ioc-&gt;reply_frames
op_plus
(paren
id|reply_dma_addr
op_minus
id|ioc-&gt;reply_frames_dma
)paren
)paren
suffix:semicolon
id|mr
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|m
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mr-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|cb_idx
op_assign
id|mr-&gt;u.frame.hwhdr.msgctxu.fld.cb_idx
suffix:semicolon
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|req_idx
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Got non-TURBO reply=%p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mr
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REPLY_FRAME
c_func
(paren
id|mr
)paren
multiline_comment|/* NEW!  20010301 -sralston&n;&t;&t;&t; *  Check/log IOC log info&n;&t;&t;&t; */
id|ioc_stat
op_assign
id|le16_to_cpu
c_func
(paren
id|mr-&gt;u.reply.IOCStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc_stat
op_amp
id|MPI_IOCSTATUS_FLAG_LOG_INFO_AVAILABLE
)paren
(brace
id|u32
id|log_info
op_assign
id|le32_to_cpu
c_func
(paren
id|mr-&gt;u.reply.IOCLogInfo
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
id|mpt_fc_log_info
c_func
(paren
id|ioc
comma
id|log_info
)paren
suffix:semicolon
r_else
id|mpt_sp_log_info
c_func
(paren
id|ioc
comma
id|log_info
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; *  Process turbo (context) reply...&n;&t;&t;&t; */
id|dirqprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Got TURBO reply(=%08x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pa
)paren
)paren
suffix:semicolon
id|type
op_assign
(paren
id|pa
op_rshift
id|MPI_CONTEXT_REPLY_TYPE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|MPI_CONTEXT_REPLY_TYPE_SCSI_TARGET
)paren
(brace
id|cb_idx
op_assign
id|mpt_stm_index
suffix:semicolon
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|mr
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|CAST_U32_TO_PTR
c_func
(paren
id|pa
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|MPI_CONTEXT_REPLY_TYPE_LAN
)paren
(brace
id|cb_idx
op_assign
id|mpt_lan_index
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * BUG FIX!  20001218 -sralston&n;&t;&t;&t;&t; *  Blind set of mf to NULL here was fatal&n;&t;&t;&t;&t; *  after lan_reply says &quot;freeme&quot;&n;&t;&t;&t;&t; *  Fix sort of combined with an optimization here;&n;&t;&t;&t;&t; *  added explicit check for case where lan_reply&n;&t;&t;&t;&t; *  was just returning 1 and doing nothing else.&n;&t;&t;&t;&t; *  For this case skip the callback, but set up&n;&t;&t;&t;&t; *  proper mf value first here:-)&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|pa
op_amp
l_int|0x58000000
)paren
op_eq
l_int|0x58000000
)paren
(brace
id|req_idx
op_assign
id|pa
op_amp
l_int|0x0000FFFF
suffix:semicolon
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|req_idx
)paren
suffix:semicolon
id|freeme
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; *  IMPORTANT!  Invalidate the callback!&n;&t;&t;&t;&t;&t; */
id|cb_idx
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|mf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|mr
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|CAST_U32_TO_PTR
c_func
(paren
id|pa
)paren
suffix:semicolon
)brace
r_else
(brace
id|req_idx
op_assign
id|pa
op_amp
l_int|0x0000FFFF
suffix:semicolon
id|cb_idx
op_assign
(paren
id|pa
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|req_idx
)paren
suffix:semicolon
id|mr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pa
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No reply flush! */
)brace
multiline_comment|/*  Check for (valid) IO callback!  */
r_if
c_cond
(paren
id|cb_idx
)paren
(brace
multiline_comment|/*  Do the callback!  */
id|freeme
op_assign
(paren
op_star
(paren
id|MptCallbacks
(braket
id|cb_idx
)braket
)paren
)paren
(paren
id|ioc
comma
id|mf
comma
id|mr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pa
)paren
(brace
multiline_comment|/*  Flush (non-TURBO) reply with a WRITE!  */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;ReplyFifo
comma
id|pa
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freeme
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*  Put Request back on FreeQ!  */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|ioc-&gt;FreeQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
id|dirqprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: ISR processed frame #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
id|MPT_MAX_REPLIES_PER_ISR
)paren
(brace
id|dirqprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: ISR processed %d replies.&quot;
comma
id|ioc-&gt;name
comma
id|count
)paren
)paren
suffix:semicolon
id|dirqprintk
c_func
(paren
(paren
l_string|&quot; Giving this ISR a break!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* drain reply FIFO */
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_base_reply - MPT base driver&squot;s callback routine; all base driver&n; *&t;&quot;internal&quot; request/reply processing is routed here.&n; *&t;Currently used for EventNotification and EventAck handling.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to original MPT request frame&n; *&t;@reply: Pointer to MPT reply frame (NULL if TurboReply)&n; *&n; *&t;Returns 1 indicating original alloc&squot;d request frame ptr&n; *&t;should be freed, or 0 if it shouldn&squot;t.&n; */
r_static
r_int
DECL|function|mpt_base_reply
id|mpt_base_reply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
(brace
r_int
id|freereq
op_assign
l_int|1
suffix:semicolon
id|u8
id|func
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: mpt_base_reply() called&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|mf
op_ge
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - NULL or BAD request frame ptr! (=%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reply
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Unexpected NULL Event (turbo?) reply!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reply-&gt;u.hdr.MsgFlags
op_amp
id|MPI_MSGFLAGS_CONTINUATION_REPLY
)paren
)paren
(brace
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Original request frame (@%p) header&bslash;n&quot;
comma
id|mf
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REQUEST_FRAME_HDR
c_func
(paren
id|mf
)paren
)brace
id|func
op_assign
id|reply-&gt;u.hdr.Function
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: mpt_base_reply, Function=%02Xh&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|func
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func
op_eq
id|MPI_FUNCTION_EVENT_NOTIFICATION
)paren
(brace
id|EventNotificationReply_t
op_star
id|pEvReply
op_assign
(paren
id|EventNotificationReply_t
op_star
)paren
id|reply
suffix:semicolon
r_int
id|evHandlers
op_assign
l_int|0
suffix:semicolon
r_int
id|results
suffix:semicolon
id|results
op_assign
id|ProcessEventNotification
c_func
(paren
id|ioc
comma
id|pEvReply
comma
op_amp
id|evHandlers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|results
op_ne
id|evHandlers
)paren
(brace
multiline_comment|/* CHECKME! Any special handling needed here? */
id|dprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: Hmmm... Called %d event handlers, sum results = %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|evHandlers
comma
id|results
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *  Hmmm...  It seems that EventNotificationReply is an exception&n;&t;&t; *  to the rule of one reply per request.&n;&t;&t; */
r_if
c_cond
(paren
id|pEvReply-&gt;MsgFlags
op_amp
id|MPI_MSGFLAGS_CONTINUATION_REPLY
)paren
id|freereq
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
singleline_comment|//&t;&t;LogEvent(ioc, pEvReply);
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|func
op_eq
id|MPI_FUNCTION_EVENT_ACK
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: mpt_base_reply, EventAck reply received&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Unexpected msg function (=%02Xh) reply received!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|func
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Conditionally tell caller to free the original&n;&t; *  EventNotification/EventAck/unexpected request frame!&n;&t; */
r_return
id|freereq
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_register - Register protocol-specific main callback handler.&n; *&t;@cbfunc: callback function pointer&n; *&t;@dclass: Protocol driver&squot;s class (%MPT_DRIVER_CLASS enum value)&n; *&n; *&t;This routine is called by a protocol-specific driver (SCSI host,&n; *&t;LAN, SCSI target) to register it&squot;s reply callback routine.  Each&n; *&t;protocol-specific driver must do this before it will be able to&n; *&t;use any IOC resources, such as obtaining request frames.&n; *&n; *&t;NOTES: The SCSI protocol driver currently calls this routine twice&n; *&t;in order to register separate callbacks; one for &quot;normal&quot; SCSI IO&n; *&t;and another for MptScsiTaskMgmt requests.&n; *&n; *&t;Returns a positive integer valued &quot;handle&quot; in the&n; *&t;range (and S.O.D. order) {7,6,...,1} if successful.&n; *&t;Any non-positive return value (including zero!) should be considered&n; *&t;an error by the caller.&n; */
r_int
DECL|function|mpt_register
id|mpt_register
c_func
(paren
id|MPT_CALLBACK
id|cbfunc
comma
id|MPT_DRIVER_CLASS
id|dclass
)paren
(brace
r_int
id|r
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifndef MODULE
multiline_comment|/*&n;&t; *  Handle possibility of the mptscsih_detect() routine getting&n;&t; *  called *before* fusion_init!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|FusionInitCalled
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Hmmm, calling fusion_init from mpt_register!&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  NOTE! We&squot;ll get recursion here, as fusion_init()&n;&t;&t; *  calls mpt_register()!&n;&t;&t; */
id|fusion_init
c_func
(paren
)paren
suffix:semicolon
id|FusionInitCalled
op_increment
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; *  Search for empty callback slot in this order: {7,6,...,1}&n;&t; *  (slot/handle 0 is reserved!)&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|MptCallbacks
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|MptCallbacks
(braket
id|i
)braket
op_assign
id|cbfunc
suffix:semicolon
id|MptDriverClass
(braket
id|i
)braket
op_assign
id|dclass
suffix:semicolon
id|MptEvHandlers
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|r
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|cbfunc
op_ne
id|mpt_base_reply
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_deregister - Deregister a protocol drivers resources.&n; *&t;@cb_idx: previously registered callback handle&n; *&n; *&t;Each protocol-specific driver should call this routine when it&squot;s&n; *&t;module is unloaded.&n; */
r_void
DECL|function|mpt_deregister
id|mpt_deregister
c_func
(paren
r_int
id|cb_idx
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
op_logical_and
(paren
id|cb_idx
OL
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
)paren
(brace
id|MptCallbacks
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|MptDriverClass
(braket
id|cb_idx
)braket
op_assign
id|MPTUNKNOWN_DRIVER
suffix:semicolon
id|MptEvHandlers
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cb_idx
op_ne
id|mpt_base_index
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_event_register - Register protocol-specific event callback&n; *&t;handler.&n; *&t;@cb_idx: previously registered (via mpt_register) callback handle&n; *&t;@ev_cbfunc: callback function&n; *&n; *&t;This routine can be called by one or more protocol-specific drivers&n; *&t;if/when they choose to be notified of MPT events.&n; *&n; *&t;Returns 0 for success.&n; */
r_int
DECL|function|mpt_event_register
id|mpt_event_register
c_func
(paren
r_int
id|cb_idx
comma
id|MPT_EVHANDLER
id|ev_cbfunc
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|MptEvHandlers
(braket
id|cb_idx
)braket
op_assign
id|ev_cbfunc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_event_deregister - Deregister protocol-specific event callback&n; *&t;handler.&n; *&t;@cb_idx: previously registered callback handle&n; *&n; *&t;Each protocol-specific driver should call this routine&n; *&t;when it does not (or can no longer) handle events,&n; *&t;or when it&squot;s module is unloaded.&n; */
r_void
DECL|function|mpt_event_deregister
id|mpt_event_deregister
c_func
(paren
r_int
id|cb_idx
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
suffix:semicolon
id|MptEvHandlers
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_reset_register - Register protocol-specific IOC reset handler.&n; *&t;@cb_idx: previously registered (via mpt_register) callback handle&n; *&t;@reset_func: reset function&n; *&n; *&t;This routine can be called by one or more protocol-specific drivers&n; *&t;if/when they choose to be notified of IOC resets.&n; *&n; *&t;Returns 0 for success.&n; */
r_int
DECL|function|mpt_reset_register
id|mpt_reset_register
c_func
(paren
r_int
id|cb_idx
comma
id|MPT_RESETHANDLER
id|reset_func
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|MptResetHandlers
(braket
id|cb_idx
)braket
op_assign
id|reset_func
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_reset_deregister - Deregister protocol-specific IOC reset handler.&n; *&t;@cb_idx: previously registered callback handle&n; *&n; *&t;Each protocol-specific driver should call this routine&n; *&t;when it does not (or can no longer) handle IOC reset handling,&n; *&t;or when it&squot;s module is unloaded.&n; */
r_void
DECL|function|mpt_reset_deregister
id|mpt_reset_deregister
c_func
(paren
r_int
id|cb_idx
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
suffix:semicolon
id|MptResetHandlers
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_get_msg_frame - Obtain a MPT request frame from the pool (of 1024)&n; *&t;allocated per MPT adapter.&n; *&t;@handle: Handle of registered MPT protocol driver&n; *&t;@iocid: IOC unique identifier (integer)&n; *&n; *&t;Returns pointer to a MPT request frame or %NULL if none are available.&n; */
id|MPT_FRAME_HDR
op_star
DECL|function|mpt_get_msg_frame
id|mpt_get_msg_frame
c_func
(paren
r_int
id|handle
comma
r_int
id|iocid
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* validate handle and ioc identifier */
id|iocp
op_assign
id|mpt_adapters
(braket
id|iocid
)braket
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iocp-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|iocp-&gt;FreeQ
)paren
)paren
(brace
r_int
id|req_offset
suffix:semicolon
id|mf
op_assign
id|iocp-&gt;FreeQ.head
suffix:semicolon
id|Q_DEL_ITEM
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage
)paren
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.cb_idx
op_assign
id|handle
suffix:semicolon
multiline_comment|/* byte */
id|req_offset
op_assign
(paren
id|u8
op_star
)paren
id|mf
op_minus
(paren
id|u8
op_star
)paren
id|iocp-&gt;req_frames
suffix:semicolon
multiline_comment|/* u16! */
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
op_assign
id|cpu_to_le16
c_func
(paren
id|req_offset
op_div
id|iocp-&gt;req_sz
)paren
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.rsvd
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iocp-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: mpt_get_msg_frame(%d,%d), got mf=%p&bslash;n&quot;
comma
id|iocp-&gt;name
comma
id|handle
comma
id|iocid
comma
id|mf
)paren
)paren
suffix:semicolon
r_return
id|mf
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_put_msg_frame - Send a protocol specific MPT request frame&n; *&t;to a IOC.&n; *&t;@handle: Handle of registered MPT protocol driver&n; *&t;@iocid: IOC unique identifier (integer)&n; *&t;@mf: Pointer to MPT request frame&n; *&n; *&t;This routine posts a MPT request frame to the request post FIFO of a&n; *&t;specific MPT adapter.&n; */
r_void
DECL|function|mpt_put_msg_frame
id|mpt_put_msg_frame
c_func
(paren
r_int
id|handle
comma
r_int
id|iocid
comma
id|MPT_FRAME_HDR
op_star
id|mf
)paren
(brace
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
id|iocp
op_assign
id|mpt_adapters
(braket
id|iocid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|iocp
op_ne
l_int|NULL
)paren
(brace
id|dma_addr_t
id|mf_dma_addr
suffix:semicolon
r_int
id|req_offset
suffix:semicolon
multiline_comment|/* ensure values are reset properly! */
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.cb_idx
op_assign
id|handle
suffix:semicolon
multiline_comment|/* byte */
id|req_offset
op_assign
(paren
id|u8
op_star
)paren
id|mf
op_minus
(paren
id|u8
op_star
)paren
id|iocp-&gt;req_frames
suffix:semicolon
multiline_comment|/* u16! */
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
op_assign
id|cpu_to_le16
c_func
(paren
id|req_offset
op_div
id|iocp-&gt;req_sz
)paren
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.rsvd
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MPT_DEBUG_MSG_FRAME
(brace
id|u32
op_star
id|m
op_assign
id|mf-&gt;u.frame.hwhdr.__hdr
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: About to Put msg frame @ %p:&bslash;n&quot;
id|KERN_INFO
l_string|&quot; &quot;
comma
id|iocp-&gt;name
comma
id|m
)paren
suffix:semicolon
id|n
op_assign
id|iocp-&gt;req_sz
op_div
l_int|4
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|m
(braket
id|n
)braket
op_eq
l_int|0
)paren
id|n
op_decrement
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|n
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_logical_and
(paren
(paren
id|i
op_mod
l_int|8
)paren
op_eq
l_int|0
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_INFO
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|m
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|mf_dma_addr
op_assign
id|iocp-&gt;req_frames_dma
op_plus
id|req_offset
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|iocp-&gt;chip-&gt;RequestFifo
comma
id|mf_dma_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_free_msg_frame - Place MPT request frame back on FreeQ.&n; *&t;@handle: Handle of registered MPT protocol driver&n; *&t;@iocid: IOC unique identifier (integer)&n; *&t;@mf: Pointer to MPT request frame&n; *&n; *&t;This routine places a MPT request frame back on the MPT adapter&squot;s&n; *&t;FreeQ.&n; */
r_void
DECL|function|mpt_free_msg_frame
id|mpt_free_msg_frame
c_func
(paren
r_int
id|handle
comma
r_int
id|iocid
comma
id|MPT_FRAME_HDR
op_star
id|mf
)paren
(brace
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|iocp
op_assign
id|mpt_adapters
(braket
id|iocid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|iocp
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*  Put Request back on FreeQ!  */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iocp-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|iocp-&gt;FreeQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iocp-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_send_handshake_request - Send MPT request via doorbell&n; *&t;handshake method.&n; *&t;@handle: Handle of registered MPT protocol driver&n; *&t;@iocid: IOC unique identifier (integer)&n; *&t;@reqBytes: Size of the request in bytes&n; *&t;@req: Pointer to MPT request frame&n; *&n; *&t;This routine is used exclusively by mptscsih to send MptScsiTaskMgmt&n; *&t;requests since they are required to be sent via doorbell handshake.&n; *&n; *&t;NOTE: It is the callers responsibility to byte-swap fields in the&n; *&t;request which are greater than 1 byte in size.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_int
DECL|function|mpt_send_handshake_request
id|mpt_send_handshake_request
c_func
(paren
r_int
id|handle
comma
r_int
id|iocid
comma
r_int
id|reqBytes
comma
id|u32
op_star
id|req
)paren
(brace
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
r_int
id|r
op_assign
l_int|0
suffix:semicolon
id|iocp
op_assign
id|mpt_adapters
(braket
id|iocid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|iocp
op_ne
l_int|NULL
)paren
(brace
id|u8
op_star
id|req_as_bytes
suffix:semicolon
id|u32
id|ioc_raw_state
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* YIKES!  We already know something is amiss.&n;&t;&t; * Do upfront check on IOC state.&n;&t;&t; */
id|ioc_raw_state
op_assign
id|GetIocState
c_func
(paren
id|iocp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc_raw_state
op_amp
id|MPI_DOORBELL_ACTIVE
)paren
op_logical_or
(paren
(paren
id|ioc_raw_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_ne
id|MPI_IOC_STATE_OPERATIONAL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: Bad IOC state (%08x) WARNING!&bslash;n&quot;
comma
id|iocp-&gt;name
comma
id|ioc_raw_state
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|mpt_do_ioc_recovery
c_func
(paren
id|iocp
comma
id|MPT_HOSTEVENT_IOC_RECOVER
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: WARNING - (%d) Cannot recover %s&bslash;n&quot;
comma
id|r
comma
id|iocp-&gt;name
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * Emulate what mpt_put_msg_frame() does /wrt to sanity&n;&t;&t; * setting cb_idx/req_idx.  But ONLY if this request&n;&t;&t; * is in proper (pre-alloc&squot;d) request buffer range...&n;&t;&t; */
id|i
op_assign
id|MFPTR_2_MPT_INDEX
c_func
(paren
id|iocp
comma
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reqBytes
op_ge
l_int|12
op_logical_and
id|i
op_ge
l_int|0
op_logical_and
id|i
OL
id|iocp-&gt;req_depth
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|req
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
op_assign
id|cpu_to_le16
c_func
(paren
id|i
)paren
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.cb_idx
op_assign
id|handle
suffix:semicolon
)brace
multiline_comment|/* Make sure there are no doorbells */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|iocp-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|iocp-&gt;chip-&gt;Doorbell
comma
(paren
(paren
id|MPI_FUNCTION_HANDSHAKE
op_lshift
id|MPI_DOORBELL_FUNCTION_SHIFT
)paren
op_or
(paren
(paren
id|reqBytes
op_div
l_int|4
)paren
op_lshift
id|MPI_DOORBELL_ADD_DWORDS_SHIFT
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Wait for IOC doorbell int */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|iocp
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: mpt_send_handshake_request start, WaitCnt=%d&bslash;n&quot;
comma
id|iocp-&gt;name
comma
id|i
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|iocp-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|iocp
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Send request via doorbell handshake */
id|req_as_bytes
op_assign
(paren
id|u8
op_star
)paren
id|req
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|reqBytes
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|word
suffix:semicolon
id|word
op_assign
(paren
(paren
id|req_as_bytes
(braket
(paren
id|i
op_star
l_int|4
)paren
op_plus
l_int|0
)braket
op_lshift
l_int|0
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|i
op_star
l_int|4
)paren
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|i
op_star
l_int|4
)paren
op_plus
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|i
op_star
l_int|4
)paren
op_plus
l_int|3
)braket
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|iocp-&gt;chip-&gt;Doorbell
comma
id|word
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|iocp
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|r
op_assign
op_minus
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|r
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|iocp
comma
l_int|2
)paren
)paren
op_ge
l_int|0
)paren
id|r
op_assign
l_int|0
suffix:semicolon
r_else
id|r
op_assign
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* Make sure there are no doorbells */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|iocp-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_adapter_find_first - Find first MPT adapter pointer.&n; *&n; *&t;Returns first MPT adapter pointer or %NULL if no MPT adapters&n; *&t;are present.&n; */
id|MPT_ADAPTER
op_star
DECL|function|mpt_adapter_find_first
id|mpt_adapter_find_first
c_func
(paren
r_void
)paren
(brace
id|MPT_ADAPTER
op_star
id|this
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|MptAdapters
)paren
)paren
id|this
op_assign
id|MptAdapters.head
suffix:semicolon
r_return
id|this
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; * &t;mpt_adapter_find_next - Find next MPT adapter pointer.&n; * &t;@prev: Pointer to previous MPT adapter&n; *&n; *&t;Returns next MPT adapter pointer or %NULL if there are no more.&n; */
id|MPT_ADAPTER
op_star
DECL|function|mpt_adapter_find_next
id|mpt_adapter_find_next
c_func
(paren
id|MPT_ADAPTER
op_star
id|prev
)paren
(brace
id|MPT_ADAPTER
op_star
id|next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_logical_and
(paren
id|prev-&gt;forw
op_ne
(paren
id|MPT_ADAPTER
op_star
)paren
op_amp
id|MptAdapters.head
)paren
)paren
id|next
op_assign
id|prev-&gt;forw
suffix:semicolon
r_return
id|next
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_pci_scan - Scan PCI devices for MPT adapters.&n; *&n; *&t;Returns count of MPT adapters found, keying off of PCI vendor and&n; *&t;device_id&squot;s.&n; */
r_int
id|__init
DECL|function|mpt_pci_scan
id|mpt_pci_scan
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev2
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|r
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Checking for MPT adapters...&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  NOTE: The 929 (I believe) will appear as 2 separate PCI devices,&n;&t; *  one for each channel.&n;&t; */
id|pci_for_each_dev
c_func
(paren
id|pdev
)paren
(brace
id|pdev2
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_ne
l_int|0x1000
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev-&gt;device
op_ne
id|MPI_MANUFACTPAGE_DEVICEID_FC909
)paren
op_logical_and
(paren
id|pdev-&gt;device
op_ne
id|MPI_MANUFACTPAGE_DEVICEID_FC929
)paren
op_logical_and
(paren
id|pdev-&gt;device
op_ne
id|MPI_MANUFACTPAGE_DEVICEID_FC919
)paren
op_logical_and
macro_line|#if 0
multiline_comment|/* FIXME! C103x family */
(paren
id|pdev-&gt;device
op_ne
id|MPI_MANUFACTPAGE_DEVID_53C1030
)paren
op_logical_and
(paren
id|pdev-&gt;device
op_ne
id|MPI_MANUFACTPAGE_DEVID_53C1030_ZC
)paren
op_logical_and
(paren
id|pdev-&gt;device
op_ne
id|MPI_MANUFACTPAGE_DEVID_53C1035
)paren
op_logical_and
macro_line|#endif
l_int|1
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Skipping LSI device=%04xh&bslash;n&quot;
comma
id|pdev-&gt;device
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* GRRRRR&n;&t;&t; * 929 dual function devices may be presented in Func 1,0 order,&n;&t;&t; * but we&squot;d really really rather have them in Func 0,1 order.&n;&t;&t; * Do some kind of look ahead here...&n;&t;&t; */
r_if
c_cond
(paren
id|pdev-&gt;devfn
op_amp
l_int|1
)paren
(brace
id|pdev2
op_assign
id|pci_peek_next_dev
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev2
op_logical_and
(paren
id|pdev2-&gt;vendor
op_eq
l_int|0x1000
)paren
op_logical_and
(paren
id|PCI_SLOT
c_func
(paren
id|pdev2-&gt;devfn
)paren
op_eq
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
)paren
op_logical_and
(paren
id|pdev2-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC929
)paren
op_logical_and
(paren
id|pdev2-&gt;bus-&gt;number
op_eq
id|pdev-&gt;bus-&gt;number
)paren
op_logical_and
op_logical_neg
(paren
id|pdev2-&gt;devfn
op_amp
l_int|1
)paren
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT adapter found: PCI bus/dfn=%02x/%02xh, class=%08x, id=%xh&bslash;n&quot;
comma
id|pdev2-&gt;bus-&gt;number
comma
id|pdev2-&gt;devfn
comma
id|pdev2
op_member_access_from_pointer
r_class
comma
id|pdev2-&gt;device
)paren
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|mpt_adapter_install
c_func
(paren
id|pdev2
)paren
)paren
op_eq
l_int|0
)paren
id|count
op_increment
suffix:semicolon
)brace
r_else
(brace
id|pdev2
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT adapter found: PCI bus/dfn=%02x/%02xh, class=%08x, id=%xh&bslash;n&quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
comma
id|pdev
op_member_access_from_pointer
r_class
comma
id|pdev-&gt;device
)paren
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|mpt_adapter_install
c_func
(paren
id|pdev
)paren
)paren
op_eq
l_int|0
)paren
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pdev2
)paren
id|pdev
op_assign
id|pdev2
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %d MPT adapter%s found, %d installed.&bslash;n&quot;
comma
id|found
comma
(paren
id|found
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;s&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
op_logical_or
op_logical_neg
id|count
)paren
(brace
id|fusion_exit
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
r_if
c_cond
(paren
id|procmpt_create
c_func
(paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: WARNING! - %s creation failed!&bslash;n&quot;
comma
id|MPT_PROCFS_MPTBASEDIR
)paren
suffix:semicolon
macro_line|#endif
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_verify_adapter - Given a unique IOC identifier, set pointer to&n; *&t;the associated MPT adapter structure.&n; *&t;@iocid: IOC unique identifier (integer)&n; *&t;@iocpp: Pointer to pointer to IOC adapter&n; *&n; *&t;Returns iocid and sets iocpp.&n; */
r_int
DECL|function|mpt_verify_adapter
id|mpt_verify_adapter
c_func
(paren
r_int
id|iocid
comma
id|MPT_ADAPTER
op_star
op_star
id|iocpp
)paren
(brace
id|MPT_ADAPTER
op_star
id|p
suffix:semicolon
op_star
id|iocpp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|iocid
op_ge
id|MPT_MAX_ADAPTERS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|p
op_assign
id|mpt_adapters
(braket
id|iocid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|iocpp
op_assign
id|p
suffix:semicolon
r_return
id|iocid
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_adapter_install - Install a PCI intelligent MPT adapter.&n; *&t;@pdev: Pointer to pci_dev structure&n; *&n; *&t;This routine performs all the steps necessary to bring the IOC of&n; *&t;a MPT adapter to a OPERATIONAL state.  This includes registering&n; *&t;memory regions, registering the interrupt, and allocating request&n; *&t;and reply memory pools.&n; *&n; *&t;This routine also pre-fetches the LAN MAC address of a Fibre Channel&n; *&t;MPT adapter.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; *&n; *&t;TODO: Add support for polled controllers&n; */
r_static
r_int
id|__init
DECL|function|mpt_adapter_install
id|mpt_adapter_install
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_char
op_star
id|myname
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
r_int
r_int
id|mem_phys
suffix:semicolon
r_int
r_int
id|port
suffix:semicolon
id|u32
id|msize
suffix:semicolon
id|u32
id|psize
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|r
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ioc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|MPT_ADAPTER
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Insufficient memory to add adapter!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ioc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ioc
)paren
)paren
suffix:semicolon
id|ioc-&gt;req_sz
op_assign
id|MPT_REQ_SIZE
suffix:semicolon
multiline_comment|/* avoid div by zero! */
id|ioc-&gt;alloc_total
op_assign
r_sizeof
(paren
id|MPT_ADAPTER
)paren
suffix:semicolon
id|ioc-&gt;pcidev
op_assign
id|pdev
suffix:semicolon
multiline_comment|/* Find lookup slot. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MPT_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mpt_adapters
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|ioc-&gt;id
op_assign
id|i
suffix:semicolon
multiline_comment|/* Assign adapter unique id (lookup) */
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|MPT_MAX_ADAPTERS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - mpt_adapters[%d] table overflow!&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|ENFILE
suffix:semicolon
)brace
id|mem_phys
op_assign
id|msize
op_assign
l_int|0
suffix:semicolon
id|port
op_assign
id|psize
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pdev
op_member_access_from_pointer
id|PCI_BASEADDR_FLAGS
c_func
(paren
id|i
)paren
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
multiline_comment|/* Get I/O space! */
id|port
op_assign
id|pdev
op_member_access_from_pointer
id|PCI_BASEADDR_START
c_func
(paren
id|i
)paren
suffix:semicolon
id|psize
op_assign
id|PCI_BASEADDR_SIZE
c_func
(paren
id|pdev
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Get memmap */
id|mem_phys
op_assign
id|pdev
op_member_access_from_pointer
id|PCI_BASEADDR_START
c_func
(paren
id|i
)paren
suffix:semicolon
id|msize
op_assign
id|PCI_BASEADDR_SIZE
c_func
(paren
id|pdev
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|ioc-&gt;mem_size
op_assign
id|msize
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|DEVICE_COUNT_RESOURCE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - MPT adapter has no memory regions defined!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT adapter @ %lx, msize=%dd bytes&bslash;n&quot;
comma
id|mem_phys
comma
id|msize
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: (port i/o @ %lx, psize=%dd bytes)&bslash;n&quot;
comma
id|port
comma
id|psize
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Using %s register access method&bslash;n&quot;
comma
id|PortIo
ques
c_cond
l_string|&quot;PortIo&quot;
suffix:colon
l_string|&quot;MemMap&quot;
)paren
)paren
suffix:semicolon
id|mem
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PortIo
)paren
(brace
multiline_comment|/* Get logical ptr for PciMem0 space */
multiline_comment|/*mem = ioremap(mem_phys, msize);*/
id|mem
op_assign
id|ioremap
c_func
(paren
id|mem_phys
comma
l_int|0x100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Unable to map adapter memory!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ioc-&gt;memmap
op_assign
id|mem
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: mem = %p, mem_phys = %lx&bslash;n&quot;
comma
id|mem
comma
id|mem_phys
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PortIo
)paren
(brace
id|u8
op_star
id|pmem
op_assign
(paren
id|u8
op_star
)paren
id|port
suffix:semicolon
id|ioc-&gt;mem_phys
op_assign
id|port
suffix:semicolon
id|ioc-&gt;chip
op_assign
(paren
id|SYSIF_REGS
op_star
)paren
id|pmem
suffix:semicolon
)brace
r_else
(brace
id|ioc-&gt;mem_phys
op_assign
id|mem_phys
suffix:semicolon
id|ioc-&gt;chip
op_assign
(paren
id|SYSIF_REGS
op_star
)paren
id|mem
suffix:semicolon
)brace
id|ioc-&gt;chip_type
op_assign
id|FCUNK
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC909
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|FC909
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC909&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC929
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|FC929
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC929&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC919
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|FC919
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC919&quot;
suffix:semicolon
)brace
macro_line|#if 0
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_53C1030
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|C1030
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSI53C1030&quot;
suffix:semicolon
)brace
macro_line|#endif
id|myname
op_assign
l_string|&quot;iocN&quot;
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|myname
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ioc-&gt;name
comma
id|myname
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ioc-&gt;name
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_char|&squot;0&squot;
op_plus
id|ioc-&gt;id
suffix:semicolon
id|Q_INIT
c_func
(paren
op_amp
id|ioc-&gt;FreeQ
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
)paren
suffix:semicolon
multiline_comment|/* Disable all! */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
id|ioc-&gt;pci_irq
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;irq
)paren
(brace
id|r
op_assign
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|mpt_interrupt
comma
id|SA_SHIRQ
comma
id|ioc-&gt;name
comma
id|ioc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Unable to allocate interrupt %d!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|mem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ioc-&gt;pci_irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* ?? */
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s installed at interrupt %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pdev-&gt;irq
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* tack onto tail of our MPT adapter list */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|MptAdapters
comma
id|ioc
comma
id|MPT_ADAPTER
)paren
suffix:semicolon
multiline_comment|/* Set lookup ptr. */
id|mpt_adapters
(braket
id|ioc-&gt;id
)braket
op_assign
id|ioc
suffix:semicolon
multiline_comment|/* NEW!  20010220 -sralston&n;&t; * Check for &quot;929 bound ports&quot; to reduce redundant resets.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;chip_type
op_eq
id|FC929
)paren
id|mpt_detect_929_bound_ports
c_func
(paren
id|ioc
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|mpt_do_ioc_recovery
c_func
(paren
id|ioc
comma
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: WARNING - %s did not initialize properly! (%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|r
)paren
suffix:semicolon
)brace
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_do_ioc_recovery - Initialize or recover MPT adapter.&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&t;@reason: Event word / reason&n; *&n; *&t;This routine performs all the steps necessary to bring the IOC&n; *&t;to a OPERATIONAL state.&n; *&n; *&t;This routine also pre-fetches the LAN MAC address of a Fibre Channel&n; *&t;MPT adapter.&n; *&n; *&t;Returns 0 for success.&n; */
r_static
r_int
DECL|function|mpt_do_ioc_recovery
id|mpt_do_ioc_recovery
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|reason
)paren
(brace
r_int
id|hard_reset_done
op_assign
l_int|0
suffix:semicolon
r_int
id|alt_ioc_ready
op_assign
l_int|0
suffix:semicolon
r_int
id|hard
suffix:semicolon
r_int
id|r
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|handlers
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Initiating %s %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
ques
c_cond
l_string|&quot;bringup&quot;
suffix:colon
l_string|&quot;recovery&quot;
)paren
suffix:semicolon
multiline_comment|/* Disable reply interrupts */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* NOTE: Access to IOC&squot;s request FreeQ is now blocked! */
singleline_comment|// FIXME? Cleanup all IOC requests here! (or below?)
singleline_comment|// But watch out for event associated request?
id|hard
op_assign
id|HardReset
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
op_logical_and
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
)paren
id|hard
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hard_reset_done
op_assign
id|MakeIocReady
c_func
(paren
id|ioc
comma
id|hard
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s NOT READY WARNING!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
singleline_comment|// NEW!
macro_line|#if 0&t;&t;&t;&t;&t;&t;
singleline_comment|// Kiss-of-death!?!
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
(brace
singleline_comment|// Grrr... Hold off any alt-IOC interrupts (and events) while
singleline_comment|// handshaking to &lt;this&gt; IOC, needed because?
multiline_comment|/* Disable alt-IOC&squot;s reply interrupts for a bit ... */
id|alt_ioc_intmask
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;IntMask
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;alt_ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* NOTE: Access to alt-IOC&squot;s request FreeQ is now blocked! */
)brace
macro_line|#endif
r_if
c_cond
(paren
id|hard_reset_done
op_logical_and
id|ioc-&gt;alt_ioc
)paren
(brace
r_if
c_cond
(paren
(paren
id|r
op_assign
id|MakeIocReady
c_func
(paren
id|ioc-&gt;alt_ioc
comma
l_int|0
)paren
)paren
op_eq
l_int|0
)paren
id|alt_ioc_ready
op_assign
l_int|1
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: alt-%s: (%d) Not ready WARNING!&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|r
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
(brace
multiline_comment|/* Get IOC facts! */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|GetIocFacts
c_func
(paren
id|ioc
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|2
suffix:semicolon
id|MptDisplayIocCapabilities
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Call each currently registered protocol IOC reset handler&n;&t; * with pre-reset indication.&n;&t; * NOTE: If we&squot;re doing _IOC_BRINGUP, there can be no&n;&t; * MptResetHandlers[] registered yet.&n;&t; */
r_if
c_cond
(paren
id|hard_reset_done
)paren
(brace
id|r
op_assign
id|handlers
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|MptResetHandlers
(braket
id|i
)braket
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Calling IOC pre_reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|i
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|i
)braket
)paren
)paren
(paren
id|ioc
comma
id|MPT_IOC_PRE_RESET
)paren
suffix:semicolon
id|handlers
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|alt_ioc_ready
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Calling alt-IOC pre_reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|i
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|i
)braket
)paren
)paren
(paren
id|ioc-&gt;alt_ioc
comma
id|MPT_IOC_PRE_RESET
)paren
suffix:semicolon
id|handlers
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* FIXME?  Examine results here? */
)brace
singleline_comment|// May need to check/upload firmware &amp; data here!
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendIocInit
c_func
(paren
id|ioc
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|3
suffix:semicolon
singleline_comment|// NEW!
r_if
c_cond
(paren
id|alt_ioc_ready
)paren
(brace
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendIocInit
c_func
(paren
id|ioc-&gt;alt_ioc
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|alt_ioc_ready
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: alt-%s: (%d) init failure WARNING!&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|r
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Call each currently registered protocol IOC reset handler&n;&t; * with post-reset indication.&n;&t; * NOTE: If we&squot;re doing _IOC_BRINGUP, there can be no&n;&t; * MptResetHandlers[] registered yet.&n;&t; */
r_if
c_cond
(paren
id|hard_reset_done
)paren
(brace
id|r
op_assign
id|handlers
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|MptResetHandlers
(braket
id|i
)braket
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Calling IOC post_reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|i
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|i
)braket
)paren
)paren
(paren
id|ioc
comma
id|MPT_IOC_POST_RESET
)paren
suffix:semicolon
id|handlers
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|alt_ioc_ready
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Calling alt-IOC post_reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|i
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|i
)braket
)paren
)paren
(paren
id|ioc-&gt;alt_ioc
comma
id|MPT_IOC_POST_RESET
)paren
suffix:semicolon
id|handlers
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* FIXME?  Examine results here? */
)brace
multiline_comment|/*&n;&t; * Prime reply &amp; request queues!&n;&t; * (mucho alloc&squot;s)&n;&t; */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|PrimeIocFifos
c_func
(paren
id|ioc
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|4
suffix:semicolon
singleline_comment|// NEW!
r_if
c_cond
(paren
id|alt_ioc_ready
op_logical_and
(paren
(paren
id|r
op_assign
id|PrimeIocFifos
c_func
(paren
id|ioc-&gt;alt_ioc
)paren
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: alt-%s: (%d) FIFO mgmt alloc WARNING!&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|r
)paren
suffix:semicolon
)brace
singleline_comment|// FIXME! Cleanup all IOC (and alt-IOC?) requests here!
r_if
c_cond
(paren
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
op_logical_and
(paren
id|ioc-&gt;lan_cnfg_page0.Header.PageLength
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Pre-fetch the ports LAN MAC address!&n;&t;&t; *  (LANPage1_t stuff)&n;&t;&t; */
(paren
r_void
)paren
id|GetLanConfigPages
c_func
(paren
id|ioc
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
(brace
id|u8
op_star
id|a
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|ioc-&gt;lan_cnfg_page1.HardwareAddressLow
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: LanAddr = %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|a
(braket
l_int|5
)braket
comma
id|a
(braket
l_int|4
)braket
comma
id|a
(braket
l_int|3
)braket
comma
id|a
(braket
l_int|2
)braket
comma
id|a
(braket
l_int|1
)braket
comma
id|a
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* Enable! (reply interrupt) */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
op_complement
(paren
id|MPI_HIM_RIM
)paren
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|1
suffix:semicolon
singleline_comment|// NEW!
macro_line|#if 0&t;&t;&t;&t;&t;&t;
singleline_comment|// Kiss-of-death!?!
r_if
c_cond
(paren
id|alt_ioc_ready
op_logical_and
(paren
id|r
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* (re)Enable alt-IOC! (reply interrupt) */
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: alt-%s reply irq re-enabled&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;IntMask
comma
op_complement
(paren
id|MPI_HIM_RIM
)paren
)paren
suffix:semicolon
id|ioc-&gt;alt_ioc-&gt;active
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* NEW!  20010120 -sralston&n;&t; *  Enable MPT base driver management of EventNotification&n;&t; *  and EventAck handling.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;facts.EventState
)paren
(paren
r_void
)paren
id|SendEventNotification
c_func
(paren
id|ioc
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1=Enable EventNotification */
singleline_comment|// NEW!
singleline_comment|// FIXME!?!
singleline_comment|//&t;if (ioc-&gt;alt_ioc &amp;&amp; alt_ioc_ready &amp;&amp; !ioc-&gt;alt_ioc-&gt;facts.EventState) {
singleline_comment|//&t;&t;(void) SendEventNotification(ioc-&gt;alt_ioc, 1);&t;/* 1=Enable EventNotification */
singleline_comment|//&t;}
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_detect_929_bound_ports - Search for PCI bus/dev_function&n; *&t;which matches PCI bus/dev_function (+/-1) for newly discovered 929.&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&t;@pdev: Pointer to (struct pci_dev) structure&n; *&n; *&t;If match on PCI dev_function +/-1 is found, bind the two MPT adapters&n; *&t;using alt_ioc pointer fields in their %MPT_ADAPTER structures.&n; */
r_static
r_void
DECL|function|mpt_detect_929_bound_ports
id|mpt_detect_929_bound_ports
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc_srch
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|match_lo
comma
id|match_hi
suffix:semicolon
id|match_lo
op_assign
id|pdev-&gt;devfn
op_minus
l_int|1
suffix:semicolon
id|match_hi
op_assign
id|pdev-&gt;devfn
op_plus
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: PCI bus/devfn=%x/%x, searching for devfn match on %x or %x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
comma
id|match_lo
comma
id|match_hi
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ioc_srch
op_ne
l_int|NULL
)paren
(brace
r_struct
id|pci_dev
op_star
id|_pcidev
op_assign
id|ioc_srch-&gt;pcidev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|_pcidev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC929
)paren
op_logical_and
(paren
id|_pcidev-&gt;bus-&gt;number
op_eq
id|pdev-&gt;bus-&gt;number
)paren
op_logical_and
(paren
id|_pcidev-&gt;devfn
op_eq
id|match_lo
op_logical_or
id|_pcidev-&gt;devfn
op_eq
id|match_hi
)paren
)paren
(brace
multiline_comment|/* Paranoia checks */
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Oops, already bound (%s &lt;==&gt; %s)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;alt_ioc-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc_srch-&gt;alt_ioc
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Oops, already bound (%s &lt;==&gt; %s)!&bslash;n&quot;
comma
id|ioc_srch-&gt;name
comma
id|ioc_srch-&gt;alt_ioc-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: FOUND! binding %s &lt;==&gt; %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc_srch-&gt;name
)paren
)paren
suffix:semicolon
id|ioc_srch-&gt;alt_ioc
op_assign
id|ioc
suffix:semicolon
id|ioc-&gt;alt_ioc
op_assign
id|ioc_srch
suffix:semicolon
id|ioc-&gt;sod_reset
op_assign
id|ioc-&gt;alt_ioc-&gt;sod_reset
suffix:semicolon
id|ioc-&gt;last_kickstart
op_assign
id|ioc-&gt;alt_ioc-&gt;last_kickstart
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ioc_srch
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|ioc_srch
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_adapter_disable - Disable misbehaving MPT adapter.&n; *&t;@this: Pointer to MPT adapter structure&n; *&t;@free: Free up alloc&squot;d reply, request, etc.&n; */
r_static
r_void
DECL|function|mpt_adapter_disable
id|mpt_adapter_disable
c_func
(paren
id|MPT_ADAPTER
op_star
id|this
comma
r_int
id|freeup
)paren
(brace
r_if
c_cond
(paren
id|this
op_ne
l_int|NULL
)paren
(brace
r_int
id|sz
suffix:semicolon
multiline_comment|/* Disable the FW */
r_if
c_cond
(paren
id|SendIocReset
c_func
(paren
id|this
comma
id|MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET
)paren
op_ne
l_int|0
)paren
(paren
r_void
)paren
id|KickStart
c_func
(paren
id|this
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Disable adapter interrupts! */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|this-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|this-&gt;active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear any lingering interrupt */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|this-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freeup
op_logical_and
id|this-&gt;reply_alloc
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|this-&gt;reply_sz
op_star
id|this-&gt;reply_depth
)paren
op_plus
l_int|128
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|this-&gt;pcidev
comma
id|sz
comma
id|this-&gt;reply_alloc
comma
id|this-&gt;reply_alloc_dma
)paren
suffix:semicolon
id|this-&gt;reply_frames
op_assign
l_int|NULL
suffix:semicolon
id|this-&gt;reply_alloc
op_assign
l_int|NULL
suffix:semicolon
id|this-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freeup
op_logical_and
id|this-&gt;req_alloc
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|this-&gt;req_sz
op_star
id|this-&gt;req_depth
)paren
op_plus
l_int|128
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *  Rounding UP to nearest 4-kB boundary here...&n;&t;&t;&t; */
id|sz
op_assign
(paren
(paren
id|sz
op_plus
l_int|0x1000UL
op_minus
l_int|1UL
)paren
op_div
l_int|0x1000
)paren
op_star
l_int|0x1000
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|this-&gt;pcidev
comma
id|sz
comma
id|this-&gt;req_alloc
comma
id|this-&gt;req_alloc_dma
)paren
suffix:semicolon
id|this-&gt;req_frames
op_assign
l_int|NULL
suffix:semicolon
id|this-&gt;req_alloc
op_assign
l_int|NULL
suffix:semicolon
id|this-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freeup
op_logical_and
id|this-&gt;sense_buf_pool
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|this-&gt;req_depth
op_star
l_int|256
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|this-&gt;pcidev
comma
id|sz
comma
id|this-&gt;sense_buf_pool
comma
id|this-&gt;sense_buf_pool_dma
)paren
suffix:semicolon
id|this-&gt;sense_buf_pool
op_assign
l_int|NULL
suffix:semicolon
id|this-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_adapter_dispose - Free all resources associated with a MPT&n; *&t;adapter.&n; *&t;@this: Pointer to MPT adapter structure&n; *&n; *&t;This routine unregisters h/w resources and frees all alloc&squot;d memory&n; *&t;associated with a MPT adapter structure.&n; */
r_static
r_void
DECL|function|mpt_adapter_dispose
id|mpt_adapter_dispose
c_func
(paren
id|MPT_ADAPTER
op_star
id|this
)paren
(brace
r_if
c_cond
(paren
id|this
op_ne
l_int|NULL
)paren
(brace
r_int
id|sz_first
comma
id|sz_last
suffix:semicolon
id|sz_first
op_assign
id|this-&gt;alloc_total
suffix:semicolon
id|mpt_adapter_disable
c_func
(paren
id|this
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;pci_irq
op_ne
op_minus
l_int|1
)paren
(brace
id|free_irq
c_func
(paren
id|this-&gt;pci_irq
comma
id|this
)paren
suffix:semicolon
id|this-&gt;pci_irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|this-&gt;memmap
op_ne
l_int|NULL
)paren
id|iounmap
c_func
(paren
(paren
id|u8
op_star
)paren
id|this-&gt;memmap
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_MTRR) &amp;&amp; 0
r_if
c_cond
(paren
id|this-&gt;mtrr_reg
OG
l_int|0
)paren
(brace
id|mtrr_del
c_func
(paren
id|this-&gt;mtrr_reg
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: MTRR region de-registered&bslash;n&quot;
comma
id|this-&gt;name
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*  Zap the adapter lookup ptr!  */
id|mpt_adapters
(braket
id|this-&gt;id
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sz_last
op_assign
id|this-&gt;alloc_total
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: free&squot;d %d of %d bytes&bslash;n&quot;
comma
id|this-&gt;name
comma
id|sz_first
op_minus
id|sz_last
op_plus
(paren
r_int
)paren
r_sizeof
(paren
op_star
id|this
)paren
comma
id|sz_first
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|this
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;MptDisplayIocCapabilities - Disply IOC&squot;s capacilities.&n; *&t;@ioc: Pointer to MPT adapter structure&n; */
r_static
r_void
DECL|function|MptDisplayIocCapabilities
id|MptDisplayIocCapabilities
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: &quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;prod_name
op_logical_and
id|strlen
c_func
(paren
id|ioc-&gt;prod_name
)paren
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
comma
id|ioc-&gt;prod_name
op_plus
l_int|3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Capabilities={&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_INITIATOR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Initiator&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_TARGET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%sTarget&quot;
comma
id|i
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%sLAN&quot;
comma
id|i
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n;&t; *  This would probably evoke more questions than it&squot;s worth&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_TARGET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%sLogBusAddr&quot;
comma
id|i
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;}&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;MakeIocReady - Get IOC to a READY state, using KickStart if needed.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@kick: Force hard KickStart of IOC&n; *&n; *&t;Returns 0 for already-READY, 1 for hard reset success,&n; *&t;else negative for failure.&n; */
r_static
r_int
DECL|function|MakeIocReady
id|MakeIocReady
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|force
)paren
(brace
id|u32
id|ioc_state
suffix:semicolon
r_int
id|statefault
op_assign
l_int|0
suffix:semicolon
r_int
id|cntdn
suffix:semicolon
r_int
id|hard_reset_done
op_assign
l_int|0
suffix:semicolon
r_int
id|r
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Get current [raw] IOC state  */
id|ioc_state
op_assign
id|GetIocState
c_func
(paren
id|ioc
comma
l_int|0
)paren
suffix:semicolon
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::MakeIocReady, %s [raw] state=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc_state
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check to see if IOC got left/stuck in doorbell handshake&n;&t; *&t;grip of death.  If so, hard reset the IOC.&n;&t; */
r_if
c_cond
(paren
id|ioc_state
op_amp
id|MPI_DOORBELL_ACTIVE
)paren
(brace
id|statefault
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: Uh-oh, unexpected doorbell active!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Is it already READY? */
r_if
c_cond
(paren
op_logical_neg
id|statefault
op_logical_and
(paren
id|ioc_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_eq
id|MPI_IOC_STATE_READY
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check to see if IOC is in FAULT state.&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_eq
id|MPI_IOC_STATE_FAULT
)paren
(brace
id|statefault
op_assign
l_int|2
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: Uh-oh, IOC is in FAULT state!!!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;           FAULT code = %04xh&bslash;n&quot;
comma
id|ioc_state
op_amp
id|MPI_DOORBELL_DATA_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Hmmm...  Did it get left operational?&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_eq
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
id|statefault
op_assign
l_int|3
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: Hmmm... IOC operational unexpected&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
id|hard_reset_done
op_assign
id|KickStart
c_func
(paren
id|ioc
comma
id|statefault
op_logical_or
id|force
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hard_reset_done
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *  Loop here waiting for IOC to come READY.&n;&t; */
id|i
op_assign
l_int|0
suffix:semicolon
id|cntdn
op_assign
id|HZ
op_star
l_int|15
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ioc_state
op_assign
id|GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
)paren
op_ne
id|MPI_IOC_STATE_READY
)paren
(brace
r_if
c_cond
(paren
id|ioc_state
op_eq
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *  BIOS or previous driver load left IOC in OP state.&n;&t;&t;&t; *  Reset messaging FIFOs.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendIocReset
c_func
(paren
id|ioc
comma
id|MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - IOC msg unit reset failed!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ioc_state
op_eq
id|MPI_IOC_STATE_RESET
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *  Something is wrong.  Try to get IOC back&n;&t;&t;&t; *  to a known state.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendIocReset
c_func
(paren
id|ioc
comma
id|MPI_FUNCTION_IO_UNIT_RESET
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - IO unit reset failed!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
)brace
id|i
op_increment
suffix:semicolon
id|cntdn
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cntdn
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Wait IOC_READY state timeout(%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
id|i
op_plus
l_int|5
)paren
op_div
id|HZ
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|statefault
OL
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: Whew!  Recovered from %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|statefault
op_eq
l_int|1
ques
c_cond
l_string|&quot;stuck handshake&quot;
suffix:colon
l_string|&quot;IOC FAULT&quot;
)paren
suffix:semicolon
)brace
r_return
id|hard_reset_done
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetIocState - Get the current state of a MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@cooked: Request raw or cooked IOC state&n; *&n; *&t;Returns all IOC Doorbell register bits if cooked==0, else just the&n; *&t;Doorbell bits in MPI_IOC_STATE_MASK.&n; */
r_static
id|u32
DECL|function|GetIocState
id|GetIocState
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|cooked
)paren
(brace
id|u32
id|s
comma
id|sc
suffix:semicolon
multiline_comment|/*  Get!  */
id|s
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: raw state = %08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|s
)paren
)paren
suffix:semicolon
id|sc
op_assign
id|s
op_amp
id|MPI_IOC_STATE_MASK
suffix:semicolon
multiline_comment|/*  Save!  */
id|ioc-&gt;last_state
op_assign
id|sc
suffix:semicolon
r_return
id|cooked
ques
c_cond
id|sc
suffix:colon
id|s
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetIocFacts - Send IOCFacts request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|GetIocFacts
id|GetIocFacts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|IOCFacts_t
id|get_facts
suffix:semicolon
id|IOCFactsReply_t
op_star
id|facts
suffix:semicolon
r_int
id|r
suffix:semicolon
r_int
id|req_sz
suffix:semicolon
r_int
id|reply_sz
suffix:semicolon
id|u32
id|status
suffix:semicolon
multiline_comment|/* IOC *must* NOT be in RESET state! */
r_if
c_cond
(paren
id|ioc-&gt;last_state
op_eq
id|MPI_IOC_STATE_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Can&squot;t get IOCFacts, %s NOT READY! (%08x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;last_state
)paren
suffix:semicolon
r_return
op_minus
l_int|44
suffix:semicolon
)brace
id|facts
op_assign
op_amp
id|ioc-&gt;facts
suffix:semicolon
multiline_comment|/* Destination (reply area)... */
id|reply_sz
op_assign
r_sizeof
(paren
op_star
id|facts
)paren
suffix:semicolon
id|memset
c_func
(paren
id|facts
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
multiline_comment|/* Request area (get_facts on the stack right now!) */
id|req_sz
op_assign
r_sizeof
(paren
id|get_facts
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|get_facts
comma
l_int|0
comma
id|req_sz
)paren
suffix:semicolon
id|get_facts.Function
op_assign
id|MPI_FUNCTION_IOC_FACTS
suffix:semicolon
multiline_comment|/* Assert: All other get_facts fields are zero! */
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Sending get IocFacts request&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* No non-zero fields in the get_facts request are greater than&n;&t; * 1 byte in size, so we can just fire it off as is.&n;&t; */
id|r
op_assign
id|HandShakeReqAndReply
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|get_facts
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
id|facts
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_ne
l_int|0
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/*&n;&t; * Now byte swap (GRRR) the necessary fields before any further&n;&t; * inspection of reply contents.&n;&t; *&n;&t; * But need to do some sanity checks on MsgLength (byte) field&n;&t; * to make sure we don&squot;t zero IOC&squot;s req_sz!&n;&t; */
multiline_comment|/* Did we get a valid reply? */
r_if
c_cond
(paren
id|facts-&gt;MsgLength
OG
m_offsetof
(paren
id|IOCFactsReply_t
comma
id|RequestFrameSize
)paren
op_div
r_sizeof
(paren
id|u32
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * If not been here, done that, save off first WhoInit value&n;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;FirstWhoInit
op_eq
id|WHOINIT_UNKNOWN
)paren
id|ioc-&gt;FirstWhoInit
op_assign
id|facts-&gt;WhoInit
suffix:semicolon
id|facts-&gt;MsgVersion
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;MsgVersion
)paren
suffix:semicolon
id|facts-&gt;MsgContext
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;MsgContext
)paren
suffix:semicolon
id|facts-&gt;IOCStatus
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;IOCStatus
)paren
suffix:semicolon
id|facts-&gt;IOCLogInfo
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;IOCLogInfo
)paren
suffix:semicolon
id|status
op_assign
id|facts-&gt;IOCStatus
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
multiline_comment|/* CHECKME! IOCStatus, IOCLogInfo */
id|facts-&gt;ReplyQueueDepth
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;ReplyQueueDepth
)paren
suffix:semicolon
id|facts-&gt;RequestFrameSize
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;RequestFrameSize
)paren
suffix:semicolon
id|facts-&gt;FWVersion
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;FWVersion
)paren
suffix:semicolon
id|facts-&gt;ProductID
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;ProductID
)paren
suffix:semicolon
id|facts-&gt;CurrentHostMfaHighAddr
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;CurrentHostMfaHighAddr
)paren
suffix:semicolon
id|facts-&gt;GlobalCredits
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;GlobalCredits
)paren
suffix:semicolon
id|facts-&gt;CurrentSenseBufferHighAddr
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;CurrentSenseBufferHighAddr
)paren
suffix:semicolon
id|facts-&gt;CurReplyFrameSize
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;CurReplyFrameSize
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Handle NEW (!) IOCFactsReply fields in MPI-1.01.xx&n;&t;&t; * Older MPI-1.00.xx struct had 13 dwords, and enlarged&n;&t;&t; * to 14 in MPI-1.01.0x.&n;&t;&t; */
r_if
c_cond
(paren
id|facts-&gt;MsgLength
op_ge
r_sizeof
(paren
id|IOCFactsReply_t
)paren
op_div
r_sizeof
(paren
id|u32
)paren
op_logical_and
id|facts-&gt;MsgVersion
OG
l_int|0x0100
)paren
(brace
id|facts-&gt;FWImageSize
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;FWImageSize
)paren
suffix:semicolon
id|facts-&gt;DataImageSize
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;DataImageSize
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|facts-&gt;RequestFrameSize
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Set values for this IOC&squot;s REQUEST queue size &amp; depth...&n;&t;&t;&t; */
id|ioc-&gt;req_sz
op_assign
id|MIN
c_func
(paren
id|MPT_REQ_SIZE
comma
id|facts-&gt;RequestFrameSize
op_star
l_int|4
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *  Set values for this IOC&squot;s REPLY queue size &amp; depth...&n;&t;&t;&t; *&n;&t;&t;&t; * BUG? FIX?  20000516 -nromer &amp; sralston &n;&t;&t;&t; *  GRRR...  The following did not translate well from MPI v0.09:&n;&t;&t;&t; *&t;ioc-&gt;reply_sz = MIN(MPT_REPLY_SIZE, facts-&gt;ReplySize * 4);&n;&t;&t;&t; *  to 0.10:&n;&t;&t;&t; *&t;ioc-&gt;reply_sz = MIN(MPT_REPLY_SIZE, facts-&gt;BlockSize * 4);&n;&t;&t;&t; *  Was trying to minimally optimize to smallest possible reply size&n;&t;&t;&t; *  (and greatly reduce kmalloc size).  But LAN may need larger reply?&n;&t;&t;&t; *&n;&t;&t;&t; *  So for now, just set reply size to request size.  FIXME?&n;&t;&t;&t; */
id|ioc-&gt;reply_sz
op_assign
id|ioc-&gt;req_sz
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*  Something is wrong!  */
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - IOC reported invalid 0 request size!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|ioc-&gt;req_sz
op_assign
id|MPT_REQ_SIZE
suffix:semicolon
id|ioc-&gt;reply_sz
op_assign
id|MPT_REPLY_SIZE
suffix:semicolon
r_return
op_minus
l_int|55
suffix:semicolon
)brace
id|ioc-&gt;req_depth
op_assign
id|MIN
c_func
(paren
id|MPT_REQ_DEPTH
comma
id|facts-&gt;GlobalCredits
)paren
suffix:semicolon
id|ioc-&gt;reply_depth
op_assign
id|MIN
c_func
(paren
id|MPT_REPLY_DEPTH
comma
id|facts-&gt;ReplyQueueDepth
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: reply_sz=%3d, reply_depth=%4d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;reply_sz
comma
id|ioc-&gt;reply_depth
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: req_sz  =%3d, req_depth  =%4d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;req_sz
comma
id|ioc-&gt;req_depth
)paren
)paren
suffix:semicolon
multiline_comment|/* Get port facts! */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|GetPortFacts
c_func
(paren
id|ioc
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|r
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Invalid IOC facts reply!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|66
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetPortFacts - Send PortFacts request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@portnum: Port number&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|GetPortFacts
id|GetPortFacts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
(brace
id|PortFacts_t
id|get_pfacts
suffix:semicolon
id|PortFactsReply_t
op_star
id|pfacts
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|req_sz
suffix:semicolon
r_int
id|reply_sz
suffix:semicolon
multiline_comment|/* IOC *must* NOT be in RESET state! */
r_if
c_cond
(paren
id|ioc-&gt;last_state
op_eq
id|MPI_IOC_STATE_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Can&squot;t get PortFacts, %s NOT READY! (%08x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;last_state
)paren
suffix:semicolon
r_return
op_minus
l_int|4
suffix:semicolon
)brace
id|pfacts
op_assign
op_amp
id|ioc-&gt;pfacts
(braket
id|portnum
)braket
suffix:semicolon
multiline_comment|/* Destination (reply area)...  */
id|reply_sz
op_assign
r_sizeof
(paren
op_star
id|pfacts
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pfacts
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
multiline_comment|/* Request area (get_pfacts on the stack right now!) */
id|req_sz
op_assign
r_sizeof
(paren
id|get_pfacts
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|get_pfacts
comma
l_int|0
comma
id|req_sz
)paren
suffix:semicolon
id|get_pfacts.Function
op_assign
id|MPI_FUNCTION_PORT_FACTS
suffix:semicolon
id|get_pfacts.PortNumber
op_assign
id|portnum
suffix:semicolon
multiline_comment|/* Assert: All other get_pfacts fields are zero! */
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Sending get PortFacts(%d) request&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|portnum
)paren
)paren
suffix:semicolon
multiline_comment|/* No non-zero fields in the get_pfacts request are greater than&n;&t; * 1 byte in size, so we can just fire it off as is.&n;&t; */
id|i
op_assign
id|HandShakeReqAndReply
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|get_pfacts
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
id|pfacts
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
r_return
id|i
suffix:semicolon
multiline_comment|/* Did we get a valid reply? */
multiline_comment|/* Now byte swap the necessary fields in the response. */
id|pfacts-&gt;MsgContext
op_assign
id|le32_to_cpu
c_func
(paren
id|pfacts-&gt;MsgContext
)paren
suffix:semicolon
id|pfacts-&gt;IOCStatus
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;IOCStatus
)paren
suffix:semicolon
id|pfacts-&gt;IOCLogInfo
op_assign
id|le32_to_cpu
c_func
(paren
id|pfacts-&gt;IOCLogInfo
)paren
suffix:semicolon
id|pfacts-&gt;MaxDevices
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;MaxDevices
)paren
suffix:semicolon
id|pfacts-&gt;PortSCSIID
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;PortSCSIID
)paren
suffix:semicolon
id|pfacts-&gt;ProtocolFlags
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;ProtocolFlags
)paren
suffix:semicolon
id|pfacts-&gt;MaxPostedCmdBuffers
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;MaxPostedCmdBuffers
)paren
suffix:semicolon
id|pfacts-&gt;MaxPersistentIDs
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;MaxPersistentIDs
)paren
suffix:semicolon
id|pfacts-&gt;MaxLanBuckets
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;MaxLanBuckets
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;SendIocInit - Send IOCInit request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&n; *&t;Send IOCInit followed by PortEnable to bring IOC to OPERATIONAL state.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|SendIocInit
id|SendIocInit
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|IOCInit_t
id|ioc_init
suffix:semicolon
id|MPIDefaultReply_t
id|init_reply
suffix:semicolon
id|u32
id|state
suffix:semicolon
r_int
id|r
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|cntdn
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ioc_init
comma
l_int|0
comma
r_sizeof
(paren
id|ioc_init
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|init_reply
comma
l_int|0
comma
r_sizeof
(paren
id|init_reply
)paren
)paren
suffix:semicolon
id|ioc_init.WhoInit
op_assign
id|MPI_WHOINIT_HOST_DRIVER
suffix:semicolon
multiline_comment|/*&t;ioc_init.ChainOffset = 0;&t;&t;&t;*/
id|ioc_init.Function
op_assign
id|MPI_FUNCTION_IOC_INIT
suffix:semicolon
multiline_comment|/*&t;ioc_init.Flags = 0;&t;&t;&t;&t;*/
multiline_comment|/*ioc_init.MaxDevices = 16;*/
id|ioc_init.MaxDevices
op_assign
l_int|255
suffix:semicolon
multiline_comment|/*&t;ioc_init.MaxBuses = 16;&t;&t;&t;&t;*/
id|ioc_init.MaxBuses
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&t;ioc_init.MsgFlags = 0;&t;&t;&t;&t;*/
multiline_comment|/*&t;ioc_init.MsgContext = cpu_to_le32(0x00000000);&t;*/
id|ioc_init.ReplyFrameSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ioc-&gt;reply_sz
)paren
suffix:semicolon
multiline_comment|/* in BYTES */
id|ioc_init.HostMfaHighAddr
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Say we 32-bit! for now */
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Sending IOCInit (req @ %p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
op_amp
id|ioc_init
)paren
)paren
suffix:semicolon
id|r
op_assign
id|HandShakeReqAndReply
c_func
(paren
id|ioc
comma
r_sizeof
(paren
id|IOCInit_t
)paren
comma
(paren
id|u32
op_star
)paren
op_amp
id|ioc_init
comma
r_sizeof
(paren
id|MPIDefaultReply_t
)paren
comma
(paren
id|u16
op_star
)paren
op_amp
id|init_reply
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_ne
l_int|0
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/* No need to byte swap the multibyte fields in the reply&n;&t; * since we don&squot;t even look at it&squot;s contents.&n;&t; */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendPortEnable
c_func
(paren
id|ioc
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/* YIKES!  SUPER IMPORTANT!!!&n;&t; *  Poll IocState until _OPERATIONAL while IOC is doing&n;&t; *  LoopInit and TargetDiscovery!&n;&t; */
id|count
op_assign
l_int|0
suffix:semicolon
id|cntdn
op_assign
id|HZ
op_star
l_int|60
suffix:semicolon
multiline_comment|/* chg&squot;d from 30 to 60 seconds */
id|state
op_assign
id|GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|state
op_ne
id|MPI_IOC_STATE_OPERATIONAL
op_logical_and
op_decrement
id|cntdn
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cntdn
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Wait IOC_OP state timeout(%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
id|count
op_plus
l_int|5
)paren
op_div
id|HZ
)paren
suffix:semicolon
r_return
op_minus
l_int|9
suffix:semicolon
)brace
id|state
op_assign
id|GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: INFO - Wait IOC_OPERATIONAL state (cnt=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
)paren
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;SendPortEnable - Send PortEnable request to MPT adapter port.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@portnum: Port number to enable&n; *&n; *&t;Send PortEnable to bring IOC to OPERATIONAL state.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|SendPortEnable
id|SendPortEnable
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
(brace
id|PortEnable_t
id|port_enable
suffix:semicolon
id|MPIDefaultReply_t
id|reply_buf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|req_sz
suffix:semicolon
r_int
id|reply_sz
suffix:semicolon
multiline_comment|/*  Destination...  */
id|reply_sz
op_assign
r_sizeof
(paren
id|MPIDefaultReply_t
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|reply_buf
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
id|req_sz
op_assign
r_sizeof
(paren
id|PortEnable_t
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|port_enable
comma
l_int|0
comma
id|req_sz
)paren
suffix:semicolon
id|port_enable.Function
op_assign
id|MPI_FUNCTION_PORT_ENABLE
suffix:semicolon
id|port_enable.PortNumber
op_assign
id|portnum
suffix:semicolon
multiline_comment|/*&t;port_enable.ChainOffset = 0;&t;&t;*/
multiline_comment|/*&t;port_enable.MsgFlags = 0;&t;&t;*/
multiline_comment|/*&t;port_enable.MsgContext = 0;&t;&t;*/
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Sending Port(%d)Enable (req @ %p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|portnum
comma
op_amp
id|port_enable
)paren
)paren
suffix:semicolon
id|i
op_assign
id|HandShakeReqAndReply
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|port_enable
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
op_amp
id|reply_buf
comma
l_int|65
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
r_return
id|i
suffix:semicolon
multiline_comment|/* We do not even look at the reply, so we need not&n;&t; * swap the multi-byte fields.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;KickStart - Perform hard reset of MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@force: Force hard reset&n; *&n; *&t;This routine places MPT adapter in diagnostic mode via the&n; *&t;WriteSequence register, and then performs a hard reset of adapter&n; *&t;via the Diagnostic register.&n; *&n; *&t;Returns 0 for soft reset success, 1 for hard reset success,&n; *&t;else a negative value for failure.&n; */
r_static
r_int
DECL|function|KickStart
id|KickStart
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|force
)paren
(brace
r_int
id|hard_reset_done
op_assign
l_int|0
suffix:semicolon
id|u32
id|ioc_state
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: KickStarting %s!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|hard_reset_done
op_assign
id|mpt_fc9x9_reset
c_func
(paren
id|ioc
comma
id|force
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ioc-&gt;chip_type
op_eq
id|FC909
op_logical_or
id|ioc-&gt;chip
op_minus
id|type
op_eq
id|FC919
)paren
(brace
id|hard_reset_done
op_assign
id|mpt_fc9x9_reset
c_func
(paren
id|ioc
comma
id|force
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc-&gt;chip_type
op_eq
id|FC929
)paren
(brace
r_int
r_int
id|delta
suffix:semicolon
id|delta
op_assign
id|jiffies
op_minus
id|ioc-&gt;last_kickstart
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: 929 KickStart, last=%ld, delta = %ld&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;last_kickstart
comma
id|delta
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;sod_reset
op_eq
l_int|0
)paren
op_logical_or
(paren
id|delta
op_ge
l_int|10
op_star
id|HZ
)paren
)paren
id|hard_reset_done
op_assign
id|mpt_fc9x9_reset
c_func
(paren
id|ioc
comma
id|ignore
)paren
suffix:semicolon
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Skipping KickStart (delta=%ld)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|delta
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TODO! Add C1030!&n;&t;} else if (ioc-&gt;chip_type == C1030) {&n;&t; */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Bad chip_type (0x%x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;chip_type
)paren
suffix:semicolon
r_return
op_minus
l_int|5
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|hard_reset_done
OL
l_int|0
)paren
r_return
id|hard_reset_done
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Diagnostic reset successful&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|HZ
op_star
l_int|20
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioc_state
op_assign
id|GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
)paren
op_eq
id|MPI_IOC_STATE_READY
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: KickStart successful! (cnt=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|cnt
)paren
)paren
suffix:semicolon
r_return
id|hard_reset_done
suffix:semicolon
)brace
multiline_comment|/* udelay(10000) ? */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Failed to come READY after reset!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_fc9x9_reset - Perform hard reset of FC9x9 adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&n; *&t;This routine places FC9x9 adapter in diagnostic mode via the&n; *&t;WriteSequence register, and then performs a hard reset of adapter&n; *&t;via the Diagnostic register.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|mpt_fc9x9_reset
id|mpt_fc9x9_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|ignore
)paren
(brace
id|u32
id|diag0val
suffix:semicolon
r_int
id|hard_reset_done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Use &quot;Diagnostic reset&quot; method! (only thing available!) */
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
(brace
id|u32
id|diag1val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|diag1val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: DBG1: diag0=%08x, diag1=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
comma
id|diag1val
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|diag0val
op_amp
id|MPI_DIAG_DRWE
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: DiagWriteEn bit already set&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Write magic sequence to WriteSequence register */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_1ST_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_2ND_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_3RD_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_4TH_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_5TH_KEY_VALUE
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Wrote magic DiagWriteEn sequence [spot#1]&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
(brace
id|u32
id|diag1val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|diag1val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: DbG2: diag0=%08x, diag1=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
comma
id|diag1val
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ignore
op_logical_and
(paren
id|diag0val
op_amp
id|MPI_DIAG_RESET_HISTORY
)paren
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Skipping due to ResetHistory bit set!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Now hit the reset bit in the Diagnostic register&n;&t;&t; * (THE BIG HAMMER!)&n;&t;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
id|MPI_DIAG_RESET_ADAPTER
)paren
suffix:semicolon
id|hard_reset_done
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Diagnostic reset performed&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* want udelay(100) */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Write magic sequence to WriteSequence register */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_1ST_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_2ND_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_3RD_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_4TH_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_5TH_KEY_VALUE
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Wrote magic DiagWriteEn sequence [spot#2]&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear RESET_HISTORY bit! */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
l_int|0x0
)paren
suffix:semicolon
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
(brace
id|u32
id|diag1val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|diag1val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: DbG3: diag0=%08x, diag1=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
comma
id|diag1val
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|diag0val
op_amp
id|MPI_DIAG_RESET_HISTORY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: WARNING - ResetHistory bit failed to clear!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
(brace
id|u32
id|diag1val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|diag1val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: DbG4: diag0=%08x, diag1=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
comma
id|diag1val
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|diag0val
op_amp
(paren
id|MPI_DIAG_FLASH_BAD_SIG
op_or
id|MPI_DIAG_RESET_ADAPTER
op_or
id|MPI_DIAG_DISABLE_ARM
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Diagnostic reset FAILED! (%02xh)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Reset flag that says we&squot;ve enabled event notification&n;&t; */
id|ioc-&gt;facts.EventState
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* NEW!  20010220 -sralston&n;&t; * Try to avoid redundant resets of the 929.&n;&t; */
id|ioc-&gt;sod_reset
op_increment
suffix:semicolon
id|ioc-&gt;last_kickstart
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
(brace
id|ioc-&gt;alt_ioc-&gt;sod_reset
op_assign
id|ioc-&gt;sod_reset
suffix:semicolon
id|ioc-&gt;alt_ioc-&gt;last_kickstart
op_assign
id|ioc-&gt;last_kickstart
suffix:semicolon
)brace
r_return
id|hard_reset_done
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;SendIocReset - Send IOCReset request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@reset_type: reset type, expected values are&n; *&t;%MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET or %MPI_FUNCTION_IO_UNIT_RESET&n; *&n; *&t;Send IOCReset request to the MPT adapter.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|SendIocReset
id|SendIocReset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u8
id|reset_type
)paren
(brace
r_int
id|r
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: Sending IOC reset(0x%02x)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|reset_type
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
comma
id|reset_type
op_lshift
id|MPI_DOORBELL_FUNCTION_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|ioc
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/* TODO!&n;&t; *  Cleanup all event stuff for this IOC; re-issue EventNotification&n;&t; *  request if needed.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;facts.Function
)paren
id|ioc-&gt;facts.EventState
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;PrimeIocFifos - Initialize IOC request and reply FIFOs.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&n; *&t;This routine allocates memory for the MPT reply and request frame&n; *&t;pools, and primes the IOC reply FIFO with reply frames.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|PrimeIocFifos
id|PrimeIocFifos
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
r_int
id|b
suffix:semicolon
id|dma_addr_t
id|aligned_mem_dma
suffix:semicolon
id|u8
op_star
id|mem
comma
op_star
id|aligned_mem
suffix:semicolon
r_int
id|i
comma
id|sz
suffix:semicolon
multiline_comment|/*  Prime reply FIFO...  */
r_if
c_cond
(paren
id|ioc-&gt;reply_frames
op_eq
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|ioc-&gt;reply_sz
op_star
id|ioc-&gt;reply_depth
)paren
op_plus
l_int|128
suffix:semicolon
id|mem
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
op_amp
id|ioc-&gt;reply_alloc_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_goto
id|out_fail
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|ioc-&gt;alloc_total
op_add_assign
id|sz
suffix:semicolon
id|ioc-&gt;reply_alloc
op_assign
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.reply_alloc  @ %p[%08x], sz=%d bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mem
comma
id|ioc-&gt;reply_alloc_dma
comma
id|sz
)paren
)paren
suffix:semicolon
id|b
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
id|b
op_assign
(paren
id|b
op_plus
(paren
l_int|0x80UL
op_minus
l_int|1UL
)paren
)paren
op_amp
op_complement
(paren
l_int|0x80UL
op_minus
l_int|1UL
)paren
suffix:semicolon
multiline_comment|/* round up to 128-byte boundary */
id|aligned_mem
op_assign
(paren
id|u8
op_star
)paren
id|b
suffix:semicolon
id|ioc-&gt;reply_frames
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|aligned_mem
suffix:semicolon
id|ioc-&gt;reply_frames_dma
op_assign
(paren
id|ioc-&gt;reply_alloc_dma
op_plus
(paren
id|aligned_mem
op_minus
id|mem
)paren
)paren
suffix:semicolon
id|aligned_mem_dma
op_assign
id|ioc-&gt;reply_frames_dma
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.reply_frames @ %p[%08x]&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|aligned_mem
comma
id|aligned_mem_dma
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ioc-&gt;reply_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/*  Write each address to the IOC!  */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;ReplyFifo
comma
id|aligned_mem_dma
)paren
suffix:semicolon
id|aligned_mem_dma
op_add_assign
id|ioc-&gt;reply_sz
suffix:semicolon
)brace
)brace
multiline_comment|/*  Request FIFO - WE manage this!  */
r_if
c_cond
(paren
id|ioc-&gt;req_frames
op_eq
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|ioc-&gt;req_sz
op_star
id|ioc-&gt;req_depth
)paren
op_plus
l_int|128
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Rounding UP to nearest 4-kB boundary here...&n;&t;&t; */
id|sz
op_assign
(paren
(paren
id|sz
op_plus
l_int|0x1000UL
op_minus
l_int|1UL
)paren
op_div
l_int|0x1000
)paren
op_star
l_int|0x1000
suffix:semicolon
id|mem
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
op_amp
id|ioc-&gt;req_alloc_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_goto
id|out_fail
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|ioc-&gt;alloc_total
op_add_assign
id|sz
suffix:semicolon
id|ioc-&gt;req_alloc
op_assign
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.req_alloc    @ %p[%08x], sz=%d bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mem
comma
id|ioc-&gt;req_alloc_dma
comma
id|sz
)paren
)paren
suffix:semicolon
id|b
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
id|b
op_assign
(paren
id|b
op_plus
(paren
l_int|0x80UL
op_minus
l_int|1UL
)paren
)paren
op_amp
op_complement
(paren
l_int|0x80UL
op_minus
l_int|1UL
)paren
suffix:semicolon
multiline_comment|/* round up to 128-byte boundary */
id|aligned_mem
op_assign
(paren
id|u8
op_star
)paren
id|b
suffix:semicolon
id|ioc-&gt;req_frames
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|aligned_mem
suffix:semicolon
id|ioc-&gt;req_frames_dma
op_assign
(paren
id|ioc-&gt;req_alloc_dma
op_plus
(paren
id|aligned_mem
op_minus
id|mem
)paren
)paren
suffix:semicolon
id|aligned_mem_dma
op_assign
id|ioc-&gt;req_frames_dma
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.req_frames   @ %p[%08x]&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|aligned_mem
comma
id|aligned_mem_dma
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ioc-&gt;req_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mf
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|aligned_mem
suffix:semicolon
multiline_comment|/*  Queue REQUESTs *internally*!  */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|ioc-&gt;FreeQ.head
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|aligned_mem
op_add_assign
id|ioc-&gt;req_sz
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_MTRR) &amp;&amp; 0
multiline_comment|/*&n;&t;&t; *  Enable Write Combining MTRR for IOC&squot;s memory region.&n;&t;&t; *  (at least as much as we can; &quot;size and base must be&n;&t;&t; *  multiples of 4 kiB&quot;&n;&t;&t; */
id|ioc-&gt;mtrr_reg
op_assign
id|mtrr_add
c_func
(paren
id|ioc-&gt;req_alloc_dma
comma
id|sz
comma
id|MTRR_TYPE_WRCOMB
comma
l_int|1
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: MTRR region registered (base:size=%08x:%x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;req_alloc_dma
comma
id|sz
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|ioc-&gt;sense_buf_pool
op_eq
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|ioc-&gt;req_depth
op_star
l_int|256
)paren
suffix:semicolon
id|ioc-&gt;sense_buf_pool
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
op_amp
id|ioc-&gt;sense_buf_pool_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sense_buf_pool
op_eq
l_int|NULL
)paren
r_goto
id|out_fail
suffix:semicolon
id|ioc-&gt;alloc_total
op_add_assign
id|sz
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_fail
suffix:colon
r_if
c_cond
(paren
id|ioc-&gt;reply_alloc
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|ioc-&gt;reply_sz
op_star
id|ioc-&gt;reply_depth
)paren
op_plus
l_int|128
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;reply_alloc
comma
id|ioc-&gt;reply_alloc_dma
)paren
suffix:semicolon
id|ioc-&gt;reply_frames
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;reply_alloc
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;req_alloc
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|ioc-&gt;req_sz
op_star
id|ioc-&gt;req_depth
)paren
op_plus
l_int|128
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Rounding UP to nearest 4-kB boundary here...&n;&t;&t; */
id|sz
op_assign
(paren
(paren
id|sz
op_plus
l_int|0x1000UL
op_minus
l_int|1UL
)paren
op_div
l_int|0x1000
)paren
op_star
l_int|0x1000
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;req_alloc
comma
id|ioc-&gt;req_alloc_dma
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_MTRR) &amp;&amp; 0
r_if
c_cond
(paren
id|ioc-&gt;mtrr_reg
OG
l_int|0
)paren
(brace
id|mtrr_del
c_func
(paren
id|ioc-&gt;mtrr_reg
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: MTRR region de-registered&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ioc-&gt;req_frames
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;req_alloc
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;sense_buf_pool
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|ioc-&gt;req_depth
op_star
l_int|256
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;sense_buf_pool
comma
id|ioc-&gt;sense_buf_pool_dma
)paren
suffix:semicolon
id|ioc-&gt;sense_buf_pool
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;HandShakeReqAndReply - Send MPT request to and receive reply from&n; *&t;IOC via doorbell handshake method.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@reqBytes: Size of the request in bytes&n; *&t;@req: Pointer to MPT request frame&n; *&t;@replyBytes: Expected size of the reply in bytes&n; *&t;@u16reply: Pointer to area where reply should be written&n; *&t;@maxwait: Max wait time for a reply (in seconds)&n; *&n; *&t;NOTES: It is the callers responsibility to byte-swap fields in the&n; *&t;request which are greater than 1 byte in size.  It is also the&n; *&t;callers responsibility to byte-swap response fields which are&n; *&t;greater than 1 byte in size.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|HandShakeReqAndReply
id|HandShakeReqAndReply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reqBytes
comma
id|u32
op_star
id|req
comma
r_int
id|replyBytes
comma
id|u16
op_star
id|u16reply
comma
r_int
id|maxwait
)paren
(brace
id|MPIDefaultReply_t
op_star
id|mptReply
suffix:semicolon
r_int
id|failcnt
op_assign
l_int|0
suffix:semicolon
r_int
id|t
suffix:semicolon
multiline_comment|/*&n;&t; * Get ready to cache a handshake reply&n;&t; */
id|ioc-&gt;hs_reply_idx
op_assign
l_int|0
suffix:semicolon
id|mptReply
op_assign
(paren
id|MPIDefaultReply_t
op_star
)paren
id|ioc-&gt;hs_reply
suffix:semicolon
id|mptReply-&gt;MsgLength
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure there are no doorbells (WRITE 0 to IntStatus reg),&n;&t; * then tell IOC that we want to handshake a request of N words.&n;&t; * (WRITE u32val to Doorbell reg).&n;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
comma
(paren
(paren
id|MPI_FUNCTION_HANDSHAKE
op_lshift
id|MPI_DOORBELL_FUNCTION_SHIFT
)paren
op_or
(paren
(paren
id|reqBytes
op_div
l_int|4
)paren
op_lshift
id|MPI_DOORBELL_ADD_DWORDS_SHIFT
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for IOC&squot;s doorbell handshake int&n;&t; */
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: HandShake request start, WaitCnt=%d%s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|t
comma
id|failcnt
ques
c_cond
l_string|&quot; - MISSING DOORBELL HANDSHAKE!&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Clear doorbell int (WRITE 0 to IntStatus reg),&n;&t; * then wait for IOC to ACKnowledge that it&squot;s ready for&n;&t; * our handshake request.&n;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|failcnt
op_logical_and
(paren
id|t
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|ioc
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|failcnt
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
op_star
id|req_as_bytes
op_assign
(paren
id|u8
op_star
)paren
id|req
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Stuff request words via doorbell handshake,&n;&t;&t; * with ACK from IOC for each.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|failcnt
op_logical_and
id|i
OL
id|reqBytes
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|word
op_assign
(paren
(paren
id|req_as_bytes
(braket
(paren
id|i
op_star
l_int|4
)paren
op_plus
l_int|0
)braket
op_lshift
l_int|0
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|i
op_star
l_int|4
)paren
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|i
op_star
l_int|4
)paren
op_plus
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|i
op_star
l_int|4
)paren
op_plus
l_int|3
)braket
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
comma
id|word
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|ioc
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
)brace
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Handshake request frame (@%p) header&bslash;n&quot;
comma
id|req
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REQUEST_FRAME_HDR
c_func
(paren
id|req
)paren
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: HandShake request post done, WaitCnt=%d%s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|t
comma
id|failcnt
ques
c_cond
l_string|&quot; - MISSING DOORBELL ACK!&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Wait for completion of doorbell handshake reply from the IOC&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|failcnt
op_logical_and
(paren
id|t
op_assign
id|WaitForDoorbellReply
c_func
(paren
id|ioc
comma
id|maxwait
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Copy out the cached reply...&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIN
c_func
(paren
id|replyBytes
op_div
l_int|2
comma
id|mptReply-&gt;MsgLength
op_star
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u16reply
(braket
id|i
)braket
op_assign
id|ioc-&gt;hs_reply
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
r_else
(brace
r_return
op_minus
l_int|99
suffix:semicolon
)brace
r_return
op_minus
id|failcnt
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;WaitForDoorbellAck - Wait for IOC to clear the IOP_DOORBELL_STATUS bit&n; *&t;in it&squot;s IntStatus register.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@howlong: How long to wait (in seconds)&n; *&n; *&t;This routine waits (up to ~2 seconds max) for IOC doorbell&n; *&t;handshake ACKnowledge.&n; *&n; *&t;Returns a negative value on failure, else wait loop count.&n; */
r_static
r_int
DECL|function|WaitForDoorbellAck
id|WaitForDoorbellAck
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
)paren
(brace
r_int
id|cntdn
op_assign
id|HZ
op_star
id|howlong
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|u32
id|intstat
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|cntdn
)paren
(brace
id|intstat
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|intstat
op_amp
id|MPI_HIS_IOP_DOORBELL_STATUS
)paren
)paren
r_break
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cntdn
)paren
(brace
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: WaitForDoorbell ACK (cnt=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Doorbell ACK timeout(%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
id|count
op_plus
l_int|5
)paren
op_div
id|HZ
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;WaitForDoorbellInt - Wait for IOC to set the HIS_DOORBELL_INTERRUPT bit&n; *&t;in it&squot;s IntStatus register.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@howlong: How long to wait (in seconds)&n; *&n; *&t;This routine waits (up to ~2 seconds max) for IOC doorbell interrupt.&n; *&n; *&t;Returns a negative value on failure, else wait loop count.&n; */
r_static
r_int
DECL|function|WaitForDoorbellInt
id|WaitForDoorbellInt
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
)paren
(brace
r_int
id|cntdn
op_assign
id|HZ
op_star
id|howlong
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|u32
id|intstat
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|cntdn
)paren
(brace
id|intstat
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intstat
op_amp
id|MPI_HIS_DOORBELL_INTERRUPT
)paren
r_break
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cntdn
)paren
(brace
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: WaitForDoorbell INT (cnt=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Doorbell INT timeout(%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
id|count
op_plus
l_int|5
)paren
op_div
id|HZ
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;WaitForDoorbellReply - Wait for and capture a IOC handshake reply.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@howlong: How long to wait (in seconds)&n; *&n; *&t;This routine polls the IOC for a handshake reply, 16 bits at a time.&n; *&t;Reply is cached to IOC private area large enough to hold a maximum&n; *&t;of 128 bytes of reply data.&n; *&n; *&t;Returns a negative value on failure, else size of reply in WORDS.&n; */
r_static
r_int
DECL|function|WaitForDoorbellReply
id|WaitForDoorbellReply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
)paren
(brace
r_int
id|u16cnt
op_assign
l_int|0
suffix:semicolon
r_int
id|failcnt
op_assign
l_int|0
suffix:semicolon
r_int
id|t
suffix:semicolon
id|u16
op_star
id|hs_reply
op_assign
id|ioc-&gt;hs_reply
suffix:semicolon
r_volatile
id|MPIDefaultReply_t
op_star
id|mptReply
op_assign
(paren
id|MPIDefaultReply_t
op_star
)paren
id|ioc-&gt;hs_reply
suffix:semicolon
id|u16
id|hword
suffix:semicolon
id|hs_reply
(braket
l_int|0
)braket
op_assign
id|hs_reply
(braket
l_int|1
)braket
op_assign
id|hs_reply
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Get first two u16&squot;s so we can look at IOC&squot;s intended reply MsgLength&n;&t; */
id|u16cnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
id|howlong
)paren
)paren
OL
l_int|0
)paren
(brace
id|failcnt
op_increment
suffix:semicolon
)brace
r_else
(brace
id|hs_reply
(braket
id|u16cnt
op_increment
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
r_else
(brace
id|hs_reply
(braket
id|u16cnt
op_increment
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: First handshake reply word=%08x%s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
id|hs_reply
)paren
comma
id|failcnt
ques
c_cond
l_string|&quot; - MISSING DOORBELL HANDSHAKE!&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If no error (and IOC said MsgLength is &gt; 0), piece together&n;&t; * reply 16 bits at a time.&n;&t; */
r_for
c_loop
(paren
id|u16cnt
op_assign
l_int|2
suffix:semicolon
op_logical_neg
id|failcnt
op_logical_and
id|u16cnt
OL
(paren
l_int|2
op_star
id|mptReply-&gt;MsgLength
)paren
suffix:semicolon
id|u16cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
id|hword
op_assign
id|le16_to_cpu
c_func
(paren
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
multiline_comment|/* don&squot;t overflow our IOC hs_reply[] buffer! */
r_if
c_cond
(paren
id|u16cnt
OL
r_sizeof
(paren
id|ioc-&gt;hs_reply
)paren
op_div
r_sizeof
(paren
id|ioc-&gt;hs_reply
(braket
l_int|0
)braket
)paren
)paren
id|hs_reply
(braket
id|u16cnt
)braket
op_assign
id|hword
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|failcnt
op_logical_and
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|failcnt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Handshake reply failure!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|failcnt
suffix:semicolon
)brace
macro_line|#if 0
r_else
r_if
c_cond
(paren
id|u16cnt
op_ne
(paren
l_int|2
op_star
id|mptReply-&gt;MsgLength
)paren
)paren
(brace
r_return
op_minus
l_int|101
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|mptReply-&gt;IOCStatus
op_amp
id|MPI_IOCSTATUS_MASK
)paren
op_ne
id|MPI_IOCSTATUS_SUCCESS
)paren
(brace
r_return
op_minus
l_int|102
suffix:semicolon
)brace
macro_line|#endif
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Got Handshake reply:&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REPLY_FRAME
c_func
(paren
id|mptReply
)paren
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: WaitForDoorbell REPLY (sz=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|u16cnt
op_div
l_int|2
)paren
)paren
suffix:semicolon
r_return
id|u16cnt
op_div
l_int|2
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetLanConfigPages - Fetch LANConfig pages.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|GetLanConfigPages
id|GetLanConfigPages
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|Config_t
id|config_req
suffix:semicolon
id|ConfigReply_t
id|config_reply
suffix:semicolon
id|LANPage0_t
op_star
id|page0
suffix:semicolon
id|dma_addr_t
id|page0_dma
suffix:semicolon
id|LANPage1_t
op_star
id|page1
suffix:semicolon
id|dma_addr_t
id|page1_dma
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|req_sz
suffix:semicolon
r_int
id|reply_sz
suffix:semicolon
r_int
id|data_sz
suffix:semicolon
multiline_comment|/* LANPage0 */
multiline_comment|/*  Immediate destination (reply area)...  */
id|reply_sz
op_assign
r_sizeof
(paren
id|config_reply
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|config_reply
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
multiline_comment|/*  Ultimate destination...  */
id|page0
op_assign
op_amp
id|ioc-&gt;lan_cnfg_page0
suffix:semicolon
id|data_sz
op_assign
r_sizeof
(paren
op_star
id|page0
)paren
suffix:semicolon
id|memset
c_func
(paren
id|page0
comma
l_int|0
comma
id|data_sz
)paren
suffix:semicolon
multiline_comment|/*  Request area (config_req on the stack right now!)  */
id|req_sz
op_assign
r_sizeof
(paren
id|config_req
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|config_req
comma
l_int|0
comma
id|req_sz
)paren
suffix:semicolon
id|config_req.Function
op_assign
id|MPI_FUNCTION_CONFIG
suffix:semicolon
id|config_req.Action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
multiline_comment|/*&t;config_req.Header.PageVersion = 0;&t;*/
multiline_comment|/*&t;config_req.Header.PageLength = 0;&t;*/
id|config_req.Header.PageNumber
op_assign
l_int|0
suffix:semicolon
id|config_req.Header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_LAN
suffix:semicolon
multiline_comment|/*&t;config_req.PageAddress = 0;&t;&t;*/
id|config_req.PageBufferSGE.u.Simple.FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
id|MPI_SGE_FLAGS_LAST_ELEMENT
op_or
id|MPI_SGE_FLAGS_END_OF_BUFFER
op_or
id|MPI_SGE_FLAGS_END_OF_LIST
op_or
id|MPI_SGE_FLAGS_SIMPLE_ELEMENT
op_or
id|MPI_SGE_FLAGS_SYSTEM_ADDRESS
op_or
id|MPI_SGE_FLAGS_32_BIT_ADDRESSING
op_or
id|MPI_SGE_FLAGS_32_BIT_CONTEXT
)paren
op_lshift
id|MPI_SGE_FLAGS_SHIFT
)paren
op_or
(paren
id|u32
)paren
id|data_sz
)paren
suffix:semicolon
id|page0_dma
op_assign
id|pci_map_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|page0
comma
id|data_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|config_req.PageBufferSGE.u.Simple.u.Address32
op_assign
id|cpu_to_le32
c_func
(paren
id|page0_dma
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Sending Config request LAN_PAGE_0&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|i
op_assign
id|HandShakeReqAndReply
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|config_req
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
op_amp
id|config_reply
comma
l_int|3
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|page0_dma
comma
id|data_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
r_return
id|i
suffix:semicolon
multiline_comment|/*  Now byte swap the necessary LANPage0 fields  */
multiline_comment|/* LANPage1 */
multiline_comment|/*  Immediate destination (reply area)...  */
id|reply_sz
op_assign
r_sizeof
(paren
id|config_reply
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|config_reply
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
multiline_comment|/*  Ultimate destination...  */
id|page1
op_assign
op_amp
id|ioc-&gt;lan_cnfg_page1
suffix:semicolon
id|data_sz
op_assign
r_sizeof
(paren
op_star
id|page1
)paren
suffix:semicolon
id|memset
c_func
(paren
id|page1
comma
l_int|0
comma
id|data_sz
)paren
suffix:semicolon
multiline_comment|/*  Request area (config_req on the stack right now!)  */
id|req_sz
op_assign
r_sizeof
(paren
id|config_req
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|config_req
comma
l_int|0
comma
id|req_sz
)paren
suffix:semicolon
id|config_req.Function
op_assign
id|MPI_FUNCTION_CONFIG
suffix:semicolon
id|config_req.Action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
multiline_comment|/*&t;config_req.Header.PageVersion = 0;&t;*/
multiline_comment|/*&t;config_req.Header.PageLength = 0;&t;*/
id|config_req.Header.PageNumber
op_assign
l_int|1
suffix:semicolon
id|config_req.Header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_LAN
suffix:semicolon
multiline_comment|/*&t;config_req.PageAddress = 0;&t;&t;*/
id|config_req.PageBufferSGE.u.Simple.FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
id|MPI_SGE_FLAGS_LAST_ELEMENT
op_or
id|MPI_SGE_FLAGS_END_OF_BUFFER
op_or
id|MPI_SGE_FLAGS_END_OF_LIST
op_or
id|MPI_SGE_FLAGS_SIMPLE_ELEMENT
op_or
id|MPI_SGE_FLAGS_SYSTEM_ADDRESS
op_or
id|MPI_SGE_FLAGS_32_BIT_ADDRESSING
op_or
id|MPI_SGE_FLAGS_32_BIT_CONTEXT
)paren
op_lshift
id|MPI_SGE_FLAGS_SHIFT
)paren
op_or
(paren
id|u32
)paren
id|data_sz
)paren
suffix:semicolon
id|page1_dma
op_assign
id|pci_map_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|page1
comma
id|data_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|config_req.PageBufferSGE.u.Simple.u.Address32
op_assign
id|cpu_to_le32
c_func
(paren
id|page1_dma
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Sending Config request LAN_PAGE_1&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|i
op_assign
id|HandShakeReqAndReply
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|config_req
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
op_amp
id|config_reply
comma
l_int|3
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|page1_dma
comma
id|data_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
r_return
id|i
suffix:semicolon
multiline_comment|/*  Now byte swap the necessary LANPage1 fields  */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;SendEventNotification - Send EventNotification (on or off) request&n; *&t;to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@EvSwitch: Event switch flags&n; */
r_static
r_int
DECL|function|SendEventNotification
id|SendEventNotification
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u8
id|EvSwitch
)paren
(brace
id|EventNotification_t
op_star
id|evnp
suffix:semicolon
id|evnp
op_assign
(paren
id|EventNotification_t
op_star
)paren
id|mpt_get_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evnp
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: WARNING - Unable to allocate a event request frame!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|evnp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|evnp
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Sending EventNotification(%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|EvSwitch
)paren
)paren
suffix:semicolon
id|evnp-&gt;Function
op_assign
id|MPI_FUNCTION_EVENT_NOTIFICATION
suffix:semicolon
id|evnp-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|evnp-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|evnp-&gt;Switch
op_assign
id|EvSwitch
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc-&gt;id
comma
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|evnp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;SendEventAck - Send EventAck request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@evnp: Pointer to original EventNotification request&n; */
r_static
r_int
DECL|function|SendEventAck
id|SendEventAck
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|evnp
)paren
(brace
id|EventAck_t
op_star
id|pAck
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pAck
op_assign
(paren
id|EventAck_t
op_star
)paren
id|mpt_get_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: WARNING - Unable to allocate event ACK request frame!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pAck
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pAck
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Sending EventAck&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|pAck-&gt;Function
op_assign
id|MPI_FUNCTION_EVENT_ACK
suffix:semicolon
id|pAck-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pAck-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pAck-&gt;Event
op_assign
id|evnp-&gt;Event
suffix:semicolon
id|pAck-&gt;EventContext
op_assign
id|evnp-&gt;EventContext
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc-&gt;id
comma
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|pAck
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS&t;&t;/* { */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procfs (%MPT_PROCFS_MPTBASEDIR/...) support stuff...&n; */
DECL|macro|PROC_MPT_READ_RETURN
mdefine_line|#define PROC_MPT_READ_RETURN(page,start,off,count,eof,len) &bslash;&n;{ &bslash;&n;&t;len -= off;&t;&t;&t;&bslash;&n;&t;if (len &lt; count) {&t;&t;&bslash;&n;&t;&t;*eof = 1;&t;&t;&bslash;&n;&t;&t;if (len &lt;= 0)&t;&t;&bslash;&n;&t;&t;&t;return 0;&t;&bslash;&n;&t;} else&t;&t;&t;&t;&bslash;&n;&t;&t;len = count;&t;&t;&bslash;&n;&t;*start = page + off;&t;&t;&bslash;&n;&t;return len;&t;&t;&t;&bslash;&n;}
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procmpt_create - Create %MPT_PROCFS_MPTBASEDIR entries.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|procmpt_create
id|procmpt_create
c_func
(paren
r_void
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
r_int
id|errcnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * &t;BEWARE: If/when MPT_PROCFS_MPTBASEDIR changes from &quot;mpt&quot;&n;&t; * &t;(single level) to multi level (e.g. &quot;driver/message/fusion&quot;)&n;&t; * &t;something here needs to change.  -sralston&n;&t; */
id|procmpt_root_dir
op_assign
id|CREATE_PROCDIR_ENTRY
c_func
(paren
id|MPT_PROCFS_MPTBASEDIR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|procmpt_root_dir
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOTDIR
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|ent
op_assign
id|create_proc_read_entry
c_func
(paren
id|MPT_PROCFS_SUMMARY_NODE
comma
l_int|0
comma
l_int|NULL
comma
id|procmpt_read_summary
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: WARNING - Could not create %s entry!&bslash;n&quot;
comma
id|MPT_PROCFS_SUMMARY_PATHNAME
)paren
suffix:semicolon
id|errcnt
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ioc
op_ne
l_int|NULL
)paren
(brace
r_char
id|pname
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|namelen
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Create &quot;/proc/mpt/iocN&quot; subdirectory entry for each MPT adapter.&n;&t;&t; */
id|namelen
op_assign
id|sprintf
c_func
(paren
id|pname
comma
id|MPT_PROCFS_MPTBASEDIR
l_string|&quot;/%s&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ent
op_assign
id|CREATE_PROCDIR_ENTRY
c_func
(paren
id|pname
comma
l_int|NULL
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *  And populate it with: &quot;summary&quot; and &quot;dbg&quot; file entries.&n;&t;&t;&t; */
(paren
r_void
)paren
id|sprintf
c_func
(paren
id|pname
op_plus
id|namelen
comma
l_string|&quot;/summary&quot;
)paren
suffix:semicolon
id|ent
op_assign
id|create_proc_read_entry
c_func
(paren
id|pname
comma
l_int|0
comma
l_int|NULL
comma
id|procmpt_read_summary
comma
id|ioc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
op_eq
l_int|NULL
)paren
(brace
id|errcnt
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: WARNING - Could not create /proc/%s entry!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pname
)paren
suffix:semicolon
)brace
singleline_comment|//#ifdef MPT_DEBUG
multiline_comment|/* DEBUG aid! */
(paren
r_void
)paren
id|sprintf
c_func
(paren
id|pname
op_plus
id|namelen
comma
l_string|&quot;/dbg&quot;
)paren
suffix:semicolon
id|ent
op_assign
id|create_proc_read_entry
c_func
(paren
id|pname
comma
l_int|0
comma
l_int|NULL
comma
id|procmpt_read_dbg
comma
id|ioc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
op_eq
l_int|NULL
)paren
(brace
id|errcnt
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: WARNING - Could not create /proc/%s entry!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pname
)paren
suffix:semicolon
)brace
singleline_comment|//#endif
)brace
r_else
(brace
id|errcnt
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: WARNING - Could not create /proc/%s entry!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pname
)paren
suffix:semicolon
)brace
id|ioc
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|errcnt
)paren
(brace
singleline_comment|//&t;&t;remove_proc_entry(&quot;mpt&quot;, 0);
r_return
op_minus
id|ENOTDIR
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procmpt_destroy - Tear down %MPT_PROCFS_MPTBASEDIR entries.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|procmpt_destroy
id|procmpt_destroy
c_func
(paren
r_void
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|procmpt_root_dir
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * &t;BEWARE: If/when MPT_PROCFS_MPTBASEDIR changes from &quot;mpt&quot;&n;&t; * &t;(single level) to multi level (e.g. &quot;driver/message/fusion&quot;)&n;&t; * &t;something here needs to change.  -sralston&n;&t; */
id|ioc
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc
op_ne
l_int|NULL
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|MPT_PROCFS_SUMMARY_NODE
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ioc
op_ne
l_int|NULL
)paren
(brace
r_char
id|pname
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|namelen
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Tear down each &quot;/proc/mpt/iocN&quot; subdirectory.&n;&t;&t; */
id|namelen
op_assign
id|sprintf
c_func
(paren
id|pname
comma
id|MPT_PROCFS_MPTBASEDIR
l_string|&quot;/%s&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
(paren
r_void
)paren
id|sprintf
c_func
(paren
id|pname
op_plus
id|namelen
comma
l_string|&quot;/summary&quot;
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|pname
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|//#ifdef MPT_DEBUG
(paren
r_void
)paren
id|sprintf
c_func
(paren
id|pname
op_plus
id|namelen
comma
l_string|&quot;/dbg&quot;
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|pname
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|//#endif
(paren
r_void
)paren
id|sprintf
c_func
(paren
id|pname
comma
id|MPT_PROCFS_MPTBASEDIR
l_string|&quot;/%s&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|pname
comma
l_int|0
)paren
suffix:semicolon
id|ioc
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
(paren
id|atomic_t
op_star
)paren
op_amp
id|procmpt_root_dir-&gt;count
)paren
op_eq
l_int|0
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|MPT_PROCFS_MPTBASEDIR
comma
l_int|0
)paren
suffix:semicolon
id|procmpt_root_dir
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;procmpt_read_summary - Handle read request from /proc/mpt/summary&n; *&t;or from /proc/mpt/iocN/summary.&n; *&t;@page: Pointer to area to write information&n; *&t;@start: Pointer to start pointer&n; *&t;@off: Offset to start writing&n; *&t;@count: &n; *&t;@eof: Pointer to EOF integer&n; *&t;@data: Pointer &n; *&n; *&t;Returns numbers of characters written to process performing the read.&n; */
r_static
r_int
DECL|function|procmpt_read_summary
id|procmpt_read_summary
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_char
op_star
id|out
op_assign
id|page
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
id|ioc
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
r_else
id|ioc
op_assign
id|data
suffix:semicolon
singleline_comment|// Too verbose!
singleline_comment|//&t;out += sprintf(out, &quot;Attached Fusion MPT I/O Controllers:%s&bslash;n&quot;, ioc ? &quot;&quot; : &quot; none&quot;);
r_while
c_loop
(paren
id|ioc
)paren
(brace
r_int
id|more
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Too verbose!
singleline_comment|//&t;&t;mpt_print_ioc_facts(ioc, out, &amp;more, 0);
id|mpt_print_ioc_summary
c_func
(paren
id|ioc
comma
id|out
comma
op_amp
id|more
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|out
op_add_assign
id|more
suffix:semicolon
r_if
c_cond
(paren
(paren
id|out
op_minus
id|page
)paren
op_ge
id|count
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
id|ioc
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_else
id|ioc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* force exit for iocN */
)brace
id|len
op_assign
id|out
op_minus
id|page
suffix:semicolon
id|PROC_MPT_READ_RETURN
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
singleline_comment|// debug aid!
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;procmpt_read_dbg - Handle read request from /proc/mpt/iocN/dbg.&n; *&t;@page: Pointer to area to write information&n; *&t;@start: Pointer to start pointer&n; *&t;@off: Offset to start writing&n; *&t;@count: &n; *&t;@eof: Pointer to EOF integer&n; *&t;@data: Pointer &n; *&n; *&t;Returns numbers of characters written to process performing the read.&n; */
r_static
r_int
DECL|function|procmpt_read_dbg
id|procmpt_read_dbg
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_char
op_star
id|out
op_assign
id|page
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ioc
op_assign
id|data
suffix:semicolon
r_while
c_loop
(paren
id|ioc
)paren
(brace
r_int
id|more
op_assign
l_int|0
suffix:semicolon
id|mpt_print_ioc_facts
c_func
(paren
id|ioc
comma
id|out
comma
op_amp
id|more
comma
l_int|0
)paren
suffix:semicolon
id|out
op_add_assign
id|more
suffix:semicolon
r_if
c_cond
(paren
(paren
id|out
op_minus
id|page
)paren
op_ge
id|count
)paren
(brace
r_break
suffix:semicolon
)brace
id|ioc
op_assign
l_int|NULL
suffix:semicolon
)brace
id|len
op_assign
id|out
op_minus
id|page
suffix:semicolon
id|PROC_MPT_READ_RETURN
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;/* CONFIG_PROC_FS } */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_void
DECL|function|mpt_get_fw_exp_ver
id|mpt_get_fw_exp_ver
c_func
(paren
r_char
op_star
id|buf
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioc-&gt;facts.FWVersion
op_amp
l_int|0xF000
)paren
op_eq
l_int|0xE000
)paren
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot; (Exp %02d%02d)&quot;
comma
(paren
id|ioc-&gt;facts.FWVersion
op_amp
l_int|0x0F00
)paren
op_rshift
l_int|8
comma
multiline_comment|/* Month */
id|ioc-&gt;facts.FWVersion
op_amp
l_int|0x001F
)paren
suffix:semicolon
multiline_comment|/* Day */
r_else
id|buf
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* insider hack! */
r_if
c_cond
(paren
id|ioc-&gt;facts.FWVersion
op_amp
l_int|0x0080
)paren
(brace
id|strcat
c_func
(paren
id|buf
comma
l_string|&quot; [MDBG]&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_print_ioc_summary - Write ASCII summary of IOC to a buffer.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@buffer: Pointer to buffer where IOC summary info should be written&n; *&t;@size: Pointer to number of bytes we wrote (set by this routine)&n; *&t;@len: Offset at which to start writing in buffer&n; *&t;@showlan: Display LAN stuff?&n; *&n; * &t;This routine writes (english readable) ASCII text, which represents&n; * &t;a summary of IOC information, to a buffer.&n; */
r_void
DECL|function|mpt_print_ioc_summary
id|mpt_print_ioc_summary
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_char
op_star
id|buffer
comma
r_int
op_star
id|size
comma
r_int
id|len
comma
r_int
id|showlan
)paren
(brace
r_char
id|expVer
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|y
suffix:semicolon
id|mpt_get_fw_exp_ver
c_func
(paren
id|expVer
comma
id|ioc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Shorter summary of attached ioc&squot;s...&n;&t; */
id|y
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%s: %s, %s%04xh%s, Ports=%d, MaxQ=%d&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;prod_name
comma
id|MPT_FW_REV_MAGIC_ID_STRING
comma
multiline_comment|/* &quot;FwRev=&quot; or somesuch */
id|ioc-&gt;facts.FWVersion
comma
id|expVer
comma
id|ioc-&gt;facts.NumberOfPorts
comma
id|ioc-&gt;req_depth
)paren
suffix:semicolon
r_if
c_cond
(paren
id|showlan
op_logical_and
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
)paren
(brace
id|u8
op_star
id|a
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|ioc-&gt;lan_cnfg_page1.HardwareAddressLow
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;, LanAddr=%02X:%02X:%02X:%02X:%02X:%02X&quot;
comma
id|a
(braket
l_int|5
)braket
comma
id|a
(braket
l_int|4
)braket
comma
id|a
(braket
l_int|3
)braket
comma
id|a
(braket
l_int|2
)braket
comma
id|a
(braket
l_int|1
)braket
comma
id|a
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;pci_irq
OL
l_int|100
)paren
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;, IRQ=%d&quot;
comma
id|ioc-&gt;pci_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;active
)paren
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot; (disabled)&quot;
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|size
op_assign
id|y
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_print_ioc_facts - Write ASCII summary of IOC facts to a buffer.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@buffer: Pointer to buffer where IOC facts should be written&n; *&t;@size: Pointer to number of bytes we wrote (set by this routine)&n; *&t;@len: Offset at which to start writing in buffer&n; *&n; * &t;This routine writes (english readable) ASCII text, which represents&n; * &t;a summary of the IOC facts, to a buffer.&n; */
r_void
DECL|function|mpt_print_ioc_facts
id|mpt_print_ioc_facts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_char
op_star
id|buffer
comma
r_int
op_star
id|size
comma
r_int
id|len
)paren
(brace
r_char
id|expVer
(braket
l_int|32
)braket
suffix:semicolon
r_char
id|iocName
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|sz
suffix:semicolon
r_int
id|y
suffix:semicolon
r_int
id|p
suffix:semicolon
id|mpt_get_fw_exp_ver
c_func
(paren
id|expVer
comma
id|ioc
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|iocName
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|y
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%s:&bslash;n&quot;
comma
id|iocName
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  ProductID = 0x%04x&bslash;n&quot;
comma
id|ioc-&gt;facts.ProductID
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|ioc-&gt;facts.NumberOfPorts
suffix:semicolon
id|p
op_increment
)paren
(brace
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  PortNumber = %d (of %d)&bslash;n&quot;
comma
id|p
op_plus
l_int|1
comma
id|ioc-&gt;facts.NumberOfPorts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
id|p
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
(brace
id|u8
op_star
id|a
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|ioc-&gt;lan_cnfg_page1.HardwareAddressLow
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  LanAddr = 0x%02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|a
(braket
l_int|5
)braket
comma
id|a
(braket
l_int|4
)braket
comma
id|a
(braket
l_int|3
)braket
comma
id|a
(braket
l_int|2
)braket
comma
id|a
(braket
l_int|1
)braket
comma
id|a
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  FWVersion = 0x%04x%s&bslash;n&quot;
comma
id|ioc-&gt;facts.FWVersion
comma
id|expVer
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  MsgVersion = 0x%04x&bslash;n&quot;
comma
id|ioc-&gt;facts.MsgVersion
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  FirstWhoInit = 0x%02x&bslash;n&quot;
comma
id|ioc-&gt;FirstWhoInit
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  EventState = 0x%02x&bslash;n&quot;
comma
id|ioc-&gt;facts.EventState
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  CurrentHostMfaHighAddr = 0x%08x&bslash;n&quot;
comma
id|ioc-&gt;facts.CurrentHostMfaHighAddr
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  CurrentSenseBufferHighAddr = 0x%08x&bslash;n&quot;
comma
id|ioc-&gt;facts.CurrentSenseBufferHighAddr
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  MaxChainDepth = 0x%02x frames&bslash;n&quot;
comma
id|ioc-&gt;facts.MaxChainDepth
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  MinBlockSize = 0x%02x bytes&bslash;n&quot;
comma
l_int|4
op_star
id|ioc-&gt;facts.BlockSize
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  RequestFrames @ 0x%p (Dma @ 0x%08x)&bslash;n&quot;
comma
id|ioc-&gt;req_alloc
comma
id|ioc-&gt;req_alloc_dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Rounding UP to nearest 4-kB boundary here...&n;&t; */
id|sz
op_assign
(paren
id|ioc-&gt;req_sz
op_star
id|ioc-&gt;req_depth
)paren
op_plus
l_int|128
suffix:semicolon
id|sz
op_assign
(paren
(paren
id|sz
op_plus
l_int|0x1000UL
op_minus
l_int|1UL
)paren
op_div
l_int|0x1000
)paren
op_star
l_int|0x1000
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;    {CurReqSz=%d} x {CurReqDepth=%d} = %d bytes ^= 0x%x&bslash;n&quot;
comma
id|ioc-&gt;req_sz
comma
id|ioc-&gt;req_depth
comma
id|ioc-&gt;req_sz
op_star
id|ioc-&gt;req_depth
comma
id|sz
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;    {MaxReqSz=%d}   {MaxReqDepth=%d}&bslash;n&quot;
comma
l_int|4
op_star
id|ioc-&gt;facts.RequestFrameSize
comma
id|ioc-&gt;facts.GlobalCredits
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;  ReplyFrames   @ 0x%p (Dma @ 0x%08x)&bslash;n&quot;
comma
id|ioc-&gt;reply_alloc
comma
id|ioc-&gt;reply_alloc_dma
)paren
suffix:semicolon
id|sz
op_assign
(paren
id|ioc-&gt;reply_sz
op_star
id|ioc-&gt;reply_depth
)paren
op_plus
l_int|128
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;    {CurRepSz=%d} x {CurRepDepth=%d} = %d bytes ^= 0x%x&bslash;n&quot;
comma
id|ioc-&gt;reply_sz
comma
id|ioc-&gt;reply_depth
comma
id|ioc-&gt;reply_sz
op_star
id|ioc-&gt;reply_depth
comma
id|sz
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;    {MaxRepSz=%d}   {MaxRepDepth=%d}&bslash;n&quot;
comma
id|ioc-&gt;facts.CurReplyFrameSize
comma
id|ioc-&gt;facts.ReplyQueueDepth
)paren
suffix:semicolon
op_star
id|size
op_assign
id|y
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_char
op_star
DECL|function|EventDescriptionStr
id|EventDescriptionStr
c_func
(paren
id|u8
id|event
comma
id|u32
id|evData0
)paren
(brace
r_char
op_star
id|ds
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|MPI_EVENT_NONE
suffix:colon
id|ds
op_assign
l_string|&quot;None&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOG_DATA
suffix:colon
id|ds
op_assign
l_string|&quot;Log Data&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_STATE_CHANGE
suffix:colon
id|ds
op_assign
l_string|&quot;State Change&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_UNIT_ATTENTION
suffix:colon
id|ds
op_assign
l_string|&quot;Unit Attention&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_IOC_BUS_RESET
suffix:colon
id|ds
op_assign
l_string|&quot;IOC Bus Reset&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_EXT_BUS_RESET
suffix:colon
id|ds
op_assign
l_string|&quot;External Bus Reset&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_RESCAN
suffix:colon
id|ds
op_assign
l_string|&quot;Bus Rescan Event&quot;
suffix:semicolon
multiline_comment|/* Ok, do we need to do anything here? As far as&n;&t;&t;   I can tell, this is when a new device gets added&n;&t;&t;   to the loop. */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LINK_STATUS_CHANGE
suffix:colon
r_if
c_cond
(paren
id|evData0
op_eq
id|MPI_EVENT_LINK_STATUS_FAILURE
)paren
id|ds
op_assign
l_string|&quot;Link Status(FAILURE) Change&quot;
suffix:semicolon
r_else
id|ds
op_assign
l_string|&quot;Link Status(ACTIVE) Change&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOOP_STATE_CHANGE
suffix:colon
r_if
c_cond
(paren
id|evData0
op_eq
id|MPI_EVENT_LOOP_STATE_CHANGE_LIP
)paren
id|ds
op_assign
l_string|&quot;Loop State(LIP) Change&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|evData0
op_eq
id|MPI_EVENT_LOOP_STATE_CHANGE_LPE
)paren
id|ds
op_assign
l_string|&quot;Loop State(LPE) Change&quot;
suffix:semicolon
multiline_comment|/* ??? */
r_else
id|ds
op_assign
l_string|&quot;Loop State(LPB) Change&quot;
suffix:semicolon
multiline_comment|/* ??? */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOGOUT
suffix:colon
id|ds
op_assign
l_string|&quot;Logout&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_EVENT_CHANGE
suffix:colon
r_if
c_cond
(paren
id|evData0
)paren
id|ds
op_assign
l_string|&quot;Events(ON) Change&quot;
suffix:semicolon
r_else
id|ds
op_assign
l_string|&quot;Events(OFF) Change&quot;
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; *  MPT base &quot;custom&quot; events may be added here...&n;&t; */
r_default
suffix:colon
id|ds
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ds
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;ProcessEventNotification - Route a received EventNotificationReply to&n; *&t;all currently regeistered event handlers.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@pEventReply: Pointer to EventNotification reply frame&n; *&t;@evHandlers: Pointer to integer, number of event handlers&n; *&n; *&t;Returns sum of event handlers return values.&n; */
r_static
r_int
DECL|function|ProcessEventNotification
id|ProcessEventNotification
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEventReply
comma
r_int
op_star
id|evHandlers
)paren
(brace
id|u16
id|evDataLen
suffix:semicolon
id|u32
id|evData0
op_assign
l_int|0
suffix:semicolon
singleline_comment|//&t;u32 evCtx;
r_int
id|i
suffix:semicolon
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_int
id|handlers
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|evStr
suffix:semicolon
id|u8
id|event
suffix:semicolon
multiline_comment|/*&n;&t; *  Do platform normalization of values&n;&t; */
id|event
op_assign
id|le32_to_cpu
c_func
(paren
id|pEventReply-&gt;Event
)paren
op_amp
l_int|0xFF
suffix:semicolon
singleline_comment|//&t;evCtx = le32_to_cpu(pEventReply-&gt;EventContext);
id|evDataLen
op_assign
id|le16_to_cpu
c_func
(paren
id|pEventReply-&gt;EventDataLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evDataLen
)paren
(brace
id|evData0
op_assign
id|le32_to_cpu
c_func
(paren
id|pEventReply-&gt;Data
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|evStr
op_assign
id|EventDescriptionStr
c_func
(paren
id|event
comma
id|evData0
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: MPT event (%s=%02Xh) detected!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|evStr
comma
id|event
)paren
)paren
suffix:semicolon
macro_line|#if defined(MPT_DEBUG) || defined(MPT_DEBUG_EVENTS)
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Event data:&bslash;n&quot;
id|KERN_INFO
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|evDataLen
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pEventReply-&gt;Data
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; *  Do general / base driver event processing&n;&t; */
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|MPI_EVENT_NONE
suffix:colon
multiline_comment|/* 00 */
r_case
id|MPI_EVENT_LOG_DATA
suffix:colon
multiline_comment|/* 01 */
r_case
id|MPI_EVENT_STATE_CHANGE
suffix:colon
multiline_comment|/* 02 */
r_case
id|MPI_EVENT_UNIT_ATTENTION
suffix:colon
multiline_comment|/* 03 */
r_case
id|MPI_EVENT_IOC_BUS_RESET
suffix:colon
multiline_comment|/* 04 */
r_case
id|MPI_EVENT_EXT_BUS_RESET
suffix:colon
multiline_comment|/* 05 */
r_case
id|MPI_EVENT_RESCAN
suffix:colon
multiline_comment|/* 06 */
r_case
id|MPI_EVENT_LINK_STATUS_CHANGE
suffix:colon
multiline_comment|/* 07 */
r_case
id|MPI_EVENT_LOOP_STATE_CHANGE
suffix:colon
multiline_comment|/* 08 */
r_case
id|MPI_EVENT_LOGOUT
suffix:colon
multiline_comment|/* 09 */
r_default
suffix:colon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_EVENT_CHANGE
suffix:colon
multiline_comment|/* 0A */
r_if
c_cond
(paren
id|evDataLen
)paren
(brace
id|u8
id|evState
op_assign
id|evData0
op_amp
l_int|0xFF
suffix:semicolon
multiline_comment|/* CHECKME! What if evState unexpectedly says OFF (0)? */
multiline_comment|/* Update EventState field in cached IocFacts */
r_if
c_cond
(paren
id|ioc-&gt;facts.Function
)paren
(brace
id|ioc-&gt;facts.EventState
op_assign
id|evState
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Call each currently registered protocol event handler.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|MptEvHandlers
(braket
id|i
)braket
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Routing Event to event handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|i
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptEvHandlers
(braket
id|i
)braket
)paren
)paren
(paren
id|ioc
comma
id|pEventReply
)paren
suffix:semicolon
id|handlers
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* FIXME?  Examine results here? */
multiline_comment|/*&n;&t; *  If needed, send (a single) EventAck.&n;&t; */
r_if
c_cond
(paren
id|pEventReply-&gt;AckRequired
op_eq
id|MPI_EVENT_NOTIFICATION_ACK_REQUIRED
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|SendEventAck
c_func
(paren
id|ioc
comma
id|pEventReply
)paren
)paren
op_ne
l_int|0
)paren
(brace
)brace
)brace
op_star
id|evHandlers
op_assign
id|handlers
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_fc_log_info - Log information returned from Fibre Channel IOC.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@log_info: U32 LogInfo reply word from the IOC&n; *&n; *&t;Refer to lsi/fc_log.h.&n; */
r_static
r_void
DECL|function|mpt_fc_log_info
id|mpt_fc_log_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|log_info
)paren
(brace
r_static
r_char
op_star
id|subcl_str
(braket
l_int|8
)braket
op_assign
(brace
l_string|&quot;FCP Initiator&quot;
comma
l_string|&quot;FCP Target&quot;
comma
l_string|&quot;LAN&quot;
comma
l_string|&quot;MPI Message Layer&quot;
comma
l_string|&quot;FC Link&quot;
comma
l_string|&quot;Context Manager&quot;
comma
l_string|&quot;Invalid Field Offset&quot;
comma
l_string|&quot;State Change Info&quot;
)brace
suffix:semicolon
r_char
op_star
id|desc
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
id|u8
id|subcl
op_assign
(paren
id|log_info
op_rshift
l_int|24
)paren
op_amp
l_int|0x7
suffix:semicolon
id|u32
id|SubCl
op_assign
id|log_info
op_amp
l_int|0x27000000
suffix:semicolon
r_switch
c_cond
(paren
id|log_info
)paren
(brace
multiline_comment|/* FCP Initiator */
r_case
id|MPI_IOCLOGINFO_FC_INIT_ERROR_OUT_OF_ORDER_FRAME
suffix:colon
id|desc
op_assign
l_string|&quot;Received an out of order frame - unsupported&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_INIT_ERROR_BAD_START_OF_FRAME
suffix:colon
id|desc
op_assign
l_string|&quot;Bad start of frame primative&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_INIT_ERROR_BAD_END_OF_FRAME
suffix:colon
id|desc
op_assign
l_string|&quot;Bad end of frame primative&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_INIT_ERROR_OVER_RUN
suffix:colon
id|desc
op_assign
l_string|&quot;Receiver hardware detected overrun&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_INIT_ERROR_RX_OTHER
suffix:colon
id|desc
op_assign
l_string|&quot;Other errors caught by IOC which require retries&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_INIT_ERROR_SUBPROC_DEAD
suffix:colon
id|desc
op_assign
l_string|&quot;Main processor could not initialize sub-processor&quot;
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* FC Target */
r_case
id|MPI_IOCLOGINFO_FC_TARGET_NO_PDISC
suffix:colon
id|desc
op_assign
l_string|&quot;Not sent because we are waiting for a PDISC from the initiator&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_NO_LOGIN
suffix:colon
id|desc
op_assign
l_string|&quot;Not sent because we are not logged in to the remote node&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_DOAR_KILLED_BY_LIP
suffix:colon
id|desc
op_assign
l_string|&quot;Data Out, Auto Response, not sent due to a LIP&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_DIAR_KILLED_BY_LIP
suffix:colon
id|desc
op_assign
l_string|&quot;Data In, Auto Response, not sent due to a LIP&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_DIAR_MISSING_DATA
suffix:colon
id|desc
op_assign
l_string|&quot;Data In, Auto Response, missing data frames&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_DONR_KILLED_BY_LIP
suffix:colon
id|desc
op_assign
l_string|&quot;Data Out, No Response, not sent due to a LIP&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_WRSP_KILLED_BY_LIP
suffix:colon
id|desc
op_assign
l_string|&quot;Auto-response after a write not sent due to a LIP&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_DINR_KILLED_BY_LIP
suffix:colon
id|desc
op_assign
l_string|&quot;Data In, No Response, not completed due to a LIP&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_DINR_MISSING_DATA
suffix:colon
id|desc
op_assign
l_string|&quot;Data In, No Response, missing data frames&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_MRSP_KILLED_BY_LIP
suffix:colon
id|desc
op_assign
l_string|&quot;Manual Response not sent due to a LIP&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_NO_CLASS_3
suffix:colon
id|desc
op_assign
l_string|&quot;Not sent because remote node does not support Class 3&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_LOGIN_NOT_VALID
suffix:colon
id|desc
op_assign
l_string|&quot;Not sent because login to remote node not validated&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_FROM_OUTBOUND
suffix:colon
id|desc
op_assign
l_string|&quot;Cleared from the outbound after a logout&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_TARGET_WAITING_FOR_DATA_IN
suffix:colon
id|desc
op_assign
l_string|&quot;Cleared waiting for data after a logout&quot;
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* LAN */
r_case
id|MPI_IOCLOGINFO_FC_LAN_TRANS_SGL_MISSING
suffix:colon
id|desc
op_assign
l_string|&quot;Transaction Context Sgl Missing&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_LAN_TRANS_WRONG_PLACE
suffix:colon
id|desc
op_assign
l_string|&quot;Transaction Context found before an EOB&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_LAN_TRANS_RES_BITS_SET
suffix:colon
id|desc
op_assign
l_string|&quot;Transaction Context value has reserved bits set&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_LAN_WRONG_SGL_FLAG
suffix:colon
id|desc
op_assign
l_string|&quot;Invalid SGL Flags&quot;
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* FC Link */
r_case
id|MPI_IOCLOGINFO_FC_LINK_LOOP_INIT_TIMEOUT
suffix:colon
id|desc
op_assign
l_string|&quot;Loop initialization timed out&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_LINK_ALREADY_INITIALIZED
suffix:colon
id|desc
op_assign
l_string|&quot;Another system controller already initialized the loop&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_LINK_LINK_NOT_ESTABLISHED
suffix:colon
id|desc
op_assign
l_string|&quot;Not synchronized to signal or still negotiating (possible cable problem)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCLOGINFO_FC_LINK_CRC_ERROR
suffix:colon
id|desc
op_assign
l_string|&quot;CRC check detected error on received frame&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: LogInfo(0x%08x): SubCl={%s}&quot;
comma
id|ioc-&gt;name
comma
id|log_info
comma
id|subcl_str
(braket
id|subcl
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SubCl
op_eq
id|MPI_IOCLOGINFO_FC_INVALID_FIELD_BYTE_OFFSET
)paren
id|printk
c_func
(paren
l_string|&quot;, byte_offset=%d&bslash;n&quot;
comma
id|log_info
op_amp
id|MPI_IOCLOGINFO_FC_INVALID_FIELD_MAX_OFFSET
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|SubCl
op_eq
id|MPI_IOCLOGINFO_FC_STATE_CHANGE
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* StateChg in LogInfo &amp; 0x00FFFFFF, above */
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_INFO
l_string|&quot; %s&bslash;n&quot;
comma
id|desc
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_sp_log_info - Log information returned from SCSI Parallel IOC.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mr: Pointer to MPT reply frame&n; *&t;@log_info: U32 LogInfo word from the IOC&n; *&n; *&t;Refer to lsi/sp_log.h.&n; */
r_static
r_void
DECL|function|mpt_sp_log_info
id|mpt_sp_log_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|log_info
)paren
(brace
multiline_comment|/* FIXME! */
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: LogInfo(0x%08x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|log_info
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_register_ascqops_strings - Register SCSI ASC/ASCQ and SCSI&n; *&t;OpCode strings from the (optional) isense module.&n; *&t;@ascqTable: Pointer to ASCQ_Table_t structure&n; *&t;@ascqtbl_sz: Number of entries in ASCQ_Table&n; *&t;@opsTable: Pointer to array of SCSI OpCode strings (char pointers)&n; *&n; *&t;Specialized driver registration routine for the isense driver.&n; */
r_int
DECL|function|mpt_register_ascqops_strings
id|mpt_register_ascqops_strings
c_func
(paren
multiline_comment|/*ASCQ_Table_t*/
r_void
op_star
id|ascqTable
comma
r_int
id|ascqtbl_sz
comma
r_const
r_char
op_star
op_star
id|opsTable
)paren
(brace
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ascqTable
op_logical_and
id|ascqtbl_sz
op_logical_and
id|opsTable
)paren
(brace
id|mpt_v_ASCQ_TablePtr
op_assign
id|ascqTable
suffix:semicolon
id|mpt_ASCQ_TableSz
op_assign
id|ascqtbl_sz
suffix:semicolon
id|mpt_ScsiOpcodesPtr
op_assign
id|opsTable
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: English readable SCSI-3 strings enabled:-)&bslash;n&quot;
)paren
suffix:semicolon
id|r
op_assign
l_int|1
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_deregister_ascqops_strings - Deregister SCSI ASC/ASCQ and SCSI&n; *&t;OpCode strings from the isense driver.&n; *&n; *&t;Specialized driver deregistration routine for the isense driver.&n; */
r_void
DECL|function|mpt_deregister_ascqops_strings
id|mpt_deregister_ascqops_strings
c_func
(paren
r_void
)paren
(brace
id|mpt_v_ASCQ_TablePtr
op_assign
l_int|NULL
suffix:semicolon
id|mpt_ASCQ_TableSz
op_assign
l_int|0
suffix:semicolon
id|mpt_ScsiOpcodesPtr
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: English readable SCSI-3 strings disabled)-:&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mpt_register
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_register
)paren
suffix:semicolon
DECL|variable|mpt_deregister
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_deregister
)paren
suffix:semicolon
DECL|variable|mpt_event_register
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_event_register
)paren
suffix:semicolon
DECL|variable|mpt_event_deregister
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_event_deregister
)paren
suffix:semicolon
DECL|variable|mpt_reset_register
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_reset_register
)paren
suffix:semicolon
DECL|variable|mpt_reset_deregister
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_reset_deregister
)paren
suffix:semicolon
DECL|variable|mpt_get_msg_frame
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_get_msg_frame
)paren
suffix:semicolon
DECL|variable|mpt_put_msg_frame
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_put_msg_frame
)paren
suffix:semicolon
DECL|variable|mpt_free_msg_frame
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_free_msg_frame
)paren
suffix:semicolon
DECL|variable|mpt_send_handshake_request
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_send_handshake_request
)paren
suffix:semicolon
DECL|variable|mpt_adapter_find_first
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_adapter_find_first
)paren
suffix:semicolon
DECL|variable|mpt_adapter_find_next
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_adapter_find_next
)paren
suffix:semicolon
DECL|variable|mpt_verify_adapter
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_verify_adapter
)paren
suffix:semicolon
DECL|variable|mpt_print_ioc_summary
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_print_ioc_summary
)paren
suffix:semicolon
DECL|variable|mpt_lan_index
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_lan_index
)paren
suffix:semicolon
DECL|variable|mpt_stm_index
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_stm_index
)paren
suffix:semicolon
DECL|variable|mpt_register_ascqops_strings
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_register_ascqops_strings
)paren
suffix:semicolon
DECL|variable|mpt_deregister_ascqops_strings
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_deregister_ascqops_strings
)paren
suffix:semicolon
DECL|variable|mpt_v_ASCQ_TablePtr
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_v_ASCQ_TablePtr
)paren
suffix:semicolon
DECL|variable|mpt_ASCQ_TableSz
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_ASCQ_TableSz
)paren
suffix:semicolon
DECL|variable|mpt_ScsiOpcodesPtr
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_ScsiOpcodesPtr
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;fusion_init - Fusion MPT base driver initialization routine.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
DECL|function|fusion_init
r_int
id|__init
id|fusion_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|FusionInitCalled
op_increment
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: INFO - Driver late-init entry point called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|show_mptmod_ver
c_func
(paren
id|my_NAME
comma
id|my_VERSION
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|COPYRIGHT
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|Q_INIT
c_func
(paren
op_amp
id|MptAdapters
comma
id|MPT_ADAPTER
)paren
suffix:semicolon
multiline_comment|/* set to empty */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MPT_MAX_PROTOCOL_DRIVERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|MptCallbacks
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|MptDriverClass
(braket
id|i
)braket
op_assign
id|MPTUNKNOWN_DRIVER
suffix:semicolon
id|MptEvHandlers
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|MptResetHandlers
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* NEW!  20010120 -sralston&n;&t; *  Register ourselves (mptbase) in order to facilitate&n;&t; *  EventNotification handling.&n;&t; */
id|mpt_base_index
op_assign
id|mpt_register
c_func
(paren
id|mpt_base_reply
comma
id|MPTBASE_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|mpt_pci_scan
c_func
(paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;fusion_exit - Perform driver unload cleanup.&n; *&n; *&t;This routine frees all resources associated with each MPT adapter&n; *&t;and removes all %MPT_PROCFS_MPTBASEDIR entries.&n; */
DECL|function|fusion_exit
r_static
r_void
id|fusion_exit
c_func
(paren
r_void
)paren
(brace
id|MPT_ADAPTER
op_star
id|this
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: fusion_exit() called!&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Whups?  20010120 -sralston&n;&t; *  Moved this *above* removal of all MptAdapters!&n;&t; */
macro_line|#ifdef CONFIG_PROC_FS
id|procmpt_destroy
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|MptAdapters
)paren
)paren
(brace
id|this
op_assign
id|MptAdapters.head
suffix:semicolon
id|Q_DEL_ITEM
c_func
(paren
id|this
)paren
suffix:semicolon
id|mpt_adapter_dispose
c_func
(paren
id|this
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|fusion_init
id|module_init
c_func
(paren
id|fusion_init
)paren
suffix:semicolon
DECL|variable|fusion_exit
id|module_exit
c_func
(paren
id|fusion_exit
)paren
suffix:semicolon
eof
