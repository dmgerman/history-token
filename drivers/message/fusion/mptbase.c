multiline_comment|/*&n; *  linux/drivers/message/fusion/mptbase.c&n; *      High performance SCSI + LAN / Fibre Channel device drivers.&n; *      This is the Fusion MPT base driver which supports multiple&n; *      (SCSI + LAN) specialized protocol drivers.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      There are lots of people not mentioned below that deserve credit&n; *      and thanks but won&squot;t get it here - sorry in advance that you&n; *      got overlooked.&n; *&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      A special thanks to Noah Romer (LSI Logic) for tons of work&n; *      and tough debugging on the LAN driver, especially early on;-)&n; *      And to Roger Hickerson (LSI Logic) for tirelessly supporting&n; *      this driver project.&n; *&n; *      A special thanks to Pamela Delaney (LSI Logic) for tons of work&n; *      and countless enhancements while adding support for the 1030&n; *      chip family.  Pam has been instrumental in the development of&n; *      of the 2.xx.xx series fusion drivers, and her contributions are&n; *      far too numerous to hope to list in one place.&n; *&n; *      All manner of help from Stephen Shirron (LSI Logic):&n; *      low-level FC analysis, debug + various fixes in FCxx firmware,&n; *      initial port to alpha platform, various driver code optimizations,&n; *      being a faithful sounding board on all sorts of issues &amp; ideas,&n; *      etc.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      Special thanks goes to the I2O LAN driver people at the&n; *      University of Helsinki, who, unbeknownst to them, provided&n; *      the inspiration and initial structure for this driver.&n; *&n; *      A really huge debt of gratitude is owed to Eddie C. Dost&n; *      for gobs of hard work fixing and optimizing LAN code.&n; *      THANK YOU!&n; *&n; *  Copyright (c) 1999-2004 LSI Logic Corporation&n; *  Originally By: Steven J. Ralston&n; *  (mailto:sjralston1@netscape.net)&n; *  (mailto:mpt_linux_developer@lsil.com)&n; *&n; *  $Id: mptbase.c,v 1.126 2002/12/16 15:28:45 pdelaney Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;&t;&t;/* needed for in_interrupt() proto */
macro_line|#include &lt;asm/io.h&gt;
macro_line|#ifdef CONFIG_MTRR
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif
macro_line|#ifdef __sparc__
macro_line|#include &lt;asm/irq.h&gt;&t;&t;&t;/* needed for __irq_itoa() proto */
macro_line|#endif
macro_line|#include &quot;mptbase.h&quot;
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|my_NAME
mdefine_line|#define my_NAME&t;&t;&quot;Fusion MPT base driver&quot;
DECL|macro|my_VERSION
mdefine_line|#define my_VERSION&t;MPT_LINUX_VERSION_COMMON
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptbase&quot;
DECL|variable|MODULEAUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|MODULEAUTHOR
)paren
suffix:semicolon
DECL|variable|my_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|my_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *  cmd line parameters&n; */
macro_line|#ifdef MFCNT
DECL|variable|mfcounter
r_static
r_int
id|mfcounter
op_assign
l_int|0
suffix:semicolon
DECL|macro|PRINT_MF_COUNT
mdefine_line|#define PRINT_MF_COUNT 20000
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Public data...&n; */
DECL|variable|mpt_lan_index
r_int
id|mpt_lan_index
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mpt_stm_index
r_int
id|mpt_stm_index
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mpt_proc_root_dir
r_struct
id|proc_dir_entry
op_star
id|mpt_proc_root_dir
suffix:semicolon
DECL|macro|WHOINIT_UNKNOWN
mdefine_line|#define WHOINIT_UNKNOWN&t;&t;0xAA
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Private data...&n; */
multiline_comment|/* Adapter link list */
DECL|variable|ioc_list
id|LIST_HEAD
c_func
(paren
id|ioc_list
)paren
suffix:semicolon
multiline_comment|/* Callback lookup table */
DECL|variable|MptCallbacks
r_static
id|MPT_CALLBACK
id|MptCallbacks
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
multiline_comment|/* Protocol driver class lookup table */
DECL|variable|MptDriverClass
r_static
r_int
id|MptDriverClass
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
multiline_comment|/* Event handler lookup table */
DECL|variable|MptEvHandlers
r_static
id|MPT_EVHANDLER
id|MptEvHandlers
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
multiline_comment|/* Reset handler lookup table */
DECL|variable|MptResetHandlers
r_static
id|MPT_RESETHANDLER
id|MptResetHandlers
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
DECL|variable|MptDeviceDriverHandlers
r_static
r_struct
id|mpt_pci_driver
op_star
id|MptDeviceDriverHandlers
(braket
id|MPT_MAX_PROTOCOL_DRIVERS
)braket
suffix:semicolon
DECL|variable|FusionInitCalled
r_static
r_int
id|FusionInitCalled
op_assign
l_int|0
suffix:semicolon
DECL|variable|mpt_base_index
r_static
r_int
id|mpt_base_index
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|last_drv_idx
r_static
r_int
id|last_drv_idx
op_assign
op_minus
l_int|1
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|mpt_waitq
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Forward protos...&n; */
r_static
id|irqreturn_t
id|mpt_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|bus_id
comma
r_struct
id|pt_regs
op_star
id|r
)paren
suffix:semicolon
r_static
r_int
id|mpt_base_reply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|req
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
suffix:semicolon
r_static
r_int
id|mpt_handshake_req_reply_wait
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reqBytes
comma
id|u32
op_star
id|req
comma
r_int
id|replyBytes
comma
id|u16
op_star
id|u16reply
comma
r_int
id|maxwait
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|mpt_do_ioc_recovery
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|reason
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_void
id|mpt_detect_bound_ports
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_void
id|mpt_adapter_disable
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|mpt_adapter_dispose
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|MptDisplayIocCapabilities
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|MakeIocReady
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|force
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
singleline_comment|//static u32&t;mpt_GetIocState(MPT_ADAPTER *ioc, int cooked);
r_static
r_int
id|GetIocFacts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
comma
r_int
id|reason
)paren
suffix:semicolon
r_static
r_int
id|GetPortFacts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|SendIocInit
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|SendPortEnable
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|mpt_do_upload
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|mpt_downloadboot
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|mpt_diag_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|ignore
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|KickStart
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|ignore
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|SendIocReset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u8
id|reset_type
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|PrimeIocFifos
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|WaitForDoorbellAck
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|WaitForDoorbellInt
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|WaitForDoorbellReply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|GetLanConfigPages
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|GetFcPortPage0
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
suffix:semicolon
r_static
r_int
id|GetIoUnitPage2
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_int
id|mpt_GetScsiPortSettings
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
suffix:semicolon
r_static
r_int
id|mpt_readScsiDevicePageHeaders
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
suffix:semicolon
r_static
r_void
id|mpt_read_ioc_pg_1
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|mpt_read_ioc_pg_4
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|mpt_timer_expired
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_int
id|SendEventNotification
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u8
id|EvSwitch
)paren
suffix:semicolon
r_static
r_int
id|SendEventAck
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|evnp
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_static
r_int
id|procmpt_summary_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|request
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|procmpt_version_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|request
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|procmpt_iocinfo_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|request
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|mpt_get_fw_exp_ver
c_func
(paren
r_char
op_star
id|buf
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
singleline_comment|//int&t;&t;mpt_HardResetHandler(MPT_ADAPTER *ioc, int sleepFlag);
r_static
r_int
id|ProcessEventNotification
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|evReply
comma
r_int
op_star
id|evHandlers
)paren
suffix:semicolon
r_static
r_void
id|mpt_sp_ioc_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|ioc_status
comma
id|MPT_FRAME_HDR
op_star
id|mf
)paren
suffix:semicolon
r_static
r_void
id|mpt_fc_log_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|log_info
)paren
suffix:semicolon
r_static
r_void
id|mpt_sp_log_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|log_info
)paren
suffix:semicolon
multiline_comment|/* module entry point */
r_static
r_int
id|__devinit
id|mptbase_probe
(paren
r_struct
id|pci_dev
op_star
comma
r_const
r_struct
id|pci_device_id
op_star
)paren
suffix:semicolon
r_static
r_void
id|__devexit
id|mptbase_remove
c_func
(paren
r_struct
id|pci_dev
op_star
)paren
suffix:semicolon
r_static
r_void
id|mptbase_shutdown
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|__init
id|fusion_init
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|__exit
id|fusion_exit
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/****************************************************************************&n; * Supported hardware&n; */
DECL|variable|mptbase_pci_table
r_static
r_struct
id|pci_device_id
id|mptbase_pci_table
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_LSI_LOGIC
comma
id|PCI_DEVICE_ID_LSI_FC909
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
id|PCI_VENDOR_ID_LSI_LOGIC
comma
id|PCI_DEVICE_ID_LSI_FC929
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
id|PCI_VENDOR_ID_LSI_LOGIC
comma
id|PCI_DEVICE_ID_LSI_FC919
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
id|PCI_VENDOR_ID_LSI_LOGIC
comma
id|PCI_DEVICE_ID_LSI_FC929X
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
id|PCI_VENDOR_ID_LSI_LOGIC
comma
id|PCI_DEVICE_ID_LSI_FC919X
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
id|PCI_VENDOR_ID_LSI_LOGIC
comma
id|PCI_DEVICE_ID_LSI_53C1030
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
id|PCI_VENDOR_ID_LSI_LOGIC
comma
id|PCI_DEVICE_ID_LSI_1030_53C1035
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
)brace
comma
(brace
l_int|0
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|mptbase_pci_table
)paren
suffix:semicolon
DECL|macro|CHIPREG_READ32
mdefine_line|#define CHIPREG_READ32(addr) &t;&t;readl_relaxed(addr)
DECL|macro|CHIPREG_READ32_dmasync
mdefine_line|#define CHIPREG_READ32_dmasync(addr)&t;readl(addr)
DECL|macro|CHIPREG_WRITE32
mdefine_line|#define CHIPREG_WRITE32(addr,val) &t;writel(val, addr)
DECL|macro|CHIPREG_PIO_WRITE32
mdefine_line|#define CHIPREG_PIO_WRITE32(addr,val)&t;outl(val, (unsigned long)addr)
DECL|macro|CHIPREG_PIO_READ32
mdefine_line|#define CHIPREG_PIO_READ32(addr) &t;inl((unsigned long)addr)
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_interrupt - MPT adapter (IOC) specific interrupt handler.&n; *&t;@irq: irq number (not used)&n; *&t;@bus_id: bus identifier cookie == pointer to MPT_ADAPTER structure&n; *&t;@r: pt_regs pointer (not used)&n; *&n; *&t;This routine is registered via the request_irq() kernel API call,&n; *&t;and handles all interrupts generated from a specific MPT adapter&n; *&t;(also referred to as a IO Controller or IOC).&n; *&t;This routine must clear the interrupt from the adapter and does&n; *&t;so by reading the reply FIFO.  Multiple replies may be processed&n; *&t;per single call to this routine; up to MPT_MAX_REPLIES_PER_ISR&n; *&t;which is currently set to 32 in mptbase.h.&n; *&n; *&t;This routine handles register-level access of the adapter but&n; *&t;dispatches (calls) a protocol-specific callback routine to handle&n; *&t;the protocol-specific details of the MPT request completion.&n; */
r_static
id|irqreturn_t
DECL|function|mpt_interrupt
id|mpt_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|bus_id
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mr
suffix:semicolon
id|u32
id|pa
suffix:semicolon
r_int
id|req_idx
suffix:semicolon
r_int
id|cb_idx
suffix:semicolon
r_int
id|type
suffix:semicolon
r_int
id|freeme
suffix:semicolon
id|ioc
op_assign
(paren
id|MPT_ADAPTER
op_star
)paren
id|bus_id
suffix:semicolon
multiline_comment|/*&n;&t; *  Drain the reply FIFO!&n;&t; *&n;&t; * NOTES: I&squot;ve seen up to 10 replies processed in this loop, so far...&n;&t; * Update: I&squot;ve seen up to 9182 replies processed in this loop! ??&n;&t; * Update: Limit ourselves to processing max of N replies&n;&t; *&t;(bottom of loop).&n;&t; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|pa
op_assign
id|CHIPREG_READ32_dmasync
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;ReplyFifo
)paren
)paren
op_eq
l_int|0xFFFFFFFF
)paren
r_return
id|IRQ_HANDLED
suffix:semicolon
id|cb_idx
op_assign
l_int|0
suffix:semicolon
id|freeme
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Check for non-TURBO reply!&n;&t;&t; */
r_if
c_cond
(paren
id|pa
op_amp
id|MPI_ADDRESS_REPLY_A_BIT
)paren
(brace
id|u32
id|reply_dma_low
suffix:semicolon
id|u16
id|ioc_stat
suffix:semicolon
multiline_comment|/* non-TURBO reply!  Hmmm, something may be up...&n;&t;&t;&t; *  Newest turbo reply mechanism; get address&n;&t;&t;&t; *  via left shift 1 (get rid of MPI_ADDRESS_REPLY_A_BIT)!&n;&t;&t;&t; */
multiline_comment|/* Map DMA address of reply header to cpu address.&n;&t;&t;&t; * pa is 32 bits - but the dma address may be 32 or 64 bits&n;&t;&t;&t; * get offset based only only the low addresses&n;&t;&t;&t; */
id|reply_dma_low
op_assign
(paren
id|pa
op_assign
(paren
id|pa
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|mr
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|ioc-&gt;reply_frames
op_plus
(paren
id|reply_dma_low
op_minus
id|ioc-&gt;reply_frames_low_dma
)paren
)paren
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mr-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|cb_idx
op_assign
id|mr-&gt;u.frame.hwhdr.msgctxu.fld.cb_idx
suffix:semicolon
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|req_idx
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Got non-TURBO reply=%p req_idx=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mr
comma
id|req_idx
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REPLY_FRAME
c_func
(paren
id|mr
)paren
multiline_comment|/* NEW!  20010301 -sralston&n;&t;&t;&t; *  Check/log IOC log info&n;&t;&t;&t; */
id|ioc_stat
op_assign
id|le16_to_cpu
c_func
(paren
id|mr-&gt;u.reply.IOCStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc_stat
op_amp
id|MPI_IOCSTATUS_FLAG_LOG_INFO_AVAILABLE
)paren
(brace
id|u32
id|log_info
op_assign
id|le32_to_cpu
c_func
(paren
id|mr-&gt;u.reply.IOCLogInfo
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
id|mpt_fc_log_info
c_func
(paren
id|ioc
comma
id|log_info
)paren
suffix:semicolon
r_else
id|mpt_sp_log_info
c_func
(paren
id|ioc
comma
id|log_info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc_stat
op_amp
id|MPI_IOCSTATUS_MASK
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
suffix:semicolon
r_else
id|mpt_sp_ioc_info
c_func
(paren
id|ioc
comma
(paren
id|u32
)paren
id|ioc_stat
comma
id|mf
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; *  Process turbo (context) reply...&n;&t;&t;&t; */
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Got TURBO reply req_idx=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pa
)paren
)paren
suffix:semicolon
id|type
op_assign
(paren
id|pa
op_rshift
id|MPI_CONTEXT_REPLY_TYPE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|MPI_CONTEXT_REPLY_TYPE_SCSI_TARGET
)paren
(brace
id|cb_idx
op_assign
id|mpt_stm_index
suffix:semicolon
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|mr
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|CAST_U32_TO_PTR
c_func
(paren
id|pa
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|MPI_CONTEXT_REPLY_TYPE_LAN
)paren
(brace
id|cb_idx
op_assign
id|mpt_lan_index
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * BUG FIX!  20001218 -sralston&n;&t;&t;&t;&t; *  Blind set of mf to NULL here was fatal&n;&t;&t;&t;&t; *  after lan_reply says &quot;freeme&quot;&n;&t;&t;&t;&t; *  Fix sort of combined with an optimization here;&n;&t;&t;&t;&t; *  added explicit check for case where lan_reply&n;&t;&t;&t;&t; *  was just returning 1 and doing nothing else.&n;&t;&t;&t;&t; *  For this case skip the callback, but set up&n;&t;&t;&t;&t; *  proper mf value first here:-)&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|pa
op_amp
l_int|0x58000000
)paren
op_eq
l_int|0x58000000
)paren
(brace
id|req_idx
op_assign
id|pa
op_amp
l_int|0x0000FFFF
suffix:semicolon
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|req_idx
)paren
suffix:semicolon
id|freeme
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; *  IMPORTANT!  Invalidate the callback!&n;&t;&t;&t;&t;&t; */
id|cb_idx
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|mf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|mr
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|CAST_U32_TO_PTR
c_func
(paren
id|pa
)paren
suffix:semicolon
)brace
r_else
(brace
id|req_idx
op_assign
id|pa
op_amp
l_int|0x0000FFFF
suffix:semicolon
id|cb_idx
op_assign
(paren
id|pa
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|req_idx
)paren
suffix:semicolon
id|mr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pa
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No reply flush! */
)brace
macro_line|#ifdef MPT_DEBUG_IRQ
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
OG
(paren
r_int
)paren
id|FC929
)paren
(brace
multiline_comment|/* Verify mf, mr are reasonable.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|mf
)paren
op_logical_and
(paren
(paren
id|mf
op_ge
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
op_logical_or
(paren
id|mf
OL
id|ioc-&gt;req_frames
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;mpt_interrupt: Invalid mf (%p) req_idx (%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
r_void
op_star
)paren
id|mf
comma
id|req_idx
)paren
suffix:semicolon
id|cb_idx
op_assign
l_int|0
suffix:semicolon
id|pa
op_assign
l_int|0
suffix:semicolon
id|freeme
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pa
)paren
op_logical_and
(paren
id|mr
)paren
op_logical_and
(paren
(paren
id|mr
op_ge
id|MPT_INDEX_2_RFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
op_logical_or
(paren
id|mr
OL
id|ioc-&gt;reply_frames
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;mpt_interrupt: Invalid rf (%p)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
r_void
op_star
)paren
id|mr
)paren
suffix:semicolon
id|cb_idx
op_assign
l_int|0
suffix:semicolon
id|pa
op_assign
l_int|0
suffix:semicolon
id|freeme
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cb_idx
OG
(paren
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;mpt_interrupt: Invalid cb_idx (%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|cb_idx
)paren
suffix:semicolon
id|cb_idx
op_assign
l_int|0
suffix:semicolon
id|pa
op_assign
l_int|0
suffix:semicolon
id|freeme
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*  Check for (valid) IO callback!  */
r_if
c_cond
(paren
id|cb_idx
)paren
(brace
multiline_comment|/*  Do the callback!  */
id|freeme
op_assign
(paren
op_star
(paren
id|MptCallbacks
(braket
id|cb_idx
)braket
)paren
)paren
(paren
id|ioc
comma
id|mf
comma
id|mr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pa
)paren
(brace
multiline_comment|/*  Flush (non-TURBO) reply with a WRITE!  */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;ReplyFifo
comma
id|pa
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freeme
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*  Put Request back on FreeQ!  */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage.list
comma
op_amp
id|ioc-&gt;FreeQ
)paren
suffix:semicolon
macro_line|#ifdef MFCNT
id|ioc-&gt;mfcnt
op_decrement
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* drain reply FIFO */
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_base_reply - MPT base driver&squot;s callback routine; all base driver&n; *&t;&quot;internal&quot; request/reply processing is routed here.&n; *&t;Currently used for EventNotification and EventAck handling.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to original MPT request frame&n; *&t;@reply: Pointer to MPT reply frame (NULL if TurboReply)&n; *&n;&t;*&t;Returns 1 indicating original alloc&squot;d request frame ptr&n; *&t;should be freed, or 0 if it shouldn&squot;t.&n; */
r_static
r_int
DECL|function|mpt_base_reply
id|mpt_base_reply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
(brace
r_int
id|freereq
op_assign
l_int|1
suffix:semicolon
id|u8
id|func
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;mpt_base_reply() called&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|mf
op_ge
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;NULL or BAD request frame ptr! (=%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
r_void
op_star
)paren
id|mf
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reply
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Unexpected NULL Event (turbo?) reply!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reply-&gt;u.hdr.MsgFlags
op_amp
id|MPI_MSGFLAGS_CONTINUATION_REPLY
)paren
)paren
(brace
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Original request frame (@%p) header&bslash;n&quot;
comma
id|mf
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REQUEST_FRAME_HDR
c_func
(paren
id|mf
)paren
)brace
id|func
op_assign
id|reply-&gt;u.hdr.Function
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;mpt_base_reply, Function=%02Xh&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|func
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func
op_eq
id|MPI_FUNCTION_EVENT_NOTIFICATION
)paren
(brace
id|EventNotificationReply_t
op_star
id|pEvReply
op_assign
(paren
id|EventNotificationReply_t
op_star
)paren
id|reply
suffix:semicolon
r_int
id|evHandlers
op_assign
l_int|0
suffix:semicolon
r_int
id|results
suffix:semicolon
id|results
op_assign
id|ProcessEventNotification
c_func
(paren
id|ioc
comma
id|pEvReply
comma
op_amp
id|evHandlers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|results
op_ne
id|evHandlers
)paren
(brace
multiline_comment|/* CHECKME! Any special handling needed here? */
id|devtprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Called %d event handlers, sum results = %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|evHandlers
comma
id|results
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Hmmm...  It seems that EventNotificationReply is an exception&n;&t;&t; *&t;to the rule of one reply per request.&n;&t;&t; */
r_if
c_cond
(paren
id|pEvReply-&gt;MsgFlags
op_amp
id|MPI_MSGFLAGS_CONTINUATION_REPLY
)paren
id|freereq
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
singleline_comment|//&t;&t;LogEvent(ioc, pEvReply);
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|func
op_eq
id|MPI_FUNCTION_EVENT_ACK
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;mpt_base_reply, EventAck reply received&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|func
op_eq
id|MPI_FUNCTION_CONFIG
op_logical_or
id|func
op_eq
id|MPI_FUNCTION_TOOLBOX
)paren
(brace
id|CONFIGPARMS
op_star
id|pCfg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;config_complete (mf=%p,mr=%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
comma
id|reply
)paren
)paren
suffix:semicolon
id|pCfg
op_assign
op_star
(paren
(paren
id|CONFIGPARMS
op_star
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|mf
op_plus
id|ioc-&gt;req_sz
op_minus
r_sizeof
(paren
r_void
op_star
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCfg
)paren
(brace
multiline_comment|/* disable timer and remove from linked list */
id|del_timer
c_func
(paren
op_amp
id|pCfg-&gt;timer
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|pCfg-&gt;linkage
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;If IOC Status is SUCCESS, save the header&n;&t;&t;&t; *&t;and set the status code to GOOD.&n;&t;&t;&t; */
id|pCfg-&gt;status
op_assign
id|MPT_CONFIG_ERROR
suffix:semicolon
r_if
c_cond
(paren
id|reply
)paren
(brace
id|ConfigReply_t
op_star
id|pReply
op_assign
(paren
id|ConfigReply_t
op_star
)paren
id|reply
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|status
op_assign
id|le16_to_cpu
c_func
(paren
id|pReply-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
id|dcprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  IOCStatus=%04xh, IOCLogInfo=%08xh&bslash;n&quot;
comma
id|status
comma
id|le32_to_cpu
c_func
(paren
id|pReply-&gt;IOCLogInfo
)paren
)paren
)paren
suffix:semicolon
id|pCfg-&gt;status
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|MPI_IOCSTATUS_SUCCESS
)paren
(brace
id|pCfg-&gt;hdr-&gt;PageVersion
op_assign
id|pReply-&gt;Header.PageVersion
suffix:semicolon
id|pCfg-&gt;hdr-&gt;PageLength
op_assign
id|pReply-&gt;Header.PageLength
suffix:semicolon
id|pCfg-&gt;hdr-&gt;PageNumber
op_assign
id|pReply-&gt;Header.PageNumber
suffix:semicolon
id|pCfg-&gt;hdr-&gt;PageType
op_assign
id|pReply-&gt;Header.PageType
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Wake up the original calling thread&n;&t;&t;&t; */
id|pCfg-&gt;wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|mpt_waitq
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Unexpected msg function (=%02Xh) reply received!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|func
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Conditionally tell caller to free the original&n;&t; *&t;EventNotification/EventAck/unexpected request frame!&n;&t; */
r_return
id|freereq
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_register - Register protocol-specific main callback handler.&n; *&t;@cbfunc: callback function pointer&n; *&t;@dclass: Protocol driver&squot;s class (%MPT_DRIVER_CLASS enum value)&n; *&n; *&t;This routine is called by a protocol-specific driver (SCSI host,&n; *&t;LAN, SCSI target) to register it&squot;s reply callback routine.  Each&n; *&t;protocol-specific driver must do this before it will be able to&n; *&t;use any IOC resources, such as obtaining request frames.&n; *&n; *&t;NOTES: The SCSI protocol driver currently calls this routine thrice&n; *&t;in order to register separate callbacks; one for &quot;normal&quot; SCSI IO;&n; *&t;one for MptScsiTaskMgmt requests; one for Scan/DV requests.&n; *&n; *&t;Returns a positive integer valued &quot;handle&quot; in the&n; *&t;range (and S.O.D. order) {N,...,7,6,5,...,1} if successful.&n; *&t;Any non-positive return value (including zero!) should be considered&n; *&t;an error by the caller.&n; */
r_int
DECL|function|mpt_register
id|mpt_register
c_func
(paren
id|MPT_CALLBACK
id|cbfunc
comma
id|MPT_DRIVER_CLASS
id|dclass
)paren
(brace
r_int
id|i
suffix:semicolon
id|last_drv_idx
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifndef MODULE
multiline_comment|/*&n;&t; *  Handle possibility of the mptscsih_detect() routine getting&n;&t; *  called *before* fusion_init!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|FusionInitCalled
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Hmmm, calling fusion_init from mpt_register!&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  NOTE! We&squot;ll get recursion here, as fusion_init()&n;&t;&t; *  calls mpt_register()!&n;&t;&t; */
id|fusion_init
c_func
(paren
)paren
suffix:semicolon
id|FusionInitCalled
op_increment
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; *  Search for empty callback slot in this order: {N,...,7,6,5,...,1}&n;&t; *  (slot/handle 0 is reserved!)&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|MptCallbacks
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|MptCallbacks
(braket
id|i
)braket
op_assign
id|cbfunc
suffix:semicolon
id|MptDriverClass
(braket
id|i
)braket
op_assign
id|dclass
suffix:semicolon
id|MptEvHandlers
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|last_drv_idx
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|last_drv_idx
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_deregister - Deregister a protocol drivers resources.&n; *&t;@cb_idx: previously registered callback handle&n; *&n; *&t;Each protocol-specific driver should call this routine when it&squot;s&n; *&t;module is unloaded.&n; */
r_void
DECL|function|mpt_deregister
id|mpt_deregister
c_func
(paren
r_int
id|cb_idx
)paren
(brace
r_if
c_cond
(paren
(paren
id|cb_idx
op_ge
l_int|0
)paren
op_logical_and
(paren
id|cb_idx
OL
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
)paren
(brace
id|MptCallbacks
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|MptDriverClass
(braket
id|cb_idx
)braket
op_assign
id|MPTUNKNOWN_DRIVER
suffix:semicolon
id|MptEvHandlers
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|last_drv_idx
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_event_register - Register protocol-specific event callback&n; *&t;handler.&n; *&t;@cb_idx: previously registered (via mpt_register) callback handle&n; *&t;@ev_cbfunc: callback function&n; *&n; *&t;This routine can be called by one or more protocol-specific drivers&n; *&t;if/when they choose to be notified of MPT events.&n; *&n; *&t;Returns 0 for success.&n; */
r_int
DECL|function|mpt_event_register
id|mpt_event_register
c_func
(paren
r_int
id|cb_idx
comma
id|MPT_EVHANDLER
id|ev_cbfunc
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|MptEvHandlers
(braket
id|cb_idx
)braket
op_assign
id|ev_cbfunc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_event_deregister - Deregister protocol-specific event callback&n; *&t;handler.&n; *&t;@cb_idx: previously registered callback handle&n; *&n; *&t;Each protocol-specific driver should call this routine&n; *&t;when it does not (or can no longer) handle events,&n; *&t;or when it&squot;s module is unloaded.&n; */
r_void
DECL|function|mpt_event_deregister
id|mpt_event_deregister
c_func
(paren
r_int
id|cb_idx
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
suffix:semicolon
id|MptEvHandlers
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_reset_register - Register protocol-specific IOC reset handler.&n; *&t;@cb_idx: previously registered (via mpt_register) callback handle&n; *&t;@reset_func: reset function&n; *&n; *&t;This routine can be called by one or more protocol-specific drivers&n; *&t;if/when they choose to be notified of IOC resets.&n; *&n; *&t;Returns 0 for success.&n; */
r_int
DECL|function|mpt_reset_register
id|mpt_reset_register
c_func
(paren
r_int
id|cb_idx
comma
id|MPT_RESETHANDLER
id|reset_func
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|MptResetHandlers
(braket
id|cb_idx
)braket
op_assign
id|reset_func
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_reset_deregister - Deregister protocol-specific IOC reset handler.&n; *&t;@cb_idx: previously registered callback handle&n; *&n; *&t;Each protocol-specific driver should call this routine&n; *&t;when it does not (or can no longer) handle IOC reset handling,&n; *&t;or when it&squot;s module is unloaded.&n; */
r_void
DECL|function|mpt_reset_deregister
id|mpt_reset_deregister
c_func
(paren
r_int
id|cb_idx
)paren
(brace
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
suffix:semicolon
id|MptResetHandlers
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_device_driver_register - Register device driver hooks&n; */
r_int
DECL|function|mpt_device_driver_register
id|mpt_device_driver_register
c_func
(paren
r_struct
id|mpt_pci_driver
op_star
id|dd_cbfunc
comma
r_int
id|cb_idx
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
(brace
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|MptDeviceDriverHandlers
(braket
id|cb_idx
)braket
op_assign
id|dd_cbfunc
suffix:semicolon
multiline_comment|/* call per pci device probe entry point */
id|list_for_each_entry
c_func
(paren
id|ioc
comma
op_amp
id|ioc_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|dd_cbfunc-&gt;probe
)paren
(brace
id|error
op_assign
id|dd_cbfunc
op_member_access_from_pointer
id|probe
c_func
(paren
id|ioc-&gt;pcidev
comma
id|ioc-&gt;pcidev-&gt;driver-&gt;id_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
)brace
)brace
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_device_driver_deregister - DeRegister device driver hooks&n; */
r_void
DECL|function|mpt_device_driver_deregister
id|mpt_device_driver_deregister
c_func
(paren
r_int
id|cb_idx
)paren
(brace
r_struct
id|mpt_pci_driver
op_star
id|dd_cbfunc
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_if
c_cond
(paren
id|cb_idx
OL
l_int|1
op_logical_or
id|cb_idx
op_ge
id|MPT_MAX_PROTOCOL_DRIVERS
)paren
r_return
suffix:semicolon
id|dd_cbfunc
op_assign
id|MptDeviceDriverHandlers
(braket
id|cb_idx
)braket
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|ioc
comma
op_amp
id|ioc_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|dd_cbfunc-&gt;remove
)paren
id|dd_cbfunc
op_member_access_from_pointer
id|remove
c_func
(paren
id|ioc-&gt;pcidev
)paren
suffix:semicolon
)brace
id|MptDeviceDriverHandlers
(braket
id|cb_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_get_msg_frame - Obtain a MPT request frame from the pool (of 1024)&n; *&t;allocated per MPT adapter.&n; *&t;@handle: Handle of registered MPT protocol driver&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&n; *&t;Returns pointer to a MPT request frame or %NULL if none are available&n; *&t;or IOC is not active.&n; */
id|MPT_FRAME_HDR
op_star
DECL|function|mpt_get_msg_frame
id|mpt_get_msg_frame
c_func
(paren
r_int
id|handle
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
multiline_comment|/* Request index */
multiline_comment|/* validate handle and ioc identifier */
macro_line|#ifdef MFCNT
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;active
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IOC Not Active! mpt_get_msg_frame returning NULL!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* If interrupts are not attached, do not return a request frame */
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;active
)paren
r_return
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ioc-&gt;FreeQ
)paren
)paren
(brace
r_int
id|req_offset
suffix:semicolon
id|mf
op_assign
id|list_entry
c_func
(paren
id|ioc-&gt;FreeQ.next
comma
id|MPT_FRAME_HDR
comma
id|u.frame.linkage.list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage.list
)paren
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.cb_idx
op_assign
id|handle
suffix:semicolon
multiline_comment|/* byte */
id|req_offset
op_assign
(paren
id|u8
op_star
)paren
id|mf
op_minus
(paren
id|u8
op_star
)paren
id|ioc-&gt;req_frames
suffix:semicolon
multiline_comment|/* u16! */
id|req_idx
op_assign
id|cpu_to_le16
c_func
(paren
id|req_offset
op_div
id|ioc-&gt;req_sz
)paren
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
op_assign
id|req_idx
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.rsvd
op_assign
l_int|0
suffix:semicolon
id|ioc-&gt;RequestNB
(braket
id|req_idx
)braket
op_assign
id|ioc-&gt;NB_for_64_byte_frame
suffix:semicolon
multiline_comment|/* Default, will be changed if necessary in SG generation */
macro_line|#ifdef MFCNT
id|ioc-&gt;mfcnt
op_increment
suffix:semicolon
macro_line|#endif
)brace
r_else
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef MFCNT
r_if
c_cond
(paren
id|mf
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IOC Active. No free Msg Frames! Count 0x%x Max 0x%x&bslash;n&quot;
comma
id|ioc-&gt;mfcnt
comma
id|ioc-&gt;req_depth
)paren
suffix:semicolon
id|mfcounter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mfcounter
op_eq
id|PRINT_MF_COUNT
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MF Count 0x%x Max 0x%x &bslash;n&quot;
comma
id|ioc-&gt;mfcnt
comma
id|ioc-&gt;req_depth
)paren
suffix:semicolon
macro_line|#endif
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: mpt_get_msg_frame(%d,%d), got mf=%p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|handle
comma
id|ioc-&gt;id
comma
id|mf
)paren
)paren
suffix:semicolon
r_return
id|mf
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_put_msg_frame - Send a protocol specific MPT request frame&n; *&t;to a IOC.&n; *&t;@handle: Handle of registered MPT protocol driver&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&t;@mf: Pointer to MPT request frame&n; *&n; *&t;This routine posts a MPT request frame to the request post FIFO of a&n; *&t;specific MPT adapter.&n; */
r_void
DECL|function|mpt_put_msg_frame
id|mpt_put_msg_frame
c_func
(paren
r_int
id|handle
comma
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
)paren
(brace
id|u32
id|mf_dma_addr
suffix:semicolon
r_int
id|req_offset
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
multiline_comment|/* Request index */
multiline_comment|/* ensure values are reset properly! */
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.cb_idx
op_assign
id|handle
suffix:semicolon
multiline_comment|/* byte */
id|req_offset
op_assign
(paren
id|u8
op_star
)paren
id|mf
op_minus
(paren
id|u8
op_star
)paren
id|ioc-&gt;req_frames
suffix:semicolon
multiline_comment|/* u16! */
id|req_idx
op_assign
id|cpu_to_le16
c_func
(paren
id|req_offset
op_div
id|ioc-&gt;req_sz
)paren
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
op_assign
id|req_idx
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.rsvd
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MPT_DEBUG_MSG_FRAME
(brace
id|u32
op_star
id|m
op_assign
id|mf-&gt;u.frame.hwhdr.__hdr
suffix:semicolon
r_int
id|ii
comma
id|n
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: About to Put msg frame @ %p:&bslash;n&quot;
id|KERN_INFO
l_string|&quot; &quot;
comma
id|ioc-&gt;name
comma
id|m
)paren
suffix:semicolon
id|n
op_assign
id|ioc-&gt;req_sz
op_div
l_int|4
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|m
(braket
id|n
)braket
op_eq
l_int|0
)paren
id|n
op_decrement
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
op_le
id|n
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_logical_and
(paren
(paren
id|ii
op_mod
l_int|8
)paren
op_eq
l_int|0
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_INFO
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|m
(braket
id|ii
)braket
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|mf_dma_addr
op_assign
(paren
id|ioc-&gt;req_frames_low_dma
op_plus
id|req_offset
)paren
op_or
id|ioc-&gt;RequestNB
(braket
id|req_idx
)braket
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;mf_dma_addr=%x req_idx=%d RequestNB=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf_dma_addr
comma
id|req_idx
comma
id|ioc-&gt;RequestNB
(braket
id|req_idx
)braket
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;RequestFifo
comma
id|mf_dma_addr
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_free_msg_frame - Place MPT request frame back on FreeQ.&n; *&t;@handle: Handle of registered MPT protocol driver&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&t;@mf: Pointer to MPT request frame&n; *&n; *&t;This routine places a MPT request frame back on the MPT adapter&squot;s&n; *&t;FreeQ.&n; */
r_void
DECL|function|mpt_free_msg_frame
id|mpt_free_msg_frame
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*  Put Request back on FreeQ!  */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage.list
comma
op_amp
id|ioc-&gt;FreeQ
)paren
suffix:semicolon
macro_line|#ifdef MFCNT
id|ioc-&gt;mfcnt
op_decrement
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_add_sge - Place a simple SGE at address pAddr.&n; *&t;@pAddr: virtual address for SGE&n; *&t;@flagslength: SGE flags and data transfer length&n; *&t;@dma_addr: Physical address&n; *&n; *&t;This routine places a MPT request frame back on the MPT adapter&squot;s&n; *&t;FreeQ.&n; */
r_void
DECL|function|mpt_add_sge
id|mpt_add_sge
c_func
(paren
r_char
op_star
id|pAddr
comma
id|u32
id|flagslength
comma
id|dma_addr_t
id|dma_addr
)paren
(brace
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
(brace
id|SGESimple64_t
op_star
id|pSge
op_assign
(paren
id|SGESimple64_t
op_star
)paren
id|pAddr
suffix:semicolon
id|u32
id|tmp
op_assign
id|dma_addr
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pSge-&gt;FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
id|flagslength
)paren
suffix:semicolon
id|pSge-&gt;Address.Low
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|dma_addr
op_rshift
l_int|32
)paren
suffix:semicolon
id|pSge-&gt;Address.High
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_else
(brace
id|SGESimple32_t
op_star
id|pSge
op_assign
(paren
id|SGESimple32_t
op_star
)paren
id|pAddr
suffix:semicolon
id|pSge-&gt;FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
id|flagslength
)paren
suffix:semicolon
id|pSge-&gt;Address
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_send_handshake_request - Send MPT request via doorbell&n; *&t;handshake method.&n; *&t;@handle: Handle of registered MPT protocol driver&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&t;@reqBytes: Size of the request in bytes&n; *&t;@req: Pointer to MPT request frame&n; *&t;@sleepFlag: Use schedule if CAN_SLEEP else use udelay.&n; *&n; *&t;This routine is used exclusively to send MptScsiTaskMgmt&n; *&t;requests since they are required to be sent via doorbell handshake.&n; *&n; *&t;NOTE: It is the callers responsibility to byte-swap fields in the&n; *&t;request which are greater than 1 byte in size.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_int
DECL|function|mpt_send_handshake_request
id|mpt_send_handshake_request
c_func
(paren
r_int
id|handle
comma
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reqBytes
comma
id|u32
op_star
id|req
comma
r_int
id|sleepFlag
)paren
(brace
r_int
id|r
op_assign
l_int|0
suffix:semicolon
id|u8
op_star
id|req_as_bytes
suffix:semicolon
r_int
id|ii
suffix:semicolon
multiline_comment|/* State is known to be good upon entering&n;&t; * this function so issue the bus reset&n;&t; * request.&n;&t; */
multiline_comment|/*&n;&t; * Emulate what mpt_put_msg_frame() does /wrt to sanity&n;&t; * setting cb_idx/req_idx.  But ONLY if this request&n;&t; * is in proper (pre-alloc&squot;d) request buffer range...&n;&t; */
id|ii
op_assign
id|MFPTR_2_MPT_INDEX
c_func
(paren
id|ioc
comma
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reqBytes
op_ge
l_int|12
op_logical_and
id|ii
op_ge
l_int|0
op_logical_and
id|ii
OL
id|ioc-&gt;req_depth
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|req
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
op_assign
id|cpu_to_le16
c_func
(paren
id|ii
)paren
suffix:semicolon
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.cb_idx
op_assign
id|handle
suffix:semicolon
)brace
multiline_comment|/* Make sure there are no doorbells */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
comma
(paren
(paren
id|MPI_FUNCTION_HANDSHAKE
op_lshift
id|MPI_DOORBELL_FUNCTION_SHIFT
)paren
op_or
(paren
(paren
id|reqBytes
op_div
l_int|4
)paren
op_lshift
id|MPI_DOORBELL_ADD_DWORDS_SHIFT
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Wait for IOC doorbell int */
r_if
c_cond
(paren
(paren
id|ii
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|ii
suffix:semicolon
)brace
multiline_comment|/* Read doorbell and check for active bit */
r_if
c_cond
(paren
op_logical_neg
(paren
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
op_amp
id|MPI_DOORBELL_ACTIVE
)paren
)paren
r_return
op_minus
l_int|5
suffix:semicolon
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: mpt_send_handshake_request start, WaitCnt=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Send request via doorbell handshake */
id|req_as_bytes
op_assign
(paren
id|u8
op_star
)paren
id|req
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|reqBytes
op_div
l_int|4
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|u32
id|word
suffix:semicolon
id|word
op_assign
(paren
(paren
id|req_as_bytes
(braket
(paren
id|ii
op_star
l_int|4
)paren
op_plus
l_int|0
)braket
op_lshift
l_int|0
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|ii
op_star
l_int|4
)paren
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|ii
op_star
l_int|4
)paren
op_plus
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|ii
op_star
l_int|4
)paren
op_plus
l_int|3
)braket
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
comma
id|word
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
(brace
id|r
op_assign
op_minus
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|r
op_ge
l_int|0
op_logical_and
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|10
comma
id|sleepFlag
)paren
op_ge
l_int|0
)paren
id|r
op_assign
l_int|0
suffix:semicolon
r_else
id|r
op_assign
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* Make sure there are no doorbells */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_verify_adapter - Given a unique IOC identifier, set pointer to&n; *&t;the associated MPT adapter structure.&n; *&t;@iocid: IOC unique identifier (integer)&n; *&t;@iocpp: Pointer to pointer to IOC adapter&n; *&n; *&t;Returns iocid and sets iocpp.&n; */
r_int
DECL|function|mpt_verify_adapter
id|mpt_verify_adapter
c_func
(paren
r_int
id|iocid
comma
id|MPT_ADAPTER
op_star
op_star
id|iocpp
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|ioc
comma
op_amp
id|ioc_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;id
op_eq
id|iocid
)paren
(brace
op_star
id|iocpp
op_assign
id|ioc
suffix:semicolon
r_return
id|iocid
suffix:semicolon
)brace
)brace
op_star
id|iocpp
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptbase_probe - Install a PCI intelligent MPT adapter.&n; *&t;@pdev: Pointer to pci_dev structure&n; *&n; *&t;This routine performs all the steps necessary to bring the IOC of&n; *&t;a MPT adapter to a OPERATIONAL state.  This includes registering&n; *&t;memory regions, registering the interrupt, and allocating request&n; *&t;and reply memory pools.&n; *&n; *&t;This routine also pre-fetches the LAN MAC address of a Fibre Channel&n; *&t;MPT adapter.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; *&n; *&t;TODO: Add support for polled controllers&n; */
r_static
r_int
id|__devinit
DECL|function|mptbase_probe
id|mptbase_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
r_int
r_int
id|mem_phys
suffix:semicolon
r_int
r_int
id|port
suffix:semicolon
id|u32
id|msize
suffix:semicolon
id|u32
id|psize
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|r
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|u64
id|mask
op_assign
l_int|0xffffffffffffffffULL
suffix:semicolon
id|u8
id|revision
suffix:semicolon
id|u8
id|pcixcmd
suffix:semicolon
r_static
r_int
id|mpt_ids
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_struct
id|proc_dir_entry
op_star
id|dent
comma
op_star
id|ent
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_return
id|r
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mpt_adapter_install&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|mask
)paren
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: 64 BIT PCI BUS DMA ADDRESSING SUPPORTED&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
(paren
id|u64
)paren
l_int|0xffffffff
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: 32 BIT PCI BUS DMA ADDRESSING NOT SUPPORTED&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
id|mask
)paren
)paren
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Using 64 bit consistent mask&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Not using 64 bit consistent mask&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ioc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|MPT_ADAPTER
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Insufficient memory to add adapter!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ioc
comma
l_int|0
comma
r_sizeof
(paren
id|MPT_ADAPTER
)paren
)paren
suffix:semicolon
id|ioc-&gt;alloc_total
op_assign
r_sizeof
(paren
id|MPT_ADAPTER
)paren
suffix:semicolon
id|ioc-&gt;req_sz
op_assign
id|MPT_DEFAULT_FRAME_SIZE
suffix:semicolon
multiline_comment|/* avoid div by zero! */
id|ioc-&gt;reply_sz
op_assign
id|MPT_REPLY_FRAME_SIZE
suffix:semicolon
id|ioc-&gt;pcidev
op_assign
id|pdev
suffix:semicolon
id|ioc-&gt;diagPending
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ioc-&gt;diagLock
)paren
suffix:semicolon
multiline_comment|/* Initialize the event logging.&n;&t; */
id|ioc-&gt;eventTypes
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* None */
id|ioc-&gt;eventContext
op_assign
l_int|0
suffix:semicolon
id|ioc-&gt;eventLogSize
op_assign
l_int|0
suffix:semicolon
id|ioc-&gt;events
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef MFCNT
id|ioc-&gt;mfcnt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|ioc-&gt;cached_fw
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Initilize SCSI Config Data structure&n;&t; */
id|memset
c_func
(paren
op_amp
id|ioc-&gt;spi_data
comma
l_int|0
comma
r_sizeof
(paren
id|ScsiCfgData
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the running configQ head.&n;&t; */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioc-&gt;configQ
)paren
suffix:semicolon
multiline_comment|/* Find lookup slot. */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioc-&gt;list
)paren
suffix:semicolon
id|ioc-&gt;id
op_assign
id|mpt_ids
op_increment
suffix:semicolon
id|mem_phys
op_assign
id|msize
op_assign
l_int|0
suffix:semicolon
id|port
op_assign
id|psize
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
id|ii
)paren
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
multiline_comment|/* Get I/O space! */
id|port
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|ii
)paren
suffix:semicolon
id|psize
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|ii
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Get memmap */
id|mem_phys
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|ii
)paren
suffix:semicolon
id|msize
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|ii
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|ioc-&gt;mem_size
op_assign
id|msize
suffix:semicolon
r_if
c_cond
(paren
id|ii
op_eq
id|DEVICE_COUNT_RESOURCE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - MPT adapter has no memory regions defined!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT adapter @ %lx, msize=%dd bytes&bslash;n&quot;
comma
id|mem_phys
comma
id|msize
)paren
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: (port i/o @ %lx, psize=%dd bytes)&bslash;n&quot;
comma
id|port
comma
id|psize
)paren
)paren
suffix:semicolon
id|mem
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Get logical ptr for PciMem0 space */
multiline_comment|/*mem = ioremap(mem_phys, msize);*/
id|mem
op_assign
id|ioremap
c_func
(paren
id|mem_phys
comma
l_int|0x100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Unable to map adapter memory!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ioc-&gt;memmap
op_assign
id|mem
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: mem = %p, mem_phys = %lx&bslash;n&quot;
comma
id|mem
comma
id|mem_phys
)paren
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: facts @ %p, pfacts[0] @ %p&bslash;n&quot;
comma
op_amp
id|ioc-&gt;facts
comma
op_amp
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|ioc-&gt;mem_phys
op_assign
id|mem_phys
suffix:semicolon
id|ioc-&gt;chip
op_assign
(paren
id|SYSIF_REGS
op_star
)paren
id|mem
suffix:semicolon
multiline_comment|/* Save Port IO values in case we need to do downloadboot */
(brace
id|u8
op_star
id|pmem
op_assign
(paren
id|u8
op_star
)paren
id|port
suffix:semicolon
id|ioc-&gt;pio_mem_phys
op_assign
id|port
suffix:semicolon
id|ioc-&gt;pio_chip
op_assign
(paren
id|SYSIF_REGS
op_star
)paren
id|pmem
suffix:semicolon
)brace
id|ioc-&gt;chip_type
op_assign
id|FCUNK
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC909
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|FC909
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC909&quot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC929
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|FC929
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC929&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC919
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|FC919
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC919&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC929X
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|FC929X
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revision
OL
id|XL_929
)paren
(brace
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC929X&quot;
suffix:semicolon
multiline_comment|/* 929X Chip Fix. Set Split transactions level&n;&t;&t; &t;* for PCIX. Set MOST bits to zero.&n;&t;&t; &t;*/
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
l_int|0x6a
comma
op_amp
id|pcixcmd
)paren
suffix:semicolon
id|pcixcmd
op_and_assign
l_int|0x8F
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x6a
comma
id|pcixcmd
)paren
suffix:semicolon
)brace
r_else
(brace
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC929XL&quot;
suffix:semicolon
multiline_comment|/* 929XL Chip Fix. Set MMRBC to 0x08.&n;&t;&t; &t;*/
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
l_int|0x6a
comma
op_amp
id|pcixcmd
)paren
suffix:semicolon
id|pcixcmd
op_or_assign
l_int|0x08
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x6a
comma
id|pcixcmd
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVICEID_FC919X
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|FC919X
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSIFC919X&quot;
suffix:semicolon
multiline_comment|/* 919X Chip Fix. Set Split transactions level&n;&t;&t; * for PCIX. Set MOST bits to zero.&n;&t;&t; */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
l_int|0x6a
comma
op_amp
id|pcixcmd
)paren
suffix:semicolon
id|pcixcmd
op_and_assign
l_int|0x8F
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x6a
comma
id|pcixcmd
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVID_53C1030
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|C1030
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSI53C1030&quot;
suffix:semicolon
multiline_comment|/* 1030 Chip Fix. Disable Split transactions&n;&t;&t; * for PCIX. Set MOST bits to zero if Rev &lt; C0( = 8).&n;&t;&t; */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revision
OL
id|C0_1030
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
l_int|0x6a
comma
op_amp
id|pcixcmd
)paren
suffix:semicolon
id|pcixcmd
op_and_assign
l_int|0x8F
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x6a
comma
id|pcixcmd
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|MPI_MANUFACTPAGE_DEVID_1030_53C1035
)paren
(brace
id|ioc-&gt;chip_type
op_assign
id|C1035
suffix:semicolon
id|ioc-&gt;prod_name
op_assign
l_string|&quot;LSI53C1035&quot;
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|ioc-&gt;name
comma
l_string|&quot;ioc%d&quot;
comma
id|ioc-&gt;id
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
)paren
suffix:semicolon
multiline_comment|/* Disable all! */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set lookup ptr. */
id|list_add_tail
c_func
(paren
op_amp
id|ioc-&gt;list
comma
op_amp
id|ioc_list
)paren
suffix:semicolon
id|ioc-&gt;pci_irq
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;irq
)paren
(brace
id|r
op_assign
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|mpt_interrupt
comma
id|SA_SHIRQ
comma
id|ioc-&gt;name
comma
id|ioc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
(brace
macro_line|#ifndef __sparc__
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Unable to allocate interrupt %d!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Unable to allocate interrupt %s!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|__irq_itoa
c_func
(paren
id|pdev-&gt;irq
)paren
)paren
suffix:semicolon
macro_line|#endif
id|list_del
c_func
(paren
op_amp
id|ioc-&gt;list
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|mem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ioc-&gt;pci_irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* ?? */
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|ioc
)paren
suffix:semicolon
macro_line|#ifndef __sparc__
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s installed at interrupt %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pdev-&gt;irq
)paren
)paren
suffix:semicolon
macro_line|#else
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s installed at interrupt %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|__irq_itoa
c_func
(paren
id|pdev-&gt;irq
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* NEW!  20010220 -sralston&n;&t; * Check for &quot;bound ports&quot; (929, 929X, 1030, 1035) to reduce redundant resets.&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc-&gt;chip_type
op_eq
id|FC929
)paren
op_logical_or
(paren
id|ioc-&gt;chip_type
op_eq
id|C1030
)paren
op_logical_or
(paren
id|ioc-&gt;chip_type
op_eq
id|C1035
)paren
op_logical_or
(paren
id|ioc-&gt;chip_type
op_eq
id|FC929X
)paren
)paren
id|mpt_detect_bound_ports
c_func
(paren
id|ioc
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|mpt_do_ioc_recovery
c_func
(paren
id|ioc
comma
id|MPT_HOSTEVENT_IOC_BRINGUP
comma
id|CAN_SLEEP
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: WARNING - %s did not initialize properly! (%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|r
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ioc-&gt;list
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|ioc-&gt;pci_irq
comma
id|ioc
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|mem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* call per device driver probe entry point */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_PROTOCOL_DRIVERS
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_logical_and
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|probe
)paren
(brace
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|probe
c_func
(paren
id|pdev
comma
id|id
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n;&t; *  Create &quot;/proc/mpt/iocN&quot; subdirectory entry for each MPT adapter.&n;&t; */
id|dent
op_assign
id|proc_mkdir
c_func
(paren
id|ioc-&gt;name
comma
id|mpt_proc_root_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dent
)paren
(brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;info&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|dent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;read_proc
op_assign
id|procmpt_iocinfo_read
suffix:semicolon
id|ent-&gt;data
op_assign
id|ioc
suffix:semicolon
)brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;summary&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|dent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;read_proc
op_assign
id|procmpt_summary_read
suffix:semicolon
id|ent-&gt;data
op_assign
id|ioc
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptbase_remove - Remove a PCI intelligent MPT adapter.&n; *&t;@pdev: Pointer to pci_dev structure&n; *&n; */
r_static
r_void
id|__devexit
DECL|function|mptbase_remove
id|mptbase_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_char
id|pname
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|sprintf
c_func
(paren
id|pname
comma
id|MPT_PROCFS_MPTBASEDIR
l_string|&quot;/%s/summary&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|pname
comma
l_int|NULL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|pname
comma
id|MPT_PROCFS_MPTBASEDIR
l_string|&quot;/%s/info&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|pname
comma
l_int|NULL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|pname
comma
id|MPT_PROCFS_MPTBASEDIR
l_string|&quot;/%s&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|pname
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* call per device driver remove entry point */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_PROTOCOL_DRIVERS
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_logical_and
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|remove
)paren
(brace
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|remove
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Disable interrupts! */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
id|synchronize_irq
c_func
(paren
id|pdev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Clear any lingering interrupt */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
)paren
suffix:semicolon
id|mpt_adapter_dispose
c_func
(paren
id|ioc
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptbase_shutdown -&n; *&n; */
r_static
r_void
DECL|function|mptbase_shutdown
id|mptbase_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ii
suffix:semicolon
multiline_comment|/* call per device driver shutdown entry point */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_PROTOCOL_DRIVERS
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_logical_and
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|shutdown
)paren
(brace
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|shutdown
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**************************************************************************&n; * Power Management&n; */
macro_line|#ifdef CONFIG_PM
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptbase_suspend - Fusion MPT base driver suspend routine.&n; *&n; *&n; */
r_static
r_int
DECL|function|mptbase_suspend
id|mptbase_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
id|u32
id|device_state
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* S1 */
id|device_state
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* D1 */
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* S3 */
r_case
l_int|4
suffix:colon
multiline_comment|/* S4 */
id|device_state
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* D3 */
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EAGAIN
multiline_comment|/*FIXME*/
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;pci-suspend: pdev=0x%p, slot=%s, Entering operating state [D%d]&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pdev
comma
id|pci_name
c_func
(paren
id|pdev
)paren
comma
id|device_state
)paren
suffix:semicolon
multiline_comment|/* call per device driver suspend entry point */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_PROTOCOL_DRIVERS
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_logical_and
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|suspend
)paren
(brace
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|suspend
c_func
(paren
id|pdev
comma
id|state
)paren
suffix:semicolon
)brace
)brace
id|pci_save_state
c_func
(paren
id|pdev
comma
id|ioc-&gt;PciState
)paren
suffix:semicolon
multiline_comment|/* put ioc into READY_STATE */
r_if
c_cond
(paren
id|SendIocReset
c_func
(paren
id|ioc
comma
id|MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET
comma
id|CAN_SLEEP
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;pci-suspend:  IOC msg unit reset failed!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* disable interrupts */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear any lingering interrupt */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|pdev
comma
id|device_state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptbase_resume - Fusion MPT base driver resume routine.&n; *&n; *&n; */
r_static
r_int
DECL|function|mptbase_resume
id|mptbase_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|u32
id|device_state
op_assign
id|pdev-&gt;current_state
suffix:semicolon
r_int
id|recovery_state
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;pci-resume: pdev=0x%p, slot=%s, Previous operating state [D%d]&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pdev
comma
id|pci_name
c_func
(paren
id|pdev
)paren
comma
id|device_state
)paren
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|pci_restore_state
c_func
(paren
id|pdev
comma
id|ioc-&gt;PciState
)paren
suffix:semicolon
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* enable interrupts */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
op_complement
(paren
id|MPI_HIM_RIM
)paren
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* F/W not running */
r_if
c_cond
(paren
op_logical_neg
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
)paren
(brace
multiline_comment|/* enable domain validation flags */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_or_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;pci-resume: ioc-state=0x%x,doorbell=0x%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
op_rshift
id|MPI_IOC_STATE_SHIFT
)paren
comma
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
)paren
suffix:semicolon
multiline_comment|/* bring ioc to operational state */
r_if
c_cond
(paren
(paren
id|recovery_state
op_assign
id|mpt_do_ioc_recovery
c_func
(paren
id|ioc
comma
id|MPT_HOSTEVENT_IOC_RECOVER
comma
id|CAN_SLEEP
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;pci-resume: Cannot recover, error:[%x]&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|recovery_state
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;pci-resume: success&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* call per device driver resume entry point */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_PROTOCOL_DRIVERS
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_logical_and
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|resume
)paren
(brace
id|MptDeviceDriverHandlers
(braket
id|ii
)braket
op_member_access_from_pointer
id|resume
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_do_ioc_recovery - Initialize or recover MPT adapter.&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&t;@reason: Event word / reason&n; *&t;@sleepFlag: Use schedule if CAN_SLEEP else use udelay.&n; *&n; *&t;This routine performs all the steps necessary to bring the IOC&n; *&t;to a OPERATIONAL state.&n; *&n; *&t;This routine also pre-fetches the LAN MAC address of a Fibre Channel&n; *&t;MPT adapter.&n; *&n; *&t;Returns:&n; *&t;&t; 0 for success&n; *&t;&t;-1 if failed to get board READY&n; *&t;&t;-2 if READY but IOCFacts Failed&n; *&t;&t;-3 if READY but PrimeIOCFifos Failed&n; *&t;&t;-4 if READY but IOCInit Failed&n; */
r_static
r_int
DECL|function|mpt_do_ioc_recovery
id|mpt_do_ioc_recovery
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|reason
comma
r_int
id|sleepFlag
)paren
(brace
r_int
id|hard_reset_done
op_assign
l_int|0
suffix:semicolon
r_int
id|alt_ioc_ready
op_assign
l_int|0
suffix:semicolon
r_int
id|hard
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|handlers
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|reset_alt_ioc_active
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Initiating %s %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
ques
c_cond
l_string|&quot;bringup&quot;
suffix:colon
l_string|&quot;recovery&quot;
)paren
suffix:semicolon
multiline_comment|/* Disable reply interrupts (also blocks FreeQ) */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc-&gt;active
)paren
id|reset_alt_ioc_active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Disable alt-IOC&squot;s reply interrupts (and FreeQ) for a bit ... */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;alt_ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
id|hard
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
id|hard
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hard_reset_done
op_assign
id|MakeIocReady
c_func
(paren
id|ioc
comma
id|hard
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|hard_reset_done
op_eq
op_minus
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s Owned by PEER..skipping!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset_alt_ioc_active
op_logical_and
id|ioc-&gt;alt_ioc
)paren
(brace
multiline_comment|/* (re)Enable alt-IOC! (reply interrupt, FreeQ) */
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: alt-%s reply irq re-enabled&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;IntMask
comma
op_complement
(paren
id|MPI_HIM_RIM
)paren
)paren
suffix:semicolon
id|ioc-&gt;alt_ioc-&gt;active
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s NOT READY WARNING!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* hard_reset_done = 0 if a soft reset was performed&n;&t; * and 1 if a hard reset was performed.&n;&t; */
r_if
c_cond
(paren
id|hard_reset_done
op_logical_and
id|reset_alt_ioc_active
op_logical_and
id|ioc-&gt;alt_ioc
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|MakeIocReady
c_func
(paren
id|ioc-&gt;alt_ioc
comma
l_int|0
comma
id|sleepFlag
)paren
)paren
op_eq
l_int|0
)paren
id|alt_ioc_ready
op_assign
l_int|1
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: alt-%s: Not ready WARNING!&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|5
suffix:semicolon
id|ii
op_increment
)paren
(brace
multiline_comment|/* Get IOC facts! Allow 5 retries */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|GetIocFacts
c_func
(paren
id|ioc
comma
id|sleepFlag
comma
id|reason
)paren
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ii
op_eq
l_int|5
)paren
(brace
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Retry IocFacts failed rc=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|rc
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
(brace
id|MptDisplayIocCapabilities
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|alt_ioc_ready
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|GetIocFacts
c_func
(paren
id|ioc-&gt;alt_ioc
comma
id|sleepFlag
comma
id|reason
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Initial Alt IocFacts failed rc=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|rc
)paren
)paren
suffix:semicolon
multiline_comment|/* Retry - alt IOC was initialized once&n;&t;&t;&t; */
id|rc
op_assign
id|GetIocFacts
c_func
(paren
id|ioc-&gt;alt_ioc
comma
id|sleepFlag
comma
id|reason
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Retry Alt IocFacts failed rc=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|rc
)paren
)paren
suffix:semicolon
id|alt_ioc_ready
op_assign
l_int|0
suffix:semicolon
id|reset_alt_ioc_active
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
(brace
id|MptDisplayIocCapabilities
c_func
(paren
id|ioc-&gt;alt_ioc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Prime reply &amp; request queues!&n;&t; * (mucho alloc&squot;s) Must be done prior to&n;&t; * init as upper addresses are needed for init.&n;&t; * If fails, continue with alt-ioc processing&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|rc
op_assign
id|PrimeIocFifos
c_func
(paren
id|ioc
)paren
)paren
op_ne
l_int|0
)paren
)paren
id|ret
op_assign
op_minus
l_int|3
suffix:semicolon
multiline_comment|/* May need to check/upload firmware &amp; data here!&n;&t; * If fails, continue with alt-ioc processing&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|rc
op_assign
id|SendIocInit
c_func
(paren
id|ioc
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
)paren
id|ret
op_assign
op_minus
l_int|4
suffix:semicolon
singleline_comment|// NEW!
r_if
c_cond
(paren
id|alt_ioc_ready
op_logical_and
(paren
(paren
id|rc
op_assign
id|PrimeIocFifos
c_func
(paren
id|ioc-&gt;alt_ioc
)paren
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: alt-%s: (%d) FIFO mgmt alloc WARNING!&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|rc
)paren
suffix:semicolon
id|alt_ioc_ready
op_assign
l_int|0
suffix:semicolon
id|reset_alt_ioc_active
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|alt_ioc_ready
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|SendIocInit
c_func
(paren
id|ioc-&gt;alt_ioc
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|alt_ioc_ready
op_assign
l_int|0
suffix:semicolon
id|reset_alt_ioc_active
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: alt-%s: (%d) init failure WARNING!&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;upload_fw
)paren
(brace
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;firmware upload required!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Controller is not operational, cannot do upload&n;&t;&t;&t; */
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|mpt_do_upload
c_func
(paren
id|ioc
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: firmware upload failure!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Enable! (reply interrupt) */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
op_complement
(paren
id|MPI_HIM_RIM
)paren
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reset_alt_ioc_active
op_logical_and
id|ioc-&gt;alt_ioc
)paren
(brace
multiline_comment|/* (re)Enable alt-IOC! (reply interrupt) */
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: alt-%s reply irq re-enabled&bslash;n&quot;
comma
id|ioc-&gt;alt_ioc-&gt;name
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;IntMask
comma
op_complement
(paren
id|MPI_HIM_RIM
)paren
)paren
suffix:semicolon
id|ioc-&gt;alt_ioc-&gt;active
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* NEW!  20010120 -sralston&n;&t; *  Enable MPT base driver management of EventNotification&n;&t; *  and EventAck handling.&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
id|ioc-&gt;facts.EventState
)paren
)paren
(paren
r_void
)paren
id|SendEventNotification
c_func
(paren
id|ioc
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1=Enable EventNotification */
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
op_logical_and
id|alt_ioc_ready
op_logical_and
op_logical_neg
id|ioc-&gt;alt_ioc-&gt;facts.EventState
)paren
(paren
r_void
)paren
id|SendEventNotification
c_func
(paren
id|ioc-&gt;alt_ioc
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1=Enable EventNotification */
multiline_comment|/* (Bugzilla:fibrebugs, #513)&n;&t; * Bug fix (part 2)!  20010905 -sralston&n;&t; *&t;Add additional &quot;reason&quot; check before call to GetLanConfigPages&n;&t; *&t;(combined with GetIoUnitPage2 call).  This prevents a somewhat&n;&t; *&t;recursive scenario; GetLanConfigPages times out, timer expired&n;&t; *&t;routine calls HardResetHandler, which calls into here again,&n;&t; *&t;and we try GetLanConfigPages again...&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_and
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *  Pre-fetch FC port WWN and stuff...&n;&t;&t;&t; *  (FCPortPage0_t stuff)&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|ioc-&gt;facts.NumberOfPorts
suffix:semicolon
id|ii
op_increment
)paren
(brace
(paren
r_void
)paren
id|GetFcPortPage0
c_func
(paren
id|ioc
comma
id|ii
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
op_logical_and
(paren
id|ioc-&gt;lan_cnfg_page0.Header.PageLength
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *  Pre-fetch the ports LAN MAC address!&n;&t;&t;&t;&t; *  (LANPage1_t stuff)&n;&t;&t;&t;&t; */
(paren
r_void
)paren
id|GetLanConfigPages
c_func
(paren
id|ioc
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
(brace
id|u8
op_star
id|a
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|ioc-&gt;lan_cnfg_page1.HardwareAddressLow
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;LanAddr = %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|a
(braket
l_int|5
)braket
comma
id|a
(braket
l_int|4
)braket
comma
id|a
(braket
l_int|3
)braket
comma
id|a
(braket
l_int|2
)braket
comma
id|a
(braket
l_int|1
)braket
comma
id|a
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
r_else
(brace
multiline_comment|/* Get NVRAM and adapter maximums from SPP 0 and 2&n;&t;&t;&t; */
id|mpt_GetScsiPortSettings
c_func
(paren
id|ioc
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Get version and length of SDP 1&n;&t;&t;&t; */
id|mpt_readScsiDevicePageHeaders
c_func
(paren
id|ioc
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Find IM volumes&n;&t;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;facts.MsgVersion
op_ge
l_int|0x0102
)paren
id|mpt_findImVolumes
c_func
(paren
id|ioc
)paren
suffix:semicolon
multiline_comment|/* Check, and possibly reset, the coalescing value&n;&t;&t;&t; */
id|mpt_read_ioc_pg_1
c_func
(paren
id|ioc
)paren
suffix:semicolon
id|mpt_read_ioc_pg_4
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
id|GetIoUnitPage2
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Call each currently registered protocol IOC reset handler&n;&t; * with post-reset indication.&n;&t; * NOTE: If we&squot;re doing _IOC_BRINGUP, there can be no&n;&t; * MptResetHandlers[] registered yet.&n;&t; */
r_if
c_cond
(paren
id|hard_reset_done
)paren
(brace
id|rc
op_assign
id|handlers
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|ii
suffix:semicolon
id|ii
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_and
id|MptResetHandlers
(braket
id|ii
)braket
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Calling IOC post_reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
id|rc
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|ii
)braket
)paren
)paren
(paren
id|ioc
comma
id|MPT_IOC_POST_RESET
)paren
suffix:semicolon
id|handlers
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|alt_ioc_ready
op_logical_and
id|MptResetHandlers
(braket
id|ii
)braket
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Calling alt-%s post_reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
id|rc
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|ii
)braket
)paren
)paren
(paren
id|ioc-&gt;alt_ioc
comma
id|MPT_IOC_POST_RESET
)paren
suffix:semicolon
id|handlers
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* FIXME?  Examine results here? */
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_detect_bound_ports - Search for PCI bus/dev_function&n; *&t;which matches PCI bus/dev_function (+/-1) for newly discovered 929,&n; *&t;929X, 1030 or 1035.&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&t;@pdev: Pointer to (struct pci_dev) structure&n; *&n; *&t;If match on PCI dev_function +/-1 is found, bind the two MPT adapters&n; *&t;using alt_ioc pointer fields in their %MPT_ADAPTER structures.&n; */
r_static
r_void
DECL|function|mpt_detect_bound_ports
id|mpt_detect_bound_ports
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_int
r_int
id|match_lo
comma
id|match_hi
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc_srch
suffix:semicolon
id|match_lo
op_assign
id|pdev-&gt;devfn
op_minus
l_int|1
suffix:semicolon
id|match_hi
op_assign
id|pdev-&gt;devfn
op_plus
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;PCI bus/devfn=%x/%x, searching for devfn match on %x or %x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
comma
id|match_lo
comma
id|match_hi
)paren
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|ioc_srch
comma
op_amp
id|ioc_list
comma
id|list
)paren
(brace
r_struct
id|pci_dev
op_star
id|_pcidev
op_assign
id|ioc_srch-&gt;pcidev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|_pcidev-&gt;device
op_eq
id|pdev-&gt;device
)paren
op_logical_and
(paren
id|_pcidev-&gt;bus-&gt;number
op_eq
id|pdev-&gt;bus-&gt;number
)paren
op_logical_and
(paren
id|_pcidev-&gt;devfn
op_eq
id|match_lo
op_logical_or
id|_pcidev-&gt;devfn
op_eq
id|match_hi
)paren
)paren
(brace
multiline_comment|/* Paranoia checks */
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Oops, already bound (%s &lt;==&gt; %s)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;alt_ioc-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc_srch-&gt;alt_ioc
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Oops, already bound (%s &lt;==&gt; %s)!&bslash;n&quot;
comma
id|ioc_srch-&gt;name
comma
id|ioc_srch-&gt;alt_ioc-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: FOUND! binding %s &lt;==&gt; %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc_srch-&gt;name
)paren
)paren
suffix:semicolon
id|ioc_srch-&gt;alt_ioc
op_assign
id|ioc
suffix:semicolon
id|ioc-&gt;alt_ioc
op_assign
id|ioc_srch
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_adapter_disable - Disable misbehaving MPT adapter.&n; *&t;@this: Pointer to MPT adapter structure&n; */
r_static
r_void
DECL|function|mpt_adapter_disable
id|mpt_adapter_disable
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
r_int
id|sz
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
op_ne
l_int|NULL
)paren
(brace
id|ddlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: mpt_adapter_disable: Pushing FW onto adapter&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mpt_downloadboot
c_func
(paren
id|ioc
comma
id|NO_SLEEP
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: firmware downloadboot failure (%d)!&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Disable adapter interrupts! */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear any lingering interrupt */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alloc
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
id|ioc-&gt;alloc_sz
suffix:semicolon
id|dexitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.free  @ %p, sz=%d bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;alloc
comma
id|ioc-&gt;alloc_sz
)paren
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;alloc
comma
id|ioc-&gt;alloc_dma
)paren
suffix:semicolon
id|ioc-&gt;reply_frames
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;req_frames
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;sense_buf_pool
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|ioc-&gt;req_depth
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;sense_buf_pool
comma
id|ioc-&gt;sense_buf_pool_dma
)paren
suffix:semicolon
id|ioc-&gt;sense_buf_pool
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;events
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
id|MPTCTL_EVENT_LOG_SIZE
op_star
r_sizeof
(paren
id|MPT_IOCTL_EVENTS
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc-&gt;events
)paren
suffix:semicolon
id|ioc-&gt;events
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
id|ioc-&gt;facts.FWImageSize
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;cached_fw
comma
id|ioc-&gt;cached_fw_dma
)paren
suffix:semicolon
id|ioc-&gt;cached_fw
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.nvram
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|ioc-&gt;spi_data.nvram
)paren
suffix:semicolon
id|ioc-&gt;spi_data.nvram
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.pIocPg3
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|ioc-&gt;spi_data.pIocPg3
)paren
suffix:semicolon
id|ioc-&gt;spi_data.pIocPg3
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.pIocPg4
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
id|ioc-&gt;spi_data.IocPg4Sz
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;spi_data.pIocPg4
comma
id|ioc-&gt;spi_data.IocPg4_dma
)paren
suffix:semicolon
id|ioc-&gt;spi_data.pIocPg4
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;ReqToChain
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|ioc-&gt;ReqToChain
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc-&gt;RequestNB
)paren
suffix:semicolon
id|ioc-&gt;ReqToChain
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;ChainToChain
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|ioc-&gt;ChainToChain
)paren
suffix:semicolon
id|ioc-&gt;ChainToChain
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_adapter_dispose - Free all resources associated with a MPT&n; *&t;adapter.&n; *&t;@ioc: Pointer to MPT adapter structure&n; *&n; *&t;This routine unregisters h/w resources and frees all alloc&squot;d memory&n; *&t;associated with a MPT adapter structure.&n; */
r_static
r_void
DECL|function|mpt_adapter_dispose
id|mpt_adapter_dispose
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
r_if
c_cond
(paren
id|ioc
op_ne
l_int|NULL
)paren
(brace
r_int
id|sz_first
comma
id|sz_last
suffix:semicolon
id|sz_first
op_assign
id|ioc-&gt;alloc_total
suffix:semicolon
id|mpt_adapter_disable
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;pci_irq
op_ne
op_minus
l_int|1
)paren
(brace
id|free_irq
c_func
(paren
id|ioc-&gt;pci_irq
comma
id|ioc
)paren
suffix:semicolon
id|ioc-&gt;pci_irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;memmap
op_ne
l_int|NULL
)paren
id|iounmap
c_func
(paren
(paren
id|u8
op_star
)paren
id|ioc-&gt;memmap
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_MTRR) &amp;&amp; 0
r_if
c_cond
(paren
id|ioc-&gt;mtrr_reg
OG
l_int|0
)paren
(brace
id|mtrr_del
c_func
(paren
id|ioc-&gt;mtrr_reg
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: MTRR region de-registered&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*  Zap the adapter lookup ptr!  */
id|list_del
c_func
(paren
op_amp
id|ioc-&gt;list
)paren
suffix:semicolon
id|sz_last
op_assign
id|ioc-&gt;alloc_total
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: free&squot;d %d of %d bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|sz_first
op_minus
id|sz_last
op_plus
(paren
r_int
)paren
r_sizeof
(paren
op_star
id|ioc
)paren
comma
id|sz_first
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;MptDisplayIocCapabilities - Disply IOC&squot;s capacilities.&n; *&t;@ioc: Pointer to MPT adapter structure&n; */
r_static
r_void
DECL|function|MptDisplayIocCapabilities
id|MptDisplayIocCapabilities
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: &quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;prod_name
op_logical_and
id|strlen
c_func
(paren
id|ioc-&gt;prod_name
)paren
OG
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot;%s: &quot;
comma
id|ioc-&gt;prod_name
op_plus
l_int|3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Capabilities={&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_INITIATOR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Initiator&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_TARGET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%sTarget&quot;
comma
id|i
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%sLAN&quot;
comma
id|i
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n;&t; *  This would probably evoke more questions than it&squot;s worth&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_TARGET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%sLogBusAddr&quot;
comma
id|i
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;}&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;MakeIocReady - Get IOC to a READY state, using KickStart if needed.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@force: Force hard KickStart of IOC&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;Returns:&n; *&t;&t; 1 - DIAG reset and READY&n; *&t;&t; 0 - READY initially OR soft reset and READY&n; *&t;&t;-1 - Any failure on KickStart&n; *&t;&t;-2 - Msg Unit Reset Failed&n; *&t;&t;-3 - IO Unit Reset Failed&n; *&t;&t;-4 - IOC owned by a PEER&n; */
r_static
r_int
DECL|function|MakeIocReady
id|MakeIocReady
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|force
comma
r_int
id|sleepFlag
)paren
(brace
id|u32
id|ioc_state
suffix:semicolon
r_int
id|statefault
op_assign
l_int|0
suffix:semicolon
r_int
id|cntdn
suffix:semicolon
r_int
id|hard_reset_done
op_assign
l_int|0
suffix:semicolon
r_int
id|r
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|whoinit
suffix:semicolon
multiline_comment|/* Get current [raw] IOC state  */
id|ioc_state
op_assign
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|0
)paren
suffix:semicolon
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::MakeIocReady, %s [raw] state=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc_state
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check to see if IOC got left/stuck in doorbell handshake&n;&t; *&t;grip of death.  If so, hard reset the IOC.&n;&t; */
r_if
c_cond
(paren
id|ioc_state
op_amp
id|MPI_DOORBELL_ACTIVE
)paren
(brace
id|statefault
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Unexpected doorbell active!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Is it already READY? */
r_if
c_cond
(paren
op_logical_neg
id|statefault
op_logical_and
(paren
id|ioc_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_eq
id|MPI_IOC_STATE_READY
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
r_return
l_int|0
suffix:semicolon
r_else
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Workaround from broken 1030 FW.&n;&t;&t;&t; * Force a diagnostic reset if fails.&n;&t;&t;&t; */
multiline_comment|/*&t;&t;&t;if ((r = SendIocReset(ioc, MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET, sleepFlag)) == 0)&n;&t;&t;&t;&t;return 0;&n;&t;&t;&t;else&n;&t;&t;&t;&t;statefault = 4; */
)brace
)brace
multiline_comment|/*&n;&t; *&t;Check to see if IOC is in FAULT state.&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_eq
id|MPI_IOC_STATE_FAULT
)paren
(brace
id|statefault
op_assign
l_int|2
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;IOC is in FAULT state!!!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;           FAULT code = %04xh&bslash;n&quot;
comma
id|ioc_state
op_amp
id|MPI_DOORBELL_DATA_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Hmmm...  Did it get left operational?&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_eq
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;IOC operational unexpected&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Check WhoInit.&n;&t;&t; * If PCI Peer, exit.&n;&t;&t; * Else, if no fault conditions are present, issue a MessageUnitReset&n;&t;&t; * Else, fall through to KickStart case&n;&t;&t; */
id|whoinit
op_assign
(paren
id|ioc_state
op_amp
id|MPI_DOORBELL_WHO_INIT_MASK
)paren
op_rshift
id|MPI_DOORBELL_WHO_INIT_SHIFT
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: whoinit 0x%x&bslash;n statefault %d force %d&bslash;n&quot;
comma
id|whoinit
comma
id|statefault
comma
id|force
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|whoinit
op_eq
id|MPI_WHOINIT_PCI_PEER
)paren
r_return
op_minus
l_int|4
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
(paren
id|statefault
op_eq
l_int|0
)paren
op_logical_and
(paren
id|force
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendIocReset
c_func
(paren
id|ioc
comma
id|MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET
comma
id|sleepFlag
)paren
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|statefault
op_assign
l_int|3
suffix:semicolon
)brace
)brace
id|hard_reset_done
op_assign
id|KickStart
c_func
(paren
id|ioc
comma
id|statefault
op_logical_or
id|force
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hard_reset_done
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *  Loop here waiting for IOC to come READY.&n;&t; */
id|ii
op_assign
l_int|0
suffix:semicolon
id|cntdn
op_assign
(paren
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
ques
c_cond
id|HZ
suffix:colon
l_int|1000
)paren
op_star
l_int|15
suffix:semicolon
multiline_comment|/* 15 seconds */
r_while
c_loop
(paren
(paren
id|ioc_state
op_assign
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
)paren
op_ne
id|MPI_IOC_STATE_READY
)paren
(brace
r_if
c_cond
(paren
id|ioc_state
op_eq
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *  BIOS or previous driver load left IOC in OP state.&n;&t;&t;&t; *  Reset messaging FIFOs.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendIocReset
c_func
(paren
id|ioc
comma
id|MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;IOC msg unit reset failed!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ioc_state
op_eq
id|MPI_IOC_STATE_RESET
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *  Something is wrong.  Try to get IOC back&n;&t;&t;&t; *  to a known state.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendIocReset
c_func
(paren
id|ioc
comma
id|MPI_FUNCTION_IO_UNIT_RESET
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;IO unit reset failed!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
)brace
id|ii
op_increment
suffix:semicolon
id|cntdn
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cntdn
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Wait IOC_READY state timeout(%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
r_int
)paren
(paren
(paren
id|ii
op_plus
l_int|5
)paren
op_div
id|HZ
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 msec delay */
)brace
)brace
r_if
c_cond
(paren
id|statefault
OL
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Recovered from %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|statefault
op_eq
l_int|1
ques
c_cond
l_string|&quot;stuck handshake&quot;
suffix:colon
l_string|&quot;IOC FAULT&quot;
)paren
suffix:semicolon
)brace
r_return
id|hard_reset_done
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_GetIocState - Get the current state of a MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@cooked: Request raw or cooked IOC state&n; *&n; *&t;Returns all IOC Doorbell register bits if cooked==0, else just the&n; *&t;Doorbell bits in MPI_IOC_STATE_MASK.&n; */
id|u32
DECL|function|mpt_GetIocState
id|mpt_GetIocState
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|cooked
)paren
(brace
id|u32
id|s
comma
id|sc
suffix:semicolon
multiline_comment|/*  Get!  */
id|s
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
suffix:semicolon
singleline_comment|//&t;dprintk((MYIOC_s_INFO_FMT &quot;raw state = %08x&bslash;n&quot;, ioc-&gt;name, s));
id|sc
op_assign
id|s
op_amp
id|MPI_IOC_STATE_MASK
suffix:semicolon
multiline_comment|/*  Save!  */
id|ioc-&gt;last_state
op_assign
id|sc
suffix:semicolon
r_return
id|cooked
ques
c_cond
id|sc
suffix:colon
id|s
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetIocFacts - Send IOCFacts request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&t;@reason: If recovery, only update facts.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|GetIocFacts
id|GetIocFacts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
comma
r_int
id|reason
)paren
(brace
id|IOCFacts_t
id|get_facts
suffix:semicolon
id|IOCFactsReply_t
op_star
id|facts
suffix:semicolon
r_int
id|r
suffix:semicolon
r_int
id|req_sz
suffix:semicolon
r_int
id|reply_sz
suffix:semicolon
r_int
id|sz
suffix:semicolon
id|u32
id|status
comma
id|vv
suffix:semicolon
id|u8
id|shiftFactor
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* IOC *must* NOT be in RESET state! */
r_if
c_cond
(paren
id|ioc-&gt;last_state
op_eq
id|MPI_IOC_STATE_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Can&squot;t get IOCFacts, %s NOT READY! (%08x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;last_state
)paren
suffix:semicolon
r_return
op_minus
l_int|44
suffix:semicolon
)brace
id|facts
op_assign
op_amp
id|ioc-&gt;facts
suffix:semicolon
multiline_comment|/* Destination (reply area)... */
id|reply_sz
op_assign
r_sizeof
(paren
op_star
id|facts
)paren
suffix:semicolon
id|memset
c_func
(paren
id|facts
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
multiline_comment|/* Request area (get_facts on the stack right now!) */
id|req_sz
op_assign
r_sizeof
(paren
id|get_facts
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|get_facts
comma
l_int|0
comma
id|req_sz
)paren
suffix:semicolon
id|get_facts.Function
op_assign
id|MPI_FUNCTION_IOC_FACTS
suffix:semicolon
multiline_comment|/* Assert: All other get_facts fields are zero! */
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending get IocFacts request req_sz=%d reply_sz=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|req_sz
comma
id|reply_sz
)paren
)paren
suffix:semicolon
multiline_comment|/* No non-zero fields in the get_facts request are greater than&n;&t; * 1 byte in size, so we can just fire it off as is.&n;&t; */
id|r
op_assign
id|mpt_handshake_req_reply_wait
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|get_facts
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
id|facts
comma
l_int|5
multiline_comment|/*seconds*/
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_ne
l_int|0
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/*&n;&t; * Now byte swap (GRRR) the necessary fields before any further&n;&t; * inspection of reply contents.&n;&t; *&n;&t; * But need to do some sanity checks on MsgLength (byte) field&n;&t; * to make sure we don&squot;t zero IOC&squot;s req_sz!&n;&t; */
multiline_comment|/* Did we get a valid reply? */
r_if
c_cond
(paren
id|facts-&gt;MsgLength
OG
m_offsetof
(paren
id|IOCFactsReply_t
comma
id|RequestFrameSize
)paren
op_div
r_sizeof
(paren
id|u32
)paren
)paren
(brace
r_if
c_cond
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If not been here, done that, save off first WhoInit value&n;&t;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;FirstWhoInit
op_eq
id|WHOINIT_UNKNOWN
)paren
id|ioc-&gt;FirstWhoInit
op_assign
id|facts-&gt;WhoInit
suffix:semicolon
)brace
id|facts-&gt;MsgVersion
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;MsgVersion
)paren
suffix:semicolon
id|facts-&gt;MsgContext
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;MsgContext
)paren
suffix:semicolon
id|facts-&gt;IOCExceptions
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;IOCExceptions
)paren
suffix:semicolon
id|facts-&gt;IOCStatus
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;IOCStatus
)paren
suffix:semicolon
id|facts-&gt;IOCLogInfo
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;IOCLogInfo
)paren
suffix:semicolon
id|status
op_assign
id|facts-&gt;IOCStatus
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
multiline_comment|/* CHECKME! IOCStatus, IOCLogInfo */
id|facts-&gt;ReplyQueueDepth
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;ReplyQueueDepth
)paren
suffix:semicolon
id|facts-&gt;RequestFrameSize
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;RequestFrameSize
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FC f/w version changed between 1.1 and 1.2&n;&t;&t; *&t;Old: u16{Major(4),Minor(4),SubMinor(8)}&n;&t;&t; *&t;New: u32{Major(8),Minor(8),Unit(8),Dev(8)}&n;&t;&t; */
r_if
c_cond
(paren
id|facts-&gt;MsgVersion
OL
l_int|0x0102
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;Handle old FC f/w style, convert to new...&n;&t;&t;&t; */
id|u16
id|oldv
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;Reserved_0101_FWVersion
)paren
suffix:semicolon
id|facts-&gt;FWVersion.Word
op_assign
(paren
(paren
id|oldv
op_lshift
l_int|12
)paren
op_amp
l_int|0xFF000000
)paren
op_or
(paren
(paren
id|oldv
op_lshift
l_int|8
)paren
op_amp
l_int|0x000FFF00
)paren
suffix:semicolon
)brace
r_else
id|facts-&gt;FWVersion.Word
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;FWVersion.Word
)paren
suffix:semicolon
id|facts-&gt;ProductID
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;ProductID
)paren
suffix:semicolon
id|facts-&gt;CurrentHostMfaHighAddr
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;CurrentHostMfaHighAddr
)paren
suffix:semicolon
id|facts-&gt;GlobalCredits
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;GlobalCredits
)paren
suffix:semicolon
id|facts-&gt;CurrentSenseBufferHighAddr
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;CurrentSenseBufferHighAddr
)paren
suffix:semicolon
id|facts-&gt;CurReplyFrameSize
op_assign
id|le16_to_cpu
c_func
(paren
id|facts-&gt;CurReplyFrameSize
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Handle NEW (!) IOCFactsReply fields in MPI-1.01.xx&n;&t;&t; * Older MPI-1.00.xx struct had 13 dwords, and enlarged&n;&t;&t; * to 14 in MPI-1.01.0x.&n;&t;&t; */
r_if
c_cond
(paren
id|facts-&gt;MsgLength
op_ge
(paren
m_offsetof
(paren
id|IOCFactsReply_t
comma
id|FWImageSize
)paren
op_plus
l_int|7
)paren
op_div
l_int|4
op_logical_and
id|facts-&gt;MsgVersion
OG
l_int|0x0100
)paren
(brace
id|facts-&gt;FWImageSize
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;FWImageSize
)paren
suffix:semicolon
)brace
id|sz
op_assign
id|facts-&gt;FWImageSize
suffix:semicolon
r_if
c_cond
(paren
id|sz
op_amp
l_int|0x01
)paren
id|sz
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sz
op_amp
l_int|0x02
)paren
id|sz
op_add_assign
l_int|2
suffix:semicolon
id|facts-&gt;FWImageSize
op_assign
id|sz
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|facts-&gt;RequestFrameSize
)paren
(brace
multiline_comment|/*  Something is wrong!  */
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;IOC reported invalid 0 request size!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|55
suffix:semicolon
)brace
id|r
op_assign
id|sz
op_assign
id|le32_to_cpu
c_func
(paren
id|facts-&gt;BlockSize
)paren
suffix:semicolon
id|vv
op_assign
(paren
(paren
l_int|63
op_div
(paren
id|sz
op_star
l_int|4
)paren
)paren
op_plus
l_int|1
)paren
op_amp
l_int|0x03
suffix:semicolon
id|ioc-&gt;NB_for_64_byte_frame
op_assign
id|vv
suffix:semicolon
r_while
c_loop
(paren
id|sz
)paren
(brace
id|shiftFactor
op_increment
suffix:semicolon
id|sz
op_assign
id|sz
op_rshift
l_int|1
suffix:semicolon
)brace
id|ioc-&gt;NBShiftFactor
op_assign
id|shiftFactor
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;NB_for_64_byte_frame=%x NBShiftFactor=%x BlockSize=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|vv
comma
id|shiftFactor
comma
id|r
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_eq
id|MPT_HOSTEVENT_IOC_BRINGUP
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Set values for this IOC&squot;s request &amp; reply frame sizes,&n;&t;&t;&t; * and request &amp; reply queue depths...&n;&t;&t;&t; */
id|ioc-&gt;req_sz
op_assign
id|min
c_func
(paren
id|MPT_DEFAULT_FRAME_SIZE
comma
id|facts-&gt;RequestFrameSize
op_star
l_int|4
)paren
suffix:semicolon
id|ioc-&gt;req_depth
op_assign
id|min_t
c_func
(paren
r_int
comma
id|MPT_MAX_REQ_DEPTH
comma
id|facts-&gt;GlobalCredits
)paren
suffix:semicolon
id|ioc-&gt;reply_sz
op_assign
id|MPT_REPLY_FRAME_SIZE
suffix:semicolon
id|ioc-&gt;reply_depth
op_assign
id|min_t
c_func
(paren
r_int
comma
id|MPT_DEFAULT_REPLY_DEPTH
comma
id|facts-&gt;ReplyQueueDepth
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;reply_sz=%3d, reply_depth=%4d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;reply_sz
comma
id|ioc-&gt;reply_depth
)paren
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;req_sz  =%3d, req_depth  =%4d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;req_sz
comma
id|ioc-&gt;req_depth
)paren
)paren
suffix:semicolon
multiline_comment|/* Get port facts! */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|GetPortFacts
c_func
(paren
id|ioc
comma
l_int|0
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|r
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Invalid IOC facts reply, msgLength=%d offsetof=%zd!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|facts-&gt;MsgLength
comma
(paren
m_offsetof
(paren
id|IOCFactsReply_t
comma
id|RequestFrameSize
)paren
op_div
r_sizeof
(paren
id|u32
)paren
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|66
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetPortFacts - Send PortFacts request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@portnum: Port number&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|GetPortFacts
id|GetPortFacts
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
comma
r_int
id|sleepFlag
)paren
(brace
id|PortFacts_t
id|get_pfacts
suffix:semicolon
id|PortFactsReply_t
op_star
id|pfacts
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|req_sz
suffix:semicolon
r_int
id|reply_sz
suffix:semicolon
multiline_comment|/* IOC *must* NOT be in RESET state! */
r_if
c_cond
(paren
id|ioc-&gt;last_state
op_eq
id|MPI_IOC_STATE_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Can&squot;t get PortFacts, %s NOT READY! (%08x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;last_state
)paren
suffix:semicolon
r_return
op_minus
l_int|4
suffix:semicolon
)brace
id|pfacts
op_assign
op_amp
id|ioc-&gt;pfacts
(braket
id|portnum
)braket
suffix:semicolon
multiline_comment|/* Destination (reply area)...  */
id|reply_sz
op_assign
r_sizeof
(paren
op_star
id|pfacts
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pfacts
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
multiline_comment|/* Request area (get_pfacts on the stack right now!) */
id|req_sz
op_assign
r_sizeof
(paren
id|get_pfacts
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|get_pfacts
comma
l_int|0
comma
id|req_sz
)paren
suffix:semicolon
id|get_pfacts.Function
op_assign
id|MPI_FUNCTION_PORT_FACTS
suffix:semicolon
id|get_pfacts.PortNumber
op_assign
id|portnum
suffix:semicolon
multiline_comment|/* Assert: All other get_pfacts fields are zero! */
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending get PortFacts(%d) request&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|portnum
)paren
)paren
suffix:semicolon
multiline_comment|/* No non-zero fields in the get_pfacts request are greater than&n;&t; * 1 byte in size, so we can just fire it off as is.&n;&t; */
id|ii
op_assign
id|mpt_handshake_req_reply_wait
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|get_pfacts
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
id|pfacts
comma
l_int|5
multiline_comment|/*seconds*/
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ii
op_ne
l_int|0
)paren
r_return
id|ii
suffix:semicolon
multiline_comment|/* Did we get a valid reply? */
multiline_comment|/* Now byte swap the necessary fields in the response. */
id|pfacts-&gt;MsgContext
op_assign
id|le32_to_cpu
c_func
(paren
id|pfacts-&gt;MsgContext
)paren
suffix:semicolon
id|pfacts-&gt;IOCStatus
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;IOCStatus
)paren
suffix:semicolon
id|pfacts-&gt;IOCLogInfo
op_assign
id|le32_to_cpu
c_func
(paren
id|pfacts-&gt;IOCLogInfo
)paren
suffix:semicolon
id|pfacts-&gt;MaxDevices
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;MaxDevices
)paren
suffix:semicolon
id|pfacts-&gt;PortSCSIID
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;PortSCSIID
)paren
suffix:semicolon
id|pfacts-&gt;ProtocolFlags
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;ProtocolFlags
)paren
suffix:semicolon
id|pfacts-&gt;MaxPostedCmdBuffers
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;MaxPostedCmdBuffers
)paren
suffix:semicolon
id|pfacts-&gt;MaxPersistentIDs
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;MaxPersistentIDs
)paren
suffix:semicolon
id|pfacts-&gt;MaxLanBuckets
op_assign
id|le16_to_cpu
c_func
(paren
id|pfacts-&gt;MaxLanBuckets
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;SendIocInit - Send IOCInit request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;Send IOCInit followed by PortEnable to bring IOC to OPERATIONAL state.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|SendIocInit
id|SendIocInit
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
)paren
(brace
id|IOCInit_t
id|ioc_init
suffix:semicolon
id|MPIDefaultReply_t
id|init_reply
suffix:semicolon
id|u32
id|state
suffix:semicolon
r_int
id|r
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|cntdn
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ioc_init
comma
l_int|0
comma
r_sizeof
(paren
id|ioc_init
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|init_reply
comma
l_int|0
comma
r_sizeof
(paren
id|init_reply
)paren
)paren
suffix:semicolon
id|ioc_init.WhoInit
op_assign
id|MPI_WHOINIT_HOST_DRIVER
suffix:semicolon
id|ioc_init.Function
op_assign
id|MPI_FUNCTION_IOC_INIT
suffix:semicolon
multiline_comment|/* If we are in a recovery mode and we uploaded the FW image,&n;&t; * then this pointer is not NULL. Skip the upload a second time.&n;&t; * Set this flag if cached_fw set for either IOC.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;facts.Flags
op_amp
id|MPI_IOCFACTS_FLAGS_FW_DOWNLOAD_BOOT
)paren
id|ioc-&gt;upload_fw
op_assign
l_int|1
suffix:semicolon
r_else
id|ioc-&gt;upload_fw
op_assign
l_int|0
suffix:semicolon
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;upload_fw %d facts.Flags=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;upload_fw
comma
id|ioc-&gt;facts.Flags
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
(brace
id|ioc_init.MaxDevices
op_assign
id|MPT_MAX_FC_DEVICES
suffix:semicolon
)brace
r_else
(brace
id|ioc_init.MaxDevices
op_assign
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
)brace
id|ioc_init.MaxBuses
op_assign
id|MPT_MAX_BUS
suffix:semicolon
id|ioc_init.ReplyFrameSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ioc-&gt;reply_sz
)paren
suffix:semicolon
multiline_comment|/* in BYTES */
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
(brace
multiline_comment|/* Save the upper 32-bits of the request&n;&t;&t; * (reply) and sense buffers.&n;&t;&t; */
id|ioc_init.HostMfaHighAddr
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|ioc-&gt;alloc_dma
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
id|ioc_init.SenseBufferHighAddr
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|ioc-&gt;sense_buf_pool_dma
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Force 32-bit addressing */
id|ioc_init.HostMfaHighAddr
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ioc_init.SenseBufferHighAddr
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|ioc-&gt;facts.CurrentHostMfaHighAddr
op_assign
id|ioc_init.HostMfaHighAddr
suffix:semicolon
id|ioc-&gt;facts.CurrentSenseBufferHighAddr
op_assign
id|ioc_init.SenseBufferHighAddr
suffix:semicolon
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending IOCInit (req @ %p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
op_amp
id|ioc_init
)paren
)paren
suffix:semicolon
id|r
op_assign
id|mpt_handshake_req_reply_wait
c_func
(paren
id|ioc
comma
r_sizeof
(paren
id|IOCInit_t
)paren
comma
(paren
id|u32
op_star
)paren
op_amp
id|ioc_init
comma
r_sizeof
(paren
id|MPIDefaultReply_t
)paren
comma
(paren
id|u16
op_star
)paren
op_amp
id|init_reply
comma
l_int|10
multiline_comment|/*seconds*/
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_ne
l_int|0
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/* No need to byte swap the multibyte fields in the reply&n;&t; * since we don&squot;t even look at it&squot;s contents.&n;&t; */
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending PortEnable (req @ %p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
op_amp
id|ioc_init
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|SendPortEnable
c_func
(paren
id|ioc
comma
l_int|0
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/* YIKES!  SUPER IMPORTANT!!!&n;&t; *  Poll IocState until _OPERATIONAL while IOC is doing&n;&t; *  LoopInit and TargetDiscovery!&n;&t; */
id|count
op_assign
l_int|0
suffix:semicolon
id|cntdn
op_assign
(paren
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
ques
c_cond
id|HZ
suffix:colon
l_int|1000
)paren
op_star
l_int|60
suffix:semicolon
multiline_comment|/* 60 seconds */
id|state
op_assign
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|state
op_ne
id|MPI_IOC_STATE_OPERATIONAL
op_logical_and
op_decrement
id|cntdn
)paren
(brace
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cntdn
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Wait IOC_OP state timeout(%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
r_int
)paren
(paren
(paren
id|count
op_plus
l_int|5
)paren
op_div
id|HZ
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|9
suffix:semicolon
)brace
id|state
op_assign
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;INFO - Wait IOC_OPERATIONAL state (cnt=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
)paren
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;SendPortEnable - Send PortEnable request to MPT adapter port.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@portnum: Port number to enable&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;Send PortEnable to bring IOC to OPERATIONAL state.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|SendPortEnable
id|SendPortEnable
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
comma
r_int
id|sleepFlag
)paren
(brace
id|PortEnable_t
id|port_enable
suffix:semicolon
id|MPIDefaultReply_t
id|reply_buf
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|req_sz
suffix:semicolon
r_int
id|reply_sz
suffix:semicolon
multiline_comment|/*  Destination...  */
id|reply_sz
op_assign
r_sizeof
(paren
id|MPIDefaultReply_t
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|reply_buf
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
id|req_sz
op_assign
r_sizeof
(paren
id|PortEnable_t
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|port_enable
comma
l_int|0
comma
id|req_sz
)paren
suffix:semicolon
id|port_enable.Function
op_assign
id|MPI_FUNCTION_PORT_ENABLE
suffix:semicolon
id|port_enable.PortNumber
op_assign
id|portnum
suffix:semicolon
multiline_comment|/*&t;port_enable.ChainOffset = 0;&t;&t;*/
multiline_comment|/*&t;port_enable.MsgFlags = 0;&t;&t;*/
multiline_comment|/*&t;port_enable.MsgContext = 0;&t;&t;*/
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending Port(%d)Enable (req @ %p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|portnum
comma
op_amp
id|port_enable
)paren
)paren
suffix:semicolon
multiline_comment|/* RAID FW may take a long time to enable&n;&t; */
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
(brace
id|ii
op_assign
id|mpt_handshake_req_reply_wait
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|port_enable
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
op_amp
id|reply_buf
comma
l_int|65
multiline_comment|/*seconds*/
comma
id|sleepFlag
)paren
suffix:semicolon
)brace
r_else
(brace
id|ii
op_assign
id|mpt_handshake_req_reply_wait
c_func
(paren
id|ioc
comma
id|req_sz
comma
(paren
id|u32
op_star
)paren
op_amp
id|port_enable
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
op_amp
id|reply_buf
comma
l_int|300
multiline_comment|/*seconds*/
comma
id|sleepFlag
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ii
op_ne
l_int|0
)paren
r_return
id|ii
suffix:semicolon
multiline_comment|/* We do not even look at the reply, so we need not&n;&t; * swap the multi-byte fields.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;ioc: Pointer to MPT_ADAPTER structure&n; *      size - total FW bytes&n; */
r_void
DECL|function|mpt_alloc_fw_memory
id|mpt_alloc_fw_memory
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|size
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
)paren
r_return
suffix:semicolon
multiline_comment|/* use already allocated memory */
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
op_logical_and
id|ioc-&gt;alt_ioc-&gt;cached_fw
)paren
(brace
id|ioc-&gt;cached_fw
op_assign
id|ioc-&gt;alt_ioc-&gt;cached_fw
suffix:semicolon
multiline_comment|/* use alt_ioc&squot;s memory */
id|ioc-&gt;cached_fw_dma
op_assign
id|ioc-&gt;alt_ioc-&gt;cached_fw_dma
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|ioc-&gt;cached_fw
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|size
comma
op_amp
id|ioc-&gt;cached_fw_dma
)paren
)paren
)paren
id|ioc-&gt;alloc_total
op_add_assign
id|size
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * If alt_img is NULL, delete from ioc structure.&n; * Else, delete a secondary image in same format.&n; */
r_void
DECL|function|mpt_free_fw_memory
id|mpt_free_fw_memory
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
r_int
id|sz
suffix:semicolon
id|sz
op_assign
id|ioc-&gt;facts.FWImageSize
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;free_fw_memory: FW Image  @ %p[%p], sz=%d[%x] bytes&bslash;n&quot;
comma
id|ioc-&gt;cached_fw
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|ioc-&gt;cached_fw_dma
comma
id|sz
comma
id|sz
)paren
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;cached_fw
comma
id|ioc-&gt;cached_fw_dma
)paren
suffix:semicolon
id|ioc-&gt;cached_fw
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_do_upload - Construct and Send FWUpload request to MPT adapter port.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;Returns 0 for success, &gt;0 for handshake failure&n; *&t;&t;&lt;0 for fw upload failure.&n; *&n; *&t;Remark: If bound IOC and a successful FWUpload was performed&n; *&t;on the bound IOC, the second image is discarded&n; *&t;and memory is free&squot;d. Both channels must upload to prevent&n; *&t;IOC from running in degraded mode.&n; */
r_static
r_int
DECL|function|mpt_do_upload
id|mpt_do_upload
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
)paren
(brace
id|u8
id|request
(braket
id|ioc-&gt;req_sz
)braket
suffix:semicolon
id|u8
id|reply
(braket
r_sizeof
(paren
id|FWUploadReply_t
)paren
)braket
suffix:semicolon
id|FWUpload_t
op_star
id|prequest
suffix:semicolon
id|FWUploadReply_t
op_star
id|preply
suffix:semicolon
id|FWUploadTCSGE_t
op_star
id|ptcsge
suffix:semicolon
r_int
id|sgeoffset
suffix:semicolon
id|u32
id|flagsLength
suffix:semicolon
r_int
id|ii
comma
id|sz
comma
id|reply_sz
suffix:semicolon
r_int
id|cmdStatus
suffix:semicolon
multiline_comment|/* If the image size is 0, we are done.&n;&t; */
r_if
c_cond
(paren
(paren
id|sz
op_assign
id|ioc-&gt;facts.FWImageSize
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|mpt_alloc_fw_memory
c_func
(paren
id|ioc
comma
id|sz
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: FW Image  @ %p[%p], sz=%d[%x] bytes&bslash;n&quot;
comma
id|ioc-&gt;cached_fw
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|ioc-&gt;cached_fw_dma
comma
id|sz
comma
id|sz
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Major Failure.&n;&t;&t; */
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|prequest
op_assign
(paren
id|FWUpload_t
op_star
)paren
op_amp
id|request
suffix:semicolon
id|preply
op_assign
(paren
id|FWUploadReply_t
op_star
)paren
op_amp
id|reply
suffix:semicolon
multiline_comment|/*  Destination...  */
id|memset
c_func
(paren
id|prequest
comma
l_int|0
comma
id|ioc-&gt;req_sz
)paren
suffix:semicolon
id|reply_sz
op_assign
r_sizeof
(paren
id|reply
)paren
suffix:semicolon
id|memset
c_func
(paren
id|preply
comma
l_int|0
comma
id|reply_sz
)paren
suffix:semicolon
id|prequest-&gt;ImageType
op_assign
id|MPI_FW_UPLOAD_ITYPE_FW_IOC_MEM
suffix:semicolon
id|prequest-&gt;Function
op_assign
id|MPI_FUNCTION_FW_UPLOAD
suffix:semicolon
id|ptcsge
op_assign
(paren
id|FWUploadTCSGE_t
op_star
)paren
op_amp
id|prequest-&gt;SGL
suffix:semicolon
id|ptcsge-&gt;DetailsLength
op_assign
l_int|12
suffix:semicolon
id|ptcsge-&gt;Flags
op_assign
id|MPI_SGE_FLAGS_TRANSACTION_ELEMENT
suffix:semicolon
id|ptcsge-&gt;ImageSize
op_assign
id|cpu_to_le32
c_func
(paren
id|sz
)paren
suffix:semicolon
id|sgeoffset
op_assign
r_sizeof
(paren
id|FWUpload_t
)paren
op_minus
r_sizeof
(paren
id|SGE_MPI_UNION
)paren
op_plus
r_sizeof
(paren
id|FWUploadTCSGE_t
)paren
suffix:semicolon
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_READ
op_or
id|sz
suffix:semicolon
id|mpt_add_sge
c_func
(paren
op_amp
id|request
(braket
id|sgeoffset
)braket
comma
id|flagsLength
comma
id|ioc-&gt;cached_fw_dma
)paren
suffix:semicolon
id|sgeoffset
op_add_assign
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;Sending FW Upload (req @ %p) sgeoffset=%d &bslash;n&quot;
comma
id|prequest
comma
id|sgeoffset
)paren
)paren
suffix:semicolon
id|DBG_DUMP_FW_REQUEST_FRAME
c_func
(paren
id|prequest
)paren
id|ii
op_assign
id|mpt_handshake_req_reply_wait
c_func
(paren
id|ioc
comma
id|sgeoffset
comma
(paren
id|u32
op_star
)paren
id|prequest
comma
id|reply_sz
comma
(paren
id|u16
op_star
)paren
id|preply
comma
l_int|65
multiline_comment|/*seconds*/
comma
id|sleepFlag
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;FW Upload completed rc=%x &bslash;n&quot;
comma
id|ii
)paren
)paren
suffix:semicolon
id|cmdStatus
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ii
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Handshake transfer was complete and successful.&n;&t;&t; * Check the Reply Frame.&n;&t;&t; */
r_int
id|status
comma
id|transfer_sz
suffix:semicolon
id|status
op_assign
id|le16_to_cpu
c_func
(paren
id|preply-&gt;IOCStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|MPI_IOCSTATUS_SUCCESS
)paren
(brace
id|transfer_sz
op_assign
id|le32_to_cpu
c_func
(paren
id|preply-&gt;ActualImageSize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transfer_sz
op_eq
id|sz
)paren
id|cmdStatus
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: do_upload status %d &bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|cmdStatus
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdStatus
)paren
(brace
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: fw upload failed, freeing image &bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|mpt_free_fw_memory
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
r_return
id|cmdStatus
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_downloadboot - DownloadBoot code&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@flag: Specify which part of IOC memory is to be uploaded.&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;FwDownloadBoot requires Programmed IO access.&n; *&n; *&t;Returns 0 for success&n; *&t;&t;-1 FW Image size is 0&n; *&t;&t;-2 No valid cached_fw Pointer&n; *&t;&t;&lt;0 for fw upload failure.&n; */
r_static
r_int
DECL|function|mpt_downloadboot
id|mpt_downloadboot
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
)paren
(brace
id|MpiFwHeader_t
op_star
id|pFwHeader
suffix:semicolon
id|MpiExtImageHeader_t
op_star
id|pExtImage
suffix:semicolon
id|u32
id|fwSize
suffix:semicolon
id|u32
id|diag0val
suffix:semicolon
r_int
id|count
suffix:semicolon
id|u32
op_star
id|ptrFw
suffix:semicolon
id|u32
id|diagRwData
suffix:semicolon
id|u32
id|nextImage
suffix:semicolon
id|u32
id|load_addr
suffix:semicolon
id|u32
id|ioc_state
op_assign
l_int|0
suffix:semicolon
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;downloadboot: fw size 0x%x, ioc FW Ptr %p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;facts.FWImageSize
comma
id|ioc-&gt;cached_fw
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;facts.FWImageSize
op_eq
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* prevent a second downloadboot and memory free with alt_ioc */
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
op_logical_and
id|ioc-&gt;alt_ioc-&gt;cached_fw
)paren
id|ioc-&gt;alt_ioc-&gt;cached_fw
op_assign
l_int|NULL
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
l_int|0xFF
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_1ST_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_2ND_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_3RD_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_4TH_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_5TH_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
(paren
id|MPI_DIAG_PREVENT_IOC_BOOT
op_or
id|MPI_DIAG_DISABLE_ARM
)paren
)paren
suffix:semicolon
multiline_comment|/* wait 1 msec */
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
id|diag0val
op_or
id|MPI_DIAG_RESET_ADAPTER
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|30
suffix:semicolon
id|count
op_increment
)paren
(brace
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|diag0val
op_amp
id|MPI_DIAG_RESET_ADAPTER
)paren
)paren
(brace
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;RESET_ADAPTER cleared, count=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* wait 1 sec */
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1000
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|1000
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|30
)paren
(brace
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;downloadboot failed! Unable to RESET_ADAPTER diag0val=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
l_int|0xFF
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_1ST_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_2ND_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_3RD_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_4TH_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_5TH_KEY_VALUE
)paren
suffix:semicolon
multiline_comment|/* Set the DiagRwEn and Disable ARM bits */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
(paren
id|MPI_DIAG_RW_ENABLE
op_or
id|MPI_DIAG_DISABLE_ARM
)paren
)paren
suffix:semicolon
id|pFwHeader
op_assign
(paren
id|MpiFwHeader_t
op_star
)paren
id|ioc-&gt;cached_fw
suffix:semicolon
id|fwSize
op_assign
(paren
id|pFwHeader-&gt;ImageSize
op_plus
l_int|3
)paren
op_div
l_int|4
suffix:semicolon
id|ptrFw
op_assign
(paren
id|u32
op_star
)paren
id|pFwHeader
suffix:semicolon
multiline_comment|/* Write the LoadStartAddress to the DiagRw Address Register&n;&t; * using Programmed IO&n;&t; */
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwAddress
comma
id|pFwHeader-&gt;LoadStartAddress
)paren
suffix:semicolon
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;LoadStart addr written 0x%x &bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pFwHeader-&gt;LoadStartAddress
)paren
)paren
suffix:semicolon
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Write FW Image: 0x%x bytes @ %p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|fwSize
op_star
l_int|4
comma
id|ptrFw
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|fwSize
op_decrement
)paren
(brace
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwData
comma
op_star
id|ptrFw
op_increment
)paren
suffix:semicolon
)brace
id|nextImage
op_assign
id|pFwHeader-&gt;NextImageHeaderOffset
suffix:semicolon
r_while
c_loop
(paren
id|nextImage
)paren
(brace
id|pExtImage
op_assign
(paren
id|MpiExtImageHeader_t
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|pFwHeader
op_plus
id|nextImage
)paren
suffix:semicolon
id|load_addr
op_assign
id|pExtImage-&gt;LoadStartAddress
suffix:semicolon
id|fwSize
op_assign
(paren
id|pExtImage-&gt;ImageSize
op_plus
l_int|3
)paren
op_rshift
l_int|2
suffix:semicolon
id|ptrFw
op_assign
(paren
id|u32
op_star
)paren
id|pExtImage
suffix:semicolon
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Write Ext Image: 0x%x bytes @ %p load_addr=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|fwSize
op_star
l_int|4
comma
id|ptrFw
comma
id|load_addr
)paren
)paren
suffix:semicolon
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwAddress
comma
id|load_addr
)paren
suffix:semicolon
r_while
c_loop
(paren
id|fwSize
op_decrement
)paren
(brace
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwData
comma
op_star
id|ptrFw
op_increment
)paren
suffix:semicolon
)brace
id|nextImage
op_assign
id|pExtImage-&gt;NextImageHeaderOffset
suffix:semicolon
)brace
multiline_comment|/* Write the IopResetVectorRegAddr */
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Write IopResetVector Addr=%x! &bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pFwHeader-&gt;IopResetRegAddr
)paren
)paren
suffix:semicolon
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwAddress
comma
id|pFwHeader-&gt;IopResetRegAddr
)paren
suffix:semicolon
multiline_comment|/* Write the IopResetVectorValue */
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Write IopResetVector Value=%x! &bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pFwHeader-&gt;IopResetVectorValue
)paren
)paren
suffix:semicolon
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwData
comma
id|pFwHeader-&gt;IopResetVectorValue
)paren
suffix:semicolon
multiline_comment|/* Clear the internal flash bad bit - autoincrementing register,&n;&t; * so must do two writes.&n;&t; */
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwAddress
comma
l_int|0x3F000000
)paren
suffix:semicolon
id|diagRwData
op_assign
id|CHIPREG_PIO_READ32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwData
)paren
suffix:semicolon
id|diagRwData
op_or_assign
l_int|0x4000000
suffix:semicolon
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwAddress
comma
l_int|0x3F000000
)paren
suffix:semicolon
id|CHIPREG_PIO_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;pio_chip-&gt;DiagRwData
comma
id|diagRwData
)paren
suffix:semicolon
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;downloadboot diag0val=%x, turning off PREVENT_IOC_BOOT, DISABLE_ARM&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
)paren
)paren
suffix:semicolon
id|diag0val
op_and_assign
op_complement
(paren
id|MPI_DIAG_PREVENT_IOC_BOOT
op_or
id|MPI_DIAG_DISABLE_ARM
)paren
suffix:semicolon
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;downloadboot now diag0val=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
id|diag0val
)paren
suffix:semicolon
multiline_comment|/* Write 0xFF to reset the sequencer */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
l_int|0xFF
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|HZ
op_star
l_int|20
suffix:semicolon
id|count
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioc_state
op_assign
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|0
)paren
)paren
op_amp
id|MPI_IOC_STATE_READY
)paren
(brace
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;downloadboot successful! (count=%d) IocState=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
comma
id|ioc_state
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SendIocInit
c_func
(paren
id|ioc
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;downloadboot: SendIocInit failed&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;downloadboot: SendIocInit successful&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
id|ddlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;downloadboot failed! IocState=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc_state
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;KickStart - Perform hard reset of MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@force: Force hard reset&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;This routine places MPT adapter in diagnostic mode via the&n; *&t;WriteSequence register, and then performs a hard reset of adapter&n; *&t;via the Diagnostic register.&n; *&n; *&t;Inputs:   sleepflag - CAN_SLEEP (non-interrupt thread)&n; *&t;&t;&t;or NO_SLEEP (interrupt thread, use mdelay)&n; *&t;&t;  force - 1 if doorbell active, board fault state&n; *&t;&t;&t;&t;board operational, IOC_RECOVERY or&n; *&t;&t;&t;&t;IOC_BRINGUP and there is an alt_ioc.&n; *&t;&t;&t;  0 else&n; *&n; *&t;Returns:&n; *&t;&t; 1 - hard reset, READY&t;&n; *&t;&t; 0 - no reset due to History bit, READY&t;&n; *&t;&t;-1 - no reset due to History bit but not READY&t;&n; *&t;&t;     OR reset but failed to come READY&n; *&t;&t;-2 - no reset, could not enter DIAG mode&n; *&t;&t;-3 - reset but bad FW bit&n; */
r_static
r_int
DECL|function|KickStart
id|KickStart
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|force
comma
r_int
id|sleepFlag
)paren
(brace
r_int
id|hard_reset_done
op_assign
l_int|0
suffix:semicolon
id|u32
id|ioc_state
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
comma
id|cntdn
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: KickStarting %s!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
OG
(paren
r_int
)paren
id|FC929
)paren
(brace
multiline_comment|/* Always issue a Msg Unit Reset first. This will clear some&n;&t;&t; * SCSI bus hang conditions.&n;&t;&t; */
id|SendIocReset
c_func
(paren
id|ioc
comma
id|MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1000
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|1000
)paren
suffix:semicolon
)brace
)brace
id|hard_reset_done
op_assign
id|mpt_diag_reset
c_func
(paren
id|ioc
comma
id|force
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hard_reset_done
OL
l_int|0
)paren
r_return
id|hard_reset_done
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Diagnostic reset successful!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|cntdn
op_assign
(paren
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
ques
c_cond
id|HZ
suffix:colon
l_int|1000
)paren
op_star
l_int|2
suffix:semicolon
multiline_comment|/* 2 seconds */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|cntdn
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|ioc_state
op_assign
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc_state
op_eq
id|MPI_IOC_STATE_READY
)paren
op_logical_or
(paren
id|ioc_state
op_eq
id|MPI_IOC_STATE_OPERATIONAL
)paren
)paren
(brace
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;KickStart successful! (cnt=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|cnt
)paren
)paren
suffix:semicolon
r_return
id|hard_reset_done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Failed to come READY after reset! IocState=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc_state
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_diag_reset - Perform hard reset of the adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@ignore: Set if to honor and clear to ignore&n; *&t;&t;the reset history bit&n; *&t;@sleepflag: CAN_SLEEP if called in a non-interrupt thread,&n; *&t;&t;else set to NO_SLEEP (use mdelay instead)&n; *&n; *&t;This routine places the adapter in diagnostic mode via the&n; *&t;WriteSequence register and then performs a hard reset of adapter&n; *&t;via the Diagnostic register. Adapter should be in ready state&n; *&t;upon successful completion.&n; *&n; *&t;Returns:  1  hard reset successful&n; *&t;&t;  0  no reset performed because reset history bit set&n; *&t;&t; -2  enabling diagnostic mode failed&n; *&t;&t; -3  diagnostic reset failed&n; */
r_static
r_int
DECL|function|mpt_diag_reset
id|mpt_diag_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|ignore
comma
r_int
id|sleepFlag
)paren
(brace
id|u32
id|diag0val
suffix:semicolon
id|u32
id|doorbell
suffix:semicolon
r_int
id|hard_reset_done
op_assign
l_int|0
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
id|u32
id|diag1val
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Clear any existing interrupts */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use &quot;Diagnostic reset&quot; method! (only thing available!) */
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|diag1val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DbG1: diag0=%08x, diag1=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
comma
id|diag1val
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Do the reset if we are told to ignore the reset history&n;&t; * or if the reset history is 0&n;&t; */
r_if
c_cond
(paren
id|ignore
op_logical_or
op_logical_neg
(paren
id|diag0val
op_amp
id|MPI_DIAG_RESET_HISTORY
)paren
)paren
(brace
r_while
c_loop
(paren
(paren
id|diag0val
op_amp
id|MPI_DIAG_DRWE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Write magic sequence to WriteSequence register&n;&t;&t;&t; * Loop until in diagnostic mode&n;&t;&t;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
l_int|0xFF
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_1ST_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_2ND_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_3RD_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_4TH_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_5TH_KEY_VALUE
)paren
suffix:semicolon
multiline_comment|/* wait 100 msec */
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|100
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|100
)paren
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|20
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Enable Diagnostic mode FAILED! (%02xh)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Wrote magic DiagWriteEn sequence (%x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MPT_DEBUG
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|diag1val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DbG2: diag0=%08x, diag1=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
comma
id|diag1val
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t; * Disable the ARM (Bug fix)&n;&t;&t; *&n;&t;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
id|diag0val
op_or
id|MPI_DIAG_DISABLE_ARM
)paren
suffix:semicolon
id|mdelay
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Now hit the reset bit in the Diagnostic register&n;&t;&t; * (THE BIG HAMMER!) (Clears DRWE bit).&n;&t;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
id|diag0val
op_or
id|MPI_DIAG_RESET_ADAPTER
)paren
suffix:semicolon
id|hard_reset_done
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Diagnostic reset performed&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Call each currently registered protocol IOC reset handler&n;&t;&t; * with pre-reset indication.&n;&t;&t; * NOTE: If we&squot;re doing _IOC_BRINGUP, there can be no&n;&t;&t; * MptResetHandlers[] registered yet.&n;&t;&t; */
(brace
r_int
id|ii
suffix:semicolon
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|ii
suffix:semicolon
id|ii
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|MptResetHandlers
(braket
id|ii
)braket
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Calling IOC pre_reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|ii
)braket
)paren
)paren
(paren
id|ioc
comma
id|MPT_IOC_PRE_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Calling alt-%s pre_reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|ii
)braket
)paren
)paren
(paren
id|ioc-&gt;alt_ioc
comma
id|MPT_IOC_PRE_RESET
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* FIXME?  Examine results here? */
)brace
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
)paren
(brace
multiline_comment|/* If the DownloadBoot operation fails, the&n;&t;&t;&t; * IOC will be left unusable. This is a fatal error&n;&t;&t;&t; * case.  _diag_reset will return &lt; 0&n;&t;&t;&t; */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|30
suffix:semicolon
id|count
op_increment
)paren
(brace
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|diag0val
op_amp
id|MPI_DIAG_RESET_ADAPTER
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* wait 1 sec */
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1000
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|1000
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|count
op_assign
id|mpt_downloadboot
c_func
(paren
id|ioc
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: firmware downloadboot failure (%d)!&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Wait for FW to reload and for board&n;&t;&t;&t; * to go to the READY state.&n;&t;&t;&t; * Maximum wait is 60 seconds.&n;&t;&t;&t; * If fail, no error will check again&n;&t;&t;&t; * with calling program.&n;&t;&t;&t; */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|60
suffix:semicolon
id|count
op_increment
)paren
(brace
id|doorbell
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
suffix:semicolon
id|doorbell
op_and_assign
id|MPI_IOC_STATE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|doorbell
op_eq
id|MPI_IOC_STATE_READY
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* wait 1 sec */
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1000
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|1000
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|diag1val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DbG3: diag0=%08x, diag1=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
comma
id|diag1val
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Clear RESET_HISTORY bit!  Place board in the&n;&t; * diagnostic mode to update the diag register.&n;&t; */
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|diag0val
op_amp
id|MPI_DIAG_DRWE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Write magic sequence to WriteSequence register&n;&t;&t; * Loop until in diagnostic mode&n;&t;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
l_int|0xFF
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_1ST_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_2ND_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_3RD_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_4TH_KEY_VALUE
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
id|MPI_WRSEQ_5TH_KEY_VALUE
)paren
suffix:semicolon
multiline_comment|/* wait 100 msec */
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|100
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|100
)paren
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|20
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Enable Diagnostic mode FAILED! (%02xh)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
)brace
id|diag0val
op_and_assign
op_complement
id|MPI_DIAG_RESET_HISTORY
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
comma
id|diag0val
)paren
suffix:semicolon
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diag0val
op_amp
id|MPI_DIAG_RESET_HISTORY
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;ResetHistory bit failed to clear!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable Diagnostic Mode&n;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;WriteSequence
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
multiline_comment|/* Check FW reload status flags.&n;&t; */
id|diag0val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diag0val
op_amp
(paren
id|MPI_DIAG_FLASH_BAD_SIG
op_or
id|MPI_DIAG_RESET_ADAPTER
op_or
id|MPI_DIAG_DISABLE_ARM
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Diagnostic reset FAILED! (%02xh)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
macro_line|#ifdef MPT_DEBUG
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|diag1val
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;alt_ioc-&gt;chip-&gt;Diagnostic
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DbG4: diag0=%08x, diag1=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|diag0val
comma
id|diag1val
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Reset flag that says we&squot;ve enabled event notification&n;&t; */
id|ioc-&gt;facts.EventState
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|ioc-&gt;alt_ioc-&gt;facts.EventState
op_assign
l_int|0
suffix:semicolon
r_return
id|hard_reset_done
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;SendIocReset - Send IOCReset request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@reset_type: reset type, expected values are&n; *&t;%MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET or %MPI_FUNCTION_IO_UNIT_RESET&n; *&n; *&t;Send IOCReset request to the MPT adapter.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|SendIocReset
id|SendIocReset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u8
id|reset_type
comma
r_int
id|sleepFlag
)paren
(brace
r_int
id|r
suffix:semicolon
id|u32
id|state
suffix:semicolon
r_int
id|cntdn
comma
id|count
suffix:semicolon
id|drsprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: Sending IOC reset(0x%02x)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|reset_type
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
comma
id|reset_type
op_lshift
id|MPI_DOORBELL_FUNCTION_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/* FW ACK&squot;d request, wait for READY state&n;&t; */
id|count
op_assign
l_int|0
suffix:semicolon
id|cntdn
op_assign
(paren
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
ques
c_cond
id|HZ
suffix:colon
l_int|1000
)paren
op_star
l_int|15
suffix:semicolon
multiline_comment|/* 15 seconds */
r_while
c_loop
(paren
(paren
id|state
op_assign
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
)paren
op_ne
id|MPI_IOC_STATE_READY
)paren
(brace
id|cntdn
op_decrement
suffix:semicolon
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cntdn
)paren
(brace
r_if
c_cond
(paren
id|sleepFlag
op_ne
id|CAN_SLEEP
)paren
id|count
op_mul_assign
l_int|10
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: ERROR - Wait IOC_READY state timeout(%d)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
r_int
)paren
(paren
(paren
id|count
op_plus
l_int|5
)paren
op_div
id|HZ
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 msec delay */
)brace
)brace
multiline_comment|/* TODO!&n;&t; *  Cleanup all event stuff for this IOC; re-issue EventNotification&n;&t; *  request if needed.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;facts.Function
)paren
id|ioc-&gt;facts.EventState
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;initChainBuffers - Allocate memory for and initialize&n; *&t;chain buffers, chain buffer control arrays and spinlock.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@init: If set, initialize the spin lock.&n; */
r_static
r_int
DECL|function|initChainBuffers
id|initChainBuffers
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|u8
op_star
id|mem
suffix:semicolon
r_int
id|sz
comma
id|ii
comma
id|num_chain
suffix:semicolon
r_int
id|scale
comma
id|num_sge
comma
id|numSGE
suffix:semicolon
multiline_comment|/* ReqToChain size must equal the req_depth&n;&t; * index = req_idx&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;ReqToChain
op_eq
l_int|NULL
)paren
(brace
id|sz
op_assign
id|ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ioc-&gt;ReqToChain
op_assign
(paren
r_int
op_star
)paren
id|mem
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s ReqToChain alloc  @ %p, sz=%d bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mem
comma
id|sz
)paren
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ioc-&gt;RequestNB
op_assign
(paren
r_int
op_star
)paren
id|mem
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s RequestNB alloc  @ %p, sz=%d bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mem
comma
id|sz
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|ioc-&gt;req_depth
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|ioc-&gt;ReqToChain
(braket
id|ii
)braket
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
)brace
multiline_comment|/* ChainToChain size must equal the total number&n;&t; * of chain buffers to be allocated.&n;&t; * index = chain_idx&n;&t; *&n;&t; * Calculate the number of chain buffers needed(plus 1) per I/O&n;&t; * then multiply the the maximum number of simultaneous cmds&n;&t; *&n;&t; * num_sge = num sge in request frame + last chain buffer&n;&t; * scale = num sge per chain buffer if no chain element&n;&t; */
id|scale
op_assign
id|ioc-&gt;req_sz
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
id|num_sge
op_assign
id|scale
op_plus
(paren
id|ioc-&gt;req_sz
op_minus
l_int|60
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_else
id|num_sge
op_assign
l_int|1
op_plus
id|scale
op_plus
(paren
id|ioc-&gt;req_sz
op_minus
l_int|64
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
(brace
id|numSGE
op_assign
(paren
id|scale
op_minus
l_int|1
)paren
op_star
(paren
id|ioc-&gt;facts.MaxChainDepth
op_minus
l_int|1
)paren
op_plus
id|scale
op_plus
(paren
id|ioc-&gt;req_sz
op_minus
l_int|60
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|numSGE
op_assign
l_int|1
op_plus
(paren
id|scale
op_minus
l_int|1
)paren
op_star
(paren
id|ioc-&gt;facts.MaxChainDepth
op_minus
l_int|1
)paren
op_plus
id|scale
op_plus
(paren
id|ioc-&gt;req_sz
op_minus
l_int|64
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s num_sge=%d numSGE=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|num_sge
comma
id|numSGE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|numSGE
OG
id|MPT_SCSI_SG_DEPTH
)paren
id|numSGE
op_assign
id|MPT_SCSI_SG_DEPTH
suffix:semicolon
id|num_chain
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|numSGE
op_minus
id|num_sge
OG
l_int|0
)paren
(brace
id|num_chain
op_increment
suffix:semicolon
id|num_sge
op_add_assign
(paren
id|scale
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|num_chain
op_increment
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s Now numSGE=%d num_sge=%d num_chain=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|numSGE
comma
id|num_sge
comma
id|num_chain
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
OG
(paren
r_int
)paren
id|FC929
)paren
id|num_chain
op_mul_assign
id|MPT_SCSI_CAN_QUEUE
suffix:semicolon
r_else
id|num_chain
op_mul_assign
id|MPT_FC_CAN_QUEUE
suffix:semicolon
id|ioc-&gt;num_chain
op_assign
id|num_chain
suffix:semicolon
id|sz
op_assign
id|num_chain
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;ChainToChain
op_eq
l_int|NULL
)paren
(brace
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ioc-&gt;ChainToChain
op_assign
(paren
r_int
op_star
)paren
id|mem
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s ChainToChain alloc @ %p, sz=%d bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mem
comma
id|sz
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|mem
op_assign
(paren
id|u8
op_star
)paren
id|ioc-&gt;ChainToChain
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0xFF
comma
id|sz
)paren
suffix:semicolon
r_return
id|num_chain
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;PrimeIocFifos - Initialize IOC request and reply FIFOs.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&n; *&t;This routine allocates memory for the MPT reply and request frame&n; *&t;pools (if necessary), and primes the IOC reply FIFO with&n; *&t;reply frames.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|PrimeIocFifos
id|PrimeIocFifos
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dma_addr_t
id|alloc_dma
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
r_int
id|i
comma
id|reply_sz
comma
id|sz
comma
id|total_size
comma
id|num_chain
suffix:semicolon
multiline_comment|/*  Prime reply FIFO...  */
r_if
c_cond
(paren
id|ioc-&gt;reply_frames
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|num_chain
op_assign
id|initChainBuffers
c_func
(paren
id|ioc
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|total_size
op_assign
id|reply_sz
op_assign
(paren
id|ioc-&gt;reply_sz
op_star
id|ioc-&gt;reply_depth
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.ReplyBuffer sz=%d bytes, ReplyDepth=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;reply_sz
comma
id|ioc-&gt;reply_depth
)paren
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.ReplyBuffer sz=%d[%x] bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|reply_sz
comma
id|reply_sz
)paren
)paren
suffix:semicolon
id|sz
op_assign
(paren
id|ioc-&gt;req_sz
op_star
id|ioc-&gt;req_depth
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.RequestBuffer sz=%d bytes, RequestDepth=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;req_sz
comma
id|ioc-&gt;req_depth
)paren
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.RequestBuffer sz=%d[%x] bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|sz
comma
id|sz
)paren
)paren
suffix:semicolon
id|total_size
op_add_assign
id|sz
suffix:semicolon
id|sz
op_assign
id|num_chain
op_star
id|ioc-&gt;req_sz
suffix:semicolon
multiline_comment|/* chain buffer pool size */
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.ChainBuffer sz=%d bytes, ChainDepth=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;req_sz
comma
id|num_chain
)paren
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.ChainBuffer sz=%d[%x] bytes num_chain=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|sz
comma
id|sz
comma
id|num_chain
)paren
)paren
suffix:semicolon
id|total_size
op_add_assign
id|sz
suffix:semicolon
id|mem
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|total_size
comma
op_amp
id|alloc_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Unable to allocate Reply, Request, Chain Buffers!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.Total alloc @ %p[%p], sz=%d[%x] bytes&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mem
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|alloc_dma
comma
id|total_size
comma
id|total_size
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|total_size
)paren
suffix:semicolon
id|ioc-&gt;alloc_total
op_add_assign
id|total_size
suffix:semicolon
id|ioc-&gt;alloc
op_assign
id|mem
suffix:semicolon
id|ioc-&gt;alloc_dma
op_assign
id|alloc_dma
suffix:semicolon
id|ioc-&gt;alloc_sz
op_assign
id|total_size
suffix:semicolon
id|ioc-&gt;reply_frames
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|mem
suffix:semicolon
id|ioc-&gt;reply_frames_low_dma
op_assign
(paren
id|u32
)paren
(paren
id|alloc_dma
op_amp
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|alloc_dma
op_add_assign
id|reply_sz
suffix:semicolon
id|mem
op_add_assign
id|reply_sz
suffix:semicolon
multiline_comment|/*  Request FIFO - WE manage this!  */
id|ioc-&gt;req_frames
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|mem
suffix:semicolon
id|ioc-&gt;req_frames_dma
op_assign
id|alloc_dma
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.RequestBuffers @ %p[%p]&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mem
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|alloc_dma
)paren
)paren
suffix:semicolon
id|ioc-&gt;req_frames_low_dma
op_assign
(paren
id|u32
)paren
(paren
id|alloc_dma
op_amp
l_int|0xFFFFFFFF
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_MTRR) &amp;&amp; 0
multiline_comment|/*&n;&t;&t; *  Enable Write Combining MTRR for IOC&squot;s memory region.&n;&t;&t; *  (at least as much as we can; &quot;size and base must be&n;&t;&t; *  multiples of 4 kiB&quot;&n;&t;&t; */
id|ioc-&gt;mtrr_reg
op_assign
id|mtrr_add
c_func
(paren
id|ioc-&gt;req_frames_dma
comma
id|sz
comma
id|MTRR_TYPE_WRCOMB
comma
l_int|1
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;MTRR region registered (base:size=%08x:%x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;req_frames_dma
comma
id|sz
)paren
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ioc-&gt;req_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
id|alloc_dma
op_add_assign
id|ioc-&gt;req_sz
suffix:semicolon
id|mem
op_add_assign
id|ioc-&gt;req_sz
suffix:semicolon
)brace
id|ioc-&gt;ChainBuffer
op_assign
id|mem
suffix:semicolon
id|ioc-&gt;ChainBufferDMA
op_assign
id|alloc_dma
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot; :%s.ChainBuffers @ %p(%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;ChainBuffer
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|ioc-&gt;ChainBufferDMA
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the free chain Q.&n;&t; &t;*/
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioc-&gt;FreeChainQ
)paren
suffix:semicolon
multiline_comment|/* Post the chain buffers to the FreeChainQ.&n;&t; &t;*/
id|mem
op_assign
(paren
id|u8
op_star
)paren
id|ioc-&gt;ChainBuffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_chain
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mf
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|mem
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage.list
comma
op_amp
id|ioc-&gt;FreeChainQ
)paren
suffix:semicolon
id|mem
op_add_assign
id|ioc-&gt;req_sz
suffix:semicolon
)brace
multiline_comment|/* Initialize Request frames linked list&n;&t;&t; */
id|alloc_dma
op_assign
id|ioc-&gt;req_frames_dma
suffix:semicolon
id|mem
op_assign
(paren
id|u8
op_star
)paren
id|ioc-&gt;req_frames
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioc-&gt;FreeQ
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ioc-&gt;req_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mf
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|mem
suffix:semicolon
multiline_comment|/*  Queue REQUESTs *internally*!  */
id|list_add_tail
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage.list
comma
op_amp
id|ioc-&gt;FreeQ
)paren
suffix:semicolon
id|mem
op_add_assign
id|ioc-&gt;req_sz
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|sz
op_assign
(paren
id|ioc-&gt;req_depth
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
suffix:semicolon
id|ioc-&gt;sense_buf_pool
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
op_amp
id|ioc-&gt;sense_buf_pool_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sense_buf_pool
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Unable to allocate Sense Buffers!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|ioc-&gt;sense_buf_low_dma
op_assign
(paren
id|u32
)paren
(paren
id|ioc-&gt;sense_buf_pool_dma
op_amp
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|ioc-&gt;alloc_total
op_add_assign
id|sz
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.SenseBuffers @ %p[%p]&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;sense_buf_pool
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|ioc-&gt;sense_buf_pool_dma
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Post Reply frames to FIFO&n;&t; */
id|alloc_dma
op_assign
id|ioc-&gt;alloc_dma
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s.ReplyBuffers @ %p[%p]&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;reply_frames
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|alloc_dma
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ioc-&gt;reply_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/*  Write each address to the IOC!  */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;ReplyFifo
comma
id|alloc_dma
)paren
suffix:semicolon
id|alloc_dma
op_add_assign
id|ioc-&gt;reply_sz
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_fail
suffix:colon
r_if
c_cond
(paren
id|ioc-&gt;alloc
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
id|ioc-&gt;alloc_sz
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;alloc
comma
id|ioc-&gt;alloc_dma
)paren
suffix:semicolon
id|ioc-&gt;reply_frames
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;req_frames
op_assign
l_int|NULL
suffix:semicolon
id|ioc-&gt;alloc_total
op_sub_assign
id|sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;sense_buf_pool
op_ne
l_int|NULL
)paren
(brace
id|sz
op_assign
(paren
id|ioc-&gt;req_depth
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sz
comma
id|ioc-&gt;sense_buf_pool
comma
id|ioc-&gt;sense_buf_pool_dma
)paren
suffix:semicolon
id|ioc-&gt;sense_buf_pool
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_handshake_req_reply_wait - Send MPT request to and receive reply&n; *&t;from IOC via doorbell handshake method.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@reqBytes: Size of the request in bytes&n; *&t;@req: Pointer to MPT request frame&n; *&t;@replyBytes: Expected size of the reply in bytes&n; *&t;@u16reply: Pointer to area where reply should be written&n; *&t;@maxwait: Max wait time for a reply (in seconds)&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;NOTES: It is the callers responsibility to byte-swap fields in the&n; *&t;request which are greater than 1 byte in size.  It is also the&n; *&t;callers responsibility to byte-swap response fields which are&n; *&t;greater than 1 byte in size.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|mpt_handshake_req_reply_wait
id|mpt_handshake_req_reply_wait
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reqBytes
comma
id|u32
op_star
id|req
comma
r_int
id|replyBytes
comma
id|u16
op_star
id|u16reply
comma
r_int
id|maxwait
comma
r_int
id|sleepFlag
)paren
(brace
id|MPIDefaultReply_t
op_star
id|mptReply
suffix:semicolon
r_int
id|failcnt
op_assign
l_int|0
suffix:semicolon
r_int
id|t
suffix:semicolon
multiline_comment|/*&n;&t; * Get ready to cache a handshake reply&n;&t; */
id|ioc-&gt;hs_reply_idx
op_assign
l_int|0
suffix:semicolon
id|mptReply
op_assign
(paren
id|MPIDefaultReply_t
op_star
)paren
id|ioc-&gt;hs_reply
suffix:semicolon
id|mptReply-&gt;MsgLength
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure there are no doorbells (WRITE 0 to IntStatus reg),&n;&t; * then tell IOC that we want to handshake a request of N words.&n;&t; * (WRITE u32val to Doorbell reg).&n;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
comma
(paren
(paren
id|MPI_FUNCTION_HANDSHAKE
op_lshift
id|MPI_DOORBELL_FUNCTION_SHIFT
)paren
op_or
(paren
(paren
id|reqBytes
op_div
l_int|4
)paren
op_lshift
id|MPI_DOORBELL_ADD_DWORDS_SHIFT
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for IOC&squot;s doorbell handshake int&n;&t; */
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;HandShake request start reqBytes=%d, WaitCnt=%d%s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|reqBytes
comma
id|t
comma
id|failcnt
ques
c_cond
l_string|&quot; - MISSING DOORBELL HANDSHAKE!&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Read doorbell and check for active bit */
r_if
c_cond
(paren
op_logical_neg
(paren
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
op_amp
id|MPI_DOORBELL_ACTIVE
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Clear doorbell int (WRITE 0 to IntStatus reg),&n;&t; * then wait for IOC to ACKnowledge that it&squot;s ready for&n;&t; * our handshake request.&n;&t; */
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|failcnt
op_logical_and
(paren
id|t
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|failcnt
)paren
(brace
r_int
id|ii
suffix:semicolon
id|u8
op_star
id|req_as_bytes
op_assign
(paren
id|u8
op_star
)paren
id|req
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Stuff request words via doorbell handshake,&n;&t;&t; * with ACK from IOC for each.&n;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|failcnt
op_logical_and
id|ii
OL
id|reqBytes
op_div
l_int|4
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|u32
id|word
op_assign
(paren
(paren
id|req_as_bytes
(braket
(paren
id|ii
op_star
l_int|4
)paren
op_plus
l_int|0
)braket
op_lshift
l_int|0
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|ii
op_star
l_int|4
)paren
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|ii
op_star
l_int|4
)paren
op_plus
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|req_as_bytes
(braket
(paren
id|ii
op_star
l_int|4
)paren
op_plus
l_int|3
)braket
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
comma
id|word
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellAck
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
)brace
id|dhsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Handshake request frame (@%p) header&bslash;n&quot;
comma
id|req
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REQUEST_FRAME_HDR
c_func
(paren
id|req
)paren
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;HandShake request post done, WaitCnt=%d%s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|t
comma
id|failcnt
ques
c_cond
l_string|&quot; - MISSING DOORBELL ACK!&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Wait for completion of doorbell handshake reply from the IOC&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|failcnt
op_logical_and
(paren
id|t
op_assign
id|WaitForDoorbellReply
c_func
(paren
id|ioc
comma
id|maxwait
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;HandShake reply count=%d%s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|t
comma
id|failcnt
ques
c_cond
l_string|&quot; - MISSING DOORBELL REPLY!&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Copy out the cached reply...&n;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|min
c_func
(paren
id|replyBytes
op_div
l_int|2
comma
id|mptReply-&gt;MsgLength
op_star
l_int|2
)paren
suffix:semicolon
id|ii
op_increment
)paren
id|u16reply
(braket
id|ii
)braket
op_assign
id|ioc-&gt;hs_reply
(braket
id|ii
)braket
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|99
suffix:semicolon
)brace
r_return
op_minus
id|failcnt
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;WaitForDoorbellAck - Wait for IOC to clear the IOP_DOORBELL_STATUS bit&n; *&t;in it&squot;s IntStatus register.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@howlong: How long to wait (in seconds)&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;This routine waits (up to ~2 seconds max) for IOC doorbell&n; *&t;handshake ACKnowledge.&n; *&n; *&t;Returns a negative value on failure, else wait loop count.&n; */
r_static
r_int
DECL|function|WaitForDoorbellAck
id|WaitForDoorbellAck
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
comma
r_int
id|sleepFlag
)paren
(brace
r_int
id|cntdn
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|u32
id|intstat
op_assign
l_int|0
suffix:semicolon
id|cntdn
op_assign
(paren
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
ques
c_cond
id|HZ
suffix:colon
l_int|1000
)paren
op_star
id|howlong
suffix:semicolon
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
r_while
c_loop
(paren
op_decrement
id|cntdn
)paren
(brace
id|intstat
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|intstat
op_amp
id|MPI_HIS_IOP_DOORBELL_STATUS
)paren
)paren
r_break
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
op_decrement
id|cntdn
)paren
(brace
id|intstat
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|intstat
op_amp
id|MPI_HIS_IOP_DOORBELL_STATUS
)paren
)paren
r_break
suffix:semicolon
id|mdelay
(paren
l_int|1
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cntdn
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;WaitForDoorbell ACK (count=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Doorbell ACK timeout (count=%d), IntStatus=%x!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
comma
id|intstat
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;WaitForDoorbellInt - Wait for IOC to set the HIS_DOORBELL_INTERRUPT bit&n; *&t;in it&squot;s IntStatus register.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@howlong: How long to wait (in seconds)&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;This routine waits (up to ~2 seconds max) for IOC doorbell interrupt.&n; *&n; *&t;Returns a negative value on failure, else wait loop count.&n; */
r_static
r_int
DECL|function|WaitForDoorbellInt
id|WaitForDoorbellInt
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
comma
r_int
id|sleepFlag
)paren
(brace
r_int
id|cntdn
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|u32
id|intstat
op_assign
l_int|0
suffix:semicolon
id|cntdn
op_assign
(paren
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
ques
c_cond
id|HZ
suffix:colon
l_int|1000
)paren
op_star
id|howlong
suffix:semicolon
r_if
c_cond
(paren
id|sleepFlag
op_eq
id|CAN_SLEEP
)paren
(brace
r_while
c_loop
(paren
op_decrement
id|cntdn
)paren
(brace
id|intstat
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intstat
op_amp
id|MPI_HIS_DOORBELL_INTERRUPT
)paren
r_break
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
op_decrement
id|cntdn
)paren
(brace
id|intstat
op_assign
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intstat
op_amp
id|MPI_HIS_DOORBELL_INTERRUPT
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cntdn
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;WaitForDoorbell INT (cnt=%d) howlong=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
comma
id|howlong
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Doorbell INT timeout (count=%d), IntStatus=%x!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|count
comma
id|intstat
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;WaitForDoorbellReply - Wait for and capture a IOC handshake reply.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@howlong: How long to wait (in seconds)&n; *&t;@sleepFlag: Specifies whether the process can sleep&n; *&n; *&t;This routine polls the IOC for a handshake reply, 16 bits at a time.&n; *&t;Reply is cached to IOC private area large enough to hold a maximum&n; *&t;of 128 bytes of reply data.&n; *&n; *&t;Returns a negative value on failure, else size of reply in WORDS.&n; */
r_static
r_int
DECL|function|WaitForDoorbellReply
id|WaitForDoorbellReply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|howlong
comma
r_int
id|sleepFlag
)paren
(brace
r_int
id|u16cnt
op_assign
l_int|0
suffix:semicolon
r_int
id|failcnt
op_assign
l_int|0
suffix:semicolon
r_int
id|t
suffix:semicolon
id|u16
op_star
id|hs_reply
op_assign
id|ioc-&gt;hs_reply
suffix:semicolon
r_volatile
id|MPIDefaultReply_t
op_star
id|mptReply
op_assign
(paren
id|MPIDefaultReply_t
op_star
)paren
id|ioc-&gt;hs_reply
suffix:semicolon
id|u16
id|hword
suffix:semicolon
id|hs_reply
(braket
l_int|0
)braket
op_assign
id|hs_reply
(braket
l_int|1
)braket
op_assign
id|hs_reply
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Get first two u16&squot;s so we can look at IOC&squot;s intended reply MsgLength&n;&t; */
id|u16cnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
id|howlong
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
(brace
id|failcnt
op_increment
suffix:semicolon
)brace
r_else
(brace
id|hs_reply
(braket
id|u16cnt
op_increment
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
r_else
(brace
id|hs_reply
(braket
id|u16cnt
op_increment
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;WaitCnt=%d First handshake reply word=%08x%s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|t
comma
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
id|hs_reply
)paren
comma
id|failcnt
ques
c_cond
l_string|&quot; - MISSING DOORBELL HANDSHAKE!&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If no error (and IOC said MsgLength is &gt; 0), piece together&n;&t; * reply 16 bits at a time.&n;&t; */
r_for
c_loop
(paren
id|u16cnt
op_assign
l_int|2
suffix:semicolon
op_logical_neg
id|failcnt
op_logical_and
id|u16cnt
OL
(paren
l_int|2
op_star
id|mptReply-&gt;MsgLength
)paren
suffix:semicolon
id|u16cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
id|hword
op_assign
id|le16_to_cpu
c_func
(paren
id|CHIPREG_READ32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;Doorbell
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
multiline_comment|/* don&squot;t overflow our IOC hs_reply[] buffer! */
r_if
c_cond
(paren
id|u16cnt
OL
r_sizeof
(paren
id|ioc-&gt;hs_reply
)paren
op_div
r_sizeof
(paren
id|ioc-&gt;hs_reply
(braket
l_int|0
)braket
)paren
)paren
id|hs_reply
(braket
id|u16cnt
)braket
op_assign
id|hword
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|failcnt
op_logical_and
(paren
id|t
op_assign
id|WaitForDoorbellInt
c_func
(paren
id|ioc
comma
l_int|5
comma
id|sleepFlag
)paren
)paren
OL
l_int|0
)paren
id|failcnt
op_increment
suffix:semicolon
id|CHIPREG_WRITE32
c_func
(paren
op_amp
id|ioc-&gt;chip-&gt;IntStatus
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|failcnt
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Handshake reply failure!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|failcnt
suffix:semicolon
)brace
macro_line|#if 0
r_else
r_if
c_cond
(paren
id|u16cnt
op_ne
(paren
l_int|2
op_star
id|mptReply-&gt;MsgLength
)paren
)paren
(brace
r_return
op_minus
l_int|101
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|mptReply-&gt;IOCStatus
op_amp
id|MPI_IOCSTATUS_MASK
)paren
op_ne
id|MPI_IOCSTATUS_SUCCESS
)paren
(brace
r_return
op_minus
l_int|102
suffix:semicolon
)brace
macro_line|#endif
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Got Handshake reply:&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REPLY_FRAME
c_func
(paren
id|mptReply
)paren
id|dhsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;WaitForDoorbell REPLY WaitCnt=%d (sz=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|t
comma
id|u16cnt
op_div
l_int|2
)paren
)paren
suffix:semicolon
r_return
id|u16cnt
op_div
l_int|2
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetLanConfigPages - Fetch LANConfig pages.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&n; *&t;Return: 0 for success&n; *&t;-ENOMEM if no memory available&n; *&t;&t;-EPERM if not allowed due to ISR context&n; *&t;&t;-EAGAIN if no msg frames currently available&n; *&t;&t;-EFAULT for non-successful reply or no reply (timeout)&n; */
r_static
r_int
DECL|function|GetLanConfigPages
id|GetLanConfigPages
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|ConfigPageHeader_t
id|hdr
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|LANPage0_t
op_star
id|ppage0_alloc
suffix:semicolon
id|dma_addr_t
id|page0_dma
suffix:semicolon
id|LANPage1_t
op_star
id|ppage1_alloc
suffix:semicolon
id|dma_addr_t
id|page1_dma
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|data_sz
suffix:semicolon
r_int
id|copy_sz
suffix:semicolon
multiline_comment|/* Get LAN Page 0 header */
id|hdr.PageVersion
op_assign
l_int|0
suffix:semicolon
id|hdr.PageLength
op_assign
l_int|0
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|0
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_LAN
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|hdr.PageLength
OG
l_int|0
)paren
(brace
id|data_sz
op_assign
id|hdr.PageLength
op_star
l_int|4
suffix:semicolon
id|ppage0_alloc
op_assign
(paren
id|LANPage0_t
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
op_amp
id|page0_dma
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|ppage0_alloc
)paren
(brace
id|memset
c_func
(paren
(paren
id|u8
op_star
)paren
id|ppage0_alloc
comma
l_int|0
comma
id|data_sz
)paren
suffix:semicolon
id|cfg.physAddr
op_assign
id|page0_dma
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* save the data */
id|copy_sz
op_assign
id|min_t
c_func
(paren
r_int
comma
r_sizeof
(paren
id|LANPage0_t
)paren
comma
id|data_sz
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ioc-&gt;lan_cnfg_page0
comma
id|ppage0_alloc
comma
id|copy_sz
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
(paren
id|u8
op_star
)paren
id|ppage0_alloc
comma
id|page0_dma
)paren
suffix:semicolon
multiline_comment|/* FIXME!&n;&t;&t;&t; *&t;Normalize endianness of structure data,&n;&t;&t;&t; *&t;by byte-swapping all &gt; 1 byte fields!&n;&t;&t;&t; */
)brace
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Get LAN Page 1 header */
id|hdr.PageVersion
op_assign
l_int|0
suffix:semicolon
id|hdr.PageLength
op_assign
l_int|0
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|1
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_LAN
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|hdr.PageLength
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|data_sz
op_assign
id|hdr.PageLength
op_star
l_int|4
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|ppage1_alloc
op_assign
(paren
id|LANPage1_t
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
op_amp
id|page1_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppage1_alloc
)paren
(brace
id|memset
c_func
(paren
(paren
id|u8
op_star
)paren
id|ppage1_alloc
comma
l_int|0
comma
id|data_sz
)paren
suffix:semicolon
id|cfg.physAddr
op_assign
id|page1_dma
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* save the data */
id|copy_sz
op_assign
id|min_t
c_func
(paren
r_int
comma
r_sizeof
(paren
id|LANPage1_t
)paren
comma
id|data_sz
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ioc-&gt;lan_cnfg_page1
comma
id|ppage1_alloc
comma
id|copy_sz
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
(paren
id|u8
op_star
)paren
id|ppage1_alloc
comma
id|page1_dma
)paren
suffix:semicolon
multiline_comment|/* FIXME!&n;&t;&t; *&t;Normalize endianness of structure data,&n;&t;&t; *&t;by byte-swapping all &gt; 1 byte fields!&n;&t;&t; */
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetFcPortPage0 - Fetch FCPort config Page0.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@portnum: IOC Port number&n; *&n; *&t;Return: 0 for success&n; *&t;-ENOMEM if no memory available&n; *&t;&t;-EPERM if not allowed due to ISR context&n; *&t;&t;-EAGAIN if no msg frames currently available&n; *&t;&t;-EFAULT for non-successful reply or no reply (timeout)&n; */
r_static
r_int
DECL|function|GetFcPortPage0
id|GetFcPortPage0
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
(brace
id|ConfigPageHeader_t
id|hdr
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|FCPortPage0_t
op_star
id|ppage0_alloc
suffix:semicolon
id|FCPortPage0_t
op_star
id|pp0dest
suffix:semicolon
id|dma_addr_t
id|page0_dma
suffix:semicolon
r_int
id|data_sz
suffix:semicolon
r_int
id|copy_sz
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Get FCPort Page 0 header */
id|hdr.PageVersion
op_assign
l_int|0
suffix:semicolon
id|hdr.PageLength
op_assign
l_int|0
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|0
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_FC_PORT
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.pageAddr
op_assign
id|portnum
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|hdr.PageLength
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|data_sz
op_assign
id|hdr.PageLength
op_star
l_int|4
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|ppage0_alloc
op_assign
(paren
id|FCPortPage0_t
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
op_amp
id|page0_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppage0_alloc
)paren
(brace
id|memset
c_func
(paren
(paren
id|u8
op_star
)paren
id|ppage0_alloc
comma
l_int|0
comma
id|data_sz
)paren
suffix:semicolon
id|cfg.physAddr
op_assign
id|page0_dma
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* save the data */
id|pp0dest
op_assign
op_amp
id|ioc-&gt;fc_port_page0
(braket
id|portnum
)braket
suffix:semicolon
id|copy_sz
op_assign
id|min_t
c_func
(paren
r_int
comma
r_sizeof
(paren
id|FCPortPage0_t
)paren
comma
id|data_sz
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pp0dest
comma
id|ppage0_alloc
comma
id|copy_sz
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Normalize endianness of structure data,&n;&t;&t;&t; *&t;by byte-swapping all &gt; 1 byte fields!&n;&t;&t;&t; */
id|pp0dest-&gt;Flags
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;Flags
)paren
suffix:semicolon
id|pp0dest-&gt;PortIdentifier
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;PortIdentifier
)paren
suffix:semicolon
id|pp0dest-&gt;WWNN.Low
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;WWNN.Low
)paren
suffix:semicolon
id|pp0dest-&gt;WWNN.High
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;WWNN.High
)paren
suffix:semicolon
id|pp0dest-&gt;WWPN.Low
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;WWPN.Low
)paren
suffix:semicolon
id|pp0dest-&gt;WWPN.High
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;WWPN.High
)paren
suffix:semicolon
id|pp0dest-&gt;SupportedServiceClass
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;SupportedServiceClass
)paren
suffix:semicolon
id|pp0dest-&gt;SupportedSpeeds
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;SupportedSpeeds
)paren
suffix:semicolon
id|pp0dest-&gt;CurrentSpeed
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;CurrentSpeed
)paren
suffix:semicolon
id|pp0dest-&gt;MaxFrameSize
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;MaxFrameSize
)paren
suffix:semicolon
id|pp0dest-&gt;FabricWWNN.Low
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;FabricWWNN.Low
)paren
suffix:semicolon
id|pp0dest-&gt;FabricWWNN.High
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;FabricWWNN.High
)paren
suffix:semicolon
id|pp0dest-&gt;FabricWWPN.Low
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;FabricWWPN.Low
)paren
suffix:semicolon
id|pp0dest-&gt;FabricWWPN.High
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;FabricWWPN.High
)paren
suffix:semicolon
id|pp0dest-&gt;DiscoveredPortsCount
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;DiscoveredPortsCount
)paren
suffix:semicolon
id|pp0dest-&gt;MaxInitiators
op_assign
id|le32_to_cpu
c_func
(paren
id|pp0dest-&gt;MaxInitiators
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
(paren
id|u8
op_star
)paren
id|ppage0_alloc
comma
id|page0_dma
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;GetIoUnitPage2 - Retrieve BIOS version and boot order information.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&n; *&t;Returns: 0 for success&n; *&t;-ENOMEM if no memory available&n; *&t;&t;-EPERM if not allowed due to ISR context&n; *&t;&t;-EAGAIN if no msg frames currently available&n; *&t;&t;-EFAULT for non-successful reply or no reply (timeout)&n; */
r_static
r_int
DECL|function|GetIoUnitPage2
id|GetIoUnitPage2
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|ConfigPageHeader_t
id|hdr
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|IOUnitPage2_t
op_star
id|ppage_alloc
suffix:semicolon
id|dma_addr_t
id|page_dma
suffix:semicolon
r_int
id|data_sz
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Get the page header */
id|hdr.PageVersion
op_assign
l_int|0
suffix:semicolon
id|hdr.PageLength
op_assign
l_int|0
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|2
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_IO_UNIT
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|hdr.PageLength
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Read the config page */
id|data_sz
op_assign
id|hdr.PageLength
op_star
l_int|4
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|ppage_alloc
op_assign
(paren
id|IOUnitPage2_t
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
op_amp
id|page_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppage_alloc
)paren
(brace
id|memset
c_func
(paren
(paren
id|u8
op_star
)paren
id|ppage_alloc
comma
l_int|0
comma
id|data_sz
)paren
suffix:semicolon
id|cfg.physAddr
op_assign
id|page_dma
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
multiline_comment|/* If Good, save data */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_eq
l_int|0
)paren
id|ioc-&gt;biosVersion
op_assign
id|le32_to_cpu
c_func
(paren
id|ppage_alloc-&gt;BiosVersion
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
(paren
id|u8
op_star
)paren
id|ppage_alloc
comma
id|page_dma
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mpt_GetScsiPortSettings - read SCSI Port Page 0 and 2&n; *&t;@ioc: Pointer to a Adapter Strucutre&n; *&t;@portnum: IOC port number&n; *&n; *&t;Return: -EFAULT if read of config page header fails&n; *&t;&t;&t;or if no nvram&n; *&t;If read of SCSI Port Page 0 fails,&n; *&t;&t;NVRAM = MPT_HOST_NVRAM_INVALID  (0xFFFFFFFF)&n; *&t;&t;Adapter settings: async, narrow&n; *&t;&t;Return 1&n; *&t;If read of SCSI Port Page 2 fails,&n; *&t;&t;Adapter settings valid&n; *&t;&t;NVRAM = MPT_HOST_NVRAM_INVALID  (0xFFFFFFFF)&n; *&t;&t;Return 1&n; *&t;Else&n; *&t;&t;Both valid&n; *&t;&t;Return 0&n; *&t;CHECK - what type of locking mechanisms should be used????&n; */
r_static
r_int
DECL|function|mpt_GetScsiPortSettings
id|mpt_GetScsiPortSettings
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
(brace
id|u8
op_star
id|pbuf
suffix:semicolon
id|dma_addr_t
id|buf_dma
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|header
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|data
comma
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allocate memory&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;spi_data.nvram
)paren
(brace
r_int
id|sz
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
id|sz
op_assign
id|MPT_MAX_SCSI_DEVICES
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ioc-&gt;spi_data.nvram
op_assign
(paren
r_int
op_star
)paren
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SCSI device NVRAM settings @ %p, sz=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;spi_data.nvram
comma
id|sz
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Invalidate NVRAM information&n;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|ioc-&gt;spi_data.nvram
(braket
id|ii
)braket
op_assign
id|MPT_HOST_NVRAM_INVALID
suffix:semicolon
)brace
multiline_comment|/* Read SPP0 header, allocate memory, then read page.&n;&t; */
id|header.PageVersion
op_assign
l_int|0
suffix:semicolon
id|header.PageLength
op_assign
l_int|0
suffix:semicolon
id|header.PageNumber
op_assign
l_int|0
suffix:semicolon
id|header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_PORT
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
id|portnum
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* use default */
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|header.PageLength
OG
l_int|0
)paren
(brace
id|pbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|header.PageLength
op_star
l_int|4
comma
op_amp
id|buf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pbuf
)paren
(brace
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|cfg.physAddr
op_assign
id|buf_dma
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
(brace
id|ioc-&gt;spi_data.maxBusWidth
op_assign
id|MPT_NARROW
suffix:semicolon
id|ioc-&gt;spi_data.maxSyncOffset
op_assign
l_int|0
suffix:semicolon
id|ioc-&gt;spi_data.minSyncFactor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|ioc-&gt;spi_data.busType
op_assign
id|MPT_HOST_BUS_UNKNOWN
suffix:semicolon
id|rc
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Save the Port Page 0 data&n;&t;&t;&t;&t; */
id|SCSIPortPage0_t
op_star
id|pPP0
op_assign
(paren
id|SCSIPortPage0_t
op_star
)paren
id|pbuf
suffix:semicolon
id|pPP0-&gt;Capabilities
op_assign
id|le32_to_cpu
c_func
(paren
id|pPP0-&gt;Capabilities
)paren
suffix:semicolon
id|pPP0-&gt;PhysicalInterface
op_assign
id|le32_to_cpu
c_func
(paren
id|pPP0-&gt;PhysicalInterface
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pPP0-&gt;Capabilities
op_amp
id|MPI_SCSIPORTPAGE0_CAP_QAS
)paren
op_eq
l_int|0
)paren
(brace
id|ioc-&gt;spi_data.noQas
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot; :%s noQas due to Capabilities=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pPP0-&gt;Capabilities
)paren
)paren
suffix:semicolon
)brace
id|ioc-&gt;spi_data.maxBusWidth
op_assign
id|pPP0-&gt;Capabilities
op_amp
id|MPI_SCSIPORTPAGE0_CAP_WIDE
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|data
op_assign
id|pPP0-&gt;Capabilities
op_amp
id|MPI_SCSIPORTPAGE0_CAP_MAX_SYNC_OFFSET_MASK
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
(brace
id|ioc-&gt;spi_data.maxSyncOffset
op_assign
(paren
id|u8
)paren
(paren
id|data
op_rshift
l_int|16
)paren
suffix:semicolon
id|data
op_assign
id|pPP0-&gt;Capabilities
op_amp
id|MPI_SCSIPORTPAGE0_CAP_MIN_SYNC_PERIOD_MASK
suffix:semicolon
id|ioc-&gt;spi_data.minSyncFactor
op_assign
(paren
id|u8
)paren
(paren
id|data
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|ioc-&gt;spi_data.maxSyncOffset
op_assign
l_int|0
suffix:semicolon
id|ioc-&gt;spi_data.minSyncFactor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
id|ioc-&gt;spi_data.busType
op_assign
id|pPP0-&gt;PhysicalInterface
op_amp
id|MPI_SCSIPORTPAGE0_PHY_SIGNAL_TYPE_MASK
suffix:semicolon
multiline_comment|/* Update the minSyncFactor based on bus type.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|ioc-&gt;spi_data.busType
op_eq
id|MPI_SCSIPORTPAGE0_PHY_SIGNAL_HVD
)paren
op_logical_or
(paren
id|ioc-&gt;spi_data.busType
op_eq
id|MPI_SCSIPORTPAGE0_PHY_SIGNAL_SE
)paren
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.minSyncFactor
OL
id|MPT_ULTRA
)paren
id|ioc-&gt;spi_data.minSyncFactor
op_assign
id|MPT_ULTRA
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pbuf
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|header.PageLength
op_star
l_int|4
comma
id|pbuf
comma
id|buf_dma
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* SCSI Port Page 2 - Read the header then the page.&n;&t; */
id|header.PageVersion
op_assign
l_int|0
suffix:semicolon
id|header.PageLength
op_assign
l_int|0
suffix:semicolon
id|header.PageNumber
op_assign
l_int|2
suffix:semicolon
id|header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_PORT
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
id|portnum
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|header.PageLength
OG
l_int|0
)paren
(brace
multiline_comment|/* Allocate memory and read SCSI Port Page 2&n;&t;&t; */
id|pbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|header.PageLength
op_star
l_int|4
comma
op_amp
id|buf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pbuf
)paren
(brace
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_NVRAM
suffix:semicolon
id|cfg.physAddr
op_assign
id|buf_dma
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Nvram data is left with INVALID mark&n;&t;&t;&t;&t; */
id|rc
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|SCSIPortPage2_t
op_star
id|pPP2
op_assign
(paren
id|SCSIPortPage2_t
op_star
)paren
id|pbuf
suffix:semicolon
id|MpiDeviceInfo_t
op_star
id|pdevice
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Save the Port Page 2 data&n;&t;&t;&t;&t; * (reformat into a 32bit quantity)&n;&t;&t;&t;&t; */
id|data
op_assign
id|le32_to_cpu
c_func
(paren
id|pPP2-&gt;PortFlags
)paren
op_amp
id|MPI_SCSIPORTPAGE2_PORT_FLAGS_DV_MASK
suffix:semicolon
id|ioc-&gt;spi_data.PortFlags
op_assign
id|data
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|pdevice
op_assign
op_amp
id|pPP2-&gt;DeviceSettings
(braket
id|ii
)braket
suffix:semicolon
id|data
op_assign
(paren
id|le16_to_cpu
c_func
(paren
id|pdevice-&gt;DeviceFlags
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|pdevice-&gt;SyncFactor
op_lshift
l_int|8
)paren
op_or
id|pdevice-&gt;Timeout
suffix:semicolon
id|ioc-&gt;spi_data.nvram
(braket
id|ii
)braket
op_assign
id|data
suffix:semicolon
)brace
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|header.PageLength
op_star
l_int|4
comma
id|pbuf
comma
id|buf_dma
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Update Adapter limits with those from NVRAM&n;&t; * Comment: Don&squot;t need to do this. Target performance&n;&t; * parameters will never exceed the adapters limits.&n;&t; */
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mpt_readScsiDevicePageHeaders - save version and length of SDP1&n; *&t;@ioc: Pointer to a Adapter Strucutre&n; *&t;@portnum: IOC port number&n; *&n; *&t;Return: -EFAULT if read of config page header fails&n; *&t;&t;or 0 if success.&n; */
r_static
r_int
DECL|function|mpt_readScsiDevicePageHeaders
id|mpt_readScsiDevicePageHeaders
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|portnum
)paren
(brace
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|header
suffix:semicolon
multiline_comment|/* Read the SCSI Device Page 1 header&n;&t; */
id|header.PageVersion
op_assign
l_int|0
suffix:semicolon
id|header.PageLength
op_assign
l_int|0
suffix:semicolon
id|header.PageNumber
op_assign
l_int|1
suffix:semicolon
id|header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
id|portnum
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ioc-&gt;spi_data.sdp1version
op_assign
id|cfg.hdr-&gt;PageVersion
suffix:semicolon
id|ioc-&gt;spi_data.sdp1length
op_assign
id|cfg.hdr-&gt;PageLength
suffix:semicolon
id|header.PageVersion
op_assign
l_int|0
suffix:semicolon
id|header.PageLength
op_assign
l_int|0
suffix:semicolon
id|header.PageNumber
op_assign
l_int|0
suffix:semicolon
id|header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ioc-&gt;spi_data.sdp0version
op_assign
id|cfg.hdr-&gt;PageVersion
suffix:semicolon
id|ioc-&gt;spi_data.sdp0length
op_assign
id|cfg.hdr-&gt;PageLength
suffix:semicolon
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Headers: 0: version %d length %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;spi_data.sdp0version
comma
id|ioc-&gt;spi_data.sdp0length
)paren
)paren
suffix:semicolon
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Headers: 1: version %d length %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;spi_data.sdp1version
comma
id|ioc-&gt;spi_data.sdp1length
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_findImVolumes - Identify IDs of hidden disks and RAID Volumes&n; *&t;@ioc: Pointer to a Adapter Strucutre&n; *&t;@portnum: IOC port number&n; *&n; *&t;Return:&n; *&t;0 on success&n; *&t;-EFAULT if read of config page header fails or data pointer not NULL&n; *&t;-ENOMEM if pci_alloc failed&n; */
r_int
DECL|function|mpt_findImVolumes
id|mpt_findImVolumes
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|IOCPage2_t
op_star
id|pIoc2
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
id|ConfigPageIoc2RaidVol_t
op_star
id|pIocRv
suffix:semicolon
id|dma_addr_t
id|ioc2_dma
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|header
suffix:semicolon
r_int
id|jj
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|iocpage2sz
suffix:semicolon
id|u8
id|nVols
comma
id|nPhys
suffix:semicolon
id|u8
id|vid
comma
id|vbus
comma
id|vioc
suffix:semicolon
multiline_comment|/* Read IOCP2 header then the page.&n;&t; */
id|header.PageVersion
op_assign
l_int|0
suffix:semicolon
id|header.PageLength
op_assign
l_int|0
suffix:semicolon
id|header.PageNumber
op_assign
l_int|2
suffix:semicolon
id|header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_IOC
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|header.PageLength
op_eq
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|iocpage2sz
op_assign
id|header.PageLength
op_star
l_int|4
suffix:semicolon
id|pIoc2
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|iocpage2sz
comma
op_amp
id|ioc2_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pIoc2
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|cfg.physAddr
op_assign
id|ioc2_dma
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|done_and_free
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mem
op_assign
(paren
id|u8
op_star
)paren
id|ioc-&gt;spi_data.pIocPg2
)paren
op_eq
l_int|NULL
)paren
(brace
id|mem
op_assign
id|kmalloc
c_func
(paren
id|iocpage2sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|ioc-&gt;spi_data.pIocPg2
op_assign
(paren
id|IOCPage2_t
op_star
)paren
id|mem
suffix:semicolon
)brace
r_else
(brace
r_goto
id|done_and_free
suffix:semicolon
)brace
)brace
id|memcpy
c_func
(paren
id|mem
comma
(paren
id|u8
op_star
)paren
id|pIoc2
comma
id|iocpage2sz
)paren
suffix:semicolon
multiline_comment|/* Identify RAID Volume Id&squot;s */
id|nVols
op_assign
id|pIoc2-&gt;NumActiveVolumes
suffix:semicolon
r_if
c_cond
(paren
id|nVols
op_eq
l_int|0
)paren
(brace
multiline_comment|/* No RAID Volume.&n;&t;&t; */
r_goto
id|done_and_free
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* At least 1 RAID Volume&n;&t;&t; */
id|pIocRv
op_assign
id|pIoc2-&gt;RaidVolume
suffix:semicolon
id|ioc-&gt;spi_data.isRaid
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|jj
op_assign
l_int|0
suffix:semicolon
id|jj
OL
id|nVols
suffix:semicolon
id|jj
op_increment
comma
id|pIocRv
op_increment
)paren
(brace
id|vid
op_assign
id|pIocRv-&gt;VolumeID
suffix:semicolon
id|vbus
op_assign
id|pIocRv-&gt;VolumeBus
suffix:semicolon
id|vioc
op_assign
id|pIocRv-&gt;VolumeIOC
suffix:semicolon
multiline_comment|/* find the match&n;&t;&t;&t; */
r_if
c_cond
(paren
id|vbus
op_eq
l_int|0
)paren
(brace
id|ioc-&gt;spi_data.isRaid
op_or_assign
(paren
l_int|1
op_lshift
id|vid
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Error! Always bus 0&n;&t;&t;&t;&t; */
)brace
)brace
)brace
multiline_comment|/* Identify Hidden Physical Disk Id&squot;s */
id|nPhys
op_assign
id|pIoc2-&gt;NumActivePhysDisks
suffix:semicolon
r_if
c_cond
(paren
id|nPhys
op_eq
l_int|0
)paren
(brace
multiline_comment|/* No physical disks.&n;&t;&t; */
)brace
r_else
(brace
id|mpt_read_ioc_pg_3
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
id|done_and_free
suffix:colon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|iocpage2sz
comma
id|pIoc2
comma
id|ioc2_dma
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|mpt_read_ioc_pg_3
id|mpt_read_ioc_pg_3
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|IOCPage3_t
op_star
id|pIoc3
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|header
suffix:semicolon
id|dma_addr_t
id|ioc3_dma
suffix:semicolon
r_int
id|iocpage3sz
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Free the old page&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;spi_data.pIocPg3
)paren
(brace
id|kfree
c_func
(paren
id|ioc-&gt;spi_data.pIocPg3
)paren
suffix:semicolon
id|ioc-&gt;spi_data.pIocPg3
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* There is at least one physical disk.&n;&t; * Read and save IOC Page 3&n;&t; */
id|header.PageVersion
op_assign
l_int|0
suffix:semicolon
id|header.PageLength
op_assign
l_int|0
suffix:semicolon
id|header.PageNumber
op_assign
l_int|3
suffix:semicolon
id|header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_IOC
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|header.PageLength
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Read Header good, alloc memory&n;&t; */
id|iocpage3sz
op_assign
id|header.PageLength
op_star
l_int|4
suffix:semicolon
id|pIoc3
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|iocpage3sz
comma
op_amp
id|ioc3_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pIoc3
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Read the Page and save the data&n;&t; * into malloc&squot;d memory.&n;&t; */
id|cfg.physAddr
op_assign
id|ioc3_dma
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
id|mem
op_assign
id|kmalloc
c_func
(paren
id|iocpage3sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|memcpy
c_func
(paren
id|mem
comma
(paren
id|u8
op_star
)paren
id|pIoc3
comma
id|iocpage3sz
)paren
suffix:semicolon
id|ioc-&gt;spi_data.pIocPg3
op_assign
(paren
id|IOCPage3_t
op_star
)paren
id|mem
suffix:semicolon
)brace
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|iocpage3sz
comma
id|pIoc3
comma
id|ioc3_dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpt_read_ioc_pg_4
id|mpt_read_ioc_pg_4
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|IOCPage4_t
op_star
id|pIoc4
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|header
suffix:semicolon
id|dma_addr_t
id|ioc4_dma
suffix:semicolon
r_int
id|iocpage4sz
suffix:semicolon
multiline_comment|/* Read and save IOC Page 4&n;&t; */
id|header.PageVersion
op_assign
l_int|0
suffix:semicolon
id|header.PageLength
op_assign
l_int|0
suffix:semicolon
id|header.PageNumber
op_assign
l_int|4
suffix:semicolon
id|header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_IOC
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|header.PageLength
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pIoc4
op_assign
id|ioc-&gt;spi_data.pIocPg4
)paren
op_eq
l_int|NULL
)paren
(brace
id|iocpage4sz
op_assign
(paren
id|header.PageLength
op_plus
l_int|4
)paren
op_star
l_int|4
suffix:semicolon
multiline_comment|/* Allow 4 additional SEP&squot;s */
id|pIoc4
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|iocpage4sz
comma
op_amp
id|ioc4_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pIoc4
)paren
r_return
suffix:semicolon
)brace
r_else
(brace
id|ioc4_dma
op_assign
id|ioc-&gt;spi_data.IocPg4_dma
suffix:semicolon
id|iocpage4sz
op_assign
id|ioc-&gt;spi_data.IocPg4Sz
suffix:semicolon
)brace
multiline_comment|/* Read the Page into dma memory.&n;&t; */
id|cfg.physAddr
op_assign
id|ioc4_dma
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
id|ioc-&gt;spi_data.pIocPg4
op_assign
(paren
id|IOCPage4_t
op_star
)paren
id|pIoc4
suffix:semicolon
id|ioc-&gt;spi_data.IocPg4_dma
op_assign
id|ioc4_dma
suffix:semicolon
id|ioc-&gt;spi_data.IocPg4Sz
op_assign
id|iocpage4sz
suffix:semicolon
)brace
r_else
(brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|iocpage4sz
comma
id|pIoc4
comma
id|ioc4_dma
)paren
suffix:semicolon
id|ioc-&gt;spi_data.pIocPg4
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|mpt_read_ioc_pg_1
id|mpt_read_ioc_pg_1
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|IOCPage1_t
op_star
id|pIoc1
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|header
suffix:semicolon
id|dma_addr_t
id|ioc1_dma
suffix:semicolon
r_int
id|iocpage1sz
op_assign
l_int|0
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
multiline_comment|/* Check the Coalescing Timeout in IOC Page 1&n;&t; */
id|header.PageVersion
op_assign
l_int|0
suffix:semicolon
id|header.PageLength
op_assign
l_int|0
suffix:semicolon
id|header.PageNumber
op_assign
l_int|1
suffix:semicolon
id|header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_IOC
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|header.PageLength
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* Read Header good, alloc memory&n;&t; */
id|iocpage1sz
op_assign
id|header.PageLength
op_star
l_int|4
suffix:semicolon
id|pIoc1
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|iocpage1sz
comma
op_amp
id|ioc1_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pIoc1
)paren
r_return
suffix:semicolon
multiline_comment|/* Read the Page and check coalescing timeout&n;&t; */
id|cfg.physAddr
op_assign
id|ioc1_dma
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
id|tmp
op_assign
id|le32_to_cpu
c_func
(paren
id|pIoc1-&gt;Flags
)paren
op_amp
id|MPI_IOCPAGE1_REPLY_COALESCING
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
id|MPI_IOCPAGE1_REPLY_COALESCING
)paren
(brace
id|tmp
op_assign
id|le32_to_cpu
c_func
(paren
id|pIoc1-&gt;CoalescingTimeout
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Coalescing Enabled Timeout = %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OG
id|MPT_COALESCING_TIMEOUT
)paren
(brace
id|pIoc1-&gt;CoalescingTimeout
op_assign
id|cpu_to_le32
c_func
(paren
id|MPT_COALESCING_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* Write NVRAM and current&n;&t;&t;&t;&t; */
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Reset Current Coalescing Timeout to = %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|MPT_COALESCING_TIMEOUT
)paren
)paren
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_NVRAM
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Reset NVRAM Coalescing Timeout to = %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|MPT_COALESCING_TIMEOUT
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Reset NVRAM Coalescing Timeout Failed&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Reset of Current Coalescing Timeout Failed!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Coalescing Disabled&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|iocpage1sz
comma
id|pIoc1
comma
id|ioc1_dma
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;SendEventNotification - Send EventNotification (on or off) request&n; *&t;to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@EvSwitch: Event switch flags&n; */
r_static
r_int
DECL|function|SendEventNotification
id|SendEventNotification
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u8
id|EvSwitch
)paren
(brace
id|EventNotification_t
op_star
id|evnp
suffix:semicolon
id|evnp
op_assign
(paren
id|EventNotification_t
op_star
)paren
id|mpt_get_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evnp
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Unable to allocate event request frame!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|evnp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|evnp
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending EventNotification(%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|EvSwitch
)paren
)paren
suffix:semicolon
id|evnp-&gt;Function
op_assign
id|MPI_FUNCTION_EVENT_NOTIFICATION
suffix:semicolon
id|evnp-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|evnp-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|evnp-&gt;Switch
op_assign
id|EvSwitch
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc
comma
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|evnp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;SendEventAck - Send EventAck request to MPT adapter.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@evnp: Pointer to original EventNotification request&n; */
r_static
r_int
DECL|function|SendEventAck
id|SendEventAck
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|evnp
)paren
(brace
id|EventAck_t
op_star
id|pAck
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pAck
op_assign
(paren
id|EventAck_t
op_star
)paren
id|mpt_get_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Unable to allocate event ACK request frame!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pAck
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pAck
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending EventAck&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|pAck-&gt;Function
op_assign
id|MPI_FUNCTION_EVENT_ACK
suffix:semicolon
id|pAck-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pAck-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pAck-&gt;Event
op_assign
id|evnp-&gt;Event
suffix:semicolon
id|pAck-&gt;EventContext
op_assign
id|evnp-&gt;EventContext
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc
comma
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|pAck
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_config - Generic function to issue config message&n; *&t;@ioc - Pointer to an adapter structure&n; *&t;@cfg - Pointer to a configuration structure. Struct contains&n; *&t;&t;action, page address, direction, physical address&n; *&t;&t;and pointer to a configuration page header&n; *&t;&t;Page header is updated.&n; *&n; *&t;Returns 0 for success&n; *&t;-EPERM if not allowed due to ISR context&n; *&t;-EAGAIN if no msg frames currently available&n; *&t;-EFAULT for non-successful reply or no reply (timeout)&n; */
r_int
DECL|function|mpt_config
id|mpt_config
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|CONFIGPARMS
op_star
id|pCfg
)paren
(brace
id|Config_t
op_star
id|pReq
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ii
comma
id|rc
suffix:semicolon
id|u32
id|flagsLength
suffix:semicolon
r_int
id|in_isr
suffix:semicolon
multiline_comment|/* (Bugzilla:fibrebugs, #513)&n;&t; * Bug fix (part 1)!  20010905 -sralston&n;&t; *&t;Prevent calling wait_event() (below), if caller happens&n;&t; *&t;to be in ISR context, because that is fatal!&n;&t; */
id|in_isr
op_assign
id|in_interrupt
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_isr
)paren
(brace
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Config request not allowed in ISR context!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* Get and Populate a free Frame&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;mpt_config: no msg frames!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|pReq
op_assign
(paren
id|Config_t
op_star
)paren
id|mf
suffix:semicolon
id|pReq-&gt;Action
op_assign
id|pCfg-&gt;action
suffix:semicolon
id|pReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Function
op_assign
id|MPI_FUNCTION_CONFIG
suffix:semicolon
id|pReq-&gt;ExtPageLength
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ExtPageType
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
id|pReq-&gt;Reserved2
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Header.PageVersion
op_assign
id|pCfg-&gt;hdr-&gt;PageVersion
suffix:semicolon
id|pReq-&gt;Header.PageLength
op_assign
id|pCfg-&gt;hdr-&gt;PageLength
suffix:semicolon
id|pReq-&gt;Header.PageNumber
op_assign
id|pCfg-&gt;hdr-&gt;PageNumber
suffix:semicolon
id|pReq-&gt;Header.PageType
op_assign
(paren
id|pCfg-&gt;hdr-&gt;PageType
op_amp
id|MPI_CONFIG_PAGETYPE_MASK
)paren
suffix:semicolon
id|pReq-&gt;PageAddress
op_assign
id|cpu_to_le32
c_func
(paren
id|pCfg-&gt;pageAddr
)paren
suffix:semicolon
multiline_comment|/* Add a SGE to the config request.&n;&t; */
r_if
c_cond
(paren
id|pCfg-&gt;dir
)paren
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_WRITE
suffix:semicolon
r_else
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_READ
suffix:semicolon
id|flagsLength
op_or_assign
id|pCfg-&gt;hdr-&gt;PageLength
op_star
l_int|4
suffix:semicolon
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;PageBufferSGE
comma
id|flagsLength
comma
id|pCfg-&gt;physAddr
)paren
suffix:semicolon
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending Config request type %d, page %d and action %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pReq-&gt;Header.PageType
comma
id|pReq-&gt;Header.PageNumber
comma
id|pReq-&gt;Action
)paren
)paren
suffix:semicolon
multiline_comment|/* Append pCfg pointer to end of mf&n;&t; */
op_star
(paren
(paren
r_void
op_star
op_star
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|mf
)paren
op_plus
(paren
id|ioc-&gt;req_sz
op_minus
r_sizeof
(paren
r_void
op_star
)paren
)paren
)paren
)paren
op_assign
(paren
r_void
op_star
)paren
id|pCfg
suffix:semicolon
multiline_comment|/* Initalize the timer&n;&t; */
id|init_timer
c_func
(paren
op_amp
id|pCfg-&gt;timer
)paren
suffix:semicolon
id|pCfg-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ioc
suffix:semicolon
id|pCfg-&gt;timer.function
op_assign
id|mpt_timer_expired
suffix:semicolon
id|pCfg-&gt;wait_done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set the timer; ensure 10 second minimum */
r_if
c_cond
(paren
id|pCfg-&gt;timeout
OL
l_int|10
)paren
id|pCfg-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|10
suffix:semicolon
r_else
id|pCfg-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
id|pCfg-&gt;timeout
suffix:semicolon
multiline_comment|/* Add to end of Q, set timer and then issue this command */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|pCfg-&gt;linkage
comma
op_amp
id|ioc-&gt;configQ
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|pCfg-&gt;timer
)paren
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc
comma
id|mf
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|mpt_waitq
comma
id|pCfg-&gt;wait_done
)paren
suffix:semicolon
multiline_comment|/* mf has been freed - do not access */
id|rc
op_assign
id|pCfg-&gt;status
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_toolbox - Generic function to issue toolbox message&n; *&t;@ioc - Pointer to an adapter structure&n; *&t;@cfg - Pointer to a toolbox structure. Struct contains&n; *&t;&t;action, page address, direction, physical address&n; *&t;&t;and pointer to a configuration page header&n; *&t;&t;Page header is updated.&n; *&n; *&t;Returns 0 for success&n; *&t;-EPERM if not allowed due to ISR context&n; *&t;-EAGAIN if no msg frames currently available&n; *&t;-EFAULT for non-successful reply or no reply (timeout)&n; */
r_int
DECL|function|mpt_toolbox
id|mpt_toolbox
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|CONFIGPARMS
op_star
id|pCfg
)paren
(brace
id|ToolboxIstwiReadWriteRequest_t
op_star
id|pReq
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|u32
id|flagsLength
suffix:semicolon
r_int
id|in_isr
suffix:semicolon
multiline_comment|/* (Bugzilla:fibrebugs, #513)&n;&t; * Bug fix (part 1)!  20010905 -sralston&n;&t; *&t;Prevent calling wait_event() (below), if caller happens&n;&t; *&t;to be in ISR context, because that is fatal!&n;&t; */
id|in_isr
op_assign
id|in_interrupt
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_isr
)paren
(brace
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;toobox request not allowed in ISR context!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* Get and Populate a free Frame&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;mpt_toolbox: no msg frames!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|pReq
op_assign
(paren
id|ToolboxIstwiReadWriteRequest_t
op_star
)paren
id|mf
suffix:semicolon
id|pReq-&gt;Tool
op_assign
id|pCfg-&gt;action
suffix:semicolon
id|pReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Function
op_assign
id|MPI_FUNCTION_TOOLBOX
suffix:semicolon
id|pReq-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Flags
op_assign
id|pCfg-&gt;dir
suffix:semicolon
id|pReq-&gt;BusNum
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;NumAddressBytes
op_assign
l_int|0x01
suffix:semicolon
id|pReq-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;DataLength
op_assign
l_int|0x04
suffix:semicolon
id|pdev
op_assign
(paren
r_struct
id|pci_dev
op_star
)paren
id|ioc-&gt;pcidev
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;devfn
op_amp
l_int|1
)paren
id|pReq-&gt;DeviceAddr
op_assign
l_int|0xB2
suffix:semicolon
r_else
id|pReq-&gt;DeviceAddr
op_assign
l_int|0xB0
suffix:semicolon
id|pReq-&gt;Addr1
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Addr2
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Addr3
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Reserved5
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Add a SGE to the config request.&n;&t; */
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_READ
op_or
l_int|4
suffix:semicolon
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;SGL
comma
id|flagsLength
comma
id|pCfg-&gt;physAddr
)paren
suffix:semicolon
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending Toolbox request, Tool=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pReq-&gt;Tool
)paren
)paren
suffix:semicolon
multiline_comment|/* Append pCfg pointer to end of mf&n;&t; */
op_star
(paren
(paren
r_void
op_star
op_star
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|mf
)paren
op_plus
(paren
id|ioc-&gt;req_sz
op_minus
r_sizeof
(paren
r_void
op_star
)paren
)paren
)paren
)paren
op_assign
(paren
r_void
op_star
)paren
id|pCfg
suffix:semicolon
multiline_comment|/* Initalize the timer&n;&t; */
id|init_timer
c_func
(paren
op_amp
id|pCfg-&gt;timer
)paren
suffix:semicolon
id|pCfg-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ioc
suffix:semicolon
id|pCfg-&gt;timer.function
op_assign
id|mpt_timer_expired
suffix:semicolon
id|pCfg-&gt;wait_done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set the timer; ensure 10 second minimum */
r_if
c_cond
(paren
id|pCfg-&gt;timeout
OL
l_int|10
)paren
id|pCfg-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|10
suffix:semicolon
r_else
id|pCfg-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
id|pCfg-&gt;timeout
suffix:semicolon
multiline_comment|/* Add to end of Q, set timer and then issue this command */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|pCfg-&gt;linkage
comma
op_amp
id|ioc-&gt;configQ
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|pCfg-&gt;timer
)paren
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mpt_base_index
comma
id|ioc
comma
id|mf
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|mpt_waitq
comma
id|pCfg-&gt;wait_done
)paren
suffix:semicolon
multiline_comment|/* mf has been freed - do not access */
id|rc
op_assign
id|pCfg-&gt;status
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_timer_expired - Call back for timer process.&n; *&t;Used only internal config functionality.&n; *&t;@data: Pointer to MPT_SCSI_HOST recast as an unsigned long&n; */
r_static
r_void
DECL|function|mpt_timer_expired
id|mpt_timer_expired
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
(paren
id|MPT_ADAPTER
op_star
)paren
id|data
suffix:semicolon
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;mpt_timer_expired! &bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Perform a FW reload */
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|ioc
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Firmware Reload FAILED!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
multiline_comment|/* No more processing.&n;&t; * Hard reset clean-up will wake up&n;&t; * process and free all resources.&n;&t; */
id|dcprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;mpt_timer_expired complete!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_ioc_reset - Base cleanup for hard reset&n; *&t;@ioc: Pointer to the adapter structure&n; *&t;@reset_phase: Indicates pre- or post-reset functionality&n; *&n; *&t;Remark: Free&squot;s resources with internally generated commands.&n; */
r_static
r_int
DECL|function|mpt_ioc_reset
id|mpt_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
(brace
id|CONFIGPARMS
op_star
id|pCfg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOC %s_reset routed to MPT base driver!&bslash;n&quot;
comma
id|reset_phase
op_eq
id|MPT_IOC_SETUP_RESET
ques
c_cond
l_string|&quot;setup&quot;
suffix:colon
(paren
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
ques
c_cond
l_string|&quot;pre&quot;
suffix:colon
l_string|&quot;post&quot;
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset_phase
op_eq
id|MPT_IOC_SETUP_RESET
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
)paren
(brace
multiline_comment|/* If the internal config Q is not empty -&n;&t;&t; * delete timer. MF resources will be freed when&n;&t;&t; * the FIFO&squot;s are primed.&n;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|pCfg
comma
op_amp
id|ioc-&gt;configQ
comma
id|linkage
)paren
id|del_timer
c_func
(paren
op_amp
id|pCfg-&gt;timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|CONFIGPARMS
op_star
id|pNext
suffix:semicolon
multiline_comment|/* Search the configQ for internal commands.&n;&t;&t; * Flush the Q, and wake up all suspended threads.&n;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|pCfg
comma
id|pNext
comma
op_amp
id|ioc-&gt;configQ
comma
id|linkage
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|pCfg-&gt;linkage
)paren
suffix:semicolon
id|pCfg-&gt;status
op_assign
id|MPT_CONFIG_ERROR
suffix:semicolon
id|pCfg-&gt;wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|mpt_waitq
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* currently means nothing really */
)brace
macro_line|#ifdef CONFIG_PROC_FS&t;&t;/* { */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procfs (%MPT_PROCFS_MPTBASEDIR/...) support stuff...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procmpt_create - Create %MPT_PROCFS_MPTBASEDIR entries.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
DECL|function|procmpt_create
id|procmpt_create
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
id|mpt_proc_root_dir
op_assign
id|proc_mkdir
c_func
(paren
id|MPT_PROCFS_MPTBASEDIR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_proc_root_dir
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOTDIR
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;summary&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|mpt_proc_root_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
id|ent-&gt;read_proc
op_assign
id|procmpt_summary_read
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;version&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|mpt_proc_root_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
id|ent-&gt;read_proc
op_assign
id|procmpt_version_read
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procmpt_destroy - Tear down %MPT_PROCFS_MPTBASEDIR entries.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_void
DECL|function|procmpt_destroy
id|procmpt_destroy
c_func
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;version&quot;
comma
id|mpt_proc_root_dir
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;summary&quot;
comma
id|mpt_proc_root_dir
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|MPT_PROCFS_MPTBASEDIR
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procmpt_summary_read - Handle read request from /proc/mpt/summary&n; *&t;or from /proc/mpt/iocN/summary.&n; *&t;@buf: Pointer to area to write information&n; *&t;@start: Pointer to start pointer&n; *&t;@offset: Offset to start writing&n; *&t;@request:&n; *&t;@eof: Pointer to EOF integer&n; *&t;@data: Pointer&n; *&n; *&t;Returns number of characters written to process performing the read.&n; */
r_static
r_int
DECL|function|procmpt_summary_read
id|procmpt_summary_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|request
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_char
op_star
id|out
op_assign
id|buf
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
(brace
r_int
id|more
op_assign
l_int|0
suffix:semicolon
id|ioc
op_assign
id|data
suffix:semicolon
id|mpt_print_ioc_summary
c_func
(paren
id|ioc
comma
id|out
comma
op_amp
id|more
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|out
op_add_assign
id|more
suffix:semicolon
)brace
r_else
(brace
id|list_for_each_entry
c_func
(paren
id|ioc
comma
op_amp
id|ioc_list
comma
id|list
)paren
(brace
r_int
id|more
op_assign
l_int|0
suffix:semicolon
id|mpt_print_ioc_summary
c_func
(paren
id|ioc
comma
id|out
comma
op_amp
id|more
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|out
op_add_assign
id|more
suffix:semicolon
r_if
c_cond
(paren
(paren
id|out
op_minus
id|buf
)paren
op_ge
id|request
)paren
r_break
suffix:semicolon
)brace
)brace
id|len
op_assign
id|out
op_minus
id|buf
suffix:semicolon
id|MPT_PROC_READ_RETURN
c_func
(paren
id|buf
comma
id|start
comma
id|offset
comma
id|request
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procmpt_version_read - Handle read request from /proc/mpt/version.&n; *&t;@buf: Pointer to area to write information&n; *&t;@start: Pointer to start pointer&n; *&t;@offset: Offset to start writing&n; *&t;@request:&n; *&t;@eof: Pointer to EOF integer&n; *&t;@data: Pointer&n; *&n; *&t;Returns number of characters written to process performing the read.&n; */
r_static
r_int
DECL|function|procmpt_version_read
id|procmpt_version_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|request
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|ii
suffix:semicolon
r_int
id|scsi
comma
id|lan
comma
id|ctl
comma
id|targ
comma
id|dmp
suffix:semicolon
r_char
op_star
id|drvname
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s-%s&bslash;n&quot;
comma
l_string|&quot;mptlinux&quot;
comma
id|MPT_LINUX_VERSION_COMMON
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|scsi
op_assign
id|lan
op_assign
id|ctl
op_assign
id|targ
op_assign
id|dmp
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|ii
suffix:semicolon
id|ii
op_decrement
)paren
(brace
id|drvname
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|MptCallbacks
(braket
id|ii
)braket
)paren
(brace
r_switch
c_cond
(paren
id|MptDriverClass
(braket
id|ii
)braket
)paren
(brace
r_case
id|MPTSCSIH_DRIVER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|scsi
op_increment
)paren
id|drvname
op_assign
l_string|&quot;SCSI host&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTLAN_DRIVER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|lan
op_increment
)paren
id|drvname
op_assign
l_string|&quot;LAN&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTSTM_DRIVER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|targ
op_increment
)paren
id|drvname
op_assign
l_string|&quot;SCSI target&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTCTL_DRIVER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ctl
op_increment
)paren
id|drvname
op_assign
l_string|&quot;ioctl&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|drvname
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  Fusion MPT %s driver&bslash;n&quot;
comma
id|drvname
)paren
suffix:semicolon
)brace
)brace
id|MPT_PROC_READ_RETURN
c_func
(paren
id|buf
comma
id|start
comma
id|offset
comma
id|request
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;procmpt_iocinfo_read - Handle read request from /proc/mpt/iocN/info.&n; *&t;@buf: Pointer to area to write information&n; *&t;@start: Pointer to start pointer&n; *&t;@offset: Offset to start writing&n; *&t;@request:&n; *&t;@eof: Pointer to EOF integer&n; *&t;@data: Pointer&n; *&n; *&t;Returns number of characters written to process performing the read.&n; */
r_static
r_int
DECL|function|procmpt_iocinfo_read
id|procmpt_iocinfo_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|request
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|data
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
id|expVer
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|sz
suffix:semicolon
r_int
id|p
suffix:semicolon
id|mpt_get_fw_exp_ver
c_func
(paren
id|expVer
comma
id|ioc
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s:&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;facts.Flags
op_amp
id|MPI_IOCFACTS_FLAGS_FW_DOWNLOAD_BOOT
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  (f/w download boot flag set)&quot;
)paren
suffix:semicolon
singleline_comment|//&t;if (ioc-&gt;facts.IOCExceptions &amp; MPI_IOCFACTS_EXCEPT_CONFIG_CHECKSUM_FAIL)
singleline_comment|//&t;&t;len += sprintf(buf+len, &quot;  CONFIG_CHECKSUM_FAIL!&quot;);
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n  ProductID = 0x%04x (%s)&bslash;n&quot;
comma
id|ioc-&gt;facts.ProductID
comma
id|ioc-&gt;prod_name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  FWVersion = 0x%08x%s&quot;
comma
id|ioc-&gt;facts.FWVersion.Word
comma
id|expVer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;facts.FWImageSize
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot; (fw_size=%d)&quot;
comma
id|ioc-&gt;facts.FWImageSize
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n  MsgVersion = 0x%04x&bslash;n&quot;
comma
id|ioc-&gt;facts.MsgVersion
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  FirstWhoInit = 0x%02x&bslash;n&quot;
comma
id|ioc-&gt;FirstWhoInit
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  EventState = 0x%02x&bslash;n&quot;
comma
id|ioc-&gt;facts.EventState
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  CurrentHostMfaHighAddr = 0x%08x&bslash;n&quot;
comma
id|ioc-&gt;facts.CurrentHostMfaHighAddr
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  CurrentSenseBufferHighAddr = 0x%08x&bslash;n&quot;
comma
id|ioc-&gt;facts.CurrentSenseBufferHighAddr
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  MaxChainDepth = 0x%02x frames&bslash;n&quot;
comma
id|ioc-&gt;facts.MaxChainDepth
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  MinBlockSize = 0x%02x bytes&bslash;n&quot;
comma
l_int|4
op_star
id|ioc-&gt;facts.BlockSize
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  RequestFrames @ 0x%p (Dma @ 0x%p)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;req_frames
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|ioc-&gt;req_frames_dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Rounding UP to nearest 4-kB boundary here...&n;&t; */
id|sz
op_assign
(paren
id|ioc-&gt;req_sz
op_star
id|ioc-&gt;req_depth
)paren
op_plus
l_int|128
suffix:semicolon
id|sz
op_assign
(paren
(paren
id|sz
op_plus
l_int|0x1000UL
op_minus
l_int|1UL
)paren
op_div
l_int|0x1000
)paren
op_star
l_int|0x1000
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    {CurReqSz=%d} x {CurReqDepth=%d} = %d bytes ^= 0x%x&bslash;n&quot;
comma
id|ioc-&gt;req_sz
comma
id|ioc-&gt;req_depth
comma
id|ioc-&gt;req_sz
op_star
id|ioc-&gt;req_depth
comma
id|sz
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    {MaxReqSz=%d}   {MaxReqDepth=%d}&bslash;n&quot;
comma
l_int|4
op_star
id|ioc-&gt;facts.RequestFrameSize
comma
id|ioc-&gt;facts.GlobalCredits
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  Frames   @ 0x%p (Dma @ 0x%p)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;alloc
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|ioc-&gt;alloc_dma
)paren
suffix:semicolon
id|sz
op_assign
(paren
id|ioc-&gt;reply_sz
op_star
id|ioc-&gt;reply_depth
)paren
op_plus
l_int|128
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    {CurRepSz=%d} x {CurRepDepth=%d} = %d bytes ^= 0x%x&bslash;n&quot;
comma
id|ioc-&gt;reply_sz
comma
id|ioc-&gt;reply_depth
comma
id|ioc-&gt;reply_sz
op_star
id|ioc-&gt;reply_depth
comma
id|sz
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    {MaxRepSz=%d}   {MaxRepDepth=%d}&bslash;n&quot;
comma
id|ioc-&gt;facts.CurReplyFrameSize
comma
id|ioc-&gt;facts.ReplyQueueDepth
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  MaxDevices = %d&bslash;n&quot;
comma
(paren
id|ioc-&gt;facts.MaxDevices
op_eq
l_int|0
)paren
ques
c_cond
l_int|255
suffix:colon
id|ioc-&gt;facts.MaxDevices
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  MaxBuses = %d&bslash;n&quot;
comma
id|ioc-&gt;facts.MaxBuses
)paren
suffix:semicolon
multiline_comment|/* per-port info */
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|ioc-&gt;facts.NumberOfPorts
suffix:semicolon
id|p
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;  PortNumber = %d (of %d)&bslash;n&quot;
comma
id|p
op_plus
l_int|1
comma
id|ioc-&gt;facts.NumberOfPorts
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
id|p
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
(brace
id|u8
op_star
id|a
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|ioc-&gt;lan_cnfg_page1.HardwareAddressLow
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    LanAddr = %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|a
(braket
l_int|5
)braket
comma
id|a
(braket
l_int|4
)braket
comma
id|a
(braket
l_int|3
)braket
comma
id|a
(braket
l_int|2
)braket
comma
id|a
(braket
l_int|1
)braket
comma
id|a
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    WWN = %08X%08X:%08X%08X&bslash;n&quot;
comma
id|ioc-&gt;fc_port_page0
(braket
id|p
)braket
dot
id|WWNN.High
comma
id|ioc-&gt;fc_port_page0
(braket
id|p
)braket
dot
id|WWNN.Low
comma
id|ioc-&gt;fc_port_page0
(braket
id|p
)braket
dot
id|WWPN.High
comma
id|ioc-&gt;fc_port_page0
(braket
id|p
)braket
dot
id|WWPN.Low
)paren
suffix:semicolon
)brace
)brace
id|MPT_PROC_READ_RETURN
c_func
(paren
id|buf
comma
id|start
comma
id|offset
comma
id|request
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;/* CONFIG_PROC_FS } */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_void
DECL|function|mpt_get_fw_exp_ver
id|mpt_get_fw_exp_ver
c_func
(paren
r_char
op_star
id|buf
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|buf
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;facts.FWVersion.Word
op_rshift
l_int|24
)paren
op_eq
l_int|0x0E
)paren
(brace
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot; (Exp %02d%02d)&quot;
comma
(paren
id|ioc-&gt;facts.FWVersion.Word
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
comma
multiline_comment|/* Month */
(paren
id|ioc-&gt;facts.FWVersion.Word
op_rshift
l_int|8
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
multiline_comment|/* Day */
multiline_comment|/* insider hack! */
r_if
c_cond
(paren
(paren
id|ioc-&gt;facts.FWVersion.Word
op_rshift
l_int|8
)paren
op_amp
l_int|0x80
)paren
id|strcat
c_func
(paren
id|buf
comma
l_string|&quot; [MDBG]&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_print_ioc_summary - Write ASCII summary of IOC to a buffer.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@buffer: Pointer to buffer where IOC summary info should be written&n; *&t;@size: Pointer to number of bytes we wrote (set by this routine)&n; *&t;@len: Offset at which to start writing in buffer&n; *&t;@showlan: Display LAN stuff?&n; *&n; *&t;This routine writes (english readable) ASCII text, which represents&n; *&t;a summary of IOC information, to a buffer.&n; */
r_void
DECL|function|mpt_print_ioc_summary
id|mpt_print_ioc_summary
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_char
op_star
id|buffer
comma
r_int
op_star
id|size
comma
r_int
id|len
comma
r_int
id|showlan
)paren
(brace
r_char
id|expVer
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|y
suffix:semicolon
id|mpt_get_fw_exp_ver
c_func
(paren
id|expVer
comma
id|ioc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Shorter summary of attached ioc&squot;s...&n;&t; */
id|y
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%s: %s, %s%08xh%s, Ports=%d, MaxQ=%d&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;prod_name
comma
id|MPT_FW_REV_MAGIC_ID_STRING
comma
multiline_comment|/* &quot;FwRev=&quot; or somesuch */
id|ioc-&gt;facts.FWVersion.Word
comma
id|expVer
comma
id|ioc-&gt;facts.NumberOfPorts
comma
id|ioc-&gt;req_depth
)paren
suffix:semicolon
r_if
c_cond
(paren
id|showlan
op_logical_and
(paren
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
)paren
(brace
id|u8
op_star
id|a
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|ioc-&gt;lan_cnfg_page1.HardwareAddressLow
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;, LanAddr=%02X:%02X:%02X:%02X:%02X:%02X&quot;
comma
id|a
(braket
l_int|5
)braket
comma
id|a
(braket
l_int|4
)braket
comma
id|a
(braket
l_int|3
)braket
comma
id|a
(braket
l_int|2
)braket
comma
id|a
(braket
l_int|1
)braket
comma
id|a
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifndef __sparc__
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;, IRQ=%d&quot;
comma
id|ioc-&gt;pci_irq
)paren
suffix:semicolon
macro_line|#else
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;, IRQ=%s&quot;
comma
id|__irq_itoa
c_func
(paren
id|ioc-&gt;pci_irq
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;active
)paren
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot; (disabled)&quot;
)paren
suffix:semicolon
id|y
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
op_plus
id|y
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|size
op_assign
id|y
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;Reset Handling&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mpt_HardResetHandler - Generic reset handler, issue SCSI Task&n; *&t;Management call based on input arg values.  If TaskMgmt fails,&n; *&t;return associated SCSI request.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@sleepFlag: Indicates if sleep or schedule must be called.&n; *&n; *&t;Remark: _HardResetHandler can be invoked from an interrupt thread (timer)&n; *&t;or a non-interrupt thread.  In the former, must not call schedule().&n; *&n; *&t;Remark: A return of -1 is a FATAL error case, as it means a&n; *&t;FW reload/initialization failed.&n; *&n; *&t;Returns 0 for SUCCESS or -1 if FAILED.&n; */
r_int
DECL|function|mpt_HardResetHandler
id|mpt_HardResetHandler
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|sleepFlag
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;HardResetHandler Entered!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
macro_line|#ifdef MFCNT
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;HardResetHandler Entered!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MF count 0x%x !&bslash;n&quot;
comma
id|ioc-&gt;mfcnt
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Reset the adapter. Prevent more than 1 call to&n;&t; * mpt_do_ioc_recovery at any instant in time.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;diagPending
)paren
op_logical_or
(paren
id|ioc-&gt;alt_ioc
op_logical_and
id|ioc-&gt;alt_ioc-&gt;diagPending
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ioc-&gt;diagPending
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* FIXME: If do_ioc_recovery fails, repeat....&n;&t; */
multiline_comment|/* The SCSI driver needs to adjust timeouts on all current&n;&t; * commands prior to the diagnostic reset being issued.&n;&t; * Prevents timeouts occuring during a diagnostic reset...very bad.&n;&t; * For all other protocol drivers, this is a no-op.&n;&t; */
(brace
r_int
id|ii
suffix:semicolon
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|ii
suffix:semicolon
id|ii
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|MptResetHandlers
(braket
id|ii
)braket
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Calling IOC reset_setup handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|ii
)braket
)paren
)paren
(paren
id|ioc
comma
id|MPT_IOC_SETUP_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Calling alt-%s setup reset handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;alt_ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptResetHandlers
(braket
id|ii
)braket
)paren
)paren
(paren
id|ioc-&gt;alt_ioc
comma
id|MPT_IOC_SETUP_RESET
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_do_ioc_recovery
c_func
(paren
id|ioc
comma
id|MPT_HOSTEVENT_IOC_RECOVER
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: WARNING - (%d) Cannot recover %s&bslash;n&quot;
comma
id|rc
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
id|ioc-&gt;reload_fw
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|ioc-&gt;alt_ioc-&gt;reload_fw
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
id|ioc-&gt;diagPending
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|ioc-&gt;alt_ioc-&gt;diagPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;HardResetHandler rc = %d!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_char
op_star
DECL|function|EventDescriptionStr
id|EventDescriptionStr
c_func
(paren
id|u8
id|event
comma
id|u32
id|evData0
)paren
(brace
r_char
op_star
id|ds
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|MPI_EVENT_NONE
suffix:colon
id|ds
op_assign
l_string|&quot;None&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOG_DATA
suffix:colon
id|ds
op_assign
l_string|&quot;Log Data&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_STATE_CHANGE
suffix:colon
id|ds
op_assign
l_string|&quot;State Change&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_UNIT_ATTENTION
suffix:colon
id|ds
op_assign
l_string|&quot;Unit Attention&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_IOC_BUS_RESET
suffix:colon
id|ds
op_assign
l_string|&quot;IOC Bus Reset&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_EXT_BUS_RESET
suffix:colon
id|ds
op_assign
l_string|&quot;External Bus Reset&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_RESCAN
suffix:colon
id|ds
op_assign
l_string|&quot;Bus Rescan Event&quot;
suffix:semicolon
multiline_comment|/* Ok, do we need to do anything here? As far as&n;&t;&t;   I can tell, this is when a new device gets added&n;&t;&t;   to the loop. */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LINK_STATUS_CHANGE
suffix:colon
r_if
c_cond
(paren
id|evData0
op_eq
id|MPI_EVENT_LINK_STATUS_FAILURE
)paren
id|ds
op_assign
l_string|&quot;Link Status(FAILURE) Change&quot;
suffix:semicolon
r_else
id|ds
op_assign
l_string|&quot;Link Status(ACTIVE) Change&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOOP_STATE_CHANGE
suffix:colon
r_if
c_cond
(paren
id|evData0
op_eq
id|MPI_EVENT_LOOP_STATE_CHANGE_LIP
)paren
id|ds
op_assign
l_string|&quot;Loop State(LIP) Change&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|evData0
op_eq
id|MPI_EVENT_LOOP_STATE_CHANGE_LPE
)paren
id|ds
op_assign
l_string|&quot;Loop State(LPE) Change&quot;
suffix:semicolon
multiline_comment|/* ??? */
r_else
id|ds
op_assign
l_string|&quot;Loop State(LPB) Change&quot;
suffix:semicolon
multiline_comment|/* ??? */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOGOUT
suffix:colon
id|ds
op_assign
l_string|&quot;Logout&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_EVENT_CHANGE
suffix:colon
r_if
c_cond
(paren
id|evData0
)paren
id|ds
op_assign
l_string|&quot;Events(ON) Change&quot;
suffix:semicolon
r_else
id|ds
op_assign
l_string|&quot;Events(OFF) Change&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_INTEGRATED_RAID
suffix:colon
id|ds
op_assign
l_string|&quot;Integrated Raid&quot;
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; *  MPT base &quot;custom&quot; events may be added here...&n;&t; */
r_default
suffix:colon
id|ds
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ds
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;ProcessEventNotification - Route a received EventNotificationReply to&n; *&t;all currently regeistered event handlers.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@pEventReply: Pointer to EventNotification reply frame&n; *&t;@evHandlers: Pointer to integer, number of event handlers&n; *&n; *&t;Returns sum of event handlers return values.&n; */
r_static
r_int
DECL|function|ProcessEventNotification
id|ProcessEventNotification
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEventReply
comma
r_int
op_star
id|evHandlers
)paren
(brace
id|u16
id|evDataLen
suffix:semicolon
id|u32
id|evData0
op_assign
l_int|0
suffix:semicolon
singleline_comment|//&t;u32 evCtx;
r_int
id|ii
suffix:semicolon
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_int
id|handlers
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|evStr
suffix:semicolon
id|u8
id|event
suffix:semicolon
multiline_comment|/*&n;&t; *  Do platform normalization of values&n;&t; */
id|event
op_assign
id|le32_to_cpu
c_func
(paren
id|pEventReply-&gt;Event
)paren
op_amp
l_int|0xFF
suffix:semicolon
singleline_comment|//&t;evCtx = le32_to_cpu(pEventReply-&gt;EventContext);
id|evDataLen
op_assign
id|le16_to_cpu
c_func
(paren
id|pEventReply-&gt;EventDataLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evDataLen
)paren
(brace
id|evData0
op_assign
id|le32_to_cpu
c_func
(paren
id|pEventReply-&gt;Data
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|evStr
op_assign
id|EventDescriptionStr
c_func
(paren
id|event
comma
id|evData0
)paren
suffix:semicolon
id|devtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;MPT event (%s=%02Xh) detected!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|evStr
comma
id|event
)paren
)paren
suffix:semicolon
macro_line|#if defined(MPT_DEBUG) || defined(MPT_DEBUG_EVENTS)
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Event data:&bslash;n&quot;
id|KERN_INFO
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|evDataLen
suffix:semicolon
id|ii
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pEventReply-&gt;Data
(braket
id|ii
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; *  Do general / base driver event processing&n;&t; */
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|MPI_EVENT_NONE
suffix:colon
multiline_comment|/* 00 */
r_case
id|MPI_EVENT_LOG_DATA
suffix:colon
multiline_comment|/* 01 */
r_case
id|MPI_EVENT_STATE_CHANGE
suffix:colon
multiline_comment|/* 02 */
r_case
id|MPI_EVENT_UNIT_ATTENTION
suffix:colon
multiline_comment|/* 03 */
r_case
id|MPI_EVENT_IOC_BUS_RESET
suffix:colon
multiline_comment|/* 04 */
r_case
id|MPI_EVENT_EXT_BUS_RESET
suffix:colon
multiline_comment|/* 05 */
r_case
id|MPI_EVENT_RESCAN
suffix:colon
multiline_comment|/* 06 */
r_case
id|MPI_EVENT_LINK_STATUS_CHANGE
suffix:colon
multiline_comment|/* 07 */
r_case
id|MPI_EVENT_LOOP_STATE_CHANGE
suffix:colon
multiline_comment|/* 08 */
r_case
id|MPI_EVENT_LOGOUT
suffix:colon
multiline_comment|/* 09 */
r_case
id|MPI_EVENT_INTEGRATED_RAID
suffix:colon
multiline_comment|/* 0B */
r_case
id|MPI_EVENT_SCSI_DEVICE_STATUS_CHANGE
suffix:colon
multiline_comment|/* 0C */
r_default
suffix:colon
r_break
suffix:semicolon
r_case
id|MPI_EVENT_EVENT_CHANGE
suffix:colon
multiline_comment|/* 0A */
r_if
c_cond
(paren
id|evDataLen
)paren
(brace
id|u8
id|evState
op_assign
id|evData0
op_amp
l_int|0xFF
suffix:semicolon
multiline_comment|/* CHECKME! What if evState unexpectedly says OFF (0)? */
multiline_comment|/* Update EventState field in cached IocFacts */
r_if
c_cond
(paren
id|ioc-&gt;facts.Function
)paren
(brace
id|ioc-&gt;facts.EventState
op_assign
id|evState
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Should this event be logged? Events are written sequentially.&n;&t; * When buffer is full, start again at the top.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;events
op_logical_and
(paren
id|ioc-&gt;eventTypes
op_amp
(paren
l_int|1
op_lshift
id|event
)paren
)paren
)paren
(brace
r_int
id|idx
suffix:semicolon
id|idx
op_assign
id|ioc-&gt;eventContext
op_mod
id|ioc-&gt;eventLogSize
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|event
op_assign
id|event
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|eventContext
op_assign
id|ioc-&gt;eventContext
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|2
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
OL
id|evDataLen
)paren
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|data
(braket
id|ii
)braket
op_assign
id|le32_to_cpu
c_func
(paren
id|pEventReply-&gt;Data
(braket
id|ii
)braket
)paren
suffix:semicolon
r_else
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|data
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|ioc-&gt;eventContext
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Call each currently registered protocol event handler.&n;&t; */
r_for
c_loop
(paren
id|ii
op_assign
id|MPT_MAX_PROTOCOL_DRIVERS
op_minus
l_int|1
suffix:semicolon
id|ii
suffix:semicolon
id|ii
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|MptEvHandlers
(braket
id|ii
)braket
)paren
(brace
id|devtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Routing Event to event handler #%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
id|r
op_add_assign
(paren
op_star
(paren
id|MptEvHandlers
(braket
id|ii
)braket
)paren
)paren
(paren
id|ioc
comma
id|pEventReply
)paren
suffix:semicolon
id|handlers
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* FIXME?  Examine results here? */
multiline_comment|/*&n;&t; *  If needed, send (a single) EventAck.&n;&t; */
r_if
c_cond
(paren
id|pEventReply-&gt;AckRequired
op_eq
id|MPI_EVENT_NOTIFICATION_ACK_REQUIRED
)paren
(brace
r_if
c_cond
(paren
(paren
id|ii
op_assign
id|SendEventAck
c_func
(paren
id|ioc
comma
id|pEventReply
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|devtprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;SendEventAck returned %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ii
)paren
)paren
suffix:semicolon
)brace
)brace
op_star
id|evHandlers
op_assign
id|handlers
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_fc_log_info - Log information returned from Fibre Channel IOC.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@log_info: U32 LogInfo reply word from the IOC&n; *&n; *&t;Refer to lsi/fc_log.h.&n; */
r_static
r_void
DECL|function|mpt_fc_log_info
id|mpt_fc_log_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|log_info
)paren
(brace
r_static
r_char
op_star
id|subcl_str
(braket
l_int|8
)braket
op_assign
(brace
l_string|&quot;FCP Initiator&quot;
comma
l_string|&quot;FCP Target&quot;
comma
l_string|&quot;LAN&quot;
comma
l_string|&quot;MPI Message Layer&quot;
comma
l_string|&quot;FC Link&quot;
comma
l_string|&quot;Context Manager&quot;
comma
l_string|&quot;Invalid Field Offset&quot;
comma
l_string|&quot;State Change Info&quot;
)brace
suffix:semicolon
id|u8
id|subcl
op_assign
(paren
id|log_info
op_rshift
l_int|24
)paren
op_amp
l_int|0x7
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;LogInfo(0x%08x): SubCl={%s}&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|log_info
comma
id|subcl_str
(braket
id|subcl
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_sp_log_info - Log information returned from SCSI Parallel IOC.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mr: Pointer to MPT reply frame&n; *&t;@log_info: U32 LogInfo word from the IOC&n; *&n; *&t;Refer to lsi/sp_log.h.&n; */
r_static
r_void
DECL|function|mpt_sp_log_info
id|mpt_sp_log_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|log_info
)paren
(brace
id|u32
id|info
op_assign
id|log_info
op_amp
l_int|0x00FF0000
suffix:semicolon
r_char
op_star
id|desc
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
r_switch
c_cond
(paren
id|info
)paren
(brace
r_case
l_int|0x00010000
suffix:colon
id|desc
op_assign
l_string|&quot;bug! MID not found&quot;
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;reload_fw
op_eq
l_int|0
)paren
id|ioc-&gt;reload_fw
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00020000
suffix:colon
id|desc
op_assign
l_string|&quot;Parity Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00030000
suffix:colon
id|desc
op_assign
l_string|&quot;ASYNC Outbound Overrun&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00040000
suffix:colon
id|desc
op_assign
l_string|&quot;SYNC Offset Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00050000
suffix:colon
id|desc
op_assign
l_string|&quot;BM Change&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00060000
suffix:colon
id|desc
op_assign
l_string|&quot;Msg In Overflow&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00070000
suffix:colon
id|desc
op_assign
l_string|&quot;DMA Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00080000
suffix:colon
id|desc
op_assign
l_string|&quot;Outbound DMA Overrun&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00090000
suffix:colon
id|desc
op_assign
l_string|&quot;Task Management&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x000A0000
suffix:colon
id|desc
op_assign
l_string|&quot;Device Problem&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x000B0000
suffix:colon
id|desc
op_assign
l_string|&quot;Invalid Phase Change&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x000C0000
suffix:colon
id|desc
op_assign
l_string|&quot;Untagged Table Size&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;LogInfo(0x%08x): F/W: %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|log_info
comma
id|desc
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mpt_sp_ioc_info - IOC information returned from SCSI Parallel IOC.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@ioc_status: U32 IOCStatus word from IOC&n; *&t;@mf: Pointer to MPT request frame&n; *&n; *&t;Refer to lsi/mpi.h.&n; */
r_static
r_void
DECL|function|mpt_sp_ioc_info
id|mpt_sp_ioc_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|u32
id|ioc_status
comma
id|MPT_FRAME_HDR
op_star
id|mf
)paren
(brace
id|u32
id|status
op_assign
id|ioc_status
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
r_char
op_star
id|desc
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|MPI_IOCSTATUS_INVALID_FUNCTION
suffix:colon
multiline_comment|/* 0x0001 */
id|desc
op_assign
l_string|&quot;Invalid Function&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_BUSY
suffix:colon
multiline_comment|/* 0x0002 */
id|desc
op_assign
l_string|&quot;Busy&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INVALID_SGL
suffix:colon
multiline_comment|/* 0x0003 */
id|desc
op_assign
l_string|&quot;Invalid SGL&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INTERNAL_ERROR
suffix:colon
multiline_comment|/* 0x0004 */
id|desc
op_assign
l_string|&quot;Internal Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_RESERVED
suffix:colon
multiline_comment|/* 0x0005 */
id|desc
op_assign
l_string|&quot;Reserved&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INSUFFICIENT_RESOURCES
suffix:colon
multiline_comment|/* 0x0006 */
id|desc
op_assign
l_string|&quot;Insufficient Resources&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INVALID_FIELD
suffix:colon
multiline_comment|/* 0x0007 */
id|desc
op_assign
l_string|&quot;Invalid Field&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INVALID_STATE
suffix:colon
multiline_comment|/* 0x0008 */
id|desc
op_assign
l_string|&quot;Invalid State&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_CONFIG_INVALID_ACTION
suffix:colon
multiline_comment|/* 0x0020 */
r_case
id|MPI_IOCSTATUS_CONFIG_INVALID_TYPE
suffix:colon
multiline_comment|/* 0x0021 */
r_case
id|MPI_IOCSTATUS_CONFIG_INVALID_PAGE
suffix:colon
multiline_comment|/* 0x0022 */
r_case
id|MPI_IOCSTATUS_CONFIG_INVALID_DATA
suffix:colon
multiline_comment|/* 0x0023 */
r_case
id|MPI_IOCSTATUS_CONFIG_NO_DEFAULTS
suffix:colon
multiline_comment|/* 0x0024 */
r_case
id|MPI_IOCSTATUS_CONFIG_CANT_COMMIT
suffix:colon
multiline_comment|/* 0x0025 */
multiline_comment|/* No message for Config IOCStatus values */
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
suffix:colon
multiline_comment|/* 0x0040 */
multiline_comment|/* No message for recovered error&n;&t;&t;desc = &quot;SCSI Recovered Error&quot;;&n;&t;&t;*/
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_INVALID_BUS
suffix:colon
multiline_comment|/* 0x0041 */
id|desc
op_assign
l_string|&quot;SCSI Invalid Bus&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_INVALID_TARGETID
suffix:colon
multiline_comment|/* 0x0042 */
id|desc
op_assign
l_string|&quot;SCSI Invalid TargetID&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE
suffix:colon
multiline_comment|/* 0x0043 */
(brace
id|SCSIIORequest_t
op_star
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|U8
id|cdb
op_assign
id|pScsiReq-&gt;CDB
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cdb
op_ne
l_int|0x12
)paren
(brace
multiline_comment|/* Inquiry is issued for device scanning */
id|desc
op_assign
l_string|&quot;SCSI Device Not There&quot;
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|MPI_IOCSTATUS_SCSI_DATA_OVERRUN
suffix:colon
multiline_comment|/* 0x0044 */
id|desc
op_assign
l_string|&quot;SCSI Data Overrun&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
suffix:colon
multiline_comment|/* 0x0045 */
multiline_comment|/* This error is checked in scsi_io_done(). Skip. &n;&t;&t;desc = &quot;SCSI Data Underrun&quot;;&n;&t;&t;*/
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_IO_DATA_ERROR
suffix:colon
multiline_comment|/* 0x0046 */
id|desc
op_assign
l_string|&quot;SCSI I/O Data Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR
suffix:colon
multiline_comment|/* 0x0047 */
id|desc
op_assign
l_string|&quot;SCSI Protocol Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_TASK_TERMINATED
suffix:colon
multiline_comment|/* 0x0048 */
id|desc
op_assign
l_string|&quot;SCSI Task Terminated&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH
suffix:colon
multiline_comment|/* 0x0049 */
id|desc
op_assign
l_string|&quot;SCSI Residual Mismatch&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
suffix:colon
multiline_comment|/* 0x004A */
id|desc
op_assign
l_string|&quot;SCSI Task Management Failed&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_IOC_TERMINATED
suffix:colon
multiline_comment|/* 0x004B */
id|desc
op_assign
l_string|&quot;SCSI IOC Terminated&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_EXT_TERMINATED
suffix:colon
multiline_comment|/* 0x004C */
id|desc
op_assign
l_string|&quot;SCSI Ext Terminated&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|desc
op_assign
l_string|&quot;Others&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|desc
op_ne
l_string|&quot;&quot;
)paren
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;IOCStatus(0x%04x): %s&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|status
comma
id|desc
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|ioc_list
id|EXPORT_SYMBOL
c_func
(paren
id|ioc_list
)paren
suffix:semicolon
DECL|variable|mpt_proc_root_dir
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_proc_root_dir
)paren
suffix:semicolon
DECL|variable|mpt_register
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_register
)paren
suffix:semicolon
DECL|variable|mpt_deregister
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_deregister
)paren
suffix:semicolon
DECL|variable|mpt_event_register
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_event_register
)paren
suffix:semicolon
DECL|variable|mpt_event_deregister
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_event_deregister
)paren
suffix:semicolon
DECL|variable|mpt_reset_register
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_reset_register
)paren
suffix:semicolon
DECL|variable|mpt_reset_deregister
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_reset_deregister
)paren
suffix:semicolon
DECL|variable|mpt_device_driver_register
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_device_driver_register
)paren
suffix:semicolon
DECL|variable|mpt_device_driver_deregister
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_device_driver_deregister
)paren
suffix:semicolon
DECL|variable|mpt_get_msg_frame
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_get_msg_frame
)paren
suffix:semicolon
DECL|variable|mpt_put_msg_frame
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_put_msg_frame
)paren
suffix:semicolon
DECL|variable|mpt_free_msg_frame
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_free_msg_frame
)paren
suffix:semicolon
DECL|variable|mpt_add_sge
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_add_sge
)paren
suffix:semicolon
DECL|variable|mpt_send_handshake_request
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_send_handshake_request
)paren
suffix:semicolon
DECL|variable|mpt_verify_adapter
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_verify_adapter
)paren
suffix:semicolon
DECL|variable|mpt_GetIocState
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_GetIocState
)paren
suffix:semicolon
DECL|variable|mpt_print_ioc_summary
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_print_ioc_summary
)paren
suffix:semicolon
DECL|variable|mpt_lan_index
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_lan_index
)paren
suffix:semicolon
DECL|variable|mpt_stm_index
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_stm_index
)paren
suffix:semicolon
DECL|variable|mpt_HardResetHandler
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_HardResetHandler
)paren
suffix:semicolon
DECL|variable|mpt_config
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_config
)paren
suffix:semicolon
DECL|variable|mpt_toolbox
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_toolbox
)paren
suffix:semicolon
DECL|variable|mpt_findImVolumes
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_findImVolumes
)paren
suffix:semicolon
DECL|variable|mpt_read_ioc_pg_3
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_read_ioc_pg_3
)paren
suffix:semicolon
DECL|variable|mpt_alloc_fw_memory
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_alloc_fw_memory
)paren
suffix:semicolon
DECL|variable|mpt_free_fw_memory
id|EXPORT_SYMBOL
c_func
(paren
id|mpt_free_fw_memory
)paren
suffix:semicolon
DECL|variable|mptbase_driver
r_static
r_struct
id|pci_driver
id|mptbase_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;mptbase&quot;
comma
dot
id|id_table
op_assign
id|mptbase_pci_table
comma
dot
id|probe
op_assign
id|mptbase_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|mptbase_remove
)paren
comma
dot
id|driver
op_assign
(brace
dot
id|shutdown
op_assign
id|mptbase_shutdown
comma
)brace
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|mptbase_suspend
comma
dot
id|resume
op_assign
id|mptbase_resume
comma
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;fusion_init - Fusion MPT base driver initialization routine.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
id|__init
DECL|function|fusion_init
id|fusion_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|r
suffix:semicolon
r_if
c_cond
(paren
id|FusionInitCalled
op_increment
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: INFO - Driver late-init entry point called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|show_mptmod_ver
c_func
(paren
id|my_NAME
comma
id|my_VERSION
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|COPYRIGHT
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MPT_MAX_PROTOCOL_DRIVERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|MptCallbacks
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|MptDriverClass
(braket
id|i
)braket
op_assign
id|MPTUNKNOWN_DRIVER
suffix:semicolon
id|MptEvHandlers
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|MptResetHandlers
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* NEW!  20010120 -sralston&n;&t; *  Register ourselves (mptbase) in order to facilitate&n;&t; *  EventNotification handling.&n;&t; */
id|mpt_base_index
op_assign
id|mpt_register
c_func
(paren
id|mpt_base_reply
comma
id|MPTBASE_DRIVER
)paren
suffix:semicolon
multiline_comment|/* Register for hard reset handling callbacks.&n;&t; */
r_if
c_cond
(paren
id|mpt_reset_register
c_func
(paren
id|mpt_base_index
comma
id|mpt_ioc_reset
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Register for IOC reset notification&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FIXME! */
)brace
macro_line|#ifdef CONFIG_PROC_FS
(paren
r_void
)paren
id|procmpt_create
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|r
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|mptbase_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
r_return
id|r
suffix:semicolon
)brace
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;fusion_exit - Perform driver unload cleanup.&n; *&n; *&t;This routine frees all resources associated with each MPT adapter&n; *&t;and removes all %MPT_PROCFS_MPTBASEDIR entries.&n; */
r_static
r_void
id|__exit
DECL|function|fusion_exit
id|fusion_exit
c_func
(paren
r_void
)paren
(brace
id|dexitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: fusion_exit() called!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|mptbase_driver
)paren
suffix:semicolon
id|mpt_reset_deregister
c_func
(paren
id|mpt_base_index
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|procmpt_destroy
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|fusion_init
id|module_init
c_func
(paren
id|fusion_init
)paren
suffix:semicolon
DECL|variable|fusion_exit
id|module_exit
c_func
(paren
id|fusion_exit
)paren
suffix:semicolon
eof
