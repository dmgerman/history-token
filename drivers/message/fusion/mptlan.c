multiline_comment|/*&n; *  linux/drivers/message/fusion/mptlan.c&n; *      IP Over Fibre Channel device driver.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      Special thanks goes to the I2O LAN driver people at the&n; *      University of Helsinki, who, unbeknownst to them, provided&n; *      the inspiration and initial structure for this driver.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      A really huge debt of gratitude is owed to Eddie C. Dost&n; *      for gobs of hard work fixing and optimizing LAN code.&n; *      THANK YOU!&n; *&n; *      (see also mptbase.c)&n; *&n; *  Copyright (c) 2000-2002 LSI Logic Corporation&n; *  Originally By: Noah Romer&n; *&n; *  $Id: mptlan.c,v 1.52 2002/05/06 13:45:07 sshirron Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Define statements used for debugging&n; */
singleline_comment|//#define MPT_LAN_IO_DEBUG
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &quot;mptlan.h&quot;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptlan&quot;
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * MPT LAN message sizes without variable part.&n; */
DECL|macro|MPT_LAN_RECEIVE_POST_REQUEST_SIZE
mdefine_line|#define MPT_LAN_RECEIVE_POST_REQUEST_SIZE &bslash;&n;&t;(sizeof(LANReceivePostRequest_t) - sizeof(SGE_MPI_UNION))
DECL|macro|MPT_LAN_TRANSACTION32_SIZE
mdefine_line|#define MPT_LAN_TRANSACTION32_SIZE &bslash;&n;&t;(sizeof(SGETransaction32_t) - sizeof(u32))
multiline_comment|/*&n; *  Fusion MPT LAN private structures&n; */
DECL|struct|NAA_Hosed
r_struct
id|NAA_Hosed
(brace
DECL|member|NAA
id|u16
id|NAA
suffix:semicolon
DECL|member|ieee
id|u8
id|ieee
(braket
id|FC_ALEN
)braket
suffix:semicolon
DECL|member|next
r_struct
id|NAA_Hosed
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|BufferControl
r_struct
id|BufferControl
(brace
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|member|dma
id|dma_addr_t
id|dma
suffix:semicolon
DECL|member|len
r_int
r_int
id|len
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|mpt_lan_priv
r_struct
id|mpt_lan_priv
(brace
DECL|member|mpt_dev
id|MPT_ADAPTER
op_star
id|mpt_dev
suffix:semicolon
DECL|member|pnum
id|u8
id|pnum
suffix:semicolon
multiline_comment|/* Port number in the IOC. This is not a Unix network port! */
DECL|member|buckets_out
id|atomic_t
id|buckets_out
suffix:semicolon
multiline_comment|/* number of unused buckets on IOC */
DECL|member|bucketthresh
r_int
id|bucketthresh
suffix:semicolon
multiline_comment|/* Send more when this many left */
DECL|member|mpt_txfidx
r_int
op_star
id|mpt_txfidx
suffix:semicolon
multiline_comment|/* Free Tx Context list */
DECL|member|mpt_txfidx_tail
r_int
id|mpt_txfidx_tail
suffix:semicolon
DECL|member|txfidx_lock
id|spinlock_t
id|txfidx_lock
suffix:semicolon
DECL|member|mpt_rxfidx
r_int
op_star
id|mpt_rxfidx
suffix:semicolon
multiline_comment|/* Free Rx Context list */
DECL|member|mpt_rxfidx_tail
r_int
id|mpt_rxfidx_tail
suffix:semicolon
DECL|member|rxfidx_lock
id|spinlock_t
id|rxfidx_lock
suffix:semicolon
DECL|member|RcvCtl
r_struct
id|BufferControl
op_star
id|RcvCtl
suffix:semicolon
multiline_comment|/* Receive BufferControl structs */
DECL|member|SendCtl
r_struct
id|BufferControl
op_star
id|SendCtl
suffix:semicolon
multiline_comment|/* Send BufferControl structs */
DECL|member|max_buckets_out
r_int
id|max_buckets_out
suffix:semicolon
multiline_comment|/* Max buckets to send to IOC */
DECL|member|tx_max_out
r_int
id|tx_max_out
suffix:semicolon
multiline_comment|/* IOC&squot;s Tx queue len */
DECL|member|total_posted
id|u32
id|total_posted
suffix:semicolon
DECL|member|total_received
id|u32
id|total_received
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
multiline_comment|/* Per device statistics */
DECL|member|post_buckets_task
r_struct
id|tq_struct
id|post_buckets_task
suffix:semicolon
DECL|member|post_buckets_active
r_int
r_int
id|post_buckets_active
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|mpt_lan_ohdr
r_struct
id|mpt_lan_ohdr
(brace
DECL|member|dtype
id|u16
id|dtype
suffix:semicolon
DECL|member|daddr
id|u8
id|daddr
(braket
id|FC_ALEN
)braket
suffix:semicolon
DECL|member|stype
id|u16
id|stype
suffix:semicolon
DECL|member|saddr
id|u8
id|saddr
(braket
id|FC_ALEN
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Forward protos...&n; */
r_static
r_int
id|lan_reply
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|mpt_lan_post_receive_buckets
c_func
(paren
r_void
op_star
id|dev_id
)paren
suffix:semicolon
r_static
r_void
id|mpt_lan_wake_post_buckets_task
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|priority
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_receive_post_turbo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|tmsg
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_receive_post_reply
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|LANReceivePostReply_t
op_star
id|pRecvRep
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_send_turbo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|tmsg
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_send_reply
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|LANSendReply_t
op_star
id|pSendRep
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
suffix:semicolon
r_static
r_int
id|mpt_lan_event_process
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEvReply
)paren
suffix:semicolon
r_static
r_int
r_int
id|mpt_lan_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Fusion MPT LAN private data&n; */
DECL|variable|LanCtx
r_static
r_int
id|LanCtx
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|max_buckets_out
r_static
id|u32
id|max_buckets_out
op_assign
l_int|127
suffix:semicolon
DECL|variable|tx_max_out_p
r_static
id|u32
id|tx_max_out_p
op_assign
l_int|127
op_minus
l_int|16
suffix:semicolon
DECL|variable|mpt_landev
r_static
r_struct
id|net_device
op_star
id|mpt_landev
(braket
id|MPT_MAX_ADAPTERS
op_plus
l_int|1
)braket
suffix:semicolon
macro_line|#ifdef QLOGIC_NAA_WORKAROUND
DECL|variable|mpt_bad_naa
r_static
r_struct
id|NAA_Hosed
op_star
id|mpt_bad_naa
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|bad_naa_lock
id|rwlock_t
id|bad_naa_lock
suffix:semicolon
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Fusion MPT LAN external data&n; */
r_extern
r_int
id|mpt_lan_index
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;lan_reply - Handle all data sent from the hardware.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to original MPT request frame (NULL if TurboReply)&n; *&t;@reply: Pointer to MPT reply frame&n; *&n; *&t;Returns 1 indicating original alloc&squot;d request frame ptr&n; *&t;should be freed, or 0 if it shouldn&squot;t.&n; */
r_static
r_int
DECL|function|lan_reply
id|lan_reply
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|mpt_landev
(braket
id|ioc-&gt;id
)braket
suffix:semicolon
r_int
id|FreeReqFrame
op_assign
l_int|0
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: Got reply.&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
)paren
)paren
suffix:semicolon
singleline_comment|//&t;dioprintk((KERN_INFO MYNAM &quot;@lan_reply: mf = %p, reply = %p&bslash;n&quot;,
singleline_comment|//&t;&t;&t;mf, reply));
r_if
c_cond
(paren
id|mf
op_eq
l_int|NULL
)paren
(brace
id|u32
id|tmsg
op_assign
id|CAST_PTR_TO_U32
c_func
(paren
id|reply
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: @lan_reply, tmsg %08x&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|tmsg
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|GET_LAN_FORM
c_func
(paren
id|tmsg
)paren
)paren
(brace
singleline_comment|// NOTE!  (Optimization) First case here is now caught in
singleline_comment|//  mptbase.c::mpt_interrupt() routine and callcack here
singleline_comment|//  is now skipped for this case!  20001218 -sralston
macro_line|#if 0
r_case
id|LAN_REPLY_FORM_MESSAGE_CONTEXT
suffix:colon
singleline_comment|//&t;&t;&t;dioprintk((KERN_INFO MYNAM &quot;/lan_reply: &quot;
singleline_comment|//&t;&t;&t;&t;  &quot;MessageContext turbo reply received&bslash;n&quot;));
id|FreeReqFrame
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|LAN_REPLY_FORM_SEND_SINGLE
suffix:colon
singleline_comment|//&t;&t;&t;dioprintk((MYNAM &quot;/lan_reply: &quot;
singleline_comment|//&t;&t;&t;&t;  &quot;calling mpt_lan_send_reply (turbo)&bslash;n&quot;));
singleline_comment|// Potential BUG here?  -sralston
singleline_comment|//&t;FreeReqFrame = mpt_lan_send_turbo(dev, tmsg);
singleline_comment|//  If/when mpt_lan_send_turbo would return 1 here,
singleline_comment|//  calling routine (mptbase.c|mpt_interrupt)
singleline_comment|//  would Oops because mf has already been set
singleline_comment|//  to NULL.  So after return from this func,
singleline_comment|//  mpt_interrupt() will attempt to put (NULL) mf ptr
singleline_comment|//  item back onto it&squot;s adapter FreeQ - Oops!:-(
singleline_comment|//  It&squot;s Ok, since mpt_lan_send_turbo() *currently*
singleline_comment|//  always returns 0, but..., just in case:
(paren
r_void
)paren
id|mpt_lan_send_turbo
c_func
(paren
id|dev
comma
id|tmsg
)paren
suffix:semicolon
id|FreeReqFrame
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LAN_REPLY_FORM_RECEIVE_SINGLE
suffix:colon
singleline_comment|//&t;&t;&t;dioprintk((KERN_INFO MYNAM &quot;@lan_reply: &quot;
singleline_comment|//&t;&t;&t;&t;  &quot;rcv-Turbo = %08x&bslash;n&quot;, tmsg));
id|mpt_lan_receive_post_turbo
c_func
(paren
id|dev
comma
id|tmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;/lan_reply: Got a turbo reply &quot;
l_string|&quot;that I don&squot;t know what to do with&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* CHECKME!  Hmmm...  FreeReqFrame is 0 here; is that right? */
r_break
suffix:semicolon
)brace
r_return
id|FreeReqFrame
suffix:semicolon
)brace
singleline_comment|//&t;msg = (u32 *) reply;
singleline_comment|//&t;dioprintk((KERN_INFO MYNAM &quot;@lan_reply: msg = %08x %08x %08x %08x&bslash;n&quot;,
singleline_comment|//&t;&t;  le32_to_cpu(msg[0]), le32_to_cpu(msg[1]),
singleline_comment|//&t;&t;  le32_to_cpu(msg[2]), le32_to_cpu(msg[3])));
singleline_comment|//&t;dioprintk((KERN_INFO MYNAM &quot;@lan_reply: Function = %02xh&bslash;n&quot;,
singleline_comment|//&t;&t;  reply-&gt;u.hdr.Function));
r_switch
c_cond
(paren
id|reply-&gt;u.hdr.Function
)paren
(brace
r_case
id|MPI_FUNCTION_LAN_SEND
suffix:colon
(brace
id|LANSendReply_t
op_star
id|pSendRep
suffix:semicolon
id|pSendRep
op_assign
(paren
id|LANSendReply_t
op_star
)paren
id|reply
suffix:semicolon
id|FreeReqFrame
op_assign
id|mpt_lan_send_reply
c_func
(paren
id|dev
comma
id|pSendRep
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|MPI_FUNCTION_LAN_RECEIVE
suffix:colon
(brace
id|LANReceivePostReply_t
op_star
id|pRecvRep
suffix:semicolon
id|pRecvRep
op_assign
(paren
id|LANReceivePostReply_t
op_star
)paren
id|reply
suffix:semicolon
r_if
c_cond
(paren
id|pRecvRep-&gt;NumberOfContexts
)paren
(brace
id|mpt_lan_receive_post_reply
c_func
(paren
id|dev
comma
id|pRecvRep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pRecvRep-&gt;MsgFlags
op_amp
id|MPI_MSGFLAGS_CONTINUATION_REPLY
)paren
)paren
id|FreeReqFrame
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;@lan_reply: zero context &quot;
l_string|&quot;ReceivePostReply received.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|MPI_FUNCTION_LAN_RESET
suffix:colon
multiline_comment|/* Just a default reply. Might want to check it to&n;&t;&t; * make sure that everything went ok.&n;&t;&t; */
id|FreeReqFrame
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_EVENT_NOTIFICATION
suffix:colon
r_case
id|MPI_FUNCTION_EVENT_ACK
suffix:colon
multiline_comment|/* UPDATE!  20010120 -sralston&n;&t;&t; *  _EVENT_NOTIFICATION should NOT come down this path any more.&n;&t;&t; *  Should be routed to mpt_lan_event_process(), but just in case...&n;&t;&t; */
id|FreeReqFrame
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;/lan_reply: Got a non-turbo &quot;
l_string|&quot;reply that I don&squot;t know what to do with&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* CHECKME!  Hmmm...  FreeReqFrame is 0 here; is that right? */
id|FreeReqFrame
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|FreeReqFrame
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_ioc_reset
id|mpt_lan_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|mpt_landev
(braket
id|ioc-&gt;id
)braket
suffix:semicolon
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: IOC %s_reset routed to LAN driver!&bslash;n&quot;
comma
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
ques
c_cond
l_string|&quot;pre&quot;
suffix:colon
l_string|&quot;post&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;mpt_rxfidx
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dlprintk
(paren
(paren
id|KERN_INFO
l_string|&quot;mptlan/ioc_reset: called netif_stop_queue for %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|priv-&gt;buckets_out
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset Rx Free Tail index and re-populate the queue. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx_tail
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|priv-&gt;max_buckets_out
suffix:semicolon
id|i
op_increment
)paren
id|priv-&gt;mpt_rxfidx
(braket
op_increment
id|priv-&gt;mpt_rxfidx_tail
)braket
op_assign
id|i
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|mpt_lan_post_receive_buckets
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_event_process
id|mpt_lan_event_process
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEvReply
)paren
(brace
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT event routed to LAN driver!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|pEvReply-&gt;Event
)paren
)paren
(brace
r_case
id|MPI_EVENT_NONE
suffix:colon
multiline_comment|/* 00 */
r_case
id|MPI_EVENT_LOG_DATA
suffix:colon
multiline_comment|/* 01 */
r_case
id|MPI_EVENT_STATE_CHANGE
suffix:colon
multiline_comment|/* 02 */
r_case
id|MPI_EVENT_UNIT_ATTENTION
suffix:colon
multiline_comment|/* 03 */
r_case
id|MPI_EVENT_IOC_BUS_RESET
suffix:colon
multiline_comment|/* 04 */
r_case
id|MPI_EVENT_EXT_BUS_RESET
suffix:colon
multiline_comment|/* 05 */
r_case
id|MPI_EVENT_RESCAN
suffix:colon
multiline_comment|/* 06 */
multiline_comment|/* Ok, do we need to do anything here? As far as&n;&t;&t;   I can tell, this is when a new device gets added&n;&t;&t;   to the loop. */
r_case
id|MPI_EVENT_LINK_STATUS_CHANGE
suffix:colon
multiline_comment|/* 07 */
r_case
id|MPI_EVENT_LOOP_STATE_CHANGE
suffix:colon
multiline_comment|/* 08 */
r_case
id|MPI_EVENT_LOGOUT
suffix:colon
multiline_comment|/* 09 */
r_case
id|MPI_EVENT_EVENT_CHANGE
suffix:colon
multiline_comment|/* 0A */
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  NOTE: pEvent-&gt;AckRequired handling now done in mptbase.c;&n;&t; *  Do NOT do it here now!&n;&t; */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_open
id|mpt_lan_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|mpt_lan_reset
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;/lan_open: lan_reset failed.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_dev-&gt;active
)paren
id|printk
(paren
l_string|&quot;The ioc is active. Perhaps it needs to be&quot;
l_string|&quot; reset?&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;The ioc in inactive, most likely in the &quot;
l_string|&quot;process of being reset. Please try again in &quot;
l_string|&quot;a moment.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|priv-&gt;mpt_txfidx
op_assign
id|kmalloc
c_func
(paren
id|priv-&gt;tx_max_out
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;mpt_txfidx
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|priv-&gt;mpt_txfidx_tail
op_assign
op_minus
l_int|1
suffix:semicolon
id|priv-&gt;SendCtl
op_assign
id|kmalloc
c_func
(paren
id|priv-&gt;tx_max_out
op_star
r_sizeof
(paren
r_struct
id|BufferControl
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;SendCtl
op_eq
l_int|NULL
)paren
r_goto
id|out_mpt_txfidx
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|priv-&gt;tx_max_out
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|priv-&gt;SendCtl
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|BufferControl
)paren
)paren
suffix:semicolon
id|priv-&gt;mpt_txfidx
(braket
op_increment
id|priv-&gt;mpt_txfidx_tail
)braket
op_assign
id|i
suffix:semicolon
)brace
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;@lo: Finished initializing SendCtl&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx
op_assign
id|kmalloc
c_func
(paren
id|priv-&gt;max_buckets_out
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;mpt_rxfidx
op_eq
l_int|NULL
)paren
r_goto
id|out_SendCtl
suffix:semicolon
id|priv-&gt;mpt_rxfidx_tail
op_assign
op_minus
l_int|1
suffix:semicolon
id|priv-&gt;RcvCtl
op_assign
id|kmalloc
c_func
(paren
id|priv-&gt;max_buckets_out
op_star
r_sizeof
(paren
r_struct
id|BufferControl
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;RcvCtl
op_eq
l_int|NULL
)paren
r_goto
id|out_mpt_rxfidx
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|priv-&gt;max_buckets_out
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|priv-&gt;RcvCtl
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|BufferControl
)paren
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx
(braket
op_increment
id|priv-&gt;mpt_rxfidx_tail
)braket
op_assign
id|i
suffix:semicolon
)brace
multiline_comment|/**/
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/lo: txfidx contains - &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/**/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|priv-&gt;tx_max_out
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/**/
id|dlprintk
c_func
(paren
(paren
l_string|&quot; %xh&quot;
comma
id|priv-&gt;mpt_txfidx
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/**/
id|dlprintk
c_func
(paren
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/lo: Finished initializing RcvCtl&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mpt_lan_post_receive_buckets
c_func
(paren
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: interface up &amp; active&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_event_register
c_func
(paren
id|LanCtx
comma
id|mpt_lan_event_process
)paren
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;/lo: Unable to register for Event&quot;
l_string|&quot; Notifications. This is a bad thing! We&squot;re not going &quot;
l_string|&quot;to go ahead, but I&squot;d be leery of system stability at &quot;
l_string|&quot;this point.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/lo: Done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_mpt_rxfidx
suffix:colon
id|kfree
c_func
(paren
id|priv-&gt;mpt_rxfidx
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx
op_assign
l_int|NULL
suffix:semicolon
id|out_SendCtl
suffix:colon
id|kfree
c_func
(paren
id|priv-&gt;SendCtl
)paren
suffix:semicolon
id|priv-&gt;SendCtl
op_assign
l_int|NULL
suffix:semicolon
id|out_mpt_txfidx
suffix:colon
id|kfree
c_func
(paren
id|priv-&gt;mpt_txfidx
)paren
suffix:semicolon
id|priv-&gt;mpt_txfidx
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Send a LanReset message to the FW. This should result in the FW returning&n;   any buckets it still has. */
r_static
r_int
DECL|function|mpt_lan_reset
id|mpt_lan_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|LANResetRequest_t
op_star
id|pResetReq
suffix:semicolon
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|LanCtx
comma
id|priv-&gt;mpt_dev-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;dlprintk((KERN_ERR MYNAM &quot;/reset: Evil funkiness abounds! &quot;&n;&t;&t;&quot;Unable to allocate a request frame.&bslash;n&quot;));&n;*/
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pResetReq
op_assign
(paren
id|LANResetRequest_t
op_star
)paren
id|mf
suffix:semicolon
id|pResetReq-&gt;Function
op_assign
id|MPI_FUNCTION_LAN_RESET
suffix:semicolon
id|pResetReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pResetReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pResetReq-&gt;PortNumber
op_assign
id|priv-&gt;pnum
suffix:semicolon
id|pResetReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pResetReq-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|LanCtx
comma
id|priv-&gt;mpt_dev-&gt;id
comma
id|mf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_close
id|mpt_lan_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: mpt_lan_close called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mpt_event_deregister
c_func
(paren
id|LanCtx
)paren
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;:lan_close: Posted %d buckets &quot;
l_string|&quot;since driver was loaded, %d still out&bslash;n&quot;
comma
id|priv-&gt;total_posted
comma
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
)paren
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mpt_lan_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|timeout
op_assign
l_int|2
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
op_logical_and
op_decrement
id|timeout
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|priv-&gt;max_buckets_out
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;RcvCtl
(braket
id|i
)braket
dot
id|skb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/**/
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/lan_close: bucket %05x &quot;
multiline_comment|/**/
l_string|&quot;is still out&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;RcvCtl
(braket
id|i
)braket
dot
id|dma
comma
id|priv-&gt;RcvCtl
(braket
id|i
)braket
dot
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|priv-&gt;RcvCtl
(braket
id|i
)braket
dot
id|skb
)paren
suffix:semicolon
)brace
)brace
id|kfree
(paren
id|priv-&gt;RcvCtl
)paren
suffix:semicolon
id|kfree
(paren
id|priv-&gt;mpt_rxfidx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|priv-&gt;tx_max_out
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;SendCtl
(braket
id|i
)braket
dot
id|skb
op_ne
l_int|NULL
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;SendCtl
(braket
id|i
)braket
dot
id|dma
comma
id|priv-&gt;SendCtl
(braket
id|i
)braket
dot
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|priv-&gt;SendCtl
(braket
id|i
)braket
dot
id|skb
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|priv-&gt;SendCtl
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|priv-&gt;mpt_txfidx
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|priv-&gt;buckets_out
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: interface down &amp; inactive&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_struct
id|net_device_stats
op_star
DECL|function|mpt_lan_get_stats
id|mpt_lan_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
(paren
r_struct
id|net_device_stats
op_star
)paren
op_amp
id|priv-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_change_mtu
id|mpt_lan_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_mtu
OL
id|MPT_LAN_MIN_MTU
)paren
op_logical_or
(paren
id|new_mtu
OG
id|MPT_LAN_MAX_MTU
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Tx timeout handler. */
r_static
r_void
DECL|function|mpt_lan_tx_timeout
id|mpt_lan_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
r_if
c_cond
(paren
id|mpt_dev-&gt;active
)paren
(brace
id|dlprintk
(paren
(paren
l_string|&quot;mptlan/tx_timeout: calling netif_wake_queue for %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
singleline_comment|//static inline int
r_static
r_int
DECL|function|mpt_lan_send_turbo
id|mpt_lan_send_turbo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|tmsg
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|sent
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|ctx
suffix:semicolon
id|ctx
op_assign
id|GET_LAN_BUFFER_CONTEXT
c_func
(paren
id|tmsg
)paren
suffix:semicolon
id|sent
op_assign
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|skb
suffix:semicolon
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_bytes
op_add_assign
id|sent-&gt;len
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: @%s, skb %p sent.&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|__FUNCTION__
comma
id|sent
)paren
)paren
suffix:semicolon
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|sent
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;txfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;mpt_txfidx
(braket
op_increment
id|priv-&gt;mpt_txfidx_tail
)braket
op_assign
id|ctx
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;txfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_send_reply
id|mpt_lan_send_reply
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|LANSendReply_t
op_star
id|pSendRep
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|sent
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|FreeReqFrame
op_assign
l_int|0
suffix:semicolon
id|u32
op_star
id|pContext
suffix:semicolon
id|u32
id|ctx
suffix:semicolon
id|u8
id|count
suffix:semicolon
id|count
op_assign
id|pSendRep-&gt;NumberOfContexts
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: send_reply: IOCStatus: %04x&bslash;n&quot;
comma
id|le16_to_cpu
c_func
(paren
id|pSendRep-&gt;IOCStatus
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Add check for Loginfo Flag in IOCStatus */
r_switch
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|pSendRep-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
)paren
(brace
r_case
id|MPI_IOCSTATUS_SUCCESS
suffix:colon
id|priv-&gt;stats.tx_packets
op_add_assign
id|count
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_LAN_CANCELED
suffix:colon
r_case
id|MPI_IOCSTATUS_LAN_TRANSMIT_ABORTED
suffix:colon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INVALID_SGL
suffix:colon
id|priv-&gt;stats.tx_errors
op_add_assign
id|count
suffix:semicolon
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s/%s: ERROR - Invalid SGL sent to IOC!&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
id|priv-&gt;stats.tx_errors
op_add_assign
id|count
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pContext
op_assign
op_amp
id|pSendRep-&gt;BufferContext
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;txfidx_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|ctx
op_assign
id|GET_LAN_BUFFER_CONTEXT
c_func
(paren
id|le32_to_cpu
c_func
(paren
op_star
id|pContext
)paren
)paren
suffix:semicolon
id|sent
op_assign
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|skb
suffix:semicolon
id|priv-&gt;stats.tx_bytes
op_add_assign
id|sent-&gt;len
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: @%s, skb %p sent.&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|__FUNCTION__
comma
id|sent
)paren
)paren
suffix:semicolon
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|sent
)paren
suffix:semicolon
id|priv-&gt;mpt_txfidx
(braket
op_increment
id|priv-&gt;mpt_txfidx_tail
)braket
op_assign
id|ctx
suffix:semicolon
id|pContext
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;txfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSendRep-&gt;MsgFlags
op_amp
id|MPI_MSGFLAGS_CONTINUATION_REPLY
)paren
)paren
id|FreeReqFrame
op_assign
l_int|1
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|FreeReqFrame
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_sdu_send
id|mpt_lan_sdu_send
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|LANSendRequest_t
op_star
id|pSendReq
suffix:semicolon
id|SGETransaction32_t
op_star
id|pTrans
suffix:semicolon
id|SGESimple64_t
op_star
id|pSimple
suffix:semicolon
id|dma_addr_t
id|dma
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ctx
suffix:semicolon
id|u16
id|cur_naa
op_assign
l_int|0x1000
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s called, skb_addr = %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|skb
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;txfidx_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;mpt_txfidx_tail
OL
l_int|0
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;txfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: no tx context available: %u&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|priv-&gt;mpt_txfidx_tail
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|LanCtx
comma
id|mpt_dev-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_eq
l_int|NULL
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;txfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to alloc request frame&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|ctx
op_assign
id|priv-&gt;mpt_txfidx
(braket
id|priv-&gt;mpt_txfidx_tail
op_decrement
)braket
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;txfidx_lock
comma
id|flags
)paren
suffix:semicolon
singleline_comment|//&t;dioprintk((KERN_INFO MYNAM &quot;: %s/%s: Creating new msg frame (send).&bslash;n&quot;,
singleline_comment|//&t;&t;&t;IOC_AND_NETDEV_NAMES_s_s(dev)));
id|pSendReq
op_assign
(paren
id|LANSendRequest_t
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Set the mac.raw pointer, since this apparently isn&squot;t getting&n;&t; * done before we get the skb. Pull the data pointer past the mac data.&n;&t; */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|12
)paren
suffix:semicolon
id|dma
op_assign
id|pci_map_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|skb
op_assign
id|skb
suffix:semicolon
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|dma
op_assign
id|dma
suffix:semicolon
id|priv-&gt;SendCtl
(braket
id|ctx
)braket
dot
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Message Header */
id|pSendReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSendReq-&gt;Function
op_assign
id|MPI_FUNCTION_LAN_SEND
suffix:semicolon
id|pSendReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pSendReq-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSendReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pSendReq-&gt;PortNumber
op_assign
id|priv-&gt;pnum
suffix:semicolon
multiline_comment|/* Transaction Context Element */
id|pTrans
op_assign
(paren
id|SGETransaction32_t
op_star
)paren
id|pSendReq-&gt;SG_List
suffix:semicolon
multiline_comment|/* No Flags, 8 bytes of Details, 32bit Context (bloody turbo replies) */
id|pTrans-&gt;ContextSize
op_assign
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|pTrans-&gt;DetailsLength
op_assign
l_int|2
op_star
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|pTrans-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pTrans-&gt;TransactionContext
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|ctx
)paren
suffix:semicolon
singleline_comment|//&t;dioprintk((KERN_INFO MYNAM &quot;: %s/%s: BC = %08x, skb = %p, buff = %p&bslash;n&quot;,
singleline_comment|//&t;&t;&t;IOC_AND_NETDEV_NAMES_s_s(dev),
singleline_comment|//&t;&t;&t;ctx, skb, skb-&gt;data));
macro_line|#ifdef QLOGIC_NAA_WORKAROUND
(brace
r_struct
id|NAA_Hosed
op_star
id|nh
suffix:semicolon
multiline_comment|/* Munge the NAA for Tx packets to QLogic boards, which don&squot;t follow&n;&t;   RFC 2625. The longer I look at this, the more my opinion of Qlogic&n;&t;   drops. */
id|read_lock_irq
c_func
(paren
op_amp
id|bad_naa_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|nh
op_assign
id|mpt_bad_naa
suffix:semicolon
id|nh
op_ne
l_int|NULL
suffix:semicolon
id|nh
op_assign
id|nh-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|nh-&gt;ieee
(braket
l_int|0
)braket
op_eq
id|skb-&gt;mac.raw
(braket
l_int|0
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|1
)braket
op_eq
id|skb-&gt;mac.raw
(braket
l_int|1
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|2
)braket
op_eq
id|skb-&gt;mac.raw
(braket
l_int|2
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|3
)braket
op_eq
id|skb-&gt;mac.raw
(braket
l_int|3
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|4
)braket
op_eq
id|skb-&gt;mac.raw
(braket
l_int|4
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|5
)braket
op_eq
id|skb-&gt;mac.raw
(braket
l_int|5
)braket
)paren
)paren
(brace
id|cur_naa
op_assign
id|nh-&gt;NAA
suffix:semicolon
id|dlprintk
(paren
(paren
id|KERN_INFO
l_string|&quot;mptlan/sdu_send: using NAA value &quot;
l_string|&quot;= %04x.&bslash;n&quot;
comma
id|cur_naa
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|read_unlock_irq
c_func
(paren
op_amp
id|bad_naa_lock
)paren
suffix:semicolon
)brace
macro_line|#endif
id|pTrans-&gt;TransactionDetails
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|cur_naa
op_lshift
l_int|16
)paren
op_or
(paren
id|skb-&gt;mac.raw
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|skb-&gt;mac.raw
(braket
l_int|1
)braket
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
id|pTrans-&gt;TransactionDetails
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|skb-&gt;mac.raw
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|skb-&gt;mac.raw
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|skb-&gt;mac.raw
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|skb-&gt;mac.raw
(braket
l_int|5
)braket
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
id|pSimple
op_assign
(paren
id|SGESimple64_t
op_star
)paren
op_amp
id|pTrans-&gt;TransactionDetails
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* If we ever decide to send more than one Simple SGE per LANSend, then&n;&t;   we will need to make sure that LAST_ELEMENT only gets set on the&n;&t;   last one. Otherwise, bad voodoo and evil funkiness will commence. */
id|pSimple-&gt;FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
id|MPI_SGE_FLAGS_LAST_ELEMENT
op_or
id|MPI_SGE_FLAGS_END_OF_BUFFER
op_or
id|MPI_SGE_FLAGS_SIMPLE_ELEMENT
op_or
id|MPI_SGE_FLAGS_SYSTEM_ADDRESS
op_or
id|MPI_SGE_FLAGS_HOST_TO_IOC
op_or
id|MPI_SGE_FLAGS_64_BIT_ADDRESSING
op_or
id|MPI_SGE_FLAGS_END_OF_LIST
)paren
op_lshift
id|MPI_SGE_FLAGS_SHIFT
)paren
op_or
id|skb-&gt;len
)paren
suffix:semicolon
id|pSimple-&gt;Address.Low
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
id|dma
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
OG
r_sizeof
(paren
id|u32
)paren
)paren
id|pSimple-&gt;Address.High
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|dma
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
r_else
id|pSimple-&gt;Address.High
op_assign
l_int|0
suffix:semicolon
id|mpt_put_msg_frame
(paren
id|LanCtx
comma
id|mpt_dev-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: Sending packet. FlagsLength = %08x.&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|le32_to_cpu
c_func
(paren
id|pSimple-&gt;FlagsLength
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_inline
r_void
DECL|function|mpt_lan_wake_post_buckets_task
id|mpt_lan_wake_post_buckets_task
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|priority
)paren
multiline_comment|/* &n; * @priority: 0 = put it on the timer queue, 1 = put it on the immediate queue&n; */
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|priv-&gt;post_buckets_active
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|priority
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|priv-&gt;post_buckets_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_else
(brace
id|queue_task
c_func
(paren
op_amp
id|priv-&gt;post_buckets_task
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: post_buckets queued on &quot;
l_string|&quot;timer.&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: Queued post_buckets task.&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_inline
r_int
DECL|function|mpt_lan_receive_skb
id|mpt_lan_receive_skb
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|mpt_lan_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: Incoming packet (%d bytes) &quot;
l_string|&quot;delivered to upper level.&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|skb-&gt;len
)paren
)paren
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|MYNAM
l_string|&quot;/receive_skb: %d buckets remaining&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
OL
id|priv-&gt;bucketthresh
)paren
id|mpt_lan_wake_post_buckets_task
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/receive_post_reply: %d buckets &quot;
l_string|&quot;remaining, %d received back since sod&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
comma
id|priv-&gt;total_received
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
singleline_comment|//static inline int
r_static
r_int
DECL|function|mpt_lan_receive_post_turbo
id|mpt_lan_receive_post_turbo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|tmsg
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|old_skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|ctx
comma
id|len
suffix:semicolon
id|ctx
op_assign
id|GET_LAN_BUCKET_CONTEXT
c_func
(paren
id|tmsg
)paren
suffix:semicolon
id|skb
op_assign
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
suffix:semicolon
id|len
op_assign
id|GET_LAN_PACKET_LENGTH
c_func
(paren
id|tmsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|MPT_LAN_RX_COPYBREAK
)paren
(brace
id|old_skb
op_assign
id|skb
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s/%s: ERROR - Can&squot;t allocate skb! (%s@%d)&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pci_dma_sync_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|old_skb-&gt;data
comma
id|len
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx
(braket
op_increment
id|priv-&gt;mpt_rxfidx_tail
)braket
op_assign
id|ctx
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
id|priv-&gt;total_received
op_increment
suffix:semicolon
r_return
id|mpt_lan_receive_skb
c_func
(paren
id|dev
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_receive_post_free
id|mpt_lan_receive_post_free
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|LANReceivePostReply_t
op_star
id|pRecvRep
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u32
id|ctx
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|i
suffix:semicolon
id|count
op_assign
id|pRecvRep-&gt;NumberOfContexts
suffix:semicolon
multiline_comment|/**/
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/receive_post_reply: &quot;
l_string|&quot;IOC returned %d buckets, freeing them...&bslash;n&quot;
comma
id|count
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ctx
op_assign
id|le32_to_cpu
c_func
(paren
id|pRecvRep-&gt;BucketContext
(braket
id|i
)braket
)paren
suffix:semicolon
id|skb
op_assign
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
suffix:semicolon
singleline_comment|//&t;&t;dlprintk((KERN_INFO MYNAM &quot;: %s: dev_name = %s&bslash;n&quot;,
singleline_comment|//&t;&t;&t;&t;IOC_AND_NETDEV_NAMES_s_s(dev)));
singleline_comment|//&t;&t;dlprintk((KERN_INFO MYNAM &quot;@rpr[2], priv = %p, buckets_out addr = %p&quot;,
singleline_comment|//&t;&t;&t;&t;priv, &amp;(priv-&gt;buckets_out)));
singleline_comment|//&t;&t;dlprintk((KERN_INFO MYNAM &quot;@rpr[2] TC + 3&bslash;n&quot;));
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx
(braket
op_increment
id|priv-&gt;mpt_rxfidx_tail
)braket
op_assign
id|ctx
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_sub
c_func
(paren
id|count
comma
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
singleline_comment|//&t;for (i = 0; i &lt; priv-&gt;max_buckets_out; i++)
singleline_comment|//&t;&t;if (priv-&gt;RcvCtl[i].skb != NULL)
singleline_comment|//&t;&t;&t;dlprintk((KERN_INFO MYNAM &quot;@rpr: bucket %03x &quot;
singleline_comment|//&t;&t;&t;&t;  &quot;is still out&bslash;n&quot;, i));
multiline_comment|/*&t;dlprintk((KERN_INFO MYNAM &quot;/receive_post_reply: freed %d buckets&bslash;n&quot;,&n;&t;&t;  count));&n;*/
multiline_comment|/**/
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;@receive_post_reply: %d buckets &quot;
multiline_comment|/**/
l_string|&quot;remaining, %d received back since sod.&bslash;n&quot;
comma
multiline_comment|/**/
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
comma
id|priv-&gt;total_received
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_lan_receive_post_reply
id|mpt_lan_receive_post_reply
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|LANReceivePostReply_t
op_star
id|pRecvRep
)paren
(brace
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|old_skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|len
comma
id|ctx
comma
id|offset
suffix:semicolon
id|u32
id|remaining
op_assign
id|le32_to_cpu
c_func
(paren
id|pRecvRep-&gt;BucketsRemaining
)paren
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|i
comma
id|l
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: mpt_lan_receive_post_reply called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: receive_post_reply: IOCStatus: %04x&bslash;n&quot;
comma
id|le16_to_cpu
c_func
(paren
id|pRecvRep-&gt;IOCStatus
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|le16_to_cpu
c_func
(paren
id|pRecvRep-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
)paren
op_eq
id|MPI_IOCSTATUS_LAN_CANCELED
)paren
r_return
id|mpt_lan_receive_post_free
c_func
(paren
id|dev
comma
id|pRecvRep
)paren
suffix:semicolon
id|len
op_assign
id|le32_to_cpu
c_func
(paren
id|pRecvRep-&gt;PacketLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s/%s: ERROR - Got a non-TURBO &quot;
l_string|&quot;ReceivePostReply w/ PacketLength zero!&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: MsgFlags = %02x, IOCStatus = %04x&bslash;n&quot;
comma
id|pRecvRep-&gt;MsgFlags
comma
id|le16_to_cpu
c_func
(paren
id|pRecvRep-&gt;IOCStatus
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ctx
op_assign
id|le32_to_cpu
c_func
(paren
id|pRecvRep-&gt;BucketContext
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|count
op_assign
id|pRecvRep-&gt;NumberOfContexts
suffix:semicolon
id|skb
op_assign
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
suffix:semicolon
id|offset
op_assign
id|le32_to_cpu
c_func
(paren
id|pRecvRep-&gt;PacketOffset
)paren
suffix:semicolon
singleline_comment|//&t;if (offset != 0) {
singleline_comment|//&t;&t;printk (KERN_INFO MYNAM &quot;: %s/%s: Got a ReceivePostReply &quot;
singleline_comment|//&t;&t;&t;&quot;w/ PacketOffset %u&bslash;n&quot;,
singleline_comment|//&t;&t;&t;&t;IOC_AND_NETDEV_NAMES_s_s(dev),
singleline_comment|//&t;&t;&t;&t;offset);
singleline_comment|//&t;}
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: @rpr, offset = %d, len = %d&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|offset
comma
id|len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|1
)paren
(brace
r_int
id|szrem
op_assign
id|len
suffix:semicolon
singleline_comment|//&t;&t;dioprintk((KERN_INFO MYNAM &quot;: %s/%s: Multiple buckets returned &quot;
singleline_comment|//&t;&t;&t;&quot;for single packet, concatenating...&bslash;n&quot;,
singleline_comment|//&t;&t;&t;&t;IOC_AND_NETDEV_NAMES_s_s(dev)));
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s/%s: ERROR - Can&squot;t allocate skb! (%s@%d)&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ctx
op_assign
id|le32_to_cpu
c_func
(paren
id|pRecvRep-&gt;BucketContext
(braket
id|i
)braket
)paren
suffix:semicolon
id|old_skb
op_assign
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
suffix:semicolon
id|l
op_assign
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
suffix:semicolon
r_if
c_cond
(paren
id|szrem
OL
id|l
)paren
id|l
op_assign
id|szrem
suffix:semicolon
singleline_comment|//&t;&t;&t;dioprintk((KERN_INFO MYNAM &quot;: %s/%s: Buckets = %d, len = %u&bslash;n&quot;,
singleline_comment|//&t;&t;&t;&t;&t;IOC_AND_NETDEV_NAMES_s_s(dev),
singleline_comment|//&t;&t;&t;&t;&t;i, l));
id|pci_dma_sync_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|l
)paren
comma
id|old_skb-&gt;data
comma
id|l
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx
(braket
op_increment
id|priv-&gt;mpt_rxfidx_tail
)braket
op_assign
id|ctx
suffix:semicolon
id|szrem
op_sub_assign
id|l
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
OL
id|MPT_LAN_RX_COPYBREAK
)paren
(brace
id|old_skb
op_assign
id|skb
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s/%s: ERROR - Can&squot;t allocate skb! (%s@%d)&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pci_dma_sync_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|old_skb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx
(braket
op_increment
id|priv-&gt;mpt_rxfidx_tail
)braket
op_assign
id|ctx
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;mpt_rxfidx
(braket
op_increment
id|priv-&gt;mpt_rxfidx_tail
)braket
op_assign
id|ctx
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
id|atomic_sub
c_func
(paren
id|count
comma
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
id|priv-&gt;total_received
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;mpt_rxfidx_tail
op_ge
id|MPT_LAN_MAX_BUCKETS_OUT
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s/%s: Yoohoo! mpt_rxfidx_tail = %d, &quot;
l_string|&quot;MPT_LAN_MAX_BUCKETS_OUT = %d&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|priv-&gt;mpt_rxfidx_tail
comma
id|MPT_LAN_MAX_BUCKETS_OUT
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Damn it Jim! I&squot;m a doctor, not a programmer! &quot;
l_string|&quot;Oh, wait a sec, I am a programmer. &quot;
l_string|&quot;And, who&squot;s Jim?!?!&bslash;n&quot;
l_string|&quot;Arrgghh! We&squot;ve done it again!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|remaining
op_eq
l_int|0
)paren
id|printk
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s/%s: WARNING - IOC out of buckets! &quot;
l_string|&quot;(priv-&gt;buckets_out = %d)&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|remaining
OL
l_int|10
)paren
id|printk
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: IOC says %d buckets left. &quot;
l_string|&quot;(priv-&gt;buckets_out = %d)&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|remaining
comma
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|remaining
OL
id|priv-&gt;bucketthresh
)paren
op_logical_and
(paren
(paren
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
op_minus
id|remaining
)paren
OG
id|MPT_LAN_BUCKETS_REMAIN_MISMATCH_THRESH
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot; Mismatch between driver&squot;s &quot;
l_string|&quot;buckets_out count and fw&squot;s BucketsRemaining &quot;
l_string|&quot;count has crossed the threshold, issuing a &quot;
l_string|&quot;LanReset to clear the fw&squot;s hashtable. You may &quot;
l_string|&quot;want to check your /var/log/messages for &bslash;&quot;CRC &quot;
l_string|&quot;error&bslash;&quot; event notifications.&bslash;n&quot;
)paren
suffix:semicolon
id|mpt_lan_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mpt_lan_wake_post_buckets_task
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|mpt_lan_receive_skb
c_func
(paren
id|dev
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Simple SGE&squot;s only at the moment */
r_static
r_void
DECL|function|mpt_lan_post_receive_buckets
id|mpt_lan_post_receive_buckets
c_func
(paren
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
id|dev-&gt;priv
suffix:semicolon
id|MPT_ADAPTER
op_star
id|mpt_dev
op_assign
id|priv-&gt;mpt_dev
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|LANReceivePostRequest_t
op_star
id|pRecvReq
suffix:semicolon
id|SGETransaction32_t
op_star
id|pTrans
suffix:semicolon
id|SGESimple64_t
op_star
id|pSimple
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|dma_addr_t
id|dma
suffix:semicolon
id|u32
id|curr
comma
id|buckets
comma
id|count
comma
id|max
suffix:semicolon
id|u32
id|len
op_assign
(paren
id|dev-&gt;mtu
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|4
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|curr
op_assign
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
id|buckets
op_assign
(paren
id|priv-&gt;max_buckets_out
op_minus
id|curr
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: @%s, Start_buckets = %u, buckets_out = %u&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|__FUNCTION__
comma
id|buckets
comma
id|curr
)paren
)paren
suffix:semicolon
id|max
op_assign
(paren
id|mpt_dev-&gt;req_sz
op_minus
id|MPT_LAN_RECEIVE_POST_REQUEST_SIZE
)paren
op_div
(paren
id|MPT_LAN_TRANSACTION32_SIZE
op_plus
r_sizeof
(paren
id|SGESimple64_t
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|buckets
)paren
(brace
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|LanCtx
comma
id|mpt_dev-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to alloc request frame&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s: %u buckets remaining&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|buckets
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|pRecvReq
op_assign
(paren
id|LANReceivePostRequest_t
op_star
)paren
id|mf
suffix:semicolon
id|count
op_assign
id|buckets
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|max
)paren
id|count
op_assign
id|max
suffix:semicolon
id|pRecvReq-&gt;Function
op_assign
id|MPI_FUNCTION_LAN_RECEIVE
suffix:semicolon
id|pRecvReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pRecvReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pRecvReq-&gt;PortNumber
op_assign
id|priv-&gt;pnum
suffix:semicolon
id|pTrans
op_assign
(paren
id|SGETransaction32_t
op_star
)paren
id|pRecvReq-&gt;SG_List
suffix:semicolon
id|pSimple
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|ctx
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;mpt_rxfidx_tail
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t alloc context&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ctx
op_assign
id|priv-&gt;mpt_rxfidx
(braket
id|priv-&gt;mpt_rxfidx_tail
op_decrement
)braket
suffix:semicolon
id|skb
op_assign
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_logical_and
(paren
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
op_ne
id|len
)paren
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
comma
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;/%s: Can&squot;t alloc skb&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|priv-&gt;mpt_rxfidx
(braket
op_increment
id|priv-&gt;mpt_rxfidx_tail
)braket
op_assign
id|ctx
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dma
op_assign
id|pci_map_single
c_func
(paren
id|mpt_dev-&gt;pcidev
comma
id|skb-&gt;data
comma
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|skb
op_assign
id|skb
suffix:semicolon
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
op_assign
id|dma
suffix:semicolon
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;rxfidx_lock
comma
id|flags
)paren
suffix:semicolon
id|pTrans-&gt;ContextSize
op_assign
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|pTrans-&gt;DetailsLength
op_assign
l_int|0
suffix:semicolon
id|pTrans-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pTrans-&gt;TransactionContext
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|pSimple
op_assign
(paren
id|SGESimple64_t
op_star
)paren
id|pTrans-&gt;TransactionDetails
suffix:semicolon
id|pSimple-&gt;FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
id|MPI_SGE_FLAGS_END_OF_BUFFER
op_or
id|MPI_SGE_FLAGS_SIMPLE_ELEMENT
op_or
id|MPI_SGE_FLAGS_64_BIT_ADDRESSING
)paren
op_lshift
id|MPI_SGE_FLAGS_SHIFT
)paren
op_or
id|len
)paren
suffix:semicolon
id|pSimple-&gt;Address.Low
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
OG
r_sizeof
(paren
id|u32
)paren
)paren
id|pSimple-&gt;Address.High
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|priv-&gt;RcvCtl
(braket
id|ctx
)braket
dot
id|dma
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
r_else
id|pSimple-&gt;Address.High
op_assign
l_int|0
suffix:semicolon
id|pTrans
op_assign
(paren
id|SGETransaction32_t
op_star
)paren
(paren
id|pSimple
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSimple
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/**/
id|printk
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;/%s: No buckets posted&bslash;n&quot;
comma
multiline_comment|/**/
id|__FUNCTION__
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|LanCtx
comma
id|mpt_dev-&gt;id
comma
id|mf
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|pSimple-&gt;FlagsLength
op_or_assign
id|cpu_to_le32
c_func
(paren
id|MPI_SGE_FLAGS_END_OF_LIST
op_lshift
id|MPI_SGE_FLAGS_SHIFT
)paren
suffix:semicolon
id|pRecvReq-&gt;BucketCount
op_assign
id|cpu_to_le32
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/*&t;printk(KERN_INFO MYNAM &quot;: posting buckets&bslash;n   &quot;);&n; *&t;for (i = 0; i &lt; j + 2; i ++)&n; *&t;    printk (&quot; %08x&quot;, le32_to_cpu(msg[i]));&n; *&t;printk (&quot;&bslash;n&quot;);&n; */
id|mpt_put_msg_frame
c_func
(paren
id|LanCtx
comma
id|mpt_dev-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|priv-&gt;total_posted
op_add_assign
id|i
suffix:semicolon
id|buckets
op_sub_assign
id|i
suffix:semicolon
id|atomic_add
c_func
(paren
id|i
comma
op_amp
id|priv-&gt;buckets_out
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/%s: End_buckets = %u, priv-&gt;buckets_out = %u&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|buckets
comma
id|atomic_read
c_func
(paren
op_amp
id|priv-&gt;buckets_out
)paren
)paren
)paren
suffix:semicolon
id|dioprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/%s: Posted %u buckets and received %u back&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|priv-&gt;total_posted
comma
id|priv-&gt;total_received
)paren
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|priv-&gt;post_buckets_active
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_struct
id|net_device
op_star
DECL|function|mpt_register_lan_device
id|mpt_register_lan_device
(paren
id|MPT_ADAPTER
op_star
id|mpt_dev
comma
r_int
id|pnum
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mpt_lan_priv
op_star
id|priv
op_assign
l_int|NULL
suffix:semicolon
id|u8
id|HWaddr
(braket
id|FC_ALEN
)braket
comma
op_star
id|a
suffix:semicolon
id|dev
op_assign
id|init_fcdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
r_struct
id|mpt_lan_priv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|MPT_LAN_MTU
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|mpt_lan_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|priv-&gt;mpt_dev
op_assign
id|mpt_dev
suffix:semicolon
id|priv-&gt;pnum
op_assign
id|pnum
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|priv-&gt;post_buckets_task
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tq_struct
)paren
)paren
suffix:semicolon
id|priv-&gt;post_buckets_task.routine
op_assign
id|mpt_lan_post_receive_buckets
suffix:semicolon
id|priv-&gt;post_buckets_task.data
op_assign
id|dev
suffix:semicolon
id|priv-&gt;post_buckets_active
op_assign
l_int|0
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;@%d: bucketlen = %d&bslash;n&quot;
comma
id|__LINE__
comma
id|dev-&gt;mtu
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|priv-&gt;buckets_out
comma
l_int|0
)paren
suffix:semicolon
id|priv-&gt;total_posted
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;total_received
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;max_buckets_out
op_assign
id|max_buckets_out
suffix:semicolon
r_if
c_cond
(paren
id|mpt_dev-&gt;pfacts
(braket
l_int|0
)braket
dot
id|MaxLanBuckets
OL
id|max_buckets_out
)paren
id|priv-&gt;max_buckets_out
op_assign
id|mpt_dev-&gt;pfacts
(braket
l_int|0
)braket
dot
id|MaxLanBuckets
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;@%d: MaxLanBuckets=%d, max_buckets_out/priv=%d/%d&bslash;n&quot;
comma
id|__LINE__
comma
id|mpt_dev-&gt;pfacts
(braket
l_int|0
)braket
dot
id|MaxLanBuckets
comma
id|max_buckets_out
comma
id|priv-&gt;max_buckets_out
)paren
)paren
suffix:semicolon
id|priv-&gt;bucketthresh
op_assign
id|priv-&gt;max_buckets_out
op_star
l_int|2
op_div
l_int|3
suffix:semicolon
id|priv-&gt;txfidx_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|priv-&gt;rxfidx_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|priv-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;stats
)paren
)paren
suffix:semicolon
multiline_comment|/*  Grab pre-fetched LANPage1 stuff. :-) */
id|a
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|mpt_dev-&gt;lan_cnfg_page1.HardwareAddressLow
suffix:semicolon
id|HWaddr
(braket
l_int|0
)braket
op_assign
id|a
(braket
l_int|5
)braket
suffix:semicolon
id|HWaddr
(braket
l_int|1
)braket
op_assign
id|a
(braket
l_int|4
)braket
suffix:semicolon
id|HWaddr
(braket
l_int|2
)braket
op_assign
id|a
(braket
l_int|3
)braket
suffix:semicolon
id|HWaddr
(braket
l_int|3
)braket
op_assign
id|a
(braket
l_int|2
)braket
suffix:semicolon
id|HWaddr
(braket
l_int|4
)braket
op_assign
id|a
(braket
l_int|1
)braket
suffix:semicolon
id|HWaddr
(braket
l_int|5
)braket
op_assign
id|a
(braket
l_int|0
)braket
suffix:semicolon
id|dev-&gt;addr_len
op_assign
id|FC_ALEN
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|HWaddr
comma
id|FC_ALEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;broadcast
comma
l_int|0xff
comma
id|FC_ALEN
)paren
suffix:semicolon
multiline_comment|/* The Tx queue is 127 deep on the 909.&n;&t; * Give ourselves some breathing room.&n;&t; */
id|priv-&gt;tx_max_out
op_assign
(paren
id|tx_max_out_p
op_le
id|MPT_TX_MAX_OUT_LIM
)paren
ques
c_cond
id|tx_max_out_p
suffix:colon
id|MPT_TX_MAX_OUT_LIM
suffix:semicolon
id|dev-&gt;open
op_assign
id|mpt_lan_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|mpt_lan_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|mpt_lan_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|mpt_lan_change_mtu
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|mpt_lan_sdu_send
suffix:semicolon
multiline_comment|/* Not in 2.3.42. Need 2.3.45+ */
id|dev-&gt;tx_timeout
op_assign
id|mpt_lan_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|MPT_LAN_TX_TIMEOUT
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Finished registering dev &quot;
l_string|&quot;and setting initial values&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_int
id|__init
DECL|function|mpt_lan_init
id|mpt_lan_init
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|MPT_ADAPTER
op_star
id|curadapter
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|show_mptmod_ver
c_func
(paren
id|LANAME
comma
id|LANVER
)paren
suffix:semicolon
macro_line|#ifdef QLOGIC_NAA_WORKAROUND
multiline_comment|/* Init the global r/w lock for the bad_naa list. We want to do this&n;&t;   before any boards are initialized and may be used. */
id|rwlock_init
c_func
(paren
op_amp
id|bad_naa_lock
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|LanCtx
op_assign
id|mpt_register
c_func
(paren
id|lan_reply
comma
id|MPTLAN_DRIVER
)paren
)paren
op_le
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: Failed to register with MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Set the callback index to be used by driver core for turbo replies */
id|mpt_lan_index
op_assign
id|LanCtx
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: assigned context of %d&bslash;n&quot;
comma
id|LanCtx
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_reset_register
c_func
(paren
id|LanCtx
comma
id|mpt_lan_ioc_reset
)paren
op_eq
l_int|0
)paren
(brace
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: Eieee! unable to register a reset &quot;
l_string|&quot;handler with mptbase! The world is at an end! &quot;
l_string|&quot;Everything is fading to black! Goodbye.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|MPT_MAX_ADAPTERS
suffix:semicolon
id|j
op_increment
)paren
(brace
id|mpt_landev
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|curadapter
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|curadapter
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|curadapter-&gt;facts.NumberOfPorts
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: PortNum=%x, ProtocolFlags=%02Xh (%c%c%c%c)&bslash;n&quot;
comma
id|curadapter-&gt;name
comma
id|curadapter-&gt;pfacts
(braket
id|i
)braket
dot
id|PortNumber
comma
id|curadapter-&gt;pfacts
(braket
id|i
)braket
dot
id|ProtocolFlags
comma
id|MPT_PROTOCOL_FLAGS_c_c_c_c
c_func
(paren
id|curadapter-&gt;pfacts
(braket
id|i
)braket
dot
id|ProtocolFlags
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curadapter-&gt;pfacts
(braket
id|i
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_LAN
)paren
(brace
id|dev
op_assign
id|mpt_register_lan_device
(paren
id|curadapter
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Fusion MPT LAN device registered as &squot;%s&squot;&bslash;n&quot;
comma
id|curadapter-&gt;name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: LanAddr = %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;&t;&t;printk (KERN_INFO MYNAM &quot;: %s/%s: Max_TX_outstanding = %d&bslash;n&quot;,
singleline_comment|//&t;&t;&t;&t;&t;&t;&t;IOC_AND_NETDEV_NAMES_s_s(dev),
singleline_comment|//&t;&t;&t;&t;&t;&t;&t;NETDEV_TO_LANPRIV_PTR(dev)-&gt;tx_max_out);
id|j
op_assign
id|curadapter-&gt;id
suffix:semicolon
id|mpt_landev
(braket
id|j
)braket
op_assign
id|dev
suffix:semicolon
id|dlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;/init: dev_addr=%p, mpt_landev[%d]=%p&bslash;n&quot;
comma
id|dev
comma
id|j
comma
id|mpt_landev
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: %s: Unable to register port%d as a LAN device&bslash;n&quot;
comma
id|curadapter-&gt;name
comma
id|curadapter-&gt;pfacts
(braket
id|i
)braket
dot
id|PortNumber
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s: Hmmm... LAN protocol seems to be disabled on this adapter port!&bslash;n&quot;
comma
id|curadapter-&gt;name
)paren
suffix:semicolon
)brace
)brace
id|curadapter
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|curadapter
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mpt_lan_exit
r_void
id|__init
id|mpt_lan_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|mpt_reset_deregister
c_func
(paren
id|LanCtx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|mpt_landev
(braket
id|i
)braket
op_ne
l_int|NULL
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|mpt_landev
(braket
id|i
)braket
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: %s/%s: Fusion MPT LAN device unregistered&bslash;n&quot;
comma
id|IOC_AND_NETDEV_NAMES_s_s
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|unregister_fcdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mpt_landev
(braket
id|i
)braket
op_assign
(paren
r_struct
id|net_device
op_star
)paren
l_int|0xdeadbeef
suffix:semicolon
multiline_comment|/* Debug */
)brace
r_if
c_cond
(paren
id|LanCtx
op_ge
l_int|0
)paren
(brace
id|mpt_deregister
c_func
(paren
id|LanCtx
)paren
suffix:semicolon
id|LanCtx
op_assign
op_minus
l_int|1
suffix:semicolon
id|mpt_lan_index
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* deregister any send/receive handler structs. I2Oism? */
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
id|MODULE_PARM
c_func
(paren
id|tx_max_out_p
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|max_buckets_out
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
singleline_comment|// Debug stuff. FIXME!
DECL|variable|mpt_lan_init
id|module_init
c_func
(paren
id|mpt_lan_init
)paren
suffix:semicolon
DECL|variable|mpt_lan_exit
id|module_exit
c_func
(paren
id|mpt_lan_exit
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
r_int
DECL|function|mpt_lan_type_trans
id|mpt_lan_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|mpt_lan_ohdr
op_star
id|fch
op_assign
(paren
r_struct
id|mpt_lan_ohdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|fcllc
op_star
id|fcllc
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|mpt_lan_ohdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fch-&gt;dtype
op_eq
id|htons
c_func
(paren
l_int|0xffff
)paren
)paren
(brace
id|u32
op_star
id|p
op_assign
(paren
id|u32
op_star
)paren
id|fch
suffix:semicolon
id|swab32s
c_func
(paren
id|p
op_plus
l_int|0
)paren
suffix:semicolon
id|swab32s
c_func
(paren
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|swab32s
c_func
(paren
id|p
op_plus
l_int|2
)paren
suffix:semicolon
id|swab32s
c_func
(paren
id|p
op_plus
l_int|3
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: WARNING - Broadcast swap F/W bug detected!&bslash;n&quot;
comma
id|NETDEV_PTR_TO_IOC_NAME_s
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Please update sender @ MAC_addr = %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|fch-&gt;saddr
(braket
l_int|0
)braket
comma
id|fch-&gt;saddr
(braket
l_int|1
)braket
comma
id|fch-&gt;saddr
(braket
l_int|2
)braket
comma
id|fch-&gt;saddr
(braket
l_int|3
)braket
comma
id|fch-&gt;saddr
(braket
l_int|4
)braket
comma
id|fch-&gt;saddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|fch-&gt;daddr
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|fch-&gt;daddr
comma
id|dev-&gt;broadcast
comma
id|FC_ALEN
)paren
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_MULTICAST
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|fch-&gt;daddr
comma
id|dev-&gt;dev_addr
comma
id|FC_ALEN
)paren
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
)brace
)brace
id|fcllc
op_assign
(paren
r_struct
id|fcllc
op_star
)paren
id|skb-&gt;data
suffix:semicolon
macro_line|#ifdef QLOGIC_NAA_WORKAROUND
(brace
id|u16
id|source_naa
op_assign
id|fch-&gt;stype
comma
id|found
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Workaround for QLogic not following RFC 2625 in regards to the NAA&n;&t;   value. */
r_if
c_cond
(paren
(paren
id|source_naa
op_amp
l_int|0xF000
)paren
op_eq
l_int|0
)paren
id|source_naa
op_assign
id|swab16
c_func
(paren
id|source_naa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fcllc-&gt;ethertype
op_eq
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
)paren
id|dlprintk
(paren
(paren
id|KERN_INFO
l_string|&quot;mptlan/type_trans: got arp req/rep w/ naa of &quot;
l_string|&quot;%04x.&bslash;n&quot;
comma
id|source_naa
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fcllc-&gt;ethertype
op_eq
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
)paren
op_logical_and
(paren
(paren
id|source_naa
op_rshift
l_int|12
)paren
op_ne
id|MPT_LAN_NAA_RFC2625
)paren
)paren
(brace
r_struct
id|NAA_Hosed
op_star
id|nh
comma
op_star
id|prevnh
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dlprintk
(paren
(paren
id|KERN_INFO
l_string|&quot;mptlan/type_trans: ARP Req/Rep from &quot;
l_string|&quot;system with non-RFC 2625 NAA value (%04x).&bslash;n&quot;
comma
id|source_naa
)paren
)paren
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|bad_naa_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|prevnh
op_assign
id|nh
op_assign
id|mpt_bad_naa
suffix:semicolon
id|nh
op_ne
l_int|NULL
suffix:semicolon
id|prevnh
op_assign
id|nh
comma
id|nh
op_assign
id|nh-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|nh-&gt;ieee
(braket
l_int|0
)braket
op_eq
id|fch-&gt;saddr
(braket
l_int|0
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|1
)braket
op_eq
id|fch-&gt;saddr
(braket
l_int|1
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|2
)braket
op_eq
id|fch-&gt;saddr
(braket
l_int|2
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|3
)braket
op_eq
id|fch-&gt;saddr
(braket
l_int|3
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|4
)braket
op_eq
id|fch-&gt;saddr
(braket
l_int|4
)braket
)paren
op_logical_and
(paren
id|nh-&gt;ieee
(braket
l_int|5
)braket
op_eq
id|fch-&gt;saddr
(braket
l_int|5
)braket
)paren
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
id|dlprintk
(paren
(paren
id|KERN_INFO
l_string|&quot;mptlan/type_trans: ARP Re&quot;
l_string|&quot;q/Rep w/ bad NAA from system already&quot;
l_string|&quot; in DB.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|found
)paren
op_logical_and
(paren
id|nh
op_eq
l_int|NULL
)paren
)paren
(brace
id|nh
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|NAA_Hosed
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|dlprintk
(paren
(paren
id|KERN_INFO
l_string|&quot;mptlan/type_trans: ARP Req/Rep w/&quot;
l_string|&quot; bad NAA from system not yet in DB.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nh
op_ne
l_int|NULL
)paren
(brace
id|nh-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mpt_bad_naa
)paren
id|mpt_bad_naa
op_assign
id|nh
suffix:semicolon
r_if
c_cond
(paren
id|prevnh
)paren
id|prevnh-&gt;next
op_assign
id|nh
suffix:semicolon
id|nh-&gt;NAA
op_assign
id|source_naa
suffix:semicolon
multiline_comment|/* Set the S_NAA value. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FC_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|nh-&gt;ieee
(braket
id|i
)braket
op_assign
id|fch-&gt;saddr
(braket
id|i
)braket
suffix:semicolon
id|dlprintk
(paren
(paren
id|KERN_INFO
l_string|&quot;Got ARP from %02x:%02x:%02x:%02x:&quot;
l_string|&quot;%02x:%02x with non-compliant S_NAA value.&bslash;n&quot;
comma
id|fch-&gt;saddr
(braket
l_int|0
)braket
comma
id|fch-&gt;saddr
(braket
l_int|1
)braket
comma
id|fch-&gt;saddr
(braket
l_int|2
)braket
comma
id|fch-&gt;saddr
(braket
l_int|3
)braket
comma
id|fch-&gt;saddr
(braket
l_int|4
)braket
comma
id|fch-&gt;saddr
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;mptlan/type_trans: Unable to&quot;
l_string|&quot; kmalloc a NAA_Hosed struct.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;mptlan/type_trans: found not&quot;
l_string|&quot; set, but nh isn&squot;t null. Evil &quot;
l_string|&quot;funkiness abounds.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|write_unlock_irq
c_func
(paren
op_amp
id|bad_naa_lock
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* Strip the SNAP header from ARP packets since we don&squot;t&n;&t; * pass them through to the 802.2/SNAP layers.&n;&t; */
r_if
c_cond
(paren
id|fcllc-&gt;dsap
op_eq
id|EXTENDED_SAP
op_logical_and
(paren
id|fcllc-&gt;ethertype
op_eq
id|htons
c_func
(paren
id|ETH_P_IP
)paren
op_logical_or
id|fcllc-&gt;ethertype
op_eq
id|htons
c_func
(paren
id|ETH_P_ARP
)paren
)paren
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|fcllc
)paren
)paren
suffix:semicolon
r_return
id|fcllc-&gt;ethertype
suffix:semicolon
)brace
r_return
id|htons
c_func
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
eof
