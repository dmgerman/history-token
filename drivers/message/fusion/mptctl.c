multiline_comment|/*&n; *  linux/drivers/message/fusion/mptctl.c&n; *      Fusion MPT misc device (ioctl) driver.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      A big THANKS to Eddie C. Dost for fixing the ioctl path&n; *      and most importantly f/w download on sparc64 platform!&n; *      (plus Eddie&squot;s other helpful hints and insights)&n; *&n; *      Thanks to Arnaldo Carvalho de Melo for finding and patching&n; *      a potential memory leak in mpt_ioctl_do_fw_download(),&n; *      and for some kmalloc insight:-)&n; *&n; *      (see also mptbase.c)&n; *&n; *  Copyright (c) 1999-2001 LSI Logic Corporation&n; *  Originally By: Steven J. Ralston, Noah Romer&n; *  (mailto:Steve.Ralston@lsil.com)&n; *&n; *  $Id: mptctl.c,v 1.25.4.1 2001/08/24 20:07:06 sralston Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
DECL|macro|COPYRIGHT
mdefine_line|#define COPYRIGHT&t;&quot;Copyright (c) 1999-2001 LSI Logic Corporation&quot;
DECL|macro|MODULEAUTHOR
mdefine_line|#define MODULEAUTHOR&t;&quot;Steven J. Ralston, Noah Romer&quot;
macro_line|#include &quot;mptbase.h&quot;
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|my_NAME
mdefine_line|#define my_NAME&t;&t;&quot;Fusion MPT misc device (ioctl) driver&quot;
DECL|macro|my_VERSION
mdefine_line|#define my_VERSION&t;MPT_LINUX_VERSION_COMMON
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptctl&quot;
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|variable|MODULEAUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|MODULEAUTHOR
)paren
suffix:semicolon
DECL|variable|my_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|my_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mptctl_id
r_static
r_int
id|mptctl_id
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|rwperf_reset
r_static
r_int
id|rwperf_reset
op_assign
l_int|0
suffix:semicolon
DECL|variable|mptctl_syscall_sem_ioc
r_static
r_struct
id|semaphore
id|mptctl_syscall_sem_ioc
(braket
id|MPT_MAX_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
id|mpt_ioctl_rwperf
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mpt_ioctl_rwperf_status
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mpt_ioctl_rwperf_reset
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mpt_ioctl_fw_download
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mpt_ioctl_do_fw_download
c_func
(paren
r_int
id|ioc
comma
r_char
op_star
id|ufwbuf
comma
r_int
id|fwlen
)paren
suffix:semicolon
r_static
r_int
id|mpt_ioctl_scsi_cmd
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Scatter gather list (SGL) sizes and limits...&n; */
singleline_comment|//#define MAX_SCSI_FRAGS&t;9
DECL|macro|MAX_FRAGS_SPILL1
mdefine_line|#define MAX_FRAGS_SPILL1&t;9
DECL|macro|MAX_FRAGS_SPILL2
mdefine_line|#define MAX_FRAGS_SPILL2&t;15
DECL|macro|FRAGS_PER_BUCKET
mdefine_line|#define FRAGS_PER_BUCKET&t;(MAX_FRAGS_SPILL2 + 1)
singleline_comment|//#define MAX_CHAIN_FRAGS&t;64
singleline_comment|//#define MAX_CHAIN_FRAGS&t;(15+15+15+16)
DECL|macro|MAX_CHAIN_FRAGS
mdefine_line|#define MAX_CHAIN_FRAGS&t;&t;(4 * MAX_FRAGS_SPILL2 + 1)
singleline_comment|//  Define max sg LIST bytes ( == (#frags + #chains) * 8 bytes each)
singleline_comment|//  Works out to: 592d bytes!     (9+1)*8 + 4*(15+1)*8
singleline_comment|//                  ^----------------- 80 + 512
DECL|macro|MAX_SGL_BYTES
mdefine_line|#define MAX_SGL_BYTES&t;&t;((MAX_FRAGS_SPILL1 + 1 + (4 * FRAGS_PER_BUCKET)) * 8)
multiline_comment|/* linux only seems to ever give 128kB MAX contiguous (GFP_USER) mem bytes */
DECL|macro|MAX_KMALLOC_SZ
mdefine_line|#define MAX_KMALLOC_SZ&t;&t;(128*1024)
DECL|struct|buflist
r_struct
id|buflist
(brace
DECL|member|kptr
id|u8
op_star
id|kptr
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|myMAX_TARGETS
mdefine_line|#define myMAX_TARGETS&t;(1&lt;&lt;4)
DECL|macro|myMAX_LUNS
mdefine_line|#define myMAX_LUNS&t;(1&lt;&lt;3)
DECL|macro|myMAX_T_MASK
mdefine_line|#define myMAX_T_MASK&t;(myMAX_TARGETS-1)
DECL|macro|myMAX_L_MASK
mdefine_line|#define myMAX_L_MASK&t;(myMAX_LUNS-1)
DECL|variable|DevInUse
r_static
id|u8
id|DevInUse
(braket
id|myMAX_TARGETS
)braket
(braket
id|myMAX_LUNS
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|DevIosCount
r_static
id|u32
id|DevIosCount
(braket
id|myMAX_TARGETS
)braket
(braket
id|myMAX_LUNS
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|fwReplyBuffer
r_static
id|u32
id|fwReplyBuffer
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|ReplyMsg
r_static
id|pMPIDefaultReply_t
id|ReplyMsg
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* some private forw protos */
r_static
id|SGESimple32_t
op_star
id|kbuf_alloc_2_sgl
c_func
(paren
r_int
id|bytes
comma
id|u32
id|dir
comma
r_int
op_star
id|frags
comma
r_struct
id|buflist
op_star
op_star
id|blp
comma
id|dma_addr_t
op_star
id|sglbuf_dma
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|kfree_sgl
c_func
(paren
id|SGESimple32_t
op_star
id|sgl
comma
id|dma_addr_t
id|sgl_dma
comma
r_struct
id|buflist
op_star
id|buflist
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptctl_syscall_down - Down the MPT adapter syscall semaphore.&n; *&t;@ioc: Pointer to MPT adapter&n; *&t;@nonblock: boolean, non-zero if O_NONBLOCK is set&n; *&n; *&t;All of the mptctl commands can potentially sleep, which is illegal&n; *&t;with a spinlock held, thus we perform mutual exclusion here.&n; *&n; *&t;Returns negative errno on error, or zero for success.&n; */
r_static
r_inline
r_int
DECL|function|mptctl_syscall_down
id|mptctl_syscall_down
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|nonblock
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::mpt_syscall_down(%p,%d) called&bslash;n&quot;
comma
id|ioc
comma
id|nonblock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|ioc-&gt;id
)braket
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|ioc-&gt;id
)braket
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  This is the callback for any message we have posted. The message itself&n; *  will be returned to the message pool when we return from the IRQ&n; *&n; *  This runs in irq context so be short and sweet.&n; */
r_static
r_int
DECL|function|mptctl_reply
id|mptctl_reply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|req
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
(brace
id|u8
id|targ
suffix:semicolon
singleline_comment|//dprintk((KERN_DEBUG MYNAM &quot;: Got mptctl_reply()!&bslash;n&quot;));
r_if
c_cond
(paren
id|req
op_logical_and
id|req-&gt;u.hdr.Function
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
(brace
id|targ
op_assign
id|req-&gt;u.scsireq.TargetID
op_amp
id|myMAX_T_MASK
suffix:semicolon
id|DevIosCount
(braket
id|targ
)braket
(braket
l_int|0
)braket
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reply
op_logical_and
id|req
op_logical_and
id|req-&gt;u.hdr.Function
op_eq
id|MPI_FUNCTION_FW_DOWNLOAD
)paren
(brace
singleline_comment|// NOTE: Expects/requires non-Turbo reply!
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Caching MPI_FUNCTION_FW_DOWNLOAD reply!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fwReplyBuffer
comma
id|reply
comma
id|MIN
c_func
(paren
r_sizeof
(paren
id|fwReplyBuffer
)paren
comma
l_int|4
op_star
id|reply-&gt;u.reply.MsgLength
)paren
)paren
suffix:semicolon
id|ReplyMsg
op_assign
(paren
id|pMPIDefaultReply_t
)paren
id|fwReplyBuffer
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  struct file_operations functionality. &n; *  Members:&n; *&t;llseek, write, read, ioctl, open, release&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,9)
r_static
id|loff_t
DECL|function|mptctl_llseek
id|mptctl_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
DECL|macro|no_llseek
mdefine_line|#define no_llseek mptctl_llseek
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
id|ssize_t
DECL|function|mptctl_write
id|mptctl_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ioctl WRITE not yet supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
id|ssize_t
DECL|function|mptctl_read
id|mptctl_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ptr
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  MPT ioctl handler&n; */
r_static
r_int
DECL|function|mpt_ioctl
id|mpt_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_sanity
op_star
id|usanity
op_assign
(paren
r_struct
id|mpt_ioctl_sanity
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_sanity
id|ksanity
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|iocnumX
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::mpt_ioctl() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ksanity
comma
id|usanity
comma
r_sizeof
(paren
id|ksanity
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mpt_ioctl() @%d - &quot;
l_string|&quot;Unable to copy mpt_ioctl_sanity data @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|usanity
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
multiline_comment|/* Verify intended MPT adapter */
id|iocnumX
op_assign
id|ksanity.iocnum
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mpt_ioctl() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnumX
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::mpt_ioctl() - Using %s&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MPTRWPERF
suffix:colon
id|ret
op_assign
id|mpt_ioctl_rwperf
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTRWPERF_CHK
suffix:colon
id|ret
op_assign
id|mpt_ioctl_rwperf_status
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTRWPERF_RESET
suffix:colon
id|ret
op_assign
id|mpt_ioctl_rwperf_reset
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTFWDOWNLOAD
suffix:colon
id|ret
op_assign
id|mpt_ioctl_fw_download
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTSCSICMD
suffix:colon
id|ret
op_assign
id|mpt_ioctl_scsi_cmd
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|iocp-&gt;id
)braket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_open
r_static
r_int
id|mptctl_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/*&n;&t; * Should support multiple management users&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_release
r_static
r_int
id|mptctl_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_ioctl_fw_download
id|mpt_ioctl_fw_download
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_fw_xfer
op_star
id|ufwdl
op_assign
(paren
r_struct
id|mpt_fw_xfer
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_fw_xfer
id|kfwdl
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;mpt_ioctl_fwdl called. mptctl_id = %xh&bslash;n&quot;
comma
id|mptctl_id
)paren
)paren
suffix:semicolon
singleline_comment|//tc
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kfwdl
comma
id|ufwdl
comma
r_sizeof
(paren
r_struct
id|mpt_fw_xfer
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::_ioctl_fwdl - &quot;
l_string|&quot;Unable to copy mpt_fw_xfer struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|ufwdl
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|mpt_ioctl_do_fw_download
c_func
(paren
id|kfwdl.iocnum
comma
id|kfwdl.bufp
comma
id|kfwdl.fwlen
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * MPT FW Download&n; */
r_static
r_int
DECL|function|mpt_ioctl_do_fw_download
id|mpt_ioctl_do_fw_download
c_func
(paren
r_int
id|ioc
comma
r_char
op_star
id|ufwbuf
comma
r_int
id|fwlen
)paren
(brace
id|FWDownload_t
op_star
id|dlmsg
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
singleline_comment|//&t;char&t;&t;&t;*fwbuf;
singleline_comment|//&t;dma_addr_t&t;&t; fwbuf_dma;
id|FWDownloadTCSGE_t
op_star
id|fwVoodoo
suffix:semicolon
singleline_comment|//&t;SGEAllUnion_t&t;&t;*fwSgl;
r_int
id|ret
suffix:semicolon
id|SGESimple32_t
op_star
id|sgl
suffix:semicolon
id|SGESimple32_t
op_star
id|sgOut
comma
op_star
id|sgIn
suffix:semicolon
id|dma_addr_t
id|sgl_dma
suffix:semicolon
r_struct
id|buflist
op_star
id|buflist
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|buflist
op_star
id|bl
op_assign
l_int|NULL
suffix:semicolon
r_int
id|numfrags
op_assign
l_int|0
suffix:semicolon
r_int
id|maxfrags
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
id|u32
id|sgdir
suffix:semicolon
id|u32
id|nib
suffix:semicolon
r_int
id|fw_bytes_copied
op_assign
l_int|0
suffix:semicolon
id|u16
id|iocstat
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;mpt_ioctl_do_fwdl called. mptctl_id = %xh.&bslash;n&quot;
comma
id|mptctl_id
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.bufp  = %p&bslash;n&quot;
comma
id|ufwbuf
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.fwlen = %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|fwlen
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.ioc   = %04xh&bslash;n&quot;
comma
id|ioc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc
op_assign
id|mpt_verify_adapter
c_func
(paren
id|ioc
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s@%d::_ioctl_fwdl - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
)brace
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|dlmsg
op_assign
(paren
id|FWDownload_t
op_star
)paren
id|mf
suffix:semicolon
id|fwVoodoo
op_assign
(paren
id|FWDownloadTCSGE_t
op_star
)paren
op_amp
id|dlmsg-&gt;SGL
suffix:semicolon
id|sgOut
op_assign
(paren
id|SGESimple32_t
op_star
)paren
(paren
id|fwVoodoo
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Construct f/w download request&n;&t; */
id|dlmsg-&gt;ImageType
op_assign
id|MPI_FW_DOWNLOAD_ITYPE_FW
suffix:semicolon
id|dlmsg-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;Function
op_assign
id|MPI_FUNCTION_FW_DOWNLOAD
suffix:semicolon
id|dlmsg-&gt;Reserved1
(braket
l_int|0
)braket
op_assign
id|dlmsg-&gt;Reserved1
(braket
l_int|1
)braket
op_assign
id|dlmsg-&gt;Reserved1
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|fwVoodoo-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|fwVoodoo-&gt;ContextSize
op_assign
l_int|0
suffix:semicolon
id|fwVoodoo-&gt;DetailsLength
op_assign
l_int|12
suffix:semicolon
id|fwVoodoo-&gt;Flags
op_assign
id|MPI_SGE_FLAGS_TRANSACTION_ELEMENT
suffix:semicolon
id|fwVoodoo-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|fwVoodoo-&gt;ImageOffset
op_assign
l_int|0
suffix:semicolon
id|fwVoodoo-&gt;ImageSize
op_assign
id|cpu_to_le32
c_func
(paren
id|fwlen
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Need to kmalloc area(s) for holding firmware image bytes.&n;&t; * But we need to do it piece meal, using a proper&n;&t; * scatter gather list (with 128kB MAX hunks).&n;&t; * &n;&t; * A practical limit here might be # of sg hunks that fit into&n;&t; * a single IOC request frame; 12 or 8 (see below), so:&n;&t; * For FC9xx: 12 x 128kB == 1.5 mB (max)&n;&t; * For C1030:  8 x 128kB == 1   mB (max)&n;&t; * We could support chaining, but things get ugly(ier:)&n;&t; */
id|sgdir
op_assign
l_int|0x04000000
suffix:semicolon
multiline_comment|/* IOC will READ from sys mem */
r_if
c_cond
(paren
(paren
id|sgl
op_assign
id|kbuf_alloc_2_sgl
c_func
(paren
id|fwlen
comma
id|sgdir
comma
op_amp
id|numfrags
comma
op_amp
id|buflist
comma
op_amp
id|sgl_dma
comma
id|iocp
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * We should only need SGL with 2 simple_32bit entries (up to 256 kB)&n;&t; * for FC9xx f/w image, but calculate max number of sge hunks&n;&t; * we can fit into a request frame, and limit ourselves to that.&n;&t; * (currently no chain support)&n;&t; * For FC9xx: (128-12-16)/8 = 12.5 = 12&n;&t; * For C1030:  (96-12-16)/8 =  8.5 =  8&n;&t; */
id|maxfrags
op_assign
(paren
id|iocp-&gt;req_sz
op_minus
r_sizeof
(paren
id|MPIHeader_t
)paren
op_minus
r_sizeof
(paren
id|FWDownloadTCSGE_t
)paren
)paren
op_div
r_sizeof
(paren
id|SGESimple32_t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|numfrags
OG
id|maxfrags
)paren
(brace
id|ret
op_assign
op_minus
id|EMLINK
suffix:semicolon
r_goto
id|fwdl_out
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: sgl buffer  = %p, sgfrags = %d&bslash;n&quot;
comma
id|sgl
comma
id|numfrags
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Parse SG list, copying sgl itself,&n;&t; * plus f/w image hunks from user space as we go...&n;&t; */
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|sgIn
op_assign
id|sgl
suffix:semicolon
id|bl
op_assign
id|buflist
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numfrags
suffix:semicolon
id|i
op_increment
)paren
(brace
id|nib
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|sgIn-&gt;FlagsLength
)paren
op_amp
l_int|0xF0000000
)paren
op_rshift
l_int|28
suffix:semicolon
multiline_comment|/* skip ignore/chain. */
r_if
c_cond
(paren
id|nib
op_eq
l_int|0
op_logical_or
id|nib
op_eq
l_int|3
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sgIn-&gt;Address
)paren
(brace
op_star
id|sgOut
op_assign
op_star
id|sgIn
suffix:semicolon
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|bl-&gt;kptr
comma
id|ufwbuf
op_plus
id|fw_bytes_copied
comma
id|bl-&gt;len
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::_ioctl_fwdl - &quot;
l_string|&quot;Unable to copy f/w buffer hunk#%d @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|n
comma
(paren
r_void
op_star
)paren
id|ufwbuf
)paren
suffix:semicolon
r_goto
id|fwdl_out
suffix:semicolon
)brace
id|fw_bytes_copied
op_add_assign
id|bl-&gt;len
suffix:semicolon
)brace
id|sgIn
op_increment
suffix:semicolon
id|bl
op_increment
suffix:semicolon
id|sgOut
op_increment
suffix:semicolon
)brace
macro_line|#ifdef MPT_DEBUG
(brace
id|u32
op_star
id|m
op_assign
(paren
id|u32
op_star
)paren
id|mf
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: F/W download request:&bslash;n&quot;
id|KERN_INFO
l_string|&quot; &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
op_plus
id|numfrags
op_star
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|m
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Finally, perform firmware download.&n;&t; */
id|ReplyMsg
op_assign
l_int|NULL
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc
comma
id|mf
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Wait until the reply has been received&n;&t; */
(brace
r_int
id|foo
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ReplyMsg
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|foo
op_mod
l_int|1000000
)paren
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG::_do_fwdl: &quot;
l_string|&quot;In ReplyMsg loop - iteration %d&bslash;n&quot;
comma
id|foo
)paren
)paren
suffix:semicolon
singleline_comment|//tc
)brace
id|ret
op_assign
op_minus
id|ETIME
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|foo
OG
l_int|60000000
)paren
r_goto
id|fwdl_out
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sgl
)paren
id|kfree_sgl
c_func
(paren
id|sgl
comma
id|sgl_dma
comma
id|buflist
comma
id|iocp
)paren
suffix:semicolon
id|iocstat
op_assign
id|le16_to_cpu
c_func
(paren
id|ReplyMsg-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_SUCCESS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: F/W update successfully sent to %s!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_INVALID_FUNCTION
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: ?Hmmm...  %s says it doesn&squot;t support F/W download!?!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (time to go bang on somebodies door)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADRQC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_BUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Warning!  %s says: IOC_BUSY!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (try again later?)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;::ioctl_fwdl() ERROR!  %s returned [bad] status = %04xh&bslash;n&quot;
comma
id|iocp-&gt;name
comma
id|iocstat
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (bad VooDoo)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMSG
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|fwdl_out
suffix:colon
id|kfree_sgl
c_func
(paren
id|sgl
comma
id|sgl_dma
comma
id|buflist
comma
id|iocp
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  NEW rwperf (read/write performance) stuff starts here...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
id|SGESimple32_t
op_star
DECL|function|kbuf_alloc_2_sgl
id|kbuf_alloc_2_sgl
c_func
(paren
r_int
id|bytes
comma
id|u32
id|sgdir
comma
r_int
op_star
id|frags
comma
r_struct
id|buflist
op_star
op_star
id|blp
comma
id|dma_addr_t
op_star
id|sglbuf_dma
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|SGESimple32_t
op_star
id|sglbuf
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|buflist
op_star
id|buflist
op_assign
l_int|NULL
suffix:semicolon
r_int
id|numfrags
op_assign
l_int|0
suffix:semicolon
r_int
id|fragcnt
op_assign
l_int|0
suffix:semicolon
r_int
id|alloc_sz
op_assign
id|MIN
c_func
(paren
id|bytes
comma
id|MAX_KMALLOC_SZ
)paren
suffix:semicolon
singleline_comment|// avoid kernel warning msg!
r_int
id|bytes_allocd
op_assign
l_int|0
suffix:semicolon
r_int
id|this_alloc
suffix:semicolon
id|SGESimple32_t
op_star
id|sgl
suffix:semicolon
id|u32
id|pa
suffix:semicolon
singleline_comment|// phys addr
id|SGEChain32_t
op_star
id|last_chain
op_assign
l_int|NULL
suffix:semicolon
id|SGEChain32_t
op_star
id|old_chain
op_assign
l_int|NULL
suffix:semicolon
r_int
id|chaincnt
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|buflist_ent
suffix:semicolon
r_int
id|sg_spill
op_assign
id|MAX_FRAGS_SPILL1
suffix:semicolon
r_int
id|dir
suffix:semicolon
op_star
id|frags
op_assign
l_int|0
suffix:semicolon
op_star
id|blp
op_assign
l_int|NULL
suffix:semicolon
id|i
op_assign
id|MAX_SGL_BYTES
op_div
l_int|8
suffix:semicolon
id|buflist
op_assign
id|kmalloc
c_func
(paren
id|i
comma
id|GFP_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflist
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|buflist
comma
l_int|0
comma
id|i
)paren
suffix:semicolon
id|buflist_ent
op_assign
l_int|0
suffix:semicolon
id|sglbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sglbuf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sglbuf
op_eq
l_int|NULL
)paren
r_goto
id|free_and_fail
suffix:semicolon
r_if
c_cond
(paren
id|sgdir
op_amp
l_int|0x04000000
)paren
id|dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_else
id|dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
id|sgl
op_assign
id|sglbuf
suffix:semicolon
r_while
c_loop
(paren
id|bytes_allocd
OL
id|bytes
)paren
(brace
id|this_alloc
op_assign
id|MIN
c_func
(paren
id|alloc_sz
comma
id|bytes
op_minus
id|bytes_allocd
)paren
suffix:semicolon
id|buflist
(braket
id|buflist_ent
)braket
dot
id|len
op_assign
id|this_alloc
suffix:semicolon
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|this_alloc
comma
op_amp
id|pa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
op_eq
l_int|NULL
)paren
(brace
id|alloc_sz
op_assign
id|alloc_sz
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|alloc_sz
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: No can do - &quot;
l_string|&quot;not enough memory!   :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: (freeing %d frags)&bslash;n&quot;
comma
id|numfrags
)paren
suffix:semicolon
r_goto
id|free_and_fail
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_else
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|bytes_allocd
op_add_assign
id|this_alloc
suffix:semicolon
multiline_comment|/* Write one SIMPLE sge */
id|sgl-&gt;FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x10000000
op_or
id|sgdir
op_or
id|this_alloc
)paren
suffix:semicolon
id|dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
comma
id|this_alloc
comma
id|dir
)paren
suffix:semicolon
id|sgl-&gt;Address
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
id|fragcnt
op_increment
suffix:semicolon
id|numfrags
op_increment
suffix:semicolon
id|sgl
op_increment
suffix:semicolon
id|buflist_ent
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bytes_allocd
op_ge
id|bytes
)paren
r_break
suffix:semicolon
multiline_comment|/* Need to chain? */
r_if
c_cond
(paren
id|fragcnt
op_eq
id|sg_spill
)paren
(brace
id|dma_addr_t
id|chain_link
suffix:semicolon
r_if
c_cond
(paren
id|last_chain
op_ne
l_int|NULL
)paren
id|last_chain-&gt;NextChainOffset
op_assign
l_int|0x1E
suffix:semicolon
id|fragcnt
op_assign
l_int|0
suffix:semicolon
id|sg_spill
op_assign
id|MAX_FRAGS_SPILL2
suffix:semicolon
multiline_comment|/* fixup previous SIMPLE sge */
id|sgl
(braket
op_minus
l_int|1
)braket
dot
id|FlagsLength
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|0x80000000
)paren
suffix:semicolon
id|chain_link
op_assign
(paren
op_star
id|sglbuf_dma
)paren
op_plus
(paren
(paren
id|u8
op_star
)paren
(paren
id|sgl
op_plus
l_int|1
)paren
op_minus
(paren
id|u8
op_star
)paren
id|sglbuf
)paren
suffix:semicolon
multiline_comment|/* Write one CHAIN sge */
id|sgl-&gt;FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x30000080
)paren
suffix:semicolon
id|sgl-&gt;Address
op_assign
id|cpu_to_le32
c_func
(paren
id|chain_link
)paren
suffix:semicolon
id|old_chain
op_assign
id|last_chain
suffix:semicolon
id|last_chain
op_assign
(paren
id|SGEChain32_t
op_star
)paren
id|sgl
suffix:semicolon
id|chaincnt
op_increment
suffix:semicolon
id|numfrags
op_increment
suffix:semicolon
id|sgl
op_increment
suffix:semicolon
)brace
multiline_comment|/* overflow check... */
r_if
c_cond
(paren
id|numfrags
op_star
l_int|8
OG
id|MAX_SGL_BYTES
)paren
(brace
multiline_comment|/* GRRRRR... */
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: No can do - &quot;
l_string|&quot;too many SG frags!   :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: (freeing %d frags)&bslash;n&quot;
comma
id|numfrags
)paren
suffix:semicolon
r_goto
id|free_and_fail
suffix:semicolon
)brace
)brace
multiline_comment|/* Last sge fixup: set LE+eol+eob bits */
id|sgl
(braket
op_minus
l_int|1
)braket
dot
id|FlagsLength
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|0xC1000000
)paren
suffix:semicolon
multiline_comment|/* Chain fixup needed? */
r_if
c_cond
(paren
id|last_chain
op_ne
l_int|NULL
op_logical_and
id|fragcnt
OL
l_int|16
)paren
id|last_chain-&gt;Length
op_assign
id|cpu_to_le16
c_func
(paren
id|fragcnt
op_star
l_int|8
)paren
suffix:semicolon
op_star
id|frags
op_assign
id|numfrags
suffix:semicolon
op_star
id|blp
op_assign
id|buflist
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: kbuf_alloc_2_sgl() - &quot;
l_string|&quot;%d SG frags generated!  (%d CHAIN%s)&bslash;n&quot;
comma
id|numfrags
comma
id|chaincnt
comma
id|chaincnt
OG
l_int|1
ques
c_cond
l_string|&quot;s&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: kbuf_alloc_2_sgl() - &quot;
l_string|&quot;last (big) alloc_sz=%d&bslash;n&quot;
comma
id|alloc_sz
)paren
)paren
suffix:semicolon
r_return
id|sglbuf
suffix:semicolon
id|free_and_fail
suffix:colon
r_if
c_cond
(paren
id|sglbuf
op_ne
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numfrags
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|u8
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|le32_to_cpu
c_func
(paren
id|sglbuf
(braket
id|i
)braket
dot
id|FlagsLength
)paren
op_rshift
l_int|24
)paren
op_eq
l_int|0x30
)paren
r_continue
suffix:semicolon
id|dma_addr
op_assign
id|le32_to_cpu
c_func
(paren
id|sglbuf
(braket
id|i
)braket
dot
id|Address
)paren
suffix:semicolon
id|kptr
op_assign
id|buflist
(braket
id|i
)braket
dot
id|kptr
suffix:semicolon
id|len
op_assign
id|buflist
(braket
id|i
)braket
dot
id|len
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sglbuf
comma
op_star
id|sglbuf_dma
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buflist
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_void
DECL|function|kfree_sgl
id|kfree_sgl
c_func
(paren
id|SGESimple32_t
op_star
id|sgl
comma
id|dma_addr_t
id|sgl_dma
comma
r_struct
id|buflist
op_star
id|buflist
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|SGESimple32_t
op_star
id|sg
op_assign
id|sgl
suffix:semicolon
r_struct
id|buflist
op_star
id|bl
op_assign
id|buflist
suffix:semicolon
id|u32
id|nib
suffix:semicolon
r_int
id|dir
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|sg-&gt;FlagsLength
)paren
op_amp
l_int|0x04000000
)paren
id|dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_else
id|dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
id|nib
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|sg-&gt;FlagsLength
)paren
op_amp
l_int|0xF0000000
)paren
op_rshift
l_int|28
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|nib
op_amp
l_int|0x4
)paren
)paren
(brace
multiline_comment|/* eob */
multiline_comment|/* skip ignore/chain. */
r_if
c_cond
(paren
id|nib
op_eq
l_int|0
op_logical_or
id|nib
op_eq
l_int|3
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sg-&gt;Address
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_void
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
id|dma_addr
op_assign
id|le32_to_cpu
c_func
(paren
id|sg-&gt;Address
)paren
suffix:semicolon
id|kptr
op_assign
id|bl-&gt;kptr
suffix:semicolon
id|len
op_assign
id|bl-&gt;len
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dma_addr
comma
id|len
comma
id|dir
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
id|sg
op_increment
suffix:semicolon
id|bl
op_increment
suffix:semicolon
id|nib
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|sg-&gt;FlagsLength
)paren
op_amp
l_int|0xF0000000
)paren
op_rshift
l_int|28
suffix:semicolon
)brace
multiline_comment|/* we&squot;re at eob! */
r_if
c_cond
(paren
id|sg-&gt;Address
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_void
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
id|dma_addr
op_assign
id|le32_to_cpu
c_func
(paren
id|sg-&gt;Address
)paren
suffix:semicolon
id|kptr
op_assign
id|bl-&gt;kptr
suffix:semicolon
id|len
op_assign
id|bl-&gt;len
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dma_addr
comma
id|len
comma
id|dir
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sgl
comma
id|sgl_dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buflist
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: Free&squot;d 1 SGL buf + %d kbufs!&bslash;n&quot;
comma
id|n
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_ioctl_rwperf_init
id|mpt_ioctl_rwperf_init
c_func
(paren
r_struct
id|mpt_raw_r_w
op_star
id|dest
comma
r_int
r_int
id|src
comma
r_char
op_star
id|caller
comma
id|MPT_ADAPTER
op_star
op_star
id|iocpp
)paren
(brace
r_char
op_star
id|myname
op_assign
l_string|&quot;_rwperf_init()&quot;
suffix:semicolon
r_int
id|ioc
suffix:semicolon
multiline_comment|/* get copy of structure passed from user space */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dest
comma
(paren
r_void
op_star
)paren
id|src
comma
r_sizeof
(paren
op_star
id|dest
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;::%s() @%d - Can&squot;t copy mpt_raw_r_w data @ %p&bslash;n&quot;
comma
id|myname
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|src
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* (-14) Bad address */
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-perf: PerfInfo.{ioc,targ,qd,iters,nblks}&quot;
l_string|&quot;: %d %d %d %d %d&bslash;n&quot;
comma
id|dest-&gt;iocnum
comma
id|dest-&gt;target
comma
(paren
r_int
)paren
id|dest-&gt;qdepth
comma
id|dest-&gt;iters
comma
id|dest-&gt;nblks
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-perf: PerfInfo.{cache,skip,range,rdwr,seqran}&quot;
l_string|&quot;: %d %d %d %d %d&bslash;n&quot;
comma
id|dest-&gt;cache_sz
comma
id|dest-&gt;skip
comma
id|dest-&gt;range
comma
id|dest-&gt;rdwr
comma
id|dest-&gt;seqran
)paren
)paren
suffix:semicolon
multiline_comment|/* Get the MPT adapter id. */
r_if
c_cond
(paren
(paren
id|ioc
op_assign
id|mpt_verify_adapter
c_func
(paren
id|dest-&gt;iocnum
comma
id|iocpp
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;::%s() @%d - ioc%d not found!&bslash;n&quot;
comma
id|myname
comma
id|__LINE__
comma
id|dest-&gt;iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|MYNAM
l_string|&quot;-perf: %s using mpt/ioc%x, target %02xh&bslash;n&quot;
comma
id|caller
comma
id|dest-&gt;iocnum
comma
id|dest-&gt;target
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
id|ioc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*  Treat first N blocks of disk as sacred!  */
DECL|macro|SACRED_BLOCKS
mdefine_line|#define SACRED_BLOCKS&t;100
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_ioctl_rwperf
id|mpt_ioctl_rwperf
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_raw_r_w
id|kPerfInfo
suffix:semicolon
multiline_comment|/* NOTE: local copy, on stack==KERNEL_SPACE! */
id|u8
id|target
comma
id|targetM
suffix:semicolon
id|u8
id|lun
comma
id|lunM
suffix:semicolon
id|u8
id|scsiop
suffix:semicolon
r_int
id|qdepth
suffix:semicolon
r_int
id|iters
suffix:semicolon
r_int
id|cache_sz
suffix:semicolon
id|u32
id|xferbytes
suffix:semicolon
id|u32
id|scsidir
suffix:semicolon
id|u32
id|qtag
suffix:semicolon
id|u32
id|scsictl
suffix:semicolon
id|u32
id|sgdir
suffix:semicolon
id|u32
id|blkno
suffix:semicolon
id|u32
id|sbphys
suffix:semicolon
id|SGESimple32_t
op_star
id|sgl
suffix:semicolon
id|dma_addr_t
id|sgl_dma
suffix:semicolon
r_struct
id|buflist
op_star
id|buflist
suffix:semicolon
id|SGESimple32_t
op_star
id|sgOut
comma
op_star
id|sgIn
suffix:semicolon
r_int
id|numfrags
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ioc
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
r_int
id|sgfragcpycnt
suffix:semicolon
r_int
id|blklo
comma
id|blkhi
suffix:semicolon
id|u8
id|nextchainoffset
suffix:semicolon
id|u8
op_star
id|SenseBuf
suffix:semicolon
id|dma_addr_t
id|SenseBufDMA
suffix:semicolon
r_char
op_star
id|myname
op_assign
l_string|&quot;_rwperf()&quot;
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;%s - starting...&bslash;n&quot;
comma
id|myname
)paren
)paren
suffix:semicolon
multiline_comment|/* Validate target device */
r_if
c_cond
(paren
(paren
id|ioc
op_assign
id|mpt_ioctl_rwperf_init
c_func
(paren
op_amp
id|kPerfInfo
comma
id|arg
comma
id|myname
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
r_return
id|ioc
suffix:semicolon
multiline_comment|/* Allocate DMA&squot;able memory for the sense buffer. */
id|SenseBuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|iocp-&gt;pcidev
comma
l_int|256
comma
op_amp
id|SenseBufDMA
)paren
suffix:semicolon
multiline_comment|/* set perf parameters from input */
id|target
op_assign
id|kPerfInfo.target
op_amp
l_int|0x0FF
suffix:semicolon
id|targetM
op_assign
id|target
op_amp
id|myMAX_T_MASK
suffix:semicolon
id|lun
op_assign
id|kPerfInfo.lun
op_amp
l_int|0x1F
suffix:semicolon
singleline_comment|// LUN=31 max
id|lunM
op_assign
id|lun
op_amp
id|myMAX_L_MASK
suffix:semicolon
id|qdepth
op_assign
id|kPerfInfo.qdepth
suffix:semicolon
id|iters
op_assign
id|kPerfInfo.iters
suffix:semicolon
id|xferbytes
op_assign
(paren
(paren
id|u32
)paren
id|kPerfInfo.nblks
)paren
op_lshift
l_int|9
suffix:semicolon
id|DevInUse
(braket
id|targetM
)braket
(braket
id|lunM
)braket
op_assign
l_int|1
suffix:semicolon
id|DevIosCount
(braket
id|targetM
)braket
(braket
id|lunM
)braket
op_assign
l_int|0
suffix:semicolon
id|cache_sz
op_assign
id|kPerfInfo.cache_sz
op_star
l_int|1024
suffix:semicolon
singleline_comment|// CacheSz in kB!
multiline_comment|/* ToDo: */
multiline_comment|/* get capacity (?) */
singleline_comment|// pre-build, one time, everything we can for speed in the loops below...
id|scsiop
op_assign
l_int|0x28
suffix:semicolon
singleline_comment|// default to SCSI READ!
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
singleline_comment|// DATA IN  (host&lt;--ioc&lt;--dev)
singleline_comment|// 02000000
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_SIMPLEQ
suffix:semicolon
singleline_comment|// 00000000
r_if
c_cond
(paren
id|xferbytes
op_eq
l_int|0
)paren
(brace
singleline_comment|// Do 0-byte READ!!!
singleline_comment|//  IMPORTANT!  Need to set no SCSI DIR for this!
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_NODATATRANSFER
suffix:semicolon
)brace
id|scsictl
op_assign
id|scsidir
op_or
id|qtag
suffix:semicolon
multiline_comment|/*&n;     *  Set sgdir for DMA transfer.&n;     */
singleline_comment|//    sgdir   = 0x04000000;&t;&t;// SCSI WRITE
id|sgdir
op_assign
l_int|0x00000000
suffix:semicolon
singleline_comment|// SCSI READ
r_if
c_cond
(paren
(paren
id|sgl
op_assign
id|kbuf_alloc_2_sgl
c_func
(paren
id|MAX
c_func
(paren
l_int|512
comma
id|xferbytes
)paren
comma
id|sgdir
comma
op_amp
id|numfrags
comma
op_amp
id|buflist
comma
op_amp
id|sgl_dma
comma
id|iocp
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sgfragcpycnt
op_assign
id|MIN
c_func
(paren
l_int|10
comma
id|numfrags
)paren
suffix:semicolon
id|nextchainoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|numfrags
OG
l_int|10
)paren
id|nextchainoffset
op_assign
l_int|0x1E
suffix:semicolon
id|sbphys
op_assign
id|SenseBufDMA
suffix:semicolon
id|rwperf_reset
op_assign
l_int|0
suffix:semicolon
singleline_comment|//    do {&t;// target-loop
id|blkno
op_assign
id|SACRED_BLOCKS
suffix:semicolon
singleline_comment|// Treat first N blocks as sacred!
singleline_comment|// FIXME!  Skip option
id|blklo
op_assign
id|blkno
suffix:semicolon
id|blkhi
op_assign
id|blkno
suffix:semicolon
r_do
(brace
singleline_comment|// inner-loop
r_while
c_loop
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Start piecing the SCSIIORequest together */
id|msg
(braket
l_int|0
)braket
op_assign
l_int|0x00000000
op_or
id|nextchainoffset
op_lshift
l_int|16
op_or
id|target
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
l_int|0x0000FF0A
suffix:semicolon
singleline_comment|// 255 sense bytes, 10-byte CDB!
id|msg
(braket
l_int|3
)braket
op_assign
id|lun
op_lshift
l_int|8
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
id|scsictl
suffix:semicolon
singleline_comment|// 16 bytes of CDB @ msg[6,7,8,9] are below...
id|msg
(braket
l_int|6
)braket
op_assign
(paren
(paren
(paren
id|blkno
op_amp
l_int|0xFF000000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|blkno
op_amp
l_int|0x00FF0000
)paren
op_lshift
l_int|8
)paren
op_or
id|scsiop
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
(paren
(paren
(paren
(paren
id|u32
)paren
id|kPerfInfo.nblks
op_amp
l_int|0x0000FF00
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|blkno
op_amp
l_int|0x000000FF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|blkno
op_amp
l_int|0x0000FF00
)paren
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
(paren
id|kPerfInfo.nblks
op_amp
l_int|0x00FF
)paren
suffix:semicolon
id|msg
(braket
l_int|9
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|10
)braket
op_assign
id|xferbytes
suffix:semicolon
singleline_comment|//            msg[11] = 0xD0000100;
singleline_comment|//            msg[12] = sbphys;
singleline_comment|//            msg[13] = 0;
id|msg
(braket
l_int|11
)braket
op_assign
id|sbphys
suffix:semicolon
singleline_comment|// Copy the SGL...
r_if
c_cond
(paren
id|xferbytes
)paren
(brace
id|sgOut
op_assign
(paren
id|SGESimple32_t
op_star
)paren
op_amp
id|msg
(braket
l_int|12
)braket
suffix:semicolon
id|sgIn
op_assign
id|sgl
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sgfragcpycnt
suffix:semicolon
id|i
op_increment
)paren
op_star
id|sgOut
op_increment
op_assign
op_star
id|sgIn
op_increment
suffix:semicolon
)brace
singleline_comment|// fubar!  QueueDepth issue!!!
r_while
c_loop
(paren
op_logical_neg
id|rwperf_reset
op_logical_and
(paren
id|DevIosCount
(braket
id|targetM
)braket
(braket
id|lunM
)braket
op_ge
id|MIN
c_func
(paren
id|qdepth
comma
l_int|64
)paren
)paren
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
singleline_comment|//            blkno += kPerfInfo.nblks;
singleline_comment|// EXP Stuff!
singleline_comment|// Try optimizing to certain cache size for the target!
singleline_comment|// by keeping blkno within cache range if at all possible
macro_line|#if 0
r_if
c_cond
(paren
id|cache_sz
op_logical_and
(paren
(paren
l_int|2
op_star
id|kPerfInfo.nblks
)paren
op_le
(paren
id|cache_sz
op_rshift
l_int|9
)paren
)paren
op_logical_and
(paren
(paren
id|blkno
op_plus
id|kPerfInfo.nblks
)paren
OG
(paren
(paren
id|cache_sz
op_rshift
l_int|9
)paren
op_plus
id|SACRED_BLOCKS
)paren
)paren
)paren
id|blkno
op_assign
id|SACRED_BLOCKS
suffix:semicolon
r_else
id|blkno
op_add_assign
id|kPerfInfo.nblks
suffix:semicolon
macro_line|#endif
singleline_comment|// Ok, cheat!
r_if
c_cond
(paren
id|cache_sz
op_logical_and
(paren
(paren
id|blkno
op_plus
id|kPerfInfo.nblks
)paren
OG
(paren
(paren
id|cache_sz
op_rshift
l_int|9
)paren
op_plus
id|SACRED_BLOCKS
)paren
)paren
)paren
id|blkno
op_assign
id|SACRED_BLOCKS
suffix:semicolon
r_else
id|blkno
op_add_assign
id|kPerfInfo.nblks
suffix:semicolon
r_if
c_cond
(paren
id|blkno
OG
id|blkhi
)paren
id|blkhi
op_assign
id|blkno
suffix:semicolon
id|DevIosCount
(braket
id|targetM
)braket
(braket
id|lunM
)braket
op_increment
suffix:semicolon
multiline_comment|/*&n;             *  Finally, post the request&n;             */
id|mpt_put_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc
comma
id|mf
)paren
suffix:semicolon
multiline_comment|/* let linux breath! */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
singleline_comment|//dprintk((KERN_DEBUG MYNAM &quot;-perf: inner-loop, cnt=%d&bslash;n&quot;, iters));
)brace
r_while
c_loop
(paren
(paren
op_decrement
id|iters
OG
l_int|0
)paren
op_logical_and
op_logical_neg
id|rwperf_reset
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-perf: DbG: blklo=%d, blkhi=%d&bslash;n&quot;
comma
id|blklo
comma
id|blkhi
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-perf: target-loop, thisTarget=%d&bslash;n&quot;
comma
id|target
)paren
)paren
suffix:semicolon
singleline_comment|//        //  TEMPORARY!
singleline_comment|//        target = 0;
singleline_comment|//    } while (target);
r_if
c_cond
(paren
id|DevIosCount
(braket
id|targetM
)braket
(braket
id|lunM
)braket
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  DbG: DevIosCount[%d][%d]=%d&bslash;n&quot;
comma
id|targetM
comma
id|lunM
comma
id|DevIosCount
(braket
id|targetM
)braket
(braket
id|lunM
)braket
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|DevIosCount
(braket
id|targetM
)braket
(braket
id|lunM
)braket
)paren
(brace
singleline_comment|//dprintk((KERN_DEBUG &quot;  DbG: Waiting... DevIosCount[%d][%d]=%d&bslash;n&quot;,
singleline_comment|//        targetM, lunM, DevIosCount[targetM][lunM]));
id|mb
c_func
(paren
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|DevInUse
(braket
id|targetM
)braket
(braket
id|lunM
)braket
op_assign
l_int|0
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|iocp-&gt;pcidev
comma
l_int|256
comma
id|SenseBuf
comma
id|SenseBufDMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sgl
)paren
id|kfree_sgl
c_func
(paren
id|sgl
comma
id|sgl_dma
comma
id|buflist
comma
id|iocp
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  *** done ***&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_ioctl_rwperf_status
id|mpt_ioctl_rwperf_status
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_raw_r_w
id|kPerfInfo
suffix:semicolon
multiline_comment|/* NOTE: local copy, on stack==KERNEL_SPACE! */
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
r_int
id|ioc
suffix:semicolon
singleline_comment|//&t;u8&t;&t; targ;
singleline_comment|//&t;u8&t;&t; lun;
r_int
id|T
comma
id|L
suffix:semicolon
r_char
op_star
id|myname
op_assign
l_string|&quot;_rwperf_status()&quot;
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;%s - starting...&bslash;n&quot;
comma
id|myname
)paren
)paren
suffix:semicolon
multiline_comment|/* Get a pointer to the MPT adapter. */
r_if
c_cond
(paren
(paren
id|ioc
op_assign
id|mpt_ioctl_rwperf_init
c_func
(paren
op_amp
id|kPerfInfo
comma
id|arg
comma
id|myname
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
r_return
id|ioc
suffix:semicolon
multiline_comment|/* set perf parameters from input */
singleline_comment|//&t;targ = kPerfInfo.target &amp; 0xFF;
singleline_comment|//&t;lun = kPerfInfo.lun &amp; 0x1F;
r_for
c_loop
(paren
id|T
op_assign
l_int|0
suffix:semicolon
id|T
OL
id|myMAX_TARGETS
suffix:semicolon
id|T
op_increment
)paren
r_for
c_loop
(paren
id|L
op_assign
l_int|0
suffix:semicolon
id|L
OL
id|myMAX_LUNS
suffix:semicolon
id|L
op_increment
)paren
r_if
c_cond
(paren
id|DevIosCount
(braket
id|T
)braket
(braket
id|L
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ioc%d-&gt;00:%02x:%02x&quot;
l_string|&quot;, IosCnt=%d&bslash;n&quot;
comma
id|myname
comma
id|ioc
comma
id|T
comma
id|L
comma
id|DevIosCount
(braket
id|T
)braket
(braket
id|L
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_ioctl_rwperf_reset
id|mpt_ioctl_rwperf_reset
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_raw_r_w
id|kPerfInfo
suffix:semicolon
multiline_comment|/* NOTE: local copy, on stack==KERNEL_SPACE! */
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
r_int
id|ioc
suffix:semicolon
singleline_comment|//&t;u8&t;&t; targ;
singleline_comment|//&t;u8&t;&t; lun;
r_int
id|T
comma
id|L
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|myname
op_assign
l_string|&quot;_rwperf_reset()&quot;
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;%s - starting...&bslash;n&quot;
comma
id|myname
)paren
)paren
suffix:semicolon
multiline_comment|/* Get MPT adapter id. */
r_if
c_cond
(paren
(paren
id|ioc
op_assign
id|mpt_ioctl_rwperf_init
c_func
(paren
op_amp
id|kPerfInfo
comma
id|arg
comma
id|myname
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
r_return
id|ioc
suffix:semicolon
multiline_comment|/* set perf parameters from input */
singleline_comment|//&t;targ = kPerfInfo.target &amp; 0xFF;
singleline_comment|//&t;lun = kPerfInfo.lun &amp; 0x1F;
id|rwperf_reset
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|rwperf_reset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|T
op_assign
l_int|0
suffix:semicolon
id|T
OL
id|myMAX_TARGETS
suffix:semicolon
id|T
op_increment
)paren
r_for
c_loop
(paren
id|L
op_assign
l_int|0
suffix:semicolon
id|L
OL
id|myMAX_LUNS
suffix:semicolon
id|L
op_increment
)paren
r_if
c_cond
(paren
id|DevIosCount
(braket
id|T
)braket
(braket
id|L
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ioc%d-&gt;00:%02x:%02x, &quot;
l_string|&quot;IosCnt RESET! (from %d to 0)&bslash;n&quot;
comma
id|myname
comma
id|ioc
comma
id|T
comma
id|L
comma
id|DevIosCount
(braket
id|T
)braket
(braket
id|L
)braket
)paren
suffix:semicolon
id|DevIosCount
(braket
id|T
)braket
(braket
id|L
)braket
op_assign
l_int|0
suffix:semicolon
id|DevInUse
(braket
id|T
)braket
(braket
id|L
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mpt_ioctl_scsi_cmd
id|mpt_ioctl_scsi_cmd
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,51)
DECL|macro|owner_THIS_MODULE
mdefine_line|#define&t;owner_THIS_MODULE  owner:&t;&t;THIS_MODULE,
macro_line|#else
DECL|macro|owner_THIS_MODULE
mdefine_line|#define&t;owner_THIS_MODULE
macro_line|#endif
DECL|variable|mptctl_fops
r_static
r_struct
id|file_operations
id|mptctl_fops
op_assign
(brace
id|owner_THIS_MODULE
id|llseek
suffix:colon
id|no_llseek
comma
id|read
suffix:colon
id|mptctl_read
comma
id|write
suffix:colon
id|mptctl_write
comma
id|ioctl
suffix:colon
id|mpt_ioctl
comma
id|open
suffix:colon
id|mptctl_open
comma
id|release
suffix:colon
id|mptctl_release
comma
)brace
suffix:semicolon
DECL|variable|mptctl_miscdev
r_static
r_struct
id|miscdevice
id|mptctl_miscdev
op_assign
(brace
id|MPT_MINOR
comma
id|MYNAM
comma
op_amp
id|mptctl_fops
)brace
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#if defined(__sparc__) &amp;&amp; defined(__sparc_v9__)&t;&t;/*{*/
multiline_comment|/* The dynamic ioctl32 compat. registry only exists in &gt;2.3.x sparc64 kernels */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)&t;&t;/*{*/
r_extern
r_int
id|register_ioctl32_conversion
c_func
(paren
r_int
r_int
id|cmd
comma
r_int
(paren
op_star
id|handler
)paren
(paren
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_struct
id|file
op_star
)paren
)paren
suffix:semicolon
r_int
id|unregister_ioctl32_conversion
c_func
(paren
r_int
r_int
id|cmd
)paren
suffix:semicolon
DECL|struct|mpt_fw_xfer32
r_struct
id|mpt_fw_xfer32
(brace
DECL|member|iocnum
r_int
r_int
id|iocnum
suffix:semicolon
DECL|member|fwlen
r_int
r_int
id|fwlen
suffix:semicolon
DECL|member|bufp
id|u32
id|bufp
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|MPTFWDOWNLOAD32
mdefine_line|#define MPTFWDOWNLOAD32     _IOWR(MPT_MAGIC_NUMBER,15,struct mpt_fw_xfer32)
r_extern
id|asmlinkage
r_int
id|sys_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|sparc32_mptfwxfer_ioctl
id|sparc32_mptfwxfer_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|mpt_fw_xfer32
id|kfw32
suffix:semicolon
r_struct
id|mpt_fw_xfer
id|kfw
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iocnum
comma
id|iocnumX
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::sparc32_mptfwxfer_ioctl() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kfw32
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|kfw32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Verify intended MPT adapter */
id|iocnumX
op_assign
id|kfw32.iocnum
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;::sparc32_mptfwxfer_ioctl @%d - ioc%d not found!&bslash;n&quot;
comma
id|__LINE__
comma
id|iocnumX
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|kfw.iocnum
op_assign
id|iocnum
suffix:semicolon
id|kfw.fwlen
op_assign
id|kfw32.fwlen
suffix:semicolon
id|kfw.bufp
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|kfw32.bufp
suffix:semicolon
id|ret
op_assign
id|mpt_ioctl_do_fw_download
c_func
(paren
id|kfw.iocnum
comma
id|kfw.bufp
comma
id|kfw.fwlen
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|iocp-&gt;id
)braket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif&t;&t;/*} linux &gt;= 2.3.x */
macro_line|#endif&t;&t;/*} sparc */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_init
r_int
id|__init
id|mptctl_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|where
op_assign
l_int|1
suffix:semicolon
id|show_mptmod_ver
c_func
(paren
id|my_NAME
comma
id|my_VERSION
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MPT_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sema_init
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|i
)braket
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if defined(__sparc__) &amp;&amp; defined(__sparc_v9__)&t;&t;/*{*/
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)&t;&t;/*{*/
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTRWPERF
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTRWPERF_CHK
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTRWPERF_RESET
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTFWDOWNLOAD32
comma
id|sparc32_mptfwxfer_ioctl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
macro_line|#endif&t;&t;/*} linux &gt;= 2.3.x */
macro_line|#endif&t;&t;/*} sparc */
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: Can&squot;t register misc device [minor=%d].&bslash;n&quot;
comma
id|MPT_MINOR
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered with Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: /dev/%s @ (major,minor=%d,%d)&bslash;n&quot;
comma
id|mptctl_miscdev.name
comma
id|MISC_MAJOR
comma
id|mptctl_miscdev.minor
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Install our handler&n;&t; */
op_increment
id|where
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mptctl_id
op_assign
id|mpt_register
c_func
(paren
id|mptctl_reply
comma
id|MPTCTL_DRIVER
)paren
)paren
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR: Failed to register with Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_fail
suffix:colon
macro_line|#if defined(__sparc__) &amp;&amp; defined(__sparc_v9__)&t;&t;/*{*/
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)&t;&t;/*{*/
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR: Failed to register ioctl32_conversion!&quot;
l_string|&quot; (%d:err=%d)&bslash;n&quot;
comma
id|where
comma
id|err
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTRWPERF
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTRWPERF_CHK
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTRWPERF_RESET
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTFWDOWNLOAD32
)paren
suffix:semicolon
macro_line|#endif&t;&t;/*} linux &gt;= 2.3.x */
macro_line|#endif&t;&t;/*} sparc */
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_exit
r_void
id|mptctl_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(__sparc__) &amp;&amp; defined(__sparc_v9__)&t;&t;/*{*/
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)&t;&t;/*{*/
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTRWPERF
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTRWPERF_CHK
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTRWPERF_RESET
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTFWDOWNLOAD32
)paren
suffix:semicolon
macro_line|#endif&t;&t;/*} linux &gt;= 2.3.x */
macro_line|#endif&t;&t;/*} sparc */
id|misc_deregister
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: /dev/%s @ (major,minor=%d,%d)&bslash;n&quot;
comma
id|mptctl_miscdev.name
comma
id|MISC_MAJOR
comma
id|mptctl_miscdev.minor
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered from Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|mptctl_id
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mptctl_init
id|module_init
c_func
(paren
id|mptctl_init
)paren
suffix:semicolon
DECL|variable|mptctl_exit
id|module_exit
c_func
(paren
id|mptctl_exit
)paren
suffix:semicolon
eof
