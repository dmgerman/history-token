multiline_comment|/*&n; *  linux/drivers/message/fusion/mptctl.c&n; *      Fusion MPT misc device (ioctl) driver.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      A special thanks to Pamela Delaney (LSI Logic) for tons of work&n; *      and countless enhancements while adding support for the 1030&n; *      chip family.  Pam has been instrumental in the development of&n; *      of the 2.xx.xx series fusion drivers, and her contributions are&n; *      far too numerous to hope to list in one place.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      A big THANKS to Eddie C. Dost for fixing the ioctl path&n; *      and most importantly f/w download on sparc64 platform!&n; *      (plus Eddie&squot;s other helpful hints and insights)&n; *&n; *      Thanks to Arnaldo Carvalho de Melo for finding and patching&n; *      a potential memory leak in mptctl_do_fw_download(),&n; *      and for some kmalloc insight:-)&n; *&n; *      (see also mptbase.c)&n; *&n; *  Copyright (c) 1999-2002 LSI Logic Corporation&n; *  Originally By: Steven J. Ralston, Noah Romer&n; *  (mailto:sjralston1@netscape.net)&n; *  (mailto:Pam.Delaney@lsil.com)&n; *&n; *  $Id: mptctl.c,v 1.55 2002/06/20 13:28:16 pdelaney Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;&t;/* needed for access to Scsi_Host struct */
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/blk.h&gt;          /* for io_request_lock (spinlock) decl */
macro_line|#include &quot;../../scsi/scsi.h&quot;
macro_line|#include &quot;../../scsi/hosts.h&quot;
DECL|macro|COPYRIGHT
mdefine_line|#define COPYRIGHT&t;&quot;Copyright (c) 1999-2001 LSI Logic Corporation&quot;
DECL|macro|MODULEAUTHOR
mdefine_line|#define MODULEAUTHOR&t;&quot;Steven J. Ralston, Noah Romer, Pamela Delaney&quot;
macro_line|#include &quot;mptbase.h&quot;
macro_line|#include &quot;mptctl.h&quot;
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|my_NAME
mdefine_line|#define my_NAME&t;&t;&quot;Fusion MPT misc device (ioctl) driver&quot;
DECL|macro|my_VERSION
mdefine_line|#define my_VERSION&t;MPT_LINUX_VERSION_COMMON
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptctl&quot;
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|variable|MODULEAUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|MODULEAUTHOR
)paren
suffix:semicolon
DECL|variable|my_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|my_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mptctl_id
r_static
r_int
id|mptctl_id
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mptctl_syscall_sem_ioc
r_static
r_struct
id|semaphore
id|mptctl_syscall_sem_ioc
(braket
id|MPT_MAX_ADAPTERS
)braket
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|mptctl_wait
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|struct|buflist
r_struct
id|buflist
(brace
DECL|member|kptr
id|u8
op_star
id|kptr
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Function prototypes. Called from OS entry point mptctl_ioctl.&n; * arg contents specific to function.&n; */
r_static
r_int
id|mptctl_fw_download
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_getiocinfo
(paren
r_int
r_int
id|arg
comma
r_int
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|mptctl_gettargetinfo
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_readtest
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_mpt_command
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_eventquery
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_eventenable
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_eventreport
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_replace_fw
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_do_reset
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_compaq_ioctl
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_cpq_getpciinfo
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_cpq_getdriver
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_cpq_ctlr_status
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_cpq_target_address
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_cpq_passthru
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_compaq_scsiio
c_func
(paren
id|VENDOR_IOCTL_REQ
op_star
id|pVenReq
comma
id|cpqfc_passthru_t
op_star
id|pPass
)paren
suffix:semicolon
multiline_comment|/*&n; * Private function calls.&n; */
r_static
r_int
id|mptctl_do_mpt_command
(paren
r_struct
id|mpt_ioctl_command
id|karg
comma
r_char
op_star
id|mfPtr
comma
r_int
id|local
)paren
suffix:semicolon
r_static
r_int
id|mptctl_do_fw_download
c_func
(paren
r_int
id|ioc
comma
r_char
op_star
id|ufwbuf
comma
r_int
id|fwlen
)paren
suffix:semicolon
r_static
id|MptSge_t
op_star
id|kbuf_alloc_2_sgl
c_func
(paren
r_int
id|bytes
comma
id|u32
id|dir
comma
r_int
id|sge_offset
comma
r_int
op_star
id|frags
comma
r_struct
id|buflist
op_star
op_star
id|blp
comma
id|dma_addr_t
op_star
id|sglbuf_dma
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|kfree_sgl
c_func
(paren
id|MptSge_t
op_star
id|sgl
comma
id|dma_addr_t
id|sgl_dma
comma
r_struct
id|buflist
op_star
id|buflist
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|mptctl_timer_expired
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_int
id|mptctl_bus_reset
c_func
(paren
id|MPT_IOCTL
op_star
id|ioctl
)paren
suffix:semicolon
r_static
r_int
id|mptctl_set_tm_flags
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
suffix:semicolon
r_static
r_void
id|mptctl_free_tm_flags
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
multiline_comment|/*&n; * Reset Handler cleanup function&n; */
r_static
r_int
id|mptctl_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Scatter gather list (SGL) sizes and limits...&n; */
singleline_comment|//#define MAX_SCSI_FRAGS&t;9
DECL|macro|MAX_FRAGS_SPILL1
mdefine_line|#define MAX_FRAGS_SPILL1&t;9
DECL|macro|MAX_FRAGS_SPILL2
mdefine_line|#define MAX_FRAGS_SPILL2&t;15
DECL|macro|FRAGS_PER_BUCKET
mdefine_line|#define FRAGS_PER_BUCKET&t;(MAX_FRAGS_SPILL2 + 1)
singleline_comment|//#define MAX_CHAIN_FRAGS&t;64
singleline_comment|//#define MAX_CHAIN_FRAGS&t;(15+15+15+16)
DECL|macro|MAX_CHAIN_FRAGS
mdefine_line|#define MAX_CHAIN_FRAGS&t;&t;(4 * MAX_FRAGS_SPILL2 + 1)
singleline_comment|//  Define max sg LIST bytes ( == (#frags + #chains) * 8 bytes each)
singleline_comment|//  Works out to: 592d bytes!     (9+1)*8 + 4*(15+1)*8
singleline_comment|//                  ^----------------- 80 + 512
DECL|macro|MAX_SGL_BYTES
mdefine_line|#define MAX_SGL_BYTES&t;&t;((MAX_FRAGS_SPILL1 + 1 + (4 * FRAGS_PER_BUCKET)) * 8)
multiline_comment|/* linux only seems to ever give 128kB MAX contiguous (GFP_USER) mem bytes */
DECL|macro|MAX_KMALLOC_SZ
mdefine_line|#define MAX_KMALLOC_SZ&t;&t;(128*1024)
DECL|macro|MPT_IOCTL_DEFAULT_TIMEOUT
mdefine_line|#define MPT_IOCTL_DEFAULT_TIMEOUT 10&t;/* Default timeout value (seconds) */
DECL|variable|fwReplyBuffer
r_static
id|u32
id|fwReplyBuffer
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|ReplyMsg
r_static
id|pMPIDefaultReply_t
id|ReplyMsg
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptctl_syscall_down - Down the MPT adapter syscall semaphore.&n; *&t;@ioc: Pointer to MPT adapter&n; *&t;@nonblock: boolean, non-zero if O_NONBLOCK is set&n; *&n; *&t;All of the ioctl commands can potentially sleep, which is illegal&n; *&t;with a spinlock held, thus we perform mutual exclusion here.&n; *&n; *&t;Returns negative errno on error, or zero for success.&n; */
r_static
r_inline
r_int
DECL|function|mptctl_syscall_down
id|mptctl_syscall_down
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|nonblock
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::mptctl_syscall_down(%p,%d) called&bslash;n&quot;
comma
id|ioc
comma
id|nonblock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;tmPtr
op_ne
l_int|NULL
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::mptctl_syscall_down BUSY&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#if defined(__sparc__) &amp;&amp; defined(__sparc_v9__)&t;&t;/*{*/
r_if
c_cond
(paren
op_logical_neg
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|ioc-&gt;id
)braket
)paren
)paren
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|ioc-&gt;id
)braket
)paren
)paren
id|rc
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|ioc-&gt;id
)braket
)paren
)paren
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
macro_line|#endif
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::mptctl_syscall_down return %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  This is the callback for any message we have posted. The message itself&n; *  will be returned to the message pool when we return from the IRQ&n; *&n; *  This runs in irq context so be short and sweet.&n; */
r_static
r_int
DECL|function|mptctl_reply
id|mptctl_reply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|req
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
(brace
r_char
op_star
id|sense_data
suffix:semicolon
r_int
id|sz
comma
id|req_index
suffix:semicolon
id|u16
id|iocStatus
suffix:semicolon
id|u8
id|cmd
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: mptctl_reply()!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
id|cmd
op_assign
id|req-&gt;u.hdr.Function
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;ioctl
)paren
(brace
multiline_comment|/* If timer is not running, then an error occurred.&n;&t;&t; * A timeout will call the reset routine to reload the messaging&n;&t;&t; * queues.&n;&t;&t; * Main callback will free message and reply frames.&n;&t;&t; */
r_if
c_cond
(paren
id|reply
op_logical_and
(paren
id|cmd
op_eq
id|MPI_FUNCTION_SCSI_TASK_MGMT
)paren
op_logical_and
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_TMTIMER_ACTIVE
)paren
)paren
(brace
multiline_comment|/* This is internally generated TM&n;&t;&t;&t; */
id|del_timer
(paren
op_amp
id|ioc-&gt;ioctl-&gt;TMtimer
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_and_assign
op_complement
id|MPT_IOCTL_STATUS_TMTIMER_ACTIVE
suffix:semicolon
id|mptctl_free_tm_flags
c_func
(paren
id|ioc
)paren
suffix:semicolon
multiline_comment|/* If TM failed, reset the timer on the existing command,&n;&t;&t;&t; * will trigger an adapter reset.&n;&t;&t;&t; */
id|iocStatus
op_assign
id|reply-&gt;u.reply.IOCStatus
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
r_if
c_cond
(paren
id|iocStatus
op_eq
id|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_TIMER_ACTIVE
)paren
(brace
id|del_timer
(paren
op_amp
id|ioc-&gt;ioctl-&gt;timer
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ioc-&gt;ioctl-&gt;timer
)paren
suffix:semicolon
)brace
)brace
id|ioc-&gt;ioctl-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_TIMER_ACTIVE
)paren
(brace
multiline_comment|/* Delete this timer&n;&t;&t;&t; */
id|del_timer
(paren
op_amp
id|ioc-&gt;ioctl-&gt;timer
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_and_assign
op_complement
id|MPT_IOCTL_STATUS_TIMER_ACTIVE
suffix:semicolon
multiline_comment|/* Set the overall status byte.  Good if:&n;&t;&t;&t; * IOC status is good OR if no reply and a SCSI IO request&n;&t;&t;&t; */
r_if
c_cond
(paren
id|reply
)paren
(brace
multiline_comment|/* Copy the reply frame (which much exist&n;&t;&t;&t;&t; * for non-SCSI I/O) to the IOC structure.&n;&t;&t;&t;&t; */
id|dctlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: Copying Reply Frame @%p to IOC!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|reply
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ioc-&gt;ioctl-&gt;ReplyFrame
comma
id|reply
comma
id|MIN
c_func
(paren
id|ioc-&gt;reply_sz
comma
l_int|4
op_star
id|reply-&gt;u.reply.MsgLength
)paren
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_RF_VALID
suffix:semicolon
multiline_comment|/* Set the command status to GOOD if IOC Status is GOOD&n;&t;&t;&t;&t; * OR if SCSI I/O cmd and data underrun or recovered error.&n;&t;&t;&t;&t; */
id|iocStatus
op_assign
id|reply-&gt;u.reply.IOCStatus
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
r_if
c_cond
(paren
id|iocStatus
op_eq
id|MPI_IOCSTATUS_SUCCESS
)paren
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_COMMAND_GOOD
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
op_logical_or
(paren
id|cmd
op_eq
id|MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH
)paren
)paren
(brace
id|ioc-&gt;ioctl-&gt;reset
op_and_assign
op_complement
id|MPTCTL_RESET_OK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iocStatus
op_eq
id|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
)paren
op_logical_or
(paren
id|iocStatus
op_eq
id|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
)paren
)paren
(brace
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_COMMAND_GOOD
suffix:semicolon
)brace
)brace
multiline_comment|/* Copy the sense data - if present&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
op_logical_and
(paren
id|reply-&gt;u.sreply.SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
)paren
(brace
id|sz
op_assign
id|req-&gt;u.scsireq.SenseBufferLength
suffix:semicolon
id|req_index
op_assign
id|le16_to_cpu
c_func
(paren
id|req-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sense_data
op_assign
(paren
(paren
id|u8
op_star
)paren
id|ioc-&gt;sense_buf_pool
op_plus
(paren
id|req_index
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ioc-&gt;ioctl-&gt;sense
comma
id|sense_data
comma
id|sz
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_SENSE_VALID
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|MPI_FUNCTION_SCSI_TASK_MGMT
)paren
id|mptctl_free_tm_flags
c_func
(paren
id|ioc
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
op_logical_or
(paren
id|cmd
op_eq
id|MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH
)paren
)paren
(brace
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_COMMAND_GOOD
suffix:semicolon
id|ioc-&gt;ioctl-&gt;reset
op_and_assign
op_complement
id|MPTCTL_RESET_OK
suffix:semicolon
)brace
multiline_comment|/* We are done, issue wake up&n;&t;&t;&t; */
id|ioc-&gt;ioctl-&gt;wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|mptctl_wait
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reply
op_logical_and
id|cmd
op_eq
id|MPI_FUNCTION_FW_DOWNLOAD
)paren
(brace
multiline_comment|/* Two paths to FW DOWNLOAD! */
singleline_comment|// NOTE: Expects/requires non-Turbo reply!
id|dctlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;:Caching MPI_FUNCTION_FW_DOWNLOAD reply!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fwReplyBuffer
comma
id|reply
comma
id|MIN
c_func
(paren
r_sizeof
(paren
id|fwReplyBuffer
)paren
comma
l_int|4
op_star
id|reply-&gt;u.reply.MsgLength
)paren
)paren
suffix:semicolon
id|ReplyMsg
op_assign
(paren
id|pMPIDefaultReply_t
)paren
id|fwReplyBuffer
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_timer_expired&n; *&n; * Call back for timer process. Used only for ioctl functionality.&n; *&n; */
DECL|function|mptctl_timer_expired
r_static
r_void
id|mptctl_timer_expired
(paren
r_int
r_int
id|data
)paren
(brace
id|MPT_IOCTL
op_star
id|ioctl
op_assign
(paren
id|MPT_IOCTL
op_star
)paren
id|data
suffix:semicolon
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_NOTICE
id|MYNAM
l_string|&quot;: Timer Expired! Host %d&bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ioctl-&gt;reset
op_amp
id|MPTCTL_RESET_OK
)paren
id|rc
op_assign
id|mptctl_bus_reset
c_func
(paren
id|ioctl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* Issue a reset for this device.&n;&t;&t; * The IOC is not responding.&n;&t;&t; */
id|mpt_HardResetHandler
c_func
(paren
id|ioctl-&gt;ioc
comma
id|NO_SLEEP
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* mptctl_bus_reset&n; *&n; * Bus reset code.&n; *&n; */
DECL|function|mptctl_bus_reset
r_static
r_int
id|mptctl_bus_reset
c_func
(paren
id|MPT_IOCTL
op_star
id|ioctl
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTm
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|ioctl-&gt;reset
op_and_assign
op_complement
id|MPTCTL_RESET_OK
suffix:semicolon
r_if
c_cond
(paren
id|ioctl-&gt;ioc-&gt;sh
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioctl-&gt;ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Single threading ....&n;&t; */
r_if
c_cond
(paren
id|mptctl_set_tm_flags
c_func
(paren
id|hd
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Send request&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioctl-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;IssueTaskMgmt, no msg frames!!&bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|mptctl_free_tm_flags
c_func
(paren
id|ioctl-&gt;ioc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;IssueTaskMgmt request @ %p&bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;name
comma
id|mf
)paren
)paren
suffix:semicolon
id|pScsiTm
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
id|pScsiTm-&gt;TargetID
op_assign
id|ioctl-&gt;target
suffix:semicolon
id|pScsiTm-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
multiline_comment|/* 0 */
id|pScsiTm-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:semicolon
id|pScsiTm-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskType
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
suffix:semicolon
id|pScsiTm-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;MsgFlags
op_assign
id|MPI_SCSITASKMGMT_MSGFLAGS_LIPRESET_RESET_OPTION
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiTm-&gt;LUN
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|7
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiTm-&gt;Reserved2
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskMsgContext
op_assign
l_int|0
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;mptctl_bus_reset: issued.&bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|ioctl-&gt;tmPtr
op_assign
id|mf
suffix:semicolon
id|ioctl-&gt;TMtimer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|20
suffix:semicolon
multiline_comment|/* 20 seconds */
id|ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_TMTIMER_ACTIVE
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ioctl-&gt;TMtimer
)paren
suffix:semicolon
id|retval
op_assign
id|mpt_send_handshake_request
c_func
(paren
id|mptctl_id
comma
id|ioctl-&gt;ioc-&gt;id
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
(paren
id|u32
op_star
)paren
id|pScsiTm
comma
id|NO_SLEEP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;_send_handshake FAILED!&quot;
l_string|&quot; (hd %p, ioc %p, mf %p) &bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;name
comma
id|hd
comma
id|hd-&gt;ioc
comma
id|mf
)paren
)paren
suffix:semicolon
id|mptctl_free_tm_flags
c_func
(paren
id|ioctl-&gt;ioc
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ioctl-&gt;TMtimer
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioctl-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|ioctl-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|mptctl_set_tm_flags
id|mptctl_set_tm_flags
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef MPT_SCSI_USE_NEW_EH
r_if
c_cond
(paren
id|hd-&gt;tmState
op_eq
id|TM_STATE_NONE
)paren
(brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_IN_PROGRESS
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|hd-&gt;tmPending
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
id|hd-&gt;tmPending
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|mptctl_free_tm_flags
id|mptctl_free_tm_flags
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef MPT_SCSI_USE_NEW_EH
id|hd-&gt;tmState
op_assign
id|TM_STATE_ERROR
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#else
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_ioc_reset&n; *&n; * Clean-up functionality. Used only if there has been a&n; * reload of the FW due.&n; *&n; */
r_static
r_int
DECL|function|mptctl_ioc_reset
id|mptctl_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
(brace
id|MPT_IOCTL
op_star
id|ioctl
op_assign
id|ioc-&gt;ioctl
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: IOC %s_reset routed to IOCTL driver!&bslash;n&quot;
comma
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
ques
c_cond
l_string|&quot;pre&quot;
suffix:colon
l_string|&quot;post&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
)paren
(brace
multiline_comment|/* Someone has called the reset handler to&n;&t;&t; * do a hard reset. No more replies from the FW.&n;&t;&t; * Delete the timer. TM flags cleaned up by SCSI driver.&n;&t;&t; * Do not need to free msg frame, as re-initialized&n;&t;&t; */
r_if
c_cond
(paren
id|ioctl
op_logical_and
(paren
id|ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_TIMER_ACTIVE
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|ioctl-&gt;timer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioctl
op_logical_and
(paren
id|ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_TMTIMER_ACTIVE
)paren
)paren
(brace
id|ioctl-&gt;status
op_and_assign
op_complement
id|MPT_IOCTL_STATUS_TMTIMER_ACTIVE
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ioctl-&gt;TMtimer
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc-&gt;id
comma
id|ioctl-&gt;tmPtr
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Set the status and continue IOCTL&n;&t;&t; * processing. All memory will be free&squot;d&n;&t;&t; * by originating thread after wake_up is&n;&t;&t; * called.&n;&t;&t; */
r_if
c_cond
(paren
id|ioctl
op_logical_and
(paren
id|ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_TIMER_ACTIVE
)paren
)paren
(brace
id|ioctl-&gt;status
op_assign
id|MPT_IOCTL_STATUS_DID_IOCRESET
suffix:semicolon
multiline_comment|/* Wake up the calling process&n;&t;&t;&t; */
id|ioctl-&gt;wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|mptctl_wait
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  struct file_operations functionality.&n; *  Members:&n; *&t;llseek, write, read, ioctl, open, release&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,9)
r_static
id|loff_t
DECL|function|mptctl_llseek
id|mptctl_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
DECL|macro|no_llseek
mdefine_line|#define no_llseek mptctl_llseek
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
id|ssize_t
DECL|function|mptctl_write
id|mptctl_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ioctl WRITE not yet supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
id|ssize_t
DECL|function|mptctl_read
id|mptctl_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ptr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ioctl READ not yet supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  MPT ioctl handler&n; *  cmd - specify the particular IOCTL command to be issued&n; *  arg - data specific to the command. Must not be null.&n; */
r_static
r_int
DECL|function|mptctl_ioctl
id|mptctl_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|mpt_ioctl_header
op_star
id|uhdr
op_assign
(paren
id|mpt_ioctl_header
op_star
)paren
id|arg
suffix:semicolon
id|mpt_ioctl_header
id|khdr
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|iocnumX
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_ioctl() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|khdr
comma
id|uhdr
comma
r_sizeof
(paren
id|khdr
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_ioctl() @%d - &quot;
l_string|&quot;Unable to copy mpt_ioctl_header data @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uhdr
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
multiline_comment|/* Test for Compaq-specific IOCTL&squot;s.&n;&t; */
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|CPQFCTS_GETPCIINFO
)paren
op_logical_or
(paren
id|cmd
op_eq
id|CPQFCTS_CTLR_STATUS
)paren
op_logical_or
(paren
id|cmd
op_eq
id|CPQFCTS_GETDRIVER
)paren
op_logical_or
(paren
id|cmd
op_eq
id|CPQFCTS_SCSI_PASSTHRU
)paren
op_logical_or
(paren
id|cmd
op_eq
id|CPQFCTS_SCSI_IOCTL_FC_TARGET_ADDRESS
)paren
)paren
r_return
id|mptctl_compaq_ioctl
c_func
(paren
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
multiline_comment|/* Verify intended MPT adapter - set iocnum and the adapter&n;&t; * pointer (iocp)&n;&t; */
id|iocnumX
op_assign
id|khdr.iocnum
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_ioctl() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnumX
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Handle those commands that are just returning&n;&t; * information stored in the driver.&n;&t; * These commands should never time out and are unaffected&n;&t; * by TM and FW reloads.&n;&t; */
r_if
c_cond
(paren
(paren
id|cmd
op_amp
op_complement
id|IOCSIZE_MASK
)paren
op_eq
(paren
id|MPTIOCINFO
op_amp
op_complement
id|IOCSIZE_MASK
)paren
)paren
(brace
r_return
id|mptctl_getiocinfo
c_func
(paren
id|arg
comma
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTTARGETINFO
)paren
(brace
r_return
id|mptctl_gettargetinfo
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTTEST
)paren
(brace
r_return
id|mptctl_readtest
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTEVENTQUERY
)paren
(brace
r_return
id|mptctl_eventquery
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTEVENTENABLE
)paren
(brace
r_return
id|mptctl_eventenable
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTEVENTREPORT
)paren
(brace
r_return
id|mptctl_eventreport
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTFWREPLACE
)paren
(brace
r_return
id|mptctl_replace_fw
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/* All of these commands require an interrupt or&n;&t; * are unknown/illegal.&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: mptctl_ioctl()&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MPTFWDOWNLOAD
suffix:colon
id|ret
op_assign
id|mptctl_fw_download
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTCOMMAND
suffix:colon
id|ret
op_assign
id|mptctl_mpt_command
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTHARDRESET
suffix:colon
id|ret
op_assign
id|mptctl_do_reset
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|iocp-&gt;id
)braket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|mptctl_do_reset
r_static
r_int
id|mptctl_do_reset
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_diag_reset
op_star
id|urinfo
op_assign
(paren
r_struct
id|mpt_ioctl_diag_reset
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_diag_reset
id|krinfo
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;mptctl_do_reset called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|krinfo
comma
id|urinfo
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_diag_reset
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_reset - &quot;
l_string|&quot;Unable to copy mpt_ioctl_diag_reset struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|urinfo
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mpt_verify_adapter
c_func
(paren
id|krinfo.hdr.iocnum
comma
op_amp
id|iocp
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_reset - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|krinfo.hdr.iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
)brace
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|iocp
comma
id|NO_SLEEP
)paren
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_reset - reset failed.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_open
r_static
r_int
id|mptctl_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/*&n;&t; * Should support multiple management users&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_release
r_static
r_int
id|mptctl_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * MPT FW download function.  Cast the arg into the mpt_fw_xfer structure.&n; * This structure contains: iocnum, firmware length (bytes),&n; *      pointer to user space memory where the fw image is stored.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENXIO  if no such device&n; *&t;&t;-EAGAIN if resource problem&n; *&t;&t;-ENOMEM if no memory for SGE&n; *&t;&t;-EMLINK if too many chain buffers required&n; *&t;&t;-EBADRQC if adapter does not support FW download&n; *&t;&t;-EBUSY if adapter is busy&n; *&t;&t;-ENOMSG if FW upload returned bad status&n; */
r_static
r_int
DECL|function|mptctl_fw_download
id|mptctl_fw_download
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_fw_xfer
op_star
id|ufwdl
op_assign
(paren
r_struct
id|mpt_fw_xfer
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_fw_xfer
id|kfwdl
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;mptctl_fwdl called. mptctl_id = %xh&bslash;n&quot;
comma
id|mptctl_id
)paren
)paren
suffix:semicolon
singleline_comment|//tc
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kfwdl
comma
id|ufwdl
comma
r_sizeof
(paren
r_struct
id|mpt_fw_xfer
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::_ioctl_fwdl - &quot;
l_string|&quot;Unable to copy mpt_fw_xfer struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|ufwdl
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|mptctl_do_fw_download
c_func
(paren
id|kfwdl.iocnum
comma
id|kfwdl.bufp
comma
id|kfwdl.fwlen
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * FW Download engine.&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENXIO  if no such device&n; *&t;&t;-EAGAIN if resource problem&n; *&t;&t;-ENOMEM if no memory for SGE&n; *&t;&t;-EMLINK if too many chain buffers required&n; *&t;&t;-EBADRQC if adapter does not support FW download&n; *&t;&t;-EBUSY if adapter is busy&n; *&t;&t;-ENOMSG if FW upload returned bad status&n; */
r_static
r_int
DECL|function|mptctl_do_fw_download
id|mptctl_do_fw_download
c_func
(paren
r_int
id|ioc
comma
r_char
op_star
id|ufwbuf
comma
r_int
id|fwlen
)paren
(brace
id|FWDownload_t
op_star
id|dlmsg
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
id|FWDownloadTCSGE_t
op_star
id|ptsge
suffix:semicolon
id|MptSge_t
op_star
id|sgl
comma
op_star
id|sgIn
suffix:semicolon
r_char
op_star
id|sgOut
suffix:semicolon
r_struct
id|buflist
op_star
id|buflist
suffix:semicolon
r_struct
id|buflist
op_star
id|bl
suffix:semicolon
id|dma_addr_t
id|sgl_dma
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|numfrags
op_assign
l_int|0
suffix:semicolon
r_int
id|maxfrags
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
id|u32
id|sgdir
suffix:semicolon
id|u32
id|nib
suffix:semicolon
r_int
id|fw_bytes_copied
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|cntdn
suffix:semicolon
r_int
id|sge_offset
op_assign
l_int|0
suffix:semicolon
id|u16
id|iocstat
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;mptctl_do_fwdl called. mptctl_id = %xh.&bslash;n&quot;
comma
id|mptctl_id
)paren
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.bufp  = %p&bslash;n&quot;
comma
id|ufwbuf
)paren
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.fwlen = %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|fwlen
)paren
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.ioc   = %04xh&bslash;n&quot;
comma
id|ioc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc
op_assign
id|mpt_verify_adapter
c_func
(paren
id|ioc
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s@%d::_ioctl_fwdl - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
)brace
multiline_comment|/*  Valid device. Get a message frame and construct the FW download message.&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|dlmsg
op_assign
(paren
id|FWDownload_t
op_star
)paren
id|mf
suffix:semicolon
id|ptsge
op_assign
(paren
id|FWDownloadTCSGE_t
op_star
)paren
op_amp
id|dlmsg-&gt;SGL
suffix:semicolon
id|sgOut
op_assign
(paren
r_char
op_star
)paren
(paren
id|ptsge
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Construct f/w download request&n;&t; */
id|dlmsg-&gt;ImageType
op_assign
id|MPI_FW_DOWNLOAD_ITYPE_FW
suffix:semicolon
id|dlmsg-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;Function
op_assign
id|MPI_FUNCTION_FW_DOWNLOAD
suffix:semicolon
id|dlmsg-&gt;Reserved1
(braket
l_int|0
)braket
op_assign
id|dlmsg-&gt;Reserved1
(braket
l_int|1
)braket
op_assign
id|dlmsg-&gt;Reserved1
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set up the Transaction SGE.&n;&t; */
id|ptsge-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|ptsge-&gt;ContextSize
op_assign
l_int|0
suffix:semicolon
id|ptsge-&gt;DetailsLength
op_assign
l_int|12
suffix:semicolon
id|ptsge-&gt;Flags
op_assign
id|MPI_SGE_FLAGS_TRANSACTION_ELEMENT
suffix:semicolon
id|ptsge-&gt;Reserved_0100_Checksum
op_assign
l_int|0
suffix:semicolon
id|ptsge-&gt;ImageOffset
op_assign
l_int|0
suffix:semicolon
id|ptsge-&gt;ImageSize
op_assign
id|cpu_to_le32
c_func
(paren
id|fwlen
)paren
suffix:semicolon
multiline_comment|/* Add the SGL&n;&t; */
multiline_comment|/*&n;&t; * Need to kmalloc area(s) for holding firmware image bytes.&n;&t; * But we need to do it piece meal, using a proper&n;&t; * scatter gather list (with 128kB MAX hunks).&n;&t; *&n;&t; * A practical limit here might be # of sg hunks that fit into&n;&t; * a single IOC request frame; 12 or 8 (see below), so:&n;&t; * For FC9xx: 12 x 128kB == 1.5 mB (max)&n;&t; * For C1030:  8 x 128kB == 1   mB (max)&n;&t; * We could support chaining, but things get ugly(ier:)&n;&t; *&n;&t; * Set the sge_offset to the start of the sgl (bytes).&n;&t; */
id|sgdir
op_assign
l_int|0x04000000
suffix:semicolon
multiline_comment|/* IOC will READ from sys mem */
id|sge_offset
op_assign
r_sizeof
(paren
id|MPIHeader_t
)paren
op_plus
r_sizeof
(paren
id|FWDownloadTCSGE_t
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sgl
op_assign
id|kbuf_alloc_2_sgl
c_func
(paren
id|fwlen
comma
id|sgdir
comma
id|sge_offset
comma
op_amp
id|numfrags
comma
op_amp
id|buflist
comma
op_amp
id|sgl_dma
comma
id|iocp
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * We should only need SGL with 2 simple_32bit entries (up to 256 kB)&n;&t; * for FC9xx f/w image, but calculate max number of sge hunks&n;&t; * we can fit into a request frame, and limit ourselves to that.&n;&t; * (currently no chain support)&n;&t; * maxfrags = (Request Size - FWdownload Size ) / Size of 32 bit SGE&n;&t; *&t;Request&t;&t;maxfrags&n;&t; *&t;128&t;&t;12&n;&t; *&t;96&t;&t;8&n;&t; *&t;64&t;&t;4&n;&t; */
id|maxfrags
op_assign
(paren
id|iocp-&gt;req_sz
op_minus
r_sizeof
(paren
id|MPIHeader_t
)paren
op_minus
r_sizeof
(paren
id|FWDownloadTCSGE_t
)paren
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|numfrags
OG
id|maxfrags
)paren
(brace
id|ret
op_assign
op_minus
id|EMLINK
suffix:semicolon
r_goto
id|fwdl_out
suffix:semicolon
)brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: sgl buffer  = %p, sgfrags = %d&bslash;n&quot;
comma
id|sgl
comma
id|numfrags
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Parse SG list, copying sgl itself,&n;&t; * plus f/w image hunks from user space as we go...&n;&t; */
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|sgIn
op_assign
id|sgl
suffix:semicolon
id|bl
op_assign
id|buflist
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numfrags
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Get the SGE type: 0 - TCSGE, 3 - Chain, 1 - Simple SGE&n;&t;&t; * Skip everything but Simple. If simple, copy from&n;&t;&t; *&t;user space into kernel space.&n;&t;&t; * Note: we should not have anything but Simple as&n;&t;&t; *&t;Chain SGE are illegal.&n;&t;&t; */
id|nib
op_assign
(paren
id|sgIn-&gt;FlagsLength
op_amp
l_int|0x30000000
)paren
op_rshift
l_int|28
suffix:semicolon
r_if
c_cond
(paren
id|nib
op_eq
l_int|0
op_logical_or
id|nib
op_eq
l_int|3
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sgIn-&gt;Address
)paren
(brace
id|mpt_add_sge
c_func
(paren
id|sgOut
comma
id|sgIn-&gt;FlagsLength
comma
id|sgIn-&gt;Address
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|bl-&gt;kptr
comma
id|ufwbuf
op_plus
id|fw_bytes_copied
comma
id|bl-&gt;len
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::_ioctl_fwdl - &quot;
l_string|&quot;Unable to copy f/w buffer hunk#%d @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|n
comma
(paren
r_void
op_star
)paren
id|ufwbuf
)paren
suffix:semicolon
r_goto
id|fwdl_out
suffix:semicolon
)brace
id|fw_bytes_copied
op_add_assign
id|bl-&gt;len
suffix:semicolon
)brace
id|sgIn
op_increment
suffix:semicolon
id|bl
op_increment
suffix:semicolon
id|sgOut
op_add_assign
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MPT_DEBUG
(brace
id|u32
op_star
id|m
op_assign
(paren
id|u32
op_star
)paren
id|mf
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: F/W download request:&bslash;n&quot;
id|KERN_INFO
l_string|&quot; &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
op_plus
id|numfrags
op_star
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|m
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Finally, perform firmware download.&n;&t; */
id|ReplyMsg
op_assign
l_int|NULL
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc
comma
id|mf
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Wait until the reply has been received&n;&t; */
r_for
c_loop
(paren
id|cntdn
op_assign
id|HZ
op_star
l_int|60
comma
id|i
op_assign
l_int|1
suffix:semicolon
id|ReplyMsg
op_eq
l_int|NULL
suffix:semicolon
id|cntdn
op_decrement
comma
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cntdn
)paren
(brace
id|ret
op_assign
op_minus
id|ETIME
suffix:semicolon
r_goto
id|fwdl_out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_mod
id|HZ
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG::_do_fwdl: &quot;
l_string|&quot;In ReplyMsg loop - iteration %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sgl
)paren
id|kfree_sgl
c_func
(paren
id|sgl
comma
id|sgl_dma
comma
id|buflist
comma
id|iocp
)paren
suffix:semicolon
id|iocstat
op_assign
id|le16_to_cpu
c_func
(paren
id|ReplyMsg-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_SUCCESS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: F/W update successfully sent to %s!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_INVALID_FUNCTION
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: ?Hmmm...  %s says it doesn&squot;t support F/W download!?!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (time to go bang on somebodies door)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADRQC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_BUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Warning!  %s says: IOC_BUSY!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (try again later?)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;::ioctl_fwdl() ERROR!  %s returned [bad] status = %04xh&bslash;n&quot;
comma
id|iocp-&gt;name
comma
id|iocstat
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (bad VooDoo)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMSG
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|fwdl_out
suffix:colon
id|kfree_sgl
c_func
(paren
id|sgl
comma
id|sgl_dma
comma
id|buflist
comma
id|iocp
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * SGE Allocation routine&n; *&n; * Inputs:&t;bytes - number of bytes to be transferred&n; *&t;&t;sgdir - data direction&n; *&t;&t;sge_offset - offset (in bytes) from the start of the request&n; *&t;&t;&t;frame to the first SGE&n; *&t;&t;ioc - pointer to the mptadapter&n; * Outputs:&t;frags - number of scatter gather elements&n; *&t;&t;blp - point to the buflist pointer&n; *&t;&t;sglbuf_dma - pointer to the (dma) sgl&n; * Returns:&t;Null if failes&n; *&t;&t;pointer to the (virtual) sgl if successful.&n; */
r_static
id|MptSge_t
op_star
DECL|function|kbuf_alloc_2_sgl
id|kbuf_alloc_2_sgl
c_func
(paren
r_int
id|bytes
comma
id|u32
id|sgdir
comma
r_int
id|sge_offset
comma
r_int
op_star
id|frags
comma
r_struct
id|buflist
op_star
op_star
id|blp
comma
id|dma_addr_t
op_star
id|sglbuf_dma
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MptSge_t
op_star
id|sglbuf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to array of SGE */
multiline_comment|/* and chain buffers */
r_struct
id|buflist
op_star
id|buflist
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* kernel routine */
id|MptSge_t
op_star
id|sgl
suffix:semicolon
r_int
id|numfrags
op_assign
l_int|0
suffix:semicolon
r_int
id|fragcnt
op_assign
l_int|0
suffix:semicolon
r_int
id|alloc_sz
op_assign
id|MIN
c_func
(paren
id|bytes
comma
id|MAX_KMALLOC_SZ
)paren
suffix:semicolon
singleline_comment|// avoid kernel warning msg!
r_int
id|bytes_allocd
op_assign
l_int|0
suffix:semicolon
r_int
id|this_alloc
suffix:semicolon
id|dma_addr_t
id|pa
suffix:semicolon
singleline_comment|// phys addr
r_int
id|i
comma
id|buflist_ent
suffix:semicolon
r_int
id|sg_spill
op_assign
id|MAX_FRAGS_SPILL1
suffix:semicolon
r_int
id|dir
suffix:semicolon
multiline_comment|/* initialization */
op_star
id|frags
op_assign
l_int|0
suffix:semicolon
op_star
id|blp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Allocate and initialize an array of kernel&n;&t; * structures for the SG elements.&n;&t; */
id|i
op_assign
id|MAX_SGL_BYTES
op_div
l_int|8
suffix:semicolon
id|buflist
op_assign
id|kmalloc
c_func
(paren
id|i
comma
id|GFP_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflist
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|buflist
comma
l_int|0
comma
id|i
)paren
suffix:semicolon
id|buflist_ent
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allocate a single block of memory to store the sg elements and&n;&t; * the chain buffers.  The calling routine is responsible for&n;&t; * copying the data in this array into the correct place in the&n;&t; * request and chain buffers.&n;&t; */
id|sglbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sglbuf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sglbuf
op_eq
l_int|NULL
)paren
r_goto
id|free_and_fail
suffix:semicolon
r_if
c_cond
(paren
id|sgdir
op_amp
l_int|0x04000000
)paren
id|dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_else
id|dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
multiline_comment|/* At start:&n;&t; *&t;sgl = sglbuf = point to beginning of sg buffer&n;&t; *&t;buflist_ent = 0 = first kernel structure&n;&t; *&t;sg_spill = number of SGE that can be written before the first&n;&t; *&t;&t;chain element.&n;&t; *&n;&t; */
id|sgl
op_assign
id|sglbuf
suffix:semicolon
id|sg_spill
op_assign
(paren
(paren
id|ioc-&gt;req_sz
op_minus
id|sge_offset
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
)paren
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|bytes_allocd
OL
id|bytes
)paren
(brace
id|this_alloc
op_assign
id|MIN
c_func
(paren
id|alloc_sz
comma
id|bytes
op_minus
id|bytes_allocd
)paren
suffix:semicolon
id|buflist
(braket
id|buflist_ent
)braket
dot
id|len
op_assign
id|this_alloc
suffix:semicolon
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|this_alloc
comma
op_amp
id|pa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
op_eq
l_int|NULL
)paren
(brace
id|alloc_sz
op_assign
id|alloc_sz
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|alloc_sz
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: No can do - &quot;
l_string|&quot;not enough memory!   :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: (freeing %d frags)&bslash;n&quot;
comma
id|numfrags
)paren
suffix:semicolon
r_goto
id|free_and_fail
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_else
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|bytes_allocd
op_add_assign
id|this_alloc
suffix:semicolon
id|sgl-&gt;FlagsLength
op_assign
(paren
l_int|0x10000000
op_or
id|MPT_SGE_FLAGS_ADDRESSING
op_or
id|sgdir
op_or
id|this_alloc
)paren
suffix:semicolon
id|dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
comma
id|this_alloc
comma
id|dir
)paren
suffix:semicolon
id|sgl-&gt;Address
op_assign
id|dma_addr
suffix:semicolon
id|fragcnt
op_increment
suffix:semicolon
id|numfrags
op_increment
suffix:semicolon
id|sgl
op_increment
suffix:semicolon
id|buflist_ent
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bytes_allocd
op_ge
id|bytes
)paren
r_break
suffix:semicolon
multiline_comment|/* Need to chain? */
r_if
c_cond
(paren
id|fragcnt
op_eq
id|sg_spill
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: No can do - &quot;
l_string|&quot;Chain required!   :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;(freeing %d frags)&bslash;n&quot;
comma
id|numfrags
)paren
suffix:semicolon
r_goto
id|free_and_fail
suffix:semicolon
)brace
multiline_comment|/* overflow check... */
r_if
c_cond
(paren
id|numfrags
op_star
l_int|8
OG
id|MAX_SGL_BYTES
)paren
(brace
multiline_comment|/* GRRRRR... */
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: No can do - &quot;
l_string|&quot;too many SG frags!   :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: (freeing %d frags)&bslash;n&quot;
comma
id|numfrags
)paren
suffix:semicolon
r_goto
id|free_and_fail
suffix:semicolon
)brace
)brace
multiline_comment|/* Last sge fixup: set LE+eol+eob bits */
id|sgl
(braket
op_minus
l_int|1
)braket
dot
id|FlagsLength
op_or_assign
l_int|0xC1000000
suffix:semicolon
op_star
id|frags
op_assign
id|numfrags
suffix:semicolon
op_star
id|blp
op_assign
id|buflist
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: kbuf_alloc_2_sgl() - &quot;
l_string|&quot;%d SG frags generated!&bslash;n&quot;
comma
id|numfrags
)paren
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: kbuf_alloc_2_sgl() - &quot;
l_string|&quot;last (big) alloc_sz=%d&bslash;n&quot;
comma
id|alloc_sz
)paren
)paren
suffix:semicolon
r_return
id|sglbuf
suffix:semicolon
id|free_and_fail
suffix:colon
r_if
c_cond
(paren
id|sglbuf
op_ne
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numfrags
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|u8
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sglbuf
(braket
id|i
)braket
dot
id|FlagsLength
op_rshift
l_int|24
)paren
op_eq
l_int|0x30
)paren
r_continue
suffix:semicolon
id|dma_addr
op_assign
id|sglbuf
(braket
id|i
)braket
dot
id|Address
suffix:semicolon
id|kptr
op_assign
id|buflist
(braket
id|i
)braket
dot
id|kptr
suffix:semicolon
id|len
op_assign
id|buflist
(braket
id|i
)braket
dot
id|len
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sglbuf
comma
op_star
id|sglbuf_dma
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buflist
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Routine to free the SGL elements.&n; */
r_static
r_void
DECL|function|kfree_sgl
id|kfree_sgl
c_func
(paren
id|MptSge_t
op_star
id|sgl
comma
id|dma_addr_t
id|sgl_dma
comma
r_struct
id|buflist
op_star
id|buflist
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MptSge_t
op_star
id|sg
op_assign
id|sgl
suffix:semicolon
r_struct
id|buflist
op_star
id|bl
op_assign
id|buflist
suffix:semicolon
id|u32
id|nib
suffix:semicolon
r_int
id|dir
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sg-&gt;FlagsLength
op_amp
l_int|0x04000000
)paren
id|dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_else
id|dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
id|nib
op_assign
(paren
id|sg-&gt;FlagsLength
op_amp
l_int|0xF0000000
)paren
op_rshift
l_int|28
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|nib
op_amp
l_int|0x4
)paren
)paren
(brace
multiline_comment|/* eob */
multiline_comment|/* skip ignore/chain. */
r_if
c_cond
(paren
id|nib
op_eq
l_int|0
op_logical_or
id|nib
op_eq
l_int|3
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sg-&gt;Address
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_void
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
id|dma_addr
op_assign
id|sg-&gt;Address
suffix:semicolon
id|kptr
op_assign
id|bl-&gt;kptr
suffix:semicolon
id|len
op_assign
id|bl-&gt;len
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dma_addr
comma
id|len
comma
id|dir
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
id|sg
op_increment
suffix:semicolon
id|bl
op_increment
suffix:semicolon
id|nib
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|sg-&gt;FlagsLength
)paren
op_amp
l_int|0xF0000000
)paren
op_rshift
l_int|28
suffix:semicolon
)brace
multiline_comment|/* we&squot;re at eob! */
r_if
c_cond
(paren
id|sg-&gt;Address
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_void
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
id|dma_addr
op_assign
id|sg-&gt;Address
suffix:semicolon
id|kptr
op_assign
id|bl-&gt;kptr
suffix:semicolon
id|len
op_assign
id|bl-&gt;len
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dma_addr
comma
id|len
comma
id|dir
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sgl
comma
id|sgl_dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buflist
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: Free&squot;d 1 SGL buf + %d kbufs!&bslash;n&quot;
comma
id|n
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptctl_getiocinfo - Query the host adapter for IOC information.&n; *&t;@arg: User space argument&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV  if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_getiocinfo
id|mptctl_getiocinfo
(paren
r_int
r_int
id|arg
comma
r_int
r_int
id|data_size
)paren
(brace
r_struct
id|mpt_ioctl_iocinfo
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_iocinfo
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_iocinfo
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|numDevices
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|max_id
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|port
suffix:semicolon
r_int
id|cim_rev
suffix:semicolon
id|u8
id|revision
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_getiocinfo called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_size
op_eq
r_sizeof
(paren
r_struct
id|mpt_ioctl_iocinfo
)paren
)paren
id|cim_rev
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|data_size
op_eq
(paren
r_sizeof
(paren
r_struct
id|mpt_ioctl_iocinfo
)paren
op_minus
r_sizeof
(paren
r_struct
id|mpt_ioctl_pci_info
)paren
)paren
)paren
id|cim_rev
op_assign
l_int|0
suffix:semicolon
r_else
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
id|data_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_getiocinfo - &quot;
l_string|&quot;Unable to read in mpt_ioctl_iocinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_getiocinfo() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Verify the data transfer size is correct.&n;&t; * Ignore the port setting.&n;&t; */
r_if
c_cond
(paren
id|karg.hdr.maxDataSize
op_ne
id|data_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_getiocinfo - &quot;
l_string|&quot;Structure size mismatch. Command not completed.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Fill in the data and return the structure to the calling&n;&t; * program&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;chip_type
op_eq
id|C1030
)paren
id|karg.adapterType
op_assign
id|MPT_IOCTL_INTERFACE_SCSI
suffix:semicolon
r_else
id|karg.adapterType
op_assign
id|MPT_IOCTL_INTERFACE_FC
suffix:semicolon
id|port
op_assign
id|karg.hdr.port
suffix:semicolon
id|karg.port
op_assign
id|port
suffix:semicolon
id|pdev
op_assign
(paren
r_struct
id|pci_dev
op_star
)paren
id|ioc-&gt;pcidev
suffix:semicolon
id|karg.pciId
op_assign
id|pdev-&gt;device
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|revision
)paren
suffix:semicolon
id|karg.hwRev
op_assign
id|revision
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|karg.subSystemDevice
op_assign
id|pdev-&gt;subsystem_device
suffix:semicolon
id|karg.subSystemVendor
op_assign
id|pdev-&gt;subsystem_vendor
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|cim_rev
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Get the PCI bus, device, and function numbers for the IOC&n;&t;&t; */
id|karg.pciInfo.u.bits.busNumber
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|karg.pciInfo.u.bits.deviceNumber
op_assign
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|karg.pciInfo.u.bits.functionNumber
op_assign
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
)brace
multiline_comment|/* Get number of devices&n;         */
r_if
c_cond
(paren
(paren
id|sh
op_assign
id|ioc-&gt;sh
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* sh-&gt;max_id = maximum target ID + 1&n;&t;&t; */
id|max_id
op_assign
id|sh-&gt;max_id
op_minus
l_int|1
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
multiline_comment|/* Check all of the target structures and&n;&t;&t; * keep a counter.&n;&t;&t; */
r_if
c_cond
(paren
id|hd
op_logical_and
id|hd-&gt;Targets
)paren
(brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
op_le
id|max_id
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;Targets
(braket
id|ii
)braket
)paren
id|numDevices
op_increment
suffix:semicolon
)brace
)brace
)brace
id|karg.numDevices
op_assign
id|numDevices
suffix:semicolon
multiline_comment|/* Set the BIOS and FW Version&n;&t; */
id|karg.FWVersion
op_assign
id|ioc-&gt;facts.FWVersion.Word
suffix:semicolon
id|karg.BIOSVersion
op_assign
id|ioc-&gt;biosVersion
suffix:semicolon
multiline_comment|/* Set the Version Strings.&n;&t; */
id|strncpy
(paren
id|karg.driverVersion
comma
id|MPT_LINUX_PACKAGE_NAME
comma
id|MPT_IOCTL_VERSION_LENGTH
)paren
suffix:semicolon
id|karg.busChangeEvent
op_assign
l_int|0
suffix:semicolon
id|karg.hostId
op_assign
id|ioc-&gt;pfacts
(braket
id|port
)braket
dot
id|PortSCSIID
suffix:semicolon
id|karg.rsvd
(braket
l_int|0
)braket
op_assign
id|karg.rsvd
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
id|data_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_getiocinfo - &quot;
l_string|&quot;Unable to write out mpt_ioctl_iocinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptctl_gettargetinfo - Query the host adapter for target information.&n; *&t;@arg: User space argument&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV  if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_gettargetinfo
id|mptctl_gettargetinfo
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_targetinfo
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_targetinfo
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_targetinfo
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_char
op_star
id|pmem
suffix:semicolon
r_int
op_star
id|pdata
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|numDevices
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|max_id
suffix:semicolon
r_int
id|ii
comma
id|jj
comma
id|lun
suffix:semicolon
r_int
id|maxWordsLeft
suffix:semicolon
r_int
id|numBytes
suffix:semicolon
id|u8
id|port
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_gettargetinfo called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_targetinfo
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_gettargetinfo - &quot;
l_string|&quot;Unable to read in mpt_ioctl_targetinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_gettargetinfo() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Get the port number and set the maximum number of bytes&n;&t; * in the returned structure.&n;&t; * Ignore the port setting.&n;&t; */
id|numBytes
op_assign
id|karg.hdr.maxDataSize
op_minus
r_sizeof
(paren
id|mpt_ioctl_header
)paren
suffix:semicolon
id|maxWordsLeft
op_assign
id|numBytes
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|port
op_assign
id|karg.hdr.port
suffix:semicolon
r_if
c_cond
(paren
id|maxWordsLeft
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_gettargetinfo() @%d - no memory available!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Fill in the data and return the structure to the calling&n;&t; * program&n;&t; */
multiline_comment|/* struct mpt_ioctl_targetinfo does not contain sufficient space&n;&t; * for the target structures so when the IOCTL is called, there is&n;&t; * not sufficient stack space for the structure. Allocate memory,&n;&t; * populate the memory, copy back to the user, then free memory.&n;&t; * targetInfo format:&n;&t; * bits 31-24: reserved&n;&t; *      23-16: LUN&n;&t; *      15- 8: Bus Number&n;&t; *       7- 0: Target ID&n;&t; */
id|pmem
op_assign
id|kmalloc
c_func
(paren
id|numBytes
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmem
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_gettargetinfo() @%d - no memory available!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pmem
comma
l_int|0
comma
id|numBytes
)paren
suffix:semicolon
id|pdata
op_assign
(paren
r_int
op_star
)paren
id|pmem
suffix:semicolon
multiline_comment|/* Get number of devices&n;         */
r_if
c_cond
(paren
(paren
id|sh
op_assign
id|ioc-&gt;sh
)paren
op_ne
l_int|NULL
)paren
(brace
id|max_id
op_assign
id|sh-&gt;max_id
op_minus
l_int|1
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
multiline_comment|/* Check all of the target structures.&n;&t;&t; * Save the Id and increment the counter,&n;&t;&t; * if ptr non-null.&n;&t;&t; * sh-&gt;max_id = maximum target ID + 1&n;&t;&t; */
r_if
c_cond
(paren
id|hd
op_logical_and
id|hd-&gt;Targets
)paren
(brace
id|ii
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ii
op_le
id|max_id
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;Targets
(braket
id|ii
)braket
)paren
(brace
r_for
c_loop
(paren
id|jj
op_assign
l_int|0
suffix:semicolon
id|jj
op_le
id|MPT_LAST_LUN
suffix:semicolon
id|jj
op_increment
)paren
(brace
id|lun
op_assign
(paren
l_int|1
op_lshift
id|jj
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;Targets
(braket
id|ii
)braket
op_member_access_from_pointer
id|luns
op_amp
id|lun
)paren
(brace
id|numDevices
op_increment
suffix:semicolon
op_star
id|pdata
op_assign
(paren
id|jj
op_lshift
l_int|16
)paren
op_or
id|ii
suffix:semicolon
op_decrement
id|maxWordsLeft
suffix:semicolon
id|pdata
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|maxWordsLeft
op_le
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
id|ii
op_increment
suffix:semicolon
)brace
)brace
)brace
id|karg.numDevices
op_assign
id|numDevices
suffix:semicolon
multiline_comment|/* Copy part of the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_targetinfo
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_gettargetinfo - &quot;
l_string|&quot;Unable to write out mpt_ioctl_targetinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pmem
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Copy the remaining data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|uarg-&gt;targetInfo
comma
id|pmem
comma
id|numBytes
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_gettargetinfo - &quot;
l_string|&quot;Unable to write out mpt_ioctl_targetinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|pdata
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pmem
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|pmem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* MPT IOCTL Test function.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV  if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_readtest
id|mptctl_readtest
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_test
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_test
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_test
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_readtest called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_test
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_readtest - &quot;
l_string|&quot;Unable to read in mpt_ioctl_test struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_readtest() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Fill in the data and return the structure to the calling&n;&t; * program&n;&t; */
macro_line|#ifdef MFCNT
id|karg.chip_type
op_assign
id|ioc-&gt;mfcnt
suffix:semicolon
macro_line|#else
id|karg.chip_type
op_assign
id|ioc-&gt;chip_type
suffix:semicolon
macro_line|#endif
id|strncpy
(paren
id|karg.name
comma
id|ioc-&gt;name
comma
id|MPT_MAX_NAME
)paren
suffix:semicolon
id|strncpy
(paren
id|karg.product
comma
id|ioc-&gt;prod_name
comma
id|MPT_PRODUCT_LENGTH
)paren
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_test
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_readtest - &quot;
l_string|&quot;Unable to write out mpt_ioctl_test struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptctl_eventquery - Query the host adapter for the event types&n; *&t;that are being logged.&n; *&t;@arg: User space argument&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV  if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_eventquery
id|mptctl_eventquery
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_eventquery
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_eventquery
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_eventquery
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_eventquery called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_eventquery
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventquery - &quot;
l_string|&quot;Unable to read in mpt_ioctl_eventquery struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_eventquery() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|karg.eventEntries
op_assign
id|ioc-&gt;eventLogSize
suffix:semicolon
id|karg.eventTypes
op_assign
id|ioc-&gt;eventTypes
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_eventquery
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventquery - &quot;
l_string|&quot;Unable to write out mpt_ioctl_eventquery struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptctl_eventenable
id|mptctl_eventenable
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_eventenable
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_eventenable
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_eventenable
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_eventenable called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_eventenable
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventenable - &quot;
l_string|&quot;Unable to read in mpt_ioctl_eventenable struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_eventenable() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;events
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Have not yet allocated memory - do so now.&n;&t;&t; */
r_int
id|sz
op_assign
id|MPTCTL_EVENT_LOG_SIZE
op_star
r_sizeof
(paren
id|MPT_IOCTL_EVENTS
)paren
suffix:semicolon
id|ioc-&gt;events
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;events
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Insufficient memory to add adapter!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ioc-&gt;events
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|ioc-&gt;alloc_total
op_add_assign
id|sz
suffix:semicolon
id|ioc-&gt;eventLogSize
op_assign
id|MPTCTL_EVENT_LOG_SIZE
suffix:semicolon
id|ioc-&gt;eventContext
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Update the IOC event logging flag.&n;&t; */
id|ioc-&gt;eventTypes
op_assign
id|karg.eventTypes
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptctl_eventreport
id|mptctl_eventreport
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_eventreport
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_eventreport
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_eventreport
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|numBytes
comma
id|maxEvents
comma
id|max
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_eventreport called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_eventreport
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventreport - &quot;
l_string|&quot;Unable to read in mpt_ioctl_eventreport struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_eventreport() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|numBytes
op_assign
id|karg.hdr.maxDataSize
op_minus
r_sizeof
(paren
id|mpt_ioctl_header
)paren
suffix:semicolon
id|maxEvents
op_assign
id|numBytes
op_div
r_sizeof
(paren
id|MPT_IOCTL_EVENTS
)paren
suffix:semicolon
id|max
op_assign
id|ioc-&gt;eventLogSize
OL
id|maxEvents
ques
c_cond
id|ioc-&gt;eventLogSize
suffix:colon
id|maxEvents
suffix:semicolon
multiline_comment|/* If fewer than 1 event is requested, there must have&n;&t; * been some type of error.&n;&t; */
r_if
c_cond
(paren
(paren
id|max
OL
l_int|1
)paren
op_logical_or
op_logical_neg
id|ioc-&gt;events
)paren
r_return
op_minus
id|ENODATA
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
id|numBytes
op_assign
id|max
op_star
r_sizeof
(paren
id|MPT_IOCTL_EVENTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|uarg-&gt;eventData
comma
id|ioc-&gt;events
comma
id|numBytes
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventreport - &quot;
l_string|&quot;Unable to write out mpt_ioctl_eventreport struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;events
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptctl_replace_fw
id|mptctl_replace_fw
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_replace_fw
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_replace_fw
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_replace_fw
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|fw_image_t
op_star
op_star
id|fwmem
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|newFwSize
suffix:semicolon
r_int
id|num_frags
comma
id|alloc_sz
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|u32
id|offset
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_replace_fw called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_replace_fw
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_replace_fw - &quot;
l_string|&quot;Unable to read in mpt_ioctl_replace_fw struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_replace_fw() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* If not caching FW, return 0&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc-&gt;cached_fw
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|ioc-&gt;alt_ioc
)paren
op_logical_and
(paren
id|ioc-&gt;alt_ioc-&gt;cached_fw
op_eq
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Allocate memory for the new FW image&n;&t; */
id|newFwSize
op_assign
id|karg.newImageSize
suffix:semicolon
id|fwmem
op_assign
id|mpt_alloc_fw_memory
c_func
(paren
id|ioc
comma
id|newFwSize
comma
op_amp
id|num_frags
comma
op_amp
id|alloc_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fwmem
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|num_frags
suffix:semicolon
id|ii
op_increment
)paren
(brace
multiline_comment|/* Copy the data from user memory to kernel space&n;&t;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|fwmem
(braket
id|ii
)braket
op_member_access_from_pointer
id|fw
comma
id|uarg-&gt;newImage
op_plus
id|offset
comma
id|fwmem
(braket
id|ii
)braket
op_member_access_from_pointer
id|size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_replace_fw - &quot;
l_string|&quot;Unable to read in mpt_ioctl_replace_fw image @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
id|mpt_free_fw_memory
c_func
(paren
id|ioc
comma
id|fwmem
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|offset
op_add_assign
id|fwmem
(braket
id|ii
)braket
op_member_access_from_pointer
id|size
suffix:semicolon
)brace
multiline_comment|/* Free the old FW image &n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
)paren
(brace
id|mpt_free_fw_memory
c_func
(paren
id|ioc
comma
l_int|0
)paren
suffix:semicolon
id|ioc-&gt;cached_fw
op_assign
id|fwmem
suffix:semicolon
id|ioc-&gt;alloc_total
op_add_assign
id|alloc_sz
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ioc-&gt;alt_ioc
)paren
op_logical_and
(paren
id|ioc-&gt;alt_ioc-&gt;cached_fw
)paren
)paren
(brace
id|mpt_free_fw_memory
c_func
(paren
id|ioc-&gt;alt_ioc
comma
l_int|0
)paren
suffix:semicolon
id|ioc-&gt;alt_ioc-&gt;cached_fw
op_assign
id|fwmem
suffix:semicolon
id|ioc-&gt;alt_ioc-&gt;alloc_total
op_add_assign
id|alloc_sz
suffix:semicolon
)brace
multiline_comment|/* Update IOCFactsReply&n;&t; */
id|ioc-&gt;facts.FWImageSize
op_assign
id|newFwSize
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;alt_ioc
)paren
id|ioc-&gt;alt_ioc-&gt;facts.FWImageSize
op_assign
id|newFwSize
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* MPT IOCTL MPTCOMMAND function.&n; * Cast the arg into the mpt_ioctl_mpt_command structure.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; *&t;&t;-ENOMEM if memory allocation error&n; */
r_static
r_int
DECL|function|mptctl_mpt_command
id|mptctl_mpt_command
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_command
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_command
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_command
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_command called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_command
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_mpt_command - &quot;
l_string|&quot;Unable to read in mpt_ioctl_command struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_mpt_command() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|mptctl_do_mpt_command
(paren
id|karg
comma
(paren
r_char
op_star
)paren
op_amp
id|uarg-&gt;MF
comma
l_int|0
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Worker routine for the IOCTL MPTCOMMAND and MPTCOMMAND32 (sparc) commands.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; *&t;&t;-ENOMEM if memory allocation error&n; *&t;&t;-EPERM if SCSI I/O and target is untagged&n; */
r_static
r_int
DECL|function|mptctl_do_mpt_command
id|mptctl_do_mpt_command
(paren
r_struct
id|mpt_ioctl_command
id|karg
comma
r_char
op_star
id|mfPtr
comma
r_int
id|local
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|MPIHeader_t
op_star
id|hdr
suffix:semicolon
r_char
op_star
id|psge
suffix:semicolon
id|MptSge_t
op_star
id|this_sge
op_assign
l_int|NULL
suffix:semicolon
id|MptSge_t
op_star
id|sglbuf
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|buflist
id|bufIn
suffix:semicolon
multiline_comment|/* data In buffer */
r_struct
id|buflist
id|bufOut
suffix:semicolon
multiline_comment|/* data Out buffer */
id|dma_addr_t
id|sglbuf_dma
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_int
id|dir
suffix:semicolon
multiline_comment|/* PCI data direction */
r_int
id|sgSize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Num SG elements */
r_int
id|this_alloc
suffix:semicolon
r_int
id|iocnum
comma
id|flagsLength
suffix:semicolon
r_int
id|sz
comma
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|msgContext
suffix:semicolon
r_int
id|tm_flags_set
op_assign
l_int|0
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_do_mpt_command called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_do_mpt_command() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;ioctl
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;No memory available during driver init.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_DID_IOCRESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Busy with IOC Reset &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Verify that the final request frame will not be too large.&n;&t; */
id|sz
op_assign
id|karg.dataSgeOffset
op_star
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataInSize
OG
l_int|0
)paren
id|sz
op_add_assign
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
id|sz
op_add_assign
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sz
OG
id|ioc-&gt;req_sz
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Request frame too large (%d) maximum (%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|sz
comma
id|ioc-&gt;req_sz
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Get a free request frame and save the message context.&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|hdr
op_assign
(paren
id|MPIHeader_t
op_star
)paren
id|mf
suffix:semicolon
id|msgContext
op_assign
id|le32_to_cpu
c_func
(paren
id|hdr-&gt;MsgContext
)paren
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
multiline_comment|/* Copy the request frame&n;&t; * Reset the saved message context.&n;&t; */
r_if
c_cond
(paren
id|local
)paren
(brace
multiline_comment|/* Request frame in kernel space&n;&t;&t; */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|mf
comma
(paren
r_char
op_star
)paren
id|mfPtr
comma
id|karg.dataSgeOffset
op_star
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Request frame in user space&n;&t;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
id|mf
comma
(paren
r_char
op_star
)paren
id|mfPtr
comma
id|karg.dataSgeOffset
op_star
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Unable to read MF from mpt_ioctl_command struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|mfPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
id|hdr-&gt;MsgContext
op_assign
id|cpu_to_le32
c_func
(paren
id|msgContext
)paren
suffix:semicolon
multiline_comment|/* Verify that this request is allowed.&n;&t; */
r_switch
c_cond
(paren
id|hdr-&gt;Function
)paren
(brace
r_case
id|MPI_FUNCTION_IOC_FACTS
suffix:colon
r_case
id|MPI_FUNCTION_PORT_FACTS
suffix:colon
r_case
id|MPI_FUNCTION_CONFIG
suffix:colon
r_case
id|MPI_FUNCTION_FC_COMMON_TRANSPORT_SEND
suffix:colon
r_case
id|MPI_FUNCTION_FC_EX_LINK_SRVC_SEND
suffix:colon
r_case
id|MPI_FUNCTION_FW_UPLOAD
suffix:colon
r_case
id|MPI_FUNCTION_SCSI_ENCLOSURE_PROCESSOR
suffix:colon
r_case
id|MPI_FUNCTION_FW_DOWNLOAD
suffix:colon
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_SCSI_IO_REQUEST
suffix:colon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|SCSIIORequest_t
op_star
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
op_assign
l_int|NULL
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_int
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_UNTAGGED
suffix:semicolon
r_int
id|scsidir
op_assign
l_int|0
suffix:semicolon
r_int
id|target
op_assign
(paren
r_int
)paren
id|pScsiReq-&gt;TargetID
suffix:semicolon
r_int
id|dataSize
suffix:semicolon
id|pScsiReq-&gt;MsgFlags
op_assign
id|mpt_msg_flags
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* verify that app has not requested&n;&t;&t;&t; *&t;more sense data than driver&n;&t;&t;&t; *&t;can provide, if so, reset this parameter&n;&t;&t;&t; * set the sense buffer pointer low address&n;&t;&t;&t; * update the control field to specify Q type&n;&t;&t;&t; */
r_if
c_cond
(paren
id|karg.maxSenseBytes
OG
id|MPT_SENSE_BUFFER_SIZE
)paren
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|MPT_SENSE_BUFFER_SIZE
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|ioc-&gt;sense_buf_low_dma
op_plus
(paren
id|req_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
)paren
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;Targets
)paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|target
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
)paren
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_SIMPLEQ
suffix:semicolon
r_else
(brace
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
multiline_comment|/* Have the IOCTL driver set the direction based&n;&t;&t;&t; * on the dataOutSize (ordering issue with Sparc).&n;&t;&t;&t; */
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
id|dataSize
op_assign
id|karg.dataOutSize
suffix:semicolon
)brace
r_else
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|dataSize
op_assign
id|karg.dataInSize
suffix:semicolon
)brace
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|scsidir
op_or
id|qtag
)paren
suffix:semicolon
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|dataSize
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;reset
op_assign
id|MPTCTL_RESET_OK
suffix:semicolon
id|ioc-&gt;ioctl-&gt;target
op_assign
id|target
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;SCSI driver is not loaded. &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_RAID_ACTION
suffix:colon
multiline_comment|/* Just add a SGE&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH
suffix:colon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|SCSIIORequest_t
op_star
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
r_int
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_SIMPLEQ
suffix:semicolon
r_int
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
r_int
id|dataSize
suffix:semicolon
id|pScsiReq-&gt;MsgFlags
op_assign
id|mpt_msg_flags
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* verify that app has not requested&n;&t;&t;&t; *&t;more sense data than driver&n;&t;&t;&t; *&t;can provide, if so, reset this parameter&n;&t;&t;&t; * set the sense buffer pointer low address&n;&t;&t;&t; * update the control field to specify Q type&n;&t;&t;&t; */
r_if
c_cond
(paren
id|karg.maxSenseBytes
OG
id|MPT_SENSE_BUFFER_SIZE
)paren
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|MPT_SENSE_BUFFER_SIZE
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|ioc-&gt;sense_buf_low_dma
op_plus
(paren
id|req_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
multiline_comment|/* All commands to physical devices are tagged&n;&t;&t;&t; */
multiline_comment|/* Have the IOCTL driver set the direction based&n;&t;&t;&t; * on the dataOutSize (ordering issue with Sparc).&n;&t;&t;&t; */
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
id|dataSize
op_assign
id|karg.dataOutSize
suffix:semicolon
)brace
r_else
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|dataSize
op_assign
id|karg.dataInSize
suffix:semicolon
)brace
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|scsidir
op_or
id|qtag
)paren
suffix:semicolon
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|dataSize
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;reset
op_assign
id|MPTCTL_RESET_OK
suffix:semicolon
id|ioc-&gt;ioctl-&gt;target
op_assign
id|pScsiReq-&gt;TargetID
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;SCSI driver is not loaded. &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:colon
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;sh
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;SCSI driver not loaded or SCSI host not found. &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mptctl_set_tm_flags
c_func
(paren
id|hd
)paren
op_ne
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
id|tm_flags_set
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t;&t; * MPI_FUNCTION_IOC_INIT&n;&t;&t; * MPI_FUNCTION_PORT_ENABLE&n;&t;&t; * MPI_FUNCTION_TARGET_CMD_BUFFER_POST&n;&t;&t; * MPI_FUNCTION_TARGET_ASSIST&n;&t;&t; * MPI_FUNCTION_TARGET_STATUS_SEND&n;&t;&t; * MPI_FUNCTION_TARGET_MODE_ABORT&n;&t;&t; * MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET&n;&t;&t; * MPI_FUNCTION_IO_UNIT_RESET&n;&t;&t; * MPI_FUNCTION_HANDSHAKE&n;&t;&t; * MPI_FUNCTION_REPLY_FRAME_REMOVAL&n;&t;&t; * MPI_FUNCTION_EVENT_NOTIFICATION&n;&t;&t; *  (driver handles event notification)&n;&t;&t; * MPI_FUNCTION_EVENT_ACK&n;&t;&t; */
multiline_comment|/*  What to do with these???  CHECK ME!!!&n;&t;&t;&t;MPI_FUNCTION_FC_LINK_SRVC_BUF_POST&n;&t;&t;&t;MPI_FUNCTION_FC_LINK_SRVC_RSP&n;&t;&t;&t;MPI_FUNCTION_FC_ABORT&n;&t;&t;&t;MPI_FUNCTION_FC_PRIMITIVE_SEND&n;&t;&t;&t;MPI_FUNCTION_LAN_SEND&n;&t;&t;&t;MPI_FUNCTION_LAN_RECEIVE&n;&t;&t; &t;MPI_FUNCTION_LAN_RESET&n;&t;&t;*/
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Illegal request (function 0x%x) &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|hdr-&gt;Function
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
multiline_comment|/* Add the SGL ( at most one data in SGE and one data out SGE )&n;&t; * In the case of two SGE&squot;s - the data out (write) will always&n;&t; * preceede the data in (read) SGE. psgList is used to free the&n;&t; * allocated memory.&n;&t; */
id|psge
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
(paren
r_int
op_star
)paren
id|mf
)paren
op_plus
id|karg.dataSgeOffset
)paren
suffix:semicolon
id|flagsLength
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* bufIn and bufOut are used for user to kernel space transfers&n;&t; */
id|bufIn.kptr
op_assign
id|bufOut.kptr
op_assign
l_int|NULL
suffix:semicolon
id|bufIn.len
op_assign
id|bufOut.len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
id|sgSize
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataInSize
OG
l_int|0
)paren
id|sgSize
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sgSize
OG
l_int|0
)paren
(brace
multiline_comment|/* Allocate memory for the SGL.&n;&t;&t; * Used to free kernel memory once&n;&t;&t; * the MF is freed.&n;&t;&t; */
id|sglbuf
op_assign
id|pci_alloc_consistent
(paren
id|ioc-&gt;pcidev
comma
id|sgSize
op_star
r_sizeof
(paren
id|MptSge_t
)paren
comma
op_amp
id|sglbuf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sglbuf
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
id|this_sge
op_assign
id|sglbuf
suffix:semicolon
multiline_comment|/* Set up the dataOut memory allocation */
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
(brace
id|dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataInSize
OG
l_int|0
)paren
(brace
id|flagsLength
op_assign
(paren
id|MPI_SGE_FLAGS_SIMPLE_ELEMENT
op_or
id|MPI_SGE_FLAGS_DIRECTION
op_or
id|mpt_addr_size
c_func
(paren
)paren
)paren
op_lshift
id|MPI_SGE_FLAGS_SHIFT
suffix:semicolon
)brace
r_else
(brace
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_WRITE
suffix:semicolon
)brace
id|flagsLength
op_or_assign
id|karg.dataOutSize
suffix:semicolon
id|this_alloc
op_assign
id|karg.dataOutSize
suffix:semicolon
id|bufOut.len
op_assign
id|this_alloc
suffix:semicolon
id|bufOut.kptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|this_alloc
comma
op_amp
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufOut.kptr
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Copy user data to kernel space.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|bufOut.kptr
comma
id|karg.dataOutBufPtr
comma
id|bufOut.len
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - Unable &quot;
l_string|&quot;to read user data &quot;
l_string|&quot;struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|karg.dataOutBufPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
multiline_comment|/* Set up this SGE.&n;&t;&t;&t;&t; * Copy to MF and to sglbuf&n;&t;&t;&t;&t; */
id|mpt_add_sge
c_func
(paren
id|psge
comma
id|flagsLength
comma
id|dma_addr
)paren
suffix:semicolon
id|psge
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|this_sge-&gt;FlagsLength
op_assign
id|flagsLength
suffix:semicolon
id|this_sge-&gt;Address
op_assign
id|dma_addr
suffix:semicolon
id|this_sge
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|karg.dataInSize
OG
l_int|0
)paren
(brace
id|dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_READ
suffix:semicolon
id|flagsLength
op_or_assign
id|karg.dataInSize
suffix:semicolon
id|this_alloc
op_assign
id|karg.dataInSize
suffix:semicolon
id|bufIn.len
op_assign
id|this_alloc
suffix:semicolon
id|bufIn.kptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|this_alloc
comma
op_amp
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufIn.kptr
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set up this SGE&n;&t;&t;&t;&t; * Copy to MF and to sglbuf&n;&t;&t;&t;&t; */
id|mpt_add_sge
c_func
(paren
id|psge
comma
id|flagsLength
comma
id|dma_addr
)paren
suffix:semicolon
id|this_sge-&gt;FlagsLength
op_assign
id|flagsLength
suffix:semicolon
id|this_sge-&gt;Address
op_assign
id|dma_addr
suffix:semicolon
id|this_sge
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Add a NULL SGE&n;&t;&t; */
id|mpt_add_sge
c_func
(paren
id|psge
comma
id|flagsLength
comma
(paren
id|dma_addr_t
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* The request is complete. Set the timer parameters&n;&t; * and issue the request.&n;&t; */
r_if
c_cond
(paren
id|karg.timeout
OG
l_int|0
)paren
(brace
id|ioc-&gt;ioctl-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
id|karg.timeout
suffix:semicolon
)brace
r_else
(brace
id|ioc-&gt;ioctl-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
id|MPT_IOCTL_DEFAULT_TIMEOUT
suffix:semicolon
)brace
id|ioc-&gt;ioctl-&gt;wait_done
op_assign
l_int|0
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_TIMER_ACTIVE
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ioc-&gt;ioctl-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdr-&gt;Function
op_eq
id|MPI_FUNCTION_SCSI_TASK_MGMT
)paren
(brace
id|rc
op_assign
id|mpt_send_handshake_request
c_func
(paren
id|mptctl_id
comma
id|ioc-&gt;id
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
(paren
id|u32
op_star
)paren
id|mf
comma
id|NO_SLEEP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|wait_event
c_func
(paren
id|mptctl_wait
comma
id|ioc-&gt;ioctl-&gt;wait_done
)paren
suffix:semicolon
)brace
r_else
(brace
id|mptctl_free_tm_flags
c_func
(paren
id|ioc
)paren
suffix:semicolon
id|tm_flags_set
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ioc-&gt;ioctl-&gt;timer
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_and_assign
op_complement
id|MPT_IOCTL_STATUS_TIMER_ACTIVE
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_assign
id|MPT_IOCTL_STATUS_TM_FAILED
suffix:semicolon
)brace
)brace
r_else
(brace
id|mpt_put_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|mptctl_wait
comma
id|ioc-&gt;ioctl-&gt;wait_done
)paren
suffix:semicolon
)brace
multiline_comment|/* The command is complete.  * Return data to the user.&n;&t; *&n;&t; * If command completed,  mf has been freed so cannot&n;&t; * use this memory.&n;&t; *&n;&t; * If timeout, a recovery  mechanism has been called.&n;&t; * Need to free the mf.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_DID_IOCRESET
)paren
(brace
multiline_comment|/* A timeout - there is no data to return to the&n;&t;&t; * the user other than an error.&n;&t;&t; * The timer callback deleted the&n;&t;&t; * timer and reset the adapter queues.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Timeout Occurred on IOCTL! Reset IOC.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|tm_flags_set
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
op_minus
id|ETIME
suffix:semicolon
multiline_comment|/* Free memory and return to the calling function&n;&t;&t; */
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_TM_FAILED
)paren
(brace
multiline_comment|/* User TM request failed!&n;&t;&t; */
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Callback freed request frame.&n;&t;&t; */
id|mf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* If a valid reply frame, copy to the user.&n;&t;&t; * Offset 2: reply length in U32&squot;s&n;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_RF_VALID
)paren
(brace
r_if
c_cond
(paren
id|karg.maxReplyBytes
OL
id|ioc-&gt;reply_sz
)paren
(brace
id|sz
op_assign
id|MIN
c_func
(paren
id|karg.maxReplyBytes
comma
l_int|4
op_star
id|ioc-&gt;ioctl-&gt;ReplyFrame
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|sz
op_assign
id|MIN
c_func
(paren
id|ioc-&gt;reply_sz
comma
l_int|4
op_star
id|ioc-&gt;ioctl-&gt;ReplyFrame
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sz
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|karg.replyFrameBufPtr
comma
op_amp
id|ioc-&gt;ioctl-&gt;ReplyFrame
comma
id|sz
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Unable to write out reply frame %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|karg.replyFrameBufPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* If valid sense data, copy to user.&n;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_SENSE_VALID
)paren
(brace
id|sz
op_assign
id|MIN
c_func
(paren
id|karg.maxSenseBytes
comma
id|MPT_SENSE_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sz
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|karg.senseDataPtr
comma
id|ioc-&gt;ioctl-&gt;sense
comma
id|sz
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Unable to write sense data to user %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|karg.senseDataPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* If the overall status is _GOOD and data in, copy data&n;&t;&t; * to user.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_COMMAND_GOOD
)paren
op_logical_and
(paren
id|karg.dataInSize
OG
l_int|0
)paren
op_logical_and
(paren
id|bufIn.kptr
)paren
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|karg.dataInBufPtr
comma
id|bufIn.kptr
comma
id|karg.dataInSize
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Unable to write data to user %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|karg.dataInBufPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
)brace
)brace
)brace
id|done_free_mem
suffix:colon
multiline_comment|/* Clear status bits.&n;&t; */
id|ioc-&gt;ioctl-&gt;status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tm_flags_set
)paren
id|mptctl_free_tm_flags
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sglbuf
)paren
(brace
id|this_sge
op_assign
id|sglbuf
suffix:semicolon
multiline_comment|/* Free the allocated memory.&n;&t;&t; */
r_if
c_cond
(paren
id|bufOut.kptr
op_ne
l_int|NULL
)paren
(brace
id|dma_addr
op_assign
id|this_sge-&gt;Address
suffix:semicolon
id|this_sge
op_increment
suffix:semicolon
multiline_comment|/* go to next structure */
id|this_alloc
op_assign
id|bufOut.len
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|this_alloc
comma
(paren
r_void
op_star
)paren
op_amp
id|bufOut
comma
id|dma_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bufIn.kptr
op_ne
l_int|NULL
)paren
(brace
id|dma_addr
op_assign
id|this_sge-&gt;Address
suffix:semicolon
id|this_alloc
op_assign
id|bufIn.len
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|this_alloc
comma
(paren
r_void
op_star
)paren
op_amp
id|bufIn
comma
id|dma_addr
)paren
suffix:semicolon
)brace
id|this_alloc
op_assign
id|sgSize
op_star
r_sizeof
(paren
id|MptSge_t
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|this_alloc
comma
(paren
r_void
op_star
)paren
id|sglbuf
comma
id|sglbuf_dma
)paren
suffix:semicolon
)brace
multiline_comment|/* mf will be null if allocation failed OR&n;&t; * if command completed OK (callback freed)&n;&t; */
r_if
c_cond
(paren
id|mf
)paren
id|mpt_free_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Routine for the Compaq IOCTL commands.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; *&t;&t;-ENOMEM if memory allocation error&n; */
r_static
r_int
DECL|function|mptctl_compaq_ioctl
id|mptctl_compaq_ioctl
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|iocnum
op_assign
l_int|0
suffix:semicolon
r_int
id|iocnumX
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|CPQFCTS_SCSI_PASSTHRU
)paren
(brace
multiline_comment|/* Update the iocnum */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|iocnumX
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_compaq_ioctl() @%d - &quot;
l_string|&quot;Unable to read controller number @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|iocnumX
op_and_assign
l_int|0xFF
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_compaq_ioctl() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnumX
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* All of these commands require an interrupt or&n;&t; * are unknown/illegal.&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: mptctl_compaq_ioctl()&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CPQFCTS_GETPCIINFO
suffix:colon
id|ret
op_assign
id|mptctl_cpq_getpciinfo
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPQFCTS_GETDRIVER
suffix:colon
id|ret
op_assign
id|mptctl_cpq_getdriver
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPQFCTS_CTLR_STATUS
suffix:colon
id|ret
op_assign
id|mptctl_cpq_ctlr_status
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPQFCTS_SCSI_IOCTL_FC_TARGET_ADDRESS
suffix:colon
id|ret
op_assign
id|mptctl_cpq_target_address
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPQFCTS_SCSI_PASSTHRU
suffix:colon
id|ret
op_assign
id|mptctl_cpq_passthru
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|iocp-&gt;id
)braket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_cpq_getpciinfo - Get PCI Information in format desired by Compaq&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; */
r_static
r_int
DECL|function|mptctl_cpq_getpciinfo
id|mptctl_cpq_getpciinfo
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|cpqfc_pci_info_struct
op_star
id|uarg
op_assign
(paren
id|cpqfc_pci_info_struct
op_star
)paren
id|arg
suffix:semicolon
id|cpqfc_pci_info_struct
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|hdr
suffix:semicolon
r_int
id|iocnum
op_assign
l_int|0
comma
id|iocnumX
op_assign
l_int|0
suffix:semicolon
id|dma_addr_t
id|buf_dma
suffix:semicolon
id|u8
op_star
id|pbuf
op_assign
l_int|NULL
suffix:semicolon
r_int
id|failed
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_cpq_pciinfo called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
id|cpqfc_pci_info_struct
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_pciinfo - &quot;
l_string|&quot;Unable to read in cpqfc_pci_info_struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_pciinfo() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pdev
op_assign
(paren
r_struct
id|pci_dev
op_star
)paren
id|ioc-&gt;pcidev
suffix:semicolon
multiline_comment|/* Populate the structure. */
id|karg.bus
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|karg.bus_type
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 = PCI; 4 = unknown */
id|karg.device_fn
op_assign
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|karg.slot_number
op_assign
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|karg.vendor_id
op_assign
id|pdev-&gt;vendor
suffix:semicolon
id|karg.device_id
op_assign
id|pdev-&gt;device
suffix:semicolon
id|karg.board_id
op_assign
(paren
id|karg.device_id
op_or
(paren
id|karg.vendor_id
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|karg.class_code
op_assign
id|pdev
op_member_access_from_pointer
r_class
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|karg.sub_vendor_id
op_assign
id|pdev-&gt;subsystem_vendor
suffix:semicolon
id|karg.sub_device_id
op_assign
id|pdev-&gt;subsystem_device
suffix:semicolon
macro_line|#endif
multiline_comment|/* Issue a config request to get the device serial number&n;&t; */
id|hdr.PageVersion
op_assign
l_int|0
suffix:semicolon
id|hdr.PageLength
op_assign
l_int|0
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|0
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_MANUFACTURING
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* read */
id|cfg.timeout
op_assign
l_int|10
suffix:semicolon
id|failed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cfg.hdr-&gt;PageLength
OG
l_int|0
)paren
(brace
multiline_comment|/* Issue the second config page request */
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|pbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|hdr.PageLength
op_star
l_int|4
comma
op_amp
id|buf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pbuf
)paren
(brace
id|cfg.physAddr
op_assign
id|buf_dma
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
id|ManufacturingPage0_t
op_star
id|pdata
op_assign
(paren
id|ManufacturingPage0_t
op_star
)paren
id|pbuf
suffix:semicolon
id|strncpy
c_func
(paren
id|karg.serial_number
comma
id|pdata-&gt;BoardTracerNumber
comma
l_int|17
)paren
suffix:semicolon
id|failed
op_assign
l_int|0
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|hdr.PageLength
op_star
l_int|4
comma
id|pbuf
comma
id|buf_dma
)paren
suffix:semicolon
id|pbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|failed
)paren
id|strncpy
c_func
(paren
id|karg.serial_number
comma
l_string|&quot; &quot;
comma
l_int|17
)paren
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
id|cpqfc_pci_info_struct
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_pciinfo - &quot;
l_string|&quot;Unable to write out cpqfc_pci_info_struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_cpq_getdriver - Get Driver Version in format desired by Compaq&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_cpq_getdriver
id|mptctl_cpq_getdriver
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_int
op_star
id|uarg
op_assign
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_int
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iocnum
op_assign
l_int|0
comma
id|iocnumX
op_assign
l_int|0
suffix:semicolon
r_int
id|ii
comma
id|jj
suffix:semicolon
r_char
id|version
(braket
l_int|10
)braket
suffix:semicolon
r_char
id|val
suffix:semicolon
r_char
op_star
id|vptr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|pptr
op_assign
l_int|NULL
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_cpq_getdriver called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_getdriver - &quot;
l_string|&quot;Unable to read in struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_cpq_getdriver() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|version
comma
id|MPT_LINUX_VERSION_COMMON
comma
l_int|8
)paren
suffix:semicolon
id|karg
op_assign
l_int|0
suffix:semicolon
id|vptr
op_assign
id|version
suffix:semicolon
id|ii
op_assign
l_int|3
suffix:semicolon
r_while
c_loop
(paren
id|ii
OG
l_int|0
)paren
(brace
id|pptr
op_assign
id|strchr
c_func
(paren
id|vptr
comma
l_char|&squot;.&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pptr
)paren
(brace
op_star
id|pptr
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|jj
op_assign
l_int|0
suffix:semicolon
id|vptr
(braket
id|jj
)braket
op_ge
l_char|&squot;0&squot;
op_logical_and
id|vptr
(braket
id|jj
)braket
op_le
l_char|&squot;9&squot;
suffix:semicolon
id|jj
op_increment
)paren
id|val
op_assign
l_int|10
op_star
id|val
op_plus
(paren
id|vptr
(braket
id|jj
)braket
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
id|karg
op_or_assign
(paren
id|val
op_lshift
(paren
l_int|8
op_star
id|ii
)paren
)paren
suffix:semicolon
id|pptr
op_increment
suffix:semicolon
id|vptr
op_assign
id|pptr
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
id|ii
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_getdriver - &quot;
l_string|&quot;Unable to write out stuct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_cpq_ctlr_status - Get controller status in format desired by Compaq&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_cpq_ctlr_status
id|mptctl_cpq_ctlr_status
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|cpqfc_ctlr_status
op_star
id|uarg
op_assign
(paren
id|cpqfc_ctlr_status
op_star
)paren
id|arg
suffix:semicolon
id|cpqfc_ctlr_status
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
op_assign
l_int|0
comma
id|iocnumX
op_assign
l_int|0
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_cpq_pciinfo called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
id|cpqfc_ctlr_status
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_ctlr_status - &quot;
l_string|&quot;Unable to read in cpqfc_ctlr_status @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_cpq_ctlr_status() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|karg.status
op_assign
id|ioc-&gt;last_state
suffix:semicolon
id|karg.offline_reason
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
id|cpqfc_ctlr_status
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_ctlr_status - &quot;
l_string|&quot;Unable to write out cpqfc_ctlr_status @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_cpq_target_address - Get WWN Information in format desired by Compaq&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; */
r_static
r_int
DECL|function|mptctl_cpq_target_address
id|mptctl_cpq_target_address
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|Scsi_FCTargAddress
op_star
id|uarg
op_assign
(paren
id|Scsi_FCTargAddress
op_star
)paren
id|arg
suffix:semicolon
id|Scsi_FCTargAddress
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
op_assign
l_int|0
comma
id|iocnumX
op_assign
l_int|0
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|hdr
suffix:semicolon
id|dma_addr_t
id|buf_dma
suffix:semicolon
id|u8
op_star
id|pbuf
op_assign
l_int|NULL
suffix:semicolon
id|FCPortPage0_t
op_star
id|ppp0
suffix:semicolon
r_int
id|ii
comma
id|failed
suffix:semicolon
id|u32
id|low
comma
id|high
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_cpq_target_address called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
id|Scsi_FCTargAddress
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_target_address - &quot;
l_string|&quot;Unable to read in Scsi_FCTargAddress @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_cpq_target_address() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|karg.host_port_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Issue a config request to get the device wwn&n;&t; */
id|hdr.PageVersion
op_assign
l_int|0
suffix:semicolon
id|hdr.PageLength
op_assign
l_int|0
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|0
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_FC_PORT
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* read */
id|cfg.timeout
op_assign
l_int|10
suffix:semicolon
id|failed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cfg.hdr-&gt;PageLength
OG
l_int|0
)paren
(brace
multiline_comment|/* Issue the second config page request */
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|pbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|hdr.PageLength
op_star
l_int|4
comma
op_amp
id|buf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pbuf
)paren
(brace
id|cfg.physAddr
op_assign
id|buf_dma
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
id|ppp0
op_assign
(paren
id|FCPortPage0_t
op_star
)paren
id|pbuf
suffix:semicolon
id|low
op_assign
id|le32_to_cpu
c_func
(paren
id|ppp0-&gt;WWNN.Low
)paren
suffix:semicolon
id|high
op_assign
id|le32_to_cpu
c_func
(paren
id|ppp0-&gt;WWNN.High
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|4
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|karg.host_wwn
(braket
l_int|7
op_minus
id|ii
)braket
op_assign
id|low
op_amp
l_int|0xFF
suffix:semicolon
id|karg.host_wwn
(braket
l_int|3
op_minus
id|ii
)braket
op_assign
id|high
op_amp
l_int|0xFF
suffix:semicolon
id|low
op_assign
(paren
id|low
op_rshift
l_int|8
)paren
suffix:semicolon
id|high
op_assign
(paren
id|high
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
id|failed
op_assign
l_int|0
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|hdr.PageLength
op_star
l_int|4
comma
id|pbuf
comma
id|buf_dma
)paren
suffix:semicolon
id|pbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|failed
)paren
(brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|7
suffix:semicolon
id|ii
op_ge
l_int|0
suffix:semicolon
id|ii
op_decrement
)paren
id|karg.host_wwn
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
id|Scsi_FCTargAddress
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_target_address - &quot;
l_string|&quot;Unable to write out Scsi_FCTargAddress @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_cpq_passthru - Construct and issue a SCSI IO Passthru&n; *&n; * Requires the SCSI host driver to be loaded.&n; * I386 version.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; */
r_static
r_int
DECL|function|mptctl_cpq_passthru
id|mptctl_cpq_passthru
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|VENDOR_IOCTL_REQ
op_star
id|uarg
op_assign
(paren
id|VENDOR_IOCTL_REQ
op_star
)paren
id|arg
suffix:semicolon
id|VENDOR_IOCTL_REQ
id|karg
suffix:semicolon
id|cpqfc_passthru_t
id|kpass
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
op_assign
l_int|0
comma
id|iocnumX
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_cpq_passthru called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
id|VENDOR_IOCTL_REQ
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_passthru - &quot;
l_string|&quot;Unable to read in VENDOR_IOCTL_REQ @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Set the IOC number */
id|iocnumX
op_assign
id|karg.lc
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_cpq_passthru() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;sh
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_cpq_passthru() @%d - SCSI Host driver not loaded!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Read in the second buffer */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kpass
comma
id|uarg-&gt;argp
comma
r_sizeof
(paren
id|cpqfc_passthru_t
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_cpq_passthru - &quot;
l_string|&quot;Unable to read in cpqfc_passthru_t @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Generate the SCSI IO command and issue */
id|rc
op_assign
id|mptctl_compaq_scsiio
c_func
(paren
op_amp
id|karg
comma
op_amp
id|kpass
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_compaq_scsiio - Reformat Compaq structures into driver structures&n; * Call the generic _do_mpt_command function.&n; *&n; * Requires the SCSI host driver to be loaded.&n; * I386 version.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; */
r_static
r_int
DECL|function|mptctl_compaq_scsiio
id|mptctl_compaq_scsiio
c_func
(paren
id|VENDOR_IOCTL_REQ
op_star
id|pVenReq
comma
id|cpqfc_passthru_t
op_star
id|pPass
)paren
(brace
r_struct
id|mpt_ioctl_command
id|karg
suffix:semicolon
id|SCSIIORequest_t
id|request
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pMf
suffix:semicolon
r_int
id|ii
comma
id|rc
suffix:semicolon
id|u8
id|opcode
suffix:semicolon
multiline_comment|/* Fill in parameters to karg */
id|karg.hdr.iocnum
op_assign
id|pVenReq-&gt;lc
suffix:semicolon
id|karg.hdr.port
op_assign
l_int|0
suffix:semicolon
id|karg.hdr.maxDataSize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not used */
id|karg.timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* use default */
id|karg.replyFrameBufPtr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* no reply data */
id|karg.maxReplyBytes
op_assign
l_int|0
suffix:semicolon
id|karg.senseDataPtr
op_assign
id|pPass-&gt;sense_data
suffix:semicolon
id|karg.maxSenseBytes
op_assign
id|pPass-&gt;sense_len
suffix:semicolon
multiline_comment|/* max is 40 */
r_if
c_cond
(paren
id|pPass-&gt;rw_flag
op_eq
id|MPT_COMPAQ_WRITE
)paren
(brace
id|karg.dataOutBufPtr
op_assign
id|pPass-&gt;bufp
suffix:semicolon
id|karg.dataOutSize
op_assign
id|pPass-&gt;len
suffix:semicolon
id|karg.dataInBufPtr
op_assign
l_int|NULL
suffix:semicolon
id|karg.dataInSize
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|karg.dataInBufPtr
op_assign
id|pPass-&gt;bufp
suffix:semicolon
id|karg.dataInSize
op_assign
id|pPass-&gt;len
suffix:semicolon
id|karg.dataOutBufPtr
op_assign
l_int|NULL
suffix:semicolon
id|karg.dataOutSize
op_assign
l_int|0
suffix:semicolon
)brace
id|karg.dataSgeOffset
op_assign
(paren
r_sizeof
(paren
id|SCSIIORequest_t
)paren
op_minus
r_sizeof
(paren
id|SGE_IO_UNION
)paren
)paren
op_div
l_int|4
suffix:semicolon
multiline_comment|/* Construct the Message frame */
id|pMf
op_assign
op_amp
id|request
suffix:semicolon
id|pMf-&gt;TargetID
op_assign
(paren
id|u8
)paren
id|pVenReq-&gt;ld
suffix:semicolon
multiline_comment|/* ???? FIXME */
id|pMf-&gt;Bus
op_assign
(paren
id|u8
)paren
id|pPass-&gt;bus
suffix:semicolon
id|pMf-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pMf-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_IO_REQUEST
suffix:semicolon
multiline_comment|/* May need some tweaking here */
id|opcode
op_assign
(paren
id|u8
)paren
id|pPass-&gt;cdb
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|opcode
OL
l_int|0x20
)paren
id|pMf-&gt;CDBLength
op_assign
l_int|6
suffix:semicolon
r_else
r_if
c_cond
(paren
id|opcode
OL
l_int|0x60
)paren
id|pMf-&gt;CDBLength
op_assign
l_int|10
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|opcode
OL
l_int|0xC0
)paren
op_logical_and
(paren
id|opcode
op_ge
l_int|0xA0
)paren
)paren
id|pMf-&gt;CDBLength
op_assign
l_int|12
suffix:semicolon
r_else
id|pMf-&gt;CDBLength
op_assign
l_int|16
suffix:semicolon
id|pMf-&gt;SenseBufferLength
op_assign
id|karg.maxSenseBytes
suffix:semicolon
multiline_comment|/* max is 40 */
id|pMf-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pMf-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set later */
id|pMf-&gt;MsgContext
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set later */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
id|pMf-&gt;LUN
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
id|pMf-&gt;LUN
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ???? FIXME */
multiline_comment|/* Tag values set by _do_mpt_command */
r_if
c_cond
(paren
id|pPass-&gt;rw_flag
op_eq
id|MPT_COMPAQ_WRITE
)paren
id|pMf-&gt;Control
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
r_else
id|pMf-&gt;Control
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|16
suffix:semicolon
id|ii
op_increment
)paren
id|pMf-&gt;CDB
(braket
id|ii
)braket
op_assign
id|pPass-&gt;cdb
(braket
id|ii
)braket
suffix:semicolon
id|pMf-&gt;DataLength
op_assign
id|pPass-&gt;len
suffix:semicolon
multiline_comment|/* All remaining fields are set by the next function&n;&t; */
id|rc
op_assign
id|mptctl_do_mpt_command
(paren
id|karg
comma
(paren
r_char
op_star
)paren
id|pMf
comma
l_int|1
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,51)
DECL|macro|owner_THIS_MODULE
mdefine_line|#define&t;owner_THIS_MODULE  owner:&t;&t;THIS_MODULE,
macro_line|#else
DECL|macro|owner_THIS_MODULE
mdefine_line|#define&t;owner_THIS_MODULE
macro_line|#endif
DECL|variable|mptctl_fops
r_static
r_struct
id|file_operations
id|mptctl_fops
op_assign
(brace
id|owner_THIS_MODULE
id|llseek
suffix:colon
id|no_llseek
comma
id|read
suffix:colon
id|mptctl_read
comma
id|write
suffix:colon
id|mptctl_write
comma
id|ioctl
suffix:colon
id|mptctl_ioctl
comma
id|open
suffix:colon
id|mptctl_open
comma
id|release
suffix:colon
id|mptctl_release
comma
)brace
suffix:semicolon
DECL|variable|mptctl_miscdev
r_static
r_struct
id|miscdevice
id|mptctl_miscdev
op_assign
(brace
id|MPT_MINOR
comma
id|MYNAM
comma
op_amp
id|mptctl_fops
)brace
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#if defined(__sparc__) &amp;&amp; defined(__sparc_v9__)&t;&t;/*{*/
multiline_comment|/* The dynamic ioctl32 compat. registry only exists in &gt;2.3.x sparc64 kernels */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)&t;&t;/*{*/
r_extern
r_int
id|register_ioctl32_conversion
c_func
(paren
r_int
r_int
id|cmd
comma
r_int
(paren
op_star
id|handler
)paren
(paren
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_struct
id|file
op_star
)paren
)paren
suffix:semicolon
r_int
id|unregister_ioctl32_conversion
c_func
(paren
r_int
r_int
id|cmd
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* sparc32_XXX functions are used to provide a conversion between&n; * pointers and u32&squot;s. If the arg does not contain any pointers, then&n; * a specialized function (sparc32_XXX) is not needed. If the arg&n; * does contain pointer(s), then the specialized function is used&n; * to ensure the structure contents is properly processed by mptctl.&n; */
r_static
r_int
DECL|function|sparc32_mptfwxfer_ioctl
id|sparc32_mptfwxfer_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|mpt_fw_xfer32
id|kfw32
suffix:semicolon
r_struct
id|mpt_fw_xfer
id|kfw
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iocnum
comma
id|iocnumX
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::sparc32_mptfwxfer_ioctl() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kfw32
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|kfw32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Verify intended MPT adapter */
id|iocnumX
op_assign
id|kfw32.iocnum
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;::sparc32_mptfwxfer_ioctl @%d - ioc%d not found!&bslash;n&quot;
comma
id|__LINE__
comma
id|iocnumX
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|kfw.iocnum
op_assign
id|iocnum
suffix:semicolon
id|kfw.fwlen
op_assign
id|kfw32.fwlen
suffix:semicolon
id|kfw.bufp
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|kfw32.bufp
suffix:semicolon
id|ret
op_assign
id|mptctl_do_fw_download
c_func
(paren
id|kfw.iocnum
comma
id|kfw.bufp
comma
id|kfw.fwlen
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|iocp-&gt;id
)braket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|sparc32_mpt_command
id|sparc32_mpt_command
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|mpt_ioctl_command32
id|karg32
suffix:semicolon
r_struct
id|mpt_ioctl_command32
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_command32
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_command
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iocnum
comma
id|iocnumX
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::sparc32_mpt_command() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg32
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|karg32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Verify intended MPT adapter */
id|iocnumX
op_assign
id|karg32.hdr.iocnum
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;::sparc32_mpt_command @%d - ioc%d not found!&bslash;n&quot;
comma
id|__LINE__
comma
id|iocnumX
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* Copy data to karg */
id|karg.hdr.iocnum
op_assign
id|karg32.hdr.iocnum
suffix:semicolon
id|karg.hdr.port
op_assign
id|karg32.hdr.port
suffix:semicolon
id|karg.timeout
op_assign
id|karg32.timeout
suffix:semicolon
id|karg.maxReplyBytes
op_assign
id|karg32.maxReplyBytes
suffix:semicolon
id|karg.dataInSize
op_assign
id|karg32.dataInSize
suffix:semicolon
id|karg.dataOutSize
op_assign
id|karg32.dataOutSize
suffix:semicolon
id|karg.maxSenseBytes
op_assign
id|karg32.maxSenseBytes
suffix:semicolon
id|karg.dataSgeOffset
op_assign
id|karg32.dataSgeOffset
suffix:semicolon
id|karg.replyFrameBufPtr
op_assign
(paren
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.replyFrameBufPtr
suffix:semicolon
id|karg.dataInBufPtr
op_assign
(paren
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.dataInBufPtr
suffix:semicolon
id|karg.dataOutBufPtr
op_assign
(paren
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.dataOutBufPtr
suffix:semicolon
id|karg.senseDataPtr
op_assign
(paren
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.senseDataPtr
suffix:semicolon
multiline_comment|/* Pass new structure to do_mpt_command&n;&t; */
id|ret
op_assign
id|mptctl_do_mpt_command
(paren
id|karg
comma
(paren
r_char
op_star
)paren
op_amp
id|uarg-&gt;MF
comma
l_int|0
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|iocp-&gt;id
)braket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|sparc32_mptctl_cpq_passthru
id|sparc32_mptctl_cpq_passthru
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|VENDOR_IOCTL_REQ32
op_star
id|uarg
op_assign
(paren
id|VENDOR_IOCTL_REQ32
op_star
)paren
id|arg
suffix:semicolon
id|VENDOR_IOCTL_REQ32
id|karg32
suffix:semicolon
id|VENDOR_IOCTL_REQ
id|karg
suffix:semicolon
id|cpqfc_passthru32_t
id|kpass32
suffix:semicolon
id|cpqfc_passthru_t
id|kpass
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|iocnum
op_assign
l_int|0
comma
id|iocnumX
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::sparc32_mptctl_cpq_passthru() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg32
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|karg32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Verify intended MPT adapter */
id|iocnumX
op_assign
id|karg32.lc
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;::sparc32_mpt_command @%d - ioc%d not found!&bslash;n&quot;
comma
id|__LINE__
comma
id|iocnumX
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mptctl_syscall_down
c_func
(paren
id|ioc
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Copy data to karg */
id|karg.ld
op_assign
id|karg32.ld
suffix:semicolon
id|karg.node
op_assign
id|karg32.node
suffix:semicolon
id|karg.lc
op_assign
id|karg32.lc
suffix:semicolon
id|karg.nexus
op_assign
id|karg32.nexus
suffix:semicolon
id|karg.argp
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.argp
suffix:semicolon
multiline_comment|/* Read in the second buffer */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kpass32
comma
id|karg.argp
comma
r_sizeof
(paren
id|cpqfc_passthru32_t
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::sparc32_mptctl_cpq_passthru - &quot;
l_string|&quot;Unable to read in cpqfc_passthru_t @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_void
op_star
)paren
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Copy the 32bit buffer to kpass */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|16
suffix:semicolon
id|ii
op_increment
)paren
id|kpass.cdb
(braket
id|ii
)braket
op_assign
id|kpass32.cdb
(braket
id|ii
)braket
suffix:semicolon
id|kpass.bus
op_assign
id|kpass32.bus
suffix:semicolon
id|kpass.pdrive
op_assign
id|kpass32.pdrive
suffix:semicolon
id|kpass.len
op_assign
id|kpass32.len
suffix:semicolon
id|kpass.sense_len
op_assign
id|kpass32.sense_len
suffix:semicolon
id|kpass.bufp
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|kpass32.bufp
suffix:semicolon
id|kpass.rw_flag
op_assign
id|kpass32.rw_flag
suffix:semicolon
multiline_comment|/* Generate the SCSI IO command and issue */
id|rc
op_assign
id|mptctl_compaq_scsiio
c_func
(paren
op_amp
id|karg
comma
op_amp
id|kpass
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|ioc-&gt;id
)braket
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif&t;&t;/*} linux &gt;= 2.3.x */
macro_line|#endif&t;&t;/*} sparc */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_init
r_int
id|__init
id|mptctl_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|where
op_assign
l_int|1
suffix:semicolon
r_int
id|sz
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
id|show_mptmod_ver
c_func
(paren
id|my_NAME
comma
id|my_VERSION
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MPT_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sema_init
c_func
(paren
op_amp
id|mptctl_syscall_sem_ioc
(braket
id|i
)braket
comma
l_int|1
)paren
suffix:semicolon
id|ioc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|i
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This adapter instance is found.&n;&t;&t;&t; * Allocate and inite a MPT_IOCTL structure&n;&t;&t;&t; */
id|sz
op_assign
r_sizeof
(paren
id|MPT_IOCTL
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|ioc-&gt;ioctl
op_assign
(paren
id|MPT_IOCTL
op_star
)paren
id|mem
suffix:semicolon
id|ioc-&gt;ioctl-&gt;ioc
op_assign
id|ioc
suffix:semicolon
id|init_timer
(paren
op_amp
id|ioc-&gt;ioctl-&gt;timer
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ioc-&gt;ioctl
suffix:semicolon
id|ioc-&gt;ioctl-&gt;timer.function
op_assign
id|mptctl_timer_expired
suffix:semicolon
id|init_timer
(paren
op_amp
id|ioc-&gt;ioctl-&gt;TMtimer
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;TMtimer.data
op_assign
(paren
r_int
r_int
)paren
id|ioc-&gt;ioctl
suffix:semicolon
id|ioc-&gt;ioctl-&gt;TMtimer.function
op_assign
id|mptctl_timer_expired
suffix:semicolon
)brace
)brace
macro_line|#if defined(__sparc__) &amp;&amp; defined(__sparc_v9__)&t;&t;/*{*/
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)&t;&t;/*{*/
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTIOCINFO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTTARGETINFO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTTEST
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTEVENTQUERY
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTEVENTENABLE
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTEVENTREPORT
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTHARDRESET
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTCOMMAND32
comma
id|sparc32_mpt_command
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|MPTFWDOWNLOAD32
comma
id|sparc32_mptfwxfer_ioctl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|CPQFCTS_GETPCIINFO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|CPQFCTS_CTLR_STATUS
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|CPQFCTS_GETDRIVER
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|CPQFCTS_SCSI_IOCTL_FC_TARGET_ADDRESS
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
id|err
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|CPQFCTS_SCSI_PASSTHRU32
comma
id|sparc32_mptctl_cpq_passthru
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|where
op_logical_and
id|err
)paren
r_goto
id|out_fail
suffix:semicolon
macro_line|#endif&t;&t;/*} linux &gt;= 2.3.x */
macro_line|#endif&t;&t;/*} sparc */
multiline_comment|/* Register this device */
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: Can&squot;t register misc device [minor=%d].&bslash;n&quot;
comma
id|MPT_MINOR
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered with Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: /dev/%s @ (major,minor=%d,%d)&bslash;n&quot;
comma
id|mptctl_miscdev.name
comma
id|MISC_MAJOR
comma
id|mptctl_miscdev.minor
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Install our handler&n;&t; */
op_increment
id|where
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mptctl_id
op_assign
id|mpt_register
c_func
(paren
id|mptctl_reply
comma
id|MPTCTL_DRIVER
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR: Failed to register with Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mpt_reset_register
c_func
(paren
id|mptctl_id
comma
id|mptctl_ioc_reset
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FIXME! */
)brace
r_return
l_int|0
suffix:semicolon
id|out_fail
suffix:colon
macro_line|#if defined(__sparc__) &amp;&amp; defined(__sparc_v9__)&t;&t;/*{*/
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)&t;&t;/*{*/
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR: Failed to register ioctl32_conversion!&quot;
l_string|&quot; (%d:err=%d)&bslash;n&quot;
comma
id|where
comma
id|err
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTIOCINFO
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTTARGETINFO
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTTEST
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTEVENTQUERY
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTEVENTENABLE
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTEVENTREPORT
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTHARDRESET
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTCOMMAND32
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|MPTFWDOWNLOAD32
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|CPQFCTS_GETPCIINFO
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|CPQFCTS_GETDRIVER
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|CPQFCTS_CTLR_STATUS
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|CPQFCTS_SCSI_IOCTL_FC_TARGET_ADDRESS
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|CPQFCTS_SCSI_PASSTHRU32
)paren
suffix:semicolon
macro_line|#endif&t;&t;/*} linux &gt;= 2.3.x */
macro_line|#endif&t;&t;/*} sparc */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MPT_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ioc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|i
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ioc-&gt;ioctl
)paren
(brace
id|kfree
(paren
id|ioc-&gt;ioctl
)paren
suffix:semicolon
id|ioc-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_exit
r_void
id|mptctl_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered /dev/%s @ (major,minor=%d,%d)&bslash;n&quot;
comma
id|mptctl_miscdev.name
comma
id|MISC_MAJOR
comma
id|mptctl_miscdev.minor
)paren
suffix:semicolon
multiline_comment|/* De-register reset handler from base module */
id|mpt_reset_deregister
c_func
(paren
id|mptctl_id
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* De-register callback handler from base module */
id|mpt_deregister
c_func
(paren
id|mptctl_id
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered from Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Free allocated memory */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MPT_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ioc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|i
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ioc-&gt;ioctl
)paren
(brace
id|kfree
(paren
id|ioc-&gt;ioctl
)paren
suffix:semicolon
id|ioc-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mptctl_init
id|module_init
c_func
(paren
id|mptctl_init
)paren
suffix:semicolon
DECL|variable|mptctl_exit
id|module_exit
c_func
(paren
id|mptctl_exit
)paren
suffix:semicolon
eof
