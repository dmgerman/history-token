multiline_comment|/*&n; *  linux/drivers/message/fusion/mptctl.c&n; *      Fusion MPT misc device (ioctl) driver.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      A special thanks to Pamela Delaney (LSI Logic) for tons of work&n; *      and countless enhancements while adding support for the 1030&n; *      chip family.  Pam has been instrumental in the development of&n; *      of the 2.xx.xx series fusion drivers, and her contributions are&n; *      far too numerous to hope to list in one place.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      A big THANKS to Eddie C. Dost for fixing the ioctl path&n; *      and most importantly f/w download on sparc64 platform!&n; *      (plus Eddie&squot;s other helpful hints and insights)&n; *&n; *      Thanks to Arnaldo Carvalho de Melo for finding and patching&n; *      a potential memory leak in mptctl_do_fw_download(),&n; *      and for some kmalloc insight:-)&n; *&n; *      (see also mptbase.c)&n; *&n; *  Copyright (c) 1999-2004 LSI Logic Corporation&n; *  Originally By: Steven J. Ralston, Noah Romer&n; *  (mailto:sjralston1@netscape.net)&n; *  (mailto:mpt_linux_developer@lsil.com)&n; *&n; *  $Id: mptctl.c,v 1.63 2002/12/03 21:26:33 pdelaney Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;&t;/* for mdelay */
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/compat.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &lt;scsi/scsi_device.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_tcq.h&gt;
DECL|macro|COPYRIGHT
mdefine_line|#define COPYRIGHT&t;&quot;Copyright (c) 1999-2004 LSI Logic Corporation&quot;
DECL|macro|MODULEAUTHOR
mdefine_line|#define MODULEAUTHOR&t;&quot;Steven J. Ralston, Noah Romer, Pamela Delaney&quot;
macro_line|#include &quot;mptbase.h&quot;
macro_line|#include &quot;mptctl.h&quot;
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|my_NAME
mdefine_line|#define my_NAME&t;&t;&quot;Fusion MPT misc device (ioctl) driver&quot;
DECL|macro|my_VERSION
mdefine_line|#define my_VERSION&t;MPT_LINUX_VERSION_COMMON
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptctl&quot;
DECL|variable|MODULEAUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|MODULEAUTHOR
)paren
suffix:semicolon
DECL|variable|my_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|my_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mptctl_id
r_static
r_int
id|mptctl_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|mptctl_wait
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|struct|buflist
r_struct
id|buflist
(brace
DECL|member|kptr
id|u8
op_star
id|kptr
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Function prototypes. Called from OS entry point mptctl_ioctl.&n; * arg contents specific to function.&n; */
r_static
r_int
id|mptctl_fw_download
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_getiocinfo
(paren
r_int
r_int
id|arg
comma
r_int
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|mptctl_gettargetinfo
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_readtest
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_mpt_command
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_eventquery
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_eventenable
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_eventreport
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_replace_fw
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_do_reset
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_hp_hostinfo
c_func
(paren
r_int
r_int
id|arg
comma
r_int
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|mptctl_hp_targetinfo
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mptctl_probe
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_const
r_struct
id|pci_device_id
op_star
)paren
suffix:semicolon
r_static
r_void
id|mptctl_remove
c_func
(paren
r_struct
id|pci_dev
op_star
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_COMPAT
r_static
r_int
id|compat_mpctl_ioctl
c_func
(paren
r_struct
id|file
op_star
id|f
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Private function calls.&n; */
r_static
r_int
id|mptctl_do_mpt_command
(paren
r_struct
id|mpt_ioctl_command
id|karg
comma
r_void
id|__user
op_star
id|mfPtr
)paren
suffix:semicolon
r_static
r_int
id|mptctl_do_fw_download
c_func
(paren
r_int
id|ioc
comma
r_char
id|__user
op_star
id|ufwbuf
comma
r_int
id|fwlen
)paren
suffix:semicolon
r_static
id|MptSge_t
op_star
id|kbuf_alloc_2_sgl
c_func
(paren
r_int
id|bytes
comma
id|u32
id|dir
comma
r_int
id|sge_offset
comma
r_int
op_star
id|frags
comma
r_struct
id|buflist
op_star
op_star
id|blp
comma
id|dma_addr_t
op_star
id|sglbuf_dma
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|kfree_sgl
c_func
(paren
id|MptSge_t
op_star
id|sgl
comma
id|dma_addr_t
id|sgl_dma
comma
r_struct
id|buflist
op_star
id|buflist
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
r_static
r_void
id|mptctl_timeout_expired
(paren
id|MPT_IOCTL
op_star
id|ioctl
)paren
suffix:semicolon
r_static
r_int
id|mptctl_bus_reset
c_func
(paren
id|MPT_IOCTL
op_star
id|ioctl
)paren
suffix:semicolon
r_static
r_int
id|mptctl_set_tm_flags
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
suffix:semicolon
r_static
r_void
id|mptctl_free_tm_flags
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
suffix:semicolon
multiline_comment|/*&n; * Reset Handler cleanup function&n; */
r_static
r_int
id|mptctl_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Scatter gather list (SGL) sizes and limits...&n; */
singleline_comment|//#define MAX_SCSI_FRAGS&t;9
DECL|macro|MAX_FRAGS_SPILL1
mdefine_line|#define MAX_FRAGS_SPILL1&t;9
DECL|macro|MAX_FRAGS_SPILL2
mdefine_line|#define MAX_FRAGS_SPILL2&t;15
DECL|macro|FRAGS_PER_BUCKET
mdefine_line|#define FRAGS_PER_BUCKET&t;(MAX_FRAGS_SPILL2 + 1)
singleline_comment|//#define MAX_CHAIN_FRAGS&t;64
singleline_comment|//#define MAX_CHAIN_FRAGS&t;(15+15+15+16)
DECL|macro|MAX_CHAIN_FRAGS
mdefine_line|#define MAX_CHAIN_FRAGS&t;&t;(4 * MAX_FRAGS_SPILL2 + 1)
singleline_comment|//  Define max sg LIST bytes ( == (#frags + #chains) * 8 bytes each)
singleline_comment|//  Works out to: 592d bytes!     (9+1)*8 + 4*(15+1)*8
singleline_comment|//                  ^----------------- 80 + 512
DECL|macro|MAX_SGL_BYTES
mdefine_line|#define MAX_SGL_BYTES&t;&t;((MAX_FRAGS_SPILL1 + 1 + (4 * FRAGS_PER_BUCKET)) * 8)
multiline_comment|/* linux only seems to ever give 128kB MAX contiguous (GFP_USER) mem bytes */
DECL|macro|MAX_KMALLOC_SZ
mdefine_line|#define MAX_KMALLOC_SZ&t;&t;(128*1024)
DECL|macro|MPT_IOCTL_DEFAULT_TIMEOUT
mdefine_line|#define MPT_IOCTL_DEFAULT_TIMEOUT 10&t;/* Default timeout value (seconds) */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptctl_syscall_down - Down the MPT adapter syscall semaphore.&n; *&t;@ioc: Pointer to MPT adapter&n; *&t;@nonblock: boolean, non-zero if O_NONBLOCK is set&n; *&n; *&t;All of the ioctl commands can potentially sleep, which is illegal&n; *&t;with a spinlock held, thus we perform mutual exclusion here.&n; *&n; *&t;Returns negative errno on error, or zero for success.&n; */
r_static
r_inline
r_int
DECL|function|mptctl_syscall_down
id|mptctl_syscall_down
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|nonblock
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::mptctl_syscall_down(%p,%d) called&bslash;n&quot;
comma
id|ioc
comma
id|nonblock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|ioc-&gt;ioctl-&gt;sem_ioc
)paren
)paren
id|rc
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|ioc-&gt;ioctl-&gt;sem_ioc
)paren
)paren
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::mptctl_syscall_down return %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  This is the callback for any message we have posted. The message itself&n; *  will be returned to the message pool when we return from the IRQ&n; *&n; *  This runs in irq context so be short and sweet.&n; */
r_static
r_int
DECL|function|mptctl_reply
id|mptctl_reply
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|req
comma
id|MPT_FRAME_HDR
op_star
id|reply
)paren
(brace
r_char
op_star
id|sense_data
suffix:semicolon
r_int
id|sz
comma
id|req_index
suffix:semicolon
id|u16
id|iocStatus
suffix:semicolon
id|u8
id|cmd
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_reply()!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
id|cmd
op_assign
id|req-&gt;u.hdr.Function
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;ioctl
)paren
(brace
r_if
c_cond
(paren
id|reply
op_eq
l_int|NULL
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_reply() NULL Reply &quot;
l_string|&quot;Function=%x!&bslash;n&quot;
comma
id|cmd
)paren
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_COMMAND_GOOD
suffix:semicolon
id|ioc-&gt;ioctl-&gt;reset
op_and_assign
op_complement
id|MPTCTL_RESET_OK
suffix:semicolon
multiline_comment|/* We are done, issue wake up&n;&t; &t;&t;*/
id|ioc-&gt;ioctl-&gt;wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|mptctl_wait
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_reply() with req=%p &quot;
l_string|&quot;reply=%p Function=%x!&bslash;n&quot;
comma
id|req
comma
id|reply
comma
id|cmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Copy the reply frame (which much exist&n;&t;&t; * for non-SCSI I/O) to the IOC structure.&n;&t;&t; */
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;Copying Reply Frame @%p to ioc%d!&bslash;n&quot;
comma
id|reply
comma
id|ioc-&gt;id
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ioc-&gt;ioctl-&gt;ReplyFrame
comma
id|reply
comma
id|min
c_func
(paren
id|ioc-&gt;reply_sz
comma
l_int|4
op_star
id|reply-&gt;u.reply.MsgLength
)paren
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_RF_VALID
suffix:semicolon
multiline_comment|/* Set the command status to GOOD if IOC Status is GOOD&n;&t;&t; * OR if SCSI I/O cmd and data underrun or recovered error.&n;&t;&t; */
id|iocStatus
op_assign
id|reply-&gt;u.reply.IOCStatus
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
r_if
c_cond
(paren
id|iocStatus
op_eq
id|MPI_IOCSTATUS_SUCCESS
)paren
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_COMMAND_GOOD
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
op_logical_or
(paren
id|cmd
op_eq
id|MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH
)paren
)paren
(brace
id|ioc-&gt;ioctl-&gt;reset
op_and_assign
op_complement
id|MPTCTL_RESET_OK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iocStatus
op_eq
id|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
)paren
op_logical_or
(paren
id|iocStatus
op_eq
id|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
)paren
)paren
(brace
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_COMMAND_GOOD
suffix:semicolon
)brace
)brace
multiline_comment|/* Copy the sense data - if present&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
op_logical_and
(paren
id|reply-&gt;u.sreply.SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
)paren
(brace
id|sz
op_assign
id|req-&gt;u.scsireq.SenseBufferLength
suffix:semicolon
id|req_index
op_assign
id|le16_to_cpu
c_func
(paren
id|req-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sense_data
op_assign
(paren
(paren
id|u8
op_star
)paren
id|ioc-&gt;sense_buf_pool
op_plus
(paren
id|req_index
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ioc-&gt;ioctl-&gt;sense
comma
id|sense_data
comma
id|sz
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_SENSE_VALID
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|MPI_FUNCTION_SCSI_TASK_MGMT
)paren
id|mptctl_free_tm_flags
c_func
(paren
id|ioc
)paren
suffix:semicolon
multiline_comment|/* We are done, issue wake up&n;&t;&t; */
id|ioc-&gt;ioctl-&gt;wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|mptctl_wait
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_timeout_expired&n; *&n; * Expecting an interrupt, however timed out.&n; *&n; */
DECL|function|mptctl_timeout_expired
r_static
r_void
id|mptctl_timeout_expired
(paren
id|MPT_IOCTL
op_star
id|ioctl
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_NOTICE
id|MYNAM
l_string|&quot;: Timeout Expired! Host %d&bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|ioctl-&gt;wait_done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioctl-&gt;reset
op_amp
id|MPTCTL_RESET_OK
)paren
id|rc
op_assign
id|mptctl_bus_reset
c_func
(paren
id|ioctl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* Issue a reset for this device.&n;&t;&t; * The IOC is not responding.&n;&t;&t; */
id|dctlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Calling HardReset! &bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|mpt_HardResetHandler
c_func
(paren
id|ioctl-&gt;ioc
comma
id|NO_SLEEP
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* mptctl_bus_reset&n; *&n; * Bus reset code.&n; *&n; */
DECL|function|mptctl_bus_reset
r_static
r_int
id|mptctl_bus_reset
c_func
(paren
id|MPT_IOCTL
op_star
id|ioctl
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTm
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|ioctl-&gt;reset
op_and_assign
op_complement
id|MPTCTL_RESET_OK
suffix:semicolon
r_if
c_cond
(paren
id|ioctl-&gt;ioc-&gt;sh
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioctl-&gt;ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Single threading ....&n;&t; */
r_if
c_cond
(paren
id|mptctl_set_tm_flags
c_func
(paren
id|hd
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Send request&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioctl-&gt;ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;IssueTaskMgmt, no msg frames!!&bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|mptctl_free_tm_flags
c_func
(paren
id|ioctl-&gt;ioc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;IssueTaskMgmt request @ %p&bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;name
comma
id|mf
)paren
)paren
suffix:semicolon
id|pScsiTm
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
id|pScsiTm-&gt;TargetID
op_assign
id|ioctl-&gt;target
suffix:semicolon
id|pScsiTm-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
multiline_comment|/* 0 */
id|pScsiTm-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:semicolon
id|pScsiTm-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskType
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
suffix:semicolon
id|pScsiTm-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;MsgFlags
op_assign
id|MPI_SCSITASKMGMT_MSGFLAGS_LIPRESET_RESET_OPTION
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiTm-&gt;LUN
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|7
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiTm-&gt;Reserved2
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskMsgContext
op_assign
l_int|0
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;mptctl_bus_reset: issued.&bslash;n&quot;
comma
id|ioctl-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|DBG_DUMP_TM_REQUEST_FRAME
c_func
(paren
(paren
id|u32
op_star
)paren
id|mf
)paren
suffix:semicolon
id|ioctl-&gt;wait_done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|mpt_send_handshake_request
c_func
(paren
id|mptctl_id
comma
id|ioctl-&gt;ioc
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
(paren
id|u32
op_star
)paren
id|pScsiTm
comma
id|CAN_SLEEP
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dfailprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;_send_handshake FAILED!&quot;
l_string|&quot; (hd %p, ioc %p, mf %p) &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|hd
comma
id|hd-&gt;ioc
comma
id|mf
)paren
)paren
suffix:semicolon
r_goto
id|mptctl_bus_reset_done
suffix:semicolon
)brace
multiline_comment|/* Now wait for the command to complete */
id|ii
op_assign
id|wait_event_interruptible_timeout
c_func
(paren
id|mptctl_wait
comma
id|ioctl-&gt;wait_done
op_eq
l_int|1
comma
id|HZ
op_star
l_int|5
multiline_comment|/* 5 second timeout */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ii
op_le
l_int|0
op_logical_and
(paren
id|ioctl-&gt;wait_done
op_ne
l_int|1
)paren
)paren
(brace
id|ioctl-&gt;wait_done
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* return failure */
)brace
id|mptctl_bus_reset_done
suffix:colon
id|mpt_free_msg_frame
c_func
(paren
id|hd-&gt;ioc
comma
id|mf
)paren
suffix:semicolon
id|mptctl_free_tm_flags
c_func
(paren
id|ioctl-&gt;ioc
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|mptctl_set_tm_flags
id|mptctl_set_tm_flags
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmState
op_eq
id|TM_STATE_NONE
)paren
(brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_IN_PROGRESS
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|mptctl_free_tm_flags
id|mptctl_free_tm_flags
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* mptctl_ioc_reset&n; *&n; * Clean-up functionality. Used only if there has been a&n; * reload of the FW due.&n; *&n; */
r_static
r_int
DECL|function|mptctl_ioc_reset
id|mptctl_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
(brace
id|MPT_IOCTL
op_star
id|ioctl
op_assign
id|ioc-&gt;ioctl
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: IOC %s_reset routed to IOCTL driver!&bslash;n&quot;
comma
id|reset_phase
op_eq
id|MPT_IOC_SETUP_RESET
ques
c_cond
l_string|&quot;setup&quot;
suffix:colon
(paren
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
ques
c_cond
l_string|&quot;pre&quot;
suffix:colon
l_string|&quot;post&quot;
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|reset_phase
)paren
(brace
r_case
id|MPT_IOC_SETUP_RESET
suffix:colon
id|ioctl-&gt;status
op_or_assign
id|MPT_IOCTL_STATUS_DID_IOCRESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_IOC_POST_RESET
suffix:colon
id|ioctl-&gt;status
op_and_assign
op_complement
id|MPT_IOCTL_STATUS_DID_IOCRESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_IOC_PRE_RESET
suffix:colon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  MPT ioctl handler&n; *  cmd - specify the particular IOCTL command to be issued&n; *  arg - data specific to the command. Must not be null.&n; */
r_static
r_int
DECL|function|__mptctl_ioctl
id|__mptctl_ioctl
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|mpt_ioctl_header
id|__user
op_star
id|uhdr
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|mpt_ioctl_header
id|khdr
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|iocnumX
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_ioctl() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|khdr
comma
id|uhdr
comma
r_sizeof
(paren
id|khdr
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_ioctl() @%d - &quot;
l_string|&quot;Unable to copy mpt_ioctl_header data @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uhdr
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
multiline_comment|/* Verify intended MPT adapter - set iocnum and the adapter&n;&t; * pointer (iocp)&n;&t; */
id|iocnumX
op_assign
id|khdr.iocnum
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_ioctl() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnumX
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|iocp-&gt;active
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_ioctl() @%d - Controller disabled.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Handle those commands that are just returning&n;&t; * information stored in the driver.&n;&t; * These commands should never time out and are unaffected&n;&t; * by TM and FW reloads.&n;&t; */
r_if
c_cond
(paren
(paren
id|cmd
op_amp
op_complement
id|IOCSIZE_MASK
)paren
op_eq
(paren
id|MPTIOCINFO
op_amp
op_complement
id|IOCSIZE_MASK
)paren
)paren
(brace
r_return
id|mptctl_getiocinfo
c_func
(paren
id|arg
comma
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTTARGETINFO
)paren
(brace
r_return
id|mptctl_gettargetinfo
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTTEST
)paren
(brace
r_return
id|mptctl_readtest
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTEVENTQUERY
)paren
(brace
r_return
id|mptctl_eventquery
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTEVENTENABLE
)paren
(brace
r_return
id|mptctl_eventenable
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTEVENTREPORT
)paren
(brace
r_return
id|mptctl_eventreport
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTFWREPLACE
)paren
(brace
r_return
id|mptctl_replace_fw
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/* All of these commands require an interrupt or&n;&t; * are unknown/illegal.&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: mptctl_ioctl()&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTFWDOWNLOAD
)paren
id|ret
op_assign
id|mptctl_fw_download
c_func
(paren
id|arg
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTCOMMAND
)paren
id|ret
op_assign
id|mptctl_mpt_command
c_func
(paren
id|arg
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|MPTHARDRESET
)paren
id|ret
op_assign
id|mptctl_do_reset
c_func
(paren
id|arg
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|cmd
op_amp
op_complement
id|IOCSIZE_MASK
)paren
op_eq
(paren
id|HP_GETHOSTINFO
op_amp
op_complement
id|IOCSIZE_MASK
)paren
)paren
id|ret
op_assign
id|mptctl_hp_hostinfo
c_func
(paren
id|arg
comma
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|HP_GETTARGETINFO
)paren
id|ret
op_assign
id|mptctl_hp_targetinfo
c_func
(paren
id|arg
)paren
suffix:semicolon
r_else
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|up
c_func
(paren
op_amp
id|iocp-&gt;ioctl-&gt;sem_ioc
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|mptctl_ioctl
id|mptctl_ioctl
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ret
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|__mptctl_ioctl
c_func
(paren
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|mptctl_do_reset
r_static
r_int
id|mptctl_do_reset
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_diag_reset
id|__user
op_star
id|urinfo
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_diag_reset
id|krinfo
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;mptctl_do_reset called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|krinfo
comma
id|urinfo
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_diag_reset
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_reset - &quot;
l_string|&quot;Unable to copy mpt_ioctl_diag_reset struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|urinfo
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mpt_verify_adapter
c_func
(paren
id|krinfo.hdr.iocnum
comma
op_amp
id|iocp
)paren
OL
l_int|0
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_reset - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|krinfo.hdr.iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
)brace
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|iocp
comma
id|CAN_SLEEP
)paren
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_reset - reset failed.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * MPT FW download function.  Cast the arg into the mpt_fw_xfer structure.&n; * This structure contains: iocnum, firmware length (bytes),&n; *      pointer to user space memory where the fw image is stored.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENXIO  if no such device&n; *&t;&t;-EAGAIN if resource problem&n; *&t;&t;-ENOMEM if no memory for SGE&n; *&t;&t;-EMLINK if too many chain buffers required&n; *&t;&t;-EBADRQC if adapter does not support FW download&n; *&t;&t;-EBUSY if adapter is busy&n; *&t;&t;-ENOMSG if FW upload returned bad status&n; */
r_static
r_int
DECL|function|mptctl_fw_download
id|mptctl_fw_download
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_fw_xfer
id|__user
op_star
id|ufwdl
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_fw_xfer
id|kfwdl
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;mptctl_fwdl called. mptctl_id = %xh&bslash;n&quot;
comma
id|mptctl_id
)paren
)paren
suffix:semicolon
singleline_comment|//tc
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kfwdl
comma
id|ufwdl
comma
r_sizeof
(paren
r_struct
id|mpt_fw_xfer
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::_ioctl_fwdl - &quot;
l_string|&quot;Unable to copy mpt_fw_xfer struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|ufwdl
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|mptctl_do_fw_download
c_func
(paren
id|kfwdl.iocnum
comma
id|kfwdl.bufp
comma
id|kfwdl.fwlen
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * FW Download engine.&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENXIO  if no such device&n; *&t;&t;-EAGAIN if resource problem&n; *&t;&t;-ENOMEM if no memory for SGE&n; *&t;&t;-EMLINK if too many chain buffers required&n; *&t;&t;-EBADRQC if adapter does not support FW download&n; *&t;&t;-EBUSY if adapter is busy&n; *&t;&t;-ENOMSG if FW upload returned bad status&n; */
r_static
r_int
DECL|function|mptctl_do_fw_download
id|mptctl_do_fw_download
c_func
(paren
r_int
id|ioc
comma
r_char
id|__user
op_star
id|ufwbuf
comma
r_int
id|fwlen
)paren
(brace
id|FWDownload_t
op_star
id|dlmsg
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
suffix:semicolon
id|FWDownloadTCSGE_t
op_star
id|ptsge
suffix:semicolon
id|MptSge_t
op_star
id|sgl
comma
op_star
id|sgIn
suffix:semicolon
r_char
op_star
id|sgOut
suffix:semicolon
r_struct
id|buflist
op_star
id|buflist
suffix:semicolon
r_struct
id|buflist
op_star
id|bl
suffix:semicolon
id|dma_addr_t
id|sgl_dma
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|numfrags
op_assign
l_int|0
suffix:semicolon
r_int
id|maxfrags
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
id|u32
id|sgdir
suffix:semicolon
id|u32
id|nib
suffix:semicolon
r_int
id|fw_bytes_copied
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|sge_offset
op_assign
l_int|0
suffix:semicolon
id|u16
id|iocstat
suffix:semicolon
id|pFWDownloadReply_t
id|ReplyMsg
op_assign
l_int|NULL
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;mptctl_do_fwdl called. mptctl_id = %xh.&bslash;n&quot;
comma
id|mptctl_id
)paren
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.bufp  = %p&bslash;n&quot;
comma
id|ufwbuf
)paren
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.fwlen = %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|fwlen
)paren
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: kfwdl.ioc   = %04xh&bslash;n&quot;
comma
id|ioc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc
op_assign
id|mpt_verify_adapter
c_func
(paren
id|ioc
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;%s@%d::_ioctl_fwdl - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|ioc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* (-6) No such device or address */
)brace
multiline_comment|/*  Valid device. Get a message frame and construct the FW download message.&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mptctl_id
comma
id|iocp
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|dlmsg
op_assign
(paren
id|FWDownload_t
op_star
)paren
id|mf
suffix:semicolon
id|ptsge
op_assign
(paren
id|FWDownloadTCSGE_t
op_star
)paren
op_amp
id|dlmsg-&gt;SGL
suffix:semicolon
id|sgOut
op_assign
(paren
r_char
op_star
)paren
(paren
id|ptsge
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Construct f/w download request&n;&t; */
id|dlmsg-&gt;ImageType
op_assign
id|MPI_FW_DOWNLOAD_ITYPE_FW
suffix:semicolon
id|dlmsg-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;Function
op_assign
id|MPI_FUNCTION_FW_DOWNLOAD
suffix:semicolon
id|dlmsg-&gt;Reserved1
(braket
l_int|0
)braket
op_assign
id|dlmsg-&gt;Reserved1
(braket
l_int|1
)braket
op_assign
id|dlmsg-&gt;Reserved1
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|dlmsg-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set up the Transaction SGE.&n;&t; */
id|ptsge-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|ptsge-&gt;ContextSize
op_assign
l_int|0
suffix:semicolon
id|ptsge-&gt;DetailsLength
op_assign
l_int|12
suffix:semicolon
id|ptsge-&gt;Flags
op_assign
id|MPI_SGE_FLAGS_TRANSACTION_ELEMENT
suffix:semicolon
id|ptsge-&gt;Reserved_0100_Checksum
op_assign
l_int|0
suffix:semicolon
id|ptsge-&gt;ImageOffset
op_assign
l_int|0
suffix:semicolon
id|ptsge-&gt;ImageSize
op_assign
id|cpu_to_le32
c_func
(paren
id|fwlen
)paren
suffix:semicolon
multiline_comment|/* Add the SGL&n;&t; */
multiline_comment|/*&n;&t; * Need to kmalloc area(s) for holding firmware image bytes.&n;&t; * But we need to do it piece meal, using a proper&n;&t; * scatter gather list (with 128kB MAX hunks).&n;&t; *&n;&t; * A practical limit here might be # of sg hunks that fit into&n;&t; * a single IOC request frame; 12 or 8 (see below), so:&n;&t; * For FC9xx: 12 x 128kB == 1.5 mB (max)&n;&t; * For C1030:  8 x 128kB == 1   mB (max)&n;&t; * We could support chaining, but things get ugly(ier:)&n;&t; *&n;&t; * Set the sge_offset to the start of the sgl (bytes).&n;&t; */
id|sgdir
op_assign
l_int|0x04000000
suffix:semicolon
multiline_comment|/* IOC will READ from sys mem */
id|sge_offset
op_assign
r_sizeof
(paren
id|MPIHeader_t
)paren
op_plus
r_sizeof
(paren
id|FWDownloadTCSGE_t
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sgl
op_assign
id|kbuf_alloc_2_sgl
c_func
(paren
id|fwlen
comma
id|sgdir
comma
id|sge_offset
comma
op_amp
id|numfrags
comma
op_amp
id|buflist
comma
op_amp
id|sgl_dma
comma
id|iocp
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * We should only need SGL with 2 simple_32bit entries (up to 256 kB)&n;&t; * for FC9xx f/w image, but calculate max number of sge hunks&n;&t; * we can fit into a request frame, and limit ourselves to that.&n;&t; * (currently no chain support)&n;&t; * maxfrags = (Request Size - FWdownload Size ) / Size of 32 bit SGE&n;&t; *&t;Request&t;&t;maxfrags&n;&t; *&t;128&t;&t;12&n;&t; *&t;96&t;&t;8&n;&t; *&t;64&t;&t;4&n;&t; */
id|maxfrags
op_assign
(paren
id|iocp-&gt;req_sz
op_minus
r_sizeof
(paren
id|MPIHeader_t
)paren
op_minus
r_sizeof
(paren
id|FWDownloadTCSGE_t
)paren
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|numfrags
OG
id|maxfrags
)paren
(brace
id|ret
op_assign
op_minus
id|EMLINK
suffix:semicolon
r_goto
id|fwdl_out
suffix:semicolon
)brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;DbG: sgl buffer  = %p, sgfrags = %d&bslash;n&quot;
comma
id|sgl
comma
id|numfrags
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Parse SG list, copying sgl itself,&n;&t; * plus f/w image hunks from user space as we go...&n;&t; */
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|sgIn
op_assign
id|sgl
suffix:semicolon
id|bl
op_assign
id|buflist
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numfrags
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Get the SGE type: 0 - TCSGE, 3 - Chain, 1 - Simple SGE&n;&t;&t; * Skip everything but Simple. If simple, copy from&n;&t;&t; *&t;user space into kernel space.&n;&t;&t; * Note: we should not have anything but Simple as&n;&t;&t; *&t;Chain SGE are illegal.&n;&t;&t; */
id|nib
op_assign
(paren
id|sgIn-&gt;FlagsLength
op_amp
l_int|0x30000000
)paren
op_rshift
l_int|28
suffix:semicolon
r_if
c_cond
(paren
id|nib
op_eq
l_int|0
op_logical_or
id|nib
op_eq
l_int|3
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sgIn-&gt;Address
)paren
(brace
id|mpt_add_sge
c_func
(paren
id|sgOut
comma
id|sgIn-&gt;FlagsLength
comma
id|sgIn-&gt;Address
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|bl-&gt;kptr
comma
id|ufwbuf
op_plus
id|fw_bytes_copied
comma
id|bl-&gt;len
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::_ioctl_fwdl - &quot;
l_string|&quot;Unable to copy f/w buffer hunk#%d @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|n
comma
id|ufwbuf
)paren
suffix:semicolon
r_goto
id|fwdl_out
suffix:semicolon
)brace
id|fw_bytes_copied
op_add_assign
id|bl-&gt;len
suffix:semicolon
)brace
id|sgIn
op_increment
suffix:semicolon
id|bl
op_increment
suffix:semicolon
id|sgOut
op_add_assign
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MPT_DEBUG
(brace
id|u32
op_star
id|m
op_assign
(paren
id|u32
op_star
)paren
id|mf
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: F/W download request:&bslash;n&quot;
id|KERN_INFO
l_string|&quot; &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
op_plus
id|numfrags
op_star
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|m
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Finally, perform firmware download.&n;&t; */
id|iocp-&gt;ioctl-&gt;wait_done
op_assign
l_int|0
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|mptctl_id
comma
id|iocp
comma
id|mf
)paren
suffix:semicolon
multiline_comment|/* Now wait for the command to complete */
id|ret
op_assign
id|wait_event_interruptible_timeout
c_func
(paren
id|mptctl_wait
comma
id|iocp-&gt;ioctl-&gt;wait_done
op_eq
l_int|1
comma
id|HZ
op_star
l_int|60
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_le
l_int|0
op_logical_and
(paren
id|iocp-&gt;ioctl-&gt;wait_done
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/* Now we need to reset the board */
id|mptctl_timeout_expired
c_func
(paren
id|iocp-&gt;ioctl
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|fwdl_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sgl
)paren
id|kfree_sgl
c_func
(paren
id|sgl
comma
id|sgl_dma
comma
id|buflist
comma
id|iocp
)paren
suffix:semicolon
id|ReplyMsg
op_assign
(paren
id|pFWDownloadReply_t
)paren
id|iocp-&gt;ioctl-&gt;ReplyFrame
suffix:semicolon
id|iocstat
op_assign
id|le16_to_cpu
c_func
(paren
id|ReplyMsg-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_SUCCESS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: F/W update successfully sent to %s!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_INVALID_FUNCTION
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: ?Hmmm...  %s says it doesn&squot;t support F/W download!?!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (time to go bang on somebodies door)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADRQC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|iocstat
op_eq
id|MPI_IOCSTATUS_BUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Warning!  %s says: IOC_BUSY!&bslash;n&quot;
comma
id|iocp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (try again later?)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;::ioctl_fwdl() ERROR!  %s returned [bad] status = %04xh&bslash;n&quot;
comma
id|iocp-&gt;name
comma
id|iocstat
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: (bad VooDoo)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMSG
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|fwdl_out
suffix:colon
id|kfree_sgl
c_func
(paren
id|sgl
comma
id|sgl_dma
comma
id|buflist
comma
id|iocp
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * SGE Allocation routine&n; *&n; * Inputs:&t;bytes - number of bytes to be transferred&n; *&t;&t;sgdir - data direction&n; *&t;&t;sge_offset - offset (in bytes) from the start of the request&n; *&t;&t;&t;frame to the first SGE&n; *&t;&t;ioc - pointer to the mptadapter&n; * Outputs:&t;frags - number of scatter gather elements&n; *&t;&t;blp - point to the buflist pointer&n; *&t;&t;sglbuf_dma - pointer to the (dma) sgl&n; * Returns:&t;Null if failes&n; *&t;&t;pointer to the (virtual) sgl if successful.&n; */
r_static
id|MptSge_t
op_star
DECL|function|kbuf_alloc_2_sgl
id|kbuf_alloc_2_sgl
c_func
(paren
r_int
id|bytes
comma
id|u32
id|sgdir
comma
r_int
id|sge_offset
comma
r_int
op_star
id|frags
comma
r_struct
id|buflist
op_star
op_star
id|blp
comma
id|dma_addr_t
op_star
id|sglbuf_dma
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MptSge_t
op_star
id|sglbuf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to array of SGE */
multiline_comment|/* and chain buffers */
r_struct
id|buflist
op_star
id|buflist
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* kernel routine */
id|MptSge_t
op_star
id|sgl
suffix:semicolon
r_int
id|numfrags
op_assign
l_int|0
suffix:semicolon
r_int
id|fragcnt
op_assign
l_int|0
suffix:semicolon
r_int
id|alloc_sz
op_assign
id|min
c_func
(paren
id|bytes
comma
id|MAX_KMALLOC_SZ
)paren
suffix:semicolon
singleline_comment|// avoid kernel warning msg!
r_int
id|bytes_allocd
op_assign
l_int|0
suffix:semicolon
r_int
id|this_alloc
suffix:semicolon
id|dma_addr_t
id|pa
suffix:semicolon
singleline_comment|// phys addr
r_int
id|i
comma
id|buflist_ent
suffix:semicolon
r_int
id|sg_spill
op_assign
id|MAX_FRAGS_SPILL1
suffix:semicolon
r_int
id|dir
suffix:semicolon
multiline_comment|/* initialization */
op_star
id|frags
op_assign
l_int|0
suffix:semicolon
op_star
id|blp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Allocate and initialize an array of kernel&n;&t; * structures for the SG elements.&n;&t; */
id|i
op_assign
id|MAX_SGL_BYTES
op_div
l_int|8
suffix:semicolon
id|buflist
op_assign
id|kmalloc
c_func
(paren
id|i
comma
id|GFP_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflist
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|buflist
comma
l_int|0
comma
id|i
)paren
suffix:semicolon
id|buflist_ent
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allocate a single block of memory to store the sg elements and&n;&t; * the chain buffers.  The calling routine is responsible for&n;&t; * copying the data in this array into the correct place in the&n;&t; * request and chain buffers.&n;&t; */
id|sglbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sglbuf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sglbuf
op_eq
l_int|NULL
)paren
r_goto
id|free_and_fail
suffix:semicolon
r_if
c_cond
(paren
id|sgdir
op_amp
l_int|0x04000000
)paren
id|dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_else
id|dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
multiline_comment|/* At start:&n;&t; *&t;sgl = sglbuf = point to beginning of sg buffer&n;&t; *&t;buflist_ent = 0 = first kernel structure&n;&t; *&t;sg_spill = number of SGE that can be written before the first&n;&t; *&t;&t;chain element.&n;&t; *&n;&t; */
id|sgl
op_assign
id|sglbuf
suffix:semicolon
id|sg_spill
op_assign
(paren
(paren
id|ioc-&gt;req_sz
op_minus
id|sge_offset
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
)paren
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|bytes_allocd
OL
id|bytes
)paren
(brace
id|this_alloc
op_assign
id|min
c_func
(paren
id|alloc_sz
comma
id|bytes
op_minus
id|bytes_allocd
)paren
suffix:semicolon
id|buflist
(braket
id|buflist_ent
)braket
dot
id|len
op_assign
id|this_alloc
suffix:semicolon
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|this_alloc
comma
op_amp
id|pa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
op_eq
l_int|NULL
)paren
(brace
id|alloc_sz
op_assign
id|alloc_sz
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|alloc_sz
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: No can do - &quot;
l_string|&quot;not enough memory!   :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: (freeing %d frags)&bslash;n&quot;
comma
id|numfrags
)paren
suffix:semicolon
r_goto
id|free_and_fail
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_else
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|bytes_allocd
op_add_assign
id|this_alloc
suffix:semicolon
id|sgl-&gt;FlagsLength
op_assign
(paren
l_int|0x10000000
op_or
id|MPT_SGE_FLAGS_ADDRESSING
op_or
id|sgdir
op_or
id|this_alloc
)paren
suffix:semicolon
id|dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|buflist
(braket
id|buflist_ent
)braket
dot
id|kptr
comma
id|this_alloc
comma
id|dir
)paren
suffix:semicolon
id|sgl-&gt;Address
op_assign
id|dma_addr
suffix:semicolon
id|fragcnt
op_increment
suffix:semicolon
id|numfrags
op_increment
suffix:semicolon
id|sgl
op_increment
suffix:semicolon
id|buflist_ent
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bytes_allocd
op_ge
id|bytes
)paren
r_break
suffix:semicolon
multiline_comment|/* Need to chain? */
r_if
c_cond
(paren
id|fragcnt
op_eq
id|sg_spill
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: No can do - &quot;
l_string|&quot;Chain required!   :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;(freeing %d frags)&bslash;n&quot;
comma
id|numfrags
)paren
suffix:semicolon
r_goto
id|free_and_fail
suffix:semicolon
)brace
multiline_comment|/* overflow check... */
r_if
c_cond
(paren
id|numfrags
op_star
l_int|8
OG
id|MAX_SGL_BYTES
)paren
(brace
multiline_comment|/* GRRRRR... */
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: No can do - &quot;
l_string|&quot;too many SG frags!   :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;-SG: (freeing %d frags)&bslash;n&quot;
comma
id|numfrags
)paren
suffix:semicolon
r_goto
id|free_and_fail
suffix:semicolon
)brace
)brace
multiline_comment|/* Last sge fixup: set LE+eol+eob bits */
id|sgl
(braket
op_minus
l_int|1
)braket
dot
id|FlagsLength
op_or_assign
l_int|0xC1000000
suffix:semicolon
op_star
id|frags
op_assign
id|numfrags
suffix:semicolon
op_star
id|blp
op_assign
id|buflist
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: kbuf_alloc_2_sgl() - &quot;
l_string|&quot;%d SG frags generated!&bslash;n&quot;
comma
id|numfrags
)paren
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: kbuf_alloc_2_sgl() - &quot;
l_string|&quot;last (big) alloc_sz=%d&bslash;n&quot;
comma
id|alloc_sz
)paren
)paren
suffix:semicolon
r_return
id|sglbuf
suffix:semicolon
id|free_and_fail
suffix:colon
r_if
c_cond
(paren
id|sglbuf
op_ne
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numfrags
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|u8
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sglbuf
(braket
id|i
)braket
dot
id|FlagsLength
op_rshift
l_int|24
)paren
op_eq
l_int|0x30
)paren
r_continue
suffix:semicolon
id|dma_addr
op_assign
id|sglbuf
(braket
id|i
)braket
dot
id|Address
suffix:semicolon
id|kptr
op_assign
id|buflist
(braket
id|i
)braket
dot
id|kptr
suffix:semicolon
id|len
op_assign
id|buflist
(braket
id|i
)braket
dot
id|len
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sglbuf
comma
op_star
id|sglbuf_dma
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buflist
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Routine to free the SGL elements.&n; */
r_static
r_void
DECL|function|kfree_sgl
id|kfree_sgl
c_func
(paren
id|MptSge_t
op_star
id|sgl
comma
id|dma_addr_t
id|sgl_dma
comma
r_struct
id|buflist
op_star
id|buflist
comma
id|MPT_ADAPTER
op_star
id|ioc
)paren
(brace
id|MptSge_t
op_star
id|sg
op_assign
id|sgl
suffix:semicolon
r_struct
id|buflist
op_star
id|bl
op_assign
id|buflist
suffix:semicolon
id|u32
id|nib
suffix:semicolon
r_int
id|dir
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sg-&gt;FlagsLength
op_amp
l_int|0x04000000
)paren
id|dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_else
id|dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
id|nib
op_assign
(paren
id|sg-&gt;FlagsLength
op_amp
l_int|0xF0000000
)paren
op_rshift
l_int|28
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|nib
op_amp
l_int|0x4
)paren
)paren
(brace
multiline_comment|/* eob */
multiline_comment|/* skip ignore/chain. */
r_if
c_cond
(paren
id|nib
op_eq
l_int|0
op_logical_or
id|nib
op_eq
l_int|3
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sg-&gt;Address
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_void
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
id|dma_addr
op_assign
id|sg-&gt;Address
suffix:semicolon
id|kptr
op_assign
id|bl-&gt;kptr
suffix:semicolon
id|len
op_assign
id|bl-&gt;len
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dma_addr
comma
id|len
comma
id|dir
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
id|sg
op_increment
suffix:semicolon
id|bl
op_increment
suffix:semicolon
id|nib
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|sg-&gt;FlagsLength
)paren
op_amp
l_int|0xF0000000
)paren
op_rshift
l_int|28
suffix:semicolon
)brace
multiline_comment|/* we&squot;re at eob! */
r_if
c_cond
(paren
id|sg-&gt;Address
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_void
op_star
id|kptr
suffix:semicolon
r_int
id|len
suffix:semicolon
id|dma_addr
op_assign
id|sg-&gt;Address
suffix:semicolon
id|kptr
op_assign
id|bl-&gt;kptr
suffix:semicolon
id|len
op_assign
id|bl-&gt;len
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dma_addr
comma
id|len
comma
id|dir
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|len
comma
id|kptr
comma
id|dma_addr
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|MAX_SGL_BYTES
comma
id|sgl
comma
id|sgl_dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buflist
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;-SG: Free&squot;d 1 SGL buf + %d kbufs!&bslash;n&quot;
comma
id|n
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptctl_getiocinfo - Query the host adapter for IOC information.&n; *&t;@arg: User space argument&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV  if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_getiocinfo
id|mptctl_getiocinfo
(paren
r_int
r_int
id|arg
comma
r_int
r_int
id|data_size
)paren
(brace
r_struct
id|mpt_ioctl_iocinfo
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_iocinfo
op_star
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|numDevices
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|max_id
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|port
suffix:semicolon
r_int
id|cim_rev
suffix:semicolon
id|u8
id|revision
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_getiocinfo called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Add of PCI INFO results in unaligned access for&n;&t; * IA64 and Sparc. Reset long to int. Return no PCI&n;&t; * data for obsolete format.&n;&t; */
r_if
c_cond
(paren
id|data_size
op_eq
r_sizeof
(paren
r_struct
id|mpt_ioctl_iocinfo_rev0
)paren
)paren
id|cim_rev
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|data_size
op_eq
r_sizeof
(paren
r_struct
id|mpt_ioctl_iocinfo_rev1
)paren
)paren
id|cim_rev
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|data_size
op_eq
r_sizeof
(paren
r_struct
id|mpt_ioctl_iocinfo
)paren
)paren
id|cim_rev
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|data_size
op_eq
(paren
r_sizeof
(paren
r_struct
id|mpt_ioctl_iocinfo_rev0
)paren
op_plus
l_int|12
)paren
)paren
id|cim_rev
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* obsolete */
r_else
r_return
op_minus
id|EFAULT
suffix:semicolon
id|karg
op_assign
id|kmalloc
c_func
(paren
id|data_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|karg
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mpt_ioctl_iocinfo() @%d - no memory available!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|karg
comma
id|uarg
comma
id|data_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_getiocinfo - &quot;
l_string|&quot;Unable to read in mpt_ioctl_iocinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|karg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg-&gt;hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_getiocinfo() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|karg
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Verify the data transfer size is correct.&n;&t; * Ignore the port setting.&n;&t; */
r_if
c_cond
(paren
id|karg-&gt;hdr.maxDataSize
op_ne
id|data_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_getiocinfo - &quot;
l_string|&quot;Structure size mismatch. Command not completed.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|karg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Fill in the data and return the structure to the calling&n;&t; * program&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|FC
)paren
id|karg-&gt;adapterType
op_assign
id|MPT_IOCTL_INTERFACE_FC
suffix:semicolon
r_else
id|karg-&gt;adapterType
op_assign
id|MPT_IOCTL_INTERFACE_SCSI
suffix:semicolon
id|port
op_assign
id|karg-&gt;hdr.port
suffix:semicolon
id|karg-&gt;port
op_assign
id|port
suffix:semicolon
id|pdev
op_assign
(paren
r_struct
id|pci_dev
op_star
)paren
id|ioc-&gt;pcidev
suffix:semicolon
id|karg-&gt;pciId
op_assign
id|pdev-&gt;device
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|revision
)paren
suffix:semicolon
id|karg-&gt;hwRev
op_assign
id|revision
suffix:semicolon
id|karg-&gt;subSystemDevice
op_assign
id|pdev-&gt;subsystem_device
suffix:semicolon
id|karg-&gt;subSystemVendor
op_assign
id|pdev-&gt;subsystem_vendor
suffix:semicolon
r_if
c_cond
(paren
id|cim_rev
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Get the PCI bus, device, and function numbers for the IOC&n;&t;&t; */
id|karg-&gt;pciInfo.u.bits.busNumber
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|karg-&gt;pciInfo.u.bits.deviceNumber
op_assign
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|karg-&gt;pciInfo.u.bits.functionNumber
op_assign
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cim_rev
op_eq
l_int|2
)paren
(brace
multiline_comment|/* Get the PCI bus, device, function and segment ID numbers &n;&t;&t;   for the IOC */
id|karg-&gt;pciInfo.u.bits.busNumber
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|karg-&gt;pciInfo.u.bits.deviceNumber
op_assign
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|karg-&gt;pciInfo.u.bits.functionNumber
op_assign
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|karg-&gt;pciInfo.u.bits.functionNumber
op_assign
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|karg-&gt;pciInfo.segmentID
op_assign
id|pci_domain_nr
c_func
(paren
id|pdev-&gt;bus
)paren
suffix:semicolon
)brace
multiline_comment|/* Get number of devices&n;         */
r_if
c_cond
(paren
(paren
id|sh
op_assign
id|ioc-&gt;sh
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* sh-&gt;max_id = maximum target ID + 1&n;&t;&t; */
id|max_id
op_assign
id|sh-&gt;max_id
op_minus
l_int|1
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
multiline_comment|/* Check all of the target structures and&n;&t;&t; * keep a counter.&n;&t;&t; */
r_if
c_cond
(paren
id|hd
op_logical_and
id|hd-&gt;Targets
)paren
(brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
op_le
id|max_id
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;Targets
(braket
id|ii
)braket
)paren
id|numDevices
op_increment
suffix:semicolon
)brace
)brace
)brace
id|karg-&gt;numDevices
op_assign
id|numDevices
suffix:semicolon
multiline_comment|/* Set the BIOS and FW Version&n;&t; */
id|karg-&gt;FWVersion
op_assign
id|ioc-&gt;facts.FWVersion.Word
suffix:semicolon
id|karg-&gt;BIOSVersion
op_assign
id|ioc-&gt;biosVersion
suffix:semicolon
multiline_comment|/* Set the Version Strings.&n;&t; */
id|strncpy
(paren
id|karg-&gt;driverVersion
comma
id|MPT_LINUX_PACKAGE_NAME
comma
id|MPT_IOCTL_VERSION_LENGTH
)paren
suffix:semicolon
id|karg-&gt;driverVersion
(braket
id|MPT_IOCTL_VERSION_LENGTH
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|karg-&gt;busChangeEvent
op_assign
l_int|0
suffix:semicolon
id|karg-&gt;hostId
op_assign
id|ioc-&gt;pfacts
(braket
id|port
)braket
dot
id|PortSCSIID
suffix:semicolon
id|karg-&gt;rsvd
(braket
l_int|0
)braket
op_assign
id|karg-&gt;rsvd
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
id|__user
op_star
)paren
id|arg
comma
id|karg
comma
id|data_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_getiocinfo - &quot;
l_string|&quot;Unable to write out mpt_ioctl_iocinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|karg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|karg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptctl_gettargetinfo - Query the host adapter for target information.&n; *&t;@arg: User space argument&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV  if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_gettargetinfo
id|mptctl_gettargetinfo
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_targetinfo
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_targetinfo
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|VirtDevice
op_star
id|vdev
suffix:semicolon
r_char
op_star
id|pmem
suffix:semicolon
r_int
op_star
id|pdata
suffix:semicolon
id|IOCPage2_t
op_star
id|pIoc2
suffix:semicolon
id|IOCPage3_t
op_star
id|pIoc3
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|numDevices
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|max_id
suffix:semicolon
r_int
id|id
comma
id|jj
comma
id|indexed_lun
comma
id|lun_index
suffix:semicolon
id|u32
id|lun
suffix:semicolon
r_int
id|maxWordsLeft
suffix:semicolon
r_int
id|numBytes
suffix:semicolon
id|u8
id|port
comma
id|devType
comma
id|bus_id
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_gettargetinfo called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_targetinfo
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_gettargetinfo - &quot;
l_string|&quot;Unable to read in mpt_ioctl_targetinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_gettargetinfo() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Get the port number and set the maximum number of bytes&n;&t; * in the returned structure.&n;&t; * Ignore the port setting.&n;&t; */
id|numBytes
op_assign
id|karg.hdr.maxDataSize
op_minus
r_sizeof
(paren
id|mpt_ioctl_header
)paren
suffix:semicolon
id|maxWordsLeft
op_assign
id|numBytes
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|port
op_assign
id|karg.hdr.port
suffix:semicolon
r_if
c_cond
(paren
id|maxWordsLeft
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_gettargetinfo() @%d - no memory available!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Fill in the data and return the structure to the calling&n;&t; * program&n;&t; */
multiline_comment|/* struct mpt_ioctl_targetinfo does not contain sufficient space&n;&t; * for the target structures so when the IOCTL is called, there is&n;&t; * not sufficient stack space for the structure. Allocate memory,&n;&t; * populate the memory, copy back to the user, then free memory.&n;&t; * targetInfo format:&n;&t; * bits 31-24: reserved&n;&t; *      23-16: LUN&n;&t; *      15- 8: Bus Number&n;&t; *       7- 0: Target ID&n;&t; */
id|pmem
op_assign
id|kmalloc
c_func
(paren
id|numBytes
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmem
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_gettargetinfo() @%d - no memory available!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pmem
comma
l_int|0
comma
id|numBytes
)paren
suffix:semicolon
id|pdata
op_assign
(paren
r_int
op_star
)paren
id|pmem
suffix:semicolon
multiline_comment|/* Get number of devices&n;         */
r_if
c_cond
(paren
(paren
id|sh
op_assign
id|ioc-&gt;sh
)paren
op_ne
l_int|NULL
)paren
(brace
id|max_id
op_assign
id|sh-&gt;max_id
op_minus
l_int|1
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
multiline_comment|/* Check all of the target structures.&n;&t;&t; * Save the Id and increment the counter,&n;&t;&t; * if ptr non-null.&n;&t;&t; * sh-&gt;max_id = maximum target ID + 1&n;&t;&t; */
r_if
c_cond
(paren
id|hd
op_logical_and
id|hd-&gt;Targets
)paren
(brace
id|mpt_findImVolumes
c_func
(paren
id|ioc
)paren
suffix:semicolon
id|pIoc2
op_assign
id|ioc-&gt;spi_data.pIocPg2
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
op_le
id|max_id
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|pIoc2
op_logical_and
id|pIoc2-&gt;NumActiveVolumes
)paren
(brace
r_if
c_cond
(paren
id|id
op_eq
id|pIoc2-&gt;RaidVolume
(braket
l_int|0
)braket
dot
id|VolumeID
)paren
(brace
r_if
c_cond
(paren
id|maxWordsLeft
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mptctl_gettargetinfo - &quot;
l_string|&quot;buffer is full but volume is available on ioc %d&bslash;n, numDevices=%d&quot;
comma
id|iocnum
comma
id|numDevices
)paren
suffix:semicolon
r_goto
id|data_space_full
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pIoc2-&gt;RaidVolume
(braket
l_int|0
)braket
dot
id|Flags
op_amp
id|MPI_IOCPAGE2_FLAG_VOLUME_INACTIVE
)paren
op_eq
l_int|0
)paren
id|devType
op_assign
l_int|0x80
suffix:semicolon
r_else
id|devType
op_assign
l_int|0xC0
suffix:semicolon
id|bus_id
op_assign
id|pIoc2-&gt;RaidVolume
(braket
l_int|0
)braket
dot
id|VolumeBus
suffix:semicolon
id|numDevices
op_increment
suffix:semicolon
op_star
id|pdata
op_assign
(paren
(paren
id|devType
op_lshift
l_int|24
)paren
op_or
(paren
id|bus_id
op_lshift
l_int|8
)paren
op_or
id|id
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;mptctl_gettargetinfo - &quot;
l_string|&quot;volume ioc=%d target=%x numDevices=%d pdata=%p&bslash;n&quot;
comma
id|iocnum
comma
op_star
id|pdata
comma
id|numDevices
comma
id|pdata
)paren
)paren
suffix:semicolon
id|pdata
op_increment
suffix:semicolon
op_decrement
id|maxWordsLeft
suffix:semicolon
r_goto
id|next_id
suffix:semicolon
)brace
r_else
(brace
id|pIoc3
op_assign
id|ioc-&gt;spi_data.pIocPg3
suffix:semicolon
r_for
c_loop
(paren
id|jj
op_assign
l_int|0
suffix:semicolon
id|jj
OL
id|pIoc3-&gt;NumPhysDisks
suffix:semicolon
id|jj
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pIoc3-&gt;PhysDisk
(braket
id|jj
)braket
dot
id|PhysDiskID
op_eq
id|id
)paren
r_goto
id|next_id
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|vdev
op_assign
id|hd-&gt;Targets
(braket
id|id
)braket
)paren
)paren
(brace
r_for
c_loop
(paren
id|jj
op_assign
l_int|0
suffix:semicolon
id|jj
op_le
id|MPT_LAST_LUN
suffix:semicolon
id|jj
op_increment
)paren
(brace
id|lun_index
op_assign
(paren
id|jj
op_rshift
l_int|5
)paren
suffix:semicolon
id|indexed_lun
op_assign
(paren
id|jj
op_mod
l_int|32
)paren
suffix:semicolon
id|lun
op_assign
(paren
l_int|1
op_lshift
id|indexed_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vdev-&gt;luns
(braket
id|lun_index
)braket
op_amp
id|lun
)paren
(brace
r_if
c_cond
(paren
id|maxWordsLeft
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mptctl_gettargetinfo - &quot;
l_string|&quot;buffer is full but more targets are available on ioc %d numDevices=%d&bslash;n&quot;
comma
id|iocnum
comma
id|numDevices
)paren
suffix:semicolon
r_goto
id|data_space_full
suffix:semicolon
)brace
id|bus_id
op_assign
id|vdev-&gt;bus_id
suffix:semicolon
id|numDevices
op_increment
suffix:semicolon
op_star
id|pdata
op_assign
(paren
(paren
id|jj
op_lshift
l_int|16
)paren
op_or
(paren
id|bus_id
op_lshift
l_int|8
)paren
op_or
id|id
)paren
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;mptctl_gettargetinfo - &quot;
l_string|&quot;target ioc=%d target=%x numDevices=%d pdata=%p&bslash;n&quot;
comma
id|iocnum
comma
op_star
id|pdata
comma
id|numDevices
comma
id|pdata
)paren
)paren
suffix:semicolon
id|pdata
op_increment
suffix:semicolon
op_decrement
id|maxWordsLeft
suffix:semicolon
)brace
)brace
)brace
id|next_id
suffix:colon
id|id
op_increment
suffix:semicolon
)brace
)brace
)brace
id|data_space_full
suffix:colon
id|karg.numDevices
op_assign
id|numDevices
suffix:semicolon
multiline_comment|/* Copy part of the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
id|__user
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_targetinfo
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_gettargetinfo - &quot;
l_string|&quot;Unable to write out mpt_ioctl_targetinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pmem
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Copy the remaining data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|uarg-&gt;targetInfo
comma
id|pmem
comma
id|numBytes
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_gettargetinfo - &quot;
l_string|&quot;Unable to write out mpt_ioctl_targetinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|pdata
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pmem
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|pmem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* MPT IOCTL Test function.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV  if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_readtest
id|mptctl_readtest
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_test
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_test
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_readtest called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_test
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_readtest - &quot;
l_string|&quot;Unable to read in mpt_ioctl_test struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_readtest() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Fill in the data and return the structure to the calling&n;&t; * program&n;&t; */
macro_line|#ifdef MFCNT
id|karg.chip_type
op_assign
id|ioc-&gt;mfcnt
suffix:semicolon
macro_line|#else
id|karg.chip_type
op_assign
id|ioc-&gt;pcidev-&gt;device
suffix:semicolon
macro_line|#endif
id|strncpy
(paren
id|karg.name
comma
id|ioc-&gt;name
comma
id|MPT_MAX_NAME
)paren
suffix:semicolon
id|karg.name
(braket
id|MPT_MAX_NAME
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
(paren
id|karg.product
comma
id|ioc-&gt;prod_name
comma
id|MPT_PRODUCT_LENGTH
)paren
suffix:semicolon
id|karg.product
(braket
id|MPT_PRODUCT_LENGTH
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
id|__user
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_test
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_readtest - &quot;
l_string|&quot;Unable to write out mpt_ioctl_test struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptctl_eventquery - Query the host adapter for the event types&n; *&t;that are being logged.&n; *&t;@arg: User space argument&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV  if no such device/adapter&n; */
r_static
r_int
DECL|function|mptctl_eventquery
id|mptctl_eventquery
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_eventquery
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_eventquery
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_eventquery called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_eventquery
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventquery - &quot;
l_string|&quot;Unable to read in mpt_ioctl_eventquery struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_eventquery() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|karg.eventEntries
op_assign
id|ioc-&gt;eventLogSize
suffix:semicolon
id|karg.eventTypes
op_assign
id|ioc-&gt;eventTypes
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
id|__user
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_eventquery
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventquery - &quot;
l_string|&quot;Unable to write out mpt_ioctl_eventquery struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptctl_eventenable
id|mptctl_eventenable
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_eventenable
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_eventenable
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_eventenable called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_eventenable
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventenable - &quot;
l_string|&quot;Unable to read in mpt_ioctl_eventenable struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_eventenable() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;events
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Have not yet allocated memory - do so now.&n;&t;&t; */
r_int
id|sz
op_assign
id|MPTCTL_EVENT_LOG_SIZE
op_star
r_sizeof
(paren
id|MPT_IOCTL_EVENTS
)paren
suffix:semicolon
id|ioc-&gt;events
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;events
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Insufficient memory to add adapter!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ioc-&gt;events
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|ioc-&gt;alloc_total
op_add_assign
id|sz
suffix:semicolon
id|ioc-&gt;eventLogSize
op_assign
id|MPTCTL_EVENT_LOG_SIZE
suffix:semicolon
id|ioc-&gt;eventContext
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Update the IOC event logging flag.&n;&t; */
id|ioc-&gt;eventTypes
op_assign
id|karg.eventTypes
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptctl_eventreport
id|mptctl_eventreport
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_eventreport
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_eventreport
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|numBytes
comma
id|maxEvents
comma
id|max
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_eventreport called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_eventreport
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventreport - &quot;
l_string|&quot;Unable to read in mpt_ioctl_eventreport struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_eventreport() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|numBytes
op_assign
id|karg.hdr.maxDataSize
op_minus
r_sizeof
(paren
id|mpt_ioctl_header
)paren
suffix:semicolon
id|maxEvents
op_assign
id|numBytes
op_div
r_sizeof
(paren
id|MPT_IOCTL_EVENTS
)paren
suffix:semicolon
id|max
op_assign
id|ioc-&gt;eventLogSize
OL
id|maxEvents
ques
c_cond
id|ioc-&gt;eventLogSize
suffix:colon
id|maxEvents
suffix:semicolon
multiline_comment|/* If fewer than 1 event is requested, there must have&n;&t; * been some type of error.&n;&t; */
r_if
c_cond
(paren
(paren
id|max
OL
l_int|1
)paren
op_logical_or
op_logical_neg
id|ioc-&gt;events
)paren
r_return
op_minus
id|ENODATA
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
id|numBytes
op_assign
id|max
op_star
r_sizeof
(paren
id|MPT_IOCTL_EVENTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|uarg-&gt;eventData
comma
id|ioc-&gt;events
comma
id|numBytes
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_eventreport - &quot;
l_string|&quot;Unable to write out mpt_ioctl_eventreport struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|ioc-&gt;events
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptctl_replace_fw
id|mptctl_replace_fw
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_replace_fw
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_replace_fw
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|newFwSize
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_replace_fw called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_replace_fw
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_replace_fw - &quot;
l_string|&quot;Unable to read in mpt_ioctl_replace_fw struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_replace_fw() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* If caching FW, Free the old FW image&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|mpt_free_fw_memory
c_func
(paren
id|ioc
)paren
suffix:semicolon
multiline_comment|/* Allocate memory for the new FW image&n;&t; */
id|newFwSize
op_assign
id|karg.newImageSize
suffix:semicolon
r_if
c_cond
(paren
id|newFwSize
op_amp
l_int|0x01
)paren
id|newFwSize
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|newFwSize
op_amp
l_int|0x02
)paren
id|newFwSize
op_add_assign
l_int|2
suffix:semicolon
id|mpt_alloc_fw_memory
c_func
(paren
id|ioc
comma
id|newFwSize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;cached_fw
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Copy the data from user memory to kernel space&n;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|ioc-&gt;cached_fw
comma
id|uarg-&gt;newImage
comma
id|newFwSize
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_replace_fw - &quot;
l_string|&quot;Unable to read in mpt_ioctl_replace_fw image &quot;
l_string|&quot;@ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
id|mpt_free_fw_memory
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Update IOCFactsReply&n;&t; */
id|ioc-&gt;facts.FWImageSize
op_assign
id|newFwSize
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* MPT IOCTL MPTCOMMAND function.&n; * Cast the arg into the mpt_ioctl_mpt_command structure.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; *&t;&t;-ENOMEM if memory allocation error&n; */
r_static
r_int
DECL|function|mptctl_mpt_command
id|mptctl_mpt_command
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_command
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_command
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_command called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
r_struct
id|mpt_ioctl_command
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_mpt_command - &quot;
l_string|&quot;Unable to read in mpt_ioctl_command struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_mpt_command() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|mptctl_do_mpt_command
(paren
id|karg
comma
op_amp
id|uarg-&gt;MF
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Worker routine for the IOCTL MPTCOMMAND and MPTCOMMAND32 (sparc) commands.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; *&t;&t;-ENOMEM if memory allocation error&n; *&t;&t;-EPERM if SCSI I/O and target is untagged&n; */
r_static
r_int
DECL|function|mptctl_do_mpt_command
id|mptctl_do_mpt_command
(paren
r_struct
id|mpt_ioctl_command
id|karg
comma
r_void
id|__user
op_star
id|mfPtr
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|MPIHeader_t
op_star
id|hdr
suffix:semicolon
r_char
op_star
id|psge
suffix:semicolon
r_struct
id|buflist
id|bufIn
suffix:semicolon
multiline_comment|/* data In buffer */
r_struct
id|buflist
id|bufOut
suffix:semicolon
multiline_comment|/* data Out buffer */
id|dma_addr_t
id|dma_addr_in
suffix:semicolon
id|dma_addr_t
id|dma_addr_out
suffix:semicolon
r_int
id|sgSize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Num SG elements */
r_int
id|iocnum
comma
id|flagsLength
suffix:semicolon
r_int
id|sz
comma
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|msgContext
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
id|ulong
id|timeout
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;mptctl_do_mpt_command called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|bufIn.kptr
op_assign
id|bufOut.kptr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_do_mpt_command() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;ioctl
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;No memory available during driver init.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_DID_IOCRESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Busy with IOC Reset &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Verify that the final request frame will not be too large.&n;&t; */
id|sz
op_assign
id|karg.dataSgeOffset
op_star
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataInSize
OG
l_int|0
)paren
id|sz
op_add_assign
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
id|sz
op_add_assign
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sz
OG
id|ioc-&gt;req_sz
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Request frame too large (%d) maximum (%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|sz
comma
id|ioc-&gt;req_sz
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Get a free request frame and save the message context.&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|hdr
op_assign
(paren
id|MPIHeader_t
op_star
)paren
id|mf
suffix:semicolon
id|msgContext
op_assign
id|le32_to_cpu
c_func
(paren
id|hdr-&gt;MsgContext
)paren
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
multiline_comment|/* Copy the request frame&n;&t; * Reset the saved message context.&n;&t; * Request frame in user space&n;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|mf
comma
id|mfPtr
comma
id|karg.dataSgeOffset
op_star
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Unable to read MF from mpt_ioctl_command struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|mfPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
id|hdr-&gt;MsgContext
op_assign
id|cpu_to_le32
c_func
(paren
id|msgContext
)paren
suffix:semicolon
multiline_comment|/* Verify that this request is allowed.&n;&t; */
r_switch
c_cond
(paren
id|hdr-&gt;Function
)paren
(brace
r_case
id|MPI_FUNCTION_IOC_FACTS
suffix:colon
r_case
id|MPI_FUNCTION_PORT_FACTS
suffix:colon
id|karg.dataOutSize
op_assign
id|karg.dataInSize
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_CONFIG
suffix:colon
r_case
id|MPI_FUNCTION_FC_COMMON_TRANSPORT_SEND
suffix:colon
r_case
id|MPI_FUNCTION_FC_EX_LINK_SRVC_SEND
suffix:colon
r_case
id|MPI_FUNCTION_FW_UPLOAD
suffix:colon
r_case
id|MPI_FUNCTION_SCSI_ENCLOSURE_PROCESSOR
suffix:colon
r_case
id|MPI_FUNCTION_FW_DOWNLOAD
suffix:colon
r_case
id|MPI_FUNCTION_FC_PRIMITIVE_SEND
suffix:colon
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_SCSI_IO_REQUEST
suffix:colon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|SCSIIORequest_t
op_star
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
op_assign
l_int|NULL
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_int
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_UNTAGGED
suffix:semicolon
r_int
id|scsidir
op_assign
l_int|0
suffix:semicolon
r_int
id|target
op_assign
(paren
r_int
)paren
id|pScsiReq-&gt;TargetID
suffix:semicolon
r_int
id|dataSize
suffix:semicolon
r_if
c_cond
(paren
(paren
id|target
OL
l_int|0
)paren
op_logical_or
(paren
id|target
op_ge
id|ioc-&gt;sh-&gt;max_id
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Target ID out of bounds. &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
id|pScsiReq-&gt;MsgFlags
op_assign
id|mpt_msg_flags
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* verify that app has not requested&n;&t;&t;&t; *&t;more sense data than driver&n;&t;&t;&t; *&t;can provide, if so, reset this parameter&n;&t;&t;&t; * set the sense buffer pointer low address&n;&t;&t;&t; * update the control field to specify Q type&n;&t;&t;&t; */
r_if
c_cond
(paren
id|karg.maxSenseBytes
OG
id|MPT_SENSE_BUFFER_SIZE
)paren
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|MPT_SENSE_BUFFER_SIZE
suffix:semicolon
r_else
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|karg.maxSenseBytes
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|ioc-&gt;sense_buf_low_dma
op_plus
(paren
id|req_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
)paren
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;Targets
)paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|target
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
)paren
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_SIMPLEQ
suffix:semicolon
multiline_comment|/* Have the IOCTL driver set the direction based&n;&t;&t;&t; * on the dataOutSize (ordering issue with Sparc).&n;&t;&t;&t; */
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
id|dataSize
op_assign
id|karg.dataOutSize
suffix:semicolon
)brace
r_else
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|dataSize
op_assign
id|karg.dataInSize
suffix:semicolon
)brace
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|scsidir
op_or
id|qtag
)paren
suffix:semicolon
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|dataSize
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;reset
op_assign
id|MPTCTL_RESET_OK
suffix:semicolon
id|ioc-&gt;ioctl-&gt;target
op_assign
id|target
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;SCSI driver is not loaded. &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_RAID_ACTION
suffix:colon
multiline_comment|/* Just add a SGE&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH
suffix:colon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|SCSIIORequest_t
op_star
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
r_int
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_SIMPLEQ
suffix:semicolon
r_int
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
r_int
id|dataSize
suffix:semicolon
id|pScsiReq-&gt;MsgFlags
op_assign
id|mpt_msg_flags
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* verify that app has not requested&n;&t;&t;&t; *&t;more sense data than driver&n;&t;&t;&t; *&t;can provide, if so, reset this parameter&n;&t;&t;&t; * set the sense buffer pointer low address&n;&t;&t;&t; * update the control field to specify Q type&n;&t;&t;&t; */
r_if
c_cond
(paren
id|karg.maxSenseBytes
OG
id|MPT_SENSE_BUFFER_SIZE
)paren
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|MPT_SENSE_BUFFER_SIZE
suffix:semicolon
r_else
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|karg.maxSenseBytes
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|ioc-&gt;sense_buf_low_dma
op_plus
(paren
id|req_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
multiline_comment|/* All commands to physical devices are tagged&n;&t;&t;&t; */
multiline_comment|/* Have the IOCTL driver set the direction based&n;&t;&t;&t; * on the dataOutSize (ordering issue with Sparc).&n;&t;&t;&t; */
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
id|dataSize
op_assign
id|karg.dataOutSize
suffix:semicolon
)brace
r_else
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|dataSize
op_assign
id|karg.dataInSize
suffix:semicolon
)brace
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|scsidir
op_or
id|qtag
)paren
suffix:semicolon
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|dataSize
)paren
suffix:semicolon
id|ioc-&gt;ioctl-&gt;reset
op_assign
id|MPTCTL_RESET_OK
suffix:semicolon
id|ioc-&gt;ioctl-&gt;target
op_assign
id|pScsiReq-&gt;TargetID
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;SCSI driver is not loaded. &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:colon
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;sh
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;SCSI driver not loaded or SCSI host not found. &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mptctl_set_tm_flags
c_func
(paren
id|hd
)paren
op_ne
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|MPI_FUNCTION_IOC_INIT
suffix:colon
(brace
id|IOCInit_t
op_star
id|pInit
op_assign
(paren
id|IOCInit_t
op_star
)paren
id|mf
suffix:semicolon
id|u32
id|high_addr
comma
id|sense_high
suffix:semicolon
multiline_comment|/* Verify that all entries in the IOC INIT match&n;&t;&t;&t; * existing setup (and in LE format).&n;&t;&t;&t; */
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
(brace
id|high_addr
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|ioc-&gt;req_frames_dma
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
id|sense_high
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|ioc-&gt;sense_buf_pool_dma
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|high_addr
op_assign
l_int|0
suffix:semicolon
id|sense_high
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pInit-&gt;Flags
op_ne
l_int|0
)paren
op_logical_or
(paren
id|pInit-&gt;MaxDevices
op_ne
id|ioc-&gt;facts.MaxDevices
)paren
op_logical_or
(paren
id|pInit-&gt;MaxBuses
op_ne
id|ioc-&gt;facts.MaxBuses
)paren
op_logical_or
(paren
id|pInit-&gt;ReplyFrameSize
op_ne
id|cpu_to_le16
c_func
(paren
id|ioc-&gt;reply_sz
)paren
)paren
op_logical_or
(paren
id|pInit-&gt;HostMfaHighAddr
op_ne
id|high_addr
)paren
op_logical_or
(paren
id|pInit-&gt;SenseBufferHighAddr
op_ne
id|sense_high
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;IOC_INIT issued with 1 or more incorrect parameters. Rejected.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t;&t; * MPI_FUNCTION_PORT_ENABLE&n;&t;&t; * MPI_FUNCTION_TARGET_CMD_BUFFER_POST&n;&t;&t; * MPI_FUNCTION_TARGET_ASSIST&n;&t;&t; * MPI_FUNCTION_TARGET_STATUS_SEND&n;&t;&t; * MPI_FUNCTION_TARGET_MODE_ABORT&n;&t;&t; * MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET&n;&t;&t; * MPI_FUNCTION_IO_UNIT_RESET&n;&t;&t; * MPI_FUNCTION_HANDSHAKE&n;&t;&t; * MPI_FUNCTION_REPLY_FRAME_REMOVAL&n;&t;&t; * MPI_FUNCTION_EVENT_NOTIFICATION&n;&t;&t; *  (driver handles event notification)&n;&t;&t; * MPI_FUNCTION_EVENT_ACK&n;&t;&t; */
multiline_comment|/*  What to do with these???  CHECK ME!!!&n;&t;&t;&t;MPI_FUNCTION_FC_LINK_SRVC_BUF_POST&n;&t;&t;&t;MPI_FUNCTION_FC_LINK_SRVC_RSP&n;&t;&t;&t;MPI_FUNCTION_FC_ABORT&n;&t;&t;&t;MPI_FUNCTION_LAN_SEND&n;&t;&t;&t;MPI_FUNCTION_LAN_RECEIVE&n;&t;&t; &t;MPI_FUNCTION_LAN_RESET&n;&t;&t;*/
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Illegal request (function 0x%x) &bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|hdr-&gt;Function
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
multiline_comment|/* Add the SGL ( at most one data in SGE and one data out SGE )&n;&t; * In the case of two SGE&squot;s - the data out (write) will always&n;&t; * preceede the data in (read) SGE. psgList is used to free the&n;&t; * allocated memory.&n;&t; */
id|psge
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
(paren
r_int
op_star
)paren
id|mf
)paren
op_plus
id|karg.dataSgeOffset
)paren
suffix:semicolon
id|flagsLength
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* bufIn and bufOut are used for user to kernel space transfers&n;&t; */
id|bufIn.kptr
op_assign
id|bufOut.kptr
op_assign
l_int|NULL
suffix:semicolon
id|bufIn.len
op_assign
id|bufOut.len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
id|sgSize
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|karg.dataInSize
OG
l_int|0
)paren
id|sgSize
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sgSize
OG
l_int|0
)paren
(brace
multiline_comment|/* Set up the dataOut memory allocation */
r_if
c_cond
(paren
id|karg.dataOutSize
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|karg.dataInSize
OG
l_int|0
)paren
(brace
id|flagsLength
op_assign
(paren
id|MPI_SGE_FLAGS_SIMPLE_ELEMENT
op_or
id|MPI_SGE_FLAGS_END_OF_BUFFER
op_or
id|MPI_SGE_FLAGS_DIRECTION
op_or
id|mpt_addr_size
c_func
(paren
)paren
)paren
op_lshift
id|MPI_SGE_FLAGS_SHIFT
suffix:semicolon
)brace
r_else
(brace
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_WRITE
suffix:semicolon
)brace
id|flagsLength
op_or_assign
id|karg.dataOutSize
suffix:semicolon
id|bufOut.len
op_assign
id|karg.dataOutSize
suffix:semicolon
id|bufOut.kptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|bufOut.len
comma
op_amp
id|dma_addr_out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufOut.kptr
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set up this SGE.&n;&t;&t;&t;&t; * Copy to MF and to sglbuf&n;&t;&t;&t;&t; */
id|mpt_add_sge
c_func
(paren
id|psge
comma
id|flagsLength
comma
id|dma_addr_out
)paren
suffix:semicolon
id|psge
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Copy user data to kernel space.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|bufOut.kptr
comma
id|karg.dataOutBufPtr
comma
id|bufOut.len
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - Unable &quot;
l_string|&quot;to read user data &quot;
l_string|&quot;struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|karg.dataOutBufPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|karg.dataInSize
OG
l_int|0
)paren
(brace
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_READ
suffix:semicolon
id|flagsLength
op_or_assign
id|karg.dataInSize
suffix:semicolon
id|bufIn.len
op_assign
id|karg.dataInSize
suffix:semicolon
id|bufIn.kptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|bufIn.len
comma
op_amp
id|dma_addr_in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufIn.kptr
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set up this SGE&n;&t;&t;&t;&t; * Copy to MF and to sglbuf&n;&t;&t;&t;&t; */
id|mpt_add_sge
c_func
(paren
id|psge
comma
id|flagsLength
comma
id|dma_addr_in
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Add a NULL SGE&n;&t;&t; */
id|mpt_add_sge
c_func
(paren
id|psge
comma
id|flagsLength
comma
(paren
id|dma_addr_t
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|ioc-&gt;ioctl-&gt;wait_done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hdr-&gt;Function
op_eq
id|MPI_FUNCTION_SCSI_TASK_MGMT
)paren
(brace
id|DBG_DUMP_TM_REQUEST_FRAME
c_func
(paren
(paren
id|u32
op_star
)paren
id|mf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_send_handshake_request
c_func
(paren
id|mptctl_id
comma
id|ioc
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
(paren
id|u32
op_star
)paren
id|mf
comma
id|CAN_SLEEP
)paren
op_ne
l_int|0
)paren
(brace
id|dfailprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;_send_handshake FAILED!&quot;
l_string|&quot; (ioc %p, mf %p) &bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc
comma
id|mf
)paren
)paren
suffix:semicolon
id|mptctl_free_tm_flags
c_func
(paren
id|ioc
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
r_else
id|mpt_put_msg_frame
c_func
(paren
id|mptctl_id
comma
id|ioc
comma
id|mf
)paren
suffix:semicolon
multiline_comment|/* Now wait for the command to complete */
id|timeout
op_assign
(paren
id|karg.timeout
OG
l_int|0
)paren
ques
c_cond
id|karg.timeout
suffix:colon
id|MPT_IOCTL_DEFAULT_TIMEOUT
suffix:semicolon
id|timeout
op_assign
id|wait_event_interruptible_timeout
c_func
(paren
id|mptctl_wait
comma
id|ioc-&gt;ioctl-&gt;wait_done
op_eq
l_int|1
comma
id|HZ
op_star
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_le
l_int|0
op_logical_and
(paren
id|ioc-&gt;ioctl-&gt;wait_done
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/* Now we need to reset the board */
r_if
c_cond
(paren
id|hdr-&gt;Function
op_eq
id|MPI_FUNCTION_SCSI_TASK_MGMT
)paren
id|mptctl_free_tm_flags
c_func
(paren
id|ioc
)paren
suffix:semicolon
id|mptctl_timeout_expired
c_func
(paren
id|ioc-&gt;ioctl
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
id|mf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* If a valid reply frame, copy to the user.&n;&t; * Offset 2: reply length in U32&squot;s&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_RF_VALID
)paren
(brace
r_if
c_cond
(paren
id|karg.maxReplyBytes
OL
id|ioc-&gt;reply_sz
)paren
(brace
id|sz
op_assign
id|min
c_func
(paren
id|karg.maxReplyBytes
comma
l_int|4
op_star
id|ioc-&gt;ioctl-&gt;ReplyFrame
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|sz
op_assign
id|min
c_func
(paren
id|ioc-&gt;reply_sz
comma
l_int|4
op_star
id|ioc-&gt;ioctl-&gt;ReplyFrame
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sz
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|karg.replyFrameBufPtr
comma
op_amp
id|ioc-&gt;ioctl-&gt;ReplyFrame
comma
id|sz
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Unable to write out reply frame %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|karg.replyFrameBufPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* If valid sense data, copy to user.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_SENSE_VALID
)paren
(brace
id|sz
op_assign
id|min
c_func
(paren
id|karg.maxSenseBytes
comma
id|MPT_SENSE_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sz
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|karg.senseDataPtr
comma
id|ioc-&gt;ioctl-&gt;sense
comma
id|sz
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Unable to write sense data to user %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|karg.senseDataPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|done_free_mem
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* If the overall status is _GOOD and data in, copy data&n;&t; * to user.&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc-&gt;ioctl-&gt;status
op_amp
id|MPT_IOCTL_STATUS_COMMAND_GOOD
)paren
op_logical_and
(paren
id|karg.dataInSize
OG
l_int|0
)paren
op_logical_and
(paren
id|bufIn.kptr
)paren
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|karg.dataInBufPtr
comma
id|bufIn.kptr
comma
id|karg.dataInSize
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_do_mpt_command - &quot;
l_string|&quot;Unable to write data to user %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|karg.dataInBufPtr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
)brace
)brace
id|done_free_mem
suffix:colon
id|ioc-&gt;ioctl-&gt;status
op_and_assign
op_complement
(paren
id|MPT_IOCTL_STATUS_COMMAND_GOOD
op_or
id|MPT_IOCTL_STATUS_SENSE_VALID
op_or
id|MPT_IOCTL_STATUS_RF_VALID
)paren
suffix:semicolon
multiline_comment|/* Free the allocated memory.&n;&t; */
r_if
c_cond
(paren
id|bufOut.kptr
op_ne
l_int|NULL
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|bufOut.len
comma
(paren
r_void
op_star
)paren
id|bufOut.kptr
comma
id|dma_addr_out
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bufIn.kptr
op_ne
l_int|NULL
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|bufIn.len
comma
(paren
r_void
op_star
)paren
id|bufIn.kptr
comma
id|dma_addr_in
)paren
suffix:semicolon
)brace
multiline_comment|/* mf is null if command issued successfully&n;&t; * otherwise, failure occured after mf acquired.&n;&t; */
r_if
c_cond
(paren
id|mf
)paren
id|mpt_free_msg_frame
c_func
(paren
id|ioc
comma
id|mf
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Prototype Routine for the HP HOST INFO command.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; *&t;&t;-ENOMEM if memory allocation error&n; */
r_static
r_int
DECL|function|mptctl_hp_hostinfo
id|mptctl_hp_hostinfo
c_func
(paren
r_int
r_int
id|arg
comma
r_int
r_int
id|data_size
)paren
(brace
id|hp_host_info_t
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_char
op_star
id|pbuf
suffix:semicolon
id|dma_addr_t
id|buf_dma
suffix:semicolon
id|hp_host_info_t
id|karg
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|hdr
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|rc
comma
id|cim_rev
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_hp_hostinfo called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Reset long to int. Should affect IA64 and SPARC only&n;&t; */
r_if
c_cond
(paren
id|data_size
op_eq
r_sizeof
(paren
id|hp_host_info_t
)paren
)paren
id|cim_rev
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|data_size
op_eq
r_sizeof
(paren
id|hp_host_info_rev0_t
)paren
)paren
id|cim_rev
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* obsolete */
r_else
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
id|hp_host_info_t
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_hp_host_info - &quot;
l_string|&quot;Unable to read in hp_host_info struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_hp_hostinfo() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Fill in the data and return the structure to the calling&n;&t; * program&n;&t; */
id|pdev
op_assign
(paren
r_struct
id|pci_dev
op_star
)paren
id|ioc-&gt;pcidev
suffix:semicolon
id|karg.vendor
op_assign
id|pdev-&gt;vendor
suffix:semicolon
id|karg.device
op_assign
id|pdev-&gt;device
suffix:semicolon
id|karg.subsystem_id
op_assign
id|pdev-&gt;subsystem_device
suffix:semicolon
id|karg.subsystem_vendor
op_assign
id|pdev-&gt;subsystem_vendor
suffix:semicolon
id|karg.devfn
op_assign
id|pdev-&gt;devfn
suffix:semicolon
id|karg.bus
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
multiline_comment|/* Save the SCSI host no. if&n;&t; * SCSI driver loaded&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;sh
op_ne
l_int|NULL
)paren
id|karg.host_no
op_assign
id|ioc-&gt;sh-&gt;host_no
suffix:semicolon
r_else
id|karg.host_no
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Reformat the fw_version into a string&n;&t; */
id|karg.fw_version
(braket
l_int|0
)braket
op_assign
id|ioc-&gt;facts.FWVersion.Struct.Major
op_ge
l_int|10
ques
c_cond
(paren
(paren
id|ioc-&gt;facts.FWVersion.Struct.Major
op_div
l_int|10
)paren
op_plus
l_char|&squot;0&squot;
)paren
suffix:colon
l_char|&squot;0&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|1
)braket
op_assign
(paren
id|ioc-&gt;facts.FWVersion.Struct.Major
op_mod
l_int|10
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|2
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|3
)braket
op_assign
id|ioc-&gt;facts.FWVersion.Struct.Minor
op_ge
l_int|10
ques
c_cond
(paren
(paren
id|ioc-&gt;facts.FWVersion.Struct.Minor
op_div
l_int|10
)paren
op_plus
l_char|&squot;0&squot;
)paren
suffix:colon
l_char|&squot;0&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|4
)braket
op_assign
(paren
id|ioc-&gt;facts.FWVersion.Struct.Minor
op_mod
l_int|10
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|5
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|6
)braket
op_assign
id|ioc-&gt;facts.FWVersion.Struct.Unit
op_ge
l_int|10
ques
c_cond
(paren
(paren
id|ioc-&gt;facts.FWVersion.Struct.Unit
op_div
l_int|10
)paren
op_plus
l_char|&squot;0&squot;
)paren
suffix:colon
l_char|&squot;0&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|7
)braket
op_assign
(paren
id|ioc-&gt;facts.FWVersion.Struct.Unit
op_mod
l_int|10
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|8
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|9
)braket
op_assign
id|ioc-&gt;facts.FWVersion.Struct.Dev
op_ge
l_int|10
ques
c_cond
(paren
(paren
id|ioc-&gt;facts.FWVersion.Struct.Dev
op_div
l_int|10
)paren
op_plus
l_char|&squot;0&squot;
)paren
suffix:colon
l_char|&squot;0&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|10
)braket
op_assign
(paren
id|ioc-&gt;facts.FWVersion.Struct.Dev
op_mod
l_int|10
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
id|karg.fw_version
(braket
l_int|11
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* Issue a config request to get the device serial number&n;&t; */
id|hdr.PageVersion
op_assign
l_int|0
suffix:semicolon
id|hdr.PageLength
op_assign
l_int|0
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|0
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_MANUFACTURING
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* read */
id|cfg.timeout
op_assign
l_int|10
suffix:semicolon
id|strncpy
c_func
(paren
id|karg.serial_number
comma
l_string|&quot; &quot;
comma
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cfg.hdr-&gt;PageLength
OG
l_int|0
)paren
(brace
multiline_comment|/* Issue the second config page request */
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|pbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|hdr.PageLength
op_star
l_int|4
comma
op_amp
id|buf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pbuf
)paren
(brace
id|cfg.physAddr
op_assign
id|buf_dma
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
id|ManufacturingPage0_t
op_star
id|pdata
op_assign
(paren
id|ManufacturingPage0_t
op_star
)paren
id|pbuf
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|pdata-&gt;BoardTracerNumber
)paren
OG
l_int|1
)paren
(brace
id|strncpy
c_func
(paren
id|karg.serial_number
comma
id|pdata-&gt;BoardTracerNumber
comma
l_int|24
)paren
suffix:semicolon
id|karg.serial_number
(braket
l_int|24
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|hdr.PageLength
op_star
l_int|4
comma
id|pbuf
comma
id|buf_dma
)paren
suffix:semicolon
id|pbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
id|rc
op_assign
id|mpt_GetIocState
c_func
(paren
id|ioc
comma
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rc
)paren
(brace
r_case
id|MPI_IOC_STATE_OPERATIONAL
suffix:colon
id|karg.ioc_status
op_assign
id|HP_STATUS_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOC_STATE_FAULT
suffix:colon
id|karg.ioc_status
op_assign
id|HP_STATUS_FAILED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOC_STATE_RESET
suffix:colon
r_case
id|MPI_IOC_STATE_READY
suffix:colon
r_default
suffix:colon
id|karg.ioc_status
op_assign
id|HP_STATUS_OTHER
suffix:semicolon
r_break
suffix:semicolon
)brace
id|karg.base_io_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|FC
)paren
id|karg.bus_phys_width
op_assign
id|HP_BUS_WIDTH_UNK
suffix:semicolon
r_else
id|karg.bus_phys_width
op_assign
id|HP_BUS_WIDTH_16
suffix:semicolon
id|karg.hard_resets
op_assign
l_int|0
suffix:semicolon
id|karg.soft_resets
op_assign
l_int|0
suffix:semicolon
id|karg.timeouts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sh
op_ne
l_int|NULL
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_logical_and
(paren
id|cim_rev
op_eq
l_int|1
)paren
)paren
(brace
id|karg.hard_resets
op_assign
id|hd-&gt;hard_resets
suffix:semicolon
id|karg.soft_resets
op_assign
id|hd-&gt;soft_resets
suffix:semicolon
id|karg.timeouts
op_assign
id|hd-&gt;timeouts
suffix:semicolon
)brace
)brace
id|cfg.pageAddr
op_assign
l_int|0
suffix:semicolon
id|cfg.action
op_assign
id|MPI_TOOLBOX_ISTWI_READ_WRITE_TOOL
suffix:semicolon
id|cfg.dir
op_assign
id|MPI_TB_ISTWI_FLAGS_READ
suffix:semicolon
id|cfg.timeout
op_assign
l_int|10
suffix:semicolon
id|pbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
l_int|4
comma
op_amp
id|buf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pbuf
)paren
(brace
id|cfg.physAddr
op_assign
id|buf_dma
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mpt_toolbox
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|karg.rsvd
op_assign
op_star
(paren
id|u32
op_star
)paren
id|pbuf
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
l_int|4
comma
id|pbuf
comma
id|buf_dma
)paren
suffix:semicolon
id|pbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
id|__user
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
id|hp_host_info_t
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_hpgethostinfo - &quot;
l_string|&quot;Unable to write out hp_host_info @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Prototype Routine for the HP TARGET INFO command.&n; *&n; * Outputs:&t;None.&n; * Return:&t;0 if successful&n; *&t;&t;-EFAULT if data unavailable&n; *&t;&t;-EBUSY  if previous command timout and IOC reset is not complete.&n; *&t;&t;-ENODEV if no such device/adapter&n; *&t;&t;-ETIME&t;if timer expires&n; *&t;&t;-ENOMEM if memory allocation error&n; */
r_static
r_int
DECL|function|mptctl_hp_targetinfo
id|mptctl_hp_targetinfo
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|hp_target_info_t
id|__user
op_star
id|uarg
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|SCSIDevicePage0_t
op_star
id|pg0_alloc
suffix:semicolon
id|SCSIDevicePage3_t
op_star
id|pg3_alloc
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
id|hp_target_info_t
id|karg
suffix:semicolon
r_int
id|iocnum
suffix:semicolon
r_int
id|data_sz
suffix:semicolon
id|dma_addr_t
id|page_dma
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|ConfigPageHeader_t
id|hdr
suffix:semicolon
r_int
id|tmp
comma
id|np
comma
id|rc
op_assign
l_int|0
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
l_string|&quot;: mptctl_hp_targetinfo called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg
comma
id|uarg
comma
r_sizeof
(paren
id|hp_target_info_t
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_hp_targetinfo - &quot;
l_string|&quot;Unable to read in hp_host_targetinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|karg.hdr.iocnum
comma
op_amp
id|ioc
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|ioc
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;%s::mptctl_hp_targetinfo() @%d - ioc%d not found!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|iocnum
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*  There is nothing to do for FCP parts.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|FC
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;spi_data.sdp0length
op_eq
l_int|0
)paren
op_logical_or
(paren
id|ioc-&gt;sh
op_eq
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sh-&gt;host_no
op_ne
id|karg.hdr.host
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Get the data transfer speeds&n;        */
id|data_sz
op_assign
id|ioc-&gt;spi_data.sdp0length
op_star
l_int|4
suffix:semicolon
id|pg0_alloc
op_assign
(paren
id|SCSIDevicePage0_t
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
op_amp
id|page_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pg0_alloc
)paren
(brace
id|hdr.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp0version
suffix:semicolon
id|hdr.PageLength
op_assign
id|data_sz
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|0
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
id|cfg.physAddr
op_assign
id|page_dma
suffix:semicolon
id|cfg.pageAddr
op_assign
(paren
id|karg.hdr.channel
op_lshift
l_int|8
)paren
op_or
id|karg.hdr.id
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|np
op_assign
id|le32_to_cpu
c_func
(paren
id|pg0_alloc-&gt;NegotiatedParameters
)paren
suffix:semicolon
id|karg.negotiated_width
op_assign
id|np
op_amp
id|MPI_SCSIDEVPAGE0_NP_WIDE
ques
c_cond
id|HP_BUS_WIDTH_16
suffix:colon
id|HP_BUS_WIDTH_8
suffix:semicolon
r_if
c_cond
(paren
id|np
op_amp
id|MPI_SCSIDEVPAGE0_NP_NEG_SYNC_OFFSET_MASK
)paren
(brace
id|tmp
op_assign
(paren
id|np
op_amp
id|MPI_SCSIDEVPAGE0_NP_NEG_SYNC_PERIOD_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0x09
)paren
id|karg.negotiated_speed
op_assign
id|HP_DEV_SPEED_ULTRA320
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tmp
op_le
l_int|0x09
)paren
id|karg.negotiated_speed
op_assign
id|HP_DEV_SPEED_ULTRA160
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tmp
op_le
l_int|0x0A
)paren
id|karg.negotiated_speed
op_assign
id|HP_DEV_SPEED_ULTRA2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tmp
op_le
l_int|0x0C
)paren
id|karg.negotiated_speed
op_assign
id|HP_DEV_SPEED_ULTRA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tmp
op_le
l_int|0x25
)paren
id|karg.negotiated_speed
op_assign
id|HP_DEV_SPEED_FAST
suffix:semicolon
r_else
id|karg.negotiated_speed
op_assign
id|HP_DEV_SPEED_ASYNC
suffix:semicolon
)brace
r_else
id|karg.negotiated_speed
op_assign
id|HP_DEV_SPEED_ASYNC
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
(paren
id|u8
op_star
)paren
id|pg0_alloc
comma
id|page_dma
)paren
suffix:semicolon
)brace
multiline_comment|/* Set defaults&n;&t; */
id|karg.message_rejects
op_assign
op_minus
l_int|1
suffix:semicolon
id|karg.phase_errors
op_assign
op_minus
l_int|1
suffix:semicolon
id|karg.parity_errors
op_assign
op_minus
l_int|1
suffix:semicolon
id|karg.select_timeouts
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Get the target error parameters&n;&t; */
id|hdr.PageVersion
op_assign
l_int|0
suffix:semicolon
id|hdr.PageLength
op_assign
l_int|0
suffix:semicolon
id|hdr.PageNumber
op_assign
l_int|3
suffix:semicolon
id|hdr.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|hdr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_HEADER
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
id|cfg.physAddr
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|cfg.hdr-&gt;PageLength
OG
l_int|0
)paren
)paren
(brace
multiline_comment|/* Issue the second config page request */
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|data_sz
op_assign
(paren
r_int
)paren
id|cfg.hdr-&gt;PageLength
op_star
l_int|4
suffix:semicolon
id|pg3_alloc
op_assign
(paren
id|SCSIDevicePage3_t
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
op_amp
id|page_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pg3_alloc
)paren
(brace
id|cfg.physAddr
op_assign
id|page_dma
suffix:semicolon
id|cfg.pageAddr
op_assign
(paren
id|karg.hdr.channel
op_lshift
l_int|8
)paren
op_or
id|karg.hdr.id
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|mpt_config
c_func
(paren
id|ioc
comma
op_amp
id|cfg
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|karg.message_rejects
op_assign
(paren
id|u32
)paren
id|le16_to_cpu
c_func
(paren
id|pg3_alloc-&gt;MsgRejectCount
)paren
suffix:semicolon
id|karg.phase_errors
op_assign
(paren
id|u32
)paren
id|le16_to_cpu
c_func
(paren
id|pg3_alloc-&gt;PhaseErrorCount
)paren
suffix:semicolon
id|karg.parity_errors
op_assign
(paren
id|u32
)paren
id|le16_to_cpu
c_func
(paren
id|pg3_alloc-&gt;ParityErrorCount
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|data_sz
comma
(paren
id|u8
op_star
)paren
id|pg3_alloc
comma
id|page_dma
)paren
suffix:semicolon
)brace
)brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_ne
l_int|NULL
)paren
id|karg.select_timeouts
op_assign
id|hd-&gt;sel_timeout
(braket
id|karg.hdr.id
)braket
suffix:semicolon
multiline_comment|/* Copy the data from kernel memory to user memory&n;&t; */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
id|__user
op_star
)paren
id|arg
comma
op_amp
id|karg
comma
r_sizeof
(paren
id|hp_target_info_t
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s@%d::mptctl_hp_target_info - &quot;
l_string|&quot;Unable to write out mpt_ioctl_targetinfo struct @ %p&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|uarg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mptctl_fops
r_static
r_struct
id|file_operations
id|mptctl_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|unlocked_ioctl
op_assign
id|mptctl_ioctl
comma
macro_line|#ifdef CONFIG_COMPAT
dot
id|compat_ioctl
op_assign
id|compat_mpctl_ioctl
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|variable|mptctl_miscdev
r_static
r_struct
id|miscdevice
id|mptctl_miscdev
op_assign
(brace
id|MPT_MINOR
comma
id|MYNAM
comma
op_amp
id|mptctl_fops
)brace
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#ifdef CONFIG_COMPAT
macro_line|#include &lt;linux/ioctl32.h&gt;
r_static
r_int
DECL|function|compat_mptfwxfer_ioctl
id|compat_mptfwxfer_ioctl
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_fw_xfer32
id|kfw32
suffix:semicolon
r_struct
id|mpt_fw_xfer
id|kfw
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iocnum
comma
id|iocnumX
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::compat_mptfwxfer_ioctl() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|kfw32
comma
(paren
r_char
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|kfw32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Verify intended MPT adapter */
id|iocnumX
op_assign
id|kfw32.iocnum
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;::compat_mptfwxfer_ioctl @%d - ioc%d not found!&bslash;n&quot;
comma
id|__LINE__
comma
id|iocnumX
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|kfw.iocnum
op_assign
id|iocnum
suffix:semicolon
id|kfw.fwlen
op_assign
id|kfw32.fwlen
suffix:semicolon
id|kfw.bufp
op_assign
id|compat_ptr
c_func
(paren
id|kfw32.bufp
)paren
suffix:semicolon
id|ret
op_assign
id|mptctl_do_fw_download
c_func
(paren
id|kfw.iocnum
comma
id|kfw.bufp
comma
id|kfw.fwlen
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|iocp-&gt;ioctl-&gt;sem_ioc
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|compat_mpt_command
id|compat_mpt_command
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|mpt_ioctl_command32
id|karg32
suffix:semicolon
r_struct
id|mpt_ioctl_command32
id|__user
op_star
id|uarg
op_assign
(paren
r_struct
id|mpt_ioctl_command32
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|mpt_ioctl_command
id|karg
suffix:semicolon
id|MPT_ADAPTER
op_star
id|iocp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iocnum
comma
id|iocnumX
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dctlprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;::compat_mpt_command() called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|karg32
comma
(paren
r_char
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|karg32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Verify intended MPT adapter */
id|iocnumX
op_assign
id|karg32.hdr.iocnum
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|iocnum
op_assign
id|mpt_verify_adapter
c_func
(paren
id|iocnumX
comma
op_amp
id|iocp
)paren
)paren
OL
l_int|0
)paren
op_logical_or
(paren
id|iocp
op_eq
l_int|NULL
)paren
)paren
(brace
id|dctlprintk
c_func
(paren
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;::compat_mpt_command @%d - ioc%d not found!&bslash;n&quot;
comma
id|__LINE__
comma
id|iocnumX
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mptctl_syscall_down
c_func
(paren
id|iocp
comma
id|nonblock
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* Copy data to karg */
id|karg.hdr.iocnum
op_assign
id|karg32.hdr.iocnum
suffix:semicolon
id|karg.hdr.port
op_assign
id|karg32.hdr.port
suffix:semicolon
id|karg.timeout
op_assign
id|karg32.timeout
suffix:semicolon
id|karg.maxReplyBytes
op_assign
id|karg32.maxReplyBytes
suffix:semicolon
id|karg.dataInSize
op_assign
id|karg32.dataInSize
suffix:semicolon
id|karg.dataOutSize
op_assign
id|karg32.dataOutSize
suffix:semicolon
id|karg.maxSenseBytes
op_assign
id|karg32.maxSenseBytes
suffix:semicolon
id|karg.dataSgeOffset
op_assign
id|karg32.dataSgeOffset
suffix:semicolon
id|karg.replyFrameBufPtr
op_assign
(paren
r_char
id|__user
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.replyFrameBufPtr
suffix:semicolon
id|karg.dataInBufPtr
op_assign
(paren
r_char
id|__user
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.dataInBufPtr
suffix:semicolon
id|karg.dataOutBufPtr
op_assign
(paren
r_char
id|__user
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.dataOutBufPtr
suffix:semicolon
id|karg.senseDataPtr
op_assign
(paren
r_char
id|__user
op_star
)paren
(paren
r_int
r_int
)paren
id|karg32.senseDataPtr
suffix:semicolon
multiline_comment|/* Pass new structure to do_mpt_command&n;&t; */
id|ret
op_assign
id|mptctl_do_mpt_command
(paren
id|karg
comma
op_amp
id|uarg-&gt;MF
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|iocp-&gt;ioctl-&gt;sem_ioc
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|compat_mpctl_ioctl
r_static
r_int
id|compat_mpctl_ioctl
c_func
(paren
r_struct
id|file
op_star
id|f
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ret
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MPTIOCINFO
suffix:colon
r_case
id|MPTIOCINFO1
suffix:colon
r_case
id|MPTIOCINFO2
suffix:colon
r_case
id|MPTTARGETINFO
suffix:colon
r_case
id|MPTEVENTQUERY
suffix:colon
r_case
id|MPTEVENTENABLE
suffix:colon
r_case
id|MPTEVENTREPORT
suffix:colon
r_case
id|MPTHARDRESET
suffix:colon
r_case
id|HP_GETHOSTINFO
suffix:colon
r_case
id|HP_GETTARGETINFO
suffix:colon
r_case
id|MPTTEST
suffix:colon
id|ret
op_assign
id|__mptctl_ioctl
c_func
(paren
id|f
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTCOMMAND32
suffix:colon
id|ret
op_assign
id|compat_mpt_command
c_func
(paren
id|f
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPTFWDOWNLOAD32
suffix:colon
id|ret
op_assign
id|compat_mptfwxfer_ioctl
c_func
(paren
id|f
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptctl_probe - Installs ioctl devices per bus.&n; *&t;@pdev: Pointer to pci_dev structure&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; *&n; */
r_static
r_int
DECL|function|mptctl_probe
id|mptctl_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|sz
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate and inite a MPT_IOCTL structure&n;&t;*/
id|sz
op_assign
r_sizeof
(paren
id|MPT_IOCTL
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|ioc-&gt;ioctl
op_assign
(paren
id|MPT_IOCTL
op_star
)paren
id|mem
suffix:semicolon
id|ioc-&gt;ioctl-&gt;ioc
op_assign
id|ioc
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|ioc-&gt;ioctl-&gt;sem_ioc
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_fail
suffix:colon
id|mptctl_remove
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptctl_remove - Removed ioctl devices&n; *&t;@pdev: Pointer to pci_dev structure&n; *&n; *&n; */
r_static
r_void
DECL|function|mptctl_remove
id|mptctl_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|kfree
(paren
id|ioc-&gt;ioctl
)paren
suffix:semicolon
)brace
DECL|variable|mptctl_driver
r_static
r_struct
id|mpt_pci_driver
id|mptctl_driver
op_assign
(brace
dot
id|probe
op_assign
id|mptctl_probe
comma
dot
id|remove
op_assign
id|mptctl_remove
comma
)brace
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_init
r_static
r_int
id|__init
id|mptctl_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|where
op_assign
l_int|1
suffix:semicolon
id|show_mptmod_ver
c_func
(paren
id|my_NAME
comma
id|my_VERSION
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_device_driver_register
c_func
(paren
op_amp
id|mptctl_driver
comma
id|MPTCTL_DRIVER
)paren
op_ne
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: failed to register dd callbacks&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Register this device */
id|err
op_assign
id|misc_register
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: Can&squot;t register misc device [minor=%d].&bslash;n&quot;
comma
id|MPT_MINOR
)paren
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered with Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: /dev/%s @ (major,minor=%d,%d)&bslash;n&quot;
comma
id|mptctl_miscdev.name
comma
id|MISC_MAJOR
comma
id|mptctl_miscdev.minor
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Install our handler&n;&t; */
op_increment
id|where
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mptctl_id
op_assign
id|mpt_register
c_func
(paren
id|mptctl_reply
comma
id|MPTCTL_DRIVER
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR: Failed to register with Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mpt_reset_register
c_func
(paren
id|mptctl_id
comma
id|mptctl_ioc_reset
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FIXME! */
)brace
r_return
l_int|0
suffix:semicolon
id|out_fail
suffix:colon
id|mpt_device_driver_deregister
c_func
(paren
id|MPTCTL_DRIVER
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|mptctl_exit
r_static
r_void
id|mptctl_exit
c_func
(paren
r_void
)paren
(brace
id|misc_deregister
c_func
(paren
op_amp
id|mptctl_miscdev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered /dev/%s @ (major,minor=%d,%d)&bslash;n&quot;
comma
id|mptctl_miscdev.name
comma
id|MISC_MAJOR
comma
id|mptctl_miscdev.minor
)paren
suffix:semicolon
multiline_comment|/* De-register reset handler from base module */
id|mpt_reset_deregister
c_func
(paren
id|mptctl_id
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* De-register callback handler from base module */
id|mpt_deregister
c_func
(paren
id|mptctl_id
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered from Fusion MPT base driver&bslash;n&quot;
)paren
suffix:semicolon
id|mpt_device_driver_deregister
c_func
(paren
id|MPTCTL_DRIVER
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mptctl_init
id|module_init
c_func
(paren
id|mptctl_init
)paren
suffix:semicolon
DECL|variable|mptctl_exit
id|module_exit
c_func
(paren
id|mptctl_exit
)paren
suffix:semicolon
eof
