multiline_comment|/*&n; *  linux/drivers/message/fusion/mptscsih.c&n; *      High performance SCSI / Fibre Channel SCSI Host device driver.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      A special thanks to Pamela Delaney (LSI Logic) for tons of work&n; *      and countless enhancements while adding support for the 1030&n; *      chip family.  Pam has been instrumental in the development of&n; *      of the 2.xx.xx series fusion drivers, and her contributions are&n; *      far too numerous to hope to list in one place.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      (see mptbase.c)&n; *&n; *  Copyright (c) 1999-2002 LSI Logic Corporation&n; *  Original author: Steven J. Ralston&n; *  (mailto:sjralston1@netscape.net)&n; *  (mailto:Pam.Delaney@lsil.com)&n; *&n; *  $Id: mptscsih.c,v 1.95 2002/06/20 13:28:17 pdelaney Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/blk.h&gt;&t;&t;/* for io_request_lock (spinlock) decl */
macro_line|#include &lt;linux/delay.h&gt;&t;/* for mdelay */
macro_line|#include &lt;linux/interrupt.h&gt;&t;/* needed for in_interrupt() proto */
macro_line|#include &lt;linux/reboot.h&gt;&t;/* notifier code */
macro_line|#include &quot;../../scsi/scsi.h&quot;
macro_line|#include &quot;../../scsi/hosts.h&quot;
macro_line|#include &quot;../../scsi/sd.h&quot;
macro_line|#include &quot;mptbase.h&quot;
macro_line|#include &quot;mptscsih.h&quot;
macro_line|#include &quot;isense.h&quot;
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|my_NAME
mdefine_line|#define my_NAME&t;&t;&quot;Fusion MPT SCSI Host driver&quot;
DECL|macro|my_VERSION
mdefine_line|#define my_VERSION&t;MPT_LINUX_VERSION_COMMON
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptscsih&quot;
DECL|variable|MODULEAUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|MODULEAUTHOR
)paren
suffix:semicolon
DECL|variable|my_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|my_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Set string for command line args from insmod */
macro_line|#ifdef MODULE
DECL|variable|mptscsih
r_char
op_star
id|mptscsih
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mptscsih
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|struct|_BIG_SENSE_BUF
r_typedef
r_struct
id|_BIG_SENSE_BUF
(brace
DECL|member|data
id|u8
id|data
(braket
id|MPT_SENSE_BUFFER_ALLOC
)braket
suffix:semicolon
DECL|typedef|BIG_SENSE_BUF
)brace
id|BIG_SENSE_BUF
suffix:semicolon
DECL|macro|MPT_SCANDV_GOOD
mdefine_line|#define MPT_SCANDV_GOOD&t;&t;&t;(0x00000000) /* must be 0 */
DECL|macro|MPT_SCANDV_DID_RESET
mdefine_line|#define MPT_SCANDV_DID_RESET&t;&t;(0x00000001)
DECL|macro|MPT_SCANDV_SENSE
mdefine_line|#define MPT_SCANDV_SENSE&t;&t;(0x00000002)
DECL|macro|MPT_SCANDV_SOME_ERROR
mdefine_line|#define MPT_SCANDV_SOME_ERROR&t;&t;(0x00000004)
DECL|macro|MPT_SCANDV_SELECTION_TIMEOUT
mdefine_line|#define MPT_SCANDV_SELECTION_TIMEOUT&t;(0x00000008)
DECL|macro|MPT_SCANDV_MAX_RETRIES
mdefine_line|#define MPT_SCANDV_MAX_RETRIES&t;&t;(10)
DECL|macro|MPT_ICFLAG_BUF_CAP
mdefine_line|#define MPT_ICFLAG_BUF_CAP&t;0x01&t;/* ReadBuffer Read Capacity format */
DECL|macro|MPT_ICFLAG_ECHO
mdefine_line|#define MPT_ICFLAG_ECHO&t;&t;0x02&t;/* ReadBuffer Echo buffer format */
DECL|macro|MPT_ICFLAG_PHYS_DISK
mdefine_line|#define MPT_ICFLAG_PHYS_DISK&t;0x04&t;/* Any SCSI IO but do Phys Disk Format */
DECL|macro|MPT_ICFLAG_TAGGED_CMD
mdefine_line|#define MPT_ICFLAG_TAGGED_CMD&t;0x08&t;/* Do tagged IO */
DECL|macro|MPT_ICFLAG_DID_RESET
mdefine_line|#define MPT_ICFLAG_DID_RESET&t;0x20&t;/* Bus Reset occured with this command */
DECL|macro|MPT_ICFLAG_RESERVED
mdefine_line|#define MPT_ICFLAG_RESERVED&t;0x40&t;/* Reserved has been issued */
DECL|struct|_internal_cmd
r_typedef
r_struct
id|_internal_cmd
(brace
DECL|member|data
r_char
op_star
id|data
suffix:semicolon
multiline_comment|/* data pointer */
DECL|member|data_dma
id|dma_addr_t
id|data_dma
suffix:semicolon
multiline_comment|/* data dma address */
DECL|member|size
r_int
id|size
suffix:semicolon
multiline_comment|/* transfer size */
DECL|member|cmd
id|u8
id|cmd
suffix:semicolon
multiline_comment|/* SCSI Op Code */
DECL|member|bus
id|u8
id|bus
suffix:semicolon
multiline_comment|/* bus number */
DECL|member|id
id|u8
id|id
suffix:semicolon
multiline_comment|/* SCSI ID (virtual) */
DECL|member|lun
id|u8
id|lun
suffix:semicolon
DECL|member|flags
id|u8
id|flags
suffix:semicolon
multiline_comment|/* Bit Field - See above */
DECL|member|physDiskNum
id|u8
id|physDiskNum
suffix:semicolon
multiline_comment|/* Phys disk number, -1 else */
DECL|member|rsvd2
id|u8
id|rsvd2
suffix:semicolon
DECL|member|rsvd
id|u8
id|rsvd
suffix:semicolon
DECL|typedef|INTERNAL_CMD
)brace
id|INTERNAL_CMD
suffix:semicolon
DECL|struct|_negoparms
r_typedef
r_struct
id|_negoparms
(brace
DECL|member|width
id|u8
id|width
suffix:semicolon
DECL|member|offset
id|u8
id|offset
suffix:semicolon
DECL|member|factor
id|u8
id|factor
suffix:semicolon
DECL|member|flags
id|u8
id|flags
suffix:semicolon
DECL|typedef|NEGOPARMS
)brace
id|NEGOPARMS
suffix:semicolon
DECL|struct|_dv_parameters
r_typedef
r_struct
id|_dv_parameters
(brace
DECL|member|max
id|NEGOPARMS
id|max
suffix:semicolon
DECL|member|now
id|NEGOPARMS
id|now
suffix:semicolon
DECL|member|cmd
id|u8
id|cmd
suffix:semicolon
DECL|member|id
id|u8
id|id
suffix:semicolon
DECL|member|pad1
id|u16
id|pad1
suffix:semicolon
DECL|typedef|DVPARAMETERS
)brace
id|DVPARAMETERS
suffix:semicolon
multiline_comment|/*&n; *  Other private/forward protos...&n; */
r_static
r_int
id|mptscsih_io_done
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_report_queue_full
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
comma
id|SCSIIORequest_t
op_star
id|pScsiReq
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_taskmgmt_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_io_direction
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_AddSGE
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
id|SCSIIORequest_t
op_star
id|pReq
comma
r_int
id|req_idx
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_getFreeChainBuffer
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
op_star
id|retIndex
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_freeChainBuffers
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|req_idx
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_initChainBuffers
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|init
)paren
suffix:semicolon
r_static
r_void
id|copy_sense_data
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
)paren
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
r_static
r_void
id|search_taskQ_for_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
)paren
suffix:semicolon
macro_line|#else
r_static
r_int
id|mptscsih_tm_pending_wait
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
suffix:semicolon
macro_line|#endif
r_static
id|u32
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
)paren
suffix:semicolon
r_static
id|MPT_FRAME_HDR
op_star
id|mptscsih_search_pendingQ
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|scpnt_idx
)paren
suffix:semicolon
r_static
r_void
id|post_pendingQ_commands
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_TMHandler
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|type
comma
id|u8
id|target
comma
id|u8
id|lun
comma
r_int
id|ctx2abort
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_IssueTaskMgmt
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|type
comma
id|u8
id|target
comma
id|u8
id|lun
comma
r_int
id|ctx2abort
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|post_reset
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_event_process
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEvReply
)paren
suffix:semicolon
r_static
id|VirtDevice
op_star
id|mptscsih_initTarget
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|bus_id
comma
r_int
id|target_id
comma
id|u8
id|lun
comma
r_char
op_star
id|data
comma
r_int
id|dlen
)paren
suffix:semicolon
r_void
id|mptscsih_setTargetNegoParms
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|VirtDevice
op_star
id|target
comma
r_char
id|byte56
)paren
suffix:semicolon
r_static
r_void
id|clear_sense_flag
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|SCSIIORequest_t
op_star
id|pReq
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_set_dvflags
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|SCSIIORequest_t
op_star
id|pReq
comma
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_setDevicePage1Flags
(paren
id|u8
id|width
comma
id|u8
id|factor
comma
id|u8
id|offset
comma
r_int
op_star
id|requestedPtr
comma
r_int
op_star
id|configurationPtr
comma
id|u8
id|flags
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_no_negotiate
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|target_id
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_writeSDP1
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
comma
r_int
id|target
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_scandv_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_timer_expired
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_taskmgmt_timeout
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_do_cmd
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|INTERNAL_CMD
op_star
id|iocmd
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_synchronize_cache
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
)paren
suffix:semicolon
macro_line|#ifndef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
r_static
r_int
id|mptscsih_do_raid
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|action
comma
id|INTERNAL_CMD
op_star
id|io
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_domainValidation
c_func
(paren
r_void
op_star
id|hd
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_is_phys_disk
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|id
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_qas_check
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_doDv
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
comma
r_int
id|target
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_dv_parms
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|DVPARAMETERS
op_star
id|dv
comma
r_void
op_star
id|pPage
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_fillbuf
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|size
comma
r_int
id|index
comma
r_int
id|width
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|mptscsih_setup
c_func
(paren
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_halt
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
id|ulong
id|event
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Reboot Notification&n; */
DECL|variable|mptscsih_notifier
r_static
r_struct
id|notifier_block
id|mptscsih_notifier
op_assign
(brace
id|mptscsih_halt
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Private data...&n; */
DECL|variable|mpt_scsi_hosts
r_static
r_int
id|mpt_scsi_hosts
op_assign
l_int|0
suffix:semicolon
DECL|variable|queue_depth
r_static
id|atomic_t
id|queue_depth
suffix:semicolon
DECL|variable|ScsiDoneCtx
r_static
r_int
id|ScsiDoneCtx
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|ScsiTaskCtx
r_static
r_int
id|ScsiTaskCtx
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|ScsiScanDvCtx
r_static
r_int
id|ScsiScanDvCtx
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Used only for bus scan and dv */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,28)
DECL|variable|proc_mpt_scsihost
r_static
r_struct
id|proc_dir_entry
id|proc_mpt_scsihost
op_assign
(brace
id|low_ino
suffix:colon
id|PROC_SCSI_MPT
comma
id|namelen
suffix:colon
l_int|8
comma
id|name
suffix:colon
l_string|&quot;mptscsih&quot;
comma
id|mode
suffix:colon
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
id|nlink
suffix:colon
l_int|2
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|macro|SNS_LEN
mdefine_line|#define SNS_LEN(scp)&t;sizeof((scp)-&gt;sense_buffer)
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
multiline_comment|/*&n; *  Stuff to handle single-threading SCSI TaskMgmt&n; *  (abort/reset) requests...&n; */
DECL|variable|mytaskQ_lock
r_static
id|spinlock_t
id|mytaskQ_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|mytaskQ_bh_active
r_static
r_int
id|mytaskQ_bh_active
op_assign
l_int|0
suffix:semicolon
DECL|variable|mptscsih_ptaskfoo
r_static
r_struct
id|tq_struct
id|mptscsih_ptaskfoo
suffix:semicolon
DECL|variable|mpt_taskQdepth
r_static
id|atomic_t
id|mpt_taskQdepth
suffix:semicolon
macro_line|#endif
macro_line|#ifndef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
multiline_comment|/*&n; * Domain Validation task structure&n; */
DECL|variable|dvtaskQ_lock
r_static
id|spinlock_t
id|dvtaskQ_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|dvtaskQ_active
r_static
r_int
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
DECL|variable|dvtaskQ_release
r_static
r_int
id|dvtaskQ_release
op_assign
l_int|0
suffix:semicolon
DECL|variable|mptscsih_dvTask
r_static
r_struct
id|tq_struct
id|mptscsih_dvTask
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Wait Queue setup&n; */
r_static
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|scandv_waitq
)paren
suffix:semicolon
DECL|variable|scandv_wait_done
r_static
r_int
id|scandv_wait_done
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Driver default setup&n; */
r_static
r_struct
id|mptscsih_driver_setup
DECL|variable|driver_setup
id|driver_setup
op_assign
id|MPTSCSIH_DRIVER_SETUP
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_io_done - Main SCSI IO callback routine registered to&n; *&t;Fusion MPT (base) driver&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to original MPT request frame&n; *&t;@r: Pointer to MPT reply frame (NULL if TurboReply)&n; *&n; *&t;This routine is called from mpt.c::mpt_interrupt() at the completion&n; *&t;of any SCSI IO request.&n; *&t;This routine is registered with the Fusion MPT (base) driver at driver&n; *&t;load/init time via the mpt_register() API call.&n; *&n; *&t;Returns 1 indicating alloc&squot;d request frame ptr should be freed.&n; */
r_static
r_int
DECL|function|mptscsih_io_done
id|mptscsih_io_done
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|mr
)paren
(brace
id|Scsi_Cmnd
op_star
id|sc
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pScsiReq
suffix:semicolon
id|SCSIIOReply_t
op_star
id|pScsiReply
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
id|u16
id|req_idx
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|mf
op_ge
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;%s req frame ptr! (=%p)!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
ques
c_cond
l_string|&quot;BAD&quot;
suffix:colon
l_string|&quot;NULL&quot;
comma
(paren
r_void
op_star
)paren
id|mf
)paren
suffix:semicolon
multiline_comment|/* return 1; CHECKME SteveR. Don&squot;t free. */
r_return
l_int|0
suffix:semicolon
)brace
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sc
op_assign
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_eq
l_int|NULL
)paren
(brace
id|MPIHeader_t
op_star
id|hdr
op_assign
(paren
id|MPIHeader_t
op_star
)paren
id|mf
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
multiline_comment|/* writeSDP1 will use the ScsiDoneCtx&n;&t;&t; * There is no processing for the reply.&n;&t;&t; * Just return to the calling function.&n;&t;&t; */
r_if
c_cond
(paren
id|hdr-&gt;Function
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;NULL ScsiCmd ptr!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|mptscsih_freeChainBuffers
c_func
(paren
id|hd
comma
id|req_idx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;ScsiDone (mf=%p,mr=%p,sc=%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
comma
id|mr
comma
id|sc
)paren
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
id|sc-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* Set default reply as OK */
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|pScsiReply
op_assign
(paren
id|SCSIIOReply_t
op_star
)paren
id|mr
suffix:semicolon
r_if
c_cond
(paren
id|pScsiReply
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* special context reply handling */
multiline_comment|/* If regular Inquiry cmd - save inquiry data&n;&t;&t; */
r_if
c_cond
(paren
id|pScsiReq-&gt;CDB
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
op_logical_neg
(paren
id|pScsiReq-&gt;CDB
(braket
l_int|1
)braket
op_amp
l_int|0x3
)paren
)paren
(brace
r_int
id|dlen
suffix:semicolon
id|dlen
op_assign
id|le32_to_cpu
c_func
(paren
id|pScsiReq-&gt;DataLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlen
op_ge
id|SCSI_STD_INQUIRY_BYTES
)paren
(brace
id|mptscsih_initTarget
c_func
(paren
id|hd
comma
id|hd-&gt;port
comma
id|sc-&gt;target
comma
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
comma
id|sc-&gt;buffer
comma
id|dlen
)paren
suffix:semicolon
)brace
)brace
id|clear_sense_flag
c_func
(paren
id|hd
comma
id|pScsiReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
id|mptscsih_set_dvflags
c_func
(paren
id|hd
comma
id|pScsiReq
comma
id|sc-&gt;buffer
)paren
suffix:semicolon
)brace
r_else
(brace
id|u32
id|xfer_cnt
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|u8
id|scsi_state
suffix:semicolon
id|status
op_assign
id|le16_to_cpu
c_func
(paren
id|pScsiReply-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
id|scsi_state
op_assign
id|pScsiReply-&gt;SCSIState
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  Uh-Oh! (%d:%d:%d) mf=%p, mr=%p, sc=%p&bslash;n&quot;
comma
id|ioc-&gt;id
comma
id|pScsiReq-&gt;TargetID
comma
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
comma
id|mf
comma
id|mr
comma
id|sc
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  IOCStatus=%04xh, SCSIState=%02xh&quot;
l_string|&quot;, SCSIStatus=%02xh, IOCLogInfo=%08xh&bslash;n&quot;
comma
id|status
comma
id|scsi_state
comma
id|pScsiReply-&gt;SCSIStatus
comma
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;IOCLogInfo
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
id|copy_sense_data
c_func
(paren
id|sc
comma
id|hd
comma
id|mf
comma
id|pScsiReply
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Look for + dump FCP ResponseInfo[]!&n;&t;&t; */
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_RESPONSE_INFO_VALID
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  FCP_ResponseInfo=%08xh&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;ResponseInfo
)paren
)paren
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|MPI_IOCSTATUS_BUSY
suffix:colon
multiline_comment|/* 0x0002 */
multiline_comment|/* CHECKME!&n;&t;&t;&t; * Maybe: DRIVER_BUSY | SUGGEST_RETRY | DID_SOFT_ERROR (retry)&n;&t;&t;&t; * But not: DID_BUS_BUSY lest one risk&n;&t;&t;&t; * killing interrupt handler:-(&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_INVALID_BUS
suffix:colon
multiline_comment|/* 0x0041 */
r_case
id|MPI_IOCSTATUS_SCSI_INVALID_TARGETID
suffix:colon
multiline_comment|/* 0x0042 */
id|sc-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE
suffix:colon
multiline_comment|/* 0x0043 */
multiline_comment|/* Spoof to SCSI Selection Timeout! */
id|sc-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_TASK_TERMINATED
suffix:colon
multiline_comment|/* 0x0048 */
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
id|search_taskQ_for_cmd
c_func
(paren
id|sc
comma
id|hd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Linux handles an unsolicited DID_RESET better &n;&t;&t;&t; * than an unsolicited DID_ABORT.&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* GEM Workaround. */
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
id|mptscsih_no_negotiate
c_func
(paren
id|hd
comma
id|sc-&gt;target
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_IOC_TERMINATED
suffix:colon
multiline_comment|/* 0x004B */
r_case
id|MPI_IOCSTATUS_SCSI_EXT_TERMINATED
suffix:colon
multiline_comment|/* 0x004C */
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
id|search_taskQ_for_cmd
c_func
(paren
id|sc
comma
id|hd
)paren
suffix:semicolon
macro_line|#endif
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* GEM Workaround. */
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
id|mptscsih_no_negotiate
c_func
(paren
id|hd
comma
id|sc-&gt;target
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH
suffix:colon
multiline_comment|/* 0x0049 */
r_case
id|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
suffix:colon
multiline_comment|/* 0x0045 */
multiline_comment|/*&n;&t;&t;&t; *  YIKES!  I just discovered that SCSI IO which&n;&t;&t;&t; *  returns check condition, SenseKey=05 (ILLEGAL REQUEST)&n;&t;&t;&t; *  and ASC/ASCQ=94/01 (LSI Logic RAID vendor specific),&n;&t;&t;&t; *  comes down this path!&n;&t;&t;&t; *  Do upfront check for valid SenseData and give it&n;&t;&t;&t; *  precedence!&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
id|pScsiReply-&gt;SCSIStatus
suffix:semicolon
id|clear_sense_flag
c_func
(paren
id|hd
comma
id|pScsiReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
(brace
multiline_comment|/* Have already saved the status and sense data&n;&t;&t;&t;&t; */
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
(paren
id|MPI_SCSI_STATE_AUTOSENSE_FAILED
op_or
id|MPI_SCSI_STATE_NO_SCSI_STATUS
)paren
)paren
(brace
multiline_comment|/* What to do?&n;&t;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
(brace
multiline_comment|/*  Not real sure here either...  */
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* Give report and update residual count.&n;&t;&t;&t; */
id|xfer_cnt
op_assign
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;TransferCount
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  sc-&gt;underflow={report ERR if &lt; %02xh bytes xfer&squot;d}&bslash;n&quot;
comma
id|sc-&gt;underflow
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  ActBytesXferd=%02xh&bslash;n&quot;
comma
id|xfer_cnt
)paren
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
id|sc-&gt;resid
op_assign
id|sc-&gt;request_bufflen
op_minus
id|xfer_cnt
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  SET sc-&gt;resid=%02xh&bslash;n&quot;
comma
id|sc-&gt;resid
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Report Queue Full&n;&t;&t;&t; */
r_if
c_cond
(paren
id|sc-&gt;result
op_eq
id|MPI_SCSI_STATUS_TASK_SET_FULL
)paren
id|mptscsih_report_queue_full
c_func
(paren
id|sc
comma
id|pScsiReply
comma
id|pScsiReq
)paren
suffix:semicolon
multiline_comment|/* If regular Inquiry cmd and some data was transferred,&n;&t;&t;&t; * save inquiry data&n;&t;&t;&t; */
r_if
c_cond
(paren
id|pScsiReq-&gt;CDB
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
op_logical_neg
(paren
id|pScsiReq-&gt;CDB
(braket
l_int|1
)braket
op_amp
l_int|0x3
)paren
op_logical_and
id|xfer_cnt
op_ge
id|SCSI_STD_INQUIRY_BYTES
)paren
(brace
id|mptscsih_initTarget
c_func
(paren
id|hd
comma
id|hd-&gt;port
comma
id|sc-&gt;target
comma
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
comma
id|sc-&gt;buffer
comma
id|xfer_cnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
id|mptscsih_set_dvflags
c_func
(paren
id|hd
comma
id|pScsiReq
comma
id|sc-&gt;buffer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
suffix:colon
multiline_comment|/* 0x0040 */
r_case
id|MPI_IOCSTATUS_SUCCESS
suffix:colon
multiline_comment|/* 0x0000 */
id|sc-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
id|pScsiReply-&gt;SCSIStatus
suffix:semicolon
id|clear_sense_flag
c_func
(paren
id|hd
comma
id|pScsiReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * If running agains circa 200003dd 909 MPT f/w,&n;&t;&t;&t;&t; * may get this (AUTOSENSE_VALID) for actual TASK_SET_FULL&n;&t;&t;&t;&t; * (QUEUE_FULL) returned from device! --&gt; get 0x0000?128&n;&t;&t;&t;&t; * and with SenseBytes set to 0.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIStatus
op_eq
id|MPI_SCSI_STATUS_TASK_SET_FULL
)paren
id|mptscsih_report_queue_full
c_func
(paren
id|sc
comma
id|pScsiReply
comma
id|pScsiReq
)paren
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
multiline_comment|/* ADDED 20011120 -sralston&n;&t;&t;&t;&t; * Scsi mid-layer (old_eh) doesn&squot;t seem to like it&n;&t;&t;&t;&t; * when RAID returns SCSIStatus=02 (CHECK CONDITION),&n;&t;&t;&t;&t; * SenseKey=01 (RECOVERED ERROR), ASC/ASCQ=95/01.&n;&t;&t;&t;&t; * Seems to be * treating this as a IO error:-(&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; * So just lie about it altogether here.&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; * NOTE: It still gets reported to syslog via&n;&t;&t;&t;&t; * mpt_ScsiHost_ErrorReport from copy_sense_data&n;&t;&t;&t;&t; * call far above.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIStatus
op_eq
id|STS_CHECK_CONDITION
op_logical_and
id|SD_Sense_Key
c_func
(paren
id|sc-&gt;sense_buffer
)paren
op_eq
id|SK_RECOVERED_ERROR
)paren
(brace
id|sc-&gt;result
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
(paren
id|MPI_SCSI_STATE_AUTOSENSE_FAILED
op_or
id|MPI_SCSI_STATE_NO_SCSI_STATUS
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * What to do?&n;&t;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
(brace
multiline_comment|/*  Not real sure here either...  */
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_QUEUE_TAG_REJECTED
)paren
(brace
multiline_comment|/* Device Inq. data indicates that it supports&n;&t;&t;&t;&t; * QTags, but rejects QTag messages.&n;&t;&t;&t;&t; * This command completed OK.&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; * Not real sure here either so do nothing...  */
)brace
r_if
c_cond
(paren
id|sc-&gt;result
op_eq
id|MPI_SCSI_STATUS_TASK_SET_FULL
)paren
id|mptscsih_report_queue_full
c_func
(paren
id|sc
comma
id|pScsiReply
comma
id|pScsiReq
)paren
suffix:semicolon
multiline_comment|/* Add handling of:&n;&t;&t;&t; * Reservation Conflict, Busy,&n;&t;&t;&t; * Command Terminated, CHECK&n;&t;&t;&t; */
multiline_comment|/* If regular Inquiry cmd - save inquiry data&n;&t;&t;&t; */
id|xfer_cnt
op_assign
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;TransferCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;result
op_eq
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_logical_and
id|pScsiReq-&gt;CDB
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
op_logical_neg
(paren
id|pScsiReq-&gt;CDB
(braket
l_int|1
)braket
op_amp
l_int|0x3
)paren
op_logical_and
id|xfer_cnt
op_ge
id|SCSI_STD_INQUIRY_BYTES
)paren
(brace
id|mptscsih_initTarget
c_func
(paren
id|hd
comma
id|hd-&gt;port
comma
id|sc-&gt;target
comma
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
comma
id|sc-&gt;buffer
comma
id|xfer_cnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
id|mptscsih_set_dvflags
c_func
(paren
id|hd
comma
id|pScsiReq
comma
id|sc-&gt;buffer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR
suffix:colon
multiline_comment|/* 0x0047 */
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
(brace
multiline_comment|/*  Not real sure here either...  */
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INVALID_FUNCTION
suffix:colon
multiline_comment|/* 0x0001 */
r_case
id|MPI_IOCSTATUS_INVALID_SGL
suffix:colon
multiline_comment|/* 0x0003 */
r_case
id|MPI_IOCSTATUS_INTERNAL_ERROR
suffix:colon
multiline_comment|/* 0x0004 */
r_case
id|MPI_IOCSTATUS_RESERVED
suffix:colon
multiline_comment|/* 0x0005 */
r_case
id|MPI_IOCSTATUS_INSUFFICIENT_RESOURCES
suffix:colon
multiline_comment|/* 0x0006 */
r_case
id|MPI_IOCSTATUS_INVALID_FIELD
suffix:colon
multiline_comment|/* 0x0007 */
r_case
id|MPI_IOCSTATUS_INVALID_STATE
suffix:colon
multiline_comment|/* 0x0008 */
r_case
id|MPI_IOCSTATUS_SCSI_DATA_OVERRUN
suffix:colon
multiline_comment|/* 0x0044 */
r_case
id|MPI_IOCSTATUS_SCSI_IO_DATA_ERROR
suffix:colon
multiline_comment|/* 0x0046 */
r_case
id|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
suffix:colon
multiline_comment|/* 0x004A */
r_default
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * What to do?&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch(status) */
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  sc-&gt;result set to %08xh&bslash;n&quot;
comma
id|sc-&gt;result
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end of address reply case */
multiline_comment|/* Unmap the DMA buffers, if any. */
r_if
c_cond
(paren
id|sc-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|ioc-&gt;pcidev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|sc-&gt;request_buffer
comma
id|sc-&gt;use_sg
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|sc-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sc-&gt;request_bufflen
)paren
(brace
id|scPrivate
op_star
id|my_priv
suffix:semicolon
id|my_priv
op_assign
(paren
id|scPrivate
op_star
)paren
op_amp
id|sc-&gt;SCp
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
(paren
id|dma_addr_t
)paren
(paren
id|ulong
)paren
id|my_priv-&gt;p1
comma
id|sc-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|sc-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sc-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* CHECKME! - Do we need to clear this??? */
id|MPT_HOST_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sc
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|sc
)paren
suffix:semicolon
multiline_comment|/* Issue the command callback */
id|MPT_HOST_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Free Chain buffers */
id|mptscsih_freeChainBuffers
c_func
(paren
id|hd
comma
id|req_idx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifndef MPT_SCSI_USE_NEW_EH&t;/* { */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;search_taskQ - Search SCSI task mgmt request queue for specific&n; *&t;request type.&n; *&t;@remove: (Boolean) Should request be removed if found?&n; *&t;@sc: Pointer to Scsi_Cmnd structure&n; *&t;@task_type: Task type to search for&n; *&n; *&t;Returns pointer to MPT request frame if found, or %NULL if request&n; *&t;was not found.&n; */
r_static
id|MPT_FRAME_HDR
op_star
DECL|function|search_taskQ
id|search_taskQ
c_func
(paren
r_int
id|remove
comma
id|Scsi_Cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|task_type
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|list_sz
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: search_taskQ(%d,sc=%p,%d) called&bslash;n&quot;
comma
id|remove
comma
id|sc
comma
id|task_type
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_sz
op_assign
id|hd-&gt;taskQcnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;taskQ
)paren
)paren
(brace
id|mf
op_assign
id|hd-&gt;taskQ.head
suffix:semicolon
r_do
(brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mf-&gt;u.frame.linkage.argp1
op_eq
id|sc
op_logical_and
id|mf-&gt;u.frame.linkage.arg1
op_eq
id|task_type
)paren
(brace
r_if
c_cond
(paren
id|remove
)paren
(brace
id|Q_DEL_ITEM
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage
)paren
suffix:semicolon
id|hd-&gt;taskQcnt
op_decrement
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mpt_taskQdepth
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t save mf into nextmf because&n;&t;&t;&t;&t;&t; * exit after command has been deleted.&n;&t;&t;&t;&t;&t; */
multiline_comment|/* Place the MF back on the FreeQ */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
macro_line|#ifdef MFCNT
id|hd-&gt;ioc-&gt;mfcnt
op_decrement
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|mf
op_assign
id|mf-&gt;u.frame.linkage.forw
)paren
op_ne
(paren
id|MPT_FRAME_HDR
op_star
)paren
op_amp
id|hd-&gt;taskQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_eq
(paren
id|MPT_FRAME_HDR
op_star
)paren
op_amp
id|hd-&gt;taskQ
)paren
(brace
id|mf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_sz
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Results=%p (%sFOUND%s)!&bslash;n&quot;
comma
id|mf
comma
id|mf
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;NOT_&quot;
comma
(paren
id|mf
op_logical_and
id|remove
)paren
ques
c_cond
l_string|&quot;+REMOVED&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  (searched thru %d of %d items on taskQ)&bslash;n&quot;
comma
id|count
comma
id|list_sz
)paren
)paren
suffix:semicolon
)brace
r_return
id|mf
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;clean_taskQ - Clean the  SCSI task mgmt request for&n; *&t;&t;&t;this SCSI host instance.&n; *&t;@hd: MPT_SCSI_HOST pointer&n; *&n; *&t;Returns: None.&n; */
r_static
r_void
DECL|function|clean_taskQ
id|clean_taskQ
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|nextmf
op_assign
l_int|NULL
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: clean_taskQ called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;taskQ
)paren
)paren
(brace
id|mf
op_assign
id|hd-&gt;taskQ.head
suffix:semicolon
r_do
(brace
id|Q_DEL_ITEM
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage
)paren
suffix:semicolon
id|hd-&gt;taskQcnt
op_decrement
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mpt_taskQdepth
)paren
suffix:semicolon
id|nextmf
op_assign
id|mf-&gt;u.frame.linkage.forw
suffix:semicolon
multiline_comment|/* Place the MF back on the FreeQ */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|ioc-&gt;FreeQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
macro_line|#ifdef MFCNT
id|hd-&gt;ioc-&gt;mfcnt
op_decrement
suffix:semicolon
macro_line|#endif
)brace
r_while
c_loop
(paren
(paren
id|mf
op_assign
id|nextmf
)paren
op_ne
(paren
id|MPT_FRAME_HDR
op_star
)paren
op_amp
id|hd-&gt;taskQ
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;search_taskQ_for_cmd - Search the  SCSI task mgmt request queue for&n; *&t;&t;&t;the specified command. If found, delete&n; *&t;@hd: MPT_SCSI_HOST pointer&n; *&n; *&t;Returns: None.&n; */
r_static
r_void
DECL|function|search_taskQ_for_cmd
id|search_taskQ_for_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: search_taskQ_for_cmd(sc=%p) called&bslash;n&quot;
comma
id|sc
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;taskQ
)paren
)paren
(brace
id|mf
op_assign
id|hd-&gt;taskQ.head
suffix:semicolon
r_do
(brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mf-&gt;u.frame.linkage.argp1
op_eq
id|sc
)paren
(brace
id|Q_DEL_ITEM
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage
)paren
suffix:semicolon
id|hd-&gt;taskQcnt
op_decrement
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mpt_taskQdepth
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Cmd %p found! Deleting.&bslash;n&quot;
comma
id|sc
)paren
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t save mf into nextmf because&n;&t;&t;&t;&t; * exit after command has been deleted.&n;&t;&t;&t;&t; */
multiline_comment|/* Place the MF back on the FreeQ */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
macro_line|#ifdef MFCNT
id|hd-&gt;ioc-&gt;mfcnt
op_decrement
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|mf
op_assign
id|mf-&gt;u.frame.linkage.forw
)paren
op_ne
(paren
id|MPT_FRAME_HDR
op_star
)paren
op_amp
id|hd-&gt;taskQ
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif&t;&t;/* } MPT_SCSI_USE_NEW_EH */
multiline_comment|/*&n; * Flush all commands on the doneQ.&n; * Lock Q when deleting/adding members&n; * Lock io_request_lock for OS callback.&n; */
r_static
r_void
DECL|function|flush_doneQ
id|flush_doneQ
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
id|MPT_DONE_Q
op_star
id|buffer
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Flush the doneQ.&n;&t; */
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: flush_doneQ called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;doneQ
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|buffer
op_assign
id|hd-&gt;doneQ.head
suffix:semicolon
multiline_comment|/* Delete from Q&n;&t;&t; */
id|Q_DEL_ITEM
c_func
(paren
id|buffer
)paren
suffix:semicolon
multiline_comment|/* Set the Scsi_Cmnd pointer&n;&t;&t; */
id|SCpnt
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|buffer-&gt;argp
suffix:semicolon
id|buffer-&gt;argp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Add to the freeQ&n;&t;&t; */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;freeQ.head
comma
id|buffer
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Do the OS callback.&n;&t;&t; */
id|MPT_HOST_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|MPT_HOST_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Search the doneQ for a specific command. If found, delete from Q.&n; * Calling function will finish processing.&n; */
r_static
r_void
DECL|function|search_doneQ_for_cmd
id|search_doneQ_for_cmd
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|MPT_DONE_Q
op_star
id|buffer
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;doneQ
)paren
)paren
(brace
id|buffer
op_assign
id|hd-&gt;doneQ.head
suffix:semicolon
r_do
(brace
id|Scsi_Cmnd
op_star
id|sc
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|buffer-&gt;argp
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
id|sc
)paren
(brace
id|Q_DEL_ITEM
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|sc-&gt;result
suffix:semicolon
multiline_comment|/* Set the Scsi_Cmnd pointer&n;&t;&t;&t;&t; */
id|buffer-&gt;argp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Add to the freeQ&n;&t;&t;&t;&t; */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;freeQ.head
comma
id|buffer
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|buffer
op_assign
id|buffer-&gt;forw
)paren
op_ne
(paren
id|MPT_DONE_Q
op_star
)paren
op_amp
id|hd-&gt;doneQ
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;mptscsih_flush_running_cmds - For each command found, search&n; *&t;&t;Scsi_Host instance taskQ and reply to OS.&n; *&t;&t;Called only if recovering from a FW reload.&n; *&t;@hd: Pointer to a SCSI HOST structure&n; *&n; *&t;Returns: None.&n; *&n; *&t;Must be called while new I/Os are being queued.&n; */
r_static
r_void
DECL|function|mptscsih_flush_running_cmds
id|mptscsih_flush_running_cmds
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|max
op_assign
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: flush_ScsiLookup called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|max
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|SCpnt
op_assign
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Command found.&n;&t;&t;&t; */
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
multiline_comment|/* Search taskQ, if found, delete.&n;&t;&t;&t; */
id|search_taskQ_for_cmd
c_func
(paren
id|SCpnt
comma
id|hd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Search pendingQ, if found, &n;&t;&t;&t; * delete from Q. If found, do not decrement&n;&t;&t;&t; * queue_depth, command never posted.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mptscsih_search_pendingQ
c_func
(paren
id|hd
comma
id|ii
)paren
op_eq
l_int|NULL
)paren
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
multiline_comment|/* Null ScsiLookup index&n;&t;&t;&t; */
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
op_assign
l_int|NULL
suffix:semicolon
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|hd-&gt;ioc
comma
id|ii
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
l_string|&quot;flush: ScsiDone (mf=%p,sc=%p)&bslash;n&quot;
comma
id|mf
comma
id|SCpnt
)paren
)paren
suffix:semicolon
multiline_comment|/* Set status&n;&t;&t;&t; * Do OS callback&n;&t;&t;&t; * Free chain buffers&n;&t;&t;&t; * Free message frame&n;&t;&t;&t; */
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|MPT_HOST_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Issue the command callback */
id|MPT_HOST_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Free Chain buffers */
id|mptscsih_freeChainBuffers
c_func
(paren
id|hd
comma
id|ii
)paren
suffix:semicolon
multiline_comment|/* Free Message frames */
id|mpt_free_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_initChainBuffers - Allocate memory for and initialize&n; *&t;chain buffers, chain buffer control arrays and spinlock.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@init: If set, initialize the spin lock.&n; */
r_static
r_int
DECL|function|mptscsih_initChainBuffers
id|mptscsih_initChainBuffers
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|init
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|chain
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|sz
comma
id|ii
comma
id|numChain
suffix:semicolon
multiline_comment|/* Chain buffer allocations&n;&t; * Allocate and initialize tracker structures&n;&t; */
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;req_sz
op_le
l_int|64
)paren
id|numChain
op_assign
id|MPT_SG_REQ_64_SCALE
op_star
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;req_sz
op_le
l_int|96
)paren
id|numChain
op_assign
id|MPT_SG_REQ_96_SCALE
op_star
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
r_else
id|numChain
op_assign
id|MPT_SG_REQ_128_SCALE
op_star
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|sz
op_assign
id|numChain
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ReqToChain
op_eq
l_int|NULL
)paren
(brace
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|hd-&gt;ReqToChain
op_assign
(paren
r_int
op_star
)paren
id|mem
suffix:semicolon
)brace
r_else
(brace
id|mem
op_assign
(paren
id|u8
op_star
)paren
id|hd-&gt;ReqToChain
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0xFF
comma
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ChainToChain
op_eq
l_int|NULL
)paren
(brace
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|hd-&gt;ChainToChain
op_assign
(paren
r_int
op_star
)paren
id|mem
suffix:semicolon
)brace
r_else
(brace
id|mem
op_assign
(paren
id|u8
op_star
)paren
id|hd-&gt;ChainToChain
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0xFF
comma
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ChainBuffer
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Allocate free chain buffer pool&n;&t;&t; */
id|sz
op_assign
id|numChain
op_star
id|hd-&gt;ioc-&gt;req_sz
suffix:semicolon
id|mem
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hd-&gt;ioc-&gt;pcidev
comma
id|sz
comma
op_amp
id|hd-&gt;ChainBufferDMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|hd-&gt;ChainBuffer
op_assign
(paren
id|u8
op_star
)paren
id|mem
suffix:semicolon
)brace
r_else
(brace
id|mem
op_assign
(paren
id|u8
op_star
)paren
id|hd-&gt;ChainBuffer
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  ChainBuffer    @ %p(%p), sz=%d&bslash;n&quot;
comma
id|hd-&gt;ChainBuffer
comma
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|hd-&gt;ChainBufferDMA
comma
id|sz
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the free chain Q.&n;&t; */
r_if
c_cond
(paren
id|init
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|hd-&gt;FreeChainQlock
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|hd-&gt;FreeChainQlock
comma
id|flags
)paren
suffix:semicolon
id|Q_INIT
c_func
(paren
op_amp
id|hd-&gt;FreeChainQ
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
multiline_comment|/* Post the chain buffers to the FreeChainQ.&n;&t; */
id|mem
op_assign
(paren
id|u8
op_star
)paren
id|hd-&gt;ChainBuffer
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|numChain
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|chain
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|mem
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;FreeChainQ.head
comma
op_amp
id|chain-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|mem
op_add_assign
id|hd-&gt;ioc-&gt;req_sz
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;FreeChainQlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Hack! It might be nice to report if a device is returning QUEUE_FULL&n; *  but maybe not each and every time...&n; */
DECL|variable|last_queue_full
r_static
r_int
id|last_queue_full
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_report_queue_full - Report QUEUE_FULL status returned&n; *&t;from a SCSI target device.&n; *&t;@sc: Pointer to Scsi_Cmnd structure&n; *&t;@pScsiReply: Pointer to SCSIIOReply_t&n; *&t;@pScsiReq: Pointer to original SCSI request&n; *&n; *&t;This routine periodically reports QUEUE_FULL status returned from a&n; *&t;SCSI target device.  It reports this to the console via kernel&n; *&t;printk() API call, not more than once every 10 seconds.&n; */
r_static
r_void
DECL|function|mptscsih_report_queue_full
id|mptscsih_report_queue_full
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
comma
id|SCSIIORequest_t
op_star
id|pScsiReq
)paren
(brace
r_int
id|time
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|time
op_minus
id|last_queue_full
OG
l_int|10
op_star
id|HZ
)paren
(brace
r_char
op_star
id|ioc_str
op_assign
l_string|&quot;ioc?&quot;
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;host
op_ne
l_int|NULL
op_logical_and
id|sc-&gt;host-&gt;hostdata
op_ne
l_int|NULL
)paren
id|ioc_str
op_assign
(paren
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sc-&gt;host-&gt;hostdata
)paren
op_member_access_from_pointer
id|ioc-&gt;name
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Device (%d:%d:%d) reported QUEUE_FULL!&bslash;n&quot;
comma
id|ioc_str
comma
l_int|0
comma
id|sc-&gt;target
comma
id|sc-&gt;lun
)paren
suffix:semicolon
id|last_queue_full
op_assign
id|time
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|BeenHereDoneThat
r_static
r_int
id|BeenHereDoneThat
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  SCSI host fops start here...  */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_detect - Register MPT adapter(s) as SCSI host(s) with&n; *&t;linux scsi mid-layer.&n; *&t;@tpnt: Pointer to Scsi_Host_Template structure&n; *&n; *&t;(linux Scsi_Host_Template.detect routine)&n; *&n; *&t;Returns number of SCSI host adapters that were successfully&n; *&t;registered with the linux scsi mid-layer via the scsi_register()&n; *&t;API call.&n; */
r_int
DECL|function|mptscsih_detect
id|mptscsih_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|sh
op_assign
l_int|NULL
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
id|MPT_ADAPTER
op_star
id|this
suffix:semicolon
id|MPT_DONE_Q
op_star
id|freedoneQ
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|sz
comma
id|ii
suffix:semicolon
r_int
id|numSGE
op_assign
l_int|0
suffix:semicolon
r_int
id|scale
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|BeenHereDoneThat
op_increment
)paren
(brace
id|show_mptmod_ver
c_func
(paren
id|my_NAME
comma
id|my_VERSION
)paren
suffix:semicolon
id|ScsiDoneCtx
op_assign
id|mpt_register
c_func
(paren
id|mptscsih_io_done
comma
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
id|ScsiTaskCtx
op_assign
id|mpt_register
c_func
(paren
id|mptscsih_taskmgmt_complete
comma
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
id|ScsiScanDvCtx
op_assign
id|mpt_register
c_func
(paren
id|mptscsih_scandv_complete
comma
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
id|spin_lock_init
c_func
(paren
op_amp
id|mytaskQ_lock
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mpt_event_register
c_func
(paren
id|ScsiDoneCtx
comma
id|mptscsih_event_process
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered for IOC event notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FIXME! */
)brace
r_if
c_cond
(paren
id|mpt_reset_register
c_func
(paren
id|ScsiDoneCtx
comma
id|mptscsih_ioc_reset
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FIXME! */
)brace
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: mpt_scsih_detect()&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* Evaluate the command line arguments, if any */
r_if
c_cond
(paren
id|mptscsih
)paren
id|mptscsih_setup
c_func
(paren
id|mptscsih
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
id|atomic_set
c_func
(paren
op_amp
id|mpt_taskQdepth
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|this
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|this
op_ne
l_int|NULL
)paren
(brace
r_int
id|portnum
suffix:semicolon
r_for
c_loop
(paren
id|portnum
op_assign
l_int|0
suffix:semicolon
id|portnum
OL
id|this-&gt;facts.NumberOfPorts
suffix:semicolon
id|portnum
op_increment
)paren
(brace
multiline_comment|/* 20010215 -sralston&n;&t;&t;&t; *  Added sanity check on SCSI Initiator-mode enabled&n;&t;&t;&t; *  for this MPT adapter.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|this-&gt;pfacts
(braket
id|portnum
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_INITIATOR
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Skipping because SCSI Initiator mode is NOT enabled!&bslash;n&quot;
comma
id|this-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* 20010202 -sralston&n;&t;&t;&t; *  Added sanity check on readiness of the MPT adapter.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|this-&gt;last_state
op_ne
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Skipping because it&squot;s not operational!&bslash;n&quot;
comma
id|this-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)
id|tpnt-&gt;proc_dir
op_assign
op_amp
id|proc_mpt_scsihost
suffix:semicolon
macro_line|#endif
id|sh
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
id|MPT_SCSI_HOST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
op_ne
l_int|NULL
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sh-&gt;io_port
op_assign
l_int|0
suffix:semicolon
id|sh-&gt;n_io_port
op_assign
l_int|0
suffix:semicolon
id|sh-&gt;irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Yikes!  This is important!&n;&t;&t;&t;&t; * Otherwise, by default, linux&n;&t;&t;&t;&t; * only scans target IDs 0-7!&n;&t;&t;&t;&t; * pfactsN-&gt;MaxDevices unreliable&n;&t;&t;&t;&t; * (not supported in early&n;&t;&t;&t;&t; *&t;versions of the FW).&n;&t;&t;&t;&t; * max_id = 1 + actual max id,&n;&t;&t;&t;&t; * max_lun = 1 + actual last lun,&n;&t;&t;&t;&t; *&t;see hosts.h :o(&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
r_int
)paren
id|this-&gt;chip_type
OG
(paren
r_int
)paren
id|FC929
)paren
id|sh-&gt;max_id
op_assign
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
r_else
(brace
multiline_comment|/* For FC, increase the queue depth&n;&t;&t;&t;&t;&t; * from MPT_SCSI_CAN_QUEUE (31)&n;&t;&t;&t;&t;&t; * to MPT_FC_CAN_QUEUE (63).&n;&t;&t;&t;&t;&t; */
id|sh-&gt;can_queue
op_assign
id|MPT_FC_CAN_QUEUE
suffix:semicolon
id|sh-&gt;max_id
op_assign
id|MPT_MAX_FC_DEVICES
OL
l_int|256
ques
c_cond
id|MPT_MAX_FC_DEVICES
suffix:colon
l_int|255
suffix:semicolon
)brace
id|sh-&gt;max_lun
op_assign
id|MPT_LAST_LUN
op_plus
l_int|1
suffix:semicolon
id|sh-&gt;this_id
op_assign
id|this-&gt;pfacts
(braket
id|portnum
)braket
dot
id|PortSCSIID
suffix:semicolon
multiline_comment|/* OS entry to allow host drivers to force&n;&t;&t;&t;&t; * a queue depth on a per device basis.&n;&t;&t;&t;&t; */
id|sh-&gt;select_queue_depths
op_assign
id|mptscsih_select_queue_depths
suffix:semicolon
multiline_comment|/* Verify that we won&squot;t exceed the maximum&n;&t;&t;&t;&t; * number of chain buffers&n;&t;&t;&t;&t; * We can optimize:  ZZ = req_sz/sizeof(SGE)&n;&t;&t;&t;&t; * For 32bit SGE&squot;s:&n;&t;&t;&t;&t; *  numSGE = 1 + (ZZ-1)*(maxChain -1) + ZZ&n;&t;&t;&t;&t; *               + (req_sz - 64)/sizeof(SGE)&n;&t;&t;&t;&t; * A slightly different algorithm is required for&n;&t;&t;&t;&t; * 64bit SGEs.&n;&t;&t;&t;&t; */
id|scale
op_assign
id|this-&gt;req_sz
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
(brace
id|numSGE
op_assign
(paren
id|scale
op_minus
l_int|1
)paren
op_star
(paren
id|this-&gt;facts.MaxChainDepth
op_minus
l_int|1
)paren
op_plus
id|scale
op_plus
(paren
id|this-&gt;req_sz
op_minus
l_int|60
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|numSGE
op_assign
l_int|1
op_plus
(paren
id|scale
op_minus
l_int|1
)paren
op_star
(paren
id|this-&gt;facts.MaxChainDepth
op_minus
l_int|1
)paren
op_plus
id|scale
op_plus
(paren
id|this-&gt;req_sz
op_minus
l_int|64
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|numSGE
OL
id|sh-&gt;sg_tablesize
)paren
(brace
multiline_comment|/* Reset this value */
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Resetting sg_tablesize to %d from %d&bslash;n&quot;
comma
id|this-&gt;name
comma
id|numSGE
comma
id|sh-&gt;sg_tablesize
)paren
)paren
suffix:semicolon
id|sh-&gt;sg_tablesize
op_assign
id|numSGE
suffix:semicolon
)brace
multiline_comment|/* Set the pci device pointer in Scsi_Host structure.&n;&t;&t;&t;&t; */
id|scsi_set_pci_device
c_func
(paren
id|sh
comma
id|this-&gt;pcidev
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
id|hd-&gt;ioc
op_assign
id|this
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|this-&gt;chip_type
OG
(paren
r_int
)paren
id|FC929
)paren
id|hd-&gt;is_spi
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|DmpService
op_logical_and
(paren
id|this-&gt;chip_type
op_eq
id|FC919
op_logical_or
id|this-&gt;chip_type
op_eq
id|FC929
)paren
)paren
id|hd-&gt;is_multipath
op_assign
l_int|1
suffix:semicolon
id|hd-&gt;port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME! */
multiline_comment|/* SCSI needs Scsi_Cmnd lookup table!&n;&t;&t;&t;&t; * (with size equal to req_depth*PtrSz!)&n;&t;&t;&t;&t; */
id|sz
op_assign
id|hd-&gt;ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_goto
id|done
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|hd-&gt;ScsiLookup
op_assign
(paren
r_struct
id|scsi_cmnd
op_star
op_star
)paren
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;ScsiLookup @ %p, sz=%d&bslash;n&quot;
comma
id|this-&gt;name
comma
id|hd-&gt;ScsiLookup
comma
id|sz
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_initChainBuffers
c_func
(paren
id|hd
comma
l_int|1
)paren
OL
l_int|0
)paren
r_goto
id|done
suffix:semicolon
multiline_comment|/* Allocate memory for free and doneQ&squot;s&n;&t;&t;&t;&t; */
id|sz
op_assign
id|sh-&gt;can_queue
op_star
r_sizeof
(paren
id|MPT_DONE_Q
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_goto
id|done
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0xFF
comma
id|sz
)paren
suffix:semicolon
id|hd-&gt;memQ
op_assign
id|mem
suffix:semicolon
multiline_comment|/* Initialize the free, done and pending Qs.&n;&t;&t;&t;&t; */
id|Q_INIT
c_func
(paren
op_amp
id|hd-&gt;freeQ
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
id|Q_INIT
c_func
(paren
op_amp
id|hd-&gt;doneQ
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
id|Q_INIT
c_func
(paren
op_amp
id|hd-&gt;pendingQ
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
)paren
suffix:semicolon
id|mem
op_assign
id|hd-&gt;memQ
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|sh-&gt;can_queue
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|freedoneQ
op_assign
(paren
id|MPT_DONE_Q
op_star
)paren
id|mem
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;freeQ.head
comma
id|freedoneQ
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
id|mem
op_add_assign
r_sizeof
(paren
id|MPT_DONE_Q
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize this Scsi_Host&n;&t;&t;&t;&t; * internal task Q.&n;&t;&t;&t;&t; */
id|Q_INIT
c_func
(paren
op_amp
id|hd-&gt;taskQ
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|hd-&gt;taskQcnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allocate memory for the device structures.&n;&t;&t;&t;&t; * A non-Null pointer at an offset&n;&t;&t;&t;&t; * indicates a device exists.&n;&t;&t;&t;&t; * max_id = 1 + maximum id (hosts.h)&n;&t;&t;&t;&t; */
id|sz
op_assign
id|sh-&gt;max_id
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_goto
id|done
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|hd-&gt;Targets
op_assign
(paren
id|VirtDevice
op_star
op_star
)paren
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Targets @ %p, sz=%d&bslash;n&quot;
comma
id|hd-&gt;Targets
comma
id|sz
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the TM flags&n;&t;&t;&t;&t; */
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MPT_SCSI_USE_NEW_EH
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
macro_line|#endif
id|hd-&gt;resetPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;abortSCpnt
op_assign
l_int|NULL
suffix:semicolon
id|hd-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
id|hd-&gt;numTMrequests
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear the pointer used to store&n;&t;&t;&t;&t; * single-threaded commands, i.e., those&n;&t;&t;&t;&t; * issued during a bus scan, dv and&n;&t;&t;&t;&t; * configuration pages.&n;&t;&t;&t;&t; */
id|hd-&gt;cmdPtr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Attach the SCSI Host to the IOC structure&n;&t;&t;&t;&t; */
id|this-&gt;sh
op_assign
id|sh
suffix:semicolon
multiline_comment|/* Initialize this SCSI Hosts&squot; timers&n;&t;&t;&t;&t; * To use, set the timer expires field&n;&t;&t;&t;&t; * and add_timer&n;&t;&t;&t;&t; */
id|init_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|hd-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|hd
suffix:semicolon
id|hd-&gt;timer.function
op_assign
id|mptscsih_timer_expired
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
id|hd-&gt;TMtimer.data
op_assign
(paren
r_int
r_int
)paren
id|hd
suffix:semicolon
id|hd-&gt;TMtimer.function
op_assign
id|mptscsih_taskmgmt_timeout
suffix:semicolon
id|hd-&gt;qtag_tick
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Moved Earlier Pam D */
multiline_comment|/* this-&gt;sh = sh;&t;*/
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
(brace
multiline_comment|/* Update with the driver setup&n;&t;&t;&t;&t;&t; * values.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.maxBusWidth
OG
id|driver_setup.max_width
)paren
id|hd-&gt;ioc-&gt;spi_data.maxBusWidth
op_assign
id|driver_setup.max_width
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.minSyncFactor
OL
id|driver_setup.min_sync_fac
)paren
id|hd-&gt;ioc-&gt;spi_data.minSyncFactor
op_assign
id|driver_setup.min_sync_fac
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.minSyncFactor
op_eq
id|MPT_ASYNC
)paren
id|hd-&gt;ioc-&gt;spi_data.maxSyncOffset
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;negoNvram
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
id|hd-&gt;negoNvram
op_assign
id|MPT_SCSICFG_USE_NVRAM
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|driver_setup.dv
op_eq
l_int|0
)paren
id|hd-&gt;negoNvram
op_assign
id|MPT_SCSICFG_USE_NVRAM
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.forceDv
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_assign
id|MPT_SCSICFG_NEGOTIATE
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;dv %x width %x factor %x &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|driver_setup.dv
comma
id|driver_setup.max_width
comma
id|driver_setup.min_sync_fac
)paren
)paren
suffix:semicolon
)brace
id|mpt_scsi_hosts
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* for each adapter port */
id|this
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|this
)paren
suffix:semicolon
)brace
id|done
suffix:colon
r_if
c_cond
(paren
id|mpt_scsi_hosts
OG
l_int|0
)paren
id|register_reboot_notifier
c_func
(paren
op_amp
id|mptscsih_notifier
)paren
suffix:semicolon
r_return
id|mpt_scsi_hosts
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|info_kbuf
r_static
r_char
op_star
id|info_kbuf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_release - Unregister SCSI host from linux scsi mid-layer&n; *&t;@host: Pointer to Scsi_Host structure&n; *&n; *&t;(linux Scsi_Host_Template.release routine)&n; *&t;This routine releases all resources associated with the SCSI host&n; *&t;adapter.&n; *&n; *&t;Returns 0 for success.&n; */
r_int
DECL|function|mptscsih_release
id|mptscsih_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
macro_line|#ifndef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|dvtaskQ_release
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|count
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mytaskQ_bh_active
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Info: Zapping TaskMgmt thread!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|clean_taskQ
c_func
(paren
id|hd
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mytaskQ_bh_active
op_logical_and
op_decrement
id|count
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - TaskMgmt thread still active!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
multiline_comment|/* Check DV thread active */
id|count
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvtaskQ_active
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dvtaskQ_active
op_logical_and
op_decrement
id|count
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - DV thread still active!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if defined(MPT_DEBUG_DV) || defined(MPT_DEBUG_DV_TINY)
r_else
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: DV thread orig %d, count %d&bslash;n&quot;
comma
l_int|10
op_star
id|HZ
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|mptscsih_notifier
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_ne
l_int|NULL
)paren
(brace
r_int
id|sz1
comma
id|sz2
comma
id|sz3
comma
id|sztarget
op_assign
l_int|0
suffix:semicolon
r_int
id|szchain
op_assign
l_int|0
suffix:semicolon
r_int
id|szQ
op_assign
l_int|0
suffix:semicolon
r_int
id|scale
suffix:semicolon
multiline_comment|/* Synchronize disk caches&n;&t;&t; */
(paren
r_void
)paren
id|mptscsih_synchronize_cache
c_func
(paren
id|hd
comma
l_int|0
)paren
suffix:semicolon
id|sz1
op_assign
id|sz2
op_assign
id|sz3
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;req_sz
op_le
l_int|64
)paren
id|scale
op_assign
id|MPT_SG_REQ_64_SCALE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;req_sz
op_le
l_int|96
)paren
id|scale
op_assign
id|MPT_SG_REQ_96_SCALE
suffix:semicolon
r_else
id|scale
op_assign
id|MPT_SG_REQ_128_SCALE
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
op_ne
l_int|NULL
)paren
(brace
id|sz1
op_assign
id|hd-&gt;ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hd-&gt;ScsiLookup
)paren
suffix:semicolon
id|hd-&gt;ScsiLookup
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;ReqToChain
op_ne
l_int|NULL
)paren
(brace
id|szchain
op_add_assign
id|scale
op_star
id|hd-&gt;ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hd-&gt;ReqToChain
)paren
suffix:semicolon
id|hd-&gt;ReqToChain
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;ChainToChain
op_ne
l_int|NULL
)paren
(brace
id|szchain
op_add_assign
id|scale
op_star
id|hd-&gt;ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hd-&gt;ChainToChain
)paren
suffix:semicolon
id|hd-&gt;ChainToChain
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;ChainBuffer
op_ne
l_int|NULL
)paren
(brace
id|sz2
op_assign
id|scale
op_star
id|hd-&gt;ioc-&gt;req_depth
op_star
id|hd-&gt;ioc-&gt;req_sz
suffix:semicolon
id|szchain
op_add_assign
id|sz2
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|hd-&gt;ioc-&gt;pcidev
comma
id|sz2
comma
id|hd-&gt;ChainBuffer
comma
id|hd-&gt;ChainBufferDMA
)paren
suffix:semicolon
id|hd-&gt;ChainBuffer
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;memQ
op_ne
l_int|NULL
)paren
(brace
id|szQ
op_assign
id|host-&gt;can_queue
op_star
r_sizeof
(paren
id|MPT_DONE_Q
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hd-&gt;memQ
)paren
suffix:semicolon
id|hd-&gt;memQ
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;Targets
op_ne
l_int|NULL
)paren
(brace
r_int
id|max
comma
id|ii
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Free any target structures that were allocated.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
(brace
id|max
op_assign
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
)brace
r_else
(brace
id|max
op_assign
id|MPT_MAX_FC_DEVICES
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|max
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;Targets
(braket
id|ii
)braket
)paren
(brace
id|kfree
c_func
(paren
id|hd-&gt;Targets
(braket
id|ii
)braket
)paren
suffix:semicolon
id|hd-&gt;Targets
(braket
id|ii
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sztarget
op_add_assign
r_sizeof
(paren
id|VirtDevice
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t;&t; * Free pointer array.&n;&t;&t;&t; */
id|sz3
op_assign
id|max
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hd-&gt;Targets
)paren
suffix:semicolon
id|hd-&gt;Targets
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Free&squot;d ScsiLookup (%d), chain (%d) and Target (%d+%d) memory&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|sz1
comma
id|szchain
comma
id|sz3
comma
id|sztarget
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
l_string|&quot;Free&squot;d done and free Q (%d) memory&bslash;n&quot;
comma
id|szQ
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* NULL the Scsi_Host pointer&n;&t; */
id|hd-&gt;ioc-&gt;sh
op_assign
l_int|NULL
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_scsi_hosts
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|mpt_scsi_hosts
op_eq
l_int|0
)paren
(brace
id|mpt_reset_deregister
c_func
(paren
id|ScsiDoneCtx
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mpt_event_deregister
c_func
(paren
id|ScsiDoneCtx
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered for IOC event notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|ScsiScanDvCtx
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|ScsiTaskCtx
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|ScsiDoneCtx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info_kbuf
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|info_kbuf
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_halt - Process the reboot notification&n; *&t;@nb: Pointer to a struct notifier_block (ignored)&n; *&t;@event: event (SYS_HALT, SYS_RESTART, SYS_POWER_OFF)&n; *&t;@buf: Pointer to a data buffer (ignored)&n; *&n; *&t;This routine called if a system shutdown or reboot is to occur.&n; *&n; *&t;Return NOTIFY_DONE if this is something other than a reboot message.&n; *&t;&t;NOTIFY_OK if this is a reboot message.&n; */
r_static
r_int
DECL|function|mptscsih_halt
id|mptscsih_halt
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
id|ulong
id|event
comma
r_void
op_star
id|buf
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
l_int|NULL
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Ignore all messages other than reboot message&n;&t; */
r_if
c_cond
(paren
(paren
id|event
op_ne
id|SYS_RESTART
)paren
op_logical_and
(paren
id|event
op_ne
id|SYS_HALT
)paren
op_logical_and
(paren
id|event
op_ne
id|SYS_POWER_OFF
)paren
)paren
r_return
(paren
id|NOTIFY_DONE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ioc
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
id|ioc
op_ne
l_int|NULL
suffix:semicolon
id|ioc
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|ioc
)paren
)paren
(brace
multiline_comment|/* Flush the cache of this adapter&n;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
)paren
(brace
id|mptscsih_synchronize_cache
c_func
(paren
id|hd
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|mptscsih_notifier
)paren
suffix:semicolon
r_return
id|NOTIFY_OK
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_info - Return information about MPT adapter&n; *&t;@SChost: Pointer to Scsi_Host structure&n; *&n; *&t;(linux Scsi_Host_Template.info routine)&n; *&n; *&t;Returns pointer to buffer where information was written.&n; */
r_const
r_char
op_star
DECL|function|mptscsih_info
id|mptscsih_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|SChost
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|h
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info_kbuf
op_eq
l_int|NULL
)paren
r_if
c_cond
(paren
(paren
id|info_kbuf
op_assign
id|kmalloc
c_func
(paren
l_int|0x1000
multiline_comment|/* 4Kb */
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|info_kbuf
suffix:semicolon
id|h
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SChost-&gt;hostdata
suffix:semicolon
id|info_kbuf
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|mpt_print_ioc_summary
c_func
(paren
id|h-&gt;ioc
comma
id|info_kbuf
comma
op_amp
id|size
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|info_kbuf
(braket
id|size
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|info_kbuf
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|max_qd
r_static
r_int
id|max_qd
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|index_log
(braket
l_int|128
)braket
suffix:semicolon
r_static
r_int
id|index_ent
op_assign
l_int|0
suffix:semicolon
r_static
id|__inline__
r_void
id|ADD_INDEX_LOG
c_func
(paren
r_int
id|req_ent
)paren
(brace
r_int
id|i
op_assign
id|index_ent
op_increment
suffix:semicolon
id|index_log
(braket
id|i
op_amp
(paren
l_int|128
op_minus
l_int|1
)paren
)braket
op_assign
id|req_ent
suffix:semicolon
)brace
macro_line|#else
DECL|macro|ADD_INDEX_LOG
mdefine_line|#define ADD_INDEX_LOG(req_ent)&t;do { } while(0)
macro_line|#endif
macro_line|#ifdef&t;DROP_TEST
DECL|macro|DROP_IOC
mdefine_line|#define DROP_IOC&t;1&t;/* IOC to force failures */
DECL|macro|DROP_TARGET
mdefine_line|#define DROP_TARGET&t;3&t;/* Target ID to force failures */
DECL|macro|DROP_THIS_CMD
mdefine_line|#define&t;DROP_THIS_CMD&t;10000&t;/* iteration to drop command */
DECL|variable|dropCounter
r_static
r_int
id|dropCounter
op_assign
l_int|0
suffix:semicolon
DECL|variable|dropTestOK
r_static
r_int
id|dropTestOK
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* num did good */
DECL|variable|dropTestBad
r_static
r_int
id|dropTestBad
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* num did bad */
DECL|variable|dropTestNum
r_static
r_int
id|dropTestNum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* total = good + bad + incomplete */
DECL|variable|numTotCmds
r_static
r_int
id|numTotCmds
op_assign
l_int|0
suffix:semicolon
DECL|variable|dropMfPtr
r_static
id|MPT_FRAME_HDR
op_star
id|dropMfPtr
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|numTMrequested
r_static
r_int
id|numTMrequested
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_put_msgframe - Wrapper routine to post message frame to F/W.&n; *&t;@context: Call back context (ScsiDoneCtx, ScsiScanDvCtx) &n; *&t;@id: IOC id number &n; *&t;@mf: Pointer to message frame &n; *&n; *&t;Handles the call to mptbase for posting request and queue depth &n; *&t;tracking.&n; *&n; *&t;Returns none.&n; */
r_static
r_void
DECL|function|mptscsih_put_msgframe
id|mptscsih_put_msgframe
c_func
(paren
r_int
id|context
comma
r_int
id|id
comma
id|MPT_FRAME_HDR
op_star
id|mf
)paren
(brace
multiline_comment|/* Main banana... */
id|atomic_inc
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
OG
id|max_qd
)paren
(brace
id|max_qd
op_assign
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Queue depth now %d.&bslash;n&quot;
comma
id|max_qd
)paren
)paren
suffix:semicolon
)brace
id|mpt_put_msg_frame
c_func
(paren
id|context
comma
id|id
comma
id|mf
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_qcmd - Primary Fusion MPT SCSI initiator IO start routine.&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure&n; *&t;@done: Pointer SCSI mid-layer IO completion function&n; *&n; *&t;(linux Scsi_Host_Template.queuecommand routine)&n; *&t;This is the primary SCSI IO start routine.  Create a MPI SCSIIORequest&n; *&t;from a linux Scsi_Cmnd request and send it to the IOC.&n; *&n; *&t;Returns 0. (rtn value discarded by linux scsi mid-layer)&n; */
r_int
DECL|function|mptscsih_qcmd
id|mptscsih_qcmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pScsiReq
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
id|MPT_DONE_Q
op_star
id|buffer
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|target
suffix:semicolon
r_int
id|lun
suffix:semicolon
r_int
id|datadir
suffix:semicolon
id|u32
id|datalen
suffix:semicolon
id|u32
id|scsictl
suffix:semicolon
id|u32
id|scsidir
suffix:semicolon
id|u32
id|qtag
suffix:semicolon
id|u32
id|cmd_len
suffix:semicolon
r_int
id|my_idx
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|did_errcode
suffix:semicolon
r_int
id|issueCmd
suffix:semicolon
id|did_errcode
op_assign
l_int|0
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|lun
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|target
)braket
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;qcmd: SCpnt=%p, done()=%p&bslash;n&quot;
comma
(paren
id|hd
op_logical_and
id|hd-&gt;ioc
)paren
ques
c_cond
id|hd-&gt;ioc-&gt;name
suffix:colon
l_string|&quot;ioc?&quot;
comma
id|SCpnt
comma
id|done
)paren
)paren
suffix:semicolon
multiline_comment|/* 20000617 -sralston&n;&t; *  GRRRRR...  Shouldn&squot;t have to do this but...&n;&t; *  Do explicit check for REQUEST_SENSE and cached SenseData.&n;&t; *  If yes, return cached SenseData.&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
(brace
id|u8
op_star
id|dest
op_assign
l_int|NULL
suffix:semicolon
r_int
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_SENSE
)paren
)paren
(brace
id|pTarget-&gt;tflags
op_and_assign
op_complement
id|MPT_TARGET_FLAGS_VALID_SENSE
suffix:semicolon
singleline_comment|//sjr-moved-here
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;use_sg
)paren
(brace
id|dest
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
)brace
r_else
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|sg
)paren
id|dest
op_assign
(paren
id|u8
op_star
)paren
(paren
id|ulong
)paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dest
)paren
(brace
id|sz
op_assign
id|MIN
(paren
id|SCSI_STD_SENSE_BYTES
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dest
comma
id|pTarget-&gt;sense
comma
id|sz
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
id|SCpnt-&gt;resid
op_assign
id|SCpnt-&gt;request_bufflen
op_minus
id|sz
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
singleline_comment|//sjr-moved-up//pTarget-&gt;tflags &amp;= ~MPT_TARGET_FLAGS_VALID_SENSE;
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|hd-&gt;resetPending
)paren
(brace
multiline_comment|/* Prevent new commands from being issued&n;&t;&t; * while reloading the FW.&n;&t;&t; */
id|did_errcode
op_assign
l_int|1
suffix:semicolon
r_goto
id|did_error
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Put together a MPT SCSI request...&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;QueueCmd, no msg frames!!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|did_errcode
op_assign
l_int|2
suffix:semicolon
r_goto
id|did_error
suffix:semicolon
)brace
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|my_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|ADD_INDEX_LOG
c_func
(paren
id|my_idx
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  The scsi layer should be handling this stuff&n;&t; *  (In 2.3.x it does -DaveM)&n;&t; */
multiline_comment|/*  BUG FIX!  19991030 -sralston&n;&t; *    TUR&squot;s being issued with scsictl=0x02000000 (DATA_IN)!&n;&t; *    Seems we may receive a buffer (datalen&gt;0) even when there&n;&t; *    will be no data transfer!  GRRRRR...&n;&t; */
id|datadir
op_assign
id|mptscsih_io_direction
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datadir
op_eq
id|SCSI_DATA_READ
)paren
(brace
id|datalen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
multiline_comment|/* DATA IN  (host&lt;--ioc&lt;--dev) */
)brace
r_else
r_if
c_cond
(paren
id|datadir
op_eq
id|SCSI_DATA_WRITE
)paren
(brace
id|datalen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
multiline_comment|/* DATA OUT (host--&gt;ioc--&gt;dev) */
)brace
r_else
(brace
id|datalen
op_assign
l_int|0
suffix:semicolon
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_NODATATRANSFER
suffix:semicolon
)brace
multiline_comment|/* Default to untagged. Once a target structure has been allocated,&n;&t; * use the Inquiry data to determine if device supports tagged.&n;&t; */
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_UNTAGGED
suffix:semicolon
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
op_logical_and
(paren
id|SCpnt-&gt;device-&gt;tagged_supported
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Some drives are too stupid to handle fairness issues&n;&t;&t; *  with tagged queueing. We throw in the odd ordered&n;&t;&t; *  tag to stop them starving themselves.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|hd-&gt;qtag_tick
)paren
OG
(paren
l_int|5
op_star
id|HZ
)paren
)paren
(brace
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_ORDEREDQ
suffix:semicolon
id|hd-&gt;qtag_tick
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_SIMPLEQ
suffix:semicolon
)brace
id|scsictl
op_assign
id|scsidir
op_or
id|qtag
suffix:semicolon
multiline_comment|/* Use the above information to set up the message frame&n;&t; */
id|pScsiReq-&gt;TargetID
op_assign
id|target
suffix:semicolon
id|pScsiReq-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
id|pScsiReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_IO_REQUEST
suffix:semicolon
id|pScsiReq-&gt;CDBLength
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|MPT_SENSE_BUFFER_SIZE
suffix:semicolon
id|pScsiReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;MsgFlags
op_assign
id|mpt_msg_flags
c_func
(paren
)paren
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
op_assign
id|lun
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|scsictl
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Write SCSI CDB into the message&n;&t; */
id|cmd_len
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|cmd_len
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiReq-&gt;CDB
(braket
id|ii
)braket
op_assign
id|SCpnt-&gt;cmnd
(braket
id|ii
)braket
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
id|cmd_len
suffix:semicolon
id|ii
OL
l_int|16
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiReq-&gt;CDB
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DataLength */
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|datalen
)paren
suffix:semicolon
multiline_comment|/* SenseBuffer low address */
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|hd-&gt;ioc-&gt;sense_buf_low_dma
op_plus
(paren
id|my_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
multiline_comment|/* Now add the SG list&n;&t; * Always have a SGE even if null length.&n;&t; */
id|rc
op_assign
id|SUCCESS
suffix:semicolon
r_if
c_cond
(paren
id|datalen
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Add a NULL SGE */
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pScsiReq-&gt;SGL
comma
id|MPT_SGE_FLAGS_SSIMPLE_READ
op_or
l_int|0
comma
(paren
id|dma_addr_t
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Add a 32 or 64 bit SGE */
id|rc
op_assign
id|mptscsih_AddSGE
c_func
(paren
id|hd
comma
id|SCpnt
comma
id|pScsiReq
comma
id|my_idx
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
id|SUCCESS
)paren
(brace
id|hd-&gt;ScsiLookup
(braket
id|my_idx
)braket
op_assign
id|SCpnt
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef&t;DROP_TEST
id|numTotCmds
op_increment
suffix:semicolon
multiline_comment|/* If the IOC number and target match, increment&n;&t;&t; * counter. If counter matches DROP_THIS, do not&n;&t;&t; * issue command to FW to force a reset.&n;&t;&t; * Save the MF pointer so we can free resources&n;&t;&t; * when task mgmt completes.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;id
op_eq
id|DROP_IOC
)paren
op_logical_and
(paren
id|target
op_eq
id|DROP_TARGET
)paren
)paren
(brace
id|dropCounter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dropCounter
op_eq
id|DROP_THIS_CMD
)paren
(brace
id|dropCounter
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If global is set, then we are already&n;&t;&t;&t;&t; * doing something - so keep issuing commands.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|dropMfPtr
op_eq
l_int|NULL
)paren
(brace
id|dropTestNum
op_increment
suffix:semicolon
id|dropMfPtr
op_assign
id|mf
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Dropped SCSI cmd (%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mf (%p) req (%4x) tot cmds (%d)&bslash;n&quot;
comma
id|mf
comma
id|my_idx
comma
id|numTotCmds
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/* SCSI specific processing */
id|issueCmd
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
(brace
r_int
id|dvStatus
op_assign
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|target
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dvStatus
op_logical_or
id|hd-&gt;ioc-&gt;spi_data.forceDv
)paren
(brace
multiline_comment|/* Write SDP1 on this I/O to this target */
r_if
c_cond
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_NEGOTIATE
)paren
(brace
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
id|target
comma
id|hd-&gt;negoNvram
)paren
suffix:semicolon
id|dvStatus
op_and_assign
op_complement
id|MPT_SCSICFG_NEGOTIATE
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|target
)braket
op_assign
id|dvStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_BLK_NEGO
)paren
(brace
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
id|target
comma
id|MPT_SCSICFG_BLK_NEGO
)paren
suffix:semicolon
id|dvStatus
op_and_assign
op_complement
id|MPT_SCSICFG_BLK_NEGO
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|target
)braket
op_assign
id|dvStatus
suffix:semicolon
)brace
macro_line|#ifndef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
r_if
c_cond
(paren
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_NEED_DV
)paren
op_logical_or
id|hd-&gt;ioc-&gt;spi_data.forceDv
)paren
(brace
r_int
r_int
id|lflags
suffix:semicolon
multiline_comment|/* Schedule DV if necessary */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dvtaskQ_active
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
id|mptscsih_dvTask.sync
op_assign
l_int|0
suffix:semicolon
id|mptscsih_dvTask.routine
op_assign
id|mptscsih_domainValidation
suffix:semicolon
id|mptscsih_dvTask.data
op_assign
(paren
r_void
op_star
)paren
id|hd
suffix:semicolon
id|SCHEDULE_TASK
c_func
(paren
op_amp
id|mptscsih_dvTask
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
)brace
id|hd-&gt;ioc-&gt;spi_data.forceDv
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Trying to do DV to this target, extend timeout.&n;&t;&t;&t;&t; * Wait to issue intil flag is clear &n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_DV_PENDING
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|SCpnt-&gt;eh_timeout
comma
id|jiffies
op_plus
l_int|40
op_star
id|HZ
)paren
suffix:semicolon
id|issueCmd
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|issueCmd
)paren
(brace
id|mptscsih_put_msgframe
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Issued SCSI cmd (%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Pending SCSI cmd (%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
multiline_comment|/* Place this command on the pendingQ if possible */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;freeQ
)paren
)paren
(brace
id|buffer
op_assign
id|hd-&gt;freeQ.head
suffix:semicolon
id|Q_DEL_ITEM
c_func
(paren
id|buffer
)paren
suffix:semicolon
multiline_comment|/* Save the mf pointer&n;&t;&t;&t;&t; */
id|buffer-&gt;argp
op_assign
(paren
r_void
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Add to the pendingQ&n;&t;&t;&t;&t; */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;pendingQ.head
comma
id|buffer
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|mptscsih_freeChainBuffers
c_func
(paren
id|hd
comma
id|my_idx
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|did_errcode
op_assign
l_int|3
suffix:semicolon
r_goto
id|did_error
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|did_error
suffix:colon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;_qcmd did_errcode=%d (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|did_errcode
comma
id|SCpnt
)paren
)paren
suffix:semicolon
multiline_comment|/* Just wish OS to issue a retry */
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;freeQ
)paren
)paren
(brace
id|buffer
op_assign
id|hd-&gt;freeQ.head
suffix:semicolon
id|Q_DEL_ITEM
c_func
(paren
id|buffer
)paren
suffix:semicolon
multiline_comment|/* Set the Scsi_Cmnd pointer&n;&t;&t; */
id|buffer-&gt;argp
op_assign
(paren
r_void
op_star
)paren
id|SCpnt
suffix:semicolon
multiline_comment|/* Add to the doneQ&n;&t;&t; */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;doneQ.head
comma
id|buffer
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_AddSGE - Add a SGE (plus chain buffers) to the&n; *&t;SCSIIORequest_t Message Frame.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure&n; *&t;@pReq: Pointer to SCSIIORequest_t structure&n; *&n; *&t;Returns ...&n; */
r_static
r_int
DECL|function|mptscsih_AddSGE
id|mptscsih_AddSGE
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
id|SCSIIORequest_t
op_star
id|pReq
comma
r_int
id|req_idx
)paren
(brace
r_char
op_star
id|psge
suffix:semicolon
r_char
op_star
id|chainSge
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|frm_sz
suffix:semicolon
r_int
id|sges_left
comma
id|sg_done
suffix:semicolon
r_int
id|chain_idx
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
r_int
id|sgeOffset
suffix:semicolon
r_int
id|numSgeSlots
comma
id|numSgeThisFrame
suffix:semicolon
id|u32
id|sgflags
comma
id|sgdir
comma
id|thisxfer
op_assign
l_int|0
suffix:semicolon
r_int
id|chain_dma_off
op_assign
l_int|0
suffix:semicolon
r_int
id|newIndex
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|dma_addr_t
id|v2
suffix:semicolon
id|sgdir
op_assign
id|le32_to_cpu
c_func
(paren
id|pReq-&gt;Control
)paren
op_amp
id|MPI_SCSIIO_CONTROL_DATADIRECTION_MASK
suffix:semicolon
r_if
c_cond
(paren
id|sgdir
op_eq
id|MPI_SCSIIO_CONTROL_WRITE
)paren
(brace
id|sgdir
op_assign
id|MPT_TRANSFER_HOST_TO_IOC
suffix:semicolon
)brace
r_else
(brace
id|sgdir
op_assign
id|MPT_TRANSFER_IOC_TO_HOST
suffix:semicolon
)brace
id|psge
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;SGL
suffix:semicolon
id|frm_sz
op_assign
id|hd-&gt;ioc-&gt;req_sz
suffix:semicolon
multiline_comment|/* Map the data portion, if any.&n;&t; * sges_left  = 0 if no data transfer.&n;&t; */
id|sges_left
op_assign
id|SCpnt-&gt;use_sg
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|sges_left
op_assign
id|pci_map_sg
c_func
(paren
id|hd-&gt;ioc-&gt;pcidev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;use_sg
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|SCpnt-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;request_bufflen
)paren
(brace
id|dma_addr_t
id|buf_dma_addr
suffix:semicolon
id|scPrivate
op_star
id|my_priv
suffix:semicolon
id|buf_dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|hd-&gt;ioc-&gt;pcidev
comma
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|SCpnt-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
multiline_comment|/* We hide it here for later unmap. */
id|my_priv
op_assign
(paren
id|scPrivate
op_star
)paren
op_amp
id|SCpnt-&gt;SCp
suffix:semicolon
id|my_priv-&gt;p1
op_assign
(paren
r_void
op_star
)paren
(paren
id|ulong
)paren
id|buf_dma_addr
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SG: non-SG for %p, len=%d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
comma
id|SCpnt-&gt;request_bufflen
)paren
)paren
suffix:semicolon
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;SGL
comma
l_int|0xD1000000
op_or
id|MPT_SGE_FLAGS_ADDRESSING
op_or
id|sgdir
op_or
id|SCpnt-&gt;request_bufflen
comma
id|buf_dma_addr
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/* Handle the SG case.&n;&t; */
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|sg_done
op_assign
l_int|0
suffix:semicolon
id|sgeOffset
op_assign
r_sizeof
(paren
id|SCSIIORequest_t
)paren
op_minus
r_sizeof
(paren
id|SGE_IO_UNION
)paren
suffix:semicolon
id|chainSge
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Prior to entering this loop - the following must be set&n;&t; * current MF:  sgeOffset (bytes)&n;&t; *              chainSge (Null if original MF is not a chain buffer)&n;&t; *              sg_done (num SGE done for this MF)&n;&t; */
id|nextSGEset
suffix:colon
id|numSgeSlots
op_assign
(paren
(paren
id|frm_sz
op_minus
id|sgeOffset
)paren
op_div
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
)paren
suffix:semicolon
id|numSgeThisFrame
op_assign
(paren
id|sges_left
OL
id|numSgeSlots
)paren
ques
c_cond
id|sges_left
suffix:colon
id|numSgeSlots
suffix:semicolon
id|sgflags
op_assign
id|MPT_SGE_FLAGS_SIMPLE_ELEMENT
op_or
id|MPT_SGE_FLAGS_ADDRESSING
op_or
id|sgdir
suffix:semicolon
multiline_comment|/* Get first (num - 1) SG elements&n;&t; * Skip any SG entries with a length of 0&n;&t; * NOTE: at finish, sg and psge pointed to NEXT data/location positions&n;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
(paren
id|numSgeThisFrame
op_minus
l_int|1
)paren
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|thisxfer
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|thisxfer
op_eq
l_int|0
)paren
(brace
id|sg
op_increment
suffix:semicolon
multiline_comment|/* Get next SG element from the OS */
id|sg_done
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|v2
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|mpt_add_sge
c_func
(paren
id|psge
comma
id|sgflags
op_or
id|thisxfer
comma
id|v2
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
multiline_comment|/* Get next SG element from the OS */
id|psge
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|sgeOffset
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|sg_done
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|numSgeThisFrame
op_eq
id|sges_left
)paren
(brace
multiline_comment|/* Add last element, end of buffer and end of list flags.&n;&t;&t; */
id|sgflags
op_or_assign
id|MPT_SGE_FLAGS_LAST_ELEMENT
op_or
id|MPT_SGE_FLAGS_END_OF_BUFFER
op_or
id|MPT_SGE_FLAGS_END_OF_LIST
suffix:semicolon
multiline_comment|/* Add last SGE and set termination flags.&n;&t;&t; * Note: Last SGE may have a length of 0 - which should be ok.&n;&t;&t; */
id|thisxfer
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
id|v2
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|mpt_add_sge
c_func
(paren
id|psge
comma
id|sgflags
op_or
id|thisxfer
comma
id|v2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;sg++;&n;&t;&t;psge += (sizeof(u32) + sizeof(dma_addr_t));&n;&t;&t;*/
id|sgeOffset
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|sg_done
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|chainSge
)paren
(brace
multiline_comment|/* The current buffer is a chain buffer,&n;&t;&t;&t; * but there is not another one.&n;&t;&t;&t; * Update the chain element&n;&t;&t;&t; * Offset and Length fields.&n;&t;&t;&t; */
id|mpt_add_chain
c_func
(paren
(paren
r_char
op_star
)paren
id|chainSge
comma
l_int|0
comma
id|sgeOffset
comma
id|hd-&gt;ChainBufferDMA
op_plus
id|chain_dma_off
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The current buffer is the original MF&n;&t;&t;&t; * and there is no Chain buffer.&n;&t;&t;&t; */
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* At least one chain buffer is needed.&n;&t;&t; * Complete the first MF&n;&t;&t; *  - last SGE element, set the LastElement bit&n;&t;&t; *  - set ChainOffset (words) for orig MF&n;&t;&t; *             (OR finish previous MF chain buffer)&n;&t;&t; *  - update MFStructPtr ChainIndex&n;&t;&t; *  - Populate chain element&n;&t;&t; * Also&n;&t;&t; * Loop until done.&n;&t;&t; */
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SG: Chain Required! sg done %d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|sg_done
)paren
)paren
suffix:semicolon
multiline_comment|/* Set LAST_ELEMENT flag for last non-chain element&n;&t;&t; * in the buffer. Since psge points at the NEXT&n;&t;&t; * SGE element, go back one SGE element, update the flags&n;&t;&t; * and reset the pointer. (Note: sgflags &amp; thisxfer are already&n;&t;&t; * set properly).&n;&t;&t; */
r_if
c_cond
(paren
id|sg_done
)paren
(brace
id|u32
op_star
id|ptmp
op_assign
(paren
id|u32
op_star
)paren
(paren
id|psge
op_minus
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
)paren
suffix:semicolon
id|sgflags
op_assign
id|le32_to_cpu
c_func
(paren
op_star
id|ptmp
)paren
suffix:semicolon
id|sgflags
op_or_assign
id|MPT_SGE_FLAGS_LAST_ELEMENT
suffix:semicolon
op_star
id|ptmp
op_assign
id|cpu_to_le32
c_func
(paren
id|sgflags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chainSge
)paren
(brace
multiline_comment|/* The current buffer is a chain buffer.&n;&t;&t;&t; * chainSge points to the previous Chain Element.&n;&t;&t;&t; * Update its chain element Offset and Length (must&n;&t;&t;&t; * include chain element size) fields.&n;&t;&t;&t; * Old chain element is now complete.&n;&t;&t;&t; */
id|u8
id|nextChain
op_assign
(paren
id|u8
)paren
(paren
id|sgeOffset
op_rshift
l_int|2
)paren
suffix:semicolon
id|sgeOffset
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|mpt_add_chain
c_func
(paren
(paren
r_char
op_star
)paren
id|chainSge
comma
id|nextChain
comma
id|sgeOffset
comma
id|hd-&gt;ChainBufferDMA
op_plus
id|chain_dma_off
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The original MF buffer requires a chain buffer -&n;&t;&t;&t; * set the offset.&n;&t;&t;&t; * Last element in this MF is a chain element.&n;&t;&t;&t; */
id|pReq-&gt;ChainOffset
op_assign
(paren
id|u8
)paren
(paren
id|sgeOffset
op_rshift
l_int|2
)paren
suffix:semicolon
)brace
id|sges_left
op_sub_assign
id|sg_done
suffix:semicolon
multiline_comment|/* NOTE: psge points to the beginning of the chain element&n;&t;&t; * in current buffer. Get a chain buffer.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|mptscsih_getFreeChainBuffer
c_func
(paren
id|hd
comma
op_amp
id|newIndex
)paren
)paren
op_eq
id|FAILED
)paren
r_return
id|FAILED
suffix:semicolon
multiline_comment|/* Update the tracking arrays.&n;&t;&t; * If chainSge == NULL, update ReqToChain, else ChainToChain&n;&t;&t; */
r_if
c_cond
(paren
id|chainSge
)paren
(brace
id|hd-&gt;ChainToChain
(braket
id|chain_idx
)braket
op_assign
id|newIndex
suffix:semicolon
)brace
r_else
(brace
id|hd-&gt;ReqToChain
(braket
id|req_idx
)braket
op_assign
id|newIndex
suffix:semicolon
)brace
id|chain_idx
op_assign
id|newIndex
suffix:semicolon
id|chain_dma_off
op_assign
id|hd-&gt;ioc-&gt;req_sz
op_star
id|chain_idx
suffix:semicolon
multiline_comment|/* Populate the chainSGE for the current buffer.&n;&t;&t; * - Set chain buffer pointer to psge and fill&n;&t;&t; *   out the Address and Flags fields.&n;&t;&t; */
id|chainSge
op_assign
(paren
r_char
op_star
)paren
id|psge
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Current buff @ %p (index 0x%x)&quot;
comma
id|psge
comma
id|req_idx
)paren
)paren
suffix:semicolon
multiline_comment|/* Start the SGE for the next buffer&n;&t;&t; */
id|psge
op_assign
(paren
r_char
op_star
)paren
(paren
id|hd-&gt;ChainBuffer
op_plus
id|chain_dma_off
)paren
suffix:semicolon
id|sgeOffset
op_assign
l_int|0
suffix:semicolon
id|sg_done
op_assign
l_int|0
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Chain buff @ %p (index 0x%x)&bslash;n&quot;
comma
id|psge
comma
id|chain_idx
)paren
)paren
suffix:semicolon
multiline_comment|/* Start the SGE for the next buffer&n;&t;&t; */
r_goto
id|nextSGEset
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_getFreeChainBuffes - Function to get a free chain&n; *&t;from the MPT_SCSI_HOST FreeChainQ.&n; *&t;@hd: Pointer to the MPT_SCSI_HOST instance&n; *&t;@req_idx: Index of the SCSI IO request frame. (output)&n; *&n; *&t;return SUCCESS or FAILED&n; */
r_static
r_int
DECL|function|mptscsih_getFreeChainBuffer
id|mptscsih_getFreeChainBuffer
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
op_star
id|retIndex
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|chainBuf
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
op_assign
id|FAILED
suffix:semicolon
r_int
id|chain_idx
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
singleline_comment|//spin_lock_irqsave(&amp;hd-&gt;FreeChainQlock, flags);
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;FreeChainQ
)paren
)paren
(brace
r_int
id|offset
suffix:semicolon
id|chainBuf
op_assign
id|hd-&gt;FreeChainQ.head
suffix:semicolon
id|Q_DEL_ITEM
c_func
(paren
op_amp
id|chainBuf-&gt;u.frame.linkage
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|u8
op_star
)paren
id|chainBuf
op_minus
(paren
id|u8
op_star
)paren
id|hd-&gt;ChainBuffer
suffix:semicolon
id|chain_idx
op_assign
id|offset
op_div
id|hd-&gt;ioc-&gt;req_sz
suffix:semicolon
id|rc
op_assign
id|SUCCESS
suffix:semicolon
)brace
singleline_comment|//spin_unlock_irqrestore(&amp;hd-&gt;FreeChainQlock, flags);
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
op_star
id|retIndex
op_assign
id|chain_idx
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;getFreeChainBuffer (index %d), got buf=%p&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
op_star
id|retIndex
comma
id|chainBuf
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_freeChainBuffers - Function to free chain buffers associated&n; *&t;with a SCSI IO request&n; *&t;@hd: Pointer to the MPT_SCSI_HOST instance&n; *&t;@req_idx: Index of the SCSI IO request frame.&n; *&n; *&t;Called if SG chain buffer allocation fails and mptscsih callbacks.&n; *&t;No return.&n; */
r_static
r_void
DECL|function|mptscsih_freeChainBuffers
id|mptscsih_freeChainBuffers
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|req_idx
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|chain
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|chain_idx
suffix:semicolon
r_int
id|next
suffix:semicolon
multiline_comment|/* Get the first chain index and reset&n;&t; * tracker state.&n;&t; */
id|chain_idx
op_assign
id|hd-&gt;ReqToChain
(braket
id|req_idx
)braket
suffix:semicolon
id|hd-&gt;ReqToChain
(braket
id|req_idx
)braket
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
r_while
c_loop
(paren
id|chain_idx
op_ne
id|MPT_HOST_NO_CHAIN
)paren
(brace
multiline_comment|/* Save the next chain buffer index */
id|next
op_assign
id|hd-&gt;ChainToChain
(braket
id|chain_idx
)braket
suffix:semicolon
multiline_comment|/* Free this chain buffer and reset&n;&t;&t; * tracker&n;&t;&t; */
id|hd-&gt;ChainToChain
(braket
id|chain_idx
)braket
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
id|chain
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
(paren
id|hd-&gt;ChainBuffer
op_plus
(paren
id|chain_idx
op_star
id|hd-&gt;ioc-&gt;req_sz
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;FreeChainQ.head
comma
op_amp
id|chain-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;FreeChainBuffers (index %d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|chain_idx
)paren
)paren
suffix:semicolon
multiline_comment|/* handle next */
id|chain_idx
op_assign
id|next
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;Reset Handling&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_TMHandler - Generic handler for SCSI Task Management.&n; *&t;Fall through to mpt_HardResetHandler if: not operational, too many&n; *&t;failed TM requests or handshake failure.&n; *&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@type: Task Management type&n; *&t;@target: Logical Target ID for reset (if appropriate)&n; *&t;@lun: Logical Unit for reset (if appropriate)&n; *&t;@ctx2abort: Context for the task to be aborted (if appropriate)&n; *&t;@sleepFlag: If set, use udelay instead of schedule in handshake code.&n; *&n; *&t;Remark: Currently invoked from a non-interrupt thread (_bh).&n; *&n; *&t;Remark: With old EH code, at most 1 SCSI TaskMgmt function per IOC&n; *&t;will be active.&n; *&n; *&t;Returns 0 for SUCCESS or -1 if FAILED.&n; */
r_static
r_int
DECL|function|mptscsih_TMHandler
id|mptscsih_TMHandler
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|type
comma
id|u8
id|target
comma
id|u8
id|lun
comma
r_int
id|ctx2abort
comma
r_int
id|sleepFlag
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|doTask
op_assign
l_int|1
suffix:semicolon
id|u32
id|ioc_raw_state
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* If FW is being reloaded currently, return success to&n;&t; * the calling function.&n;&t; */
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;TMHandler Entered!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot; TMHandler&quot;
l_string|&quot; NULL ioc!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// SJR - CHECKME - Can we avoid this here?
singleline_comment|// (mpt_HardResetHandler has this check...)
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;diagPending
)paren
op_logical_or
(paren
id|ioc-&gt;alt_ioc
op_logical_and
id|ioc-&gt;alt_ioc-&gt;diagPending
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Do not do a Task Management if there are&n;&t; * too many failed TMs on this adapter.&n;&t; */
r_if
c_cond
(paren
id|hd-&gt;numTMrequests
OG
id|MPT_HOST_TOO_MANY_TM
)paren
id|doTask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Is operational?&n;&t; */
id|ioc_raw_state
op_assign
id|mpt_GetIocState
c_func
(paren
id|hd-&gt;ioc
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG_RESET
r_if
c_cond
(paren
(paren
id|ioc_raw_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_ne
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;TM Handler: IOC Not operational! state 0x%x Calling HardResetHandler&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|ioc_raw_state
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|doTask
op_logical_and
(paren
(paren
id|ioc_raw_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_eq
id|MPI_IOC_STATE_OPERATIONAL
)paren
op_logical_and
op_logical_neg
(paren
id|ioc_raw_state
op_amp
id|MPI_DOORBELL_ACTIVE
)paren
)paren
(brace
multiline_comment|/* Isse the Task Mgmt request.&n;&t;&t; */
id|rc
op_assign
id|mptscsih_IssueTaskMgmt
c_func
(paren
id|hd
comma
id|type
comma
id|target
comma
id|lun
comma
id|ctx2abort
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
macro_line|#ifdef MPT_SCSI_USE_NEW_EH
id|hd-&gt;tmState
op_assign
id|TM_STATE_ERROR
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Issue of TaskMgmt failed!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Issue of TaskMgmt Successful!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef DROP_TEST
id|numTMrequested
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|numTMrequested
OG
l_int|5
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set to 1 to force a hard reset */
id|numTMrequested
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|rc
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Falling through to HardReset! &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|sleepFlag
)paren
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;TMHandler rc = %d!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|rc
)paren
)paren
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;TMHandler: _bh_handler state (%d) taskQ count (%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mytaskQ_bh_active
comma
id|hd-&gt;taskQcnt
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_IssueTaskMgmt - Generic send Task Management function.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@type: Task Management type&n; *&t;@target: Logical Target ID for reset (if appropriate)&n; *&t;@lun: Logical Unit for reset (if appropriate)&n; *&t;@ctx2abort: Context for the task to be aborted (if appropriate)&n; *&t;@sleepFlag: If set, use udelay instead of schedule in handshake code.&n; *&n; *&t;Remark: _HardResetHandler can be invoked from an interrupt thread (timer)&n; *&t;or a non-interrupt thread.  In the former, must not call schedule().&n; *&n; *&t;Not all fields are meaningfull for all task types.&n; *&n; *&t;Returns 0 for SUCCESS, -999 for &quot;no msg frames&quot;,&n; *&t;else other non-zero value returned.&n; */
r_static
r_int
DECL|function|mptscsih_IssueTaskMgmt
id|mptscsih_IssueTaskMgmt
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|type
comma
id|u8
id|target
comma
id|u8
id|lun
comma
r_int
id|ctx2abort
comma
r_int
id|sleepFlag
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTm
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|retval
suffix:semicolon
multiline_comment|/* Return Fail to calling function if no message frames available.&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;IssueTaskMgmt, no msg frames!!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
singleline_comment|//return FAILED;
r_return
op_minus
l_int|999
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;IssueTaskMgmt request @ %p&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|mf
)paren
)paren
suffix:semicolon
multiline_comment|/* Format the Request&n;&t; */
id|pScsiTm
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
id|pScsiTm-&gt;TargetID
op_assign
id|target
suffix:semicolon
id|pScsiTm-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
id|pScsiTm-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:semicolon
id|pScsiTm-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskType
op_assign
id|type
suffix:semicolon
id|pScsiTm-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;MsgFlags
op_assign
(paren
id|type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
ques
c_cond
id|MPI_SCSITASKMGMT_MSGFLAGS_LIPRESET_RESET_OPTION
suffix:colon
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|pScsiTm-&gt;LUN
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|pScsiTm-&gt;LUN
(braket
l_int|1
)braket
op_assign
id|lun
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|7
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiTm-&gt;Reserved2
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskMsgContext
op_assign
id|ctx2abort
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;IssueTaskMgmt, ctx2abort (0x%08x), type (%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|ctx2abort
comma
id|type
)paren
)paren
suffix:semicolon
multiline_comment|/* MPI v0.10 requires SCSITaskMgmt requests be sent via Doorbell/handshake&n;&t;&t;mpt_put_msg_frame(hd-&gt;ioc-&gt;id, mf);&n;&t;* Save the MF pointer in case the request times out.&n;&t;*/
id|hd-&gt;tmPtr
op_assign
id|mf
suffix:semicolon
id|hd-&gt;numTMrequests
op_increment
suffix:semicolon
id|hd-&gt;TMtimer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|20
suffix:semicolon
multiline_comment|/* 20 seconds */
id|add_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|mpt_send_handshake_request
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
(paren
id|u32
op_star
)paren
id|pScsiTm
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;_send_handshake FAILED!&quot;
l_string|&quot; (hd %p, ioc %p, mf %p) &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|hd
comma
id|hd-&gt;ioc
comma
id|mf
)paren
)paren
suffix:semicolon
id|hd-&gt;numTMrequests
op_decrement
suffix:semicolon
id|hd-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
macro_line|#ifdef MPT_SCSI_USE_NEW_EH&t;&t;/* { */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_abort - Abort linux Scsi_Cmnd routine, new_eh variant&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO to be aborted&n; *&n; *&t;(linux Scsi_Host_Template.eh_abort_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_int
DECL|function|mptscsih_abort
id|mptscsih_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|ctx2abort
suffix:semicolon
r_int
id|scpnt_idx
suffix:semicolon
multiline_comment|/* If we can&squot;t locate our host adapter structure, return FAILED status.&n;&t; */
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_abort: &quot;
l_string|&quot;Can&squot;t locate host! (sc=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: &gt;&gt; Attempting task abort! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: IOs outstanding = %d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
multiline_comment|/* Find this command&n;&t; */
r_if
c_cond
(paren
(paren
id|scpnt_idx
op_assign
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
id|SCpnt
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Cmd not found in ScsiLookup. If found in&n;&t;&t; * doneQ, delete from Q. Do OS callback.&n;&t;&t; */
id|search_doneQ_for_cmd
c_func
(paren
id|hd
comma
id|SCpnt
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_abort: &quot;
l_string|&quot;Command not in the active list! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*  Wait a fixed amount of time for the TM pending flag to be cleared.&n;&t; *  If we time out, then we return a FAILED status to the caller.  This&n;&t; *  call to mptscsih_tm_pending_wait() will set the pending flag if we are&n;&t; *  successful.&n;&t; */
r_if
c_cond
(paren
id|mptscsih_tm_pending_wait
c_func
(paren
id|hd
)paren
op_eq
id|FAILED
)paren
(brace
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_abort: &quot;
l_string|&quot;Timed out waiting for previous TM to complete! &quot;
l_string|&quot;(sc = %p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* If this command is pended, then timeout/hang occurred&n;&t; * during DV. Post command and flush pending Q&n;&t; * and then following up with the reset request.&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mptscsih_search_pendingQ
c_func
(paren
id|hd
comma
id|scpnt_idx
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|mptscsih_put_msgframe
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|post_pendingQ_commands
c_func
(paren
id|hd
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_abort: &quot;
l_string|&quot;Found command in pending queue! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Most important!  Set TaskMsgContext to SCpnt&squot;s MsgContext!&n;&t; * (the IO to be ABORT&squot;d)&n;&t; *&n;&t; * NOTE: Since we do not byteswap MsgContext, we do not&n;&t; *&t; swap it here either.  It is an opaque cookie to&n;&t; *&t; the controller, so it does not matter. -DaveM&n;&t; */
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|hd-&gt;ioc
comma
id|scpnt_idx
)paren
suffix:semicolon
id|ctx2abort
op_assign
id|mf-&gt;u.frame.hwhdr.msgctxu.MsgContext
suffix:semicolon
id|hd-&gt;abortSCpnt
op_assign
id|SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_TMHandler
c_func
(paren
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
id|ctx2abort
comma
id|CAN_SLEEP
)paren
OL
l_int|0
op_logical_or
id|hd-&gt;tmState
op_eq
id|TM_STATE_ERROR
)paren
(brace
multiline_comment|/* The TM request failed and the subsequent FW-reload failed!&n;&t;&t; * Fatal error case.&n;&t;&t; */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Error issuing abort task! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* If command not found, do not do callback,&n;&t;&t; *  just return failed.  CHECKME&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
(braket
id|scpnt_idx
)braket
op_ne
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
multiline_comment|/* We must clear our pending flag before clearing our state.&n;&t;&t; */
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* Our task management request will either complete or time out.  So we&n;&t; * spin until tmPending is != 1. If tmState is set to TM_STATE_ERROR, &n;&t; * we encountered an error executing the task management request.&n;&t; */
r_while
c_loop
(paren
id|hd-&gt;tmPending
op_eq
l_int|1
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmState
op_eq
id|TM_STATE_ERROR
)paren
(brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_abort: &quot;
l_string|&quot;TM timeout error! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_abort: &quot;
l_string|&quot;Abort was successful! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_dev_reset - Perform a SCSI TARGET_RESET!  new_eh variant&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO which reset is due to&n; *&n; *&t;(linux Scsi_Host_Template.eh_dev_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_int
DECL|function|mptscsih_dev_reset
id|mptscsih_dev_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* If we can&squot;t locate our host adapter structure, return FAILED status.&n;&t; */
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_dev_reset: &quot;
l_string|&quot;Can&squot;t locate host! (sc=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: &gt;&gt; Attempting target reset! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: IOs outstanding = %d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
multiline_comment|/*  Wait a fixed amount of time for the TM pending flag to be cleared.&n;&t; *  If we time out, then we return a FAILED status to the caller.  This&n;&t; *  call to mptscsih_tm_pending_wait() will set the pending flag if we are&n;&t; *  successful.&n;&t; */
r_if
c_cond
(paren
id|mptscsih_tm_pending_wait
c_func
(paren
id|hd
)paren
op_eq
id|FAILED
)paren
(brace
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_dev_reset: &quot;
l_string|&quot;Timed out waiting for previous TM to complete! &quot;
l_string|&quot;(sc = %p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mptscsih_TMHandler
c_func
(paren
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET
comma
id|SCpnt-&gt;target
comma
l_int|0
comma
l_int|0
comma
id|CAN_SLEEP
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* The TM request failed and the subsequent FW-reload failed!&n;&t;&t; * Fatal error case.&n;&t;&t; */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Error processing TaskMgmt request (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* Our task management request will either complete or time out.  So we&n;&t; * spin until tmPending is != 1. If tmState is set to TM_STATE_ERROR, &n;&t; * we encountered an error executing the task management request.&n;&t; */
r_while
c_loop
(paren
id|hd-&gt;tmPending
op_eq
l_int|1
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmState
op_eq
id|TM_STATE_ERROR
)paren
(brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_dev_reset: &quot;
l_string|&quot;TM timeout error! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_dev_reset: &quot;
l_string|&quot;Device reset was successful! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_bus_reset - Perform a SCSI BUS_RESET!&t;new_eh variant&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO which reset is due to&n; *&n; *&t;(linux Scsi_Host_Template.eh_bus_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_int
DECL|function|mptscsih_bus_reset
id|mptscsih_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* If we can&squot;t locate our host adapter structure, return FAILED status.&n;&t; */
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_bus_reset: &quot;
l_string|&quot;Can&squot;t locate host! (sc=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: &gt;&gt; Attempting bus reset! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: IOs outstanding = %d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
multiline_comment|/*  Wait a fixed amount of time for the TM pending flag to be cleared.&n;&t; *  If we time out, then we return a FAILED status to the caller.  This&n;&t; *  call to mptscsih_tm_pending_wait() will set the pending flag if we are&n;&t; *  successful.&n;&t; */
r_if
c_cond
(paren
id|mptscsih_tm_pending_wait
c_func
(paren
id|hd
)paren
op_eq
id|FAILED
)paren
(brace
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_bus_reset: &quot;
l_string|&quot;Timed out waiting for previous TM to complete! &quot;
l_string|&quot;(sc = %p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* We are now ready to execute the task management request. */
r_if
c_cond
(paren
id|mptscsih_TMHandler
c_func
(paren
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|CAN_SLEEP
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* The TM request failed and the subsequent FW-reload failed!&n;&t;&t; * Fatal error case.&n;&t;&t; */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Error processing TaskMgmt request (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* Our task management request will either complete or time out.  So we&n;&t; * spin until tmPending is != 1. If tmState is set to TM_STATE_ERROR, &n;&t; * we encountered an error executing the task management request.&n;&t; */
r_while
c_loop
(paren
id|hd-&gt;tmPending
op_eq
l_int|1
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmState
op_eq
id|TM_STATE_ERROR
)paren
(brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_bus_reset: &quot;
l_string|&quot;TM timeout error! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_bus_reset: &quot;
l_string|&quot;Bus reset was successful! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_host_reset - Perform a SCSI host adapter RESET!&n; *&t;new_eh variant&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO which reset is due to&n; *&n; *&t;(linux Scsi_Host_Template.eh_host_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_int
DECL|function|mptscsih_host_reset
id|mptscsih_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|status
op_assign
id|SUCCESS
suffix:semicolon
multiline_comment|/*  If we can&squot;t locate the host to reset, then we failed. */
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_host_reset: &quot;
l_string|&quot;Can&squot;t locate host! (sc=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: &gt;&gt; Attempting host reset! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: IOs outstanding = %d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
multiline_comment|/*  If our attempts to reset the host failed, then return a failed&n;&t; *  status.  The host will be taken off line by the SCSI mid-layer.&n;&t; */
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|CAN_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|status
op_assign
id|FAILED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*  Make sure TM pending is cleared and TM state is set to &n;&t;&t; *  NONE. &n;&t;&t; */
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
)brace
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_host_reset: &quot;
l_string|&quot;Status = %s&bslash;n&quot;
comma
(paren
id|status
op_eq
id|SUCCESS
)paren
ques
c_cond
l_string|&quot;SUCCESS&quot;
suffix:colon
l_string|&quot;FAILED&quot;
)paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_tm_pending_wait - wait for pending task management request to &n; *&t;&t;complete.&n; *&t;@hd: Pointer to MPT host structure.&n; *&n; *&t;Returns {SUCCESS,FAILED}.&n; */
r_static
r_int
DECL|function|mptscsih_tm_pending_wait
id|mptscsih_tm_pending_wait
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|loop_count
op_assign
l_int|60
op_star
l_int|4
suffix:semicolon
multiline_comment|/* Wait 60 seconds */
r_int
id|status
op_assign
id|FAILED
suffix:semicolon
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmState
op_eq
id|TM_STATE_NONE
)paren
(brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_IN_PROGRESS
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|loop_count
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#else&t;&t;/* MPT_SCSI old EH stuff... */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_old_abort - Abort linux Scsi_Cmnd routine&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO to be aborted&n; *&n; *&t;(linux Scsi_Host_Template.abort routine)&n; *&n; *&t;Returns SCSI_ABORT_{SUCCESS,BUSY,PENDING}.&n; */
r_int
DECL|function|mptscsih_old_abort
id|mptscsih_old_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_struct
id|tq_struct
op_star
id|ptaskfoo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|scpnt_idx
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: OldAbort scheduling ABORT SCSI IO (sc=%p)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;  IOs outstanding = %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;  WARNING - OldAbort, NULL hostdata ptr!!&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|scpnt_idx
op_assign
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
id|SCpnt
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Cmd not found in ScsiLookup.&n;&t;&t; * If found in doneQ, delete from Q.&n;&t;&t; * Do OS callback.&n;&t;&t; */
id|search_doneQ_for_cmd
c_func
(paren
id|hd
comma
id|SCpnt
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If this command is pended, then timeout/hang occurred&n;&t;&t; * during DV. Force bus reset by posting command to F/W&n;&t;&t; * and then following up with the reset request.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mptscsih_search_pendingQ
c_func
(paren
id|hd
comma
id|scpnt_idx
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|mptscsih_put_msgframe
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|post_pendingQ_commands
c_func
(paren
id|hd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *  Check to see if there&squot;s already an ABORT queued for this guy.&n;&t; */
id|mf
op_assign
id|search_taskQ
c_func
(paren
l_int|0
comma
id|SCpnt
comma
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_ne
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;OldAbort:Abort Task PENDING cmd (%p) taskQ depth (%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
comma
id|hd-&gt;taskQcnt
)paren
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
singleline_comment|// SJR - CHECKME - Can we avoid this here?
singleline_comment|// (mpt_HardResetHandler has this check...)
multiline_comment|/* If IOC is reloading FW, return PENDING.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;diagPending
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* If there are no message frames what should we do?&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot;  WARNING - OldAbort, no msg frames!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* We are out of message frames!&n;&t;&t; * Call the reset handler to do a FW reload.&n;&t;&t; */
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot; Reloading Firmware!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot; Firmware Reload FAILED!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Add ourselves to (end of) taskQ .&n;&t; *  Check to see if our _bh is running.  If NOT, schedule it.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;taskQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|hd-&gt;taskQcnt
op_increment
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|mpt_taskQdepth
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save the original SCpnt mf pointer&n;&t; */
id|SCpnt-&gt;host_scribble
op_assign
(paren
id|u8
op_star
)paren
id|MPT_INDEX_2_MFPTR
(paren
id|hd-&gt;ioc
comma
id|scpnt_idx
)paren
suffix:semicolon
multiline_comment|/* For the time being, force bus reset on any abort&n;&t; * requests for the 1030 FW.&n;&t; */
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
id|mf-&gt;u.frame.linkage.arg1
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
suffix:semicolon
r_else
id|mf-&gt;u.frame.linkage.arg1
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
suffix:semicolon
id|mf-&gt;u.frame.linkage.argp1
op_assign
id|SCpnt
suffix:semicolon
id|mf-&gt;u.frame.linkage.argp2
op_assign
(paren
r_void
op_star
)paren
id|hd
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;OldAbort:_bh_handler state (%d) taskQ count (%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|mytaskQ_bh_active
comma
id|hd-&gt;taskQcnt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mytaskQ_bh_active
)paren
(brace
id|mytaskQ_bh_active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Oh how cute, no alloc/free/mgmt needed if we use&n;&t;&t; *  (bottom/unused portion of) MPT request frame.&n;&t;&t; */
id|ptaskfoo
op_assign
(paren
r_struct
id|tq_struct
op_star
)paren
op_amp
id|mptscsih_ptaskfoo
suffix:semicolon
id|ptaskfoo-&gt;sync
op_assign
l_int|0
suffix:semicolon
id|ptaskfoo-&gt;routine
op_assign
id|mptscsih_taskmgmt_bh
suffix:semicolon
id|ptaskfoo-&gt;data
op_assign
id|SCpnt
suffix:semicolon
id|SCHEDULE_TASK
c_func
(paren
id|ptaskfoo
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_old_reset - Perform a SCSI BUS_RESET!&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO which reset is due to&n; *&t;@reset_flags: (not used?)&n; *&n; *&t;(linux Scsi_Host_Template.reset routine)&n; *&n; *&t;Returns SCSI_RESET_{SUCCESS,PUNT,PENDING}.&n; */
r_int
DECL|function|mptscsih_old_reset
id|mptscsih_old_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_struct
id|tq_struct
op_star
id|ptaskfoo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|scpnt_idx
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: OldReset scheduling BUS_RESET (sc=%p)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;  IOs outstanding = %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|scpnt_idx
op_assign
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
id|SCpnt
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Cmd not found in ScsiLookup.&n;&t;&t; * If found in doneQ, delete from Q.&n;&t;&t; * Do OS callback.&n;&t;&t; */
id|search_doneQ_for_cmd
c_func
(paren
id|hd
comma
id|SCpnt
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If this command is pended, then timeout/hang occurred&n;&t;&t; * during DV. Force bus reset by posting command to F/W&n;&t;&t; * and then following up with the reset request.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mptscsih_search_pendingQ
c_func
(paren
id|hd
comma
id|scpnt_idx
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|mptscsih_put_msgframe
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|post_pendingQ_commands
c_func
(paren
id|hd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *  Check to see if there&squot;s an ABORT_TASK queued for this guy.&n;&t; *  If so, delete.&n;&t; */
id|search_taskQ
c_func
(paren
l_int|1
comma
id|SCpnt
comma
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Check to see if there&squot;s already a BUS_RESET queued for this guy.&n;&t; */
id|mf
op_assign
id|search_taskQ
c_func
(paren
l_int|0
comma
id|SCpnt
comma
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_ne
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;OldReset:Reset Task PENDING cmd (%p) taskQ depth (%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
comma
id|hd-&gt;taskQcnt
)paren
)paren
suffix:semicolon
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
singleline_comment|// SJR - CHECKME - Can we avoid this here?
singleline_comment|// (mpt_HardResetHandler has this check...)
multiline_comment|/* If IOC is reloading FW, return PENDING.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;diagPending
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* We are out of message frames!&n;&t;&t; * Call the reset handler to do a FW reload.&n;&t;&t; */
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot; Reloading Firmware!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot; Firmware Reload FAILED!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Add ourselves to (end of) taskQ.&n;&t; *  Check to see if our _bh is running.  If NOT, schedule it.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;taskQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|hd-&gt;taskQcnt
op_increment
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|mpt_taskQdepth
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;OldReset: _bh_handler state (%d) taskQ count (%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|mytaskQ_bh_active
comma
id|hd-&gt;taskQcnt
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save the original SCpnt mf pointer&n;&t; */
id|SCpnt-&gt;host_scribble
op_assign
(paren
id|u8
op_star
)paren
id|MPT_INDEX_2_MFPTR
(paren
id|hd-&gt;ioc
comma
id|scpnt_idx
)paren
suffix:semicolon
id|mf-&gt;u.frame.linkage.arg1
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
suffix:semicolon
id|mf-&gt;u.frame.linkage.argp1
op_assign
id|SCpnt
suffix:semicolon
id|mf-&gt;u.frame.linkage.argp2
op_assign
(paren
r_void
op_star
)paren
id|hd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mytaskQ_bh_active
)paren
(brace
id|mytaskQ_bh_active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Oh how cute, no alloc/free/mgmt needed if we use&n;&t;&t; *  (bottom/unused portion of) MPT request frame.&n;&t;&t; */
id|ptaskfoo
op_assign
(paren
r_struct
id|tq_struct
op_star
)paren
op_amp
id|mptscsih_ptaskfoo
suffix:semicolon
id|ptaskfoo-&gt;sync
op_assign
l_int|0
suffix:semicolon
id|ptaskfoo-&gt;routine
op_assign
id|mptscsih_taskmgmt_bh
suffix:semicolon
id|ptaskfoo-&gt;data
op_assign
id|SCpnt
suffix:semicolon
id|SCHEDULE_TASK
c_func
(paren
id|ptaskfoo
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_taskmgmt_bh - SCSI task mgmt bottom half handler&n; *&t;@sc: (unused)&n; *&n; *&t;This routine (thread) is active whenever there are any outstanding&n; *&t;SCSI task management requests for a SCSI host adapter.&n; *&t;IMPORTANT!  This routine is scheduled therefore should never be&n; *&t;running in ISR context.  i.e., it&squot;s safe to sleep here.&n; */
r_void
DECL|function|mptscsih_taskmgmt_bh
id|mptscsih_taskmgmt_bh
c_func
(paren
r_void
op_star
id|sc
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|u32
id|ctx2abort
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|scpnt_idx
suffix:semicolon
r_int
id|did
suffix:semicolon
id|u8
id|task_type
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|mytaskQ_bh_active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
id|did
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ioc
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
id|ioc
op_ne
l_int|NULL
suffix:semicolon
id|ioc
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|ioc
)paren
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - TaskMgmt NULL SCSI Host!&quot;
l_string|&quot;(ioc=%p, sh=%p hd=%p)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|ioc
comma
(paren
r_void
op_star
)paren
id|ioc-&gt;sh
comma
(paren
r_void
op_star
)paren
id|hd
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;taskQ
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* If we ever find a non-empty queue,&n;&t;&t;&t;&t; * keep the handler alive&n;&t;&t;&t;&t; */
id|did
op_increment
suffix:semicolon
multiline_comment|/* tmPending is SMP lock-protected */
r_if
c_cond
(paren
id|hd-&gt;tmPending
op_logical_or
id|hd-&gt;tmPtr
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|hd-&gt;tmPending
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Process this request&n;&t;&t;&t;&t; */
id|mf
op_assign
id|hd-&gt;taskQ.head
suffix:semicolon
id|Q_DEL_ITEM
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage
)paren
suffix:semicolon
id|hd-&gt;taskQcnt
op_decrement
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|mpt_taskQdepth
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|SCpnt
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|mf-&gt;u.frame.linkage.argp1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - TaskMgmt has NULL SCpnt! (mf=%p:sc=%p)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|mf
comma
(paren
r_void
op_star
)paren
id|SCpnt
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Get the ScsiLookup index pointer&n;&t;&t;&t;&t; * from the SC pointer.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;host_scribble
op_logical_or
(paren
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
op_ne
id|hd
)paren
)paren
(brace
multiline_comment|/* The command associated with the&n;&t;&t;&t;&t;&t; * abort/reset request must have&n;&t;&t;&t;&t;&t; * completed and this is a stale&n;&t;&t;&t;&t;&t; * request. We are done.&n;&t;&t;&t;&t;&t; * Free the current MF and continue.&n;&t;&t;&t;&t;&t; */
id|mpt_free_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|scpnt_idx
op_assign
id|MFPTR_2_MPT_INDEX
c_func
(paren
id|hd-&gt;ioc
comma
id|SCpnt-&gt;host_scribble
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scpnt_idx
op_ne
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
id|SCpnt
)paren
)paren
(brace
multiline_comment|/* Error! this should never happen!!&n;&t;&t;&t;&t;&t; */
id|mpt_free_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|task_type
op_assign
id|mf-&gt;u.frame.linkage.arg1
suffix:semicolon
id|ctx2abort
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|task_type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|SCpntMf
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Most important!  Set TaskMsgContext to SCpnt&squot;s MsgContext!&n;&t;&t;&t;&t;&t; * (the IO to be ABORT&squot;d)&n;&t;&t;&t;&t;&t; *&n;&t;&t;&t;&t;&t; * NOTE: Since we do not byteswap MsgContext, we do not&n;&t;&t;&t;&t;&t; *&t; swap it here either.  It is an opaque cookie to&n;&t;&t;&t;&t;&t; *&t; the controller, so it does not matter. -DaveM&n;&t;&t;&t;&t;&t; */
id|SCpntMf
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|SCpnt-&gt;host_scribble
suffix:semicolon
id|ctx2abort
op_assign
id|SCpntMf-&gt;u.frame.hwhdr.msgctxu.MsgContext
suffix:semicolon
id|hd-&gt;abortSCpnt
op_assign
id|SCpnt
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Attempting ABORT SCSI IO! (mf=%p:sc=%p)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|mf
comma
(paren
r_void
op_star
)paren
id|SCpnt
)paren
suffix:semicolon
)brace
multiline_comment|/* The TM handler will allocate a new mf,&n;&t;&t;&t;&t; * so free the current mf.&n;&t;&t;&t;&t; */
id|mpt_free_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|mf
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_TMHandler
c_func
(paren
id|hd
comma
id|task_type
comma
id|SCpnt-&gt;target
comma
id|SCpnt-&gt;lun
comma
id|ctx2abort
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* The TM request failed and the subsequent FW-reload failed!&n;&t;&t;&t;&t;&t; * Fatal error case.&n;&t;&t;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: WARNING[1] - IOC error processing TaskMgmt request (sc=%p)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
(braket
id|scpnt_idx
)braket
op_ne
l_int|NULL
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
id|MPT_HOST_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|MPT_HOST_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;abortSCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|mpt_taskQdepth
)paren
OG
l_int|0
)paren
id|did
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|did
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|mytaskQ_bh_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mytaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif&t;&t;/* } */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_taskmgmt_complete - Registered with Fusion MPT base driver&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to SCSI task mgmt request frame&n; *&t;@mr: Pointer to SCSI task mgmt reply frame&n; *&n; *&t;This routine is called from mptbase.c::mpt_interrupt() at the completion&n; *&t;of any SCSI task management request.&n; *&t;This routine is registered with the MPT (base) driver at driver&n; *&t;load/init time via the mpt_register() API call.&n; *&n; *&t;Returns 1 indicating alloc&squot;d request frame ptr should be freed.&n; */
r_static
r_int
DECL|function|mptscsih_taskmgmt_complete
id|mptscsih_taskmgmt_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|mr
)paren
(brace
id|SCSITaskMgmtReply_t
op_star
id|pScsiTmReply
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTmReq
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|tmType
op_assign
l_int|0
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SCSI TaskMgmt completed (mf=%p,r=%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
comma
id|mr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
multiline_comment|/* Depending on the thread, a timer is activated for&n;&t;&t; * the TM request.  Delete this timer on completion of TM.&n;&t;&t; * Decrement count of outstanding TM requests.&n;&t;&t; */
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmPtr
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;taskQcnt (%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|hd-&gt;taskQcnt
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;TaskMgmt Complete: NULL Scsi Host Ptr&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mr
op_eq
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;ERROR! TaskMgmt Reply: NULL Request %p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|pScsiTmReply
op_assign
(paren
id|SCSITaskMgmtReply_t
op_star
)paren
id|mr
suffix:semicolon
id|pScsiTmReq
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Figure out if this was ABORT_TASK, TARGET_RESET, or BUS_RESET! */
id|tmType
op_assign
id|pScsiTmReq-&gt;TaskType
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  TaskType = %d, TerminationCount=%d&bslash;n&quot;
comma
id|tmType
comma
id|le32_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;TerminationCount
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Error?  (anything non-zero?) */
r_if
c_cond
(paren
op_star
(paren
id|u32
op_star
)paren
op_amp
id|pScsiTmReply-&gt;Reserved2
(braket
l_int|0
)braket
)paren
(brace
id|u16
id|iocstatus
suffix:semicolon
id|iocstatus
op_assign
id|le16_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  SCSI TaskMgmt (%d) - Oops!&bslash;n&quot;
comma
id|tmType
)paren
)paren
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  IOCStatus = %04xh&bslash;n&quot;
comma
id|iocstatus
)paren
)paren
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  IOCLogInfo = %08xh&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;IOCLogInfo
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* clear flags and continue.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|tmType
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
id|hd-&gt;abortSCpnt
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef&t;DROP_TEST
r_if
c_cond
(paren
id|dropMfPtr
)paren
id|dropTestBad
op_increment
suffix:semicolon
macro_line|#endif
multiline_comment|/* If an internal command is present&n;&t;&t;&t; * or the TM failed - reload the FW.&n;&t;&t;&t; * FC FW may respond FAILED to an ABORT&n;&t;&t;&t; */
r_if
c_cond
(paren
id|tmType
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
(brace
r_if
c_cond
(paren
(paren
id|hd-&gt;cmdPtr
)paren
op_logical_or
(paren
id|iocstatus
op_eq
id|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
)paren
)paren
(brace
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|ioc
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot; Firmware Reload FAILED!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef MPT_SCSI_USE_NEW_EH
id|hd-&gt;tmState
op_assign
id|TM_STATE_ERROR
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|dtmprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  SCSI TaskMgmt SUCCESS!&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
r_if
c_cond
(paren
id|tmType
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
(brace
multiline_comment|/* clean taskQ - remove tasks associated with&n;&t;&t;&t;&t; * completed commands.&n;&t;&t;&t;&t; */
id|clean_taskQ
c_func
(paren
id|hd
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tmType
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
(brace
multiline_comment|/* If taskQ contains another request&n;&t;&t;&t;&t; * for this SCpnt, delete this request.&n;&t;&t;&t;&t; */
id|search_taskQ_for_cmd
c_func
(paren
id|hd-&gt;abortSCpnt
comma
id|hd
)paren
suffix:semicolon
)brace
macro_line|#endif
id|hd-&gt;numTMrequests
op_decrement
suffix:semicolon
id|hd-&gt;abortSCpnt
op_assign
l_int|NULL
suffix:semicolon
id|flush_doneQ
c_func
(paren
id|hd
)paren
suffix:semicolon
macro_line|#ifdef&t;DROP_TEST
r_if
c_cond
(paren
id|dropMfPtr
)paren
id|dropTestOK
op_increment
suffix:semicolon
macro_line|#endif
)brace
)brace
macro_line|#ifdef&t;DROP_TEST
(brace
id|Scsi_Cmnd
op_star
id|sc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
multiline_comment|/* Free resources for the drop test MF and chain buffers.&n;&t;&t; */
r_if
c_cond
(paren
id|dropMfPtr
)paren
(brace
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|dropMfPtr-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sc
op_assign
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Drop Test: NULL ScsiCmd ptr!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|sc-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tmType
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
r_else
id|sc-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
id|MPT_HOST_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sc
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|sc
)paren
suffix:semicolon
multiline_comment|/* Issue callback */
id|MPT_HOST_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mptscsih_freeChainBuffers
c_func
(paren
id|hd
comma
id|req_idx
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|ioc-&gt;id
comma
id|dropMfPtr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Free&squot;d Dropped cmd (%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|sc
)paren
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;mf (%p) reqidx (%4x)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|dropMfPtr
comma
id|req_idx
)paren
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Num Tot (%d) Good (%d) Bad (%d) &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|dropTestNum
comma
id|dropTestOK
comma
id|dropTestBad
)paren
suffix:semicolon
)brace
id|dropMfPtr
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
multiline_comment|/*&n;&t; *  Signal to _bh thread that we finished.&n;&t; *  This IOC can now process another TM command.&n;&t; */
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;taskmgmt_complete: (=%p) done! Num Failed(%d) Task Count (%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
comma
id|hd-&gt;numTMrequests
comma
id|hd-&gt;taskQcnt
)paren
)paren
suffix:semicolon
macro_line|#endif
id|hd-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;This is anyones guess quite frankly.&n; */
r_int
DECL|function|mptscsih_bios_param
id|mptscsih_bios_param
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|ip
)paren
(brace
r_int
id|size
suffix:semicolon
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
id|ip
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* heads&t;&t;&t;*/
id|ip
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* sectors&t;&t;&t;*/
r_if
c_cond
(paren
(paren
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_rshift
l_int|11
)paren
OG
l_int|1024
)paren
(brace
multiline_comment|/* cylinders, test for big disk */
id|ip
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* heads&t;&t;&t;*/
id|ip
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
multiline_comment|/* sectors&t;&t;&t;*/
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_div
(paren
l_int|255
op_star
l_int|63
)paren
suffix:semicolon
multiline_comment|/* cylinders&t;&t;&t;*/
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;OS entry point to adjust the queue_depths on a per-device basis.&n; *&t;Called once per device the bus scan. Use it to force the queue_depth&n; *&t;member to 1 if a device does not support Q tags.&n; */
r_void
DECL|function|mptscsih_select_queue_depths
id|mptscsih_select_queue_depths
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|sh
comma
id|Scsi_Device
op_star
id|sdList
)paren
(brace
r_struct
id|scsi_device
op_star
id|device
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|ii
comma
id|max
suffix:semicolon
r_for
c_loop
(paren
id|device
op_assign
id|sdList
suffix:semicolon
id|device
op_ne
l_int|NULL
suffix:semicolon
id|device
op_assign
id|device-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;host
op_ne
id|sh
)paren
r_continue
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;Targets
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
id|max
op_assign
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
r_else
id|max
op_assign
id|MPT_MAX_FC_DEVICES
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|max
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|ii
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pTarget
op_logical_and
op_logical_neg
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
)paren
(brace
id|device-&gt;queue_depth
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Private routines...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* 19991030 -sralston&n; *  Return absolute SCSI data direction:&n; *     1 = _DATA_OUT&n; *     0 = _DIR_NONE&n; *    -1 = _DATA_IN&n; *&n; * Changed: 3-20-2002 pdelaney to use the default data&n; * direction and the defines set up in the&n; * 2.4 kernel series&n; *     1 = _DATA_OUT&t;changed to SCSI_DATA_WRITE (1)&n; *     0 = _DIR_NONE&t;changed to SCSI_DATA_NONE (3)&n; *    -1 = _DATA_IN&t;changed to SCSI_DATA_READ (2)&n; * If the direction is unknown, fall through to original code.&n; */
r_static
r_int
DECL|function|mptscsih_io_direction
id|mptscsih_io_direction
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_if
c_cond
(paren
id|cmd-&gt;sc_data_direction
op_ne
id|SCSI_DATA_UNKNOWN
)paren
r_return
id|cmd-&gt;sc_data_direction
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/*  _DATA_OUT commands&t;*/
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_12
suffix:colon
r_case
id|WRITE_LONG
suffix:colon
r_case
id|WRITE_SAME
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
r_case
id|WRITE_VERIFY
suffix:colon
r_case
id|WRITE_VERIFY_12
suffix:colon
r_case
id|COMPARE
suffix:colon
r_case
id|COPY
suffix:colon
r_case
id|COPY_VERIFY
suffix:colon
r_case
id|SEARCH_EQUAL
suffix:colon
r_case
id|SEARCH_HIGH
suffix:colon
r_case
id|SEARCH_LOW
suffix:colon
r_case
id|SEARCH_EQUAL_12
suffix:colon
r_case
id|SEARCH_HIGH_12
suffix:colon
r_case
id|SEARCH_LOW_12
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
r_case
id|MODE_SELECT_10
suffix:colon
r_case
id|LOG_SELECT
suffix:colon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|CHANGE_DEFINITION
suffix:colon
r_case
id|UPDATE_BLOCK
suffix:colon
r_case
id|SET_WINDOW
suffix:colon
r_case
id|MEDIUM_SCAN
suffix:colon
r_case
id|SEND_VOLUME_TAG
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_case
id|PERSISTENT_RESERVE_OUT
suffix:colon
r_case
l_int|0xea
suffix:colon
r_case
l_int|0xa3
suffix:colon
r_return
id|SCSI_DATA_WRITE
suffix:semicolon
multiline_comment|/*  No data transfer commands  */
r_case
id|SEEK_6
suffix:colon
r_case
id|SEEK_10
suffix:colon
r_case
id|RESERVE
suffix:colon
r_case
id|RELEASE
suffix:colon
r_case
id|TEST_UNIT_READY
suffix:colon
r_case
id|START_STOP
suffix:colon
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_return
id|SCSI_DATA_NONE
suffix:semicolon
multiline_comment|/*  Conditional data transfer commands&t;*/
r_case
id|FORMAT_UNIT
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x10
)paren
multiline_comment|/* FmtData (data out phase)? */
r_return
id|SCSI_DATA_WRITE
suffix:semicolon
r_else
r_return
id|SCSI_DATA_NONE
suffix:semicolon
r_case
id|VERIFY
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x02
)paren
multiline_comment|/* VERIFY:BYTCHK (data out phase)? */
r_return
id|SCSI_DATA_WRITE
suffix:semicolon
r_else
r_return
id|SCSI_DATA_NONE
suffix:semicolon
r_case
id|RESERVE_10
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x03
)paren
multiline_comment|/* RESERVE:{LongID|Extent} (data out phase)? */
r_return
id|SCSI_DATA_WRITE
suffix:semicolon
r_else
r_return
id|SCSI_DATA_NONE
suffix:semicolon
macro_line|#if 0
r_case
id|REZERO_UNIT
suffix:colon
multiline_comment|/* (or REWIND) */
r_case
id|SPACE
suffix:colon
r_case
id|ERASE
suffix:colon
r_case
id|ERASE_10
suffix:colon
r_case
id|SYNCHRONIZE_CACHE
suffix:colon
r_case
id|LOCK_UNLOCK_CACHE
suffix:colon
macro_line|#endif
multiline_comment|/*  Must be data _IN!  */
r_default
suffix:colon
r_return
id|SCSI_DATA_READ
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Utility function to copy sense data from the scsi_cmnd buffer&n; * to the FC and SCSI target structures.&n; *&n; */
r_static
r_void
DECL|function|copy_sense_data
id|copy_sense_data
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
)paren
(brace
id|VirtDevice
op_star
id|target
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pReq
suffix:semicolon
id|u32
id|sense_count
op_assign
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;SenseCount
)paren
suffix:semicolon
r_int
id|index
suffix:semicolon
r_char
id|devFoo
(braket
l_int|96
)braket
suffix:semicolon
id|IO_Info_t
id|thisIo
suffix:semicolon
multiline_comment|/* Get target structure&n;&t; */
id|pReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|index
op_assign
(paren
r_int
)paren
id|pReq-&gt;TargetID
suffix:semicolon
id|target
op_assign
id|hd-&gt;Targets
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;is_multipath
op_logical_and
id|sc-&gt;device-&gt;hostdata
)paren
id|target
op_assign
(paren
id|VirtDevice
op_star
)paren
id|sc-&gt;device-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|sense_count
)paren
(brace
id|u8
op_star
id|sense_data
suffix:semicolon
r_int
id|req_index
suffix:semicolon
multiline_comment|/* Copy the sense received into the scsi command block. */
id|req_index
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sense_data
op_assign
(paren
(paren
id|u8
op_star
)paren
id|hd-&gt;ioc-&gt;sense_buf_pool
op_plus
(paren
id|req_index
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|sc-&gt;sense_buffer
comma
id|sense_data
comma
id|SNS_LEN
c_func
(paren
id|sc
)paren
)paren
suffix:semicolon
multiline_comment|/* save sense data to the target device&n;&t;&t; */
r_if
c_cond
(paren
id|target
)paren
(brace
r_int
id|sz
suffix:semicolon
id|sz
op_assign
id|MIN
c_func
(paren
id|pReq-&gt;SenseBufferLength
comma
id|sense_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sz
OG
id|SCSI_STD_SENSE_BYTES
)paren
id|sz
op_assign
id|SCSI_STD_SENSE_BYTES
suffix:semicolon
id|memcpy
c_func
(paren
id|target-&gt;sense
comma
id|sense_data
comma
id|sz
)paren
suffix:semicolon
id|target-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_SENSE
suffix:semicolon
)brace
multiline_comment|/* Log SMART data (asc = 0x5D, non-IM case only) if required.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;events
)paren
op_logical_and
(paren
id|hd-&gt;ioc-&gt;eventTypes
op_amp
(paren
l_int|1
op_lshift
id|MPI_EVENT_SCSI_DEVICE_STATUS_CHANGE
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|sense_data
(braket
l_int|12
)braket
op_eq
l_int|0x5D
)paren
op_logical_and
(paren
id|target-&gt;raidVolume
op_eq
l_int|0
)paren
)paren
(brace
r_int
id|idx
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|idx
op_assign
id|ioc-&gt;eventContext
op_mod
id|ioc-&gt;eventLogSize
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|event
op_assign
id|MPI_EVENT_SCSI_DEVICE_STATUS_CHANGE
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|eventContext
op_assign
id|ioc-&gt;eventContext
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|pReq-&gt;LUN
(braket
l_int|1
)braket
op_lshift
l_int|24
)paren
op_logical_or
(paren
id|MPI_EVENT_SCSI_DEV_STAT_RC_SMART_DATA
op_lshift
l_int|16
)paren
op_logical_or
(paren
id|pReq-&gt;Bus
op_lshift
l_int|8
)paren
op_logical_or
id|pReq-&gt;TargetID
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|sense_data
(braket
l_int|13
)braket
op_lshift
l_int|8
)paren
op_logical_or
id|sense_data
(braket
l_int|12
)braket
suffix:semicolon
id|ioc-&gt;eventContext
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Print an error report for the user.&n;&t;&t; */
id|thisIo.cdbPtr
op_assign
id|sc-&gt;cmnd
suffix:semicolon
id|thisIo.sensePtr
op_assign
id|sc-&gt;sense_buffer
suffix:semicolon
id|thisIo.SCSIStatus
op_assign
id|pScsiReply-&gt;SCSIStatus
suffix:semicolon
id|thisIo.DoDisplay
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;is_multipath
)paren
id|sprintf
c_func
(paren
id|devFoo
comma
l_string|&quot;%d:%d:%d &bslash;&quot;%s&bslash;&quot;&quot;
comma
id|hd-&gt;ioc-&gt;id
comma
id|pReq-&gt;TargetID
comma
id|pReq-&gt;LUN
(braket
l_int|1
)braket
comma
id|target-&gt;dev_vol_name
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|devFoo
comma
l_string|&quot;%d:%d:%d&quot;
comma
id|hd-&gt;ioc-&gt;id
comma
id|sc-&gt;target
comma
id|sc-&gt;lun
)paren
suffix:semicolon
id|thisIo.DevIDStr
op_assign
id|devFoo
suffix:semicolon
multiline_comment|/* fubar */
id|thisIo.dataPtr
op_assign
l_int|NULL
suffix:semicolon
id|thisIo.inqPtr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;device
)paren
(brace
id|thisIo.inqPtr
op_assign
id|sc-&gt;device-&gt;vendor
op_minus
l_int|8
suffix:semicolon
multiline_comment|/* FIXME!!! */
)brace
(paren
r_void
)paren
id|mpt_ScsiHost_ErrorReport
c_func
(paren
op_amp
id|thisIo
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Hmmm... SenseData len=0! (?)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
id|u32
DECL|function|SCPNT_TO_LOOKUP_IDX
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sc-&gt;host-&gt;hostdata
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
(braket
id|i
)braket
op_eq
id|sc
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* see mptscsih.h */
macro_line|#ifdef MPT_SCSIHOST_NEED_ENTRY_EXIT_HOOKUPS
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|MPT_SCSIHOST
suffix:semicolon
macro_line|#&t;include &quot;../../scsi/scsi_module.c&quot;
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Search the pendingQ for a command with specific index.&n; * If found, delete and return mf pointer  &n; * If not found, return NULL&n; */
r_static
id|MPT_FRAME_HDR
op_star
DECL|function|mptscsih_search_pendingQ
id|mptscsih_search_pendingQ
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|scpnt_idx
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|MPT_DONE_Q
op_star
id|buffer
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|cmdMfPtr
op_assign
l_int|NULL
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: search_pendingQ called...&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|cmdMfPtr
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|hd-&gt;ioc
comma
id|scpnt_idx
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;pendingQ
)paren
)paren
(brace
id|buffer
op_assign
id|hd-&gt;pendingQ.head
suffix:semicolon
r_do
(brace
id|mf
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|buffer-&gt;argp
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_eq
id|cmdMfPtr
)paren
(brace
id|Q_DEL_ITEM
c_func
(paren
id|buffer
)paren
suffix:semicolon
multiline_comment|/* clear the arg pointer&n;&t;&t;&t;&t; */
id|buffer-&gt;argp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Add to the freeQ&n;&t;&t;&t;&t; */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;freeQ.head
comma
id|buffer
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|buffer
op_assign
id|buffer-&gt;forw
)paren
op_ne
(paren
id|MPT_DONE_Q
op_star
)paren
op_amp
id|hd-&gt;pendingQ
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot; ...return %p&bslash;n&quot;
comma
id|mf
)paren
)paren
suffix:semicolon
r_return
id|mf
suffix:semicolon
)brace
multiline_comment|/* Post all commands on the pendingQ to the FW.&n; * Lock Q when deleting/adding members&n; * Lock io_request_lock for OS callback.&n; */
r_static
r_void
DECL|function|post_pendingQ_commands
id|post_pendingQ_commands
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|MPT_DONE_Q
op_star
id|buffer
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Flush the pendingQ.&n;&t; */
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;: post_pendingQ_commands called&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|hd-&gt;pendingQ
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|buffer
op_assign
id|hd-&gt;pendingQ.head
suffix:semicolon
multiline_comment|/* Delete from Q&n;&t;&t; */
id|Q_DEL_ITEM
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|mf
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|buffer-&gt;argp
suffix:semicolon
id|buffer-&gt;argp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Add to the freeQ&n;&t;&t; */
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|hd-&gt;freeQ.head
comma
id|buffer
comma
id|MPT_DONE_Q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;freedoneQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mf
)paren
(brace
multiline_comment|/* This should never happen */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;post_pendingQ_commands: mf %p&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
(paren
r_void
op_star
)paren
id|mf
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|mptscsih_put_msgframe
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Issued SCSI cmd (mf=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|mf
)paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptscsih_ioc_reset
id|mptscsih_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOC %s_reset routed to SCSI host driver!&bslash;n&quot;
comma
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
ques
c_cond
l_string|&quot;pre&quot;
suffix:colon
l_string|&quot;post&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* If a FW reload request arrives after base installed but&n;&t; * before all scsi hosts have been attached, then an alt_ioc&n;&t; * may have a NULL sh pointer.&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc-&gt;sh
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|ioc-&gt;sh-&gt;hostdata
op_eq
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_else
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Do Pre-Diag Reset handling&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Clean Up:&n;&t;&t; * 1. Set Hard Reset Pending Flag&n;&t;&t; * All new commands go to doneQ&n;&t;&t; */
id|hd-&gt;resetPending
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 2. Flush running commands&n;&t;&t; *&t;Clean drop test code - if compiled&n;&t;&t; *&t;Clean ScsiLookup (and associated memory)&n;&t;&t; *&t;AND clean mytaskQ&n;&t;&t; */
multiline_comment|/* 2a. Drop Test Command.&n;&t;&t; */
macro_line|#ifdef&t;DROP_TEST
(brace
id|Scsi_Cmnd
op_star
id|sc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
multiline_comment|/* Free resources for the drop test MF&n;&t;&t;&t; * and chain buffers.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dropMfPtr
)paren
(brace
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|dropMfPtr-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sc
op_assign
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Drop Test: NULL ScsiCmd ptr!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|sc-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
id|MPT_HOST_LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sc
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|sc
)paren
suffix:semicolon
multiline_comment|/* Issue callback */
id|MPT_HOST_UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|mptscsih_freeChainBuffers
c_func
(paren
id|hd
comma
id|req_idx
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|ioc-&gt;id
comma
id|dropMfPtr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Free&squot;d: mf (%p) reqidx (%4x)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|dropMfPtr
comma
id|req_idx
)paren
suffix:semicolon
)brace
id|dropMfPtr
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* 2b. Reply to OS all known outstanding I/O commands.&n;&t;&t; */
id|mptscsih_flush_running_cmds
c_func
(paren
id|hd
)paren
suffix:semicolon
multiline_comment|/* 2c. If there was an internal command that&n;&t;&t; * has not completed, configuration or io request,&n;&t;&t; * free these resources.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;cmdPtr
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ScsiScanDvCtx
comma
id|ioc-&gt;id
comma
id|hd-&gt;cmdPtr
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
)brace
multiline_comment|/* 2d. If a task management has not completed,&n;&t;&t; * free resources associated with this request.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;tmPtr
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|ioc-&gt;id
comma
id|hd-&gt;tmPtr
)paren
suffix:semicolon
)brace
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
multiline_comment|/* 2e. Delete all commands on taskQ&n;&t;&t; * Should be superfluous - as this taskQ should&n;&t;&t; * be empty.&n;&t;&t; */
id|clean_taskQ
c_func
(paren
id|hd
)paren
suffix:semicolon
macro_line|#endif
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Pre-Reset handling complete.&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Do Post-Diag Reset handling&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Once a FW reload begins, all new OS commands are&n;&t;&t; * redirected to the doneQ w/ a reset status.&n;&t;&t; * Init all control structures.&n;&t;&t; */
multiline_comment|/* ScsiLookup initialization&n;&t;&t; */
(brace
r_int
id|ii
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|ii
op_increment
)paren
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* 2. Chain Buffer initialization&n;&t;&t; */
id|mptscsih_initChainBuffers
c_func
(paren
id|hd
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 3. tmPtr clear&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;tmPtr
)paren
(brace
id|hd-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* 4. Renegotiate to all devices, if SCSI&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
l_int|0
comma
id|MPT_SCSICFG_ALL_IDS
op_or
id|MPT_SCSICFG_USE_NVRAM
)paren
suffix:semicolon
multiline_comment|/* 5. Enable new commands to be posted&n;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;resetPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;numTMrequests
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 6. If there was an internal command,&n;&t;&t; * wake this process up.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;cmdPtr
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Wake up the original calling thread&n;&t;&t;&t; */
id|hd-&gt;pLocal
op_assign
op_amp
id|hd-&gt;localReply
suffix:semicolon
id|hd-&gt;pLocal-&gt;completion
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
id|scandv_wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|scandv_waitq
)paren
suffix:semicolon
id|hd-&gt;cmdPtr
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* 7. Flush doneQ&n;&t;&t; */
id|flush_doneQ
c_func
(paren
id|hd
)paren
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Post-Reset handling complete.&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* currently means nothing really */
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptscsih_event_process
id|mptscsih_event_process
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEvReply
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|u8
id|event
op_assign
id|le32_to_cpu
c_func
(paren
id|pEvReply-&gt;Event
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;MPT event (=%02Xh) routed to SCSI host driver!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|event
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|MPI_EVENT_UNIT_ATTENTION
suffix:colon
multiline_comment|/* 03 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_IOC_BUS_RESET
suffix:colon
multiline_comment|/* 04 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_EXT_BUS_RESET
suffix:colon
multiline_comment|/* 05 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOGOUT
suffix:colon
multiline_comment|/* 09 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  CHECKME! Don&squot;t think we need to do&n;&t;&t; *  anything for these, but...&n;&t;&t; */
r_case
id|MPI_EVENT_RESCAN
suffix:colon
multiline_comment|/* 06 */
r_case
id|MPI_EVENT_LINK_STATUS_CHANGE
suffix:colon
multiline_comment|/* 07 */
r_case
id|MPI_EVENT_LOOP_STATE_CHANGE
suffix:colon
multiline_comment|/* 08 */
multiline_comment|/*&n;&t;&t; *  CHECKME!  Falling thru...&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_INTEGRATED_RAID
suffix:colon
multiline_comment|/* 0B */
macro_line|#ifndef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
multiline_comment|/* negoNvram set to 0 if DV enabled and to USE_NVRAM if &n;&t;&t; * if DV disabled. Need to check for target mode.&n;&t;&t; */
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_logical_and
(paren
id|hd-&gt;is_spi
)paren
op_logical_and
(paren
id|hd-&gt;negoNvram
op_eq
l_int|0
)paren
)paren
(brace
id|ScsiCfgData
op_star
id|pSpi
suffix:semicolon
id|Ioc3PhysDisk_t
op_star
id|pPDisk
suffix:semicolon
r_int
id|numPDisk
suffix:semicolon
id|u8
id|reason
suffix:semicolon
id|u8
id|physDiskNum
suffix:semicolon
id|reason
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|pEvReply-&gt;Data
(braket
l_int|0
)braket
)paren
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_eq
id|MPI_EVENT_RAID_RC_DOMAIN_VAL_NEEDED
)paren
(brace
multiline_comment|/* New or replaced disk. &n;&t;&t;&t;&t; * Set DV flag and schedule DV.&n;&t;&t;&t;&t; */
id|pSpi
op_assign
op_amp
id|ioc-&gt;spi_data
suffix:semicolon
id|physDiskNum
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|pEvReply-&gt;Data
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xFF000000
)paren
op_rshift
l_int|24
suffix:semicolon
r_if
c_cond
(paren
id|pSpi-&gt;pIocPg3
)paren
(brace
id|pPDisk
op_assign
id|pSpi-&gt;pIocPg3-&gt;PhysDisk
suffix:semicolon
id|numPDisk
op_assign
id|pSpi-&gt;pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
r_if
c_cond
(paren
id|physDiskNum
op_eq
id|pPDisk-&gt;PhysDiskNum
)paren
(brace
id|pSpi-&gt;dvStatus
(braket
id|pPDisk-&gt;PhysDiskID
)braket
op_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|pSpi-&gt;forceDv
op_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;NEED_DV set for phys disk id %d&bslash;n&quot;
comma
id|pPDisk-&gt;PhysDiskID
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif
macro_line|#if defined(MPT_DEBUG_DV) || defined(MPT_DEBUG_DV_TINY)
id|printk
c_func
(paren
l_string|&quot;Raid Event RF: &quot;
)paren
suffix:semicolon
(brace
id|u32
op_star
id|m
op_assign
(paren
id|u32
op_star
)paren
id|pEvReply
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|n
op_assign
(paren
r_int
)paren
id|pEvReply-&gt;MsgLength
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|6
suffix:semicolon
id|ii
OL
id|n
suffix:semicolon
id|ii
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|m
(braket
id|ii
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MPI_EVENT_NONE
suffix:colon
multiline_comment|/* 00 */
r_case
id|MPI_EVENT_LOG_DATA
suffix:colon
multiline_comment|/* 01 */
r_case
id|MPI_EVENT_STATE_CHANGE
suffix:colon
multiline_comment|/* 02 */
r_case
id|MPI_EVENT_EVENT_CHANGE
suffix:colon
multiline_comment|/* 0A */
r_default
suffix:colon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Ignoring event (=%02Xh)&bslash;n&quot;
comma
id|event
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* currently means nothing really */
)brace
macro_line|#if 0&t;&t;/* { */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;scsiherr.c - Fusion MPT SCSI Host driver error handling/reporting.&n; *&n; *&t;drivers/message/fusion/scsiherr.c&n; */
singleline_comment|//extern const char&t;**mpt_ScsiOpcodesPtr;&t;/* needed by mptscsih.c */
singleline_comment|//extern ASCQ_Table_t&t; *mpt_ASCQ_TablePtr;
singleline_comment|//extern int&t;&t;  mpt_ASCQ_TableSz;
mdefine_line|#define MYNAM&t;&quot;mptscsih&quot;
macro_line|#endif&t;&t;/* } */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Private data...&n; */
DECL|variable|mptscsih_ASCQ_TablePtr
r_static
id|ASCQ_Table_t
op_star
id|mptscsih_ASCQ_TablePtr
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* old symsense.c stuff... */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Private data...&n; * To protect ourselves against those that would pass us bogus pointers&n; */
DECL|variable|dummyInqData
r_static
id|u8
id|dummyInqData
(braket
id|SCSI_STD_INQUIRY_BYTES
)braket
op_assign
(brace
l_int|0x1F
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x1F
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|dummySenseData
r_static
id|u8
id|dummySenseData
(braket
id|SCSI_STD_SENSE_BYTES
)braket
op_assign
(brace
l_int|0x70
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x0A
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|dummyCDB
r_static
id|u8
id|dummyCDB
(braket
l_int|16
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|dummyScsiData
r_static
id|u8
id|dummyScsiData
(braket
l_int|16
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
macro_line|#if 0
r_static
r_const
r_char
op_star
id|PeripheralDeviceTypeString
(braket
l_int|32
)braket
op_assign
(brace
l_string|&quot;Direct-access&quot;
comma
multiline_comment|/* 00h */
l_string|&quot;Sequential-access&quot;
comma
multiline_comment|/* 01h */
l_string|&quot;Printer&quot;
comma
multiline_comment|/* 02h */
l_string|&quot;Processor&quot;
comma
multiline_comment|/* 03h */
multiline_comment|/*&quot;Write-Once-Read-Multiple&quot;,*/
multiline_comment|/* 04h */
l_string|&quot;WORM&quot;
comma
multiline_comment|/* 04h */
l_string|&quot;CD-ROM&quot;
comma
multiline_comment|/* 05h */
l_string|&quot;Scanner&quot;
comma
multiline_comment|/* 06h */
l_string|&quot;Optical memory&quot;
comma
multiline_comment|/* 07h */
l_string|&quot;Media Changer&quot;
comma
multiline_comment|/* 08h */
l_string|&quot;Communications&quot;
comma
multiline_comment|/* 09h */
l_string|&quot;(Graphics arts pre-press)&quot;
comma
multiline_comment|/* 0Ah */
l_string|&quot;(Graphics arts pre-press)&quot;
comma
multiline_comment|/* 0Bh */
l_string|&quot;Array controller&quot;
comma
multiline_comment|/* 0Ch */
l_string|&quot;Enclosure services&quot;
comma
multiline_comment|/* 0Dh */
l_string|&quot;Simplified direct-access&quot;
comma
multiline_comment|/* 0Eh */
l_string|&quot;Reserved-0Fh&quot;
comma
multiline_comment|/* 0Fh */
l_string|&quot;Reserved-10h&quot;
comma
multiline_comment|/* 10h */
l_string|&quot;Reserved-11h&quot;
comma
multiline_comment|/* 11h */
l_string|&quot;Reserved-12h&quot;
comma
multiline_comment|/* 12h */
l_string|&quot;Reserved-13h&quot;
comma
multiline_comment|/* 13h */
l_string|&quot;Reserved-14h&quot;
comma
multiline_comment|/* 14h */
l_string|&quot;Reserved-15h&quot;
comma
multiline_comment|/* 15h */
l_string|&quot;Reserved-16h&quot;
comma
multiline_comment|/* 16h */
l_string|&quot;Reserved-17h&quot;
comma
multiline_comment|/* 17h */
l_string|&quot;Reserved-18h&quot;
comma
multiline_comment|/* 18h */
l_string|&quot;Reserved-19h&quot;
comma
multiline_comment|/* 19h */
l_string|&quot;Reserved-1Ah&quot;
comma
multiline_comment|/* 1Ah */
l_string|&quot;Reserved-1Bh&quot;
comma
multiline_comment|/* 1Bh */
l_string|&quot;Reserved-1Ch&quot;
comma
multiline_comment|/* 1Ch */
l_string|&quot;Reserved-1Dh&quot;
comma
multiline_comment|/* 1Dh */
l_string|&quot;Reserved-1Eh&quot;
comma
multiline_comment|/* 1Eh */
l_string|&quot;Unknown&quot;
multiline_comment|/* 1Fh */
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|ScsiStatusString
r_static
r_char
op_star
id|ScsiStatusString
(braket
)braket
op_assign
(brace
l_string|&quot;GOOD&quot;
comma
multiline_comment|/* 00h */
l_int|NULL
comma
multiline_comment|/* 01h */
l_string|&quot;CHECK CONDITION&quot;
comma
multiline_comment|/* 02h */
l_int|NULL
comma
multiline_comment|/* 03h */
l_string|&quot;CONDITION MET&quot;
comma
multiline_comment|/* 04h */
l_int|NULL
comma
multiline_comment|/* 05h */
l_int|NULL
comma
multiline_comment|/* 06h */
l_int|NULL
comma
multiline_comment|/* 07h */
l_string|&quot;BUSY&quot;
comma
multiline_comment|/* 08h */
l_int|NULL
comma
multiline_comment|/* 09h */
l_int|NULL
comma
multiline_comment|/* 0Ah */
l_int|NULL
comma
multiline_comment|/* 0Bh */
l_int|NULL
comma
multiline_comment|/* 0Ch */
l_int|NULL
comma
multiline_comment|/* 0Dh */
l_int|NULL
comma
multiline_comment|/* 0Eh */
l_int|NULL
comma
multiline_comment|/* 0Fh */
l_string|&quot;INTERMEDIATE&quot;
comma
multiline_comment|/* 10h */
l_int|NULL
comma
multiline_comment|/* 11h */
l_int|NULL
comma
multiline_comment|/* 12h */
l_int|NULL
comma
multiline_comment|/* 13h */
l_string|&quot;INTERMEDIATE-CONDITION MET&quot;
comma
multiline_comment|/* 14h */
l_int|NULL
comma
multiline_comment|/* 15h */
l_int|NULL
comma
multiline_comment|/* 16h */
l_int|NULL
comma
multiline_comment|/* 17h */
l_string|&quot;RESERVATION CONFLICT&quot;
comma
multiline_comment|/* 18h */
l_int|NULL
comma
multiline_comment|/* 19h */
l_int|NULL
comma
multiline_comment|/* 1Ah */
l_int|NULL
comma
multiline_comment|/* 1Bh */
l_int|NULL
comma
multiline_comment|/* 1Ch */
l_int|NULL
comma
multiline_comment|/* 1Dh */
l_int|NULL
comma
multiline_comment|/* 1Eh */
l_int|NULL
comma
multiline_comment|/* 1Fh */
l_int|NULL
comma
multiline_comment|/* 20h */
l_int|NULL
comma
multiline_comment|/* 21h */
l_string|&quot;COMMAND TERMINATED&quot;
comma
multiline_comment|/* 22h */
l_int|NULL
comma
multiline_comment|/* 23h */
l_int|NULL
comma
multiline_comment|/* 24h */
l_int|NULL
comma
multiline_comment|/* 25h */
l_int|NULL
comma
multiline_comment|/* 26h */
l_int|NULL
comma
multiline_comment|/* 27h */
l_string|&quot;TASK SET FULL&quot;
comma
multiline_comment|/* 28h */
l_int|NULL
comma
multiline_comment|/* 29h */
l_int|NULL
comma
multiline_comment|/* 2Ah */
l_int|NULL
comma
multiline_comment|/* 2Bh */
l_int|NULL
comma
multiline_comment|/* 2Ch */
l_int|NULL
comma
multiline_comment|/* 2Dh */
l_int|NULL
comma
multiline_comment|/* 2Eh */
l_int|NULL
comma
multiline_comment|/* 2Fh */
l_string|&quot;ACA ACTIVE&quot;
comma
multiline_comment|/* 30h */
l_int|NULL
)brace
suffix:semicolon
DECL|variable|ScsiCommonOpString
r_static
r_const
r_char
op_star
id|ScsiCommonOpString
(braket
)braket
op_assign
(brace
l_string|&quot;TEST UNIT READY&quot;
comma
multiline_comment|/* 00h */
l_string|&quot;REZERO UNIT (REWIND)&quot;
comma
multiline_comment|/* 01h */
l_int|NULL
comma
multiline_comment|/* 02h */
l_string|&quot;REQUEST_SENSE&quot;
comma
multiline_comment|/* 03h */
l_string|&quot;FORMAT UNIT (MEDIUM)&quot;
comma
multiline_comment|/* 04h */
l_string|&quot;READ BLOCK LIMITS&quot;
comma
multiline_comment|/* 05h */
l_int|NULL
comma
multiline_comment|/* 06h */
l_string|&quot;REASSIGN BLOCKS&quot;
comma
multiline_comment|/* 07h */
l_string|&quot;READ(6)&quot;
comma
multiline_comment|/* 08h */
l_int|NULL
comma
multiline_comment|/* 09h */
l_string|&quot;WRITE(6)&quot;
comma
multiline_comment|/* 0Ah */
l_string|&quot;SEEK(6)&quot;
comma
multiline_comment|/* 0Bh */
l_int|NULL
comma
multiline_comment|/* 0Ch */
l_int|NULL
comma
multiline_comment|/* 0Dh */
l_int|NULL
comma
multiline_comment|/* 0Eh */
l_string|&quot;READ REVERSE&quot;
comma
multiline_comment|/* 0Fh */
l_string|&quot;WRITE_FILEMARKS&quot;
comma
multiline_comment|/* 10h */
l_string|&quot;SPACE(6)&quot;
comma
multiline_comment|/* 11h */
l_string|&quot;INQUIRY&quot;
comma
multiline_comment|/* 12h */
l_int|NULL
)brace
suffix:semicolon
DECL|variable|SenseKeyString
r_static
r_const
r_char
op_star
id|SenseKeyString
(braket
)braket
op_assign
(brace
l_string|&quot;NO SENSE&quot;
comma
multiline_comment|/* 0h */
l_string|&quot;RECOVERED ERROR&quot;
comma
multiline_comment|/* 1h */
l_string|&quot;NOT READY&quot;
comma
multiline_comment|/* 2h */
l_string|&quot;MEDIUM ERROR&quot;
comma
multiline_comment|/* 3h */
l_string|&quot;HARDWARE ERROR&quot;
comma
multiline_comment|/* 4h */
l_string|&quot;ILLEGAL REQUEST&quot;
comma
multiline_comment|/* 5h */
l_string|&quot;UNIT ATTENTION&quot;
comma
multiline_comment|/* 6h */
l_string|&quot;DATA PROTECT&quot;
comma
multiline_comment|/* 7h */
l_string|&quot;BLANK CHECK&quot;
comma
multiline_comment|/* 8h */
l_string|&quot;VENDOR-SPECIFIC&quot;
comma
multiline_comment|/* 9h */
l_string|&quot;ABORTED COPY&quot;
comma
multiline_comment|/* Ah */
l_string|&quot;ABORTED COMMAND&quot;
comma
multiline_comment|/* Bh */
l_string|&quot;EQUAL (obsolete)&quot;
comma
multiline_comment|/* Ch */
l_string|&quot;VOLUME OVERFLOW&quot;
comma
multiline_comment|/* Dh */
l_string|&quot;MISCOMPARE&quot;
comma
multiline_comment|/* Eh */
l_string|&quot;RESERVED&quot;
comma
multiline_comment|/* Fh */
l_int|NULL
)brace
suffix:semicolon
DECL|macro|SPECIAL_ASCQ
mdefine_line|#define SPECIAL_ASCQ(c,q) &bslash;&n;&t;(((c) == 0x40 &amp;&amp; (q) != 0x00) || ((c) == 0x4D) || ((c) == 0x70))
macro_line|#if 0
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Sense_Key_Specific() - If Sense_Key_Specific_Valid bit is set,&n; *&t;&t;&t;   then print additional information via&n; *&t;&t;&t;   a call to SDMS_SystemAlert().&n; */
r_static
r_void
id|Sense_Key_Specific
c_func
(paren
id|IO_Info_t
op_star
id|ioop
comma
r_char
op_star
id|msg1
)paren
(brace
id|u8
op_star
id|sd
suffix:semicolon
id|u8
id|BadValue
suffix:semicolon
id|u8
id|SenseKey
suffix:semicolon
r_int
id|Offset
suffix:semicolon
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|msg1
)paren
suffix:semicolon
id|sd
op_assign
id|ioop-&gt;sensePtr
suffix:semicolon
r_if
c_cond
(paren
id|SD_Additional_Sense_Length
c_func
(paren
id|sd
)paren
OL
l_int|8
)paren
r_return
suffix:semicolon
id|SenseKey
op_assign
id|SD_Sense_Key
c_func
(paren
id|sd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SD_Sense_Key_Specific_Valid
c_func
(paren
id|sd
)paren
)paren
(brace
r_if
c_cond
(paren
id|SenseKey
op_eq
id|SK_ILLEGAL_REQUEST
)paren
(brace
id|Offset
op_assign
id|SD_Bad_Byte
c_func
(paren
id|sd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SD_Was_Illegal_Request
c_func
(paren
id|sd
)paren
)paren
(brace
id|BadValue
op_assign
id|ioop-&gt;cdbPtr
(braket
id|Offset
)braket
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;&bslash;n  Illegal CDB value=%02Xh found at CDB &quot;
comma
id|BadValue
)paren
suffix:semicolon
)brace
r_else
(brace
id|BadValue
op_assign
id|ioop-&gt;dataPtr
(braket
id|Offset
)braket
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;&bslash;n  Illegal DATA value=%02Xh found at DATA &quot;
comma
id|BadValue
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;byte=%02Xh&quot;
comma
id|Offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SD_SKS_Bit_Pointer_Valid
c_func
(paren
id|sd
)paren
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;/bit=%1Xh&quot;
comma
id|SD_SKS_Bit_Pointer
c_func
(paren
id|sd
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|SenseKey
op_eq
id|SK_RECOVERED_ERROR
)paren
op_logical_or
(paren
id|SenseKey
op_eq
id|SK_HARDWARE_ERROR
)paren
op_logical_or
(paren
id|SenseKey
op_eq
id|SK_MEDIUM_ERROR
)paren
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;&bslash;n  Recovery algorithm Actual_Retry_Count=%02Xh&quot;
comma
id|SD_Actual_Retry_Count
c_func
(paren
id|sd
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|dump_cdb
r_static
r_int
id|dump_cdb
c_func
(paren
r_char
op_star
id|foo
comma
r_int
r_char
op_star
id|cdb
)paren
(brace
r_int
id|i
comma
id|grpCode
comma
id|cdbLen
suffix:semicolon
r_int
id|l
op_assign
l_int|0
suffix:semicolon
id|grpCode
op_assign
id|cdb
(braket
l_int|0
)braket
op_rshift
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|grpCode
OL
l_int|1
)paren
id|cdbLen
op_assign
l_int|6
suffix:semicolon
r_else
r_if
c_cond
(paren
id|grpCode
OL
l_int|3
)paren
id|cdbLen
op_assign
l_int|10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|grpCode
op_eq
l_int|5
)paren
id|cdbLen
op_assign
l_int|12
suffix:semicolon
r_else
id|cdbLen
op_assign
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cdbLen
suffix:semicolon
id|i
op_increment
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; %02X&quot;
comma
id|cdb
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|dump_sd
r_static
r_int
id|dump_sd
c_func
(paren
r_char
op_star
id|foo
comma
r_int
r_char
op_star
id|sd
)paren
(brace
r_int
id|snsLen
op_assign
l_int|8
op_plus
id|SD_Additional_Sense_Length
c_func
(paren
id|sd
)paren
suffix:semicolon
r_int
id|l
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIN
c_func
(paren
id|snsLen
comma
l_int|18
)paren
suffix:semicolon
id|i
op_increment
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; %02X&quot;
comma
id|sd
(braket
id|i
)braket
)paren
suffix:semicolon
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot;%s&quot;
comma
id|snsLen
OG
l_int|18
ques
c_cond
l_string|&quot; ...&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*  Do ASC/ASCQ lookup/grindage to English readable string(s)  */
DECL|function|ascq_set_strings_4max
r_static
r_const
r_char
op_star
id|ascq_set_strings_4max
c_func
(paren
id|u8
id|ASC
comma
id|u8
id|ASCQ
comma
r_const
r_char
op_star
op_star
id|s1
comma
r_const
r_char
op_star
op_star
id|s2
comma
r_const
r_char
op_star
op_star
id|s3
comma
r_const
r_char
op_star
op_star
id|s4
)paren
(brace
r_static
r_const
r_char
op_star
id|asc_04_part1_string
op_assign
l_string|&quot;LOGICAL UNIT &quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|asc_04_part2a_string
op_assign
l_string|&quot;NOT READY, &quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|asc_04_part2b_string
op_assign
l_string|&quot;IS &quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|asc_04_ascq_NN_part3_strings
(braket
)braket
op_assign
(brace
multiline_comment|/* ASC ASCQ (hex) */
l_string|&quot;CAUSE NOT REPORTABLE&quot;
comma
multiline_comment|/* 04 00 */
l_string|&quot;IN PROCESS OF BECOMING READY&quot;
comma
multiline_comment|/* 04 01 */
l_string|&quot;INITIALIZING CMD. REQUIRED&quot;
comma
multiline_comment|/* 04 02 */
l_string|&quot;MANUAL INTERVENTION REQUIRED&quot;
comma
multiline_comment|/* 04 03 */
multiline_comment|/* Add&t;&quot; IN PROGRESS&quot; to all the following... */
l_string|&quot;FORMAT&quot;
comma
multiline_comment|/* 04 04 */
l_string|&quot;REBUILD&quot;
comma
multiline_comment|/* 04 05 */
l_string|&quot;RECALCULATION&quot;
comma
multiline_comment|/* 04 06 */
l_string|&quot;OPERATION&quot;
comma
multiline_comment|/* 04 07 */
l_string|&quot;LONG WRITE&quot;
comma
multiline_comment|/* 04 08 */
l_string|&quot;SELF-TEST&quot;
comma
multiline_comment|/* 04 09 */
l_int|NULL
)brace
suffix:semicolon
r_static
r_char
op_star
id|asc_04_part4_string
op_assign
l_string|&quot; IN PROGRESS&quot;
suffix:semicolon
r_static
r_char
op_star
id|asc_29_ascq_NN_strings
(braket
)braket
op_assign
(brace
multiline_comment|/* ASC ASCQ (hex) */
l_string|&quot;POWER ON, RESET, OR BUS DEVICE RESET OCCURRED&quot;
comma
multiline_comment|/* 29 00 */
l_string|&quot;POWER ON OCCURRED&quot;
comma
multiline_comment|/* 29 01 */
l_string|&quot;SCSI BUS RESET OCCURRED&quot;
comma
multiline_comment|/* 29 02 */
l_string|&quot;BUS DEVICE RESET FUNCTION OCCURRED&quot;
comma
multiline_comment|/* 29 03 */
l_string|&quot;DEVICE INTERNAL RESET&quot;
comma
multiline_comment|/* 29 04 */
l_string|&quot;TRANSCEIVER MODE CHANGED TO SINGLE-ENDED&quot;
comma
multiline_comment|/* 29 05 */
l_string|&quot;TRANSCEIVER MODE CHANGED TO LVD&quot;
comma
multiline_comment|/* 29 06 */
l_int|NULL
)brace
suffix:semicolon
r_static
r_char
op_star
id|ascq_vendor_uniq
op_assign
l_string|&quot;(Vendor Unique)&quot;
suffix:semicolon
r_static
r_char
op_star
id|ascq_noone
op_assign
l_string|&quot;(no matching ASC/ASCQ description found)&quot;
suffix:semicolon
r_int
id|idx
suffix:semicolon
op_star
id|s1
op_assign
op_star
id|s2
op_assign
op_star
id|s3
op_assign
op_star
id|s4
op_assign
l_string|&quot;&quot;
suffix:semicolon
multiline_comment|/* set&squot;em all to the empty &quot;&quot; string */
multiline_comment|/* CHECKME! Need lock/sem?&n;&t; *  Update and examine for isense module presense.&n;&t; */
id|mptscsih_ASCQ_TablePtr
op_assign
(paren
id|ASCQ_Table_t
op_star
)paren
id|mpt_v_ASCQ_TablePtr
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_ASCQ_TablePtr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* 2nd chances... */
r_if
c_cond
(paren
id|ASC
op_eq
l_int|0x04
op_logical_and
(paren
id|ASCQ
OL
r_sizeof
(paren
id|asc_04_ascq_NN_part3_strings
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
op_minus
l_int|1
)paren
)paren
(brace
op_star
id|s1
op_assign
id|asc_04_part1_string
suffix:semicolon
op_star
id|s2
op_assign
(paren
id|ASCQ
op_eq
l_int|0x01
)paren
ques
c_cond
id|asc_04_part2b_string
suffix:colon
id|asc_04_part2a_string
suffix:semicolon
op_star
id|s3
op_assign
id|asc_04_ascq_NN_part3_strings
(braket
id|ASCQ
)braket
suffix:semicolon
multiline_comment|/* check for &quot; IN PROGRESS&quot; ones */
r_if
c_cond
(paren
id|ASCQ
op_ge
l_int|0x04
)paren
op_star
id|s4
op_assign
id|asc_04_part4_string
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ASC
op_eq
l_int|0x29
op_logical_and
(paren
id|ASCQ
OL
r_sizeof
(paren
id|asc_29_ascq_NN_strings
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
op_minus
l_int|1
)paren
)paren
op_star
id|s1
op_assign
id|asc_29_ascq_NN_strings
(braket
id|ASCQ
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Else { leave all *s[1-4] values pointing to the empty &quot;&quot; string }&n;&t;&t; */
r_return
op_star
id|s1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Need to check ASC here; if it is &quot;special,&quot; then&n;&t; * the ASCQ is variable, and indicates failed component number.&n;&t; * We must treat the ASCQ as a &quot;dont care&quot; while searching the&n;&t; * mptscsih_ASCQ_Table[] by masking it off, and then restoring it later&n;&t; * on when we actually need to identify the failed component.&n;&t; */
r_if
c_cond
(paren
id|SPECIAL_ASCQ
c_func
(paren
id|ASC
comma
id|ASCQ
)paren
)paren
id|ASCQ
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* OK, now search mptscsih_ASCQ_Table[] for a matching entry */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|mptscsih_ASCQ_TablePtr
op_logical_and
id|idx
OL
id|mpt_ASCQ_TableSz
suffix:semicolon
id|idx
op_increment
)paren
r_if
c_cond
(paren
(paren
id|ASC
op_eq
id|mptscsih_ASCQ_TablePtr
(braket
id|idx
)braket
dot
id|ASC
)paren
op_logical_and
(paren
id|ASCQ
op_eq
id|mptscsih_ASCQ_TablePtr
(braket
id|idx
)braket
dot
id|ASCQ
)paren
)paren
(brace
op_star
id|s1
op_assign
id|mptscsih_ASCQ_TablePtr
(braket
id|idx
)braket
dot
id|Description
suffix:semicolon
r_return
op_star
id|s1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ASC
op_ge
l_int|0x80
)paren
op_logical_or
(paren
id|ASCQ
op_ge
l_int|0x80
)paren
)paren
op_star
id|s1
op_assign
id|ascq_vendor_uniq
suffix:semicolon
r_else
op_star
id|s1
op_assign
id|ascq_noone
suffix:semicolon
r_return
op_star
id|s1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  SCSI Error Report; desired output format...&n; *---&n;SCSI Error Report =-=-=-=-=-=-=-=-=-=-=-=-=-= (ioc0,scsi0:0)&n;  SCSI_Status=02h (CHECK CONDITION)&n;  Original_CDB[]: 00 00 00 00 00 00 - TestUnitReady&n;  SenseData[12h]: 70 00 06 00 00 00 00 0A 00 00 00 00 29 00 03 00 00 00&n;  SenseKey=6h (UNIT ATTENTION); FRU=03h&n;  ASC/ASCQ=29h/00h, &quot;POWER ON, RESET, OR BUS DEVICE RESET OCCURRED&quot;&n; *---&n; */
DECL|function|mpt_ScsiHost_ErrorReport
r_int
id|mpt_ScsiHost_ErrorReport
c_func
(paren
id|IO_Info_t
op_star
id|ioop
)paren
(brace
r_char
id|foo
(braket
l_int|512
)braket
suffix:semicolon
r_char
id|buf2
(braket
l_int|32
)braket
suffix:semicolon
r_char
op_star
id|statstr
suffix:semicolon
r_const
r_char
op_star
id|opstr
suffix:semicolon
r_int
id|sk
op_assign
id|SD_Sense_Key
c_func
(paren
id|ioop-&gt;sensePtr
)paren
suffix:semicolon
r_const
r_char
op_star
id|skstr
op_assign
id|SenseKeyString
(braket
id|sk
)braket
suffix:semicolon
r_int
r_char
id|asc
op_assign
id|SD_ASC
c_func
(paren
id|ioop-&gt;sensePtr
)paren
suffix:semicolon
r_int
r_char
id|ascq
op_assign
id|SD_ASCQ
c_func
(paren
id|ioop-&gt;sensePtr
)paren
suffix:semicolon
r_int
id|l
suffix:semicolon
multiline_comment|/*&n;&t; *  More quiet mode.&n;&t; *  Filter out common, repetitive, warning-type errors...  like:&n;&t; *    POWER ON (06,29/00 or 06,29/01),&n;&t; *    SPINNING UP (02,04/01),&n;&t; *    LOGICAL UNIT NOT SUPPORTED (05,25/00), etc.&n;&t; */
r_if
c_cond
(paren
id|sk
op_eq
id|SK_NO_SENSE
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sk
op_eq
id|SK_UNIT_ATTENTION
op_logical_and
id|asc
op_eq
l_int|0x29
op_logical_and
(paren
id|ascq
op_eq
l_int|0x00
op_logical_or
id|ascq
op_eq
l_int|0x01
)paren
)paren
op_logical_or
(paren
id|sk
op_eq
id|SK_NOT_READY
op_logical_and
id|asc
op_eq
l_int|0x04
op_logical_and
(paren
id|ascq
op_eq
l_int|0x01
op_logical_or
id|ascq
op_eq
l_int|0x02
)paren
)paren
op_logical_or
(paren
id|sk
op_eq
id|SK_ILLEGAL_REQUEST
op_logical_and
id|asc
op_eq
l_int|0x25
op_logical_and
id|ascq
op_eq
l_int|0x00
)paren
)paren
(brace
multiline_comment|/* Do nothing! */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Protect ourselves...&n;&t; */
r_if
c_cond
(paren
id|ioop-&gt;cdbPtr
op_eq
l_int|NULL
)paren
id|ioop-&gt;cdbPtr
op_assign
id|dummyCDB
suffix:semicolon
r_if
c_cond
(paren
id|ioop-&gt;sensePtr
op_eq
l_int|NULL
)paren
id|ioop-&gt;sensePtr
op_assign
id|dummySenseData
suffix:semicolon
r_if
c_cond
(paren
id|ioop-&gt;inqPtr
op_eq
l_int|NULL
)paren
id|ioop-&gt;inqPtr
op_assign
id|dummyInqData
suffix:semicolon
r_if
c_cond
(paren
id|ioop-&gt;dataPtr
op_eq
l_int|NULL
)paren
id|ioop-&gt;dataPtr
op_assign
id|dummyScsiData
suffix:semicolon
id|statstr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioop-&gt;SCSIStatus
op_ge
r_sizeof
(paren
id|ScsiStatusString
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
op_minus
l_int|1
)paren
op_logical_or
(paren
(paren
id|statstr
op_assign
(paren
r_char
op_star
)paren
id|ScsiStatusString
(braket
id|ioop-&gt;SCSIStatus
)braket
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
(paren
r_void
)paren
id|sprintf
c_func
(paren
id|buf2
comma
l_string|&quot;Bad-Reserved-%02Xh&quot;
comma
id|ioop-&gt;SCSIStatus
)paren
suffix:semicolon
id|statstr
op_assign
id|buf2
suffix:semicolon
)brace
id|opstr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_plus
id|ioop-&gt;cdbPtr
(braket
l_int|0
)braket
op_le
r_sizeof
(paren
id|ScsiCommonOpString
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
)paren
id|opstr
op_assign
id|ScsiCommonOpString
(braket
id|ioop-&gt;cdbPtr
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mpt_ScsiOpcodesPtr
)paren
id|opstr
op_assign
id|mpt_ScsiOpcodesPtr
(braket
id|ioop-&gt;cdbPtr
(braket
l_int|0
)braket
)braket
suffix:semicolon
id|l
op_assign
id|sprintf
c_func
(paren
id|foo
comma
l_string|&quot;SCSI Error Report =-=-= (%s)&bslash;n&quot;
l_string|&quot;  SCSI_Status=%02Xh (%s)&bslash;n&quot;
l_string|&quot;  Original_CDB[]:&quot;
comma
id|ioop-&gt;DevIDStr
comma
id|ioop-&gt;SCSIStatus
comma
id|statstr
)paren
suffix:semicolon
id|l
op_add_assign
id|dump_cdb
c_func
(paren
id|foo
op_plus
id|l
comma
id|ioop-&gt;cdbPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opstr
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; - &bslash;&quot;%s&bslash;&quot;&quot;
comma
id|opstr
)paren
suffix:semicolon
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot;&bslash;n  SenseData[%02Xh]:&quot;
comma
l_int|8
op_plus
id|SD_Additional_Sense_Length
c_func
(paren
id|ioop-&gt;sensePtr
)paren
)paren
suffix:semicolon
id|l
op_add_assign
id|dump_sd
c_func
(paren
id|foo
op_plus
id|l
comma
id|ioop-&gt;sensePtr
)paren
suffix:semicolon
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot;&bslash;n  SenseKey=%Xh (%s); FRU=%02Xh&bslash;n  ASC/ASCQ=%02Xh/%02Xh&quot;
comma
id|sk
comma
id|skstr
comma
id|SD_FRU
c_func
(paren
id|ioop-&gt;sensePtr
)paren
comma
id|asc
comma
id|ascq
)paren
suffix:semicolon
(brace
r_const
r_char
op_star
id|x1
comma
op_star
id|x2
comma
op_star
id|x3
comma
op_star
id|x4
suffix:semicolon
id|x1
op_assign
id|x2
op_assign
id|x3
op_assign
id|x4
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|x1
op_assign
id|ascq_set_strings_4max
c_func
(paren
id|asc
comma
id|ascq
comma
op_amp
id|x1
comma
op_amp
id|x2
comma
op_amp
id|x3
comma
op_amp
id|x4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x1
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|x1
(braket
l_int|0
)braket
op_ne
l_char|&squot;(&squot;
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; &bslash;&quot;%s%s%s%s&bslash;&quot;&quot;
comma
id|x1
comma
id|x2
comma
id|x3
comma
id|x4
)paren
suffix:semicolon
r_else
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; %s%s%s%s&quot;
comma
id|x1
comma
id|x2
comma
id|x3
comma
id|x4
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|SPECIAL_ASCQ
c_func
(paren
id|asc
comma
id|ascq
)paren
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; (%02Xh)&quot;
comma
id|ascq
)paren
suffix:semicolon
macro_line|#endif
id|PrintF
c_func
(paren
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|foo
)paren
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_initTarget - Target, LUN alloc/free functionality.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@bus_id: Bus number (?)&n; *&t;@target_id: SCSI target id&n; *&t;@lun: SCSI LUN id&n; *&t;@data: Pointer to data&n; *&t;@dlen: Number of INQUIRY bytes&n; *&n; *&t;NOTE: It&squot;s only SAFE to call this routine if data points to&n; *&t;sane &amp; valid STANDARD INQUIRY data!&n; *&n; *&t;Allocate and initialize memory for this target.&n; *&t;Save inquiry data.&n; *&n; *&t;Returns pointer to VirtDevice structure.&n; */
r_static
id|VirtDevice
op_star
DECL|function|mptscsih_initTarget
id|mptscsih_initTarget
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|bus_id
comma
r_int
id|target_id
comma
id|u8
id|lun
comma
r_char
op_star
id|data
comma
r_int
id|dlen
)paren
(brace
id|VirtDevice
op_star
id|vdev
suffix:semicolon
r_int
id|sz
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;initTarget (%d,%d,%d) called, hd=%p&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|bus_id
comma
id|target_id
comma
id|lun
comma
id|hd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vdev
op_assign
id|hd-&gt;Targets
(braket
id|target_id
)braket
)paren
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|vdev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|VirtDevice
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;initTarget kmalloc(%d) FAILED!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
(paren
r_int
)paren
r_sizeof
(paren
id|VirtDevice
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|vdev
comma
l_int|0
comma
r_sizeof
(paren
id|VirtDevice
)paren
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|vdev-&gt;VdevLock
)paren
suffix:semicolon
id|Q_INIT
c_func
(paren
op_amp
id|vdev-&gt;WaitQ
comma
r_void
)paren
suffix:semicolon
id|Q_INIT
c_func
(paren
op_amp
id|vdev-&gt;SentQ
comma
r_void
)paren
suffix:semicolon
id|Q_INIT
c_func
(paren
op_amp
id|vdev-&gt;DoneQ
comma
r_void
)paren
suffix:semicolon
id|vdev-&gt;tflags
op_assign
l_int|0
suffix:semicolon
id|vdev-&gt;ioc_id
op_assign
id|hd-&gt;ioc-&gt;id
suffix:semicolon
id|vdev-&gt;target_id
op_assign
id|target_id
suffix:semicolon
id|vdev-&gt;bus_id
op_assign
id|bus_id
suffix:semicolon
id|hd-&gt;Targets
(braket
id|target_id
)braket
op_assign
id|vdev
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  *NEW* Target structure (id %d) @ %p&bslash;n&quot;
comma
id|target_id
comma
id|vdev
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|vdev
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_amp
(paren
l_int|1
op_lshift
id|target_id
)paren
)paren
id|vdev-&gt;raidVolume
op_assign
l_int|1
suffix:semicolon
r_else
id|vdev-&gt;raidVolume
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vdev
op_logical_and
id|data
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vdev-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_INQUIRY
)paren
)paren
(brace
multiline_comment|/* Copy the inquiry data  - if we haven&squot;t yet.&n;&t;&t;&t;*/
id|sz
op_assign
id|MIN
c_func
(paren
id|dlen
comma
id|SCSI_STD_INQUIRY_BYTES
)paren
suffix:semicolon
id|memcpy
(paren
id|vdev-&gt;inq_data
comma
id|data
comma
id|sz
)paren
suffix:semicolon
id|vdev-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_INQUIRY
suffix:semicolon
multiline_comment|/* Update the target capabilities&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dlen
OG
l_int|56
)paren
id|mptscsih_setTargetNegoParms
c_func
(paren
id|hd
comma
id|vdev
comma
id|data
(braket
l_int|56
)braket
)paren
suffix:semicolon
r_else
id|mptscsih_setTargetNegoParms
c_func
(paren
id|hd
comma
id|vdev
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Is LUN supported? If so, upper 3 bits will be 0&n;&t;&t; * in first byte of inquiry data.&n;&t;&t; */
r_if
c_cond
(paren
(paren
op_star
id|data
op_amp
l_int|0xe0
)paren
op_eq
l_int|0
)paren
id|vdev-&gt;luns
op_or_assign
(paren
l_int|1
op_lshift
id|lun
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  target = %p&bslash;n&quot;
comma
id|vdev
)paren
)paren
suffix:semicolon
r_return
id|vdev
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Update the target negotiation parameters based on the&n; *  the Inquiry data, adapter capabilities, and NVRAM settings.&n; *&n; */
DECL|function|mptscsih_setTargetNegoParms
r_void
id|mptscsih_setTargetNegoParms
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|VirtDevice
op_star
id|target
comma
r_char
id|byte56
)paren
(brace
id|ScsiCfgData
op_star
id|pspi_data
op_assign
op_amp
id|hd-&gt;ioc-&gt;spi_data
suffix:semicolon
r_int
id|id
op_assign
(paren
r_int
)paren
id|target-&gt;target_id
suffix:semicolon
r_int
id|nvram
suffix:semicolon
r_char
id|canQ
op_assign
l_int|0
suffix:semicolon
id|u8
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
id|u8
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|u8
id|offset
op_assign
l_int|0
suffix:semicolon
id|u8
id|version
comma
id|nfactor
suffix:semicolon
id|u8
id|noQas
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set flags based on Inquiry data&n;&t; */
r_if
c_cond
(paren
id|target-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_INQUIRY
)paren
(brace
id|version
op_assign
id|target-&gt;inq_data
(braket
l_int|2
)braket
op_amp
l_int|0x03
suffix:semicolon
r_if
c_cond
(paren
id|version
OL
l_int|2
)paren
(brace
id|width
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
id|offset
op_assign
id|pspi_data-&gt;maxSyncOffset
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|target-&gt;inq_data
(braket
l_int|7
)braket
op_amp
l_int|0x20
)paren
(brace
id|width
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|target-&gt;inq_data
(braket
l_int|7
)braket
op_amp
l_int|0x10
)paren
(brace
multiline_comment|/* bits 2 &amp; 3 show DT support&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|byte56
op_amp
l_int|0x04
)paren
op_eq
l_int|0
)paren
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
r_else
id|factor
op_assign
id|MPT_ULTRA320
suffix:semicolon
multiline_comment|/* bit 1 QAS support, non-raid only&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|target-&gt;raidVolume
op_eq
l_int|0
)paren
op_logical_and
(paren
id|byte56
op_amp
l_int|0x02
)paren
op_ne
l_int|0
)paren
id|noQas
op_assign
l_int|0
suffix:semicolon
id|offset
op_assign
id|pspi_data-&gt;maxSyncOffset
suffix:semicolon
)brace
r_else
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|target-&gt;inq_data
(braket
l_int|7
)braket
op_amp
l_int|0x02
)paren
(brace
id|canQ
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Update tflags based on NVRAM settings. (SCSI only)&n;&t;&t; */
r_if
c_cond
(paren
id|pspi_data-&gt;nvram
op_logical_and
(paren
id|pspi_data-&gt;nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
id|nvram
op_assign
id|pspi_data-&gt;nvram
(braket
id|id
)braket
suffix:semicolon
id|nfactor
op_assign
(paren
id|nvram
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|width
)paren
id|width
op_assign
id|nvram
op_amp
id|MPT_NVRAM_WIDE_DISABLE
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|offset
OG
l_int|0
)paren
(brace
multiline_comment|/* Ensure factor is set to the&n;&t;&t;&t;&t; * maximum of: adapter, nvram, inquiry&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|nfactor
)paren
(brace
r_if
c_cond
(paren
id|nfactor
OL
id|pspi_data-&gt;minSyncFactor
)paren
id|nfactor
op_assign
id|pspi_data-&gt;minSyncFactor
suffix:semicolon
id|factor
op_assign
id|MAX
(paren
id|factor
comma
id|nfactor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|factor
op_eq
id|MPT_ASYNC
)paren
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|offset
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
)brace
r_else
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
)brace
multiline_comment|/* Make sure data is consistent&n;&t;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|width
)paren
op_logical_and
(paren
id|factor
OL
id|MPT_ULTRA2
)paren
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
)brace
multiline_comment|/* Save the data to the target structure.&n;&t;&t; */
id|target-&gt;minSyncFactor
op_assign
id|factor
suffix:semicolon
id|target-&gt;maxOffset
op_assign
id|offset
suffix:semicolon
id|target-&gt;maxWidth
op_assign
id|width
suffix:semicolon
r_if
c_cond
(paren
id|canQ
)paren
(brace
id|target-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_Q_YES
suffix:semicolon
)brace
id|target-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_NEGO
suffix:semicolon
multiline_comment|/* Disable unused features.&n;&t;&t; */
id|target-&gt;negoFlags
op_assign
id|pspi_data-&gt;noQas
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|width
)paren
id|target-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|offset
)paren
id|target-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
r_if
c_cond
(paren
id|noQas
)paren
id|target-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
multiline_comment|/* GEM, processor WORKAROUND&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|target-&gt;inq_data
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
op_eq
l_int|0x03
)paren
op_logical_or
(paren
(paren
id|target-&gt;inq_data
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
OG
l_int|0x08
)paren
)paren
(brace
id|target-&gt;negoFlags
op_or_assign
(paren
id|MPT_TARGET_NO_NEGO_WIDE
op_or
id|MPT_TARGET_NO_NEGO_SYNC
)paren
suffix:semicolon
id|pspi_data-&gt;dvStatus
(braket
id|id
)braket
op_or_assign
id|MPT_SCSICFG_BLK_NEGO
suffix:semicolon
)brace
multiline_comment|/* Disable QAS if mixed configuration case&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|noQas
)paren
op_logical_and
(paren
op_logical_neg
id|pspi_data-&gt;noQas
)paren
op_logical_and
(paren
(paren
id|target-&gt;inq_data
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
op_eq
l_int|0x00
)paren
)paren
(brace
id|VirtDevice
op_star
id|vdev
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|pspi_data-&gt;noQas
op_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|id
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|vdev
op_assign
id|hd-&gt;Targets
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vdev
op_ne
l_int|NULL
)paren
id|vdev-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
)brace
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Clear sense valid flag.&n; */
DECL|function|clear_sense_flag
r_static
r_void
id|clear_sense_flag
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|SCSIIORequest_t
op_star
id|pReq
)paren
(brace
id|VirtDevice
op_star
id|target
suffix:semicolon
r_int
id|index
op_assign
(paren
r_int
)paren
id|pReq-&gt;TargetID
suffix:semicolon
r_if
c_cond
(paren
(paren
id|target
op_assign
id|hd-&gt;Targets
(braket
id|index
)braket
)paren
)paren
(brace
id|target-&gt;tflags
op_and_assign
op_complement
id|MPT_TARGET_FLAGS_VALID_SENSE
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* &n; * If DV disabled (negoNvram set to USE_NVARM) or if not LUN 0, return.&n; * Else set the NEED_DV flag after Read Capacity Issued (disks) &n; * or Mode Sense (cdroms). Tapes, key off of Inquiry command.&n; */
DECL|function|mptscsih_set_dvflags
r_static
r_void
id|mptscsih_set_dvflags
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|SCSIIORequest_t
op_star
id|pReq
comma
r_char
op_star
id|data
)paren
(brace
id|u8
id|cmd
op_assign
id|pReq-&gt;CDB
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pReq-&gt;LUN
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;negoNvram
op_ne
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|READ_CAPACITY
)paren
op_logical_or
(paren
id|cmd
op_eq
id|MODE_SENSE
)paren
op_logical_or
(paren
(paren
id|cmd
op_eq
id|INQUIRY
)paren
op_logical_and
(paren
(paren
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
op_eq
l_int|0x01
)paren
)paren
)paren
(brace
id|u8
id|dvStatus
op_assign
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|pReq-&gt;TargetID
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_DV_DONE
)paren
)paren
(brace
id|ScsiCfgData
op_star
id|pSpi
op_assign
op_amp
id|hd-&gt;ioc-&gt;spi_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSpi-&gt;isRaid
op_amp
(paren
l_int|1
op_lshift
id|pReq-&gt;TargetID
)paren
)paren
op_logical_and
id|pSpi-&gt;pIocPg3
)paren
(brace
multiline_comment|/* Set NEED_DV for all hidden disks&n;&t;&t;&t;&t; */
id|Ioc3PhysDisk_t
op_star
id|pPDisk
op_assign
id|pSpi-&gt;pIocPg3-&gt;PhysDisk
suffix:semicolon
r_int
id|numPDisk
op_assign
id|pSpi-&gt;pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
id|pSpi-&gt;dvStatus
(braket
id|pPDisk-&gt;PhysDiskID
)braket
op_or_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;NEED_DV set for phys disk id %d&bslash;n&quot;
comma
id|pPDisk-&gt;PhysDiskID
)paren
)paren
suffix:semicolon
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
)brace
id|pSpi-&gt;dvStatus
(braket
id|pReq-&gt;TargetID
)braket
op_or_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;NEED_DV set for visible disk id %d&bslash;n&quot;
comma
id|pReq-&gt;TargetID
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * If no Target, bus reset on 1st I/O. Set the flag to &n; * prevent any future negotiations to this device.&n; */
DECL|function|mptscsih_no_negotiate
r_static
r_void
id|mptscsih_no_negotiate
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|target_id
)paren
(brace
r_if
c_cond
(paren
(paren
id|hd-&gt;Targets
)paren
op_logical_and
(paren
id|hd-&gt;Targets
(braket
id|target_id
)braket
op_eq
l_int|NULL
)paren
)paren
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|target_id
)braket
op_or_assign
id|MPT_SCSICFG_BLK_NEGO
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  SCSI Config Page functionality ...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_setDevicePage1Flags  - add Requested and Configuration fields flags&n; *&t;based on width, factor and offset parameters.&n; *&t;@width: bus width&n; *&t;@factor: sync factor&n; *&t;@offset: sync offset&n; *&t;@requestedPtr: pointer to requested values (updated)&n; *&t;@configurationPtr: pointer to configuration values (updated)&n; *&t;@flags: flags to block WDTR or SDTR negotiation&n; *&n; *&t;Return: None.&n; *&n; *&t;Remark: Called by writeSDP1 and _dv_params&n; */
r_static
r_void
DECL|function|mptscsih_setDevicePage1Flags
id|mptscsih_setDevicePage1Flags
(paren
id|u8
id|width
comma
id|u8
id|factor
comma
id|u8
id|offset
comma
r_int
op_star
id|requestedPtr
comma
r_int
op_star
id|configurationPtr
comma
id|u8
id|flags
)paren
(brace
id|u8
id|nowide
op_assign
id|flags
op_amp
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
id|u8
id|nosync
op_assign
id|flags
op_amp
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
op_star
id|configurationPtr
op_assign
l_int|0
suffix:semicolon
op_star
id|requestedPtr
op_assign
id|width
ques
c_cond
id|MPI_SCSIDEVPAGE1_RP_WIDE
suffix:colon
l_int|0
suffix:semicolon
op_star
id|requestedPtr
op_or_assign
(paren
id|offset
op_lshift
l_int|16
)paren
op_or
(paren
id|factor
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|width
op_logical_and
id|offset
op_logical_and
op_logical_neg
id|nowide
op_logical_and
op_logical_neg
id|nosync
)paren
(brace
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA160
)paren
(brace
op_star
id|requestedPtr
op_or_assign
(paren
id|MPI_SCSIDEVPAGE1_RP_IU
op_plus
id|MPI_SCSIDEVPAGE1_RP_DT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|MPT_TARGET_NO_NEGO_QAS
)paren
op_eq
l_int|0
)paren
op_star
id|requestedPtr
op_or_assign
id|MPI_SCSIDEVPAGE1_RP_QAS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA2
)paren
(brace
op_star
id|requestedPtr
op_or_assign
id|MPI_SCSIDEVPAGE1_RP_DT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|nowide
)paren
op_star
id|configurationPtr
op_or_assign
id|MPI_SCSIDEVPAGE1_CONF_WDTR_DISALLOWED
suffix:semicolon
r_if
c_cond
(paren
id|nosync
)paren
op_star
id|configurationPtr
op_or_assign
id|MPI_SCSIDEVPAGE1_CONF_SDTR_DISALLOWED
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_writeSDP1  - write SCSI Device Page 1&n; *&t;@hd: Pointer to a SCSI Host Strucutre&n; *&t;@portnum: IOC port number&n; *&t;@target_id: writeSDP1 for single ID&n; *&t;@flags: MPT_SCSICFG_ALL_IDS, MPT_SCSICFG_USE_NVRAM, MPT_SCSICFG_BLK_NEGO&n; *&n; *&t;Return: -EFAULT if read of config page header fails&n; *&t;&t;or 0 if success.&n; *&n; *&t;Remark: If a target has been found, the settings from the&n; *&t;&t;target structure are used, else the device is set&n; *&t;&t;to async/narrow.&n; *&n; *&t;Remark: Called during init and after a FW reload.&n; *&t;Remark: We do not wait for a return, write pages sequentially.&n; */
r_static
r_int
DECL|function|mptscsih_writeSDP1
id|mptscsih_writeSDP1
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
comma
r_int
id|target_id
comma
r_int
id|flags
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|Config_t
op_star
id|pReq
op_assign
l_int|NULL
suffix:semicolon
id|SCSIDevicePage1_t
op_star
id|pData
op_assign
l_int|NULL
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
op_assign
l_int|NULL
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|dma_addr_t
id|dataDma
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
id|u32
id|frameOffset
suffix:semicolon
id|u32
id|requested
comma
id|configuration
comma
id|flagsLength
suffix:semicolon
r_int
id|ii
comma
id|nvram
suffix:semicolon
r_int
id|id
op_assign
l_int|0
comma
id|maxid
op_assign
l_int|0
suffix:semicolon
id|u8
id|width
suffix:semicolon
id|u8
id|factor
suffix:semicolon
id|u8
id|offset
suffix:semicolon
id|u8
id|bus
op_assign
l_int|0
suffix:semicolon
id|u8
id|negoFlags
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.sdp1length
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MPT_SCSICFG_ALL_IDS
)paren
(brace
id|id
op_assign
l_int|0
suffix:semicolon
id|maxid
op_assign
id|ioc-&gt;sh-&gt;max_id
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|id
op_assign
id|target_id
suffix:semicolon
id|maxid
op_assign
id|MIN
c_func
(paren
id|id
comma
id|ioc-&gt;sh-&gt;max_id
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|id
op_le
id|maxid
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|id
op_eq
id|ioc-&gt;pfacts
(braket
id|portnum
)braket
dot
id|PortSCSIID
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MPT_SCSICFG_USE_NVRAM
)paren
(brace
multiline_comment|/* Use NVRAM, adapter maximums and target settings.&n;&t;&t;&t; * Data over-riden by target structure information, if present&n;&t;&t;&t; */
id|width
op_assign
id|ioc-&gt;spi_data.maxBusWidth
suffix:semicolon
id|offset
op_assign
id|ioc-&gt;spi_data.maxSyncOffset
suffix:semicolon
id|factor
op_assign
id|ioc-&gt;spi_data.minSyncFactor
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.nvram
op_logical_and
(paren
id|ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
id|nvram
op_assign
id|ioc-&gt;spi_data.nvram
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|width
)paren
id|width
op_assign
id|nvram
op_amp
id|MPT_NVRAM_WIDE_DISABLE
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|offset
OG
l_int|0
)paren
(brace
id|factor
op_assign
(paren
id|nvram
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|factor
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Key for async */
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|ioc-&gt;spi_data.minSyncFactor
)paren
(brace
id|factor
op_assign
id|ioc-&gt;spi_data.minSyncFactor
suffix:semicolon
)brace
)brace
r_else
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
multiline_comment|/* Set the negotiation flags.&n;&t;&t;&t; */
id|negoFlags
op_assign
id|ioc-&gt;spi_data.noQas
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|width
)paren
id|negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|offset
)paren
id|negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
)brace
r_else
(brace
id|width
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|negoFlags
op_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
)brace
multiline_comment|/* If id is not a raid volume, get the updated&n;&t;&t; * transmission settings from the target structure.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;Targets
op_logical_and
(paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|id
)braket
)paren
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|width
op_assign
id|pTarget-&gt;maxWidth
suffix:semicolon
id|factor
op_assign
id|pTarget-&gt;minSyncFactor
suffix:semicolon
id|offset
op_assign
id|pTarget-&gt;maxOffset
suffix:semicolon
id|negoFlags
op_assign
id|pTarget-&gt;negoFlags
suffix:semicolon
id|pTarget
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|MPT_SCSICFG_BLK_NEGO
)paren
id|negoFlags
op_assign
id|MPT_TARGET_NO_NEGO_WIDE
op_or
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
multiline_comment|/* REMOVE - can this be removed without problems?????&n;&t;&t;else if (negoFlags == (MPT_TARGET_NO_NEGO_WIDE | MPT_TARGET_NO_NEGO_SYNC))&n;&t;&t;&t;continue;&n;&t;&t;*/
id|mptscsih_setDevicePage1Flags
c_func
(paren
id|width
comma
id|factor
comma
id|offset
comma
op_amp
id|requested
comma
op_amp
id|configuration
comma
id|negoFlags
)paren
suffix:semicolon
multiline_comment|/* Get a MF for this command.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;write SDP1: no msg frames!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Set the request and the data pointers.&n;&t;&t; * Request takes: 36 bytes (32 bit SGE)&n;&t;&t; * SCSI Device Page 1 requires 16 bytes&n;&t;&t; * 40 + 16 &lt;= size of SCSI IO Request = 56 bytes&n;&t;&t; * and MF size &gt;= 64 bytes.&n;&t;&t; * Place data at end of MF.&n;&t;&t; */
id|pReq
op_assign
(paren
id|Config_t
op_star
)paren
id|mf
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|frameOffset
op_assign
id|ioc-&gt;req_sz
op_minus
r_sizeof
(paren
id|SCSIDevicePage1_t
)paren
suffix:semicolon
id|pData
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|mf
op_plus
id|frameOffset
)paren
suffix:semicolon
id|dataDma
op_assign
id|ioc-&gt;req_frames_dma
op_plus
(paren
id|req_idx
op_star
id|ioc-&gt;req_sz
)paren
op_plus
id|frameOffset
suffix:semicolon
multiline_comment|/* Complete the request frame (same for all requests).&n;&t;&t; */
id|pReq-&gt;Action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|pReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Function
op_assign
id|MPI_FUNCTION_CONFIG
suffix:semicolon
id|pReq-&gt;Reserved1
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Reserved1
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Reserved1
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|pReq-&gt;Reserved2
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|pReq-&gt;Header.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp1version
suffix:semicolon
id|pReq-&gt;Header.PageLength
op_assign
id|ioc-&gt;spi_data.sdp1length
suffix:semicolon
id|pReq-&gt;Header.PageNumber
op_assign
l_int|1
suffix:semicolon
id|pReq-&gt;Header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
id|pReq-&gt;PageAddress
op_assign
id|cpu_to_le32
c_func
(paren
id|id
op_or
(paren
id|bus
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Add a SGE to the config request.&n;&t;&t; */
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_WRITE
op_or
id|ioc-&gt;spi_data.sdp1length
op_star
l_int|4
suffix:semicolon
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;PageBufferSGE
comma
id|flagsLength
comma
id|dataDma
)paren
suffix:semicolon
multiline_comment|/* Set up the common data portion&n;&t;&t; */
id|pData-&gt;Header.PageVersion
op_assign
id|pReq-&gt;Header.PageVersion
suffix:semicolon
id|pData-&gt;Header.PageLength
op_assign
id|pReq-&gt;Header.PageLength
suffix:semicolon
id|pData-&gt;Header.PageNumber
op_assign
id|pReq-&gt;Header.PageNumber
suffix:semicolon
id|pData-&gt;Header.PageType
op_assign
id|pReq-&gt;Header.PageType
suffix:semicolon
id|pData-&gt;RequestedParameters
op_assign
id|cpu_to_le32
c_func
(paren
id|requested
)paren
suffix:semicolon
id|pData-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pData-&gt;Configuration
op_assign
id|cpu_to_le32
c_func
(paren
id|configuration
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;write SDP1: id %d pgaddr 0x%x req 0x%x config 0x%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|id
comma
(paren
id|id
op_or
(paren
id|bus
op_lshift
l_int|8
)paren
)paren
comma
id|requested
comma
id|configuration
)paren
)paren
suffix:semicolon
id|mptscsih_put_msgframe
c_func
(paren
id|ScsiDoneCtx
comma
id|ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_taskmgmt_timeout - Call back for timeout on a&n; *&t;task management request.&n; *&t;@data: Pointer to MPT_SCSI_HOST recast as an unsigned long&n; *&n; */
DECL|function|mptscsih_taskmgmt_timeout
r_static
r_void
id|mptscsih_taskmgmt_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|data
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_taskmgmt_timeout: &quot;
l_string|&quot;TM request timed out!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Delete the timer that triggered this callback.&n;&t; * Remark: del_timer checks to make sure timer is active&n;&t; * before deleting.&n;&t; */
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
macro_line|#ifdef MPT_SCSI_USE_NEW_EH
multiline_comment|/* Set the error flag to 1 so that the function that started the&n;&t; * task management request knows it timed out.&n;&t; */
id|hd-&gt;tmState
op_assign
id|TM_STATE_ERROR
suffix:semicolon
macro_line|#endif
multiline_comment|/* Call the reset handler. Already had a TM request&n;&t; * timeout - so issue a diagnostic reset&n;&t; */
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot; Firmware Reload FAILED!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MPT_SCSI_USE_NEW_EH
r_else
(brace
multiline_comment|/* Because we have reset the IOC, no TM requests can be&n;&t;&t; * pending.  So let&squot;s make sure the tmPending flag is reset.&n;&t;&t; */
id|nehprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_taskmgmt_timeout&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Bus Scan and Domain Validation functionality ...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_scandv_complete - Scan and DV callback routine registered&n; *&t;to Fustion MPT (base) driver.&n; *&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to original MPT request frame&n; *&t;@mr: Pointer to MPT reply frame (NULL if TurboReply)&n; *&n; *&t;This routine is called from mpt.c::mpt_interrupt() at the completion&n; *&t;of any SCSI IO request.&n; *&t;This routine is registered with the Fusion MPT (base) driver at driver&n; *&t;load/init time via the mpt_register() API call.&n; *&n; *&t;Returns 1 indicating alloc&squot;d request frame ptr should be freed.&n; *&n; *&t;Remark: Sets a completion code and (possibly) saves sense data&n; *&t;in the IOC member localReply structure.&n; *&t;Used ONLY for bus scan, DV and other internal commands.&n; */
r_static
r_int
DECL|function|mptscsih_scandv_complete
id|mptscsih_scandv_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|mr
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pReq
suffix:semicolon
r_int
id|completionCode
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|mf
op_ge
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;ScanDvComplete, %s req frame ptr! (=%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
ques
c_cond
l_string|&quot;BAD&quot;
suffix:colon
l_string|&quot;NULL&quot;
comma
(paren
r_void
op_star
)paren
id|mf
)paren
suffix:semicolon
r_goto
id|wakeup
suffix:semicolon
)brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|pReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_ne
id|hd-&gt;cmdPtr
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;ScanDvComplete (mf=%p, cmdPtr=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
(paren
r_void
op_star
)paren
id|mf
comma
(paren
r_void
op_star
)paren
id|hd-&gt;cmdPtr
)paren
suffix:semicolon
)brace
id|hd-&gt;cmdPtr
op_assign
l_int|NULL
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;ScanDvComplete (mf=%p,mr=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|mf
comma
id|mr
)paren
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
id|hd-&gt;pLocal
op_assign
op_amp
id|hd-&gt;localReply
suffix:semicolon
multiline_comment|/* If target struct exists, clear sense valid flag.&n;&t; */
id|clear_sense_flag
c_func
(paren
id|hd
comma
id|pReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mr
op_eq
l_int|NULL
)paren
(brace
id|completionCode
op_assign
id|MPT_SCANDV_GOOD
suffix:semicolon
)brace
r_else
(brace
id|SCSIIOReply_t
op_star
id|pReply
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|pReply
op_assign
(paren
id|SCSIIOReply_t
op_star
)paren
id|mr
suffix:semicolon
id|status
op_assign
id|le16_to_cpu
c_func
(paren
id|pReply-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  IOCStatus=%04xh, SCSIState=%02xh, SCSIStatus=%02xh, IOCLogInfo=%08xh&bslash;n&quot;
comma
id|status
comma
id|pReply-&gt;SCSIState
comma
id|pReply-&gt;SCSIStatus
comma
id|le32_to_cpu
c_func
(paren
id|pReply-&gt;IOCLogInfo
)paren
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE
suffix:colon
multiline_comment|/* 0x0043 */
id|completionCode
op_assign
id|MPT_SCANDV_SELECTION_TIMEOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_IO_DATA_ERROR
suffix:colon
multiline_comment|/* 0x0046 */
r_case
id|MPI_IOCSTATUS_SCSI_TASK_TERMINATED
suffix:colon
multiline_comment|/* 0x0048 */
r_case
id|MPI_IOCSTATUS_SCSI_IOC_TERMINATED
suffix:colon
multiline_comment|/* 0x004B */
r_case
id|MPI_IOCSTATUS_SCSI_EXT_TERMINATED
suffix:colon
multiline_comment|/* 0x004C */
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
suffix:colon
multiline_comment|/* 0x0045 */
r_case
id|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
suffix:colon
multiline_comment|/* 0x0040 */
r_case
id|MPI_IOCSTATUS_SUCCESS
suffix:colon
multiline_comment|/* 0x0000 */
r_if
c_cond
(paren
id|pReply-&gt;Function
op_eq
id|MPI_FUNCTION_CONFIG
)paren
(brace
id|ConfigReply_t
op_star
id|pr
op_assign
(paren
id|ConfigReply_t
op_star
)paren
id|mr
suffix:semicolon
id|completionCode
op_assign
id|MPT_SCANDV_GOOD
suffix:semicolon
id|hd-&gt;pLocal-&gt;header.PageVersion
op_assign
id|pr-&gt;Header.PageVersion
suffix:semicolon
id|hd-&gt;pLocal-&gt;header.PageLength
op_assign
id|pr-&gt;Header.PageLength
suffix:semicolon
id|hd-&gt;pLocal-&gt;header.PageNumber
op_assign
id|pr-&gt;Header.PageNumber
suffix:semicolon
id|hd-&gt;pLocal-&gt;header.PageType
op_assign
id|pr-&gt;Header.PageType
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pReply-&gt;Function
op_eq
id|MPI_FUNCTION_RAID_ACTION
)paren
(brace
multiline_comment|/* If the RAID Volume request is successful,&n;&t;&t;&t;&t; * return GOOD, else indicate that&n;&t;&t;&t;&t; * some type of error occurred.&n;&t;&t;&t;&t; */
id|MpiRaidActionReply_t
op_star
id|pr
op_assign
(paren
id|MpiRaidActionReply_t
op_star
)paren
id|mr
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;ActionStatus
op_eq
id|MPI_RAID_ACTION_ASTATUS_SUCCESS
)paren
id|completionCode
op_assign
id|MPT_SCANDV_GOOD
suffix:semicolon
r_else
id|completionCode
op_assign
id|MPT_SCANDV_SOME_ERROR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
(brace
id|VirtDevice
op_star
id|target
suffix:semicolon
id|u8
op_star
id|sense_data
suffix:semicolon
r_int
id|sz
suffix:semicolon
multiline_comment|/* save sense data in global &amp; target structure&n;&t;&t;&t;&t; */
id|completionCode
op_assign
id|MPT_SCANDV_SENSE
suffix:semicolon
id|hd-&gt;pLocal-&gt;scsiStatus
op_assign
id|pReply-&gt;SCSIStatus
suffix:semicolon
id|sense_data
op_assign
(paren
(paren
id|u8
op_star
)paren
id|hd-&gt;ioc-&gt;sense_buf_pool
op_plus
(paren
id|req_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
id|sz
op_assign
id|MIN
(paren
id|pReq-&gt;SenseBufferLength
comma
id|SCSI_STD_SENSE_BYTES
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|hd-&gt;pLocal-&gt;sense
comma
id|sense_data
comma
id|sz
)paren
suffix:semicolon
id|target
op_assign
id|hd-&gt;Targets
(braket
id|pReq-&gt;TargetID
)braket
suffix:semicolon
r_if
c_cond
(paren
id|target
)paren
(brace
id|memcpy
c_func
(paren
id|target-&gt;sense
comma
id|sense_data
comma
id|sz
)paren
suffix:semicolon
id|target-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_SENSE
suffix:semicolon
)brace
id|ddvprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  Check Condition, sense ptr %p&bslash;n&quot;
comma
id|sense_data
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
(paren
id|MPI_SCSI_STATE_AUTOSENSE_FAILED
op_or
id|MPI_SCSI_STATE_NO_SCSI_STATUS
)paren
)paren
(brace
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
(brace
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If no error, this will be equivalent&n;&t;&t;&t;&t; * to MPT_SCANDV_GOOD&n;&t;&t;&t;&t; */
id|completionCode
op_assign
(paren
r_int
)paren
id|pReply-&gt;SCSIStatus
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR
suffix:colon
multiline_comment|/* 0x0047 */
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
r_else
id|completionCode
op_assign
id|MPT_SCANDV_SOME_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|completionCode
op_assign
id|MPT_SCANDV_SOME_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch(status) */
id|ddvprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  completionCode set to %08xh&bslash;n&quot;
comma
id|completionCode
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end of address reply case */
id|hd-&gt;pLocal-&gt;completion
op_assign
id|completionCode
suffix:semicolon
multiline_comment|/* MF and RF are freed in mpt_interrupt&n;&t; */
id|wakeup
suffix:colon
multiline_comment|/* Free Chain buffers (will never chain) in scan or dv */
singleline_comment|//mptscsih_freeChainBuffers(hd, req_idx);
multiline_comment|/*&n;&t; * Wake up the original calling thread&n;&t; */
id|scandv_wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|scandv_waitq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_timer_expired - Call back for timer process.&n; *&t;Used only for dv functionality.&n; *&t;@data: Pointer to MPT_SCSI_HOST recast as an unsigned long&n; *&n; */
DECL|function|mptscsih_timer_expired
r_static
r_void
id|mptscsih_timer_expired
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|data
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Timer Expired! Cmd %p&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|hd-&gt;cmdPtr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;cmdPtr
)paren
(brace
id|MPIHeader_t
op_star
id|cmd
op_assign
(paren
id|MPIHeader_t
op_star
)paren
id|hd-&gt;cmdPtr
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;Function
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
(brace
multiline_comment|/* Desire to issue a task management request here.&n;&t;&t;&t; * TM requests MUST be single threaded.&n;&t;&t;&t; * If old eh code and no TM current, issue request.&n;&t;&t;&t; * If new eh code, do nothing. Wait for OS cmd timeout&n;&t;&t;&t; *&t;for bus reset.&n;&t;&t;&t; */
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmPending
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|hd-&gt;tmPending
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_TMHandler
c_func
(paren
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;TM FAILED!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#else
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV Cmd Timeout: NoOp&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* Perform a FW reload */
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Firmware Reload FAILED!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* This should NEVER happen */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Null cmdPtr!!!!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* No more processing.&n;&t; * TM call will generate an interrupt for SCSI TM Management.&n;&t; * The FW will reply to all outstanding commands, callback will finish cleanup.&n;&t; * Hard reset clean-up will free all resources.&n;&t; */
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Timer Expired Complete!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifndef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_do_raid - Format and Issue a RAID volume request message.&n; *&t;@hd: Pointer to scsi host structure&n; *&t;@action: What do be done.&n; *&t;@id: Logical target id.&n; *&t;@bus: Target locations bus.&n; *&n; *&t;Returns: &lt; 0 on a fatal error&n; *&t;&t;0 on success&n; *&n; *&t;Remark: Wait to return until reply processed by the ISR.&n; */
r_static
r_int
DECL|function|mptscsih_do_raid
id|mptscsih_do_raid
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|action
comma
id|INTERNAL_CMD
op_star
id|io
)paren
(brace
id|MpiRaidActionRequest_t
op_star
id|pReq
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
id|in_isr
suffix:semicolon
id|in_isr
op_assign
id|in_interrupt
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_isr
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Internal raid request not allowed in ISR context!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* Get and Populate a free Frame&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiScanDvCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;_do_raid: no msg frames!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|pReq
op_assign
(paren
id|MpiRaidActionRequest_t
op_star
)paren
id|mf
suffix:semicolon
id|pReq-&gt;Action
op_assign
id|action
suffix:semicolon
id|pReq-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Function
op_assign
id|MPI_FUNCTION_RAID_ACTION
suffix:semicolon
id|pReq-&gt;VolumeID
op_assign
id|io-&gt;id
suffix:semicolon
id|pReq-&gt;VolumeBus
op_assign
id|io-&gt;bus
suffix:semicolon
id|pReq-&gt;PhysDiskNum
op_assign
id|io-&gt;physDiskNum
suffix:semicolon
id|pReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ActionDataWord
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserved for this action */
singleline_comment|//pReq-&gt;ActionDataSGE = 0;
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;ActionDataSGE
comma
id|MPT_SGE_FLAGS_SSIMPLE_READ
op_or
l_int|0
comma
(paren
id|dma_addr_t
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;RAID Volume action %x id %d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|action
comma
id|io-&gt;id
)paren
)paren
suffix:semicolon
id|hd-&gt;pLocal
op_assign
l_int|NULL
suffix:semicolon
id|hd-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|2
suffix:semicolon
multiline_comment|/* 2 second timeout */
id|scandv_wait_done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Save cmd pointer, for resource free if timeout or&n;&t; * FW reload occurs&n;&t; */
id|hd-&gt;cmdPtr
op_assign
id|mf
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|mptscsih_put_msgframe
c_func
(paren
id|ScsiScanDvCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|scandv_waitq
comma
id|scandv_wait_done
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|hd-&gt;pLocal-&gt;completion
op_ne
id|MPT_SCANDV_GOOD
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* ~MPTSCSIH_DISABLE_DOMAIN_VALIDATION */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_do_cmd - Do internal command.&n; *&t;@hd: MPT_SCSI_HOST pointer&n; *&t;@io: INTERNAL_CMD pointer.&n; *&n; *&t;Issue the specified internally generated command and do command&n; *&t;specific cleanup. For bus scan / DV only.&n; *&t;NOTES: If command is Inquiry and status is good,&n; *&t;initialize a target structure, save the data&n; *&n; *&t;Remark: Single threaded access only.&n; *&n; *&t;Return:&n; *&t;&t;&lt; 0 if an illegal command or no resources&n; *&n; *&t;&t;   0 if good&n; *&n; *&t;&t; &gt; 0 if command complete but some type of completion error.&n; */
r_static
r_int
DECL|function|mptscsih_do_cmd
id|mptscsih_do_cmd
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|INTERNAL_CMD
op_star
id|io
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pScsiReq
suffix:semicolon
id|SCSIIORequest_t
id|ReqCopy
suffix:semicolon
r_int
id|my_idx
comma
id|ii
comma
id|dir
suffix:semicolon
r_int
id|rc
comma
id|cmdTimeout
suffix:semicolon
r_int
id|in_isr
suffix:semicolon
r_char
id|cmdLen
suffix:semicolon
r_char
id|CDB
(braket
)braket
op_assign
initialization_block
suffix:semicolon
r_char
id|cmd
op_assign
id|io-&gt;cmd
suffix:semicolon
id|in_isr
op_assign
id|in_interrupt
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_isr
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Internal SCSI IO request not allowed in ISR context!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* Set command specific information&n;&t; */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CMD_Inquiry
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|CDB
(braket
l_int|4
)braket
op_assign
id|io-&gt;size
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_TestUnitReady
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_StartStopUnit
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|CDB
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*Spin up the disk */
id|cmdTimeout
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_ReadBuffer
suffix:colon
id|cmdLen
op_assign
l_int|10
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
id|CDB
(braket
l_int|1
)braket
op_assign
l_int|0x0A
suffix:semicolon
)brace
r_else
(brace
id|CDB
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
)brace
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_BUF_CAP
)paren
(brace
id|CDB
(braket
l_int|1
)braket
op_or_assign
l_int|0x01
suffix:semicolon
)brace
id|CDB
(braket
l_int|6
)braket
op_assign
(paren
id|io-&gt;size
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|CDB
(braket
l_int|7
)braket
op_assign
(paren
id|io-&gt;size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|CDB
(braket
l_int|8
)braket
op_assign
id|io-&gt;size
op_amp
l_int|0xFF
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_WriteBuffer
suffix:colon
id|cmdLen
op_assign
l_int|10
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
id|CDB
(braket
l_int|1
)braket
op_assign
l_int|0x0A
suffix:semicolon
)brace
r_else
(brace
id|CDB
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
)brace
id|CDB
(braket
l_int|6
)braket
op_assign
(paren
id|io-&gt;size
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|CDB
(braket
l_int|7
)braket
op_assign
(paren
id|io-&gt;size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|CDB
(braket
l_int|8
)braket
op_assign
id|io-&gt;size
op_amp
l_int|0xFF
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_Reserve6
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_Release6
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_SynchronizeCache
suffix:colon
id|cmdLen
op_assign
l_int|10
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
singleline_comment|//&t;&t;CDB[1] = 0x02;&t;/* set immediate bit */
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Error Case */
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Get and Populate a free Frame&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiScanDvCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;No msg frames!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Get the request index */
id|my_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|ADD_INDEX_LOG
c_func
(paren
id|my_idx
)paren
suffix:semicolon
multiline_comment|/* for debug */
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_PHYS_DISK
)paren
(brace
id|pScsiReq-&gt;TargetID
op_assign
id|io-&gt;physDiskNum
suffix:semicolon
id|pScsiReq-&gt;Bus
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Function
op_assign
id|MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH
suffix:semicolon
)brace
r_else
(brace
id|pScsiReq-&gt;TargetID
op_assign
id|io-&gt;id
suffix:semicolon
id|pScsiReq-&gt;Bus
op_assign
id|io-&gt;bus
suffix:semicolon
id|pScsiReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_IO_REQUEST
suffix:semicolon
)brace
id|pScsiReq-&gt;CDBLength
op_assign
id|cmdLen
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|MPT_SENSE_BUFFER_SIZE
suffix:semicolon
id|pScsiReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;MsgFlags
op_assign
id|mpt_msg_flags
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* MsgContext set in mpt_get_msg_fram call  */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiReq-&gt;LUN
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
op_assign
id|io-&gt;lun
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_TAGGED_CMD
)paren
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|dir
op_or
id|MPI_SCSIIO_CONTROL_SIMPLEQ
)paren
suffix:semicolon
r_else
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|dir
op_or
id|MPI_SCSIIO_CONTROL_UNTAGGED
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|16
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiReq-&gt;CDB
(braket
id|ii
)braket
op_assign
id|CDB
(braket
id|ii
)braket
suffix:semicolon
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|io-&gt;size
)paren
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|hd-&gt;ioc-&gt;sense_buf_low_dma
op_plus
(paren
id|my_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending Command 0x%x for (%d:%d:%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|cmd
comma
id|io-&gt;bus
comma
id|io-&gt;id
comma
id|io-&gt;lun
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_eq
id|MPI_SCSIIO_CONTROL_READ
)paren
(brace
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pScsiReq-&gt;SGL
comma
id|MPT_SGE_FLAGS_SSIMPLE_READ
op_or
id|io-&gt;size
comma
id|io-&gt;data_dma
)paren
suffix:semicolon
)brace
r_else
(brace
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pScsiReq-&gt;SGL
comma
id|MPT_SGE_FLAGS_SSIMPLE_WRITE
op_or
id|io-&gt;size
comma
id|io-&gt;data_dma
)paren
suffix:semicolon
)brace
multiline_comment|/* The ISR will free the request frame, but we need&n;&t; * the information to initialize the target. Duplicate.&n;&t; */
id|memcpy
c_func
(paren
op_amp
id|ReqCopy
comma
id|pScsiReq
comma
r_sizeof
(paren
id|SCSIIORequest_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Issue this command after:&n;&t; *&t;finish init&n;&t; *&t;add timer&n;&t; * Wait until the reply has been received&n;&t; *  ScsiScanDvCtx callback function will&n;&t; *&t;set hd-&gt;pLocal;&n;&t; *&t;set scandv_wait_done and call wake_up&n;&t; */
id|hd-&gt;pLocal
op_assign
l_int|NULL
suffix:semicolon
id|hd-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
id|cmdTimeout
suffix:semicolon
id|scandv_wait_done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Save cmd pointer, for resource free if timeout or&n;&t; * FW reload occurs&n;&t; */
id|hd-&gt;cmdPtr
op_assign
id|mf
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|mptscsih_put_msgframe
c_func
(paren
id|ScsiScanDvCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|scandv_waitq
comma
id|scandv_wait_done
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;pLocal
)paren
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
id|hd-&gt;pLocal-&gt;skip
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Always set fatal error codes in some cases.&n;&t;&t; */
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SELECTION_TIMEOUT
)paren
id|rc
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SOME_ERROR
)paren
id|rc
op_assign
op_minus
id|rc
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* This should never happen. */
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;_do_cmd: Null pLocal!!!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_synchronize_cache - Send SYNCHRONIZE_CACHE to all disks.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@portnum: IOC port number&n; *&n; *&t;Uses the ISR, but with special processing.&n; *&t;MUST be single-threaded.&n; *&n; *&t;Return: 0 on completion&n; */
r_static
r_int
DECL|function|mptscsih_synchronize_cache
id|mptscsih_synchronize_cache
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
op_assign
l_int|NULL
suffix:semicolon
id|SCSIDevicePage1_t
op_star
id|pcfg1Data
op_assign
l_int|NULL
suffix:semicolon
id|INTERNAL_CMD
id|iocmd
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|dma_addr_t
id|cfg1_dma_addr
op_assign
op_minus
l_int|1
suffix:semicolon
id|ConfigPageHeader_t
id|header1
suffix:semicolon
r_int
id|bus
op_assign
l_int|0
suffix:semicolon
r_int
id|id
op_assign
l_int|0
suffix:semicolon
r_int
id|lun
op_assign
l_int|0
suffix:semicolon
r_int
id|hostId
op_assign
id|ioc-&gt;pfacts
(braket
id|portnum
)braket
dot
id|PortSCSIID
suffix:semicolon
r_int
id|max_id
suffix:semicolon
r_int
id|requested
comma
id|configuration
comma
id|data
suffix:semicolon
r_int
id|doConfig
op_assign
l_int|0
suffix:semicolon
id|u8
id|flags
comma
id|factor
suffix:semicolon
id|max_id
op_assign
id|ioc-&gt;sh-&gt;max_id
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Following parameters will not change&n;&t; * in this routine.&n;&t; */
id|iocmd.cmd
op_assign
id|CMD_SynchronizeCache
suffix:semicolon
id|iocmd.flags
op_assign
l_int|0
suffix:semicolon
id|iocmd.physDiskNum
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
id|iocmd.rsvd
op_assign
id|iocmd.rsvd2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No SCSI hosts&n;&t; */
r_if
c_cond
(paren
id|hd-&gt;Targets
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Skip the host&n;&t; */
r_if
c_cond
(paren
id|id
op_eq
id|hostId
)paren
id|id
op_increment
suffix:semicolon
multiline_comment|/* Write SDP1 for all SCSI devices &n;&t; * Alloc memory and set up config buffer&n;&t; */
r_if
c_cond
(paren
id|hd-&gt;is_spi
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.sdp1length
OG
l_int|0
)paren
(brace
id|pcfg1Data
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|ioc-&gt;spi_data.sdp1length
op_star
l_int|4
comma
op_amp
id|cfg1_dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcfg1Data
op_ne
l_int|NULL
)paren
(brace
id|doConfig
op_assign
l_int|1
suffix:semicolon
id|header1.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp1version
suffix:semicolon
id|header1.PageLength
op_assign
id|ioc-&gt;spi_data.sdp1length
suffix:semicolon
id|header1.PageNumber
op_assign
l_int|1
suffix:semicolon
id|header1.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg1_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* loop through all devices on this port&n;&t; */
r_while
c_loop
(paren
id|bus
OL
id|MPT_MAX_BUS
)paren
(brace
id|iocmd.bus
op_assign
id|bus
suffix:semicolon
id|iocmd.id
op_assign
id|id
suffix:semicolon
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
(paren
r_int
)paren
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|doConfig
)paren
(brace
multiline_comment|/* Set the negotiation flags */
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|id
)braket
)paren
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|flags
op_assign
id|pTarget-&gt;negoFlags
suffix:semicolon
)brace
r_else
(brace
id|flags
op_assign
id|hd-&gt;ioc-&gt;spi_data.noQas
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
op_logical_and
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
id|data
op_assign
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|MPT_NVRAM_WIDE_DISABLE
)paren
id|flags
op_or_assign
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
id|factor
op_assign
(paren
id|data
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
id|MPT_NVRAM_SYNC_SHIFT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|factor
op_eq
l_int|0
)paren
op_logical_or
(paren
id|factor
op_eq
id|MPT_ASYNC
)paren
)paren
id|flags
op_or_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
)brace
)brace
multiline_comment|/* Force to async, narrow */
id|mptscsih_setDevicePage1Flags
c_func
(paren
l_int|0
comma
id|MPT_ASYNC
comma
l_int|0
comma
op_amp
id|requested
comma
op_amp
id|configuration
comma
id|flags
)paren
suffix:semicolon
id|pcfg1Data-&gt;RequestedParameters
op_assign
id|le32_to_cpu
c_func
(paren
id|requested
)paren
suffix:semicolon
id|pcfg1Data-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pcfg1Data-&gt;Configuration
op_assign
id|le32_to_cpu
c_func
(paren
id|configuration
)paren
suffix:semicolon
id|cfg.pageAddr
op_assign
(paren
id|bus
op_lshift
l_int|8
)paren
op_or
id|id
suffix:semicolon
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
suffix:semicolon
)brace
multiline_comment|/* If target Ptr NULL or if this target is NOT a disk, skip.&n;&t;&t; */
singleline_comment|//&t;if (pTarget &amp;&amp; ((pTarget-&gt;inq_data[0] &amp; 0x1F) == 0)) {
r_if
c_cond
(paren
id|pTarget
)paren
(brace
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
op_le
id|MPT_LAST_LUN
suffix:semicolon
id|lun
op_increment
)paren
(brace
multiline_comment|/* If LUN present, issue the command&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pTarget-&gt;luns
op_amp
(paren
l_int|1
op_lshift
id|lun
)paren
)paren
(brace
id|iocmd.lun
op_assign
id|lun
suffix:semicolon
(paren
r_void
)paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* get next relevant device */
id|id
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|hostId
)paren
id|id
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|id
OG
id|max_id
)paren
(brace
id|id
op_assign
l_int|0
suffix:semicolon
id|bus
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pcfg1Data
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|header1.PageLength
op_star
l_int|4
comma
id|pcfg1Data
comma
id|cfg1_dma_addr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MPTSCSIH_DISABLE_DOMAIN_VALIDATION
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_domainValidation - Top level handler for domain validation.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure.&n; *&n; *&t;Uses the ISR, but with special processing.&n; *&t;Called from schedule, should not be in interrupt mode.&n; *&t;While thread alive, do dv for all devices needing dv&n; *&n; *&t;Return: None.&n; */
r_static
r_void
DECL|function|mptscsih_domainValidation
id|mptscsih_domainValidation
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|id
comma
id|maxid
comma
id|dvStatus
comma
id|did
suffix:semicolon
r_int
id|ii
comma
id|isPhysDisk
suffix:semicolon
id|u8
id|oldQas
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|dvtaskQ_active
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dvtaskQ_release
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* For this ioc, loop through all devices and do dv to each device.&n;&t; * When complete with this ioc, search through the ioc list, and &n;&t; * for each scsi ioc found, do dv for all devices. Exit when no&n;&t; * device needs dv.&n;&t; */
id|did
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|did
)paren
(brace
id|did
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ioc
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
id|ioc
op_ne
l_int|NULL
suffix:semicolon
id|ioc
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|ioc
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvtaskQ_release
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* DV only to SCSI adapters */
r_if
c_cond
(paren
(paren
r_int
)paren
id|ioc-&gt;chip_type
op_le
(paren
r_int
)paren
id|FC929
)paren
r_continue
suffix:semicolon
multiline_comment|/* Make sure everything looks ok */
r_if
c_cond
(paren
id|ioc-&gt;sh
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|maxid
op_assign
id|MIN
(paren
id|ioc-&gt;sh-&gt;max_id
comma
id|MPT_MAX_SCSI_DEVICES
)paren
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|maxid
suffix:semicolon
id|id
op_increment
)paren
(brace
id|oldQas
op_assign
id|hd-&gt;ioc-&gt;spi_data.noQas
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvtaskQ_release
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|dvStatus
op_assign
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_NEED_DV
)paren
(brace
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_or_assign
id|MPT_SCSICFG_DV_PENDING
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* If hidden phys disk, block IO&squot;s to all&n;&t;&t;&t;&t;&t; *&t;raid volumes&n;&t;&t;&t;&t;&t; * else, process normally&n;&t;&t;&t;&t;&t; */
id|isPhysDisk
op_assign
id|mptscsih_is_phys_disk
c_func
(paren
id|ioc
comma
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isPhysDisk
)paren
(brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_amp
(paren
l_int|1
op_lshift
id|ii
)paren
)paren
(brace
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_or_assign
id|MPT_SCSICFG_DV_PENDING
suffix:semicolon
)brace
)brace
)brace
id|mptscsih_doDv
c_func
(paren
id|hd
comma
l_int|0
comma
id|id
)paren
suffix:semicolon
id|did
op_increment
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_or_assign
id|MPT_SCSICFG_DV_DONE
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_DV_PENDING
suffix:semicolon
r_if
c_cond
(paren
id|isPhysDisk
)paren
(brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_amp
(paren
l_int|1
op_lshift
id|ii
)paren
)paren
(brace
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_DV_PENDING
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Post OS IOs that were pended while&n;&t;&t;&t;&t;&t; * DV running.&n;&t;&t;&t;&t;&t; */
id|post_pendingQ_commands
c_func
(paren
id|hd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|oldQas
)paren
op_logical_and
(paren
id|hd-&gt;ioc-&gt;spi_data.noQas
)paren
)paren
id|mptscsih_qas_check
c_func
(paren
id|hd
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Search IOC page 3 to determine if this is hidden physical disk&n; */
DECL|function|mptscsih_is_phys_disk
r_static
r_int
id|mptscsih_is_phys_disk
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|id
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.pIocPg3
)paren
(brace
id|Ioc3PhysDisk_t
op_star
id|pPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;PhysDisk
suffix:semicolon
r_int
id|numPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
r_if
c_cond
(paren
id|pPDisk-&gt;PhysDiskID
op_eq
id|id
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Write SDP1 if no QAS has been enabled&n; */
DECL|function|mptscsih_qas_check
r_static
r_void
id|mptscsih_qas_check
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
id|VirtDevice
op_star
id|pTarget
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|change
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;Targets
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|change
op_assign
l_int|0
suffix:semicolon
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|ii
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pTarget
op_ne
l_int|NULL
)paren
op_logical_and
(paren
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pTarget-&gt;negoFlags
op_amp
id|hd-&gt;ioc-&gt;spi_data.noQas
)paren
op_eq
l_int|0
)paren
(brace
id|change
op_assign
l_int|1
suffix:semicolon
id|pTarget-&gt;negoFlags
op_or_assign
id|hd-&gt;ioc-&gt;spi_data.noQas
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|mptscsih_is_phys_disk
c_func
(paren
id|hd-&gt;ioc
comma
id|ii
)paren
op_eq
l_int|1
)paren
id|change
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|change
)paren
op_logical_and
(paren
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_amp
id|MPT_SCSICFG_DV_DONE
)paren
)paren
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
id|ii
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|macro|MPT_GET_NVRAM_VALS
mdefine_line|#define MPT_GET_NVRAM_VALS&t;0x01
DECL|macro|MPT_UPDATE_MAX
mdefine_line|#define MPT_UPDATE_MAX&t;&t;0x02
DECL|macro|MPT_SET_MAX
mdefine_line|#define MPT_SET_MAX&t;&t;0x04
DECL|macro|MPT_SET_MIN
mdefine_line|#define MPT_SET_MIN&t;&t;0x08
DECL|macro|MPT_FALLBACK
mdefine_line|#define MPT_FALLBACK&t;&t;0x10
DECL|macro|MPT_SAVE
mdefine_line|#define MPT_SAVE&t;&t;0x20
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_doDv - Perform domain validation to a target.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure.&n; *&t;@portnum: IOC port number.&n; *&t;@target: Physical ID of this target&n; *&n; *&t;Uses the ISR, but with special processing.&n; *&t;MUST be single-threaded.&n; *&t;Test will exit if target is at async &amp; narrow.&n; *&n; *&t;Return: None.&n; */
r_static
r_void
DECL|function|mptscsih_doDv
id|mptscsih_doDv
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
comma
r_int
id|id
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
op_assign
l_int|NULL
suffix:semicolon
id|SCSIDevicePage1_t
op_star
id|pcfg1Data
op_assign
l_int|NULL
suffix:semicolon
id|SCSIDevicePage0_t
op_star
id|pcfg0Data
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
id|pbuf1
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
id|pbuf2
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
id|pDvBuf
op_assign
l_int|NULL
suffix:semicolon
id|dma_addr_t
id|dvbuf_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_addr_t
id|buf1_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_addr_t
id|buf2_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_addr_t
id|cfg1_dma_addr
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_addr_t
id|cfg0_dma_addr
op_assign
op_minus
l_int|1
suffix:semicolon
id|ConfigPageHeader_t
id|header1
suffix:semicolon
id|ConfigPageHeader_t
id|header0
suffix:semicolon
id|DVPARAMETERS
id|dv
suffix:semicolon
id|INTERNAL_CMD
id|iocmd
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
r_int
id|dv_alloc
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
comma
id|sz
op_assign
l_int|0
suffix:semicolon
r_int
id|bufsize
op_assign
l_int|0
suffix:semicolon
r_int
id|dataBufSize
op_assign
l_int|0
suffix:semicolon
r_int
id|echoBufSize
op_assign
l_int|0
suffix:semicolon
r_int
id|notDone
suffix:semicolon
r_int
id|patt
suffix:semicolon
r_int
id|repeat
suffix:semicolon
r_char
id|firstPass
op_assign
l_int|1
suffix:semicolon
r_char
id|doFallback
op_assign
l_int|0
suffix:semicolon
r_char
id|readPage0
suffix:semicolon
r_char
id|bus
comma
id|lun
suffix:semicolon
r_char
id|inq0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.sdp1length
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.sdp0length
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|ioc-&gt;pfacts
(braket
id|portnum
)braket
dot
id|PortSCSIID
)paren
r_return
suffix:semicolon
id|lun
op_assign
l_int|0
suffix:semicolon
id|bus
op_assign
l_int|0
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV started: numIOs %d bus=%d, id %d dv @ %p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
comma
id|bus
comma
id|id
comma
op_amp
id|dv
)paren
)paren
suffix:semicolon
multiline_comment|/* Prep DV structure&n;&t; */
id|memset
(paren
op_amp
id|dv
comma
l_int|0
comma
r_sizeof
(paren
id|DVPARAMETERS
)paren
)paren
suffix:semicolon
id|dv.id
op_assign
id|id
suffix:semicolon
multiline_comment|/* Populate tmax with the current maximum&n;&t; * transfer parameters for this target.&n;&t; * Exit if narrow and async.&n;&t; */
id|dv.cmd
op_assign
id|MPT_GET_NVRAM_VALS
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.max.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.max.offset
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Prep SCSI IO structure&n;&t; */
id|iocmd.id
op_assign
id|id
suffix:semicolon
id|iocmd.bus
op_assign
id|bus
suffix:semicolon
id|iocmd.lun
op_assign
id|lun
suffix:semicolon
id|iocmd.flags
op_assign
l_int|0
suffix:semicolon
id|iocmd.physDiskNum
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.rsvd
op_assign
id|iocmd.rsvd2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Use tagged commands if possible.&n;&t; */
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
)paren
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_TAGGED_CMD
suffix:semicolon
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_INQUIRY
)paren
)paren
(brace
multiline_comment|/* Another GEM workaround. Check peripheral device type,&n;&t;&t; * if PROCESSOR, quit DV.&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|pTarget-&gt;inq_data
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
op_eq
l_int|0x03
)paren
op_logical_or
(paren
(paren
id|pTarget-&gt;inq_data
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
OG
l_int|0x08
)paren
)paren
(brace
id|pTarget-&gt;negoFlags
op_or_assign
(paren
id|MPT_TARGET_NO_NEGO_WIDE
op_or
id|MPT_TARGET_NO_NEGO_SYNC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Prep cfg structure&n;&t; */
id|cfg.pageAddr
op_assign
(paren
id|bus
op_lshift
l_int|8
)paren
op_or
id|id
suffix:semicolon
id|cfg.hdr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Prep SDP0 header&n;&t; */
id|header0.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp0version
suffix:semicolon
id|header0.PageLength
op_assign
id|ioc-&gt;spi_data.sdp0length
suffix:semicolon
id|header0.PageNumber
op_assign
l_int|0
suffix:semicolon
id|header0.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
multiline_comment|/* Prep SDP1 header&n;&t; */
id|header1.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp1version
suffix:semicolon
id|header1.PageLength
op_assign
id|ioc-&gt;spi_data.sdp1length
suffix:semicolon
id|header1.PageNumber
op_assign
l_int|1
suffix:semicolon
id|header1.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
r_if
c_cond
(paren
id|header0.PageLength
op_amp
l_int|1
)paren
id|dv_alloc
op_assign
(paren
id|header0.PageLength
op_star
l_int|4
)paren
op_plus
l_int|4
suffix:semicolon
id|dv_alloc
op_add_assign
(paren
l_int|2048
op_plus
(paren
id|header1.PageLength
op_star
l_int|4
)paren
)paren
suffix:semicolon
id|pDvBuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dv_alloc
comma
op_amp
id|dvbuf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDvBuf
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|sz
op_assign
l_int|0
suffix:semicolon
id|pbuf1
op_assign
(paren
id|u8
op_star
)paren
id|pDvBuf
suffix:semicolon
id|buf1_dma
op_assign
id|dvbuf_dma
suffix:semicolon
id|sz
op_add_assign
l_int|1024
suffix:semicolon
id|pbuf2
op_assign
(paren
id|u8
op_star
)paren
(paren
id|pDvBuf
op_plus
id|sz
)paren
suffix:semicolon
id|buf2_dma
op_assign
id|dvbuf_dma
op_plus
id|sz
suffix:semicolon
id|sz
op_add_assign
l_int|1024
suffix:semicolon
id|pcfg0Data
op_assign
(paren
id|SCSIDevicePage0_t
op_star
)paren
(paren
id|pDvBuf
op_plus
id|sz
)paren
suffix:semicolon
id|cfg0_dma_addr
op_assign
id|dvbuf_dma
op_plus
id|sz
suffix:semicolon
id|sz
op_add_assign
id|header0.PageLength
op_star
l_int|4
suffix:semicolon
multiline_comment|/* 8-byte alignment&n;&t; */
r_if
c_cond
(paren
id|header0.PageLength
op_amp
l_int|1
)paren
id|sz
op_add_assign
l_int|4
suffix:semicolon
id|pcfg1Data
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
(paren
id|pDvBuf
op_plus
id|sz
)paren
suffix:semicolon
id|cfg1_dma_addr
op_assign
id|dvbuf_dma
op_plus
id|sz
suffix:semicolon
multiline_comment|/* Skip this ID? Set cfg.hdr to force config page write&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_amp
id|MPT_NVRAM_ID_SCAN_ENABLE
)paren
)paren
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV Skipped: bus, id, lun (%d, %d, %d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|bus
comma
id|id
comma
id|lun
)paren
)paren
suffix:semicolon
id|dv.cmd
op_assign
id|MPT_SET_MAX
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
multiline_comment|/* Finish iocmd inititialization - hidden or visible disk? */
r_if
c_cond
(paren
id|ioc-&gt;spi_data.pIocPg3
)paren
(brace
multiline_comment|/* Searc IOC page 3 for matching id&n;&t;&t; */
id|Ioc3PhysDisk_t
op_star
id|pPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;PhysDisk
suffix:semicolon
r_int
id|numPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
r_if
c_cond
(paren
id|pPDisk-&gt;PhysDiskID
op_eq
id|id
)paren
(brace
multiline_comment|/* match */
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_PHYS_DISK
suffix:semicolon
id|iocmd.physDiskNum
op_assign
id|pPDisk-&gt;PhysDiskNum
suffix:semicolon
multiline_comment|/* Quiesce the IM&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|mptscsih_do_raid
c_func
(paren
id|hd
comma
id|MPI_RAID_ACTION_QUIESCE_PHYS_IO
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;RAID Queisce FAILED!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/* RAID Volume ID&squot;s may double for a physical device. If RAID but&n;&t; * not a physical ID as well, skip DV.&n;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_amp
(paren
l_int|1
op_lshift
id|id
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_PHYS_DISK
)paren
)paren
r_goto
id|target_done
suffix:semicolon
multiline_comment|/* Basic Test.&n;&t; * Async &amp; Narrow - Inquiry&n;&t; * Async &amp; Narrow - Inquiry&n;&t; * Maximum transfer rate - Inquiry&n;&t; * Compare buffers:&n;&t; *&t;If compare, test complete.&n;&t; *&t;If miscompare and first pass, repeat&n;&t; *&t;If miscompare and not first pass, fall back and repeat&n;&t; */
id|hd-&gt;pLocal
op_assign
l_int|NULL
suffix:semicolon
id|readPage0
op_assign
l_int|0
suffix:semicolon
id|sz
op_assign
id|SCSI_STD_INQUIRY_BYTES
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV: Start Basic test.&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|dv.cmd
op_assign
id|MPT_SET_MIN
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg1_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
id|iocmd.cmd
op_assign
id|CMD_Inquiry
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf1_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf1
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
multiline_comment|/* Another GEM workaround. Check peripheral device type,&n;&t;&t; * if PROCESSOR, quit DV.&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|pbuf1
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
op_eq
l_int|0x03
)paren
op_logical_or
(paren
(paren
id|pbuf1
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
OG
l_int|0x08
)paren
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|doFallback
)paren
id|dv.cmd
op_assign
id|MPT_FALLBACK
suffix:semicolon
r_else
id|dv.cmd
op_assign
id|MPT_SET_MAX
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.now.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.now.offset
)paren
)paren
r_goto
id|target_done
suffix:semicolon
id|iocmd.cmd
op_assign
id|CMD_Inquiry
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf2_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf2
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
multiline_comment|/* Save the return code.&n;&t;&t;&t; * If this is the first pass,&n;&t;&t;&t; * read SCSI Device Page 0&n;&t;&t;&t; * and update the target max parameters.&n;&t;&t;&t; */
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
id|doFallback
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|readPage0
)paren
(brace
id|u32
id|sdp0_info
suffix:semicolon
id|u32
id|sdp0_nego
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header0
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg0_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
id|sdp0_info
op_assign
id|le32_to_cpu
c_func
(paren
id|pcfg0Data-&gt;Information
)paren
op_amp
l_int|0x0E
suffix:semicolon
id|sdp0_nego
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|pcfg0Data-&gt;NegotiatedParameters
)paren
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
suffix:semicolon
multiline_comment|/* Quantum and Fujitsu workarounds.&n;&t;&t;&t;&t;&t; * Quantum: PPR U320 -&gt; PPR reply with Ultra2 and wide&n;&t;&t;&t;&t;&t; * Fujitsu: PPR U320 -&gt; Msg Reject and Ultra2 and wide&n;&t;&t;&t;&t;&t; * Resetart with a request for U160.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|dv.now.factor
op_eq
id|MPT_ULTRA320
)paren
op_logical_and
(paren
id|sdp0_nego
op_eq
id|MPT_ULTRA2
)paren
)paren
(brace
id|doFallback
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|dv.cmd
op_assign
id|MPT_UPDATE_MAX
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg0Data
)paren
suffix:semicolon
multiline_comment|/* Update the SCSI device page 1 area&n;&t;&t;&t;&t;&t;&t; */
id|pcfg1Data-&gt;RequestedParameters
op_assign
id|pcfg0Data-&gt;NegotiatedParameters
suffix:semicolon
id|readPage0
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Quantum workaround. Restart this test will the fallback&n;&t;&t;&t;&t; * flag set.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|doFallback
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|pbuf1
comma
id|pbuf2
comma
id|sz
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|firstPass
)paren
id|doFallback
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
multiline_comment|/* test complete */
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_eq
id|MPT_SCANDV_DID_RESET
)paren
op_logical_or
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
)paren
id|doFallback
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set fallback flag */
r_else
r_goto
id|target_done
suffix:semicolon
id|firstPass
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV: Basic test completed OK.&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|inq0
op_assign
(paren
op_star
id|pbuf1
)paren
op_amp
l_int|0x1F
suffix:semicolon
multiline_comment|/* Continue only for disks&n;&t; */
r_if
c_cond
(paren
id|inq0
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
multiline_comment|/* Start the Enhanced Test.&n;&t; * 0) issue TUR to clear out check conditions&n;&t; * 1) read capacity of echo (regular) buffer&n;&t; * 2) reserve device&n;&t; * 3) do write-read-compare data pattern test&n;&t; * 4) release&n;&t; * 5) update nego parms to target struct&n;&t; */
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg1_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
id|iocmd.cmd
op_assign
id|CMD_TestUnitReady
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
id|notDone
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|notDone
)paren
(brace
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
id|notDone
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|u8
id|asc
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
suffix:semicolon
id|u8
id|ascq
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|skey
comma
id|asc
comma
id|ascq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skey
op_eq
id|SK_UNIT_ATTENTION
)paren
id|notDone
op_increment
suffix:semicolon
multiline_comment|/* repeat */
r_else
r_if
c_cond
(paren
(paren
id|skey
op_eq
id|SK_NOT_READY
)paren
op_logical_and
(paren
id|asc
op_eq
l_int|0x04
)paren
op_logical_and
(paren
id|ascq
op_eq
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* wait then repeat */
id|mdelay
(paren
l_int|2000
)paren
suffix:semicolon
id|notDone
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|skey
op_eq
id|SK_NOT_READY
)paren
op_logical_and
(paren
id|asc
op_eq
l_int|0x3A
)paren
)paren
(brace
multiline_comment|/* no medium, try read test anyway */
id|notDone
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* All other errors are fatal.&n;&t;&t;&t;&t; */
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: fatal error.&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
r_else
r_goto
id|target_done
suffix:semicolon
)brace
id|iocmd.cmd
op_assign
id|CMD_ReadBuffer
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf1_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf1
suffix:semicolon
id|iocmd.size
op_assign
l_int|4
suffix:semicolon
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_BUF_CAP
suffix:semicolon
id|dataBufSize
op_assign
l_int|0
suffix:semicolon
id|echoBufSize
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|patt
op_assign
l_int|0
suffix:semicolon
id|patt
OL
l_int|2
suffix:semicolon
id|patt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|patt
op_eq
l_int|0
)paren
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_ECHO
suffix:semicolon
r_else
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_ECHO
suffix:semicolon
id|notDone
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|notDone
)paren
(brace
id|bufsize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If not ready after 8 trials,&n;&t;&t;&t; * give up on this device.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|notDone
OG
l_int|8
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;ReadBuffer Comp Code %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;  buff: %0x %0x %0x %0x&bslash;n&quot;
comma
id|pbuf1
(braket
l_int|0
)braket
comma
id|pbuf1
(braket
l_int|1
)braket
comma
id|pbuf1
(braket
l_int|2
)braket
comma
id|pbuf1
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
id|notDone
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
id|bufsize
op_assign
(paren
(paren
id|pbuf1
(braket
l_int|2
)braket
op_amp
l_int|0x1F
)paren
op_lshift
l_int|8
)paren
op_or
id|pbuf1
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
id|bufsize
op_assign
id|pbuf1
(braket
l_int|1
)braket
op_lshift
l_int|16
op_or
id|pbuf1
(braket
l_int|2
)braket
op_lshift
l_int|8
op_or
id|pbuf1
(braket
l_int|3
)braket
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|u8
id|asc
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
suffix:semicolon
id|u8
id|ascq
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|skey
comma
id|asc
comma
id|ascq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skey
op_eq
id|SK_ILLEGAL_REQUEST
)paren
(brace
id|notDone
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skey
op_eq
id|SK_UNIT_ATTENTION
)paren
(brace
id|notDone
op_increment
suffix:semicolon
multiline_comment|/* repeat */
)brace
r_else
r_if
c_cond
(paren
(paren
id|skey
op_eq
id|SK_NOT_READY
)paren
op_logical_and
(paren
id|asc
op_eq
l_int|0x04
)paren
op_logical_and
(paren
id|ascq
op_eq
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* wait then repeat */
id|mdelay
(paren
l_int|2000
)paren
suffix:semicolon
id|notDone
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* All other errors are fatal.&n;&t;&t;&t;&t;&t;&t; */
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: fatal error.&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* All other errors are fatal&n;&t;&t;&t;&t;&t; */
r_goto
id|target_done
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
id|echoBufSize
op_assign
id|bufsize
suffix:semicolon
r_else
id|dataBufSize
op_assign
id|bufsize
suffix:semicolon
)brace
id|sz
op_assign
l_int|0
suffix:semicolon
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_BUF_CAP
suffix:semicolon
multiline_comment|/* Use echo buffers if possible,&n;&t; * Exit if both buffers are 0.&n;&t; */
r_if
c_cond
(paren
id|echoBufSize
OG
l_int|0
)paren
(brace
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_ECHO
suffix:semicolon
r_if
c_cond
(paren
id|dataBufSize
OG
l_int|0
)paren
id|bufsize
op_assign
id|MIN
c_func
(paren
id|echoBufSize
comma
id|dataBufSize
)paren
suffix:semicolon
r_else
id|bufsize
op_assign
id|echoBufSize
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dataBufSize
op_eq
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;%s Buffer Capacity %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
ques
c_cond
l_string|&quot;Echo&quot;
suffix:colon
l_string|&quot; &quot;
comma
id|bufsize
)paren
)paren
suffix:semicolon
multiline_comment|/* Data buffers for write-read-compare test max 1K.&n;&t; */
id|sz
op_assign
id|MIN
c_func
(paren
id|bufsize
comma
l_int|1024
)paren
suffix:semicolon
multiline_comment|/* --- loop ----&n;&t; * On first pass, always issue a reserve.&n;&t; * On additional loops, only if a reset has occurred.&n;&t; * iocmd.flags indicates if echo or regular buffer&n;&t; */
r_for
c_loop
(paren
id|patt
op_assign
l_int|0
suffix:semicolon
id|patt
OL
l_int|4
suffix:semicolon
id|patt
op_increment
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;Pattern %d&bslash;n&quot;
comma
id|patt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_RESERVED
)paren
op_logical_and
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_DID_RESET
)paren
)paren
(brace
id|iocmd.cmd
op_assign
id|CMD_TestUnitReady
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
id|iocmd.cmd
op_assign
id|CMD_Release6
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;Release rc %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_RESERVED
suffix:semicolon
r_else
r_goto
id|target_done
suffix:semicolon
)brace
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_RESERVED
suffix:semicolon
)brace
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_DID_RESET
suffix:semicolon
id|repeat
op_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|repeat
op_logical_and
(paren
op_logical_neg
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_RESERVED
)paren
)paren
)paren
(brace
id|iocmd.cmd
op_assign
id|CMD_Reserve6
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_RESERVED
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
multiline_comment|/* Wait if coming ready&n;&t;&t;&t;&t;&t; */
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|u8
id|asc
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
suffix:semicolon
id|u8
id|ascq
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Reserve Failed: &quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|skey
comma
id|asc
comma
id|ascq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skey
op_eq
id|SK_NOT_READY
)paren
op_logical_and
(paren
id|asc
op_eq
l_int|0x04
)paren
op_logical_and
(paren
id|ascq
op_eq
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* wait then repeat */
id|mdelay
(paren
l_int|2000
)paren
suffix:semicolon
id|notDone
op_increment
suffix:semicolon
)brace
r_else
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Reserved Failed.&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
r_else
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Reserved Failed.&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
)brace
id|mptscsih_fillbuf
c_func
(paren
id|pbuf1
comma
id|sz
comma
id|patt
comma
l_int|1
)paren
suffix:semicolon
id|iocmd.cmd
op_assign
id|CMD_WriteBuffer
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf1_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf1
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
suffix:semicolon
multiline_comment|/* Issue read buffer */
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_DID_RESET
)paren
(brace
multiline_comment|/* If using echo buffers, reset to data buffers.&n;&t;&t;&t;&t; * Else do Fallback and restart&n;&t;&t;&t;&t; * this test (re-issue reserve&n;&t;&t;&t;&t; * because of bus reset).&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
op_logical_and
(paren
id|dataBufSize
op_ge
id|bufsize
)paren
)paren
(brace
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_ECHO
suffix:semicolon
)brace
r_else
(brace
id|dv.cmd
op_assign
id|MPT_FALLBACK
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.now.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.now.offset
)paren
)paren
r_goto
id|target_done
suffix:semicolon
)brace
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_DID_RESET
suffix:semicolon
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
multiline_comment|/* Restart data test if UA, else quit.&n;&t;&t;&t;&t; */
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|skey
comma
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
comma
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skey
op_eq
id|SK_UNIT_ATTENTION
)paren
(brace
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skey
op_eq
id|SK_ILLEGAL_REQUEST
)paren
(brace
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
r_if
c_cond
(paren
id|dataBufSize
op_ge
id|bufsize
)paren
(brace
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_ECHO
suffix:semicolon
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_goto
id|target_done
suffix:semicolon
)brace
r_else
r_goto
id|target_done
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fatal error */
r_goto
id|target_done
suffix:semicolon
)brace
)brace
id|iocmd.cmd
op_assign
id|CMD_ReadBuffer
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf2_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf2
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
multiline_comment|/* If buffers compare,&n;&t;&t;&t;&t;  * go to next pattern,&n;&t;&t;&t;&t;  * else, do a fallback and restart&n;&t;&t;&t;&t;  * data transfer test.&n;&t;&t;&t;&t;  */
r_if
c_cond
(paren
id|memcmp
(paren
id|pbuf1
comma
id|pbuf2
comma
id|sz
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
multiline_comment|/* goto next pattern */
)brace
r_else
(brace
multiline_comment|/* Miscompare with Echo buffer, go to data buffer,&n;&t;&t;&t;&t;&t; * if that buffer exists.&n;&t;&t;&t;&t;&t; * Miscompare with Data buffer, check first 4 bytes,&n;&t;&t;&t;&t;&t; * some devices return capacity. Exit in this case.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
r_if
c_cond
(paren
id|dataBufSize
op_ge
id|bufsize
)paren
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_ECHO
suffix:semicolon
r_else
r_goto
id|target_done
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dataBufSize
op_eq
(paren
id|pbuf2
(braket
l_int|1
)braket
op_lshift
l_int|16
op_or
id|pbuf2
(braket
l_int|2
)braket
op_lshift
l_int|8
op_or
id|pbuf2
(braket
l_int|3
)braket
)paren
)paren
(brace
multiline_comment|/* Argh. Device returning wrong data.&n;&t;&t;&t;&t;&t;&t;&t; * Quit DV for this device.&n;&t;&t;&t;&t;&t;&t;&t; */
r_goto
id|target_done
suffix:semicolon
)brace
multiline_comment|/* Had an actual miscompare. Slow down.*/
id|dv.cmd
op_assign
id|MPT_FALLBACK
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.now.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.now.offset
)paren
)paren
r_goto
id|target_done
suffix:semicolon
)brace
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_DID_RESET
)paren
(brace
multiline_comment|/* Do Fallback and restart&n;&t;&t;&t;&t; * this test (re-issue reserve&n;&t;&t;&t;&t; * because of bus reset).&n;&t;&t;&t;&t; */
id|dv.cmd
op_assign
id|MPT_FALLBACK
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.now.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.now.offset
)paren
)paren
r_goto
id|target_done
suffix:semicolon
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_DID_RESET
suffix:semicolon
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
multiline_comment|/* Restart data test if UA, else quit.&n;&t;&t;&t;&t; */
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|skey
comma
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
comma
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skey
op_eq
id|SK_UNIT_ATTENTION
)paren
(brace
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_goto
id|target_done
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fatal error */
r_goto
id|target_done
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* --- end of patt loop ---- */
id|target_done
suffix:colon
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_RESERVED
)paren
(brace
id|iocmd.cmd
op_assign
id|CMD_Release6
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Release failed. id %d&quot;
comma
id|ioc-&gt;name
comma
id|id
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;pLocal-&gt;completion
op_eq
id|MPT_SCANDV_GOOD
)paren
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_RESERVED
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Release failed. id %d&quot;
comma
id|ioc-&gt;name
comma
id|id
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Set if cfg1_dma_addr contents is valid&n;&t; */
r_if
c_cond
(paren
id|cfg.hdr
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* If disk, not U320, disable QAS&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|inq0
op_eq
l_int|0
)paren
op_logical_and
(paren
id|dv.now.factor
OG
id|MPT_ULTRA320
)paren
)paren
id|hd-&gt;ioc-&gt;spi_data.noQas
op_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|dv.cmd
op_assign
id|MPT_SAVE
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
multiline_comment|/* Save the final negotiated settings to&n;&t;&t; * SCSI device page 1.&n;&t;&t; */
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg1_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
suffix:semicolon
)brace
multiline_comment|/* If this is a RAID Passthrough, enable internal IOs&n;&t; */
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_PHYS_DISK
)paren
(brace
r_if
c_cond
(paren
id|mptscsih_do_raid
c_func
(paren
id|hd
comma
id|MPI_RAID_ACTION_ENABLE_PHYS_IO
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;RAID Queisce FAILED!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Done with the DV scan of the current target&n;&t; */
r_if
c_cond
(paren
id|pDvBuf
)paren
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dv_alloc
comma
id|pDvBuf
comma
id|dvbuf_dma
)paren
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV Done. IOs outstanding = %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_dv_parms - perform a variety of operations on the&n; *&t;parameters used for negotiation.&n; *&t;@hd: Pointer to a SCSI host.&n; *&t;@dv: Pointer to a structure that contains the maximum and current&n; *&t;&t;negotiated parameters.&n; */
r_static
r_void
DECL|function|mptscsih_dv_parms
id|mptscsih_dv_parms
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|DVPARAMETERS
op_star
id|dv
comma
r_void
op_star
id|pPage
)paren
(brace
id|VirtDevice
op_star
id|pTarget
op_assign
l_int|NULL
suffix:semicolon
id|SCSIDevicePage0_t
op_star
id|pPage0
op_assign
l_int|NULL
suffix:semicolon
id|SCSIDevicePage1_t
op_star
id|pPage1
op_assign
l_int|NULL
suffix:semicolon
r_int
id|val
op_assign
l_int|0
comma
id|data
comma
id|configuration
suffix:semicolon
id|u8
id|width
op_assign
l_int|0
suffix:semicolon
id|u8
id|offset
op_assign
l_int|0
suffix:semicolon
id|u8
id|factor
op_assign
l_int|0
suffix:semicolon
id|u8
id|negoFlags
op_assign
l_int|0
suffix:semicolon
id|u8
id|cmd
op_assign
id|dv-&gt;cmd
suffix:semicolon
id|u8
id|id
op_assign
id|dv-&gt;id
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MPT_GET_NVRAM_VALS
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Getting NVRAM: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Get the NVRAM values and save in tmax&n;&t;&t; * If not an LVD bus, the adapter minSyncFactor has been&n;&t;&t; * already throttled back.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;Targets
)paren
op_logical_and
(paren
(paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
(paren
r_int
)paren
id|id
)braket
)paren
op_ne
l_int|NULL
)paren
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|width
op_assign
id|pTarget-&gt;maxWidth
suffix:semicolon
id|offset
op_assign
id|pTarget-&gt;maxOffset
suffix:semicolon
id|factor
op_assign
id|pTarget-&gt;minSyncFactor
suffix:semicolon
id|negoFlags
op_assign
id|pTarget-&gt;negoFlags
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
op_logical_and
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
id|data
op_assign
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
suffix:semicolon
id|width
op_assign
id|data
op_amp
id|MPT_NVRAM_WIDE_DISABLE
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_assign
id|hd-&gt;ioc-&gt;spi_data.maxSyncOffset
)paren
op_eq
l_int|0
)paren
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
r_else
(brace
id|factor
op_assign
(paren
id|data
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
id|MPT_NVRAM_SYNC_SHIFT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|factor
op_eq
l_int|0
)paren
op_logical_or
(paren
id|factor
op_eq
id|MPT_ASYNC
)paren
)paren
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
multiline_comment|/* Set the negotiation flags */
id|negoFlags
op_assign
id|hd-&gt;ioc-&gt;spi_data.noQas
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|width
)paren
id|negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|offset
)paren
id|negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
)brace
multiline_comment|/* limit by adapter capabilities */
id|width
op_assign
id|MIN
c_func
(paren
id|width
comma
id|hd-&gt;ioc-&gt;spi_data.maxBusWidth
)paren
suffix:semicolon
id|offset
op_assign
id|MIN
c_func
(paren
id|offset
comma
id|hd-&gt;ioc-&gt;spi_data.maxSyncOffset
)paren
suffix:semicolon
id|factor
op_assign
id|MAX
c_func
(paren
id|factor
comma
id|hd-&gt;ioc-&gt;spi_data.minSyncFactor
)paren
suffix:semicolon
multiline_comment|/* Check Consistency */
r_if
c_cond
(paren
id|offset
op_logical_and
(paren
id|factor
OL
id|MPT_ULTRA2
)paren
op_logical_and
op_logical_neg
id|width
)paren
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
id|dv-&gt;max.width
op_assign
id|width
suffix:semicolon
id|dv-&gt;max.offset
op_assign
id|offset
suffix:semicolon
id|dv-&gt;max.factor
op_assign
id|factor
suffix:semicolon
id|dv-&gt;max.flags
op_assign
id|negoFlags
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot; width %d, factor %x, offset %x flags %x&bslash;n&quot;
comma
id|width
comma
id|factor
comma
id|offset
comma
id|negoFlags
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_UPDATE_MAX
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Updating with SDP0 Data: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Update tmax values with those from Device Page 0.*/
id|pPage0
op_assign
(paren
id|SCSIDevicePage0_t
op_star
)paren
id|pPage
suffix:semicolon
r_if
c_cond
(paren
id|pPage0
)paren
(brace
id|val
op_assign
id|cpu_to_le32
c_func
(paren
id|pPage0-&gt;NegotiatedParameters
)paren
suffix:semicolon
id|dv-&gt;max.width
op_assign
id|val
op_amp
id|MPI_SCSIDEVPAGE0_NP_WIDE
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|dv-&gt;max.offset
op_assign
(paren
id|val
op_amp
id|MPI_SCSIDEVPAGE0_NP_NEG_SYNC_OFFSET_MASK
)paren
op_rshift
l_int|16
suffix:semicolon
id|dv-&gt;max.factor
op_assign
(paren
id|val
op_amp
id|MPI_SCSIDEVPAGE0_NP_NEG_SYNC_PERIOD_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
)brace
id|dv-&gt;now.width
op_assign
id|dv-&gt;max.width
suffix:semicolon
id|dv-&gt;now.offset
op_assign
id|dv-&gt;max.offset
suffix:semicolon
id|dv-&gt;now.factor
op_assign
id|dv-&gt;max.factor
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;width %d, factor %x, offset %x, flags %x&bslash;n&quot;
comma
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.flags
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_SET_MAX
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Setting Max: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Set current to the max values. Update the config page.*/
id|dv-&gt;now.width
op_assign
id|dv-&gt;max.width
suffix:semicolon
id|dv-&gt;now.offset
op_assign
id|dv-&gt;max.offset
suffix:semicolon
id|dv-&gt;now.factor
op_assign
id|dv-&gt;max.factor
suffix:semicolon
id|dv-&gt;now.flags
op_assign
id|dv-&gt;max.flags
suffix:semicolon
id|pPage1
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
id|pPage
suffix:semicolon
r_if
c_cond
(paren
id|pPage1
)paren
(brace
id|mptscsih_setDevicePage1Flags
(paren
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
op_amp
id|val
comma
op_amp
id|configuration
comma
id|dv-&gt;now.flags
)paren
suffix:semicolon
id|pPage1-&gt;RequestedParameters
op_assign
id|le32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
id|pPage1-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pPage1-&gt;Configuration
op_assign
id|le32_to_cpu
c_func
(paren
id|configuration
)paren
suffix:semicolon
)brace
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;width %d, factor %x, offset %x request %x, config %x&bslash;n&quot;
comma
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
id|val
comma
id|configuration
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_SET_MIN
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Setting Min: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Set page to asynchronous and narrow &n;&t;&t; * Do not update now, breaks fallback routine. */
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|negoFlags
op_assign
id|dv-&gt;max.flags
suffix:semicolon
id|pPage1
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
id|pPage
suffix:semicolon
r_if
c_cond
(paren
id|pPage1
)paren
(brace
id|mptscsih_setDevicePage1Flags
(paren
id|width
comma
id|factor
comma
id|offset
comma
op_amp
id|val
comma
op_amp
id|configuration
comma
id|negoFlags
)paren
suffix:semicolon
id|pPage1-&gt;RequestedParameters
op_assign
id|le32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
id|pPage1-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pPage1-&gt;Configuration
op_assign
id|le32_to_cpu
c_func
(paren
id|configuration
)paren
suffix:semicolon
)brace
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;width %d, factor %x, offset %x request %x config %x&bslash;n&quot;
comma
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
id|val
comma
id|configuration
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_FALLBACK
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Fallback: Start: offset %d, factor %x, width %d &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.width
)paren
)paren
suffix:semicolon
id|width
op_assign
id|dv-&gt;now.width
suffix:semicolon
id|offset
op_assign
id|dv-&gt;now.offset
suffix:semicolon
id|factor
op_assign
id|dv-&gt;now.factor
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
)paren
op_logical_and
(paren
id|dv-&gt;max.width
)paren
)paren
(brace
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA160
)paren
id|factor
op_assign
id|MPT_ULTRA160
suffix:semicolon
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA2
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
id|width
op_assign
id|MPT_WIDE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|factor
op_eq
id|MPT_ULTRA2
)paren
op_logical_and
id|width
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA
suffix:semicolon
id|width
op_assign
id|MPT_WIDE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|factor
op_eq
id|MPT_ULTRA
)paren
op_logical_and
id|width
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA
suffix:semicolon
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_FAST
)paren
(brace
id|factor
op_assign
id|MPT_FAST
suffix:semicolon
id|width
op_assign
id|MPT_WIDE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|factor
op_eq
id|MPT_FAST
)paren
op_logical_and
id|width
)paren
(brace
id|factor
op_assign
id|MPT_FAST
suffix:semicolon
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_SCSI
)paren
(brace
id|factor
op_assign
id|MPT_SCSI
suffix:semicolon
id|width
op_assign
id|MPT_WIDE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|factor
op_eq
id|MPT_SCSI
)paren
op_logical_and
id|width
)paren
(brace
id|factor
op_assign
id|MPT_SCSI
suffix:semicolon
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
)brace
r_else
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|offset
)paren
(brace
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA
)paren
id|factor
op_assign
id|MPT_ULTRA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_FAST
)paren
id|factor
op_assign
id|MPT_FAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_SCSI
)paren
id|factor
op_assign
id|MPT_SCSI
suffix:semicolon
r_else
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
id|dv-&gt;max.flags
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|dv-&gt;now.width
op_assign
id|width
suffix:semicolon
id|dv-&gt;now.offset
op_assign
id|offset
suffix:semicolon
id|dv-&gt;now.factor
op_assign
id|factor
suffix:semicolon
id|dv-&gt;now.flags
op_assign
id|dv-&gt;max.flags
suffix:semicolon
id|pPage1
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
id|pPage
suffix:semicolon
r_if
c_cond
(paren
id|pPage1
)paren
(brace
id|mptscsih_setDevicePage1Flags
(paren
id|width
comma
id|factor
comma
id|offset
comma
op_amp
id|val
comma
op_amp
id|configuration
comma
id|dv-&gt;now.flags
)paren
suffix:semicolon
id|pPage1-&gt;RequestedParameters
op_assign
id|le32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
id|pPage1-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pPage1-&gt;Configuration
op_assign
id|le32_to_cpu
c_func
(paren
id|configuration
)paren
suffix:semicolon
)brace
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;Finish: offset %d, factor %x, width %d, request %x config %x&bslash;n&quot;
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.width
comma
id|val
comma
id|configuration
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_SAVE
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Saving to Target structure: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;offset %d, factor %x, width %d &bslash;n&quot;
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.width
)paren
)paren
suffix:semicolon
multiline_comment|/* Save these values to target structures&n;&t;&t; * or overwrite nvram (phys disks only).&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;Targets
)paren
op_logical_and
(paren
(paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
(paren
r_int
)paren
id|id
)braket
)paren
op_ne
l_int|NULL
)paren
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|pTarget-&gt;maxWidth
op_assign
id|dv-&gt;now.width
suffix:semicolon
id|pTarget-&gt;maxOffset
op_assign
id|dv-&gt;now.offset
suffix:semicolon
id|pTarget-&gt;minSyncFactor
op_assign
id|dv-&gt;now.factor
suffix:semicolon
id|pTarget-&gt;negoFlags
op_assign
id|dv-&gt;now.flags
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Preserv all flags, use&n;&t;&t;&t; * read-modify-write algorithm&n;&t;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
)paren
(brace
id|data
op_assign
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dv-&gt;now.width
)paren
id|data
op_and_assign
op_complement
id|MPT_NVRAM_WIDE_DISABLE
suffix:semicolon
r_else
id|data
op_or_assign
id|MPT_NVRAM_WIDE_DISABLE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dv-&gt;now.offset
)paren
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|data
op_and_assign
op_complement
id|MPT_NVRAM_SYNC_MASK
suffix:semicolon
id|data
op_or_assign
(paren
id|dv-&gt;now.factor
op_lshift
id|MPT_NVRAM_SYNC_SHIFT
)paren
op_amp
id|MPT_NVRAM_SYNC_MASK
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_assign
id|data
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_fillbuf - fill a buffer with a special data pattern&n; *&t;&t;cleanup. For bus scan only.&n; *&n; *&t;@buffer: Pointer to data buffer to be filled.&n; *&t;@size: Number of bytes to fill&n; *&t;@index: Pattern index&n; *&t;@width: bus width, 0 (8 bits) or 1 (16 bits)&n; */
r_static
r_void
DECL|function|mptscsih_fillbuf
id|mptscsih_fillbuf
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|size
comma
r_int
id|index
comma
r_int
id|width
)paren
(brace
r_char
op_star
id|ptr
op_assign
id|buffer
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_char
id|byte
suffix:semicolon
r_int
id|val
suffix:semicolon
r_switch
c_cond
(paren
id|index
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|width
)paren
(brace
multiline_comment|/* Pattern:  0000 FFFF 0000 FFFF&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x02
)paren
op_star
id|ptr
op_assign
l_int|0xFF
suffix:semicolon
r_else
op_star
id|ptr
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Pattern:  00 FF 00 FF&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x01
)paren
op_star
id|ptr
op_assign
l_int|0xFF
suffix:semicolon
r_else
op_star
id|ptr
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|width
)paren
(brace
multiline_comment|/* Pattern:  5555 AAAA 5555 AAAA 5555&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x02
)paren
op_star
id|ptr
op_assign
l_int|0xAA
suffix:semicolon
r_else
op_star
id|ptr
op_assign
l_int|0x55
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Pattern:  55 AA 55 AA 55&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x01
)paren
op_star
id|ptr
op_assign
l_int|0xAA
suffix:semicolon
r_else
op_star
id|ptr
op_assign
l_int|0x55
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Pattern:  00 01 02 03 04 05&n;&t;&t; * ... FE FF 00 01..&n;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
op_star
id|ptr
op_assign
(paren
r_char
)paren
id|ii
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
id|width
)paren
(brace
multiline_comment|/* Wide Pattern:  FFFE 0001 FFFD 0002&n;&t;&t;&t; * ...  4000 DFFF 8000 EFFF&n;&t;&t;&t; */
id|byte
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
op_div
l_int|2
suffix:semicolon
id|ii
op_increment
)paren
(brace
multiline_comment|/* Create the base pattern&n;&t;&t;&t;&t; */
id|val
op_assign
(paren
l_int|1
op_lshift
id|byte
)paren
suffix:semicolon
multiline_comment|/* every 64 (0x40) bytes flip the pattern&n;&t;&t;&t;&t; * since we fill 2 bytes / iteration,&n;&t;&t;&t;&t; * test for ii = 0x20&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x20
)paren
id|val
op_assign
op_complement
(paren
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x01
)paren
(brace
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
(paren
id|val
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
id|val
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|byte
op_increment
suffix:semicolon
id|byte
op_and_assign
l_int|0x0F
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
op_complement
id|val
suffix:semicolon
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
(paren
id|val
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
id|val
op_amp
l_int|0xFF
)paren
suffix:semicolon
)brace
id|ptr
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Narrow Pattern:  FE 01 FD 02 FB 04&n;&t;&t;&t; * .. 7F 80 01 FE 02 FD ...  80 7F&n;&t;&t;&t; */
id|byte
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
multiline_comment|/* Base pattern - first 32 bytes&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x01
)paren
(brace
op_star
id|ptr
op_assign
(paren
l_int|1
op_lshift
id|byte
)paren
suffix:semicolon
id|byte
op_increment
suffix:semicolon
id|byte
op_and_assign
l_int|0x07
suffix:semicolon
)brace
r_else
(brace
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
op_complement
(paren
l_int|1
op_lshift
id|byte
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Flip the pattern every 32 bytes&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x20
)paren
op_star
id|ptr
op_assign
op_complement
(paren
op_star
id|ptr
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif /* ~MPTSCSIH_DISABLE_DOMAIN_VALIDATION */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Commandline Parsing routines and defines.&n; *&n; * insmod format:&n; *&t;insmod mptscsih mptscsih=&quot;width:1 dv:n factor:0x09&quot;&n; *  boot format:&n; *&t;mptscsih=width:1,dv:n,factor:0x8&n; *&n; */
macro_line|#ifdef MODULE
DECL|macro|ARG_SEP
mdefine_line|#define&t;ARG_SEP&t;&squot; &squot;
macro_line|#else
DECL|macro|ARG_SEP
mdefine_line|#define&t;ARG_SEP&t;&squot;,&squot;
macro_line|#endif
DECL|variable|__initdata
r_static
r_char
id|setup_token
(braket
)braket
id|__initdata
op_assign
l_string|&quot;dv:&quot;
l_string|&quot;width:&quot;
l_string|&quot;factor:&quot;
suffix:semicolon
multiline_comment|/* DONNOT REMOVE THIS &squot;;&squot; */
DECL|macro|OPT_DV
mdefine_line|#define OPT_DV&t;&t;&t;1
DECL|macro|OPT_MAX_WIDTH
mdefine_line|#define OPT_MAX_WIDTH&t;&t;2
DECL|macro|OPT_MIN_SYNC_FACTOR
mdefine_line|#define OPT_MIN_SYNC_FACTOR&t;3
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|get_setup_token
id|__init
id|get_setup_token
c_func
(paren
r_char
op_star
id|p
)paren
(brace
r_char
op_star
id|cur
op_assign
id|setup_token
suffix:semicolon
r_char
op_star
id|pc
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|cur
op_ne
l_int|NULL
op_logical_and
(paren
id|pc
op_assign
id|strchr
c_func
(paren
id|cur
comma
l_char|&squot;:&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
op_increment
id|pc
suffix:semicolon
op_increment
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
comma
id|cur
comma
id|pc
op_minus
id|cur
)paren
)paren
r_return
id|i
suffix:semicolon
id|cur
op_assign
id|pc
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptscsih_setup
id|__init
id|mptscsih_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|cur
op_assign
id|str
suffix:semicolon
r_char
op_star
id|pc
comma
op_star
id|pv
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
r_int
id|c
suffix:semicolon
r_while
c_loop
(paren
id|cur
op_ne
l_int|NULL
op_logical_and
(paren
id|pc
op_assign
id|strchr
c_func
(paren
id|cur
comma
l_char|&squot;:&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_char
op_star
id|pe
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|pv
op_assign
id|pc
suffix:semicolon
id|c
op_assign
op_star
op_increment
id|pv
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;n&squot;
)paren
id|val
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;y&squot;
)paren
id|val
op_assign
l_int|1
suffix:semicolon
r_else
id|val
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|pv
comma
op_amp
id|pe
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Found Token: %s, value %x&bslash;n&quot;
comma
id|cur
comma
(paren
r_int
)paren
id|val
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|get_setup_token
c_func
(paren
id|cur
)paren
)paren
(brace
r_case
id|OPT_DV
suffix:colon
id|driver_setup.dv
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPT_MAX_WIDTH
suffix:colon
id|driver_setup.max_width
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPT_MIN_SYNC_FACTOR
suffix:colon
id|driver_setup.min_sync_fac
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;mptscsih_setup: unexpected boot option &squot;%.*s&squot; ignored&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|pc
op_minus
id|cur
op_plus
l_int|1
)paren
comma
id|cur
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cur
op_assign
id|strchr
c_func
(paren
id|cur
comma
id|ARG_SEP
)paren
)paren
op_ne
l_int|NULL
)paren
op_increment
id|cur
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
eof
