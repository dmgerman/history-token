multiline_comment|/*&n; *  linux/drivers/message/fusion/mptscsih.c&n; *      High performance SCSI / Fibre Channel SCSI Host device driver.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      (see mptbase.c)&n; *&n; *  Copyright (c) 1999-2001 LSI Logic Corporation&n; *  Original author: Steven J. Ralston&n; *  (mailto:Steve.Ralston@lsil.com)&n; *&n; *  $Id: mptscsih.c,v 1.24 2001/03/22 08:45:08 sralston Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/blk.h&gt;&t;&t;/* for io_request_lock (spinlock) decl */
macro_line|#include &quot;../../scsi/scsi.h&quot;
macro_line|#include &quot;../../scsi/hosts.h&quot;
macro_line|#include &quot;../../scsi/sd.h&quot;
macro_line|#include &quot;mptbase.h&quot;
macro_line|#include &quot;mptscsih.h&quot;
macro_line|#include &quot;isense.h&quot;
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|my_NAME
mdefine_line|#define my_NAME&t;&t;&quot;Fusion MPT SCSI Host driver&quot;
DECL|macro|my_VERSION
mdefine_line|#define my_VERSION&t;MPT_LINUX_VERSION_COMMON
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptscsih&quot;
DECL|variable|MODULEAUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|MODULEAUTHOR
)paren
suffix:semicolon
DECL|variable|my_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|my_NAME
)paren
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|struct|_BIG_SENSE_BUF
r_typedef
r_struct
id|_BIG_SENSE_BUF
(brace
DECL|member|data
id|u8
id|data
(braket
l_int|256
)braket
suffix:semicolon
DECL|typedef|BIG_SENSE_BUF
)brace
id|BIG_SENSE_BUF
suffix:semicolon
DECL|struct|_MPT_SCSI_HOST
r_typedef
r_struct
id|_MPT_SCSI_HOST
(brace
DECL|member|ioc
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
DECL|member|port
r_int
id|port
suffix:semicolon
DECL|member|ScsiLookup
r_struct
id|scsi_cmnd
op_star
op_star
id|ScsiLookup
suffix:semicolon
DECL|member|SgHunks
id|u8
op_star
id|SgHunks
suffix:semicolon
DECL|member|SgHunksDMA
id|dma_addr_t
id|SgHunksDMA
suffix:semicolon
DECL|member|qtag_tick
id|u32
id|qtag_tick
suffix:semicolon
DECL|member|TargetsQ
id|FCDEV_TRACKER
id|TargetsQ
suffix:semicolon
DECL|typedef|MPT_SCSI_HOST
)brace
id|MPT_SCSI_HOST
suffix:semicolon
DECL|struct|_MPT_SCSI_DEV
r_typedef
r_struct
id|_MPT_SCSI_DEV
(brace
DECL|member|forw
r_struct
id|_MPT_SCSI_DEV
op_star
id|forw
suffix:semicolon
DECL|member|back
r_struct
id|_MPT_SCSI_DEV
op_star
id|back
suffix:semicolon
DECL|member|ioc
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
DECL|member|sense_sz
r_int
id|sense_sz
suffix:semicolon
DECL|member|CachedSense
id|BIG_SENSE_BUF
id|CachedSense
suffix:semicolon
DECL|member|io_cnt
r_int
r_int
id|io_cnt
suffix:semicolon
DECL|member|read_cnt
r_int
r_int
id|read_cnt
suffix:semicolon
DECL|typedef|MPT_SCSI_DEV
)brace
id|MPT_SCSI_DEV
suffix:semicolon
multiline_comment|/*&n; *  Other private/forward protos...&n; */
r_static
r_int
id|mptscsih_io_done
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_report_queue_full
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
comma
id|SCSIIORequest_t
op_star
id|pScsiReq
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_taskmgmt_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_io_direction
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|copy_sense_data
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
)paren
suffix:semicolon
r_static
id|u32
id|SCPNT_TO_MSGCTX
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_event_process
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEvReply
)paren
suffix:semicolon
DECL|variable|mpt_scsi_hosts
r_static
r_int
id|mpt_scsi_hosts
op_assign
l_int|0
suffix:semicolon
DECL|variable|queue_depth
r_static
id|atomic_t
id|queue_depth
suffix:semicolon
DECL|variable|ScsiDoneCtx
r_static
r_int
id|ScsiDoneCtx
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|ScsiTaskCtx
r_static
r_int
id|ScsiTaskCtx
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,28)
DECL|variable|proc_mpt_scsihost
r_static
r_struct
id|proc_dir_entry
id|proc_mpt_scsihost
op_assign
(brace
id|low_ino
suffix:colon
id|PROC_SCSI_MPT
comma
id|namelen
suffix:colon
l_int|8
comma
id|name
suffix:colon
l_string|&quot;mptscsih&quot;
comma
id|mode
suffix:colon
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
id|nlink
suffix:colon
l_int|2
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|macro|SNS_LEN
mdefine_line|#define SNS_LEN(scp)  sizeof((scp)-&gt;sense_buffer)
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
multiline_comment|/*&n; *  Stuff to handle single-threading SCSI TaskMgmt&n; *  (abort/reset) requests...&n; */
DECL|variable|mpt_scsih_taskQ_lock
r_static
id|spinlock_t
id|mpt_scsih_taskQ_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|mpt_scsih_taskQ
r_static
id|MPT_Q_TRACKER
id|mpt_scsih_taskQ
op_assign
(brace
(paren
id|MPT_FRAME_HDR
op_star
)paren
op_amp
id|mpt_scsih_taskQ
comma
(paren
id|MPT_FRAME_HDR
op_star
)paren
op_amp
id|mpt_scsih_taskQ
)brace
suffix:semicolon
DECL|variable|mpt_scsih_taskQ_cnt
r_static
r_int
id|mpt_scsih_taskQ_cnt
op_assign
l_int|0
suffix:semicolon
DECL|variable|mpt_scsih_taskQ_bh_active
r_static
r_int
id|mpt_scsih_taskQ_bh_active
op_assign
l_int|0
suffix:semicolon
DECL|variable|mpt_scsih_active_taskmgmt_mf
r_static
id|MPT_FRAME_HDR
op_star
id|mpt_scsih_active_taskmgmt_mf
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_io_done - Main SCSI IO callback routine registered to&n; *&t;Fusion MPT (base) driver&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to original MPT request frame&n; *&t;@r: Pointer to MPT reply frame (NULL if TurboReply)&n; *&n; *&t;This routine is called from mpt.c::mpt_interrupt() at the completion&n; *&t;of any SCSI IO request.&n; *&t;This routine is registered with the Fusion MPT (base) driver at driver&n; *&t;load/init time via the mpt_register() API call.&n; *&n; *&t;Returns 1 indicating alloc&squot;d request frame ptr should be freed.&n; */
r_static
r_int
DECL|function|mptscsih_io_done
id|mptscsih_io_done
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
(brace
id|Scsi_Cmnd
op_star
id|sc
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_SCSI_DEV
op_star
id|mpt_sdev
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|mf
op_ge
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR! NULL or BAD req frame ptr (=%p)!&bslash;n&quot;
comma
id|mf
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sc
op_assign
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
suffix:semicolon
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: ScsiDone (req:sc:reply=%p:%p:%p)&bslash;n&quot;
comma
id|mf
comma
id|sc
comma
id|r
)paren
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Check for {1st} {IO} completion to &quot;new&quot; device.&n;&t; *  How do we know it&squot;s a new device?&n;&t; *  If we haven&squot;t set SDpnt-&gt;hostdata I guess...&n;&t; */
r_if
c_cond
(paren
id|sc
op_logical_and
id|sc-&gt;device
)paren
(brace
id|mpt_sdev
op_assign
(paren
id|MPT_SCSI_DEV
op_star
)paren
id|sc-&gt;device-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mpt_sdev
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: *NEW* SCSI device (%d:%d:%d)!&bslash;n&quot;
comma
id|sc-&gt;device-&gt;id
comma
id|sc-&gt;device-&gt;lun
comma
id|sc-&gt;device-&gt;channel
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sc-&gt;device-&gt;hostdata
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|MPT_SCSI_DEV
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR: kmalloc(%d) FAILED!&bslash;n&quot;
comma
(paren
r_int
)paren
r_sizeof
(paren
id|MPT_SCSI_DEV
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|sc-&gt;device-&gt;hostdata
comma
l_int|0
comma
r_sizeof
(paren
id|MPT_SCSI_DEV
)paren
)paren
suffix:semicolon
id|mpt_sdev
op_assign
(paren
id|MPT_SCSI_DEV
op_star
)paren
id|sc-&gt;device-&gt;hostdata
suffix:semicolon
id|mpt_sdev-&gt;ioc
op_assign
id|ioc
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_increment
id|mpt_sdev-&gt;io_cnt
op_logical_and
id|mptscsih_io_direction
c_func
(paren
id|sc
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_increment
id|mpt_sdev-&gt;read_cnt
op_eq
l_int|3
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: 3rd DATA_IN, CDB[0]=%02x&bslash;n&quot;
comma
id|sc-&gt;cmnd
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|mpt_sdev-&gt;sense_sz
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *  Completion of first IO down this path&n;&t;&t;&t;&t; *  *should* invalidate device SenseData...&n;&t;&t;&t;&t; */
id|mpt_sdev-&gt;sense_sz
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
macro_line|#if 0
(brace
id|MPT_FRAME_HDR
op_star
id|mf_chk
suffix:semicolon
multiline_comment|/* This, I imagine, is a costly check, but...&n;&t; *  If abort/reset active, check to see if this is a IO&n;&t; *  that completed while ABORT/RESET for it is waiting&n;&t; *  on our taskQ!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|mpt_scsih_taskQ
)paren
)paren
(brace
multiline_comment|/* If ABORT for this IO is queued, zap it! */
id|mf_chk
op_assign
id|search_taskQ
c_func
(paren
l_int|1
comma
id|sc
comma
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf_chk
op_ne
l_int|NULL
)paren
(brace
id|sc-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|sc
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|sc
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|r
op_ne
l_int|NULL
op_logical_and
id|sc
op_ne
l_int|NULL
)paren
(brace
id|SCSIIOReply_t
op_star
id|pScsiReply
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pScsiReq
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|pScsiReply
op_assign
(paren
id|SCSIIOReply_t
op_star
)paren
id|r
suffix:semicolon
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|status
op_assign
id|le16_to_cpu
c_func
(paren
id|pScsiReply-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
id|MYNAM
l_string|&quot;: Uh-Oh!  (req:sc:reply=%p:%p:%p)&bslash;n&quot;
comma
id|mf
comma
id|sc
comma
id|r
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  IOCStatus=%04xh, SCSIState=%02xh&quot;
l_string|&quot;, SCSIStatus=%02xh, IOCLogInfo=%08xh&bslash;n&quot;
comma
id|status
comma
id|pScsiReply-&gt;SCSIState
comma
id|pScsiReply-&gt;SCSIStatus
comma
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;IOCLogInfo
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Look for + dump FCP ResponseInfo[]!&n;&t;&t; */
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_RESPONSE_INFO_VALID
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  FCP_ResponseInfo=%08xh&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;ResponseInfo
)paren
)paren
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|MPI_IOCSTATUS_BUSY
suffix:colon
multiline_comment|/* 0x0002 */
multiline_comment|/*sc-&gt;result = DID_BUS_BUSY &lt;&lt; 16;*/
multiline_comment|/* YIKES! - Seems to&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * kill linux interrupt&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * handler&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
multiline_comment|/* Try SCSI BUSY! */
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
suffix:colon
multiline_comment|/* 0x0040 */
multiline_comment|/*  Not real sure here...  */
id|sc-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_INVALID_BUS
suffix:colon
multiline_comment|/* 0x0041 */
r_case
id|MPI_IOCSTATUS_SCSI_INVALID_TARGETID
suffix:colon
multiline_comment|/* 0x0042 */
id|sc-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE
suffix:colon
multiline_comment|/* 0x0043 */
multiline_comment|/*  Spoof to SCSI Selection Timeout!  */
id|sc-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
suffix:colon
multiline_comment|/* 0x0045 */
multiline_comment|/*&n;&t;&t;&t; *  YIKES!  I just discovered that SCSI IO which&n;&t;&t;&t; *  returns check condition, SenseKey=05 (ILLEGAL REQUEST)&n;&t;&t;&t; *  and ASC/ASCQ=94/01 (LSI Logic RAID vendor specific),&n;&t;&t;&t; *  comes down this path!&n;&t;&t;&t; *  Do upfront check for valid SenseData and give it&n;&t;&t;&t; *  precedence!&n;&t;&t;&t; */
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
(brace
id|copy_sense_data
c_func
(paren
id|sc
comma
id|hd
comma
id|mf
comma
id|pScsiReply
)paren
suffix:semicolon
id|sc-&gt;result
op_assign
id|pScsiReply-&gt;SCSIStatus
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
id|MYNAM
l_string|&quot;: sc-&gt;underflow={report ERR if &lt; %02xh bytes xfer&squot;d}&bslash;n&quot;
comma
id|sc-&gt;underflow
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
id|MYNAM
l_string|&quot;: ActBytesXferd=%02xh&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;TransferCount
)paren
)paren
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
id|sc-&gt;resid
op_assign
id|sc-&gt;request_bufflen
op_minus
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;TransferCount
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
id|MYNAM
l_string|&quot;: SET sc-&gt;resid=%02xh&bslash;n&quot;
comma
id|sc-&gt;resid
)paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
r_if
c_cond
(paren
id|sc-&gt;underflow
op_logical_and
(paren
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;TransferCount
)paren
OL
id|sc-&gt;underflow
)paren
)paren
(brace
id|sc-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|sc-&gt;resid
op_assign
id|sc-&gt;request_bufflen
op_minus
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;TransferCount
)paren
suffix:semicolon
)brace
r_else
(brace
id|sc-&gt;result
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* workaround attempts... */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
r_if
c_cond
(paren
id|sc-&gt;resid
op_ge
l_int|0x200
)paren
(brace
multiline_comment|/* GRRRRR...&n;&t;&t;&t;&t; *   //sc-&gt;result = DID_SOFT_ERROR &lt;&lt; 16;&n;&t;&t;&t;&t; * Try spoofing to BUSY&n;&t;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
)brace
r_else
(brace
id|sc-&gt;result
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#else
id|sc-&gt;result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_TASK_TERMINATED
suffix:colon
multiline_comment|/* 0x0048 */
id|sc-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_IOC_TERMINATED
suffix:colon
multiline_comment|/* 0x004B */
r_case
id|MPI_IOCSTATUS_SCSI_EXT_TERMINATED
suffix:colon
multiline_comment|/* 0x004C */
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SUCCESS
suffix:colon
multiline_comment|/* 0x0000 */
id|sc-&gt;result
op_assign
id|pScsiReply-&gt;SCSIStatus
suffix:semicolon
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
(brace
id|copy_sense_data
c_func
(paren
id|sc
comma
id|hd
comma
id|mf
comma
id|pScsiReply
)paren
suffix:semicolon
multiline_comment|/*  If running agains circa 200003dd 909 MPT f/w,&n;&t;&t;&t;&t; *  may get this (AUTOSENSE_VALID) for actual TASK_SET_FULL&n;&t;&t;&t;&t; *  (QUEUE_FULL) returned from device!&t;--&gt; get 0x0000?128&n;&t;&t;&t;&t; *  and with SenseBytes set to 0.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIStatus
op_eq
id|MPI_SCSI_STATUS_TASK_SET_FULL
)paren
id|mptscsih_report_queue_full
c_func
(paren
id|sc
comma
id|pScsiReply
comma
id|pScsiReq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
(paren
id|MPI_SCSI_STATE_AUTOSENSE_FAILED
op_or
id|MPI_SCSI_STATE_NO_SCSI_STATUS
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; *  What to do?&n;&t;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
(brace
multiline_comment|/*  Not real sure here either...  */
id|sc-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sc-&gt;result
op_eq
id|MPI_SCSI_STATUS_TASK_SET_FULL
)paren
id|mptscsih_report_queue_full
c_func
(paren
id|sc
comma
id|pScsiReply
comma
id|pScsiReq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INVALID_FUNCTION
suffix:colon
multiline_comment|/* 0x0001 */
r_case
id|MPI_IOCSTATUS_INVALID_SGL
suffix:colon
multiline_comment|/* 0x0003 */
r_case
id|MPI_IOCSTATUS_INTERNAL_ERROR
suffix:colon
multiline_comment|/* 0x0004 */
r_case
id|MPI_IOCSTATUS_RESERVED
suffix:colon
multiline_comment|/* 0x0005 */
r_case
id|MPI_IOCSTATUS_INSUFFICIENT_RESOURCES
suffix:colon
multiline_comment|/* 0x0006 */
r_case
id|MPI_IOCSTATUS_INVALID_FIELD
suffix:colon
multiline_comment|/* 0x0007 */
r_case
id|MPI_IOCSTATUS_INVALID_STATE
suffix:colon
multiline_comment|/* 0x0008 */
r_case
id|MPI_IOCSTATUS_SCSI_DATA_OVERRUN
suffix:colon
multiline_comment|/* 0x0044 */
r_case
id|MPI_IOCSTATUS_SCSI_IO_DATA_ERROR
suffix:colon
multiline_comment|/* 0x0046 */
r_case
id|MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR
suffix:colon
multiline_comment|/* 0x0047 */
r_case
id|MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH
suffix:colon
multiline_comment|/* 0x0049 */
r_case
id|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
suffix:colon
multiline_comment|/* 0x004A */
r_default
suffix:colon
multiline_comment|/*&n;&t;&t;&t; *  What to do?&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch(status) */
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
id|MYNAM
l_string|&quot;: sc-&gt;result set to %08xh&bslash;n&quot;
comma
id|sc-&gt;result
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sc
op_ne
l_int|NULL
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Unmap the DMA buffers, if any. */
r_if
c_cond
(paren
id|sc-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|ioc-&gt;pcidev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|sc-&gt;request_buffer
comma
id|sc-&gt;use_sg
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|sc-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sc-&gt;request_bufflen
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
(paren
id|dma_addr_t
)paren
(paren
(paren
r_int
)paren
id|sc-&gt;SCp.ptr
)paren
comma
id|sc-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|sc-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|sc
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|sc
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;search_taskQ - Search SCSI task mgmt request queue for specific&n; *&t;&t;&t;request type&n; *&t;@remove: (Boolean) Should request be removed if found?&n; *&t;@sc: Pointer to Scsi_Cmnd structure&n; *&t;@task_type: Task type to search for&n; *&n; *&t;Returns pointer to MPT request frame if found, or %NULL if request&n; *&t;was not found.&n; */
r_static
id|MPT_FRAME_HDR
op_star
DECL|function|search_taskQ
id|search_taskQ
c_func
(paren
r_int
id|remove
comma
id|Scsi_Cmnd
op_star
id|sc
comma
id|u8
id|task_type
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|list_sz
suffix:semicolon
id|dslprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: spinlock#1&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|list_sz
op_assign
id|mpt_scsih_taskQ_cnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|mpt_scsih_taskQ
)paren
)paren
(brace
id|mf
op_assign
id|mpt_scsih_taskQ.head
suffix:semicolon
r_do
(brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mf-&gt;u.frame.linkage.argp1
op_eq
id|sc
op_logical_and
id|mf-&gt;u.frame.linkage.arg1
op_eq
id|task_type
)paren
(brace
r_if
c_cond
(paren
id|remove
)paren
(brace
id|Q_DEL_ITEM
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage
)paren
suffix:semicolon
id|mpt_scsih_taskQ_cnt
op_decrement
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|mf
op_assign
id|mf-&gt;u.frame.linkage.forw
)paren
op_ne
(paren
id|MPT_FRAME_HDR
op_star
)paren
op_amp
id|mpt_scsih_taskQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_eq
(paren
id|MPT_FRAME_HDR
op_star
)paren
op_amp
id|mpt_scsih_taskQ
)paren
(brace
id|mf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_sz
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: search_taskQ(%d,%p,%d) results=%p (%sFOUND%s)!&bslash;n&quot;
comma
id|remove
comma
id|sc
comma
id|task_type
comma
id|mf
comma
id|mf
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;NOT_&quot;
comma
(paren
id|mf
op_logical_and
id|remove
)paren
ques
c_cond
l_string|&quot;+REMOVED&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: (searched thru %d of %d items on taskQ)&bslash;n&quot;
comma
id|count
comma
id|list_sz
)paren
)paren
suffix:semicolon
)brace
r_return
id|mf
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Hack!  I&squot;d like to report if a device is returning QUEUE_FULL&n; *  but maybe not each and every time...&n; */
DECL|variable|last_queue_full
r_static
r_int
id|last_queue_full
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_report_queue_full - Report QUEUE_FULL status returned&n; *&t;from a SCSI target device.&n; *&t;@sc: Pointer to Scsi_Cmnd structure&n; *&t;@pScsiReply: Pointer to SCSIIOReply_t&n; *&t;@pScsiReq: Pointer to original SCSI request&n; *&n; *&t;This routine periodically reports QUEUE_FULL status returned from a&n; *&t;SCSI target device.  It reports this to the console via kernel&n; *&t;printk() API call, not more than once every 10 seconds.&n; */
r_static
r_void
DECL|function|mptscsih_report_queue_full
id|mptscsih_report_queue_full
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
comma
id|SCSIIORequest_t
op_star
id|pScsiReq
)paren
(brace
r_int
id|time
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|time
op_minus
id|last_queue_full
OG
l_int|10
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Device reported QUEUE_FULL!  SCSI bus:target:lun = %d:%d:%d&bslash;n&quot;
comma
l_int|0
comma
id|sc-&gt;target
comma
id|sc-&gt;lun
)paren
suffix:semicolon
id|last_queue_full
op_assign
id|time
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|BeenHereDoneThat
r_static
r_int
id|BeenHereDoneThat
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  SCSI fops start here...  */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_detect - Register MPT adapter(s) as SCSI host(s) with&n; *&t;linux scsi mid-layer.&n; *&t;@tpnt: Pointer to Scsi_Host_Template structure&n; *&n; *&t;(linux Scsi_Host_Template.detect routine)&n; *&n; *&t;Returns number of SCSI host adapters that were successfully&n; *&t;registered with the linux scsi mid-layer via the scsi_register()&n; *&t;API call.&n; */
r_int
DECL|function|mptscsih_detect
id|mptscsih_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|sh
op_assign
l_int|NULL
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
l_int|NULL
suffix:semicolon
id|MPT_ADAPTER
op_star
id|this
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|sz
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|BeenHereDoneThat
op_increment
)paren
(brace
id|show_mptmod_ver
c_func
(paren
id|my_NAME
comma
id|my_VERSION
)paren
suffix:semicolon
id|ScsiDoneCtx
op_assign
id|mpt_register
c_func
(paren
id|mptscsih_io_done
comma
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
id|ScsiTaskCtx
op_assign
id|mpt_register
c_func
(paren
id|mptscsih_taskmgmt_complete
comma
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
id|Q_INIT
c_func
(paren
op_amp
id|mpt_scsih_taskQ
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mpt_event_register
c_func
(paren
id|ScsiDoneCtx
comma
id|mptscsih_event_process
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered for IOC event notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FIXME! */
)brace
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: mpt_scsih_detect()&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|this
op_assign
id|mpt_adapter_find_first
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|this
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* FIXME!  Multi-port (aka FC929) support...&n;&t;&t; * for (i = 0; i &lt; this-&gt;facts.NumberOfPorts; i++)&n;&t;&t; */
multiline_comment|/* 20010215 -sralston&n;&t;&t; *  Added sanity check on SCSI Initiator-mode enabled&n;&t;&t; *  for this MPT adapter.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|this-&gt;pfacts0.ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_INITIATOR
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: Skipping %s because SCSI Initiator mode is NOT enabled!&bslash;n&quot;
comma
id|this-&gt;name
)paren
suffix:semicolon
id|this
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|this
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* 20010202 -sralston&n;&t;&t; *  Added sanity check on readiness of the MPT adapter.&n;&t;&t; */
r_if
c_cond
(paren
id|this-&gt;last_state
op_ne
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - Skipping %s because it&squot;s not operational!&bslash;n&quot;
comma
id|this-&gt;name
)paren
suffix:semicolon
id|this
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|this
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)
id|tpnt-&gt;proc_dir
op_assign
op_amp
id|proc_mpt_scsihost
suffix:semicolon
macro_line|#endif
id|sh
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
id|MPT_SCSI_HOST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
op_ne
l_int|NULL
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sh-&gt;io_port
op_assign
l_int|0
suffix:semicolon
id|sh-&gt;n_io_port
op_assign
l_int|0
suffix:semicolon
id|sh-&gt;irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Yikes!  This is important!&n;&t;&t;&t; * Otherwise, by default, linux only scans target IDs 0-7!&n;&t;&t;&t; */
id|sh-&gt;max_id
op_assign
id|this-&gt;pfacts0.MaxDevices
op_minus
l_int|1
suffix:semicolon
id|sh-&gt;this_id
op_assign
id|this-&gt;pfacts0.PortSCSIID
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
id|hd-&gt;ioc
op_assign
id|this
suffix:semicolon
id|hd-&gt;port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME! */
multiline_comment|/* SCSI needs Scsi_Cmnd lookup table!&n;&t;&t;&t; * (with size equal to req_depth*PtrSz!)&n;&t;&t;&t; */
id|sz
op_assign
id|hd-&gt;ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
id|mpt_scsi_hosts
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|hd-&gt;ScsiLookup
op_assign
(paren
r_struct
id|scsi_cmnd
op_star
op_star
)paren
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: ScsiLookup @ %p, sz=%d&bslash;n&quot;
comma
id|hd-&gt;ScsiLookup
comma
id|sz
)paren
)paren
suffix:semicolon
multiline_comment|/* SCSI also needs SG buckets/hunk management!&n;&t;&t;&t; * (with size equal to N * req_sz * req_depth!)&n;&t;&t;&t; * (where N is number of SG buckets per hunk)&n;&t;&t;&t; */
id|sz
op_assign
id|MPT_SG_BUCKETS_PER_HUNK
op_star
id|hd-&gt;ioc-&gt;req_sz
op_star
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|mem
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hd-&gt;ioc-&gt;pcidev
comma
id|sz
comma
op_amp
id|hd-&gt;SgHunksDMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
r_return
id|mpt_scsi_hosts
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|hd-&gt;SgHunks
op_assign
(paren
id|u8
op_star
)paren
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SgHunks    @ %p(%08x), sz=%d&bslash;n&quot;
comma
id|hd-&gt;SgHunks
comma
id|hd-&gt;SgHunksDMA
comma
id|sz
)paren
)paren
suffix:semicolon
id|hd-&gt;qtag_tick
op_assign
id|jiffies
suffix:semicolon
id|this-&gt;sh
op_assign
id|sh
suffix:semicolon
id|mpt_scsi_hosts
op_increment
suffix:semicolon
)brace
id|this
op_assign
id|mpt_adapter_find_next
c_func
(paren
id|this
)paren
suffix:semicolon
)brace
r_return
id|mpt_scsi_hosts
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|info_kbuf
r_static
r_char
op_star
id|info_kbuf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_release - Unregister SCSI host from linux scsi mid-layer&n; *&t;@host: Pointer to Scsi_Host structure&n; *&n; *&t;(linux Scsi_Host_Template.release routine)&n; *&t;This routine releases all resources associated with the SCSI host&n; *&t;adapter.&n; *&n; *&t;Returns 0 for success.&n; */
r_int
DECL|function|mptscsih_release
id|mptscsih_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_scsih_taskQ_bh_active
)paren
(brace
r_int
id|count
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Info: Zapping TaskMgmt thread!&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Zap the taskQ! */
id|Q_INIT
c_func
(paren
op_amp
id|mpt_scsih_taskQ
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mpt_scsih_taskQ_bh_active
op_logical_and
op_decrement
id|count
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR! TaskMgmt thread still active!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_ne
l_int|NULL
)paren
(brace
r_int
id|sz1
comma
id|sz2
suffix:semicolon
id|sz1
op_assign
id|sz2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
op_ne
l_int|NULL
)paren
(brace
id|sz1
op_assign
id|hd-&gt;ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hd-&gt;ScsiLookup
)paren
suffix:semicolon
id|hd-&gt;ScsiLookup
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;SgHunks
op_ne
l_int|NULL
)paren
(brace
id|sz2
op_assign
id|MPT_SG_BUCKETS_PER_HUNK
op_star
id|hd-&gt;ioc-&gt;req_sz
op_star
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|hd-&gt;ioc-&gt;pcidev
comma
id|sz2
comma
id|hd-&gt;SgHunks
comma
id|hd-&gt;SgHunksDMA
)paren
suffix:semicolon
id|hd-&gt;SgHunks
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Free&squot;d ScsiLookup (%d) and SgHunks (%d) memory&bslash;n&quot;
comma
id|sz1
comma
id|sz2
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mpt_scsi_hosts
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|mpt_scsi_hosts
op_eq
l_int|0
)paren
(brace
macro_line|#if 0
id|mptscsih_flush_pending
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|mpt_event_deregister
c_func
(paren
id|ScsiDoneCtx
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered for IOC event notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|ScsiDoneCtx
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|ScsiTaskCtx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info_kbuf
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|info_kbuf
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_info - Return information about MPT adapter&n; *&t;@SChost: Pointer to Scsi_Host structure&n; *&n; *&t;(linux Scsi_Host_Template.info routine)&n; *&n; *&t;Returns pointer to buffer where information was written.&n; */
r_const
r_char
op_star
DECL|function|mptscsih_info
id|mptscsih_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|SChost
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|h
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info_kbuf
op_eq
l_int|NULL
)paren
r_if
c_cond
(paren
(paren
id|info_kbuf
op_assign
id|kmalloc
c_func
(paren
l_int|0x1000
multiline_comment|/* 4Kb */
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|info_kbuf
suffix:semicolon
id|h
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SChost-&gt;hostdata
suffix:semicolon
id|info_kbuf
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|mpt_print_ioc_summary
c_func
(paren
id|h-&gt;ioc
comma
id|info_kbuf
comma
op_amp
id|size
comma
l_int|0
)paren
suffix:semicolon
id|info_kbuf
(braket
id|size
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|info_kbuf
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|max_qd
r_static
r_int
id|max_qd
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
DECL|variable|max_sges
r_static
r_int
id|max_sges
op_assign
l_int|0
suffix:semicolon
DECL|variable|max_xfer
r_static
r_int
id|max_xfer
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if 0
r_static
r_int
id|max_num_sges
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|max_sgent_len
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if 0
r_static
r_int
id|index_log
(braket
l_int|128
)braket
suffix:semicolon
r_static
r_int
id|index_ent
op_assign
l_int|0
suffix:semicolon
r_static
id|__inline__
r_void
id|ADD_INDEX_LOG
c_func
(paren
r_int
id|req_ent
)paren
(brace
r_int
id|i
op_assign
id|index_ent
op_increment
suffix:semicolon
id|index_log
(braket
id|i
op_amp
(paren
l_int|128
op_minus
l_int|1
)paren
)braket
op_assign
id|req_ent
suffix:semicolon
)brace
macro_line|#else
DECL|macro|ADD_INDEX_LOG
mdefine_line|#define ADD_INDEX_LOG(req_ent)&t;do { } while(0)
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_qcmd - Primary Fusion MPT SCSI initiator IO start routine.&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure&n; *&t;@done: Pointer SCSI mid-layer IO completion function&n; *&n; *&t;(linux Scsi_Host_Template.queuecommand routine)&n; *&t;This is the primary SCSI IO start routine.  Create a MPI SCSIIORequest&n; *&t;from a linux Scsi_Cmnd request and send it to the IOC.&n; *&n; *&t;Returns 0. (rtn value discarded by linux scsi mid-layer)&n; */
r_int
DECL|function|mptscsih_qcmd
id|mptscsih_qcmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pScsiReq
suffix:semicolon
r_int
id|datadir
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|u32
id|sgdir
suffix:semicolon
id|u32
id|scsictl
suffix:semicolon
id|u32
id|scsidir
suffix:semicolon
id|u32
id|qtag
suffix:semicolon
id|u32
op_star
id|mptr
suffix:semicolon
r_int
id|sge_spill1
suffix:semicolon
r_int
id|frm_sz
suffix:semicolon
r_int
id|sges_left
suffix:semicolon
id|u32
id|chain_offset
suffix:semicolon
r_int
id|my_idx
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;_qcmd: SCpnt=%p, done()=%p&bslash;n&quot;
comma
id|SCpnt
comma
id|done
)paren
)paren
suffix:semicolon
id|host
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|host-&gt;host_busy
op_ge
l_int|60
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|u16
id|pci_command
comma
id|pci_status
suffix:semicolon
multiline_comment|/* The IOC is probably hung, investigate status. */
id|printk
c_func
(paren
l_string|&quot;MPI: IOC probably hung IOCSTAT[%08x] INTSTAT[%08x] REPLYFIFO[%08x]&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
id|ioc-&gt;chip.fc9xx-&gt;DoorbellValue
)paren
comma
id|readl
c_func
(paren
op_amp
id|ioc-&gt;chip.fc9xx-&gt;IntStatus
)paren
comma
id|readl
c_func
(paren
op_amp
id|ioc-&gt;chip.fc9xx-&gt;ReplyFifo
)paren
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|ioc-&gt;pcidev
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|ioc-&gt;pcidev
comma
id|PCI_STATUS
comma
op_amp
id|pci_status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MPI: PCI command[%04x] status[%04x]&bslash;n&quot;
comma
id|pci_command
comma
id|pci_status
)paren
suffix:semicolon
(brace
multiline_comment|/* DUMP req index logger. */
r_int
id|begin
comma
id|end
suffix:semicolon
id|begin
op_assign
(paren
id|index_ent
op_minus
l_int|65
)paren
op_amp
(paren
l_int|128
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
id|index_ent
op_amp
(paren
l_int|128
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MPI: REQ_INDEX_HIST[&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|begin
op_ne
id|end
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(%04x)&quot;
comma
id|index_log
(braket
id|begin
)braket
)paren
suffix:semicolon
id|begin
op_assign
(paren
id|begin
op_plus
l_int|1
)paren
op_amp
(paren
l_int|128
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/* 20000617 -sralston&n;&t; *  GRRRRR...  Shouldn&squot;t have to do this but...&n;&t; *  Do explicit check for REQUEST_SENSE and cached SenseData.&n;&t; *  If yes, return cached SenseData.&n;&t; */
macro_line|#ifdef MPT_SCSI_CACHE_AUTOSENSE
(brace
id|MPT_SCSI_DEV
op_star
id|mpt_sdev
suffix:semicolon
id|mpt_sdev
op_assign
(paren
id|MPT_SCSI_DEV
op_star
)paren
id|SCpnt-&gt;device-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|mpt_sdev
op_logical_and
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
(brace
id|u8
op_star
id|dest
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;use_sg
)paren
id|dest
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_else
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|sg
)paren
id|dest
op_assign
(paren
id|u8
op_star
)paren
(paren
r_int
r_int
)paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dest
op_logical_and
id|mpt_sdev-&gt;sense_sz
)paren
(brace
id|memcpy
c_func
(paren
id|dest
comma
id|mpt_sdev-&gt;CachedSense.data
comma
id|mpt_sdev-&gt;sense_sz
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
(brace
r_int
id|i
suffix:semicolon
id|u8
op_star
id|sb
suffix:semicolon
id|sb
op_assign
id|mpt_sdev-&gt;CachedSense.data
suffix:semicolon
r_if
c_cond
(paren
id|sb
op_logical_and
(paren
(paren
id|sb
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Returning last cached SCSI (hex) SenseData:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot; &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|8
op_plus
id|sb
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%s%02x&quot;
comma
id|i
op_eq
l_int|13
ques
c_cond
l_string|&quot;-&quot;
suffix:colon
l_string|&quot; &quot;
comma
id|sb
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
id|SCpnt-&gt;resid
op_assign
id|SCpnt-&gt;request_bufflen
op_minus
id|mpt_sdev-&gt;sense_sz
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&t;&t;&t;spin_lock(&amp;io_request_lock);&t;*/
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/*&t;&t;&t;spin_unlock(&amp;io_request_lock);&t;*/
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;SCpnt-&gt;result = DID_SOFT_ERROR &lt;&lt; 16;&t;*/
id|SCpnt-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/*&t;&t;return 1;&t;&t;&t;&t;*/
r_return
l_int|0
suffix:semicolon
)brace
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|my_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|ADD_INDEX_LOG
c_func
(paren
id|my_idx
)paren
suffix:semicolon
multiline_comment|/* Map the data portion, if any. */
id|sges_left
op_assign
id|SCpnt-&gt;use_sg
suffix:semicolon
r_if
c_cond
(paren
id|sges_left
)paren
(brace
id|sges_left
op_assign
id|pci_map_sg
c_func
(paren
id|hd-&gt;ioc-&gt;pcidev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
comma
id|sges_left
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|SCpnt-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;request_bufflen
)paren
(brace
id|dma_addr_t
id|buf_dma_addr
suffix:semicolon
id|buf_dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|hd-&gt;ioc-&gt;pcidev
comma
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|SCpnt-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
multiline_comment|/* We hide it here for later unmap. */
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|buf_dma_addr
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Put together a MPT SCSI request...&n;&t; */
multiline_comment|/* Assume SimpleQ, NO DATA XFER for now */
id|len
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|sgdir
op_assign
l_int|0x00000000
suffix:semicolon
multiline_comment|/* SGL IN  (host&lt;--ioc) */
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_NODATATRANSFER
suffix:semicolon
multiline_comment|/*&n;&t; *  The scsi layer should be handling this stuff&n;&t; *  (In 2.3.x it does -DaveM)&n;&t; */
multiline_comment|/*  BUG FIX!  19991030 -sralston&n;&t; *    TUR&squot;s being issued with scsictl=0x02000000 (DATA_IN)!&n;&t; *    Seems we may receive a buffer (len&gt;0) even when there&n;&t; *    will be no data transfer!  GRRRRR...&n;&t; */
id|datadir
op_assign
id|mptscsih_io_direction
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datadir
OL
l_int|0
)paren
(brace
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
multiline_comment|/* DATA IN  (host&lt;--ioc&lt;--dev) */
)brace
r_else
r_if
c_cond
(paren
id|datadir
OG
l_int|0
)paren
(brace
id|sgdir
op_assign
l_int|0x04000000
suffix:semicolon
multiline_comment|/* SGL OUT  (host--&gt;ioc) */
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
multiline_comment|/* DATA OUT (host--&gt;ioc--&gt;dev) */
)brace
r_else
(brace
id|len
op_assign
l_int|0
suffix:semicolon
)brace
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_SIMPLEQ
suffix:semicolon
multiline_comment|/*&n;&t; *  Attach tags to the devices&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;tagged_supported
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Some drives are too stupid to handle fairness issues&n;&t;&t; *  with tagged queueing. We throw in the odd ordered&n;&t;&t; *  tag to stop them starving themselves.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|hd-&gt;qtag_tick
)paren
OG
(paren
l_int|5
op_star
id|HZ
)paren
)paren
(brace
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_ORDEREDQ
suffix:semicolon
id|hd-&gt;qtag_tick
op_assign
id|jiffies
suffix:semicolon
macro_line|#if 0
multiline_comment|/* These are ALWAYS zero!&n;&t;&t;&t; * (Because this is a place for the device driver to dynamically&n;&t;&t;&t; *  assign tag numbers any way it sees fit.  That&squot;s why -DaveM)&n;&t;&t;&t; */
id|dprintk
c_func
(paren
(paren
id|KERN_DEBUG
id|MYNAM
l_string|&quot;: sc-&gt;device-&gt;current_tag = %08x&bslash;n&quot;
comma
id|SCpnt-&gt;device-&gt;current_tag
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_DEBUG
id|MYNAM
l_string|&quot;: sc-&gt;tag                 = %08x&bslash;n&quot;
comma
id|SCpnt-&gt;tag
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if 0
r_else
(brace
multiline_comment|/* Hmmm...  I always see value of 0 here,&n;&t;&t;&t; *  of which {HEAD_OF, ORDERED, SIMPLE} are NOT!  -sralston&n;&t;&t;&t; * (Because this is a place for the device driver to dynamically&n;&t;&t;&t; *  assign tag numbers any way it sees fit.  That&squot;s why -DaveM)&n;&t;&t;&t; *&n;&t;&t;&t; * if (SCpnt-&gt;tag == HEAD_OF_QUEUE_TAG)&n;&t;&t;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;current_tag
op_eq
id|HEAD_OF_QUEUE_TAG
)paren
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_HEADOFQ
suffix:semicolon
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;tag
op_eq
id|ORDERED_QUEUE_TAG
)paren
id|qtag
op_assign
id|MPI_SCSIIO_CONTROL_ORDEREDQ
suffix:semicolon
)brace
macro_line|#endif
)brace
id|scsictl
op_assign
id|scsidir
op_or
id|qtag
suffix:semicolon
id|frm_sz
op_assign
id|hd-&gt;ioc-&gt;req_sz
suffix:semicolon
multiline_comment|/* Ack!&n;&t; * sge_spill1 = 9;&n;&t; */
id|sge_spill1
op_assign
(paren
id|frm_sz
op_minus
(paren
r_sizeof
(paren
id|SCSIIORequest_t
)paren
op_minus
r_sizeof
(paren
id|SGEIOUnion_t
)paren
op_plus
r_sizeof
(paren
id|SGEChain32_t
)paren
)paren
)paren
op_div
l_int|8
suffix:semicolon
multiline_comment|/*  spill1: for req_sz == 128 (128-48==80, 80/8==10 SGEs max, first time!), --&gt; use 9&n;&t; *  spill1: for req_sz ==  96 ( 96-48==48, 48/8== 6 SGEs max, first time!), --&gt; use 5&n;&t; */
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: %x     spill1 = %d&bslash;n&quot;
comma
id|my_idx
comma
id|sge_spill1
)paren
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG
r_if
c_cond
(paren
id|sges_left
OG
id|max_sges
)paren
(brace
id|max_sges
op_assign
id|sges_left
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT_MaxSges = %d&bslash;n&quot;
comma
id|max_sges
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if 0
r_if
c_cond
(paren
id|sges_left
OG
id|max_num_sges
)paren
(brace
id|max_num_sges
op_assign
id|sges_left
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT_MaxNumSges = %d&bslash;n&quot;
comma
id|max_num_sges
)paren
suffix:semicolon
)brace
macro_line|#endif
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: %x     sges_left = %d (initially)&bslash;n&quot;
comma
id|my_idx
comma
id|sges_left
)paren
)paren
suffix:semicolon
id|chain_offset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sges_left
OG
(paren
id|sge_spill1
op_plus
l_int|1
)paren
)paren
(brace
macro_line|#if 0
id|chain_offset
op_assign
l_int|0x1E
suffix:semicolon
macro_line|#endif
id|chain_offset
op_assign
(paren
id|frm_sz
op_minus
l_int|8
)paren
op_div
l_int|4
suffix:semicolon
)brace
id|pScsiReq-&gt;TargetID
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|pScsiReq-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
id|pScsiReq-&gt;ChainOffset
op_assign
id|chain_offset
suffix:semicolon
id|pScsiReq-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_IO_REQUEST
suffix:semicolon
id|pScsiReq-&gt;CDBLength
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
multiline_comment|/* We have 256 bytes alloc&squot;d per IO; let&squot;s use it. */
multiline_comment|/*&t;pScsiReq-&gt;SenseBufferLength = SNS_LEN(SCpnt);&t;*/
id|pScsiReq-&gt;SenseBufferLength
op_assign
l_int|255
suffix:semicolon
id|pScsiReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|scsictl
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Write SCSI CDB into the message&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|pScsiReq-&gt;CDB
(braket
id|i
)braket
op_assign
id|SCpnt-&gt;cmnd
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|12
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|pScsiReq-&gt;CDB
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DataLength */
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|len
)paren
suffix:semicolon
multiline_comment|/* SenseBuffer low address */
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|hd-&gt;ioc-&gt;sense_buf_pool_dma
op_plus
(paren
id|my_idx
op_star
l_int|256
)paren
)paren
suffix:semicolon
id|mptr
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|pScsiReq-&gt;SGL
suffix:semicolon
multiline_comment|/*&n;&t; *  Now fill in the SGList...&n;&t; *  NOTES: For 128 byte req_sz, we can hold up to 10 simple SGE&squot;s&n;&t; *  in the remaining request frame.  We -could- do unlimited chains&n;&t; *  but each chain buffer can only be req_sz bytes in size, and&n;&t; *  we lose one SGE whenever we chain.&n;&t; *  For 128 req_sz, we can hold up to 16 SGE&squot;s per chain buffer.&n;&t; *  For practical reasons, limit ourselves to 1 overflow chain buffer;&n;&t; *  giving us 9 + 16 == 25 SGE&squot;s max.&n;&t; *  At 4 Kb per SGE, that yields 100 Kb max transfer.&n;&t; *&n;&t; *  (This code needs to be completely changed when/if 64-bit DMA&n;&t; *   addressing is used, since we will be able to fit much less than&n;&t; *   10 embedded SG entries. -DaveM)&n;&t; */
r_if
c_cond
(paren
id|sges_left
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|u32
id|v1
comma
id|v2
suffix:semicolon
r_int
id|sge_spill2
suffix:semicolon
r_int
id|sge_cur_spill
suffix:semicolon
r_int
id|sgCnt
suffix:semicolon
id|u8
op_star
id|pSgBucket
suffix:semicolon
r_int
id|chain_sz
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&t;sge_spill2 = 15;&n;&t;&t; *  spill2: for req_sz == 128 (128/8==16 SGEs max, first time!), --&gt; use 15&n;&t;&t; *  spill2: for req_sz ==  96 ( 96/8==12 SGEs max, first time!), --&gt; use 11&n;&t;&t; */
id|sge_spill2
op_assign
id|frm_sz
op_div
l_int|8
op_minus
l_int|1
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: %x     spill2 = %d&bslash;n&quot;
comma
id|my_idx
comma
id|sge_spill2
)paren
)paren
suffix:semicolon
id|pSgBucket
op_assign
l_int|NULL
suffix:semicolon
id|sgCnt
op_assign
l_int|0
suffix:semicolon
id|sge_cur_spill
op_assign
id|sge_spill1
suffix:semicolon
r_while
c_loop
(paren
id|sges_left
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
OG
id|max_sgent_len
)paren
(brace
id|max_sgent_len
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT_MaxSgentLen = %d&bslash;n&quot;
comma
id|max_sgent_len
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Write one simple SGE */
id|v1
op_assign
id|sgdir
op_or
l_int|0x10000000
op_or
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
id|len
op_add_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
id|v2
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: %x     Writing SGE @%p: %08x %08x, sges_left=%d&bslash;n&quot;
comma
id|my_idx
comma
id|mptr
comma
id|v1
comma
id|v2
comma
id|sges_left
)paren
)paren
suffix:semicolon
op_star
id|mptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|v1
)paren
suffix:semicolon
op_star
id|mptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|v2
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
id|sgCnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|sges_left
op_eq
l_int|0
)paren
(brace
multiline_comment|/* re-write 1st word of previous SGE with SIMPLE,&n;&t;&t;&t;&t; * LE, EOB, and EOL bits!&n;&t;&t;&t;&t; */
id|v1
op_assign
l_int|0xD1000000
op_or
id|sgdir
op_or
id|sg_dma_len
c_func
(paren
id|sg
op_minus
l_int|1
)paren
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: %x (re)Writing SGE @%p: %08x (VERY LAST SGE!)&bslash;n&quot;
comma
id|my_idx
comma
id|mptr
op_minus
l_int|2
comma
id|v1
)paren
)paren
suffix:semicolon
op_star
(paren
id|mptr
op_minus
l_int|2
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|v1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|sges_left
OG
l_int|1
)paren
op_logical_and
(paren
(paren
id|sgCnt
op_mod
id|sge_cur_spill
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: %x     SG spill at modulo 0!&bslash;n&quot;
comma
id|my_idx
)paren
)paren
suffix:semicolon
multiline_comment|/* Fixup previous SGE with LE bit! */
id|v1
op_assign
id|sgdir
op_or
l_int|0x90000000
op_or
id|sg_dma_len
c_func
(paren
id|sg
op_minus
l_int|1
)paren
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: %x (re)Writing SGE @%p: %08x (LAST BUCKET SGE!)&bslash;n&quot;
comma
id|my_idx
comma
id|mptr
op_minus
l_int|2
comma
id|v1
)paren
)paren
suffix:semicolon
op_star
(paren
id|mptr
op_minus
l_int|2
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|v1
)paren
suffix:semicolon
id|chain_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Going to need another chain? */
r_if
c_cond
(paren
id|sges_left
OG
(paren
id|sge_spill2
op_plus
l_int|1
)paren
)paren
(brace
macro_line|#if 0
id|chain_offset
op_assign
l_int|0x1E
suffix:semicolon
macro_line|#endif
id|chain_offset
op_assign
(paren
id|frm_sz
op_minus
l_int|8
)paren
op_div
l_int|4
suffix:semicolon
id|chain_sz
op_assign
id|frm_sz
suffix:semicolon
)brace
r_else
(brace
id|chain_sz
op_assign
id|sges_left
op_star
l_int|8
suffix:semicolon
)brace
multiline_comment|/* write chain SGE at mptr. */
id|v1
op_assign
l_int|0x30000000
op_or
id|chain_offset
op_lshift
l_int|16
op_or
id|chain_sz
suffix:semicolon
r_if
c_cond
(paren
id|pSgBucket
op_eq
l_int|NULL
)paren
(brace
id|pSgBucket
op_assign
id|hd-&gt;SgHunks
op_plus
(paren
id|my_idx
op_star
id|frm_sz
op_star
id|MPT_SG_BUCKETS_PER_HUNK
)paren
suffix:semicolon
)brace
r_else
(brace
id|pSgBucket
op_add_assign
id|frm_sz
suffix:semicolon
)brace
id|v2
op_assign
(paren
id|hd-&gt;SgHunksDMA
op_plus
(paren
(paren
id|u8
op_star
)paren
id|pSgBucket
op_minus
(paren
id|u8
op_star
)paren
id|hd-&gt;SgHunks
)paren
)paren
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: %x     Writing SGE @%p: %08x %08x (CHAIN!)&bslash;n&quot;
comma
id|my_idx
comma
id|mptr
comma
id|v1
comma
id|v2
)paren
)paren
suffix:semicolon
op_star
(paren
id|mptr
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|v1
)paren
suffix:semicolon
op_star
(paren
id|mptr
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|v2
)paren
suffix:semicolon
id|mptr
op_assign
(paren
id|u32
op_star
)paren
id|pSgBucket
suffix:semicolon
id|sgCnt
op_assign
l_int|0
suffix:semicolon
id|sge_cur_spill
op_assign
id|sge_spill2
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SG: non-SG for %p, len=%d&bslash;n&quot;
comma
id|SCpnt
comma
id|SCpnt-&gt;request_bufflen
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|dma_addr_t
id|buf_dma_addr
suffix:semicolon
id|buf_dma_addr
op_assign
(paren
id|dma_addr_t
)paren
(paren
r_int
r_int
)paren
id|SCpnt-&gt;SCp.ptr
suffix:semicolon
op_star
(paren
id|mptr
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xD1000000
op_or
id|sgdir
op_or
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
op_star
(paren
id|mptr
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|buf_dma_addr
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef MPT_DEBUG
multiline_comment|/* if (SCpnt-&gt;request_bufflen &gt; max_xfer) */
r_if
c_cond
(paren
id|len
OG
id|max_xfer
)paren
(brace
id|max_xfer
op_assign
id|len
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT_MaxXfer = %d&bslash;n&quot;
comma
id|max_xfer
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|hd-&gt;ScsiLookup
(braket
id|my_idx
)braket
op_assign
id|SCpnt
suffix:semicolon
multiline_comment|/* Main banana... */
id|mpt_put_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc-&gt;id
comma
id|mf
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
OG
id|max_qd
)paren
(brace
id|max_qd
op_assign
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Queue depth now %d.&bslash;n&quot;
comma
id|max_qd
)paren
)paren
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Issued SCSI cmd (%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MPT_SCSI_USE_NEW_EH&t;&t;/* { */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    mptscsih_abort&n;    Returns: 0=SUCCESS, else FAILED&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_abort - Abort linux Scsi_Cmnd routine, new_eh variant&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO to be aborted&n; *&n; *&t;(linux Scsi_Host_Template.eh_abort_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.  &n; */
r_int
DECL|function|mptscsih_abort
id|mptscsih_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTm
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
id|u32
id|ctx2abort
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Attempting _ABORT SCSI IO (=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOs outstanding = %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;SCpnt-&gt;result = DID_SOFT_ERROR &lt;&lt; 16;&t;*/
id|SCpnt-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|pScsiTm
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|mf
suffix:semicolon
id|pScsiTm-&gt;TargetID
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|pScsiTm-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
id|pScsiTm-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:semicolon
id|pScsiTm-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskType
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
suffix:semicolon
id|pScsiTm-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u8
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
id|val
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
id|pScsiTm-&gt;LUN
(braket
id|i
)braket
op_assign
id|val
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|pScsiTm-&gt;Reserved2
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Most important!  Set TaskMsgContext to SCpnt&squot;s MsgContext!&n;&t; * (the IO to be ABORT&squot;d)&n;&t; *&n;&t; * NOTE: Since we do not byteswap MsgContext, we do not&n;&t; *&t; swap it here either.  It is an opaque cookie to&n;&t; *&t; the controller, so it does not matter. -DaveM&n;&t; */
id|ctx2abort
op_assign
id|SCPNT_TO_MSGCTX
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;:DbG: ctx2abort = %08x&bslash;n&quot;
comma
id|ctx2abort
)paren
)paren
suffix:semicolon
id|pScsiTm-&gt;TaskMsgContext
op_assign
id|ctx2abort
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* MPI v0.10 requires SCSITaskMgmt requests be sent via Doorbell/handshake&n;&t;mpt_put_msg_frame(hd-&gt;ioc-&gt;id, mf);&n;*/
multiline_comment|/* FIXME!  Check return status! */
(paren
r_void
)paren
id|mpt_send_handshake_request
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
id|msg
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_bus_reset - Perform a SCSI BUS_RESET!&t;new_eh variant&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO which reset is due to&n; *&n; *&t;(linux Scsi_Host_Template.eh_bus_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_int
DECL|function|mptscsih_bus_reset
id|mptscsih_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTm
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Attempting _BUS_RESET (%p)&bslash;n&quot;
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOs outstanding = %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;SCpnt-&gt;result = DID_SOFT_ERROR &lt;&lt; 16;&t;*/
id|SCpnt-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|pScsiTm
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|mf
suffix:semicolon
id|pScsiTm-&gt;TargetID
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|pScsiTm-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
id|pScsiTm-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:semicolon
id|pScsiTm-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskType
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
suffix:semicolon
id|pScsiTm-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|pScsiTm-&gt;LUN
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Control: No data direction, set task mgmt bit? */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|pScsiTm-&gt;Reserved2
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskMsgContext
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* MPI v0.10 requires SCSITaskMgmt requests be sent via Doorbell/handshake&n;&t;mpt_put_msg_frame(hd-&gt;ioc-&gt;id, mf);&n;*/
multiline_comment|/* FIXME!  Check return status! */
(paren
r_void
)paren
id|mpt_send_handshake_request
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
id|msg
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_dev_reset - Perform a SCSI TARGET_RESET!  new_eh variant&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO which reset is due to&n; *&n; *&t;(linux Scsi_Host_Template.eh_dev_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_int
DECL|function|mptscsih_dev_reset
id|mptscsih_dev_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTm
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Attempting _TARGET_RESET (%p)&bslash;n&quot;
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOs outstanding = %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;SCpnt-&gt;result = DID_SOFT_ERROR &lt;&lt; 16;&t;*/
id|SCpnt-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|pScsiTm
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
id|msg
op_assign
(paren
id|u32
op_star
)paren
id|mf
suffix:semicolon
id|pScsiTm-&gt;TargetID
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|pScsiTm-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
id|pScsiTm-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:semicolon
id|pScsiTm-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskType
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET
suffix:semicolon
id|pScsiTm-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* _TARGET_RESET goes to LUN 0 always! */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|pScsiTm-&gt;LUN
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Control: No data direction, set task mgmt bit? */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|pScsiTm-&gt;Reserved2
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskMsgContext
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* MPI v0.10 requires SCSITaskMgmt requests be sent via Doorbell/handshake&n;&t;mpt_put_msg_frame(hd-&gt;ioc-&gt;id, mf);&n;*/
multiline_comment|/* FIXME!  Check return status! */
(paren
r_void
)paren
id|mpt_send_handshake_request
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
id|msg
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
macro_line|#if 0&t;/* { */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_host_reset - Perform a SCSI host adapter RESET!&n; *&t;new_eh variant&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO which reset is due to&n; *&n; *&t;(linux Scsi_Host_Template.eh_host_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_int
id|mptscsih_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_return
id|FAILED
suffix:semicolon
)brace
macro_line|#endif&t;/* } */
macro_line|#else&t;&t;/* MPT_SCSI old EH stuff... */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_old_abort - Abort linux Scsi_Cmnd routine&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO to be aborted&n; *&n; *&t;(linux Scsi_Host_Template.abort routine)&n; *&n; *&t;Returns SCSI_ABORT_{SUCCESS,BUSY,PENDING}.&n; */
r_int
DECL|function|mptscsih_old_abort
id|mptscsih_old_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_struct
id|tq_struct
op_star
id|ptaskfoo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Scheduling _ABORT SCSI IO (=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOs outstanding = %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Check to see if there&squot;s already an ABORT queued for this guy.&n;&t; */
id|mf
op_assign
id|search_taskQ
c_func
(paren
l_int|0
comma
id|SCpnt
comma
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_ne
l_int|NULL
)paren
(brace
r_return
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;SCpnt-&gt;result = DID_SOFT_ERROR &lt;&lt; 16;&t;*/
id|SCpnt-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_BUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Add ourselves to (end of) mpt_scsih_taskQ.&n;&t; *  Check to see if our _bh is running.  If NOT, schedule it.&n;&t; */
id|dslprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: spinlock#2&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|mpt_scsih_taskQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|mpt_scsih_taskQ_cnt
op_increment
suffix:semicolon
multiline_comment|/* Yikes - linkage! */
multiline_comment|/*&t;SCpnt-&gt;host_scribble = (unsigned char *)mf;&t;*/
id|mf-&gt;u.frame.linkage.arg1
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
suffix:semicolon
id|mf-&gt;u.frame.linkage.argp1
op_assign
id|SCpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mpt_scsih_taskQ_bh_active
)paren
(brace
id|mpt_scsih_taskQ_bh_active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Oh how cute, no alloc/free/mgmt needed if we use&n;&t;&t; *  (bottom/unused portion of) MPT request frame.&n;&t;&t; */
id|ptaskfoo
op_assign
(paren
r_struct
id|tq_struct
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|mf
op_plus
id|hd-&gt;ioc-&gt;req_sz
op_minus
r_sizeof
(paren
op_star
id|ptaskfoo
)paren
)paren
suffix:semicolon
id|ptaskfoo-&gt;sync
op_assign
l_int|0
suffix:semicolon
id|ptaskfoo-&gt;routine
op_assign
id|mptscsih_taskmgmt_bh
suffix:semicolon
id|ptaskfoo-&gt;data
op_assign
id|SCpnt
suffix:semicolon
id|SCHEDULE_TASK
c_func
(paren
id|ptaskfoo
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_old_reset - Perform a SCSI BUS_RESET!&n; *&t;@SCpnt: Pointer to Scsi_Cmnd structure, IO which reset is due to&n; *&t;@reset_flags: (not used?)&n; *&n; *&t;(linux Scsi_Host_Template.reset routine)&n; *&n; *&t;Returns SCSI_RESET_{SUCCESS,PUNT,PENDING}.&n; */
r_int
DECL|function|mptscsih_old_reset
id|mptscsih_old_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|reset_flags
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_struct
id|tq_struct
op_star
id|ptaskfoo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Scheduling _BUS_RESET (=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOs outstanding = %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Check to see if there&squot;s already a BUS_RESET queued for this guy.&n;&t; */
id|mf
op_assign
id|search_taskQ
c_func
(paren
l_int|0
comma
id|SCpnt
comma
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_ne
l_int|NULL
)paren
(brace
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;SCpnt-&gt;result = DID_SOFT_ERROR &lt;&lt; 16;&t;*/
id|SCpnt-&gt;result
op_assign
id|STS_BUSY
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_RESET_PUNT
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Add ourselves to (end of) mpt_scsih_taskQ.&n;&t; *  Check to see if our _bh is running.  If NOT, schedule it.&n;&t; */
id|dslprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: spinlock#3&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|Q_ADD_TAIL
c_func
(paren
op_amp
id|mpt_scsih_taskQ
comma
op_amp
id|mf-&gt;u.frame.linkage
comma
id|MPT_FRAME_HDR
)paren
suffix:semicolon
id|mpt_scsih_taskQ_cnt
op_increment
suffix:semicolon
multiline_comment|/* Yikes - linkage! */
multiline_comment|/*&t;SCpnt-&gt;host_scribble = (unsigned char *)mf;&t;*/
id|mf-&gt;u.frame.linkage.arg1
op_assign
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
suffix:semicolon
id|mf-&gt;u.frame.linkage.argp1
op_assign
id|SCpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mpt_scsih_taskQ_bh_active
)paren
(brace
id|mpt_scsih_taskQ_bh_active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Oh how cute, no alloc/free/mgmt needed if we use&n;&t;&t; *  (bottom/unused portion of) MPT request frame.&n;&t;&t; */
id|ptaskfoo
op_assign
(paren
r_struct
id|tq_struct
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|mf
op_plus
id|hd-&gt;ioc-&gt;req_sz
op_minus
r_sizeof
(paren
op_star
id|ptaskfoo
)paren
)paren
suffix:semicolon
id|ptaskfoo-&gt;sync
op_assign
l_int|0
suffix:semicolon
id|ptaskfoo-&gt;routine
op_assign
id|mptscsih_taskmgmt_bh
suffix:semicolon
id|ptaskfoo-&gt;data
op_assign
id|SCpnt
suffix:semicolon
id|SCHEDULE_TASK
c_func
(paren
id|ptaskfoo
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|SCSI_RESET_PENDING
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_taskmgmt_bh - SCSI task mgmt bottom half handler&n; *&t;@sc: (unused)&n; *&n; *&t;This routine (thread) is active whenever there are any outstanding&n; *&t;SCSI task management requests for a SCSI host adapter.&n; *&t;IMPORTANT!  This routine is scheduled therefore should never be&n; *&t;running in ISR context.  i.e., it&squot;s safe to sleep here.&n; */
r_void
DECL|function|mptscsih_taskmgmt_bh
id|mptscsih_taskmgmt_bh
c_func
(paren
r_void
op_star
id|sc
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTm
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|u32
id|ctx2abort
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|task_type
suffix:semicolon
id|dslprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: spinlock#4&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|mpt_scsih_taskQ_bh_active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t; *  We MUST remove item from taskQ *before* we format the&n;&t;&t; *  frame as a SCSITaskMgmt request and send it down to the IOC.&n;&t;&t; */
id|dslprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: spinlock#5&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Q_IS_EMPTY
c_func
(paren
op_amp
id|mpt_scsih_taskQ
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mf
op_assign
id|mpt_scsih_taskQ.head
suffix:semicolon
id|Q_DEL_ITEM
c_func
(paren
op_amp
id|mf-&gt;u.frame.linkage
)paren
suffix:semicolon
id|mpt_scsih_taskQ_cnt
op_decrement
suffix:semicolon
id|mpt_scsih_active_taskmgmt_mf
op_assign
id|mf
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|SCpnt
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|mf-&gt;u.frame.linkage.argp1
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR: TaskMgmt has NULL SCpnt! (%p:%p)&bslash;n&quot;
comma
id|mf
comma
id|SCpnt
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pScsiTm
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pScsiTm-&gt;LUN
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|task_type
op_assign
id|mf-&gt;u.frame.linkage.arg1
suffix:semicolon
r_if
c_cond
(paren
id|task_type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Attempting _ABORT SCSI IO! (mf:sc=%p:%p)&bslash;n&quot;
comma
id|mf
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Most important!  Set TaskMsgContext to SCpnt&squot;s MsgContext!&n;&t;&t;&t; * (the IO to be ABORT&squot;d)&n;&t;&t;&t; *&n;&t;&t;&t; * NOTE: Since we do not byteswap MsgContext, we do not&n;&t;&t;&t; *&t; swap it here either.  It is an opaque cookie to&n;&t;&t;&t; *&t; the controller, so it does not matter. -DaveM&n;&t;&t;&t; */
id|ctx2abort
op_assign
id|SCPNT_TO_MSGCTX
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|pScsiTm-&gt;LUN
(braket
l_int|1
)braket
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|task_type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: Attempting _BUS_RESET! (against SCSI IO mf:sc=%p:%p)&bslash;n&quot;
comma
id|mf
comma
id|SCpnt
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_else
r_if
c_cond
(paren
id|task_type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET
)paren
(brace
)brace
r_else
r_if
c_cond
(paren
id|task_type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_ABRT_TASK_SET
)paren
(brace
)brace
macro_line|#endif
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOs outstanding = %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue_depth
)paren
)paren
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;host-&gt;hostdata
suffix:semicolon
id|pScsiTm-&gt;TargetID
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|pScsiTm-&gt;Bus
op_assign
id|hd-&gt;port
suffix:semicolon
id|pScsiTm-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:semicolon
id|pScsiTm-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskType
op_assign
id|task_type
suffix:semicolon
id|pScsiTm-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|pScsiTm-&gt;Reserved2
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;:DbG: ctx2abort = %08x&bslash;n&quot;
comma
id|ctx2abort
)paren
)paren
suffix:semicolon
id|pScsiTm-&gt;TaskMsgContext
op_assign
id|ctx2abort
suffix:semicolon
multiline_comment|/* Control: No data direction, set task mgmt bit? */
multiline_comment|/*&n;&t;&t; *  As of MPI v0.10 this request can NOT be sent (normally)&n;&t;&t; *  via FIFOs.&t;So we can&squot;t:&n;&t;&t; *&t;&t;mpt_put_msg_frame(ScsiTaskCtx, hd-&gt;ioc-&gt;id, mf);&n;&t;&t; *  SCSITaskMgmt requests MUST be sent ONLY via&n;&t;&t; *  Doorbell/handshake now.   :-(&n;&t;&t; *&n;&t;&t; *  FIXME!  Check return status!&n;&t;&t; */
(paren
r_void
)paren
id|mpt_send_handshake_request
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc-&gt;id
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
(paren
id|u32
op_star
)paren
id|mf
)paren
suffix:semicolon
multiline_comment|/* Spin-Wait for TaskMgmt complete!!! */
r_while
c_loop
(paren
id|mpt_scsih_active_taskmgmt_mf
op_ne
l_int|NULL
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
)brace
)brace
id|dslprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: spinlock#6&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|mpt_scsih_taskQ_bh_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif&t;&t;/* } */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_taskmgmt_complete - Callback routine, gets registered to&n; *&t;Fusion MPT base&t;driver&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to SCSI task mgmt request frame&n; *&t;@r: Pointer to SCSI task mgmt reply frame&n; *&n; *&t;This routine is called from mptbase.c::mpt_interrupt() at the completion&n; *&t;of any SCSI task management request.&n; *&t;This routine is registered with the MPT (base) driver at driver&n; *&t;load/init time via the mpt_register() API call.&n; *&n; *&t;Returns 1 indicating alloc&squot;d request frame ptr should be freed.&n; */
r_static
r_int
DECL|function|mptscsih_taskmgmt_complete
id|mptscsih_taskmgmt_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
(brace
id|SCSITaskMgmtReply_t
op_star
id|pScsiTmReply
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTmReq
suffix:semicolon
id|u8
id|tmType
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SCSI TaskMgmt completed mf=%p, r=%p&bslash;n&quot;
comma
id|mf
comma
id|r
)paren
)paren
suffix:semicolon
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
id|dslprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: spinlock#7&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* It better be the active one! */
r_if
c_cond
(paren
id|mf
op_ne
id|mpt_scsih_active_taskmgmt_mf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR! Non-active TaskMgmt (=%p) completed!&bslash;n&quot;
comma
id|mf
)paren
suffix:semicolon
id|mpt_scsih_active_taskmgmt_mf
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef MPT_DEBUG
r_if
c_cond
(paren
(paren
id|mf
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|mf
op_ge
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR! NULL or BAD TaskMgmt ptr (=%p)!&bslash;n&quot;
comma
id|mf
)paren
suffix:semicolon
id|mpt_scsih_active_taskmgmt_mf
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|r
op_ne
l_int|NULL
)paren
(brace
id|pScsiTmReply
op_assign
(paren
id|SCSITaskMgmtReply_t
op_star
)paren
id|r
suffix:semicolon
id|pScsiTmReq
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Figure out if this was ABORT_TASK, TARGET_RESET, or BUS_RESET! */
id|tmType
op_assign
id|pScsiTmReq-&gt;TaskType
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: TaskType = %d&bslash;n&quot;
comma
id|tmType
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: TerminationCount = %d&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;TerminationCount
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Error?  (anything non-zero?) */
r_if
c_cond
(paren
op_star
(paren
id|u32
op_star
)paren
op_amp
id|pScsiTmReply-&gt;Reserved2
(braket
l_int|0
)braket
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SCSI TaskMgmt (%d) - Oops!&bslash;n&quot;
comma
id|tmType
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: IOCStatus = %04xh&bslash;n&quot;
comma
id|le16_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;IOCStatus
)paren
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: IOCLogInfo = %08xh&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;IOCLogInfo
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: SCSI TaskMgmt (%d) SUCCESS!&bslash;n&quot;
comma
id|tmType
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifndef MPT_SCSI_USE_NEW_EH
multiline_comment|/*&n;&t; *  Signal to _bh thread that we finished.&n;&t; */
id|dslprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: spinlock#8&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|mpt_scsih_active_taskmgmt_mf
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpt_scsih_taskQ_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;This is anyones guess quite frankly.&n; */
r_int
DECL|function|mptscsih_bios_param
id|mptscsih_bios_param
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|ip
)paren
(brace
r_int
id|size
suffix:semicolon
id|size
op_assign
id|disk-&gt;capacity
suffix:semicolon
id|ip
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* heads&t;&t;&t;*/
id|ip
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* sectors&t;&t;&t;*/
r_if
c_cond
(paren
(paren
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_rshift
l_int|11
)paren
OG
l_int|1024
)paren
(brace
multiline_comment|/* cylinders, test for big disk */
id|ip
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* heads&t;&t;&t;*/
id|ip
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
multiline_comment|/* sectors&t;&t;&t;*/
id|ip
(braket
l_int|2
)braket
op_assign
id|size
op_div
(paren
l_int|255
op_star
l_int|63
)paren
suffix:semicolon
multiline_comment|/* cylinders&t;&t;&t;*/
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Private routines...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* 19991030 -sralston&n; *  Return absolute SCSI data direction:&n; *     1 = _DATA_OUT&n; *     0 = _DIR_NONE&n; *    -1 = _DATA_IN&n; */
r_static
r_int
DECL|function|mptscsih_io_direction
id|mptscsih_io_direction
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/*  _DATA_OUT commands&t;*/
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_12
suffix:colon
r_case
id|WRITE_LONG
suffix:colon
r_case
id|WRITE_SAME
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
r_case
id|WRITE_VERIFY
suffix:colon
r_case
id|WRITE_VERIFY_12
suffix:colon
r_case
id|COMPARE
suffix:colon
r_case
id|COPY
suffix:colon
r_case
id|COPY_VERIFY
suffix:colon
r_case
id|SEARCH_EQUAL
suffix:colon
r_case
id|SEARCH_HIGH
suffix:colon
r_case
id|SEARCH_LOW
suffix:colon
r_case
id|SEARCH_EQUAL_12
suffix:colon
r_case
id|SEARCH_HIGH_12
suffix:colon
r_case
id|SEARCH_LOW_12
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
r_case
id|MODE_SELECT_10
suffix:colon
r_case
id|LOG_SELECT
suffix:colon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|CHANGE_DEFINITION
suffix:colon
r_case
id|UPDATE_BLOCK
suffix:colon
r_case
id|SET_WINDOW
suffix:colon
r_case
id|MEDIUM_SCAN
suffix:colon
r_case
id|SEND_VOLUME_TAG
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_case
id|PERSISTENT_RESERVE_OUT
suffix:colon
r_case
l_int|0xea
suffix:colon
r_return
l_int|1
suffix:semicolon
multiline_comment|/*  No data transfer commands  */
r_case
id|SEEK_6
suffix:colon
r_case
id|SEEK_10
suffix:colon
r_case
id|RESERVE
suffix:colon
r_case
id|RELEASE
suffix:colon
r_case
id|TEST_UNIT_READY
suffix:colon
r_case
id|START_STOP
suffix:colon
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/*  Conditional data transfer commands&t;*/
r_case
id|FORMAT_UNIT
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x10
)paren
multiline_comment|/* FmtData (data out phase)? */
r_return
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
r_case
id|VERIFY
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x02
)paren
multiline_comment|/* VERIFY:BYTCHK (data out phase)? */
r_return
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
r_case
id|RESERVE_10
suffix:colon
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x03
)paren
multiline_comment|/* RESERSE:{LongID|Extent} (data out phase)? */
r_return
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
macro_line|#if 0
r_case
id|REZERO_UNIT
suffix:colon
multiline_comment|/* (or REWIND) */
r_case
id|SPACE
suffix:colon
r_case
id|ERASE
suffix:colon
r_case
id|ERASE_10
suffix:colon
r_case
id|SYNCHRONIZE_CACHE
suffix:colon
r_case
id|LOCK_UNLOCK_CACHE
suffix:colon
macro_line|#endif
multiline_comment|/*  Must be data _IN!  */
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_void
DECL|function|copy_sense_data
id|copy_sense_data
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
)paren
(brace
id|MPT_SCSI_DEV
op_star
id|mpt_sdev
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|sense_count
op_assign
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;SenseCount
)paren
suffix:semicolon
r_char
id|devFoo
(braket
l_int|32
)braket
suffix:semicolon
id|IO_Info_t
id|thisIo
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_logical_and
id|sc-&gt;device
)paren
id|mpt_sdev
op_assign
(paren
id|MPT_SCSI_DEV
op_star
)paren
id|sc-&gt;device-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|sense_count
)paren
(brace
id|u8
op_star
id|sense_data
suffix:semicolon
r_int
id|req_index
suffix:semicolon
multiline_comment|/* Copy the sense received into the scsi command block. */
id|req_index
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sense_data
op_assign
(paren
(paren
id|u8
op_star
)paren
id|hd-&gt;ioc-&gt;sense_buf_pool
op_plus
(paren
id|req_index
op_star
l_int|256
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|sc-&gt;sense_buffer
comma
id|sense_data
comma
id|SNS_LEN
c_func
(paren
id|sc
)paren
)paren
suffix:semicolon
multiline_comment|/* Cache SenseData for this SCSI device! */
r_if
c_cond
(paren
id|mpt_sdev
)paren
(brace
id|memcpy
c_func
(paren
id|mpt_sdev-&gt;CachedSense.data
comma
id|sense_data
comma
id|sense_count
)paren
suffix:semicolon
id|mpt_sdev-&gt;sense_sz
op_assign
id|sense_count
suffix:semicolon
)brace
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Hmmm... SenseData len=0! (?)&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|thisIo.cdbPtr
op_assign
id|sc-&gt;cmnd
suffix:semicolon
id|thisIo.sensePtr
op_assign
id|sc-&gt;sense_buffer
suffix:semicolon
id|thisIo.SCSIStatus
op_assign
id|pScsiReply-&gt;SCSIStatus
suffix:semicolon
id|thisIo.DoDisplay
op_assign
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|devFoo
comma
l_string|&quot;ioc%d,scsi%d:%d&quot;
comma
id|hd-&gt;ioc-&gt;id
comma
id|sc-&gt;target
comma
id|sc-&gt;lun
)paren
suffix:semicolon
id|thisIo.DevIDStr
op_assign
id|devFoo
suffix:semicolon
multiline_comment|/* fubar */
id|thisIo.dataPtr
op_assign
l_int|NULL
suffix:semicolon
id|thisIo.inqPtr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;device
)paren
(brace
id|thisIo.inqPtr
op_assign
id|sc-&gt;device-&gt;vendor
op_minus
l_int|8
suffix:semicolon
multiline_comment|/* FIXME!!! */
)brace
(paren
r_void
)paren
id|mpt_ScsiHost_ErrorReport
c_func
(paren
op_amp
id|thisIo
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
id|u32
DECL|function|SCPNT_TO_MSGCTX
id|SCPNT_TO_MSGCTX
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sc-&gt;host-&gt;hostdata
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
(braket
id|i
)braket
op_eq
id|sc
)paren
(brace
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|hd-&gt;ioc
comma
id|i
)paren
suffix:semicolon
r_return
id|mf-&gt;u.frame.hwhdr.msgctxu.MsgContext
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* see mptscsih.h */
macro_line|#ifdef MPT_SCSIHOST_NEED_ENTRY_EXIT_HOOKUPS
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|MPT_SCSIHOST
suffix:semicolon
macro_line|#&t;include &quot;../../scsi/scsi_module.c&quot;
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptscsih_event_process
id|mptscsih_event_process
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEvReply
)paren
(brace
id|u8
id|event
op_assign
id|le32_to_cpu
c_func
(paren
id|pEvReply-&gt;Event
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: MPT event (=%02Xh) routed to SCSI host driver!&bslash;n&quot;
comma
id|event
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|MPI_EVENT_UNIT_ATTENTION
suffix:colon
multiline_comment|/* 03 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_IOC_BUS_RESET
suffix:colon
multiline_comment|/* 04 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_EXT_BUS_RESET
suffix:colon
multiline_comment|/* 05 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOGOUT
suffix:colon
multiline_comment|/* 09 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  CHECKME! Don&squot;t think we need to do&n;&t;&t; *  anything for these, but...&n;&t;&t; */
r_case
id|MPI_EVENT_RESCAN
suffix:colon
multiline_comment|/* 06 */
r_case
id|MPI_EVENT_LINK_STATUS_CHANGE
suffix:colon
multiline_comment|/* 07 */
r_case
id|MPI_EVENT_LOOP_STATE_CHANGE
suffix:colon
multiline_comment|/* 08 */
multiline_comment|/*&n;&t;&t; *  CHECKME!  Falling thru...&n;&t;&t; */
r_case
id|MPI_EVENT_NONE
suffix:colon
multiline_comment|/* 00 */
r_case
id|MPI_EVENT_LOG_DATA
suffix:colon
multiline_comment|/* 01 */
r_case
id|MPI_EVENT_STATE_CHANGE
suffix:colon
multiline_comment|/* 02 */
r_case
id|MPI_EVENT_EVENT_CHANGE
suffix:colon
multiline_comment|/* 0A */
r_default
suffix:colon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Ignoring event (=%02Xh)&bslash;n&quot;
comma
id|event
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* currently means nothing really */
)brace
macro_line|#if 0&t;&t;/* { */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;scsiherr.c - Fusion MPT SCSI Host driver error handling/reporting.&n; *&n; *&t;drivers/message/fusion/scsiherr.c&n; */
singleline_comment|//extern const char&t;**mpt_ScsiOpcodesPtr;&t;/* needed by mptscsih.c */
singleline_comment|//extern ASCQ_Table_t&t; *mpt_ASCQ_TablePtr;
singleline_comment|//extern int&t;&t;  mpt_ASCQ_TableSz;
multiline_comment|/*  Lie!  */
mdefine_line|#define MYNAM&t;&quot;mptscsih&quot;
macro_line|#endif&t;&t;/* } */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Private data...&n; */
DECL|variable|mptscsih_ASCQ_TablePtr
r_static
id|ASCQ_Table_t
op_star
id|mptscsih_ASCQ_TablePtr
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* old symsense.c stuff... */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * Private data...&n; * To protect ourselves against those that would pass us bogus pointers&n; */
DECL|variable|dummyInqData
r_static
id|u8
id|dummyInqData
(braket
id|SCSI_STD_INQUIRY_BYTES
)braket
op_assign
(brace
l_int|0x1F
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x1F
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|dummySenseData
r_static
id|u8
id|dummySenseData
(braket
id|SCSI_STD_SENSE_BYTES
)braket
op_assign
(brace
l_int|0x70
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x0A
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|dummyCDB
r_static
id|u8
id|dummyCDB
(braket
l_int|16
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|dummyScsiData
r_static
id|u8
id|dummyScsiData
(braket
l_int|16
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
macro_line|#if 0
r_static
r_const
r_char
op_star
id|PeripheralDeviceTypeString
(braket
l_int|32
)braket
op_assign
(brace
l_string|&quot;Direct-access&quot;
comma
multiline_comment|/* 00h */
l_string|&quot;Sequential-access&quot;
comma
multiline_comment|/* 01h */
l_string|&quot;Printer&quot;
comma
multiline_comment|/* 02h */
l_string|&quot;Processor&quot;
comma
multiline_comment|/* 03h */
multiline_comment|/*&quot;Write-Once-Read-Multiple&quot;,*/
multiline_comment|/* 04h */
l_string|&quot;WORM&quot;
comma
multiline_comment|/* 04h */
l_string|&quot;CD-ROM&quot;
comma
multiline_comment|/* 05h */
l_string|&quot;Scanner&quot;
comma
multiline_comment|/* 06h */
l_string|&quot;Optical memory&quot;
comma
multiline_comment|/* 07h */
l_string|&quot;Media Changer&quot;
comma
multiline_comment|/* 08h */
l_string|&quot;Communications&quot;
comma
multiline_comment|/* 09h */
l_string|&quot;(Graphics arts pre-press)&quot;
comma
multiline_comment|/* 0Ah */
l_string|&quot;(Graphics arts pre-press)&quot;
comma
multiline_comment|/* 0Bh */
l_string|&quot;Array controller&quot;
comma
multiline_comment|/* 0Ch */
l_string|&quot;Enclosure services&quot;
comma
multiline_comment|/* 0Dh */
l_string|&quot;Simplified direct-access&quot;
comma
multiline_comment|/* 0Eh */
l_string|&quot;Reserved-0Fh&quot;
comma
multiline_comment|/* 0Fh */
l_string|&quot;Reserved-10h&quot;
comma
multiline_comment|/* 10h */
l_string|&quot;Reserved-11h&quot;
comma
multiline_comment|/* 11h */
l_string|&quot;Reserved-12h&quot;
comma
multiline_comment|/* 12h */
l_string|&quot;Reserved-13h&quot;
comma
multiline_comment|/* 13h */
l_string|&quot;Reserved-14h&quot;
comma
multiline_comment|/* 14h */
l_string|&quot;Reserved-15h&quot;
comma
multiline_comment|/* 15h */
l_string|&quot;Reserved-16h&quot;
comma
multiline_comment|/* 16h */
l_string|&quot;Reserved-17h&quot;
comma
multiline_comment|/* 17h */
l_string|&quot;Reserved-18h&quot;
comma
multiline_comment|/* 18h */
l_string|&quot;Reserved-19h&quot;
comma
multiline_comment|/* 19h */
l_string|&quot;Reserved-1Ah&quot;
comma
multiline_comment|/* 1Ah */
l_string|&quot;Reserved-1Bh&quot;
comma
multiline_comment|/* 1Bh */
l_string|&quot;Reserved-1Ch&quot;
comma
multiline_comment|/* 1Ch */
l_string|&quot;Reserved-1Dh&quot;
comma
multiline_comment|/* 1Dh */
l_string|&quot;Reserved-1Eh&quot;
comma
multiline_comment|/* 1Eh */
l_string|&quot;Unknown&quot;
multiline_comment|/* 1Fh */
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|ScsiStatusString
r_static
r_char
op_star
id|ScsiStatusString
(braket
)braket
op_assign
(brace
l_string|&quot;GOOD&quot;
comma
multiline_comment|/* 00h */
l_int|NULL
comma
multiline_comment|/* 01h */
l_string|&quot;CHECK CONDITION&quot;
comma
multiline_comment|/* 02h */
l_int|NULL
comma
multiline_comment|/* 03h */
l_string|&quot;CONDITION MET&quot;
comma
multiline_comment|/* 04h */
l_int|NULL
comma
multiline_comment|/* 05h */
l_int|NULL
comma
multiline_comment|/* 06h */
l_int|NULL
comma
multiline_comment|/* 07h */
l_string|&quot;BUSY&quot;
comma
multiline_comment|/* 08h */
l_int|NULL
comma
multiline_comment|/* 09h */
l_int|NULL
comma
multiline_comment|/* 0Ah */
l_int|NULL
comma
multiline_comment|/* 0Bh */
l_int|NULL
comma
multiline_comment|/* 0Ch */
l_int|NULL
comma
multiline_comment|/* 0Dh */
l_int|NULL
comma
multiline_comment|/* 0Eh */
l_int|NULL
comma
multiline_comment|/* 0Fh */
l_string|&quot;INTERMEDIATE&quot;
comma
multiline_comment|/* 10h */
l_int|NULL
comma
multiline_comment|/* 11h */
l_int|NULL
comma
multiline_comment|/* 12h */
l_int|NULL
comma
multiline_comment|/* 13h */
l_string|&quot;INTERMEDIATE-CONDITION MET&quot;
comma
multiline_comment|/* 14h */
l_int|NULL
comma
multiline_comment|/* 15h */
l_int|NULL
comma
multiline_comment|/* 16h */
l_int|NULL
comma
multiline_comment|/* 17h */
l_string|&quot;RESERVATION CONFLICT&quot;
comma
multiline_comment|/* 18h */
l_int|NULL
comma
multiline_comment|/* 19h */
l_int|NULL
comma
multiline_comment|/* 1Ah */
l_int|NULL
comma
multiline_comment|/* 1Bh */
l_int|NULL
comma
multiline_comment|/* 1Ch */
l_int|NULL
comma
multiline_comment|/* 1Dh */
l_int|NULL
comma
multiline_comment|/* 1Eh */
l_int|NULL
comma
multiline_comment|/* 1Fh */
l_int|NULL
comma
multiline_comment|/* 20h */
l_int|NULL
comma
multiline_comment|/* 21h */
l_string|&quot;COMMAND TERMINATED&quot;
comma
multiline_comment|/* 22h */
l_int|NULL
comma
multiline_comment|/* 23h */
l_int|NULL
comma
multiline_comment|/* 24h */
l_int|NULL
comma
multiline_comment|/* 25h */
l_int|NULL
comma
multiline_comment|/* 26h */
l_int|NULL
comma
multiline_comment|/* 27h */
l_string|&quot;TASK SET FULL&quot;
comma
multiline_comment|/* 28h */
l_int|NULL
comma
multiline_comment|/* 29h */
l_int|NULL
comma
multiline_comment|/* 2Ah */
l_int|NULL
comma
multiline_comment|/* 2Bh */
l_int|NULL
comma
multiline_comment|/* 2Ch */
l_int|NULL
comma
multiline_comment|/* 2Dh */
l_int|NULL
comma
multiline_comment|/* 2Eh */
l_int|NULL
comma
multiline_comment|/* 2Fh */
l_string|&quot;ACA ACTIVE&quot;
comma
multiline_comment|/* 30h */
l_int|NULL
)brace
suffix:semicolon
DECL|variable|ScsiCommonOpString
r_static
r_const
r_char
op_star
id|ScsiCommonOpString
(braket
)braket
op_assign
(brace
l_string|&quot;TEST UNIT READY&quot;
comma
multiline_comment|/* 00h */
l_string|&quot;REZERO UNIT (REWIND)&quot;
comma
multiline_comment|/* 01h */
l_int|NULL
comma
multiline_comment|/* 02h */
l_string|&quot;REQUEST_SENSE&quot;
comma
multiline_comment|/* 03h */
l_string|&quot;FORMAT UNIT (MEDIUM)&quot;
comma
multiline_comment|/* 04h */
l_string|&quot;READ BLOCK LIMITS&quot;
comma
multiline_comment|/* 05h */
l_int|NULL
comma
multiline_comment|/* 06h */
l_string|&quot;REASSIGN BLOCKS&quot;
comma
multiline_comment|/* 07h */
l_string|&quot;READ(6)&quot;
comma
multiline_comment|/* 08h */
l_int|NULL
comma
multiline_comment|/* 09h */
l_string|&quot;WRITE(6)&quot;
comma
multiline_comment|/* 0Ah */
l_string|&quot;SEEK(6)&quot;
comma
multiline_comment|/* 0Bh */
l_int|NULL
comma
multiline_comment|/* 0Ch */
l_int|NULL
comma
multiline_comment|/* 0Dh */
l_int|NULL
comma
multiline_comment|/* 0Eh */
l_string|&quot;READ REVERSE&quot;
comma
multiline_comment|/* 0Fh */
l_string|&quot;WRITE_FILEMARKS&quot;
comma
multiline_comment|/* 10h */
l_string|&quot;SPACE(6)&quot;
comma
multiline_comment|/* 11h */
l_string|&quot;INQUIRY&quot;
comma
multiline_comment|/* 12h */
l_int|NULL
)brace
suffix:semicolon
DECL|variable|SenseKeyString
r_static
r_const
r_char
op_star
id|SenseKeyString
(braket
)braket
op_assign
(brace
l_string|&quot;NO SENSE&quot;
comma
multiline_comment|/* 0h */
l_string|&quot;RECOVERED ERROR&quot;
comma
multiline_comment|/* 1h */
l_string|&quot;NOT READY&quot;
comma
multiline_comment|/* 2h */
l_string|&quot;MEDIUM ERROR&quot;
comma
multiline_comment|/* 3h */
l_string|&quot;HARDWARE ERROR&quot;
comma
multiline_comment|/* 4h */
l_string|&quot;ILLEGAL REQUEST&quot;
comma
multiline_comment|/* 5h */
l_string|&quot;UNIT ATTENTION&quot;
comma
multiline_comment|/* 6h */
l_string|&quot;DATA PROTECT&quot;
comma
multiline_comment|/* 7h */
l_string|&quot;BLANK CHECK&quot;
comma
multiline_comment|/* 8h */
l_string|&quot;VENDOR-SPECIFIC&quot;
comma
multiline_comment|/* 9h */
l_string|&quot;ABORTED COPY&quot;
comma
multiline_comment|/* Ah */
l_string|&quot;ABORTED COMMAND&quot;
comma
multiline_comment|/* Bh */
l_string|&quot;EQUAL (obsolete)&quot;
comma
multiline_comment|/* Ch */
l_string|&quot;VOLUME OVERFLOW&quot;
comma
multiline_comment|/* Dh */
l_string|&quot;MISCOMPARE&quot;
comma
multiline_comment|/* Eh */
l_string|&quot;RESERVED&quot;
comma
multiline_comment|/* Fh */
l_int|NULL
)brace
suffix:semicolon
DECL|macro|SPECIAL_ASCQ
mdefine_line|#define SPECIAL_ASCQ(c,q) &bslash;&n;&t;(((c) == 0x40 &amp;&amp; (q) != 0x00) || ((c) == 0x4D) || ((c) == 0x70))
macro_line|#if 0
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Sense_Key_Specific() - If Sense_Key_Specific_Valid bit is set,&n; *&t;&t;&t;   then print additional information via&n; *&t;&t;&t;   a call to SDMS_SystemAlert().&n; *&n; *  Return: nothing&n; */
r_static
r_void
id|Sense_Key_Specific
c_func
(paren
id|IO_Info_t
op_star
id|ioop
comma
r_char
op_star
id|msg1
)paren
(brace
id|u8
op_star
id|sd
suffix:semicolon
id|u8
id|BadValue
suffix:semicolon
id|u8
id|SenseKey
suffix:semicolon
r_int
id|Offset
suffix:semicolon
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|msg1
)paren
suffix:semicolon
id|sd
op_assign
id|ioop-&gt;sensePtr
suffix:semicolon
r_if
c_cond
(paren
id|SD_Additional_Sense_Length
c_func
(paren
id|sd
)paren
OL
l_int|8
)paren
r_return
suffix:semicolon
id|SenseKey
op_assign
id|SD_Sense_Key
c_func
(paren
id|sd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SD_Sense_Key_Specific_Valid
c_func
(paren
id|sd
)paren
)paren
(brace
r_if
c_cond
(paren
id|SenseKey
op_eq
id|SK_ILLEGAL_REQUEST
)paren
(brace
id|Offset
op_assign
id|SD_Bad_Byte
c_func
(paren
id|sd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SD_Was_Illegal_Request
c_func
(paren
id|sd
)paren
)paren
(brace
id|BadValue
op_assign
id|ioop-&gt;cdbPtr
(braket
id|Offset
)braket
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;&bslash;n  Illegal CDB value=%02Xh found at CDB &quot;
comma
id|BadValue
)paren
suffix:semicolon
)brace
r_else
(brace
id|BadValue
op_assign
id|ioop-&gt;dataPtr
(braket
id|Offset
)braket
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;&bslash;n  Illegal DATA value=%02Xh found at DATA &quot;
comma
id|BadValue
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;byte=%02Xh&quot;
comma
id|Offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SD_SKS_Bit_Pointer_Valid
c_func
(paren
id|sd
)paren
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;/bit=%1Xh&quot;
comma
id|SD_SKS_Bit_Pointer
c_func
(paren
id|sd
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|SenseKey
op_eq
id|SK_RECOVERED_ERROR
)paren
op_logical_or
(paren
id|SenseKey
op_eq
id|SK_HARDWARE_ERROR
)paren
op_logical_or
(paren
id|SenseKey
op_eq
id|SK_MEDIUM_ERROR
)paren
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|msg1
op_plus
id|len
comma
l_string|&quot;&bslash;n  Recovery algorithm Actual_Retry_Count=%02Xh&quot;
comma
id|SD_Actual_Retry_Count
c_func
(paren
id|sd
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|dump_cdb
r_static
r_int
id|dump_cdb
c_func
(paren
r_char
op_star
id|foo
comma
r_int
r_char
op_star
id|cdb
)paren
(brace
r_int
id|i
comma
id|grpCode
comma
id|cdbLen
suffix:semicolon
r_int
id|l
op_assign
l_int|0
suffix:semicolon
id|grpCode
op_assign
id|cdb
(braket
l_int|0
)braket
op_rshift
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|grpCode
OL
l_int|1
)paren
id|cdbLen
op_assign
l_int|6
suffix:semicolon
r_else
r_if
c_cond
(paren
id|grpCode
OL
l_int|3
)paren
id|cdbLen
op_assign
l_int|10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|grpCode
op_eq
l_int|5
)paren
id|cdbLen
op_assign
l_int|12
suffix:semicolon
r_else
id|cdbLen
op_assign
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cdbLen
suffix:semicolon
id|i
op_increment
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; %02X&quot;
comma
id|cdb
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|function|dump_sd
r_static
r_int
id|dump_sd
c_func
(paren
r_char
op_star
id|foo
comma
r_int
r_char
op_star
id|sd
)paren
(brace
r_int
id|snsLen
op_assign
l_int|8
op_plus
id|SD_Additional_Sense_Length
c_func
(paren
id|sd
)paren
suffix:semicolon
r_int
id|l
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIN
c_func
(paren
id|snsLen
comma
l_int|18
)paren
suffix:semicolon
id|i
op_increment
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; %02X&quot;
comma
id|sd
(braket
id|i
)braket
)paren
suffix:semicolon
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot;%s&quot;
comma
id|snsLen
OG
l_int|18
ques
c_cond
l_string|&quot; ...&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*  Do ASC/ASCQ lookup/grindage to English readable string(s)  */
DECL|function|ascq_set_strings_4max
r_static
r_const
r_char
op_star
id|ascq_set_strings_4max
c_func
(paren
id|u8
id|ASC
comma
id|u8
id|ASCQ
comma
r_const
r_char
op_star
op_star
id|s1
comma
r_const
r_char
op_star
op_star
id|s2
comma
r_const
r_char
op_star
op_star
id|s3
comma
r_const
r_char
op_star
op_star
id|s4
)paren
(brace
r_static
r_const
r_char
op_star
id|asc_04_part1_string
op_assign
l_string|&quot;LOGICAL UNIT &quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|asc_04_part2a_string
op_assign
l_string|&quot;NOT READY, &quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|asc_04_part2b_string
op_assign
l_string|&quot;IS &quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|asc_04_ascq_NN_part3_strings
(braket
)braket
op_assign
(brace
multiline_comment|/* ASC ASCQ (hex) */
l_string|&quot;CAUSE NOT REPORTABLE&quot;
comma
multiline_comment|/* 04 00 */
l_string|&quot;IN PROCESS OF BECOMING READY&quot;
comma
multiline_comment|/* 04 01 */
l_string|&quot;INITIALIZING CMD. REQUIRED&quot;
comma
multiline_comment|/* 04 02 */
l_string|&quot;MANUAL INTERVENTION REQUIRED&quot;
comma
multiline_comment|/* 04 03 */
multiline_comment|/* Add&t;&quot; IN PROGRESS&quot; to all the following... */
l_string|&quot;FORMAT&quot;
comma
multiline_comment|/* 04 04 */
l_string|&quot;REBUILD&quot;
comma
multiline_comment|/* 04 05 */
l_string|&quot;RECALCULATION&quot;
comma
multiline_comment|/* 04 06 */
l_string|&quot;OPERATION&quot;
comma
multiline_comment|/* 04 07 */
l_string|&quot;LONG WRITE&quot;
comma
multiline_comment|/* 04 08 */
l_string|&quot;SELF-TEST&quot;
comma
multiline_comment|/* 04 09 */
l_int|NULL
)brace
suffix:semicolon
r_static
r_char
op_star
id|asc_04_part4_string
op_assign
l_string|&quot; IN PROGRESS&quot;
suffix:semicolon
r_static
r_char
op_star
id|asc_29_ascq_NN_strings
(braket
)braket
op_assign
(brace
multiline_comment|/* ASC ASCQ (hex) */
l_string|&quot;POWER ON, RESET, OR BUS DEVICE RESET OCCURRED&quot;
comma
multiline_comment|/* 29 00 */
l_string|&quot;POWER ON OCCURRED&quot;
comma
multiline_comment|/* 29 01 */
l_string|&quot;SCSI BUS RESET OCCURRED&quot;
comma
multiline_comment|/* 29 02 */
l_string|&quot;BUS DEVICE RESET FUNCTION OCCURRED&quot;
comma
multiline_comment|/* 29 03 */
l_string|&quot;DEVICE INTERNAL RESET&quot;
comma
multiline_comment|/* 29 04 */
l_string|&quot;TRANSCEIVER MODE CHANGED TO SINGLE-ENDED&quot;
comma
multiline_comment|/* 29 05 */
l_string|&quot;TRANSCEIVER MODE CHANGED TO LVD&quot;
comma
multiline_comment|/* 29 06 */
l_int|NULL
)brace
suffix:semicolon
r_static
r_char
op_star
id|ascq_vendor_uniq
op_assign
l_string|&quot;(Vendor Unique)&quot;
suffix:semicolon
r_static
r_char
op_star
id|ascq_noone
op_assign
l_string|&quot;(no matching ASC/ASCQ description found)&quot;
suffix:semicolon
r_int
id|idx
suffix:semicolon
op_star
id|s1
op_assign
op_star
id|s2
op_assign
op_star
id|s3
op_assign
op_star
id|s4
op_assign
l_string|&quot;&quot;
suffix:semicolon
multiline_comment|/* set&squot;em all to the empty &quot;&quot; string */
multiline_comment|/* CHECKME! Need lock/sem?&n;&t; *  Update and examine for isense module presense.&n;&t; */
id|mptscsih_ASCQ_TablePtr
op_assign
(paren
id|ASCQ_Table_t
op_star
)paren
id|mpt_v_ASCQ_TablePtr
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_ASCQ_TablePtr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* 2nd chances... */
r_if
c_cond
(paren
id|ASC
op_eq
l_int|0x04
op_logical_and
(paren
id|ASCQ
OL
r_sizeof
(paren
id|asc_04_ascq_NN_part3_strings
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
op_minus
l_int|1
)paren
)paren
(brace
op_star
id|s1
op_assign
id|asc_04_part1_string
suffix:semicolon
op_star
id|s2
op_assign
(paren
id|ASCQ
op_eq
l_int|0x01
)paren
ques
c_cond
id|asc_04_part2b_string
suffix:colon
id|asc_04_part2a_string
suffix:semicolon
op_star
id|s3
op_assign
id|asc_04_ascq_NN_part3_strings
(braket
id|ASCQ
)braket
suffix:semicolon
multiline_comment|/* check for &quot; IN PROGRESS&quot; ones */
r_if
c_cond
(paren
id|ASCQ
op_ge
l_int|0x04
)paren
op_star
id|s4
op_assign
id|asc_04_part4_string
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ASC
op_eq
l_int|0x29
op_logical_and
(paren
id|ASCQ
OL
r_sizeof
(paren
id|asc_29_ascq_NN_strings
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
op_minus
l_int|1
)paren
)paren
op_star
id|s1
op_assign
id|asc_29_ascq_NN_strings
(braket
id|ASCQ
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;else { leave all *s[1-4] values pointing to the empty &quot;&quot; string }&n;&t;&t; */
r_return
op_star
id|s1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Need to check ASC here; if it is &quot;special,&quot; then&n;&t; *  the ASCQ is variable, and indicates failed component number.&n;&t; *  We must treat the ASCQ as a &quot;don&squot;t care&quot; while searching the&n;&t; *  mptscsih_ASCQ_Table[] by masking it off, and then restoring it later&n;&t; *  on when we actually need to identify the failed component.&n;&t; */
r_if
c_cond
(paren
id|SPECIAL_ASCQ
c_func
(paren
id|ASC
comma
id|ASCQ
)paren
)paren
id|ASCQ
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/*  OK, now search mptscsih_ASCQ_Table[] for a matching entry  */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|mptscsih_ASCQ_TablePtr
op_logical_and
id|idx
OL
id|mpt_ASCQ_TableSz
suffix:semicolon
id|idx
op_increment
)paren
r_if
c_cond
(paren
(paren
id|ASC
op_eq
id|mptscsih_ASCQ_TablePtr
(braket
id|idx
)braket
dot
id|ASC
)paren
op_logical_and
(paren
id|ASCQ
op_eq
id|mptscsih_ASCQ_TablePtr
(braket
id|idx
)braket
dot
id|ASCQ
)paren
)paren
r_return
(paren
op_star
id|s1
op_assign
id|mptscsih_ASCQ_TablePtr
(braket
id|idx
)braket
dot
id|Description
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ASC
op_ge
l_int|0x80
)paren
op_logical_or
(paren
id|ASCQ
op_ge
l_int|0x80
)paren
)paren
op_star
id|s1
op_assign
id|ascq_vendor_uniq
suffix:semicolon
r_else
op_star
id|s1
op_assign
id|ascq_noone
suffix:semicolon
r_return
op_star
id|s1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  SCSI Error Report; desired output format...&n; *---&n;SCSI Error Report =-=-=-=-=-=-=-=-=-=-=-=-=-= (ioc0,scsi0:0)&n;  SCSI_Status=02h (CHECK CONDITION)&n;  Original_CDB[]: 00 00 00 00 00 00 - TestUnitReady&n;  SenseData[12h]: 70 00 06 00 00 00 00 0A 00 00 00 00 29 00 03 00 00 00&n;  SenseKey=6h (UNIT ATTENTION); FRU=03h&n;  ASC/ASCQ=29h/00h, &quot;POWER ON, RESET, OR BUS DEVICE RESET OCCURRED&quot;&n; *---&n; */
DECL|function|mpt_ScsiHost_ErrorReport
r_int
id|mpt_ScsiHost_ErrorReport
c_func
(paren
id|IO_Info_t
op_star
id|ioop
)paren
(brace
r_char
id|foo
(braket
l_int|512
)braket
suffix:semicolon
r_char
id|buf2
(braket
l_int|32
)braket
suffix:semicolon
r_char
op_star
id|statstr
suffix:semicolon
r_const
r_char
op_star
id|opstr
suffix:semicolon
r_int
id|sk
op_assign
id|SD_Sense_Key
c_func
(paren
id|ioop-&gt;sensePtr
)paren
suffix:semicolon
r_const
r_char
op_star
id|skstr
op_assign
id|SenseKeyString
(braket
id|sk
)braket
suffix:semicolon
r_int
r_char
id|asc
op_assign
id|SD_ASC
c_func
(paren
id|ioop-&gt;sensePtr
)paren
suffix:semicolon
r_int
r_char
id|ascq
op_assign
id|SD_ASCQ
c_func
(paren
id|ioop-&gt;sensePtr
)paren
suffix:semicolon
r_int
id|l
suffix:semicolon
multiline_comment|/*&n;&t; *  More quiet mode.&n;&t; *  Filter out common, repetitive, warning-type errors...  like:&n;&t; *    POWER ON (06,29/00 or 06,29/01),&n;&t; *    SPINNING UP (02,04/01),&n;&t; *    LOGICAL UNIT NOT SUPPORTED (05,25/00), etc.&n;&t; */
r_if
c_cond
(paren
(paren
id|sk
op_eq
id|SK_UNIT_ATTENTION
op_logical_and
id|asc
op_eq
l_int|0x29
op_logical_and
(paren
id|ascq
op_eq
l_int|0x00
op_logical_or
id|ascq
op_eq
l_int|0x01
)paren
)paren
op_logical_or
(paren
id|sk
op_eq
id|SK_NOT_READY
op_logical_and
id|asc
op_eq
l_int|0x04
op_logical_and
id|ascq
op_eq
l_int|0x01
)paren
op_logical_or
(paren
id|sk
op_eq
id|SK_ILLEGAL_REQUEST
op_logical_and
id|asc
op_eq
l_int|0x25
op_logical_and
id|ascq
op_eq
l_int|0x00
)paren
)paren
(brace
multiline_comment|/* Do nothing! */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Protect ourselves...&n;&t; */
r_if
c_cond
(paren
id|ioop-&gt;cdbPtr
op_eq
l_int|NULL
)paren
id|ioop-&gt;cdbPtr
op_assign
id|dummyCDB
suffix:semicolon
r_if
c_cond
(paren
id|ioop-&gt;sensePtr
op_eq
l_int|NULL
)paren
id|ioop-&gt;sensePtr
op_assign
id|dummySenseData
suffix:semicolon
r_if
c_cond
(paren
id|ioop-&gt;inqPtr
op_eq
l_int|NULL
)paren
id|ioop-&gt;inqPtr
op_assign
id|dummyInqData
suffix:semicolon
r_if
c_cond
(paren
id|ioop-&gt;dataPtr
op_eq
l_int|NULL
)paren
id|ioop-&gt;dataPtr
op_assign
id|dummyScsiData
suffix:semicolon
id|statstr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioop-&gt;SCSIStatus
op_ge
r_sizeof
(paren
id|ScsiStatusString
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
op_minus
l_int|1
)paren
op_logical_or
(paren
(paren
id|statstr
op_assign
(paren
r_char
op_star
)paren
id|ScsiStatusString
(braket
id|ioop-&gt;SCSIStatus
)braket
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
(paren
r_void
)paren
id|sprintf
c_func
(paren
id|buf2
comma
l_string|&quot;Bad-Reserved-%02Xh&quot;
comma
id|ioop-&gt;SCSIStatus
)paren
suffix:semicolon
id|statstr
op_assign
id|buf2
suffix:semicolon
)brace
id|opstr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_plus
id|ioop-&gt;cdbPtr
(braket
l_int|0
)braket
op_le
r_sizeof
(paren
id|ScsiCommonOpString
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
)paren
id|opstr
op_assign
id|ScsiCommonOpString
(braket
id|ioop-&gt;cdbPtr
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mpt_ScsiOpcodesPtr
)paren
id|opstr
op_assign
id|mpt_ScsiOpcodesPtr
(braket
id|ioop-&gt;cdbPtr
(braket
l_int|0
)braket
)braket
suffix:semicolon
id|l
op_assign
id|sprintf
c_func
(paren
id|foo
comma
l_string|&quot;SCSI Error Report =-=-= (%s)&bslash;n&quot;
l_string|&quot;  SCSI_Status=%02Xh (%s)&bslash;n&quot;
l_string|&quot;  Original_CDB[]:&quot;
comma
id|ioop-&gt;DevIDStr
comma
id|ioop-&gt;SCSIStatus
comma
id|statstr
)paren
suffix:semicolon
id|l
op_add_assign
id|dump_cdb
c_func
(paren
id|foo
op_plus
id|l
comma
id|ioop-&gt;cdbPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opstr
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; - &bslash;&quot;%s&bslash;&quot;&quot;
comma
id|opstr
)paren
suffix:semicolon
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot;&bslash;n  SenseData[%02Xh]:&quot;
comma
l_int|8
op_plus
id|SD_Additional_Sense_Length
c_func
(paren
id|ioop-&gt;sensePtr
)paren
)paren
suffix:semicolon
id|l
op_add_assign
id|dump_sd
c_func
(paren
id|foo
op_plus
id|l
comma
id|ioop-&gt;sensePtr
)paren
suffix:semicolon
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot;&bslash;n  SenseKey=%Xh (%s); FRU=%02Xh&bslash;n  ASC/ASCQ=%02Xh/%02Xh&quot;
comma
id|sk
comma
id|skstr
comma
id|SD_FRU
c_func
(paren
id|ioop-&gt;sensePtr
)paren
comma
id|asc
comma
id|ascq
)paren
suffix:semicolon
(brace
r_const
r_char
op_star
id|x1
comma
op_star
id|x2
comma
op_star
id|x3
comma
op_star
id|x4
suffix:semicolon
id|x1
op_assign
id|x2
op_assign
id|x3
op_assign
id|x4
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|x1
op_assign
id|ascq_set_strings_4max
c_func
(paren
id|asc
comma
id|ascq
comma
op_amp
id|x1
comma
op_amp
id|x2
comma
op_amp
id|x3
comma
op_amp
id|x4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x1
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|x1
(braket
l_int|0
)braket
op_ne
l_char|&squot;(&squot;
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; &bslash;&quot;%s%s%s%s&bslash;&quot;&quot;
comma
id|x1
comma
id|x2
comma
id|x3
comma
id|x4
)paren
suffix:semicolon
r_else
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; %s%s%s%s&quot;
comma
id|x1
comma
id|x2
comma
id|x3
comma
id|x4
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|SPECIAL_ASCQ
c_func
(paren
id|asc
comma
id|ascq
)paren
)paren
id|l
op_add_assign
id|sprintf
c_func
(paren
id|foo
op_plus
id|l
comma
l_string|&quot; (%02Xh)&quot;
comma
id|ascq
)paren
suffix:semicolon
macro_line|#endif
id|PrintF
c_func
(paren
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|foo
)paren
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
eof
