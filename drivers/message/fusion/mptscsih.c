multiline_comment|/*&n; *  linux/drivers/message/fusion/mptscsih.c&n; *      High performance SCSI / Fibre Channel SCSI Host device driver.&n; *      For use with PCI chip/adapter(s):&n; *          LSIFC9xx/LSI409xx Fibre Channel&n; *      running LSI Logic Fusion MPT (Message Passing Technology) firmware.&n; *&n; *  Credits:&n; *      This driver would not exist if not for Alan Cox&squot;s development&n; *      of the linux i2o driver.&n; *&n; *      A special thanks to Pamela Delaney (LSI Logic) for tons of work&n; *      and countless enhancements while adding support for the 1030&n; *      chip family.  Pam has been instrumental in the development of&n; *      of the 2.xx.xx series fusion drivers, and her contributions are&n; *      far too numerous to hope to list in one place.&n; *&n; *      A huge debt of gratitude is owed to David S. Miller (DaveM)&n; *      for fixing much of the stupid and broken stuff in the early&n; *      driver while porting to sparc64 platform.  THANK YOU!&n; *&n; *      (see mptbase.c)&n; *&n; *  Copyright (c) 1999-2004 LSI Logic Corporation&n; *  Original author: Steven J. Ralston&n; *  (mailto:sjralston1@netscape.net)&n; *  (mailto:mpt_linux_developer@lsil.com)&n; *&n; *  $Id: mptscsih.c,v 1.104 2002/12/03 21:26:34 pdelaney Exp $&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; version 2 of the License.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    NO WARRANTY&n;    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;    solely responsible for determining the appropriateness of using and&n;    distributing the Program and assumes all risks associated with its&n;    exercise of rights under this Agreement, including but not limited to&n;    the risks and costs of program errors, damage to or loss of data,&n;    programs or equipment, and unavailability or interruption of operations.&n;&n;    DISCLAIMER OF LIABILITY&n;    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
macro_line|#include &quot;linux_compat.h&quot;&t;/* linux-2.6 tweaks */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;&t;/* for mdelay */
macro_line|#include &lt;linux/interrupt.h&gt;&t;/* needed for in_interrupt() proto */
macro_line|#include &lt;linux/reboot.h&gt;&t;/* notifier code */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &lt;scsi/scsi_device.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_tcq.h&gt;
macro_line|#include &quot;mptbase.h&quot;
macro_line|#include &quot;mptscsih.h&quot;
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|my_NAME
mdefine_line|#define my_NAME&t;&t;&quot;Fusion MPT SCSI Host driver&quot;
DECL|macro|my_VERSION
mdefine_line|#define my_VERSION&t;MPT_LINUX_VERSION_COMMON
DECL|macro|MYNAM
mdefine_line|#define MYNAM&t;&t;&quot;mptscsih&quot;
DECL|variable|MODULEAUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|MODULEAUTHOR
)paren
suffix:semicolon
DECL|variable|my_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|my_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|dv
r_static
r_int
id|dv
op_assign
id|MPTSCSIH_DOMAIN_VALIDATION
suffix:semicolon
id|module_param
c_func
(paren
id|dv
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dv
comma
l_string|&quot;DV Algorithm: enhanced = 1, basic = 0 (default=MPTSCSIH_DOMAIN_VALIDATION=1)&quot;
)paren
suffix:semicolon
DECL|variable|width
r_static
r_int
id|width
op_assign
id|MPTSCSIH_MAX_WIDTH
suffix:semicolon
id|module_param
c_func
(paren
id|width
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|width
comma
l_string|&quot;Max Bus Width: wide = 1, narrow = 0 (default=MPTSCSIH_MAX_WIDTH=1)&quot;
)paren
suffix:semicolon
DECL|variable|factor
r_static
id|ushort
id|factor
op_assign
id|MPTSCSIH_MIN_SYNC
suffix:semicolon
id|module_param
c_func
(paren
id|factor
comma
id|ushort
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|factor
comma
l_string|&quot;Min Sync Factor: (default=MPTSCSIH_MIN_SYNC=0x08)&quot;
)paren
suffix:semicolon
DECL|variable|saf_te
r_static
r_int
id|saf_te
op_assign
id|MPTSCSIH_SAF_TE
suffix:semicolon
id|module_param
c_func
(paren
id|saf_te
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|saf_te
comma
l_string|&quot;Force enabling SEP Processor: (default=MPTSCSIH_SAF_TE=0)&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|struct|_BIG_SENSE_BUF
r_typedef
r_struct
id|_BIG_SENSE_BUF
(brace
DECL|member|data
id|u8
id|data
(braket
id|MPT_SENSE_BUFFER_ALLOC
)braket
suffix:semicolon
DECL|typedef|BIG_SENSE_BUF
)brace
id|BIG_SENSE_BUF
suffix:semicolon
DECL|macro|MPT_SCANDV_GOOD
mdefine_line|#define MPT_SCANDV_GOOD&t;&t;&t;(0x00000000) /* must be 0 */
DECL|macro|MPT_SCANDV_DID_RESET
mdefine_line|#define MPT_SCANDV_DID_RESET&t;&t;(0x00000001)
DECL|macro|MPT_SCANDV_SENSE
mdefine_line|#define MPT_SCANDV_SENSE&t;&t;(0x00000002)
DECL|macro|MPT_SCANDV_SOME_ERROR
mdefine_line|#define MPT_SCANDV_SOME_ERROR&t;&t;(0x00000004)
DECL|macro|MPT_SCANDV_SELECTION_TIMEOUT
mdefine_line|#define MPT_SCANDV_SELECTION_TIMEOUT&t;(0x00000008)
DECL|macro|MPT_SCANDV_ISSUE_SENSE
mdefine_line|#define MPT_SCANDV_ISSUE_SENSE&t;&t;(0x00000010)
DECL|macro|MPT_SCANDV_FALLBACK
mdefine_line|#define MPT_SCANDV_FALLBACK&t;&t;(0x00000020)
DECL|macro|MPT_SCANDV_MAX_RETRIES
mdefine_line|#define MPT_SCANDV_MAX_RETRIES&t;&t;(10)
DECL|macro|MPT_ICFLAG_BUF_CAP
mdefine_line|#define MPT_ICFLAG_BUF_CAP&t;0x01&t;/* ReadBuffer Read Capacity format */
DECL|macro|MPT_ICFLAG_ECHO
mdefine_line|#define MPT_ICFLAG_ECHO&t;&t;0x02&t;/* ReadBuffer Echo buffer format */
DECL|macro|MPT_ICFLAG_PHYS_DISK
mdefine_line|#define MPT_ICFLAG_PHYS_DISK&t;0x04&t;/* Any SCSI IO but do Phys Disk Format */
DECL|macro|MPT_ICFLAG_TAGGED_CMD
mdefine_line|#define MPT_ICFLAG_TAGGED_CMD&t;0x08&t;/* Do tagged IO */
DECL|macro|MPT_ICFLAG_DID_RESET
mdefine_line|#define MPT_ICFLAG_DID_RESET&t;0x20&t;/* Bus Reset occurred with this command */
DECL|macro|MPT_ICFLAG_RESERVED
mdefine_line|#define MPT_ICFLAG_RESERVED&t;0x40&t;/* Reserved has been issued */
DECL|struct|_internal_cmd
r_typedef
r_struct
id|_internal_cmd
(brace
DECL|member|data
r_char
op_star
id|data
suffix:semicolon
multiline_comment|/* data pointer */
DECL|member|data_dma
id|dma_addr_t
id|data_dma
suffix:semicolon
multiline_comment|/* data dma address */
DECL|member|size
r_int
id|size
suffix:semicolon
multiline_comment|/* transfer size */
DECL|member|cmd
id|u8
id|cmd
suffix:semicolon
multiline_comment|/* SCSI Op Code */
DECL|member|bus
id|u8
id|bus
suffix:semicolon
multiline_comment|/* bus number */
DECL|member|id
id|u8
id|id
suffix:semicolon
multiline_comment|/* SCSI ID (virtual) */
DECL|member|lun
id|u8
id|lun
suffix:semicolon
DECL|member|flags
id|u8
id|flags
suffix:semicolon
multiline_comment|/* Bit Field - See above */
DECL|member|physDiskNum
id|u8
id|physDiskNum
suffix:semicolon
multiline_comment|/* Phys disk number, -1 else */
DECL|member|rsvd2
id|u8
id|rsvd2
suffix:semicolon
DECL|member|rsvd
id|u8
id|rsvd
suffix:semicolon
DECL|typedef|INTERNAL_CMD
)brace
id|INTERNAL_CMD
suffix:semicolon
DECL|struct|_negoparms
r_typedef
r_struct
id|_negoparms
(brace
DECL|member|width
id|u8
id|width
suffix:semicolon
DECL|member|offset
id|u8
id|offset
suffix:semicolon
DECL|member|factor
id|u8
id|factor
suffix:semicolon
DECL|member|flags
id|u8
id|flags
suffix:semicolon
DECL|typedef|NEGOPARMS
)brace
id|NEGOPARMS
suffix:semicolon
DECL|struct|_dv_parameters
r_typedef
r_struct
id|_dv_parameters
(brace
DECL|member|max
id|NEGOPARMS
id|max
suffix:semicolon
DECL|member|now
id|NEGOPARMS
id|now
suffix:semicolon
DECL|member|cmd
id|u8
id|cmd
suffix:semicolon
DECL|member|id
id|u8
id|id
suffix:semicolon
DECL|member|pad1
id|u16
id|pad1
suffix:semicolon
DECL|typedef|DVPARAMETERS
)brace
id|DVPARAMETERS
suffix:semicolon
multiline_comment|/*&n; *  Other private/forward protos...&n; */
r_static
r_int
id|mptscsih_io_done
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_report_queue_full
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|sc
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
comma
id|SCSIIORequest_t
op_star
id|pScsiReq
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_taskmgmt_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_AddSGE
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_struct
id|scsi_cmnd
op_star
id|SCpnt
comma
id|SCSIIORequest_t
op_star
id|pReq
comma
r_int
id|req_idx
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_freeChainBuffers
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|req_idx
)paren
suffix:semicolon
r_static
r_void
id|copy_sense_data
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_tm_pending_wait
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
suffix:semicolon
r_static
id|u32
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|sc
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_TMHandler
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|type
comma
id|u8
id|channel
comma
id|u8
id|target
comma
id|u8
id|lun
comma
r_int
id|ctx2abort
comma
id|ulong
id|timeout
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_IssueTaskMgmt
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|type
comma
id|u8
id|channel
comma
id|u8
id|target
comma
id|u8
id|lun
comma
r_int
id|ctx2abort
comma
id|ulong
id|timeout
comma
r_int
id|sleepFlag
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|post_reset
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_event_process
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEvReply
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_initTarget
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|bus_id
comma
r_int
id|target_id
comma
id|u8
id|lun
comma
r_char
op_star
id|data
comma
r_int
id|dlen
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_setTargetNegoParms
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|VirtDevice
op_star
id|target
comma
r_char
id|byte56
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_set_dvflags
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|SCSIIORequest_t
op_star
id|pReq
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_setDevicePage1Flags
(paren
id|u8
id|width
comma
id|u8
id|factor
comma
id|u8
id|offset
comma
r_int
op_star
id|requestedPtr
comma
r_int
op_star
id|configurationPtr
comma
id|u8
id|flags
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_no_negotiate
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|target_id
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_writeSDP1
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
comma
r_int
id|target
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_writeIOCPage4
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|target_id
comma
r_int
id|bus
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_scandv_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|r
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_timer_expired
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_taskmgmt_timeout
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_schedule_reset
c_func
(paren
r_void
op_star
id|hd
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_do_cmd
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|INTERNAL_CMD
op_star
id|iocmd
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_synchronize_cache
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
)paren
suffix:semicolon
DECL|variable|mptscsih_rstTask
r_static
r_struct
id|work_struct
id|mptscsih_rstTask
suffix:semicolon
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
r_static
r_int
id|mptscsih_do_raid
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|action
comma
id|INTERNAL_CMD
op_star
id|io
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_domainValidation
c_func
(paren
r_void
op_star
id|hd
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_is_phys_disk
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|id
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_qas_check
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|id
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_doDv
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|channel
comma
r_int
id|target
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_dv_parms
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|DVPARAMETERS
op_star
id|dv
comma
r_void
op_star
id|pPage
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_fillbuf
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|size
comma
r_int
id|index
comma
r_int
id|width
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* module entry point */
r_static
r_int
id|__init
id|mptscsih_init
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|__exit
id|mptscsih_exit
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_probe
(paren
r_struct
id|pci_dev
op_star
comma
r_const
r_struct
id|pci_device_id
op_star
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_remove
c_func
(paren
r_struct
id|pci_dev
op_star
)paren
suffix:semicolon
r_static
r_void
id|mptscsih_shutdown
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PM
r_static
r_int
id|mptscsih_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
suffix:semicolon
r_static
r_int
id|mptscsih_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;Private data...&n; */
DECL|variable|mpt_scsi_hosts
r_static
r_int
id|mpt_scsi_hosts
op_assign
l_int|0
suffix:semicolon
DECL|variable|ScsiDoneCtx
r_static
r_int
id|ScsiDoneCtx
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|ScsiTaskCtx
r_static
r_int
id|ScsiTaskCtx
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|ScsiScanDvCtx
r_static
r_int
id|ScsiScanDvCtx
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Used only for bus scan and dv */
DECL|macro|SNS_LEN
mdefine_line|#define SNS_LEN(scp)&t;sizeof((scp)-&gt;sense_buffer)
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
multiline_comment|/*&n; * Domain Validation task structure&n; */
DECL|variable|dvtaskQ_lock
r_static
id|spinlock_t
id|dvtaskQ_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|dvtaskQ_active
r_static
r_int
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
DECL|variable|dvtaskQ_release
r_static
r_int
id|dvtaskQ_release
op_assign
l_int|0
suffix:semicolon
DECL|variable|mptscsih_dvTask
r_static
r_struct
id|work_struct
id|mptscsih_dvTask
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Wait Queue setup&n; */
r_static
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|scandv_waitq
)paren
suffix:semicolon
DECL|variable|scandv_wait_done
r_static
r_int
id|scandv_wait_done
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Driver command line structure&n; */
DECL|variable|driver_setup
r_static
r_struct
id|mptscsih_driver_setup
id|driver_setup
suffix:semicolon
DECL|variable|driver_template
r_static
r_struct
id|scsi_host_template
id|driver_template
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_add_sge - Place a simple SGE at address pAddr.&n; *&t;@pAddr: virtual address for SGE&n; *&t;@flagslength: SGE flags and data transfer length&n; *&t;@dma_addr: Physical address&n; *&n; *&t;This routine places a MPT request frame back on the MPT adapter&squot;s&n; *&t;FreeQ.&n; */
r_static
r_inline
r_void
DECL|function|mptscsih_add_sge
id|mptscsih_add_sge
c_func
(paren
r_char
op_star
id|pAddr
comma
id|u32
id|flagslength
comma
id|dma_addr_t
id|dma_addr
)paren
(brace
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
(brace
id|SGESimple64_t
op_star
id|pSge
op_assign
(paren
id|SGESimple64_t
op_star
)paren
id|pAddr
suffix:semicolon
id|u32
id|tmp
op_assign
id|dma_addr
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pSge-&gt;FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
id|flagslength
)paren
suffix:semicolon
id|pSge-&gt;Address.Low
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|dma_addr
op_rshift
l_int|32
)paren
suffix:semicolon
id|pSge-&gt;Address.High
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_else
(brace
id|SGESimple32_t
op_star
id|pSge
op_assign
(paren
id|SGESimple32_t
op_star
)paren
id|pAddr
suffix:semicolon
id|pSge-&gt;FlagsLength
op_assign
id|cpu_to_le32
c_func
(paren
id|flagslength
)paren
suffix:semicolon
id|pSge-&gt;Address
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* mptscsih_add_sge() */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_add_chain - Place a chain SGE at address pAddr.&n; *&t;@pAddr: virtual address for SGE&n; *&t;@next: nextChainOffset value (u32&squot;s)&n; *&t;@length: length of next SGL segment&n; *&t;@dma_addr: Physical address&n; *&n; *&t;This routine places a MPT request frame back on the MPT adapter&squot;s&n; *&t;FreeQ.&n; */
r_static
r_inline
r_void
DECL|function|mptscsih_add_chain
id|mptscsih_add_chain
c_func
(paren
r_char
op_star
id|pAddr
comma
id|u8
id|next
comma
id|u16
id|length
comma
id|dma_addr_t
id|dma_addr
)paren
(brace
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
(brace
id|SGEChain64_t
op_star
id|pChain
op_assign
(paren
id|SGEChain64_t
op_star
)paren
id|pAddr
suffix:semicolon
id|u32
id|tmp
op_assign
id|dma_addr
op_amp
l_int|0xFFFFFFFF
suffix:semicolon
id|pChain-&gt;Length
op_assign
id|cpu_to_le16
c_func
(paren
id|length
)paren
suffix:semicolon
id|pChain-&gt;Flags
op_assign
id|MPI_SGE_FLAGS_CHAIN_ELEMENT
op_or
id|mpt_addr_size
c_func
(paren
)paren
suffix:semicolon
id|pChain-&gt;NextChainOffset
op_assign
id|next
suffix:semicolon
id|pChain-&gt;Address.Low
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|dma_addr
op_rshift
l_int|32
)paren
suffix:semicolon
id|pChain-&gt;Address.High
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_else
(brace
id|SGEChain32_t
op_star
id|pChain
op_assign
(paren
id|SGEChain32_t
op_star
)paren
id|pAddr
suffix:semicolon
id|pChain-&gt;Length
op_assign
id|cpu_to_le16
c_func
(paren
id|length
)paren
suffix:semicolon
id|pChain-&gt;Flags
op_assign
id|MPI_SGE_FLAGS_CHAIN_ELEMENT
op_or
id|mpt_addr_size
c_func
(paren
)paren
suffix:semicolon
id|pChain-&gt;NextChainOffset
op_assign
id|next
suffix:semicolon
id|pChain-&gt;Address
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* mptscsih_add_chain() */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_getFreeChainBuffer - Function to get a free chain&n; *&t;from the MPT_SCSI_HOST FreeChainQ.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@req_idx: Index of the SCSI IO request frame. (output)&n; *&n; *&t;return SUCCESS or FAILED&n; */
r_static
r_inline
r_int
DECL|function|mptscsih_getFreeChainBuffer
id|mptscsih_getFreeChainBuffer
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
op_star
id|retIndex
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|chainBuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|chain_idx
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;getFreeChainBuffer called&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ioc-&gt;FreeChainQ
)paren
)paren
(brace
r_int
id|offset
suffix:semicolon
id|chainBuf
op_assign
id|list_entry
c_func
(paren
id|ioc-&gt;FreeChainQ.next
comma
id|MPT_FRAME_HDR
comma
id|u.frame.linkage.list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|chainBuf-&gt;u.frame.linkage.list
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|u8
op_star
)paren
id|chainBuf
op_minus
(paren
id|u8
op_star
)paren
id|ioc-&gt;ChainBuffer
suffix:semicolon
id|chain_idx
op_assign
id|offset
op_div
id|ioc-&gt;req_sz
suffix:semicolon
id|rc
op_assign
id|SUCCESS
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;getFreeChainBuffer (index %d), got buf=%p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
op_star
id|retIndex
comma
id|chainBuf
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|FAILED
suffix:semicolon
id|chain_idx
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
id|dfailprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;getFreeChainBuffer failed&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
op_star
id|retIndex
op_assign
id|chain_idx
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* mptscsih_getFreeChainBuffer() */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_AddSGE - Add a SGE (plus chain buffers) to the&n; *&t;SCSIIORequest_t Message Frame.&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@SCpnt: Pointer to scsi_cmnd structure&n; *&t;@pReq: Pointer to SCSIIORequest_t structure&n; *&n; *&t;Returns ...&n; */
r_static
r_int
DECL|function|mptscsih_AddSGE
id|mptscsih_AddSGE
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_struct
id|scsi_cmnd
op_star
id|SCpnt
comma
id|SCSIIORequest_t
op_star
id|pReq
comma
r_int
id|req_idx
)paren
(brace
r_char
op_star
id|psge
suffix:semicolon
r_char
op_star
id|chainSge
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|frm_sz
suffix:semicolon
r_int
id|sges_left
comma
id|sg_done
suffix:semicolon
r_int
id|chain_idx
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
r_int
id|sgeOffset
suffix:semicolon
r_int
id|numSgeSlots
comma
id|numSgeThisFrame
suffix:semicolon
id|u32
id|sgflags
comma
id|sgdir
comma
id|thisxfer
op_assign
l_int|0
suffix:semicolon
r_int
id|chain_dma_off
op_assign
l_int|0
suffix:semicolon
r_int
id|newIndex
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|dma_addr_t
id|v2
suffix:semicolon
id|u32
id|RequestNB
suffix:semicolon
id|sgdir
op_assign
id|le32_to_cpu
c_func
(paren
id|pReq-&gt;Control
)paren
op_amp
id|MPI_SCSIIO_CONTROL_DATADIRECTION_MASK
suffix:semicolon
r_if
c_cond
(paren
id|sgdir
op_eq
id|MPI_SCSIIO_CONTROL_WRITE
)paren
(brace
id|sgdir
op_assign
id|MPT_TRANSFER_HOST_TO_IOC
suffix:semicolon
)brace
r_else
(brace
id|sgdir
op_assign
id|MPT_TRANSFER_IOC_TO_HOST
suffix:semicolon
)brace
id|psge
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;SGL
suffix:semicolon
id|frm_sz
op_assign
id|ioc-&gt;req_sz
suffix:semicolon
multiline_comment|/* Map the data portion, if any.&n;&t; * sges_left  = 0 if no data transfer.&n;&t; */
r_if
c_cond
(paren
(paren
id|sges_left
op_assign
id|SCpnt-&gt;use_sg
)paren
)paren
(brace
id|sges_left
op_assign
id|pci_map_sg
c_func
(paren
id|ioc-&gt;pcidev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;use_sg
comma
id|SCpnt-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sges_left
op_eq
l_int|0
)paren
r_return
id|FAILED
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;request_bufflen
)paren
(brace
id|SCpnt-&gt;SCp.dma_handle
op_assign
id|pci_map_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;request_bufflen
comma
id|SCpnt-&gt;sc_data_direction
)paren
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SG: non-SG for %p, len=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|SCpnt
comma
id|SCpnt-&gt;request_bufflen
)paren
)paren
suffix:semicolon
id|mptscsih_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;SGL
comma
l_int|0xD1000000
op_or
id|MPT_SGE_FLAGS_ADDRESSING
op_or
id|sgdir
op_or
id|SCpnt-&gt;request_bufflen
comma
id|SCpnt-&gt;SCp.dma_handle
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/* Handle the SG case.&n;&t; */
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|sg_done
op_assign
l_int|0
suffix:semicolon
id|sgeOffset
op_assign
r_sizeof
(paren
id|SCSIIORequest_t
)paren
op_minus
r_sizeof
(paren
id|SGE_IO_UNION
)paren
suffix:semicolon
id|chainSge
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Prior to entering this loop - the following must be set&n;&t; * current MF:  sgeOffset (bytes)&n;&t; *              chainSge (Null if original MF is not a chain buffer)&n;&t; *              sg_done (num SGE done for this MF)&n;&t; */
id|nextSGEset
suffix:colon
id|numSgeSlots
op_assign
(paren
(paren
id|frm_sz
op_minus
id|sgeOffset
)paren
op_div
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
)paren
suffix:semicolon
id|numSgeThisFrame
op_assign
(paren
id|sges_left
OL
id|numSgeSlots
)paren
ques
c_cond
id|sges_left
suffix:colon
id|numSgeSlots
suffix:semicolon
id|sgflags
op_assign
id|MPT_SGE_FLAGS_SIMPLE_ELEMENT
op_or
id|MPT_SGE_FLAGS_ADDRESSING
op_or
id|sgdir
suffix:semicolon
multiline_comment|/* Get first (num - 1) SG elements&n;&t; * Skip any SG entries with a length of 0&n;&t; * NOTE: at finish, sg and psge pointed to NEXT data/location positions&n;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
(paren
id|numSgeThisFrame
op_minus
l_int|1
)paren
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|thisxfer
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|thisxfer
op_eq
l_int|0
)paren
(brace
id|sg
op_increment
suffix:semicolon
multiline_comment|/* Get next SG element from the OS */
id|sg_done
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|v2
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|mptscsih_add_sge
c_func
(paren
id|psge
comma
id|sgflags
op_or
id|thisxfer
comma
id|v2
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
multiline_comment|/* Get next SG element from the OS */
id|psge
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|sgeOffset
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|sg_done
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|numSgeThisFrame
op_eq
id|sges_left
)paren
(brace
multiline_comment|/* Add last element, end of buffer and end of list flags.&n;&t;&t; */
id|sgflags
op_or_assign
id|MPT_SGE_FLAGS_LAST_ELEMENT
op_or
id|MPT_SGE_FLAGS_END_OF_BUFFER
op_or
id|MPT_SGE_FLAGS_END_OF_LIST
suffix:semicolon
multiline_comment|/* Add last SGE and set termination flags.&n;&t;&t; * Note: Last SGE may have a length of 0 - which should be ok.&n;&t;&t; */
id|thisxfer
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
id|v2
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|mptscsih_add_sge
c_func
(paren
id|psge
comma
id|sgflags
op_or
id|thisxfer
comma
id|v2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;sg++;&n;&t;&t;psge += (sizeof(u32) + sizeof(dma_addr_t));&n;&t;&t;*/
id|sgeOffset
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|sg_done
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|chainSge
)paren
(brace
multiline_comment|/* The current buffer is a chain buffer,&n;&t;&t;&t; * but there is not another one.&n;&t;&t;&t; * Update the chain element&n;&t;&t;&t; * Offset and Length fields.&n;&t;&t;&t; */
id|mptscsih_add_chain
c_func
(paren
(paren
r_char
op_star
)paren
id|chainSge
comma
l_int|0
comma
id|sgeOffset
comma
id|ioc-&gt;ChainBufferDMA
op_plus
id|chain_dma_off
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The current buffer is the original MF&n;&t;&t;&t; * and there is no Chain buffer.&n;&t;&t;&t; */
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|RequestNB
op_assign
(paren
(paren
(paren
id|sgeOffset
op_minus
l_int|1
)paren
op_rshift
id|ioc-&gt;NBShiftFactor
)paren
op_plus
l_int|1
)paren
op_amp
l_int|0x03
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Single Buffer RequestNB=%x, sgeOffset=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|RequestNB
comma
id|sgeOffset
)paren
)paren
suffix:semicolon
id|ioc-&gt;RequestNB
(braket
id|req_idx
)braket
op_assign
id|RequestNB
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* At least one chain buffer is needed.&n;&t;&t; * Complete the first MF&n;&t;&t; *  - last SGE element, set the LastElement bit&n;&t;&t; *  - set ChainOffset (words) for orig MF&n;&t;&t; *             (OR finish previous MF chain buffer)&n;&t;&t; *  - update MFStructPtr ChainIndex&n;&t;&t; *  - Populate chain element&n;&t;&t; * Also&n;&t;&t; * Loop until done.&n;&t;&t; */
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SG: Chain Required! sg done %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|sg_done
)paren
)paren
suffix:semicolon
multiline_comment|/* Set LAST_ELEMENT flag for last non-chain element&n;&t;&t; * in the buffer. Since psge points at the NEXT&n;&t;&t; * SGE element, go back one SGE element, update the flags&n;&t;&t; * and reset the pointer. (Note: sgflags &amp; thisxfer are already&n;&t;&t; * set properly).&n;&t;&t; */
r_if
c_cond
(paren
id|sg_done
)paren
(brace
id|u32
op_star
id|ptmp
op_assign
(paren
id|u32
op_star
)paren
(paren
id|psge
op_minus
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
)paren
suffix:semicolon
id|sgflags
op_assign
id|le32_to_cpu
c_func
(paren
op_star
id|ptmp
)paren
suffix:semicolon
id|sgflags
op_or_assign
id|MPT_SGE_FLAGS_LAST_ELEMENT
suffix:semicolon
op_star
id|ptmp
op_assign
id|cpu_to_le32
c_func
(paren
id|sgflags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chainSge
)paren
(brace
multiline_comment|/* The current buffer is a chain buffer.&n;&t;&t;&t; * chainSge points to the previous Chain Element.&n;&t;&t;&t; * Update its chain element Offset and Length (must&n;&t;&t;&t; * include chain element size) fields.&n;&t;&t;&t; * Old chain element is now complete.&n;&t;&t;&t; */
id|u8
id|nextChain
op_assign
(paren
id|u8
)paren
(paren
id|sgeOffset
op_rshift
l_int|2
)paren
suffix:semicolon
id|sgeOffset
op_add_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_plus
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|mptscsih_add_chain
c_func
(paren
(paren
r_char
op_star
)paren
id|chainSge
comma
id|nextChain
comma
id|sgeOffset
comma
id|ioc-&gt;ChainBufferDMA
op_plus
id|chain_dma_off
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The original MF buffer requires a chain buffer -&n;&t;&t;&t; * set the offset.&n;&t;&t;&t; * Last element in this MF is a chain element.&n;&t;&t;&t; */
id|pReq-&gt;ChainOffset
op_assign
(paren
id|u8
)paren
(paren
id|sgeOffset
op_rshift
l_int|2
)paren
suffix:semicolon
id|RequestNB
op_assign
(paren
(paren
(paren
id|sgeOffset
op_minus
l_int|1
)paren
op_rshift
id|ioc-&gt;NBShiftFactor
)paren
op_plus
l_int|1
)paren
op_amp
l_int|0x03
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;Chain Buffer Needed, RequestNB=%x sgeOffset=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|RequestNB
comma
id|sgeOffset
)paren
)paren
suffix:semicolon
id|ioc-&gt;RequestNB
(braket
id|req_idx
)braket
op_assign
id|RequestNB
suffix:semicolon
)brace
id|sges_left
op_sub_assign
id|sg_done
suffix:semicolon
multiline_comment|/* NOTE: psge points to the beginning of the chain element&n;&t;&t; * in current buffer. Get a chain buffer.&n;&t;&t; */
id|dsgprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;calling getFreeChainBuffer SCSI cmd=%02x (%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|pReq-&gt;CDB
(braket
l_int|0
)braket
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mptscsih_getFreeChainBuffer
c_func
(paren
id|ioc
comma
op_amp
id|newIndex
)paren
)paren
op_eq
id|FAILED
)paren
r_return
id|FAILED
suffix:semicolon
multiline_comment|/* Update the tracking arrays.&n;&t;&t; * If chainSge == NULL, update ReqToChain, else ChainToChain&n;&t;&t; */
r_if
c_cond
(paren
id|chainSge
)paren
(brace
id|ioc-&gt;ChainToChain
(braket
id|chain_idx
)braket
op_assign
id|newIndex
suffix:semicolon
)brace
r_else
(brace
id|ioc-&gt;ReqToChain
(braket
id|req_idx
)braket
op_assign
id|newIndex
suffix:semicolon
)brace
id|chain_idx
op_assign
id|newIndex
suffix:semicolon
id|chain_dma_off
op_assign
id|ioc-&gt;req_sz
op_star
id|chain_idx
suffix:semicolon
multiline_comment|/* Populate the chainSGE for the current buffer.&n;&t;&t; * - Set chain buffer pointer to psge and fill&n;&t;&t; *   out the Address and Flags fields.&n;&t;&t; */
id|chainSge
op_assign
(paren
r_char
op_star
)paren
id|psge
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Current buff @ %p (index 0x%x)&quot;
comma
id|psge
comma
id|req_idx
)paren
)paren
suffix:semicolon
multiline_comment|/* Start the SGE for the next buffer&n;&t;&t; */
id|psge
op_assign
(paren
r_char
op_star
)paren
(paren
id|ioc-&gt;ChainBuffer
op_plus
id|chain_dma_off
)paren
suffix:semicolon
id|sgeOffset
op_assign
l_int|0
suffix:semicolon
id|sg_done
op_assign
l_int|0
suffix:semicolon
id|dsgprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Chain buff @ %p (index 0x%x)&bslash;n&quot;
comma
id|psge
comma
id|chain_idx
)paren
)paren
suffix:semicolon
multiline_comment|/* Start the SGE for the next buffer&n;&t;&t; */
r_goto
id|nextSGEset
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/* mptscsih_AddSGE() */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_io_done - Main SCSI IO callback routine registered to&n; *&t;Fusion MPT (base) driver&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to original MPT request frame&n; *&t;@r: Pointer to MPT reply frame (NULL if TurboReply)&n; *&n; *&t;This routine is called from mpt.c::mpt_interrupt() at the completion&n; *&t;of any SCSI IO request.&n; *&t;This routine is registered with the Fusion MPT (base) driver at driver&n; *&t;load/init time via the mpt_register() API call.&n; *&n; *&t;Returns 1 indicating alloc&squot;d request frame ptr should be freed.&n; */
r_static
r_int
DECL|function|mptscsih_io_done
id|mptscsih_io_done
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|mr
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|sc
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pScsiReq
suffix:semicolon
id|SCSIIOReply_t
op_star
id|pScsiReply
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sc
op_assign
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_eq
l_int|NULL
)paren
(brace
id|MPIHeader_t
op_star
id|hdr
op_assign
(paren
id|MPIHeader_t
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Remark: writeSDP1 will use the ScsiDoneCtx&n;&t;&t; * If a SCSI I/O cmd, device disabled by OS and&n;&t;&t; * completion done. Cannot touch sc struct. Just free mem.&n;&t;&t; */
r_if
c_cond
(paren
id|hdr-&gt;Function
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;NULL ScsiCmd ptr!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
id|mptscsih_freeChainBuffers
c_func
(paren
id|ioc
comma
id|req_idx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;ScsiDone (mf=%p,mr=%p,sc=%p,idx=%d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
comma
id|mr
comma
id|sc
comma
id|req_idx
)paren
)paren
suffix:semicolon
id|sc-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* Set default reply as OK */
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|pScsiReply
op_assign
(paren
id|SCSIIOReply_t
op_star
)paren
id|mr
suffix:semicolon
r_if
c_cond
(paren
id|pScsiReply
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* special context reply handling */
suffix:semicolon
)brace
r_else
(brace
id|u32
id|xfer_cnt
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|u8
id|scsi_state
comma
id|scsi_status
suffix:semicolon
id|status
op_assign
id|le16_to_cpu
c_func
(paren
id|pScsiReply-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
id|scsi_state
op_assign
id|pScsiReply-&gt;SCSIState
suffix:semicolon
id|scsi_status
op_assign
id|pScsiReply-&gt;SCSIStatus
suffix:semicolon
id|xfer_cnt
op_assign
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;TransferCount
)paren
suffix:semicolon
id|dreplyprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot; Reply (%d:%d:%d) mf=%p, mr=%p, sc=%p&bslash;n&quot;
comma
id|ioc-&gt;id
comma
id|pScsiReq-&gt;TargetID
comma
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
comma
id|mf
comma
id|mr
comma
id|sc
)paren
)paren
suffix:semicolon
id|dreplyprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;IOCStatus=%04xh SCSIState=%02xh&quot;
l_string|&quot; SCSIStatus=%02xh xfer_cnt=%08xh&bslash;n&quot;
comma
id|status
comma
id|scsi_state
comma
id|scsi_status
comma
id|xfer_cnt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
id|copy_sense_data
c_func
(paren
id|sc
comma
id|hd
comma
id|mf
comma
id|pScsiReply
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Look for + dump FCP ResponseInfo[]!&n;&t;&t; */
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_RESPONSE_INFO_VALID
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;  FCP_ResponseInfo=%08xh&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;ResponseInfo
)paren
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|MPI_IOCSTATUS_BUSY
suffix:colon
multiline_comment|/* 0x0002 */
multiline_comment|/* CHECKME!&n;&t;&t;&t; * Maybe: DRIVER_BUSY | SUGGEST_RETRY | DID_SOFT_ERROR (retry)&n;&t;&t;&t; * But not: DID_BUS_BUSY lest one risk&n;&t;&t;&t; * killing interrupt handler:-(&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|SAM_STAT_BUSY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_INVALID_BUS
suffix:colon
multiline_comment|/* 0x0041 */
r_case
id|MPI_IOCSTATUS_SCSI_INVALID_TARGETID
suffix:colon
multiline_comment|/* 0x0042 */
id|sc-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE
suffix:colon
multiline_comment|/* 0x0043 */
multiline_comment|/* Spoof to SCSI Selection Timeout! */
id|sc-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;sel_timeout
(braket
id|pScsiReq-&gt;TargetID
)braket
OL
l_int|0xFFFF
)paren
id|hd-&gt;sel_timeout
(braket
id|pScsiReq-&gt;TargetID
)braket
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_TASK_TERMINATED
suffix:colon
multiline_comment|/* 0x0048 */
r_case
id|MPI_IOCSTATUS_SCSI_IOC_TERMINATED
suffix:colon
multiline_comment|/* 0x004B */
r_case
id|MPI_IOCSTATUS_SCSI_EXT_TERMINATED
suffix:colon
multiline_comment|/* 0x004C */
multiline_comment|/* Linux handles an unsolicited DID_RESET better&n;&t;&t;&t; * than an unsolicited DID_ABORT.&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* GEM Workaround. */
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|SCSI
)paren
id|mptscsih_no_negotiate
c_func
(paren
id|hd
comma
id|sc-&gt;device-&gt;id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH
suffix:colon
multiline_comment|/* 0x0049 */
id|sc-&gt;resid
op_assign
id|sc-&gt;request_bufflen
op_minus
id|xfer_cnt
suffix:semicolon
r_if
c_cond
(paren
id|xfer_cnt
op_ge
id|sc-&gt;underflow
)paren
(brace
multiline_comment|/* Sufficient data transfer occurred */
id|sc-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
id|scsi_status
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|xfer_cnt
op_eq
l_int|0
)paren
(brace
multiline_comment|/* A CRC Error causes this condition; retry */
id|sc-&gt;result
op_assign
(paren
id|DRIVER_SENSE
op_lshift
l_int|24
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
id|sc-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|sc-&gt;sense_buffer
(braket
l_int|2
)braket
op_assign
id|NO_SENSE
suffix:semicolon
id|sc-&gt;sense_buffer
(braket
l_int|12
)braket
op_assign
l_int|0
suffix:semicolon
id|sc-&gt;sense_buffer
(braket
l_int|13
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
id|dreplyprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;RESIDUAL_MISMATCH: result=%x on id=%d&bslash;n&quot;
comma
id|sc-&gt;result
comma
id|sc-&gt;target
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
suffix:colon
multiline_comment|/* 0x0045 */
multiline_comment|/*&n;&t;&t;&t; *  Do upfront check for valid SenseData and give it&n;&t;&t;&t; *  precedence!&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
id|scsi_status
suffix:semicolon
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
(brace
multiline_comment|/* Have already saved the status and sense data&n;&t;&t;&t;&t; */
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|xfer_cnt
op_eq
l_int|0
)paren
op_logical_or
(paren
id|sc-&gt;underflow
OG
id|xfer_cnt
)paren
)paren
(brace
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_state
op_amp
(paren
id|MPI_SCSI_STATE_AUTOSENSE_FAILED
op_or
id|MPI_SCSI_STATE_NO_SCSI_STATUS
)paren
)paren
(brace
multiline_comment|/* What to do?&n;&t;&t;&t;&t; &t;*/
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
(brace
multiline_comment|/*  Not real sure here either...  */
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
multiline_comment|/* Give report and update residual count.&n;&t;&t;&t; */
id|dreplyprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  sc-&gt;underflow={report ERR if &lt; %02xh bytes xfer&squot;d}&bslash;n&quot;
comma
id|sc-&gt;underflow
)paren
)paren
suffix:semicolon
id|dreplyprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  ActBytesXferd=%02xh&bslash;n&quot;
comma
id|xfer_cnt
)paren
)paren
suffix:semicolon
id|sc-&gt;resid
op_assign
id|sc-&gt;request_bufflen
op_minus
id|xfer_cnt
suffix:semicolon
id|dreplyprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  SET sc-&gt;resid=%02xh&bslash;n&quot;
comma
id|sc-&gt;resid
)paren
)paren
suffix:semicolon
multiline_comment|/* Report Queue Full&n;&t;&t;&t; */
r_if
c_cond
(paren
id|scsi_status
op_eq
id|MPI_SCSI_STATUS_TASK_SET_FULL
)paren
id|mptscsih_report_queue_full
c_func
(paren
id|sc
comma
id|pScsiReply
comma
id|pScsiReq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
suffix:colon
multiline_comment|/* 0x0040 */
r_case
id|MPI_IOCSTATUS_SUCCESS
suffix:colon
multiline_comment|/* 0x0000 */
id|scsi_status
op_assign
id|pScsiReply-&gt;SCSIStatus
suffix:semicolon
id|sc-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
id|scsi_status
suffix:semicolon
r_if
c_cond
(paren
id|scsi_state
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * If running against circa 200003dd 909 MPT f/w,&n;&t;&t;&t;&t; * may get this (AUTOSENSE_VALID) for actual TASK_SET_FULL&n;&t;&t;&t;&t; * (QUEUE_FULL) returned from device! --&gt; get 0x0000?128&n;&t;&t;&t;&t; * and with SenseBytes set to 0.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pScsiReply-&gt;SCSIStatus
op_eq
id|MPI_SCSI_STATUS_TASK_SET_FULL
)paren
id|mptscsih_report_queue_full
c_func
(paren
id|sc
comma
id|pScsiReply
comma
id|pScsiReq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_state
op_amp
(paren
id|MPI_SCSI_STATE_AUTOSENSE_FAILED
op_or
id|MPI_SCSI_STATE_NO_SCSI_STATUS
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * What to do?&n;&t;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
(brace
multiline_comment|/*  Not real sure here either...  */
id|sc-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_state
op_amp
id|MPI_SCSI_STATE_QUEUE_TAG_REJECTED
)paren
(brace
multiline_comment|/* Device Inq. data indicates that it supports&n;&t;&t;&t;&t; * QTags, but rejects QTag messages.&n;&t;&t;&t;&t; * This command completed OK.&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; * Not real sure here either so do nothing...  */
)brace
r_if
c_cond
(paren
id|sc-&gt;result
op_eq
id|MPI_SCSI_STATUS_TASK_SET_FULL
)paren
id|mptscsih_report_queue_full
c_func
(paren
id|sc
comma
id|pScsiReply
comma
id|pScsiReq
)paren
suffix:semicolon
multiline_comment|/* Add handling of:&n;&t;&t;&t; * Reservation Conflict, Busy,&n;&t;&t;&t; * Command Terminated, CHECK&n;&t;&t;&t; */
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR
suffix:colon
multiline_comment|/* 0x0047 */
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_INVALID_FUNCTION
suffix:colon
multiline_comment|/* 0x0001 */
r_case
id|MPI_IOCSTATUS_INVALID_SGL
suffix:colon
multiline_comment|/* 0x0003 */
r_case
id|MPI_IOCSTATUS_INTERNAL_ERROR
suffix:colon
multiline_comment|/* 0x0004 */
r_case
id|MPI_IOCSTATUS_RESERVED
suffix:colon
multiline_comment|/* 0x0005 */
r_case
id|MPI_IOCSTATUS_INSUFFICIENT_RESOURCES
suffix:colon
multiline_comment|/* 0x0006 */
r_case
id|MPI_IOCSTATUS_INVALID_FIELD
suffix:colon
multiline_comment|/* 0x0007 */
r_case
id|MPI_IOCSTATUS_INVALID_STATE
suffix:colon
multiline_comment|/* 0x0008 */
r_case
id|MPI_IOCSTATUS_SCSI_DATA_OVERRUN
suffix:colon
multiline_comment|/* 0x0044 */
r_case
id|MPI_IOCSTATUS_SCSI_IO_DATA_ERROR
suffix:colon
multiline_comment|/* 0x0046 */
r_case
id|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
suffix:colon
multiline_comment|/* 0x004A */
r_default
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * What to do?&n;&t;&t;&t; */
id|sc-&gt;result
op_assign
id|DID_SOFT_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch(status) */
id|dreplyprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  sc-&gt;result is %08xh&bslash;n&quot;
comma
id|sc-&gt;result
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end of address reply case */
multiline_comment|/* Unmap the DMA buffers, if any. */
r_if
c_cond
(paren
id|sc-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|ioc-&gt;pcidev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|sc-&gt;request_buffer
comma
id|sc-&gt;use_sg
comma
id|sc-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sc-&gt;request_bufflen
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|sc-&gt;SCp.dma_handle
comma
id|sc-&gt;request_bufflen
comma
id|sc-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sc
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|sc
)paren
suffix:semicolon
multiline_comment|/* Issue the command callback */
multiline_comment|/* Free Chain buffers */
id|mptscsih_freeChainBuffers
c_func
(paren
id|ioc
comma
id|req_idx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;mptscsih_flush_running_cmds - For each command found, search&n; *&t;&t;Scsi_Host instance taskQ and reply to OS.&n; *&t;&t;Called only if recovering from a FW reload.&n; *&t;@hd: Pointer to a SCSI HOST structure&n; *&n; *&t;Returns: None.&n; *&n; *&t;Must be called while new I/Os are being queued.&n; */
r_static
r_void
DECL|function|mptscsih_flush_running_cmds
id|mptscsih_flush_running_cmds
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|SCpnt
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|max
op_assign
id|ioc-&gt;req_depth
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: flush_ScsiLookup called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|max
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|SCpnt
op_assign
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Command found.&n;&t;&t;&t; */
multiline_comment|/* Null ScsiLookup index&n;&t;&t;&t; */
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
op_assign
l_int|NULL
suffix:semicolon
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ii
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
l_string|&quot;flush: ScsiDone (mf=%p,sc=%p)&bslash;n&quot;
comma
id|mf
comma
id|SCpnt
)paren
)paren
suffix:semicolon
multiline_comment|/* Set status, free OS resources (SG DMA buffers)&n;&t;&t;&t; * Do OS callback&n;&t;&t;&t; * Free driver resources (chain, msg buffers)&n;&t;&t;&t; */
r_if
c_cond
(paren
id|scsi_device_online
c_func
(paren
id|SCpnt-&gt;device
)paren
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|ioc-&gt;pcidev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;use_sg
comma
id|SCpnt-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;request_bufflen
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|SCpnt-&gt;SCp.dma_handle
comma
id|SCpnt-&gt;request_bufflen
comma
id|SCpnt-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
)brace
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Free Chain buffers */
id|mptscsih_freeChainBuffers
c_func
(paren
id|ioc
comma
id|ii
)paren
suffix:semicolon
multiline_comment|/* Free Message frames */
id|mpt_free_msg_frame
c_func
(paren
id|ioc
comma
id|mf
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Issue the command callback */
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;mptscsih_search_running_cmds - Delete any commands associated&n; *&t;&t;with the specified target and lun. Function called only&n; *&t;&t;when a lun is disable by mid-layer.&n; *&t;&t;Do NOT access the referenced scsi_cmnd structure or&n; *&t;&t;members. Will cause either a paging or NULL ptr error.&n; *&t;@hd: Pointer to a SCSI HOST structure&n; *&t;@target: target id&n; *&t;@lun: lun&n; *&n; *&t;Returns: None.&n; *&n; *&t;Called from slave_destroy.&n; */
r_static
r_void
DECL|function|mptscsih_search_running_cmds
id|mptscsih_search_running_cmds
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|uint
id|target
comma
id|uint
id|lun
)paren
(brace
id|SCSIIORequest_t
op_star
id|mf
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|max
op_assign
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|dsprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: search_running target %d lun %d max %d&bslash;n&quot;
comma
id|target
comma
id|lun
comma
id|max
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|max
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
op_ne
l_int|NULL
)paren
(brace
id|mf
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|hd-&gt;ioc
comma
id|ii
)paren
suffix:semicolon
id|dsprintk
c_func
(paren
(paren
l_string|&quot;search_running: found (sc=%p, mf = %p) target %d, lun %d &bslash;n&quot;
comma
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
comma
id|mf
comma
id|mf-&gt;TargetID
comma
id|mf-&gt;LUN
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf-&gt;TargetID
op_ne
(paren
(paren
id|u8
)paren
id|target
)paren
)paren
op_logical_or
(paren
id|mf-&gt;LUN
(braket
l_int|1
)braket
op_ne
(paren
(paren
id|u8
)paren
id|lun
)paren
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Cleanup&n;&t;&t;&t; */
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
op_assign
l_int|NULL
suffix:semicolon
id|mptscsih_freeChainBuffers
c_func
(paren
id|hd-&gt;ioc
comma
id|ii
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|hd-&gt;ioc
comma
(paren
id|MPT_FRAME_HDR
op_star
)paren
id|mf
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Hack! It might be nice to report if a device is returning QUEUE_FULL&n; *  but maybe not each and every time...&n; */
DECL|variable|last_queue_full
r_static
r_int
id|last_queue_full
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_report_queue_full - Report QUEUE_FULL status returned&n; *&t;from a SCSI target device.&n; *&t;@sc: Pointer to scsi_cmnd structure&n; *&t;@pScsiReply: Pointer to SCSIIOReply_t&n; *&t;@pScsiReq: Pointer to original SCSI request&n; *&n; *&t;This routine periodically reports QUEUE_FULL status returned from a&n; *&t;SCSI target device.  It reports this to the console via kernel&n; *&t;printk() API call, not more than once every 10 seconds.&n; */
r_static
r_void
DECL|function|mptscsih_report_queue_full
id|mptscsih_report_queue_full
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|sc
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
comma
id|SCSIIORequest_t
op_star
id|pScsiReq
)paren
(brace
r_int
id|time
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|time
op_minus
id|last_queue_full
OG
l_int|10
op_star
id|HZ
)paren
(brace
r_char
op_star
id|ioc_str
op_assign
l_string|&quot;ioc?&quot;
suffix:semicolon
r_if
c_cond
(paren
id|sc-&gt;device
op_logical_and
id|sc-&gt;device-&gt;host
op_ne
l_int|NULL
op_logical_and
id|sc-&gt;device-&gt;host-&gt;hostdata
op_ne
l_int|NULL
)paren
id|ioc_str
op_assign
(paren
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sc-&gt;device-&gt;host-&gt;hostdata
)paren
op_member_access_from_pointer
id|ioc-&gt;name
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Device (%d:%d:%d) reported QUEUE_FULL!&bslash;n&quot;
comma
id|ioc_str
comma
l_int|0
comma
id|sc-&gt;device-&gt;id
comma
id|sc-&gt;device-&gt;lun
)paren
)paren
suffix:semicolon
id|last_queue_full
op_assign
id|time
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|info_kbuf
r_static
r_char
op_star
id|info_kbuf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_probe - Installs scsi devices per bus.&n; *&t;@pdev: Pointer to pci_dev structure&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; *&n; */
r_static
r_int
DECL|function|mptscsih_probe
id|mptscsih_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|sz
comma
id|ii
suffix:semicolon
r_int
id|numSGE
op_assign
l_int|0
suffix:semicolon
r_int
id|scale
suffix:semicolon
r_int
id|ioc_cap
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 20010202 -sralston&n;&t; *  Added sanity check on readiness of the MPT adapter.&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;last_state
op_ne
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Skipping because it&squot;s not operational!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;active
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Skipping because it&squot;s disabled!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*  Sanity check - ensure at least 1 port is INITIATOR capable&n;&t; */
id|ioc_cap
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|ioc-&gt;facts.NumberOfPorts
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;pfacts
(braket
id|ii
)braket
dot
id|ProtocolFlags
op_amp
id|MPI_PORTFACTS_PROTOCOL_INITIATOR
)paren
id|ioc_cap
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ioc_cap
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Skipping ioc=%p because SCSI Initiator mode is NOT enabled!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|ioc
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|sh
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|driver_template
comma
r_sizeof
(paren
id|MPT_SCSI_HOST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sh
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Unable to register controller with SCSI subsystem&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Attach the SCSI Host to the IOC structure&n;&t; */
id|ioc-&gt;sh
op_assign
id|sh
suffix:semicolon
id|sh-&gt;io_port
op_assign
l_int|0
suffix:semicolon
id|sh-&gt;n_io_port
op_assign
l_int|0
suffix:semicolon
id|sh-&gt;irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set 16 byte cdb&squot;s */
id|sh-&gt;max_cmd_len
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* Yikes!  This is important!&n;&t; * Otherwise, by default, linux&n;&t; * only scans target IDs 0-7!&n;&t; * pfactsN-&gt;MaxDevices unreliable&n;&t; * (not supported in early&n;&t; *&t;versions of the FW).&n;&t; * max_id = 1 + actual max id,&n;&t; * max_lun = 1 + actual last lun,&n;&t; *&t;see hosts.h :o(&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
id|sh-&gt;max_id
op_assign
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* For FC, increase the queue depth&n;&t; * from MPT_SCSI_CAN_QUEUE (31)&n;&t; * to MPT_FC_CAN_QUEUE (63).&n;&t; */
id|sh-&gt;can_queue
op_assign
id|MPT_FC_CAN_QUEUE
suffix:semicolon
id|sh-&gt;max_id
op_assign
id|MPT_MAX_FC_DEVICES
OL
l_int|256
ques
c_cond
id|MPT_MAX_FC_DEVICES
suffix:colon
l_int|255
suffix:semicolon
)brace
id|sh-&gt;max_lun
op_assign
id|MPT_LAST_LUN
op_plus
l_int|1
suffix:semicolon
id|sh-&gt;max_channel
op_assign
l_int|0
suffix:semicolon
id|sh-&gt;this_id
op_assign
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|PortSCSIID
suffix:semicolon
multiline_comment|/* Required entry.&n;&t; */
id|sh-&gt;unique_id
op_assign
id|ioc-&gt;id
suffix:semicolon
multiline_comment|/* Verify that we won&squot;t exceed the maximum&n;&t; * number of chain buffers&n;&t; * We can optimize:  ZZ = req_sz/sizeof(SGE)&n;&t; * For 32bit SGE&squot;s:&n;&t; *  numSGE = 1 + (ZZ-1)*(maxChain -1) + ZZ&n;&t; *               + (req_sz - 64)/sizeof(SGE)&n;&t; * A slightly different algorithm is required for&n;&t; * 64bit SGEs.&n;&t; */
id|scale
op_assign
id|ioc-&gt;req_sz
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_eq
r_sizeof
(paren
id|u64
)paren
)paren
(brace
id|numSGE
op_assign
(paren
id|scale
op_minus
l_int|1
)paren
op_star
(paren
id|ioc-&gt;facts.MaxChainDepth
op_minus
l_int|1
)paren
op_plus
id|scale
op_plus
(paren
id|ioc-&gt;req_sz
op_minus
l_int|60
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|numSGE
op_assign
l_int|1
op_plus
(paren
id|scale
op_minus
l_int|1
)paren
op_star
(paren
id|ioc-&gt;facts.MaxChainDepth
op_minus
l_int|1
)paren
op_plus
id|scale
op_plus
(paren
id|ioc-&gt;req_sz
op_minus
l_int|64
)paren
op_div
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|numSGE
OL
id|sh-&gt;sg_tablesize
)paren
(brace
multiline_comment|/* Reset this value */
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Resetting sg_tablesize to %d from %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|numSGE
comma
id|sh-&gt;sg_tablesize
)paren
)paren
suffix:semicolon
id|sh-&gt;sg_tablesize
op_assign
id|numSGE
suffix:semicolon
)brace
multiline_comment|/* Set the pci device pointer in Scsi_Host structure.&n;&t; */
id|scsi_set_device
c_func
(paren
id|sh
comma
op_amp
id|ioc-&gt;pcidev-&gt;dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
id|hd-&gt;ioc
op_assign
id|ioc
suffix:semicolon
multiline_comment|/* SCSI needs scsi_cmnd lookup table!&n;&t; * (with size equal to req_depth*PtrSz!)&n;&t; */
id|sz
op_assign
id|ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|mptscsih_probe_failed
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|hd-&gt;ScsiLookup
op_assign
(paren
r_struct
id|scsi_cmnd
op_star
op_star
)paren
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;ScsiLookup @ %p, sz=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|hd-&gt;ScsiLookup
comma
id|sz
)paren
)paren
suffix:semicolon
multiline_comment|/* Allocate memory for the device structures.&n;&t; * A non-Null pointer at an offset&n;&t; * indicates a device exists.&n;&t; * max_id = 1 + maximum id (hosts.h)&n;&t; */
id|sz
op_assign
id|sh-&gt;max_id
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|NULL
)paren
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|mptscsih_probe_failed
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|hd-&gt;Targets
op_assign
(paren
id|VirtDevice
op_star
op_star
)paren
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Targets @ %p, sz=%d&bslash;n&quot;
comma
id|hd-&gt;Targets
comma
id|sz
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the TM flags&n;&t; */
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|hd-&gt;resetPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;abortSCpnt
op_assign
l_int|NULL
suffix:semicolon
id|hd-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Clear the pointer used to store&n;&t; * single-threaded commands, i.e., those&n;&t; * issued during a bus scan, dv and&n;&t; * configuration pages.&n;&t; */
id|hd-&gt;cmdPtr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Initialize this SCSI Hosts&squot; timers&n;&t; * To use, set the timer expires field&n;&t; * and add_timer&n;&t; */
id|init_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|hd-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|hd
suffix:semicolon
id|hd-&gt;timer.function
op_assign
id|mptscsih_timer_expired
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
id|hd-&gt;TMtimer.data
op_assign
(paren
r_int
r_int
)paren
id|hd
suffix:semicolon
id|hd-&gt;TMtimer.function
op_assign
id|mptscsih_taskmgmt_timeout
suffix:semicolon
id|hd-&gt;qtag_tick
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Moved Earlier Pam D */
multiline_comment|/* ioc-&gt;sh = sh;&t;*/
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
multiline_comment|/* Update with the driver setup&n;&t;&t; * values.&n;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;spi_data.maxBusWidth
OG
id|driver_setup.max_width
)paren
(brace
id|ioc-&gt;spi_data.maxBusWidth
op_assign
id|driver_setup.max_width
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.minSyncFactor
OL
id|driver_setup.min_sync_factor
)paren
(brace
id|ioc-&gt;spi_data.minSyncFactor
op_assign
id|driver_setup.min_sync_factor
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.minSyncFactor
op_eq
id|MPT_ASYNC
)paren
(brace
id|ioc-&gt;spi_data.maxSyncOffset
op_assign
l_int|0
suffix:semicolon
)brace
id|ioc-&gt;spi_data.Saf_Te
op_assign
id|driver_setup.saf_te
suffix:semicolon
id|hd-&gt;negoNvram
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
id|hd-&gt;negoNvram
op_assign
id|MPT_SCSICFG_USE_NVRAM
suffix:semicolon
macro_line|#endif
id|ioc-&gt;spi_data.forceDv
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_assign
id|MPT_SCSICFG_NEGOTIATE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
id|ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_or_assign
id|MPT_SCSICFG_DV_NOT_DONE
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;dv %x width %x factor %x saf_te %x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|driver_setup.dv
comma
id|driver_setup.max_width
comma
id|driver_setup.min_sync_factor
comma
id|driver_setup.saf_te
)paren
)paren
suffix:semicolon
)brace
id|mpt_scsi_hosts
op_increment
suffix:semicolon
id|error
op_assign
id|scsi_add_host
(paren
id|sh
comma
op_amp
id|ioc-&gt;pcidev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;scsi_add_host failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|mptscsih_probe_failed
suffix:semicolon
)brace
id|scsi_scan_host
c_func
(paren
id|sh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|mptscsih_probe_failed
suffix:colon
id|mptscsih_remove
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_remove - Removed scsi devices&n; *&t;@pdev: Pointer to pci_dev structure&n; *&n; *&n; */
r_static
r_void
DECL|function|mptscsih_remove
id|mptscsih_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|ioc-&gt;sh
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
r_return
suffix:semicolon
)brace
id|scsi_remove_host
c_func
(paren
id|host
)paren
suffix:semicolon
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
multiline_comment|/* Check DV thread active */
id|count
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvtaskQ_active
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dvtaskQ_active
op_logical_and
op_decrement
id|count
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: ERROR - DV thread still active!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if defined(MPT_DEBUG_DV) || defined(MPT_DEBUG_DV_TINY)
r_else
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot;: DV thread orig %d, count %d&bslash;n&quot;
comma
l_int|10
op_star
id|HZ
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_ne
l_int|NULL
)paren
(brace
r_int
id|sz1
suffix:semicolon
id|mptscsih_shutdown
c_func
(paren
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
id|sz1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
op_ne
l_int|NULL
)paren
(brace
id|sz1
op_assign
id|hd-&gt;ioc-&gt;req_depth
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hd-&gt;ScsiLookup
)paren
suffix:semicolon
id|hd-&gt;ScsiLookup
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;Targets
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Free pointer array.&n;&t;&t;&t; */
id|kfree
c_func
(paren
id|hd-&gt;Targets
)paren
suffix:semicolon
id|hd-&gt;Targets
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Free&squot;d ScsiLookup (%d) memory&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|sz1
)paren
)paren
suffix:semicolon
multiline_comment|/* NULL the Scsi_Host pointer&n;&t;&t; */
id|hd-&gt;ioc-&gt;sh
op_assign
l_int|NULL
suffix:semicolon
)brace
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
id|mpt_scsi_hosts
op_decrement
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_shutdown - reboot notifier&n; *&n; */
r_static
r_void
DECL|function|mptscsih_shutdown
id|mptscsih_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|to_pci_dev
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|ioc-&gt;sh
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
r_return
suffix:semicolon
)brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Flush the cache of this adapter&n;&t; */
r_if
c_cond
(paren
id|hd
op_ne
l_int|NULL
)paren
(brace
id|mptscsih_synchronize_cache
c_func
(paren
id|hd
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_PM
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_suspend - Fusion MPT scsie driver suspend routine.&n; *&n; *&n; */
r_static
r_int
DECL|function|mptscsih_suspend
id|mptscsih_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
id|mptscsih_shutdown
c_func
(paren
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_resume - Fusion MPT scsi driver resume routine.&n; *&n; *&n; */
r_static
r_int
DECL|function|mptscsih_resume
id|mptscsih_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|ioc-&gt;sh
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hd
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
(brace
r_int
r_int
id|lflags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dvtaskQ_active
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|mptscsih_dvTask
comma
id|mptscsih_domainValidation
comma
(paren
r_void
op_star
)paren
id|hd
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|mptscsih_dvTask
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|mptscsih_driver
r_static
r_struct
id|mpt_pci_driver
id|mptscsih_driver
op_assign
(brace
dot
id|probe
op_assign
id|mptscsih_probe
comma
dot
id|remove
op_assign
id|mptscsih_remove
comma
dot
id|shutdown
op_assign
id|mptscsih_shutdown
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|mptscsih_suspend
comma
dot
id|resume
op_assign
id|mptscsih_resume
comma
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/*  SCSI host fops start here...  */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_init - Register MPT adapter(s) as SCSI host(s) with&n; *&t;linux scsi mid-layer.&n; *&n; *&t;Returns 0 for success, non-zero for failure.&n; */
r_static
r_int
id|__init
DECL|function|mptscsih_init
id|mptscsih_init
c_func
(paren
r_void
)paren
(brace
id|show_mptmod_ver
c_func
(paren
id|my_NAME
comma
id|my_VERSION
)paren
suffix:semicolon
id|ScsiDoneCtx
op_assign
id|mpt_register
c_func
(paren
id|mptscsih_io_done
comma
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
id|ScsiTaskCtx
op_assign
id|mpt_register
c_func
(paren
id|mptscsih_taskmgmt_complete
comma
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
id|ScsiScanDvCtx
op_assign
id|mpt_register
c_func
(paren
id|mptscsih_scandv_complete
comma
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_event_register
c_func
(paren
id|ScsiDoneCtx
comma
id|mptscsih_event_process
)paren
op_eq
l_int|0
)paren
(brace
id|devtprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered for IOC event notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mpt_reset_register
c_func
(paren
id|ScsiDoneCtx
comma
id|mptscsih_ioc_reset
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Registered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|dinitprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Command Line Args: dv=%d max_width=%d &quot;
l_string|&quot;factor=0x%x saf_te=%d&bslash;n&quot;
comma
id|dv
comma
id|width
comma
id|factor
comma
id|saf_te
)paren
)paren
suffix:semicolon
id|driver_setup.dv
op_assign
(paren
id|dv
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|driver_setup.max_width
op_assign
(paren
id|width
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|driver_setup.min_sync_factor
op_assign
id|factor
suffix:semicolon
id|driver_setup.saf_te
op_assign
(paren
id|saf_te
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mpt_device_driver_register
c_func
(paren
op_amp
id|mptscsih_driver
comma
id|MPTSCSIH_DRIVER
)paren
op_ne
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: failed to register dd callbacks&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_exit - Unregisters MPT adapter(s)&n; *&n; */
r_static
r_void
id|__exit
DECL|function|mptscsih_exit
id|mptscsih_exit
c_func
(paren
r_void
)paren
(brace
id|mpt_device_driver_deregister
c_func
(paren
id|MPTSCSIH_DRIVER
)paren
suffix:semicolon
id|mpt_reset_deregister
c_func
(paren
id|ScsiDoneCtx
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered for IOC reset notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mpt_event_deregister
c_func
(paren
id|ScsiDoneCtx
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
id|MYNAM
l_string|&quot;: Deregistered for IOC event notifications&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|ScsiScanDvCtx
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|ScsiTaskCtx
)paren
suffix:semicolon
id|mpt_deregister
c_func
(paren
id|ScsiDoneCtx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info_kbuf
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|info_kbuf
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_info - Return information about MPT adapter&n; *&t;@SChost: Pointer to Scsi_Host structure&n; *&n; *&t;(linux scsi_host_template.info routine)&n; *&n; *&t;Returns pointer to buffer where information was written.&n; */
r_static
r_const
r_char
op_star
DECL|function|mptscsih_info
id|mptscsih_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|SChost
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|h
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info_kbuf
op_eq
l_int|NULL
)paren
r_if
c_cond
(paren
(paren
id|info_kbuf
op_assign
id|kmalloc
c_func
(paren
l_int|0x1000
multiline_comment|/* 4Kb */
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|info_kbuf
suffix:semicolon
id|h
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SChost-&gt;hostdata
suffix:semicolon
id|info_kbuf
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|h
)paren
(brace
id|mpt_print_ioc_summary
c_func
(paren
id|h-&gt;ioc
comma
id|info_kbuf
comma
op_amp
id|size
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|info_kbuf
(braket
id|size
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|info_kbuf
suffix:semicolon
)brace
DECL|struct|info_str
r_struct
id|info_str
(brace
DECL|member|buffer
r_char
op_star
id|buffer
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
DECL|member|offset
r_int
id|offset
suffix:semicolon
DECL|member|pos
r_int
id|pos
suffix:semicolon
)brace
suffix:semicolon
DECL|function|copy_mem_info
r_static
r_void
id|copy_mem_info
c_func
(paren
r_struct
id|info_str
op_star
id|info
comma
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;pos
op_plus
id|len
OG
id|info-&gt;length
)paren
id|len
op_assign
id|info-&gt;length
op_minus
id|info-&gt;pos
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;pos
op_plus
id|len
OL
id|info-&gt;offset
)paren
(brace
id|info-&gt;pos
op_add_assign
id|len
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;pos
OL
id|info-&gt;offset
)paren
(brace
id|data
op_add_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;pos
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;pos
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|info-&gt;buffer
op_plus
id|info-&gt;pos
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|info-&gt;pos
op_add_assign
id|len
suffix:semicolon
)brace
)brace
DECL|function|copy_info
r_static
r_int
id|copy_info
c_func
(paren
r_struct
id|info_str
op_star
id|info
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_char
id|buf
(braket
l_int|81
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|len
op_assign
id|vsprintf
c_func
(paren
id|buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|copy_mem_info
c_func
(paren
id|info
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|mptscsih_host_info
r_static
r_int
id|mptscsih_host_info
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_char
op_star
id|pbuf
comma
id|off_t
id|offset
comma
r_int
id|len
)paren
(brace
r_struct
id|info_str
id|info
suffix:semicolon
id|info.buffer
op_assign
id|pbuf
suffix:semicolon
id|info.length
op_assign
id|len
suffix:semicolon
id|info.offset
op_assign
id|offset
suffix:semicolon
id|info.pos
op_assign
l_int|0
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;%s: %s, &quot;
comma
id|ioc-&gt;name
comma
id|ioc-&gt;prod_name
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;%s%08xh, &quot;
comma
id|MPT_FW_REV_MAGIC_ID_STRING
comma
id|ioc-&gt;facts.FWVersion.Word
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Ports=%d, &quot;
comma
id|ioc-&gt;facts.NumberOfPorts
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;MaxQ=%d&bslash;n&quot;
comma
id|ioc-&gt;req_depth
)paren
suffix:semicolon
r_return
(paren
(paren
id|info.pos
OG
id|info.offset
)paren
ques
c_cond
id|info.pos
op_minus
id|info.offset
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_proc_info - Return information about MPT adapter&n; *&n; *&t;(linux scsi_host_template.info routine)&n; *&n; * &t;buffer: if write, user data; if read, buffer for user&n; * &t;length: if write, return length;&n; * &t;offset: if write, 0; if read, the current offset into the buffer from&n; * &t;&t;the previous read.&n; * &t;hostno: scsi host number&n; *&t;func:   if write = 1; if read = 0&n; */
r_static
r_int
DECL|function|mptscsih_proc_info
id|mptscsih_proc_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|func
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|func
)paren
(brace
multiline_comment|/* &n;&t;&t; * write is not supported &n;&t;&t; */
)brace
r_else
(brace
r_if
c_cond
(paren
id|start
)paren
op_star
id|start
op_assign
id|buffer
suffix:semicolon
id|size
op_assign
id|mptscsih_host_info
c_func
(paren
id|ioc
comma
id|buffer
comma
id|offset
comma
id|length
)paren
suffix:semicolon
)brace
r_return
id|size
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|macro|ADD_INDEX_LOG
mdefine_line|#define ADD_INDEX_LOG(req_ent)&t;do { } while(0)
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_qcmd - Primary Fusion MPT SCSI initiator IO start routine.&n; *&t;@SCpnt: Pointer to scsi_cmnd structure&n; *&t;@done: Pointer SCSI mid-layer IO completion function&n; *&n; *&t;(linux scsi_host_template.queuecommand routine)&n; *&t;This is the primary SCSI IO start routine.  Create a MPI SCSIIORequest&n; *&t;from a linux scsi_cmnd request and send it to the IOC.&n; *&n; *&t;Returns 0. (rtn value discarded by linux scsi mid-layer)&n; */
r_static
r_int
DECL|function|mptscsih_qcmd
id|mptscsih_qcmd
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pScsiReq
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
r_int
id|target
suffix:semicolon
r_int
id|lun
suffix:semicolon
id|u32
id|datalen
suffix:semicolon
id|u32
id|scsictl
suffix:semicolon
id|u32
id|scsidir
suffix:semicolon
id|u32
id|cmd_len
suffix:semicolon
r_int
id|my_idx
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|target
op_assign
id|SCpnt-&gt;device-&gt;id
suffix:semicolon
id|lun
op_assign
id|SCpnt-&gt;device-&gt;lun
suffix:semicolon
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|target
)braket
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;qcmd: SCpnt=%p, done()=%p&bslash;n&quot;
comma
(paren
id|hd
op_logical_and
id|hd-&gt;ioc
)paren
ques
c_cond
id|hd-&gt;ioc-&gt;name
suffix:colon
l_string|&quot;ioc?&quot;
comma
id|SCpnt
comma
id|done
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;resetPending
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;qcmd: SCpnt=%p timeout + 60HZ&bslash;n&quot;
comma
(paren
id|hd
op_logical_and
id|hd-&gt;ioc
)paren
ques
c_cond
id|hd-&gt;ioc-&gt;name
suffix:colon
l_string|&quot;ioc?&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Put together a MPT SCSI request...&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;QueueCmd, no msg frames!!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|my_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|ADD_INDEX_LOG
c_func
(paren
id|my_idx
)paren
suffix:semicolon
multiline_comment|/*  BUG FIX!  19991030 -sralston&n;&t; *    TUR&squot;s being issued with scsictl=0x02000000 (DATA_IN)!&n;&t; *    Seems we may receive a buffer (datalen&gt;0) even when there&n;&t; *    will be no data transfer!  GRRRRR...&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;sc_data_direction
op_eq
id|DMA_FROM_DEVICE
)paren
(brace
id|datalen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
multiline_comment|/* DATA IN  (host&lt;--ioc&lt;--dev) */
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;sc_data_direction
op_eq
id|DMA_TO_DEVICE
)paren
(brace
id|datalen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
multiline_comment|/* DATA OUT (host--&gt;ioc--&gt;dev) */
)brace
r_else
(brace
id|datalen
op_assign
l_int|0
suffix:semicolon
id|scsidir
op_assign
id|MPI_SCSIIO_CONTROL_NODATATRANSFER
suffix:semicolon
)brace
multiline_comment|/* Default to untagged. Once a target structure has been allocated,&n;&t; * use the Inquiry data to determine if device supports tagged.&n;&t; */
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
op_logical_and
(paren
id|SCpnt-&gt;device-&gt;tagged_supported
)paren
)paren
(brace
id|scsictl
op_assign
id|scsidir
op_or
id|MPI_SCSIIO_CONTROL_SIMPLEQ
suffix:semicolon
)brace
r_else
(brace
id|scsictl
op_assign
id|scsidir
op_or
id|MPI_SCSIIO_CONTROL_UNTAGGED
suffix:semicolon
)brace
multiline_comment|/* Use the above information to set up the message frame&n;&t; */
id|pScsiReq-&gt;TargetID
op_assign
(paren
id|u8
)paren
id|target
suffix:semicolon
id|pScsiReq-&gt;Bus
op_assign
(paren
id|u8
)paren
id|SCpnt-&gt;device-&gt;channel
suffix:semicolon
id|pScsiReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_IO_REQUEST
suffix:semicolon
id|pScsiReq-&gt;CDBLength
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|MPT_SENSE_BUFFER_SIZE
suffix:semicolon
id|pScsiReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;MsgFlags
op_assign
id|mpt_msg_flags
c_func
(paren
)paren
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
op_assign
id|lun
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|scsictl
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Write SCSI CDB into the message&n;&t; */
id|cmd_len
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|cmd_len
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiReq-&gt;CDB
(braket
id|ii
)braket
op_assign
id|SCpnt-&gt;cmnd
(braket
id|ii
)braket
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
id|cmd_len
suffix:semicolon
id|ii
OL
l_int|16
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiReq-&gt;CDB
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DataLength */
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|datalen
)paren
suffix:semicolon
multiline_comment|/* SenseBuffer low address */
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|hd-&gt;ioc-&gt;sense_buf_low_dma
op_plus
(paren
id|my_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
multiline_comment|/* Now add the SG list&n;&t; * Always have a SGE even if null length.&n;&t; */
r_if
c_cond
(paren
id|datalen
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Add a NULL SGE */
id|mptscsih_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pScsiReq-&gt;SGL
comma
id|MPT_SGE_FLAGS_SSIMPLE_READ
op_or
l_int|0
comma
(paren
id|dma_addr_t
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Add a 32 or 64 bit SGE */
r_if
c_cond
(paren
id|mptscsih_AddSGE
c_func
(paren
id|hd-&gt;ioc
comma
id|SCpnt
comma
id|pScsiReq
comma
id|my_idx
)paren
op_ne
id|SUCCESS
)paren
r_goto
id|fail
suffix:semicolon
)brace
id|hd-&gt;ScsiLookup
(braket
id|my_idx
)braket
op_assign
id|SCpnt
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
r_int
id|dvStatus
op_assign
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|target
)braket
suffix:semicolon
r_int
id|issueCmd
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dvStatus
op_logical_or
id|hd-&gt;ioc-&gt;spi_data.forceDv
)paren
(brace
r_if
c_cond
(paren
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_NEED_DV
)paren
op_logical_or
(paren
id|hd-&gt;ioc-&gt;spi_data.forceDv
op_amp
id|MPT_SCSICFG_NEED_DV
)paren
)paren
(brace
r_int
r_int
id|lflags
suffix:semicolon
multiline_comment|/* Schedule DV if necessary */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dvtaskQ_active
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|mptscsih_dvTask
comma
id|mptscsih_domainValidation
comma
(paren
r_void
op_star
)paren
id|hd
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|mptscsih_dvTask
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|lflags
)paren
suffix:semicolon
)brace
id|hd-&gt;ioc-&gt;spi_data.forceDv
op_and_assign
op_complement
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
)brace
multiline_comment|/* Trying to do DV to this target, extend timeout.&n;&t;&t;&t; * Wait to issue until flag is clear&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_DV_PENDING
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|SCpnt-&gt;eh_timeout
comma
id|jiffies
op_plus
l_int|40
op_star
id|HZ
)paren
suffix:semicolon
id|issueCmd
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the DV flags.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_DV_NOT_DONE
)paren
id|mptscsih_set_dvflags
c_func
(paren
id|hd
comma
id|pScsiReq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|issueCmd
)paren
r_goto
id|fail
suffix:semicolon
)brace
)brace
macro_line|#endif
id|mpt_put_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|hd-&gt;ioc
comma
id|mf
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Issued SCSI cmd (%p) mf=%p idx=%d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
comma
id|mf
comma
id|my_idx
)paren
)paren
suffix:semicolon
id|DBG_DUMP_REQUEST_FRAME
c_func
(paren
id|mf
)paren
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|mptscsih_freeChainBuffers
c_func
(paren
id|hd-&gt;ioc
comma
id|my_idx
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|hd-&gt;ioc
comma
id|mf
)paren
suffix:semicolon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_freeChainBuffers - Function to free chain buffers associated&n; *&t;with a SCSI IO request&n; *&t;@hd: Pointer to the MPT_SCSI_HOST instance&n; *&t;@req_idx: Index of the SCSI IO request frame.&n; *&n; *&t;Called if SG chain buffer allocation fails and mptscsih callbacks.&n; *&t;No return.&n; */
r_static
r_void
DECL|function|mptscsih_freeChainBuffers
id|mptscsih_freeChainBuffers
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|req_idx
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|chain
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|chain_idx
suffix:semicolon
r_int
id|next
suffix:semicolon
multiline_comment|/* Get the first chain index and reset&n;&t; * tracker state.&n;&t; */
id|chain_idx
op_assign
id|ioc-&gt;ReqToChain
(braket
id|req_idx
)braket
suffix:semicolon
id|ioc-&gt;ReqToChain
(braket
id|req_idx
)braket
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
r_while
c_loop
(paren
id|chain_idx
op_ne
id|MPT_HOST_NO_CHAIN
)paren
(brace
multiline_comment|/* Save the next chain buffer index */
id|next
op_assign
id|ioc-&gt;ChainToChain
(braket
id|chain_idx
)braket
suffix:semicolon
multiline_comment|/* Free this chain buffer and reset&n;&t;&t; * tracker&n;&t;&t; */
id|ioc-&gt;ChainToChain
(braket
id|chain_idx
)braket
op_assign
id|MPT_HOST_NO_CHAIN
suffix:semicolon
id|chain
op_assign
(paren
id|MPT_FRAME_HDR
op_star
)paren
(paren
id|ioc-&gt;ChainBuffer
op_plus
(paren
id|chain_idx
op_star
id|ioc-&gt;req_sz
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|chain-&gt;u.frame.linkage.list
comma
op_amp
id|ioc-&gt;FreeChainQ
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|dmfprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;FreeChainBuffers (index %d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|chain_idx
)paren
)paren
suffix:semicolon
multiline_comment|/* handle next */
id|chain_idx
op_assign
id|next
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;Reset Handling&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_TMHandler - Generic handler for SCSI Task Management.&n; *&t;Fall through to mpt_HardResetHandler if: not operational, too many&n; *&t;failed TM requests or handshake failure.&n; *&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@type: Task Management type&n; *&t;@target: Logical Target ID for reset (if appropriate)&n; *&t;@lun: Logical Unit for reset (if appropriate)&n; *&t;@ctx2abort: Context for the task to be aborted (if appropriate)&n; *&t;@sleepFlag: If set, use udelay instead of schedule in handshake code.&n; *&n; *&t;Remark: Currently invoked from a non-interrupt thread (_bh).&n; *&n; *&t;Remark: With old EH code, at most 1 SCSI TaskMgmt function per IOC&n; *&t;will be active.&n; *&n; *&t;Returns 0 for SUCCESS or -1 if FAILED.&n; */
r_static
r_int
DECL|function|mptscsih_TMHandler
id|mptscsih_TMHandler
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|type
comma
id|u8
id|channel
comma
id|u8
id|target
comma
id|u8
id|lun
comma
r_int
id|ctx2abort
comma
id|ulong
id|timeout
comma
r_int
id|sleepFlag
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|doTask
op_assign
l_int|1
suffix:semicolon
id|u32
id|ioc_raw_state
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* If FW is being reloaded currently, return success to&n;&t; * the calling function.&n;&t; */
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
r_if
c_cond
(paren
id|ioc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MYNAM
l_string|&quot; TMHandler&quot;
l_string|&quot; NULL ioc!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;TMHandler Entered!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
singleline_comment|// SJR - CHECKME - Can we avoid this here?
singleline_comment|// (mpt_HardResetHandler has this check...)
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;diagPending
)paren
op_logical_or
(paren
id|ioc-&gt;alt_ioc
op_logical_and
id|ioc-&gt;alt_ioc-&gt;diagPending
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;diagLock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*  Wait a fixed amount of time for the TM pending flag to be cleared.&n;&t; *  If we time out and not bus reset, then we return a FAILED status to the caller.&n;&t; *  The call to mptscsih_tm_pending_wait() will set the pending flag if we are&n;&t; *  successful. Otherwise, reload the FW.&n;&t; */
r_if
c_cond
(paren
id|mptscsih_tm_pending_wait
c_func
(paren
id|hd
)paren
op_eq
id|FAILED
)paren
(brace
r_if
c_cond
(paren
id|type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: TMHandler abort: &quot;
l_string|&quot;Timed out waiting for last TM (%d) to complete! &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|hd-&gt;tmPending
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: TMHandler target reset: &quot;
l_string|&quot;Timed out waiting for last TM (%d) to complete! &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|hd-&gt;tmPending
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: TMHandler bus reset: &quot;
l_string|&quot;Timed out waiting for last TM (%d) to complete! &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|hd-&gt;tmPending
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmPending
op_amp
(paren
l_int|1
op_lshift
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
)paren
r_return
id|FAILED
suffix:semicolon
id|doTask
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_or_assign
(paren
l_int|1
op_lshift
id|type
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Is operational?&n;&t; */
id|ioc_raw_state
op_assign
id|mpt_GetIocState
c_func
(paren
id|hd-&gt;ioc
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef MPT_DEBUG_RESET
r_if
c_cond
(paren
(paren
id|ioc_raw_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_ne
id|MPI_IOC_STATE_OPERATIONAL
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;TM Handler: IOC Not operational(0x%x)!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|ioc_raw_state
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|doTask
op_logical_and
(paren
(paren
id|ioc_raw_state
op_amp
id|MPI_IOC_STATE_MASK
)paren
op_eq
id|MPI_IOC_STATE_OPERATIONAL
)paren
op_logical_and
op_logical_neg
(paren
id|ioc_raw_state
op_amp
id|MPI_DOORBELL_ACTIVE
)paren
)paren
(brace
multiline_comment|/* Isse the Task Mgmt request.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;hard_resets
OL
op_minus
l_int|1
)paren
id|hd-&gt;hard_resets
op_increment
suffix:semicolon
id|rc
op_assign
id|mptscsih_IssueTaskMgmt
c_func
(paren
id|hd
comma
id|type
comma
id|channel
comma
id|target
comma
id|lun
comma
id|ctx2abort
comma
id|timeout
comma
id|sleepFlag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Issue of TaskMgmt failed!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Issue of TaskMgmt Successful!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Only fall through to the HRH if this is a bus reset&n;&t; */
r_if
c_cond
(paren
(paren
id|type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
op_logical_and
(paren
id|rc
op_logical_or
id|ioc-&gt;reload_fw
op_logical_or
(paren
id|ioc-&gt;alt_ioc
op_logical_and
id|ioc-&gt;alt_ioc-&gt;reload_fw
)paren
)paren
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Calling HardReset! &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|sleepFlag
)paren
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;TMHandler rc = %d!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_IssueTaskMgmt - Generic send Task Management function.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@type: Task Management type&n; *&t;@target: Logical Target ID for reset (if appropriate)&n; *&t;@lun: Logical Unit for reset (if appropriate)&n; *&t;@ctx2abort: Context for the task to be aborted (if appropriate)&n; *&t;@sleepFlag: If set, use udelay instead of schedule in handshake code.&n; *&n; *&t;Remark: _HardResetHandler can be invoked from an interrupt thread (timer)&n; *&t;or a non-interrupt thread.  In the former, must not call schedule().&n; *&n; *&t;Not all fields are meaningfull for all task types.&n; *&n; *&t;Returns 0 for SUCCESS, -999 for &quot;no msg frames&quot;,&n; *&t;else other non-zero value returned.&n; */
r_static
r_int
DECL|function|mptscsih_IssueTaskMgmt
id|mptscsih_IssueTaskMgmt
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|type
comma
id|u8
id|channel
comma
id|u8
id|target
comma
id|u8
id|lun
comma
r_int
id|ctx2abort
comma
id|ulong
id|timeout
comma
r_int
id|sleepFlag
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTm
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|retval
suffix:semicolon
multiline_comment|/* Return Fail to calling function if no message frames available.&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dfailprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;IssueTaskMgmt, no msg frames!!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
singleline_comment|//return FAILED;
r_return
op_minus
l_int|999
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;IssueTaskMgmt request @ %p&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|mf
)paren
)paren
suffix:semicolon
multiline_comment|/* Format the Request&n;&t; */
id|pScsiTm
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
id|pScsiTm-&gt;TargetID
op_assign
id|target
suffix:semicolon
id|pScsiTm-&gt;Bus
op_assign
id|channel
suffix:semicolon
id|pScsiTm-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_TASK_MGMT
suffix:semicolon
id|pScsiTm-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskType
op_assign
id|type
suffix:semicolon
id|pScsiTm-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;MsgFlags
op_assign
(paren
id|type
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
ques
c_cond
id|MPI_SCSITASKMGMT_MSGFLAGS_LIPRESET_RESET_OPTION
suffix:colon
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|pScsiTm-&gt;LUN
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|pScsiTm-&gt;LUN
(braket
l_int|1
)braket
op_assign
id|lun
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|7
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiTm-&gt;Reserved2
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiTm-&gt;TaskMsgContext
op_assign
id|ctx2abort
suffix:semicolon
multiline_comment|/* MPI v0.10 requires SCSITaskMgmt requests be sent via Doorbell/handshake&n;&t;&t;mpt_put_msg_frame(hd-&gt;ioc-&gt;id, mf);&n;&t;* Save the MF pointer in case the request times out.&n;&t;*/
id|hd-&gt;tmPtr
op_assign
id|mf
suffix:semicolon
id|hd-&gt;TMtimer.expires
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;IssueTaskMgmt: ctx2abort (0x%08x) type=%d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|ctx2abort
comma
id|type
)paren
)paren
suffix:semicolon
id|DBG_DUMP_TM_REQUEST_FRAME
c_func
(paren
(paren
id|u32
op_star
)paren
id|pScsiTm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|mpt_send_handshake_request
c_func
(paren
id|ScsiTaskCtx
comma
id|hd-&gt;ioc
comma
r_sizeof
(paren
id|SCSITaskMgmt_t
)paren
comma
(paren
id|u32
op_star
)paren
id|pScsiTm
comma
id|sleepFlag
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dfailprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;_send_handshake FAILED!&quot;
l_string|&quot; (hd %p, ioc %p, mf %p) &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|hd
comma
id|hd-&gt;ioc
comma
id|mf
)paren
)paren
suffix:semicolon
id|hd-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|hd-&gt;ioc
comma
id|mf
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_abort - Abort linux scsi_cmnd routine, new_eh variant&n; *&t;@SCpnt: Pointer to scsi_cmnd structure, IO to be aborted&n; *&n; *&t;(linux scsi_host_template.eh_abort_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_static
r_int
DECL|function|mptscsih_abort
id|mptscsih_abort
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|u32
id|ctx2abort
suffix:semicolon
r_int
id|scpnt_idx
suffix:semicolon
id|spinlock_t
op_star
id|host_lock
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;host_lock
suffix:semicolon
multiline_comment|/* If we can&squot;t locate our host adapter structure, return FAILED status.&n;&t; */
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|dfailprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_abort: &quot;
l_string|&quot;Can&squot;t locate host! (sc=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;resetPending
)paren
r_return
id|FAILED
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: &gt;&gt; Attempting task abort! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;timeouts
OL
op_minus
l_int|1
)paren
id|hd-&gt;timeouts
op_increment
suffix:semicolon
multiline_comment|/* Find this command&n;&t; */
r_if
c_cond
(paren
(paren
id|scpnt_idx
op_assign
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
id|SCpnt
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Cmd not found in ScsiLookup. &n;&t;&t; * Do OS callback.&n;&t;&t; */
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_abort: &quot;
l_string|&quot;Command not in the active list! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/* Most important!  Set TaskMsgContext to SCpnt&squot;s MsgContext!&n;&t; * (the IO to be ABORT&squot;d)&n;&t; *&n;&t; * NOTE: Since we do not byteswap MsgContext, we do not&n;&t; *&t; swap it here either.  It is an opaque cookie to&n;&t; *&t; the controller, so it does not matter. -DaveM&n;&t; */
id|mf
op_assign
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|hd-&gt;ioc
comma
id|scpnt_idx
)paren
suffix:semicolon
id|ctx2abort
op_assign
id|mf-&gt;u.frame.hwhdr.msgctxu.MsgContext
suffix:semicolon
id|hd-&gt;abortSCpnt
op_assign
id|SCpnt
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_TMHandler
c_func
(paren
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
comma
id|SCpnt-&gt;device-&gt;channel
comma
id|SCpnt-&gt;device-&gt;id
comma
id|SCpnt-&gt;device-&gt;lun
comma
id|ctx2abort
comma
(paren
id|HZ
op_star
l_int|2
)paren
multiline_comment|/* 2 second timeout */
comma
id|CAN_SLEEP
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* The TM request failed and the subsequent FW-reload failed!&n;&t;&t; * Fatal error case.&n;&t;&t; */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Error issuing abort task! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* We must clear our pending flag before clearing our state.&n;&t;&t; */
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
multiline_comment|/* Unmap the DMA buffers, if any. */
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|ioc-&gt;pcidev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;use_sg
comma
id|SCpnt-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;request_bufflen
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|ioc-&gt;pcidev
comma
id|SCpnt-&gt;SCp.dma_handle
comma
id|SCpnt-&gt;request_bufflen
comma
id|SCpnt-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
id|hd-&gt;ScsiLookup
(braket
id|scpnt_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Issue the command callback */
id|mptscsih_freeChainBuffers
c_func
(paren
id|ioc
comma
id|scpnt_idx
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ioc
comma
id|mf
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_dev_reset - Perform a SCSI TARGET_RESET!  new_eh variant&n; *&t;@SCpnt: Pointer to scsi_cmnd structure, IO which reset is due to&n; *&n; *&t;(linux scsi_host_template.eh_dev_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_static
r_int
DECL|function|mptscsih_dev_reset
id|mptscsih_dev_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|spinlock_t
op_star
id|host_lock
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;host_lock
suffix:semicolon
multiline_comment|/* If we can&squot;t locate our host adapter structure, return FAILED status.&n;&t; */
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_dev_reset: &quot;
l_string|&quot;Can&squot;t locate host! (sc=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd-&gt;resetPending
)paren
r_return
id|FAILED
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: &gt;&gt; Attempting target reset! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Supported for FC only.&n;&t; */
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;bus_type
op_eq
id|SCSI
)paren
r_return
id|FAILED
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_TMHandler
c_func
(paren
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET
comma
id|SCpnt-&gt;device-&gt;channel
comma
id|SCpnt-&gt;device-&gt;id
comma
l_int|0
comma
l_int|0
comma
(paren
id|HZ
op_star
l_int|5
)paren
multiline_comment|/* 5 second timeout */
comma
id|CAN_SLEEP
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* The TM request failed and the subsequent FW-reload failed!&n;&t;&t; * Fatal error case.&n;&t;&t; */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Error processing TaskMgmt request (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_bus_reset - Perform a SCSI BUS_RESET!&t;new_eh variant&n; *&t;@SCpnt: Pointer to scsi_cmnd structure, IO which reset is due to&n; *&n; *&t;(linux scsi_host_template.eh_bus_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_static
r_int
DECL|function|mptscsih_bus_reset
id|mptscsih_bus_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|spinlock_t
op_star
id|host_lock
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;host_lock
suffix:semicolon
multiline_comment|/* If we can&squot;t locate our host adapter structure, return FAILED status.&n;&t; */
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_bus_reset: &quot;
l_string|&quot;Can&squot;t locate host! (sc=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: &gt;&gt; Attempting bus reset! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;timeouts
OL
op_minus
l_int|1
)paren
id|hd-&gt;timeouts
op_increment
suffix:semicolon
multiline_comment|/* We are now ready to execute the task management request. */
id|spin_unlock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_TMHandler
c_func
(paren
id|hd
comma
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
comma
id|SCpnt-&gt;device-&gt;channel
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
(paren
id|HZ
op_star
l_int|5
)paren
multiline_comment|/* 5 second timeout */
comma
id|CAN_SLEEP
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* The TM request failed and the subsequent FW-reload failed!&n;&t;&t; * Fatal error case.&n;&t;&t; */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Error processing TaskMgmt request (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_host_reset - Perform a SCSI host adapter RESET!&n; *&t;new_eh variant&n; *&t;@SCpnt: Pointer to scsi_cmnd structure, IO which reset is due to&n; *&n; *&t;(linux scsi_host_template.eh_host_reset_handler routine)&n; *&n; *&t;Returns SUCCESS or FAILED.&n; */
r_static
r_int
DECL|function|mptscsih_host_reset
id|mptscsih_host_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|status
op_assign
id|SUCCESS
suffix:semicolon
id|spinlock_t
op_star
id|host_lock
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;host_lock
suffix:semicolon
multiline_comment|/*  If we can&squot;t locate the host to reset, then we failed. */
r_if
c_cond
(paren
(paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
)paren
op_eq
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_host_reset: &quot;
l_string|&quot;Can&squot;t locate host! (sc=%p)&bslash;n&quot;
comma
id|SCpnt
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: &gt;&gt; Attempting host reset! (sc=%p)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/*  If our attempts to reset the host failed, then return a failed&n;&t; *  status.  The host will be taken off line by the SCSI mid-layer.&n;&t; */
id|spin_unlock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|CAN_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|status
op_assign
id|FAILED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*  Make sure TM pending is cleared and TM state is set to&n;&t;&t; *  NONE.&n;&t;&t; */
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
id|host_lock
)paren
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: mptscsih_host_reset: &quot;
l_string|&quot;Status = %s&bslash;n&quot;
comma
(paren
id|status
op_eq
id|SUCCESS
)paren
ques
c_cond
l_string|&quot;SUCCESS&quot;
suffix:colon
l_string|&quot;FAILED&quot;
)paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_tm_pending_wait - wait for pending task management request to&n; *&t;&t;complete.&n; *&t;@hd: Pointer to MPT host structure.&n; *&n; *&t;Returns {SUCCESS,FAILED}.&n; */
r_static
r_int
DECL|function|mptscsih_tm_pending_wait
id|mptscsih_tm_pending_wait
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|loop_count
op_assign
l_int|10
op_star
l_int|4
suffix:semicolon
multiline_comment|/* Wait 10 seconds */
r_int
id|status
op_assign
id|FAILED
suffix:semicolon
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmState
op_eq
id|TM_STATE_NONE
)paren
(brace
id|hd-&gt;tmState
op_assign
id|TM_STATE_IN_PROGRESS
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hd-&gt;ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|loop_count
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_taskmgmt_complete - Registered with Fusion MPT base driver&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to SCSI task mgmt request frame&n; *&t;@mr: Pointer to SCSI task mgmt reply frame&n; *&n; *&t;This routine is called from mptbase.c::mpt_interrupt() at the completion&n; *&t;of any SCSI task management request.&n; *&t;This routine is registered with the MPT (base) driver at driver&n; *&t;load/init time via the mpt_register() API call.&n; *&n; *&t;Returns 1 indicating alloc&squot;d request frame ptr should be freed.&n; */
r_static
r_int
DECL|function|mptscsih_taskmgmt_complete
id|mptscsih_taskmgmt_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|mr
)paren
(brace
id|SCSITaskMgmtReply_t
op_star
id|pScsiTmReply
suffix:semicolon
id|SCSITaskMgmt_t
op_star
id|pScsiTmReq
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|iocstatus
suffix:semicolon
id|u8
id|tmType
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;TaskMgmt completed (mf=%p,mr=%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
comma
id|mr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
multiline_comment|/* Depending on the thread, a timer is activated for&n;&t;&t; * the TM request.  Delete this timer on completion of TM.&n;&t;&t; * Decrement count of outstanding TM requests.&n;&t;&t; */
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;tmPtr
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;TaskMgmt Complete: NULL Scsi Host Ptr&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mr
op_eq
l_int|NULL
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;ERROR! TaskMgmt Reply: NULL Request %p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|pScsiTmReply
op_assign
(paren
id|SCSITaskMgmtReply_t
op_star
)paren
id|mr
suffix:semicolon
id|pScsiTmReq
op_assign
(paren
id|SCSITaskMgmt_t
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Figure out if this was ABORT_TASK, TARGET_RESET, or BUS_RESET! */
id|tmType
op_assign
id|pScsiTmReq-&gt;TaskType
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;  TaskType = %d, TerminationCount=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|tmType
comma
id|le32_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;TerminationCount
)paren
)paren
)paren
suffix:semicolon
id|DBG_DUMP_TM_REPLY_FRAME
c_func
(paren
(paren
id|u32
op_star
)paren
id|pScsiTmReply
)paren
suffix:semicolon
id|iocstatus
op_assign
id|le16_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;  SCSI TaskMgmt (%d) IOCStatus=%04x IOCLogInfo=%08x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|tmType
comma
id|iocstatus
comma
id|le32_to_cpu
c_func
(paren
id|pScsiTmReply-&gt;IOCLogInfo
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Error?  (anything non-zero?) */
r_if
c_cond
(paren
id|iocstatus
)paren
(brace
multiline_comment|/* clear flags and continue.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|tmType
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
)paren
id|hd-&gt;abortSCpnt
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* If an internal command is present&n;&t;&t;&t; * or the TM failed - reload the FW.&n;&t;&t;&t; * FC FW may respond FAILED to an ABORT&n;&t;&t;&t; */
r_if
c_cond
(paren
id|tmType
op_eq
id|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
)paren
(brace
r_if
c_cond
(paren
(paren
id|hd-&gt;cmdPtr
)paren
op_logical_or
(paren
id|iocstatus
op_eq
id|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
)paren
)paren
(brace
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|ioc
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot; Firmware Reload FAILED!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot; TaskMgmt SUCCESS&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|hd-&gt;abortSCpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|hd-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;This is anyones guess quite frankly.&n; */
r_static
r_int
DECL|function|mptscsih_bios_param
id|mptscsih_bios_param
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
suffix:semicolon
r_int
id|sectors
suffix:semicolon
id|sector_t
id|cylinders
suffix:semicolon
id|ulong
id|dummy
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|dummy
op_assign
id|heads
op_star
id|sectors
suffix:semicolon
id|cylinders
op_assign
id|capacity
suffix:semicolon
id|sector_div
c_func
(paren
id|cylinders
comma
id|dummy
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Handle extended translation size for logical drives&n;&t; * &gt; 1Gb&n;&t; */
r_if
c_cond
(paren
(paren
id|ulong
)paren
id|capacity
op_ge
l_int|0x200000
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|dummy
op_assign
id|heads
op_star
id|sectors
suffix:semicolon
id|cylinders
op_assign
id|capacity
suffix:semicolon
id|sector_div
c_func
(paren
id|cylinders
comma
id|dummy
)paren
suffix:semicolon
)brace
multiline_comment|/* return result */
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;: bios_param: Id=%i Lun=%i Channel=%i CHS=%i/%i/%i&bslash;n&quot;
comma
id|sdev-&gt;id
comma
id|sdev-&gt;lun
comma
id|sdev-&gt;channel
comma
(paren
r_int
)paren
id|cylinders
comma
id|heads
comma
id|sectors
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;OS entry point to allow host driver to alloc memory&n; *&t;for each scsi device. Called once per device the bus scan.&n; *&t;Return non-zero if allocation fails.&n; *&t;Init memory once per id (not LUN).&n; */
r_static
r_int
DECL|function|mptscsih_slave_alloc
id|mptscsih_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|device
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|device-&gt;host
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|VirtDevice
op_star
id|vdev
suffix:semicolon
id|uint
id|target
op_assign
id|device-&gt;id
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vdev
op_assign
id|hd-&gt;Targets
(braket
id|target
)braket
)paren
op_ne
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|vdev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|VirtDevice
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vdev
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;slave_alloc kmalloc(%zd) FAILED!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
r_sizeof
(paren
id|VirtDevice
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|vdev
comma
l_int|0
comma
r_sizeof
(paren
id|VirtDevice
)paren
)paren
suffix:semicolon
id|vdev-&gt;tflags
op_assign
id|MPT_TARGET_FLAGS_Q_YES
suffix:semicolon
id|vdev-&gt;ioc_id
op_assign
id|hd-&gt;ioc-&gt;id
suffix:semicolon
id|vdev-&gt;target_id
op_assign
id|device-&gt;id
suffix:semicolon
id|vdev-&gt;bus_id
op_assign
id|device-&gt;channel
suffix:semicolon
id|vdev-&gt;raidVolume
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;Targets
(braket
id|device-&gt;id
)braket
op_assign
id|vdev
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_amp
(paren
l_int|1
op_lshift
id|device-&gt;id
)paren
)paren
(brace
id|vdev-&gt;raidVolume
op_assign
l_int|1
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;RAID Volume @ id %d&bslash;n&quot;
comma
id|device-&gt;id
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|vdev-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_INQUIRY
suffix:semicolon
)brace
id|out
suffix:colon
id|vdev-&gt;num_luns
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mptscsih_is_raid_volume
r_static
r_int
id|mptscsih_is_raid_volume
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|uint
id|id
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_logical_or
op_logical_neg
id|hd-&gt;ioc-&gt;spi_data.pIocPg3
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hd-&gt;ioc-&gt;spi_data.pIocPg3-&gt;NumPhysDisks
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|id
op_eq
id|hd-&gt;ioc-&gt;spi_data.pIocPg3-&gt;PhysDisk
(braket
id|i
)braket
dot
id|PhysDiskID
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;OS entry point to allow for host driver to free allocated memory&n; *&t;Called if no device present or device being unloaded&n; */
r_static
r_void
DECL|function|mptscsih_slave_destroy
id|mptscsih_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|device
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|device-&gt;host
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|VirtDevice
op_star
id|vdev
suffix:semicolon
id|uint
id|target
op_assign
id|device-&gt;id
suffix:semicolon
id|uint
id|lun
op_assign
id|device-&gt;lun
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|mptscsih_search_running_cmds
c_func
(paren
id|hd
comma
id|target
comma
id|lun
)paren
suffix:semicolon
id|vdev
op_assign
id|hd-&gt;Targets
(braket
id|target
)braket
suffix:semicolon
id|vdev-&gt;luns
(braket
l_int|0
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|vdev-&gt;num_luns
)paren
r_return
suffix:semicolon
id|kfree
c_func
(paren
id|hd-&gt;Targets
(braket
id|target
)braket
)paren
suffix:semicolon
id|hd-&gt;Targets
(braket
id|target
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
r_if
c_cond
(paren
id|mptscsih_is_raid_volume
c_func
(paren
id|hd
comma
id|target
)paren
)paren
(brace
id|hd-&gt;ioc-&gt;spi_data.forceDv
op_or_assign
id|MPT_SCSICFG_RELOAD_IOC_PG3
suffix:semicolon
)brace
r_else
(brace
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|target
)braket
op_assign
id|MPT_SCSICFG_NEGOTIATE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hd-&gt;negoNvram
)paren
(brace
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|target
)braket
op_or_assign
id|MPT_SCSICFG_DV_NOT_DONE
suffix:semicolon
)brace
)brace
)brace
)brace
r_static
r_void
DECL|function|mptscsih_set_queue_depth
id|mptscsih_set_queue_depth
c_func
(paren
r_struct
id|scsi_device
op_star
id|device
comma
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|VirtDevice
op_star
id|pTarget
comma
r_int
id|qdepth
)paren
(brace
r_int
id|max_depth
suffix:semicolon
r_int
id|tagged
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
r_if
c_cond
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_INQUIRY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
)paren
id|max_depth
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
(paren
id|pTarget-&gt;inq_data
(braket
l_int|0
)braket
op_amp
l_int|0x1f
)paren
op_eq
l_int|0x00
)paren
op_logical_and
(paren
id|pTarget-&gt;minSyncFactor
op_le
id|MPT_ULTRA160
)paren
)paren
id|max_depth
op_assign
id|MPT_SCSI_CMD_PER_DEV_HIGH
suffix:semicolon
r_else
id|max_depth
op_assign
id|MPT_SCSI_CMD_PER_DEV_LOW
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* error case - No Inq. Data */
id|max_depth
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
id|max_depth
op_assign
id|MPT_SCSI_CMD_PER_DEV_HIGH
suffix:semicolon
r_if
c_cond
(paren
id|qdepth
OG
id|max_depth
)paren
id|qdepth
op_assign
id|max_depth
suffix:semicolon
r_if
c_cond
(paren
id|qdepth
op_eq
l_int|1
)paren
id|tagged
op_assign
l_int|0
suffix:semicolon
r_else
id|tagged
op_assign
id|MSG_SIMPLE_TAG
suffix:semicolon
id|scsi_adjust_queue_depth
c_func
(paren
id|device
comma
id|tagged
comma
id|qdepth
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;OS entry point to adjust the queue_depths on a per-device basis.&n; *&t;Called once per device the bus scan. Use it to force the queue_depth&n; *&t;member to 1 if a device does not support Q tags.&n; *&t;Return non-zero if fails.&n; */
r_static
r_int
DECL|function|mptscsih_slave_configure
id|mptscsih_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|device
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|sh
op_assign
id|device-&gt;host
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|hd-&gt;Targets
op_eq
l_int|NULL
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|dsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;device @ %p, id=%d, LUN=%d, channel=%d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|device
comma
id|device-&gt;id
comma
id|device-&gt;lun
comma
id|device-&gt;channel
)paren
)paren
suffix:semicolon
id|dsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;sdtr %d wdtr %d ppr %d inq length=%d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|device-&gt;sdtr
comma
id|device-&gt;wdtr
comma
id|device-&gt;ppr
comma
id|device-&gt;inquiry_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;id
OG
id|sh-&gt;max_id
)paren
(brace
multiline_comment|/* error case, should never happen */
id|scsi_adjust_queue_depth
c_func
(paren
id|device
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|slave_configure_exit
suffix:semicolon
)brace
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|device-&gt;id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pTarget
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Driver doesn&squot;t know about this device.&n;&t;&t; * Kernel may generate a &quot;Dummy Lun 0&quot; which&n;&t;&t; * may become a real Lun if a &n;&t;&t; * &quot;scsi add-single-device&quot; command is executed&n;&t;&t; * while the driver is active (hot-plug a &n;&t;&t; * device).  LSI Raid controllers need &n;&t;&t; * queue_depth set to DEV_HIGH for this reason.&n;&t;&t; */
id|scsi_adjust_queue_depth
c_func
(paren
id|device
comma
id|MSG_SIMPLE_TAG
comma
id|MPT_SCSI_CMD_PER_DEV_HIGH
)paren
suffix:semicolon
r_goto
id|slave_configure_exit
suffix:semicolon
)brace
id|mptscsih_initTarget
c_func
(paren
id|hd
comma
id|device-&gt;channel
comma
id|device-&gt;id
comma
id|device-&gt;lun
comma
id|device-&gt;inquiry
comma
id|device-&gt;inquiry_len
)paren
suffix:semicolon
id|mptscsih_set_queue_depth
c_func
(paren
id|device
comma
id|hd
comma
id|pTarget
comma
id|MPT_SCSI_CMD_PER_DEV_HIGH
)paren
suffix:semicolon
id|dsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Queue depth=%d, tflags=%x&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|device-&gt;queue_depth
comma
id|pTarget-&gt;tflags
)paren
)paren
suffix:semicolon
id|dsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;negoFlags=%x, maxOffset=%x, SyncFactor=%x&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|pTarget-&gt;negoFlags
comma
id|pTarget-&gt;maxOffset
comma
id|pTarget-&gt;minSyncFactor
)paren
)paren
suffix:semicolon
id|slave_configure_exit
suffix:colon
id|dsprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;tagged %d, simple %d, ordered %d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|device-&gt;tagged_supported
comma
id|device-&gt;simple_tags
comma
id|device-&gt;ordered_tags
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|mptscsih_store_queue_depth
id|mptscsih_store_queue_depth
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|depth
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
id|depth
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|depth
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|sdev-&gt;id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pTarget
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|mptscsih_set_queue_depth
c_func
(paren
id|sdev
comma
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
comma
id|pTarget
comma
id|depth
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Private routines...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* Utility function to copy sense data from the scsi_cmnd buffer&n; * to the FC and SCSI target structures.&n; *&n; */
r_static
r_void
DECL|function|copy_sense_data
id|copy_sense_data
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|sc
comma
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|SCSIIOReply_t
op_star
id|pScsiReply
)paren
(brace
id|VirtDevice
op_star
id|target
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pReq
suffix:semicolon
id|u32
id|sense_count
op_assign
id|le32_to_cpu
c_func
(paren
id|pScsiReply-&gt;SenseCount
)paren
suffix:semicolon
r_int
id|index
suffix:semicolon
multiline_comment|/* Get target structure&n;&t; */
id|pReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
id|index
op_assign
(paren
r_int
)paren
id|pReq-&gt;TargetID
suffix:semicolon
id|target
op_assign
id|hd-&gt;Targets
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sense_count
)paren
(brace
id|u8
op_star
id|sense_data
suffix:semicolon
r_int
id|req_index
suffix:semicolon
multiline_comment|/* Copy the sense received into the scsi command block. */
id|req_index
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|sense_data
op_assign
(paren
(paren
id|u8
op_star
)paren
id|hd-&gt;ioc-&gt;sense_buf_pool
op_plus
(paren
id|req_index
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|sc-&gt;sense_buffer
comma
id|sense_data
comma
id|SNS_LEN
c_func
(paren
id|sc
)paren
)paren
suffix:semicolon
multiline_comment|/* Log SMART data (asc = 0x5D, non-IM case only) if required.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;events
)paren
op_logical_and
(paren
id|hd-&gt;ioc-&gt;eventTypes
op_amp
(paren
l_int|1
op_lshift
id|MPI_EVENT_SCSI_DEVICE_STATUS_CHANGE
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|sense_data
(braket
l_int|12
)braket
op_eq
l_int|0x5D
)paren
op_logical_and
(paren
id|target-&gt;raidVolume
op_eq
l_int|0
)paren
)paren
(brace
r_int
id|idx
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|idx
op_assign
id|ioc-&gt;eventContext
op_mod
id|ioc-&gt;eventLogSize
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|event
op_assign
id|MPI_EVENT_SCSI_DEVICE_STATUS_CHANGE
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|eventContext
op_assign
id|ioc-&gt;eventContext
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|pReq-&gt;LUN
(braket
l_int|1
)braket
op_lshift
l_int|24
)paren
op_logical_or
(paren
id|MPI_EVENT_SCSI_DEV_STAT_RC_SMART_DATA
op_lshift
l_int|16
)paren
op_logical_or
(paren
id|pReq-&gt;Bus
op_lshift
l_int|8
)paren
op_logical_or
id|pReq-&gt;TargetID
suffix:semicolon
id|ioc-&gt;events
(braket
id|idx
)braket
dot
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|sense_data
(braket
l_int|13
)braket
op_lshift
l_int|8
)paren
op_logical_or
id|sense_data
(braket
l_int|12
)braket
suffix:semicolon
id|ioc-&gt;eventContext
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Hmmm... SenseData len=0! (?)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
)brace
r_static
id|u32
DECL|function|SCPNT_TO_LOOKUP_IDX
id|SCPNT_TO_LOOKUP_IDX
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|sc
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|sc-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ScsiLookup
(braket
id|i
)braket
op_eq
id|sc
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptscsih_ioc_reset
id|mptscsih_ioc_reset
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|reset_phase
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: IOC %s_reset routed to SCSI host driver!&bslash;n&quot;
comma
id|reset_phase
op_eq
id|MPT_IOC_SETUP_RESET
ques
c_cond
l_string|&quot;setup&quot;
suffix:colon
(paren
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
ques
c_cond
l_string|&quot;pre&quot;
suffix:colon
l_string|&quot;post&quot;
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* If a FW reload request arrives after base installed but&n;&t; * before all scsi hosts have been attached, then an alt_ioc&n;&t; * may have a NULL sh pointer.&n;&t; */
r_if
c_cond
(paren
(paren
id|ioc-&gt;sh
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|ioc-&gt;sh-&gt;hostdata
op_eq
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_else
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|reset_phase
op_eq
id|MPT_IOC_SETUP_RESET
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Setup-Diag Reset&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Clean Up:&n;&t;&t; * 1. Set Hard Reset Pending Flag&n;&t;&t; * All new commands go to doneQ&n;&t;&t; */
id|hd-&gt;resetPending
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reset_phase
op_eq
id|MPT_IOC_PRE_RESET
)paren
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Pre-Diag Reset&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* 2. Flush running commands&n;&t;&t; *&t;Clean ScsiLookup (and associated memory)&n;&t;&t; *&t;AND clean mytaskQ&n;&t;&t; */
multiline_comment|/* 2b. Reply to OS all known outstanding I/O commands.&n;&t;&t; */
id|mptscsih_flush_running_cmds
c_func
(paren
id|hd
)paren
suffix:semicolon
multiline_comment|/* 2c. If there was an internal command that&n;&t;&t; * has not completed, configuration or io request,&n;&t;&t; * free these resources.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;cmdPtr
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ioc
comma
id|hd-&gt;cmdPtr
)paren
suffix:semicolon
)brace
multiline_comment|/* 2d. If a task management has not completed,&n;&t;&t; * free resources associated with this request.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;tmPtr
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
id|mpt_free_msg_frame
c_func
(paren
id|ioc
comma
id|hd-&gt;tmPtr
)paren
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Pre-Reset complete.&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Post-Diag Reset&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Once a FW reload begins, all new OS commands are&n;&t;&t; * redirected to the doneQ w/ a reset status.&n;&t;&t; * Init all control structures.&n;&t;&t; */
multiline_comment|/* ScsiLookup initialization&n;&t;&t; */
(brace
r_int
id|ii
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|hd-&gt;ioc-&gt;req_depth
suffix:semicolon
id|ii
op_increment
)paren
id|hd-&gt;ScsiLookup
(braket
id|ii
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* 2. Chain Buffer initialization&n;&t;&t; */
multiline_comment|/* 3. tmPtr clear&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;tmPtr
)paren
(brace
id|hd-&gt;tmPtr
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* 4. Renegotiate to all devices, if SCSI&n;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
id|dnegoprintk
c_func
(paren
(paren
l_string|&quot;writeSDP1: ALL_IDS USE_NVRAM&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
l_int|0
comma
id|MPT_SCSICFG_ALL_IDS
op_or
id|MPT_SCSICFG_USE_NVRAM
)paren
suffix:semicolon
)brace
multiline_comment|/* 5. Enable new commands to be posted&n;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;FreeQlock
comma
id|flags
)paren
suffix:semicolon
id|hd-&gt;resetPending
op_assign
l_int|0
suffix:semicolon
id|hd-&gt;tmState
op_assign
id|TM_STATE_NONE
suffix:semicolon
multiline_comment|/* 6. If there was an internal command,&n;&t;&t; * wake this process up.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;cmdPtr
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Wake up the original calling thread&n;&t;&t;&t; */
id|hd-&gt;pLocal
op_assign
op_amp
id|hd-&gt;localReply
suffix:semicolon
id|hd-&gt;pLocal-&gt;completion
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
id|scandv_wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|scandv_waitq
)paren
suffix:semicolon
id|hd-&gt;cmdPtr
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* 7. Set flag to force DV and re-read IOC Page 3&n;&t;&t; */
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
id|ioc-&gt;spi_data.forceDv
op_assign
id|MPT_SCSICFG_NEED_DV
op_or
id|MPT_SCSICFG_RELOAD_IOC_PG3
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;Set reload IOC Pg3 Flag&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|dtmprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Post-Reset complete.&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* currently means nothing really */
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
r_static
r_int
DECL|function|mptscsih_event_process
id|mptscsih_event_process
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|EventNotificationReply_t
op_star
id|pEvReply
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|u8
id|event
op_assign
id|le32_to_cpu
c_func
(paren
id|pEvReply-&gt;Event
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|devtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;MPT event (=%02Xh) routed to SCSI host driver!&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|event
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|MPI_EVENT_UNIT_ATTENTION
suffix:colon
multiline_comment|/* 03 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_IOC_BUS_RESET
suffix:colon
multiline_comment|/* 04 */
r_case
id|MPI_EVENT_EXT_BUS_RESET
suffix:colon
multiline_comment|/* 05 */
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_logical_and
(paren
id|ioc-&gt;bus_type
op_eq
id|SCSI
)paren
op_logical_and
(paren
id|hd-&gt;soft_resets
OL
op_minus
l_int|1
)paren
)paren
id|hd-&gt;soft_resets
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MPI_EVENT_LOGOUT
suffix:colon
multiline_comment|/* 09 */
multiline_comment|/* FIXME! */
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  CHECKME! Don&squot;t think we need to do&n;&t;&t; *  anything for these, but...&n;&t;&t; */
r_case
id|MPI_EVENT_RESCAN
suffix:colon
multiline_comment|/* 06 */
r_case
id|MPI_EVENT_LINK_STATUS_CHANGE
suffix:colon
multiline_comment|/* 07 */
r_case
id|MPI_EVENT_LOOP_STATE_CHANGE
suffix:colon
multiline_comment|/* 08 */
multiline_comment|/*&n;&t;&t; *  CHECKME!  Falling thru...&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|MPI_EVENT_INTEGRATED_RAID
suffix:colon
multiline_comment|/* 0B */
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
multiline_comment|/* negoNvram set to 0 if DV enabled and to USE_NVRAM if&n;&t;&t; * if DV disabled. Need to check for target mode.&n;&t;&t; */
id|hd
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_logical_and
(paren
id|ioc-&gt;bus_type
op_eq
id|SCSI
)paren
op_logical_and
(paren
id|hd-&gt;negoNvram
op_eq
l_int|0
)paren
)paren
(brace
id|ScsiCfgData
op_star
id|pSpi
suffix:semicolon
id|Ioc3PhysDisk_t
op_star
id|pPDisk
suffix:semicolon
r_int
id|numPDisk
suffix:semicolon
id|u8
id|reason
suffix:semicolon
id|u8
id|physDiskNum
suffix:semicolon
id|reason
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|pEvReply-&gt;Data
(braket
l_int|0
)braket
)paren
op_amp
l_int|0x00FF0000
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_eq
id|MPI_EVENT_RAID_RC_DOMAIN_VAL_NEEDED
)paren
(brace
multiline_comment|/* New or replaced disk.&n;&t;&t;&t;&t; * Set DV flag and schedule DV.&n;&t;&t;&t;&t; */
id|pSpi
op_assign
op_amp
id|ioc-&gt;spi_data
suffix:semicolon
id|physDiskNum
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|pEvReply-&gt;Data
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xFF000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;DV requested for phys disk id %d&bslash;n&quot;
comma
id|physDiskNum
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSpi-&gt;pIocPg3
)paren
(brace
id|pPDisk
op_assign
id|pSpi-&gt;pIocPg3-&gt;PhysDisk
suffix:semicolon
id|numPDisk
op_assign
id|pSpi-&gt;pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
r_if
c_cond
(paren
id|physDiskNum
op_eq
id|pPDisk-&gt;PhysDiskNum
)paren
(brace
id|pSpi-&gt;dvStatus
(braket
id|pPDisk-&gt;PhysDiskID
)braket
op_assign
(paren
id|MPT_SCSICFG_NEED_DV
op_or
id|MPT_SCSICFG_DV_NOT_DONE
)paren
suffix:semicolon
id|pSpi-&gt;forceDv
op_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;NEED_DV set for phys disk id %d&bslash;n&quot;
comma
id|pPDisk-&gt;PhysDiskID
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|numPDisk
op_eq
l_int|0
)paren
(brace
multiline_comment|/* The physical disk that needs DV was not found&n;&t;&t;&t;&t;&t;&t; * in the stored IOC Page 3. The driver must reload&n;&t;&t;&t;&t;&t;&t; * this page. DV routine will set the NEED_DV flag for&n;&t;&t;&t;&t;&t;&t; * all phys disks that have DV_NOT_DONE set.&n;&t;&t;&t;&t;&t;&t; */
id|pSpi-&gt;forceDv
op_assign
id|MPT_SCSICFG_NEED_DV
op_or
id|MPT_SCSICFG_RELOAD_IOC_PG3
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;phys disk %d not found. Setting reload IOC Pg3 Flag&bslash;n&quot;
comma
id|physDiskNum
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif
macro_line|#if defined(MPT_DEBUG_DV) || defined(MPT_DEBUG_DV_TINY)
id|printk
c_func
(paren
l_string|&quot;Raid Event RF: &quot;
)paren
suffix:semicolon
(brace
id|u32
op_star
id|m
op_assign
(paren
id|u32
op_star
)paren
id|pEvReply
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|n
op_assign
(paren
r_int
)paren
id|pEvReply-&gt;MsgLength
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|6
suffix:semicolon
id|ii
OL
id|n
suffix:semicolon
id|ii
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|le32_to_cpu
c_func
(paren
id|m
(braket
id|ii
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MPI_EVENT_NONE
suffix:colon
multiline_comment|/* 00 */
r_case
id|MPI_EVENT_LOG_DATA
suffix:colon
multiline_comment|/* 01 */
r_case
id|MPI_EVENT_STATE_CHANGE
suffix:colon
multiline_comment|/* 02 */
r_case
id|MPI_EVENT_EVENT_CHANGE
suffix:colon
multiline_comment|/* 0A */
r_default
suffix:colon
id|dprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;  Ignoring event (=%02Xh)&bslash;n&quot;
comma
id|event
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* currently means nothing really */
)brace
DECL|variable|mptscsih_queue_depth_attr
r_static
r_struct
id|device_attribute
id|mptscsih_queue_depth_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;queue_depth&quot;
comma
dot
id|mode
op_assign
id|S_IWUSR
comma
)brace
comma
dot
id|store
op_assign
id|mptscsih_store_queue_depth
comma
)brace
suffix:semicolon
DECL|variable|mptscsih_dev_attrs
r_static
r_struct
id|device_attribute
op_star
id|mptscsih_dev_attrs
(braket
)braket
op_assign
(brace
op_amp
id|mptscsih_queue_depth_attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|driver_template
r_static
r_struct
id|scsi_host_template
id|driver_template
op_assign
(brace
dot
id|proc_name
op_assign
l_string|&quot;mptscsih&quot;
comma
dot
id|proc_info
op_assign
id|mptscsih_proc_info
comma
dot
id|name
op_assign
l_string|&quot;MPT SCSI Host&quot;
comma
dot
id|info
op_assign
id|mptscsih_info
comma
dot
id|queuecommand
op_assign
id|mptscsih_qcmd
comma
dot
id|slave_alloc
op_assign
id|mptscsih_slave_alloc
comma
dot
id|slave_configure
op_assign
id|mptscsih_slave_configure
comma
dot
id|slave_destroy
op_assign
id|mptscsih_slave_destroy
comma
dot
id|eh_abort_handler
op_assign
id|mptscsih_abort
comma
dot
id|eh_device_reset_handler
op_assign
id|mptscsih_dev_reset
comma
dot
id|eh_bus_reset_handler
op_assign
id|mptscsih_bus_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|mptscsih_host_reset
comma
dot
id|bios_param
op_assign
id|mptscsih_bios_param
comma
dot
id|can_queue
op_assign
id|MPT_SCSI_CAN_QUEUE
comma
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|sg_tablesize
op_assign
id|MPT_SCSI_SG_DEPTH
comma
dot
id|max_sectors
op_assign
l_int|8192
comma
dot
id|cmd_per_lun
op_assign
l_int|7
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|sdev_attrs
op_assign
id|mptscsih_dev_attrs
comma
)brace
suffix:semicolon
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_initTarget - Target, LUN alloc/free functionality.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@bus_id: Bus number (?)&n; *&t;@target_id: SCSI target id&n; *&t;@lun: SCSI LUN id&n; *&t;@data: Pointer to data&n; *&t;@dlen: Number of INQUIRY bytes&n; *&n; *&t;NOTE: It&squot;s only SAFE to call this routine if data points to&n; *&t;sane &amp; valid STANDARD INQUIRY data!&n; *&n; *&t;Allocate and initialize memory for this target.&n; *&t;Save inquiry data.&n; *&n; */
r_static
r_void
DECL|function|mptscsih_initTarget
id|mptscsih_initTarget
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|bus_id
comma
r_int
id|target_id
comma
id|u8
id|lun
comma
r_char
op_star
id|data
comma
r_int
id|dlen
)paren
(brace
r_int
id|indexed_lun
comma
id|lun_index
suffix:semicolon
id|VirtDevice
op_star
id|vdev
suffix:semicolon
id|ScsiCfgData
op_star
id|pSpi
suffix:semicolon
r_char
id|data_56
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;initTarget bus=%d id=%d lun=%d hd=%p&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|bus_id
comma
id|target_id
comma
id|lun
comma
id|hd
)paren
)paren
suffix:semicolon
multiline_comment|/* Is LUN supported? If so, upper 2 bits will be 0&n;&t;* in first byte of inquiry data.&n;&t;*/
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_amp
l_int|0xe0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vdev
op_assign
id|hd-&gt;Targets
(braket
id|target_id
)braket
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|lun_index
op_assign
(paren
id|lun
op_rshift
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 32 luns per lun_index */
id|indexed_lun
op_assign
(paren
id|lun
op_mod
l_int|32
)paren
suffix:semicolon
id|vdev-&gt;luns
(braket
id|lun_index
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|indexed_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
r_if
c_cond
(paren
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|TYPE_PROCESSOR
)paren
op_logical_and
(paren
id|hd-&gt;ioc-&gt;spi_data.Saf_Te
)paren
)paren
(brace
multiline_comment|/* Treat all Processors as SAF-TE if&n;&t;&t;&t; * command line option is set */
id|vdev-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_SAF_TE_ISSUED
suffix:semicolon
id|mptscsih_writeIOCPage4
c_func
(paren
id|hd
comma
id|target_id
comma
id|bus_id
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|TYPE_PROCESSOR
)paren
op_logical_and
op_logical_neg
(paren
id|vdev-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_SAF_TE_ISSUED
)paren
)paren
(brace
r_if
c_cond
(paren
id|dlen
OG
l_int|49
)paren
(brace
id|vdev-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_INQUIRY
suffix:semicolon
r_if
c_cond
(paren
id|data
(braket
l_int|44
)braket
op_eq
l_char|&squot;S&squot;
op_logical_and
id|data
(braket
l_int|45
)braket
op_eq
l_char|&squot;A&squot;
op_logical_and
id|data
(braket
l_int|46
)braket
op_eq
l_char|&squot;F&squot;
op_logical_and
id|data
(braket
l_int|47
)braket
op_eq
l_char|&squot;-&squot;
op_logical_and
id|data
(braket
l_int|48
)braket
op_eq
l_char|&squot;T&squot;
op_logical_and
id|data
(braket
l_int|49
)braket
op_eq
l_char|&squot;E&squot;
)paren
(brace
id|vdev-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_SAF_TE_ISSUED
suffix:semicolon
id|mptscsih_writeIOCPage4
c_func
(paren
id|hd
comma
id|target_id
comma
id|bus_id
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vdev-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_INQUIRY
)paren
)paren
(brace
r_if
c_cond
(paren
id|dlen
OG
l_int|8
)paren
(brace
id|memcpy
(paren
id|vdev-&gt;inq_data
comma
id|data
comma
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|vdev-&gt;inq_data
comma
id|data
comma
id|dlen
)paren
suffix:semicolon
)brace
multiline_comment|/* If have not done DV, set the DV flag.&n;&t;&t;&t; */
id|pSpi
op_assign
op_amp
id|hd-&gt;ioc-&gt;spi_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|TYPE_TAPE
)paren
op_logical_or
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|TYPE_PROCESSOR
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSpi-&gt;dvStatus
(braket
id|target_id
)braket
op_amp
id|MPT_SCSICFG_DV_NOT_DONE
)paren
id|pSpi-&gt;dvStatus
(braket
id|target_id
)braket
op_or_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
)brace
id|vdev-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_INQUIRY
suffix:semicolon
id|data_56
op_assign
l_int|0x0F
suffix:semicolon
multiline_comment|/* Default to full capabilities if Inq data length is &lt; 57 */
r_if
c_cond
(paren
id|dlen
OG
l_int|56
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|vdev-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_56
)paren
)paren
)paren
(brace
multiline_comment|/* Update the target capabilities&n;&t;&t;&t;&t; */
id|data_56
op_assign
id|data
(braket
l_int|56
)braket
suffix:semicolon
id|vdev-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_56
suffix:semicolon
)brace
)brace
id|mptscsih_setTargetNegoParms
c_func
(paren
id|hd
comma
id|vdev
comma
id|data_56
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Initial Inquiry may not request enough data bytes to&n;&t;&t;&t; * obtain byte 57.  DV will; if target doesn&squot;t return&n;&t;&t;&t; * at least 57 bytes, data[56] will be zero. */
r_if
c_cond
(paren
id|dlen
OG
l_int|56
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|vdev-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_56
)paren
)paren
)paren
(brace
multiline_comment|/* Update the target capabilities&n;&t;&t;&t;&t; */
id|data_56
op_assign
id|data
(braket
l_int|56
)braket
suffix:semicolon
id|vdev-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_56
suffix:semicolon
id|mptscsih_setTargetNegoParms
c_func
(paren
id|hd
comma
id|vdev
comma
id|data_56
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Update the target negotiation parameters based on the&n; *  the Inquiry data, adapter capabilities, and NVRAM settings.&n; *&n; */
r_static
r_void
DECL|function|mptscsih_setTargetNegoParms
id|mptscsih_setTargetNegoParms
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|VirtDevice
op_star
id|target
comma
r_char
id|byte56
)paren
(brace
id|ScsiCfgData
op_star
id|pspi_data
op_assign
op_amp
id|hd-&gt;ioc-&gt;spi_data
suffix:semicolon
r_int
id|id
op_assign
(paren
r_int
)paren
id|target-&gt;target_id
suffix:semicolon
r_int
id|nvram
suffix:semicolon
id|VirtDevice
op_star
id|vdev
suffix:semicolon
r_int
id|ii
suffix:semicolon
id|u8
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
id|u8
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|u8
id|offset
op_assign
l_int|0
suffix:semicolon
id|u8
id|version
comma
id|nfactor
suffix:semicolon
id|u8
id|noQas
op_assign
l_int|1
suffix:semicolon
id|target-&gt;negoFlags
op_assign
id|pspi_data-&gt;noQas
suffix:semicolon
multiline_comment|/* noQas == 0 =&gt; device supports QAS. Need byte 56 of Inq to determine&n;&t; * support. If available, default QAS to off and allow enabling.&n;&t; * If not available, default QAS to on, turn off for non-disks.&n;&t; */
multiline_comment|/* Set flags based on Inquiry data&n;&t; */
id|version
op_assign
id|target-&gt;inq_data
(braket
l_int|2
)braket
op_amp
l_int|0x07
suffix:semicolon
r_if
c_cond
(paren
id|version
OL
l_int|2
)paren
(brace
id|width
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
id|offset
op_assign
id|pspi_data-&gt;maxSyncOffset
suffix:semicolon
id|target-&gt;tflags
op_and_assign
op_complement
id|MPT_TARGET_FLAGS_Q_YES
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|target-&gt;inq_data
(braket
l_int|7
)braket
op_amp
l_int|0x20
)paren
(brace
id|width
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|target-&gt;inq_data
(braket
l_int|7
)braket
op_amp
l_int|0x10
)paren
(brace
id|factor
op_assign
id|pspi_data-&gt;minSyncFactor
suffix:semicolon
r_if
c_cond
(paren
id|target-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_VALID_56
)paren
(brace
multiline_comment|/* bits 2 &amp; 3 show Clocking support */
r_if
c_cond
(paren
(paren
id|byte56
op_amp
l_int|0x0C
)paren
op_eq
l_int|0
)paren
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
(paren
id|byte56
op_amp
l_int|0x03
)paren
op_eq
l_int|0
)paren
id|factor
op_assign
id|MPT_ULTRA160
suffix:semicolon
r_else
(brace
id|factor
op_assign
id|MPT_ULTRA320
suffix:semicolon
r_if
c_cond
(paren
id|byte56
op_amp
l_int|0x02
)paren
(brace
id|ddvtprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;Enabling QAS due to byte56=%02x on id=%d!&bslash;n&quot;
comma
id|byte56
comma
id|id
)paren
)paren
suffix:semicolon
id|noQas
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|target-&gt;inq_data
(braket
l_int|0
)braket
op_eq
id|TYPE_TAPE
)paren
(brace
r_if
c_cond
(paren
id|byte56
op_amp
l_int|0x01
)paren
id|target-&gt;negoFlags
op_or_assign
id|MPT_TAPE_NEGO_IDP
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
id|ddvtprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;Enabling QAS on id=%d due to ~TARGET_FLAGS_VALID_56!&bslash;n&quot;
comma
id|id
)paren
)paren
suffix:semicolon
id|noQas
op_assign
l_int|0
suffix:semicolon
)brace
id|offset
op_assign
id|pspi_data-&gt;maxSyncOffset
suffix:semicolon
multiline_comment|/* If RAID, never disable QAS&n;&t;&t;&t; * else if non RAID, do not disable&n;&t;&t;&t; *   QAS if bit 1 is set&n;&t;&t;&t; * bit 1 QAS support, non-raid only&n;&t;&t;&t; * bit 0 IU support&n;&t;&t;&t; */
r_if
c_cond
(paren
id|target-&gt;raidVolume
op_eq
l_int|1
)paren
(brace
id|noQas
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|target-&gt;inq_data
(braket
l_int|7
)braket
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
(brace
id|target-&gt;tflags
op_and_assign
op_complement
id|MPT_TARGET_FLAGS_Q_YES
suffix:semicolon
)brace
multiline_comment|/* Update tflags based on NVRAM settings. (SCSI only)&n;&t; */
r_if
c_cond
(paren
id|pspi_data-&gt;nvram
op_logical_and
(paren
id|pspi_data-&gt;nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
id|nvram
op_assign
id|pspi_data-&gt;nvram
(braket
id|id
)braket
suffix:semicolon
id|nfactor
op_assign
(paren
id|nvram
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|width
)paren
id|width
op_assign
id|nvram
op_amp
id|MPT_NVRAM_WIDE_DISABLE
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|offset
OG
l_int|0
)paren
(brace
multiline_comment|/* Ensure factor is set to the&n;&t;&t;&t; * maximum of: adapter, nvram, inquiry&n;&t;&t;&t; */
r_if
c_cond
(paren
id|nfactor
)paren
(brace
r_if
c_cond
(paren
id|nfactor
OL
id|pspi_data-&gt;minSyncFactor
)paren
id|nfactor
op_assign
id|pspi_data-&gt;minSyncFactor
suffix:semicolon
id|factor
op_assign
id|max
c_func
(paren
id|factor
comma
id|nfactor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|factor
op_eq
id|MPT_ASYNC
)paren
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|offset
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
)brace
r_else
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
)brace
multiline_comment|/* Make sure data is consistent&n;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|width
)paren
op_logical_and
(paren
id|factor
OL
id|MPT_ULTRA2
)paren
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
)brace
multiline_comment|/* Save the data to the target structure.&n;&t; */
id|target-&gt;minSyncFactor
op_assign
id|factor
suffix:semicolon
id|target-&gt;maxOffset
op_assign
id|offset
suffix:semicolon
id|target-&gt;maxWidth
op_assign
id|width
suffix:semicolon
id|target-&gt;tflags
op_or_assign
id|MPT_TARGET_FLAGS_VALID_NEGO
suffix:semicolon
multiline_comment|/* Disable unused features.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|width
)paren
id|target-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|offset
)paren
id|target-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
r_if
c_cond
(paren
id|factor
OG
id|MPT_ULTRA320
)paren
id|noQas
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* GEM, processor WORKAROUND&n;&t; */
r_if
c_cond
(paren
(paren
id|target-&gt;inq_data
(braket
l_int|0
)braket
op_eq
id|TYPE_PROCESSOR
)paren
op_logical_or
(paren
id|target-&gt;inq_data
(braket
l_int|0
)braket
OG
l_int|0x08
)paren
)paren
(brace
id|target-&gt;negoFlags
op_or_assign
(paren
id|MPT_TARGET_NO_NEGO_WIDE
op_or
id|MPT_TARGET_NO_NEGO_SYNC
)paren
suffix:semicolon
id|pspi_data-&gt;dvStatus
(braket
id|id
)braket
op_or_assign
id|MPT_SCSICFG_BLK_NEGO
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|noQas
op_logical_and
(paren
id|pspi_data-&gt;noQas
op_eq
l_int|0
)paren
)paren
(brace
id|pspi_data-&gt;noQas
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|target-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
multiline_comment|/* Disable QAS in a mixed configuration case&n;&t; &t;&t;*/
id|ddvtprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;Disabling QAS due to noQas=%02x on id=%d!&bslash;n&quot;
comma
id|noQas
comma
id|id
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|id
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|vdev
op_assign
id|hd-&gt;Targets
(braket
id|ii
)braket
)paren
)paren
(brace
id|vdev-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
id|ii
comma
id|vdev-&gt;negoFlags
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Write SDP1 on this I/O to this target */
r_if
c_cond
(paren
id|pspi_data-&gt;dvStatus
(braket
id|id
)braket
op_amp
id|MPT_SCSICFG_NEGOTIATE
)paren
(brace
id|ddvtprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;MPT_SCSICFG_NEGOTIATE on id=%d!&bslash;n&quot;
comma
id|id
)paren
)paren
suffix:semicolon
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
id|id
comma
id|hd-&gt;negoNvram
)paren
suffix:semicolon
id|pspi_data-&gt;dvStatus
(braket
id|id
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_NEGOTIATE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pspi_data-&gt;dvStatus
(braket
id|id
)braket
op_amp
id|MPT_SCSICFG_BLK_NEGO
)paren
(brace
id|ddvtprintk
c_func
(paren
(paren
id|KERN_INFO
l_string|&quot;MPT_SCSICFG_BLK_NEGO on id=%d!&bslash;n&quot;
comma
id|id
)paren
)paren
suffix:semicolon
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
id|id
comma
id|MPT_SCSICFG_BLK_NEGO
)paren
suffix:semicolon
id|pspi_data-&gt;dvStatus
(braket
id|id
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_BLK_NEGO
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/* If DV disabled (negoNvram set to USE_NVARM) or if not LUN 0, return.&n; * Else set the NEED_DV flag after Read Capacity Issued (disks)&n; * or Mode Sense (cdroms).&n; *&n; * Tapes, initTarget will set this flag on completion of Inquiry command.&n; * Called only if DV_NOT_DONE flag is set&n; */
DECL|function|mptscsih_set_dvflags
r_static
r_void
id|mptscsih_set_dvflags
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|SCSIIORequest_t
op_star
id|pReq
)paren
(brace
id|u8
id|cmd
suffix:semicolon
id|ScsiCfgData
op_star
id|pSpi
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot; set_dvflags: id=%d lun=%d negoNvram=%x cmd=%x&bslash;n&quot;
comma
id|pReq-&gt;TargetID
comma
id|pReq-&gt;LUN
(braket
l_int|1
)braket
comma
id|hd-&gt;negoNvram
comma
id|pReq-&gt;CDB
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pReq-&gt;LUN
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
op_logical_or
(paren
id|hd-&gt;negoNvram
op_ne
l_int|0
)paren
)paren
r_return
suffix:semicolon
id|cmd
op_assign
id|pReq-&gt;CDB
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|READ_CAPACITY
)paren
op_logical_or
(paren
id|cmd
op_eq
id|MODE_SENSE
)paren
)paren
(brace
id|pSpi
op_assign
op_amp
id|hd-&gt;ioc-&gt;spi_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSpi-&gt;isRaid
op_amp
(paren
l_int|1
op_lshift
id|pReq-&gt;TargetID
)paren
)paren
op_logical_and
id|pSpi-&gt;pIocPg3
)paren
(brace
multiline_comment|/* Set NEED_DV for all hidden disks&n;&t;&t;&t; */
id|Ioc3PhysDisk_t
op_star
id|pPDisk
op_assign
id|pSpi-&gt;pIocPg3-&gt;PhysDisk
suffix:semicolon
r_int
id|numPDisk
op_assign
id|pSpi-&gt;pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
id|pSpi-&gt;dvStatus
(braket
id|pPDisk-&gt;PhysDiskID
)braket
op_or_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;NEED_DV set for phys disk id %d&bslash;n&quot;
comma
id|pPDisk-&gt;PhysDiskID
)paren
)paren
suffix:semicolon
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
)brace
id|pSpi-&gt;dvStatus
(braket
id|pReq-&gt;TargetID
)braket
op_or_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
l_string|&quot;NEED_DV set for visible disk id %d&bslash;n&quot;
comma
id|pReq-&gt;TargetID
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; * If no Target, bus reset on 1st I/O. Set the flag to&n; * prevent any future negotiations to this device.&n; */
DECL|function|mptscsih_no_negotiate
r_static
r_void
id|mptscsih_no_negotiate
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|target_id
)paren
(brace
r_if
c_cond
(paren
(paren
id|hd-&gt;Targets
)paren
op_logical_and
(paren
id|hd-&gt;Targets
(braket
id|target_id
)braket
op_eq
l_int|NULL
)paren
)paren
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|target_id
)braket
op_or_assign
id|MPT_SCSICFG_BLK_NEGO
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  SCSI Config Page functionality ...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_setDevicePage1Flags  - add Requested and Configuration fields flags&n; *&t;based on width, factor and offset parameters.&n; *&t;@width: bus width&n; *&t;@factor: sync factor&n; *&t;@offset: sync offset&n; *&t;@requestedPtr: pointer to requested values (updated)&n; *&t;@configurationPtr: pointer to configuration values (updated)&n; *&t;@flags: flags to block WDTR or SDTR negotiation&n; *&n; *&t;Return: None.&n; *&n; *&t;Remark: Called by writeSDP1 and _dv_params&n; */
r_static
r_void
DECL|function|mptscsih_setDevicePage1Flags
id|mptscsih_setDevicePage1Flags
(paren
id|u8
id|width
comma
id|u8
id|factor
comma
id|u8
id|offset
comma
r_int
op_star
id|requestedPtr
comma
r_int
op_star
id|configurationPtr
comma
id|u8
id|flags
)paren
(brace
id|u8
id|nowide
op_assign
id|flags
op_amp
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
id|u8
id|nosync
op_assign
id|flags
op_amp
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
op_star
id|configurationPtr
op_assign
l_int|0
suffix:semicolon
op_star
id|requestedPtr
op_assign
id|width
ques
c_cond
id|MPI_SCSIDEVPAGE1_RP_WIDE
suffix:colon
l_int|0
suffix:semicolon
op_star
id|requestedPtr
op_or_assign
(paren
id|offset
op_lshift
l_int|16
)paren
op_or
(paren
id|factor
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|width
op_logical_and
id|offset
op_logical_and
op_logical_neg
id|nowide
op_logical_and
op_logical_neg
id|nosync
)paren
(brace
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA160
)paren
(brace
op_star
id|requestedPtr
op_or_assign
(paren
id|MPI_SCSIDEVPAGE1_RP_IU
op_plus
id|MPI_SCSIDEVPAGE1_RP_DT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|MPT_TARGET_NO_NEGO_QAS
)paren
op_eq
l_int|0
)paren
op_star
id|requestedPtr
op_or_assign
id|MPI_SCSIDEVPAGE1_RP_QAS
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MPT_TAPE_NEGO_IDP
)paren
op_star
id|requestedPtr
op_or_assign
l_int|0x08000000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA2
)paren
(brace
op_star
id|requestedPtr
op_or_assign
id|MPI_SCSIDEVPAGE1_RP_DT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|nowide
)paren
op_star
id|configurationPtr
op_or_assign
id|MPI_SCSIDEVPAGE1_CONF_WDTR_DISALLOWED
suffix:semicolon
r_if
c_cond
(paren
id|nosync
)paren
op_star
id|configurationPtr
op_or_assign
id|MPI_SCSIDEVPAGE1_CONF_SDTR_DISALLOWED
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_writeSDP1  - write SCSI Device Page 1&n; *&t;@hd: Pointer to a SCSI Host Strucutre&n; *&t;@portnum: IOC port number&n; *&t;@target_id: writeSDP1 for single ID&n; *&t;@flags: MPT_SCSICFG_ALL_IDS, MPT_SCSICFG_USE_NVRAM, MPT_SCSICFG_BLK_NEGO&n; *&n; *&t;Return: -EFAULT if read of config page header fails&n; *&t;&t;or 0 if success.&n; *&n; *&t;Remark: If a target has been found, the settings from the&n; *&t;&t;target structure are used, else the device is set&n; *&t;&t;to async/narrow.&n; *&n; *&t;Remark: Called during init and after a FW reload.&n; *&t;Remark: We do not wait for a return, write pages sequentially.&n; */
r_static
r_int
DECL|function|mptscsih_writeSDP1
id|mptscsih_writeSDP1
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
comma
r_int
id|target_id
comma
r_int
id|flags
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|Config_t
op_star
id|pReq
suffix:semicolon
id|SCSIDevicePage1_t
op_star
id|pData
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|dma_addr_t
id|dataDma
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
id|u32
id|frameOffset
suffix:semicolon
id|u32
id|requested
comma
id|configuration
comma
id|flagsLength
suffix:semicolon
r_int
id|ii
comma
id|nvram
suffix:semicolon
r_int
id|id
op_assign
l_int|0
comma
id|maxid
op_assign
l_int|0
suffix:semicolon
id|u8
id|width
suffix:semicolon
id|u8
id|factor
suffix:semicolon
id|u8
id|offset
suffix:semicolon
id|u8
id|bus
op_assign
l_int|0
suffix:semicolon
id|u8
id|negoFlags
suffix:semicolon
id|u8
id|maxwidth
comma
id|maxoffset
comma
id|maxfactor
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.sdp1length
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MPT_SCSICFG_ALL_IDS
)paren
(brace
id|id
op_assign
l_int|0
suffix:semicolon
id|maxid
op_assign
id|ioc-&gt;sh-&gt;max_id
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioc-&gt;sh
)paren
(brace
id|id
op_assign
id|target_id
suffix:semicolon
id|maxid
op_assign
id|min_t
c_func
(paren
r_int
comma
id|id
comma
id|ioc-&gt;sh-&gt;max_id
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|id
op_le
id|maxid
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|id
op_eq
id|ioc-&gt;pfacts
(braket
id|portnum
)braket
dot
id|PortSCSIID
)paren
r_continue
suffix:semicolon
multiline_comment|/* Use NVRAM to get adapter and target maximums&n;&t;&t; * Data over-riden by target structure information, if present&n;&t;&t; */
id|maxwidth
op_assign
id|ioc-&gt;spi_data.maxBusWidth
suffix:semicolon
id|maxoffset
op_assign
id|ioc-&gt;spi_data.maxSyncOffset
suffix:semicolon
id|maxfactor
op_assign
id|ioc-&gt;spi_data.minSyncFactor
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.nvram
op_logical_and
(paren
id|ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
id|nvram
op_assign
id|ioc-&gt;spi_data.nvram
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|maxwidth
)paren
id|maxwidth
op_assign
id|nvram
op_amp
id|MPT_NVRAM_WIDE_DISABLE
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|maxoffset
OG
l_int|0
)paren
(brace
id|maxfactor
op_assign
(paren
id|nvram
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|maxfactor
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Key for async */
id|maxfactor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|maxoffset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|maxfactor
OL
id|ioc-&gt;spi_data.minSyncFactor
)paren
(brace
id|maxfactor
op_assign
id|ioc-&gt;spi_data.minSyncFactor
suffix:semicolon
)brace
)brace
r_else
id|maxfactor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
multiline_comment|/* Set the negotiation flags.&n;&t;&t; */
id|negoFlags
op_assign
id|ioc-&gt;spi_data.noQas
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maxwidth
)paren
id|negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maxoffset
)paren
id|negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MPT_SCSICFG_USE_NVRAM
)paren
(brace
id|width
op_assign
id|maxwidth
suffix:semicolon
id|factor
op_assign
id|maxfactor
suffix:semicolon
id|offset
op_assign
id|maxoffset
suffix:semicolon
)brace
r_else
(brace
id|width
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
singleline_comment|//negoFlags = 0;
singleline_comment|//negoFlags = MPT_TARGET_NO_NEGO_SYNC;
)brace
multiline_comment|/* If id is not a raid volume, get the updated&n;&t;&t; * transmission settings from the target structure.&n;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;Targets
op_logical_and
(paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|id
)braket
)paren
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|width
op_assign
id|pTarget-&gt;maxWidth
suffix:semicolon
id|factor
op_assign
id|pTarget-&gt;minSyncFactor
suffix:semicolon
id|offset
op_assign
id|pTarget-&gt;maxOffset
suffix:semicolon
id|negoFlags
op_assign
id|pTarget-&gt;negoFlags
suffix:semicolon
)brace
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
multiline_comment|/* Force to async and narrow if DV has not been executed&n;&t;&t; * for this ID&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_amp
id|MPT_SCSICFG_DV_NOT_DONE
)paren
op_ne
l_int|0
)paren
(brace
id|width
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|flags
op_amp
id|MPT_SCSICFG_BLK_NEGO
)paren
id|negoFlags
op_assign
id|MPT_TARGET_NO_NEGO_WIDE
op_or
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
id|mptscsih_setDevicePage1Flags
c_func
(paren
id|width
comma
id|factor
comma
id|offset
comma
op_amp
id|requested
comma
op_amp
id|configuration
comma
id|negoFlags
)paren
suffix:semicolon
id|dnegoprintk
c_func
(paren
(paren
l_string|&quot;writeSDP1: id=%d width=%d factor=%x offset=%x negoFlags=%x request=%x config=%x&bslash;n&quot;
comma
id|target_id
comma
id|width
comma
id|factor
comma
id|offset
comma
id|negoFlags
comma
id|requested
comma
id|configuration
)paren
)paren
suffix:semicolon
multiline_comment|/* Get a MF for this command.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;write SDP1: no msg frames!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;WriteSDP1 (mf=%p, id=%d, req=0x%x, cfg=0x%x)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|mf
comma
id|id
comma
id|requested
comma
id|configuration
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the request and the data pointers.&n;&t;&t; * Request takes: 36 bytes (32 bit SGE)&n;&t;&t; * SCSI Device Page 1 requires 16 bytes&n;&t;&t; * 40 + 16 &lt;= size of SCSI IO Request = 56 bytes&n;&t;&t; * and MF size &gt;= 64 bytes.&n;&t;&t; * Place data at end of MF.&n;&t;&t; */
id|pReq
op_assign
(paren
id|Config_t
op_star
)paren
id|mf
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|frameOffset
op_assign
id|ioc-&gt;req_sz
op_minus
r_sizeof
(paren
id|SCSIDevicePage1_t
)paren
suffix:semicolon
id|pData
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|mf
op_plus
id|frameOffset
)paren
suffix:semicolon
id|dataDma
op_assign
id|ioc-&gt;req_frames_dma
op_plus
(paren
id|req_idx
op_star
id|ioc-&gt;req_sz
)paren
op_plus
id|frameOffset
suffix:semicolon
multiline_comment|/* Complete the request frame (same for all requests).&n;&t;&t; */
id|pReq-&gt;Action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|pReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Function
op_assign
id|MPI_FUNCTION_CONFIG
suffix:semicolon
id|pReq-&gt;ExtPageLength
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ExtPageType
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|pReq-&gt;Reserved2
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|pReq-&gt;Header.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp1version
suffix:semicolon
id|pReq-&gt;Header.PageLength
op_assign
id|ioc-&gt;spi_data.sdp1length
suffix:semicolon
id|pReq-&gt;Header.PageNumber
op_assign
l_int|1
suffix:semicolon
id|pReq-&gt;Header.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
id|pReq-&gt;PageAddress
op_assign
id|cpu_to_le32
c_func
(paren
id|id
op_or
(paren
id|bus
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Add a SGE to the config request.&n;&t;&t; */
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_WRITE
op_or
id|ioc-&gt;spi_data.sdp1length
op_star
l_int|4
suffix:semicolon
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;PageBufferSGE
comma
id|flagsLength
comma
id|dataDma
)paren
suffix:semicolon
multiline_comment|/* Set up the common data portion&n;&t;&t; */
id|pData-&gt;Header.PageVersion
op_assign
id|pReq-&gt;Header.PageVersion
suffix:semicolon
id|pData-&gt;Header.PageLength
op_assign
id|pReq-&gt;Header.PageLength
suffix:semicolon
id|pData-&gt;Header.PageNumber
op_assign
id|pReq-&gt;Header.PageNumber
suffix:semicolon
id|pData-&gt;Header.PageType
op_assign
id|pReq-&gt;Header.PageType
suffix:semicolon
id|pData-&gt;RequestedParameters
op_assign
id|cpu_to_le32
c_func
(paren
id|requested
)paren
suffix:semicolon
id|pData-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pData-&gt;Configuration
op_assign
id|cpu_to_le32
c_func
(paren
id|configuration
)paren
suffix:semicolon
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;write SDP1: id %d pgaddr 0x%x req 0x%x config 0x%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|id
comma
(paren
id|id
op_or
(paren
id|bus
op_lshift
l_int|8
)paren
)paren
comma
id|requested
comma
id|configuration
)paren
)paren
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|ioc
comma
id|mf
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_writeIOCPage4  - write IOC Page 4&n; *&t;@hd: Pointer to a SCSI Host Structure&n; *&t;@target_id: write IOC Page4 for this ID &amp; Bus&n; *&n; *&t;Return: -EAGAIN if unable to obtain a Message Frame&n; *&t;&t;or 0 if success.&n; *&n; *&t;Remark: We do not wait for a return, write pages sequentially.&n; */
r_static
r_int
DECL|function|mptscsih_writeIOCPage4
id|mptscsih_writeIOCPage4
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|target_id
comma
r_int
id|bus
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|Config_t
op_star
id|pReq
suffix:semicolon
id|IOCPage4_t
op_star
id|IOCPage4Ptr
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|dma_addr_t
id|dataDma
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
id|u32
id|frameOffset
suffix:semicolon
id|u32
id|flagsLength
suffix:semicolon
r_int
id|ii
suffix:semicolon
multiline_comment|/* Get a MF for this command.&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;writeIOCPage4 : no msg frames!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Set the request and the data pointers.&n;&t; * Place data at end of MF.&n;&t; */
id|pReq
op_assign
(paren
id|Config_t
op_star
)paren
id|mf
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|frameOffset
op_assign
id|ioc-&gt;req_sz
op_minus
r_sizeof
(paren
id|IOCPage4_t
)paren
suffix:semicolon
multiline_comment|/* Complete the request frame (same for all requests).&n;&t; */
id|pReq-&gt;Action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|pReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Function
op_assign
id|MPI_FUNCTION_CONFIG
suffix:semicolon
id|pReq-&gt;ExtPageLength
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ExtPageType
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
(brace
id|pReq-&gt;Reserved2
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|IOCPage4Ptr
op_assign
id|ioc-&gt;spi_data.pIocPg4
suffix:semicolon
id|dataDma
op_assign
id|ioc-&gt;spi_data.IocPg4_dma
suffix:semicolon
id|ii
op_assign
id|IOCPage4Ptr-&gt;ActiveSEP
op_increment
suffix:semicolon
id|IOCPage4Ptr-&gt;SEP
(braket
id|ii
)braket
dot
id|SEPTargetID
op_assign
id|target_id
suffix:semicolon
id|IOCPage4Ptr-&gt;SEP
(braket
id|ii
)braket
dot
id|SEPBus
op_assign
id|bus
suffix:semicolon
id|pReq-&gt;Header
op_assign
id|IOCPage4Ptr-&gt;Header
suffix:semicolon
id|pReq-&gt;PageAddress
op_assign
id|cpu_to_le32
c_func
(paren
id|target_id
op_or
(paren
id|bus
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Add a SGE to the config request.&n;&t; */
id|flagsLength
op_assign
id|MPT_SGE_FLAGS_SSIMPLE_WRITE
op_or
(paren
id|IOCPage4Ptr-&gt;Header.PageLength
op_plus
id|ii
)paren
op_star
l_int|4
suffix:semicolon
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;PageBufferSGE
comma
id|flagsLength
comma
id|dataDma
)paren
suffix:semicolon
id|dinitprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;writeIOCPage4: MaxSEP=%d ActiveSEP=%d id=%d bus=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|IOCPage4Ptr-&gt;MaxSEP
comma
id|IOCPage4Ptr-&gt;ActiveSEP
comma
id|target_id
comma
id|bus
)paren
)paren
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|ScsiDoneCtx
comma
id|ioc
comma
id|mf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_taskmgmt_timeout - Call back for timeout on a&n; *&t;task management request.&n; *&t;@data: Pointer to MPT_SCSI_HOST recast as an unsigned long&n; *&n; */
DECL|function|mptscsih_taskmgmt_timeout
r_static
r_void
id|mptscsih_taskmgmt_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|data
suffix:semicolon
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_taskmgmt_timeout: &quot;
l_string|&quot;TM request timed out!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Delete the timer that triggered this callback.&n;&t; * Remark: del_timer checks to make sure timer is active&n;&t; * before deleting.&n;&t; */
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;TMtimer
)paren
suffix:semicolon
multiline_comment|/* Call the reset handler. Already had a TM request&n;&t; * timeout - so issue a diagnostic reset&n;&t; */
id|INIT_WORK
c_func
(paren
op_amp
id|mptscsih_rstTask
comma
id|mptscsih_schedule_reset
comma
(paren
r_void
op_star
)paren
id|hd
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|mptscsih_rstTask
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_schedule_reset - Call back for timeout on a&n; *&t;task management request.&n; *&t;@data: Pointer to MPT_SCSI_HOST recast as an unsigned long&n; *&n; */
r_static
r_void
DECL|function|mptscsih_schedule_reset
id|mptscsih_schedule_reset
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|CAN_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
(paren
id|KERN_WARNING
l_string|&quot; Firmware Reload FAILED!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Because we have reset the IOC, no TM requests can be&n;&t;&t; * pending.  So let&squot;s make sure the tmPending flag is reset.&n;&t;&t; */
id|dtmprintk
c_func
(paren
(paren
id|KERN_WARNING
id|MYNAM
l_string|&quot;: %s: mptscsih_taskmgmt_timeout&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|hd-&gt;tmPending
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *  Bus Scan and Domain Validation functionality ...&n; */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&n; *&t;mptscsih_scandv_complete - Scan and DV callback routine registered&n; *&t;to Fustion MPT (base) driver.&n; *&n; *&t;@ioc: Pointer to MPT_ADAPTER structure&n; *&t;@mf: Pointer to original MPT request frame&n; *&t;@mr: Pointer to MPT reply frame (NULL if TurboReply)&n; *&n; *&t;This routine is called from mpt.c::mpt_interrupt() at the completion&n; *&t;of any SCSI IO request.&n; *&t;This routine is registered with the Fusion MPT (base) driver at driver&n; *&t;load/init time via the mpt_register() API call.&n; *&n; *&t;Returns 1 indicating alloc&squot;d request frame ptr should be freed.&n; *&n; *&t;Remark: Sets a completion code and (possibly) saves sense data&n; *&t;in the IOC member localReply structure.&n; *&t;Used ONLY for DV and other internal commands.&n; */
r_static
r_int
DECL|function|mptscsih_scandv_complete
id|mptscsih_scandv_complete
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
id|MPT_FRAME_HDR
op_star
id|mf
comma
id|MPT_FRAME_HDR
op_star
id|mr
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pReq
suffix:semicolon
r_int
id|completionCode
suffix:semicolon
id|u16
id|req_idx
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mf
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|mf
op_ge
id|MPT_INDEX_2_MFPTR
c_func
(paren
id|ioc
comma
id|ioc-&gt;req_depth
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;ScanDvComplete, %s req frame ptr! (=%p)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|mf
ques
c_cond
l_string|&quot;BAD&quot;
suffix:colon
l_string|&quot;NULL&quot;
comma
(paren
r_void
op_star
)paren
id|mf
)paren
suffix:semicolon
r_goto
id|wakeup
suffix:semicolon
)brace
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|req_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|hd-&gt;ScsiLookup
(braket
id|req_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|pReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
r_if
c_cond
(paren
id|mf
op_ne
id|hd-&gt;cmdPtr
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;ScanDvComplete (mf=%p, cmdPtr=%p, idx=%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
(paren
r_void
op_star
)paren
id|mf
comma
(paren
r_void
op_star
)paren
id|hd-&gt;cmdPtr
comma
id|req_idx
)paren
suffix:semicolon
)brace
id|hd-&gt;cmdPtr
op_assign
l_int|NULL
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;ScanDvComplete (mf=%p,mr=%p,idx=%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|mf
comma
id|mr
comma
id|req_idx
)paren
)paren
suffix:semicolon
id|hd-&gt;pLocal
op_assign
op_amp
id|hd-&gt;localReply
suffix:semicolon
id|hd-&gt;pLocal-&gt;scsiStatus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If target struct exists, clear sense valid flag.&n;&t; */
r_if
c_cond
(paren
id|mr
op_eq
l_int|NULL
)paren
(brace
id|completionCode
op_assign
id|MPT_SCANDV_GOOD
suffix:semicolon
)brace
r_else
(brace
id|SCSIIOReply_t
op_star
id|pReply
suffix:semicolon
id|u16
id|status
suffix:semicolon
id|u8
id|scsi_status
suffix:semicolon
id|pReply
op_assign
(paren
id|SCSIIOReply_t
op_star
)paren
id|mr
suffix:semicolon
id|status
op_assign
id|le16_to_cpu
c_func
(paren
id|pReply-&gt;IOCStatus
)paren
op_amp
id|MPI_IOCSTATUS_MASK
suffix:semicolon
id|scsi_status
op_assign
id|pReply-&gt;SCSIStatus
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  IOCStatus=%04xh, SCSIState=%02xh, SCSIStatus=%02xh, IOCLogInfo=%08xh&bslash;n&quot;
comma
id|status
comma
id|pReply-&gt;SCSIState
comma
id|scsi_status
comma
id|le32_to_cpu
c_func
(paren
id|pReply-&gt;IOCLogInfo
)paren
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE
suffix:colon
multiline_comment|/* 0x0043 */
id|completionCode
op_assign
id|MPT_SCANDV_SELECTION_TIMEOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_IO_DATA_ERROR
suffix:colon
multiline_comment|/* 0x0046 */
r_case
id|MPI_IOCSTATUS_SCSI_TASK_TERMINATED
suffix:colon
multiline_comment|/* 0x0048 */
r_case
id|MPI_IOCSTATUS_SCSI_IOC_TERMINATED
suffix:colon
multiline_comment|/* 0x004B */
r_case
id|MPI_IOCSTATUS_SCSI_EXT_TERMINATED
suffix:colon
multiline_comment|/* 0x004C */
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
suffix:colon
multiline_comment|/* 0x0045 */
r_case
id|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
suffix:colon
multiline_comment|/* 0x0040 */
r_case
id|MPI_IOCSTATUS_SUCCESS
suffix:colon
multiline_comment|/* 0x0000 */
r_if
c_cond
(paren
id|pReply-&gt;Function
op_eq
id|MPI_FUNCTION_CONFIG
)paren
(brace
id|ConfigReply_t
op_star
id|pr
op_assign
(paren
id|ConfigReply_t
op_star
)paren
id|mr
suffix:semicolon
id|completionCode
op_assign
id|MPT_SCANDV_GOOD
suffix:semicolon
id|hd-&gt;pLocal-&gt;header.PageVersion
op_assign
id|pr-&gt;Header.PageVersion
suffix:semicolon
id|hd-&gt;pLocal-&gt;header.PageLength
op_assign
id|pr-&gt;Header.PageLength
suffix:semicolon
id|hd-&gt;pLocal-&gt;header.PageNumber
op_assign
id|pr-&gt;Header.PageNumber
suffix:semicolon
id|hd-&gt;pLocal-&gt;header.PageType
op_assign
id|pr-&gt;Header.PageType
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pReply-&gt;Function
op_eq
id|MPI_FUNCTION_RAID_ACTION
)paren
(brace
multiline_comment|/* If the RAID Volume request is successful,&n;&t;&t;&t;&t; * return GOOD, else indicate that&n;&t;&t;&t;&t; * some type of error occurred.&n;&t;&t;&t;&t; */
id|MpiRaidActionReply_t
op_star
id|pr
op_assign
(paren
id|MpiRaidActionReply_t
op_star
)paren
id|mr
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;ActionStatus
op_eq
id|MPI_RAID_ACTION_ASTATUS_SUCCESS
)paren
id|completionCode
op_assign
id|MPT_SCANDV_GOOD
suffix:semicolon
r_else
id|completionCode
op_assign
id|MPT_SCANDV_SOME_ERROR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_VALID
)paren
(brace
id|u8
op_star
id|sense_data
suffix:semicolon
r_int
id|sz
suffix:semicolon
multiline_comment|/* save sense data in global structure&n;&t;&t;&t;&t; */
id|completionCode
op_assign
id|MPT_SCANDV_SENSE
suffix:semicolon
id|hd-&gt;pLocal-&gt;scsiStatus
op_assign
id|scsi_status
suffix:semicolon
id|sense_data
op_assign
(paren
(paren
id|u8
op_star
)paren
id|hd-&gt;ioc-&gt;sense_buf_pool
op_plus
(paren
id|req_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
id|sz
op_assign
id|min_t
c_func
(paren
r_int
comma
id|pReq-&gt;SenseBufferLength
comma
id|SCSI_STD_SENSE_BYTES
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|hd-&gt;pLocal-&gt;sense
comma
id|sense_data
comma
id|sz
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  Check Condition, sense ptr %p&bslash;n&quot;
comma
id|sense_data
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_AUTOSENSE_FAILED
)paren
(brace
r_if
c_cond
(paren
id|pReq-&gt;CDB
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
id|completionCode
op_assign
id|MPT_SCANDV_ISSUE_SENSE
suffix:semicolon
r_else
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_NO_SCSI_STATUS
)paren
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
r_else
(brace
id|completionCode
op_assign
id|MPT_SCANDV_GOOD
suffix:semicolon
id|hd-&gt;pLocal-&gt;scsiStatus
op_assign
id|scsi_status
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR
suffix:colon
multiline_comment|/* 0x0047 */
r_if
c_cond
(paren
id|pReply-&gt;SCSIState
op_amp
id|MPI_SCSI_STATE_TERMINATED
)paren
id|completionCode
op_assign
id|MPT_SCANDV_DID_RESET
suffix:semicolon
r_else
id|completionCode
op_assign
id|MPT_SCANDV_SOME_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|completionCode
op_assign
id|MPT_SCANDV_SOME_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch(status) */
id|ddvtprintk
c_func
(paren
(paren
id|KERN_NOTICE
l_string|&quot;  completionCode set to %08xh&bslash;n&quot;
comma
id|completionCode
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end of address reply case */
id|hd-&gt;pLocal-&gt;completion
op_assign
id|completionCode
suffix:semicolon
multiline_comment|/* MF and RF are freed in mpt_interrupt&n;&t; */
id|wakeup
suffix:colon
multiline_comment|/* Free Chain buffers (will never chain) in scan or dv */
singleline_comment|//mptscsih_freeChainBuffers(ioc, req_idx);
multiline_comment|/*&n;&t; * Wake up the original calling thread&n;&t; */
id|scandv_wait_done
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|scandv_waitq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_timer_expired - Call back for timer process.&n; *&t;Used only for dv functionality.&n; *&t;@data: Pointer to MPT_SCSI_HOST recast as an unsigned long&n; *&n; */
DECL|function|mptscsih_timer_expired
r_static
r_void
id|mptscsih_timer_expired
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|data
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Timer Expired! Cmd %p&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|hd-&gt;cmdPtr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;cmdPtr
)paren
(brace
id|MPIHeader_t
op_star
id|cmd
op_assign
(paren
id|MPIHeader_t
op_star
)paren
id|hd-&gt;cmdPtr
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;Function
op_eq
id|MPI_FUNCTION_SCSI_IO_REQUEST
)paren
(brace
multiline_comment|/* Desire to issue a task management request here.&n;&t;&t;&t; * TM requests MUST be single threaded.&n;&t;&t;&t; * If old eh code and no TM current, issue request.&n;&t;&t;&t; * If new eh code, do nothing. Wait for OS cmd timeout&n;&t;&t;&t; *&t;for bus reset.&n;&t;&t;&t; */
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV Cmd Timeout: NoOp&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Perform a FW reload */
r_if
c_cond
(paren
id|mpt_HardResetHandler
c_func
(paren
id|hd-&gt;ioc
comma
id|NO_SLEEP
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Firmware Reload FAILED!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* This should NEVER happen */
id|printk
c_func
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Null cmdPtr!!!!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* No more processing.&n;&t; * TM call will generate an interrupt for SCSI TM Management.&n;&t; * The FW will reply to all outstanding commands, callback will finish cleanup.&n;&t; * Hard reset clean-up will free all resources.&n;&t; */
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Timer Expired Complete!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_do_raid - Format and Issue a RAID volume request message.&n; *&t;@hd: Pointer to scsi host structure&n; *&t;@action: What do be done.&n; *&t;@id: Logical target id.&n; *&t;@bus: Target locations bus.&n; *&n; *&t;Returns: &lt; 0 on a fatal error&n; *&t;&t;0 on success&n; *&n; *&t;Remark: Wait to return until reply processed by the ISR.&n; */
r_static
r_int
DECL|function|mptscsih_do_raid
id|mptscsih_do_raid
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|u8
id|action
comma
id|INTERNAL_CMD
op_star
id|io
)paren
(brace
id|MpiRaidActionRequest_t
op_star
id|pReq
suffix:semicolon
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
r_int
id|in_isr
suffix:semicolon
id|in_isr
op_assign
id|in_interrupt
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_isr
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Internal raid request not allowed in ISR context!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* Get and Populate a free Frame&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiScanDvCtx
comma
id|hd-&gt;ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;_do_raid: no msg frames!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|pReq
op_assign
(paren
id|MpiRaidActionRequest_t
op_star
)paren
id|mf
suffix:semicolon
id|pReq-&gt;Action
op_assign
id|action
suffix:semicolon
id|pReq-&gt;Reserved1
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Function
op_assign
id|MPI_FUNCTION_RAID_ACTION
suffix:semicolon
id|pReq-&gt;VolumeID
op_assign
id|io-&gt;id
suffix:semicolon
id|pReq-&gt;VolumeBus
op_assign
id|io-&gt;bus
suffix:semicolon
id|pReq-&gt;PhysDiskNum
op_assign
id|io-&gt;physDiskNum
suffix:semicolon
id|pReq-&gt;MsgFlags
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pReq-&gt;ActionDataWord
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reserved for this action */
singleline_comment|//pReq-&gt;ActionDataSGE = 0;
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pReq-&gt;ActionDataSGE
comma
id|MPT_SGE_FLAGS_SSIMPLE_READ
op_or
l_int|0
comma
(paren
id|dma_addr_t
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;RAID Volume action %x id %d&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|action
comma
id|io-&gt;id
)paren
)paren
suffix:semicolon
id|hd-&gt;pLocal
op_assign
l_int|NULL
suffix:semicolon
id|hd-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|10
suffix:semicolon
multiline_comment|/* 10 second timeout */
id|scandv_wait_done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Save cmd pointer, for resource free if timeout or&n;&t; * FW reload occurs&n;&t; */
id|hd-&gt;cmdPtr
op_assign
id|mf
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|ScsiScanDvCtx
comma
id|hd-&gt;ioc
comma
id|mf
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|scandv_waitq
comma
id|scandv_wait_done
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|hd-&gt;pLocal-&gt;completion
op_ne
id|MPT_SCANDV_GOOD
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* ~MPTSCSIH_ENABLE_DOMAIN_VALIDATION */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_do_cmd - Do internal command.&n; *&t;@hd: MPT_SCSI_HOST pointer&n; *&t;@io: INTERNAL_CMD pointer.&n; *&n; *&t;Issue the specified internally generated command and do command&n; *&t;specific cleanup. For bus scan / DV only.&n; *&t;NOTES: If command is Inquiry and status is good,&n; *&t;initialize a target structure, save the data&n; *&n; *&t;Remark: Single threaded access only.&n; *&n; *&t;Return:&n; *&t;&t;&lt; 0 if an illegal command or no resources&n; *&n; *&t;&t;   0 if good&n; *&n; *&t;&t; &gt; 0 if command complete but some type of completion error.&n; */
r_static
r_int
DECL|function|mptscsih_do_cmd
id|mptscsih_do_cmd
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|INTERNAL_CMD
op_star
id|io
)paren
(brace
id|MPT_FRAME_HDR
op_star
id|mf
suffix:semicolon
id|SCSIIORequest_t
op_star
id|pScsiReq
suffix:semicolon
id|SCSIIORequest_t
id|ReqCopy
suffix:semicolon
r_int
id|my_idx
comma
id|ii
comma
id|dir
suffix:semicolon
r_int
id|rc
comma
id|cmdTimeout
suffix:semicolon
r_int
id|in_isr
suffix:semicolon
r_char
id|cmdLen
suffix:semicolon
r_char
id|CDB
(braket
)braket
op_assign
initialization_block
suffix:semicolon
r_char
id|cmd
op_assign
id|io-&gt;cmd
suffix:semicolon
id|in_isr
op_assign
id|in_interrupt
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_isr
)paren
(brace
id|dprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;Internal SCSI IO request not allowed in ISR context!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* Set command specific information&n;&t; */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|INQUIRY
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|CDB
(braket
l_int|4
)braket
op_assign
id|io-&gt;size
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|START_STOP
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|CDB
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*Spin up the disk */
id|cmdTimeout
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQUEST_SENSE
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|CDB
(braket
l_int|4
)braket
op_assign
id|io-&gt;size
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_BUFFER
suffix:colon
id|cmdLen
op_assign
l_int|10
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
id|CDB
(braket
l_int|1
)braket
op_assign
l_int|0x0A
suffix:semicolon
)brace
r_else
(brace
id|CDB
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
)brace
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_BUF_CAP
)paren
(brace
id|CDB
(braket
l_int|1
)braket
op_or_assign
l_int|0x01
suffix:semicolon
)brace
id|CDB
(braket
l_int|6
)braket
op_assign
(paren
id|io-&gt;size
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|CDB
(braket
l_int|7
)braket
op_assign
(paren
id|io-&gt;size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|CDB
(braket
l_int|8
)braket
op_assign
id|io-&gt;size
op_amp
l_int|0xFF
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE_BUFFER
suffix:colon
id|cmdLen
op_assign
l_int|10
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_WRITE
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
id|CDB
(braket
l_int|1
)braket
op_assign
l_int|0x0A
suffix:semicolon
)brace
r_else
(brace
id|CDB
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
)brace
id|CDB
(braket
l_int|6
)braket
op_assign
(paren
id|io-&gt;size
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|CDB
(braket
l_int|7
)braket
op_assign
(paren
id|io-&gt;size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|CDB
(braket
l_int|8
)braket
op_assign
id|io-&gt;size
op_amp
l_int|0xFF
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RESERVE
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RELEASE
suffix:colon
id|cmdLen
op_assign
l_int|6
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNCHRONIZE_CACHE
suffix:colon
id|cmdLen
op_assign
l_int|10
suffix:semicolon
id|dir
op_assign
id|MPI_SCSIIO_CONTROL_READ
suffix:semicolon
id|CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
singleline_comment|//&t;&t;CDB[1] = 0x02;&t;/* set immediate bit */
id|cmdTimeout
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Error Case */
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Get and Populate a free Frame&n;&t; */
r_if
c_cond
(paren
(paren
id|mf
op_assign
id|mpt_get_msg_frame
c_func
(paren
id|ScsiScanDvCtx
comma
id|hd-&gt;ioc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_WARN_FMT
l_string|&quot;No msg frames!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|pScsiReq
op_assign
(paren
id|SCSIIORequest_t
op_star
)paren
id|mf
suffix:semicolon
multiline_comment|/* Get the request index */
id|my_idx
op_assign
id|le16_to_cpu
c_func
(paren
id|mf-&gt;u.frame.hwhdr.msgctxu.fld.req_idx
)paren
suffix:semicolon
id|ADD_INDEX_LOG
c_func
(paren
id|my_idx
)paren
suffix:semicolon
multiline_comment|/* for debug */
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_PHYS_DISK
)paren
(brace
id|pScsiReq-&gt;TargetID
op_assign
id|io-&gt;physDiskNum
suffix:semicolon
id|pScsiReq-&gt;Bus
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Function
op_assign
id|MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH
suffix:semicolon
)brace
r_else
(brace
id|pScsiReq-&gt;TargetID
op_assign
id|io-&gt;id
suffix:semicolon
id|pScsiReq-&gt;Bus
op_assign
id|io-&gt;bus
suffix:semicolon
id|pScsiReq-&gt;ChainOffset
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;Function
op_assign
id|MPI_FUNCTION_SCSI_IO_REQUEST
suffix:semicolon
)brace
id|pScsiReq-&gt;CDBLength
op_assign
id|cmdLen
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLength
op_assign
id|MPT_SENSE_BUFFER_SIZE
suffix:semicolon
id|pScsiReq-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;MsgFlags
op_assign
id|mpt_msg_flags
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* MsgContext set in mpt_get_msg_fram call  */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|8
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiReq-&gt;LUN
(braket
id|ii
)braket
op_assign
l_int|0
suffix:semicolon
id|pScsiReq-&gt;LUN
(braket
l_int|1
)braket
op_assign
id|io-&gt;lun
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MPT_ICFLAG_TAGGED_CMD
)paren
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|dir
op_or
id|MPI_SCSIIO_CONTROL_SIMPLEQ
)paren
suffix:semicolon
r_else
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|dir
op_or
id|MPI_SCSIIO_CONTROL_UNTAGGED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|REQUEST_SENSE
)paren
(brace
id|pScsiReq-&gt;Control
op_assign
id|cpu_to_le32
c_func
(paren
id|dir
op_or
id|MPI_SCSIIO_CONTROL_UNTAGGED
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Untagged! 0x%2x&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|cmd
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
l_int|16
suffix:semicolon
id|ii
op_increment
)paren
id|pScsiReq-&gt;CDB
(braket
id|ii
)braket
op_assign
id|CDB
(braket
id|ii
)braket
suffix:semicolon
id|pScsiReq-&gt;DataLength
op_assign
id|cpu_to_le32
c_func
(paren
id|io-&gt;size
)paren
suffix:semicolon
id|pScsiReq-&gt;SenseBufferLowAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|hd-&gt;ioc-&gt;sense_buf_low_dma
op_plus
(paren
id|my_idx
op_star
id|MPT_SENSE_BUFFER_ALLOC
)paren
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;Sending Command 0x%x for (%d:%d:%d)&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|cmd
comma
id|io-&gt;bus
comma
id|io-&gt;id
comma
id|io-&gt;lun
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_eq
id|MPI_SCSIIO_CONTROL_READ
)paren
(brace
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pScsiReq-&gt;SGL
comma
id|MPT_SGE_FLAGS_SSIMPLE_READ
op_or
id|io-&gt;size
comma
id|io-&gt;data_dma
)paren
suffix:semicolon
)brace
r_else
(brace
id|mpt_add_sge
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pScsiReq-&gt;SGL
comma
id|MPT_SGE_FLAGS_SSIMPLE_WRITE
op_or
id|io-&gt;size
comma
id|io-&gt;data_dma
)paren
suffix:semicolon
)brace
multiline_comment|/* The ISR will free the request frame, but we need&n;&t; * the information to initialize the target. Duplicate.&n;&t; */
id|memcpy
c_func
(paren
op_amp
id|ReqCopy
comma
id|pScsiReq
comma
r_sizeof
(paren
id|SCSIIORequest_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Issue this command after:&n;&t; *&t;finish init&n;&t; *&t;add timer&n;&t; * Wait until the reply has been received&n;&t; *  ScsiScanDvCtx callback function will&n;&t; *&t;set hd-&gt;pLocal;&n;&t; *&t;set scandv_wait_done and call wake_up&n;&t; */
id|hd-&gt;pLocal
op_assign
l_int|NULL
suffix:semicolon
id|hd-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
id|cmdTimeout
suffix:semicolon
id|scandv_wait_done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Save cmd pointer, for resource free if timeout or&n;&t; * FW reload occurs&n;&t; */
id|hd-&gt;cmdPtr
op_assign
id|mf
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hd-&gt;timer
)paren
suffix:semicolon
id|mpt_put_msg_frame
c_func
(paren
id|ScsiScanDvCtx
comma
id|hd-&gt;ioc
comma
id|mf
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|scandv_waitq
comma
id|scandv_wait_done
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;pLocal
)paren
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
id|hd-&gt;pLocal-&gt;skip
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Always set fatal error codes in some cases.&n;&t;&t; */
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SELECTION_TIMEOUT
)paren
id|rc
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SOME_ERROR
)paren
id|rc
op_assign
op_minus
id|rc
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* This should never happen. */
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;_do_cmd: Null pLocal!!!&bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_synchronize_cache - Send SYNCHRONIZE_CACHE to all disks.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure&n; *&t;@portnum: IOC port number&n; *&n; *&t;Uses the ISR, but with special processing.&n; *&t;MUST be single-threaded.&n; *&n; *&t;Return: 0 on completion&n; */
r_static
r_int
DECL|function|mptscsih_synchronize_cache
id|mptscsih_synchronize_cache
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|portnum
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
id|SCSIDevicePage1_t
op_star
id|pcfg1Data
op_assign
l_int|NULL
suffix:semicolon
id|INTERNAL_CMD
id|iocmd
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
id|dma_addr_t
id|cfg1_dma_addr
op_assign
op_minus
l_int|1
suffix:semicolon
id|ConfigPageHeader_t
id|header1
suffix:semicolon
r_int
id|bus
op_assign
l_int|0
suffix:semicolon
r_int
id|id
op_assign
l_int|0
suffix:semicolon
r_int
id|lun
suffix:semicolon
r_int
id|indexed_lun
comma
id|lun_index
suffix:semicolon
r_int
id|hostId
op_assign
id|ioc-&gt;pfacts
(braket
id|portnum
)braket
dot
id|PortSCSIID
suffix:semicolon
r_int
id|max_id
suffix:semicolon
r_int
id|requested
comma
id|configuration
comma
id|data
suffix:semicolon
r_int
id|doConfig
op_assign
l_int|0
suffix:semicolon
id|u8
id|flags
comma
id|factor
suffix:semicolon
id|max_id
op_assign
id|ioc-&gt;sh-&gt;max_id
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Following parameters will not change&n;&t; * in this routine.&n;&t; */
id|iocmd.cmd
op_assign
id|SYNCHRONIZE_CACHE
suffix:semicolon
id|iocmd.flags
op_assign
l_int|0
suffix:semicolon
id|iocmd.physDiskNum
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
id|iocmd.rsvd
op_assign
id|iocmd.rsvd2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No SCSI hosts&n;&t; */
r_if
c_cond
(paren
id|hd-&gt;Targets
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Skip the host&n;&t; */
r_if
c_cond
(paren
id|id
op_eq
id|hostId
)paren
id|id
op_increment
suffix:semicolon
multiline_comment|/* Write SDP1 for all SCSI devices&n;&t; * Alloc memory and set up config buffer&n;&t; */
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_eq
id|SCSI
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.sdp1length
OG
l_int|0
)paren
(brace
id|pcfg1Data
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|ioc-&gt;spi_data.sdp1length
op_star
l_int|4
comma
op_amp
id|cfg1_dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcfg1Data
op_ne
l_int|NULL
)paren
(brace
id|doConfig
op_assign
l_int|1
suffix:semicolon
id|header1.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp1version
suffix:semicolon
id|header1.PageLength
op_assign
id|ioc-&gt;spi_data.sdp1length
suffix:semicolon
id|header1.PageNumber
op_assign
l_int|1
suffix:semicolon
id|header1.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg1_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
id|cfg.timeout
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* loop through all devices on this port&n;&t; */
r_while
c_loop
(paren
id|bus
OL
id|MPT_MAX_BUS
)paren
(brace
id|iocmd.bus
op_assign
id|bus
suffix:semicolon
id|iocmd.id
op_assign
id|id
suffix:semicolon
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
(paren
r_int
)paren
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|doConfig
)paren
(brace
multiline_comment|/* Set the negotiation flags */
r_if
c_cond
(paren
id|pTarget
op_logical_and
(paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|id
)braket
)paren
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|flags
op_assign
id|pTarget-&gt;negoFlags
suffix:semicolon
)brace
r_else
(brace
id|flags
op_assign
id|hd-&gt;ioc-&gt;spi_data.noQas
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
op_logical_and
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
id|data
op_assign
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|MPT_NVRAM_WIDE_DISABLE
)paren
id|flags
op_or_assign
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
id|factor
op_assign
(paren
id|data
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
id|MPT_NVRAM_SYNC_SHIFT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|factor
op_eq
l_int|0
)paren
op_logical_or
(paren
id|factor
op_eq
id|MPT_ASYNC
)paren
)paren
id|flags
op_or_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
)brace
)brace
multiline_comment|/* Force to async, narrow */
id|mptscsih_setDevicePage1Flags
c_func
(paren
l_int|0
comma
id|MPT_ASYNC
comma
l_int|0
comma
op_amp
id|requested
comma
op_amp
id|configuration
comma
id|flags
)paren
suffix:semicolon
id|dnegoprintk
c_func
(paren
(paren
l_string|&quot;syncronize cache: id=%d width=0 factor=MPT_ASYNC &quot;
l_string|&quot;offset=0 negoFlags=%x request=%x config=%x&bslash;n&quot;
comma
id|id
comma
id|flags
comma
id|requested
comma
id|configuration
)paren
)paren
suffix:semicolon
id|pcfg1Data-&gt;RequestedParameters
op_assign
id|le32_to_cpu
c_func
(paren
id|requested
)paren
suffix:semicolon
id|pcfg1Data-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pcfg1Data-&gt;Configuration
op_assign
id|le32_to_cpu
c_func
(paren
id|configuration
)paren
suffix:semicolon
id|cfg.pageAddr
op_assign
(paren
id|bus
op_lshift
l_int|8
)paren
op_or
id|id
suffix:semicolon
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
suffix:semicolon
)brace
multiline_comment|/* If target Ptr NULL or if this target is NOT a disk, skip.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|pTarget
)paren
op_logical_and
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
)paren
(brace
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
op_le
id|MPT_LAST_LUN
suffix:semicolon
id|lun
op_increment
)paren
(brace
multiline_comment|/* If LUN present, issue the command&n;&t;&t;&t;&t; */
id|lun_index
op_assign
(paren
id|lun
op_rshift
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 32 luns per lun_index */
id|indexed_lun
op_assign
(paren
id|lun
op_mod
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pTarget-&gt;luns
(braket
id|lun_index
)braket
op_amp
(paren
l_int|1
op_lshift
id|indexed_lun
)paren
)paren
(brace
id|iocmd.lun
op_assign
id|lun
suffix:semicolon
(paren
r_void
)paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* get next relevant device */
id|id
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|hostId
)paren
id|id
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|id
OG
id|max_id
)paren
(brace
id|id
op_assign
l_int|0
suffix:semicolon
id|bus
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pcfg1Data
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|header1.PageLength
op_star
l_int|4
comma
id|pcfg1Data
comma
id|cfg1_dma_addr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MPTSCSIH_ENABLE_DOMAIN_VALIDATION
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_domainValidation - Top level handler for domain validation.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure.&n; *&n; *&t;Uses the ISR, but with special processing.&n; *&t;Called from schedule, should not be in interrupt mode.&n; *&t;While thread alive, do dv for all devices needing dv&n; *&n; *&t;Return: None.&n; */
r_static
r_void
DECL|function|mptscsih_domainValidation
id|mptscsih_domainValidation
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
id|MPT_SCSI_HOST
op_star
id|hd
suffix:semicolon
id|MPT_ADAPTER
op_star
id|ioc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|id
comma
id|maxid
comma
id|dvStatus
comma
id|did
suffix:semicolon
r_int
id|ii
comma
id|isPhysDisk
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|dvtaskQ_active
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dvtaskQ_release
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* For this ioc, loop through all devices and do dv to each device.&n;&t; * When complete with this ioc, search through the ioc list, and&n;&t; * for each scsi ioc found, do dv for all devices. Exit when no&n;&t; * device needs dv.&n;&t; */
id|did
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|did
)paren
(brace
id|did
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|ioc
comma
op_amp
id|ioc_list
comma
id|list
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvtaskQ_release
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|250
)paren
suffix:semicolon
multiline_comment|/* DV only to SCSI adapters */
r_if
c_cond
(paren
id|ioc-&gt;bus_type
op_ne
id|SCSI
)paren
r_continue
suffix:semicolon
multiline_comment|/* Make sure everything looks ok */
r_if
c_cond
(paren
id|ioc-&gt;sh
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|hd
op_assign
(paren
id|MPT_SCSI_HOST
op_star
)paren
id|ioc-&gt;sh-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|hd
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;spi_data.forceDv
op_amp
id|MPT_SCSICFG_RELOAD_IOC_PG3
)paren
op_ne
l_int|0
)paren
(brace
id|mpt_read_ioc_pg_3
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.pIocPg3
)paren
(brace
id|Ioc3PhysDisk_t
op_star
id|pPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;PhysDisk
suffix:semicolon
r_int
id|numPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.dvStatus
(braket
id|pPDisk-&gt;PhysDiskID
)braket
op_amp
id|MPT_SCSICFG_DV_NOT_DONE
)paren
id|ioc-&gt;spi_data.dvStatus
(braket
id|pPDisk-&gt;PhysDiskID
)braket
op_or_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
)brace
id|ioc-&gt;spi_data.forceDv
op_and_assign
op_complement
id|MPT_SCSICFG_RELOAD_IOC_PG3
suffix:semicolon
)brace
id|maxid
op_assign
id|min_t
c_func
(paren
r_int
comma
id|ioc-&gt;sh-&gt;max_id
comma
id|MPT_MAX_SCSI_DEVICES
)paren
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|maxid
suffix:semicolon
id|id
op_increment
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvtaskQ_release
)paren
(brace
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|dvStatus
op_assign
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dvStatus
op_amp
id|MPT_SCSICFG_NEED_DV
)paren
(brace
id|did
op_increment
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_or_assign
id|MPT_SCSICFG_DV_PENDING
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|msleep
c_func
(paren
l_int|250
)paren
suffix:semicolon
multiline_comment|/* If hidden phys disk, block IO&squot;s to all&n;&t;&t;&t;&t;&t; *&t;raid volumes&n;&t;&t;&t;&t;&t; * else, process normally&n;&t;&t;&t;&t;&t; */
id|isPhysDisk
op_assign
id|mptscsih_is_phys_disk
c_func
(paren
id|ioc
comma
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isPhysDisk
)paren
(brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_amp
(paren
l_int|1
op_lshift
id|ii
)paren
)paren
(brace
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_or_assign
id|MPT_SCSICFG_DV_PENDING
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|mptscsih_doDv
c_func
(paren
id|hd
comma
l_int|0
comma
id|id
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Untagged device was busy, try again&n;&t;&t;&t;&t;&t;&t; */
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_or_assign
id|MPT_SCSICFG_NEED_DV
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_DV_PENDING
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DV is complete. Clear flags.&n;&t;&t;&t;&t;&t;&t; */
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_and_assign
op_complement
(paren
id|MPT_SCSICFG_DV_NOT_DONE
op_or
id|MPT_SCSICFG_DV_PENDING
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isPhysDisk
)paren
(brace
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_amp
(paren
l_int|1
op_lshift
id|ii
)paren
)paren
(brace
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_DV_PENDING
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.noQas
)paren
id|mptscsih_qas_check
c_func
(paren
id|hd
comma
id|id
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
id|dvtaskQ_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dvtaskQ_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Search IOC page 3 to determine if this is hidden physical disk&n; */
DECL|function|mptscsih_is_phys_disk
r_static
r_int
id|mptscsih_is_phys_disk
c_func
(paren
id|MPT_ADAPTER
op_star
id|ioc
comma
r_int
id|id
)paren
(brace
r_if
c_cond
(paren
id|ioc-&gt;spi_data.pIocPg3
)paren
(brace
id|Ioc3PhysDisk_t
op_star
id|pPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;PhysDisk
suffix:semicolon
r_int
id|numPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
r_if
c_cond
(paren
id|pPDisk-&gt;PhysDiskID
op_eq
id|id
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Write SDP1 if no QAS has been enabled&n; */
DECL|function|mptscsih_qas_check
r_static
r_void
id|mptscsih_qas_check
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|id
)paren
(brace
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;Targets
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|MPT_MAX_SCSI_DEVICES
suffix:semicolon
id|ii
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_eq
id|id
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|ii
)braket
op_amp
id|MPT_SCSICFG_DV_NOT_DONE
)paren
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|ii
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pTarget
op_ne
l_int|NULL
)paren
op_logical_and
(paren
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pTarget-&gt;negoFlags
op_amp
id|hd-&gt;ioc-&gt;spi_data.noQas
)paren
op_eq
l_int|0
)paren
(brace
id|pTarget-&gt;negoFlags
op_or_assign
id|hd-&gt;ioc-&gt;spi_data.noQas
suffix:semicolon
id|dnegoprintk
c_func
(paren
(paren
l_string|&quot;writeSDP1: id=%d flags=0&bslash;n&quot;
comma
id|id
)paren
)paren
suffix:semicolon
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
id|ii
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|mptscsih_is_phys_disk
c_func
(paren
id|hd-&gt;ioc
comma
id|ii
)paren
op_eq
l_int|1
)paren
(brace
id|dnegoprintk
c_func
(paren
(paren
l_string|&quot;writeSDP1: id=%d SCSICFG_USE_NVRAM&bslash;n&quot;
comma
id|id
)paren
)paren
suffix:semicolon
id|mptscsih_writeSDP1
c_func
(paren
id|hd
comma
l_int|0
comma
id|ii
comma
id|MPT_SCSICFG_USE_NVRAM
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|macro|MPT_GET_NVRAM_VALS
mdefine_line|#define MPT_GET_NVRAM_VALS&t;0x01
DECL|macro|MPT_UPDATE_MAX
mdefine_line|#define MPT_UPDATE_MAX&t;&t;0x02
DECL|macro|MPT_SET_MAX
mdefine_line|#define MPT_SET_MAX&t;&t;0x04
DECL|macro|MPT_SET_MIN
mdefine_line|#define MPT_SET_MIN&t;&t;0x08
DECL|macro|MPT_FALLBACK
mdefine_line|#define MPT_FALLBACK&t;&t;0x10
DECL|macro|MPT_SAVE
mdefine_line|#define MPT_SAVE&t;&t;0x20
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/**&n; *&t;mptscsih_doDv - Perform domain validation to a target.&n; *&t;@hd: Pointer to MPT_SCSI_HOST structure.&n; *&t;@portnum: IOC port number.&n; *&t;@target: Physical ID of this target&n; *&n; *&t;Uses the ISR, but with special processing.&n; *&t;MUST be single-threaded.&n; *&t;Test will exit if target is at async &amp; narrow.&n; *&n; *&t;Return: None.&n; */
r_static
r_int
DECL|function|mptscsih_doDv
id|mptscsih_doDv
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
r_int
id|bus_number
comma
r_int
id|id
)paren
(brace
id|MPT_ADAPTER
op_star
id|ioc
op_assign
id|hd-&gt;ioc
suffix:semicolon
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
id|SCSIDevicePage1_t
op_star
id|pcfg1Data
suffix:semicolon
id|SCSIDevicePage0_t
op_star
id|pcfg0Data
suffix:semicolon
id|u8
op_star
id|pbuf1
suffix:semicolon
id|u8
op_star
id|pbuf2
suffix:semicolon
id|u8
op_star
id|pDvBuf
suffix:semicolon
id|dma_addr_t
id|dvbuf_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_addr_t
id|buf1_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_addr_t
id|buf2_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_addr_t
id|cfg1_dma_addr
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_addr_t
id|cfg0_dma_addr
op_assign
op_minus
l_int|1
suffix:semicolon
id|ConfigPageHeader_t
id|header1
suffix:semicolon
id|ConfigPageHeader_t
id|header0
suffix:semicolon
id|DVPARAMETERS
id|dv
suffix:semicolon
id|INTERNAL_CMD
id|iocmd
suffix:semicolon
id|CONFIGPARMS
id|cfg
suffix:semicolon
r_int
id|dv_alloc
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
comma
id|sz
op_assign
l_int|0
suffix:semicolon
r_int
id|bufsize
op_assign
l_int|0
suffix:semicolon
r_int
id|dataBufSize
op_assign
l_int|0
suffix:semicolon
r_int
id|echoBufSize
op_assign
l_int|0
suffix:semicolon
r_int
id|notDone
suffix:semicolon
r_int
id|patt
suffix:semicolon
r_int
id|repeat
suffix:semicolon
r_int
id|retcode
op_assign
l_int|0
suffix:semicolon
r_int
id|nfactor
op_assign
id|MPT_ULTRA320
suffix:semicolon
r_char
id|firstPass
op_assign
l_int|1
suffix:semicolon
r_char
id|doFallback
op_assign
l_int|0
suffix:semicolon
r_char
id|readPage0
suffix:semicolon
r_char
id|bus
comma
id|lun
suffix:semicolon
r_char
id|inq0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.sdp1length
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.sdp0length
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* If multiple buses are used, require that the initiator&n;&t; * id be the same on all buses.&n;&t; */
r_if
c_cond
(paren
id|id
op_eq
id|ioc-&gt;pfacts
(braket
l_int|0
)braket
dot
id|PortSCSIID
)paren
r_return
l_int|0
suffix:semicolon
id|lun
op_assign
l_int|0
suffix:semicolon
id|bus
op_assign
(paren
id|u8
)paren
id|bus_number
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV started: bus=%d, id=%d dv @ %p&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|bus
comma
id|id
comma
op_amp
id|dv
)paren
)paren
suffix:semicolon
multiline_comment|/* Prep DV structure&n;&t; */
id|memset
(paren
op_amp
id|dv
comma
l_int|0
comma
r_sizeof
(paren
id|DVPARAMETERS
)paren
)paren
suffix:semicolon
id|dv.id
op_assign
id|id
suffix:semicolon
multiline_comment|/* Populate tmax with the current maximum&n;&t; * transfer parameters for this target.&n;&t; * Exit if narrow and async.&n;&t; */
id|dv.cmd
op_assign
id|MPT_GET_NVRAM_VALS
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Prep SCSI IO structure&n;&t; */
id|iocmd.id
op_assign
id|id
suffix:semicolon
id|iocmd.bus
op_assign
id|bus
suffix:semicolon
id|iocmd.lun
op_assign
id|lun
suffix:semicolon
id|iocmd.flags
op_assign
l_int|0
suffix:semicolon
id|iocmd.physDiskNum
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.rsvd
op_assign
id|iocmd.rsvd2
op_assign
l_int|0
suffix:semicolon
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
id|id
)braket
suffix:semicolon
multiline_comment|/* Use tagged commands if possible.&n;&t; */
r_if
c_cond
(paren
id|pTarget
)paren
(brace
r_if
c_cond
(paren
id|pTarget-&gt;tflags
op_amp
id|MPT_TARGET_FLAGS_Q_YES
)paren
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_TAGGED_CMD
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;facts.FWVersion.Word
OL
l_int|0x01000600
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;facts.FWVersion.Word
op_ge
l_int|0x01010000
)paren
op_logical_and
(paren
id|hd-&gt;ioc-&gt;facts.FWVersion.Word
OL
l_int|0x01010B00
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Prep cfg structure&n;&t; */
id|cfg.pageAddr
op_assign
(paren
id|bus
op_lshift
l_int|8
)paren
op_or
id|id
suffix:semicolon
id|cfg.hdr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Prep SDP0 header&n;&t; */
id|header0.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp0version
suffix:semicolon
id|header0.PageLength
op_assign
id|ioc-&gt;spi_data.sdp0length
suffix:semicolon
id|header0.PageNumber
op_assign
l_int|0
suffix:semicolon
id|header0.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
multiline_comment|/* Prep SDP1 header&n;&t; */
id|header1.PageVersion
op_assign
id|ioc-&gt;spi_data.sdp1version
suffix:semicolon
id|header1.PageLength
op_assign
id|ioc-&gt;spi_data.sdp1length
suffix:semicolon
id|header1.PageNumber
op_assign
l_int|1
suffix:semicolon
id|header1.PageType
op_assign
id|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
suffix:semicolon
r_if
c_cond
(paren
id|header0.PageLength
op_amp
l_int|1
)paren
id|dv_alloc
op_assign
(paren
id|header0.PageLength
op_star
l_int|4
)paren
op_plus
l_int|4
suffix:semicolon
id|dv_alloc
op_add_assign
(paren
l_int|2048
op_plus
(paren
id|header1.PageLength
op_star
l_int|4
)paren
)paren
suffix:semicolon
id|pDvBuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dv_alloc
comma
op_amp
id|dvbuf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDvBuf
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|sz
op_assign
l_int|0
suffix:semicolon
id|pbuf1
op_assign
(paren
id|u8
op_star
)paren
id|pDvBuf
suffix:semicolon
id|buf1_dma
op_assign
id|dvbuf_dma
suffix:semicolon
id|sz
op_add_assign
l_int|1024
suffix:semicolon
id|pbuf2
op_assign
(paren
id|u8
op_star
)paren
(paren
id|pDvBuf
op_plus
id|sz
)paren
suffix:semicolon
id|buf2_dma
op_assign
id|dvbuf_dma
op_plus
id|sz
suffix:semicolon
id|sz
op_add_assign
l_int|1024
suffix:semicolon
id|pcfg0Data
op_assign
(paren
id|SCSIDevicePage0_t
op_star
)paren
(paren
id|pDvBuf
op_plus
id|sz
)paren
suffix:semicolon
id|cfg0_dma_addr
op_assign
id|dvbuf_dma
op_plus
id|sz
suffix:semicolon
id|sz
op_add_assign
id|header0.PageLength
op_star
l_int|4
suffix:semicolon
multiline_comment|/* 8-byte alignment&n;&t; */
r_if
c_cond
(paren
id|header0.PageLength
op_amp
l_int|1
)paren
id|sz
op_add_assign
l_int|4
suffix:semicolon
id|pcfg1Data
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
(paren
id|pDvBuf
op_plus
id|sz
)paren
suffix:semicolon
id|cfg1_dma_addr
op_assign
id|dvbuf_dma
op_plus
id|sz
suffix:semicolon
multiline_comment|/* Skip this ID? Set cfg.hdr to force config page write&n;&t; */
(brace
id|ScsiCfgData
op_star
id|pspi_data
op_assign
op_amp
id|hd-&gt;ioc-&gt;spi_data
suffix:semicolon
r_if
c_cond
(paren
id|pspi_data-&gt;nvram
op_logical_and
(paren
id|pspi_data-&gt;nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
multiline_comment|/* Set the factor from nvram */
id|nfactor
op_assign
(paren
id|pspi_data-&gt;nvram
(braket
id|id
)braket
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|nfactor
OL
id|pspi_data-&gt;minSyncFactor
)paren
id|nfactor
op_assign
id|pspi_data-&gt;minSyncFactor
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pspi_data-&gt;nvram
(braket
id|id
)braket
op_amp
id|MPT_NVRAM_ID_SCAN_ENABLE
)paren
op_logical_or
(paren
id|pspi_data-&gt;PortFlags
op_eq
id|MPI_SCSIPORTPAGE2_PORT_FLAGS_OFF_DV
)paren
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV Skipped: bus, id, lun (%d, %d, %d)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|bus
comma
id|id
comma
id|lun
)paren
)paren
suffix:semicolon
id|dv.cmd
op_assign
id|MPT_SET_MAX
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
multiline_comment|/* Save the final negotiated settings to&n;&t;&t;&t;&t; * SCSI device page 1.&n;&t;&t;&t;&t; */
id|cfg.physAddr
op_assign
id|cfg1_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Finish iocmd inititialization - hidden or visible disk? */
r_if
c_cond
(paren
id|ioc-&gt;spi_data.pIocPg3
)paren
(brace
multiline_comment|/* Search IOC page 3 for matching id&n;&t;&t; */
id|Ioc3PhysDisk_t
op_star
id|pPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;PhysDisk
suffix:semicolon
r_int
id|numPDisk
op_assign
id|ioc-&gt;spi_data.pIocPg3-&gt;NumPhysDisks
suffix:semicolon
r_while
c_loop
(paren
id|numPDisk
)paren
(brace
r_if
c_cond
(paren
id|pPDisk-&gt;PhysDiskID
op_eq
id|id
)paren
(brace
multiline_comment|/* match */
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_PHYS_DISK
suffix:semicolon
id|iocmd.physDiskNum
op_assign
id|pPDisk-&gt;PhysDiskNum
suffix:semicolon
multiline_comment|/* Quiesce the IM&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|mptscsih_do_raid
c_func
(paren
id|hd
comma
id|MPI_RAID_ACTION_QUIESCE_PHYS_IO
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;RAID Queisce FAILED!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|pPDisk
op_increment
suffix:semicolon
id|numPDisk
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/* RAID Volume ID&squot;s may double for a physical device. If RAID but&n;&t; * not a physical ID as well, skip DV.&n;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;spi_data.isRaid
op_amp
(paren
l_int|1
op_lshift
id|id
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_PHYS_DISK
)paren
)paren
r_goto
id|target_done
suffix:semicolon
multiline_comment|/* Basic Test.&n;&t; * Async &amp; Narrow - Inquiry&n;&t; * Async &amp; Narrow - Inquiry&n;&t; * Maximum transfer rate - Inquiry&n;&t; * Compare buffers:&n;&t; *&t;If compare, test complete.&n;&t; *&t;If miscompare and first pass, repeat&n;&t; *&t;If miscompare and not first pass, fall back and repeat&n;&t; */
id|hd-&gt;pLocal
op_assign
l_int|NULL
suffix:semicolon
id|readPage0
op_assign
l_int|0
suffix:semicolon
id|sz
op_assign
id|SCSI_MAX_INQUIRY_BYTES
suffix:semicolon
id|rc
op_assign
id|MPT_SCANDV_GOOD
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV: Start Basic test on id=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|id
)paren
)paren
suffix:semicolon
id|retcode
op_assign
l_int|0
suffix:semicolon
id|dv.cmd
op_assign
id|MPT_SET_MIN
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg1_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
multiline_comment|/* Wide - narrow - wide workaround case&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_eq
id|MPT_SCANDV_ISSUE_SENSE
)paren
op_logical_and
id|dv.max.width
)paren
(brace
multiline_comment|/* Send an untagged command to reset disk Qs corrupted&n;&t;&t;&t; * when a parity error occurs on a Request Sense.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;ioc-&gt;facts.FWVersion.Word
op_ge
l_int|0x01000600
)paren
op_logical_or
(paren
(paren
id|hd-&gt;ioc-&gt;facts.FWVersion.Word
op_ge
l_int|0x01010000
)paren
op_logical_and
(paren
id|hd-&gt;ioc-&gt;facts.FWVersion.Word
OL
l_int|0x01010B00
)paren
)paren
)paren
(brace
id|iocmd.cmd
op_assign
id|REQUEST_SENSE
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf1_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf1
suffix:semicolon
id|iocmd.size
op_assign
l_int|0x12
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
op_logical_or
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
)paren
(brace
id|dv.max.width
op_assign
l_int|0
suffix:semicolon
id|doFallback
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_goto
id|target_done
suffix:semicolon
)brace
)brace
r_else
r_goto
id|target_done
suffix:semicolon
)brace
id|iocmd.cmd
op_assign
id|INQUIRY
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf1_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf1
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
id|memset
c_func
(paren
id|pbuf1
comma
l_int|0x00
comma
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;pLocal-&gt;scsiStatus
op_eq
id|SAM_STAT_BUSY
)paren
(brace
r_if
c_cond
(paren
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_TAGGED_CMD
)paren
op_eq
l_int|0
)paren
id|retcode
op_assign
l_int|1
suffix:semicolon
r_else
id|retcode
op_assign
l_int|0
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If first command doesn&squot;t complete&n;&t;&t;&t;&t; * with a good status or with a check condition,&n;&t;&t;&t;&t; * exit.&n;&t;&t;&t;&t; */
r_goto
id|target_done
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset the size for disks&n;&t;&t; */
id|inq0
op_assign
(paren
op_star
id|pbuf1
)paren
op_amp
l_int|0x1F
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inq0
op_eq
l_int|0
)paren
op_logical_and
id|pTarget
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|sz
op_assign
l_int|0x40
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
)brace
multiline_comment|/* Another GEM workaround. Check peripheral device type,&n;&t;&t; * if PROCESSOR, quit DV.&n;&t;&t; */
r_if
c_cond
(paren
id|inq0
op_eq
id|TYPE_PROCESSOR
)paren
(brace
id|mptscsih_initTarget
c_func
(paren
id|hd
comma
id|bus
comma
id|id
comma
id|lun
comma
id|pbuf1
comma
id|sz
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inq0
OG
l_int|0x08
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|sz
op_eq
l_int|0x40
)paren
(brace
r_if
c_cond
(paren
(paren
id|pTarget-&gt;maxWidth
op_eq
l_int|1
)paren
op_logical_and
(paren
id|pTarget-&gt;maxOffset
)paren
op_logical_and
(paren
id|nfactor
OL
l_int|0x0A
)paren
op_logical_and
(paren
id|pTarget-&gt;minSyncFactor
OG
l_int|0x09
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pbuf1
(braket
l_int|56
)braket
op_amp
l_int|0x04
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|pbuf1
(braket
l_int|56
)braket
op_amp
l_int|0x01
)paren
op_eq
l_int|1
)paren
(brace
id|pTarget-&gt;minSyncFactor
op_assign
id|nfactor
OG
id|MPT_ULTRA320
ques
c_cond
id|nfactor
suffix:colon
id|MPT_ULTRA320
suffix:semicolon
)brace
r_else
(brace
id|pTarget-&gt;minSyncFactor
op_assign
id|nfactor
OG
id|MPT_ULTRA160
ques
c_cond
id|nfactor
suffix:colon
id|MPT_ULTRA160
suffix:semicolon
)brace
id|dv.max.factor
op_assign
id|pTarget-&gt;minSyncFactor
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pbuf1
(braket
l_int|56
)braket
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
(brace
id|pTarget-&gt;negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.noQas
op_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV: Start Basic noQas on id=%d due to pbuf1[56]=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|id
comma
id|pbuf1
(braket
l_int|56
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|doFallback
)paren
id|dv.cmd
op_assign
id|MPT_FALLBACK
suffix:semicolon
r_else
id|dv.cmd
op_assign
id|MPT_SET_MAX
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.now.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.now.offset
)paren
)paren
r_goto
id|target_done
suffix:semicolon
id|iocmd.cmd
op_assign
id|INQUIRY
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf2_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf2
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
id|memset
c_func
(paren
id|pbuf2
comma
l_int|0x00
comma
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
multiline_comment|/* Save the return code.&n;&t;&t;&t; * If this is the first pass,&n;&t;&t;&t; * read SCSI Device Page 0&n;&t;&t;&t; * and update the target max parameters.&n;&t;&t;&t; */
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
id|doFallback
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|readPage0
)paren
(brace
id|u32
id|sdp0_info
suffix:semicolon
id|u32
id|sdp0_nego
suffix:semicolon
id|cfg.hdr
op_assign
op_amp
id|header0
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg0_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
id|sdp0_info
op_assign
id|le32_to_cpu
c_func
(paren
id|pcfg0Data-&gt;Information
)paren
op_amp
l_int|0x0E
suffix:semicolon
id|sdp0_nego
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|pcfg0Data-&gt;NegotiatedParameters
)paren
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
suffix:semicolon
multiline_comment|/* Quantum and Fujitsu workarounds.&n;&t;&t;&t;&t;&t; * Quantum: PPR U320 -&gt; PPR reply with Ultra2 and wide&n;&t;&t;&t;&t;&t; * Fujitsu: PPR U320 -&gt; Msg Reject and Ultra2 and wide&n;&t;&t;&t;&t;&t; * Resetart with a request for U160.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|dv.now.factor
op_eq
id|MPT_ULTRA320
)paren
op_logical_and
(paren
id|sdp0_nego
op_eq
id|MPT_ULTRA2
)paren
)paren
(brace
id|doFallback
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|dv.cmd
op_assign
id|MPT_UPDATE_MAX
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg0Data
)paren
suffix:semicolon
multiline_comment|/* Update the SCSI device page 1 area&n;&t;&t;&t;&t;&t;&t; */
id|pcfg1Data-&gt;RequestedParameters
op_assign
id|pcfg0Data-&gt;NegotiatedParameters
suffix:semicolon
id|readPage0
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Quantum workaround. Restart this test will the fallback&n;&t;&t;&t;&t; * flag set.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|doFallback
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|pbuf1
comma
id|pbuf2
comma
id|sz
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|firstPass
)paren
id|doFallback
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV:Inquiry compared id=%d, calling initTarget&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|id
)paren
)paren
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.dvStatus
(braket
id|id
)braket
op_and_assign
op_complement
id|MPT_SCSICFG_DV_NOT_DONE
suffix:semicolon
id|mptscsih_initTarget
c_func
(paren
id|hd
comma
id|bus
comma
id|id
comma
id|lun
comma
id|pbuf1
comma
id|sz
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* test complete */
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_ISSUE_SENSE
)paren
id|doFallback
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set fallback flag */
r_else
r_if
c_cond
(paren
(paren
id|rc
op_eq
id|MPT_SCANDV_DID_RESET
)paren
op_logical_or
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
op_logical_or
(paren
id|rc
op_eq
id|MPT_SCANDV_FALLBACK
)paren
)paren
id|doFallback
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set fallback flag */
r_else
r_goto
id|target_done
suffix:semicolon
id|firstPass
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;DV: Basic test on id=%d completed OK.&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver_setup.dv
op_eq
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
id|inq0
op_assign
(paren
op_star
id|pbuf1
)paren
op_amp
l_int|0x1F
suffix:semicolon
multiline_comment|/* Continue only for disks&n;&t; */
r_if
c_cond
(paren
id|inq0
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;spi_data.PortFlags
op_eq
id|MPI_SCSIPORTPAGE2_PORT_FLAGS_BASIC_DV_ONLY
)paren
r_goto
id|target_done
suffix:semicolon
multiline_comment|/* Start the Enhanced Test.&n;&t; * 0) issue TUR to clear out check conditions&n;&t; * 1) read capacity of echo (regular) buffer&n;&t; * 2) reserve device&n;&t; * 3) do write-read-compare data pattern test&n;&t; * 4) release&n;&t; * 5) update nego parms to target struct&n;&t; */
id|cfg.hdr
op_assign
op_amp
id|header1
suffix:semicolon
id|cfg.physAddr
op_assign
id|cfg1_dma_addr
suffix:semicolon
id|cfg.action
op_assign
id|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
suffix:semicolon
id|cfg.dir
op_assign
l_int|1
suffix:semicolon
id|iocmd.cmd
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
id|notDone
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|notDone
)paren
(brace
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
id|notDone
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|u8
id|asc
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
suffix:semicolon
id|u8
id|ascq
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|skey
comma
id|asc
comma
id|ascq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skey
op_eq
id|UNIT_ATTENTION
)paren
id|notDone
op_increment
suffix:semicolon
multiline_comment|/* repeat */
r_else
r_if
c_cond
(paren
(paren
id|skey
op_eq
id|NOT_READY
)paren
op_logical_and
(paren
id|asc
op_eq
l_int|0x04
)paren
op_logical_and
(paren
id|ascq
op_eq
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* wait then repeat */
id|mdelay
(paren
l_int|2000
)paren
suffix:semicolon
id|notDone
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|skey
op_eq
id|NOT_READY
)paren
op_logical_and
(paren
id|asc
op_eq
l_int|0x3A
)paren
)paren
(brace
multiline_comment|/* no medium, try read test anyway */
id|notDone
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* All other errors are fatal.&n;&t;&t;&t;&t; */
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: fatal error.&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
r_else
r_goto
id|target_done
suffix:semicolon
)brace
id|iocmd.cmd
op_assign
id|READ_BUFFER
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf1_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf1
suffix:semicolon
id|iocmd.size
op_assign
l_int|4
suffix:semicolon
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_BUF_CAP
suffix:semicolon
id|dataBufSize
op_assign
l_int|0
suffix:semicolon
id|echoBufSize
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|patt
op_assign
l_int|0
suffix:semicolon
id|patt
OL
l_int|2
suffix:semicolon
id|patt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|patt
op_eq
l_int|0
)paren
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_ECHO
suffix:semicolon
r_else
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_ECHO
suffix:semicolon
id|notDone
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|notDone
)paren
(brace
id|bufsize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If not ready after 8 trials,&n;&t;&t;&t; * give up on this device.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|notDone
OG
l_int|8
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;ReadBuffer Comp Code %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;  buff: %0x %0x %0x %0x&bslash;n&quot;
comma
id|pbuf1
(braket
l_int|0
)braket
comma
id|pbuf1
(braket
l_int|1
)braket
comma
id|pbuf1
(braket
l_int|2
)braket
comma
id|pbuf1
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
id|notDone
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
id|bufsize
op_assign
(paren
(paren
id|pbuf1
(braket
l_int|2
)braket
op_amp
l_int|0x1F
)paren
op_lshift
l_int|8
)paren
op_or
id|pbuf1
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
id|bufsize
op_assign
id|pbuf1
(braket
l_int|1
)braket
op_lshift
l_int|16
op_or
id|pbuf1
(braket
l_int|2
)braket
op_lshift
l_int|8
op_or
id|pbuf1
(braket
l_int|3
)braket
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|u8
id|asc
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
suffix:semicolon
id|u8
id|ascq
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|skey
comma
id|asc
comma
id|ascq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skey
op_eq
id|ILLEGAL_REQUEST
)paren
(brace
id|notDone
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skey
op_eq
id|UNIT_ATTENTION
)paren
(brace
id|notDone
op_increment
suffix:semicolon
multiline_comment|/* repeat */
)brace
r_else
r_if
c_cond
(paren
(paren
id|skey
op_eq
id|NOT_READY
)paren
op_logical_and
(paren
id|asc
op_eq
l_int|0x04
)paren
op_logical_and
(paren
id|ascq
op_eq
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* wait then repeat */
id|mdelay
(paren
l_int|2000
)paren
suffix:semicolon
id|notDone
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* All other errors are fatal.&n;&t;&t;&t;&t;&t;&t; */
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: fatal error.&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* All other errors are fatal&n;&t;&t;&t;&t;&t; */
r_goto
id|target_done
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
id|echoBufSize
op_assign
id|bufsize
suffix:semicolon
r_else
id|dataBufSize
op_assign
id|bufsize
suffix:semicolon
)brace
id|sz
op_assign
l_int|0
suffix:semicolon
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_BUF_CAP
suffix:semicolon
multiline_comment|/* Use echo buffers if possible,&n;&t; * Exit if both buffers are 0.&n;&t; */
r_if
c_cond
(paren
id|echoBufSize
OG
l_int|0
)paren
(brace
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_ECHO
suffix:semicolon
r_if
c_cond
(paren
id|dataBufSize
OG
l_int|0
)paren
id|bufsize
op_assign
id|min
c_func
(paren
id|echoBufSize
comma
id|dataBufSize
)paren
suffix:semicolon
r_else
id|bufsize
op_assign
id|echoBufSize
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dataBufSize
op_eq
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;%s Buffer Capacity %d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
ques
c_cond
l_string|&quot;Echo&quot;
suffix:colon
l_string|&quot; &quot;
comma
id|bufsize
)paren
)paren
suffix:semicolon
multiline_comment|/* Data buffers for write-read-compare test max 1K.&n;&t; */
id|sz
op_assign
id|min
c_func
(paren
id|bufsize
comma
l_int|1024
)paren
suffix:semicolon
multiline_comment|/* --- loop ----&n;&t; * On first pass, always issue a reserve.&n;&t; * On additional loops, only if a reset has occurred.&n;&t; * iocmd.flags indicates if echo or regular buffer&n;&t; */
r_for
c_loop
(paren
id|patt
op_assign
l_int|0
suffix:semicolon
id|patt
OL
l_int|4
suffix:semicolon
id|patt
op_increment
)paren
(brace
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;Pattern %d&bslash;n&quot;
comma
id|patt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_RESERVED
)paren
op_logical_and
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_DID_RESET
)paren
)paren
(brace
id|iocmd.cmd
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
id|iocmd.cmd
op_assign
id|RELEASE
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;Release rc %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_RESERVED
suffix:semicolon
r_else
r_goto
id|target_done
suffix:semicolon
)brace
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_RESERVED
suffix:semicolon
)brace
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_DID_RESET
suffix:semicolon
id|repeat
op_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|repeat
op_logical_and
(paren
op_logical_neg
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_RESERVED
)paren
)paren
)paren
(brace
id|iocmd.cmd
op_assign
id|RESERVE
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_RESERVED
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
multiline_comment|/* Wait if coming ready&n;&t;&t;&t;&t;&t; */
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|u8
id|asc
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
suffix:semicolon
id|u8
id|ascq
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Reserve Failed: &quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|skey
comma
id|asc
comma
id|ascq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skey
op_eq
id|NOT_READY
)paren
op_logical_and
(paren
id|asc
op_eq
l_int|0x04
)paren
op_logical_and
(paren
id|ascq
op_eq
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* wait then repeat */
id|mdelay
(paren
l_int|2000
)paren
suffix:semicolon
id|notDone
op_increment
suffix:semicolon
)brace
r_else
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Reserved Failed.&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
r_else
(brace
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Reserved Failed.&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
r_goto
id|target_done
suffix:semicolon
)brace
)brace
)brace
id|mptscsih_fillbuf
c_func
(paren
id|pbuf1
comma
id|sz
comma
id|patt
comma
l_int|1
)paren
suffix:semicolon
id|iocmd.cmd
op_assign
id|WRITE_BUFFER
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf1_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf1
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
suffix:semicolon
multiline_comment|/* Issue read buffer */
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_DID_RESET
)paren
(brace
multiline_comment|/* If using echo buffers, reset to data buffers.&n;&t;&t;&t;&t; * Else do Fallback and restart&n;&t;&t;&t;&t; * this test (re-issue reserve&n;&t;&t;&t;&t; * because of bus reset).&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
op_logical_and
(paren
id|dataBufSize
op_ge
id|bufsize
)paren
)paren
(brace
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_ECHO
suffix:semicolon
)brace
r_else
(brace
id|dv.cmd
op_assign
id|MPT_FALLBACK
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.now.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.now.offset
)paren
)paren
r_goto
id|target_done
suffix:semicolon
)brace
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_DID_RESET
suffix:semicolon
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
multiline_comment|/* Restart data test if UA, else quit.&n;&t;&t;&t;&t; */
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|skey
comma
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
comma
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skey
op_eq
id|UNIT_ATTENTION
)paren
(brace
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|skey
op_eq
id|ILLEGAL_REQUEST
)paren
(brace
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
r_if
c_cond
(paren
id|dataBufSize
op_ge
id|bufsize
)paren
(brace
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_ECHO
suffix:semicolon
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_goto
id|target_done
suffix:semicolon
)brace
r_else
r_goto
id|target_done
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fatal error */
r_goto
id|target_done
suffix:semicolon
)brace
)brace
id|iocmd.cmd
op_assign
id|READ_BUFFER
suffix:semicolon
id|iocmd.data_dma
op_assign
id|buf2_dma
suffix:semicolon
id|iocmd.data
op_assign
id|pbuf2
suffix:semicolon
id|iocmd.size
op_assign
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
op_eq
l_int|NULL
)paren
r_goto
id|target_done
suffix:semicolon
r_else
(brace
id|rc
op_assign
id|hd-&gt;pLocal-&gt;completion
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_GOOD
)paren
(brace
multiline_comment|/* If buffers compare,&n;&t;&t;&t;&t;  * go to next pattern,&n;&t;&t;&t;&t;  * else, do a fallback and restart&n;&t;&t;&t;&t;  * data transfer test.&n;&t;&t;&t;&t;  */
r_if
c_cond
(paren
id|memcmp
(paren
id|pbuf1
comma
id|pbuf2
comma
id|sz
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
multiline_comment|/* goto next pattern */
)brace
r_else
(brace
multiline_comment|/* Miscompare with Echo buffer, go to data buffer,&n;&t;&t;&t;&t;&t; * if that buffer exists.&n;&t;&t;&t;&t;&t; * Miscompare with Data buffer, check first 4 bytes,&n;&t;&t;&t;&t;&t; * some devices return capacity. Exit in this case.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_ECHO
)paren
(brace
r_if
c_cond
(paren
id|dataBufSize
op_ge
id|bufsize
)paren
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_ECHO
suffix:semicolon
r_else
r_goto
id|target_done
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dataBufSize
op_eq
(paren
id|pbuf2
(braket
l_int|1
)braket
op_lshift
l_int|16
op_or
id|pbuf2
(braket
l_int|2
)braket
op_lshift
l_int|8
op_or
id|pbuf2
(braket
l_int|3
)braket
)paren
)paren
(brace
multiline_comment|/* Argh. Device returning wrong data.&n;&t;&t;&t;&t;&t;&t;&t; * Quit DV for this device.&n;&t;&t;&t;&t;&t;&t;&t; */
r_goto
id|target_done
suffix:semicolon
)brace
multiline_comment|/* Had an actual miscompare. Slow down.*/
id|dv.cmd
op_assign
id|MPT_FALLBACK
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.now.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.now.offset
)paren
)paren
r_goto
id|target_done
suffix:semicolon
)brace
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_DID_RESET
)paren
(brace
multiline_comment|/* Do Fallback and restart&n;&t;&t;&t;&t; * this test (re-issue reserve&n;&t;&t;&t;&t; * because of bus reset).&n;&t;&t;&t;&t; */
id|dv.cmd
op_assign
id|MPT_FALLBACK
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpt_config
c_func
(paren
id|hd-&gt;ioc
comma
op_amp
id|cfg
)paren
op_ne
l_int|0
)paren
r_goto
id|target_done
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dv.now.width
)paren
op_logical_and
(paren
op_logical_neg
id|dv.now.offset
)paren
)paren
r_goto
id|target_done
suffix:semicolon
id|iocmd.flags
op_or_assign
id|MPT_ICFLAG_DID_RESET
suffix:semicolon
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
id|MPT_SCANDV_SENSE
)paren
(brace
multiline_comment|/* Restart data test if UA, else quit.&n;&t;&t;&t;&t; */
id|u8
id|skey
op_assign
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|2
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;SenseKey:ASC:ASCQ = (%x:%02x:%02x)&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|skey
comma
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|12
)braket
comma
id|hd-&gt;pLocal-&gt;sense
(braket
l_int|13
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skey
op_eq
id|UNIT_ATTENTION
)paren
(brace
id|patt
op_assign
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_goto
id|target_done
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fatal error */
r_goto
id|target_done
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* --- end of patt loop ---- */
id|target_done
suffix:colon
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_RESERVED
)paren
(brace
id|iocmd.cmd
op_assign
id|RELEASE
suffix:semicolon
id|iocmd.data_dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|iocmd.data
op_assign
l_int|NULL
suffix:semicolon
id|iocmd.size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mptscsih_do_cmd
c_func
(paren
id|hd
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Release failed. id %d&quot;
comma
id|ioc-&gt;name
comma
id|id
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hd-&gt;pLocal
)paren
(brace
r_if
c_cond
(paren
id|hd-&gt;pLocal-&gt;completion
op_eq
id|MPT_SCANDV_GOOD
)paren
id|iocmd.flags
op_and_assign
op_complement
id|MPT_ICFLAG_RESERVED
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV: Release failed. id %d&quot;
comma
id|ioc-&gt;name
comma
id|id
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Set if cfg1_dma_addr contents is valid&n;&t; */
r_if
c_cond
(paren
(paren
id|cfg.hdr
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|retcode
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* If disk, not U320, disable QAS&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|inq0
op_eq
l_int|0
)paren
op_logical_and
(paren
id|dv.now.factor
OG
id|MPT_ULTRA320
)paren
)paren
(brace
id|hd-&gt;ioc-&gt;spi_data.noQas
op_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;noQas set due to id=%d has factor=%x&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|id
comma
id|dv.now.factor
)paren
)paren
suffix:semicolon
)brace
id|dv.cmd
op_assign
id|MPT_SAVE
suffix:semicolon
id|mptscsih_dv_parms
c_func
(paren
id|hd
comma
op_amp
id|dv
comma
(paren
r_void
op_star
)paren
id|pcfg1Data
)paren
suffix:semicolon
multiline_comment|/* Double writes to SDP1 can cause problems,&n;&t;&t; * skip save of the final negotiated settings to&n;&t;&t; * SCSI device page 1.&n;&t;&t; *&n;&t;&t;cfg.hdr = &amp;header1;&n;&t;&t;cfg.physAddr = cfg1_dma_addr;&n;&t;&t;cfg.action = MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT;&n;&t;&t;cfg.dir = 1;&n;&t;&t;mpt_config(hd-&gt;ioc, &amp;cfg);&n;&t;&t; */
)brace
multiline_comment|/* If this is a RAID Passthrough, enable internal IOs&n;&t; */
r_if
c_cond
(paren
id|iocmd.flags
op_amp
id|MPT_ICFLAG_PHYS_DISK
)paren
(brace
r_if
c_cond
(paren
id|mptscsih_do_raid
c_func
(paren
id|hd
comma
id|MPI_RAID_ACTION_ENABLE_PHYS_IO
comma
op_amp
id|iocmd
)paren
OL
l_int|0
)paren
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_ERR_FMT
l_string|&quot;RAID Enable FAILED!&bslash;n&quot;
comma
id|ioc-&gt;name
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Done with the DV scan of the current target&n;&t; */
r_if
c_cond
(paren
id|pDvBuf
)paren
id|pci_free_consistent
c_func
(paren
id|ioc-&gt;pcidev
comma
id|dv_alloc
comma
id|pDvBuf
comma
id|dvbuf_dma
)paren
suffix:semicolon
id|ddvtprintk
c_func
(paren
(paren
id|MYIOC_s_INFO_FMT
l_string|&quot;DV Done id=%d&bslash;n&quot;
comma
id|ioc-&gt;name
comma
id|id
)paren
)paren
suffix:semicolon
r_return
id|retcode
suffix:semicolon
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_dv_parms - perform a variety of operations on the&n; *&t;parameters used for negotiation.&n; *&t;@hd: Pointer to a SCSI host.&n; *&t;@dv: Pointer to a structure that contains the maximum and current&n; *&t;&t;negotiated parameters.&n; */
r_static
r_void
DECL|function|mptscsih_dv_parms
id|mptscsih_dv_parms
c_func
(paren
id|MPT_SCSI_HOST
op_star
id|hd
comma
id|DVPARAMETERS
op_star
id|dv
comma
r_void
op_star
id|pPage
)paren
(brace
id|VirtDevice
op_star
id|pTarget
suffix:semicolon
id|SCSIDevicePage0_t
op_star
id|pPage0
suffix:semicolon
id|SCSIDevicePage1_t
op_star
id|pPage1
suffix:semicolon
r_int
id|val
op_assign
l_int|0
comma
id|data
comma
id|configuration
suffix:semicolon
id|u8
id|width
op_assign
l_int|0
suffix:semicolon
id|u8
id|offset
op_assign
l_int|0
suffix:semicolon
id|u8
id|factor
op_assign
l_int|0
suffix:semicolon
id|u8
id|negoFlags
op_assign
l_int|0
suffix:semicolon
id|u8
id|cmd
op_assign
id|dv-&gt;cmd
suffix:semicolon
id|u8
id|id
op_assign
id|dv-&gt;id
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MPT_GET_NVRAM_VALS
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Getting NVRAM: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Get the NVRAM values and save in tmax&n;&t;&t; * If not an LVD bus, the adapter minSyncFactor has been&n;&t;&t; * already throttled back.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;Targets
)paren
op_logical_and
(paren
(paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
(paren
r_int
)paren
id|id
)braket
)paren
op_ne
l_int|NULL
)paren
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|width
op_assign
id|pTarget-&gt;maxWidth
suffix:semicolon
id|offset
op_assign
id|pTarget-&gt;maxOffset
suffix:semicolon
id|factor
op_assign
id|pTarget-&gt;minSyncFactor
suffix:semicolon
id|negoFlags
op_assign
id|pTarget-&gt;negoFlags
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
op_logical_and
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_ne
id|MPT_HOST_NVRAM_INVALID
)paren
)paren
(brace
id|data
op_assign
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
suffix:semicolon
id|width
op_assign
id|data
op_amp
id|MPT_NVRAM_WIDE_DISABLE
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_assign
id|hd-&gt;ioc-&gt;spi_data.maxSyncOffset
)paren
op_eq
l_int|0
)paren
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
r_else
(brace
id|factor
op_assign
(paren
id|data
op_amp
id|MPT_NVRAM_SYNC_MASK
)paren
op_rshift
id|MPT_NVRAM_SYNC_SHIFT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|factor
op_eq
l_int|0
)paren
op_logical_or
(paren
id|factor
op_eq
id|MPT_ASYNC
)paren
)paren
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
multiline_comment|/* Set the negotiation flags */
id|negoFlags
op_assign
id|hd-&gt;ioc-&gt;spi_data.noQas
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|width
)paren
id|negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_WIDE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|offset
)paren
id|negoFlags
op_or_assign
id|MPT_TARGET_NO_NEGO_SYNC
suffix:semicolon
)brace
multiline_comment|/* limit by adapter capabilities */
id|width
op_assign
id|min
c_func
(paren
id|width
comma
id|hd-&gt;ioc-&gt;spi_data.maxBusWidth
)paren
suffix:semicolon
id|offset
op_assign
id|min
c_func
(paren
id|offset
comma
id|hd-&gt;ioc-&gt;spi_data.maxSyncOffset
)paren
suffix:semicolon
id|factor
op_assign
id|max
c_func
(paren
id|factor
comma
id|hd-&gt;ioc-&gt;spi_data.minSyncFactor
)paren
suffix:semicolon
multiline_comment|/* Check Consistency */
r_if
c_cond
(paren
id|offset
op_logical_and
(paren
id|factor
OL
id|MPT_ULTRA2
)paren
op_logical_and
op_logical_neg
id|width
)paren
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
id|dv-&gt;max.width
op_assign
id|width
suffix:semicolon
id|dv-&gt;max.offset
op_assign
id|offset
suffix:semicolon
id|dv-&gt;max.factor
op_assign
id|factor
suffix:semicolon
id|dv-&gt;max.flags
op_assign
id|negoFlags
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot; id=%d width=%d factor=%x offset=%x flags=%x&bslash;n&quot;
comma
id|id
comma
id|width
comma
id|factor
comma
id|offset
comma
id|negoFlags
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_UPDATE_MAX
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Updating with SDP0 Data: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Update tmax values with those from Device Page 0.*/
id|pPage0
op_assign
(paren
id|SCSIDevicePage0_t
op_star
)paren
id|pPage
suffix:semicolon
r_if
c_cond
(paren
id|pPage0
)paren
(brace
id|val
op_assign
id|cpu_to_le32
c_func
(paren
id|pPage0-&gt;NegotiatedParameters
)paren
suffix:semicolon
id|dv-&gt;max.width
op_assign
id|val
op_amp
id|MPI_SCSIDEVPAGE0_NP_WIDE
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|dv-&gt;max.offset
op_assign
(paren
id|val
op_amp
id|MPI_SCSIDEVPAGE0_NP_NEG_SYNC_OFFSET_MASK
)paren
op_rshift
l_int|16
suffix:semicolon
id|dv-&gt;max.factor
op_assign
(paren
id|val
op_amp
id|MPI_SCSIDEVPAGE0_NP_NEG_SYNC_PERIOD_MASK
)paren
op_rshift
l_int|8
suffix:semicolon
)brace
id|dv-&gt;now.width
op_assign
id|dv-&gt;max.width
suffix:semicolon
id|dv-&gt;now.offset
op_assign
id|dv-&gt;max.offset
suffix:semicolon
id|dv-&gt;now.factor
op_assign
id|dv-&gt;max.factor
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;id=%d width=%d factor=%x offset=%x flags=%x&bslash;n&quot;
comma
id|id
comma
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.flags
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_SET_MAX
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Setting Max: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Set current to the max values. Update the config page.*/
id|dv-&gt;now.width
op_assign
id|dv-&gt;max.width
suffix:semicolon
id|dv-&gt;now.offset
op_assign
id|dv-&gt;max.offset
suffix:semicolon
id|dv-&gt;now.factor
op_assign
id|dv-&gt;max.factor
suffix:semicolon
id|dv-&gt;now.flags
op_assign
id|dv-&gt;max.flags
suffix:semicolon
id|pPage1
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
id|pPage
suffix:semicolon
r_if
c_cond
(paren
id|pPage1
)paren
(brace
id|mptscsih_setDevicePage1Flags
(paren
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
op_amp
id|val
comma
op_amp
id|configuration
comma
id|dv-&gt;now.flags
)paren
suffix:semicolon
id|dnegoprintk
c_func
(paren
(paren
l_string|&quot;Setting Max: id=%d width=%d factor=%x offset=%x negoFlags=%x request=%x config=%x&bslash;n&quot;
comma
id|id
comma
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.flags
comma
id|val
comma
id|configuration
)paren
)paren
suffix:semicolon
id|pPage1-&gt;RequestedParameters
op_assign
id|le32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
id|pPage1-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pPage1-&gt;Configuration
op_assign
id|le32_to_cpu
c_func
(paren
id|configuration
)paren
suffix:semicolon
)brace
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;id=%d width=%d factor=%x offset=%x flags=%x request=%x configuration=%x&bslash;n&quot;
comma
id|id
comma
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.flags
comma
id|val
comma
id|configuration
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_SET_MIN
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Setting Min: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Set page to asynchronous and narrow&n;&t;&t; * Do not update now, breaks fallback routine. */
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|negoFlags
op_assign
id|dv-&gt;max.flags
suffix:semicolon
id|pPage1
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
id|pPage
suffix:semicolon
r_if
c_cond
(paren
id|pPage1
)paren
(brace
id|mptscsih_setDevicePage1Flags
(paren
id|width
comma
id|factor
comma
id|offset
comma
op_amp
id|val
comma
op_amp
id|configuration
comma
id|negoFlags
)paren
suffix:semicolon
id|dnegoprintk
c_func
(paren
(paren
l_string|&quot;Setting Min: id=%d width=%d factor=%x offset=%x negoFlags=%x request=%x config=%x&bslash;n&quot;
comma
id|id
comma
id|width
comma
id|factor
comma
id|offset
comma
id|negoFlags
comma
id|val
comma
id|configuration
)paren
)paren
suffix:semicolon
id|pPage1-&gt;RequestedParameters
op_assign
id|le32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
id|pPage1-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pPage1-&gt;Configuration
op_assign
id|le32_to_cpu
c_func
(paren
id|configuration
)paren
suffix:semicolon
)brace
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;id=%d width=%d factor=%x offset=%x request=%x config=%x negoFlags=%x&bslash;n&quot;
comma
id|id
comma
id|width
comma
id|factor
comma
id|offset
comma
id|val
comma
id|configuration
comma
id|negoFlags
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_FALLBACK
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Fallback: Start: offset %d, factor %x, width %d &bslash;n&quot;
comma
id|hd-&gt;ioc-&gt;name
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.width
)paren
)paren
suffix:semicolon
id|width
op_assign
id|dv-&gt;now.width
suffix:semicolon
id|offset
op_assign
id|dv-&gt;now.offset
suffix:semicolon
id|factor
op_assign
id|dv-&gt;now.factor
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
)paren
op_logical_and
(paren
id|dv-&gt;max.width
)paren
)paren
(brace
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA160
)paren
id|factor
op_assign
id|MPT_ULTRA160
suffix:semicolon
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA2
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
id|width
op_assign
id|MPT_WIDE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|factor
op_eq
id|MPT_ULTRA2
)paren
op_logical_and
id|width
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA2
suffix:semicolon
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA
)paren
(brace
id|factor
op_assign
id|MPT_ULTRA
suffix:semicolon
id|width
op_assign
id|MPT_WIDE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|factor
op_eq
id|MPT_ULTRA
)paren
op_logical_and
id|width
)paren
(brace
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_FAST
)paren
(brace
id|factor
op_assign
id|MPT_FAST
suffix:semicolon
id|width
op_assign
id|MPT_WIDE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|factor
op_eq
id|MPT_FAST
)paren
op_logical_and
id|width
)paren
(brace
id|factor
op_assign
id|MPT_FAST
suffix:semicolon
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_SCSI
)paren
(brace
id|factor
op_assign
id|MPT_SCSI
suffix:semicolon
id|width
op_assign
id|MPT_WIDE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|factor
op_eq
id|MPT_SCSI
)paren
op_logical_and
id|width
)paren
(brace
id|factor
op_assign
id|MPT_SCSI
suffix:semicolon
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
)brace
r_else
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|offset
)paren
(brace
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
r_if
c_cond
(paren
id|factor
OL
id|MPT_ULTRA
)paren
id|factor
op_assign
id|MPT_ULTRA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_FAST
)paren
id|factor
op_assign
id|MPT_FAST
suffix:semicolon
r_else
r_if
c_cond
(paren
id|factor
OL
id|MPT_SCSI
)paren
id|factor
op_assign
id|MPT_SCSI
suffix:semicolon
r_else
(brace
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|width
op_assign
id|MPT_NARROW
suffix:semicolon
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
)brace
id|dv-&gt;max.flags
op_or_assign
id|MPT_TARGET_NO_NEGO_QAS
suffix:semicolon
id|dv-&gt;max.flags
op_and_assign
op_complement
id|MPT_TAPE_NEGO_IDP
suffix:semicolon
id|dv-&gt;now.width
op_assign
id|width
suffix:semicolon
id|dv-&gt;now.offset
op_assign
id|offset
suffix:semicolon
id|dv-&gt;now.factor
op_assign
id|factor
suffix:semicolon
id|dv-&gt;now.flags
op_assign
id|dv-&gt;max.flags
suffix:semicolon
id|pPage1
op_assign
(paren
id|SCSIDevicePage1_t
op_star
)paren
id|pPage
suffix:semicolon
r_if
c_cond
(paren
id|pPage1
)paren
(brace
id|mptscsih_setDevicePage1Flags
(paren
id|width
comma
id|factor
comma
id|offset
comma
op_amp
id|val
comma
op_amp
id|configuration
comma
id|dv-&gt;now.flags
)paren
suffix:semicolon
id|dnegoprintk
c_func
(paren
(paren
l_string|&quot;Finish: id=%d width=%d offset=%d factor=%x flags=%x request=%x config=%x&bslash;n&quot;
comma
id|id
comma
id|width
comma
id|offset
comma
id|factor
comma
id|dv-&gt;now.flags
comma
id|val
comma
id|configuration
)paren
)paren
suffix:semicolon
id|pPage1-&gt;RequestedParameters
op_assign
id|le32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
id|pPage1-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pPage1-&gt;Configuration
op_assign
id|le32_to_cpu
c_func
(paren
id|configuration
)paren
suffix:semicolon
)brace
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;Finish: id=%d offset=%d factor=%x width=%d request=%x config=%x&bslash;n&quot;
comma
id|id
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.width
comma
id|val
comma
id|configuration
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPT_SAVE
suffix:colon
id|ddvprintk
c_func
(paren
(paren
id|MYIOC_s_NOTE_FMT
l_string|&quot;Saving to Target structure: &quot;
comma
id|hd-&gt;ioc-&gt;name
)paren
)paren
suffix:semicolon
id|ddvprintk
c_func
(paren
(paren
l_string|&quot;id=%d width=%x factor=%x offset=%d flags=%x&bslash;n&quot;
comma
id|id
comma
id|dv-&gt;now.width
comma
id|dv-&gt;now.factor
comma
id|dv-&gt;now.offset
comma
id|dv-&gt;now.flags
)paren
)paren
suffix:semicolon
multiline_comment|/* Save these values to target structures&n;&t;&t; * or overwrite nvram (phys disks only).&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|hd-&gt;Targets
)paren
op_logical_and
(paren
(paren
id|pTarget
op_assign
id|hd-&gt;Targets
(braket
(paren
r_int
)paren
id|id
)braket
)paren
op_ne
l_int|NULL
)paren
op_logical_and
op_logical_neg
id|pTarget-&gt;raidVolume
)paren
(brace
id|pTarget-&gt;maxWidth
op_assign
id|dv-&gt;now.width
suffix:semicolon
id|pTarget-&gt;maxOffset
op_assign
id|dv-&gt;now.offset
suffix:semicolon
id|pTarget-&gt;minSyncFactor
op_assign
id|dv-&gt;now.factor
suffix:semicolon
id|pTarget-&gt;negoFlags
op_assign
id|dv-&gt;now.flags
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Preserv all flags, use&n;&t;&t;&t; * read-modify-write algorithm&n;&t;&t;&t; */
r_if
c_cond
(paren
id|hd-&gt;ioc-&gt;spi_data.nvram
)paren
(brace
id|data
op_assign
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dv-&gt;now.width
)paren
id|data
op_and_assign
op_complement
id|MPT_NVRAM_WIDE_DISABLE
suffix:semicolon
r_else
id|data
op_or_assign
id|MPT_NVRAM_WIDE_DISABLE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dv-&gt;now.offset
)paren
id|factor
op_assign
id|MPT_ASYNC
suffix:semicolon
id|data
op_and_assign
op_complement
id|MPT_NVRAM_SYNC_MASK
suffix:semicolon
id|data
op_or_assign
(paren
id|dv-&gt;now.factor
op_lshift
id|MPT_NVRAM_SYNC_SHIFT
)paren
op_amp
id|MPT_NVRAM_SYNC_MASK
suffix:semicolon
id|hd-&gt;ioc-&gt;spi_data.nvram
(braket
id|id
)braket
op_assign
id|data
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
multiline_comment|/*&t;mptscsih_fillbuf - fill a buffer with a special data pattern&n; *&t;&t;cleanup. For bus scan only.&n; *&n; *&t;@buffer: Pointer to data buffer to be filled.&n; *&t;@size: Number of bytes to fill&n; *&t;@index: Pattern index&n; *&t;@width: bus width, 0 (8 bits) or 1 (16 bits)&n; */
r_static
r_void
DECL|function|mptscsih_fillbuf
id|mptscsih_fillbuf
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|size
comma
r_int
id|index
comma
r_int
id|width
)paren
(brace
r_char
op_star
id|ptr
op_assign
id|buffer
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_char
id|byte
suffix:semicolon
r_int
id|val
suffix:semicolon
r_switch
c_cond
(paren
id|index
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|width
)paren
(brace
multiline_comment|/* Pattern:  0000 FFFF 0000 FFFF&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x02
)paren
op_star
id|ptr
op_assign
l_int|0xFF
suffix:semicolon
r_else
op_star
id|ptr
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Pattern:  00 FF 00 FF&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x01
)paren
op_star
id|ptr
op_assign
l_int|0xFF
suffix:semicolon
r_else
op_star
id|ptr
op_assign
l_int|0x00
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|width
)paren
(brace
multiline_comment|/* Pattern:  5555 AAAA 5555 AAAA 5555&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x02
)paren
op_star
id|ptr
op_assign
l_int|0xAA
suffix:semicolon
r_else
op_star
id|ptr
op_assign
l_int|0x55
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Pattern:  55 AA 55 AA 55&n;&t;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x01
)paren
op_star
id|ptr
op_assign
l_int|0xAA
suffix:semicolon
r_else
op_star
id|ptr
op_assign
l_int|0x55
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Pattern:  00 01 02 03 04 05&n;&t;&t; * ... FE FF 00 01..&n;&t;&t; */
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
op_star
id|ptr
op_assign
(paren
r_char
)paren
id|ii
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
id|width
)paren
(brace
multiline_comment|/* Wide Pattern:  FFFE 0001 FFFD 0002&n;&t;&t;&t; * ...  4000 DFFF 8000 EFFF&n;&t;&t;&t; */
id|byte
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
op_div
l_int|2
suffix:semicolon
id|ii
op_increment
)paren
(brace
multiline_comment|/* Create the base pattern&n;&t;&t;&t;&t; */
id|val
op_assign
(paren
l_int|1
op_lshift
id|byte
)paren
suffix:semicolon
multiline_comment|/* every 64 (0x40) bytes flip the pattern&n;&t;&t;&t;&t; * since we fill 2 bytes / iteration,&n;&t;&t;&t;&t; * test for ii = 0x20&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x20
)paren
id|val
op_assign
op_complement
(paren
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x01
)paren
(brace
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
(paren
id|val
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
id|val
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|byte
op_increment
suffix:semicolon
id|byte
op_and_assign
l_int|0x0F
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
op_complement
id|val
suffix:semicolon
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
(paren
id|val
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
id|val
op_amp
l_int|0xFF
)paren
suffix:semicolon
)brace
id|ptr
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Narrow Pattern:  FE 01 FD 02 FB 04&n;&t;&t;&t; * .. 7F 80 01 FE 02 FD ...  80 7F&n;&t;&t;&t; */
id|byte
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|ii
OL
id|size
suffix:semicolon
id|ii
op_increment
comma
id|ptr
op_increment
)paren
(brace
multiline_comment|/* Base pattern - first 32 bytes&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x01
)paren
(brace
op_star
id|ptr
op_assign
(paren
l_int|1
op_lshift
id|byte
)paren
suffix:semicolon
id|byte
op_increment
suffix:semicolon
id|byte
op_and_assign
l_int|0x07
suffix:semicolon
)brace
r_else
(brace
op_star
id|ptr
op_assign
(paren
r_char
)paren
(paren
op_complement
(paren
l_int|1
op_lshift
id|byte
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Flip the pattern every 32 bytes&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ii
op_amp
l_int|0x20
)paren
op_star
id|ptr
op_assign
op_complement
(paren
op_star
id|ptr
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif /* ~MPTSCSIH_ENABLE_DOMAIN_VALIDATION */
multiline_comment|/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
DECL|variable|mptscsih_init
id|module_init
c_func
(paren
id|mptscsih_init
)paren
suffix:semicolon
DECL|variable|mptscsih_exit
id|module_exit
c_func
(paren
id|mptscsih_exit
)paren
suffix:semicolon
eof
