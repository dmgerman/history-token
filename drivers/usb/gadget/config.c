multiline_comment|/*&n; * usb/gadget/config.c -- simplify building config descriptors&n; *&n; * Copyright (C) 2003 David Brownell&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/usb_ch9.h&gt;
multiline_comment|/**&n; * usb_descriptor_fillbuf - fill buffer with descriptors&n; * @buf: Buffer to be filled&n; * @buflen: Size of buf&n; * @src: Array of descriptor pointers, terminated by null pointer.&n; *&n; * Copies descriptors into the buffer, returning the length or a&n; * negative error code if they can&squot;t all be copied.  Useful when&n; * assembling descriptors for an associated set of interfaces used&n; * as part of configuring a composite device; or in other cases where&n; * sets of descriptors need to be marshaled.&n; */
r_int
DECL|function|usb_descriptor_fillbuf
id|usb_descriptor_fillbuf
c_func
(paren
r_void
op_star
id|buf
comma
r_int
id|buflen
comma
r_const
r_struct
id|usb_descriptor_header
op_star
op_star
id|src
)paren
(brace
id|u8
op_star
id|dest
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|src
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* fill buffer from src[] until null descriptor ptr */
r_for
c_loop
(paren
suffix:semicolon
l_int|0
op_ne
op_star
id|src
suffix:semicolon
id|src
op_increment
)paren
(brace
r_int
id|len
op_assign
(paren
op_star
id|src
)paren
op_member_access_from_pointer
id|bLength
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|buflen
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
id|dest
comma
op_star
id|src
comma
id|len
)paren
suffix:semicolon
id|buflen
op_sub_assign
id|len
suffix:semicolon
id|dest
op_add_assign
id|len
suffix:semicolon
)brace
r_return
id|dest
op_minus
(paren
id|u8
op_star
)paren
id|buf
suffix:semicolon
)brace
multiline_comment|/**&n; * usb_gadget_config_buf - builts a complete configuration descriptor&n; * @config: Header for the descriptor, including characteristics such&n; *&t;as power requirements and number of interfaces.&n; * @desc: Null-terminated vector of pointers to the descriptors (interface,&n; *&t;endpoint, etc) defining all functions in this device configuration.&n; * @buf: Buffer for the resulting configuration descriptor.&n; * @length: Length of buffer.  If this is not big enough to hold the&n; *&t;entire configuration descriptor, an error code will be returned.&n; *&n; * This copies descriptors into the response buffer, building a descriptor&n; * for that configuration.  It returns the buffer length or a negative&n; * status code.  The config.wTotalLength field is set to match the length&n; * of the result, but other descriptor fields (including power usage and&n; * interface count) must be set by the caller.&n; *&n; * Gadget drivers could use this when constructing a config descriptor&n; * in response to USB_REQ_GET_DESCRIPTOR.  They will need to patch the&n; * resulting bDescriptorType value if USB_DT_OTHER_SPEED_CONFIG is needed.&n; */
DECL|function|usb_gadget_config_buf
r_int
id|usb_gadget_config_buf
c_func
(paren
r_const
r_struct
id|usb_config_descriptor
op_star
id|config
comma
r_void
op_star
id|buf
comma
r_int
id|length
comma
r_const
r_struct
id|usb_descriptor_header
op_star
op_star
id|desc
)paren
(brace
r_struct
id|usb_config_descriptor
op_star
id|cp
op_assign
id|buf
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* config descriptor first */
r_if
c_cond
(paren
id|length
OL
id|USB_DT_CONFIG_SIZE
op_logical_or
op_logical_neg
id|desc
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|cp
op_assign
op_star
id|config
suffix:semicolon
multiline_comment|/* then interface/endpoint/class/vendor/... */
id|len
op_assign
id|usb_descriptor_fillbuf
c_func
(paren
id|USB_DT_CONFIG_SIZE
op_plus
(paren
id|u8
op_star
)paren
id|buf
comma
id|length
op_minus
id|USB_DT_CONFIG_SIZE
comma
id|desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_return
id|len
suffix:semicolon
id|len
op_add_assign
id|USB_DT_CONFIG_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0xffff
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* patch up the config descriptor */
id|cp-&gt;bLength
op_assign
id|USB_DT_CONFIG_SIZE
suffix:semicolon
id|cp-&gt;bDescriptorType
op_assign
id|USB_DT_CONFIG
suffix:semicolon
id|cp-&gt;wTotalLength
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
id|cp-&gt;bmAttributes
op_or_assign
id|USB_CONFIG_ATT_ONE
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
eof
