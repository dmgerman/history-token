multiline_comment|/*&n; * Toshiba TC86C001 (&quot;Goku-S&quot;) USB Device Controller driver&n; *&n; * Copyright (C) 2000-2002 Lineo&n; *      by Stuart Lynne, Tom Rushworth, and Bruce Balden&n; * Copyright (C) 2002 Toshiba Corporation&n; * Copyright (C) 2003 MontaVista Software (source@mvista.com)&n; *&n; * This file is licensed under the terms of the GNU General Public&n; * License version 2.  This program is licensed &quot;as is&quot; without any&n; * warranty of any kind, whether express or implied.&n; */
multiline_comment|/*&n; * This device has ep0 and three semi-configurable bulk/interrupt endpoints.&n; *&n; *  - Endpoint numbering is fixed: ep{1,2,3}-bulk&n; *  - Gadget drivers can choose ep maxpacket (8/16/32/64)&n; *  - Gadget drivers can choose direction (IN, OUT)&n; *  - DMA works with ep1 (OUT transfers) and ep2 (IN transfers).&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
singleline_comment|// #define&t;VERBOSE&t;&t;/* extra debug messages (success too) */
singleline_comment|// #define&t;USB_TRACE&t;/* packet-level success messages */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/usb_ch9.h&gt;
macro_line|#include &lt;linux/usb_gadget.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &quot;goku_udc.h&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define&t;DRIVER_DESC&t;&t;&quot;TC86C001 USB Device Controller&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define&t;DRIVER_VERSION&t;&t;&quot;30-Oct 2003&quot;
DECL|macro|DMA_ADDR_INVALID
mdefine_line|#define&t;DMA_ADDR_INVALID&t;(~(dma_addr_t)0)
DECL|variable|driver_name
r_static
r_const
r_char
id|driver_name
(braket
)braket
op_assign
l_string|&quot;goku_udc&quot;
suffix:semicolon
DECL|variable|driver_desc
r_static
r_const
r_char
id|driver_desc
(braket
)braket
op_assign
id|DRIVER_DESC
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;source@mvista.com&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * IN dma behaves ok under testing, though the IN-dma abort paths don&squot;t&n; * seem to behave quite as expected.  Used by default.&n; *&n; * OUT dma documents design problems handling the common &quot;short packet&quot;&n; * transfer termination policy; it couldn&squot;t enabled by default, even&n; * if the OUT-dma abort problems had a resolution.&n; */
DECL|variable|use_dma
r_static
r_int
id|use_dma
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
singleline_comment|//#include &lt;linux/moduleparam.h&gt;
multiline_comment|/* &quot;modprobe goku_udc use_dma=1&quot; etc&n; *&t;0 to disable dma&n; *&t;1 to use IN dma only (normal operation)&n; *&t;2 to use IN and OUT dma&n; */
id|module_param
c_func
(paren
id|use_dma
comma
id|uint
comma
id|S_IRUGO
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
id|nuke
c_func
(paren
r_struct
id|goku_ep
op_star
comma
r_int
id|status
)paren
suffix:semicolon
r_static
r_inline
r_void
DECL|function|command
id|command
c_func
(paren
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
comma
r_int
id|command
comma
r_int
id|epnum
)paren
(brace
id|writel
c_func
(paren
id|COMMAND_EP
c_func
(paren
id|epnum
)paren
op_or
id|command
comma
op_amp
id|regs-&gt;Command
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|goku_ep_enable
id|goku_ep_enable
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|desc
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
suffix:semicolon
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
id|u32
id|mode
suffix:semicolon
id|u16
id|max
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|desc
op_logical_or
id|ep-&gt;desc
op_logical_or
id|desc-&gt;bDescriptorType
op_ne
id|USB_DT_ENDPOINT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_eq
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;driver
op_logical_or
id|dev-&gt;gadget.speed
op_eq
id|USB_SPEED_UNKNOWN
)paren
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;num
op_ne
(paren
id|desc-&gt;bEndpointAddress
op_amp
l_int|0x0f
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|desc-&gt;bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
(brace
r_case
id|USB_ENDPOINT_XFER_BULK
suffix:colon
r_case
id|USB_ENDPOINT_XFER_INT
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|readl
c_func
(paren
id|ep-&gt;reg_status
)paren
op_amp
id|EPxSTATUS_EP_MASK
)paren
op_ne
id|EPxSTATUS_EP_INVALID
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* enabling the no-toggle interrupt mode would need an api hook */
id|mode
op_assign
l_int|0
suffix:semicolon
id|max
op_assign
id|le16_to_cpu
c_func
(paren
id|get_unaligned
c_func
(paren
op_amp
id|desc-&gt;wMaxPacketSize
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|max
)paren
(brace
r_case
l_int|64
suffix:colon
id|mode
op_increment
suffix:semicolon
r_case
l_int|32
suffix:colon
id|mode
op_increment
suffix:semicolon
r_case
l_int|16
suffix:colon
id|mode
op_increment
suffix:semicolon
r_case
l_int|8
suffix:colon
id|mode
op_lshift_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|mode
op_or_assign
l_int|2
op_lshift
l_int|1
suffix:semicolon
multiline_comment|/* bulk, or intr-with-toggle */
multiline_comment|/* ep1/ep2 dma direction is chosen early; it works in the other&n;&t; * direction, with pio.  be cautious with out-dma.&n;&t; */
id|ep-&gt;is_in
op_assign
(paren
id|USB_DIR_IN
op_amp
id|desc-&gt;bEndpointAddress
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;is_in
)paren
(brace
id|mode
op_or_assign
l_int|1
suffix:semicolon
id|ep-&gt;dma
op_assign
(paren
id|use_dma
op_ne
l_int|0
)paren
op_logical_and
(paren
id|ep-&gt;num
op_eq
id|UDC_MSTRD_ENDPOINT
)paren
suffix:semicolon
)brace
r_else
(brace
id|ep-&gt;dma
op_assign
(paren
id|use_dma
op_eq
l_int|2
)paren
op_logical_and
(paren
id|ep-&gt;num
op_eq
id|UDC_MSTWR_ENDPOINT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;dma
)paren
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;%s out-dma hides short packets&bslash;n&quot;
comma
id|ep-&gt;ep.name
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* ep1 and ep2 can do double buffering and/or dma */
r_if
c_cond
(paren
id|ep-&gt;num
OL
l_int|3
)paren
(brace
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|ep-&gt;dev-&gt;regs
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
multiline_comment|/* double buffer except (for now) with pio in */
id|tmp
op_assign
(paren
(paren
id|ep-&gt;dma
op_logical_or
op_logical_neg
id|ep-&gt;is_in
)paren
ques
c_cond
l_int|0x10
multiline_comment|/* double buffered */
suffix:colon
l_int|0x11
multiline_comment|/* single buffer */
)paren
op_lshift
id|ep-&gt;num
suffix:semicolon
id|tmp
op_or_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxSingle
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
op_amp
id|regs-&gt;EPxSingle
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|ep-&gt;dma
ques
c_cond
l_int|0x10
multiline_comment|/*dma*/
suffix:colon
l_int|0x11
multiline_comment|/*pio*/
)paren
op_lshift
id|ep-&gt;num
suffix:semicolon
id|tmp
op_or_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxBCS
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
op_amp
id|regs-&gt;EPxBCS
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|mode
comma
id|ep-&gt;reg_mode
)paren
suffix:semicolon
id|command
c_func
(paren
id|ep-&gt;dev-&gt;regs
comma
id|COMMAND_RESET
comma
id|ep-&gt;num
)paren
suffix:semicolon
id|ep-&gt;ep.maxpacket
op_assign
id|max
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;desc
op_assign
id|desc
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;enable %s %s %s maxpacket %u&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|ep-&gt;is_in
ques
c_cond
l_string|&quot;IN&quot;
suffix:colon
l_string|&quot;OUT&quot;
comma
id|ep-&gt;dma
ques
c_cond
l_string|&quot;dma&quot;
suffix:colon
l_string|&quot;pio&quot;
comma
id|max
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ep_reset
r_static
r_void
id|ep_reset
c_func
(paren
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
comma
r_struct
id|goku_ep
op_star
id|ep
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|regs
)paren
(brace
id|command
c_func
(paren
id|regs
comma
id|COMMAND_INVALID
comma
id|ep-&gt;num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;num
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;num
op_eq
id|UDC_MSTWR_ENDPOINT
)paren
id|dev-&gt;int_enable
op_and_assign
op_complement
(paren
id|INT_MSTWREND
op_or
id|INT_MSTWRTMOUT
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ep-&gt;num
op_eq
id|UDC_MSTRD_ENDPOINT
)paren
id|dev-&gt;int_enable
op_and_assign
op_complement
id|INT_MSTRDEND
suffix:semicolon
id|dev-&gt;int_enable
op_and_assign
op_complement
id|INT_EPxDATASET
(paren
id|ep-&gt;num
)paren
suffix:semicolon
)brace
r_else
id|dev-&gt;int_enable
op_and_assign
op_complement
id|INT_EP0
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;int_enable
comma
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;num
OL
l_int|3
)paren
(brace
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|r
op_assign
id|ep-&gt;dev-&gt;regs
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
op_amp
id|r-&gt;EPxSingle
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
l_int|0x11
op_lshift
id|ep-&gt;num
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
op_amp
id|r-&gt;EPxSingle
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
op_amp
id|r-&gt;EPxBCS
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
l_int|0x11
op_lshift
id|ep-&gt;num
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
op_amp
id|r-&gt;EPxBCS
)paren
suffix:semicolon
)brace
multiline_comment|/* reset dma in case we&squot;re still using it */
r_if
c_cond
(paren
id|ep-&gt;dma
)paren
(brace
id|u32
id|master
suffix:semicolon
id|master
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
op_amp
id|MST_RW_BITS
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;num
op_eq
id|UDC_MSTWR_ENDPOINT
)paren
(brace
id|master
op_and_assign
op_complement
id|MST_W_BITS
suffix:semicolon
id|master
op_or_assign
id|MST_WR_RESET
suffix:semicolon
)brace
r_else
(brace
id|master
op_and_assign
op_complement
id|MST_R_BITS
suffix:semicolon
id|master
op_or_assign
id|MST_RD_RESET
suffix:semicolon
)brace
id|writel
c_func
(paren
id|master
comma
op_amp
id|regs-&gt;dma_master
)paren
suffix:semicolon
)brace
)brace
id|ep-&gt;ep.maxpacket
op_assign
id|MAX_FIFO_SIZE
suffix:semicolon
id|ep-&gt;desc
op_assign
l_int|NULL
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|ep-&gt;irqs
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;dma
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|goku_ep_disable
r_static
r_int
id|goku_ep_disable
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
)paren
(brace
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
r_struct
id|goku_udc
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|ep-&gt;desc
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ep0state
op_eq
id|EP0_SUSPEND
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;disable %s&bslash;n&quot;
comma
id|_ep-&gt;name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|nuke
c_func
(paren
id|ep
comma
op_minus
id|ESHUTDOWN
)paren
suffix:semicolon
id|ep_reset
c_func
(paren
id|dev-&gt;regs
comma
id|ep
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_struct
id|usb_request
op_star
DECL|function|goku_alloc_request
id|goku_alloc_request
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
)paren
r_return
l_int|NULL
suffix:semicolon
id|req
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|req
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|req
comma
l_int|0
comma
r_sizeof
op_star
id|req
)paren
suffix:semicolon
id|req-&gt;req.dma
op_assign
id|DMA_ADDR_INVALID
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|req-&gt;queue
)paren
suffix:semicolon
r_return
op_amp
id|req-&gt;req
suffix:semicolon
)brace
r_static
r_void
DECL|function|goku_free_request
id|goku_free_request
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_struct
id|usb_request
op_star
id|_req
)paren
(brace
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|_req
)paren
r_return
suffix:semicolon
id|req
op_assign
id|container_of
c_func
(paren
id|_req
comma
r_struct
id|goku_request
comma
id|req
)paren
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|req-&gt;queue
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|USE_KMALLOC
macro_line|#undef USE_KMALLOC
multiline_comment|/* many common platforms have dma-coherent caches, which means that it&squot;s&n; * safe to use kmalloc() memory for all i/o buffers without using any&n; * cache flushing calls.  (unless you&squot;re trying to share cache lines&n; * between dma and non-dma activities, which is a slow idea in any case.)&n; *&n; * other platforms need more care, with 2.6 having a moderately general&n; * solution except for the common &quot;buffer is smaller than a page&quot; case.&n; */
macro_line|#if&t;defined(CONFIG_X86)
DECL|macro|USE_KMALLOC
mdefine_line|#define USE_KMALLOC
macro_line|#elif&t;defined(CONFIG_MIPS) &amp;&amp; !defined(CONFIG_NONCOHERENT_IO)
DECL|macro|USE_KMALLOC
mdefine_line|#define USE_KMALLOC
macro_line|#elif&t;defined(CONFIG_PPC) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)
DECL|macro|USE_KMALLOC
mdefine_line|#define USE_KMALLOC
macro_line|#endif
multiline_comment|/* allocating buffers this way eliminates dma mapping overhead, which&n; * on some platforms will mean eliminating a per-io buffer copy.  with&n; * some kinds of system caches, further tweaks may still be needed.&n; */
r_static
r_void
op_star
DECL|function|goku_alloc_buffer
id|goku_alloc_buffer
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_int
id|bytes
comma
id|dma_addr_t
op_star
id|dma
comma
r_int
id|gfp_flags
)paren
(brace
r_void
op_star
id|retval
suffix:semicolon
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
)paren
r_return
l_int|NULL
suffix:semicolon
op_star
id|dma
op_assign
id|DMA_ADDR_INVALID
suffix:semicolon
macro_line|#if&t;defined(USE_KMALLOC)
id|retval
op_assign
id|kmalloc
c_func
(paren
id|bytes
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
op_star
id|dma
op_assign
id|virt_to_phys
c_func
(paren
id|retval
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|ep-&gt;dma
)paren
(brace
multiline_comment|/* the main problem with this call is that it wastes memory&n;&t;&t; * on typical 1/N page allocations: it allocates 1-N pages.&n;&t;&t; */
macro_line|#warning Using dma_alloc_coherent even with buffers smaller than a page.
id|retval
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;pdev-&gt;dev
comma
id|bytes
comma
id|dma
comma
id|gfp_flags
)paren
suffix:semicolon
)brace
r_else
id|retval
op_assign
id|kmalloc
c_func
(paren
id|bytes
comma
id|gfp_flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
r_static
r_void
DECL|function|goku_free_buffer
id|goku_free_buffer
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_void
op_star
id|buf
comma
id|dma_addr_t
id|dma
comma
r_int
id|bytes
)paren
(brace
multiline_comment|/* free memory into the right allocator */
macro_line|#ifndef&t;USE_KMALLOC
r_if
c_cond
(paren
id|dma
op_ne
id|DMA_ADDR_INVALID
)paren
(brace
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
)paren
r_return
suffix:semicolon
id|dma_free_coherent
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;pdev-&gt;dev
comma
id|bytes
comma
id|buf
comma
id|dma
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
id|kfree
(paren
id|buf
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
DECL|function|done
id|done
c_func
(paren
r_struct
id|goku_ep
op_star
id|ep
comma
r_struct
id|goku_request
op_star
id|req
comma
r_int
id|status
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
suffix:semicolon
r_int
id|stopped
op_assign
id|ep-&gt;stopped
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|req-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req-&gt;req.status
op_eq
op_minus
id|EINPROGRESS
)paren
)paren
id|req-&gt;req.status
op_assign
id|status
suffix:semicolon
r_else
id|status
op_assign
id|req-&gt;req.status
suffix:semicolon
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;mapped
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|dev-&gt;pdev
comma
id|req-&gt;req.dma
comma
id|req-&gt;req.length
comma
id|ep-&gt;is_in
ques
c_cond
id|PCI_DMA_TODEVICE
suffix:colon
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|req-&gt;req.dma
op_assign
id|DMA_ADDR_INVALID
suffix:semicolon
id|req-&gt;mapped
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef USB_TRACE
r_if
c_cond
(paren
id|status
op_logical_and
id|status
op_ne
op_minus
id|ESHUTDOWN
)paren
macro_line|#endif
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;complete %s req %p stat %d len %u/%u&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
op_amp
id|req-&gt;req
comma
id|status
comma
id|req-&gt;req.actual
comma
id|req-&gt;req.length
)paren
suffix:semicolon
multiline_comment|/* don&squot;t modify queue heads during completion callback */
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|req-&gt;req
dot
id|complete
c_func
(paren
op_amp
id|ep-&gt;ep
comma
op_amp
id|req-&gt;req
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|ep-&gt;stopped
op_assign
id|stopped
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_inline
r_int
DECL|function|write_packet
id|write_packet
c_func
(paren
id|u32
id|__iomem
op_star
id|fifo
comma
id|u8
op_star
id|buf
comma
r_struct
id|goku_request
op_star
id|req
comma
r_int
id|max
)paren
(brace
r_int
id|length
comma
id|count
suffix:semicolon
id|length
op_assign
id|min
c_func
(paren
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
comma
id|max
)paren
suffix:semicolon
id|req-&gt;req.actual
op_add_assign
id|length
suffix:semicolon
id|count
op_assign
id|length
suffix:semicolon
r_while
c_loop
(paren
id|likely
c_func
(paren
id|count
op_decrement
)paren
)paren
id|writel
c_func
(paren
op_star
id|buf
op_increment
comma
id|fifo
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
singleline_comment|// return:  0 = still running, 1 = completed, negative = errno
DECL|function|write_fifo
r_static
r_int
id|write_fifo
c_func
(paren
r_struct
id|goku_ep
op_star
id|ep
comma
r_struct
id|goku_request
op_star
id|req
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|u8
op_star
id|buf
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|is_last
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
op_amp
id|dev-&gt;regs-&gt;DataSet
)paren
suffix:semicolon
id|buf
op_assign
id|req-&gt;req.buf
op_plus
id|req-&gt;req.actual
suffix:semicolon
id|prefetch
c_func
(paren
id|buf
)paren
suffix:semicolon
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ep-&gt;num
op_eq
l_int|0
op_logical_and
id|dev-&gt;ep0state
op_ne
id|EP0_IN
)paren
)paren
r_return
op_minus
id|EL2HLT
suffix:semicolon
multiline_comment|/* NOTE:  just single-buffered PIO-IN for now.  */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
(paren
id|tmp
op_amp
id|DATASET_A
c_func
(paren
id|ep-&gt;num
)paren
)paren
op_ne
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* clear our &quot;packet available&quot; irq */
r_if
c_cond
(paren
id|ep-&gt;num
op_ne
l_int|0
)paren
id|writel
c_func
(paren
op_complement
id|INT_EPxDATASET
c_func
(paren
id|ep-&gt;num
)paren
comma
op_amp
id|dev-&gt;regs-&gt;int_status
)paren
suffix:semicolon
id|count
op_assign
id|write_packet
c_func
(paren
id|ep-&gt;reg_fifo
comma
id|buf
comma
id|req
comma
id|ep-&gt;ep.maxpacket
)paren
suffix:semicolon
multiline_comment|/* last packet often short (sometimes a zlp, especially on ep0) */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|count
op_ne
id|ep-&gt;ep.maxpacket
)paren
)paren
(brace
id|writel
c_func
(paren
op_complement
(paren
l_int|1
op_lshift
id|ep-&gt;num
)paren
comma
op_amp
id|dev-&gt;regs-&gt;EOP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;num
op_eq
l_int|0
)paren
(brace
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|stopped
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_STATUS
suffix:semicolon
)brace
id|is_last
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req-&gt;req.length
op_ne
id|req-&gt;req.actual
)paren
op_logical_or
id|req-&gt;req.zero
)paren
id|is_last
op_assign
l_int|0
suffix:semicolon
r_else
id|is_last
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#if 0&t;&t;/* printk seemed to trash is_last...*/
singleline_comment|//#ifdef USB_TRACE
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;wrote %s %u bytes%s IN %u left %p&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|count
comma
id|is_last
ques
c_cond
l_string|&quot;/last&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
comma
id|req
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* requests complete when all IN data is in the FIFO,&n;&t; * or sometimes later, if a zlp was needed.&n;&t; */
r_if
c_cond
(paren
id|is_last
)paren
(brace
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|read_fifo
r_static
r_int
id|read_fifo
c_func
(paren
r_struct
id|goku_ep
op_star
id|ep
comma
r_struct
id|goku_request
op_star
id|req
)paren
(brace
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
suffix:semicolon
id|u32
id|size
comma
id|set
suffix:semicolon
id|u8
op_star
id|buf
suffix:semicolon
r_int
id|bufferspace
comma
id|is_short
comma
id|dbuff
suffix:semicolon
id|regs
op_assign
id|ep-&gt;dev-&gt;regs
suffix:semicolon
id|top
suffix:colon
id|buf
op_assign
id|req-&gt;req.buf
op_plus
id|req-&gt;req.actual
suffix:semicolon
id|prefetchw
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ep-&gt;num
op_eq
l_int|0
op_logical_and
id|ep-&gt;dev-&gt;ep0state
op_ne
id|EP0_OUT
)paren
)paren
r_return
op_minus
id|EL2HLT
suffix:semicolon
id|dbuff
op_assign
(paren
id|ep-&gt;num
op_eq
l_int|1
op_logical_or
id|ep-&gt;num
op_eq
l_int|2
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* ack dataset irq matching the status we&squot;ll handle */
r_if
c_cond
(paren
id|ep-&gt;num
op_ne
l_int|0
)paren
id|writel
c_func
(paren
op_complement
id|INT_EPxDATASET
c_func
(paren
id|ep-&gt;num
)paren
comma
op_amp
id|regs-&gt;int_status
)paren
suffix:semicolon
id|set
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;DataSet
)paren
op_amp
id|DATASET_AB
c_func
(paren
id|ep-&gt;num
)paren
suffix:semicolon
id|size
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxSizeLA
(braket
id|ep-&gt;num
)braket
)paren
suffix:semicolon
id|bufferspace
op_assign
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
suffix:semicolon
multiline_comment|/* usually do nothing without an OUT packet */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|ep-&gt;num
op_ne
l_int|0
op_logical_or
id|bufferspace
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|set
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* use ep1/ep2 double-buffering for OUT */
r_if
c_cond
(paren
op_logical_neg
(paren
id|size
op_amp
id|PACKET_ACTIVE
)paren
)paren
id|size
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxSizeLB
(braket
id|ep-&gt;num
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|size
op_amp
id|PACKET_ACTIVE
)paren
)paren
singleline_comment|// &quot;can&squot;t happen&quot;
r_break
suffix:semicolon
id|size
op_and_assign
id|DATASIZE
suffix:semicolon
multiline_comment|/* EPxSizeH == 0 */
multiline_comment|/* ep0out no-out-data case for set_config, etc */
)brace
r_else
id|size
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* read all bytes from this packet */
id|req-&gt;req.actual
op_add_assign
id|size
suffix:semicolon
id|is_short
op_assign
(paren
id|size
OL
id|ep-&gt;ep.maxpacket
)paren
suffix:semicolon
macro_line|#ifdef USB_TRACE
id|VDBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;read %s %u bytes%s OUT req %p %u/%u&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|size
comma
id|is_short
ques
c_cond
l_string|&quot;/S&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|req
comma
id|req-&gt;req.actual
comma
id|req-&gt;req.length
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|likely
c_func
(paren
id|size
op_decrement
op_ne
l_int|0
)paren
)paren
(brace
id|u8
id|byte
op_assign
(paren
id|u8
)paren
id|readl
c_func
(paren
id|ep-&gt;reg_fifo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|bufferspace
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* this happens when the driver&squot;s buffer&n;&t;&t;&t;&t; * is smaller than what the host sent.&n;&t;&t;&t;&t; * discard the extra data in this packet.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|req-&gt;req.status
op_ne
op_minus
id|EOVERFLOW
)paren
id|DBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;%s overflow %u&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|size
)paren
suffix:semicolon
id|req-&gt;req.status
op_assign
op_minus
id|EOVERFLOW
suffix:semicolon
)brace
r_else
(brace
op_star
id|buf
op_increment
op_assign
id|byte
suffix:semicolon
id|bufferspace
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/* completion */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|is_short
op_logical_or
id|req-&gt;req.actual
op_eq
id|req-&gt;req.length
)paren
)paren
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ep-&gt;num
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* non-control endpoints now usable? */
r_if
c_cond
(paren
id|ep-&gt;dev-&gt;req_config
)paren
id|writel
c_func
(paren
id|ep-&gt;dev-&gt;configured
ques
c_cond
id|USBSTATE_CONFIGURED
suffix:colon
l_int|0
comma
op_amp
id|regs-&gt;UsbState
)paren
suffix:semicolon
multiline_comment|/* ep0out status stage */
id|writel
c_func
(paren
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
op_amp
id|regs-&gt;EOP
)paren
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|ep-&gt;dev-&gt;ep0state
op_assign
id|EP0_STATUS
suffix:semicolon
)brace
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* empty the second buffer asap */
r_if
c_cond
(paren
id|dbuff
op_logical_and
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|goku_request
comma
id|queue
)paren
suffix:semicolon
r_goto
id|top
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|dbuff
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|pio_irq_enable
id|pio_irq_enable
c_func
(paren
r_struct
id|goku_udc
op_star
id|dev
comma
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
comma
r_int
id|epnum
)paren
(brace
id|dev-&gt;int_enable
op_or_assign
id|INT_EPxDATASET
(paren
id|epnum
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;int_enable
comma
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
multiline_comment|/* write may still be posted */
)brace
r_static
r_inline
r_void
DECL|function|pio_irq_disable
id|pio_irq_disable
c_func
(paren
r_struct
id|goku_udc
op_star
id|dev
comma
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
comma
r_int
id|epnum
)paren
(brace
id|dev-&gt;int_enable
op_and_assign
op_complement
id|INT_EPxDATASET
(paren
id|epnum
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;int_enable
comma
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
multiline_comment|/* write may still be posted */
)brace
r_static
r_inline
r_void
DECL|function|pio_advance
id|pio_advance
c_func
(paren
r_struct
id|goku_ep
op_star
id|ep
)paren
(brace
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|list_empty
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
)paren
r_return
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|goku_request
comma
id|queue
)paren
suffix:semicolon
(paren
id|ep-&gt;is_in
ques
c_cond
id|write_fifo
suffix:colon
id|read_fifo
)paren
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
singleline_comment|// return:  0 = q running, 1 = q stopped, negative = errno
DECL|function|start_dma
r_static
r_int
id|start_dma
c_func
(paren
r_struct
id|goku_ep
op_star
id|ep
comma
r_struct
id|goku_request
op_star
id|req
)paren
(brace
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|ep-&gt;dev-&gt;regs
suffix:semicolon
id|u32
id|master
suffix:semicolon
id|u32
id|start
op_assign
id|req-&gt;req.dma
suffix:semicolon
id|u32
id|end
op_assign
id|start
op_plus
id|req-&gt;req.length
op_minus
l_int|1
suffix:semicolon
id|master
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
op_amp
id|MST_RW_BITS
suffix:semicolon
multiline_comment|/* re-init the bits affecting IN dma; careful with zlps */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|ep-&gt;is_in
)paren
)paren
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|master
op_amp
id|MST_RD_ENA
)paren
)paren
(brace
id|DBG
(paren
id|ep-&gt;dev
comma
l_string|&quot;start, IN active dma %03x!!&bslash;n&quot;
comma
id|master
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;return -EL2HLT;
)brace
id|writel
c_func
(paren
id|end
comma
op_amp
id|regs-&gt;in_dma_end
)paren
suffix:semicolon
id|writel
c_func
(paren
id|start
comma
op_amp
id|regs-&gt;in_dma_start
)paren
suffix:semicolon
id|master
op_and_assign
op_complement
id|MST_R_BITS
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|req-&gt;req.length
op_eq
l_int|0
)paren
)paren
id|master
op_assign
id|MST_RD_ENA
op_or
id|MST_RD_EOPB
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|req-&gt;req.length
op_mod
id|ep-&gt;ep.maxpacket
)paren
op_ne
l_int|0
op_logical_or
id|req-&gt;req.zero
)paren
id|master
op_assign
id|MST_RD_ENA
op_or
id|MST_EOPB_ENA
suffix:semicolon
r_else
id|master
op_assign
id|MST_RD_ENA
op_or
id|MST_EOPB_DIS
suffix:semicolon
id|ep-&gt;dev-&gt;int_enable
op_or_assign
id|INT_MSTRDEND
suffix:semicolon
multiline_comment|/* Goku DMA-OUT merges short packets, which plays poorly with&n;&t; * protocols where short packets mark the transfer boundaries.&n;&t; * The chip supports a nonstandard policy with INT_MSTWRTMOUT,&n;&t; * ending transfers after 3 SOFs; we don&squot;t turn it on.&n;&t; */
)brace
r_else
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|master
op_amp
id|MST_WR_ENA
)paren
)paren
(brace
id|DBG
(paren
id|ep-&gt;dev
comma
l_string|&quot;start, OUT active dma %03x!!&bslash;n&quot;
comma
id|master
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;return -EL2HLT;
)brace
id|writel
c_func
(paren
id|end
comma
op_amp
id|regs-&gt;out_dma_end
)paren
suffix:semicolon
id|writel
c_func
(paren
id|start
comma
op_amp
id|regs-&gt;out_dma_start
)paren
suffix:semicolon
id|master
op_and_assign
op_complement
id|MST_W_BITS
suffix:semicolon
id|master
op_or_assign
id|MST_WR_ENA
op_or
id|MST_TIMEOUT_DIS
suffix:semicolon
id|ep-&gt;dev-&gt;int_enable
op_or_assign
id|INT_MSTWREND
op_or
id|INT_MSTWRTMOUT
suffix:semicolon
)brace
id|writel
c_func
(paren
id|master
comma
op_amp
id|regs-&gt;dma_master
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ep-&gt;dev-&gt;int_enable
comma
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dma_advance
r_static
r_void
id|dma_advance
c_func
(paren
r_struct
id|goku_udc
op_star
id|dev
comma
r_struct
id|goku_ep
op_star
id|ep
)paren
(brace
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|ep-&gt;dev-&gt;regs
suffix:semicolon
id|u32
id|master
suffix:semicolon
id|master
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
)paren
(brace
id|stop
suffix:colon
r_if
c_cond
(paren
id|ep-&gt;is_in
)paren
id|dev-&gt;int_enable
op_and_assign
op_complement
id|INT_MSTRDEND
suffix:semicolon
r_else
id|dev-&gt;int_enable
op_and_assign
op_complement
(paren
id|INT_MSTWREND
op_or
id|INT_MSTWRTMOUT
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;int_enable
comma
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|goku_request
comma
id|queue
)paren
suffix:semicolon
multiline_comment|/* normal hw dma completion (not abort) */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|ep-&gt;is_in
)paren
)paren
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|master
op_amp
id|MST_RD_ENA
)paren
)paren
r_return
suffix:semicolon
id|req-&gt;req.actual
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;in_dma_current
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|master
op_amp
id|MST_WR_ENA
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* hardware merges short packets, and also hides packet&n;&t;&t; * overruns.  a partial packet MAY be in the fifo here.&n;&t;&t; */
id|req-&gt;req.actual
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;out_dma_current
)paren
suffix:semicolon
)brace
id|req-&gt;req.actual
op_sub_assign
id|req-&gt;req.dma
suffix:semicolon
id|req-&gt;req.actual
op_increment
suffix:semicolon
macro_line|#ifdef USB_TRACE
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;done %s %s dma, %u/%u bytes, req %p&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|ep-&gt;is_in
ques
c_cond
l_string|&quot;IN&quot;
suffix:colon
l_string|&quot;OUT&quot;
comma
id|req-&gt;req.actual
comma
id|req-&gt;req.length
comma
id|req
)paren
suffix:semicolon
macro_line|#endif
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
r_goto
id|stop
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|goku_request
comma
id|queue
)paren
suffix:semicolon
(paren
r_void
)paren
id|start_dma
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
DECL|function|abort_dma
r_static
r_void
id|abort_dma
c_func
(paren
r_struct
id|goku_ep
op_star
id|ep
comma
r_int
id|status
)paren
(brace
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|ep-&gt;dev-&gt;regs
suffix:semicolon
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
id|u32
id|curr
comma
id|master
suffix:semicolon
multiline_comment|/* NAK future host requests, hoping the implicit delay lets the&n;&t; * dma engine finish reading (or writing) its latest packet and&n;&t; * empty the dma buffer (up to 16 bytes).&n;&t; *&n;&t; * This avoids needing to clean up a partial packet in the fifo;&n;&t; * we can&squot;t do that for IN without side effects to HALT and TOGGLE.&n;&t; */
id|command
c_func
(paren
id|regs
comma
id|COMMAND_FIFO_DISABLE
comma
id|ep-&gt;num
)paren
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|goku_request
comma
id|queue
)paren
suffix:semicolon
id|master
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
op_amp
id|MST_RW_BITS
suffix:semicolon
multiline_comment|/* FIXME using these resets isn&squot;t usably documented. this may&n;&t; * not work unless it&squot;s followed by disabling the endpoint.&n;&t; *&n;&t; * FIXME the OUT reset path doesn&squot;t even behave consistently.&n;&t; */
r_if
c_cond
(paren
id|ep-&gt;is_in
)paren
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
op_amp
id|MST_RD_ENA
)paren
op_eq
l_int|0
)paren
)paren
r_goto
id|finished
suffix:semicolon
id|curr
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;in_dma_current
)paren
suffix:semicolon
id|writel
c_func
(paren
id|curr
comma
op_amp
id|regs-&gt;in_dma_end
)paren
suffix:semicolon
id|writel
c_func
(paren
id|curr
comma
op_amp
id|regs-&gt;in_dma_start
)paren
suffix:semicolon
id|master
op_and_assign
op_complement
id|MST_R_BITS
suffix:semicolon
id|master
op_or_assign
id|MST_RD_RESET
suffix:semicolon
id|writel
c_func
(paren
id|master
comma
op_amp
id|regs-&gt;dma_master
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
op_amp
id|MST_RD_ENA
)paren
id|DBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;IN dma active after reset!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
op_amp
id|MST_WR_ENA
)paren
op_eq
l_int|0
)paren
)paren
r_goto
id|finished
suffix:semicolon
id|curr
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;out_dma_current
)paren
suffix:semicolon
id|writel
c_func
(paren
id|curr
comma
op_amp
id|regs-&gt;out_dma_end
)paren
suffix:semicolon
id|writel
c_func
(paren
id|curr
comma
op_amp
id|regs-&gt;out_dma_start
)paren
suffix:semicolon
id|master
op_and_assign
op_complement
id|MST_W_BITS
suffix:semicolon
id|master
op_or_assign
id|MST_WR_RESET
suffix:semicolon
id|writel
c_func
(paren
id|master
comma
op_amp
id|regs-&gt;dma_master
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
op_amp
id|MST_WR_ENA
)paren
id|DBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;OUT dma active after reset!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|req-&gt;req.actual
op_assign
(paren
id|curr
op_minus
id|req-&gt;req.dma
)paren
op_plus
l_int|1
suffix:semicolon
id|req-&gt;req.status
op_assign
id|status
suffix:semicolon
id|VDBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;%s %s %s %d/%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep-&gt;ep.name
comma
id|ep-&gt;is_in
ques
c_cond
l_string|&quot;IN&quot;
suffix:colon
l_string|&quot;OUT&quot;
comma
id|req-&gt;req.actual
comma
id|req-&gt;req.length
)paren
suffix:semicolon
id|command
c_func
(paren
id|regs
comma
id|COMMAND_FIFO_ENABLE
comma
id|ep-&gt;num
)paren
suffix:semicolon
r_return
suffix:semicolon
id|finished
suffix:colon
multiline_comment|/* dma already completed; no abort needed */
id|command
c_func
(paren
id|regs
comma
id|COMMAND_FIFO_ENABLE
comma
id|ep-&gt;num
)paren
suffix:semicolon
id|req-&gt;req.actual
op_assign
id|req-&gt;req.length
suffix:semicolon
id|req-&gt;req.status
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_int
DECL|function|goku_queue
id|goku_queue
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_struct
id|usb_request
op_star
id|_req
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
r_struct
id|goku_udc
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/* always require a cpu-view buffer so pio works */
id|req
op_assign
id|container_of
c_func
(paren
id|_req
comma
r_struct
id|goku_request
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|_req
op_logical_or
op_logical_neg
id|_req-&gt;complete
op_logical_or
op_logical_neg
id|_req-&gt;buf
op_logical_or
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|req-&gt;queue
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|_ep
op_logical_or
(paren
op_logical_neg
id|ep-&gt;desc
op_logical_and
id|ep-&gt;num
op_ne
l_int|0
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|dev-&gt;driver
op_logical_or
id|dev-&gt;gadget.speed
op_eq
id|USB_SPEED_UNKNOWN
)paren
)paren
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
multiline_comment|/* can&squot;t touch registers when suspended */
r_if
c_cond
(paren
id|dev-&gt;ep0state
op_eq
id|EP0_SUSPEND
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* set up dma mapping in case the caller didn&squot;t */
r_if
c_cond
(paren
id|ep-&gt;dma
op_logical_and
id|_req-&gt;dma
op_eq
id|DMA_ADDR_INVALID
)paren
(brace
id|_req-&gt;dma
op_assign
id|pci_map_single
c_func
(paren
id|dev-&gt;pdev
comma
id|_req-&gt;buf
comma
id|_req-&gt;length
comma
id|ep-&gt;is_in
ques
c_cond
id|PCI_DMA_TODEVICE
suffix:colon
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|req-&gt;mapped
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef USB_TRACE
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;%s queue req %p, len %u buf %p&bslash;n&quot;
comma
id|_ep-&gt;name
comma
id|_req
comma
id|_req-&gt;length
comma
id|_req-&gt;buf
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|_req-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|_req-&gt;actual
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* for ep0 IN without premature status, zlp is required and&n;&t; * writing EOP starts the status stage (OUT).&n;&t; */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ep-&gt;num
op_eq
l_int|0
op_logical_and
id|ep-&gt;is_in
)paren
)paren
id|_req-&gt;zero
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* kickstart this i/o queue? */
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
op_logical_and
id|likely
c_func
(paren
op_logical_neg
id|ep-&gt;stopped
)paren
)paren
(brace
multiline_comment|/* dma:  done after dma completion IRQ (or error)&n;&t;&t; * pio:  done after last fifo operation&n;&t;&t; */
r_if
c_cond
(paren
id|ep-&gt;dma
)paren
id|status
op_assign
id|start_dma
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
r_else
id|status
op_assign
(paren
id|ep-&gt;is_in
ques
c_cond
id|write_fifo
suffix:colon
id|read_fifo
)paren
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|status
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
id|status
op_assign
l_int|0
suffix:semicolon
id|req
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* else pio or dma irq handler advances the queue. */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req
op_ne
l_int|0
)paren
)paren
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;queue
comma
op_amp
id|ep-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
op_logical_and
id|likely
c_func
(paren
id|ep-&gt;num
op_ne
l_int|0
)paren
op_logical_and
op_logical_neg
id|ep-&gt;dma
op_logical_and
op_logical_neg
(paren
id|dev-&gt;int_enable
op_amp
id|INT_EPxDATASET
(paren
id|ep-&gt;num
)paren
)paren
)paren
id|pio_irq_enable
c_func
(paren
id|dev
comma
id|dev-&gt;regs
comma
id|ep-&gt;num
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* pci writes may still be posted */
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* dequeue ALL requests */
DECL|function|nuke
r_static
r_void
id|nuke
c_func
(paren
r_struct
id|goku_ep
op_star
id|ep
comma
r_int
id|status
)paren
(brace
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;dma
)paren
id|abort_dma
c_func
(paren
id|ep
comma
id|status
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|goku_request
comma
id|queue
)paren
suffix:semicolon
id|done
c_func
(paren
id|ep
comma
id|req
comma
id|status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* dequeue JUST ONE request */
DECL|function|goku_dequeue
r_static
r_int
id|goku_dequeue
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_struct
id|usb_request
op_star
id|_req
)paren
(brace
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
r_struct
id|goku_udc
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|_req
op_logical_or
(paren
op_logical_neg
id|ep-&gt;desc
op_logical_and
id|ep-&gt;num
op_ne
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;driver
)paren
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
multiline_comment|/* we can&squot;t touch (dma) registers when suspended */
r_if
c_cond
(paren
id|dev-&gt;ep0state
op_eq
id|EP0_SUSPEND
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;%s %s %s %s %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep-&gt;name
comma
id|ep-&gt;is_in
ques
c_cond
l_string|&quot;IN&quot;
suffix:colon
l_string|&quot;OUT&quot;
comma
id|ep-&gt;dma
ques
c_cond
l_string|&quot;dma&quot;
suffix:colon
l_string|&quot;pio&quot;
comma
id|_req
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* make sure it&squot;s actually queued on this endpoint */
id|list_for_each_entry
(paren
id|req
comma
op_amp
id|ep-&gt;queue
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
op_amp
id|req-&gt;req
op_eq
id|_req
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_amp
id|req-&gt;req
op_ne
id|_req
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ep-&gt;dma
op_logical_and
id|ep-&gt;queue.next
op_eq
op_amp
id|req-&gt;queue
op_logical_and
op_logical_neg
id|ep-&gt;stopped
)paren
(brace
id|abort_dma
c_func
(paren
id|ep
comma
op_minus
id|ECONNRESET
)paren
suffix:semicolon
id|done
c_func
(paren
id|ep
comma
id|req
comma
op_minus
id|ECONNRESET
)paren
suffix:semicolon
id|dma_advance
c_func
(paren
id|dev
comma
id|ep
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|req-&gt;queue
)paren
)paren
id|done
c_func
(paren
id|ep
comma
id|req
comma
op_minus
id|ECONNRESET
)paren
suffix:semicolon
r_else
id|req
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|req
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|goku_clear_halt
r_static
r_void
id|goku_clear_halt
c_func
(paren
r_struct
id|goku_ep
op_star
id|ep
)paren
(brace
singleline_comment|// assert (ep-&gt;num !=0)
id|VDBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;%s clear halt&bslash;n&quot;
comma
id|ep-&gt;ep.name
)paren
suffix:semicolon
id|command
c_func
(paren
id|ep-&gt;dev-&gt;regs
comma
id|COMMAND_SETDATA0
comma
id|ep-&gt;num
)paren
suffix:semicolon
id|command
c_func
(paren
id|ep-&gt;dev-&gt;regs
comma
id|COMMAND_STALL_CLEAR
comma
id|ep-&gt;num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;stopped
)paren
(brace
id|ep-&gt;stopped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;dma
)paren
(brace
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
r_return
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|goku_request
comma
id|queue
)paren
suffix:semicolon
(paren
r_void
)paren
id|start_dma
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
r_else
id|pio_advance
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
)brace
DECL|function|goku_set_halt
r_static
r_int
id|goku_set_halt
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_int
id|value
)paren
(brace
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ep
op_assign
id|container_of
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;num
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
)paren
(brace
id|ep-&gt;dev-&gt;ep0state
op_assign
id|EP0_STALL
suffix:semicolon
id|ep-&gt;dev-&gt;ep
(braket
l_int|0
)braket
dot
id|stopped
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* don&squot;t change EPxSTATUS_EP_INVALID to READY */
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;desc
)paren
(brace
id|DBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;%s %s inactive?&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep-&gt;ep.name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ep-&gt;is_in
op_logical_and
id|value
multiline_comment|/* data in (either) packet buffer? */
op_logical_and
(paren
id|readl
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;regs-&gt;DataSet
)paren
op_amp
id|DATASET_AB
c_func
(paren
id|ep-&gt;num
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
id|goku_clear_halt
c_func
(paren
id|ep
)paren
suffix:semicolon
r_else
(brace
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|VDBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;%s set halt&bslash;n&quot;
comma
id|ep-&gt;ep.name
)paren
suffix:semicolon
id|command
c_func
(paren
id|ep-&gt;dev-&gt;regs
comma
id|COMMAND_STALL
comma
id|ep-&gt;num
)paren
suffix:semicolon
id|readl
c_func
(paren
id|ep-&gt;reg_status
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|goku_fifo_status
r_static
r_int
id|goku_fifo_status
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
)paren
(brace
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
suffix:semicolon
id|u32
id|size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
multiline_comment|/* size is only reported sanely for OUT */
r_if
c_cond
(paren
id|ep-&gt;is_in
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
multiline_comment|/* ignores 16-byte dma buffer; SizeH == 0 */
id|regs
op_assign
id|ep-&gt;dev-&gt;regs
suffix:semicolon
id|size
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxSizeLA
(braket
id|ep-&gt;num
)braket
)paren
op_amp
id|DATASIZE
suffix:semicolon
id|size
op_add_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxSizeLB
(braket
id|ep-&gt;num
)braket
)paren
op_amp
id|DATASIZE
suffix:semicolon
id|VDBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;%s %s %u&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep-&gt;ep.name
comma
id|size
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
DECL|function|goku_fifo_flush
r_static
r_void
id|goku_fifo_flush
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
)paren
(brace
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
suffix:semicolon
id|u32
id|size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
)paren
r_return
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|goku_ep
comma
id|ep
)paren
suffix:semicolon
id|VDBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;%s %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep-&gt;ep.name
)paren
suffix:semicolon
multiline_comment|/* don&squot;t change EPxSTATUS_EP_INVALID to READY */
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;desc
op_logical_and
id|ep-&gt;num
op_ne
l_int|0
)paren
(brace
id|DBG
c_func
(paren
id|ep-&gt;dev
comma
l_string|&quot;%s %s inactive?&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep-&gt;ep.name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|regs
op_assign
id|ep-&gt;dev-&gt;regs
suffix:semicolon
id|size
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxSizeLA
(braket
id|ep-&gt;num
)braket
)paren
suffix:semicolon
id|size
op_and_assign
id|DATASIZE
suffix:semicolon
multiline_comment|/* Non-desirable behavior:  FIFO_CLEAR also clears the&n;&t; * endpoint halt feature.  For OUT, we _could_ just read&n;&t; * the bytes out (PIO, if !ep-&gt;dma); for in, no choice.&n;&t; */
r_if
c_cond
(paren
id|size
)paren
id|command
c_func
(paren
id|regs
comma
id|COMMAND_FIFO_CLEAR
comma
id|ep-&gt;num
)paren
suffix:semicolon
)brace
DECL|variable|goku_ep_ops
r_static
r_struct
id|usb_ep_ops
id|goku_ep_ops
op_assign
(brace
dot
id|enable
op_assign
id|goku_ep_enable
comma
dot
id|disable
op_assign
id|goku_ep_disable
comma
dot
id|alloc_request
op_assign
id|goku_alloc_request
comma
dot
id|free_request
op_assign
id|goku_free_request
comma
dot
id|alloc_buffer
op_assign
id|goku_alloc_buffer
comma
dot
id|free_buffer
op_assign
id|goku_free_buffer
comma
dot
id|queue
op_assign
id|goku_queue
comma
dot
id|dequeue
op_assign
id|goku_dequeue
comma
dot
id|set_halt
op_assign
id|goku_set_halt
comma
dot
id|fifo_status
op_assign
id|goku_fifo_status
comma
dot
id|fifo_flush
op_assign
id|goku_fifo_flush
comma
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|goku_get_frame
r_static
r_int
id|goku_get_frame
c_func
(paren
r_struct
id|usb_gadget
op_star
id|_gadget
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|variable|goku_ops
r_static
r_const
r_struct
id|usb_gadget_ops
id|goku_ops
op_assign
(brace
dot
id|get_frame
op_assign
id|goku_get_frame
comma
singleline_comment|// no remote wakeup
singleline_comment|// not selfpowered
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|dmastr
r_static
r_inline
r_char
op_star
id|dmastr
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|use_dma
op_eq
l_int|0
)paren
r_return
l_string|&quot;(dma disabled)&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|use_dma
op_eq
l_int|2
)paren
r_return
l_string|&quot;(dma IN and OUT)&quot;
suffix:semicolon
r_else
r_return
l_string|&quot;(dma IN)&quot;
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_USB_GADGET_DEBUG_FILES
DECL|variable|proc_node_name
r_static
r_const
r_char
id|proc_node_name
(braket
)braket
op_assign
l_string|&quot;driver/udc&quot;
suffix:semicolon
DECL|macro|FOURBITS
mdefine_line|#define FOURBITS &quot;%s%s%s%s&quot;
DECL|macro|EIGHTBITS
mdefine_line|#define EIGHTBITS FOURBITS FOURBITS
r_static
r_void
DECL|function|dump_intmask
id|dump_intmask
c_func
(paren
r_const
r_char
op_star
id|label
comma
id|u32
id|mask
comma
r_char
op_star
op_star
id|next
comma
r_int
op_star
id|size
)paren
(brace
r_int
id|t
suffix:semicolon
multiline_comment|/* int_status is the same format ... */
id|t
op_assign
id|scnprintf
c_func
(paren
op_star
id|next
comma
op_star
id|size
comma
l_string|&quot;%s %05X =&quot;
id|FOURBITS
id|EIGHTBITS
id|EIGHTBITS
l_string|&quot;&bslash;n&quot;
comma
id|label
comma
id|mask
comma
(paren
id|mask
op_amp
id|INT_PWRDETECT
)paren
ques
c_cond
l_string|&quot; power&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_SYSERROR
)paren
ques
c_cond
l_string|&quot; sys&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_MSTRDEND
)paren
ques
c_cond
l_string|&quot; in-dma&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_MSTWRTMOUT
)paren
ques
c_cond
l_string|&quot; wrtmo&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_MSTWREND
)paren
ques
c_cond
l_string|&quot; out-dma&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_MSTWRSET
)paren
ques
c_cond
l_string|&quot; wrset&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_ERR
)paren
ques
c_cond
l_string|&quot; err&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_SOF
)paren
ques
c_cond
l_string|&quot; sof&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_EP3NAK
)paren
ques
c_cond
l_string|&quot; ep3nak&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_EP2NAK
)paren
ques
c_cond
l_string|&quot; ep2nak&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_EP1NAK
)paren
ques
c_cond
l_string|&quot; ep1nak&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_EP3DATASET
)paren
ques
c_cond
l_string|&quot; ep3&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_EP2DATASET
)paren
ques
c_cond
l_string|&quot; ep2&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_EP1DATASET
)paren
ques
c_cond
l_string|&quot; ep1&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_STATUSNAK
)paren
ques
c_cond
l_string|&quot; ep0snak&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_STATUS
)paren
ques
c_cond
l_string|&quot; ep0status&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_SETUP
)paren
ques
c_cond
l_string|&quot; setup&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_ENDPOINT0
)paren
ques
c_cond
l_string|&quot; ep0&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_USBRESET
)paren
ques
c_cond
l_string|&quot; reset&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|INT_SUSPEND
)paren
ques
c_cond
l_string|&quot; suspend&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
op_star
id|size
op_sub_assign
id|t
suffix:semicolon
op_star
id|next
op_add_assign
id|t
suffix:semicolon
)brace
r_static
r_int
DECL|function|udc_proc_read
id|udc_proc_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|_dev
)paren
(brace
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_struct
id|goku_udc
op_star
id|dev
op_assign
id|_dev
suffix:semicolon
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|dev-&gt;regs
suffix:semicolon
r_char
op_star
id|next
op_assign
id|buf
suffix:semicolon
r_int
id|size
op_assign
id|count
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|t
comma
id|is_usb_connected
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* basic device status */
id|tmp
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;power_detect
)paren
suffix:semicolon
id|is_usb_connected
op_assign
id|tmp
op_amp
id|PW_DETECT
suffix:semicolon
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
l_string|&quot;%s - %s&bslash;n&quot;
l_string|&quot;%s version: %s %s&bslash;n&quot;
l_string|&quot;Gadget driver: %s&bslash;n&quot;
l_string|&quot;Host %s, %s&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev-&gt;pdev
)paren
comma
id|driver_desc
comma
id|driver_name
comma
id|DRIVER_VERSION
comma
id|dmastr
c_func
(paren
)paren
comma
id|dev-&gt;driver
ques
c_cond
id|dev-&gt;driver-&gt;driver.name
suffix:colon
l_string|&quot;(none)&quot;
comma
id|is_usb_connected
ques
c_cond
(paren
(paren
id|tmp
op_amp
id|PW_PULLUP
)paren
ques
c_cond
l_string|&quot;full speed&quot;
suffix:colon
l_string|&quot;powered&quot;
)paren
suffix:colon
l_string|&quot;disconnected&quot;
comma
(paren
(brace
r_char
op_star
id|tmp
suffix:semicolon
r_switch
(paren
id|dev-&gt;ep0state
)paren
(brace
r_case
id|EP0_DISCONNECT
suffix:colon
id|tmp
op_assign
l_string|&quot;ep0_disconnect&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EP0_IDLE
suffix:colon
id|tmp
op_assign
l_string|&quot;ep0_idle&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EP0_IN
suffix:colon
id|tmp
op_assign
l_string|&quot;ep0_in&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EP0_OUT
suffix:colon
id|tmp
op_assign
l_string|&quot;ep0_out&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EP0_STATUS
suffix:colon
id|tmp
op_assign
l_string|&quot;ep0_status&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EP0_STALL
suffix:colon
id|tmp
op_assign
l_string|&quot;ep0_stall&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EP0_SUSPEND
suffix:colon
id|tmp
op_assign
l_string|&quot;ep0_suspend&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|tmp
op_assign
l_string|&quot;ep0_?&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tmp
suffix:semicolon
)brace
)paren
)paren
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
id|dump_intmask
c_func
(paren
l_string|&quot;int_status&quot;
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_status
)paren
comma
op_amp
id|next
comma
op_amp
id|size
)paren
suffix:semicolon
id|dump_intmask
c_func
(paren
l_string|&quot;int_enable&quot;
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_enable
)paren
comma
op_amp
id|next
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_usb_connected
op_logical_or
op_logical_neg
id|dev-&gt;driver
op_logical_or
(paren
id|tmp
op_amp
id|PW_PULLUP
)paren
op_eq
l_int|0
)paren
r_goto
id|done
suffix:semicolon
multiline_comment|/* registers for (active) device and ep0 */
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
l_string|&quot;&bslash;nirqs %lu&bslash;ndataset %02x &quot;
l_string|&quot;single.bcs %02x.%02x state %x addr %u&bslash;n&quot;
comma
id|dev-&gt;irqs
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;DataSet
)paren
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxSingle
)paren
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;EPxBCS
)paren
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;UsbState
)paren
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;address
)paren
)paren
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;dma_master
)paren
suffix:semicolon
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
l_string|&quot;dma %03X =&quot;
id|EIGHTBITS
l_string|&quot;%s %s&bslash;n&quot;
comma
id|tmp
comma
(paren
id|tmp
op_amp
id|MST_EOPB_DIS
)paren
ques
c_cond
l_string|&quot; eopb-&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_EOPB_ENA
)paren
ques
c_cond
l_string|&quot; eopb+&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_TIMEOUT_DIS
)paren
ques
c_cond
l_string|&quot; tmo-&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_TIMEOUT_ENA
)paren
ques
c_cond
l_string|&quot; tmo+&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_RD_EOPB
)paren
ques
c_cond
l_string|&quot; eopb&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_RD_RESET
)paren
ques
c_cond
l_string|&quot; in_reset&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_WR_RESET
)paren
ques
c_cond
l_string|&quot; out_reset&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_RD_ENA
)paren
ques
c_cond
l_string|&quot; IN&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_WR_ENA
)paren
ques
c_cond
l_string|&quot; OUT&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|MST_CONNECTION
)paren
ques
c_cond
l_string|&quot;ep1in/ep2out&quot;
suffix:colon
l_string|&quot;ep1out/ep2in&quot;
)paren
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
multiline_comment|/* dump endpoint queues */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|goku_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|i
)braket
suffix:semicolon
r_struct
id|goku_request
op_star
id|req
suffix:semicolon
r_int
id|t
suffix:semicolon
r_if
c_cond
(paren
id|i
op_logical_and
op_logical_neg
id|ep-&gt;desc
)paren
r_continue
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|ep-&gt;reg_status
)paren
suffix:semicolon
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
l_string|&quot;%s %s max %u %s, irqs %lu, &quot;
l_string|&quot;status %02x (%s) &quot;
id|FOURBITS
l_string|&quot;&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|ep-&gt;is_in
ques
c_cond
l_string|&quot;in&quot;
suffix:colon
l_string|&quot;out&quot;
comma
id|ep-&gt;ep.maxpacket
comma
id|ep-&gt;dma
ques
c_cond
l_string|&quot;dma&quot;
suffix:colon
l_string|&quot;pio&quot;
comma
id|ep-&gt;irqs
comma
id|tmp
comma
(paren
(brace
r_char
op_star
id|s
suffix:semicolon
r_switch
(paren
id|tmp
op_amp
id|EPxSTATUS_EP_MASK
)paren
(brace
r_case
id|EPxSTATUS_EP_READY
suffix:colon
id|s
op_assign
l_string|&quot;ready&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPxSTATUS_EP_DATAIN
suffix:colon
id|s
op_assign
l_string|&quot;packet&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPxSTATUS_EP_FULL
suffix:colon
id|s
op_assign
l_string|&quot;full&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPxSTATUS_EP_TX_ERR
suffix:colon
singleline_comment|// host will retry
id|s
op_assign
l_string|&quot;tx_err&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPxSTATUS_EP_RX_ERR
suffix:colon
id|s
op_assign
l_string|&quot;rx_err&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPxSTATUS_EP_BUSY
suffix:colon
multiline_comment|/* ep0 only */
id|s
op_assign
l_string|&quot;busy&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPxSTATUS_EP_STALL
suffix:colon
id|s
op_assign
l_string|&quot;stall&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPxSTATUS_EP_INVALID
suffix:colon
singleline_comment|// these &quot;can&squot;t happen&quot;
id|s
op_assign
l_string|&quot;invalid&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|s
op_assign
l_string|&quot;?&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|s
suffix:semicolon
)brace
)paren
comma
(paren
id|tmp
op_amp
id|EPxSTATUS_TOGGLE
)paren
ques
c_cond
l_string|&quot;data1&quot;
suffix:colon
l_string|&quot;data0&quot;
comma
(paren
id|tmp
op_amp
id|EPxSTATUS_SUSPEND
)paren
ques
c_cond
l_string|&quot; suspend&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|EPxSTATUS_FIFO_DISABLE
)paren
ques
c_cond
l_string|&quot; disable&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|EPxSTATUS_STAGE_ERROR
)paren
ques
c_cond
l_string|&quot; ep0stat&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_le
l_int|0
op_logical_or
id|t
OG
id|size
)paren
r_goto
id|done
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
l_string|&quot;&bslash;t(nothing queued)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_le
l_int|0
op_logical_or
id|t
OG
id|size
)paren
r_goto
id|done
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|req
comma
op_amp
id|ep-&gt;queue
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;dma
op_logical_and
id|req-&gt;queue.prev
op_eq
op_amp
id|ep-&gt;queue
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|UDC_MSTRD_ENDPOINT
)paren
id|tmp
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;in_dma_current
)paren
suffix:semicolon
r_else
id|tmp
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;out_dma_current
)paren
suffix:semicolon
id|tmp
op_sub_assign
id|req-&gt;req.dma
suffix:semicolon
id|tmp
op_increment
suffix:semicolon
)brace
r_else
id|tmp
op_assign
id|req-&gt;req.actual
suffix:semicolon
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
l_string|&quot;&bslash;treq %p len %u/%u buf %p&bslash;n&quot;
comma
op_amp
id|req-&gt;req
comma
id|tmp
comma
id|req-&gt;req.length
comma
id|req-&gt;req.buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_le
l_int|0
op_logical_or
id|t
OG
id|size
)paren
r_goto
id|done
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
)brace
)brace
id|done
suffix:colon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
id|count
op_minus
id|size
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_USB_GADGET_DEBUG_FILES */
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|udc_reinit
r_static
r_void
id|udc_reinit
(paren
r_struct
id|goku_udc
op_star
id|dev
)paren
(brace
r_static
r_char
op_star
id|names
(braket
)braket
op_assign
(brace
l_string|&quot;ep0&quot;
comma
l_string|&quot;ep1-bulk&quot;
comma
l_string|&quot;ep2-bulk&quot;
comma
l_string|&quot;ep3-bulk&quot;
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|dev-&gt;gadget.ep_list
)paren
suffix:semicolon
id|dev-&gt;gadget.ep0
op_assign
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|ep
suffix:semicolon
id|dev-&gt;gadget.speed
op_assign
id|USB_SPEED_UNKNOWN
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_DISCONNECT
suffix:semicolon
id|dev-&gt;irqs
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|goku_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|i
)braket
suffix:semicolon
id|ep-&gt;num
op_assign
id|i
suffix:semicolon
id|ep-&gt;ep.name
op_assign
id|names
(braket
id|i
)braket
suffix:semicolon
id|ep-&gt;reg_fifo
op_assign
op_amp
id|dev-&gt;regs-&gt;ep_fifo
(braket
id|i
)braket
suffix:semicolon
id|ep-&gt;reg_status
op_assign
op_amp
id|dev-&gt;regs-&gt;ep_status
(braket
id|i
)braket
suffix:semicolon
id|ep-&gt;reg_mode
op_assign
op_amp
id|dev-&gt;regs-&gt;ep_mode
(braket
id|i
)braket
suffix:semicolon
id|ep-&gt;ep.ops
op_assign
op_amp
id|goku_ep_ops
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|ep-&gt;ep.ep_list
comma
op_amp
id|dev-&gt;gadget.ep_list
)paren
suffix:semicolon
id|ep-&gt;dev
op_assign
id|dev
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|ep-&gt;queue
)paren
suffix:semicolon
id|ep_reset
c_func
(paren
l_int|NULL
comma
id|ep
)paren
suffix:semicolon
)brace
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|reg_mode
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|ep.maxpacket
op_assign
id|MAX_EP0_SIZE
suffix:semicolon
id|list_del_init
(paren
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|ep.ep_list
)paren
suffix:semicolon
)brace
DECL|function|udc_reset
r_static
r_void
id|udc_reset
c_func
(paren
r_struct
id|goku_udc
op_star
id|dev
)paren
(brace
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|dev-&gt;regs
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|regs-&gt;power_detect
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
id|dev-&gt;int_enable
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* deassert reset, leave USB D+ at hi-Z (no pullup)&n;&t; * don&squot;t let INT_PWRDETECT sequence begin&n;&t; */
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|writel
c_func
(paren
id|PW_RESETB
comma
op_amp
id|regs-&gt;power_detect
)paren
suffix:semicolon
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
)brace
DECL|function|ep0_start
r_static
r_void
id|ep0_start
c_func
(paren
r_struct
id|goku_udc
op_star
id|dev
)paren
(brace
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|dev-&gt;regs
suffix:semicolon
r_int
id|i
suffix:semicolon
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|udc_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|udc_reinit
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|//writel(MST_EOPB_ENA | MST_TIMEOUT_ENA, &amp;regs-&gt;dma_master);
multiline_comment|/* hw handles set_address, set_feature, get_status; maybe more */
id|writel
c_func
(paren
id|G_REQMODE_SET_INTF
op_or
id|G_REQMODE_GET_INTF
op_or
id|G_REQMODE_SET_CONF
op_or
id|G_REQMODE_GET_CONF
op_or
id|G_REQMODE_GET_DESC
op_or
id|G_REQMODE_CLEAR_FEAT
comma
op_amp
id|regs-&gt;reqmode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;ep
(braket
id|i
)braket
dot
id|irqs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* can&squot;t modify descriptors after writing UsbReady */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DESC_LEN
suffix:semicolon
id|i
op_increment
)paren
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|regs-&gt;descriptors
(braket
id|i
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|regs-&gt;UsbReady
)paren
suffix:semicolon
multiline_comment|/* expect ep0 requests when the host drops reset */
id|writel
c_func
(paren
id|PW_RESETB
op_or
id|PW_PULLUP
comma
op_amp
id|regs-&gt;power_detect
)paren
suffix:semicolon
id|dev-&gt;int_enable
op_assign
id|INT_DEVWIDE
op_or
id|INT_EP0
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;int_enable
comma
op_amp
id|dev-&gt;regs-&gt;int_enable
)paren
suffix:semicolon
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
id|dev-&gt;gadget.speed
op_assign
id|USB_SPEED_FULL
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_IDLE
suffix:semicolon
)brace
DECL|function|udc_enable
r_static
r_void
id|udc_enable
c_func
(paren
r_struct
id|goku_udc
op_star
id|dev
)paren
(brace
multiline_comment|/* start enumeration now, or after power detect irq */
r_if
c_cond
(paren
id|readl
c_func
(paren
op_amp
id|dev-&gt;regs-&gt;power_detect
)paren
op_amp
id|PW_DETECT
)paren
id|ep0_start
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
(brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dev-&gt;int_enable
op_assign
id|INT_PWRDETECT
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;int_enable
comma
op_amp
id|dev-&gt;regs-&gt;int_enable
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* keeping it simple:&n; * - one bus driver, initted first;&n; * - one function driver, initted second&n; */
DECL|variable|the_controller
r_static
r_struct
id|goku_udc
op_star
id|the_controller
suffix:semicolon
multiline_comment|/* when a driver is successfully registered, it will receive&n; * control requests including set_configuration(), which enables&n; * non-control requests.  then usb traffic follows until a&n; * disconnect is reported.  then a host may connect again, or&n; * the driver might get unbound.&n; */
DECL|function|usb_gadget_register_driver
r_int
id|usb_gadget_register_driver
c_func
(paren
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
op_assign
id|the_controller
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
op_logical_or
id|driver-&gt;speed
op_ne
id|USB_SPEED_FULL
op_logical_or
op_logical_neg
id|driver-&gt;bind
op_logical_or
op_logical_neg
id|driver-&gt;unbind
op_logical_or
op_logical_neg
id|driver-&gt;disconnect
op_logical_or
op_logical_neg
id|driver-&gt;setup
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* hook up the driver */
id|driver-&gt;driver.bus
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;driver
op_assign
id|driver
suffix:semicolon
id|dev-&gt;gadget.dev.driver
op_assign
op_amp
id|driver-&gt;driver
suffix:semicolon
id|retval
op_assign
id|driver
op_member_access_from_pointer
id|bind
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;bind to driver %s --&gt; error %d&bslash;n&quot;
comma
id|driver-&gt;driver.name
comma
id|retval
)paren
suffix:semicolon
id|dev-&gt;driver
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;gadget.dev.driver
op_assign
l_int|NULL
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* then enable host detection and ep0; and we&squot;re ready&n;&t; * for set_configuration as well as eventual disconnect.&n;&t; */
id|udc_enable
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;registered gadget driver &squot;%s&squot;&bslash;n&quot;
comma
id|driver-&gt;driver.name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|usb_gadget_register_driver
id|EXPORT_SYMBOL
c_func
(paren
id|usb_gadget_register_driver
)paren
suffix:semicolon
r_static
r_void
DECL|function|stop_activity
id|stop_activity
c_func
(paren
r_struct
id|goku_udc
op_star
id|dev
comma
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;gadget.speed
op_eq
id|USB_SPEED_UNKNOWN
)paren
id|driver
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* disconnect gadget driver after quiesceing hw and the driver */
id|udc_reset
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|nuke
c_func
(paren
op_amp
id|dev-&gt;ep
(braket
id|i
)braket
comma
op_minus
id|ESHUTDOWN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|driver
op_member_access_from_pointer
id|disconnect
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;driver
)paren
id|udc_enable
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|usb_gadget_unregister_driver
r_int
id|usb_gadget_unregister_driver
c_func
(paren
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
op_assign
id|the_controller
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
op_logical_or
id|driver
op_ne
id|dev-&gt;driver
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;driver
op_assign
l_int|NULL
suffix:semicolon
id|stop_activity
c_func
(paren
id|dev
comma
id|driver
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|driver
op_member_access_from_pointer
id|unbind
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;unregistered driver &squot;%s&squot;&bslash;n&quot;
comma
id|driver-&gt;driver.name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|usb_gadget_unregister_driver
id|EXPORT_SYMBOL
c_func
(paren
id|usb_gadget_unregister_driver
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|ep0_setup
r_static
r_void
id|ep0_setup
c_func
(paren
r_struct
id|goku_udc
op_star
id|dev
)paren
(brace
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|dev-&gt;regs
suffix:semicolon
r_struct
id|usb_ctrlrequest
id|ctrl
suffix:semicolon
r_int
id|tmp
suffix:semicolon
multiline_comment|/* read SETUP packet and enter DATA stage */
id|ctrl.bRequestType
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;bRequestType
)paren
suffix:semicolon
id|ctrl.bRequest
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;bRequest
)paren
suffix:semicolon
id|ctrl.wValue
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;wValueH
)paren
op_lshift
l_int|8
)paren
op_or
id|readl
c_func
(paren
op_amp
id|regs-&gt;wValueL
)paren
suffix:semicolon
id|ctrl.wIndex
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;wIndexH
)paren
op_lshift
l_int|8
)paren
op_or
id|readl
c_func
(paren
op_amp
id|regs-&gt;wIndexL
)paren
suffix:semicolon
id|ctrl.wLength
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;wLengthH
)paren
op_lshift
l_int|8
)paren
op_or
id|readl
c_func
(paren
op_amp
id|regs-&gt;wLengthL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|regs-&gt;SetupRecv
)paren
suffix:semicolon
id|nuke
c_func
(paren
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|stopped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|ctrl.bRequestType
op_amp
id|USB_DIR_IN
)paren
)paren
(brace
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|is_in
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_IN
suffix:semicolon
multiline_comment|/* detect early status stages */
id|writel
c_func
(paren
id|ICONTROL_STATUSNAK
comma
op_amp
id|dev-&gt;regs-&gt;IntControl
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|is_in
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_OUT
suffix:semicolon
multiline_comment|/* NOTE:  CLEAR_FEATURE is done in software so that we can&n;&t;&t; * synchronize transfer restarts after bulk IN stalls.  data&n;&t;&t; * won&squot;t even enter the fifo until the halt is cleared.&n;&t;&t; */
r_switch
c_cond
(paren
id|ctrl.bRequest
)paren
(brace
r_case
id|USB_REQ_CLEAR_FEATURE
suffix:colon
r_switch
c_cond
(paren
id|ctrl.bRequestType
)paren
(brace
r_case
id|USB_RECIP_ENDPOINT
suffix:colon
id|tmp
op_assign
id|ctrl.wIndex
op_amp
l_int|0x0f
suffix:semicolon
multiline_comment|/* active endpoint */
r_if
c_cond
(paren
id|tmp
OG
l_int|3
op_logical_or
(paren
op_logical_neg
id|dev-&gt;ep
(braket
id|tmp
)braket
dot
id|desc
op_logical_and
id|tmp
op_ne
l_int|0
)paren
)paren
r_goto
id|stall
suffix:semicolon
r_if
c_cond
(paren
id|ctrl.wIndex
op_amp
id|USB_DIR_IN
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;ep
(braket
id|tmp
)braket
dot
id|is_in
)paren
r_goto
id|stall
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;ep
(braket
id|tmp
)braket
dot
id|is_in
)paren
r_goto
id|stall
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl.wValue
op_ne
id|USB_ENDPOINT_HALT
)paren
r_goto
id|stall
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
id|goku_clear_halt
c_func
(paren
op_amp
id|dev-&gt;ep
(braket
id|tmp
)braket
)paren
suffix:semicolon
id|succeed
suffix:colon
multiline_comment|/* start ep0out status stage */
id|writel
c_func
(paren
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
op_amp
id|regs-&gt;EOP
)paren
suffix:semicolon
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|stopped
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_STATUS
suffix:semicolon
r_return
suffix:semicolon
r_case
id|USB_RECIP_DEVICE
suffix:colon
multiline_comment|/* device remote wakeup: always clear */
r_if
c_cond
(paren
id|ctrl.wValue
op_ne
l_int|1
)paren
r_goto
id|stall
suffix:semicolon
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;clear dev remote wakeup&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|succeed
suffix:semicolon
r_case
id|USB_RECIP_INTERFACE
suffix:colon
r_goto
id|stall
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* pass to gadget driver */
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
macro_line|#ifdef USB_TRACE
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;SETUP %02x.%02x v%04x i%04x l%04x&bslash;n&quot;
comma
id|ctrl.bRequestType
comma
id|ctrl.bRequest
comma
id|ctrl.wValue
comma
id|ctrl.wIndex
comma
id|ctrl.wLength
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* hw wants to know when we&squot;re configured (or not) */
id|dev-&gt;req_config
op_assign
(paren
id|ctrl.bRequest
op_eq
id|USB_REQ_SET_CONFIGURATION
op_logical_and
id|ctrl.bRequestType
op_eq
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|dev-&gt;req_config
)paren
)paren
id|dev-&gt;configured
op_assign
(paren
id|ctrl.wValue
op_ne
l_int|0
)paren
suffix:semicolon
multiline_comment|/* delegate everything to the gadget driver.&n;&t; * it may respond after this irq handler returns.&n;&t; */
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|tmp
op_assign
id|dev-&gt;driver
op_member_access_from_pointer
id|setup
c_func
(paren
op_amp
id|dev-&gt;gadget
comma
op_amp
id|ctrl
)paren
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|tmp
OL
l_int|0
)paren
)paren
(brace
id|stall
suffix:colon
macro_line|#ifdef USB_TRACE
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;req %02x.%02x protocol STALL; err %d&bslash;n&quot;
comma
id|ctrl.bRequestType
comma
id|ctrl.bRequest
comma
id|tmp
)paren
suffix:semicolon
macro_line|#endif
id|command
c_func
(paren
id|regs
comma
id|COMMAND_STALL
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|stopped
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_STALL
suffix:semicolon
)brace
multiline_comment|/* expect at least one data or status stage irq */
)brace
DECL|macro|ACK
mdefine_line|#define ACK(irqbit) { &bslash;&n;&t;&t;stat &amp;= ~irqbit; &bslash;&n;&t;&t;writel(~irqbit, &amp;regs-&gt;int_status); &bslash;&n;&t;&t;handled = 1; &bslash;&n;&t;&t;}
DECL|function|goku_irq
r_static
id|irqreturn_t
id|goku_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|_dev
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
op_assign
id|_dev
suffix:semicolon
r_struct
id|goku_udc_regs
id|__iomem
op_star
id|regs
op_assign
id|dev-&gt;regs
suffix:semicolon
r_struct
id|goku_ep
op_star
id|ep
suffix:semicolon
id|u32
id|stat
comma
id|handled
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|rescans
op_assign
l_int|5
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|rescan
suffix:colon
id|stat
op_assign
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_status
)paren
op_amp
id|dev-&gt;int_enable
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stat
)paren
r_goto
id|done
suffix:semicolon
id|dev-&gt;irqs
op_increment
suffix:semicolon
multiline_comment|/* device-wide irqs */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|stat
op_amp
id|INT_DEVWIDE
)paren
)paren
(brace
r_if
c_cond
(paren
id|stat
op_amp
id|INT_SYSERROR
)paren
(brace
id|ERROR
c_func
(paren
id|dev
comma
l_string|&quot;system error&bslash;n&quot;
)paren
suffix:semicolon
id|stop_activity
c_func
(paren
id|dev
comma
id|dev-&gt;driver
)paren
suffix:semicolon
id|stat
op_assign
l_int|0
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
singleline_comment|// FIXME have a neater way to prevent re-enumeration
id|dev-&gt;driver
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|INT_PWRDETECT
)paren
(brace
id|writel
c_func
(paren
op_complement
id|stat
comma
op_amp
id|regs-&gt;int_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
op_amp
id|dev-&gt;regs-&gt;power_detect
)paren
op_amp
id|PW_DETECT
)paren
(brace
id|VDBG
c_func
(paren
id|dev
comma
l_string|&quot;connect&bslash;n&quot;
)paren
suffix:semicolon
id|ep0_start
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;disconnect&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;gadget.speed
op_eq
id|USB_SPEED_FULL
)paren
id|stop_activity
c_func
(paren
id|dev
comma
id|dev-&gt;driver
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_DISCONNECT
suffix:semicolon
id|dev-&gt;int_enable
op_assign
id|INT_DEVWIDE
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;int_enable
comma
op_amp
id|dev-&gt;regs-&gt;int_enable
)paren
suffix:semicolon
)brace
id|stat
op_assign
l_int|0
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|INT_SUSPEND
)paren
(brace
id|ACK
c_func
(paren
id|INT_SUSPEND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;ep_status
(braket
l_int|0
)braket
)paren
op_amp
id|EPxSTATUS_SUSPEND
)paren
(brace
r_switch
c_cond
(paren
id|dev-&gt;ep0state
)paren
(brace
r_case
id|EP0_DISCONNECT
suffix:colon
r_case
id|EP0_SUSPEND
suffix:colon
r_goto
id|pm_next
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;USB suspend&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_SUSPEND
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;gadget.speed
op_ne
id|USB_SPEED_UNKNOWN
op_logical_and
id|dev-&gt;driver
op_logical_and
id|dev-&gt;driver-&gt;suspend
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;driver
op_member_access_from_pointer
id|suspend
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;ep0state
op_ne
id|EP0_SUSPEND
)paren
(brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;bogus USB resume %d&bslash;n&quot;
comma
id|dev-&gt;ep0state
)paren
suffix:semicolon
r_goto
id|pm_next
suffix:semicolon
)brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;USB resume&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_IDLE
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;gadget.speed
op_ne
id|USB_SPEED_UNKNOWN
op_logical_and
id|dev-&gt;driver
op_logical_and
id|dev-&gt;driver-&gt;resume
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;driver
op_member_access_from_pointer
id|resume
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
)brace
)brace
)brace
id|pm_next
suffix:colon
r_if
c_cond
(paren
id|stat
op_amp
id|INT_USBRESET
)paren
(brace
multiline_comment|/* hub reset done */
id|ACK
c_func
(paren
id|INT_USBRESET
)paren
suffix:semicolon
id|INFO
c_func
(paren
id|dev
comma
l_string|&quot;USB reset done, gadget %s&bslash;n&quot;
comma
id|dev-&gt;driver-&gt;driver.name
)paren
suffix:semicolon
)brace
singleline_comment|// and INT_ERR on some endpoint&squot;s crc/bitstuff/... problem
)brace
multiline_comment|/* progress ep0 setup, data, or status stages.&n;&t; * no transition {EP0_STATUS, EP0_STALL} --&gt; EP0_IDLE; saves irqs&n;&t; */
r_if
c_cond
(paren
id|stat
op_amp
id|INT_SETUP
)paren
(brace
id|ACK
c_func
(paren
id|INT_SETUP
)paren
suffix:semicolon
id|dev-&gt;ep
(braket
l_int|0
)braket
dot
id|irqs
op_increment
suffix:semicolon
id|ep0_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|INT_STATUSNAK
)paren
(brace
id|ACK
c_func
(paren
id|INT_STATUSNAK
op_or
id|INT_ENDPOINT0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ep0state
op_eq
id|EP0_IN
)paren
(brace
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
id|nuke
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
id|writel
c_func
(paren
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
op_amp
id|regs-&gt;EOP
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|EP0_STATUS
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|INT_ENDPOINT0
)paren
(brace
id|ACK
c_func
(paren
id|INT_ENDPOINT0
)paren
suffix:semicolon
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
id|pio_advance
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
multiline_comment|/* dma completion */
r_if
c_cond
(paren
id|stat
op_amp
id|INT_MSTRDEND
)paren
(brace
multiline_comment|/* IN */
id|ACK
c_func
(paren
id|INT_MSTRDEND
)paren
suffix:semicolon
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|UDC_MSTRD_ENDPOINT
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
id|dma_advance
c_func
(paren
id|dev
comma
id|ep
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|INT_MSTWREND
)paren
(brace
multiline_comment|/* OUT */
id|ACK
c_func
(paren
id|INT_MSTWREND
)paren
suffix:semicolon
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|UDC_MSTWR_ENDPOINT
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
id|dma_advance
c_func
(paren
id|dev
comma
id|ep
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
id|INT_MSTWRTMOUT
)paren
(brace
multiline_comment|/* OUT */
id|ACK
c_func
(paren
id|INT_MSTWRTMOUT
)paren
suffix:semicolon
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|UDC_MSTWR_ENDPOINT
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
id|ERROR
c_func
(paren
id|dev
comma
l_string|&quot;%s write timeout ?&bslash;n&quot;
comma
id|ep-&gt;ep.name
)paren
suffix:semicolon
singleline_comment|// reset dma? then dma_advance()
)brace
multiline_comment|/* pio */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|tmp
op_assign
id|INT_EPxDATASET
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|tmp
)paren
)paren
r_continue
suffix:semicolon
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|i
)braket
suffix:semicolon
id|pio_advance
c_func
(paren
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|pio_irq_disable
c_func
(paren
id|dev
comma
id|regs
comma
id|i
)paren
suffix:semicolon
id|stat
op_and_assign
op_complement
id|tmp
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rescans
op_decrement
)paren
r_goto
id|rescan
suffix:semicolon
id|done
suffix:colon
(paren
r_void
)paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_enable
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
)paren
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;unhandled irq status: %05x (%05x, %05x)&bslash;n&quot;
comma
id|stat
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;int_status
)paren
comma
id|dev-&gt;int_enable
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
DECL|macro|ACK
macro_line|#undef ACK
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|gadget_release
r_static
r_void
id|gadget_release
c_func
(paren
r_struct
id|device
op_star
id|_dev
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
op_assign
id|dev_get_drvdata
c_func
(paren
id|_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* tear down the binding between this driver and the pci device */
DECL|function|goku_remove
r_static
r_void
id|goku_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* start with the driver above us */
r_if
c_cond
(paren
id|dev-&gt;driver
)paren
(brace
multiline_comment|/* should have been done already by driver model core */
id|WARN
c_func
(paren
id|dev
comma
l_string|&quot;pci remove, driver &squot;%s&squot; is still registered&bslash;n&quot;
comma
id|dev-&gt;driver-&gt;driver.name
)paren
suffix:semicolon
id|usb_gadget_unregister_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_USB_GADGET_DEBUG_FILES
id|remove_proc_entry
c_func
(paren
id|proc_node_name
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev-&gt;regs
)paren
id|udc_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;got_irq
)paren
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;regs
)paren
id|iounmap
c_func
(paren
id|dev-&gt;regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;got_region
)paren
id|release_mem_region
c_func
(paren
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;enabled
)paren
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|dev-&gt;gadget.dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|dev-&gt;regs
op_assign
l_int|NULL
suffix:semicolon
id|the_controller
op_assign
l_int|NULL
suffix:semicolon
id|INFO
c_func
(paren
id|dev
comma
l_string|&quot;unbind&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* wrap this driver around the specified pci device, but&n; * don&squot;t respond over USB until a gadget driver binds to us.&n; */
DECL|function|goku_probe
r_static
r_int
id|goku_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|goku_udc
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|resource
comma
id|len
suffix:semicolon
r_void
id|__iomem
op_star
id|base
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_char
id|buf
(braket
l_int|8
)braket
comma
op_star
id|bufp
suffix:semicolon
multiline_comment|/* if you want to support more than one controller in a system,&n;&t; * usb_gadget_driver_{register,unregister}() must change.&n;&t; */
r_if
c_cond
(paren
id|the_controller
)paren
(brace
id|WARN
c_func
(paren
id|dev
comma
l_string|&quot;ignoring %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdev-&gt;irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Check PCI %s IRQ setup!&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/* alloc, and start init */
id|dev
op_assign
id|kmalloc
(paren
r_sizeof
op_star
id|dev
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;enomem %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
op_star
id|dev
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|dev-&gt;gadget.ops
op_assign
op_amp
id|goku_ops
suffix:semicolon
multiline_comment|/* the &quot;gadget&quot; abstracts/virtualizes the controller */
id|strcpy
c_func
(paren
id|dev-&gt;gadget.dev.bus_id
comma
l_string|&quot;gadget&quot;
)paren
suffix:semicolon
id|dev-&gt;gadget.dev.parent
op_assign
op_amp
id|pdev-&gt;dev
suffix:semicolon
id|dev-&gt;gadget.dev.dma_mask
op_assign
id|pdev-&gt;dev.dma_mask
suffix:semicolon
id|dev-&gt;gadget.dev.release
op_assign
id|gadget_release
suffix:semicolon
id|dev-&gt;gadget.name
op_assign
id|driver_name
suffix:semicolon
multiline_comment|/* now all the pci goodies ... */
id|retval
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;can&squot;t enable, %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|dev-&gt;enabled
op_assign
l_int|1
suffix:semicolon
id|resource
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|len
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|resource
comma
id|len
comma
id|driver_name
)paren
)paren
(brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;controller already in use&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|dev-&gt;got_region
op_assign
l_int|1
suffix:semicolon
id|base
op_assign
id|ioremap_nocache
c_func
(paren
id|resource
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;can&squot;t map memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|dev-&gt;regs
op_assign
(paren
r_struct
id|goku_udc_regs
id|__iomem
op_star
)paren
id|base
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|INFO
c_func
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|driver_desc
)paren
suffix:semicolon
id|INFO
c_func
(paren
id|dev
comma
l_string|&quot;version: &quot;
id|DRIVER_VERSION
l_string|&quot; %s&bslash;n&quot;
comma
id|dmastr
c_func
(paren
)paren
)paren
suffix:semicolon
macro_line|#ifndef __sparc__
id|scnprintf
c_func
(paren
id|buf
comma
r_sizeof
id|buf
comma
l_string|&quot;%d&quot;
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|bufp
op_assign
id|buf
suffix:semicolon
macro_line|#else
id|bufp
op_assign
id|__irq_itoa
c_func
(paren
id|pdev-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
id|INFO
c_func
(paren
id|dev
comma
l_string|&quot;irq %s, pci mem %p&bslash;n&quot;
comma
id|bufp
comma
id|base
)paren
suffix:semicolon
multiline_comment|/* init to known state, then setup irqs */
id|udc_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|udc_reinit
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|goku_irq
comma
id|SA_SHIRQ
multiline_comment|/*|SA_SAMPLE_RANDOM*/
comma
id|driver_name
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|DBG
c_func
(paren
id|dev
comma
l_string|&quot;request interrupt %s failed&bslash;n&quot;
comma
id|bufp
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|dev-&gt;got_irq
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
)paren
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USB_GADGET_DEBUG_FILES
id|create_proc_read_entry
c_func
(paren
id|proc_node_name
comma
l_int|0
comma
l_int|NULL
comma
id|udc_proc_read
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* done */
id|the_controller
op_assign
id|dev
suffix:semicolon
id|device_register
c_func
(paren
op_amp
id|dev-&gt;gadget.dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|done
suffix:colon
r_if
c_cond
(paren
id|dev
)paren
id|goku_remove
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|pci_ids
r_static
r_struct
id|pci_device_id
id|pci_ids
(braket
)braket
op_assign
(brace
(brace
dot
r_class
op_assign
(paren
(paren
id|PCI_CLASS_SERIAL_USB
op_lshift
l_int|8
)paren
op_or
l_int|0xfe
)paren
comma
dot
id|class_mask
op_assign
op_complement
l_int|0
comma
dot
id|vendor
op_assign
l_int|0x102f
comma
multiline_comment|/* Toshiba */
dot
id|device
op_assign
l_int|0x0107
comma
multiline_comment|/* this UDC */
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|pci_ids
)paren
suffix:semicolon
DECL|variable|goku_pci_driver
r_static
r_struct
id|pci_driver
id|goku_pci_driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
id|driver_name
comma
dot
id|id_table
op_assign
id|pci_ids
comma
dot
id|probe
op_assign
id|goku_probe
comma
dot
id|remove
op_assign
id|goku_remove
comma
multiline_comment|/* FIXME add power management support */
)brace
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
(paren
r_void
)paren
(brace
r_return
id|pci_register_driver
(paren
op_amp
id|goku_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
(paren
id|init
)paren
suffix:semicolon
DECL|function|cleanup
r_static
r_void
id|__exit
id|cleanup
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|goku_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|cleanup
id|module_exit
(paren
id|cleanup
)paren
suffix:semicolon
eof
