multiline_comment|/*&n; * ether.c -- Ethernet gadget driver, with CDC and non-CDC options&n; *&n; * Copyright (C) 2003-2004 David Brownell&n; * Copyright (C) 2003-2004 Robert Schwebel, Benedikt Spranger&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
singleline_comment|// #define DEBUG 1
singleline_comment|// #define VERBOSE
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/uts.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &lt;linux/usb_ch9.h&gt;
macro_line|#include &lt;linux/usb_gadget.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &quot;gadget_chips.h&quot;
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/*&n; * Ethernet gadget driver -- with CDC and non-CDC options&n; *&n; * CDC Ethernet is the standard USB solution for sending Ethernet frames&n; * using USB.  Real hardware tends to use the same framing protocol but look&n; * different for control features.  This driver strongly prefers to use&n; * this USB-IF standard as its open-systems interoperability solution;&n; * most host side USB stacks (except from Microsoft) support it.&n; *&n; * There&squot;s some hardware that can&squot;t talk CDC.  We make that hardware&n; * implement a &quot;minimalist&quot; vendor-agnostic CDC core:  same framing, but&n; * link-level setup only requires activating the configuration.&n; * Linux supports it, but other host operating systems may not.&n; * (This is a subset of CDC Ethernet.)&n; *&n; * A third option is also in use.  Rather than CDC Ethernet, or something&n; * simpler, Microsoft pushes their own approach: RNDIS.  The published&n; * RNDIS specs are ambiguous and appear to be incomplete, and are also&n; * needlessly complex.&n; */
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&t;&quot;Ethernet Gadget&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&t;&quot;St Patrick&squot;s Day 2004&quot;
DECL|variable|shortname
r_static
r_const
r_char
id|shortname
(braket
)braket
op_assign
l_string|&quot;ether&quot;
suffix:semicolon
DECL|variable|driver_desc
r_static
r_const
r_char
id|driver_desc
(braket
)braket
op_assign
id|DRIVER_DESC
suffix:semicolon
DECL|macro|RX_EXTRA
mdefine_line|#define RX_EXTRA&t;20&t;&t;/* guard against rx overflows */
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
macro_line|#include &quot;rndis.h&quot;
macro_line|#else
DECL|macro|rndis_init
mdefine_line|#define rndis_init() 0
DECL|macro|rndis_exit
mdefine_line|#define rndis_exit() do{}while(0)
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|struct|eth_dev
r_struct
id|eth_dev
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|gadget
r_struct
id|usb_gadget
op_star
id|gadget
suffix:semicolon
DECL|member|req
r_struct
id|usb_request
op_star
id|req
suffix:semicolon
multiline_comment|/* for control responses */
DECL|member|config
id|u8
id|config
suffix:semicolon
DECL|member|in_ep
DECL|member|out_ep
DECL|member|status_ep
r_struct
id|usb_ep
op_star
id|in_ep
comma
op_star
id|out_ep
comma
op_star
id|status_ep
suffix:semicolon
r_const
r_struct
id|usb_endpoint_descriptor
DECL|member|in
DECL|member|out
DECL|member|status
op_star
id|in
comma
op_star
id|out
comma
op_star
id|status
suffix:semicolon
DECL|member|tx_reqs
DECL|member|rx_reqs
r_struct
id|list_head
id|tx_reqs
comma
id|rx_reqs
suffix:semicolon
DECL|member|net
r_struct
id|net_device
op_star
id|net
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_qlen
id|atomic_t
id|tx_qlen
suffix:semicolon
DECL|member|work
r_struct
id|work_struct
id|work
suffix:semicolon
DECL|member|zlp
r_int
id|zlp
suffix:colon
l_int|1
suffix:semicolon
DECL|member|cdc
r_int
id|cdc
suffix:colon
l_int|1
suffix:semicolon
DECL|member|rndis
r_int
id|rndis
suffix:colon
l_int|1
suffix:semicolon
DECL|member|cdc_filter
id|u16
id|cdc_filter
suffix:semicolon
DECL|member|todo
r_int
r_int
id|todo
suffix:semicolon
DECL|macro|WORK_RX_MEMORY
mdefine_line|#define&t;WORK_RX_MEMORY&t;&t;0
DECL|member|rndis_config
r_int
id|rndis_config
suffix:semicolon
DECL|member|host_mac
id|u8
id|host_mac
(braket
id|ETH_ALEN
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* This version autoconfigures as much as possible at run-time.&n; *&n; * It also ASSUMES a self-powered device, without remote wakeup,&n; * although remote wakeup support would make sense.&n; */
DECL|variable|EP_IN_NAME
r_static
r_const
r_char
op_star
id|EP_IN_NAME
suffix:semicolon
DECL|variable|EP_OUT_NAME
r_static
r_const
r_char
op_star
id|EP_OUT_NAME
suffix:semicolon
DECL|variable|EP_STATUS_NAME
r_static
r_const
r_char
op_star
id|EP_STATUS_NAME
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* DO NOT REUSE THESE IDs with a protocol-incompatible driver!!  Ever!!&n; * Instead:  allocate your own, using normal USB-IF procedures.&n; */
multiline_comment|/* Thanks to NetChip Technologies for donating this product ID.&n; * It&squot;s for devices with only CDC Ethernet configurations.&n; */
DECL|macro|CDC_VENDOR_NUM
mdefine_line|#define CDC_VENDOR_NUM&t;0x0525&t;&t;/* NetChip */
DECL|macro|CDC_PRODUCT_NUM
mdefine_line|#define CDC_PRODUCT_NUM&t;0xa4a1&t;&t;/* Linux-USB Ethernet Gadget */
multiline_comment|/* For hardware that can&squot;t talk CDC, we use the same vendor ID that&n; * ARM Linux has used for ethernet-over-usb, both with sa1100 and&n; * with pxa250.  We&squot;re protocol-compatible, if the host-side drivers&n; * use the endpoint descriptors.  bcdDevice (version) is nonzero, so&n; * drivers that need to hard-wire endpoint numbers have a hook.&n; *&n; * The protocol is a minimal subset of CDC Ether, which works on any bulk&n; * hardware that&squot;s not deeply broken ... even on hardware that can&squot;t talk&n; * RNDIS (like SA-1100, with no interrupt endpoint, or anything that&n; * doesn&squot;t handle control-OUT).&n; */
DECL|macro|SIMPLE_VENDOR_NUM
mdefine_line|#define&t;SIMPLE_VENDOR_NUM&t;0x049f
DECL|macro|SIMPLE_PRODUCT_NUM
mdefine_line|#define&t;SIMPLE_PRODUCT_NUM&t;0x505a
multiline_comment|/* For hardware that can talk RNDIS and either of the above protocols,&n; * use this ID ... the windows INF files will know it.  Unless it&squot;s&n; * used with CDC Ethernet, Linux 2.4 hosts will need updates to choose&n; * the non-RNDIS configuration.&n; */
DECL|macro|RNDIS_VENDOR_NUM
mdefine_line|#define RNDIS_VENDOR_NUM&t;0x0525&t;/* NetChip */
DECL|macro|RNDIS_PRODUCT_NUM
mdefine_line|#define RNDIS_PRODUCT_NUM&t;0xa4a2&t;/* Ethernet/RNDIS Gadget */
multiline_comment|/* Some systems will want different product identifers published in the&n; * device descriptor, either numbers or strings or both.  These string&n; * parameters are in UTF-8 (superset of ASCII&squot;s 7 bit characters).&n; */
DECL|variable|idVendor
r_static
id|ushort
id|__initdata
id|idVendor
suffix:semicolon
id|module_param
c_func
(paren
id|idVendor
comma
id|ushort
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|idVendor
comma
l_string|&quot;USB Vendor ID&quot;
)paren
suffix:semicolon
DECL|variable|idProduct
r_static
id|ushort
id|__initdata
id|idProduct
suffix:semicolon
id|module_param
c_func
(paren
id|idProduct
comma
id|ushort
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|idProduct
comma
l_string|&quot;USB Product ID&quot;
)paren
suffix:semicolon
DECL|variable|bcdDevice
r_static
id|ushort
id|__initdata
id|bcdDevice
suffix:semicolon
id|module_param
c_func
(paren
id|bcdDevice
comma
id|ushort
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|bcdDevice
comma
l_string|&quot;USB Device version (BCD)&quot;
)paren
suffix:semicolon
DECL|variable|iManufacturer
r_static
r_char
op_star
id|__initdata
id|iManufacturer
suffix:semicolon
id|module_param
c_func
(paren
id|iManufacturer
comma
id|charp
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|iManufacturer
comma
l_string|&quot;USB Manufacturer string&quot;
)paren
suffix:semicolon
DECL|variable|iProduct
r_static
r_char
op_star
id|__initdata
id|iProduct
suffix:semicolon
id|module_param
c_func
(paren
id|iProduct
comma
id|charp
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|iProduct
comma
l_string|&quot;USB Product string&quot;
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Include CDC support if we could run on CDC-capable hardware. */
macro_line|#ifdef CONFIG_USB_GADGET_NET2280
DECL|macro|DEV_CONFIG_CDC
mdefine_line|#define&t;DEV_CONFIG_CDC
macro_line|#endif
macro_line|#ifdef CONFIG_USB_GADGET_DUMMY_HCD
DECL|macro|DEV_CONFIG_CDC
mdefine_line|#define&t;DEV_CONFIG_CDC
macro_line|#endif
macro_line|#ifdef CONFIG_USB_GADGET_GOKU
DECL|macro|DEV_CONFIG_CDC
mdefine_line|#define&t;DEV_CONFIG_CDC
macro_line|#endif
macro_line|#ifdef CONFIG_USB_GADGET_MQ11XX
DECL|macro|DEV_CONFIG_CDC
mdefine_line|#define&t;DEV_CONFIG_CDC
macro_line|#endif
macro_line|#ifdef CONFIG_USB_GADGET_OMAP
DECL|macro|DEV_CONFIG_CDC
mdefine_line|#define&t;DEV_CONFIG_CDC
macro_line|#endif
multiline_comment|/* For CDC-incapable hardware, choose the simple cdc subset.&n; * Anything that talks bulk (without notable bugs) can do this.&n; */
macro_line|#ifdef CONFIG_USB_GADGET_PXA
DECL|macro|DEV_CONFIG_SUBSET
mdefine_line|#define&t;DEV_CONFIG_SUBSET
macro_line|#endif
macro_line|#ifdef CONFIG_USB_GADGET_SH
DECL|macro|DEV_CONFIG_SUBSET
mdefine_line|#define&t;DEV_CONFIG_SUBSET
macro_line|#endif
macro_line|#ifdef CONFIG_USB_GADGET_SA1100
multiline_comment|/* use non-CDC for backwards compatibility */
DECL|macro|DEV_CONFIG_SUBSET
mdefine_line|#define&t;DEV_CONFIG_SUBSET
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|DEFAULT_QLEN
mdefine_line|#define DEFAULT_QLEN&t;2&t;/* double buffering by default */
macro_line|#ifdef CONFIG_USB_GADGET_DUALSPEED
DECL|variable|qmult
r_static
r_int
id|qmult
op_assign
l_int|5
suffix:semicolon
id|module_param
(paren
id|qmult
comma
id|uint
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
multiline_comment|/* for dual-speed hardware, use deeper queues at highspeed */
DECL|macro|qlen
mdefine_line|#define qlen(gadget) &bslash;&n;&t;(DEFAULT_QLEN*((gadget-&gt;speed == USB_SPEED_HIGH) ? qmult : 1))
multiline_comment|/* also defer IRQs on highspeed TX */
DECL|macro|TX_DELAY
mdefine_line|#define TX_DELAY&t;qmult
DECL|macro|BITRATE
mdefine_line|#define&t;BITRATE(g) ((g-&gt;speed == USB_SPEED_HIGH) ? 4800000 : 120000)
macro_line|#else&t;/* full speed (low speed doesn&squot;t do bulk) */
DECL|macro|qlen
mdefine_line|#define qlen(gadget) DEFAULT_QLEN
DECL|macro|BITRATE
mdefine_line|#define&t;BITRATE(g)&t;(12000)
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|xprintk
mdefine_line|#define xprintk(d,level,fmt,args...) &bslash;&n;&t;printk(level &quot;%s: &quot; fmt , (d)-&gt;net-&gt;name , ## args)
macro_line|#ifdef DEBUG
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG(dev,fmt,args...) &bslash;&n;&t;xprintk(dev , KERN_DEBUG , fmt , ## args)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(dev,fmt,args...) &bslash;&n;&t;do { } while (0)
macro_line|#endif /* DEBUG */
macro_line|#ifdef VERBOSE
DECL|macro|VDEBUG
mdefine_line|#define VDEBUG&t;DEBUG
macro_line|#else
DECL|macro|VDEBUG
mdefine_line|#define VDEBUG(dev,fmt,args...) &bslash;&n;&t;do { } while (0)
macro_line|#endif /* DEBUG */
DECL|macro|ERROR
mdefine_line|#define ERROR(dev,fmt,args...) &bslash;&n;&t;xprintk(dev , KERN_ERR , fmt , ## args)
DECL|macro|WARN
mdefine_line|#define WARN(dev,fmt,args...) &bslash;&n;&t;xprintk(dev , KERN_WARNING , fmt , ## args)
DECL|macro|INFO
mdefine_line|#define INFO(dev,fmt,args...) &bslash;&n;&t;xprintk(dev , KERN_INFO , fmt , ## args)
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* USB DRIVER HOOKUP (to the hardware driver, below us), mostly&n; * ep0 implementation:  descriptors, config management, setup().&n; * also optional class-specific notification interrupt transfer.&n; */
multiline_comment|/*&n; * DESCRIPTORS ... most are static, but strings and (full) configuration&n; * descriptors are built on demand.  For now we do either full CDC, or&n; * our simple subset, with RNDIS as an optional second configuration.&n; *&n; * RNDIS includes some CDC ACM descriptors ... like CDC Ethernet.  But&n; * the class descriptors match a modem (they&squot;re ignored; it&squot;s really just&n; * Ethernet functionality), they don&squot;t need the NOP altsetting, and the&n; * status transfer endpoint isn&squot;t optional.&n; */
DECL|macro|STRING_MANUFACTURER
mdefine_line|#define STRING_MANUFACTURER&t;&t;1
DECL|macro|STRING_PRODUCT
mdefine_line|#define STRING_PRODUCT&t;&t;&t;2
DECL|macro|STRING_ETHADDR
mdefine_line|#define STRING_ETHADDR&t;&t;&t;3
DECL|macro|STRING_DATA
mdefine_line|#define STRING_DATA&t;&t;&t;4
DECL|macro|STRING_CONTROL
mdefine_line|#define STRING_CONTROL&t;&t;&t;5
DECL|macro|STRING_RNDIS_CONTROL
mdefine_line|#define STRING_RNDIS_CONTROL&t;&t;6
DECL|macro|STRING_CDC
mdefine_line|#define STRING_CDC&t;&t;&t;7
DECL|macro|STRING_SUBSET
mdefine_line|#define STRING_SUBSET&t;&t;&t;8
DECL|macro|STRING_RNDIS
mdefine_line|#define STRING_RNDIS&t;&t;&t;9
DECL|macro|USB_BUFSIZ
mdefine_line|#define USB_BUFSIZ&t;256&t;&t;/* holds our biggest descriptor */
multiline_comment|/*&n; * This device advertises one configuration, eth_config, unless RNDIS&n; * is enabled (rndis_config) on hardware supporting at least two configs.&n; *&n; * NOTE:  Controllers like superh_udc should probably be able to use&n; * an RNDIS-only configuration.&n; */
DECL|macro|DEV_CONFIG_VALUE
mdefine_line|#define DEV_CONFIG_VALUE&t;1&t;/* cdc or subset */
DECL|macro|DEV_RNDIS_CONFIG_VALUE
mdefine_line|#define DEV_RNDIS_CONFIG_VALUE&t;2&t;/* rndis; optional */
r_static
r_struct
id|usb_device_descriptor
DECL|variable|device_desc
id|device_desc
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|device_desc
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_DEVICE
comma
dot
id|bcdUSB
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0200
)paren
comma
dot
id|bDeviceClass
op_assign
id|USB_CLASS_COMM
comma
dot
id|bDeviceSubClass
op_assign
l_int|0
comma
dot
id|bDeviceProtocol
op_assign
l_int|0
comma
dot
id|idVendor
op_assign
id|__constant_cpu_to_le16
(paren
id|CDC_VENDOR_NUM
)paren
comma
dot
id|idProduct
op_assign
id|__constant_cpu_to_le16
(paren
id|CDC_PRODUCT_NUM
)paren
comma
dot
id|iManufacturer
op_assign
id|STRING_MANUFACTURER
comma
dot
id|iProduct
op_assign
id|STRING_PRODUCT
comma
dot
id|bNumConfigurations
op_assign
l_int|1
comma
)brace
suffix:semicolon
r_static
r_struct
id|usb_config_descriptor
DECL|variable|eth_config
id|eth_config
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|eth_config
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_CONFIG
comma
multiline_comment|/* compute wTotalLength on the fly */
dot
id|bNumInterfaces
op_assign
l_int|2
comma
dot
id|bConfigurationValue
op_assign
id|DEV_CONFIG_VALUE
comma
dot
id|iConfiguration
op_assign
id|STRING_CDC
comma
dot
id|bmAttributes
op_assign
id|USB_CONFIG_ATT_ONE
op_or
id|USB_CONFIG_ATT_SELFPOWER
comma
dot
id|bMaxPower
op_assign
l_int|1
comma
)brace
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
r_static
r_const
r_struct
id|usb_config_descriptor
DECL|variable|rndis_config
id|rndis_config
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|rndis_config
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_CONFIG
comma
multiline_comment|/* compute wTotalLength on the fly */
dot
id|bNumInterfaces
op_assign
l_int|2
comma
dot
id|bConfigurationValue
op_assign
id|DEV_RNDIS_CONFIG_VALUE
comma
dot
id|iConfiguration
op_assign
id|STRING_RNDIS
comma
dot
id|bmAttributes
op_assign
id|USB_CONFIG_ATT_ONE
op_or
id|USB_CONFIG_ATT_SELFPOWER
comma
dot
id|bMaxPower
op_assign
l_int|1
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Compared to the simple CDC subset, the full CDC Ethernet model adds&n; * three class descriptors, two interface descriptors, optional status&n; * endpoint.  Both have a &quot;data&quot; interface and two bulk endpoints.&n; * There are also differences in how control requests are handled.&n; *&n; * RNDIS shares a lot with CDC-Ethernet, since it&squot;s a variant of&n; * the CDC-ACM (modem) spec.&n; */
macro_line|#ifdef&t;DEV_CONFIG_CDC
r_static
r_struct
id|usb_interface_descriptor
DECL|variable|control_intf
id|control_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|control_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|0
comma
multiline_comment|/* status endpoint is optional; this may be patched later */
dot
id|bNumEndpoints
op_assign
l_int|1
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_COMM
comma
dot
id|bInterfaceSubClass
op_assign
l_int|6
comma
multiline_comment|/* ethernet control model */
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
dot
id|iInterface
op_assign
id|STRING_CONTROL
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|rndis_control_intf
id|rndis_control_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|rndis_control_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|0
comma
dot
id|bNumEndpoints
op_assign
l_int|1
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_COMM
comma
dot
id|bInterfaceSubClass
op_assign
l_int|2
comma
multiline_comment|/* abstract control model */
dot
id|bInterfaceProtocol
op_assign
l_int|0xff
comma
multiline_comment|/* vendor specific */
dot
id|iInterface
op_assign
id|STRING_RNDIS_CONTROL
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if defined(DEV_CONFIG_CDC) || defined(CONFIG_USB_ETH_RNDIS)
multiline_comment|/* &quot;Header Functional Descriptor&quot; from CDC spec  5.2.3.1 */
DECL|struct|header_desc
r_struct
id|header_desc
(brace
DECL|member|bLength
id|u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubType
id|u8
id|bDescriptorSubType
suffix:semicolon
DECL|member|bcdCDC
id|u16
id|bcdCDC
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|header_desc
r_static
r_const
r_struct
id|header_desc
id|header_desc
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|header_desc
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_CS_INTERFACE
comma
dot
id|bDescriptorSubType
op_assign
l_int|0
comma
dot
id|bcdCDC
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0110
)paren
comma
)brace
suffix:semicolon
multiline_comment|/* &quot;Union Functional Descriptor&quot; from CDC spec 5.2.3.8 */
DECL|struct|union_desc
r_struct
id|union_desc
(brace
DECL|member|bLength
id|u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubType
id|u8
id|bDescriptorSubType
suffix:semicolon
DECL|member|bMasterInterface0
id|u8
id|bMasterInterface0
suffix:semicolon
DECL|member|bSlaveInterface0
id|u8
id|bSlaveInterface0
suffix:semicolon
multiline_comment|/* ... and there could be other slave interfaces */
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|union_desc
r_static
r_const
r_struct
id|union_desc
id|union_desc
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|union_desc
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_CS_INTERFACE
comma
dot
id|bDescriptorSubType
op_assign
l_int|6
comma
dot
id|bMasterInterface0
op_assign
l_int|0
comma
multiline_comment|/* index of control interface */
dot
id|bSlaveInterface0
op_assign
l_int|1
comma
multiline_comment|/* index of DATA interface */
)brace
suffix:semicolon
macro_line|#endif&t;/* CDC || RNDIS */
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
multiline_comment|/* &quot;Call Management Descriptor&quot; from CDC spec  5.2.3.3 */
DECL|struct|call_mgmt_descriptor
r_struct
id|call_mgmt_descriptor
(brace
DECL|member|bLength
id|u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubType
id|u8
id|bDescriptorSubType
suffix:semicolon
DECL|member|bmCapabilities
id|u8
id|bmCapabilities
suffix:semicolon
DECL|member|bDataInterface
id|u8
id|bDataInterface
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|call_mgmt_descriptor
r_static
r_const
r_struct
id|call_mgmt_descriptor
id|call_mgmt_descriptor
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|call_mgmt_descriptor
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_CS_INTERFACE
comma
dot
id|bDescriptorSubType
op_assign
l_int|0x01
comma
dot
id|bmCapabilities
op_assign
l_int|0x00
comma
dot
id|bDataInterface
op_assign
l_int|0x01
comma
)brace
suffix:semicolon
multiline_comment|/* &quot;Abstract Control Management Descriptor&quot; from CDC spec  5.2.3.4 */
DECL|struct|acm_descriptor
r_struct
id|acm_descriptor
(brace
DECL|member|bLength
id|u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubType
id|u8
id|bDescriptorSubType
suffix:semicolon
DECL|member|bmCapabilities
id|u8
id|bmCapabilities
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|acm_descriptor
r_static
r_struct
id|acm_descriptor
id|acm_descriptor
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|acm_descriptor
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_CS_INTERFACE
comma
dot
id|bDescriptorSubType
op_assign
l_int|0x02
comma
dot
id|bmCapabilities
op_assign
l_int|0X00
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;DEV_CONFIG_CDC
multiline_comment|/* &quot;Ethernet Networking Functional Descriptor&quot; from CDC spec 5.2.3.16 */
DECL|struct|ether_desc
r_struct
id|ether_desc
(brace
DECL|member|bLength
id|u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubType
id|u8
id|bDescriptorSubType
suffix:semicolon
DECL|member|iMACAddress
id|u8
id|iMACAddress
suffix:semicolon
DECL|member|bmEthernetStatistics
id|u32
id|bmEthernetStatistics
suffix:semicolon
DECL|member|wMaxSegmentSize
id|u16
id|wMaxSegmentSize
suffix:semicolon
DECL|member|wNumberMCFilters
id|u16
id|wNumberMCFilters
suffix:semicolon
DECL|member|bNumberPowerFilters
id|u8
id|bNumberPowerFilters
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|ether_desc
r_static
r_const
r_struct
id|ether_desc
id|ether_desc
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|ether_desc
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_CS_INTERFACE
comma
dot
id|bDescriptorSubType
op_assign
l_int|0x0f
comma
multiline_comment|/* this descriptor actually adds value, surprise! */
dot
id|iMACAddress
op_assign
id|STRING_ETHADDR
comma
dot
id|bmEthernetStatistics
op_assign
id|__constant_cpu_to_le32
(paren
l_int|0
)paren
comma
multiline_comment|/* no statistics */
dot
id|wMaxSegmentSize
op_assign
id|__constant_cpu_to_le16
(paren
id|ETH_FRAME_LEN
)paren
comma
dot
id|wNumberMCFilters
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0
)paren
comma
dot
id|bNumberPowerFilters
op_assign
l_int|0
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if defined(DEV_CONFIG_CDC) || defined(CONFIG_USB_ETH_RNDIS)
multiline_comment|/* include the status endpoint if we can, even where it&squot;s optional.&n; * use small wMaxPacketSize, since many &quot;interrupt&quot; endpoints have&n; * very small fifos and it&squot;s no big deal if CDC_NOTIFY_SPEED_CHANGE&n; * takes two packets.  also default to a big transfer interval, to&n; * waste less bandwidth.&n; *&n; * some drivers (like Linux 2.4 cdc-ether!) &quot;need&quot; it to exist even&n; * if they ignore the connect/disconnect notifications that real aether&n; * can provide.  more advanced cdc configurations might want to support&n; * encapsulated commands (vendor-specific, using control-OUT).&n; *&n; * RNDIS requires the status endpoint, since it uses that encapsulation&n; * mechanism for its funky RPC scheme.&n; */
DECL|macro|LOG2_STATUS_INTERVAL_MSEC
mdefine_line|#define LOG2_STATUS_INTERVAL_MSEC&t;5&t;/* 1 &lt;&lt; 5 == 32 msec */
DECL|macro|STATUS_BYTECOUNT
mdefine_line|#define STATUS_BYTECOUNT&t;&t;8&t;/* 8 byte header + data */
r_static
r_struct
id|usb_endpoint_descriptor
DECL|variable|fs_status_desc
id|fs_status_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|USB_DIR_IN
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_INT
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
id|STATUS_BYTECOUNT
)paren
comma
dot
id|bInterval
op_assign
l_int|1
op_lshift
id|LOG2_STATUS_INTERVAL_MSEC
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;DEV_CONFIG_CDC
multiline_comment|/* the default data interface has no endpoints ... */
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|data_nop_intf
id|data_nop_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|data_nop_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|1
comma
dot
id|bAlternateSetting
op_assign
l_int|0
comma
dot
id|bNumEndpoints
op_assign
l_int|0
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_CDC_DATA
comma
dot
id|bInterfaceSubClass
op_assign
l_int|0
comma
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* ... but the &quot;real&quot; data interface has two bulk endpoints */
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|data_intf
id|data_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|data_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|1
comma
dot
id|bAlternateSetting
op_assign
l_int|1
comma
dot
id|bNumEndpoints
op_assign
l_int|2
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_CDC_DATA
comma
dot
id|bInterfaceSubClass
op_assign
l_int|0
comma
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
dot
id|iInterface
op_assign
id|STRING_DATA
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
multiline_comment|/* RNDIS doesn&squot;t activate by changing to the &quot;real&quot; altsetting */
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|rndis_data_intf
id|rndis_data_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|rndis_data_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|1
comma
dot
id|bAlternateSetting
op_assign
l_int|0
comma
dot
id|bNumEndpoints
op_assign
l_int|2
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_CDC_DATA
comma
dot
id|bInterfaceSubClass
op_assign
l_int|0
comma
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
dot
id|iInterface
op_assign
id|STRING_DATA
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEV_CONFIG_SUBSET
multiline_comment|/*&n; * &quot;Simple&quot; CDC-subset option is a simple vendor-neutral model that most&n; * full speed controllers can handle:  one interface, two bulk endpoints.&n; */
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|subset_data_intf
id|subset_data_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|subset_data_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|0
comma
dot
id|bAlternateSetting
op_assign
l_int|0
comma
dot
id|bNumEndpoints
op_assign
l_int|2
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_VENDOR_SPEC
comma
dot
id|bInterfaceSubClass
op_assign
l_int|0
comma
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
dot
id|iInterface
op_assign
id|STRING_DATA
comma
)brace
suffix:semicolon
macro_line|#endif&t;/* SUBSET */
r_static
r_struct
id|usb_endpoint_descriptor
DECL|variable|fs_source_desc
id|fs_source_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|USB_DIR_IN
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
)brace
suffix:semicolon
r_static
r_struct
id|usb_endpoint_descriptor
DECL|variable|fs_sink_desc
id|fs_sink_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|USB_DIR_OUT
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
)brace
suffix:semicolon
DECL|variable|fs_eth_function
r_static
r_const
r_struct
id|usb_descriptor_header
op_star
id|fs_eth_function
(braket
l_int|10
)braket
op_assign
(brace
macro_line|#ifdef DEV_CONFIG_CDC
multiline_comment|/* &quot;cdc&quot; mode descriptors */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|control_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|header_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|union_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|ether_desc
comma
multiline_comment|/* NOTE: status endpoint may need to be removed */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_status_desc
comma
multiline_comment|/* data interface, with altsetting */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|data_nop_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|data_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_source_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_sink_desc
comma
l_int|0
comma
macro_line|#endif /* DEV_CONFIG_CDC */
)brace
suffix:semicolon
DECL|function|fs_subset_descriptors
r_static
r_inline
r_void
id|__init
id|fs_subset_descriptors
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef DEV_CONFIG_SUBSET
id|fs_eth_function
(braket
l_int|0
)braket
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|subset_data_intf
suffix:semicolon
id|fs_eth_function
(braket
l_int|1
)braket
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_source_desc
suffix:semicolon
id|fs_eth_function
(braket
l_int|2
)braket
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_sink_desc
suffix:semicolon
id|fs_eth_function
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#else
id|fs_eth_function
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
DECL|variable|fs_rndis_function
r_static
r_const
r_struct
id|usb_descriptor_header
op_star
id|fs_rndis_function
(braket
)braket
op_assign
(brace
multiline_comment|/* control interface matches ACM, not Ethernet */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|rndis_control_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|header_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|call_mgmt_descriptor
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|acm_descriptor
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|union_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_status_desc
comma
multiline_comment|/* data interface has no altsetting */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|rndis_data_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_source_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_sink_desc
comma
l_int|0
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;CONFIG_USB_GADGET_DUALSPEED
multiline_comment|/*&n; * usb 2.0 devices need to expose both high speed and full speed&n; * descriptors, unless they only run at full speed.&n; */
macro_line|#if defined(DEV_CONFIG_CDC) || defined(CONFIG_USB_ETH_RNDIS)
r_static
r_struct
id|usb_endpoint_descriptor
DECL|variable|hs_status_desc
id|hs_status_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_INT
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
id|STATUS_BYTECOUNT
)paren
comma
dot
id|bInterval
op_assign
id|LOG2_STATUS_INTERVAL_MSEC
op_plus
l_int|4
comma
)brace
suffix:semicolon
macro_line|#endif /* DEV_CONFIG_CDC */
r_static
r_struct
id|usb_endpoint_descriptor
DECL|variable|hs_source_desc
id|hs_source_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
l_int|512
)paren
comma
)brace
suffix:semicolon
r_static
r_struct
id|usb_endpoint_descriptor
DECL|variable|hs_sink_desc
id|hs_sink_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
l_int|512
)paren
comma
)brace
suffix:semicolon
r_static
r_struct
id|usb_qualifier_descriptor
DECL|variable|dev_qualifier
id|dev_qualifier
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|dev_qualifier
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_DEVICE_QUALIFIER
comma
dot
id|bcdUSB
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0200
)paren
comma
dot
id|bDeviceClass
op_assign
id|USB_CLASS_COMM
comma
dot
id|bNumConfigurations
op_assign
l_int|1
comma
)brace
suffix:semicolon
DECL|variable|hs_eth_function
r_static
r_const
r_struct
id|usb_descriptor_header
op_star
id|hs_eth_function
(braket
l_int|10
)braket
op_assign
(brace
macro_line|#ifdef DEV_CONFIG_CDC
multiline_comment|/* &quot;cdc&quot; mode descriptors */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|control_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|header_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|union_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|ether_desc
comma
multiline_comment|/* NOTE: status endpoint may need to be removed */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|hs_status_desc
comma
multiline_comment|/* data interface, with altsetting */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|data_nop_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|data_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|hs_source_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|hs_sink_desc
comma
l_int|0
comma
macro_line|#endif /* DEV_CONFIG_CDC */
)brace
suffix:semicolon
DECL|function|hs_subset_descriptors
r_static
r_inline
r_void
id|__init
id|hs_subset_descriptors
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef DEV_CONFIG_SUBSET
id|hs_eth_function
(braket
l_int|0
)braket
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|subset_data_intf
suffix:semicolon
id|hs_eth_function
(braket
l_int|1
)braket
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_source_desc
suffix:semicolon
id|hs_eth_function
(braket
l_int|2
)braket
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|fs_sink_desc
suffix:semicolon
id|hs_eth_function
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#else
id|hs_eth_function
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
DECL|variable|hs_rndis_function
r_static
r_const
r_struct
id|usb_descriptor_header
op_star
id|hs_rndis_function
(braket
)braket
op_assign
(brace
multiline_comment|/* control interface matches ACM, not Ethernet */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|rndis_control_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|header_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|call_mgmt_descriptor
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|acm_descriptor
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|union_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|hs_status_desc
comma
multiline_comment|/* data interface has no altsetting */
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|rndis_data_intf
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|hs_source_desc
comma
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
op_amp
id|hs_sink_desc
comma
l_int|0
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* maxpacket and other transfer characteristics vary by speed. */
DECL|macro|ep_desc
mdefine_line|#define ep_desc(g,hs,fs) (((g)-&gt;speed==USB_SPEED_HIGH)?(hs):(fs))
macro_line|#else
multiline_comment|/* if there&squot;s no high speed support, maxpacket doesn&squot;t change. */
DECL|macro|ep_desc
mdefine_line|#define ep_desc(g,hs,fs) fs
DECL|function|hs_subset_descriptors
r_static
r_inline
r_void
id|__init
id|hs_subset_descriptors
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif&t;/* !CONFIG_USB_GADGET_DUALSPEED */
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* descriptors that are built on-demand */
DECL|variable|manufacturer
r_static
r_char
id|manufacturer
(braket
l_int|40
)braket
suffix:semicolon
DECL|variable|product_desc
r_static
r_char
id|product_desc
(braket
l_int|40
)braket
op_assign
id|DRIVER_DESC
suffix:semicolon
macro_line|#ifdef&t;DEV_CONFIG_CDC
multiline_comment|/* address that the host will use ... usually assigned at random */
DECL|variable|ethaddr
r_static
r_char
id|ethaddr
(braket
l_int|2
op_star
id|ETH_ALEN
op_plus
l_int|1
)braket
suffix:semicolon
macro_line|#endif
multiline_comment|/* static strings, in iso 8859/1 */
DECL|variable|strings
r_static
r_struct
id|usb_string
id|strings
(braket
)braket
op_assign
(brace
(brace
id|STRING_MANUFACTURER
comma
id|manufacturer
comma
)brace
comma
(brace
id|STRING_PRODUCT
comma
id|product_desc
comma
)brace
comma
(brace
id|STRING_DATA
comma
l_string|&quot;Ethernet Data&quot;
comma
)brace
comma
macro_line|#ifdef&t;DEV_CONFIG_CDC
(brace
id|STRING_CDC
comma
l_string|&quot;CDC Ethernet&quot;
comma
)brace
comma
(brace
id|STRING_ETHADDR
comma
id|ethaddr
comma
)brace
comma
(brace
id|STRING_CONTROL
comma
l_string|&quot;CDC Communications Control&quot;
comma
)brace
comma
macro_line|#endif
macro_line|#ifdef&t;DEV_CONFIG_SUBSET
(brace
id|STRING_SUBSET
comma
l_string|&quot;CDC Ethernet Subset&quot;
comma
)brace
comma
macro_line|#endif
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
(brace
id|STRING_RNDIS
comma
l_string|&quot;RNDIS&quot;
comma
)brace
comma
(brace
id|STRING_RNDIS_CONTROL
comma
l_string|&quot;RNDIS Communications Control&quot;
comma
)brace
comma
macro_line|#endif
(brace
)brace
multiline_comment|/* end of list */
)brace
suffix:semicolon
DECL|variable|stringtab
r_static
r_struct
id|usb_gadget_strings
id|stringtab
op_assign
(brace
dot
id|language
op_assign
l_int|0x0409
comma
multiline_comment|/* en-us */
dot
id|strings
op_assign
id|strings
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * one config, two interfaces:  control, data.&n; * complications: class descriptors, and an altsetting.&n; */
r_static
r_int
DECL|function|config_buf
id|config_buf
(paren
r_enum
id|usb_device_speed
id|speed
comma
id|u8
op_star
id|buf
comma
id|u8
id|type
comma
r_int
id|index
)paren
(brace
r_int
id|len
suffix:semicolon
macro_line|#ifdef CONFIG_USB_GADGET_DUALSPEED
r_int
id|hs
op_assign
(paren
id|speed
op_eq
id|USB_SPEED_HIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|USB_DT_OTHER_SPEED_CONFIG
)paren
id|hs
op_assign
op_logical_neg
id|hs
suffix:semicolon
DECL|macro|which_config
mdefine_line|#define which_config(t)&t;(hs ? &amp; t ## _config   : &amp; t ## _config)
DECL|macro|which_fn
mdefine_line|#define which_fn(t)&t;(hs ? &amp; hs_ ## t ## _function : &amp; fs_ ## t ## _function)
macro_line|#else
mdefine_line|#define&t;which_config(t)&t;(&amp; t ## _config)
mdefine_line|#define&t;which_fn(t)&t;(&amp; fs_ ## t ## _function)
macro_line|#endif
r_if
c_cond
(paren
id|index
op_ge
id|device_desc.bNumConfigurations
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
multiline_comment|/* list the RNDIS config first, to make Microsoft&squot;s drivers&n;&t; * happy. DOCSIS 1.0 needs this too.&n;&t; */
r_if
c_cond
(paren
id|device_desc.bNumConfigurations
op_eq
l_int|2
op_logical_and
id|index
op_eq
l_int|0
)paren
id|len
op_assign
id|usb_gadget_config_buf
(paren
id|which_config
(paren
id|rndis
)paren
comma
id|buf
comma
id|USB_BUFSIZ
comma
(paren
r_const
r_struct
id|usb_descriptor_header
op_star
op_star
)paren
id|which_fn
(paren
id|rndis
)paren
)paren
suffix:semicolon
r_else
macro_line|#endif
id|len
op_assign
id|usb_gadget_config_buf
(paren
id|which_config
(paren
id|eth
)paren
comma
id|buf
comma
id|USB_BUFSIZ
comma
(paren
r_const
r_struct
id|usb_descriptor_header
op_star
op_star
)paren
id|which_fn
(paren
id|eth
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_return
id|len
suffix:semicolon
(paren
(paren
r_struct
id|usb_config_descriptor
op_star
)paren
id|buf
)paren
op_member_access_from_pointer
id|bDescriptorType
op_assign
id|type
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
id|eth_start
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|gfp_flags
)paren
suffix:semicolon
r_static
r_int
id|alloc_requests
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|n
comma
r_int
id|gfp_flags
)paren
suffix:semicolon
macro_line|#ifdef&t;DEV_CONFIG_CDC
DECL|function|ether_alt_ep_setup
r_static
r_inline
r_int
id|ether_alt_ep_setup
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_struct
id|usb_ep
op_star
id|ep
)paren
(brace
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|d
suffix:semicolon
multiline_comment|/* With CDC,  the host isn&squot;t allowed to use these two data&n;&t; * endpoints in the default altsetting for the interface.&n;&t; * so we don&squot;t activate them yet.  Reset from SET_INTERFACE.&n;&t; *&n;&t; * Strictly speaking RNDIS should work the same: activation is&n;&t; * a side effect of setting a packet filter.  Deactivation is&n;&t; * from REMOTE_NDIS_HALT_MSG, reset from REMOTE_NDIS_RESET_MSG.&n;&t; */
multiline_comment|/* one endpoint writes data back IN to the host */
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_IN_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|dev-&gt;gadget
comma
op_amp
id|hs_source_desc
comma
op_amp
id|fs_source_desc
)paren
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;in_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;in
op_assign
id|d
suffix:semicolon
multiline_comment|/* one endpoint just reads OUT packets */
)brace
r_else
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_OUT_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|dev-&gt;gadget
comma
op_amp
id|hs_sink_desc
comma
op_amp
id|fs_sink_desc
)paren
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;out_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;out
op_assign
id|d
suffix:semicolon
multiline_comment|/* optional status/notification endpoint */
)brace
r_else
r_if
c_cond
(paren
id|EP_STATUS_NAME
op_logical_and
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_STATUS_NAME
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|result
suffix:semicolon
id|d
op_assign
id|ep_desc
(paren
id|dev-&gt;gadget
comma
op_amp
id|hs_status_desc
comma
op_amp
id|fs_status_desc
)paren
suffix:semicolon
id|result
op_assign
id|usb_ep_enable
(paren
id|ep
comma
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;status_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;status
op_assign
id|d
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if&t;defined(DEV_CONFIG_SUBSET) || defined(CONFIG_USB_ETH_RNDIS)
DECL|function|ether_ep_setup
r_static
r_inline
r_int
id|ether_ep_setup
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_struct
id|usb_ep
op_star
id|ep
)paren
(brace
r_int
id|result
suffix:semicolon
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|d
suffix:semicolon
multiline_comment|/* CDC subset is simpler:  if the device is there,&n;&t; * it&squot;s live with rx and tx endpoints.&n;&t; *&n;&t; * Do this as a shortcut for RNDIS too.&n;&t; */
multiline_comment|/* one endpoint writes data back IN to the host */
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_IN_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|dev-&gt;gadget
comma
op_amp
id|hs_source_desc
comma
op_amp
id|fs_source_desc
)paren
suffix:semicolon
id|result
op_assign
id|usb_ep_enable
(paren
id|ep
comma
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;in_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;in
op_assign
id|d
suffix:semicolon
multiline_comment|/* one endpoint just reads OUT packets */
)brace
r_else
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_OUT_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|dev-&gt;gadget
comma
op_amp
id|hs_sink_desc
comma
op_amp
id|fs_sink_desc
)paren
suffix:semicolon
id|result
op_assign
id|usb_ep_enable
(paren
id|ep
comma
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;out_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;out
op_assign
id|d
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|set_ether_config
id|set_ether_config
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|gfp_flags
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|usb_ep
op_star
id|ep
suffix:semicolon
r_struct
id|usb_gadget
op_star
id|gadget
op_assign
id|dev-&gt;gadget
suffix:semicolon
id|gadget_for_each_ep
(paren
id|ep
comma
id|gadget
)paren
(brace
macro_line|#ifdef&t;DEV_CONFIG_CDC
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;rndis
op_logical_and
id|dev-&gt;cdc
)paren
(brace
id|result
op_assign
id|ether_alt_ep_setup
(paren
id|dev
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
r_if
c_cond
(paren
id|dev-&gt;rndis
op_logical_and
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_STATUS_NAME
)paren
op_eq
l_int|0
)paren
(brace
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|d
suffix:semicolon
id|d
op_assign
id|ep_desc
(paren
id|gadget
comma
op_amp
id|hs_status_desc
comma
op_amp
id|fs_status_desc
)paren
suffix:semicolon
id|result
op_assign
id|usb_ep_enable
(paren
id|ep
comma
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;status_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;status
op_assign
id|d
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
macro_line|#endif
(brace
macro_line|#if&t;defined(DEV_CONFIG_SUBSET) || defined(CONFIG_USB_ETH_RNDIS)
id|result
op_assign
id|ether_ep_setup
(paren
id|dev
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* stop on error */
id|ERROR
(paren
id|dev
comma
l_string|&quot;can&squot;t enable %s, result %d&bslash;n&quot;
comma
id|ep-&gt;name
comma
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|result
op_logical_and
(paren
op_logical_neg
id|dev-&gt;in_ep
op_logical_or
op_logical_neg
id|dev-&gt;out_ep
)paren
)paren
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
id|result
op_assign
id|alloc_requests
(paren
id|dev
comma
id|qlen
(paren
id|gadget
)paren
comma
id|gfp_flags
)paren
suffix:semicolon
multiline_comment|/* on error, disable any endpoints  */
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
macro_line|#if defined(DEV_CONFIG_CDC) || defined(CONFIG_USB_ETH_RNDIS)
r_if
c_cond
(paren
id|dev-&gt;status_ep
)paren
(paren
r_void
)paren
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;status_ep
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;status
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(DEV_CONFIG_SUBSET) || defined(CONFIG_USB_ETH_RNDIS)
r_if
c_cond
(paren
id|dev-&gt;rndis
op_logical_or
op_logical_neg
id|dev-&gt;cdc
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;in_ep
)paren
(paren
r_void
)paren
id|usb_ep_disable
(paren
id|dev-&gt;in_ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;out_ep
)paren
(paren
r_void
)paren
id|usb_ep_disable
(paren
id|dev-&gt;out_ep
)paren
suffix:semicolon
)brace
macro_line|#endif
id|dev-&gt;in_ep
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;in
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;out_ep
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;out
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* activate non-CDC configs right away&n;&t; * this isn&squot;t strictly according to the RNDIS spec&n;&t; */
macro_line|#if defined(DEV_CONFIG_SUBSET) || defined(CONFIG_USB_ETH_RNDIS)
r_if
c_cond
(paren
id|dev-&gt;rndis
op_logical_or
op_logical_neg
id|dev-&gt;cdc
)paren
(brace
id|netif_carrier_on
(paren
id|dev-&gt;net
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
(paren
id|dev-&gt;net
)paren
)paren
(brace
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|eth_start
(paren
id|dev
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
id|DEBUG
(paren
id|dev
comma
l_string|&quot;qlen %d&bslash;n&quot;
comma
id|qlen
(paren
id|gadget
)paren
)paren
suffix:semicolon
multiline_comment|/* caller is responsible for cleanup on error */
r_return
id|result
suffix:semicolon
)brace
DECL|function|eth_reset_config
r_static
r_void
id|eth_reset_config
(paren
r_struct
id|eth_dev
op_star
id|dev
)paren
(brace
r_struct
id|usb_request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;config
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|netif_stop_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|netif_carrier_off
(paren
id|dev-&gt;net
)paren
suffix:semicolon
multiline_comment|/* disable endpoints, forcing (synchronous) completion of&n;&t; * pending i/o.  then free the requests.&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;in_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;in_ep
)paren
suffix:semicolon
r_while
c_loop
(paren
id|likely
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|dev-&gt;tx_reqs
)paren
)paren
)paren
(brace
id|req
op_assign
id|container_of
(paren
id|dev-&gt;tx_reqs.next
comma
r_struct
id|usb_request
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|req-&gt;list
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|dev-&gt;in_ep
comma
id|req
)paren
suffix:semicolon
)brace
id|dev-&gt;in_ep
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;out_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;out_ep
)paren
suffix:semicolon
r_while
c_loop
(paren
id|likely
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|dev-&gt;rx_reqs
)paren
)paren
)paren
(brace
id|req
op_assign
id|container_of
(paren
id|dev-&gt;rx_reqs.next
comma
r_struct
id|usb_request
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|req-&gt;list
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|dev-&gt;out_ep
comma
id|req
)paren
suffix:semicolon
)brace
id|dev-&gt;out_ep
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;status_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
id|dev-&gt;status_ep
op_assign
l_int|0
suffix:semicolon
)brace
id|dev-&gt;config
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* change our operational config.  must agree with the code&n; * that returns config descriptors, and altsetting code.&n; */
r_static
r_int
DECL|function|eth_set_config
id|eth_set_config
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|number
comma
r_int
id|gfp_flags
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|usb_gadget
op_star
id|gadget
op_assign
id|dev-&gt;gadget
suffix:semicolon
r_if
c_cond
(paren
id|number
op_eq
id|dev-&gt;config
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|gadget_is_sa1100
(paren
id|gadget
)paren
op_logical_and
id|dev-&gt;config
op_logical_and
id|atomic_read
(paren
op_amp
id|dev-&gt;tx_qlen
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* tx fifo is full, but we can&squot;t clear it...*/
id|INFO
(paren
id|dev
comma
l_string|&quot;can&squot;t change configurations&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
id|eth_reset_config
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* default:  pass all packets, no multicast filtering */
id|dev-&gt;cdc_filter
op_assign
l_int|0x000f
suffix:semicolon
r_switch
c_cond
(paren
id|number
)paren
(brace
r_case
id|DEV_CONFIG_VALUE
suffix:colon
id|dev-&gt;rndis
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|set_ether_config
(paren
id|dev
comma
id|gfp_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
r_case
id|DEV_RNDIS_CONFIG_VALUE
suffix:colon
id|dev-&gt;rndis
op_assign
l_int|1
suffix:semicolon
id|result
op_assign
id|set_ether_config
(paren
id|dev
comma
id|gfp_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* FALL THROUGH */
r_case
l_int|0
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
)paren
id|eth_reset_config
(paren
id|dev
)paren
suffix:semicolon
r_else
(brace
r_char
op_star
id|speed
suffix:semicolon
r_switch
c_cond
(paren
id|gadget-&gt;speed
)paren
(brace
r_case
id|USB_SPEED_FULL
suffix:colon
id|speed
op_assign
l_string|&quot;full&quot;
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_USB_GADGET_DUALSPEED
r_case
id|USB_SPEED_HIGH
suffix:colon
id|speed
op_assign
l_string|&quot;high&quot;
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|speed
op_assign
l_string|&quot;?&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev-&gt;config
op_assign
id|number
suffix:semicolon
id|INFO
(paren
id|dev
comma
l_string|&quot;%s speed config #%d: %s, using %s&bslash;n&quot;
comma
id|speed
comma
id|number
comma
id|driver_desc
comma
id|dev-&gt;rndis
ques
c_cond
l_string|&quot;RNDIS&quot;
suffix:colon
(paren
id|dev-&gt;cdc
ques
c_cond
l_string|&quot;CDC Ethernet&quot;
suffix:colon
l_string|&quot;CDC Ethernet Subset&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* section 3.8.2 table 11 of the CDC spec lists Ethernet notifications&n; * section 3.6.2.1 table 5 specifies ACM notifications, accepted by RNDIS&n; * and RNDIS also defines its own bit-incompatible notifications&n; */
DECL|macro|CDC_NOTIFY_NETWORK_CONNECTION
mdefine_line|#define CDC_NOTIFY_NETWORK_CONNECTION&t;0x00&t;/* required; 6.3.1 */
DECL|macro|CDC_NOTIFY_RESPONSE_AVAILABLE
mdefine_line|#define CDC_NOTIFY_RESPONSE_AVAILABLE&t;0x01&t;/* optional; 6.3.2 */
DECL|macro|CDC_NOTIFY_SPEED_CHANGE
mdefine_line|#define CDC_NOTIFY_SPEED_CHANGE&t;&t;0x2a&t;/* required; 6.3.8 */
macro_line|#ifdef&t;DEV_CONFIG_CDC
DECL|struct|cdc_notification
r_struct
id|cdc_notification
(brace
DECL|member|bmRequestType
id|u8
id|bmRequestType
suffix:semicolon
DECL|member|bNotificationType
id|u8
id|bNotificationType
suffix:semicolon
DECL|member|wValue
id|u16
id|wValue
suffix:semicolon
DECL|member|wIndex
id|u16
id|wIndex
suffix:semicolon
DECL|member|wLength
id|u16
id|wLength
suffix:semicolon
multiline_comment|/* SPEED_CHANGE data looks like this */
DECL|member|data
id|u32
id|data
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|eth_status_complete
r_static
r_void
id|eth_status_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_struct
id|cdc_notification
op_star
id|event
op_assign
id|req-&gt;buf
suffix:semicolon
r_int
id|value
op_assign
id|req-&gt;status
suffix:semicolon
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|ep-&gt;driver_data
suffix:semicolon
multiline_comment|/* issue the second notification if host reads the first */
r_if
c_cond
(paren
id|event-&gt;bNotificationType
op_eq
id|CDC_NOTIFY_NETWORK_CONNECTION
op_logical_and
id|value
op_eq
l_int|0
)paren
(brace
id|event-&gt;bmRequestType
op_assign
l_int|0xA1
suffix:semicolon
id|event-&gt;bNotificationType
op_assign
id|CDC_NOTIFY_SPEED_CHANGE
suffix:semicolon
id|event-&gt;wValue
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|event-&gt;wIndex
op_assign
id|__constant_cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
id|event-&gt;wLength
op_assign
id|__constant_cpu_to_le16
(paren
l_int|8
)paren
suffix:semicolon
multiline_comment|/* SPEED_CHANGE data is up/down speeds in bits/sec */
id|event-&gt;data
(braket
l_int|0
)braket
op_assign
id|event-&gt;data
(braket
l_int|1
)braket
op_assign
(paren
id|dev-&gt;gadget-&gt;speed
op_eq
id|USB_SPEED_HIGH
)paren
ques
c_cond
(paren
l_int|13
op_star
l_int|512
op_star
l_int|8
op_star
l_int|1000
op_star
l_int|8
)paren
suffix:colon
(paren
l_int|19
op_star
l_int|64
op_star
l_int|1
op_star
l_int|1000
op_star
l_int|8
)paren
suffix:semicolon
id|req-&gt;length
op_assign
l_int|16
suffix:semicolon
id|value
op_assign
id|usb_ep_queue
(paren
id|ep
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;send SPEED_CHANGE --&gt; %d&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_else
id|DEBUG
(paren
id|dev
comma
l_string|&quot;event %02x --&gt; %d&bslash;n&quot;
comma
id|event-&gt;bNotificationType
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* free when done */
id|usb_ep_free_buffer
(paren
id|ep
comma
id|req-&gt;buf
comma
id|req-&gt;dma
comma
l_int|16
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
DECL|function|issue_start_status
r_static
r_void
id|issue_start_status
(paren
r_struct
id|eth_dev
op_star
id|dev
)paren
(brace
r_struct
id|usb_request
op_star
id|req
suffix:semicolon
r_struct
id|cdc_notification
op_star
id|event
suffix:semicolon
r_int
id|value
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s, flush old status first&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* flush old status&n;&t; *&n;&t; * FIXME ugly idiom, maybe we&squot;d be better with just&n;&t; * a &quot;cancel the whole queue&quot; primitive since any&n;&t; * unlink-one primitive has way too many error modes.&n;&t; * here, we &quot;know&quot; toggle is already clear...&n;&t; */
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;status_ep
comma
id|dev-&gt;status
)paren
suffix:semicolon
multiline_comment|/* FIXME make these allocations static like dev-&gt;req */
id|req
op_assign
id|usb_ep_alloc_request
(paren
id|dev-&gt;status_ep
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status ENOMEM&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|req-&gt;buf
op_assign
id|usb_ep_alloc_buffer
(paren
id|dev-&gt;status_ep
comma
l_int|16
comma
op_amp
id|dev-&gt;req-&gt;dma
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;buf
op_eq
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status buf ENOMEM&bslash;n&quot;
)paren
suffix:semicolon
id|free_req
suffix:colon
id|usb_ep_free_request
(paren
id|dev-&gt;status_ep
comma
id|req
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* 3.8.1 says to issue first NETWORK_CONNECTION, then&n;&t; * a SPEED_CHANGE.  could be useful in some configs.&n;&t; */
id|event
op_assign
id|req-&gt;buf
suffix:semicolon
id|event-&gt;bmRequestType
op_assign
l_int|0xA1
suffix:semicolon
id|event-&gt;bNotificationType
op_assign
id|CDC_NOTIFY_NETWORK_CONNECTION
suffix:semicolon
id|event-&gt;wValue
op_assign
id|__constant_cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* connected */
id|event-&gt;wIndex
op_assign
id|__constant_cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
id|event-&gt;wLength
op_assign
l_int|0
suffix:semicolon
id|req-&gt;length
op_assign
l_int|8
suffix:semicolon
id|req-&gt;complete
op_assign
id|eth_status_complete
suffix:semicolon
id|value
op_assign
id|usb_ep_queue
(paren
id|dev-&gt;status_ep
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
OL
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status buf queue --&gt; %d&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
id|usb_ep_free_buffer
(paren
id|dev-&gt;status_ep
comma
id|req-&gt;buf
comma
id|dev-&gt;req-&gt;dma
comma
l_int|16
)paren
suffix:semicolon
r_goto
id|free_req
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|eth_setup_complete
r_static
r_void
id|eth_setup_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;status
op_logical_or
id|req-&gt;actual
op_ne
id|req-&gt;length
)paren
id|DEBUG
(paren
(paren
r_struct
id|eth_dev
op_star
)paren
id|ep-&gt;driver_data
comma
l_string|&quot;setup complete --&gt; %d, %d/%d&bslash;n&quot;
comma
id|req-&gt;status
comma
id|req-&gt;actual
comma
id|req-&gt;length
)paren
suffix:semicolon
)brace
multiline_comment|/* see section 3.8.2 table 10 of the CDC spec for more ethernet&n; * requests, mostly for filters (multicast, pm) and statistics&n; * section 3.6.2.1 table 4 has ACM requests; RNDIS requires the&n; * encapsulated command mechanism.&n; */
DECL|macro|CDC_SEND_ENCAPSULATED_COMMAND
mdefine_line|#define CDC_SEND_ENCAPSULATED_COMMAND&t;&t;0x00&t;/* optional */
DECL|macro|CDC_GET_ENCAPSULATED_RESPONSE
mdefine_line|#define CDC_GET_ENCAPSULATED_RESPONSE&t;&t;0x01&t;/* optional */
DECL|macro|CDC_SET_ETHERNET_MULTICAST_FILTERS
mdefine_line|#define CDC_SET_ETHERNET_MULTICAST_FILTERS&t;0x40&t;/* optional */
DECL|macro|CDC_SET_ETHERNET_PM_PATTERN_FILTER
mdefine_line|#define CDC_SET_ETHERNET_PM_PATTERN_FILTER&t;0x41&t;/* optional */
DECL|macro|CDC_GET_ETHERNET_PM_PATTERN_FILTER
mdefine_line|#define CDC_GET_ETHERNET_PM_PATTERN_FILTER&t;0x42&t;/* optional */
DECL|macro|CDC_SET_ETHERNET_PACKET_FILTER
mdefine_line|#define CDC_SET_ETHERNET_PACKET_FILTER&t;&t;0x43&t;/* required */
DECL|macro|CDC_GET_ETHERNET_STATISTIC
mdefine_line|#define CDC_GET_ETHERNET_STATISTIC&t;&t;0x44&t;/* optional */
multiline_comment|/* table 62; bits in cdc_filter */
DECL|macro|CDC_PACKET_TYPE_PROMISCUOUS
mdefine_line|#define&t;CDC_PACKET_TYPE_PROMISCUOUS&t;&t;(1 &lt;&lt; 0)
DECL|macro|CDC_PACKET_TYPE_ALL_MULTICAST
mdefine_line|#define&t;CDC_PACKET_TYPE_ALL_MULTICAST&t;&t;(1 &lt;&lt; 1) /* no filter */
DECL|macro|CDC_PACKET_TYPE_DIRECTED
mdefine_line|#define&t;CDC_PACKET_TYPE_DIRECTED&t;&t;(1 &lt;&lt; 2)
DECL|macro|CDC_PACKET_TYPE_BROADCAST
mdefine_line|#define&t;CDC_PACKET_TYPE_BROADCAST&t;&t;(1 &lt;&lt; 3)
DECL|macro|CDC_PACKET_TYPE_MULTICAST
mdefine_line|#define&t;CDC_PACKET_TYPE_MULTICAST&t;&t;(1 &lt;&lt; 4) /* filtered */
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
DECL|function|rndis_response_complete
r_static
r_void
id|rndis_response_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|ep-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;status
op_logical_or
id|req-&gt;actual
op_ne
id|req-&gt;length
)paren
id|DEBUG
(paren
id|dev
comma
l_string|&quot;rndis response complete --&gt; %d, %d/%d&bslash;n&quot;
comma
id|req-&gt;status
comma
id|req-&gt;actual
comma
id|req-&gt;length
)paren
suffix:semicolon
multiline_comment|/* done sending after CDC_GET_ENCAPSULATED_RESPONSE */
id|rndis_free_response
(paren
id|dev-&gt;rndis_config
comma
id|req-&gt;buf
)paren
suffix:semicolon
)brace
DECL|function|rndis_command_complete
r_static
r_void
id|rndis_command_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|ep-&gt;driver_data
suffix:semicolon
multiline_comment|/* received RNDIS command from CDC_SEND_ENCAPSULATED_COMMAND */
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rndis_msg_parser
(paren
id|dev-&gt;rndis_config
comma
(paren
id|u8
op_star
)paren
id|req-&gt;buf
)paren
)paren
id|ERROR
c_func
(paren
id|dev
comma
l_string|&quot;%s: rndis parse error&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* RNDIS */
multiline_comment|/*&n; * The setup() callback implements all the ep0 functionality that&squot;s not&n; * handled lower down.  CDC has a number of less-common features:&n; *&n; *  - two interfaces:  control, and ethernet data&n; *  - Ethernet data interface has two altsettings:  default, and active&n; *  - class-specific descriptors for the control interface&n; *  - class-specific control requests&n; */
r_static
r_int
DECL|function|eth_setup
id|eth_setup
(paren
r_struct
id|usb_gadget
op_star
id|gadget
comma
r_const
r_struct
id|usb_ctrlrequest
op_star
id|ctrl
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|get_gadget_data
(paren
id|gadget
)paren
suffix:semicolon
r_struct
id|usb_request
op_star
id|req
op_assign
id|dev-&gt;req
suffix:semicolon
r_int
id|value
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
multiline_comment|/* descriptors just go into the pre-allocated ep0 buffer,&n;&t; * while config change events may enable network traffic.&n;&t; */
r_switch
c_cond
(paren
id|ctrl-&gt;bRequest
)paren
(brace
r_case
id|USB_REQ_GET_DESCRIPTOR
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
id|USB_DIR_IN
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl-&gt;wValue
op_rshift
l_int|8
)paren
(brace
r_case
id|USB_DT_DEVICE
suffix:colon
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
r_sizeof
id|device_desc
)paren
suffix:semicolon
id|memcpy
(paren
id|req-&gt;buf
comma
op_amp
id|device_desc
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_USB_GADGET_DUALSPEED
r_case
id|USB_DT_DEVICE_QUALIFIER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|gadget-&gt;is_dualspeed
)paren
r_break
suffix:semicolon
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
r_sizeof
id|dev_qualifier
)paren
suffix:semicolon
id|memcpy
(paren
id|req-&gt;buf
comma
op_amp
id|dev_qualifier
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_DT_OTHER_SPEED_CONFIG
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|gadget-&gt;is_dualspeed
)paren
r_break
suffix:semicolon
singleline_comment|// FALLTHROUGH
macro_line|#endif /* CONFIG_USB_GADGET_DUALSPEED */
r_case
id|USB_DT_CONFIG
suffix:colon
id|value
op_assign
id|config_buf
(paren
id|gadget-&gt;speed
comma
id|req-&gt;buf
comma
id|ctrl-&gt;wValue
op_rshift
l_int|8
comma
id|ctrl-&gt;wValue
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_ge
l_int|0
)paren
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_DT_STRING
suffix:colon
id|value
op_assign
id|usb_gadget_get_string
(paren
op_amp
id|stringtab
comma
id|ctrl-&gt;wValue
op_amp
l_int|0xff
comma
id|req-&gt;buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_ge
l_int|0
)paren
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|USB_REQ_SET_CONFIGURATION
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|value
op_assign
id|eth_set_config
(paren
id|dev
comma
id|ctrl-&gt;wValue
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_REQ_GET_CONFIGURATION
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
id|USB_DIR_IN
)paren
r_break
suffix:semicolon
op_star
(paren
id|u8
op_star
)paren
id|req-&gt;buf
op_assign
id|dev-&gt;config
suffix:semicolon
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_REQ_SET_INTERFACE
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
id|USB_RECIP_INTERFACE
op_logical_or
op_logical_neg
id|dev-&gt;config
op_logical_or
id|ctrl-&gt;wIndex
OG
l_int|1
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;cdc
op_logical_and
id|ctrl-&gt;wIndex
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* PXA hardware partially handles SET_INTERFACE;&n;&t;&t; * we need to kluge around that interference.&n;&t;&t; */
r_if
c_cond
(paren
id|gadget_is_pxa
(paren
id|gadget
)paren
)paren
(brace
id|value
op_assign
id|eth_set_config
(paren
id|dev
comma
id|DEV_CONFIG_VALUE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_goto
id|done_set_intf
suffix:semicolon
)brace
macro_line|#ifdef DEV_CONFIG_CDC
r_switch
c_cond
(paren
id|ctrl-&gt;wIndex
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* control/master intf */
r_if
c_cond
(paren
id|ctrl-&gt;wValue
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;status_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;status_ep
comma
id|dev-&gt;status
)paren
suffix:semicolon
)brace
id|value
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* data intf */
r_if
c_cond
(paren
id|ctrl-&gt;wValue
OG
l_int|1
)paren
r_break
suffix:semicolon
id|usb_ep_disable
(paren
id|dev-&gt;in_ep
)paren
suffix:semicolon
id|usb_ep_disable
(paren
id|dev-&gt;out_ep
)paren
suffix:semicolon
multiline_comment|/* CDC requires the data transfers not be done from&n;&t;&t;&t; * the default interface setting ... also, setting&n;&t;&t;&t; * the non-default interface clears filters etc.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|ctrl-&gt;wValue
op_eq
l_int|1
)paren
(brace
id|usb_ep_enable
(paren
id|dev-&gt;in_ep
comma
id|dev-&gt;in
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;out_ep
comma
id|dev-&gt;out
)paren
suffix:semicolon
id|netif_carrier_on
(paren
id|dev-&gt;net
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;status_ep
)paren
id|issue_start_status
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
(paren
id|dev-&gt;net
)paren
)paren
(brace
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|eth_start
(paren
id|dev
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|netif_stop_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|netif_carrier_off
(paren
id|dev-&gt;net
)paren
suffix:semicolon
)brace
id|value
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* FIXME this is wrong, as is the assumption that&n;&t;&t; * all non-PXA hardware talks real CDC ...&n;&t;&t; */
id|dev_warn
(paren
op_amp
id|gadget-&gt;dev
comma
l_string|&quot;set_interface ignored!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEV_CONFIG_CDC */
id|done_set_intf
suffix:colon
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_REQ_GET_INTERFACE
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
(paren
id|USB_DIR_IN
op_or
id|USB_RECIP_INTERFACE
)paren
op_logical_or
op_logical_neg
id|dev-&gt;config
op_logical_or
id|ctrl-&gt;wIndex
OG
l_int|1
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;cdc
op_logical_or
id|dev-&gt;rndis
)paren
op_logical_and
id|ctrl-&gt;wIndex
op_ne
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* for CDC, iff carrier is on, data interface is active. */
r_if
c_cond
(paren
id|dev-&gt;rndis
op_logical_or
id|ctrl-&gt;wIndex
op_ne
l_int|1
)paren
op_star
(paren
id|u8
op_star
)paren
id|req-&gt;buf
op_assign
l_int|0
suffix:semicolon
r_else
op_star
(paren
id|u8
op_star
)paren
id|req-&gt;buf
op_assign
id|netif_carrier_ok
(paren
id|dev-&gt;net
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef DEV_CONFIG_CDC
r_case
id|CDC_SET_ETHERNET_PACKET_FILTER
suffix:colon
multiline_comment|/* see 6.2.30: no data, wIndex = interface,&n;&t;&t; * wValue = packet filter bitmap&n;&t;&t; */
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
(paren
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_INTERFACE
)paren
op_logical_or
op_logical_neg
id|dev-&gt;cdc
op_logical_or
id|dev-&gt;rndis
op_logical_or
id|ctrl-&gt;wLength
op_ne
l_int|0
op_logical_or
id|ctrl-&gt;wIndex
OG
l_int|1
)paren
r_break
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;NOP packet filter %04x&bslash;n&quot;
comma
id|ctrl-&gt;wValue
)paren
suffix:semicolon
multiline_comment|/* NOTE: table 62 has 5 filter bits to reduce traffic,&n;&t;&t; * and we &quot;must&quot; support multicast and promiscuous.&n;&t;&t; * this NOP implements a bad filter (always promisc)&n;&t;&t; */
id|dev-&gt;cdc_filter
op_assign
id|ctrl-&gt;wValue
suffix:semicolon
id|value
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* DEV_CONFIG_CDC */
macro_line|#ifdef CONFIG_USB_ETH_RNDIS&t;&t;
multiline_comment|/* RNDIS uses the CDC command encapsulation mechanism to implement&n;&t; * an RPC scheme, with much getting/setting of attributes by OID.&n;&t; */
r_case
id|CDC_SEND_ENCAPSULATED_COMMAND
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
(paren
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_INTERFACE
)paren
op_logical_or
op_logical_neg
id|dev-&gt;rndis
op_logical_or
id|ctrl-&gt;wLength
OG
id|USB_BUFSIZ
op_logical_or
id|ctrl-&gt;wValue
op_logical_or
id|rndis_control_intf.bInterfaceNumber
op_ne
id|ctrl-&gt;wIndex
)paren
r_break
suffix:semicolon
multiline_comment|/* read the request, then process it */
id|value
op_assign
id|ctrl-&gt;wLength
suffix:semicolon
id|req-&gt;complete
op_assign
id|rndis_command_complete
suffix:semicolon
multiline_comment|/* later, rndis_control_ack () sends a notification */
r_break
suffix:semicolon
r_case
id|CDC_GET_ENCAPSULATED_RESPONSE
suffix:colon
r_if
c_cond
(paren
(paren
id|USB_DIR_IN
op_or
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_INTERFACE
)paren
op_eq
id|ctrl-&gt;bRequestType
op_logical_and
id|dev-&gt;rndis
singleline_comment|// &amp;&amp; ctrl-&gt;wLength &gt;= 0x0400
op_logical_and
op_logical_neg
id|ctrl-&gt;wValue
op_logical_and
id|rndis_control_intf.bInterfaceNumber
op_eq
id|ctrl-&gt;wIndex
)paren
(brace
id|u8
op_star
id|buf
suffix:semicolon
multiline_comment|/* return the result */
id|buf
op_assign
id|rndis_get_next_response
(paren
id|dev-&gt;rndis_config
comma
op_amp
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
(brace
id|memcpy
(paren
id|req-&gt;buf
comma
id|buf
comma
id|value
)paren
suffix:semicolon
id|req-&gt;complete
op_assign
id|rndis_response_complete
suffix:semicolon
)brace
multiline_comment|/* else stalls ... spec says to avoid that */
)brace
r_break
suffix:semicolon
macro_line|#endif&t;/* RNDIS */
r_default
suffix:colon
id|VDEBUG
(paren
id|dev
comma
l_string|&quot;unknown control req%02x.%02x v%04x i%04x l%d&bslash;n&quot;
comma
id|ctrl-&gt;bRequestType
comma
id|ctrl-&gt;bRequest
comma
id|ctrl-&gt;wValue
comma
id|ctrl-&gt;wIndex
comma
id|ctrl-&gt;wLength
)paren
suffix:semicolon
)brace
multiline_comment|/* respond with data transfer before status phase? */
r_if
c_cond
(paren
id|value
op_ge
l_int|0
)paren
(brace
id|req-&gt;length
op_assign
id|value
suffix:semicolon
id|value
op_assign
id|usb_ep_queue
(paren
id|gadget-&gt;ep0
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
OL
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;ep_queue --&gt; %d&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
id|req-&gt;status
op_assign
l_int|0
suffix:semicolon
id|eth_setup_complete
(paren
id|gadget-&gt;ep0
comma
id|req
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* host either stalls (value &lt; 0) or reports success */
r_return
id|value
suffix:semicolon
)brace
r_static
r_void
DECL|function|eth_disconnect
id|eth_disconnect
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|get_gadget_data
(paren
id|gadget
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_stop_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|netif_carrier_off
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|eth_reset_config
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* FIXME RNDIS should enter RNDIS_UNINITIALIZED */
multiline_comment|/* next we may get setup() calls to enumerate new connections;&n;&t; * or an unbind() during shutdown (including removing module).&n;&t; */
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* NETWORK DRIVER HOOKUP (to the layer above this driver) */
DECL|function|eth_change_mtu
r_static
r_int
id|eth_change_mtu
(paren
r_struct
id|net_device
op_star
id|net
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
singleline_comment|// FIXME if rndis, don&squot;t change while link&squot;s live
r_if
c_cond
(paren
id|new_mtu
op_le
id|ETH_HLEN
op_logical_or
id|new_mtu
OG
id|ETH_FRAME_LEN
)paren
r_return
op_minus
id|ERANGE
suffix:semicolon
multiline_comment|/* no zero-length packet read wanted after mtu-sized packets */
r_if
c_cond
(paren
(paren
(paren
id|new_mtu
op_plus
r_sizeof
(paren
r_struct
id|ethhdr
)paren
)paren
op_mod
id|dev-&gt;in_ep-&gt;maxpacket
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EDOM
suffix:semicolon
id|net-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|eth_get_stats
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_return
op_amp
(paren
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
)paren
op_member_access_from_pointer
id|stats
suffix:semicolon
)brace
DECL|function|eth_ethtool_ioctl
r_static
r_int
id|eth_ethtool_ioctl
(paren
r_struct
id|net_device
op_star
id|net
comma
r_void
op_star
id|useraddr
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|u32
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|cmd
comma
(paren
id|u32
op_star
)paren
id|useraddr
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
multiline_comment|/* get driver info */
r_struct
id|ethtool_drvinfo
id|info
suffix:semicolon
id|memset
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
id|info
)paren
suffix:semicolon
id|info.cmd
op_assign
id|ETHTOOL_GDRVINFO
suffix:semicolon
id|strlcpy
(paren
id|info.driver
comma
id|shortname
comma
r_sizeof
id|info.driver
)paren
suffix:semicolon
id|strlcpy
(paren
id|info.version
comma
id|DRIVER_VERSION
comma
r_sizeof
id|info.version
)paren
suffix:semicolon
id|strlcpy
(paren
id|info.fw_version
comma
id|dev-&gt;gadget-&gt;name
comma
r_sizeof
id|info.fw_version
)paren
suffix:semicolon
id|strlcpy
(paren
id|info.bus_info
comma
id|dev-&gt;gadget-&gt;dev.bus_id
comma
r_sizeof
id|info.bus_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|useraddr
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ETHTOOL_GLINK
suffix:colon
(brace
multiline_comment|/* get link status */
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GLINK
)brace
suffix:semicolon
id|edata.data
op_assign
(paren
id|dev-&gt;gadget-&gt;speed
op_ne
id|USB_SPEED_UNKNOWN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|useraddr
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Note that the ethtool user space code requires EOPNOTSUPP */
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|eth_ioctl
r_static
r_int
id|eth_ioctl
(paren
r_struct
id|net_device
op_star
id|net
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
r_return
id|eth_ethtool_ioctl
(paren
id|net
comma
(paren
r_void
op_star
)paren
id|rq-&gt;ifr_data
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|defer_kevent
r_static
r_void
id|defer_kevent
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|flag
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
(paren
id|flag
comma
op_amp
id|dev-&gt;todo
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schedule_work
(paren
op_amp
id|dev-&gt;work
)paren
)paren
id|ERROR
(paren
id|dev
comma
l_string|&quot;kevent %d may have been dropped&bslash;n&quot;
comma
id|flag
)paren
suffix:semicolon
r_else
id|DEBUG
(paren
id|dev
comma
l_string|&quot;kevent %d scheduled&bslash;n&quot;
comma
id|flag
)paren
suffix:semicolon
)brace
r_static
r_void
id|rx_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
suffix:semicolon
r_static
r_int
DECL|function|rx_submit
id|rx_submit
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_struct
id|usb_request
op_star
id|req
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_int
id|size
suffix:semicolon
multiline_comment|/* Padding up to RX_EXTRA handles minor disagreements with host.&n;&t; * Normally we use the USB &quot;terminate on short read&quot; convention;&n;&t; * so allow up to (N*maxpacket)-1, since that memory is normally&n;&t; * already allocated.  Major loss of synch means -EOVERFLOW; any&n;&t; * obviously corrupted packets will automatically be discarded. &n;&t; *&n;&t; * RNDIS uses internal framing, and explicitly allows senders to&n;&t; * pad to end-of-packet.  That&squot;s potentially nice for speed,&n;&t; * but means receivers can&squot;t recover synch on their own.&n;&t; */
id|size
op_assign
(paren
r_sizeof
(paren
r_struct
id|ethhdr
)paren
op_plus
id|dev-&gt;net-&gt;mtu
op_plus
id|RX_EXTRA
)paren
suffix:semicolon
id|size
op_add_assign
id|dev-&gt;out_ep-&gt;maxpacket
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
r_if
c_cond
(paren
id|dev-&gt;rndis
)paren
id|size
op_add_assign
r_sizeof
(paren
r_struct
id|rndis_packet_msg_type
)paren
suffix:semicolon
macro_line|#endif&t;
id|size
op_sub_assign
id|size
op_mod
id|dev-&gt;out_ep-&gt;maxpacket
suffix:semicolon
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;rndis
)paren
macro_line|#endif&t;
id|size
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|alloc_skb
(paren
id|size
comma
id|gfp_flags
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;no rx skb&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|enomem
suffix:semicolon
)brace
id|req-&gt;buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|req-&gt;length
op_assign
id|size
suffix:semicolon
id|req-&gt;complete
op_assign
id|rx_complete
suffix:semicolon
id|req-&gt;context
op_assign
id|skb
suffix:semicolon
id|retval
op_assign
id|usb_ep_queue
(paren
id|dev-&gt;out_ep
comma
id|req
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOMEM
)paren
id|enomem
suffix:colon
id|defer_kevent
(paren
id|dev
comma
id|WORK_RX_MEMORY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;rx submit --&gt; %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|dev-&gt;rx_reqs
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|rx_complete
r_static
r_void
id|rx_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|req-&gt;context
suffix:semicolon
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|ep-&gt;driver_data
suffix:semicolon
r_int
id|status
op_assign
id|req-&gt;status
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* normal completion */
r_case
l_int|0
suffix:colon
id|skb_put
(paren
id|skb
comma
id|req-&gt;actual
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
multiline_comment|/* we know MaxPacketsPerTransfer == 1 here */
r_if
c_cond
(paren
id|dev-&gt;rndis
)paren
id|rndis_rm_hdr
(paren
id|req-&gt;buf
comma
op_amp
(paren
id|skb-&gt;len
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ETH_HLEN
OG
id|skb-&gt;len
op_logical_or
id|skb-&gt;len
OG
id|ETH_FRAME_LEN
)paren
(brace
id|dev-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|dev-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;rx length %d&bslash;n&quot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev-&gt;net
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
(paren
id|skb
comma
id|dev-&gt;net
)paren
suffix:semicolon
id|dev-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|dev-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* no buffer copies needed, unless hardware can&squot;t&n;&t;&t; * use skb buffers.&n;&t;&t; */
id|status
op_assign
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* software-driven interface shutdown */
r_case
op_minus
id|ECONNRESET
suffix:colon
singleline_comment|// unlink
r_case
op_minus
id|ESHUTDOWN
suffix:colon
singleline_comment|// disconnect etc
id|VDEBUG
(paren
id|dev
comma
l_string|&quot;rx shutdown, code %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_goto
id|quiesce
suffix:semicolon
multiline_comment|/* for hardware automagic (such as pxa) */
r_case
op_minus
id|ECONNABORTED
suffix:colon
singleline_comment|// endpoint reset
id|DEBUG
(paren
id|dev
comma
l_string|&quot;rx %s reset&bslash;n&quot;
comma
id|ep-&gt;name
)paren
suffix:semicolon
id|defer_kevent
(paren
id|dev
comma
id|WORK_RX_MEMORY
)paren
suffix:semicolon
id|quiesce
suffix:colon
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|clean
suffix:semicolon
multiline_comment|/* data overrun */
r_case
op_minus
id|EOVERFLOW
suffix:colon
id|dev-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
singleline_comment|// FALLTHROUGH
r_default
suffix:colon
id|dev-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;rx status %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
(paren
id|dev-&gt;net
)paren
)paren
(brace
id|clean
suffix:colon
multiline_comment|/* nobody reading rx_reqs, so no dev-&gt;lock */
id|list_add
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|dev-&gt;rx_reqs
)paren
suffix:semicolon
id|req
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req
)paren
id|rx_submit
(paren
id|dev
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
DECL|function|prealloc
r_static
r_int
id|prealloc
(paren
r_struct
id|list_head
op_star
id|list
comma
r_struct
id|usb_ep
op_star
id|ep
comma
r_int
id|n
comma
r_int
id|gfp_flags
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|usb_request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* queue/recycle up to N requests */
id|i
op_assign
id|n
suffix:semicolon
id|list_for_each_entry
(paren
id|req
comma
id|list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|i
op_decrement
op_eq
l_int|0
)paren
r_goto
id|extra
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
id|req
op_assign
id|usb_ep_alloc_request
(paren
id|ep
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_return
id|list_empty
(paren
id|list
)paren
ques
c_cond
op_minus
id|ENOMEM
suffix:colon
l_int|0
suffix:semicolon
id|list_add
(paren
op_amp
id|req-&gt;list
comma
id|list
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|extra
suffix:colon
multiline_comment|/* free extras */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|list_head
op_star
id|next
suffix:semicolon
id|next
op_assign
id|req-&gt;list.next
suffix:semicolon
id|list_del
(paren
op_amp
id|req-&gt;list
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next
op_eq
id|list
)paren
r_break
suffix:semicolon
id|req
op_assign
id|container_of
(paren
id|next
comma
r_struct
id|usb_request
comma
id|list
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alloc_requests
r_static
r_int
id|alloc_requests
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|n
comma
r_int
id|gfp_flags
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|prealloc
(paren
op_amp
id|dev-&gt;tx_reqs
comma
id|dev-&gt;in_ep
comma
id|n
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
id|status
op_assign
id|prealloc
(paren
op_amp
id|dev-&gt;rx_reqs
comma
id|dev-&gt;out_ep
comma
id|n
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;can&squot;t alloc requests&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|rx_fill
r_static
r_void
id|rx_fill
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|usb_request
op_star
id|req
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|clear_bit
(paren
id|WORK_RX_MEMORY
comma
op_amp
id|dev-&gt;todo
)paren
suffix:semicolon
multiline_comment|/* fill unused rxq slots with some skb */
id|spin_lock_irqsave
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|dev-&gt;rx_reqs
)paren
)paren
(brace
id|req
op_assign
id|container_of
(paren
id|dev-&gt;rx_reqs.next
comma
r_struct
id|usb_request
comma
id|list
)paren
suffix:semicolon
id|list_del_init
(paren
op_amp
id|req-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_submit
(paren
id|dev
comma
id|req
comma
id|gfp_flags
)paren
OL
l_int|0
)paren
(brace
id|defer_kevent
(paren
id|dev
comma
id|WORK_RX_MEMORY
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|eth_work
r_static
r_void
id|eth_work
(paren
r_void
op_star
id|_dev
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|_dev
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
(paren
id|WORK_RX_MEMORY
comma
op_amp
id|dev-&gt;todo
)paren
)paren
(brace
r_if
c_cond
(paren
id|netif_running
(paren
id|dev-&gt;net
)paren
)paren
id|rx_fill
(paren
id|dev
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_else
id|clear_bit
(paren
id|WORK_RX_MEMORY
comma
op_amp
id|dev-&gt;todo
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;todo
)paren
id|DEBUG
(paren
id|dev
comma
l_string|&quot;work done, flags = 0x%lx&bslash;n&quot;
comma
id|dev-&gt;todo
)paren
suffix:semicolon
)brace
DECL|function|tx_complete
r_static
r_void
id|tx_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|req-&gt;context
suffix:semicolon
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|ep-&gt;driver_data
suffix:semicolon
r_switch
c_cond
(paren
id|req-&gt;status
)paren
(brace
r_default
suffix:colon
id|dev-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|VDEBUG
(paren
id|dev
comma
l_string|&quot;tx err %d&bslash;n&quot;
comma
id|req-&gt;status
)paren
suffix:semicolon
multiline_comment|/* FALLTHROUGH */
r_case
op_minus
id|ECONNRESET
suffix:colon
singleline_comment|// unlink
r_case
op_minus
id|ESHUTDOWN
suffix:colon
singleline_comment|// disconnect etc
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
id|dev-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|dev-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|dev-&gt;tx_reqs
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
id|atomic_dec
(paren
op_amp
id|dev-&gt;tx_qlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_carrier_ok
(paren
id|dev-&gt;net
)paren
)paren
id|netif_wake_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
)brace
DECL|function|eth_start_xmit
r_static
r_int
id|eth_start_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
r_int
id|length
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_struct
id|usb_request
op_star
id|req
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* FIXME check dev-&gt;cdc_filter to decide whether to send this,&n;&t; * instead of acting as if CDC_PACKET_TYPE_PROMISCUOUS were&n;&t; * always set.  RNDIS has the same kind of outgoing filter.&n;&t; */
id|spin_lock_irqsave
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|req
op_assign
id|container_of
(paren
id|dev-&gt;tx_reqs.next
comma
r_struct
id|usb_request
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|req-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
op_amp
id|dev-&gt;tx_reqs
)paren
)paren
id|netif_stop_queue
(paren
id|net
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* no buffer copies needed, unless the network stack did it&n;&t; * or the hardware can&squot;t use skb buffers.&n;&t; * or there&squot;s not enough space for any RNDIS headers we need&n;&t; */
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
r_if
c_cond
(paren
id|dev-&gt;rndis
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb_rndis
suffix:semicolon
id|skb_rndis
op_assign
id|skb_realloc_headroom
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|rndis_packet_msg_type
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_rndis
)paren
r_goto
id|drop
suffix:semicolon
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|skb_rndis
suffix:semicolon
id|rndis_add_hdr
(paren
id|skb
)paren
suffix:semicolon
id|length
op_assign
id|skb-&gt;len
suffix:semicolon
)brace
macro_line|#endif
id|req-&gt;buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|req-&gt;context
op_assign
id|skb
suffix:semicolon
id|req-&gt;complete
op_assign
id|tx_complete
suffix:semicolon
multiline_comment|/* use zlp framing on tx for strict CDC-Ether conformance,&n;&t; * though any robust network rx path ignores extra padding.&n;&t; * and some hardware doesn&squot;t like to write zlps.&n;&t; */
id|req-&gt;zero
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;zlp
op_logical_and
(paren
id|length
op_mod
id|dev-&gt;in_ep-&gt;maxpacket
)paren
op_eq
l_int|0
)paren
id|length
op_increment
suffix:semicolon
id|req-&gt;length
op_assign
id|length
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_GADGET_DUALSPEED
multiline_comment|/* throttle highspeed IRQ rate back slightly */
id|req-&gt;no_interrupt
op_assign
(paren
id|dev-&gt;gadget-&gt;speed
op_eq
id|USB_SPEED_HIGH
)paren
ques
c_cond
(paren
(paren
id|atomic_read
(paren
op_amp
id|dev-&gt;tx_qlen
)paren
op_mod
id|TX_DELAY
)paren
op_ne
l_int|0
)paren
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
id|retval
op_assign
id|usb_ep_queue
(paren
id|dev-&gt;in_ep
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|retval
)paren
(brace
r_default
suffix:colon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;tx queue err %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
id|net-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|dev-&gt;tx_qlen
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
)paren
(brace
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
id|drop
suffix:colon
macro_line|#endif
id|dev-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
op_amp
id|dev-&gt;tx_reqs
)paren
)paren
id|netif_start_queue
(paren
id|net
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|dev-&gt;tx_reqs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
DECL|function|rndis_send_media_state
r_static
r_void
id|rndis_send_media_state
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|connect
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|connect
)paren
(brace
r_if
c_cond
(paren
id|rndis_signal_connect
(paren
id|dev-&gt;rndis_config
)paren
)paren
r_return
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|rndis_signal_disconnect
(paren
id|dev-&gt;rndis_config
)paren
)paren
r_return
suffix:semicolon
)brace
)brace
DECL|function|rndis_control_ack
r_static
r_int
id|rndis_control_ack
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|u32
id|length
suffix:semicolon
r_struct
id|usb_request
op_star
id|resp
suffix:semicolon
multiline_comment|/* in case RNDIS calls this after disconnect */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;status_ep
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status ENODEV&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Allocate memory for notification ie. ACK */
id|resp
op_assign
id|usb_ep_alloc_request
(paren
id|dev-&gt;status_ep
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|resp
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status ENOMEM&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|resp-&gt;buf
op_assign
id|usb_ep_alloc_buffer
(paren
id|dev-&gt;status_ep
comma
l_int|8
comma
op_amp
id|resp-&gt;dma
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|resp-&gt;buf
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status buf ENOMEM&bslash;n&quot;
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|dev-&gt;status_ep
comma
id|resp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Send RNDIS RESPONSE_AVAILABLE notification;&n;&t; * CDC_NOTIFY_RESPONSE_AVAILABLE should work too&n;&t; */
id|resp-&gt;length
op_assign
l_int|8
suffix:semicolon
id|resp-&gt;complete
op_assign
id|rndis_response_complete
suffix:semicolon
op_star
(paren
(paren
id|u32
op_star
)paren
id|resp-&gt;buf
)paren
op_assign
id|__constant_cpu_to_le32
(paren
l_int|1
)paren
suffix:semicolon
op_star
(paren
(paren
id|u32
op_star
)paren
id|resp-&gt;buf
op_plus
l_int|1
)paren
op_assign
id|__constant_cpu_to_le32
(paren
l_int|0
)paren
suffix:semicolon
id|length
op_assign
id|usb_ep_queue
(paren
id|dev-&gt;status_ep
comma
id|resp
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
(brace
id|resp-&gt;status
op_assign
l_int|0
suffix:semicolon
id|rndis_response_complete
(paren
id|dev-&gt;status_ep
comma
id|resp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif&t;/* RNDIS */
DECL|function|eth_start
r_static
r_void
id|eth_start
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|gfp_flags
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* fill the rx queue */
id|rx_fill
(paren
id|dev
comma
id|gfp_flags
)paren
suffix:semicolon
multiline_comment|/* and open the tx floodgates */
id|atomic_set
(paren
op_amp
id|dev-&gt;tx_qlen
comma
l_int|0
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
r_if
c_cond
(paren
id|dev-&gt;rndis
)paren
(brace
id|rndis_set_param_medium
(paren
id|dev-&gt;rndis_config
comma
id|NDIS_MEDIUM_802_3
comma
id|BITRATE
c_func
(paren
id|dev-&gt;gadget
)paren
)paren
suffix:semicolon
id|rndis_send_media_state
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif&t;
)brace
DECL|function|eth_open
r_static
r_int
id|eth_open
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_carrier_ok
(paren
id|dev-&gt;net
)paren
)paren
id|eth_start
(paren
id|dev
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth_stop
r_static
r_int
id|eth_stop
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|VDEBUG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|netif_stop_queue
(paren
id|net
)paren
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;stop stats: rx/tx %ld/%ld, errs %ld/%ld&bslash;n&quot;
comma
id|dev-&gt;stats.rx_packets
comma
id|dev-&gt;stats.tx_packets
comma
id|dev-&gt;stats.rx_errors
comma
id|dev-&gt;stats.tx_errors
)paren
suffix:semicolon
multiline_comment|/* ensure there are no more active requests */
r_if
c_cond
(paren
id|dev-&gt;gadget-&gt;speed
op_ne
id|USB_SPEED_UNKNOWN
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;in_ep
)paren
suffix:semicolon
id|usb_ep_disable
(paren
id|dev-&gt;out_ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_carrier_ok
(paren
id|dev-&gt;net
)paren
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;host still using in/out endpoints&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// FIXME idiom may leave toggle wrong here
id|usb_ep_enable
(paren
id|dev-&gt;in_ep
comma
id|dev-&gt;in
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;out_ep
comma
id|dev-&gt;out
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;status_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;status_ep
comma
id|dev-&gt;status
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
r_if
c_cond
(paren
id|dev-&gt;rndis
)paren
(brace
id|rndis_set_param_medium
(paren
id|dev-&gt;rndis_config
comma
id|NDIS_MEDIUM_802_3
comma
l_int|0
)paren
suffix:semicolon
id|rndis_send_media_state
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
DECL|function|eth_unbind
id|eth_unbind
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|get_gadget_data
(paren
id|gadget
)paren
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;unbind&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USB_ETH_RNDIS
id|rndis_deregister
(paren
id|dev-&gt;rndis_config
)paren
suffix:semicolon
id|rndis_exit
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* we&squot;ve already been disconnected ... no i/o is active */
r_if
c_cond
(paren
id|dev-&gt;req
)paren
(brace
id|usb_ep_free_buffer
(paren
id|gadget-&gt;ep0
comma
id|dev-&gt;req-&gt;buf
comma
id|dev-&gt;req-&gt;dma
comma
id|USB_BUFSIZ
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|gadget-&gt;ep0
comma
id|dev-&gt;req
)paren
suffix:semicolon
id|dev-&gt;req
op_assign
l_int|0
suffix:semicolon
)brace
id|unregister_netdev
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev-&gt;net
)paren
suffix:semicolon
multiline_comment|/* assuming we used keventd, it must quiesce too */
id|flush_scheduled_work
(paren
)paren
suffix:semicolon
id|set_gadget_data
(paren
id|gadget
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|eth_bind
id|eth_bind
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
suffix:semicolon
r_struct
id|net_device
op_star
id|net
suffix:semicolon
id|u8
id|cdc
op_assign
l_int|1
comma
id|zlp
op_assign
l_int|1
comma
id|rndis
op_assign
l_int|1
suffix:semicolon
r_struct
id|usb_ep
op_star
id|ep
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* these flags are only ever cleared; compiler take note */
macro_line|#ifndef&t;DEV_CONFIG_CDC
id|cdc
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifndef&t;CONFIG_USB_ETH_RNDIS
id|rndis
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Because most host side USB stacks handle CDC Ethernet, that&n;&t; * standard protocol is _strongly_ preferred for interop purposes.&n;&t; * (By everyone except Microsoft.)&n;&t; */
r_if
c_cond
(paren
id|gadget_is_net2280
(paren
id|gadget
)paren
)paren
(brace
id|device_desc.bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0201
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gadget_is_dummy
(paren
id|gadget
)paren
)paren
(brace
id|device_desc.bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0202
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gadget_is_pxa
(paren
id|gadget
)paren
)paren
(brace
id|device_desc.bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0203
)paren
suffix:semicolon
multiline_comment|/* pxa doesn&squot;t support altsettings */
id|cdc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gadget_is_sh
c_func
(paren
id|gadget
)paren
)paren
(brace
id|device_desc.bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0204
)paren
suffix:semicolon
multiline_comment|/* sh doesn&squot;t support multiple interfaces or configs */
id|cdc
op_assign
l_int|0
suffix:semicolon
id|rndis
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gadget_is_sa1100
(paren
id|gadget
)paren
)paren
(brace
id|device_desc.bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0205
)paren
suffix:semicolon
multiline_comment|/* hardware can&squot;t write zlps */
id|zlp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sa1100 CAN do CDC, without status endpoint ... we use&n;&t;&t; * non-CDC to be compatible with ARM Linux-2.4 &quot;usb-eth&quot;.&n;&t;&t; */
id|cdc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gadget_is_goku
(paren
id|gadget
)paren
)paren
(brace
id|device_desc.bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0206
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gadget_is_mq11xx
(paren
id|gadget
)paren
)paren
(brace
id|device_desc.bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0207
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gadget_is_omap
(paren
id|gadget
)paren
)paren
(brace
id|device_desc.bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0208
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* can&squot;t assume CDC works.  don&squot;t want to default to&n;&t;&t; * anything less functional on CDC-capable hardware,&n;&t;&t; * so we fail in this case.&n;&t;&t; */
id|dev_err
(paren
op_amp
id|gadget-&gt;dev
comma
l_string|&quot;controller &squot;%s&squot; not recognized&bslash;n&quot;
comma
id|gadget-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|snprintf
(paren
id|manufacturer
comma
r_sizeof
id|manufacturer
comma
id|UTS_SYSNAME
l_string|&quot; &quot;
id|UTS_RELEASE
l_string|&quot;/%s&quot;
comma
id|gadget-&gt;name
)paren
suffix:semicolon
multiline_comment|/* CDC subset ... recognized by Linux since 2.4.10, but Windows&n;&t; * drivers aren&squot;t widely available.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|cdc
)paren
(brace
id|device_desc.bDeviceClass
op_assign
id|USB_CLASS_VENDOR_SPEC
suffix:semicolon
id|device_desc.idVendor
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|SIMPLE_VENDOR_NUM
)paren
suffix:semicolon
id|device_desc.idProduct
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|SIMPLE_PRODUCT_NUM
)paren
suffix:semicolon
)brace
multiline_comment|/* If there&squot;s an RNDIS configuration, that&squot;s what Windows wants to&n;&t; * be using ... so use these product IDs here and in the &quot;linux.inf&quot;&n;&t; * needed to install MSFT drivers.  Current Linux kernels will use&n;&t; * the second configuration if it&squot;s CDC Ethernet, and need some help&n;&t; * to choose the right configuration otherwise.&n;&t; */
r_if
c_cond
(paren
id|rndis
)paren
(brace
id|device_desc.idVendor
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|RNDIS_VENDOR_NUM
)paren
suffix:semicolon
id|device_desc.idProduct
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|RNDIS_PRODUCT_NUM
)paren
suffix:semicolon
id|snprintf
(paren
id|product_desc
comma
r_sizeof
id|product_desc
comma
l_string|&quot;RNDIS/%s&quot;
comma
id|driver_desc
)paren
suffix:semicolon
)brace
multiline_comment|/* support optional vendor/distro customization */
r_if
c_cond
(paren
id|idVendor
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|idProduct
)paren
(brace
id|dev_err
(paren
op_amp
id|gadget-&gt;dev
comma
l_string|&quot;idVendor needs idProduct!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|device_desc.idVendor
op_assign
id|cpu_to_le16
c_func
(paren
id|idVendor
)paren
suffix:semicolon
id|device_desc.idProduct
op_assign
id|cpu_to_le16
c_func
(paren
id|idProduct
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcdDevice
)paren
id|device_desc.bcdDevice
op_assign
id|cpu_to_le16
c_func
(paren
id|bcdDevice
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iManufacturer
)paren
id|strlcpy
(paren
id|manufacturer
comma
id|iManufacturer
comma
r_sizeof
id|manufacturer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iProduct
)paren
id|strlcpy
(paren
id|product_desc
comma
id|iProduct
comma
r_sizeof
id|product_desc
)paren
suffix:semicolon
multiline_comment|/* all we really need is bulk IN/OUT */
id|usb_ep_autoconfig_reset
(paren
id|gadget
)paren
suffix:semicolon
id|ep
op_assign
id|usb_ep_autoconfig
(paren
id|gadget
comma
op_amp
id|fs_source_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep
)paren
(brace
id|autoconf_fail
suffix:colon
id|dev_err
(paren
op_amp
id|gadget-&gt;dev
comma
l_string|&quot;can&squot;t autoconfigure on %s&bslash;n&quot;
comma
id|gadget-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|EP_IN_NAME
op_assign
id|ep-&gt;name
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|ep
suffix:semicolon
multiline_comment|/* claim */
id|ep
op_assign
id|usb_ep_autoconfig
(paren
id|gadget
comma
op_amp
id|fs_sink_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep
)paren
r_goto
id|autoconf_fail
suffix:semicolon
id|EP_OUT_NAME
op_assign
id|ep-&gt;name
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|ep
suffix:semicolon
multiline_comment|/* claim */
multiline_comment|/* CDC Ethernet control interface doesn&squot;t require a status endpoint.&n;&t; * Since some hosts expect one, try to allocate one anyway.&n;&t; */
r_if
c_cond
(paren
id|cdc
op_logical_or
id|rndis
)paren
(brace
id|ep
op_assign
id|usb_ep_autoconfig
(paren
id|gadget
comma
op_amp
id|fs_status_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep
)paren
(brace
id|EP_STATUS_NAME
op_assign
id|ep-&gt;name
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|ep
suffix:semicolon
multiline_comment|/* claim */
)brace
r_else
r_if
c_cond
(paren
id|rndis
)paren
(brace
id|dev_err
(paren
op_amp
id|gadget-&gt;dev
comma
l_string|&quot;can&squot;t run RNDIS on %s&bslash;n&quot;
comma
id|gadget-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifdef&t;DEV_CONFIG_CDC
)brace
r_else
r_if
c_cond
(paren
id|cdc
)paren
(brace
id|control_intf.bNumEndpoints
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME remove endpoint from descriptor list */
macro_line|#endif
)brace
)brace
multiline_comment|/* one config:  cdc, else minimal subset */
r_if
c_cond
(paren
op_logical_neg
id|cdc
)paren
(brace
id|eth_config.bNumInterfaces
op_assign
l_int|1
suffix:semicolon
id|eth_config.iConfiguration
op_assign
id|STRING_SUBSET
suffix:semicolon
id|fs_subset_descriptors
c_func
(paren
)paren
suffix:semicolon
id|hs_subset_descriptors
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* For now RNDIS is always a second config */
r_if
c_cond
(paren
id|rndis
)paren
id|device_desc.bNumConfigurations
op_assign
l_int|2
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_GADGET_DUALSPEED
r_if
c_cond
(paren
id|rndis
)paren
id|dev_qualifier.bNumConfigurations
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|cdc
)paren
id|dev_qualifier.bDeviceClass
op_assign
id|USB_CLASS_VENDOR_SPEC
suffix:semicolon
multiline_comment|/* assumes ep0 uses the same value for both speeds ... */
id|dev_qualifier.bMaxPacketSize0
op_assign
id|device_desc.bMaxPacketSize0
suffix:semicolon
multiline_comment|/* and that all endpoints are dual-speed */
id|hs_source_desc.bEndpointAddress
op_assign
id|fs_source_desc.bEndpointAddress
suffix:semicolon
id|hs_sink_desc.bEndpointAddress
op_assign
id|fs_sink_desc.bEndpointAddress
suffix:semicolon
macro_line|#if defined(DEV_CONFIG_CDC) || defined(CONFIG_USB_ETH_RNDIS)
r_if
c_cond
(paren
id|EP_STATUS_NAME
)paren
id|hs_status_desc.bEndpointAddress
op_assign
id|fs_status_desc.bEndpointAddress
suffix:semicolon
macro_line|#endif
macro_line|#endif&t;/* DUALSPEED */
id|device_desc.bMaxPacketSize0
op_assign
id|gadget-&gt;ep0-&gt;maxpacket
suffix:semicolon
id|usb_gadget_set_selfpowered
(paren
id|gadget
)paren
suffix:semicolon
id|net
op_assign
id|alloc_etherdev
(paren
r_sizeof
op_star
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|net
)paren
r_return
id|status
suffix:semicolon
id|dev
op_assign
id|net-&gt;priv
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|INIT_WORK
(paren
op_amp
id|dev-&gt;work
comma
id|eth_work
comma
id|dev
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|dev-&gt;tx_reqs
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|dev-&gt;rx_reqs
)paren
suffix:semicolon
multiline_comment|/* network device setup */
id|dev-&gt;net
op_assign
id|net
suffix:semicolon
id|SET_MODULE_OWNER
(paren
id|net
)paren
suffix:semicolon
id|strcpy
(paren
id|net-&gt;name
comma
l_string|&quot;usb%d&quot;
)paren
suffix:semicolon
id|dev-&gt;cdc
op_assign
id|cdc
suffix:semicolon
id|dev-&gt;zlp
op_assign
id|zlp
suffix:semicolon
multiline_comment|/* FIXME make these addresses configurable with module params.&n;&t; * also the manufacturer and product strings.&n;&t; */
multiline_comment|/* one random address for the gadget device ... both of these could&n;&t; * reasonably come from an id prom or a module parameter.&n;&t; */
id|random_ether_addr
c_func
(paren
id|net-&gt;dev_addr
)paren
suffix:semicolon
multiline_comment|/* ... another address for the host, on the other end of the&n;&t; * link, gets exported through CDC (see CDC spec table 41)&n;&t; * and RNDIS.&n;&t; */
r_if
c_cond
(paren
id|cdc
op_logical_or
id|rndis
)paren
(brace
id|random_ether_addr
c_func
(paren
id|dev-&gt;host_mac
)paren
suffix:semicolon
macro_line|#ifdef&t;DEV_CONFIG_CDC
id|snprintf
(paren
id|ethaddr
comma
r_sizeof
id|ethaddr
comma
l_string|&quot;%02X%02X%02X%02X%02X%02X&quot;
comma
id|dev-&gt;host_mac
(braket
l_int|0
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|1
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|2
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|3
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|4
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|rndis
)paren
(brace
id|status
op_assign
id|rndis_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
id|dev_err
(paren
op_amp
id|gadget-&gt;dev
comma
l_string|&quot;can&squot;t init RNDIS, %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
)brace
id|net-&gt;change_mtu
op_assign
id|eth_change_mtu
suffix:semicolon
id|net-&gt;get_stats
op_assign
id|eth_get_stats
suffix:semicolon
id|net-&gt;hard_start_xmit
op_assign
id|eth_start_xmit
suffix:semicolon
id|net-&gt;open
op_assign
id|eth_open
suffix:semicolon
id|net-&gt;stop
op_assign
id|eth_stop
suffix:semicolon
singleline_comment|// watchdog_timeo, tx_timeout ...
singleline_comment|// set_multicast_list
id|net-&gt;do_ioctl
op_assign
id|eth_ioctl
suffix:semicolon
multiline_comment|/* preallocate control response and buffer */
id|dev-&gt;req
op_assign
id|usb_ep_alloc_request
(paren
id|gadget-&gt;ep0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;req
)paren
r_goto
id|fail
suffix:semicolon
id|dev-&gt;req-&gt;complete
op_assign
id|eth_setup_complete
suffix:semicolon
id|dev-&gt;req-&gt;buf
op_assign
id|usb_ep_alloc_buffer
(paren
id|gadget-&gt;ep0
comma
id|USB_BUFSIZ
comma
op_amp
id|dev-&gt;req-&gt;dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;req-&gt;buf
)paren
(brace
id|usb_ep_free_request
(paren
id|gadget-&gt;ep0
comma
id|dev-&gt;req
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* finish hookup to lower layer ... */
id|dev-&gt;gadget
op_assign
id|gadget
suffix:semicolon
id|set_gadget_data
(paren
id|gadget
comma
id|dev
)paren
suffix:semicolon
id|gadget-&gt;ep0-&gt;driver_data
op_assign
id|dev
suffix:semicolon
multiline_comment|/* two kinds of host-initiated state changes:&n;&t; *  - iff DATA transfer is active, carrier is &quot;on&quot;&n;&t; *  - tx queueing enabled if open *and* carrier is &quot;on&quot;&n;&t; */
id|netif_stop_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|netif_carrier_off
(paren
id|dev-&gt;net
)paren
suffix:semicolon
singleline_comment|// SET_NETDEV_DEV (dev-&gt;net, &amp;gadget-&gt;dev);
id|status
op_assign
id|register_netdev
(paren
id|dev-&gt;net
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_goto
id|fail1
suffix:semicolon
id|INFO
(paren
id|dev
comma
l_string|&quot;%s, version: &quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
comma
id|driver_desc
)paren
suffix:semicolon
id|INFO
(paren
id|dev
comma
l_string|&quot;using %s, OUT %s IN %s%s%s&bslash;n&quot;
comma
id|gadget-&gt;name
comma
id|EP_OUT_NAME
comma
id|EP_IN_NAME
comma
id|EP_STATUS_NAME
ques
c_cond
l_string|&quot; STATUS &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|EP_STATUS_NAME
ques
c_cond
id|EP_STATUS_NAME
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|INFO
(paren
id|dev
comma
l_string|&quot;MAC %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|net-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|net-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|net-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|net-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|net-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|net-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdc
op_logical_or
id|rndis
)paren
id|INFO
(paren
id|dev
comma
l_string|&quot;HOST MAC %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|dev-&gt;host_mac
(braket
l_int|0
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|1
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|2
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|3
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|4
)braket
comma
id|dev-&gt;host_mac
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_ETH_RNDIS
r_if
c_cond
(paren
id|rndis
)paren
(brace
id|u32
id|vendorID
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME RNDIS vendor id == &quot;vendor NIC code&quot; == ? */
id|dev-&gt;rndis_config
op_assign
id|rndis_register
(paren
id|rndis_control_ack
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rndis_config
OL
l_int|0
)paren
(brace
id|fail0
suffix:colon
id|unregister_netdev
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* these set up a lot of the OIDs that RNDIS needs */
id|rndis_set_host_mac
(paren
id|dev-&gt;rndis_config
comma
id|dev-&gt;host_mac
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rndis_set_param_dev
(paren
id|dev-&gt;rndis_config
comma
id|dev-&gt;net
comma
op_amp
id|dev-&gt;stats
)paren
)paren
r_goto
id|fail0
suffix:semicolon
r_if
c_cond
(paren
id|rndis_set_param_vendor
(paren
id|dev-&gt;rndis_config
comma
id|vendorID
comma
id|manufacturer
)paren
)paren
r_goto
id|fail0
suffix:semicolon
r_if
c_cond
(paren
id|rndis_set_param_medium
(paren
id|dev-&gt;rndis_config
comma
id|NDIS_MEDIUM_802_3
comma
l_int|0
)paren
)paren
r_goto
id|fail0
suffix:semicolon
id|INFO
(paren
id|dev
comma
l_string|&quot;RNDIS ready&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;
r_return
id|status
suffix:semicolon
id|fail1
suffix:colon
id|dev_dbg
c_func
(paren
op_amp
id|gadget-&gt;dev
comma
l_string|&quot;register_netdev failed, %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|fail
suffix:colon
id|eth_unbind
(paren
id|gadget
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|eth_driver
r_static
r_struct
id|usb_gadget_driver
id|eth_driver
op_assign
(brace
macro_line|#ifdef CONFIG_USB_GADGET_DUALSPEED
dot
id|speed
op_assign
id|USB_SPEED_HIGH
comma
macro_line|#else
dot
id|speed
op_assign
id|USB_SPEED_FULL
comma
macro_line|#endif
dot
id|function
op_assign
(paren
r_char
op_star
)paren
id|driver_desc
comma
dot
id|bind
op_assign
id|eth_bind
comma
dot
id|unbind
op_assign
id|eth_unbind
comma
dot
id|setup
op_assign
id|eth_setup
comma
dot
id|disconnect
op_assign
id|eth_disconnect
comma
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
id|shortname
comma
singleline_comment|// .shutdown = ...
singleline_comment|// .suspend = ...
singleline_comment|// .resume = ...
)brace
comma
)brace
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;David Brownell, Benedikt Spanger&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
(paren
r_void
)paren
(brace
r_return
id|usb_gadget_register_driver
(paren
op_amp
id|eth_driver
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
(paren
id|init
)paren
suffix:semicolon
DECL|function|cleanup
r_static
r_void
id|__exit
id|cleanup
(paren
r_void
)paren
(brace
id|usb_gadget_unregister_driver
(paren
op_amp
id|eth_driver
)paren
suffix:semicolon
)brace
DECL|variable|cleanup
id|module_exit
(paren
id|cleanup
)paren
suffix:semicolon
eof
