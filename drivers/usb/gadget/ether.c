multiline_comment|/*&n; * ether.c -- Ethernet gadget driver, with CDC and non-CDC options&n; *&n; * Copyright (C) 2003 David Brownell&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
DECL|macro|DEBUG
mdefine_line|#define DEBUG 1
singleline_comment|// #define VERBOSE
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/uts.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &lt;linux/usb_ch9.h&gt;
macro_line|#include &lt;linux/usb_gadget.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/*&n; * Ethernet gadget driver -- with CDC and non-CDC options&n; *&n; * CDC Ethernet is the standard USB solution for sending Ethernet frames&n; * using USB.  Real hardware tends to use the same framing protocol but look&n; * different for control features.  And Microsoft pushes their own approach&n; * (RNDIS) instead of the standard.&n; *&n; * There&squot;s some hardware that can&squot;t talk CDC.  We make that hardware&n; * implement a &quot;minimalist&quot; vendor-agnostic CDC core:  same framing, but&n; * link-level setup only requires activating the configuration.&n; */
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&t;&quot;Ethernet Gadget&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&t;&quot;Bastille Day 2003&quot;
DECL|variable|shortname
r_static
r_const
r_char
id|shortname
(braket
)braket
op_assign
l_string|&quot;ether&quot;
suffix:semicolon
DECL|variable|driver_desc
r_static
r_const
r_char
id|driver_desc
(braket
)braket
op_assign
id|DRIVER_DESC
suffix:semicolon
DECL|macro|MIN_PACKET
mdefine_line|#define MIN_PACKET&t;sizeof(struct ethhdr)
DECL|macro|MAX_PACKET
mdefine_line|#define&t;MAX_PACKET&t;ETH_DATA_LEN&t;/* biggest packet we&squot;ll rx/tx */
DECL|macro|RX_EXTRA
mdefine_line|#define RX_EXTRA&t;20&t;&t;/* guard against rx overflows */
multiline_comment|/* FIXME allow high speed jumbograms */
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|struct|eth_dev
r_struct
id|eth_dev
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|gadget
r_struct
id|usb_gadget
op_star
id|gadget
suffix:semicolon
DECL|member|req
r_struct
id|usb_request
op_star
id|req
suffix:semicolon
multiline_comment|/* for control responses */
DECL|member|config
id|u8
id|config
suffix:semicolon
DECL|member|in_ep
DECL|member|out_ep
DECL|member|status_ep
r_struct
id|usb_ep
op_star
id|in_ep
comma
op_star
id|out_ep
comma
op_star
id|status_ep
suffix:semicolon
r_const
r_struct
id|usb_endpoint_descriptor
DECL|member|in
DECL|member|out
DECL|member|status
op_star
id|in
comma
op_star
id|out
comma
op_star
id|status
suffix:semicolon
DECL|member|net
r_struct
id|net_device
op_star
id|net
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_qlen
id|atomic_t
id|tx_qlen
suffix:semicolon
DECL|member|work
r_struct
id|work_struct
id|work
suffix:semicolon
DECL|member|todo
r_int
r_int
id|todo
suffix:semicolon
DECL|macro|WORK_RX_MEMORY
mdefine_line|#define&t;WORK_RX_MEMORY&t;&t;0
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* This driver keeps a variable number of requests queued, more at&n; * high speeds.  (Numbers are just educated guesses, untuned.)&n; * Shrink the queue if memory is tight, or make it bigger to&n; * handle bigger traffic bursts between IRQs.&n; */
DECL|variable|qmult
r_static
r_int
id|qmult
op_assign
l_int|4
suffix:semicolon
DECL|macro|HS_FACTOR
mdefine_line|#define HS_FACTOR&t;5
DECL|macro|qlen
mdefine_line|#define qlen(gadget) &bslash;&n;&t;(qmult*((gadget-&gt;speed == USB_SPEED_HIGH) ? HS_FACTOR : 1))
multiline_comment|/* defer IRQs on highspeed TX */
DECL|macro|TX_DELAY
mdefine_line|#define TX_DELAY&t;8
id|module_param
(paren
id|qmult
comma
id|uint
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Thanks to NetChip Technologies for donating this product ID.&n; *&n; * DO NOT REUSE THESE IDs with a protocol-incompatible driver!!  Ever!!&n; * Instead:  allocate your own, using normal USB-IF procedures.&n; */
DECL|macro|DRIVER_VENDOR_NUM
mdefine_line|#define DRIVER_VENDOR_NUM&t;0x0525&t;&t;/* NetChip */
DECL|macro|DRIVER_PRODUCT_NUM
mdefine_line|#define DRIVER_PRODUCT_NUM&t;0xa4a1&t;&t;/* Linux-USB Ethernet Gadget */
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/*&n; * hardware-specific configuration, controlled by which device&n; * controller driver was configured.&n; *&n; * CHIP ... hardware identifier&n; * DRIVER_VERSION_NUM ... alerts the host side driver to differences&n; * EP0_MAXPACKET ... controls packetization of control requests&n; * EP_*_NAME ... which endpoints do we use for which purpose?&n; * EP_*_NUM ... numbers for them (often limited by hardware)&n; * HIGHSPEED ... define if ep0 and descriptors need high speed support&n; * MAX_USB_POWER ... define if we use other than 100 mA bus current&n; * SELFPOWER ... unless we can run on bus power, USB_CONFIG_ATT_SELFPOWER&n; * WAKEUP ... if hardware supports remote wakeup AND we will issue the&n; * &t;usb_gadget_wakeup() call to initiate it, USB_CONFIG_ATT_WAKEUP&n; *&n; * hw_optimize(gadget) ... for any hardware tweaks we want to kick in&n; * &t;before we enable our endpoints&n; *&n; * add other defines for other portability issues, like hardware that&n; * for some reason doesn&squot;t handle full speed bulk maxpacket of 64.&n; */
DECL|macro|DEV_CONFIG_VALUE
mdefine_line|#define DEV_CONFIG_VALUE&t;3&t;/* some hardware cares */
multiline_comment|/* #undef on hardware that can&squot;t implement CDC */
DECL|macro|DEV_CONFIG_CDC
mdefine_line|#define&t;DEV_CONFIG_CDC
multiline_comment|/*&n; * NetChip 2280, PCI based.&n; *&n; * use DMA with fat fifos for all data traffic, PIO for the status channel&n; * where its 64 byte maxpacket ceiling is no issue.&n; *&n; * performance note:  only PIO needs per-usb-packet IRQs (ep0, ep-e, ep-f)&n; * otherwise IRQs are per-Ethernet-packet unless TX_DELAY and chaining help.&n; */
macro_line|#ifdef&t;CONFIG_USB_ETH_NET2280
DECL|macro|CHIP
mdefine_line|#define CHIP&t;&t;&t;&quot;net2280&quot;
DECL|macro|DRIVER_VERSION_NUM
mdefine_line|#define DRIVER_VERSION_NUM&t;0x0101
DECL|macro|EP0_MAXPACKET
mdefine_line|#define EP0_MAXPACKET&t;&t;64
DECL|variable|EP_OUT_NAME
r_static
r_const
r_char
id|EP_OUT_NAME
(braket
)braket
op_assign
l_string|&quot;ep-a&quot;
suffix:semicolon
DECL|macro|EP_OUT_NUM
mdefine_line|#define EP_OUT_NUM&t;1
DECL|variable|EP_IN_NAME
r_static
r_const
r_char
id|EP_IN_NAME
(braket
)braket
op_assign
l_string|&quot;ep-b&quot;
suffix:semicolon
DECL|macro|EP_IN_NUM
mdefine_line|#define EP_IN_NUM&t;2
DECL|variable|EP_STATUS_NAME
r_static
r_const
r_char
id|EP_STATUS_NAME
(braket
)braket
op_assign
l_string|&quot;ep-f&quot;
suffix:semicolon
DECL|macro|EP_STATUS_NUM
mdefine_line|#define EP_STATUS_NUM&t;3
DECL|macro|HIGHSPEED
mdefine_line|#define HIGHSPEED
multiline_comment|/* specific hardware configs could be bus-powered */
DECL|macro|SELFPOWER
mdefine_line|#define SELFPOWER USB_CONFIG_ATT_SELFPOWER
multiline_comment|/* supports remote wakeup, but this driver doesn&squot;t */
r_extern
r_int
id|net2280_set_fifo_mode
(paren
r_struct
id|usb_gadget
op_star
id|gadget
comma
r_int
id|mode
)paren
suffix:semicolon
DECL|function|hw_optimize
r_static
r_inline
r_void
id|hw_optimize
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
multiline_comment|/* we can have bigger ep-a/ep-b fifos (2KB each, 4 USB packets&n;&t; * for highspeed bulk) because we&squot;re not using ep-c/ep-d.&n;&t; */
id|net2280_set_fifo_mode
(paren
id|gadget
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * PXA-2xx UDC:  widely used in second gen Linux-capable ARM PDAs&n; * and other products.&n; *&n; * multiple interfaces (or altsettings) aren&squot;t usable.  so this hardware&n; * can&squot;t implement CDC, which needs both capabilities.&n; */
macro_line|#ifdef&t;CONFIG_USB_ETH_PXA2XX
DECL|macro|DEV_CONFIG_CDC
macro_line|#undef&t;DEV_CONFIG_CDC
DECL|macro|CHIP
mdefine_line|#define CHIP&t;&t;&t;&quot;pxa2xx&quot;
DECL|macro|DRIVER_VERSION_NUM
mdefine_line|#define DRIVER_VERSION_NUM&t;0x0103
DECL|macro|EP0_MAXPACKET
mdefine_line|#define EP0_MAXPACKET&t;&t;16
DECL|variable|EP_OUT_NAME
r_static
r_const
r_char
id|EP_OUT_NAME
(braket
)braket
op_assign
l_string|&quot;ep2out-bulk&quot;
suffix:semicolon
DECL|macro|EP_OUT_NUM
mdefine_line|#define EP_OUT_NUM&t;2
DECL|variable|EP_IN_NAME
r_static
r_const
r_char
id|EP_IN_NAME
(braket
)braket
op_assign
l_string|&quot;ep1in-bulk&quot;
suffix:semicolon
DECL|macro|EP_IN_NUM
mdefine_line|#define EP_IN_NUM&t;1
multiline_comment|/* doesn&squot;t support bus-powered operation */
DECL|macro|SELFPOWER
mdefine_line|#define SELFPOWER USB_CONFIG_ATT_SELFPOWER
multiline_comment|/* supports remote wakeup, but this driver doesn&squot;t */
multiline_comment|/* no hw optimizations to apply */
DECL|macro|hw_optimize
mdefine_line|#define hw_optimize(g) do {} while (0);
macro_line|#endif
multiline_comment|/*&n; * SA-1100 UDC:  widely used in first gen Linux-capable PDAs.&n; *&n; * can&squot;t have a notification endpoint, since there are only the two&n; * bulk-capable ones.  the CDC spec allows that.&n; */
macro_line|#ifdef&t;CONFIG_USB_ETH_SA1100
DECL|macro|CHIP
mdefine_line|#define CHIP&t;&t;&t;&quot;sa1100&quot;
DECL|macro|DRIVER_VERSION_NUM
mdefine_line|#define DRIVER_VERSION_NUM&t;0x0105
DECL|macro|EP0_MAXPACKET
mdefine_line|#define EP0_MAXPACKET&t;&t;8
DECL|variable|EP_OUT_NAME
r_static
r_const
r_char
id|EP_OUT_NAME
(braket
)braket
op_assign
l_string|&quot;ep1out-bulk&quot;
suffix:semicolon
DECL|macro|EP_OUT_NUM
mdefine_line|#define EP_OUT_NUM&t;1
DECL|variable|EP_IN_NAME
r_static
r_const
r_char
id|EP_IN_NAME
(braket
)braket
op_assign
l_string|&quot;ep2in-bulk&quot;
suffix:semicolon
DECL|macro|EP_IN_NUM
mdefine_line|#define EP_IN_NUM&t;2
singleline_comment|// EP_STATUS_NUM is undefined
multiline_comment|/* doesn&squot;t support bus-powered operation */
DECL|macro|SELFPOWER
mdefine_line|#define SELFPOWER USB_CONFIG_ATT_SELFPOWER
multiline_comment|/* doesn&squot;t support remote wakeup? */
multiline_comment|/* no hw optimizations to apply */
DECL|macro|hw_optimize
mdefine_line|#define hw_optimize(g) do {} while (0);
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifndef EP0_MAXPACKET
macro_line|#&t;error Configure some USB peripheral controller driver!
macro_line|#endif
multiline_comment|/* We normally expect hardware that can talk CDC.  That involves&n; * using multiple interfaces and altsettings, and maybe a status&n; * interrupt.  Driver binding to be done according to USB-IF class,&n; * though you can use different VENDOR and PRODUCT numbers if you&n; * want (and they&squot;re officially assigned).&n; * &n; * For hardware that can&squot;t talk CDC, we use the same vendor ID that&n; * ARM Linux has used for ethernet-over-usb, both with sa1100 and&n; * with pxa250.  We&squot;re protocol-compatible, if the host-side drivers&n; * use the endpoint descriptors.  DRIVER_VERSION_NUM is nonzero, so&n; * drivers that need to hard-wire endpoint numbers have a hook.&n; */
macro_line|#ifdef&t;DEV_CONFIG_CDC
DECL|macro|DEV_CONFIG_CLASS
mdefine_line|#define&t;DEV_CONFIG_CLASS&t;USB_CLASS_COMM
macro_line|#else&t;
DECL|macro|DEV_CONFIG_CLASS
mdefine_line|#define&t;DEV_CONFIG_CLASS&t;USB_CLASS_VENDOR_SPEC
DECL|macro|EP_STATUS_NUM
macro_line|#undef&t;EP_STATUS_NUM
DECL|macro|DRIVER_VENDOR_NUM
macro_line|#undef&t;DRIVER_VENDOR_NUM
DECL|macro|DRIVER_PRODUCT_NUM
macro_line|#undef&t;DRIVER_PRODUCT_NUM
DECL|macro|DRIVER_VENDOR_NUM
mdefine_line|#define&t;DRIVER_VENDOR_NUM&t;0x049f
DECL|macro|DRIVER_PRODUCT_NUM
mdefine_line|#define&t;DRIVER_PRODUCT_NUM&t;0x505a
macro_line|#endif /* CONFIG_CDC_ETHER */
multiline_comment|/* power usage is config specific.&n; * hardware that supports remote wakeup defaults to disabling it.&n; */
macro_line|#ifndef&t;SELFPOWER
multiline_comment|/* default: say we rely on bus power */
DECL|macro|SELFPOWER
mdefine_line|#define SELFPOWER&t;0
multiline_comment|/* else:&n; * - SELFPOWER value must be USB_CONFIG_ATT_SELFPOWER&n; * - MAX_USB_POWER may be nonzero.&n; */
macro_line|#endif
macro_line|#ifndef&t;MAX_USB_POWER
multiline_comment|/* any hub supports this steady state bus power consumption */
DECL|macro|MAX_USB_POWER
mdefine_line|#define MAX_USB_POWER&t;100&t;/* mA */
macro_line|#endif
macro_line|#ifndef&t;WAKEUP
multiline_comment|/* default: this driver won&squot;t do remote wakeup */
DECL|macro|WAKEUP
mdefine_line|#define WAKEUP&t;&t;0
multiline_comment|/* else value must be USB_CONFIG_ATT_WAKEUP */
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|xprintk
mdefine_line|#define xprintk(d,level,fmt,args...) &bslash;&n;&t;printk(level &quot;%s %s: &quot; fmt , shortname , (d)-&gt;gadget-&gt;dev.bus_id , &bslash;&n;&t;&t;## args)
macro_line|#ifdef DEBUG
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG(dev,fmt,args...) &bslash;&n;&t;xprintk(dev , KERN_DEBUG , fmt , ## args)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(dev,fmt,args...) &bslash;&n;&t;do { } while (0)
macro_line|#endif /* DEBUG */
macro_line|#ifdef VERBOSE
DECL|macro|VDEBUG
mdefine_line|#define VDEBUG&t;DEBUG
macro_line|#else
DECL|macro|VDEBUG
mdefine_line|#define VDEBUG(dev,fmt,args...) &bslash;&n;&t;do { } while (0)
macro_line|#endif /* DEBUG */
DECL|macro|ERROR
mdefine_line|#define ERROR(dev,fmt,args...) &bslash;&n;&t;xprintk(dev , KERN_ERR , fmt , ## args)
DECL|macro|WARN
mdefine_line|#define WARN(dev,fmt,args...) &bslash;&n;&t;xprintk(dev , KERN_WARNING , fmt , ## args)
DECL|macro|INFO
mdefine_line|#define INFO(dev,fmt,args...) &bslash;&n;&t;xprintk(dev , KERN_INFO , fmt , ## args)
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* USB DRIVER HOOKUP (to the hardware driver, below us), mostly&n; * ep0 implementation:  descriptors, config management, setup().&n; * also optional class-specific notification interrupt transfer.&n; */
multiline_comment|/*&n; * DESCRIPTORS ... most are static, but strings and (full) configuration&n; * descriptors are built on demand.  Notice how most of the cdc descriptors&n; * aren&squot;t needed in the &quot;minimalist&quot; mode.&n; */
DECL|macro|STRING_MANUFACTURER
mdefine_line|#define STRING_MANUFACTURER&t;&t;1
DECL|macro|STRING_PRODUCT
mdefine_line|#define STRING_PRODUCT&t;&t;&t;2
DECL|macro|STRING_ETHADDR
mdefine_line|#define STRING_ETHADDR&t;&t;&t;3
DECL|macro|STRING_DATA
mdefine_line|#define STRING_DATA&t;&t;&t;4
DECL|macro|STRING_CONTROL
mdefine_line|#define STRING_CONTROL&t;&t;&t;5
DECL|macro|USB_BUFSIZ
mdefine_line|#define USB_BUFSIZ&t;256&t;&t;/* holds our biggest descriptor */
multiline_comment|/*&n; * This device advertises one configuration.&n; */
r_static
r_const
r_struct
id|usb_device_descriptor
DECL|variable|device_desc
id|device_desc
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|device_desc
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_DEVICE
comma
dot
id|bcdUSB
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0200
)paren
comma
dot
id|bDeviceClass
op_assign
id|DEV_CONFIG_CLASS
comma
dot
id|bDeviceSubClass
op_assign
l_int|0
comma
dot
id|bDeviceProtocol
op_assign
l_int|0
comma
dot
id|bMaxPacketSize0
op_assign
id|EP0_MAXPACKET
comma
dot
id|idVendor
op_assign
id|__constant_cpu_to_le16
(paren
id|DRIVER_VENDOR_NUM
)paren
comma
dot
id|idProduct
op_assign
id|__constant_cpu_to_le16
(paren
id|DRIVER_PRODUCT_NUM
)paren
comma
dot
id|bcdDevice
op_assign
id|__constant_cpu_to_le16
(paren
id|DRIVER_VERSION_NUM
)paren
comma
dot
id|iManufacturer
op_assign
id|STRING_MANUFACTURER
comma
dot
id|iProduct
op_assign
id|STRING_PRODUCT
comma
dot
id|bNumConfigurations
op_assign
l_int|1
comma
)brace
suffix:semicolon
r_static
r_const
r_struct
id|usb_config_descriptor
DECL|variable|eth_config
id|eth_config
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|eth_config
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_CONFIG
comma
multiline_comment|/* compute wTotalLength on the fly */
macro_line|#ifdef&t;DEV_CONFIG_CDC
dot
id|bNumInterfaces
op_assign
l_int|2
comma
macro_line|#else
dot
id|bNumInterfaces
op_assign
l_int|1
comma
macro_line|#endif
dot
id|bConfigurationValue
op_assign
id|DEV_CONFIG_VALUE
comma
dot
id|iConfiguration
op_assign
id|STRING_PRODUCT
comma
dot
id|bmAttributes
op_assign
id|USB_CONFIG_ATT_ONE
op_or
id|SELFPOWER
op_or
id|WAKEUP
comma
dot
id|bMaxPower
op_assign
(paren
id|MAX_USB_POWER
op_plus
l_int|1
)paren
op_div
l_int|2
comma
)brace
suffix:semicolon
macro_line|#ifdef&t;DEV_CONFIG_CDC
multiline_comment|/*&n; * Compared to the &quot;minimalist&quot; non-CDC model, the CDC model adds&n; * three class descriptors, two interface descrioptors, and a status&n; * endpoint.  Both have a &quot;data&quot; interface and two bulk endpoints.&n; * There are also differences in how control requests are handled.&n; */
multiline_comment|/* master comm interface optionally has a status notification endpoint */
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|control_intf
id|control_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|control_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|0
comma
macro_line|#ifdef&t;EP_STATUS_NUM
dot
id|bNumEndpoints
op_assign
l_int|1
comma
macro_line|#else
dot
id|bNumEndpoints
op_assign
l_int|0
comma
macro_line|#endif
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_COMM
comma
dot
id|bInterfaceSubClass
op_assign
l_int|6
comma
multiline_comment|/* ethernet control model */
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
dot
id|iInterface
op_assign
id|STRING_CONTROL
comma
)brace
suffix:semicolon
multiline_comment|/* &quot;Header Functional Descriptor&quot; from CDC spec  5.2.3.1 */
DECL|struct|header_desc
r_struct
id|header_desc
(brace
DECL|member|bLength
id|u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubType
id|u8
id|bDescriptorSubType
suffix:semicolon
DECL|member|bcdCDC
id|u16
id|bcdCDC
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|header_desc
r_static
r_const
r_struct
id|header_desc
id|header_desc
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|header_desc
comma
dot
id|bDescriptorType
op_assign
l_int|0x24
comma
dot
id|bDescriptorSubType
op_assign
l_int|0
comma
dot
id|bcdCDC
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0110
)paren
comma
)brace
suffix:semicolon
multiline_comment|/* &quot;Union Functional Descriptor&quot; from CDC spec 5.2.3.X */
DECL|struct|union_desc
r_struct
id|union_desc
(brace
DECL|member|bLength
id|u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubType
id|u8
id|bDescriptorSubType
suffix:semicolon
DECL|member|bMasterInterface0
id|u8
id|bMasterInterface0
suffix:semicolon
DECL|member|bSlaveInterface0
id|u8
id|bSlaveInterface0
suffix:semicolon
multiline_comment|/* ... and there could be other slave interfaces */
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|union_desc
r_static
r_const
r_struct
id|union_desc
id|union_desc
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|union_desc
comma
dot
id|bDescriptorType
op_assign
l_int|0x24
comma
dot
id|bDescriptorSubType
op_assign
l_int|6
comma
dot
id|bMasterInterface0
op_assign
l_int|0
comma
multiline_comment|/* index of control interface */
dot
id|bSlaveInterface0
op_assign
l_int|1
comma
multiline_comment|/* index of DATA interface */
)brace
suffix:semicolon
multiline_comment|/* &quot;Ethernet Networking Functional Descriptor&quot; from CDC spec 5.2.3.16 */
DECL|struct|ether_desc
r_struct
id|ether_desc
(brace
DECL|member|bLength
id|u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubType
id|u8
id|bDescriptorSubType
suffix:semicolon
DECL|member|iMACAddress
id|u8
id|iMACAddress
suffix:semicolon
DECL|member|bmEthernetStatistics
id|u32
id|bmEthernetStatistics
suffix:semicolon
DECL|member|wMaxSegmentSize
id|u16
id|wMaxSegmentSize
suffix:semicolon
DECL|member|wNumberMCFilters
id|u16
id|wNumberMCFilters
suffix:semicolon
DECL|member|bNumberPowerFilters
id|u8
id|bNumberPowerFilters
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|ether_desc
r_static
r_const
r_struct
id|ether_desc
id|ether_desc
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|ether_desc
comma
dot
id|bDescriptorType
op_assign
l_int|0x24
comma
dot
id|bDescriptorSubType
op_assign
l_int|0x0f
comma
multiline_comment|/* this descriptor actually adds value, surprise! */
dot
id|iMACAddress
op_assign
id|STRING_ETHADDR
comma
dot
id|bmEthernetStatistics
op_assign
id|__constant_cpu_to_le32
(paren
l_int|0
)paren
comma
multiline_comment|/* no statistics */
dot
id|wMaxSegmentSize
op_assign
id|__constant_cpu_to_le16
(paren
id|MAX_PACKET
op_plus
id|ETH_HLEN
)paren
comma
dot
id|wNumberMCFilters
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0
)paren
comma
dot
id|bNumberPowerFilters
op_assign
l_int|0
comma
)brace
suffix:semicolon
macro_line|#ifdef&t;EP_STATUS_NUM
multiline_comment|/* include the status endpoint if we can, even though it&squot;s optional.&n; *&n; * some drivers (like current Linux cdc-ether!) &quot;need&quot; it to exist even&n; * if they ignore the connect/disconnect notifications that real aether&n; * can provide.  more advanced cdc configurations might want to support&n; * encapsulated commands (vendor-specific, using control-OUT).&n; */
DECL|macro|LOG2_STATUS_INTERVAL_MSEC
mdefine_line|#define LOG2_STATUS_INTERVAL_MSEC&t;6
DECL|macro|STATUS_BYTECOUNT
mdefine_line|#define STATUS_BYTECOUNT&t;&t;16&t;/* 8 byte header + data */
r_static
r_const
r_struct
id|usb_endpoint_descriptor
DECL|variable|fs_status_desc
id|fs_status_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|EP_STATUS_NUM
op_or
id|USB_DIR_IN
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_INT
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
id|STATUS_BYTECOUNT
)paren
comma
dot
id|bInterval
op_assign
l_int|1
op_lshift
id|LOG2_STATUS_INTERVAL_MSEC
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* the default data interface has no endpoints ... */
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|data_nop_intf
id|data_nop_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|data_nop_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|1
comma
dot
id|bAlternateSetting
op_assign
l_int|0
comma
dot
id|bNumEndpoints
op_assign
l_int|0
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_CDC_DATA
comma
dot
id|bInterfaceSubClass
op_assign
l_int|0
comma
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
dot
id|iInterface
op_assign
id|STRING_DATA
comma
)brace
suffix:semicolon
multiline_comment|/* ... but the &quot;real&quot; data interface has two full speed bulk endpoints */
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|data_intf
id|data_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|data_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|1
comma
dot
id|bAlternateSetting
op_assign
l_int|1
comma
dot
id|bNumEndpoints
op_assign
l_int|2
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_CDC_DATA
comma
dot
id|bInterfaceSubClass
op_assign
l_int|0
comma
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
dot
id|iInterface
op_assign
id|STRING_DATA
comma
)brace
suffix:semicolon
macro_line|#else
multiline_comment|/*&n; * &quot;Minimalist&quot; non-CDC option is a simple vendor-neutral model that most&n; * full speed controllers can handle:  one interface, two bulk endpoints.&n; */
r_static
r_const
r_struct
id|usb_interface_descriptor
DECL|variable|data_intf
id|data_intf
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|data_intf
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_INTERFACE
comma
dot
id|bInterfaceNumber
op_assign
l_int|0
comma
dot
id|bAlternateSetting
op_assign
l_int|0
comma
dot
id|bNumEndpoints
op_assign
l_int|2
comma
dot
id|bInterfaceClass
op_assign
id|USB_CLASS_VENDOR_SPEC
comma
dot
id|bInterfaceSubClass
op_assign
l_int|0
comma
dot
id|bInterfaceProtocol
op_assign
l_int|0
comma
dot
id|iInterface
op_assign
id|STRING_DATA
comma
)brace
suffix:semicolon
macro_line|#endif&t;/* DEV_CONFIG_CDC */
r_static
r_const
r_struct
id|usb_endpoint_descriptor
DECL|variable|fs_source_desc
id|fs_source_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|EP_IN_NUM
op_or
id|USB_DIR_IN
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
l_int|64
)paren
comma
)brace
suffix:semicolon
r_static
r_const
r_struct
id|usb_endpoint_descriptor
DECL|variable|fs_sink_desc
id|fs_sink_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|EP_OUT_NUM
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
l_int|64
)paren
comma
)brace
suffix:semicolon
macro_line|#ifdef&t;HIGHSPEED
multiline_comment|/*&n; * usb 2.0 devices need to expose both high speed and full speed&n; * descriptors, unless they only run at full speed.&n; */
macro_line|#ifdef&t;EP_STATUS_NUM
r_static
r_const
r_struct
id|usb_endpoint_descriptor
DECL|variable|hs_status_desc
id|hs_status_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|EP_STATUS_NUM
op_or
id|USB_DIR_IN
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_INT
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
id|STATUS_BYTECOUNT
)paren
comma
dot
id|bInterval
op_assign
id|LOG2_STATUS_INTERVAL_MSEC
op_plus
l_int|3
comma
)brace
suffix:semicolon
macro_line|#endif
r_static
r_const
r_struct
id|usb_endpoint_descriptor
DECL|variable|hs_source_desc
id|hs_source_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|EP_IN_NUM
op_or
id|USB_DIR_IN
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
l_int|512
)paren
comma
dot
id|bInterval
op_assign
l_int|1
comma
)brace
suffix:semicolon
r_static
r_const
r_struct
id|usb_endpoint_descriptor
DECL|variable|hs_sink_desc
id|hs_sink_desc
op_assign
(brace
dot
id|bLength
op_assign
id|USB_DT_ENDPOINT_SIZE
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_ENDPOINT
comma
dot
id|bEndpointAddress
op_assign
id|EP_OUT_NUM
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
dot
id|wMaxPacketSize
op_assign
id|__constant_cpu_to_le16
(paren
l_int|512
)paren
comma
dot
id|bInterval
op_assign
l_int|1
comma
)brace
suffix:semicolon
r_static
r_const
r_struct
id|usb_qualifier_descriptor
DECL|variable|dev_qualifier
id|dev_qualifier
op_assign
(brace
dot
id|bLength
op_assign
r_sizeof
id|dev_qualifier
comma
dot
id|bDescriptorType
op_assign
id|USB_DT_DEVICE_QUALIFIER
comma
dot
id|bcdUSB
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0x0200
)paren
comma
dot
id|bDeviceClass
op_assign
id|DEV_CONFIG_CLASS
comma
multiline_comment|/* assumes ep0 uses the same value for both speeds ... */
dot
id|bMaxPacketSize0
op_assign
id|EP0_MAXPACKET
comma
dot
id|bNumConfigurations
op_assign
l_int|1
comma
)brace
suffix:semicolon
multiline_comment|/* maxpacket and other transfer characteristics vary by speed. */
DECL|macro|ep_desc
mdefine_line|#define ep_desc(g,hs,fs) (((g)-&gt;speed==USB_SPEED_HIGH)?(hs):(fs))
macro_line|#else
multiline_comment|/* if there&squot;s no high speed support, maxpacket doesn&squot;t change. */
DECL|macro|ep_desc
mdefine_line|#define ep_desc(g,hs,fs) fs
macro_line|#endif&t;/* !HIGHSPEED */
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* descriptors that are built on-demand */
macro_line|#ifdef&t;DEV_CONFIG_CDC
multiline_comment|/* address that the host will use ... usually assigned at random */
DECL|variable|ethaddr
r_static
r_char
id|ethaddr
(braket
l_int|2
op_star
id|ETH_ALEN
op_plus
l_int|1
)braket
suffix:semicolon
macro_line|#endif
multiline_comment|/* static strings, in iso 8859/1 */
DECL|variable|strings
r_static
r_struct
id|usb_string
id|strings
(braket
)braket
op_assign
(brace
(brace
id|STRING_MANUFACTURER
comma
id|UTS_SYSNAME
l_string|&quot; &quot;
id|UTS_RELEASE
l_string|&quot;/&quot;
id|CHIP
comma
)brace
comma
(brace
id|STRING_PRODUCT
comma
id|driver_desc
comma
)brace
comma
macro_line|#ifdef&t;DEV_CONFIG_CDC
(brace
id|STRING_ETHADDR
comma
id|ethaddr
comma
)brace
comma
(brace
id|STRING_CONTROL
comma
l_string|&quot;CDC Communications Control&quot;
comma
)brace
comma
macro_line|#endif
(brace
id|STRING_DATA
comma
l_string|&quot;Ethernet Data&quot;
comma
)brace
comma
(brace
)brace
multiline_comment|/* end of list */
)brace
suffix:semicolon
DECL|variable|stringtab
r_static
r_struct
id|usb_gadget_strings
id|stringtab
op_assign
(brace
dot
id|language
op_assign
l_int|0x0409
comma
multiline_comment|/* en-us */
dot
id|strings
op_assign
id|strings
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * one config, two interfaces:  control, data.&n; * complications: class descriptors, and an altsetting.&n; */
r_static
r_int
DECL|function|config_buf
id|config_buf
(paren
r_enum
id|usb_device_speed
id|speed
comma
id|u8
op_star
id|buf
comma
id|u8
id|type
comma
r_int
id|index
)paren
(brace
r_const
r_int
id|config_len
op_assign
id|USB_DT_CONFIG_SIZE
macro_line|#ifdef DEV_CONFIG_CDC
op_plus
l_int|2
op_star
id|USB_DT_INTERFACE_SIZE
op_plus
r_sizeof
id|header_desc
op_plus
r_sizeof
id|union_desc
op_plus
r_sizeof
id|ether_desc
macro_line|#ifdef&t;EP_STATUS_NUM
op_plus
id|USB_DT_ENDPOINT_SIZE
macro_line|#endif
macro_line|#endif /* DEV_CONFIG_CDC */
op_plus
id|USB_DT_INTERFACE_SIZE
op_plus
l_int|2
op_star
id|USB_DT_ENDPOINT_SIZE
suffix:semicolon
macro_line|#ifdef HIGHSPEED
r_int
id|hs
suffix:semicolon
macro_line|#endif
multiline_comment|/* a single configuration must always be index 0 */
r_if
c_cond
(paren
id|index
OG
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|config_len
OG
id|USB_BUFSIZ
)paren
r_return
op_minus
id|EDOM
suffix:semicolon
multiline_comment|/* config (or other speed config) */
id|memcpy
(paren
id|buf
comma
op_amp
id|eth_config
comma
id|USB_DT_CONFIG_SIZE
)paren
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|type
suffix:semicolon
(paren
(paren
r_struct
id|usb_config_descriptor
op_star
)paren
id|buf
)paren
op_member_access_from_pointer
id|wTotalLength
op_assign
id|__constant_cpu_to_le16
(paren
id|config_len
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_CONFIG_SIZE
suffix:semicolon
macro_line|#ifdef&t;HIGHSPEED
id|hs
op_assign
(paren
id|speed
op_eq
id|USB_SPEED_HIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|USB_DT_OTHER_SPEED_CONFIG
)paren
id|hs
op_assign
op_logical_neg
id|hs
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEV_CONFIG_CDC
multiline_comment|/* control interface, class descriptors, optional status endpoint */
id|memcpy
(paren
id|buf
comma
op_amp
id|control_intf
comma
id|USB_DT_INTERFACE_SIZE
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_INTERFACE_SIZE
suffix:semicolon
id|memcpy
(paren
id|buf
comma
op_amp
id|header_desc
comma
r_sizeof
id|header_desc
)paren
suffix:semicolon
id|buf
op_add_assign
r_sizeof
id|header_desc
suffix:semicolon
id|memcpy
(paren
id|buf
comma
op_amp
id|union_desc
comma
r_sizeof
id|union_desc
)paren
suffix:semicolon
id|buf
op_add_assign
r_sizeof
id|union_desc
suffix:semicolon
id|memcpy
(paren
id|buf
comma
op_amp
id|ether_desc
comma
r_sizeof
id|ether_desc
)paren
suffix:semicolon
id|buf
op_add_assign
r_sizeof
id|ether_desc
suffix:semicolon
macro_line|#ifdef&t;EP_STATUS_NUM
macro_line|#ifdef&t;HIGHSPEED
r_if
c_cond
(paren
id|hs
)paren
id|memcpy
(paren
id|buf
comma
op_amp
id|hs_status_desc
comma
id|USB_DT_ENDPOINT_SIZE
)paren
suffix:semicolon
r_else
macro_line|#endif&t;/* HIGHSPEED */
id|memcpy
(paren
id|buf
comma
op_amp
id|fs_status_desc
comma
id|USB_DT_ENDPOINT_SIZE
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_ENDPOINT_SIZE
suffix:semicolon
macro_line|#endif&t;/* EP_STATUS_NUM */
multiline_comment|/* default data altsetting has no endpoints */
id|memcpy
(paren
id|buf
comma
op_amp
id|data_nop_intf
comma
id|USB_DT_INTERFACE_SIZE
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_INTERFACE_SIZE
suffix:semicolon
macro_line|#endif /* DEV_CONFIG_CDC */
multiline_comment|/* the &quot;real&quot; data interface has two endpoints */
id|memcpy
(paren
id|buf
comma
op_amp
id|data_intf
comma
id|USB_DT_INTERFACE_SIZE
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_INTERFACE_SIZE
suffix:semicolon
macro_line|#ifdef HIGHSPEED
r_if
c_cond
(paren
id|hs
)paren
(brace
id|memcpy
(paren
id|buf
comma
op_amp
id|hs_source_desc
comma
id|USB_DT_ENDPOINT_SIZE
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_ENDPOINT_SIZE
suffix:semicolon
id|memcpy
(paren
id|buf
comma
op_amp
id|hs_sink_desc
comma
id|USB_DT_ENDPOINT_SIZE
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_ENDPOINT_SIZE
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
id|memcpy
(paren
id|buf
comma
op_amp
id|fs_source_desc
comma
id|USB_DT_ENDPOINT_SIZE
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_ENDPOINT_SIZE
suffix:semicolon
id|memcpy
(paren
id|buf
comma
op_amp
id|fs_sink_desc
comma
id|USB_DT_ENDPOINT_SIZE
)paren
suffix:semicolon
id|buf
op_add_assign
id|USB_DT_ENDPOINT_SIZE
suffix:semicolon
)brace
r_return
id|config_len
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
id|eth_start
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|gfp_flags
)paren
suffix:semicolon
r_static
r_int
DECL|function|set_ether_config
id|set_ether_config
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|gfp_flags
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|usb_ep
op_star
id|ep
suffix:semicolon
r_struct
id|usb_gadget
op_star
id|gadget
op_assign
id|dev-&gt;gadget
suffix:semicolon
id|gadget_for_each_ep
(paren
id|ep
comma
id|gadget
)paren
(brace
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|d
suffix:semicolon
macro_line|#ifdef&t;DEV_CONFIG_CDC
multiline_comment|/* With CDC,  the host isn&squot;t allowed to use these two data&n;&t;&t; * endpoints in the default altsetting for the interface.&n;&t;&t; * so we don&squot;t activate them yet.&n;&t;&t; */
multiline_comment|/* one endpoint writes data back IN to the host */
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_IN_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|gadget
comma
op_amp
id|hs_source_desc
comma
op_amp
id|fs_source_desc
)paren
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;in_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;in
op_assign
id|d
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* one endpoint just reads OUT packets */
)brace
r_else
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_OUT_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|gadget
comma
op_amp
id|hs_sink_desc
comma
op_amp
id|fs_sink_desc
)paren
suffix:semicolon
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;out_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;out
op_assign
id|d
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#ifdef&t;EP_STATUS_NUM
multiline_comment|/* optional status/notification endpoint */
r_else
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_STATUS_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|gadget
comma
op_amp
id|hs_status_desc
comma
op_amp
id|fs_status_desc
)paren
suffix:semicolon
id|result
op_assign
id|usb_ep_enable
(paren
id|ep
comma
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;status_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;status
op_assign
id|d
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#else&t;/* !CONFIG_CDC_ETHER */
multiline_comment|/* non-CDC is simpler:  if the device is there,&n;&t;&t; * it&squot;s live with rx and tx endpoints.&n;&t;&t; */
multiline_comment|/* one endpoint writes data back IN to the host */
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_IN_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|gadget
comma
op_amp
id|hs_source_desc
comma
op_amp
id|fs_source_desc
)paren
suffix:semicolon
id|result
op_assign
id|usb_ep_enable
(paren
id|ep
comma
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;in_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;in
op_assign
id|d
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* one endpoint just reads OUT packets */
)brace
r_else
r_if
c_cond
(paren
id|strcmp
(paren
id|ep-&gt;name
comma
id|EP_OUT_NAME
)paren
op_eq
l_int|0
)paren
(brace
id|d
op_assign
id|ep_desc
(paren
id|gadget
comma
op_amp
id|hs_sink_desc
comma
op_amp
id|fs_sink_desc
)paren
suffix:semicolon
id|result
op_assign
id|usb_ep_enable
(paren
id|ep
comma
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|ep-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;out_ep
op_assign
id|ep
suffix:semicolon
id|dev-&gt;out
op_assign
id|d
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
macro_line|#endif /* !CONFIG_CDC_ETHER */
multiline_comment|/* ignore any other endpoints */
r_else
r_continue
suffix:semicolon
multiline_comment|/* stop on error */
id|ERROR
(paren
id|dev
comma
l_string|&quot;can&squot;t enable %s, result %d&bslash;n&quot;
comma
id|ep-&gt;name
comma
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|result
op_logical_and
(paren
op_logical_neg
id|dev-&gt;in_ep
op_logical_or
op_logical_neg
id|dev-&gt;out_ep
)paren
)paren
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifndef&t;DEV_CONFIG_CDC
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|netif_carrier_on
(paren
id|dev-&gt;net
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
(paren
id|dev-&gt;net
)paren
)paren
id|eth_start
(paren
id|dev
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
macro_line|#endif /* !CONFIG_CDC_ETHER */
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
id|DEBUG
(paren
id|dev
comma
l_string|&quot;qlen %d&bslash;n&quot;
comma
id|qlen
(paren
id|gadget
)paren
)paren
suffix:semicolon
multiline_comment|/* caller is responsible for cleanup on error */
r_return
id|result
suffix:semicolon
)brace
DECL|function|eth_reset_config
r_static
r_void
id|eth_reset_config
(paren
r_struct
id|eth_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;config
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|netif_stop_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|netif_carrier_off
(paren
id|dev-&gt;net
)paren
suffix:semicolon
multiline_comment|/* just disable endpoints, forcing completion of pending i/o.&n;&t; * all our completion handlers free their requests in this case.&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;in_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;in_ep
)paren
suffix:semicolon
id|dev-&gt;in_ep
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;out_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;out_ep
)paren
suffix:semicolon
id|dev-&gt;out_ep
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef&t;EP_STATUS_NUM
r_if
c_cond
(paren
id|dev-&gt;status_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
id|dev-&gt;status_ep
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|dev-&gt;config
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* change our operational config.  must agree with the code&n; * that returns config descriptors, and altsetting code.&n; */
r_static
r_int
DECL|function|eth_set_config
id|eth_set_config
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|number
comma
r_int
id|gfp_flags
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|usb_gadget
op_star
id|gadget
op_assign
id|dev-&gt;gadget
suffix:semicolon
r_if
c_cond
(paren
id|number
op_eq
id|dev-&gt;config
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_USB_ETH_SA1100
r_if
c_cond
(paren
id|dev-&gt;config
op_logical_and
id|atomic_read
(paren
op_amp
id|dev-&gt;tx_qlen
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* tx fifo is full, but we can&squot;t clear it...*/
id|INFO
(paren
id|dev
comma
l_string|&quot;can&squot;t change configurations&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
macro_line|#endif
id|eth_reset_config
(paren
id|dev
)paren
suffix:semicolon
id|hw_optimize
(paren
id|gadget
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|number
)paren
(brace
r_case
id|DEV_CONFIG_VALUE
suffix:colon
id|result
op_assign
id|set_ether_config
(paren
id|dev
comma
id|gfp_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* FALL THROUGH */
r_case
l_int|0
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
)paren
id|eth_reset_config
(paren
id|dev
)paren
suffix:semicolon
r_else
(brace
r_char
op_star
id|speed
suffix:semicolon
r_switch
c_cond
(paren
id|gadget-&gt;speed
)paren
(brace
r_case
id|USB_SPEED_FULL
suffix:colon
id|speed
op_assign
l_string|&quot;full&quot;
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef HIGHSPEED
r_case
id|USB_SPEED_HIGH
suffix:colon
id|speed
op_assign
l_string|&quot;high&quot;
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|speed
op_assign
l_string|&quot;?&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev-&gt;config
op_assign
id|number
suffix:semicolon
id|INFO
(paren
id|dev
comma
l_string|&quot;%s speed config #%d: %s&bslash;n&quot;
comma
id|speed
comma
id|number
comma
id|driver_desc
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef&t;EP_STATUS_NUM
multiline_comment|/* section 3.8.2 table 11 of the CDC spec lists Ethernet notifications */
DECL|macro|CDC_NOTIFY_NETWORK_CONNECTION
mdefine_line|#define CDC_NOTIFY_NETWORK_CONNECTION&t;0x00&t;/* required; 6.3.1 */
DECL|macro|CDC_NOTIFY_SPEED_CHANGE
mdefine_line|#define CDC_NOTIFY_SPEED_CHANGE&t;&t;0x2a&t;/* required; 6.3.8 */
DECL|struct|cdc_notification
r_struct
id|cdc_notification
(brace
DECL|member|bmRequestType
id|u8
id|bmRequestType
suffix:semicolon
DECL|member|bNotificationType
id|u8
id|bNotificationType
suffix:semicolon
DECL|member|wValue
id|u16
id|wValue
suffix:semicolon
DECL|member|wIndex
id|u16
id|wIndex
suffix:semicolon
DECL|member|wLength
id|u16
id|wLength
suffix:semicolon
multiline_comment|/* SPEED_CHANGE data looks like this */
DECL|member|data
id|u32
id|data
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|eth_status_complete
r_static
r_void
id|eth_status_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_struct
id|cdc_notification
op_star
id|event
op_assign
id|req-&gt;buf
suffix:semicolon
r_int
id|value
op_assign
id|req-&gt;status
suffix:semicolon
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|ep-&gt;driver_data
suffix:semicolon
multiline_comment|/* issue the second notification if host reads the first */
r_if
c_cond
(paren
id|event-&gt;bNotificationType
op_eq
id|CDC_NOTIFY_NETWORK_CONNECTION
op_logical_and
id|value
op_eq
l_int|0
)paren
(brace
id|event-&gt;bmRequestType
op_assign
l_int|0xA1
suffix:semicolon
id|event-&gt;bNotificationType
op_assign
id|CDC_NOTIFY_SPEED_CHANGE
suffix:semicolon
id|event-&gt;wValue
op_assign
id|__constant_cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|event-&gt;wIndex
op_assign
id|__constant_cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
id|event-&gt;wLength
op_assign
id|__constant_cpu_to_le16
(paren
l_int|8
)paren
suffix:semicolon
multiline_comment|/* SPEED_CHANGE data is up/down speeds in bits/sec */
id|event-&gt;data
(braket
l_int|0
)braket
op_assign
id|event-&gt;data
(braket
l_int|1
)braket
op_assign
(paren
id|dev-&gt;gadget-&gt;speed
op_eq
id|USB_SPEED_HIGH
)paren
ques
c_cond
(paren
l_int|13
op_star
l_int|512
op_star
l_int|8
op_star
l_int|1000
op_star
l_int|8
)paren
suffix:colon
(paren
l_int|19
op_star
l_int|64
op_star
l_int|1
op_star
l_int|1000
op_star
l_int|8
)paren
suffix:semicolon
id|req-&gt;length
op_assign
l_int|16
suffix:semicolon
id|value
op_assign
id|usb_ep_queue
(paren
id|ep
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;send SPEED_CHANGE --&gt; %d&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_else
id|DEBUG
(paren
id|dev
comma
l_string|&quot;event %02x --&gt; %d&bslash;n&quot;
comma
id|event-&gt;bNotificationType
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* free when done */
id|usb_ep_free_buffer
(paren
id|ep
comma
id|req-&gt;buf
comma
id|req-&gt;dma
comma
l_int|16
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
DECL|function|issue_start_status
r_static
r_void
id|issue_start_status
(paren
r_struct
id|eth_dev
op_star
id|dev
)paren
(brace
r_struct
id|usb_request
op_star
id|req
suffix:semicolon
r_struct
id|cdc_notification
op_star
id|event
suffix:semicolon
r_int
id|value
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s, flush old status first&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* flush old status&n;&t; *&n;&t; * FIXME ugly idiom, maybe we&squot;d be better with just&n;&t; * a &quot;cancel the whole queue&quot; primitive since any&n;&t; * unlink-one primitive has way too many error modes.&n;&t; * here, we &quot;know&quot; toggle is already clear...&n;&t; */
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;status_ep
comma
id|dev-&gt;status
)paren
suffix:semicolon
multiline_comment|/* FIXME make these allocations static like dev-&gt;req */
id|req
op_assign
id|usb_ep_alloc_request
(paren
id|dev-&gt;status_ep
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status ENOMEM&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|req-&gt;buf
op_assign
id|usb_ep_alloc_buffer
(paren
id|dev-&gt;status_ep
comma
l_int|16
comma
op_amp
id|dev-&gt;req-&gt;dma
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;buf
op_eq
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status buf ENOMEM&bslash;n&quot;
)paren
suffix:semicolon
id|free_req
suffix:colon
id|usb_ep_free_request
(paren
id|dev-&gt;status_ep
comma
id|req
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* 3.8.1 says to issue first NETWORK_CONNECTION, then&n;&t; * a SPEED_CHANGE.  could be useful in some configs.&n;&t; */
id|event
op_assign
id|req-&gt;buf
suffix:semicolon
id|event-&gt;bmRequestType
op_assign
l_int|0xA1
suffix:semicolon
id|event-&gt;bNotificationType
op_assign
id|CDC_NOTIFY_NETWORK_CONNECTION
suffix:semicolon
id|event-&gt;wValue
op_assign
id|__constant_cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* connected */
id|event-&gt;wIndex
op_assign
id|__constant_cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
id|event-&gt;wLength
op_assign
l_int|0
suffix:semicolon
id|req-&gt;length
op_assign
l_int|8
suffix:semicolon
id|req-&gt;complete
op_assign
id|eth_status_complete
suffix:semicolon
id|value
op_assign
id|usb_ep_queue
(paren
id|dev-&gt;status_ep
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
OL
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;status buf queue --&gt; %d&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
id|usb_ep_free_buffer
(paren
id|dev-&gt;status_ep
comma
id|req-&gt;buf
comma
id|dev-&gt;req-&gt;dma
comma
l_int|16
)paren
suffix:semicolon
r_goto
id|free_req
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|eth_setup_complete
r_static
r_void
id|eth_setup_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;status
op_logical_or
id|req-&gt;actual
op_ne
id|req-&gt;length
)paren
id|DEBUG
(paren
(paren
r_struct
id|eth_dev
op_star
)paren
id|ep-&gt;driver_data
comma
l_string|&quot;setup complete --&gt; %d, %d/%d&bslash;n&quot;
comma
id|req-&gt;status
comma
id|req-&gt;actual
comma
id|req-&gt;length
)paren
suffix:semicolon
)brace
multiline_comment|/* see section 3.8.2 table 10 of the CDC spec for more ethernet&n; * requests, mostly for filters (multicast, pm) and statistics&n; */
DECL|macro|CDC_SET_ETHERNET_PACKET_FILTER
mdefine_line|#define CDC_SET_ETHERNET_PACKET_FILTER&t;0x43&t;/* required */
multiline_comment|/*&n; * The setup() callback implements all the ep0 functionality that&squot;s not&n; * handled lower down.  CDC has a number of less-common features:&n; *&n; *  - two interfaces:  control, and ethernet data&n; *  - data interface has two altsettings:  default, and active&n; *  - class-specific descriptors for the control interface&n; *  - a mandatory class-specific control request&n; */
r_static
r_int
DECL|function|eth_setup
id|eth_setup
(paren
r_struct
id|usb_gadget
op_star
id|gadget
comma
r_const
r_struct
id|usb_ctrlrequest
op_star
id|ctrl
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|get_gadget_data
(paren
id|gadget
)paren
suffix:semicolon
r_struct
id|usb_request
op_star
id|req
op_assign
id|dev-&gt;req
suffix:semicolon
r_int
id|value
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
multiline_comment|/* descriptors just go into the pre-allocated ep0 buffer,&n;&t; * while config change events may enable network traffic.&n;&t; */
r_switch
c_cond
(paren
id|ctrl-&gt;bRequest
)paren
(brace
r_case
id|USB_REQ_GET_DESCRIPTOR
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
id|USB_DIR_IN
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl-&gt;wValue
op_rshift
l_int|8
)paren
(brace
r_case
id|USB_DT_DEVICE
suffix:colon
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
r_sizeof
id|device_desc
)paren
suffix:semicolon
id|memcpy
(paren
id|req-&gt;buf
comma
op_amp
id|device_desc
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef HIGHSPEED
r_case
id|USB_DT_DEVICE_QUALIFIER
suffix:colon
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
r_sizeof
id|dev_qualifier
)paren
suffix:semicolon
id|memcpy
(paren
id|req-&gt;buf
comma
op_amp
id|dev_qualifier
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_DT_OTHER_SPEED_CONFIG
suffix:colon
singleline_comment|// FALLTHROUGH
macro_line|#endif /* HIGHSPEED */
r_case
id|USB_DT_CONFIG
suffix:colon
id|value
op_assign
id|config_buf
(paren
id|gadget-&gt;speed
comma
id|req-&gt;buf
comma
id|ctrl-&gt;wValue
op_rshift
l_int|8
comma
id|ctrl-&gt;wValue
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_ge
l_int|0
)paren
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_DT_STRING
suffix:colon
id|value
op_assign
id|usb_gadget_get_string
(paren
op_amp
id|stringtab
comma
id|ctrl-&gt;wValue
op_amp
l_int|0xff
comma
id|req-&gt;buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_ge
l_int|0
)paren
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|USB_REQ_SET_CONFIGURATION
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|value
op_assign
id|eth_set_config
(paren
id|dev
comma
id|ctrl-&gt;wValue
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_ETH_PXA2XX
multiline_comment|/* PXA UDC prevents us from using SET_INTERFACE in normal ways.&n;&t; * And it hides GET_CONFIGURATION and GET_INTERFACE too.&n;&t; */
r_case
id|USB_REQ_SET_INTERFACE
suffix:colon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|value
op_assign
id|eth_set_config
(paren
id|dev
comma
id|DEV_CONFIG_VALUE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else&t;/* hardware that that stays out of our way */
r_case
id|USB_REQ_GET_CONFIGURATION
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
id|USB_DIR_IN
)paren
r_break
suffix:semicolon
op_star
(paren
id|u8
op_star
)paren
id|req-&gt;buf
op_assign
id|dev-&gt;config
suffix:semicolon
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_REQ_SET_INTERFACE
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
id|USB_RECIP_INTERFACE
op_logical_or
op_logical_neg
id|dev-&gt;config
op_logical_or
id|ctrl-&gt;wIndex
OG
l_int|1
)paren
r_break
suffix:semicolon
id|spin_lock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl-&gt;wIndex
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* control/master intf */
r_if
c_cond
(paren
id|ctrl-&gt;wValue
op_ne
l_int|0
)paren
r_break
suffix:semicolon
macro_line|#ifdef&t;EP_STATUS_NUM
r_if
c_cond
(paren
id|dev-&gt;status_ep
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;status_ep
comma
id|dev-&gt;status
)paren
suffix:semicolon
)brace
macro_line|#endif
id|value
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* data intf */
r_if
c_cond
(paren
id|ctrl-&gt;wValue
OG
l_int|1
)paren
r_break
suffix:semicolon
id|usb_ep_disable
(paren
id|dev-&gt;in_ep
)paren
suffix:semicolon
id|usb_ep_disable
(paren
id|dev-&gt;out_ep
)paren
suffix:semicolon
multiline_comment|/* CDC requires the data transfers not be done from&n;&t;&t;&t; * the default interface setting ... also, setting&n;&t;&t;&t; * the non-default interface clears filters etc.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|ctrl-&gt;wValue
op_eq
l_int|1
)paren
(brace
id|usb_ep_enable
(paren
id|dev-&gt;in_ep
comma
id|dev-&gt;in
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;out_ep
comma
id|dev-&gt;out
)paren
suffix:semicolon
id|netif_carrier_on
(paren
id|dev-&gt;net
)paren
suffix:semicolon
macro_line|#ifdef&t;EP_STATUS_NUM
id|issue_start_status
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|netif_running
(paren
id|dev-&gt;net
)paren
)paren
id|eth_start
(paren
id|dev
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
r_else
(brace
id|netif_stop_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|netif_carrier_off
(paren
id|dev-&gt;net
)paren
suffix:semicolon
)brace
id|value
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_REQ_GET_INTERFACE
suffix:colon
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
(paren
id|USB_DIR_IN
op_or
id|USB_RECIP_INTERFACE
)paren
op_logical_or
op_logical_neg
id|dev-&gt;config
op_logical_or
id|ctrl-&gt;wIndex
OG
l_int|1
)paren
r_break
suffix:semicolon
multiline_comment|/* if carrier is on, data interface is active. */
op_star
(paren
id|u8
op_star
)paren
id|req-&gt;buf
op_assign
(paren
(paren
id|ctrl-&gt;wIndex
op_eq
l_int|1
)paren
op_logical_and
id|netif_carrier_ok
(paren
id|dev-&gt;net
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
id|value
op_assign
id|min
(paren
id|ctrl-&gt;wLength
comma
(paren
id|u16
)paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEV_CONFIG_CDC
r_case
id|CDC_SET_ETHERNET_PACKET_FILTER
suffix:colon
multiline_comment|/* see 6.2.30: no data, wIndex = interface,&n;&t;&t; * wValue = packet filter bitmap&n;&t;&t; */
r_if
c_cond
(paren
id|ctrl-&gt;bRequestType
op_ne
(paren
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_INTERFACE
)paren
op_logical_or
id|ctrl-&gt;wLength
op_ne
l_int|0
op_logical_or
id|ctrl-&gt;wIndex
OG
l_int|1
)paren
id|DEBUG
(paren
id|dev
comma
l_string|&quot;NOP packet filter %04x&bslash;n&quot;
comma
id|ctrl-&gt;wValue
)paren
suffix:semicolon
multiline_comment|/* NOTE: table 62 has 5 filter bits to reduce traffic,&n;&t;&t; * and we &quot;must&quot; support multicast and promiscuous.&n;&t;&t; * this NOP implements a bad filter...&n;&t;&t; */
id|value
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* DEV_CONFIG_CDC */
r_default
suffix:colon
id|VDEBUG
(paren
id|dev
comma
l_string|&quot;unknown control req%02x.%02x v%04x i%04x l%d&bslash;n&quot;
comma
id|ctrl-&gt;bRequestType
comma
id|ctrl-&gt;bRequest
comma
id|ctrl-&gt;wValue
comma
id|ctrl-&gt;wIndex
comma
id|ctrl-&gt;wLength
)paren
suffix:semicolon
)brace
multiline_comment|/* respond with data transfer before status phase? */
r_if
c_cond
(paren
id|value
op_ge
l_int|0
)paren
(brace
id|req-&gt;length
op_assign
id|value
suffix:semicolon
id|value
op_assign
id|usb_ep_queue
(paren
id|gadget-&gt;ep0
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
OL
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;ep_queue --&gt; %d&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
id|req-&gt;status
op_assign
l_int|0
suffix:semicolon
id|eth_setup_complete
(paren
id|gadget-&gt;ep0
comma
id|req
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* host either stalls (value &lt; 0) or reports success */
r_return
id|value
suffix:semicolon
)brace
r_static
r_void
DECL|function|eth_disconnect
id|eth_disconnect
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|get_gadget_data
(paren
id|gadget
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_stop_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|netif_carrier_off
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|eth_reset_config
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* next we may get setup() calls to enumerate new connections;&n;&t; * or an unbind() during shutdown (including removing module).&n;&t; */
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* NETWORK DRIVER HOOKUP (to the layer above this driver) */
DECL|function|eth_change_mtu
r_static
r_int
id|eth_change_mtu
(paren
r_struct
id|net_device
op_star
id|net
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
op_le
id|MIN_PACKET
op_logical_or
id|new_mtu
OG
id|MAX_PACKET
)paren
r_return
op_minus
id|ERANGE
suffix:semicolon
multiline_comment|/* no zero-length packet read wanted after mtu-sized packets */
r_if
c_cond
(paren
(paren
(paren
id|new_mtu
op_plus
r_sizeof
(paren
r_struct
id|ethhdr
)paren
)paren
op_mod
id|dev-&gt;in_ep-&gt;maxpacket
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EDOM
suffix:semicolon
id|net-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|eth_get_stats
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_return
op_amp
(paren
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
)paren
op_member_access_from_pointer
id|stats
suffix:semicolon
)brace
DECL|function|eth_ethtool_ioctl
r_static
r_int
id|eth_ethtool_ioctl
(paren
r_struct
id|net_device
op_star
id|net
comma
r_void
op_star
id|useraddr
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|u32
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|cmd
comma
(paren
id|u32
op_star
)paren
id|useraddr
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
multiline_comment|/* get driver info */
r_struct
id|ethtool_drvinfo
id|info
suffix:semicolon
id|memset
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
id|info
)paren
suffix:semicolon
id|info.cmd
op_assign
id|ETHTOOL_GDRVINFO
suffix:semicolon
id|strlcpy
(paren
id|info.driver
comma
id|shortname
comma
r_sizeof
id|info.driver
)paren
suffix:semicolon
id|strlcpy
(paren
id|info.version
comma
id|DRIVER_VERSION
comma
r_sizeof
id|info.version
)paren
suffix:semicolon
id|strlcpy
(paren
id|info.fw_version
comma
id|CHIP
comma
r_sizeof
id|info.fw_version
)paren
suffix:semicolon
id|strlcpy
(paren
id|info.bus_info
comma
id|dev-&gt;gadget-&gt;dev.bus_id
comma
r_sizeof
id|info.bus_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|useraddr
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ETHTOOL_GLINK
suffix:colon
(brace
multiline_comment|/* get link status */
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GLINK
)brace
suffix:semicolon
id|edata.data
op_assign
(paren
id|dev-&gt;gadget-&gt;speed
op_ne
id|USB_SPEED_UNKNOWN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|useraddr
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Note that the ethtool user space code requires EOPNOTSUPP */
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|eth_ioctl
r_static
r_int
id|eth_ioctl
(paren
r_struct
id|net_device
op_star
id|net
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
r_return
id|eth_ethtool_ioctl
(paren
id|net
comma
(paren
r_void
op_star
)paren
id|rq-&gt;ifr_data
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
)brace
DECL|function|defer_kevent
r_static
r_void
id|defer_kevent
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|flag
)paren
(brace
id|set_bit
(paren
id|flag
comma
op_amp
id|dev-&gt;todo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schedule_work
(paren
op_amp
id|dev-&gt;work
)paren
)paren
id|ERROR
(paren
id|dev
comma
l_string|&quot;kevent %d may have been dropped&bslash;n&quot;
comma
id|flag
)paren
suffix:semicolon
r_else
id|DEBUG
(paren
id|dev
comma
l_string|&quot;kevent %d scheduled&bslash;n&quot;
comma
id|flag
)paren
suffix:semicolon
)brace
r_static
r_void
id|rx_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
suffix:semicolon
r_static
r_int
DECL|function|rx_submit
id|rx_submit
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_struct
id|usb_request
op_star
id|req
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|size
suffix:semicolon
id|size
op_assign
(paren
r_sizeof
(paren
r_struct
id|ethhdr
)paren
op_plus
id|dev-&gt;net-&gt;mtu
op_plus
id|RX_EXTRA
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|alloc_skb
(paren
id|size
comma
id|gfp_flags
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;no rx skb&bslash;n&quot;
)paren
suffix:semicolon
id|defer_kevent
(paren
id|dev
comma
id|WORK_RX_MEMORY
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|dev-&gt;out_ep
comma
id|req
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|req-&gt;buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|req-&gt;length
op_assign
id|size
suffix:semicolon
id|req-&gt;complete
op_assign
id|rx_complete
suffix:semicolon
id|req-&gt;context
op_assign
id|skb
suffix:semicolon
id|retval
op_assign
id|usb_ep_queue
(paren
id|dev-&gt;out_ep
comma
id|req
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOMEM
)paren
id|defer_kevent
(paren
id|dev
comma
id|WORK_RX_MEMORY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;rx submit --&gt; %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|dev-&gt;out_ep
comma
id|req
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|rx_complete
r_static
r_void
id|rx_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|req-&gt;context
suffix:semicolon
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|ep-&gt;driver_data
suffix:semicolon
r_int
id|status
op_assign
id|req-&gt;status
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* normal completion */
r_case
l_int|0
suffix:colon
id|skb_put
(paren
id|skb
comma
id|req-&gt;actual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MIN_PACKET
OG
id|skb-&gt;len
op_logical_or
id|skb-&gt;len
OG
(paren
id|MAX_PACKET
op_plus
id|ETH_HLEN
)paren
)paren
(brace
id|dev-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|dev-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;rx length %d&bslash;n&quot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev-&gt;net
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
(paren
id|skb
comma
id|dev-&gt;net
)paren
suffix:semicolon
id|dev-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|dev-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* no buffer copies needed, unless hardware can&squot;t&n;&t;&t; * use skb buffers.&n;&t;&t; */
id|status
op_assign
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* software-driven interface shutdown */
r_case
op_minus
id|ECONNRESET
suffix:colon
singleline_comment|// unlink
r_case
op_minus
id|ESHUTDOWN
suffix:colon
singleline_comment|// disconnect etc
id|VDEBUG
(paren
id|dev
comma
l_string|&quot;rx shutdown, code %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_goto
id|clean
suffix:semicolon
multiline_comment|/* data overrun */
r_case
op_minus
id|EOVERFLOW
suffix:colon
id|dev-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
singleline_comment|// FALLTHROUGH
r_default
suffix:colon
id|dev-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;rx status %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
(paren
id|dev-&gt;net
)paren
)paren
(brace
id|clean
suffix:colon
id|usb_ep_free_request
(paren
id|dev-&gt;out_ep
comma
id|req
)paren
suffix:semicolon
id|req
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req
)paren
id|rx_submit
(paren
id|dev
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
DECL|function|eth_work
r_static
r_void
id|eth_work
(paren
r_void
op_star
id|_dev
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|_dev
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
(paren
id|WORK_RX_MEMORY
comma
op_amp
id|dev-&gt;todo
)paren
)paren
(brace
r_struct
id|usb_request
op_star
id|req
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
(paren
id|dev-&gt;net
)paren
)paren
id|req
op_assign
id|usb_ep_alloc_request
(paren
id|dev-&gt;in_ep
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_else
id|clear_bit
(paren
id|WORK_RX_MEMORY
comma
op_amp
id|dev-&gt;todo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_ne
l_int|0
)paren
(brace
id|clear_bit
(paren
id|WORK_RX_MEMORY
comma
op_amp
id|dev-&gt;todo
)paren
suffix:semicolon
id|rx_submit
(paren
id|dev
comma
id|req
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;todo
)paren
id|DEBUG
(paren
id|dev
comma
l_string|&quot;work done, flags = 0x%lx&bslash;n&quot;
comma
id|dev-&gt;todo
)paren
suffix:semicolon
)brace
DECL|function|tx_complete
r_static
r_void
id|tx_complete
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|req
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|req-&gt;context
suffix:semicolon
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|ep-&gt;driver_data
suffix:semicolon
r_switch
c_cond
(paren
id|req-&gt;status
)paren
(brace
r_default
suffix:colon
id|dev-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|VDEBUG
(paren
id|dev
comma
l_string|&quot;tx err %d&bslash;n&quot;
comma
id|req-&gt;status
)paren
suffix:semicolon
multiline_comment|/* FALLTHROUGH */
r_case
op_minus
id|ECONNRESET
suffix:colon
singleline_comment|// unlink
r_case
op_minus
id|ESHUTDOWN
suffix:colon
singleline_comment|// disconnect etc
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
id|dev-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|dev-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|usb_ep_free_request
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|dev-&gt;tx_qlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_carrier_ok
(paren
id|dev-&gt;net
)paren
)paren
id|netif_wake_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
)brace
DECL|function|eth_start_xmit
r_static
r_int
id|eth_start_xmit
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
r_int
id|length
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_struct
id|usb_request
op_star
id|req
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|usb_ep_alloc_request
(paren
id|dev-&gt;in_ep
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;no request&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
multiline_comment|/* no buffer copies needed, unless the network stack did it&n;&t; * or the hardware can&squot;t use skb buffers.&n;&t; */
id|req-&gt;buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|req-&gt;context
op_assign
id|skb
suffix:semicolon
id|req-&gt;complete
op_assign
id|tx_complete
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_ETH_SA1100
multiline_comment|/* don&squot;t demand zlp (req-&gt;zero) support from all hardware */
r_if
c_cond
(paren
(paren
id|length
op_mod
id|dev-&gt;in_ep-&gt;maxpacket
)paren
op_eq
l_int|0
)paren
id|length
op_increment
suffix:semicolon
macro_line|#else
multiline_comment|/* use zlp framing on tx for strict CDC-Ether conformance,&n;&t; * though any robust network rx path ignores extra padding.&n;&t; */
id|req-&gt;zero
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|req-&gt;length
op_assign
id|length
suffix:semicolon
macro_line|#ifdef&t;HIGHSPEED
multiline_comment|/* throttle highspeed IRQ rate back slightly */
id|req-&gt;no_interrupt
op_assign
(paren
id|dev-&gt;gadget-&gt;speed
op_eq
id|USB_SPEED_HIGH
)paren
ques
c_cond
(paren
(paren
id|atomic_read
(paren
op_amp
id|dev-&gt;tx_qlen
)paren
op_mod
id|TX_DELAY
)paren
op_ne
l_int|0
)paren
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
id|retval
op_assign
id|usb_ep_queue
(paren
id|dev-&gt;in_ep
comma
id|req
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|retval
)paren
(brace
r_default
suffix:colon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;tx queue err %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
id|net-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
(paren
op_amp
id|dev-&gt;tx_qlen
)paren
)paren
id|netif_stop_queue
(paren
id|net
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;drop, code %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
id|drop
suffix:colon
id|dev-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb_any
(paren
id|skb
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|dev-&gt;in_ep
comma
id|req
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth_start
r_static
r_void
id|eth_start
(paren
r_struct
id|eth_dev
op_star
id|dev
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|usb_request
op_star
id|req
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|size
op_assign
id|qlen
(paren
id|dev-&gt;gadget
)paren
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* fill the rx queue */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|retval
op_eq
l_int|0
op_logical_and
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|req
op_assign
id|usb_ep_alloc_request
(paren
id|dev-&gt;in_ep
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
id|retval
op_assign
id|rx_submit
(paren
id|dev
comma
id|req
comma
id|gfp_flags
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
id|defer_kevent
(paren
id|dev
comma
id|WORK_RX_MEMORY
)paren
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* and open the tx floodgates */
id|atomic_set
(paren
op_amp
id|dev-&gt;tx_qlen
comma
id|size
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
)brace
DECL|function|eth_open
r_static
r_int
id|eth_open
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_carrier_ok
(paren
id|dev-&gt;net
)paren
)paren
id|eth_start
(paren
id|dev
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth_stop
r_static
r_int
id|eth_stop
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
(paren
r_struct
id|eth_dev
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|netif_stop_queue
(paren
id|net
)paren
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;stop stats: rx/tx %ld/%ld, errs %ld/%ld&bslash;n&quot;
comma
id|dev-&gt;stats.rx_packets
comma
id|dev-&gt;stats.tx_packets
comma
id|dev-&gt;stats.rx_errors
comma
id|dev-&gt;stats.tx_errors
)paren
suffix:semicolon
multiline_comment|/* ensure there are no more active requests */
r_if
c_cond
(paren
id|dev-&gt;gadget-&gt;speed
op_ne
id|USB_SPEED_UNKNOWN
)paren
(brace
id|usb_ep_disable
(paren
id|dev-&gt;in_ep
)paren
suffix:semicolon
id|usb_ep_disable
(paren
id|dev-&gt;out_ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_carrier_ok
(paren
id|dev-&gt;net
)paren
)paren
(brace
id|DEBUG
(paren
id|dev
comma
l_string|&quot;host still using in/out endpoints&bslash;n&quot;
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;in_ep
comma
id|dev-&gt;in
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;out_ep
comma
id|dev-&gt;out
)paren
suffix:semicolon
)brace
macro_line|#ifdef&t;EP_STATUS_NUM
id|usb_ep_disable
(paren
id|dev-&gt;status_ep
)paren
suffix:semicolon
id|usb_ep_enable
(paren
id|dev-&gt;status_ep
comma
id|dev-&gt;status
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
DECL|function|eth_unbind
id|eth_unbind
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
op_assign
id|get_gadget_data
(paren
id|gadget
)paren
suffix:semicolon
id|DEBUG
(paren
id|dev
comma
l_string|&quot;unbind&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* we&squot;ve already been disconnected ... no i/o is active */
r_if
c_cond
(paren
id|dev-&gt;req
)paren
(brace
id|usb_ep_free_buffer
(paren
id|gadget-&gt;ep0
comma
id|dev-&gt;req-&gt;buf
comma
id|dev-&gt;req-&gt;dma
comma
id|USB_BUFSIZ
)paren
suffix:semicolon
id|usb_ep_free_request
(paren
id|gadget-&gt;ep0
comma
id|dev-&gt;req
)paren
suffix:semicolon
id|dev-&gt;req
op_assign
l_int|0
suffix:semicolon
)brace
id|unregister_netdev
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev-&gt;net
)paren
suffix:semicolon
multiline_comment|/* assuming we used keventd, it must quiesce too */
id|flush_scheduled_work
(paren
)paren
suffix:semicolon
id|set_gadget_data
(paren
id|gadget
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|eth_bind
id|eth_bind
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
r_struct
id|eth_dev
op_star
id|dev
suffix:semicolon
r_struct
id|net_device
op_star
id|net
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
macro_line|#ifdef&t;DEV_CONFIG_CDC
id|u8
id|node_id
(braket
id|ETH_ALEN
)braket
suffix:semicolon
multiline_comment|/* just one upstream link at a time */
r_if
c_cond
(paren
id|ethaddr
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
id|net
op_assign
id|alloc_etherdev
(paren
r_sizeof
op_star
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|net
)paren
r_return
id|status
suffix:semicolon
id|dev
op_assign
id|net-&gt;priv
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|INIT_WORK
(paren
op_amp
id|dev-&gt;work
comma
id|eth_work
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* network device setup */
id|dev-&gt;net
op_assign
id|net
suffix:semicolon
id|SET_MODULE_OWNER
(paren
id|net
)paren
suffix:semicolon
id|net-&gt;priv
op_assign
id|dev
suffix:semicolon
id|strcpy
(paren
id|net-&gt;name
comma
l_string|&quot;usb%d&quot;
)paren
suffix:semicolon
id|ether_setup
(paren
id|net
)paren
suffix:semicolon
multiline_comment|/* one random address for the gadget device ... both of these could&n;&t; * reasonably come from an id prom or a module parameter.&n;&t; */
id|get_random_bytes
(paren
id|net-&gt;dev_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|net-&gt;dev_addr
(braket
l_int|0
)braket
op_and_assign
l_int|0xfe
suffix:semicolon
singleline_comment|// clear multicast bit
id|net-&gt;dev_addr
(braket
l_int|0
)braket
op_or_assign
l_int|0x02
suffix:semicolon
singleline_comment|// set local assignment bit (IEEE802)
macro_line|#ifdef&t;DEV_CONFIG_CDC
multiline_comment|/* ... another address for the host, on the other end of the&n;&t; * link, gets exported through CDC (see CDC spec table 41)&n;&t; */
id|get_random_bytes
(paren
id|node_id
comma
r_sizeof
id|node_id
)paren
suffix:semicolon
id|node_id
(braket
l_int|0
)braket
op_and_assign
l_int|0xfe
suffix:semicolon
singleline_comment|// clear multicast bit
id|node_id
(braket
l_int|0
)braket
op_or_assign
l_int|0x02
suffix:semicolon
singleline_comment|// set local assignment bit (IEEE802)
id|snprintf
(paren
id|ethaddr
comma
r_sizeof
id|ethaddr
comma
l_string|&quot;%02X%02X%02X%02X%02X%02X&quot;
comma
id|node_id
(braket
l_int|0
)braket
comma
id|node_id
(braket
l_int|1
)braket
comma
id|node_id
(braket
l_int|2
)braket
comma
id|node_id
(braket
l_int|3
)braket
comma
id|node_id
(braket
l_int|4
)braket
comma
id|node_id
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
id|net-&gt;change_mtu
op_assign
id|eth_change_mtu
suffix:semicolon
id|net-&gt;get_stats
op_assign
id|eth_get_stats
suffix:semicolon
id|net-&gt;hard_start_xmit
op_assign
id|eth_start_xmit
suffix:semicolon
id|net-&gt;open
op_assign
id|eth_open
suffix:semicolon
id|net-&gt;stop
op_assign
id|eth_stop
suffix:semicolon
singleline_comment|// watchdog_timeo, tx_timeout ...
singleline_comment|// set_multicast_list
id|net-&gt;do_ioctl
op_assign
id|eth_ioctl
suffix:semicolon
multiline_comment|/* preallocate control response and buffer */
id|dev-&gt;req
op_assign
id|usb_ep_alloc_request
(paren
id|gadget-&gt;ep0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;req
)paren
r_goto
id|fail
suffix:semicolon
id|dev-&gt;req-&gt;complete
op_assign
id|eth_setup_complete
suffix:semicolon
id|dev-&gt;req-&gt;buf
op_assign
id|usb_ep_alloc_buffer
(paren
id|gadget-&gt;ep0
comma
id|USB_BUFSIZ
comma
op_amp
id|dev-&gt;req-&gt;dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;req-&gt;buf
)paren
(brace
id|usb_ep_free_request
(paren
id|gadget-&gt;ep0
comma
id|dev-&gt;req
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* finish hookup to lower layer ... */
id|dev-&gt;gadget
op_assign
id|gadget
suffix:semicolon
id|set_gadget_data
(paren
id|gadget
comma
id|dev
)paren
suffix:semicolon
id|gadget-&gt;ep0-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|INFO
(paren
id|dev
comma
l_string|&quot;%s, &quot;
id|CHIP
l_string|&quot;, version: &quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
comma
id|driver_desc
)paren
suffix:semicolon
macro_line|#ifdef&t;DEV_CONFIG_CDC
id|INFO
(paren
id|dev
comma
l_string|&quot;CDC host enet %s&bslash;n&quot;
comma
id|ethaddr
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* two kinds of host-initiated state changes:&n;&t; *  - iff DATA transfer is active, carrier is &quot;on&quot;&n;&t; *  - tx queueing enabled if open *and* carrier is &quot;on&quot;&n;&t; */
id|netif_stop_queue
(paren
id|dev-&gt;net
)paren
suffix:semicolon
id|netif_carrier_off
(paren
id|dev-&gt;net
)paren
suffix:semicolon
singleline_comment|// SET_NETDEV_DEV (dev-&gt;net, &amp;gadget-&gt;dev);
id|status
op_assign
id|register_netdev
(paren
id|dev-&gt;net
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
r_return
id|status
suffix:semicolon
id|fail
suffix:colon
id|eth_unbind
(paren
id|gadget
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|eth_driver
r_static
r_struct
id|usb_gadget_driver
id|eth_driver
op_assign
(brace
macro_line|#ifdef HIGHSPEED
dot
id|speed
op_assign
id|USB_SPEED_HIGH
comma
macro_line|#else
dot
id|speed
op_assign
id|USB_SPEED_FULL
comma
macro_line|#endif
dot
id|function
op_assign
(paren
r_char
op_star
)paren
id|driver_desc
comma
dot
id|bind
op_assign
id|eth_bind
comma
dot
id|unbind
op_assign
id|eth_unbind
comma
dot
id|setup
op_assign
id|eth_setup
comma
dot
id|disconnect
op_assign
id|eth_disconnect
comma
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
id|shortname
comma
singleline_comment|// .shutdown = ...
singleline_comment|// .suspend = ...
singleline_comment|// .resume = ...
)brace
comma
)brace
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;David Brownell&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
(paren
r_void
)paren
(brace
r_return
id|usb_gadget_register_driver
(paren
op_amp
id|eth_driver
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
(paren
id|init
)paren
suffix:semicolon
DECL|function|cleanup
r_static
r_void
id|__exit
id|cleanup
(paren
r_void
)paren
(brace
id|usb_gadget_unregister_driver
(paren
op_amp
id|eth_driver
)paren
suffix:semicolon
)brace
DECL|variable|cleanup
id|module_exit
(paren
id|cleanup
)paren
suffix:semicolon
eof
