multiline_comment|/*&n; * omap_udc.c -- for OMAP full speed udc; most chips support OTG.&n; *&n; * Copyright (C) 2004 Texas Instruments, Inc.&n; * Copyright (C) 2004 David Brownell&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
DECL|macro|DEBUG
macro_line|#undef&t;DEBUG
DECL|macro|VERBOSE
macro_line|#undef&t;VERBOSE
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/usb_ch9.h&gt;
macro_line|#include &lt;linux/usb_gadget.h&gt;
macro_line|#include &lt;linux/usb_otg.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/arch/dma.h&gt;
macro_line|#include &lt;asm/arch/mux.h&gt;
macro_line|#include &lt;asm/arch/usb.h&gt;
macro_line|#include &quot;omap_udc.h&quot;
DECL|macro|USB_TRACE
macro_line|#undef&t;USB_TRACE
multiline_comment|/* bulk DMA seems to be behaving for both IN and OUT */
DECL|macro|USE_DMA
mdefine_line|#define&t;USE_DMA
multiline_comment|/* ISO too */
DECL|macro|USE_ISO
mdefine_line|#define&t;USE_ISO
DECL|macro|DRIVER_DESC
mdefine_line|#define&t;DRIVER_DESC&t;&quot;OMAP UDC driver&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define&t;DRIVER_VERSION&t;&quot;4 October 2004&quot;
DECL|macro|DMA_ADDR_INVALID
mdefine_line|#define&t;DMA_ADDR_INVALID&t;(~(dma_addr_t)0)
multiline_comment|/*&n; * The OMAP UDC needs _very_ early endpoint setup:  before enabling the&n; * D+ pullup to allow enumeration.  That&squot;s too early for the gadget&n; * framework to use from usb_endpoint_enable(), which happens after&n; * enumeration as part of activating an interface.  (But if we add an&n; * optional new &quot;UDC not yet running&quot; state to the gadget driver model,&n; * even just during driver binding, the endpoint autoconfig logic is the&n; * natural spot to manufacture new endpoints.)&n; *&n; * So instead of using endpoint enable calls to control the hardware setup,&n; * this driver defines a &quot;fifo mode&quot; parameter.  It&squot;s used during driver&n; * initialization to choose among a set of pre-defined endpoint configs.&n; * See omap_udc_setup() for available modes, or to add others.  That code&n; * lives in an init section, so use this driver as a module if you need&n; * to change the fifo mode after the kernel boots.&n; *&n; * Gadget drivers normally ignore endpoints they don&squot;t care about, and&n; * won&squot;t include them in configuration descriptors.  That means only&n; * misbehaving hosts would even notice they exist.&n; */
macro_line|#ifdef&t;USE_ISO
DECL|variable|fifo_mode
r_static
r_int
id|fifo_mode
op_assign
l_int|3
suffix:semicolon
macro_line|#else
DECL|variable|fifo_mode
r_static
r_int
id|fifo_mode
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* &quot;modprobe omap_udc fifo_mode=42&quot;, or else as a kernel&n; * boot parameter &quot;omap_udc:fifo_mode=42&quot;&n; */
id|module_param
(paren
id|fifo_mode
comma
id|uint
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|fifo_mode
comma
l_string|&quot;endpoint setup (0 == default)&quot;
)paren
suffix:semicolon
macro_line|#ifdef&t;USE_DMA
DECL|variable|use_dma
r_static
r_int
id|use_dma
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &quot;modprobe omap_udc use_dma=y&quot;, or else as a kernel&n; * boot parameter &quot;omap_udc:use_dma=y&quot;&n; */
id|module_param
(paren
id|use_dma
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|use_dma
comma
l_string|&quot;enable/disable DMA&quot;
)paren
suffix:semicolon
macro_line|#else&t;/* !USE_DMA */
multiline_comment|/* save a bit of code */
DECL|macro|use_dma
mdefine_line|#define&t;use_dma&t;&t;0
macro_line|#endif&t;/* !USE_DMA */
DECL|variable|driver_name
r_static
r_const
r_char
id|driver_name
(braket
)braket
op_assign
l_string|&quot;omap_udc&quot;
suffix:semicolon
DECL|variable|driver_desc
r_static
r_const
r_char
id|driver_desc
(braket
)braket
op_assign
id|DRIVER_DESC
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* there&squot;s a notion of &quot;current endpoint&quot; for modifying endpoint&n; * state, and PIO access to its FIFO.  &n; */
DECL|function|use_ep
r_static
r_void
id|use_ep
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
id|u16
id|select
)paren
(brace
id|u16
id|num
op_assign
id|ep-&gt;bEndpointAddress
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
id|num
op_or_assign
id|UDC_EP_DIR
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|num
op_or
id|select
suffix:semicolon
multiline_comment|/* when select, MUST deselect later !! */
)brace
DECL|function|deselect_ep
r_static
r_inline
r_void
id|deselect_ep
c_func
(paren
r_void
)paren
(brace
id|UDC_EP_NUM_REG
op_and_assign
op_complement
id|UDC_EP_SEL
suffix:semicolon
multiline_comment|/* 6 wait states before TX will happen */
)brace
r_static
r_void
id|dma_channel_claim
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_int
id|preferred
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|omap_ep_enable
r_static
r_int
id|omap_ep_enable
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|desc
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|omap_ep
comma
id|ep
)paren
suffix:semicolon
r_struct
id|omap_udc
op_star
id|udc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|maxp
suffix:semicolon
multiline_comment|/* catch various bogus parameters */
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|desc
op_logical_or
id|ep-&gt;desc
op_logical_or
id|desc-&gt;bDescriptorType
op_ne
id|USB_DT_ENDPOINT
op_logical_or
id|ep-&gt;bEndpointAddress
op_ne
id|desc-&gt;bEndpointAddress
op_logical_or
id|ep-&gt;maxpacket
OL
id|le16_to_cpu
(paren
id|desc-&gt;wMaxPacketSize
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, bad ep or descriptor&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|maxp
op_assign
id|le16_to_cpu
(paren
id|desc-&gt;wMaxPacketSize
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|desc-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_BULK
op_logical_and
id|maxp
op_ne
id|ep-&gt;maxpacket
)paren
op_logical_or
id|desc-&gt;wMaxPacketSize
OG
id|ep-&gt;maxpacket
op_logical_or
op_logical_neg
id|desc-&gt;wMaxPacketSize
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, bad %s maxpacket&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
macro_line|#ifdef&t;USE_ISO
r_if
c_cond
(paren
(paren
id|desc-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_ISOC
op_logical_and
id|desc-&gt;bInterval
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/* hardware wants period = 1; USB allows 2^(Interval-1) */
id|DBG
c_func
(paren
l_string|&quot;%s, unsupported ISO period %dms&bslash;n&quot;
comma
id|_ep-&gt;name
comma
l_int|1
op_lshift
(paren
id|desc-&gt;bInterval
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EDOM
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|desc-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_ISOC
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, ISO nyet&bslash;n&quot;
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EDOM
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* xfer types must match, except that interrupt ~= bulk */
r_if
c_cond
(paren
id|ep-&gt;bmAttributes
op_ne
id|desc-&gt;bmAttributes
op_logical_and
id|ep-&gt;bmAttributes
op_ne
id|USB_ENDPOINT_XFER_BULK
op_logical_and
id|desc-&gt;bmAttributes
op_ne
id|USB_ENDPOINT_XFER_INT
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, %s type mismatch&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|udc
op_assign
id|ep-&gt;udc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;driver
op_logical_or
id|udc-&gt;gadget.speed
op_eq
id|USB_SPEED_UNKNOWN
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, bogus device state&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ep-&gt;desc
op_assign
id|desc
suffix:semicolon
id|ep-&gt;irqs
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;ep.maxpacket
op_assign
id|maxp
suffix:semicolon
multiline_comment|/* set endpoint to initial state */
id|ep-&gt;dma_channel
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;has_dma
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;lch
op_assign
op_minus
l_int|1
suffix:semicolon
id|use_ep
c_func
(paren
id|ep
comma
id|UDC_EP_SEL
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_RESET_EP
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|0
suffix:semicolon
id|deselect_ep
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_ISOC
)paren
id|list_add
c_func
(paren
op_amp
id|ep-&gt;iso
comma
op_amp
id|udc-&gt;iso
)paren
suffix:semicolon
multiline_comment|/* maybe assign a DMA channel to this endpoint */
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|desc-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_BULK
)paren
multiline_comment|/* FIXME ISO can dma, but prefers first channel */
id|dma_channel_claim
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* PIO OUT may RX packets */
r_if
c_cond
(paren
id|desc-&gt;bmAttributes
op_ne
id|USB_ENDPOINT_XFER_ISOC
op_logical_and
op_logical_neg
id|ep-&gt;has_dma
op_logical_and
op_logical_neg
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|1
op_plus
id|ep-&gt;double_buf
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|VDBG
c_func
(paren
l_string|&quot;%s enabled&bslash;n&quot;
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|nuke
c_func
(paren
r_struct
id|omap_ep
op_star
comma
r_int
id|status
)paren
suffix:semicolon
DECL|function|omap_ep_disable
r_static
r_int
id|omap_ep_disable
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|omap_ep
comma
id|ep
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|ep-&gt;desc
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, %s not enabled&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep
ques
c_cond
id|ep-&gt;ep.name
suffix:colon
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ep-&gt;desc
op_assign
l_int|0
suffix:semicolon
id|nuke
(paren
id|ep
comma
op_minus
id|ESHUTDOWN
)paren
suffix:semicolon
id|ep-&gt;ep.maxpacket
op_assign
id|ep-&gt;maxpacket
suffix:semicolon
id|ep-&gt;has_dma
op_assign
l_int|0
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_HALT
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|ep-&gt;iso
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ep-&gt;timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|VDBG
c_func
(paren
l_string|&quot;%s disabled&bslash;n&quot;
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_struct
id|usb_request
op_star
DECL|function|omap_alloc_request
id|omap_alloc_request
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
id|req
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|req
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
(brace
id|memset
(paren
id|req
comma
l_int|0
comma
r_sizeof
op_star
id|req
)paren
suffix:semicolon
id|req-&gt;req.dma
op_assign
id|DMA_ADDR_INVALID
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|req-&gt;queue
)paren
suffix:semicolon
)brace
r_return
op_amp
id|req-&gt;req
suffix:semicolon
)brace
r_static
r_void
DECL|function|omap_free_request
id|omap_free_request
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|_req
)paren
(brace
r_struct
id|omap_req
op_star
id|req
op_assign
id|container_of
c_func
(paren
id|_req
comma
r_struct
id|omap_req
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_req
)paren
id|kfree
(paren
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
op_star
DECL|function|omap_alloc_buffer
id|omap_alloc_buffer
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_int
id|bytes
comma
id|dma_addr_t
op_star
id|dma
comma
r_int
id|gfp_flags
)paren
(brace
r_void
op_star
id|retval
suffix:semicolon
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|omap_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;has_dma
)paren
(brace
r_static
r_int
id|warned
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|warned
op_logical_and
id|bytes
OL
id|PAGE_SIZE
)paren
(brace
id|dev_warn
c_func
(paren
id|ep-&gt;udc-&gt;gadget.dev.parent
comma
l_string|&quot;using dma_alloc_coherent for &quot;
l_string|&quot;small allocations wastes memory&bslash;n&quot;
)paren
suffix:semicolon
id|warned
op_increment
suffix:semicolon
)brace
r_return
id|dma_alloc_coherent
c_func
(paren
id|ep-&gt;udc-&gt;gadget.dev.parent
comma
id|bytes
comma
id|dma
comma
id|gfp_flags
)paren
suffix:semicolon
)brace
id|retval
op_assign
id|kmalloc
c_func
(paren
id|bytes
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
op_star
id|dma
op_assign
id|virt_to_phys
c_func
(paren
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|omap_free_buffer
r_static
r_void
id|omap_free_buffer
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_void
op_star
id|buf
comma
id|dma_addr_t
id|dma
comma
r_int
id|bytes
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|omap_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|_ep
op_logical_and
id|ep-&gt;has_dma
)paren
id|dma_free_coherent
c_func
(paren
id|ep-&gt;udc-&gt;gadget.dev.parent
comma
id|bytes
comma
id|buf
comma
id|dma
)paren
suffix:semicolon
r_else
id|kfree
(paren
id|buf
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
DECL|function|done
id|done
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_struct
id|omap_req
op_star
id|req
comma
r_int
id|status
)paren
(brace
r_int
id|stopped
op_assign
id|ep-&gt;stopped
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|req-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;req.status
op_eq
op_minus
id|EINPROGRESS
)paren
id|req-&gt;req.status
op_assign
id|status
suffix:semicolon
r_else
id|status
op_assign
id|req-&gt;req.status
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;has_dma
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;mapped
)paren
(brace
id|dma_unmap_single
c_func
(paren
id|ep-&gt;udc-&gt;gadget.dev.parent
comma
id|req-&gt;req.dma
comma
id|req-&gt;req.length
comma
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
id|DMA_TO_DEVICE
suffix:colon
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|req-&gt;req.dma
op_assign
id|DMA_ADDR_INVALID
suffix:semicolon
id|req-&gt;mapped
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|dma_sync_single_for_cpu
c_func
(paren
id|ep-&gt;udc-&gt;gadget.dev.parent
comma
id|req-&gt;req.dma
comma
id|req-&gt;req.length
comma
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
id|DMA_TO_DEVICE
suffix:colon
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
)brace
macro_line|#ifndef&t;USB_TRACE
r_if
c_cond
(paren
id|status
op_logical_and
id|status
op_ne
op_minus
id|ESHUTDOWN
)paren
macro_line|#endif
id|VDBG
c_func
(paren
l_string|&quot;complete %s req %p stat %d len %u/%u&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
op_amp
id|req-&gt;req
comma
id|status
comma
id|req-&gt;req.actual
comma
id|req-&gt;req.length
)paren
suffix:semicolon
multiline_comment|/* don&squot;t modify queue heads during completion callback */
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
)paren
suffix:semicolon
id|req-&gt;req
dot
id|complete
c_func
(paren
op_amp
id|ep-&gt;ep
comma
op_amp
id|req-&gt;req
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
)paren
suffix:semicolon
id|ep-&gt;stopped
op_assign
id|stopped
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|FIFO_FULL
mdefine_line|#define&t;FIFO_FULL&t;(UDC_NON_ISO_FIFO_FULL | UDC_ISO_FIFO_FULL)
DECL|macro|FIFO_UNWRITABLE
mdefine_line|#define&t;FIFO_UNWRITABLE&t;(UDC_EP_HALTED | FIFO_FULL)
DECL|macro|FIFO_EMPTY
mdefine_line|#define FIFO_EMPTY&t;(UDC_NON_ISO_FIFO_EMPTY | UDC_ISO_FIFO_EMPTY)
DECL|macro|FIFO_UNREADABLE
mdefine_line|#define FIFO_UNREADABLE (UDC_EP_HALTED | FIFO_EMPTY)
r_static
r_inline
r_int
DECL|function|write_packet
id|write_packet
c_func
(paren
id|u8
op_star
id|buf
comma
r_struct
id|omap_req
op_star
id|req
comma
r_int
id|max
)paren
(brace
r_int
id|len
suffix:semicolon
id|u16
op_star
id|wp
suffix:semicolon
id|len
op_assign
id|min
c_func
(paren
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
comma
id|max
)paren
suffix:semicolon
id|req-&gt;req.actual
op_add_assign
id|len
suffix:semicolon
id|max
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
(paren
(paren
(paren
r_int
)paren
id|buf
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|wp
op_assign
(paren
id|u16
op_star
)paren
id|buf
suffix:semicolon
r_while
c_loop
(paren
id|max
op_ge
l_int|2
)paren
(brace
id|UDC_DATA_REG
op_assign
op_star
id|wp
op_increment
suffix:semicolon
id|max
op_sub_assign
l_int|2
suffix:semicolon
)brace
id|buf
op_assign
(paren
id|u8
op_star
)paren
id|wp
suffix:semicolon
)brace
r_while
c_loop
(paren
id|max
op_decrement
)paren
op_star
(paren
r_volatile
id|u8
op_star
)paren
op_amp
id|UDC_DATA_REG
op_assign
op_star
id|buf
op_increment
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
singleline_comment|// FIXME change r/w fifo calling convention
singleline_comment|// return:  0 = still running, 1 = completed, negative = errno
DECL|function|write_fifo
r_static
r_int
id|write_fifo
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_struct
id|omap_req
op_star
id|req
)paren
(brace
id|u8
op_star
id|buf
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|is_last
suffix:semicolon
id|u16
id|ep_stat
suffix:semicolon
id|buf
op_assign
id|req-&gt;req.buf
op_plus
id|req-&gt;req.actual
suffix:semicolon
id|prefetch
c_func
(paren
id|buf
)paren
suffix:semicolon
multiline_comment|/* PIO-IN isn&squot;t double buffered except for iso */
id|ep_stat
op_assign
id|UDC_STAT_FLG_REG
suffix:semicolon
r_if
c_cond
(paren
id|ep_stat
op_amp
id|FIFO_UNWRITABLE
)paren
r_return
l_int|0
suffix:semicolon
id|count
op_assign
id|ep-&gt;ep.maxpacket
suffix:semicolon
id|count
op_assign
id|write_packet
c_func
(paren
id|buf
comma
id|req
comma
id|count
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* last packet is often short (sometimes a zlp) */
r_if
c_cond
(paren
id|count
op_ne
id|ep-&gt;ep.maxpacket
)paren
id|is_last
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|req-&gt;req.length
op_eq
id|req-&gt;req.actual
op_logical_and
op_logical_neg
id|req-&gt;req.zero
)paren
id|is_last
op_assign
l_int|1
suffix:semicolon
r_else
id|is_last
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* NOTE:  requests complete when all IN data is in a&n;&t; * FIFO (or sometimes later, if a zlp was needed).&n;&t; * Use usb_ep_fifo_status() where needed.&n;&t; */
r_if
c_cond
(paren
id|is_last
)paren
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
r_return
id|is_last
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|read_packet
id|read_packet
c_func
(paren
id|u8
op_star
id|buf
comma
r_struct
id|omap_req
op_star
id|req
comma
r_int
id|avail
)paren
(brace
r_int
id|len
suffix:semicolon
id|u16
op_star
id|wp
suffix:semicolon
id|len
op_assign
id|min
c_func
(paren
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
comma
id|avail
)paren
suffix:semicolon
id|req-&gt;req.actual
op_add_assign
id|len
suffix:semicolon
id|avail
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
(paren
(paren
(paren
r_int
)paren
id|buf
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|wp
op_assign
(paren
id|u16
op_star
)paren
id|buf
suffix:semicolon
r_while
c_loop
(paren
id|avail
op_ge
l_int|2
)paren
(brace
op_star
id|wp
op_increment
op_assign
id|UDC_DATA_REG
suffix:semicolon
id|avail
op_sub_assign
l_int|2
suffix:semicolon
)brace
id|buf
op_assign
(paren
id|u8
op_star
)paren
id|wp
suffix:semicolon
)brace
r_while
c_loop
(paren
id|avail
op_decrement
)paren
op_star
id|buf
op_increment
op_assign
op_star
(paren
r_volatile
id|u8
op_star
)paren
op_amp
id|UDC_DATA_REG
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
singleline_comment|// return:  0 = still running, 1 = queue empty, negative = errno
DECL|function|read_fifo
r_static
r_int
id|read_fifo
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_struct
id|omap_req
op_star
id|req
)paren
(brace
id|u8
op_star
id|buf
suffix:semicolon
r_int
id|count
comma
id|avail
suffix:semicolon
r_int
id|is_last
suffix:semicolon
id|buf
op_assign
id|req-&gt;req.buf
op_plus
id|req-&gt;req.actual
suffix:semicolon
id|prefetchw
c_func
(paren
id|buf
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|u16
id|ep_stat
op_assign
id|UDC_STAT_FLG_REG
suffix:semicolon
id|is_last
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ep_stat
op_amp
id|FIFO_EMPTY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;double_buf
)paren
r_break
suffix:semicolon
id|ep-&gt;fnf
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ep_stat
op_amp
id|UDC_EP_HALTED
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ep_stat
op_amp
id|FIFO_FULL
)paren
id|avail
op_assign
id|ep-&gt;ep.maxpacket
suffix:semicolon
r_else
(brace
id|avail
op_assign
id|UDC_RXFSTAT_REG
suffix:semicolon
id|ep-&gt;fnf
op_assign
id|ep-&gt;double_buf
suffix:semicolon
)brace
id|count
op_assign
id|read_packet
c_func
(paren
id|buf
comma
id|req
comma
id|avail
)paren
suffix:semicolon
multiline_comment|/* partial packet reads may not be errors */
r_if
c_cond
(paren
id|count
OL
id|ep-&gt;ep.maxpacket
)paren
(brace
id|is_last
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* overflowed this request?  flush extra data */
r_if
c_cond
(paren
id|count
op_ne
id|avail
)paren
(brace
id|req-&gt;req.status
op_assign
op_minus
id|EOVERFLOW
suffix:semicolon
id|avail
op_sub_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|avail
op_decrement
)paren
(paren
r_void
)paren
op_star
(paren
r_volatile
id|u8
op_star
)paren
op_amp
id|UDC_DATA_REG
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|req-&gt;req.length
op_eq
id|req-&gt;req.actual
)paren
id|is_last
op_assign
l_int|1
suffix:semicolon
r_else
id|is_last
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;bEndpointAddress
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|is_last
)paren
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|is_last
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|dma_src_len
r_static
id|u16
id|dma_src_len
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
id|dma_addr_t
id|start
)paren
(brace
id|dma_addr_t
id|end
suffix:semicolon
multiline_comment|/* IN-DMA needs this on fault/cancel paths, so 15xx misreports&n;&t; * the last transfer&squot;s bytecount by more than a FIFO&squot;s worth.&n;&t; */
r_if
c_cond
(paren
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|end
op_assign
id|omap_readw
c_func
(paren
id|OMAP_DMA_CSAC
c_func
(paren
id|ep-&gt;lch
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
id|ep-&gt;dma_counter
)paren
r_return
l_int|0
suffix:semicolon
id|end
op_or_assign
id|start
op_amp
(paren
l_int|0xffff
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
OL
id|start
)paren
id|end
op_add_assign
l_int|0x10000
suffix:semicolon
r_return
id|end
op_minus
id|start
suffix:semicolon
)brace
DECL|macro|DMA_DEST_LAST
mdefine_line|#define DMA_DEST_LAST(x) (cpu_is_omap15xx() &bslash;&n;&t;&t;? OMAP_DMA_CSAC(x) /* really: CPC */ &bslash;&n;&t;&t;: OMAP_DMA_CDAC(x))
DECL|function|dma_dest_len
r_static
id|u16
id|dma_dest_len
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
id|dma_addr_t
id|start
)paren
(brace
id|dma_addr_t
id|end
suffix:semicolon
id|end
op_assign
id|omap_readw
c_func
(paren
id|DMA_DEST_LAST
c_func
(paren
id|ep-&gt;lch
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
id|ep-&gt;dma_counter
)paren
r_return
l_int|0
suffix:semicolon
id|end
op_or_assign
id|start
op_amp
(paren
l_int|0xffff
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
id|end
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|end
OL
id|start
)paren
id|end
op_add_assign
l_int|0x10000
suffix:semicolon
r_return
id|end
op_minus
id|start
suffix:semicolon
)brace
multiline_comment|/* Each USB transfer request using DMA maps to one or more DMA transfers.&n; * When DMA completion isn&squot;t request completion, the UDC continues with&n; * the next DMA transfer for that USB transfer.&n; */
DECL|function|next_in_dma
r_static
r_void
id|next_in_dma
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_struct
id|omap_req
op_star
id|req
)paren
(brace
id|u16
id|txdma_ctrl
suffix:semicolon
r_int
id|length
op_assign
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
suffix:semicolon
r_const
r_int
id|sync_mode
op_assign
id|cpu_is_omap15xx
c_func
(paren
)paren
ques
c_cond
id|OMAP_DMA_SYNC_FRAME
suffix:colon
id|OMAP_DMA_SYNC_ELEMENT
suffix:semicolon
multiline_comment|/* measure length in either bytes or packets */
r_if
c_cond
(paren
(paren
id|cpu_is_omap16xx
c_func
(paren
)paren
op_logical_and
id|length
op_le
(paren
id|UDC_TXN_TSC
op_plus
l_int|1
)paren
)paren
op_logical_or
(paren
id|cpu_is_omap15xx
c_func
(paren
)paren
op_logical_and
id|length
OL
id|ep-&gt;maxpacket
)paren
)paren
(brace
id|txdma_ctrl
op_assign
id|UDC_TXN_EOT
op_or
id|length
suffix:semicolon
id|omap_set_dma_transfer_params
c_func
(paren
id|ep-&gt;lch
comma
id|OMAP_DMA_DATA_TYPE_S8
comma
id|length
comma
l_int|1
comma
id|sync_mode
)paren
suffix:semicolon
)brace
r_else
(brace
id|length
op_assign
id|min
c_func
(paren
id|length
op_div
id|ep-&gt;maxpacket
comma
(paren
r_int
)paren
id|UDC_TXN_TSC
op_plus
l_int|1
)paren
suffix:semicolon
id|txdma_ctrl
op_assign
id|length
suffix:semicolon
id|omap_set_dma_transfer_params
c_func
(paren
id|ep-&gt;lch
comma
id|OMAP_DMA_DATA_TYPE_S8
comma
id|ep-&gt;ep.maxpacket
comma
id|length
comma
id|sync_mode
)paren
suffix:semicolon
id|length
op_mul_assign
id|ep-&gt;maxpacket
suffix:semicolon
)brace
id|omap_set_dma_src_params
c_func
(paren
id|ep-&gt;lch
comma
id|OMAP_DMA_PORT_EMIFF
comma
id|OMAP_DMA_AMODE_POST_INC
comma
id|req-&gt;req.dma
op_plus
id|req-&gt;req.actual
)paren
suffix:semicolon
id|omap_start_dma
c_func
(paren
id|ep-&gt;lch
)paren
suffix:semicolon
id|ep-&gt;dma_counter
op_assign
id|omap_readw
c_func
(paren
id|OMAP_DMA_CSAC
c_func
(paren
id|ep-&gt;lch
)paren
)paren
suffix:semicolon
id|UDC_DMA_IRQ_EN_REG
op_or_assign
id|UDC_TX_DONE_IE
c_func
(paren
id|ep-&gt;dma_channel
)paren
suffix:semicolon
id|UDC_TXDMA_REG
c_func
(paren
id|ep-&gt;dma_channel
)paren
op_assign
id|UDC_TXN_START
op_or
id|txdma_ctrl
suffix:semicolon
id|req-&gt;dma_bytes
op_assign
id|length
suffix:semicolon
)brace
DECL|function|finish_in_dma
r_static
r_void
id|finish_in_dma
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_struct
id|omap_req
op_star
id|req
comma
r_int
id|status
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|req-&gt;req.actual
op_add_assign
id|req-&gt;dma_bytes
suffix:semicolon
multiline_comment|/* return if this request needs to send data or zlp */
r_if
c_cond
(paren
id|req-&gt;req.actual
OL
id|req-&gt;req.length
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;req.zero
op_logical_and
id|req-&gt;dma_bytes
op_ne
l_int|0
op_logical_and
(paren
id|req-&gt;req.actual
op_mod
id|ep-&gt;maxpacket
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_else
id|req-&gt;req.actual
op_add_assign
id|dma_src_len
c_func
(paren
id|ep
comma
id|req-&gt;req.dma
op_plus
id|req-&gt;req.actual
)paren
suffix:semicolon
multiline_comment|/* tx completion */
id|omap_stop_dma
c_func
(paren
id|ep-&gt;lch
)paren
suffix:semicolon
id|UDC_DMA_IRQ_EN_REG
op_and_assign
op_complement
id|UDC_TX_DONE_IE
c_func
(paren
id|ep-&gt;dma_channel
)paren
suffix:semicolon
id|done
c_func
(paren
id|ep
comma
id|req
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|next_out_dma
r_static
r_void
id|next_out_dma
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_struct
id|omap_req
op_star
id|req
)paren
(brace
r_int
id|packets
suffix:semicolon
multiline_comment|/* NOTE:  we filtered out &quot;short reads&quot; before, so we know&n;&t; * the buffer has only whole numbers of packets.&n;&t; */
multiline_comment|/* set up this DMA transfer, enable the fifo, start */
id|packets
op_assign
(paren
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
)paren
op_div
id|ep-&gt;ep.maxpacket
suffix:semicolon
id|packets
op_assign
id|min
c_func
(paren
id|packets
comma
(paren
r_int
)paren
id|UDC_RXN_TC
op_plus
l_int|1
)paren
suffix:semicolon
id|req-&gt;dma_bytes
op_assign
id|packets
op_star
id|ep-&gt;ep.maxpacket
suffix:semicolon
id|omap_set_dma_transfer_params
c_func
(paren
id|ep-&gt;lch
comma
id|OMAP_DMA_DATA_TYPE_S8
comma
id|ep-&gt;ep.maxpacket
comma
id|packets
comma
id|OMAP_DMA_SYNC_ELEMENT
)paren
suffix:semicolon
id|omap_set_dma_dest_params
c_func
(paren
id|ep-&gt;lch
comma
id|OMAP_DMA_PORT_EMIFF
comma
id|OMAP_DMA_AMODE_POST_INC
comma
id|req-&gt;req.dma
op_plus
id|req-&gt;req.actual
)paren
suffix:semicolon
id|ep-&gt;dma_counter
op_assign
id|omap_readw
c_func
(paren
id|DMA_DEST_LAST
c_func
(paren
id|ep-&gt;lch
)paren
)paren
suffix:semicolon
id|UDC_RXDMA_REG
c_func
(paren
id|ep-&gt;dma_channel
)paren
op_assign
id|UDC_RXN_STOP
op_or
(paren
id|packets
op_minus
l_int|1
)paren
suffix:semicolon
id|UDC_DMA_IRQ_EN_REG
op_or_assign
id|UDC_RX_EOT_IE
c_func
(paren
id|ep-&gt;dma_channel
)paren
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
(paren
id|ep-&gt;bEndpointAddress
op_amp
l_int|0xf
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|omap_start_dma
c_func
(paren
id|ep-&gt;lch
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|finish_out_dma
id|finish_out_dma
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_struct
id|omap_req
op_star
id|req
comma
r_int
id|status
)paren
(brace
id|u16
id|count
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|ep-&gt;dma_counter
op_assign
(paren
id|u16
)paren
(paren
id|req-&gt;req.dma
op_plus
id|req-&gt;req.actual
)paren
suffix:semicolon
id|count
op_assign
id|dma_dest_len
c_func
(paren
id|ep
comma
id|req-&gt;req.dma
op_plus
id|req-&gt;req.actual
)paren
suffix:semicolon
id|count
op_add_assign
id|req-&gt;req.actual
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
id|req-&gt;req.length
)paren
id|req-&gt;req.actual
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
id|req-&gt;dma_bytes
op_logical_or
id|status
)paren
id|omap_stop_dma
c_func
(paren
id|ep-&gt;lch
)paren
suffix:semicolon
multiline_comment|/* if this wasn&squot;t short, request may need another transfer */
r_else
r_if
c_cond
(paren
id|req-&gt;req.actual
OL
id|req-&gt;req.length
)paren
r_return
suffix:semicolon
multiline_comment|/* rx completion */
id|UDC_DMA_IRQ_EN_REG
op_and_assign
op_complement
id|UDC_RX_EOT_IE
c_func
(paren
id|ep-&gt;dma_channel
)paren
suffix:semicolon
id|done
c_func
(paren
id|ep
comma
id|req
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|dma_irq
r_static
r_void
id|dma_irq
c_func
(paren
r_struct
id|omap_udc
op_star
id|udc
comma
id|u16
id|irq_src
)paren
(brace
id|u16
id|dman_stat
op_assign
id|UDC_DMAN_STAT_REG
suffix:semicolon
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
multiline_comment|/* IN dma: tx to host */
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_TXN_DONE
)paren
(brace
id|ep
op_assign
op_amp
id|udc-&gt;ep
(braket
l_int|16
op_plus
id|UDC_DMA_TX_SRC
c_func
(paren
id|dman_stat
)paren
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
multiline_comment|/* can see TXN_DONE after dma abort */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
id|finish_in_dma
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_TXN_DONE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
id|next_in_dma
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* OUT dma: rx from host */
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_RXN_EOT
)paren
(brace
id|ep
op_assign
op_amp
id|udc-&gt;ep
(braket
id|UDC_DMA_RX_SRC
c_func
(paren
id|dman_stat
)paren
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
multiline_comment|/* can see RXN_EOT after dma abort */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
id|finish_out_dma
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_RXN_EOT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
id|next_out_dma
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_RXN_CNT
)paren
(brace
id|ep
op_assign
op_amp
id|udc-&gt;ep
(braket
id|UDC_DMA_RX_SRC
c_func
(paren
id|dman_stat
)paren
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
multiline_comment|/* omap15xx does this unasked... */
id|VDBG
c_func
(paren
l_string|&quot;%s, RX_CNT irq?&bslash;n&quot;
comma
id|ep-&gt;ep.name
)paren
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_RXN_CNT
suffix:semicolon
)brace
)brace
DECL|function|dma_error
r_static
r_void
id|dma_error
c_func
(paren
r_int
id|lch
comma
id|u16
id|ch_status
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
op_assign
id|data
suffix:semicolon
multiline_comment|/* if ch_status &amp; OMAP_DMA_DROP_IRQ ... */
multiline_comment|/* if ch_status &amp; OMAP_DMA_TOUT_IRQ ... */
id|ERR
c_func
(paren
l_string|&quot;%s dma error, lch %d status %02x&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|lch
comma
id|ch_status
)paren
suffix:semicolon
multiline_comment|/* complete current transfer ... */
)brace
DECL|function|dma_channel_claim
r_static
r_void
id|dma_channel_claim
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_int
id|channel
)paren
(brace
id|u16
id|reg
suffix:semicolon
r_int
id|status
comma
id|restart
comma
id|is_in
suffix:semicolon
id|is_in
op_assign
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
suffix:semicolon
r_if
c_cond
(paren
id|is_in
)paren
id|reg
op_assign
id|UDC_TXDMA_CFG_REG
suffix:semicolon
r_else
id|reg
op_assign
id|UDC_RXDMA_CFG_REG
suffix:semicolon
id|reg
op_or_assign
l_int|1
op_lshift
l_int|12
suffix:semicolon
multiline_comment|/* &quot;pulse&quot; activated */
id|ep-&gt;dma_channel
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;lch
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_eq
l_int|0
op_logical_or
id|channel
OG
l_int|3
)paren
(brace
r_if
c_cond
(paren
(paren
id|reg
op_amp
l_int|0x0f00
)paren
op_eq
l_int|0
)paren
id|channel
op_assign
l_int|3
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|reg
op_amp
l_int|0x00f0
)paren
op_eq
l_int|0
)paren
id|channel
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|reg
op_amp
l_int|0x000f
)paren
op_eq
l_int|0
)paren
multiline_comment|/* preferred for ISO */
id|channel
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|status
op_assign
op_minus
id|EMLINK
suffix:semicolon
r_goto
id|just_restart
suffix:semicolon
)brace
)brace
id|reg
op_or_assign
(paren
l_int|0x0f
op_amp
id|ep-&gt;bEndpointAddress
)paren
op_lshift
(paren
l_int|4
op_star
(paren
id|channel
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|ep-&gt;dma_channel
op_assign
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|is_in
)paren
(brace
id|status
op_assign
id|omap_request_dma
c_func
(paren
id|OMAP_DMA_USB_W2FC_TX0
op_minus
l_int|1
op_plus
id|channel
comma
id|ep-&gt;ep.name
comma
id|dma_error
comma
id|ep
comma
op_amp
id|ep-&gt;lch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|UDC_TXDMA_CFG_REG
op_assign
id|reg
suffix:semicolon
id|omap_set_dma_dest_params
c_func
(paren
id|ep-&gt;lch
comma
id|OMAP_DMA_PORT_TIPB
comma
id|OMAP_DMA_AMODE_CONSTANT
comma
(paren
r_int
r_int
)paren
id|io_v2p
c_func
(paren
(paren
id|u32
)paren
op_amp
id|UDC_DATA_DMA_REG
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
id|omap_request_dma
c_func
(paren
id|OMAP_DMA_USB_W2FC_RX0
op_minus
l_int|1
op_plus
id|channel
comma
id|ep-&gt;ep.name
comma
id|dma_error
comma
id|ep
comma
op_amp
id|ep-&gt;lch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|UDC_RXDMA_CFG_REG
op_assign
id|reg
suffix:semicolon
id|omap_set_dma_src_params
c_func
(paren
id|ep-&gt;lch
comma
id|OMAP_DMA_PORT_TIPB
comma
id|OMAP_DMA_AMODE_CONSTANT
comma
(paren
r_int
r_int
)paren
id|io_v2p
c_func
(paren
(paren
id|u32
)paren
op_amp
id|UDC_DATA_DMA_REG
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
)paren
id|ep-&gt;dma_channel
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|ep-&gt;has_dma
op_assign
l_int|1
suffix:semicolon
id|omap_disable_dma_irq
c_func
(paren
id|ep-&gt;lch
comma
id|OMAP_DMA_BLOCK_IRQ
)paren
suffix:semicolon
multiline_comment|/* channel type P: hw synch (fifo) */
r_if
c_cond
(paren
op_logical_neg
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
id|omap_writew
c_func
(paren
l_int|2
comma
id|OMAP_DMA_LCH_CTRL
c_func
(paren
id|ep-&gt;lch
)paren
)paren
suffix:semicolon
)brace
id|just_restart
suffix:colon
multiline_comment|/* restart any queue, even if the claim failed  */
id|restart
op_assign
op_logical_neg
id|ep-&gt;stopped
op_logical_and
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|DBG
c_func
(paren
l_string|&quot;%s no dma channel: %d%s&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|status
comma
id|restart
ques
c_cond
l_string|&quot; (restart)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_else
id|DBG
c_func
(paren
l_string|&quot;%s claimed %cxdma%d lch %d%s&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|is_in
ques
c_cond
l_char|&squot;t&squot;
suffix:colon
l_char|&squot;r&squot;
comma
id|ep-&gt;dma_channel
op_minus
l_int|1
comma
id|ep-&gt;lch
comma
id|restart
ques
c_cond
l_string|&quot; (restart)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|restart
)paren
(brace
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;has_dma
)paren
(paren
id|is_in
ques
c_cond
id|next_in_dma
suffix:colon
id|next_out_dma
)paren
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
r_else
(brace
id|use_ep
c_func
(paren
id|ep
comma
id|UDC_EP_SEL
)paren
suffix:semicolon
(paren
id|is_in
ques
c_cond
id|write_fifo
suffix:colon
id|read_fifo
)paren
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
id|deselect_ep
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_in
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|1
op_plus
id|ep-&gt;double_buf
suffix:semicolon
)brace
multiline_comment|/* IN: 6 wait states before it&squot;ll tx */
)brace
)brace
)brace
DECL|function|dma_channel_release
r_static
r_void
id|dma_channel_release
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
)paren
(brace
r_int
id|shift
op_assign
l_int|4
op_star
(paren
id|ep-&gt;dma_channel
op_minus
l_int|1
)paren
suffix:semicolon
id|u16
id|mask
op_assign
l_int|0x0f
op_lshift
id|shift
suffix:semicolon
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
r_int
id|active
suffix:semicolon
multiline_comment|/* abort any active usb transfer request */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
r_else
id|req
op_assign
l_int|0
suffix:semicolon
id|active
op_assign
(paren
(paren
l_int|1
op_lshift
l_int|7
)paren
op_amp
id|omap_readl
c_func
(paren
id|OMAP_DMA_CCR
c_func
(paren
id|ep-&gt;lch
)paren
)paren
)paren
op_ne
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s release %s %cxdma%d %p&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|active
ques
c_cond
l_string|&quot;active&quot;
suffix:colon
l_string|&quot;idle&quot;
comma
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
l_char|&squot;t&squot;
suffix:colon
l_char|&squot;r&squot;
comma
id|ep-&gt;dma_channel
op_minus
l_int|1
comma
id|req
)paren
suffix:semicolon
multiline_comment|/* wait till current packet DMA finishes, and fifo empties */
r_if
c_cond
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
(brace
id|UDC_TXDMA_CFG_REG
op_and_assign
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
(brace
id|finish_in_dma
c_func
(paren
id|ep
comma
id|req
comma
op_minus
id|ECONNRESET
)paren
suffix:semicolon
multiline_comment|/* clear FIFO; hosts probably won&squot;t empty it */
id|use_ep
c_func
(paren
id|ep
comma
id|UDC_EP_SEL
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_EP
suffix:semicolon
id|deselect_ep
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|UDC_TXDMA_CFG_REG
op_amp
id|mask
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
id|UDC_RXDMA_CFG_REG
op_and_assign
op_complement
id|mask
suffix:semicolon
multiline_comment|/* dma empties the fifo */
r_while
c_loop
(paren
id|UDC_RXDMA_CFG_REG
op_amp
id|mask
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
id|finish_out_dma
c_func
(paren
id|ep
comma
id|req
comma
op_minus
id|ECONNRESET
)paren
suffix:semicolon
)brace
id|omap_free_dma
c_func
(paren
id|ep-&gt;lch
)paren
suffix:semicolon
id|ep-&gt;dma_channel
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;lch
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* has_dma still set, till endpoint is fully quiesced */
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_int
DECL|function|omap_ep_queue
id|omap_ep_queue
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_struct
id|usb_request
op_star
id|_req
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|omap_ep
comma
id|ep
)paren
suffix:semicolon
r_struct
id|omap_req
op_star
id|req
op_assign
id|container_of
c_func
(paren
id|_req
comma
r_struct
id|omap_req
comma
id|req
)paren
suffix:semicolon
r_struct
id|omap_udc
op_star
id|udc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|is_iso
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* catch various bogus parameters */
r_if
c_cond
(paren
op_logical_neg
id|_req
op_logical_or
op_logical_neg
id|req-&gt;req.complete
op_logical_or
op_logical_neg
id|req-&gt;req.buf
op_logical_or
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|req-&gt;queue
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, bad params&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
(paren
op_logical_neg
id|ep-&gt;desc
op_logical_and
id|ep-&gt;bEndpointAddress
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, bad ep&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ep-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_ISOC
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;req.length
OG
id|ep-&gt;ep.maxpacket
)paren
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
id|is_iso
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* this isn&squot;t bogus, but OMAP DMA isn&squot;t the only hardware to&n;&t; * have a hard time with partial packet reads...  reject it.&n;&t; */
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;has_dma
op_logical_and
id|ep-&gt;bEndpointAddress
op_ne
l_int|0
op_logical_and
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
op_eq
l_int|0
op_logical_and
(paren
id|req-&gt;req.length
op_mod
id|ep-&gt;ep.maxpacket
)paren
op_ne
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s, no partial packet OUT reads&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
id|udc
op_assign
id|ep-&gt;udc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;driver
op_logical_or
id|udc-&gt;gadget.speed
op_eq
id|USB_SPEED_UNKNOWN
)paren
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;has_dma
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;req.dma
op_eq
id|DMA_ADDR_INVALID
)paren
(brace
id|req-&gt;req.dma
op_assign
id|dma_map_single
c_func
(paren
id|ep-&gt;udc-&gt;gadget.dev.parent
comma
id|req-&gt;req.buf
comma
id|req-&gt;req.length
comma
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
id|DMA_TO_DEVICE
suffix:colon
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|req-&gt;mapped
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|dma_sync_single_for_device
c_func
(paren
id|ep-&gt;udc-&gt;gadget.dev.parent
comma
id|req-&gt;req.dma
comma
id|req-&gt;req.length
comma
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
id|DMA_TO_DEVICE
suffix:colon
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|req-&gt;mapped
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|VDBG
c_func
(paren
l_string|&quot;%s queue req %p, len %d buf %p&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|_req
comma
id|_req-&gt;length
comma
id|_req-&gt;buf
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|req-&gt;req.status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|req-&gt;req.actual
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* maybe kickstart non-iso i/o queues */
r_if
c_cond
(paren
id|is_iso
)paren
id|UDC_IRQ_EN_REG
op_or_assign
id|UDC_SOF_IE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
op_logical_and
op_logical_neg
id|ep-&gt;stopped
op_logical_and
op_logical_neg
id|ep-&gt;ackwait
)paren
(brace
r_int
id|is_in
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;bEndpointAddress
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;ep0_pending
op_logical_or
op_logical_neg
id|list_empty
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EL2HLT
suffix:semicolon
)brace
multiline_comment|/* empty DATA stage? */
id|is_in
op_assign
id|udc-&gt;ep0_in
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req-&gt;req.length
)paren
(brace
multiline_comment|/* chip became CONFIGURED or ADDRESSED&n;&t;&t;&t;&t; * earlier; drivers may already have queued&n;&t;&t;&t;&t; * requests to non-control endpoints&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|udc-&gt;ep0_set_config
)paren
(brace
id|u16
id|irq_en
op_assign
id|UDC_IRQ_EN_REG
suffix:semicolon
id|irq_en
op_or_assign
id|UDC_DS_CHG_IE
op_or
id|UDC_EP0_IE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;ep0_reset_config
)paren
id|irq_en
op_or_assign
id|UDC_EPN_RX_IE
op_or
id|UDC_EPN_TX_IE
suffix:semicolon
id|UDC_IRQ_EN_REG
op_assign
id|irq_en
suffix:semicolon
)brace
multiline_comment|/* STATUS is reverse direction */
id|UDC_EP_NUM_REG
op_assign
id|is_in
ques
c_cond
id|UDC_EP_SEL
suffix:colon
(paren
id|UDC_EP_SEL
op_or
id|UDC_EP_DIR
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_EP
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|udc-&gt;ep0_in
ques
c_cond
l_int|0
suffix:colon
id|UDC_EP_DIR
suffix:semicolon
multiline_comment|/* cleanup */
id|udc-&gt;ep0_pending
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
id|req
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* non-empty DATA stage */
)brace
r_else
r_if
c_cond
(paren
id|is_in
)paren
(brace
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_SEL
op_or
id|UDC_EP_DIR
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|udc-&gt;ep0_setup
)paren
r_goto
id|irq_wait
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_SEL
suffix:semicolon
)brace
)brace
r_else
(brace
id|is_in
op_assign
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;has_dma
)paren
id|use_ep
c_func
(paren
id|ep
comma
id|UDC_EP_SEL
)paren
suffix:semicolon
multiline_comment|/* if ISO: SOF IRQs must be enabled/disabled! */
)brace
r_if
c_cond
(paren
id|ep-&gt;has_dma
)paren
(paren
id|is_in
ques
c_cond
id|next_in_dma
suffix:colon
id|next_out_dma
)paren
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|req
)paren
(brace
r_if
c_cond
(paren
(paren
id|is_in
ques
c_cond
id|write_fifo
suffix:colon
id|read_fifo
)paren
(paren
id|ep
comma
id|req
)paren
op_eq
l_int|1
)paren
id|req
op_assign
l_int|0
suffix:semicolon
id|deselect_ep
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_in
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|1
op_plus
id|ep-&gt;double_buf
suffix:semicolon
)brace
multiline_comment|/* IN: 6 wait states before it&squot;ll tx */
)brace
)brace
id|irq_wait
suffix:colon
multiline_comment|/* irq handler advances the queue */
r_if
c_cond
(paren
id|req
op_ne
l_int|0
)paren
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;queue
comma
op_amp
id|ep-&gt;queue
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|omap_ep_dequeue
r_static
r_int
id|omap_ep_dequeue
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_struct
id|usb_request
op_star
id|_req
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|omap_ep
comma
id|ep
)paren
suffix:semicolon
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|_req
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* make sure it&squot;s actually queued on this endpoint */
id|list_for_each_entry
(paren
id|req
comma
op_amp
id|ep-&gt;queue
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
op_amp
id|req-&gt;req
op_eq
id|_req
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_amp
id|req-&gt;req
op_ne
id|_req
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;dma_channel
op_logical_and
id|ep-&gt;queue.next
op_eq
op_amp
id|req-&gt;queue
)paren
(brace
r_int
id|channel
op_assign
id|ep-&gt;dma_channel
suffix:semicolon
multiline_comment|/* releasing the channel cancels the request,&n;&t;&t; * reclaiming the channel restarts the queue&n;&t;&t; */
id|dma_channel_release
c_func
(paren
id|ep
)paren
suffix:semicolon
id|dma_channel_claim
c_func
(paren
id|ep
comma
id|channel
)paren
suffix:semicolon
)brace
r_else
id|done
c_func
(paren
id|ep
comma
id|req
comma
op_minus
id|ECONNRESET
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|omap_ep_set_halt
r_static
r_int
id|omap_ep_set_halt
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_int
id|value
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|omap_ep
comma
id|ep
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* just use protocol stalls for ep0; real halts are annoying */
r_if
c_cond
(paren
id|ep-&gt;bEndpointAddress
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;udc-&gt;ep0_pending
)paren
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|value
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;udc-&gt;ep0_set_config
)paren
(brace
id|WARN
c_func
(paren
l_string|&quot;error changing config?&bslash;n&quot;
)paren
suffix:semicolon
id|UDC_SYSCON2_REG
op_assign
id|UDC_CLR_CFG
suffix:semicolon
)brace
id|UDC_SYSCON2_REG
op_assign
id|UDC_STALL_CMD
suffix:semicolon
id|ep-&gt;udc-&gt;ep0_pending
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* NOP */
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* otherwise, all active non-ISO endpoints can halt */
)brace
r_else
r_if
c_cond
(paren
id|ep-&gt;bmAttributes
op_ne
id|USB_ENDPOINT_XFER_ISOC
op_logical_and
id|ep-&gt;desc
)paren
(brace
multiline_comment|/* IN endpoints must already be idle */
r_if
c_cond
(paren
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
op_logical_and
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|status
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
)paren
(brace
r_int
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;dma_channel
op_logical_and
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|channel
op_assign
id|ep-&gt;dma_channel
suffix:semicolon
id|dma_channel_release
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
r_else
id|channel
op_assign
l_int|0
suffix:semicolon
id|use_ep
c_func
(paren
id|ep
comma
id|UDC_EP_SEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UDC_STAT_FLG_REG
op_amp
id|UDC_NON_ISO_FIFO_EMPTY
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_SET_HALT
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|status
op_assign
op_minus
id|EAGAIN
suffix:semicolon
id|deselect_ep
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel
)paren
id|dma_channel_claim
c_func
(paren
id|ep
comma
id|channel
)paren
suffix:semicolon
)brace
r_else
(brace
id|use_ep
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_RESET_EP
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|1
op_plus
id|ep-&gt;double_buf
suffix:semicolon
)brace
)brace
)brace
id|done
suffix:colon
id|VDBG
c_func
(paren
l_string|&quot;%s %s halt stat %d&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|value
ques
c_cond
l_string|&quot;set&quot;
suffix:colon
l_string|&quot;clear&quot;
comma
id|status
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|variable|omap_ep_ops
r_static
r_struct
id|usb_ep_ops
id|omap_ep_ops
op_assign
(brace
dot
id|enable
op_assign
id|omap_ep_enable
comma
dot
id|disable
op_assign
id|omap_ep_disable
comma
dot
id|alloc_request
op_assign
id|omap_alloc_request
comma
dot
id|free_request
op_assign
id|omap_free_request
comma
dot
id|alloc_buffer
op_assign
id|omap_alloc_buffer
comma
dot
id|free_buffer
op_assign
id|omap_free_buffer
comma
dot
id|queue
op_assign
id|omap_ep_queue
comma
dot
id|dequeue
op_assign
id|omap_ep_dequeue
comma
dot
id|set_halt
op_assign
id|omap_ep_set_halt
comma
singleline_comment|// fifo_status ... report bytes in fifo
singleline_comment|// fifo_flush ... flush fifo
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|omap_get_frame
r_static
r_int
id|omap_get_frame
c_func
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
id|u16
id|sof
op_assign
id|UDC_SOF_REG
suffix:semicolon
r_return
(paren
id|sof
op_amp
id|UDC_TS_OK
)paren
ques
c_cond
(paren
id|sof
op_amp
id|UDC_TS
)paren
suffix:colon
op_minus
id|EL2NSYNC
suffix:semicolon
)brace
DECL|function|omap_wakeup
r_static
r_int
id|omap_wakeup
c_func
(paren
r_struct
id|usb_gadget
op_star
id|gadget
)paren
(brace
r_struct
id|omap_udc
op_star
id|udc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EHOSTUNREACH
suffix:semicolon
id|udc
op_assign
id|container_of
c_func
(paren
id|gadget
comma
r_struct
id|omap_udc
comma
id|gadget
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udc-&gt;devstat
op_amp
id|UDC_SUS
)paren
(brace
multiline_comment|/* NOTE:  OTG spec erratum says that OTG devices may&n;&t;&t; * issue wakeups without host enable.&n;&t;&t; */
r_if
c_cond
(paren
id|udc-&gt;devstat
op_amp
(paren
id|UDC_B_HNP_ENABLE
op_or
id|UDC_R_WK_OK
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;remote wakeup...&bslash;n&quot;
)paren
suffix:semicolon
id|UDC_SYSCON2_REG
op_assign
id|UDC_RMT_WKP
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* NOTE:  non-OTG systems may use SRP TOO... */
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|udc-&gt;devstat
op_amp
id|UDC_ATT
)paren
)paren
(brace
r_if
c_cond
(paren
id|udc-&gt;transceiver
)paren
id|retval
op_assign
id|otg_start_srp
c_func
(paren
id|udc-&gt;transceiver
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|omap_set_selfpowered
id|omap_set_selfpowered
c_func
(paren
r_struct
id|usb_gadget
op_star
id|gadget
comma
r_int
id|is_selfpowered
)paren
(brace
r_struct
id|omap_udc
op_star
id|udc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|syscon1
suffix:semicolon
id|udc
op_assign
id|container_of
c_func
(paren
id|gadget
comma
r_struct
id|omap_udc
comma
id|gadget
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|syscon1
op_assign
id|UDC_SYSCON1_REG
suffix:semicolon
r_if
c_cond
(paren
id|is_selfpowered
)paren
id|syscon1
op_or_assign
id|UDC_SELF_PWR
suffix:semicolon
r_else
id|syscon1
op_and_assign
op_complement
id|UDC_SELF_PWR
suffix:semicolon
id|UDC_SYSCON1_REG
op_assign
id|syscon1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|can_pullup
r_static
r_int
id|can_pullup
c_func
(paren
r_struct
id|omap_udc
op_star
id|udc
)paren
(brace
r_return
id|udc-&gt;driver
op_logical_and
id|udc-&gt;softconnect
op_logical_and
id|udc-&gt;vbus_active
suffix:semicolon
)brace
DECL|function|pullup_enable
r_static
r_void
id|pullup_enable
c_func
(paren
r_struct
id|omap_udc
op_star
id|udc
)paren
(brace
id|UDC_SYSCON1_REG
op_or_assign
id|UDC_PULLUP_EN
suffix:semicolon
macro_line|#ifndef CONFIG_USB_OTG
r_if
c_cond
(paren
op_logical_neg
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
id|OTG_CTRL_REG
op_or_assign
id|OTG_BSESSVLD
suffix:semicolon
macro_line|#endif
id|UDC_IRQ_EN_REG
op_assign
id|UDC_DS_CHG_IE
suffix:semicolon
)brace
DECL|function|pullup_disable
r_static
r_void
id|pullup_disable
c_func
(paren
r_struct
id|omap_udc
op_star
id|udc
)paren
(brace
macro_line|#ifndef CONFIG_USB_OTG
r_if
c_cond
(paren
op_logical_neg
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
id|OTG_CTRL_REG
op_and_assign
op_complement
id|OTG_BSESSVLD
suffix:semicolon
macro_line|#endif
id|UDC_IRQ_EN_REG
op_assign
id|UDC_DS_CHG_IE
suffix:semicolon
id|UDC_SYSCON1_REG
op_and_assign
op_complement
id|UDC_PULLUP_EN
suffix:semicolon
)brace
multiline_comment|/*&n; * Called by whatever detects VBUS sessions:  external transceiver&n; * driver, or maybe GPIO0 VBUS IRQ.  May request 48 MHz clock.&n; */
DECL|function|omap_vbus_session
r_static
r_int
id|omap_vbus_session
c_func
(paren
r_struct
id|usb_gadget
op_star
id|gadget
comma
r_int
id|is_active
)paren
(brace
r_struct
id|omap_udc
op_star
id|udc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|udc
op_assign
id|container_of
c_func
(paren
id|gadget
comma
r_struct
id|omap_udc
comma
id|gadget
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|VDBG
c_func
(paren
l_string|&quot;VBUS %s&bslash;n&quot;
comma
id|is_active
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|udc-&gt;vbus_active
op_assign
(paren
id|is_active
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* &quot;software&quot; detect, ignored if !VBUS_MODE_1510 */
r_if
c_cond
(paren
id|is_active
)paren
id|FUNC_MUX_CTRL_0_REG
op_or_assign
id|VBUS_CTRL_1510
suffix:semicolon
r_else
id|FUNC_MUX_CTRL_0_REG
op_and_assign
op_complement
id|VBUS_CTRL_1510
suffix:semicolon
)brace
r_if
c_cond
(paren
id|can_pullup
c_func
(paren
id|udc
)paren
)paren
id|pullup_enable
c_func
(paren
id|udc
)paren
suffix:semicolon
r_else
id|pullup_disable
c_func
(paren
id|udc
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|omap_vbus_draw
r_static
r_int
id|omap_vbus_draw
c_func
(paren
r_struct
id|usb_gadget
op_star
id|gadget
comma
r_int
id|mA
)paren
(brace
r_struct
id|omap_udc
op_star
id|udc
suffix:semicolon
id|udc
op_assign
id|container_of
c_func
(paren
id|gadget
comma
r_struct
id|omap_udc
comma
id|gadget
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udc-&gt;transceiver
)paren
r_return
id|otg_set_power
c_func
(paren
id|udc-&gt;transceiver
comma
id|mA
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|omap_pullup
r_static
r_int
id|omap_pullup
c_func
(paren
r_struct
id|usb_gadget
op_star
id|gadget
comma
r_int
id|is_on
)paren
(brace
r_struct
id|omap_udc
op_star
id|udc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|udc
op_assign
id|container_of
c_func
(paren
id|gadget
comma
r_struct
id|omap_udc
comma
id|gadget
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|udc-&gt;softconnect
op_assign
(paren
id|is_on
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|can_pullup
c_func
(paren
id|udc
)paren
)paren
id|pullup_enable
c_func
(paren
id|udc
)paren
suffix:semicolon
r_else
id|pullup_disable
c_func
(paren
id|udc
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|omap_gadget_ops
r_static
r_struct
id|usb_gadget_ops
id|omap_gadget_ops
op_assign
(brace
dot
id|get_frame
op_assign
id|omap_get_frame
comma
dot
id|wakeup
op_assign
id|omap_wakeup
comma
dot
id|set_selfpowered
op_assign
id|omap_set_selfpowered
comma
dot
id|vbus_session
op_assign
id|omap_vbus_session
comma
dot
id|vbus_draw
op_assign
id|omap_vbus_draw
comma
dot
id|pullup
op_assign
id|omap_pullup
comma
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* dequeue ALL requests; caller holds udc-&gt;lock */
DECL|function|nuke
r_static
r_void
id|nuke
c_func
(paren
r_struct
id|omap_ep
op_star
id|ep
comma
r_int
id|status
)paren
(brace
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;dma_channel
)paren
id|dma_channel_release
c_func
(paren
id|ep
)paren
suffix:semicolon
id|use_ep
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_EP
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;bEndpointAddress
op_logical_and
id|ep-&gt;bmAttributes
op_ne
id|USB_ENDPOINT_XFER_ISOC
)paren
id|UDC_CTRL_REG
op_assign
id|UDC_SET_HALT
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
id|done
c_func
(paren
id|ep
comma
id|req
comma
id|status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* caller holds udc-&gt;lock */
DECL|function|udc_quiesce
r_static
r_void
id|udc_quiesce
c_func
(paren
r_struct
id|omap_udc
op_star
id|udc
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
id|udc-&gt;gadget.speed
op_assign
id|USB_SPEED_UNKNOWN
suffix:semicolon
id|nuke
c_func
(paren
op_amp
id|udc-&gt;ep
(braket
l_int|0
)braket
comma
op_minus
id|ESHUTDOWN
)paren
suffix:semicolon
id|list_for_each_entry
(paren
id|ep
comma
op_amp
id|udc-&gt;gadget.ep_list
comma
id|ep.ep_list
)paren
id|nuke
c_func
(paren
id|ep
comma
op_minus
id|ESHUTDOWN
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|update_otg
r_static
r_void
id|update_otg
c_func
(paren
r_struct
id|omap_udc
op_star
id|udc
)paren
(brace
id|u16
id|devstat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;gadget.is_otg
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|OTG_CTRL_REG
op_amp
id|OTG_ID
)paren
id|devstat
op_assign
id|UDC_DEVSTAT_REG
suffix:semicolon
r_else
id|devstat
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;gadget.b_hnp_enable
op_assign
op_logical_neg
op_logical_neg
(paren
id|devstat
op_amp
id|UDC_B_HNP_ENABLE
)paren
suffix:semicolon
id|udc-&gt;gadget.a_hnp_support
op_assign
op_logical_neg
op_logical_neg
(paren
id|devstat
op_amp
id|UDC_A_HNP_SUPPORT
)paren
suffix:semicolon
id|udc-&gt;gadget.a_alt_hnp_support
op_assign
op_logical_neg
op_logical_neg
(paren
id|devstat
op_amp
id|UDC_A_ALT_HNP_SUPPORT
)paren
suffix:semicolon
multiline_comment|/* Enable HNP early, avoiding races on suspend irq path.&n;&t; * ASSUMES OTG state machine B_BUS_REQ input is true.&n;&t; */
r_if
c_cond
(paren
id|udc-&gt;gadget.b_hnp_enable
)paren
id|OTG_CTRL_REG
op_assign
(paren
id|OTG_CTRL_REG
op_or
id|OTG_B_HNPEN
op_or
id|OTG_B_BUSREQ
)paren
op_amp
op_complement
id|OTG_PULLUP
suffix:semicolon
)brace
DECL|function|ep0_irq
r_static
r_void
id|ep0_irq
c_func
(paren
r_struct
id|omap_udc
op_star
id|udc
comma
id|u16
id|irq_src
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep0
op_assign
op_amp
id|udc-&gt;ep
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|omap_req
op_star
id|req
op_assign
l_int|0
suffix:semicolon
id|ep0-&gt;irqs
op_increment
suffix:semicolon
multiline_comment|/* Clear any pending requests and then scrub any rx/tx state&n;&t; * before starting to handle the SETUP request.&n;&t; */
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_SETUP
)paren
(brace
id|u16
id|ack
op_assign
id|irq_src
op_amp
(paren
id|UDC_EP0_TX
op_or
id|UDC_EP0_RX
)paren
suffix:semicolon
id|nuke
c_func
(paren
id|ep0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ack
)paren
(brace
id|UDC_IRQ_SRC_REG
op_assign
id|ack
suffix:semicolon
id|irq_src
op_assign
id|UDC_SETUP
suffix:semicolon
)brace
)brace
multiline_comment|/* IN/OUT packets mean we&squot;re in the DATA or STATUS stage.  &n;&t; * This driver uses only uses protocol stalls (ep0 never halts),&n;&t; * and if we got this far the gadget driver already had a&n;&t; * chance to stall.  Tries to be forgiving of host oddities.&n;&t; *&n;&t; * NOTE:  the last chance gadget drivers have to stall control&n;&t; * requests is during their request completion callback.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep0-&gt;queue
)paren
)paren
id|req
op_assign
id|container_of
c_func
(paren
id|ep0-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
multiline_comment|/* IN == TX to host */
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_EP0_TX
)paren
(brace
r_int
id|stat
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_EP0_TX
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_SEL
op_or
id|UDC_EP_DIR
suffix:semicolon
id|stat
op_assign
id|UDC_STAT_FLG_REG
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|UDC_ACK
)paren
(brace
r_if
c_cond
(paren
id|udc-&gt;ep0_in
)paren
(brace
multiline_comment|/* write next IN packet from response,&n;&t;&t;&t;&t; * or set up the status stage.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|req
)paren
id|stat
op_assign
id|write_fifo
c_func
(paren
id|ep0
comma
id|req
)paren
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_DIR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
op_logical_and
id|udc-&gt;ep0_pending
)paren
(brace
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_SEL
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_EP
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;ep0_pending
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else:  6 wait states before it&squot;ll tx */
)brace
r_else
(brace
multiline_comment|/* ack status stage of OUT transfer */
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_DIR
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
id|done
c_func
(paren
id|ep0
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
id|req
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stat
op_amp
id|UDC_STALL
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_HALT
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_DIR
suffix:semicolon
)brace
r_else
(brace
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_DIR
suffix:semicolon
)brace
)brace
multiline_comment|/* OUT == RX from host */
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_EP0_RX
)paren
(brace
r_int
id|stat
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_EP0_RX
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_SEL
suffix:semicolon
id|stat
op_assign
id|UDC_STAT_FLG_REG
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|UDC_ACK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;ep0_in
)paren
(brace
id|stat
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* read next OUT packet of request, maybe&n;&t;&t;&t;&t; * reactiviting the fifo; stall on errors.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|req
op_logical_or
(paren
id|stat
op_assign
id|read_fifo
c_func
(paren
id|ep0
comma
id|req
)paren
)paren
OL
l_int|0
)paren
(brace
id|UDC_SYSCON2_REG
op_assign
id|UDC_STALL_CMD
suffix:semicolon
id|udc-&gt;ep0_pending
op_assign
l_int|0
suffix:semicolon
id|stat
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stat
op_eq
l_int|0
)paren
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* activate status stage */
r_if
c_cond
(paren
id|stat
op_eq
l_int|1
)paren
(brace
id|done
c_func
(paren
id|ep0
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* that may have STALLed ep0... */
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_SEL
op_or
id|UDC_EP_DIR
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_EP
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_DIR
suffix:semicolon
id|udc-&gt;ep0_pending
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ack status stage of IN transfer */
id|UDC_EP_NUM_REG
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
id|done
c_func
(paren
id|ep0
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|stat
op_amp
id|UDC_STALL
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_HALT
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|UDC_EP_NUM_REG
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* SETUP starts all control transfers */
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_SETUP
)paren
(brace
r_union
id|u
(brace
id|u16
id|word
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|usb_ctrlrequest
id|r
suffix:semicolon
)brace
id|u
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
multiline_comment|/* read the (latest) SETUP message */
r_do
(brace
id|UDC_EP_NUM_REG
op_assign
id|UDC_SETUP_SEL
suffix:semicolon
multiline_comment|/* two bytes at a time */
id|u.word
(braket
l_int|0
)braket
op_assign
id|UDC_DATA_REG
suffix:semicolon
id|u.word
(braket
l_int|1
)braket
op_assign
id|UDC_DATA_REG
suffix:semicolon
id|u.word
(braket
l_int|2
)braket
op_assign
id|UDC_DATA_REG
suffix:semicolon
id|u.word
(braket
l_int|3
)braket
op_assign
id|UDC_DATA_REG
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|UDC_IRQ_SRC_REG
op_amp
id|UDC_SETUP
)paren
suffix:semicolon
id|le16_to_cpus
(paren
op_amp
id|u.r.wValue
)paren
suffix:semicolon
id|le16_to_cpus
(paren
op_amp
id|u.r.wIndex
)paren
suffix:semicolon
id|le16_to_cpus
(paren
op_amp
id|u.r.wLength
)paren
suffix:semicolon
multiline_comment|/* Delegate almost all control requests to the gadget driver,&n;&t;&t; * except for a handful of ch9 status/feature requests that&n;&t;&t; * hardware doesn&squot;t autodecode _and_ the gadget API hides.&n;&t;&t; */
id|udc-&gt;ep0_in
op_assign
(paren
id|u.r.bRequestType
op_amp
id|USB_DIR_IN
)paren
op_ne
l_int|0
suffix:semicolon
id|udc-&gt;ep0_set_config
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;ep0_pending
op_assign
l_int|1
suffix:semicolon
id|ep0-&gt;stopped
op_assign
l_int|0
suffix:semicolon
id|ep0-&gt;ackwait
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|u.r.bRequest
)paren
(brace
r_case
id|USB_REQ_SET_CONFIGURATION
suffix:colon
multiline_comment|/* udc needs to know when ep != 0 is valid */
r_if
c_cond
(paren
id|u.r.bRequestType
op_ne
id|USB_RECIP_DEVICE
)paren
r_goto
id|delegate
suffix:semicolon
r_if
c_cond
(paren
id|u.r.wLength
op_ne
l_int|0
)paren
r_goto
id|do_stall
suffix:semicolon
id|udc-&gt;ep0_set_config
op_assign
l_int|1
suffix:semicolon
id|udc-&gt;ep0_reset_config
op_assign
(paren
id|u.r.wValue
op_eq
l_int|0
)paren
suffix:semicolon
id|VDBG
c_func
(paren
l_string|&quot;set config %d&bslash;n&quot;
comma
id|u.r.wValue
)paren
suffix:semicolon
multiline_comment|/* update udc NOW since gadget driver may start&n;&t;&t;&t; * queueing requests immediately; clear config&n;&t;&t;&t; * later if it fails the request.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|udc-&gt;ep0_reset_config
)paren
id|UDC_SYSCON2_REG
op_assign
id|UDC_CLR_CFG
suffix:semicolon
r_else
id|UDC_SYSCON2_REG
op_assign
id|UDC_DEV_CFG
suffix:semicolon
id|update_otg
c_func
(paren
id|udc
)paren
suffix:semicolon
r_goto
id|delegate
suffix:semicolon
r_case
id|USB_REQ_CLEAR_FEATURE
suffix:colon
multiline_comment|/* clear endpoint halt */
r_if
c_cond
(paren
id|u.r.bRequestType
op_ne
id|USB_RECIP_ENDPOINT
)paren
r_goto
id|delegate
suffix:semicolon
r_if
c_cond
(paren
id|u.r.wValue
op_ne
id|USB_ENDPOINT_HALT
op_logical_or
id|u.r.wLength
op_ne
l_int|0
)paren
r_goto
id|do_stall
suffix:semicolon
id|ep
op_assign
op_amp
id|udc-&gt;ep
(braket
id|u.r.wIndex
op_amp
l_int|0xf
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_ne
id|ep0
)paren
(brace
r_if
c_cond
(paren
id|u.r.wIndex
op_amp
id|USB_DIR_IN
)paren
id|ep
op_add_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_ISOC
op_logical_or
op_logical_neg
id|ep-&gt;desc
)paren
r_goto
id|do_stall
suffix:semicolon
id|use_ep
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_RESET_EP
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|1
op_plus
id|ep-&gt;double_buf
suffix:semicolon
)brace
)brace
id|VDBG
c_func
(paren
l_string|&quot;%s halt cleared by host&bslash;n&quot;
comma
id|ep-&gt;name
)paren
suffix:semicolon
r_goto
id|ep0out_status_stage
suffix:semicolon
r_case
id|USB_REQ_SET_FEATURE
suffix:colon
multiline_comment|/* set endpoint halt */
r_if
c_cond
(paren
id|u.r.bRequestType
op_ne
id|USB_RECIP_ENDPOINT
)paren
r_goto
id|delegate
suffix:semicolon
r_if
c_cond
(paren
id|u.r.wValue
op_ne
id|USB_ENDPOINT_HALT
op_logical_or
id|u.r.wLength
op_ne
l_int|0
)paren
r_goto
id|do_stall
suffix:semicolon
id|ep
op_assign
op_amp
id|udc-&gt;ep
(braket
id|u.r.wIndex
op_amp
l_int|0xf
)braket
suffix:semicolon
r_if
c_cond
(paren
id|u.r.wIndex
op_amp
id|USB_DIR_IN
)paren
id|ep
op_add_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_ISOC
op_logical_or
id|ep
op_eq
id|ep0
op_logical_or
op_logical_neg
id|ep-&gt;desc
)paren
r_goto
id|do_stall
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;has_dma
)paren
(brace
multiline_comment|/* this has rude side-effects (aborts) and&n;&t;&t;&t;&t; * can&squot;t really work if DMA-IN is active&n;&t;&t;&t;&t; */
id|DBG
c_func
(paren
l_string|&quot;%s host set_halt, NYET &bslash;n&quot;
comma
id|ep-&gt;name
)paren
suffix:semicolon
r_goto
id|do_stall
suffix:semicolon
)brace
id|use_ep
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* can&squot;t halt if fifo isn&squot;t empty... */
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_EP
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_HALT
suffix:semicolon
id|VDBG
c_func
(paren
l_string|&quot;%s halted by host&bslash;n&quot;
comma
id|ep-&gt;name
)paren
suffix:semicolon
id|ep0out_status_stage
suffix:colon
id|status
op_assign
l_int|0
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_SEL
op_or
id|UDC_EP_DIR
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_CLR_EP
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_DIR
suffix:semicolon
id|udc-&gt;ep0_pending
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_REQ_GET_STATUS
suffix:colon
multiline_comment|/* return interface status.  if we were pedantic,&n;&t;&t;&t; * we&squot;d detect non-existent interfaces, and stall.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|u.r.bRequestType
op_ne
(paren
id|USB_DIR_IN
op_or
id|USB_RECIP_INTERFACE
)paren
)paren
r_goto
id|delegate
suffix:semicolon
multiline_comment|/* return two zero bytes */
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_SEL
op_or
id|UDC_EP_DIR
suffix:semicolon
id|UDC_DATA_REG
op_assign
l_int|0
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|UDC_EP_DIR
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
id|VDBG
c_func
(paren
l_string|&quot;GET_STATUS, interface %d&bslash;n&quot;
comma
id|u.r.wIndex
)paren
suffix:semicolon
multiline_comment|/* next, status stage */
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
id|delegate
suffix:colon
multiline_comment|/* activate the ep0out fifo right away */
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;ep0_in
op_logical_and
id|u.r.wLength
)paren
(brace
id|UDC_EP_NUM_REG
op_assign
l_int|0
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
)brace
multiline_comment|/* gadget drivers see class/vendor specific requests,&n;&t;&t;&t; * {SET,GET}_{INTERFACE,DESCRIPTOR,CONFIGURATION},&n;&t;&t;&t; * and more&n;&t;&t;&t; */
id|VDBG
c_func
(paren
l_string|&quot;SETUP %02x.%02x v%04x i%04x l%04x&bslash;n&quot;
comma
id|u.r.bRequestType
comma
id|u.r.bRequest
comma
id|u.r.wValue
comma
id|u.r.wIndex
comma
id|u.r.wLength
)paren
suffix:semicolon
multiline_comment|/* The gadget driver may return an error here,&n;&t;&t;&t; * causing an immediate protocol stall.&n;&t;&t;&t; *&n;&t;&t;&t; * Else it must issue a response, either queueing a&n;&t;&t;&t; * response buffer for the DATA stage, or halting ep0&n;&t;&t;&t; * (causing a protocol stall, not a real halt).  A&n;&t;&t;&t; * zero length buffer means no DATA stage.&n;&t;&t;&t; *&n;&t;&t;&t; * It&squot;s fine to issue that response after the setup()&n;&t;&t;&t; * call returns, and this IRQ was handled.&n;&t;&t;&t; */
id|udc-&gt;ep0_setup
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
id|status
op_assign
id|udc-&gt;driver-&gt;setup
(paren
op_amp
id|udc-&gt;gadget
comma
op_amp
id|u.r
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
id|udc-&gt;ep0_setup
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
id|do_stall
suffix:colon
id|VDBG
c_func
(paren
l_string|&quot;req %02x.%02x protocol STALL; stat %d&bslash;n&quot;
comma
id|u.r.bRequestType
comma
id|u.r.bRequest
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udc-&gt;ep0_set_config
)paren
(brace
r_if
c_cond
(paren
id|udc-&gt;ep0_reset_config
)paren
id|WARN
c_func
(paren
l_string|&quot;error resetting config?&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|UDC_SYSCON2_REG
op_assign
id|UDC_CLR_CFG
suffix:semicolon
)brace
id|UDC_SYSCON2_REG
op_assign
id|UDC_STALL_CMD
suffix:semicolon
id|udc-&gt;ep0_pending
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|OTG_FLAGS
mdefine_line|#define OTG_FLAGS (UDC_B_HNP_ENABLE|UDC_A_HNP_SUPPORT|UDC_A_ALT_HNP_SUPPORT)
DECL|function|devstate_irq
r_static
r_void
id|devstate_irq
c_func
(paren
r_struct
id|omap_udc
op_star
id|udc
comma
id|u16
id|irq_src
)paren
(brace
id|u16
id|devstat
comma
id|change
suffix:semicolon
id|devstat
op_assign
id|UDC_DEVSTAT_REG
suffix:semicolon
id|change
op_assign
id|devstat
op_xor
id|udc-&gt;devstat
suffix:semicolon
id|udc-&gt;devstat
op_assign
id|devstat
suffix:semicolon
r_if
c_cond
(paren
id|change
op_amp
(paren
id|UDC_USB_RESET
op_or
id|UDC_ATT
)paren
)paren
(brace
id|udc_quiesce
c_func
(paren
id|udc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|change
op_amp
id|UDC_ATT
)paren
(brace
multiline_comment|/* driver for any external transceiver will&n;&t;&t;&t; * have called omap_vbus_session() already&n;&t;&t;&t; */
r_if
c_cond
(paren
id|devstat
op_amp
id|UDC_ATT
)paren
(brace
id|udc-&gt;gadget.speed
op_assign
id|USB_SPEED_FULL
suffix:semicolon
id|VDBG
c_func
(paren
l_string|&quot;connect&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;transceiver
)paren
id|pullup_enable
c_func
(paren
id|udc
)paren
suffix:semicolon
singleline_comment|// if (driver-&gt;connect) call it
)brace
r_else
r_if
c_cond
(paren
id|udc-&gt;gadget.speed
op_ne
id|USB_SPEED_UNKNOWN
)paren
(brace
id|udc-&gt;gadget.speed
op_assign
id|USB_SPEED_UNKNOWN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc-&gt;transceiver
)paren
id|pullup_disable
c_func
(paren
id|udc
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;disconnect, gadget %s&bslash;n&quot;
comma
id|udc-&gt;driver-&gt;driver.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udc-&gt;driver-&gt;disconnect
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
id|udc-&gt;driver
op_member_access_from_pointer
id|disconnect
c_func
(paren
op_amp
id|udc-&gt;gadget
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
)brace
)brace
id|change
op_and_assign
op_complement
id|UDC_ATT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|change
op_amp
id|UDC_USB_RESET
)paren
(brace
r_if
c_cond
(paren
id|devstat
op_amp
id|UDC_USB_RESET
)paren
(brace
id|VDBG
c_func
(paren
l_string|&quot;RESET=1&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|udc-&gt;gadget.speed
op_assign
id|USB_SPEED_FULL
suffix:semicolon
id|INFO
c_func
(paren
l_string|&quot;USB reset done, gadget %s&bslash;n&quot;
comma
id|udc-&gt;driver-&gt;driver.name
)paren
suffix:semicolon
multiline_comment|/* ep0 traffic is legal from now on */
id|UDC_IRQ_EN_REG
op_assign
id|UDC_DS_CHG_IE
op_or
id|UDC_EP0_IE
suffix:semicolon
)brace
id|change
op_and_assign
op_complement
id|UDC_USB_RESET
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|change
op_amp
id|UDC_SUS
)paren
(brace
r_if
c_cond
(paren
id|udc-&gt;gadget.speed
op_ne
id|USB_SPEED_UNKNOWN
)paren
(brace
singleline_comment|// FIXME tell isp1301 to suspend/resume (?)
r_if
c_cond
(paren
id|devstat
op_amp
id|UDC_SUS
)paren
(brace
id|VDBG
c_func
(paren
l_string|&quot;suspend&bslash;n&quot;
)paren
suffix:semicolon
id|update_otg
c_func
(paren
id|udc
)paren
suffix:semicolon
multiline_comment|/* HNP could be under way already */
r_if
c_cond
(paren
id|udc-&gt;gadget.speed
op_eq
id|USB_SPEED_FULL
op_logical_and
id|udc-&gt;driver-&gt;suspend
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
id|udc-&gt;driver
op_member_access_from_pointer
id|suspend
c_func
(paren
op_amp
id|udc-&gt;gadget
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|VDBG
c_func
(paren
l_string|&quot;resume&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udc-&gt;gadget.speed
op_eq
id|USB_SPEED_FULL
op_logical_and
id|udc-&gt;driver-&gt;resume
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
id|udc-&gt;driver
op_member_access_from_pointer
id|resume
c_func
(paren
op_amp
id|udc-&gt;gadget
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
)brace
)brace
)brace
id|change
op_and_assign
op_complement
id|UDC_SUS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_is_omap15xx
c_func
(paren
)paren
op_logical_and
(paren
id|change
op_amp
id|OTG_FLAGS
)paren
)paren
(brace
id|update_otg
c_func
(paren
id|udc
)paren
suffix:semicolon
id|change
op_and_assign
op_complement
id|OTG_FLAGS
suffix:semicolon
)brace
id|change
op_and_assign
op_complement
(paren
id|UDC_CFG
op_or
id|UDC_DEF
op_or
id|UDC_ADD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
id|VDBG
c_func
(paren
l_string|&quot;devstat %03x, ignore change %03x&bslash;n&quot;
comma
id|devstat
comma
id|change
)paren
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_DS_CHG
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|omap_udc_irq
id|omap_udc_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|_udc
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
r_struct
id|omap_udc
op_star
id|udc
op_assign
id|_udc
suffix:semicolon
id|u16
id|irq_src
suffix:semicolon
id|irqreturn_t
id|status
op_assign
id|IRQ_NONE
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|irq_src
op_assign
id|UDC_IRQ_SRC_REG
suffix:semicolon
multiline_comment|/* Device state change (usb ch9 stuff) */
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_DS_CHG
)paren
(brace
id|devstate_irq
c_func
(paren
id|_udc
comma
id|irq_src
)paren
suffix:semicolon
id|status
op_assign
id|IRQ_HANDLED
suffix:semicolon
id|irq_src
op_and_assign
op_complement
id|UDC_DS_CHG
suffix:semicolon
)brace
multiline_comment|/* EP0 control transfers */
r_if
c_cond
(paren
id|irq_src
op_amp
(paren
id|UDC_EP0_RX
op_or
id|UDC_SETUP
op_or
id|UDC_EP0_TX
)paren
)paren
(brace
id|ep0_irq
c_func
(paren
id|_udc
comma
id|irq_src
)paren
suffix:semicolon
id|status
op_assign
id|IRQ_HANDLED
suffix:semicolon
id|irq_src
op_and_assign
op_complement
(paren
id|UDC_EP0_RX
op_or
id|UDC_SETUP
op_or
id|UDC_EP0_TX
)paren
suffix:semicolon
)brace
multiline_comment|/* DMA transfer completion */
r_if
c_cond
(paren
id|use_dma
op_logical_and
(paren
id|irq_src
op_amp
(paren
id|UDC_TXN_DONE
op_or
id|UDC_RXN_CNT
op_or
id|UDC_RXN_EOT
)paren
)paren
)paren
(brace
id|dma_irq
c_func
(paren
id|_udc
comma
id|irq_src
)paren
suffix:semicolon
id|status
op_assign
id|IRQ_HANDLED
suffix:semicolon
id|irq_src
op_and_assign
op_complement
(paren
id|UDC_TXN_DONE
op_or
id|UDC_RXN_CNT
op_or
id|UDC_RXN_EOT
)paren
suffix:semicolon
)brace
id|irq_src
op_and_assign
op_complement
(paren
id|UDC_SOF
op_or
id|UDC_EPN_TX
op_or
id|UDC_EPN_RX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_src
)paren
id|DBG
c_func
(paren
l_string|&quot;udc_irq, unhandled %03x&bslash;n&quot;
comma
id|irq_src
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* workaround for seemingly-lost IRQs for RX ACKs... */
DECL|macro|PIO_OUT_TIMEOUT
mdefine_line|#define PIO_OUT_TIMEOUT&t;(jiffies + HZ/3)
DECL|macro|HALF_FULL
mdefine_line|#define HALF_FULL(f)&t;(!((f)&amp;(UDC_NON_ISO_FIFO_FULL|UDC_NON_ISO_FIFO_EMPTY)))
DECL|function|pio_out_timer
r_static
r_void
id|pio_out_timer
c_func
(paren
r_int
r_int
id|_ep
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
op_assign
(paren
r_void
op_star
)paren
id|_ep
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|stat_flg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
op_logical_and
id|ep-&gt;ackwait
)paren
(brace
id|use_ep
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
id|stat_flg
op_assign
id|UDC_STAT_FLG_REG
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat_flg
op_amp
id|UDC_ACK
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|stat_flg
op_amp
id|UDC_FIFO_EN
)paren
op_logical_or
(paren
id|ep-&gt;double_buf
op_logical_and
id|HALF_FULL
c_func
(paren
id|stat_flg
)paren
)paren
)paren
)paren
(brace
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
id|VDBG
c_func
(paren
l_string|&quot;%s: lose, %04x&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|stat_flg
)paren
suffix:semicolon
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|ep-&gt;bEndpointAddress
op_or
id|UDC_EP_SEL
suffix:semicolon
(paren
r_void
)paren
id|read_fifo
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|ep-&gt;bEndpointAddress
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|1
op_plus
id|ep-&gt;double_buf
suffix:semicolon
)brace
)brace
id|mod_timer
c_func
(paren
op_amp
id|ep-&gt;timer
comma
id|PIO_OUT_TIMEOUT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|omap_udc_pio_irq
id|omap_udc_pio_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|_dev
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
id|u16
id|epn_stat
comma
id|irq_src
suffix:semicolon
id|irqreturn_t
id|status
op_assign
id|IRQ_NONE
suffix:semicolon
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
r_int
id|epnum
suffix:semicolon
r_struct
id|omap_udc
op_star
id|udc
op_assign
id|_dev
suffix:semicolon
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|epn_stat
op_assign
id|UDC_EPN_STAT_REG
suffix:semicolon
id|irq_src
op_assign
id|UDC_IRQ_SRC_REG
suffix:semicolon
multiline_comment|/* handle OUT first, to avoid some wasteful NAKs */
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_EPN_RX
)paren
(brace
id|epnum
op_assign
(paren
id|epn_stat
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_EPN_RX
suffix:semicolon
id|status
op_assign
id|IRQ_HANDLED
suffix:semicolon
id|ep
op_assign
op_amp
id|udc-&gt;ep
(braket
id|epnum
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|epnum
op_or
id|UDC_EP_SEL
suffix:semicolon
id|ep-&gt;fnf
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|UDC_STAT_FLG_REG
op_amp
id|UDC_ACK
)paren
)paren
(brace
id|ep-&gt;ackwait
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
r_int
id|stat
suffix:semicolon
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
id|stat
op_assign
id|read_fifo
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;double_buf
)paren
id|ep-&gt;fnf
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* min 6 clock delay before clearing EP_SEL ... */
id|epn_stat
op_assign
id|UDC_EPN_STAT_REG
suffix:semicolon
id|epn_stat
op_assign
id|UDC_EPN_STAT_REG
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|epnum
suffix:semicolon
multiline_comment|/* enabling fifo _after_ clearing ACK, contrary to docs,&n;&t;&t; * reduces lossage; timer still needed though (sigh).&n;&t;&t; */
r_if
c_cond
(paren
id|ep-&gt;fnf
)paren
(brace
id|UDC_CTRL_REG
op_assign
id|UDC_SET_FIFO_EN
suffix:semicolon
id|ep-&gt;ackwait
op_assign
l_int|1
op_plus
id|ep-&gt;double_buf
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|ep-&gt;timer
comma
id|PIO_OUT_TIMEOUT
)paren
suffix:semicolon
)brace
multiline_comment|/* then IN transfers */
r_else
r_if
c_cond
(paren
id|irq_src
op_amp
id|UDC_EPN_TX
)paren
(brace
id|epnum
op_assign
id|epn_stat
op_amp
l_int|0x0f
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_EPN_TX
suffix:semicolon
id|status
op_assign
id|IRQ_HANDLED
suffix:semicolon
id|ep
op_assign
op_amp
id|udc-&gt;ep
(braket
l_int|16
op_plus
id|epnum
)braket
suffix:semicolon
id|ep-&gt;irqs
op_increment
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|epnum
op_or
id|UDC_EP_DIR
op_or
id|UDC_EP_SEL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|UDC_STAT_FLG_REG
op_amp
id|UDC_ACK
)paren
)paren
(brace
id|ep-&gt;ackwait
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|container_of
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
(paren
r_void
)paren
id|write_fifo
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* min 6 clock delay before clearing EP_SEL ... */
id|epn_stat
op_assign
id|UDC_EPN_STAT_REG
suffix:semicolon
id|epn_stat
op_assign
id|UDC_EPN_STAT_REG
suffix:semicolon
id|UDC_EP_NUM_REG
op_assign
id|epnum
op_or
id|UDC_EP_DIR
suffix:semicolon
multiline_comment|/* then 6 clocks before it&squot;d tx */
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#ifdef&t;USE_ISO
r_static
id|irqreturn_t
DECL|function|omap_udc_iso_irq
id|omap_udc_iso_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|_dev
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
r_struct
id|omap_udc
op_star
id|udc
op_assign
id|_dev
suffix:semicolon
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
r_int
id|pending
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* handle all non-DMA ISO transfers */
id|list_for_each_entry
(paren
id|ep
comma
op_amp
id|udc-&gt;iso
comma
id|iso
)paren
(brace
id|u16
id|stat
suffix:semicolon
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;has_dma
op_logical_or
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
r_continue
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|omap_req
comma
id|queue
)paren
suffix:semicolon
id|use_ep
c_func
(paren
id|ep
comma
id|UDC_EP_SEL
)paren
suffix:semicolon
id|stat
op_assign
id|UDC_STAT_FLG_REG
suffix:semicolon
multiline_comment|/* NOTE: like the other controller drivers, this isn&squot;t&n;&t;&t; * currently reporting lost or damaged frames.&n;&t;&t; */
r_if
c_cond
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
(brace
r_if
c_cond
(paren
id|stat
op_amp
id|UDC_MISS_IN
)paren
multiline_comment|/* done(ep, req, -EPROTO) */
suffix:semicolon
r_else
id|write_fifo
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|UDC_NO_RXPACKET
)paren
id|status
op_assign
op_minus
id|EREMOTEIO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stat
op_amp
id|UDC_ISO_ERR
)paren
id|status
op_assign
op_minus
id|EILSEQ
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stat
op_amp
id|UDC_DATA_FLUSH
)paren
id|status
op_assign
op_minus
id|ENOSR
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
multiline_comment|/* done(ep, req, status) */
suffix:semicolon
r_else
id|read_fifo
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
id|deselect_ep
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* 6 wait states before next EP */
id|ep-&gt;irqs
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|pending
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pending
)paren
id|UDC_IRQ_EN_REG
op_and_assign
op_complement
id|UDC_SOF_IE
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_SOF
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|udc
r_static
r_struct
id|omap_udc
op_star
id|udc
suffix:semicolon
DECL|function|usb_gadget_register_driver
r_int
id|usb_gadget_register_driver
(paren
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
(brace
r_int
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* basic sanity tests */
r_if
c_cond
(paren
op_logical_neg
id|udc
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
singleline_comment|// FIXME if otg, check:  driver-&gt;is_otg
op_logical_or
id|driver-&gt;speed
OL
id|USB_SPEED_FULL
op_logical_or
op_logical_neg
id|driver-&gt;bind
op_logical_or
op_logical_neg
id|driver-&gt;unbind
op_logical_or
op_logical_neg
id|driver-&gt;setup
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udc-&gt;driver
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* reset state */
id|list_for_each_entry
(paren
id|ep
comma
op_amp
id|udc-&gt;gadget.ep_list
comma
id|ep.ep_list
)paren
(brace
id|ep-&gt;irqs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_ISOC
)paren
r_continue
suffix:semicolon
id|use_ep
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
id|UDC_CTRL_REG
op_assign
id|UDC_SET_HALT
suffix:semicolon
)brace
id|udc-&gt;ep0_pending
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;ep
(braket
l_int|0
)braket
dot
id|irqs
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;softconnect
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* hook up the driver */
id|driver-&gt;driver.bus
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;driver
op_assign
id|driver
suffix:semicolon
id|udc-&gt;gadget.dev.driver
op_assign
op_amp
id|driver-&gt;driver
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|driver-&gt;bind
(paren
op_amp
id|udc-&gt;gadget
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;bind to %s --&gt; %d&bslash;n&quot;
comma
id|driver-&gt;driver.name
comma
id|status
)paren
suffix:semicolon
id|udc-&gt;gadget.dev.driver
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;driver
op_assign
l_int|0
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;bound to driver %s&bslash;n&quot;
comma
id|driver-&gt;driver.name
)paren
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_IRQ_SRC_MASK
suffix:semicolon
multiline_comment|/* connect to bus through transceiver */
r_if
c_cond
(paren
id|udc-&gt;transceiver
)paren
(brace
id|status
op_assign
id|otg_set_peripheral
c_func
(paren
id|udc-&gt;transceiver
comma
op_amp
id|udc-&gt;gadget
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;can&squot;t bind to transceiver&bslash;n&quot;
)paren
suffix:semicolon
id|driver-&gt;unbind
(paren
op_amp
id|udc-&gt;gadget
)paren
suffix:semicolon
id|udc-&gt;gadget.dev.driver
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;driver
op_assign
l_int|0
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|can_pullup
c_func
(paren
id|udc
)paren
)paren
id|pullup_enable
(paren
id|udc
)paren
suffix:semicolon
r_else
id|pullup_disable
(paren
id|udc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|machine_is_omap_innovator
c_func
(paren
)paren
)paren
id|omap_vbus_session
c_func
(paren
op_amp
id|udc-&gt;gadget
comma
l_int|1
)paren
suffix:semicolon
id|done
suffix:colon
r_return
id|status
suffix:semicolon
)brace
DECL|variable|usb_gadget_register_driver
id|EXPORT_SYMBOL
c_func
(paren
id|usb_gadget_register_driver
)paren
suffix:semicolon
DECL|function|usb_gadget_unregister_driver
r_int
id|usb_gadget_unregister_driver
(paren
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
op_logical_or
id|driver
op_ne
id|udc-&gt;driver
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_omap_innovator
c_func
(paren
)paren
)paren
id|omap_vbus_session
c_func
(paren
op_amp
id|udc-&gt;gadget
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udc-&gt;transceiver
)paren
(paren
r_void
)paren
id|otg_set_peripheral
c_func
(paren
id|udc-&gt;transceiver
comma
l_int|0
)paren
suffix:semicolon
r_else
id|pullup_disable
c_func
(paren
id|udc
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|udc_quiesce
c_func
(paren
id|udc
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|driver
op_member_access_from_pointer
id|unbind
c_func
(paren
op_amp
id|udc-&gt;gadget
)paren
suffix:semicolon
id|udc-&gt;gadget.dev.driver
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;driver
op_assign
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;unregistered driver &squot;%s&squot;&bslash;n&quot;
comma
id|driver-&gt;driver.name
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|variable|usb_gadget_unregister_driver
id|EXPORT_SYMBOL
c_func
(paren
id|usb_gadget_unregister_driver
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef CONFIG_USB_GADGET_DEBUG_FILES
macro_line|#include &lt;linux/seq_file.h&gt;
DECL|variable|proc_filename
r_static
r_const
r_char
id|proc_filename
(braket
)braket
op_assign
l_string|&quot;driver/udc&quot;
suffix:semicolon
DECL|macro|FOURBITS
mdefine_line|#define FOURBITS &quot;%s%s%s%s&quot;
DECL|macro|EIGHTBITS
mdefine_line|#define EIGHTBITS FOURBITS FOURBITS
DECL|function|proc_ep_show
r_static
r_void
id|proc_ep_show
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_struct
id|omap_ep
op_star
id|ep
)paren
(brace
id|u16
id|stat_flg
suffix:semicolon
r_struct
id|omap_req
op_star
id|req
suffix:semicolon
r_char
id|buf
(braket
l_int|20
)braket
suffix:semicolon
id|use_ep
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|ep-&gt;has_dma
)paren
id|snprintf
c_func
(paren
id|buf
comma
r_sizeof
id|buf
comma
l_string|&quot;(%cxdma%d lch%d) &quot;
comma
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
l_char|&squot;t&squot;
suffix:colon
l_char|&squot;r&squot;
comma
id|ep-&gt;dma_channel
op_minus
l_int|1
comma
id|ep-&gt;lch
)paren
suffix:semicolon
r_else
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|stat_flg
op_assign
id|UDC_STAT_FLG_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;&bslash;n%s %s%s%sirqs %ld stat %04x &quot;
id|EIGHTBITS
id|FOURBITS
l_string|&quot;%s&bslash;n&quot;
comma
id|ep-&gt;name
comma
id|buf
comma
id|ep-&gt;double_buf
ques
c_cond
l_string|&quot;dbuf &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
(brace
r_char
op_star
id|s
suffix:semicolon
r_switch
(paren
id|ep-&gt;ackwait
)paren
(brace
r_case
l_int|0
suffix:colon
id|s
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|s
op_assign
l_string|&quot;(ackw) &quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|s
op_assign
l_string|&quot;(ackw2) &quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|s
op_assign
l_string|&quot;(?) &quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|s
suffix:semicolon
)brace
)paren
comma
id|ep-&gt;irqs
comma
id|stat_flg
comma
(paren
id|stat_flg
op_amp
id|UDC_NO_RXPACKET
)paren
ques
c_cond
l_string|&quot;no_rxpacket &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_MISS_IN
)paren
ques
c_cond
l_string|&quot;miss_in &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_DATA_FLUSH
)paren
ques
c_cond
l_string|&quot;data_flush &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_ISO_ERR
)paren
ques
c_cond
l_string|&quot;iso_err &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_ISO_FIFO_EMPTY
)paren
ques
c_cond
l_string|&quot;iso_fifo_empty &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_ISO_FIFO_FULL
)paren
ques
c_cond
l_string|&quot;iso_fifo_full &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_EP_HALTED
)paren
ques
c_cond
l_string|&quot;HALT &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_STALL
)paren
ques
c_cond
l_string|&quot;STALL &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_NAK
)paren
ques
c_cond
l_string|&quot;NAK &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_ACK
)paren
ques
c_cond
l_string|&quot;ACK &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_FIFO_EN
)paren
ques
c_cond
l_string|&quot;fifo_en &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_NON_ISO_FIFO_EMPTY
)paren
ques
c_cond
l_string|&quot;fifo_empty &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_flg
op_amp
id|UDC_NON_ISO_FIFO_FULL
)paren
ques
c_cond
l_string|&quot;fifo_full &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;&bslash;t(queue empty)&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|list_for_each_entry
(paren
id|req
comma
op_amp
id|ep-&gt;queue
comma
id|queue
)paren
(brace
r_int
id|length
op_assign
id|req-&gt;req.actual
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|buf
(braket
l_int|0
)braket
)paren
(brace
id|length
op_add_assign
(paren
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
id|dma_src_len
suffix:colon
id|dma_dest_len
)paren
(paren
id|ep
comma
id|req-&gt;req.dma
op_plus
id|length
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;&bslash;treq %p len %d/%d buf %p&bslash;n&quot;
comma
op_amp
id|req-&gt;req
comma
id|length
comma
id|req-&gt;req.length
comma
id|req-&gt;req.buf
)paren
suffix:semicolon
)brace
)brace
DECL|function|trx_mode
r_static
r_char
op_star
id|trx_mode
c_func
(paren
r_int
id|m
)paren
(brace
r_switch
c_cond
(paren
id|m
)paren
(brace
r_case
l_int|3
suffix:colon
r_case
l_int|0
suffix:colon
r_return
l_string|&quot;6wire&quot;
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
l_string|&quot;4wire&quot;
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
l_string|&quot;3wire&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;unknown&quot;
suffix:semicolon
)brace
)brace
DECL|function|proc_otg_show
r_static
r_int
id|proc_otg_show
c_func
(paren
r_struct
id|seq_file
op_star
id|s
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|OTG_REV_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;OTG rev %d.%d, transceiver_ctrl %08x&bslash;n&quot;
comma
id|tmp
op_rshift
l_int|4
comma
id|tmp
op_amp
l_int|0xf
comma
id|USB_TRANSCEIVER_CTRL_REG
)paren
suffix:semicolon
id|tmp
op_assign
id|OTG_SYSCON_1_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;otg_syscon1 %08x usb2 %s, usb1 %s, usb0 %s,&quot;
id|FOURBITS
l_string|&quot;&bslash;n&quot;
comma
id|tmp
comma
id|trx_mode
c_func
(paren
id|USB2_TRX_MODE
c_func
(paren
id|tmp
)paren
)paren
comma
id|trx_mode
c_func
(paren
id|USB1_TRX_MODE
c_func
(paren
id|tmp
)paren
)paren
comma
id|trx_mode
c_func
(paren
id|USB0_TRX_MODE
c_func
(paren
id|tmp
)paren
)paren
comma
(paren
id|tmp
op_amp
id|OTG_IDLE_EN
)paren
ques
c_cond
l_string|&quot; !otg&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|HST_IDLE_EN
)paren
ques
c_cond
l_string|&quot; !host&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|DEV_IDLE_EN
)paren
ques
c_cond
l_string|&quot; !dev&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_RESET_DONE
)paren
ques
c_cond
l_string|&quot; reset_done&quot;
suffix:colon
l_string|&quot; reset_active&quot;
)paren
suffix:semicolon
id|tmp
op_assign
id|OTG_SYSCON_2_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;otg_syscon2 %08x%s&quot;
id|EIGHTBITS
l_string|&quot; b_ase_brst=%d hmc=%d&bslash;n&quot;
comma
id|tmp
comma
(paren
id|tmp
op_amp
id|OTG_EN
)paren
ques
c_cond
l_string|&quot; otg_en&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|USBX_SYNCHRO
)paren
ques
c_cond
l_string|&quot; synchro&quot;
suffix:colon
l_string|&quot;&quot;
comma
singleline_comment|// much more SRP stuff
(paren
id|tmp
op_amp
id|SRP_DATA
)paren
ques
c_cond
l_string|&quot; srp_data&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|SRP_VBUS
)paren
ques
c_cond
l_string|&quot; srp_vbus&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_PADEN
)paren
ques
c_cond
l_string|&quot; otg_paden&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|HMC_PADEN
)paren
ques
c_cond
l_string|&quot; hmc_paden&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UHOST_EN
)paren
ques
c_cond
l_string|&quot; uhost_en&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|HMC_TLLSPEED
)paren
ques
c_cond
l_string|&quot; tllspeed&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|HMC_TLLATTACH
)paren
ques
c_cond
l_string|&quot; tllattach&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|B_ASE_BRST
c_func
(paren
id|tmp
)paren
comma
id|OTG_HMC
c_func
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|OTG_CTRL_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;otg_ctrl    %06x&quot;
id|EIGHTBITS
id|EIGHTBITS
l_string|&quot;%s&bslash;n&quot;
comma
id|tmp
comma
(paren
id|tmp
op_amp
id|OTG_ASESSVLD
)paren
ques
c_cond
l_string|&quot; asess&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_BSESSEND
)paren
ques
c_cond
l_string|&quot; bsess_end&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_BSESSVLD
)paren
ques
c_cond
l_string|&quot; bsess&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_VBUSVLD
)paren
ques
c_cond
l_string|&quot; vbus&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_ID
)paren
ques
c_cond
l_string|&quot; id&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_DRIVER_SEL
)paren
ques
c_cond
l_string|&quot; DEVICE&quot;
suffix:colon
l_string|&quot; HOST&quot;
comma
(paren
id|tmp
op_amp
id|OTG_A_SETB_HNPEN
)paren
ques
c_cond
l_string|&quot; a_setb_hnpen&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_A_BUSREQ
)paren
ques
c_cond
l_string|&quot; a_bus&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_B_HNPEN
)paren
ques
c_cond
l_string|&quot; b_hnpen&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_B_BUSREQ
)paren
ques
c_cond
l_string|&quot; b_bus&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_BUSDROP
)paren
ques
c_cond
l_string|&quot; busdrop&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_PULLDOWN
)paren
ques
c_cond
l_string|&quot; down&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_PULLUP
)paren
ques
c_cond
l_string|&quot; up&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_DRV_VBUS
)paren
ques
c_cond
l_string|&quot; drv&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_PD_VBUS
)paren
ques
c_cond
l_string|&quot; pd_vb&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_PU_VBUS
)paren
ques
c_cond
l_string|&quot; pu_vb&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|OTG_PU_ID
)paren
ques
c_cond
l_string|&quot; pu_id&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|tmp
op_assign
id|OTG_IRQ_EN_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;otg_irq_en  %04x&quot;
l_string|&quot;&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|OTG_IRQ_SRC_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;otg_irq_src %04x&quot;
l_string|&quot;&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|OTG_OUTCTRL_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;otg_outctrl %04x&quot;
l_string|&quot;&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|OTG_TEST_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;otg_test    %04x&quot;
l_string|&quot;&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
)brace
DECL|function|proc_udc_show
r_static
r_int
id|proc_udc_show
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|_
)paren
(brace
id|u32
id|tmp
suffix:semicolon
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;%s, version: &quot;
id|DRIVER_VERSION
macro_line|#ifdef&t;USE_ISO
l_string|&quot; (iso)&quot;
macro_line|#endif
l_string|&quot;%s&bslash;n&quot;
comma
id|driver_desc
comma
id|use_dma
ques
c_cond
l_string|&quot; (dma)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|tmp
op_assign
id|UDC_REV_REG
op_amp
l_int|0xff
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;UDC rev %d.%d, fifo mode %d, gadget %s&bslash;n&quot;
l_string|&quot;hmc %d, transceiver %s&bslash;n&quot;
comma
id|tmp
op_rshift
l_int|4
comma
id|tmp
op_amp
l_int|0xf
comma
id|fifo_mode
comma
id|udc-&gt;driver
ques
c_cond
id|udc-&gt;driver-&gt;driver.name
suffix:colon
l_string|&quot;(none)&quot;
comma
id|HMC
comma
id|udc-&gt;transceiver
ques
c_cond
id|udc-&gt;transceiver-&gt;label
suffix:colon
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;ULPD control %04x req %04x status %04x&bslash;n&quot;
comma
id|__REG16
c_func
(paren
id|ULPD_CLOCK_CTRL
)paren
comma
id|__REG16
c_func
(paren
id|ULPD_SOFT_REQ
)paren
comma
id|__REG16
c_func
(paren
id|ULPD_STATUS_REQ
)paren
)paren
suffix:semicolon
multiline_comment|/* OTG controller registers */
r_if
c_cond
(paren
op_logical_neg
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
id|proc_otg_show
c_func
(paren
id|s
)paren
suffix:semicolon
id|tmp
op_assign
id|UDC_SYSCON1_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;&bslash;nsyscon1     %04x&quot;
id|EIGHTBITS
l_string|&quot;&bslash;n&quot;
comma
id|tmp
comma
(paren
id|tmp
op_amp
id|UDC_CFG_LOCK
)paren
ques
c_cond
l_string|&quot; cfg_lock&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_DATA_ENDIAN
)paren
ques
c_cond
l_string|&quot; data_endian&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_DMA_ENDIAN
)paren
ques
c_cond
l_string|&quot; dma_endian&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_NAK_EN
)paren
ques
c_cond
l_string|&quot; nak&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_AUTODECODE_DIS
)paren
ques
c_cond
l_string|&quot; autodecode_dis&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_SELF_PWR
)paren
ques
c_cond
l_string|&quot; self_pwr&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_SOFF_DIS
)paren
ques
c_cond
l_string|&quot; soff_dis&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_PULLUP_EN
)paren
ques
c_cond
l_string|&quot; PULLUP&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
singleline_comment|// syscon2 is write-only
multiline_comment|/* UDC controller registers */
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_amp
id|UDC_PULLUP_EN
)paren
)paren
(brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;(suspended)&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tmp
op_assign
id|UDC_DEVSTAT_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;devstat     %04x&quot;
id|EIGHTBITS
l_string|&quot;%s%s&bslash;n&quot;
comma
id|tmp
comma
(paren
id|tmp
op_amp
id|UDC_B_HNP_ENABLE
)paren
ques
c_cond
l_string|&quot; b_hnp&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_A_HNP_SUPPORT
)paren
ques
c_cond
l_string|&quot; a_hnp&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_A_ALT_HNP_SUPPORT
)paren
ques
c_cond
l_string|&quot; a_alt_hnp&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_R_WK_OK
)paren
ques
c_cond
l_string|&quot; r_wk_ok&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_USB_RESET
)paren
ques
c_cond
l_string|&quot; usb_reset&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_SUS
)paren
ques
c_cond
l_string|&quot; SUS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_CFG
)paren
ques
c_cond
l_string|&quot; CFG&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_ADD
)paren
ques
c_cond
l_string|&quot; ADD&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_DEF
)paren
ques
c_cond
l_string|&quot; DEF&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_ATT
)paren
ques
c_cond
l_string|&quot; ATT&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;sof         %04x&bslash;n&quot;
comma
id|UDC_SOF_REG
)paren
suffix:semicolon
id|tmp
op_assign
id|UDC_IRQ_EN_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;irq_en      %04x&quot;
id|FOURBITS
l_string|&quot;%s&bslash;n&quot;
comma
id|tmp
comma
(paren
id|tmp
op_amp
id|UDC_SOF_IE
)paren
ques
c_cond
l_string|&quot; sof&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_EPN_RX_IE
)paren
ques
c_cond
l_string|&quot; epn_rx&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_EPN_TX_IE
)paren
ques
c_cond
l_string|&quot; epn_tx&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_DS_CHG_IE
)paren
ques
c_cond
l_string|&quot; ds_chg&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_EP0_IE
)paren
ques
c_cond
l_string|&quot; ep0&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|tmp
op_assign
id|UDC_IRQ_SRC_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;irq_src     %04x&quot;
id|EIGHTBITS
l_string|&quot;%s%s&bslash;n&quot;
comma
id|tmp
comma
(paren
id|tmp
op_amp
id|UDC_TXN_DONE
)paren
ques
c_cond
l_string|&quot; txn_done&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_RXN_CNT
)paren
ques
c_cond
l_string|&quot; rxn_cnt&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_RXN_EOT
)paren
ques
c_cond
l_string|&quot; rxn_eot&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_SOF
)paren
ques
c_cond
l_string|&quot; sof&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_EPN_RX
)paren
ques
c_cond
l_string|&quot; epn_rx&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_EPN_TX
)paren
ques
c_cond
l_string|&quot; epn_tx&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_DS_CHG
)paren
ques
c_cond
l_string|&quot; ds_chg&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_SETUP
)paren
ques
c_cond
l_string|&quot; setup&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_EP0_RX
)paren
ques
c_cond
l_string|&quot; ep0out&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_EP0_TX
)paren
ques
c_cond
l_string|&quot; ep0in&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
)paren
(brace
r_int
id|i
suffix:semicolon
id|tmp
op_assign
id|UDC_DMA_IRQ_EN_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;dma_irq_en  %04x%s&quot;
id|EIGHTBITS
l_string|&quot;&bslash;n&quot;
comma
id|tmp
comma
(paren
id|tmp
op_amp
id|UDC_TX_DONE_IE
c_func
(paren
l_int|3
)paren
)paren
ques
c_cond
l_string|&quot; tx2_done&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_RX_CNT_IE
c_func
(paren
l_int|3
)paren
)paren
ques
c_cond
l_string|&quot; rx2_cnt&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_RX_EOT_IE
c_func
(paren
l_int|3
)paren
)paren
ques
c_cond
l_string|&quot; rx2_eot&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_TX_DONE_IE
c_func
(paren
l_int|2
)paren
)paren
ques
c_cond
l_string|&quot; tx1_done&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_RX_CNT_IE
c_func
(paren
l_int|2
)paren
)paren
ques
c_cond
l_string|&quot; rx1_cnt&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_RX_EOT_IE
c_func
(paren
l_int|2
)paren
)paren
ques
c_cond
l_string|&quot; rx1_eot&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_TX_DONE_IE
c_func
(paren
l_int|1
)paren
)paren
ques
c_cond
l_string|&quot; tx0_done&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_RX_CNT_IE
c_func
(paren
l_int|1
)paren
)paren
ques
c_cond
l_string|&quot; rx0_cnt&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|tmp
op_amp
id|UDC_RX_EOT_IE
c_func
(paren
l_int|1
)paren
)paren
ques
c_cond
l_string|&quot; rx0_eot&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|tmp
op_assign
id|UDC_RXDMA_CFG_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;rxdma_cfg   %04x&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
(paren
l_int|0x0f
op_lshift
(paren
id|i
op_star
l_int|4
)paren
)paren
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;rxdma[%d]    %04x&bslash;n&quot;
comma
id|i
comma
id|UDC_RXDMA_REG
c_func
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
id|tmp
op_assign
id|UDC_TXDMA_CFG_REG
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;txdma_cfg   %04x&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_amp
(paren
l_int|0x0f
op_lshift
(paren
id|i
op_star
l_int|4
)paren
)paren
)paren
)paren
r_continue
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;txdma[%d]    %04x&bslash;n&quot;
comma
id|i
comma
id|UDC_TXDMA_REG
c_func
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|tmp
op_assign
id|UDC_DEVSTAT_REG
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|UDC_ATT
)paren
(brace
id|proc_ep_show
c_func
(paren
id|s
comma
op_amp
id|udc-&gt;ep
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|UDC_ADD
)paren
(brace
id|list_for_each_entry
(paren
id|ep
comma
op_amp
id|udc-&gt;gadget.ep_list
comma
id|ep.ep_list
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;desc
)paren
id|proc_ep_show
c_func
(paren
id|s
comma
id|ep
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|udc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|proc_udc_open
r_static
r_int
id|proc_udc_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|proc_udc_show
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|proc_ops
r_static
r_struct
id|file_operations
id|proc_ops
op_assign
(brace
dot
id|open
op_assign
id|proc_udc_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|create_proc_file
r_static
r_void
id|create_proc_file
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|pde
suffix:semicolon
id|pde
op_assign
id|create_proc_entry
(paren
id|proc_filename
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pde
)paren
id|pde-&gt;proc_fops
op_assign
op_amp
id|proc_ops
suffix:semicolon
)brace
DECL|function|remove_proc_file
r_static
r_void
id|remove_proc_file
c_func
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|proc_filename
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|create_proc_file
r_static
r_inline
r_void
id|create_proc_file
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|remove_proc_file
r_static
r_inline
r_void
id|remove_proc_file
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Before this controller can enumerate, we need to pick an endpoint&n; * configuration, or &quot;fifo_mode&quot;  That involves allocating 2KB of packet&n; * buffer space among the endpoints we&squot;ll be operating.&n; */
r_static
r_int
id|__init
DECL|function|omap_ep_setup
id|omap_ep_setup
c_func
(paren
r_char
op_star
id|name
comma
id|u8
id|addr
comma
id|u8
id|type
comma
r_int
id|buf
comma
r_int
id|maxp
comma
r_int
id|dbuf
)paren
(brace
r_struct
id|omap_ep
op_star
id|ep
suffix:semicolon
id|u16
id|epn_rxtx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* OUT endpoints first, then IN */
id|ep
op_assign
op_amp
id|udc-&gt;ep
(braket
id|addr
op_amp
l_int|0xf
)braket
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
id|USB_DIR_IN
)paren
id|ep
op_add_assign
l_int|16
suffix:semicolon
multiline_comment|/* in case of ep init table bugs */
id|BUG_ON
c_func
(paren
id|ep-&gt;name
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* chip setup ... bit values are same for IN, OUT */
r_if
c_cond
(paren
id|type
op_eq
id|USB_ENDPOINT_XFER_ISOC
)paren
(brace
r_switch
c_cond
(paren
id|maxp
)paren
(brace
r_case
l_int|8
suffix:colon
id|epn_rxtx
op_assign
l_int|0
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|epn_rxtx
op_assign
l_int|1
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|epn_rxtx
op_assign
l_int|2
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|epn_rxtx
op_assign
l_int|3
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|128
suffix:colon
id|epn_rxtx
op_assign
l_int|4
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|256
suffix:colon
id|epn_rxtx
op_assign
l_int|5
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|512
suffix:colon
id|epn_rxtx
op_assign
l_int|6
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|epn_rxtx
op_or_assign
id|UDC_EPN_RX_ISO
suffix:semicolon
id|dbuf
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* double-buffering &quot;not supported&quot; on 15xx,&n;&t;&t; * and ignored for PIO-IN on 16xx&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|use_dma
op_logical_or
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
id|dbuf
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|maxp
)paren
(brace
r_case
l_int|8
suffix:colon
id|epn_rxtx
op_assign
l_int|0
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|epn_rxtx
op_assign
l_int|1
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|epn_rxtx
op_assign
l_int|2
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|epn_rxtx
op_assign
l_int|3
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbuf
op_logical_and
id|addr
)paren
id|epn_rxtx
op_or_assign
id|UDC_EPN_RX_DB
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ep-&gt;timer
)paren
suffix:semicolon
id|ep-&gt;timer.function
op_assign
id|pio_out_timer
suffix:semicolon
id|ep-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ep
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr
)paren
id|epn_rxtx
op_or_assign
id|UDC_EPN_RX_VALID
suffix:semicolon
id|BUG_ON
c_func
(paren
id|buf
op_amp
l_int|0x07
)paren
suffix:semicolon
id|epn_rxtx
op_or_assign
id|buf
op_rshift
l_int|3
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s addr %02x rxtx %04x maxp %d%s buf %d&bslash;n&quot;
comma
id|name
comma
id|addr
comma
id|epn_rxtx
comma
id|maxp
comma
id|dbuf
ques
c_cond
l_string|&quot;x2&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
id|USB_DIR_IN
)paren
id|UDC_EP_TX_REG
c_func
(paren
id|addr
op_amp
l_int|0xf
)paren
op_assign
id|epn_rxtx
suffix:semicolon
r_else
id|UDC_EP_RX_REG
c_func
(paren
id|addr
)paren
op_assign
id|epn_rxtx
suffix:semicolon
multiline_comment|/* next endpoint&squot;s buffer starts after this one&squot;s */
id|buf
op_add_assign
id|maxp
suffix:semicolon
r_if
c_cond
(paren
id|dbuf
)paren
id|buf
op_add_assign
id|maxp
suffix:semicolon
id|BUG_ON
c_func
(paren
id|buf
OG
l_int|2048
)paren
suffix:semicolon
multiline_comment|/* set up driver data structures */
id|BUG_ON
c_func
(paren
id|strlen
c_func
(paren
id|name
)paren
op_ge
r_sizeof
id|ep-&gt;name
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|ep-&gt;name
comma
id|name
comma
r_sizeof
id|ep-&gt;name
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ep-&gt;iso
)paren
suffix:semicolon
id|ep-&gt;bEndpointAddress
op_assign
id|addr
suffix:semicolon
id|ep-&gt;bmAttributes
op_assign
id|type
suffix:semicolon
id|ep-&gt;double_buf
op_assign
id|dbuf
suffix:semicolon
id|ep-&gt;udc
op_assign
id|udc
suffix:semicolon
id|ep-&gt;ep.name
op_assign
id|ep-&gt;name
suffix:semicolon
id|ep-&gt;ep.ops
op_assign
op_amp
id|omap_ep_ops
suffix:semicolon
id|ep-&gt;ep.maxpacket
op_assign
id|ep-&gt;maxpacket
op_assign
id|maxp
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|ep-&gt;ep.ep_list
comma
op_amp
id|udc-&gt;gadget.ep_list
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
DECL|function|omap_udc_release
r_static
r_void
id|omap_udc_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|complete
c_func
(paren
id|udc-&gt;done
)paren
suffix:semicolon
id|kfree
(paren
id|udc
)paren
suffix:semicolon
id|udc
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|omap_udc_setup
id|omap_udc_setup
c_func
(paren
r_struct
id|platform_device
op_star
id|odev
comma
r_struct
id|otg_transceiver
op_star
id|xceiv
)paren
(brace
r_int
id|tmp
comma
id|buf
suffix:semicolon
multiline_comment|/* abolish any previous hardware state */
id|UDC_SYSCON1_REG
op_assign
l_int|0
suffix:semicolon
id|UDC_IRQ_EN_REG
op_assign
l_int|0
suffix:semicolon
id|UDC_IRQ_SRC_REG
op_assign
id|UDC_IRQ_SRC_MASK
suffix:semicolon
id|UDC_DMA_IRQ_EN_REG
op_assign
l_int|0
suffix:semicolon
id|UDC_RXDMA_CFG_REG
op_assign
l_int|0
suffix:semicolon
id|UDC_TXDMA_CFG_REG
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* UDC_PULLUP_EN gates the chip clock */
singleline_comment|// OTG_SYSCON_1_REG |= DEV_IDLE_EN;
id|udc
op_assign
id|kmalloc
(paren
r_sizeof
op_star
id|udc
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|udc
comma
l_int|0
comma
r_sizeof
op_star
id|udc
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|udc-&gt;lock
)paren
suffix:semicolon
id|udc-&gt;gadget.ops
op_assign
op_amp
id|omap_gadget_ops
suffix:semicolon
id|udc-&gt;gadget.ep0
op_assign
op_amp
id|udc-&gt;ep
(braket
l_int|0
)braket
dot
id|ep
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|udc-&gt;gadget.ep_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|udc-&gt;iso
)paren
suffix:semicolon
id|udc-&gt;gadget.speed
op_assign
id|USB_SPEED_UNKNOWN
suffix:semicolon
id|udc-&gt;gadget.name
op_assign
id|driver_name
suffix:semicolon
id|device_initialize
c_func
(paren
op_amp
id|udc-&gt;gadget.dev
)paren
suffix:semicolon
id|strcpy
(paren
id|udc-&gt;gadget.dev.bus_id
comma
l_string|&quot;gadget&quot;
)paren
suffix:semicolon
id|udc-&gt;gadget.dev.release
op_assign
id|omap_udc_release
suffix:semicolon
id|udc-&gt;gadget.dev.parent
op_assign
op_amp
id|odev-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
)paren
id|udc-&gt;gadget.dev.dma_mask
op_assign
id|odev-&gt;dev.dma_mask
suffix:semicolon
id|udc-&gt;transceiver
op_assign
id|xceiv
suffix:semicolon
multiline_comment|/* ep0 is special; put it right after the SETUP buffer */
id|buf
op_assign
id|omap_ep_setup
c_func
(paren
l_string|&quot;ep0&quot;
comma
l_int|0
comma
id|USB_ENDPOINT_XFER_CONTROL
comma
l_int|8
multiline_comment|/* after SETUP */
comma
l_int|64
multiline_comment|/* maxpacket */
comma
l_int|0
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|udc-&gt;ep
(braket
l_int|0
)braket
dot
id|ep.ep_list
)paren
suffix:semicolon
multiline_comment|/* initially disable all non-ep0 endpoints */
r_for
c_loop
(paren
id|tmp
op_assign
l_int|1
suffix:semicolon
id|tmp
OL
l_int|15
suffix:semicolon
id|tmp
op_increment
)paren
(brace
id|UDC_EP_RX_REG
c_func
(paren
id|tmp
)paren
op_assign
l_int|0
suffix:semicolon
id|UDC_EP_TX_REG
c_func
(paren
id|tmp
)paren
op_assign
l_int|0
suffix:semicolon
)brace
DECL|macro|OMAP_BULK_EP
mdefine_line|#define OMAP_BULK_EP(name,addr) &bslash;&n;&t;buf = omap_ep_setup(name &quot;-bulk&quot;, addr, &bslash;&n;&t;&t;&t;USB_ENDPOINT_XFER_BULK, buf, 64, 1);
DECL|macro|OMAP_INT_EP
mdefine_line|#define OMAP_INT_EP(name,addr, maxp) &bslash;&n;&t;buf = omap_ep_setup(name &quot;-int&quot;, addr, &bslash;&n;&t;&t;&t;USB_ENDPOINT_XFER_INT, buf, maxp, 0);
DECL|macro|OMAP_ISO_EP
mdefine_line|#define OMAP_ISO_EP(name,addr, maxp) &bslash;&n;&t;buf = omap_ep_setup(name &quot;-iso&quot;, addr, &bslash;&n;&t;&t;&t;USB_ENDPOINT_XFER_ISOC, buf, maxp, 1);
r_switch
c_cond
(paren
id|fifo_mode
)paren
(brace
r_case
l_int|0
suffix:colon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep1in&quot;
comma
id|USB_DIR_IN
op_or
l_int|1
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep2out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|2
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep3in&quot;
comma
id|USB_DIR_IN
op_or
l_int|3
comma
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep1in&quot;
comma
id|USB_DIR_IN
op_or
l_int|1
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep2out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|2
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep3in&quot;
comma
id|USB_DIR_IN
op_or
l_int|3
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep4out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|4
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep5in&quot;
comma
id|USB_DIR_IN
op_or
l_int|5
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep5out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|5
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep6in&quot;
comma
id|USB_DIR_IN
op_or
l_int|6
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep6out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|6
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep7in&quot;
comma
id|USB_DIR_IN
op_or
l_int|7
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep7out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|7
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep8in&quot;
comma
id|USB_DIR_IN
op_or
l_int|8
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep8out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|8
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep9in&quot;
comma
id|USB_DIR_IN
op_or
l_int|9
comma
l_int|16
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep10out&quot;
comma
id|USB_DIR_IN
op_or
l_int|10
comma
l_int|16
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep11in&quot;
comma
id|USB_DIR_IN
op_or
l_int|9
comma
l_int|16
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep12out&quot;
comma
id|USB_DIR_IN
op_or
l_int|10
comma
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef&t;USE_ISO
r_case
l_int|2
suffix:colon
multiline_comment|/* mixed iso/bulk */
id|OMAP_ISO_EP
c_func
(paren
l_string|&quot;ep1in&quot;
comma
id|USB_DIR_IN
op_or
l_int|1
comma
l_int|256
)paren
suffix:semicolon
id|OMAP_ISO_EP
c_func
(paren
l_string|&quot;ep2out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|2
comma
l_int|256
)paren
suffix:semicolon
id|OMAP_ISO_EP
c_func
(paren
l_string|&quot;ep3in&quot;
comma
id|USB_DIR_IN
op_or
l_int|3
comma
l_int|128
)paren
suffix:semicolon
id|OMAP_ISO_EP
c_func
(paren
l_string|&quot;ep4out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|4
comma
l_int|128
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep5in&quot;
comma
id|USB_DIR_IN
op_or
l_int|5
comma
l_int|16
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep6in&quot;
comma
id|USB_DIR_IN
op_or
l_int|6
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep7out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|7
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep8in&quot;
comma
id|USB_DIR_IN
op_or
l_int|8
comma
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* mixed bulk/iso */
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep1in&quot;
comma
id|USB_DIR_IN
op_or
l_int|1
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep2out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|2
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep3in&quot;
comma
id|USB_DIR_IN
op_or
l_int|3
comma
l_int|16
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep4in&quot;
comma
id|USB_DIR_IN
op_or
l_int|4
)paren
suffix:semicolon
id|OMAP_BULK_EP
c_func
(paren
l_string|&quot;ep5out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|5
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep6in&quot;
comma
id|USB_DIR_IN
op_or
l_int|6
comma
l_int|16
)paren
suffix:semicolon
id|OMAP_ISO_EP
c_func
(paren
l_string|&quot;ep7in&quot;
comma
id|USB_DIR_IN
op_or
l_int|7
comma
l_int|256
)paren
suffix:semicolon
id|OMAP_ISO_EP
c_func
(paren
l_string|&quot;ep8out&quot;
comma
id|USB_DIR_OUT
op_or
l_int|8
comma
l_int|256
)paren
suffix:semicolon
id|OMAP_INT_EP
c_func
(paren
l_string|&quot;ep9in&quot;
comma
id|USB_DIR_IN
op_or
l_int|9
comma
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
multiline_comment|/* add more modes as needed */
r_default
suffix:colon
id|ERR
c_func
(paren
l_string|&quot;unsupported fifo_mode #%d&bslash;n&quot;
comma
id|fifo_mode
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|UDC_SYSCON1_REG
op_assign
id|UDC_CFG_LOCK
op_or
id|UDC_SELF_PWR
suffix:semicolon
id|INFO
c_func
(paren
l_string|&quot;fifo mode %d, %d bytes not used&bslash;n&quot;
comma
id|fifo_mode
comma
l_int|2048
op_minus
id|buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|omap_udc_probe
r_static
r_int
id|__init
id|omap_udc_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|platform_device
op_star
id|odev
op_assign
id|to_platform_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_int
id|hmc
suffix:semicolon
r_struct
id|otg_transceiver
op_star
id|xceiv
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|type
op_assign
l_int|0
suffix:semicolon
r_struct
id|omap_usb_config
op_star
id|config
op_assign
id|dev-&gt;platform_data
suffix:semicolon
multiline_comment|/* NOTE:  &quot;knows&quot; the order of the resources! */
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_plus
l_int|1
comma
id|driver_name
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;request_mem_region failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|INFO
c_func
(paren
l_string|&quot;OMAP UDC rev %d.%d%s&bslash;n&quot;
comma
id|UDC_REV_REG
op_rshift
l_int|4
comma
id|UDC_REV_REG
op_amp
l_int|0xf
comma
id|config-&gt;otg
ques
c_cond
l_string|&quot;, Mini-AB&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* use the mode given to us by board init code */
r_if
c_cond
(paren
id|cpu_is_omap15xx
c_func
(paren
)paren
)paren
(brace
id|hmc
op_assign
id|HMC_1510
suffix:semicolon
id|type
op_assign
l_string|&quot;(unknown)&quot;
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_omap_innovator
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* just set up software VBUS detect, and then&n;&t;&t;&t; * later rig it so we always report VBUS.&n;&t;&t;&t; * FIXME without really sensing VBUS, we can&squot;t&n;&t;&t;&t; * know when to turn PULLUP_EN on/off; and that&n;&t;&t;&t; * means we always &quot;need&quot; the 48MHz clock.&n;&t;&t;&t; */
id|u32
id|tmp
op_assign
id|FUNC_MUX_CTRL_0_REG
suffix:semicolon
id|FUNC_MUX_CTRL_0_REG
op_and_assign
op_complement
id|VBUS_CTRL_1510
suffix:semicolon
id|tmp
op_or_assign
id|VBUS_MODE_1510
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|VBUS_CTRL_1510
suffix:semicolon
id|FUNC_MUX_CTRL_0_REG
op_assign
id|tmp
suffix:semicolon
)brace
)brace
r_else
(brace
id|hmc
op_assign
id|HMC_1610
suffix:semicolon
r_switch
c_cond
(paren
id|hmc
)paren
(brace
r_case
l_int|3
suffix:colon
r_case
l_int|11
suffix:colon
r_case
l_int|16
suffix:colon
r_case
l_int|19
suffix:colon
r_case
l_int|25
suffix:colon
id|xceiv
op_assign
id|otg_get_transceiver
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xceiv
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;external transceiver not registered!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|config-&gt;otg
)paren
r_goto
id|cleanup0
suffix:semicolon
id|type
op_assign
l_string|&quot;(unknown external)&quot;
suffix:semicolon
)brace
r_else
id|type
op_assign
id|xceiv-&gt;label
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* POWERUP DEFAULT == 0 */
r_case
l_int|4
suffix:colon
r_case
l_int|12
suffix:colon
r_case
l_int|20
suffix:colon
id|type
op_assign
l_string|&quot;INTEGRATED&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|21
suffix:colon
multiline_comment|/* internal loopback */
id|type
op_assign
l_string|&quot;(loopback)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|14
suffix:colon
multiline_comment|/* transceiverless */
id|type
op_assign
l_string|&quot;(none)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ERR
c_func
(paren
l_string|&quot;unrecognized UDC HMC mode %d&bslash;n&quot;
comma
id|hmc
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
id|INFO
c_func
(paren
l_string|&quot;hmc mode %d, transceiver %s&bslash;n&quot;
comma
id|hmc
comma
id|type
)paren
suffix:semicolon
multiline_comment|/* a &quot;gadget&quot; abstracts/virtualizes the controller */
id|status
op_assign
id|omap_udc_setup
c_func
(paren
id|odev
comma
id|xceiv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
r_goto
id|cleanup0
suffix:semicolon
)brace
id|xceiv
op_assign
l_int|0
suffix:semicolon
singleline_comment|// &quot;udc&quot; is now valid
id|pullup_disable
c_func
(paren
id|udc
)paren
suffix:semicolon
macro_line|#if&t;defined(CONFIG_USB_OHCI_HCD) || defined(CONFIG_USB_OHCI_HCD_MODULE)
id|udc-&gt;gadget.is_otg
op_assign
(paren
id|config-&gt;otg
op_ne
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* USB general purpose IRQ:  ep0, state changes, dma, etc */
id|status
op_assign
id|request_irq
c_func
(paren
id|odev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
id|omap_udc_irq
comma
id|SA_SAMPLE_RANDOM
comma
id|driver_name
comma
id|udc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;can&squot;t get irq %ld, err %d&bslash;n&quot;
comma
id|odev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
id|status
)paren
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
multiline_comment|/* USB &quot;non-iso&quot; IRQ (PIO for all but ep0) */
id|status
op_assign
id|request_irq
c_func
(paren
id|odev-&gt;resource
(braket
l_int|2
)braket
dot
id|start
comma
id|omap_udc_pio_irq
comma
id|SA_SAMPLE_RANDOM
comma
l_string|&quot;omap_udc pio&quot;
comma
id|udc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;can&squot;t get irq %ld, err %d&bslash;n&quot;
comma
id|odev-&gt;resource
(braket
l_int|2
)braket
dot
id|start
comma
id|status
)paren
suffix:semicolon
r_goto
id|cleanup2
suffix:semicolon
)brace
macro_line|#ifdef&t;USE_ISO
id|status
op_assign
id|request_irq
c_func
(paren
id|odev-&gt;resource
(braket
l_int|3
)braket
dot
id|start
comma
id|omap_udc_iso_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;omap_udc iso&quot;
comma
id|udc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;can&squot;t get irq %ld, err %d&bslash;n&quot;
comma
id|odev-&gt;resource
(braket
l_int|3
)braket
dot
id|start
comma
id|status
)paren
suffix:semicolon
r_goto
id|cleanup3
suffix:semicolon
)brace
macro_line|#endif
id|create_proc_file
c_func
(paren
)paren
suffix:semicolon
id|device_add
c_func
(paren
op_amp
id|udc-&gt;gadget.dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef&t;USE_ISO
id|cleanup3
suffix:colon
id|free_irq
c_func
(paren
id|odev-&gt;resource
(braket
l_int|2
)braket
dot
id|start
comma
id|udc
)paren
suffix:semicolon
macro_line|#endif
id|cleanup2
suffix:colon
id|free_irq
c_func
(paren
id|odev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
id|udc
)paren
suffix:semicolon
id|cleanup1
suffix:colon
id|kfree
(paren
id|udc
)paren
suffix:semicolon
id|udc
op_assign
l_int|0
suffix:semicolon
id|cleanup0
suffix:colon
r_if
c_cond
(paren
id|xceiv
)paren
id|put_device
c_func
(paren
id|xceiv-&gt;dev
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|omap_udc_remove
r_static
r_int
id|__exit
id|omap_udc_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|platform_device
op_star
id|odev
op_assign
id|to_platform_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DECLARE_COMPLETION
c_func
(paren
id|done
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udc
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|udc-&gt;done
op_assign
op_amp
id|done
suffix:semicolon
id|pullup_disable
c_func
(paren
id|udc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udc-&gt;transceiver
)paren
(brace
id|put_device
c_func
(paren
id|udc-&gt;transceiver-&gt;dev
)paren
suffix:semicolon
id|udc-&gt;transceiver
op_assign
l_int|0
suffix:semicolon
)brace
id|UDC_SYSCON1_REG
op_assign
l_int|0
suffix:semicolon
id|remove_proc_file
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef&t;USE_ISO
id|free_irq
c_func
(paren
id|odev-&gt;resource
(braket
l_int|3
)braket
dot
id|start
comma
id|udc
)paren
suffix:semicolon
macro_line|#endif
id|free_irq
c_func
(paren
id|odev-&gt;resource
(braket
l_int|2
)braket
dot
id|start
comma
id|udc
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|odev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
id|udc
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|odev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_plus
l_int|1
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|udc-&gt;gadget.dev
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|done
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* suspend/resume/wakeup from sysfs (echo &gt; power/state) */
DECL|function|omap_udc_suspend
r_static
r_int
id|omap_udc_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_if
c_cond
(paren
id|level
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;suspend, state %d&bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
id|omap_pullup
c_func
(paren
op_amp
id|udc-&gt;gadget
comma
l_int|0
)paren
suffix:semicolon
id|udc-&gt;gadget.dev.power.power_state
op_assign
l_int|3
suffix:semicolon
id|udc-&gt;gadget.dev.parent-&gt;power.power_state
op_assign
l_int|3
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|omap_udc_resume
r_static
r_int
id|omap_udc_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
r_if
c_cond
(paren
id|level
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;resume + wakeup/SRP&bslash;n&quot;
)paren
suffix:semicolon
id|udc-&gt;gadget.dev.parent-&gt;power.power_state
op_assign
l_int|0
suffix:semicolon
id|udc-&gt;gadget.dev.power.power_state
op_assign
l_int|0
suffix:semicolon
id|omap_pullup
c_func
(paren
op_amp
id|udc-&gt;gadget
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* maybe the host would enumerate us if we nudged it */
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_return
id|omap_wakeup
c_func
(paren
op_amp
id|udc-&gt;gadget
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|udc_driver
r_static
r_struct
id|device_driver
id|udc_driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
id|driver_name
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|omap_udc_probe
comma
dot
id|remove
op_assign
id|__exit_p
c_func
(paren
id|omap_udc_remove
)paren
comma
dot
id|suspend
op_assign
id|omap_udc_suspend
comma
dot
id|resume
op_assign
id|omap_udc_resume
comma
)brace
suffix:semicolon
DECL|function|udc_init
r_static
r_int
id|__init
id|udc_init
c_func
(paren
r_void
)paren
(brace
id|INFO
c_func
(paren
l_string|&quot;%s, version: &quot;
id|DRIVER_VERSION
macro_line|#ifdef&t;USE_ISO
l_string|&quot; (iso)&quot;
macro_line|#endif
l_string|&quot;%s&bslash;n&quot;
comma
id|driver_desc
comma
id|use_dma
ques
c_cond
l_string|&quot; (dma)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|driver_register
c_func
(paren
op_amp
id|udc_driver
)paren
suffix:semicolon
)brace
DECL|variable|udc_init
id|module_init
c_func
(paren
id|udc_init
)paren
suffix:semicolon
DECL|function|udc_exit
r_static
r_void
id|__exit
id|udc_exit
c_func
(paren
r_void
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|udc_driver
)paren
suffix:semicolon
)brace
DECL|variable|udc_exit
id|module_exit
c_func
(paren
id|udc_exit
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
