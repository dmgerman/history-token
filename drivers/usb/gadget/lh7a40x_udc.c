multiline_comment|/*&n; * linux/drivers/usb/gadget/lh7a40x_udc.c&n; * Sharp LH7A40x on-chip full speed USB device controllers&n; *&n; * Copyright (C) 2004 Mikko Lahteenmaki, Nordic ID&n; * Copyright (C) 2004 Bo Henriksen, Nordic ID&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; */
macro_line|#include &quot;lh7a40x_udc.h&quot;
singleline_comment|//#define DEBUG printk
singleline_comment|//#define DEBUG_EP0 printk
singleline_comment|//#define DEBUG_SETUP printk
macro_line|#ifndef DEBUG_EP0
DECL|macro|DEBUG_EP0
macro_line|# define DEBUG_EP0(fmt,args...)
macro_line|#endif
macro_line|#ifndef DEBUG_SETUP
DECL|macro|DEBUG_SETUP
macro_line|# define DEBUG_SETUP(fmt,args...)
macro_line|#endif
macro_line|#ifndef DEBUG
DECL|macro|NO_STATES
macro_line|# define NO_STATES
DECL|macro|DEBUG
macro_line|# define DEBUG(fmt,args...)
macro_line|#endif
DECL|macro|DRIVER_DESC
mdefine_line|#define&t;DRIVER_DESC&t;&t;&t;&quot;LH7A40x USB Device Controller&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define&t;DRIVER_VERSION&t;&t;__DATE__
macro_line|#ifndef _BIT&t;&t;&t;/* FIXME - what happended to _BIT in 2.6.7bk18? */
DECL|macro|_BIT
mdefine_line|#define _BIT(x) (1&lt;&lt;(x))
macro_line|#endif
DECL|variable|the_controller
r_struct
id|lh7a40x_udc
op_star
id|the_controller
suffix:semicolon
DECL|variable|driver_name
r_static
r_const
r_char
id|driver_name
(braket
)braket
op_assign
l_string|&quot;lh7a40x_udc&quot;
suffix:semicolon
DECL|variable|driver_desc
r_static
r_const
r_char
id|driver_desc
(braket
)braket
op_assign
id|DRIVER_DESC
suffix:semicolon
DECL|variable|ep0name
r_static
r_const
r_char
id|ep0name
(braket
)braket
op_assign
l_string|&quot;ep0-control&quot;
suffix:semicolon
multiline_comment|/*&n;  Local definintions.&n;*/
macro_line|#ifndef NO_STATES
DECL|variable|state_names
r_static
r_char
op_star
id|state_names
(braket
)braket
op_assign
(brace
l_string|&quot;WAIT_FOR_SETUP&quot;
comma
l_string|&quot;DATA_STATE_XMIT&quot;
comma
l_string|&quot;DATA_STATE_NEED_ZLP&quot;
comma
l_string|&quot;WAIT_FOR_OUT_STATUS&quot;
comma
l_string|&quot;DATA_STATE_RECV&quot;
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;  Local declarations.&n;*/
r_static
r_int
id|lh7a40x_ep_enable
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_const
r_struct
id|usb_endpoint_descriptor
op_star
)paren
suffix:semicolon
r_static
r_int
id|lh7a40x_ep_disable
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
)paren
suffix:semicolon
r_static
r_struct
id|usb_request
op_star
id|lh7a40x_alloc_request
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lh7a40x_free_request
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
)paren
suffix:semicolon
r_static
r_void
op_star
id|lh7a40x_alloc_buffer
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_int
comma
id|dma_addr_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|lh7a40x_free_buffer
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_void
op_star
comma
id|dma_addr_t
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|lh7a40x_queue
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|lh7a40x_dequeue
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
)paren
suffix:semicolon
r_static
r_int
id|lh7a40x_set_halt
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|lh7a40x_fifo_status
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
)paren
suffix:semicolon
r_static
r_int
id|lh7a40x_fifo_status
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
)paren
suffix:semicolon
r_static
r_void
id|lh7a40x_fifo_flush
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
)paren
suffix:semicolon
r_static
r_void
id|lh7a40x_ep0_kick
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
r_struct
id|lh7a40x_ep
op_star
id|ep
)paren
suffix:semicolon
r_static
r_void
id|lh7a40x_handle_ep0
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
id|u32
id|intr
)paren
suffix:semicolon
r_static
r_void
id|done
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_struct
id|lh7a40x_request
op_star
id|req
comma
r_int
id|status
)paren
suffix:semicolon
r_static
r_void
id|pio_irq_enable
c_func
(paren
r_int
id|bEndpointAddress
)paren
suffix:semicolon
r_static
r_void
id|pio_irq_disable
c_func
(paren
r_int
id|bEndpointAddress
)paren
suffix:semicolon
r_static
r_void
id|stop_activity
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
suffix:semicolon
r_static
r_void
id|flush
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
)paren
suffix:semicolon
r_static
r_void
id|udc_enable
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|udc_set_address
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
r_int
r_char
id|address
)paren
suffix:semicolon
DECL|variable|lh7a40x_ep_ops
r_static
r_struct
id|usb_ep_ops
id|lh7a40x_ep_ops
op_assign
(brace
dot
id|enable
op_assign
id|lh7a40x_ep_enable
comma
dot
id|disable
op_assign
id|lh7a40x_ep_disable
comma
dot
id|alloc_request
op_assign
id|lh7a40x_alloc_request
comma
dot
id|free_request
op_assign
id|lh7a40x_free_request
comma
dot
id|alloc_buffer
op_assign
id|lh7a40x_alloc_buffer
comma
dot
id|free_buffer
op_assign
id|lh7a40x_free_buffer
comma
dot
id|queue
op_assign
id|lh7a40x_queue
comma
dot
id|dequeue
op_assign
id|lh7a40x_dequeue
comma
dot
id|set_halt
op_assign
id|lh7a40x_set_halt
comma
dot
id|fifo_status
op_assign
id|lh7a40x_fifo_status
comma
dot
id|fifo_flush
op_assign
id|lh7a40x_fifo_flush
comma
)brace
suffix:semicolon
multiline_comment|/* Inline code */
DECL|function|write_packet
r_static
id|__inline__
r_int
id|write_packet
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_struct
id|lh7a40x_request
op_star
id|req
comma
r_int
id|max
)paren
(brace
id|u8
op_star
id|buf
suffix:semicolon
r_int
id|length
comma
id|count
suffix:semicolon
r_volatile
id|u32
op_star
id|fifo
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ep-&gt;fifo
suffix:semicolon
id|buf
op_assign
id|req-&gt;req.buf
op_plus
id|req-&gt;req.actual
suffix:semicolon
id|prefetch
c_func
(paren
id|buf
)paren
suffix:semicolon
id|length
op_assign
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
suffix:semicolon
id|length
op_assign
id|min
c_func
(paren
id|length
comma
id|max
)paren
suffix:semicolon
id|req-&gt;req.actual
op_add_assign
id|length
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;Write %d (max %d), fifo %p&bslash;n&quot;
comma
id|length
comma
id|max
comma
id|fifo
)paren
suffix:semicolon
id|count
op_assign
id|length
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
op_star
id|fifo
op_assign
op_star
id|buf
op_increment
suffix:semicolon
)brace
r_return
id|length
suffix:semicolon
)brace
DECL|function|usb_set_index
r_static
id|__inline__
r_void
id|usb_set_index
c_func
(paren
id|u32
id|ep
)paren
(brace
op_star
(paren
r_volatile
id|u32
op_star
)paren
id|io_p2v
c_func
(paren
id|USB_INDEX
)paren
op_assign
id|ep
suffix:semicolon
)brace
DECL|function|usb_read
r_static
id|__inline__
id|u32
id|usb_read
c_func
(paren
id|u32
id|port
)paren
(brace
r_return
op_star
(paren
r_volatile
id|u32
op_star
)paren
id|io_p2v
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
DECL|function|usb_write
r_static
id|__inline__
r_void
id|usb_write
c_func
(paren
id|u32
id|val
comma
id|u32
id|port
)paren
(brace
op_star
(paren
r_volatile
id|u32
op_star
)paren
id|io_p2v
c_func
(paren
id|port
)paren
op_assign
id|val
suffix:semicolon
)brace
DECL|function|usb_set
r_static
id|__inline__
r_void
id|usb_set
c_func
(paren
id|u32
id|val
comma
id|u32
id|port
)paren
(brace
r_volatile
id|u32
op_star
id|ioport
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|io_p2v
c_func
(paren
id|port
)paren
suffix:semicolon
id|u32
id|after
op_assign
(paren
op_star
id|ioport
)paren
op_or
id|val
suffix:semicolon
op_star
id|ioport
op_assign
id|after
suffix:semicolon
)brace
DECL|function|usb_clear
r_static
id|__inline__
r_void
id|usb_clear
c_func
(paren
id|u32
id|val
comma
id|u32
id|port
)paren
(brace
r_volatile
id|u32
op_star
id|ioport
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|io_p2v
c_func
(paren
id|port
)paren
suffix:semicolon
id|u32
id|after
op_assign
(paren
op_star
id|ioport
)paren
op_amp
op_complement
id|val
suffix:semicolon
op_star
id|ioport
op_assign
id|after
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|GPIO_PORTC_DR
mdefine_line|#define GPIO_PORTC_DR &t;(0x80000E08)
DECL|macro|GPIO_PORTC_DDR
mdefine_line|#define GPIO_PORTC_DDR &t;(0x80000E18)
DECL|macro|GPIO_PORTC_PDR
mdefine_line|#define GPIO_PORTC_PDR &t;(0x80000E70)
multiline_comment|/* get port C pin data register */
DECL|macro|get_portc_pdr
mdefine_line|#define get_portc_pdr(bit) &t;&t;((usb_read(GPIO_PORTC_PDR) &amp; _BIT(bit)) != 0)
multiline_comment|/* get port C data direction register */
DECL|macro|get_portc_ddr
mdefine_line|#define get_portc_ddr(bit) &t;&t;((usb_read(GPIO_PORTC_DDR) &amp; _BIT(bit)) != 0)
multiline_comment|/* set port C data register */
DECL|macro|set_portc_dr
mdefine_line|#define set_portc_dr(bit, val) &t;(val ? usb_set(_BIT(bit), GPIO_PORTC_DR) : usb_clear(_BIT(bit), GPIO_PORTC_DR))
multiline_comment|/* set port C data direction register */
DECL|macro|set_portc_ddr
mdefine_line|#define set_portc_ddr(bit, val) (val ? usb_set(_BIT(bit), GPIO_PORTC_DDR) : usb_clear(_BIT(bit), GPIO_PORTC_DDR))
multiline_comment|/*&n; * LPD7A404 GPIO&squot;s:&n; * Port C bit 1 = USB Port 1 Power Enable&n; * Port C bit 2 = USB Port 1 Data Carrier Detect&n; */
DECL|macro|is_usb_connected
mdefine_line|#define is_usb_connected() &t;&t;get_portc_pdr(2)
macro_line|#ifdef CONFIG_USB_GADGET_DEBUG_FILES
DECL|variable|proc_node_name
r_static
r_const
r_char
id|proc_node_name
(braket
)braket
op_assign
l_string|&quot;driver/udc&quot;
suffix:semicolon
r_static
r_int
DECL|function|udc_proc_read
id|udc_proc_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|_dev
)paren
(brace
r_char
op_star
id|buf
op_assign
id|page
suffix:semicolon
r_struct
id|lh7a40x_udc
op_star
id|dev
op_assign
id|_dev
suffix:semicolon
r_char
op_star
id|next
op_assign
id|buf
suffix:semicolon
r_int
id|size
op_assign
id|count
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|t
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* basic device status */
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
id|DRIVER_DESC
l_string|&quot;&bslash;n&quot;
l_string|&quot;%s version: %s&bslash;n&quot;
l_string|&quot;Gadget driver: %s&bslash;n&quot;
l_string|&quot;Host: %s&bslash;n&bslash;n&quot;
comma
id|driver_name
comma
id|DRIVER_VERSION
comma
id|dev-&gt;driver
ques
c_cond
id|dev-&gt;driver-&gt;driver.name
suffix:colon
l_string|&quot;(none)&quot;
comma
id|is_usb_connected
c_func
(paren
)paren
ques
c_cond
l_string|&quot;full speed&quot;
suffix:colon
l_string|&quot;disconnected&quot;
)paren
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
l_string|&quot;GPIO:&bslash;n&quot;
l_string|&quot; Port C bit 1: %d, dir %d&bslash;n&quot;
l_string|&quot; Port C bit 2: %d, dir %d&bslash;n&bslash;n&quot;
comma
id|get_portc_pdr
c_func
(paren
l_int|1
)paren
comma
id|get_portc_ddr
c_func
(paren
l_int|1
)paren
comma
id|get_portc_pdr
c_func
(paren
l_int|2
)paren
comma
id|get_portc_ddr
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
id|t
op_assign
id|scnprintf
c_func
(paren
id|next
comma
id|size
comma
l_string|&quot;DCP pullup: %d&bslash;n&bslash;n&quot;
comma
(paren
id|usb_read
c_func
(paren
id|USB_PM
)paren
op_amp
id|PM_USB_DCP
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|size
op_sub_assign
id|t
suffix:semicolon
id|next
op_add_assign
id|t
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
id|count
op_minus
id|size
suffix:semicolon
)brace
DECL|macro|create_proc_files
mdefine_line|#define create_proc_files() &t;create_proc_read_entry(proc_node_name, 0, NULL, udc_proc_read, dev)
DECL|macro|remove_proc_files
mdefine_line|#define remove_proc_files() &t;remove_proc_entry(proc_node_name, NULL)
macro_line|#else&t;/* !CONFIG_USB_GADGET_DEBUG_FILES */
DECL|macro|create_proc_files
mdefine_line|#define create_proc_files() do {} while (0)
DECL|macro|remove_proc_files
mdefine_line|#define remove_proc_files() do {} while (0)
macro_line|#endif&t;/* CONFIG_USB_GADGET_DEBUG_FILES */
multiline_comment|/*&n; * &t;udc_disable - disable USB device controller&n; */
DECL|function|udc_disable
r_static
r_void
id|udc_disable
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
id|udc_set_address
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|usb_write
c_func
(paren
l_int|0
comma
id|USB_IN_INT_EN
)paren
suffix:semicolon
id|usb_write
c_func
(paren
l_int|0
comma
id|USB_OUT_INT_EN
)paren
suffix:semicolon
id|usb_write
c_func
(paren
l_int|0
comma
id|USB_INT_EN
)paren
suffix:semicolon
multiline_comment|/* Disable the USB */
id|usb_write
c_func
(paren
l_int|0
comma
id|USB_PM
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_LH7A404
multiline_comment|/* Disable USB power */
id|set_portc_dr
c_func
(paren
l_int|1
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* if hardware supports it, disconnect from usb */
multiline_comment|/* make_usb_disappear(); */
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
id|dev-&gt;gadget.speed
op_assign
id|USB_SPEED_UNKNOWN
suffix:semicolon
id|dev-&gt;usb_address
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;udc_reinit - initialize software state&n; */
DECL|function|udc_reinit
r_static
r_void
id|udc_reinit
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
)paren
(brace
id|u32
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* device/ep0 records init */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dev-&gt;gadget.ep_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dev-&gt;gadget.ep0-&gt;ep_list
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
multiline_comment|/* basic endpoint records init */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDC_MAX_ENDPOINTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
id|list_add_tail
c_func
(paren
op_amp
id|ep-&gt;ep.ep_list
comma
op_amp
id|dev-&gt;gadget.ep_list
)paren
suffix:semicolon
id|ep-&gt;desc
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
suffix:semicolon
id|ep-&gt;pio_irqs
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* the rest was statically initialized, and is read-only */
)brace
DECL|macro|BYTES2MAXP
mdefine_line|#define BYTES2MAXP(x)&t;(x / 8)
DECL|macro|MAXP2BYTES
mdefine_line|#define MAXP2BYTES(x)&t;(x * 8)
multiline_comment|/* until it&squot;s enabled, this UDC should be completely invisible&n; * to any USB host.&n; */
DECL|function|udc_enable
r_static
r_void
id|udc_enable
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
)paren
(brace
r_int
id|ep
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;gadget.speed
op_assign
id|USB_SPEED_UNKNOWN
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_LH7A404
multiline_comment|/* Set Port C bit 1 &amp; 2 as output */
id|set_portc_ddr
c_func
(paren
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|set_portc_ddr
c_func
(paren
l_int|2
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Enable USB power */
id|set_portc_dr
c_func
(paren
l_int|1
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * C.f Chapter 18.1.3.1 Initializing the USB&n;&t; */
multiline_comment|/* Disable the USB */
id|usb_clear
c_func
(paren
id|PM_USB_ENABLE
comma
id|USB_PM
)paren
suffix:semicolon
multiline_comment|/* Reset APB &amp; I/O sides of the USB */
id|usb_set
c_func
(paren
id|USB_RESET_APB
op_or
id|USB_RESET_IO
comma
id|USB_RESET
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|usb_clear
c_func
(paren
id|USB_RESET_APB
op_or
id|USB_RESET_IO
comma
id|USB_RESET
)paren
suffix:semicolon
multiline_comment|/* Set MAXP values for each */
r_for
c_loop
(paren
id|ep
op_assign
l_int|0
suffix:semicolon
id|ep
OL
id|UDC_MAX_ENDPOINTS
suffix:semicolon
id|ep
op_increment
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep_reg
op_assign
op_amp
id|dev-&gt;ep
(braket
id|ep
)braket
suffix:semicolon
id|u32
id|csr
suffix:semicolon
id|usb_set_index
c_func
(paren
id|ep
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ep_reg-&gt;ep_type
)paren
(brace
r_case
id|ep_bulk_in
suffix:colon
r_case
id|ep_interrupt
suffix:colon
id|usb_clear
c_func
(paren
id|USB_IN_CSR2_USB_DMA_EN
op_or
id|USB_IN_CSR2_AUTO_SET
comma
id|ep_reg-&gt;csr2
)paren
suffix:semicolon
multiline_comment|/* Fall through */
r_case
id|ep_control
suffix:colon
id|usb_write
c_func
(paren
id|BYTES2MAXP
c_func
(paren
id|ep_maxpacket
c_func
(paren
id|ep_reg
)paren
)paren
comma
id|USB_IN_MAXP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ep_bulk_out
suffix:colon
id|usb_clear
c_func
(paren
id|USB_OUT_CSR2_USB_DMA_EN
op_or
id|USB_OUT_CSR2_AUTO_CLR
comma
id|ep_reg-&gt;csr2
)paren
suffix:semicolon
id|usb_write
c_func
(paren
id|BYTES2MAXP
c_func
(paren
id|ep_maxpacket
c_func
(paren
id|ep_reg
)paren
)paren
comma
id|USB_OUT_MAXP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Read &amp; Write CSR1, just in case */
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep_reg-&gt;csr1
)paren
suffix:semicolon
id|usb_write
c_func
(paren
id|csr
comma
id|ep_reg-&gt;csr1
)paren
suffix:semicolon
id|flush
c_func
(paren
id|ep_reg
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts */
id|usb_write
c_func
(paren
l_int|0
comma
id|USB_IN_INT_EN
)paren
suffix:semicolon
id|usb_write
c_func
(paren
l_int|0
comma
id|USB_OUT_INT_EN
)paren
suffix:semicolon
id|usb_write
c_func
(paren
l_int|0
comma
id|USB_INT_EN
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts */
id|usb_set
c_func
(paren
id|USB_IN_INT_EP0
comma
id|USB_IN_INT_EN
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|USB_INT_RESET_INT
op_or
id|USB_INT_RESUME_INT
comma
id|USB_INT_EN
)paren
suffix:semicolon
multiline_comment|/* Dont enable rest of the interrupts */
multiline_comment|/* usb_set(USB_IN_INT_EP3 | USB_IN_INT_EP1 | USB_IN_INT_EP0, USB_IN_INT_EN);&n;&t;   usb_set(USB_OUT_INT_EP2, USB_OUT_INT_EN); */
multiline_comment|/* Enable SUSPEND */
id|usb_set
c_func
(paren
id|PM_ENABLE_SUSPEND
comma
id|USB_PM
)paren
suffix:semicolon
multiline_comment|/* Enable the USB */
id|usb_set
c_func
(paren
id|PM_USB_ENABLE
comma
id|USB_PM
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_LH7A404
multiline_comment|/* NOTE: DOES NOT WORK! */
multiline_comment|/* Let host detect UDC:&n;&t; * Software must write a 0 to the PMR:DCP_CTRL bit to turn this&n;&t; * transistor on and pull the USBDP pin HIGH.&n;&t; */
multiline_comment|/* usb_clear(PM_USB_DCP, USB_PM);&n;&t;   usb_set(PM_USB_DCP, USB_PM); */
macro_line|#endif
)brace
multiline_comment|/*&n;  Register entry point for the peripheral controller driver.&n;*/
DECL|function|usb_gadget_register_driver
r_int
id|usb_gadget_register_driver
c_func
(paren
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
(brace
r_struct
id|lh7a40x_udc
op_star
id|dev
op_assign
id|the_controller
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|driver-&gt;driver.name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
op_logical_or
id|driver-&gt;speed
op_ne
id|USB_SPEED_FULL
op_logical_or
op_logical_neg
id|driver-&gt;bind
op_logical_or
op_logical_neg
id|driver-&gt;unbind
op_logical_or
op_logical_neg
id|driver-&gt;disconnect
op_logical_or
op_logical_neg
id|driver-&gt;setup
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* first hook up the driver ... */
id|dev-&gt;driver
op_assign
id|driver
suffix:semicolon
id|dev-&gt;gadget.dev.driver
op_assign
op_amp
id|driver-&gt;driver
suffix:semicolon
id|device_add
c_func
(paren
op_amp
id|dev-&gt;gadget.dev
)paren
suffix:semicolon
id|retval
op_assign
id|driver
op_member_access_from_pointer
id|bind
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: bind to driver %s --&gt; error %d&bslash;n&quot;
comma
id|dev-&gt;gadget.name
comma
id|driver-&gt;driver.name
comma
id|retval
)paren
suffix:semicolon
id|device_del
c_func
(paren
op_amp
id|dev-&gt;gadget.dev
)paren
suffix:semicolon
id|dev-&gt;driver
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;gadget.dev.driver
op_assign
l_int|0
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* ... then enable host detection and ep0; and we&squot;re ready&n;&t; * for set_configuration as well as eventual disconnect.&n;&t; * NOTE:  this shouldn&squot;t power up until later.&n;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: registered gadget driver &squot;%s&squot;&bslash;n&quot;
comma
id|dev-&gt;gadget.name
comma
id|driver-&gt;driver.name
)paren
suffix:semicolon
id|udc_enable
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|usb_gadget_register_driver
id|EXPORT_SYMBOL
c_func
(paren
id|usb_gadget_register_driver
)paren
suffix:semicolon
multiline_comment|/*&n;  Unregister entry point for the peripheral controller driver.&n;*/
DECL|function|usb_gadget_unregister_driver
r_int
id|usb_gadget_unregister_driver
c_func
(paren
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
(brace
r_struct
id|lh7a40x_udc
op_star
id|dev
op_assign
id|the_controller
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
op_logical_or
id|driver
op_ne
id|dev-&gt;driver
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;driver
op_assign
l_int|0
suffix:semicolon
id|stop_activity
c_func
(paren
id|dev
comma
id|driver
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|driver
op_member_access_from_pointer
id|unbind
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
id|device_del
c_func
(paren
op_amp
id|dev-&gt;gadget.dev
)paren
suffix:semicolon
id|udc_disable
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;unregistered gadget driver &squot;%s&squot;&bslash;n&quot;
comma
id|driver-&gt;driver.name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|usb_gadget_unregister_driver
id|EXPORT_SYMBOL
c_func
(paren
id|usb_gadget_unregister_driver
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/** Write request to FIFO (max write == maxp size)&n; *  Return:  0 = still running, 1 = completed, negative = errno&n; *  NOTE: INDEX register must be set for EP&n; */
DECL|function|write_fifo
r_static
r_int
id|write_fifo
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_struct
id|lh7a40x_request
op_star
id|req
)paren
(brace
id|u32
id|max
suffix:semicolon
id|u32
id|csr
suffix:semicolon
id|max
op_assign
id|le16_to_cpu
c_func
(paren
id|ep-&gt;desc-&gt;wMaxPacketSize
)paren
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep-&gt;csr1
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;CSR: %x %d&bslash;n&quot;
comma
id|csr
comma
id|csr
op_amp
id|USB_IN_CSR1_FIFO_NOT_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|csr
op_amp
id|USB_IN_CSR1_FIFO_NOT_EMPTY
)paren
)paren
(brace
r_int
id|count
suffix:semicolon
r_int
id|is_last
comma
id|is_short
suffix:semicolon
id|count
op_assign
id|write_packet
c_func
(paren
id|ep
comma
id|req
comma
id|max
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|USB_IN_CSR1_IN_PKT_RDY
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
multiline_comment|/* last packet is usually short (or a zlp) */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|count
op_ne
id|max
)paren
)paren
id|is_last
op_assign
id|is_short
op_assign
l_int|1
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req-&gt;req.length
op_ne
id|req-&gt;req.actual
)paren
op_logical_or
id|req-&gt;req.zero
)paren
id|is_last
op_assign
l_int|0
suffix:semicolon
r_else
id|is_last
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* interrupt/iso maxpacket may not fill the fifo */
id|is_short
op_assign
id|unlikely
c_func
(paren
id|max
OL
id|ep_maxpacket
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_string|&quot;%s: wrote %s %d bytes%s%s %d left %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep-&gt;ep.name
comma
id|count
comma
id|is_last
ques
c_cond
l_string|&quot;/L&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|is_short
ques
c_cond
l_string|&quot;/S&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
comma
id|req
)paren
suffix:semicolon
multiline_comment|/* requests complete when all IN data is in the FIFO */
r_if
c_cond
(paren
id|is_last
)paren
(brace
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|pio_irq_disable
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_string|&quot;Hmm.. %d ep FIFO is not empty!&bslash;n&quot;
comma
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** Read to request from FIFO (max read == bytes in fifo)&n; *  Return:  0 = still running, 1 = completed, negative = errno&n; *  NOTE: INDEX register must be set for EP&n; */
DECL|function|read_fifo
r_static
r_int
id|read_fifo
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_struct
id|lh7a40x_request
op_star
id|req
)paren
(brace
id|u32
id|csr
suffix:semicolon
id|u8
op_star
id|buf
suffix:semicolon
r_int
id|bufferspace
comma
id|count
comma
id|is_short
suffix:semicolon
r_volatile
id|u32
op_star
id|fifo
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ep-&gt;fifo
suffix:semicolon
multiline_comment|/* make sure there&squot;s a packet in the FIFO. */
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep-&gt;csr1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|csr
op_amp
id|USB_OUT_CSR1_OUT_PKT_RDY
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s: Packet NOT ready!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf
op_assign
id|req-&gt;req.buf
op_plus
id|req-&gt;req.actual
suffix:semicolon
id|prefetchw
c_func
(paren
id|buf
)paren
suffix:semicolon
id|bufferspace
op_assign
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
suffix:semicolon
multiline_comment|/* read all bytes from this packet */
id|count
op_assign
id|usb_read
c_func
(paren
id|USB_OUT_FIFO_WC1
)paren
suffix:semicolon
id|req-&gt;req.actual
op_add_assign
id|min
c_func
(paren
id|count
comma
id|bufferspace
)paren
suffix:semicolon
id|is_short
op_assign
(paren
id|count
OL
id|ep-&gt;ep.maxpacket
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;read %s %02x, %d bytes%s req %p %d/%d&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|csr
comma
id|count
comma
id|is_short
ques
c_cond
l_string|&quot;/S&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|req
comma
id|req-&gt;req.actual
comma
id|req-&gt;req.length
)paren
suffix:semicolon
r_while
c_loop
(paren
id|likely
c_func
(paren
id|count
op_decrement
op_ne
l_int|0
)paren
)paren
(brace
id|u8
id|byte
op_assign
(paren
id|u8
)paren
(paren
op_star
id|fifo
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|bufferspace
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* this happens when the driver&squot;s buffer&n;&t;&t;&t; * is smaller than what the host sent.&n;&t;&t;&t; * discard the extra data.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|req-&gt;req.status
op_ne
op_minus
id|EOVERFLOW
)paren
id|printk
c_func
(paren
l_string|&quot;%s overflow %d&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|count
)paren
suffix:semicolon
id|req-&gt;req.status
op_assign
op_minus
id|EOVERFLOW
suffix:semicolon
)brace
r_else
(brace
op_star
id|buf
op_increment
op_assign
id|byte
suffix:semicolon
id|bufferspace
op_decrement
suffix:semicolon
)brace
)brace
id|usb_clear
c_func
(paren
id|USB_OUT_CSR1_OUT_PKT_RDY
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
multiline_comment|/* completion */
r_if
c_cond
(paren
id|is_short
op_logical_or
id|req-&gt;req.actual
op_eq
id|req-&gt;req.length
)paren
(brace
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|USB_OUT_CSR1_FIFO_FLUSH
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|pio_irq_disable
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* finished that packet.  the next one may be waiting... */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;done - retire a request; caller blocked irqs&n; *  INDEX register is preserved to keep same&n; */
DECL|function|done
r_static
r_void
id|done
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_struct
id|lh7a40x_request
op_star
id|req
comma
r_int
id|status
)paren
(brace
r_int
r_int
id|stopped
op_assign
id|ep-&gt;stopped
suffix:semicolon
id|u32
id|index
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|req-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req-&gt;req.status
op_eq
op_minus
id|EINPROGRESS
)paren
)paren
id|req-&gt;req.status
op_assign
id|status
suffix:semicolon
r_else
id|status
op_assign
id|req-&gt;req.status
suffix:semicolon
r_if
c_cond
(paren
id|status
op_logical_and
id|status
op_ne
op_minus
id|ESHUTDOWN
)paren
id|DEBUG
c_func
(paren
l_string|&quot;complete %s req %p stat %d len %u/%u&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
op_amp
id|req-&gt;req
comma
id|status
comma
id|req-&gt;req.actual
comma
id|req-&gt;req.length
)paren
suffix:semicolon
multiline_comment|/* don&squot;t modify queue heads during completion callback */
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Read current index (completion may modify it) */
id|index
op_assign
id|usb_read
c_func
(paren
id|USB_INDEX
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
)paren
suffix:semicolon
id|req-&gt;req
dot
id|complete
c_func
(paren
op_amp
id|ep-&gt;ep
comma
op_amp
id|req-&gt;req
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Restore index */
id|usb_set_index
c_func
(paren
id|index
)paren
suffix:semicolon
id|ep-&gt;stopped
op_assign
id|stopped
suffix:semicolon
)brace
multiline_comment|/** Enable EP interrupt */
DECL|function|pio_irq_enable
r_static
r_void
id|pio_irq_enable
c_func
(paren
r_int
id|ep
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ep
)paren
(brace
r_case
l_int|1
suffix:colon
id|usb_set
c_func
(paren
id|USB_IN_INT_EP1
comma
id|USB_IN_INT_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|usb_set
c_func
(paren
id|USB_OUT_INT_EP2
comma
id|USB_OUT_INT_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|usb_set
c_func
(paren
id|USB_IN_INT_EP3
comma
id|USB_IN_INT_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_string|&quot;Unknown endpoint: %d&bslash;n&quot;
comma
id|ep
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/** Disable EP interrupt */
DECL|function|pio_irq_disable
r_static
r_void
id|pio_irq_disable
c_func
(paren
r_int
id|ep
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ep
)paren
(brace
r_case
l_int|1
suffix:colon
id|usb_clear
c_func
(paren
id|USB_IN_INT_EP1
comma
id|USB_IN_INT_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|usb_clear
c_func
(paren
id|USB_OUT_INT_EP2
comma
id|USB_OUT_INT_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|usb_clear
c_func
(paren
id|USB_IN_INT_EP3
comma
id|USB_IN_INT_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_string|&quot;Unknown endpoint: %d&bslash;n&quot;
comma
id|ep
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * &t;nuke - dequeue ALL requests&n; */
DECL|function|nuke
r_void
id|nuke
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_int
id|status
)paren
(brace
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
)paren
suffix:semicolon
multiline_comment|/* Flush FIFO */
id|flush
c_func
(paren
id|ep
)paren
suffix:semicolon
multiline_comment|/* called with irqs blocked */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|lh7a40x_request
comma
id|queue
)paren
suffix:semicolon
id|done
c_func
(paren
id|ep
comma
id|req
comma
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable IRQ if EP is enabled (has decriptor) */
r_if
c_cond
(paren
id|ep-&gt;desc
)paren
id|pio_irq_disable
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;void nuke_all(struct lh7a40x_udc *dev)&n;{&n;&t;int n;&n;&t;for(n=0; n&lt;UDC_MAX_ENDPOINTS; n++) {&n;&t;&t;struct lh7a40x_ep *ep = &amp;dev-&gt;ep[n];&n;&t;&t;usb_set_index(n);&n;&t;&t;nuke(ep, 0);&n;&t;}&n;}*/
multiline_comment|/*&n;static void flush_all(struct lh7a40x_udc *dev)&n;{&n;&t;int n;&n;    for (n = 0; n &lt; UDC_MAX_ENDPOINTS; n++)&n;    {&n;&t;&t;struct lh7a40x_ep *ep = &amp;dev-&gt;ep[n];&n;&t;&t;flush(ep);&n;    }&n;}&n;*/
multiline_comment|/** Flush EP&n; * NOTE: INDEX register must be set before this call&n; */
DECL|function|flush
r_static
r_void
id|flush
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ep-&gt;ep_type
)paren
(brace
r_case
id|ep_control
suffix:colon
multiline_comment|/* check, by implication c.f. 15.1.2.11 */
r_break
suffix:semicolon
r_case
id|ep_bulk_in
suffix:colon
r_case
id|ep_interrupt
suffix:colon
multiline_comment|/* if(csr &amp; USB_IN_CSR1_IN_PKT_RDY) */
id|usb_set
c_func
(paren
id|USB_IN_CSR1_FIFO_FLUSH
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ep_bulk_out
suffix:colon
multiline_comment|/* if(csr &amp; USB_OUT_CSR1_OUT_PKT_RDY) */
id|usb_set
c_func
(paren
id|USB_OUT_CSR1_FIFO_FLUSH
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * lh7a40x_in_epn - handle IN interrupt&n; */
DECL|function|lh7a40x_in_epn
r_static
r_void
id|lh7a40x_in_epn
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
id|u32
id|ep_idx
comma
id|u32
id|intr
)paren
(brace
id|u32
id|csr
suffix:semicolon
r_struct
id|lh7a40x_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|ep_idx
)braket
suffix:semicolon
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
id|usb_set_index
c_func
(paren
id|ep_idx
)paren
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep-&gt;csr1
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s: %d, csr %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep_idx
comma
id|csr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr
op_amp
id|USB_IN_CSR1_SENT_STALL
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;USB_IN_CSR1_SENT_STALL&bslash;n&quot;
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|USB_IN_CSR1_SENT_STALL
multiline_comment|/*|USB_IN_CSR1_SEND_STALL */
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;desc
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s: NO EP DESC&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|req
op_assign
l_int|0
suffix:semicolon
r_else
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|lh7a40x_request
comma
id|queue
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;req: %p&bslash;n&quot;
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_return
suffix:semicolon
id|write_fifo
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/* ********************************************************************************************* */
multiline_comment|/* Bulk OUT (recv)&n; */
DECL|function|lh7a40x_out_epn
r_static
r_void
id|lh7a40x_out_epn
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
id|u32
id|ep_idx
comma
id|u32
id|intr
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|ep_idx
)braket
suffix:semicolon
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep_idx
)paren
suffix:semicolon
id|usb_set_index
c_func
(paren
id|ep_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;desc
)paren
(brace
id|u32
id|csr
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep-&gt;csr1
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep
op_member_access_from_pointer
id|csr1
)paren
)paren
op_amp
(paren
id|USB_OUT_CSR1_OUT_PKT_RDY
op_or
id|USB_OUT_CSR1_SENT_STALL
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr
op_amp
id|USB_OUT_CSR1_SENT_STALL
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s: stall sent, flush fifo&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* usb_set(USB_OUT_CSR1_FIFO_FLUSH, ep-&gt;csr1); */
id|flush
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|csr
op_amp
id|USB_OUT_CSR1_OUT_PKT_RDY
)paren
(brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|req
op_assign
l_int|0
suffix:semicolon
r_else
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|lh7a40x_request
comma
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: NULL REQ %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep_idx
)paren
suffix:semicolon
id|flush
c_func
(paren
id|ep
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|read_fifo
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Throw packet away.. */
id|printk
c_func
(paren
l_string|&quot;%s: No descriptor?!?&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|flush
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
)brace
DECL|function|stop_activity
r_static
r_void
id|stop_activity
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
r_struct
id|usb_gadget_driver
op_star
id|driver
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* don&squot;t disconnect drivers more than once */
r_if
c_cond
(paren
id|dev-&gt;gadget.speed
op_eq
id|USB_SPEED_UNKNOWN
)paren
id|driver
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;gadget.speed
op_assign
id|USB_SPEED_UNKNOWN
suffix:semicolon
multiline_comment|/* prevent new request submissions, kill any outstanding requests  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDC_MAX_ENDPOINTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|i
)braket
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|usb_set_index
c_func
(paren
id|i
)paren
suffix:semicolon
id|nuke
c_func
(paren
id|ep
comma
op_minus
id|ESHUTDOWN
)paren
suffix:semicolon
)brace
multiline_comment|/* report disconnect; the driver is already quiesced */
r_if
c_cond
(paren
id|driver
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|driver
op_member_access_from_pointer
id|disconnect
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* re-init driver-visible data structures */
id|udc_reinit
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/** Handle USB RESET interrupt&n; */
DECL|function|lh7a40x_reset_intr
r_static
r_void
id|lh7a40x_reset_intr
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
)paren
(brace
macro_line|#if 0&t;&t;&t;&t;/* def CONFIG_ARCH_LH7A404 */
multiline_comment|/* Does not work always... */
id|DEBUG
c_func
(paren
l_string|&quot;%s: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;usb_address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;usb_address
)paren
(brace
multiline_comment|/*usb_set(USB_RESET_IO, USB_RESET);&n;&t;&t;   mdelay(5);&n;&t;&t;   usb_clear(USB_RESET_IO, USB_RESET); */
r_return
suffix:semicolon
)brace
multiline_comment|/* Put the USB controller into reset. */
id|usb_set
c_func
(paren
id|USB_RESET_IO
comma
id|USB_RESET
)paren
suffix:semicolon
multiline_comment|/* Set Device ID to 0 */
id|udc_set_address
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Let PLL2 settle down */
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Release the USB controller from reset */
id|usb_clear
c_func
(paren
id|USB_RESET_IO
comma
id|USB_RESET
)paren
suffix:semicolon
multiline_comment|/* Re-enable UDC */
id|udc_enable
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;gadget.speed
op_assign
id|USB_SPEED_FULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;lh7a40x usb client interrupt handler.&n; */
DECL|function|lh7a40x_udc_irq
r_static
id|irqreturn_t
id|lh7a40x_udc_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|_dev
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
r_struct
id|lh7a40x_udc
op_star
id|dev
op_assign
id|_dev
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|u32
id|intr_in
op_assign
id|usb_read
c_func
(paren
id|USB_IN_INT
)paren
suffix:semicolon
id|u32
id|intr_out
op_assign
id|usb_read
c_func
(paren
id|USB_OUT_INT
)paren
suffix:semicolon
id|u32
id|intr_int
op_assign
id|usb_read
c_func
(paren
id|USB_INT
)paren
suffix:semicolon
multiline_comment|/* Test also against enable bits.. (lh7a40x errata).. Sigh.. */
id|u32
id|in_en
op_assign
id|usb_read
c_func
(paren
id|USB_IN_INT_EN
)paren
suffix:semicolon
id|u32
id|out_en
op_assign
id|usb_read
c_func
(paren
id|USB_OUT_INT_EN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intr_out
op_logical_and
op_logical_neg
id|intr_in
op_logical_and
op_logical_neg
id|intr_int
)paren
r_break
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s (on state %s)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|state_names
(braket
id|dev-&gt;ep0state
)braket
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;intr_out = %x&bslash;n&quot;
comma
id|intr_out
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;intr_in  = %x&bslash;n&quot;
comma
id|intr_in
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;intr_int = %x&bslash;n&quot;
comma
id|intr_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_in
)paren
(brace
id|usb_write
c_func
(paren
id|intr_in
comma
id|USB_IN_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|intr_in
op_amp
id|USB_IN_INT_EP1
)paren
op_logical_and
(paren
id|in_en
op_amp
id|USB_IN_INT_EP1
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;USB_IN_INT_EP1&bslash;n&quot;
)paren
suffix:semicolon
id|lh7a40x_in_epn
c_func
(paren
id|dev
comma
l_int|1
comma
id|intr_in
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|intr_in
op_amp
id|USB_IN_INT_EP3
)paren
op_logical_and
(paren
id|in_en
op_amp
id|USB_IN_INT_EP3
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;USB_IN_INT_EP3&bslash;n&quot;
)paren
suffix:semicolon
id|lh7a40x_in_epn
c_func
(paren
id|dev
comma
l_int|3
comma
id|intr_in
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_in
op_amp
id|USB_IN_INT_EP0
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;USB_IN_INT_EP0 (control)&bslash;n&quot;
)paren
suffix:semicolon
id|lh7a40x_handle_ep0
c_func
(paren
id|dev
comma
id|intr_in
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intr_out
)paren
(brace
id|usb_write
c_func
(paren
id|intr_out
comma
id|USB_OUT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|intr_out
op_amp
id|USB_OUT_INT_EP2
)paren
op_logical_and
(paren
id|out_en
op_amp
id|USB_OUT_INT_EP2
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;USB_OUT_INT_EP2&bslash;n&quot;
)paren
suffix:semicolon
id|lh7a40x_out_epn
c_func
(paren
id|dev
comma
l_int|2
comma
id|intr_out
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intr_int
)paren
(brace
id|usb_write
c_func
(paren
id|intr_int
comma
id|USB_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_int
op_amp
id|USB_INT_RESET_INT
)paren
(brace
id|lh7a40x_reset_intr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_int
op_amp
id|USB_INT_RESUME_INT
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;USB resume&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;gadget.speed
op_ne
id|USB_SPEED_UNKNOWN
op_logical_and
id|dev-&gt;driver
op_logical_and
id|dev-&gt;driver-&gt;resume
op_logical_and
id|is_usb_connected
c_func
(paren
)paren
)paren
(brace
id|dev-&gt;driver
op_member_access_from_pointer
id|resume
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intr_int
op_amp
id|USB_INT_SUSPEND_INT
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;USB suspend%s&bslash;n&quot;
comma
id|is_usb_connected
c_func
(paren
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;+disconnect&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_usb_connected
c_func
(paren
)paren
)paren
(brace
id|stop_activity
c_func
(paren
id|dev
comma
id|dev-&gt;driver
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;gadget.speed
op_ne
id|USB_SPEED_UNKNOWN
op_logical_and
id|dev-&gt;driver
op_logical_and
id|dev-&gt;driver-&gt;suspend
)paren
(brace
id|dev-&gt;driver
op_member_access_from_pointer
id|suspend
c_func
(paren
op_amp
id|dev-&gt;gadget
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|lh7a40x_ep_enable
r_static
r_int
id|lh7a40x_ep_enable
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|desc
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
suffix:semicolon
r_struct
id|lh7a40x_udc
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep
)paren
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|lh7a40x_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|desc
op_logical_or
id|ep-&gt;desc
op_logical_or
id|_ep-&gt;name
op_eq
id|ep0name
op_logical_or
id|desc-&gt;bDescriptorType
op_ne
id|USB_DT_ENDPOINT
op_logical_or
id|ep-&gt;bEndpointAddress
op_ne
id|desc-&gt;bEndpointAddress
op_logical_or
id|ep_maxpacket
c_func
(paren
id|ep
)paren
OL
id|le16_to_cpu
c_func
(paren
id|desc-&gt;wMaxPacketSize
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bad ep or descriptor&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* xfer types must match, except that interrupt ~= bulk */
r_if
c_cond
(paren
id|ep-&gt;bmAttributes
op_ne
id|desc-&gt;bmAttributes
op_logical_and
id|ep-&gt;bmAttributes
op_ne
id|USB_ENDPOINT_XFER_BULK
op_logical_and
id|desc-&gt;bmAttributes
op_ne
id|USB_ENDPOINT_XFER_INT
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, %s type mismatch&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* hardware _could_ do smaller, but driver doesn&squot;t */
r_if
c_cond
(paren
(paren
id|desc-&gt;bmAttributes
op_eq
id|USB_ENDPOINT_XFER_BULK
op_logical_and
id|le16_to_cpu
c_func
(paren
id|desc-&gt;wMaxPacketSize
)paren
op_ne
id|ep_maxpacket
c_func
(paren
id|ep
)paren
)paren
op_logical_or
op_logical_neg
id|desc-&gt;wMaxPacketSize
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bad %s maxpacket&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;driver
op_logical_or
id|dev-&gt;gadget.speed
op_eq
id|USB_SPEED_UNKNOWN
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bogus device state&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;desc
op_assign
id|desc
suffix:semicolon
id|ep-&gt;pio_irqs
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;ep.maxpacket
op_assign
id|le16_to_cpu
c_func
(paren
id|desc-&gt;wMaxPacketSize
)paren
suffix:semicolon
multiline_comment|/* Reset halt state (does flush) */
id|lh7a40x_set_halt
c_func
(paren
id|_ep
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s: enabled %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** Disable EP&n; *  NOTE: Sets INDEX register&n; */
DECL|function|lh7a40x_ep_disable
r_static
r_int
id|lh7a40x_ep_disable
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep
)paren
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|lh7a40x_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
op_logical_neg
id|ep-&gt;desc
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, %s not enabled&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep
ques
c_cond
id|ep-&gt;ep.name
suffix:colon
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|usb_set_index
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
multiline_comment|/* Nuke all pending requests (does flush) */
id|nuke
c_func
(paren
id|ep
comma
op_minus
id|ESHUTDOWN
)paren
suffix:semicolon
multiline_comment|/* Disable ep IRQ */
id|pio_irq_disable
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
id|ep-&gt;desc
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s: disabled %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lh7a40x_alloc_request
r_static
r_struct
id|usb_request
op_star
id|lh7a40x_alloc_request
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
)paren
suffix:semicolon
id|req
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|req
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|req
comma
l_int|0
comma
r_sizeof
op_star
id|req
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|req-&gt;queue
)paren
suffix:semicolon
r_return
op_amp
id|req-&gt;req
suffix:semicolon
)brace
DECL|function|lh7a40x_free_request
r_static
r_void
id|lh7a40x_free_request
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_struct
id|usb_request
op_star
id|_req
)paren
(brace
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
)paren
suffix:semicolon
id|req
op_assign
id|container_of
c_func
(paren
id|_req
comma
r_struct
id|lh7a40x_request
comma
id|req
)paren
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|req-&gt;queue
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
DECL|function|lh7a40x_alloc_buffer
r_static
r_void
op_star
id|lh7a40x_alloc_buffer
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_int
id|bytes
comma
id|dma_addr_t
op_star
id|dma
comma
r_int
id|gfp_flags
)paren
(brace
r_char
op_star
id|retval
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s (%p, %d, %d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
comma
id|bytes
comma
id|gfp_flags
)paren
suffix:semicolon
id|retval
op_assign
id|kmalloc
c_func
(paren
id|bytes
comma
id|gfp_flags
op_amp
op_complement
(paren
id|__GFP_DMA
op_or
id|__GFP_HIGHMEM
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
op_star
id|dma
op_assign
id|virt_to_bus
c_func
(paren
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|lh7a40x_free_buffer
r_static
r_void
id|lh7a40x_free_buffer
c_func
(paren
r_struct
id|usb_ep
op_star
id|ep
comma
r_void
op_star
id|buf
comma
id|dma_addr_t
id|dma
comma
r_int
id|bytes
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
multiline_comment|/** Queue one request&n; *  Kickstart transfer if needed&n; *  NOTE: Sets INDEX register&n; */
DECL|function|lh7a40x_queue
r_static
r_int
id|lh7a40x_queue
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_struct
id|usb_request
op_star
id|_req
comma
r_int
id|gfp_flags
)paren
(brace
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
r_struct
id|lh7a40x_ep
op_star
id|ep
suffix:semicolon
r_struct
id|lh7a40x_udc
op_star
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;&bslash;n&bslash;n&bslash;n%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep
)paren
suffix:semicolon
id|req
op_assign
id|container_of
c_func
(paren
id|_req
comma
r_struct
id|lh7a40x_request
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
(paren
op_logical_neg
id|_req
op_logical_or
op_logical_neg
id|_req-&gt;complete
op_logical_or
op_logical_neg
id|_req-&gt;buf
op_logical_or
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|req-&gt;queue
)paren
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bad params&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|lh7a40x_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|_ep
op_logical_or
(paren
op_logical_neg
id|ep-&gt;desc
op_logical_and
id|ep-&gt;ep.name
op_ne
id|ep0name
)paren
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bad ep&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev
op_assign
id|ep-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|dev-&gt;driver
op_logical_or
id|dev-&gt;gadget.speed
op_eq
id|USB_SPEED_UNKNOWN
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bogus device state %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;driver
)paren
suffix:semicolon
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_string|&quot;%s queue req %p, len %d buf %p&bslash;n&quot;
comma
id|_ep-&gt;name
comma
id|_req
comma
id|_req-&gt;length
comma
id|_req-&gt;buf
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|_req-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|_req-&gt;actual
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* kickstart this i/o queue? */
id|DEBUG
c_func
(paren
l_string|&quot;Add to %d Q %d %d&bslash;n&quot;
comma
id|ep_index
c_func
(paren
id|ep
)paren
comma
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
comma
id|ep-&gt;stopped
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
op_logical_and
id|likely
c_func
(paren
op_logical_neg
id|ep-&gt;stopped
)paren
)paren
(brace
id|u32
id|csr
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* EP0 */
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;queue
comma
op_amp
id|ep-&gt;queue
)paren
suffix:semicolon
id|lh7a40x_ep0_kick
c_func
(paren
id|dev
comma
id|ep
)paren
suffix:semicolon
id|req
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ep_is_in
c_func
(paren
id|ep
)paren
)paren
(brace
multiline_comment|/* EP1 &amp; EP3 */
id|usb_set_index
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep-&gt;csr1
)paren
suffix:semicolon
id|pio_irq_enable
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|csr
op_amp
id|USB_IN_CSR1_FIFO_NOT_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|write_fifo
c_func
(paren
id|ep
comma
id|req
)paren
op_eq
l_int|1
)paren
id|req
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* EP2 */
id|usb_set_index
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep-&gt;csr1
)paren
suffix:semicolon
id|pio_irq_enable
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|csr
op_amp
id|USB_OUT_CSR1_FIFO_FULL
)paren
)paren
(brace
r_if
c_cond
(paren
id|read_fifo
c_func
(paren
id|ep
comma
id|req
)paren
op_eq
l_int|1
)paren
id|req
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* pio or dma irq handler advances the queue. */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req
op_ne
l_int|0
)paren
)paren
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;queue
comma
op_amp
id|ep-&gt;queue
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* dequeue JUST ONE request */
DECL|function|lh7a40x_dequeue
r_static
r_int
id|lh7a40x_dequeue
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_struct
id|usb_request
op_star
id|_req
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
suffix:semicolon
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_ep
)paren
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|lh7a40x_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
op_logical_or
id|ep-&gt;ep.name
op_eq
id|ep0name
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* make sure it&squot;s actually queued on this endpoint */
id|list_for_each_entry
c_func
(paren
id|req
comma
op_amp
id|ep-&gt;queue
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
op_amp
id|req-&gt;req
op_eq
id|_req
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_amp
id|req-&gt;req
op_ne
id|_req
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|done
c_func
(paren
id|ep
comma
id|req
comma
op_minus
id|ECONNRESET
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** Halt specific EP&n; *  Return 0 if success&n; *  NOTE: Sets INDEX register to EP !&n; */
DECL|function|lh7a40x_set_halt
r_static
r_int
id|lh7a40x_set_halt
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
comma
r_int
id|value
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|lh7a40x_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|_ep
op_logical_or
(paren
op_logical_neg
id|ep-&gt;desc
op_logical_and
id|ep-&gt;ep.name
op_ne
id|ep0name
)paren
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bad ep&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|usb_set_index
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s, ep %d, val %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep_index
c_func
(paren
id|ep
)paren
comma
id|value
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep_index
c_func
(paren
id|ep
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* EP0 */
id|usb_set
c_func
(paren
id|EP0_SEND_STALL
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ep_is_in
c_func
(paren
id|ep
)paren
)paren
(brace
id|u32
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep-&gt;csr1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_logical_and
(paren
(paren
id|csr
op_amp
id|USB_IN_CSR1_FIFO_NOT_EMPTY
)paren
op_logical_or
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Attempts to halt IN endpoints will fail (returning -EAGAIN)&n;&t;&t;&t; * if any transfer requests are still queued, or if the controller&n;&t;&t;&t; * FIFO still holds bytes that the host hasn&#xfffd;t collected.&n;&t;&t;&t; */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG
(paren
l_string|&quot;Attempt to halt IN endpoint failed (returning -EAGAIN) %d %d&bslash;n&quot;
comma
(paren
id|csr
op_amp
id|USB_IN_CSR1_FIFO_NOT_EMPTY
)paren
comma
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|flush
c_func
(paren
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
id|usb_set
c_func
(paren
id|USB_IN_CSR1_SEND_STALL
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
r_else
(brace
id|usb_clear
c_func
(paren
id|USB_IN_CSR1_SEND_STALL
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|USB_IN_CSR1_CLR_DATA_TOGGLE
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|flush
c_func
(paren
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
id|usb_set
c_func
(paren
id|USB_OUT_CSR1_SEND_STALL
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
r_else
(brace
id|usb_clear
c_func
(paren
id|USB_OUT_CSR1_SEND_STALL
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|USB_OUT_CSR1_CLR_DATA_REG
comma
id|ep-&gt;csr1
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|value
)paren
(brace
id|ep-&gt;stopped
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|ep-&gt;stopped
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s %s halted&bslash;n&quot;
comma
id|_ep-&gt;name
comma
id|value
op_eq
l_int|0
ques
c_cond
l_string|&quot;NOT&quot;
suffix:colon
l_string|&quot;IS&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** Return bytes in EP FIFO&n; *  NOTE: Sets INDEX register to EP&n; */
DECL|function|lh7a40x_fifo_status
r_static
r_int
id|lh7a40x_fifo_status
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
)paren
(brace
id|u32
id|csr
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_struct
id|lh7a40x_ep
op_star
id|ep
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|lh7a40x_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_ep
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bad ep&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
multiline_comment|/* LPD can&squot;t report unclaimed bytes from IN fifos */
r_if
c_cond
(paren
id|ep_is_in
c_func
(paren
id|ep
)paren
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|usb_set_index
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|ep-&gt;csr1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;dev-&gt;gadget.speed
op_ne
id|USB_SPEED_UNKNOWN
op_logical_or
id|csr
op_amp
id|USB_OUT_CSR1_OUT_PKT_RDY
)paren
(brace
id|count
op_assign
id|usb_read
c_func
(paren
id|USB_OUT_FIFO_WC1
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/** Flush EP FIFO&n; *  NOTE: Sets INDEX register to EP&n; */
DECL|function|lh7a40x_fifo_flush
r_static
r_void
id|lh7a40x_fifo_flush
c_func
(paren
r_struct
id|usb_ep
op_star
id|_ep
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
suffix:semicolon
id|ep
op_assign
id|container_of
c_func
(paren
id|_ep
comma
r_struct
id|lh7a40x_ep
comma
id|ep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|_ep
op_logical_or
(paren
op_logical_neg
id|ep-&gt;desc
op_logical_and
id|ep-&gt;ep.name
op_ne
id|ep0name
)paren
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s, bad ep&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_set_index
c_func
(paren
id|ep_index
c_func
(paren
id|ep
)paren
)paren
suffix:semicolon
id|flush
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************/
multiline_comment|/* End Point 0 related functions                                */
multiline_comment|/****************************************************************/
multiline_comment|/* return:  0 = still running, 1 = completed, negative = errno */
DECL|function|write_fifo_ep0
r_static
r_int
id|write_fifo_ep0
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_struct
id|lh7a40x_request
op_star
id|req
)paren
(brace
id|u32
id|max
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|is_last
suffix:semicolon
id|max
op_assign
id|ep_maxpacket
c_func
(paren
id|ep
)paren
suffix:semicolon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|count
op_assign
id|write_packet
c_func
(paren
id|ep
comma
id|req
comma
id|max
)paren
suffix:semicolon
multiline_comment|/* last packet is usually short (or a zlp) */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|count
op_ne
id|max
)paren
)paren
id|is_last
op_assign
l_int|1
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req-&gt;req.length
op_ne
id|req-&gt;req.actual
)paren
op_logical_or
id|req-&gt;req.zero
)paren
id|is_last
op_assign
l_int|0
suffix:semicolon
r_else
id|is_last
op_assign
l_int|1
suffix:semicolon
)brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: wrote %s %d bytes%s %d left %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ep-&gt;ep.name
comma
id|count
comma
id|is_last
ques
c_cond
l_string|&quot;/L&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
comma
id|req
)paren
suffix:semicolon
multiline_comment|/* requests complete when all IN data is in the FIFO */
r_if
c_cond
(paren
id|is_last
)paren
(brace
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lh7a40x_fifo_read
r_static
id|__inline__
r_int
id|lh7a40x_fifo_read
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_int
r_char
op_star
id|cp
comma
r_int
id|max
)paren
(brace
r_int
id|bytes
suffix:semicolon
r_int
id|count
op_assign
id|usb_read
c_func
(paren
id|USB_OUT_FIFO_WC1
)paren
suffix:semicolon
r_volatile
id|u32
op_star
id|fifo
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ep-&gt;fifo
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|max
)paren
id|count
op_assign
id|max
suffix:semicolon
id|bytes
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
op_star
id|cp
op_increment
op_assign
op_star
id|fifo
op_amp
l_int|0xFF
suffix:semicolon
r_return
id|bytes
suffix:semicolon
)brace
DECL|function|lh7a40x_fifo_write
r_static
id|__inline__
r_void
id|lh7a40x_fifo_write
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_int
r_char
op_star
id|cp
comma
r_int
id|count
)paren
(brace
r_volatile
id|u32
op_star
id|fifo
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ep-&gt;fifo
suffix:semicolon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;fifo_write: %d %d&bslash;n&quot;
comma
id|ep_index
c_func
(paren
id|ep
)paren
comma
id|count
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
op_star
id|fifo
op_assign
op_star
id|cp
op_increment
suffix:semicolon
)brace
DECL|function|read_fifo_ep0
r_static
r_int
id|read_fifo_ep0
c_func
(paren
r_struct
id|lh7a40x_ep
op_star
id|ep
comma
r_struct
id|lh7a40x_request
op_star
id|req
)paren
(brace
id|u32
id|csr
suffix:semicolon
id|u8
op_star
id|buf
suffix:semicolon
r_int
id|bufferspace
comma
id|count
comma
id|is_short
suffix:semicolon
r_volatile
id|u32
op_star
id|fifo
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ep-&gt;fifo
suffix:semicolon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|USB_EP0_CSR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|csr
op_amp
id|USB_OUT_CSR1_OUT_PKT_RDY
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|buf
op_assign
id|req-&gt;req.buf
op_plus
id|req-&gt;req.actual
suffix:semicolon
id|prefetchw
c_func
(paren
id|buf
)paren
suffix:semicolon
id|bufferspace
op_assign
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
suffix:semicolon
multiline_comment|/* read all bytes from this packet */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|csr
op_amp
id|EP0_OUT_PKT_RDY
)paren
)paren
(brace
id|count
op_assign
id|usb_read
c_func
(paren
id|USB_OUT_FIFO_WC1
)paren
suffix:semicolon
id|req-&gt;req.actual
op_add_assign
id|min
c_func
(paren
id|count
comma
id|bufferspace
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* zlp */
id|count
op_assign
l_int|0
suffix:semicolon
id|is_short
op_assign
(paren
id|count
OL
id|ep-&gt;ep.maxpacket
)paren
suffix:semicolon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;read %s %02x, %d bytes%s req %p %d/%d&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|csr
comma
id|count
comma
id|is_short
ques
c_cond
l_string|&quot;/S&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|req
comma
id|req-&gt;req.actual
comma
id|req-&gt;req.length
)paren
suffix:semicolon
r_while
c_loop
(paren
id|likely
c_func
(paren
id|count
op_decrement
op_ne
l_int|0
)paren
)paren
(brace
id|u8
id|byte
op_assign
(paren
id|u8
)paren
(paren
op_star
id|fifo
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|bufferspace
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* this happens when the driver&squot;s buffer&n;&t;&t;&t; * is smaller than what the host sent.&n;&t;&t;&t; * discard the extra data.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|req-&gt;req.status
op_ne
op_minus
id|EOVERFLOW
)paren
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s overflow %d&bslash;n&quot;
comma
id|ep-&gt;ep.name
comma
id|count
)paren
suffix:semicolon
id|req-&gt;req.status
op_assign
op_minus
id|EOVERFLOW
suffix:semicolon
)brace
r_else
(brace
op_star
id|buf
op_increment
op_assign
id|byte
suffix:semicolon
id|bufferspace
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/* completion */
r_if
c_cond
(paren
id|is_short
op_logical_or
id|req-&gt;req.actual
op_eq
id|req-&gt;req.length
)paren
(brace
id|done
c_func
(paren
id|ep
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* finished that packet.  the next one may be waiting... */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * udc_set_address - set the USB address for this device&n; * @address:&n; *&n; * Called from control endpoint function after it decodes a set address setup packet.&n; */
DECL|function|udc_set_address
r_static
r_void
id|udc_set_address
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
r_int
r_char
id|address
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* c.f. 15.1.2.2 Table 15-4 address will be used after DATA_END is set */
id|dev-&gt;usb_address
op_assign
id|address
suffix:semicolon
id|usb_set
c_func
(paren
(paren
id|address
op_amp
id|USB_FA_FUNCTION_ADDR
)paren
comma
id|USB_FA
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|USB_FA_ADDR_UPDATE
op_or
(paren
id|address
op_amp
id|USB_FA_FUNCTION_ADDR
)paren
comma
id|USB_FA
)paren
suffix:semicolon
multiline_comment|/* usb_read(USB_FA); */
)brace
multiline_comment|/*&n; * DATA_STATE_RECV (OUT_PKT_RDY)&n; *      - if error&n; *              set EP0_CLR_OUT | EP0_DATA_END | EP0_SEND_STALL bits&n; *      - else&n; *              set EP0_CLR_OUT bit&n; &t;&t;&t;&t;if last set EP0_DATA_END bit&n; */
DECL|function|lh7a40x_ep0_out
r_static
r_void
id|lh7a40x_ep0_out
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
id|u32
id|csr
)paren
(brace
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
r_struct
id|lh7a40x_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|req
op_assign
l_int|0
suffix:semicolon
r_else
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|lh7a40x_request
comma
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_eq
l_int|0
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;ZERO LENGTH OUT!&bslash;n&quot;
)paren
suffix:semicolon
id|usb_set
c_func
(paren
(paren
id|EP0_CLR_OUT
op_or
id|EP0_DATA_END
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ret
op_assign
id|read_fifo_ep0
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* Done! */
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: finished, waiting for status&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_set
c_func
(paren
(paren
id|EP0_CLR_OUT
op_or
id|EP0_DATA_END
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Not done yet.. */
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: not finished&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|EP0_CLR_OUT
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;NO REQ??!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * DATA_STATE_XMIT&n; */
DECL|function|lh7a40x_ep0_in
r_static
r_int
id|lh7a40x_ep0_in
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
id|u32
id|csr
)paren
(brace
r_struct
id|lh7a40x_request
op_star
id|req
suffix:semicolon
r_struct
id|lh7a40x_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|ret
comma
id|need_zlp
op_assign
l_int|0
suffix:semicolon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;queue
)paren
)paren
id|req
op_assign
l_int|0
suffix:semicolon
r_else
id|req
op_assign
id|list_entry
c_func
(paren
id|ep-&gt;queue.next
comma
r_struct
id|lh7a40x_request
comma
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: NULL REQ&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_eq
l_int|0
)paren
(brace
id|usb_set
c_func
(paren
(paren
id|EP0_IN_PKT_RDY
op_or
id|EP0_DATA_END
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_minus
id|req-&gt;req.actual
op_eq
id|EP0_PACKETSIZE
)paren
(brace
multiline_comment|/* Next write will end with the packet size, */
multiline_comment|/* so we need Zero-length-packet */
id|need_zlp
op_assign
l_int|1
suffix:semicolon
)brace
id|ret
op_assign
id|write_fifo_ep0
c_func
(paren
id|ep
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|1
op_logical_and
op_logical_neg
id|need_zlp
)paren
(brace
multiline_comment|/* Last packet */
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: finished, waiting for status&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_set
c_func
(paren
(paren
id|EP0_IN_PKT_RDY
op_or
id|EP0_DATA_END
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
)brace
r_else
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: not finished&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|EP0_IN_PKT_RDY
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|need_zlp
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: Need ZLP!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|EP0_IN_PKT_RDY
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|DATA_STATE_NEED_ZLP
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|lh7a40x_handle_get_status
r_static
r_int
id|lh7a40x_handle_get_status
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
r_struct
id|usb_ctrlrequest
op_star
id|ctrl
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep0
op_assign
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|lh7a40x_ep
op_star
id|qep
suffix:semicolon
r_int
id|reqtype
op_assign
(paren
id|ctrl-&gt;bRequestType
op_amp
id|USB_RECIP_MASK
)paren
suffix:semicolon
id|u16
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|reqtype
op_eq
id|USB_RECIP_INTERFACE
)paren
(brace
multiline_comment|/* This is not supported.&n;&t;&t; * And according to the USB spec, this one does nothing..&n;&t;&t; * Just return 0&n;&t;&t; */
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;GET_STATUS: USB_RECIP_INTERFACE&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reqtype
op_eq
id|USB_RECIP_DEVICE
)paren
(brace
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;GET_STATUS: USB_RECIP_DEVICE&bslash;n&quot;
)paren
suffix:semicolon
id|val
op_or_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Self powered */
multiline_comment|/*val |= (1&lt;&lt;1); */
multiline_comment|/* Remote wakeup */
)brace
r_else
r_if
c_cond
(paren
id|reqtype
op_eq
id|USB_RECIP_ENDPOINT
)paren
(brace
r_int
id|ep_num
op_assign
(paren
id|ctrl-&gt;wIndex
op_amp
op_complement
id|USB_DIR_IN
)paren
suffix:semicolon
id|DEBUG_SETUP
(paren
l_string|&quot;GET_STATUS: USB_RECIP_ENDPOINT (%d), ctrl-&gt;wLength = %d&bslash;n&quot;
comma
id|ep_num
comma
id|ctrl-&gt;wLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;wLength
OG
l_int|2
op_logical_or
id|ep_num
OG
l_int|3
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|qep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|ep_num
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ep_is_in
c_func
(paren
id|qep
)paren
op_ne
(paren
(paren
id|ctrl-&gt;wIndex
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_logical_and
id|ep_index
c_func
(paren
id|qep
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|usb_set_index
c_func
(paren
id|ep_index
c_func
(paren
id|qep
)paren
)paren
suffix:semicolon
multiline_comment|/* Return status on next IN token */
r_switch
c_cond
(paren
id|qep-&gt;ep_type
)paren
(brace
r_case
id|ep_control
suffix:colon
id|val
op_assign
(paren
id|usb_read
c_func
(paren
id|qep-&gt;csr1
)paren
op_amp
id|EP0_SEND_STALL
)paren
op_eq
id|EP0_SEND_STALL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ep_bulk_in
suffix:colon
r_case
id|ep_interrupt
suffix:colon
id|val
op_assign
(paren
id|usb_read
c_func
(paren
id|qep-&gt;csr1
)paren
op_amp
id|USB_IN_CSR1_SEND_STALL
)paren
op_eq
id|USB_IN_CSR1_SEND_STALL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ep_bulk_out
suffix:colon
id|val
op_assign
(paren
id|usb_read
c_func
(paren
id|qep-&gt;csr1
)paren
op_amp
id|USB_OUT_CSR1_SEND_STALL
)paren
op_eq
id|USB_OUT_CSR1_SEND_STALL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Back to EP0 index */
id|usb_set_index
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;GET_STATUS, ep: %d (%x), val = %d&bslash;n&quot;
comma
id|ep_num
comma
id|ctrl-&gt;wIndex
comma
id|val
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;Unknown REQ TYPE: %d&bslash;n&quot;
comma
id|reqtype
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/* Clear &quot;out packet ready&quot; */
id|usb_set
c_func
(paren
(paren
id|EP0_CLR_OUT
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
multiline_comment|/* Put status to FIFO */
id|lh7a40x_fifo_write
c_func
(paren
id|ep0
comma
(paren
id|u8
op_star
)paren
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
suffix:semicolon
multiline_comment|/* Issue &quot;In packet ready&quot; */
id|usb_set
c_func
(paren
(paren
id|EP0_IN_PKT_RDY
op_or
id|EP0_DATA_END
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * WAIT_FOR_SETUP (OUT_PKT_RDY)&n; *      - read data packet from EP0 FIFO&n; *      - decode command&n; *      - if error&n; *              set EP0_CLR_OUT | EP0_DATA_END | EP0_SEND_STALL bits&n; *      - else&n; *              set EP0_CLR_OUT | EP0_DATA_END bits&n; */
DECL|function|lh7a40x_ep0_setup
r_static
r_void
id|lh7a40x_ep0_setup
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
id|u32
id|csr
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|usb_ctrlrequest
id|ctrl
suffix:semicolon
r_int
id|i
comma
id|bytes
comma
id|is_in
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;%s: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
multiline_comment|/* Nuke all previous transfers */
id|nuke
c_func
(paren
id|ep
comma
op_minus
id|EPROTO
)paren
suffix:semicolon
multiline_comment|/* read control req from fifo (8 bytes) */
id|bytes
op_assign
id|lh7a40x_fifo_read
c_func
(paren
id|ep
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|ctrl
comma
l_int|8
)paren
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;Read CTRL REQ %d bytes&bslash;n&quot;
comma
id|bytes
)paren
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;CTRL.bRequestType = %d (is_in %d)&bslash;n&quot;
comma
id|ctrl.bRequestType
comma
id|ctrl.bRequestType
op_eq
id|USB_DIR_IN
)paren
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;CTRL.bRequest = %d&bslash;n&quot;
comma
id|ctrl.bRequest
)paren
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;CTRL.wLength = %d&bslash;n&quot;
comma
id|ctrl.wLength
)paren
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;CTRL.wValue = %d (%d)&bslash;n&quot;
comma
id|ctrl.wValue
comma
id|ctrl.wValue
op_rshift
l_int|8
)paren
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;CTRL.wIndex = %d&bslash;n&quot;
comma
id|ctrl.wIndex
)paren
suffix:semicolon
multiline_comment|/* Set direction of EP0 */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|ctrl.bRequestType
op_amp
id|USB_DIR_IN
)paren
)paren
(brace
id|ep-&gt;bEndpointAddress
op_or_assign
id|USB_DIR_IN
suffix:semicolon
id|is_in
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|ep-&gt;bEndpointAddress
op_and_assign
op_complement
id|USB_DIR_IN
suffix:semicolon
id|is_in
op_assign
l_int|0
suffix:semicolon
)brace
id|dev-&gt;req_pending
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Handle some SETUP packets ourselves */
r_switch
c_cond
(paren
id|ctrl.bRequest
)paren
(brace
r_case
id|USB_REQ_SET_ADDRESS
suffix:colon
r_if
c_cond
(paren
id|ctrl.bRequestType
op_ne
(paren
id|USB_TYPE_STANDARD
op_or
id|USB_RECIP_DEVICE
)paren
)paren
r_break
suffix:semicolon
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;USB_REQ_SET_ADDRESS (%d)&bslash;n&quot;
comma
id|ctrl.wValue
)paren
suffix:semicolon
id|udc_set_address
c_func
(paren
id|dev
comma
id|ctrl.wValue
)paren
suffix:semicolon
id|usb_set
c_func
(paren
(paren
id|EP0_CLR_OUT
op_or
id|EP0_DATA_END
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|USB_REQ_GET_STATUS
suffix:colon
(brace
r_if
c_cond
(paren
id|lh7a40x_handle_get_status
c_func
(paren
id|dev
comma
op_amp
id|ctrl
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_case
id|USB_REQ_CLEAR_FEATURE
suffix:colon
r_case
id|USB_REQ_SET_FEATURE
suffix:colon
r_if
c_cond
(paren
id|ctrl.bRequestType
op_eq
id|USB_RECIP_ENDPOINT
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|qep
suffix:semicolon
r_int
id|ep_num
op_assign
(paren
id|ctrl.wIndex
op_amp
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* Support only HALT feature */
r_if
c_cond
(paren
id|ctrl.wValue
op_ne
l_int|0
op_logical_or
id|ctrl.wLength
op_ne
l_int|0
op_logical_or
id|ep_num
OG
l_int|3
op_logical_or
id|ep_num
OL
l_int|1
)paren
r_break
suffix:semicolon
id|qep
op_assign
op_amp
id|dev-&gt;ep
(braket
id|ep_num
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ctrl.bRequest
op_eq
id|USB_REQ_SET_FEATURE
)paren
(brace
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;SET_FEATURE (%d)&bslash;n&quot;
comma
id|ep_num
)paren
suffix:semicolon
id|lh7a40x_set_halt
c_func
(paren
op_amp
id|qep-&gt;ep
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG_SETUP
c_func
(paren
l_string|&quot;CLR_FEATURE (%d)&bslash;n&quot;
comma
id|ep_num
)paren
suffix:semicolon
id|lh7a40x_set_halt
c_func
(paren
op_amp
id|qep-&gt;ep
comma
l_int|0
)paren
suffix:semicolon
)brace
id|usb_set_index
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reply with a ZLP on next IN token */
id|usb_set
c_func
(paren
(paren
id|EP0_CLR_OUT
op_or
id|EP0_DATA_END
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|dev-&gt;driver
)paren
)paren
(brace
multiline_comment|/* device-2-host (IN) or no data setup command, process immediately */
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|i
op_assign
id|dev-&gt;driver
op_member_access_from_pointer
id|setup
c_func
(paren
op_amp
id|dev-&gt;gadget
comma
op_amp
id|ctrl
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
multiline_comment|/* setup processing failed, force stall */
id|DEBUG_SETUP
(paren
l_string|&quot;  --&gt; ERROR: gadget setup FAILED (stalling), setup returned %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|usb_set_index
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|usb_set
c_func
(paren
(paren
id|EP0_CLR_OUT
op_or
id|EP0_DATA_END
op_or
id|EP0_SEND_STALL
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
multiline_comment|/* ep-&gt;stopped = 1; */
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * DATA_STATE_NEED_ZLP&n; */
DECL|function|lh7a40x_ep0_in_zlp
r_static
r_void
id|lh7a40x_ep0_in_zlp
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
id|u32
id|csr
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
multiline_comment|/* c.f. Table 15-14 */
id|usb_set
c_func
(paren
(paren
id|EP0_IN_PKT_RDY
op_or
id|EP0_DATA_END
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
)brace
multiline_comment|/*&n; * handle ep0 interrupt&n; */
DECL|function|lh7a40x_handle_ep0
r_static
r_void
id|lh7a40x_handle_ep0
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
id|u32
id|intr
)paren
(brace
r_struct
id|lh7a40x_ep
op_star
id|ep
op_assign
op_amp
id|dev-&gt;ep
(braket
l_int|0
)braket
suffix:semicolon
id|u32
id|csr
suffix:semicolon
multiline_comment|/* Set index 0 */
id|usb_set_index
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|USB_EP0_CSR
)paren
suffix:semicolon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: csr = %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * For overview of what we should be doing see c.f. Chapter 18.1.2.4&n;&t; * We will follow that outline here modified by our own global state&n;&t; * indication which provides hints as to what we think should be&n;&t; * happening..&n;&t; */
multiline_comment|/*&n;&t; * if SENT_STALL is set&n;&t; *      - clear the SENT_STALL bit&n;&t; */
r_if
c_cond
(paren
id|csr
op_amp
id|EP0_SENT_STALL
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: EP0_SENT_STALL is set: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
id|usb_clear
c_func
(paren
(paren
id|EP0_SENT_STALL
op_or
id|EP0_SEND_STALL
)paren
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
id|nuke
c_func
(paren
id|ep
comma
op_minus
id|ECONNABORTED
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if a transfer is in progress &amp;&amp; IN_PKT_RDY and OUT_PKT_RDY are clear&n;&t; *      - fill EP0 FIFO&n;&t; *      - if last packet&n;&t; *      -       set IN_PKT_RDY | DATA_END&n;&t; *      - else&n;&t; *              set IN_PKT_RDY&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|csr
op_amp
(paren
id|EP0_IN_PKT_RDY
op_or
id|EP0_OUT_PKT_RDY
)paren
)paren
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: IN_PKT_RDY and OUT_PKT_RDY are clear&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;ep0state
)paren
(brace
r_case
id|DATA_STATE_XMIT
suffix:colon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;continue with DATA_STATE_XMIT&bslash;n&quot;
)paren
suffix:semicolon
id|lh7a40x_ep0_in
c_func
(paren
id|dev
comma
id|csr
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|DATA_STATE_NEED_ZLP
suffix:colon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;continue with DATA_STATE_NEED_ZLP&bslash;n&quot;
)paren
suffix:semicolon
id|lh7a40x_ep0_in_zlp
c_func
(paren
id|dev
comma
id|csr
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Stall? */
id|DEBUG_EP0
c_func
(paren
l_string|&quot;Odd state!! state = %s&bslash;n&quot;
comma
id|state_names
(braket
id|dev-&gt;ep0state
)braket
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
multiline_comment|/* nuke(ep, 0); */
multiline_comment|/* usb_set(EP0_SEND_STALL, ep-&gt;csr1); */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * if SETUP_END is set&n;&t; *      - abort the last transfer&n;&t; *      - set SERVICED_SETUP_END_BIT&n;&t; */
r_if
c_cond
(paren
id|csr
op_amp
id|EP0_SETUP_END
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: EP0_SETUP_END is set: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
id|usb_set
c_func
(paren
id|EP0_CLR_SETUP_END
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
id|nuke
c_func
(paren
id|ep
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;ep0state
op_assign
id|WAIT_FOR_SETUP
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if EP0_OUT_PKT_RDY is set&n;&t; *      - read data packet from EP0 FIFO&n;&t; *      - decode command&n;&t; *      - if error&n;&t; *              set SERVICED_OUT_PKT_RDY | DATA_END bits | SEND_STALL&n;&t; *      - else&n;&t; *              set SERVICED_OUT_PKT_RDY | DATA_END bits&n;&t; */
r_if
c_cond
(paren
id|csr
op_amp
id|EP0_OUT_PKT_RDY
)paren
(brace
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: EP0_OUT_PKT_RDY is set: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;ep0state
)paren
(brace
r_case
id|WAIT_FOR_SETUP
suffix:colon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;WAIT_FOR_SETUP&bslash;n&quot;
)paren
suffix:semicolon
id|lh7a40x_ep0_setup
c_func
(paren
id|dev
comma
id|csr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DATA_STATE_RECV
suffix:colon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;DATA_STATE_RECV&bslash;n&quot;
)paren
suffix:semicolon
id|lh7a40x_ep0_out
c_func
(paren
id|dev
comma
id|csr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* send stall? */
id|DEBUG_EP0
c_func
(paren
l_string|&quot;strange state!! 2. send stall? state = %d&bslash;n&quot;
comma
id|dev-&gt;ep0state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|lh7a40x_ep0_kick
r_static
r_void
id|lh7a40x_ep0_kick
c_func
(paren
r_struct
id|lh7a40x_udc
op_star
id|dev
comma
r_struct
id|lh7a40x_ep
op_star
id|ep
)paren
(brace
id|u32
id|csr
suffix:semicolon
id|usb_set_index
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|csr
op_assign
id|usb_read
c_func
(paren
id|USB_EP0_CSR
)paren
suffix:semicolon
id|DEBUG_EP0
c_func
(paren
l_string|&quot;%s: %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|csr
)paren
suffix:semicolon
multiline_comment|/* Clear &quot;out packet ready&quot; */
id|usb_set
c_func
(paren
id|EP0_CLR_OUT
comma
id|USB_EP0_CSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep_is_in
c_func
(paren
id|ep
)paren
)paren
(brace
id|dev-&gt;ep0state
op_assign
id|DATA_STATE_XMIT
suffix:semicolon
id|lh7a40x_ep0_in
c_func
(paren
id|dev
comma
id|csr
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;ep0state
op_assign
id|DATA_STATE_RECV
suffix:semicolon
id|lh7a40x_ep0_out
c_func
(paren
id|dev
comma
id|csr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ---------------------------------------------------------------------------&n; * &t;device-scoped parts of the api to the usb controller hardware&n; * ---------------------------------------------------------------------------&n; */
DECL|function|lh7a40x_udc_get_frame
r_static
r_int
id|lh7a40x_udc_get_frame
c_func
(paren
r_struct
id|usb_gadget
op_star
id|_gadget
)paren
(brace
id|u32
id|frame1
op_assign
id|usb_read
c_func
(paren
id|USB_FRM_NUM1
)paren
suffix:semicolon
multiline_comment|/* Least significant 8 bits */
id|u32
id|frame2
op_assign
id|usb_read
c_func
(paren
id|USB_FRM_NUM2
)paren
suffix:semicolon
multiline_comment|/* Most significant 3 bits */
id|DEBUG
c_func
(paren
l_string|&quot;%s, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_gadget
)paren
suffix:semicolon
r_return
(paren
(paren
id|frame2
op_amp
l_int|0x07
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|frame1
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
DECL|function|lh7a40x_udc_wakeup
r_static
r_int
id|lh7a40x_udc_wakeup
c_func
(paren
r_struct
id|usb_gadget
op_star
id|_gadget
)paren
(brace
multiline_comment|/* host may not have enabled remote wakeup */
multiline_comment|/*if ((UDCCS0 &amp; UDCCS0_DRWF) == 0)&n;&t;   return -EHOSTUNREACH;&n;&t;   udc_set_mask_UDCCR(UDCCR_RSM); */
r_return
op_minus
id|ENOTSUPP
suffix:semicolon
)brace
DECL|variable|lh7a40x_udc_ops
r_static
r_const
r_struct
id|usb_gadget_ops
id|lh7a40x_udc_ops
op_assign
(brace
dot
id|get_frame
op_assign
id|lh7a40x_udc_get_frame
comma
dot
id|wakeup
op_assign
id|lh7a40x_udc_wakeup
comma
multiline_comment|/* current versions must always be self-powered */
)brace
suffix:semicolon
DECL|function|nop_release
r_static
r_void
id|nop_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
)brace
DECL|variable|memory
r_static
r_struct
id|lh7a40x_udc
id|memory
op_assign
(brace
dot
id|usb_address
op_assign
l_int|0
comma
dot
id|gadget
op_assign
(brace
dot
id|ops
op_assign
op_amp
id|lh7a40x_udc_ops
comma
dot
id|ep0
op_assign
op_amp
id|memory.ep
(braket
l_int|0
)braket
dot
id|ep
comma
dot
id|name
op_assign
id|driver_name
comma
dot
id|dev
op_assign
(brace
dot
id|bus_id
op_assign
l_string|&quot;gadget&quot;
comma
dot
id|release
op_assign
id|nop_release
comma
)brace
comma
)brace
comma
multiline_comment|/* control endpoint */
dot
id|ep
(braket
l_int|0
)braket
op_assign
(brace
dot
id|ep
op_assign
(brace
dot
id|name
op_assign
id|ep0name
comma
dot
id|ops
op_assign
op_amp
id|lh7a40x_ep_ops
comma
dot
id|maxpacket
op_assign
id|EP0_PACKETSIZE
comma
)brace
comma
dot
id|dev
op_assign
op_amp
id|memory
comma
dot
id|bEndpointAddress
op_assign
l_int|0
comma
dot
id|bmAttributes
op_assign
l_int|0
comma
dot
id|ep_type
op_assign
id|ep_control
comma
dot
id|fifo
op_assign
id|io_p2v
c_func
(paren
id|USB_EP0_FIFO
)paren
comma
dot
id|csr1
op_assign
id|USB_EP0_CSR
comma
dot
id|csr2
op_assign
id|USB_EP0_CSR
comma
)brace
comma
multiline_comment|/* first group of endpoints */
dot
id|ep
(braket
l_int|1
)braket
op_assign
(brace
dot
id|ep
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ep1in-bulk&quot;
comma
dot
id|ops
op_assign
op_amp
id|lh7a40x_ep_ops
comma
dot
id|maxpacket
op_assign
l_int|64
comma
)brace
comma
dot
id|dev
op_assign
op_amp
id|memory
comma
dot
id|bEndpointAddress
op_assign
id|USB_DIR_IN
op_or
l_int|1
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
dot
id|ep_type
op_assign
id|ep_bulk_in
comma
dot
id|fifo
op_assign
id|io_p2v
c_func
(paren
id|USB_EP1_FIFO
)paren
comma
dot
id|csr1
op_assign
id|USB_IN_CSR1
comma
dot
id|csr2
op_assign
id|USB_IN_CSR2
comma
)brace
comma
dot
id|ep
(braket
l_int|2
)braket
op_assign
(brace
dot
id|ep
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ep2out-bulk&quot;
comma
dot
id|ops
op_assign
op_amp
id|lh7a40x_ep_ops
comma
dot
id|maxpacket
op_assign
l_int|64
comma
)brace
comma
dot
id|dev
op_assign
op_amp
id|memory
comma
dot
id|bEndpointAddress
op_assign
l_int|2
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_BULK
comma
dot
id|ep_type
op_assign
id|ep_bulk_out
comma
dot
id|fifo
op_assign
id|io_p2v
c_func
(paren
id|USB_EP2_FIFO
)paren
comma
dot
id|csr1
op_assign
id|USB_OUT_CSR1
comma
dot
id|csr2
op_assign
id|USB_OUT_CSR2
comma
)brace
comma
dot
id|ep
(braket
l_int|3
)braket
op_assign
(brace
dot
id|ep
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ep3in-int&quot;
comma
dot
id|ops
op_assign
op_amp
id|lh7a40x_ep_ops
comma
dot
id|maxpacket
op_assign
l_int|64
comma
)brace
comma
dot
id|dev
op_assign
op_amp
id|memory
comma
dot
id|bEndpointAddress
op_assign
id|USB_DIR_IN
op_or
l_int|3
comma
dot
id|bmAttributes
op_assign
id|USB_ENDPOINT_XFER_INT
comma
dot
id|ep_type
op_assign
id|ep_interrupt
comma
dot
id|fifo
op_assign
id|io_p2v
c_func
(paren
id|USB_EP3_FIFO
)paren
comma
dot
id|csr1
op_assign
id|USB_IN_CSR1
comma
dot
id|csr2
op_assign
id|USB_IN_CSR2
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * &t;probe - binds to the platform device&n; */
DECL|function|lh7a40x_udc_probe
r_static
r_int
id|lh7a40x_udc_probe
c_func
(paren
r_struct
id|device
op_star
id|_dev
)paren
(brace
r_struct
id|lh7a40x_udc
op_star
id|dev
op_assign
op_amp
id|memory
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s: %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|_dev
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;dev
op_assign
id|_dev
suffix:semicolon
id|device_initialize
c_func
(paren
op_amp
id|dev-&gt;gadget.dev
)paren
suffix:semicolon
id|dev-&gt;gadget.dev.parent
op_assign
id|_dev
suffix:semicolon
id|the_controller
op_assign
id|dev
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|_dev
comma
id|dev
)paren
suffix:semicolon
id|udc_disable
c_func
(paren
id|dev
)paren
suffix:semicolon
id|udc_reinit
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* irq setup after old hardware state is cleaned up */
id|retval
op_assign
id|request_irq
c_func
(paren
id|IRQ_USBINTR
comma
id|lh7a40x_udc_irq
comma
id|SA_INTERRUPT
comma
id|driver_name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t get irq %i, err %d&bslash;n&quot;
comma
id|driver_name
comma
id|IRQ_USBINTR
comma
id|retval
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|create_proc_files
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|lh7a40x_udc_remove
r_static
r_int
id|lh7a40x_udc_remove
c_func
(paren
r_struct
id|device
op_star
id|_dev
)paren
(brace
r_struct
id|lh7a40x_udc
op_star
id|dev
op_assign
id|_dev-&gt;driver_data
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;%s: %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
id|udc_disable
c_func
(paren
id|dev
)paren
suffix:semicolon
id|remove_proc_files
c_func
(paren
)paren
suffix:semicolon
id|usb_gadget_unregister_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_USBINTR
comma
id|dev
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|_dev
comma
l_int|0
)paren
suffix:semicolon
id|the_controller
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|udc_driver
r_static
r_struct
id|device_driver
id|udc_driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
id|driver_name
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|lh7a40x_udc_probe
comma
dot
id|remove
op_assign
id|lh7a40x_udc_remove
multiline_comment|/* FIXME power management support */
multiline_comment|/* .suspend = ... disable UDC */
multiline_comment|/* .resume = ... re-enable UDC */
)brace
suffix:semicolon
DECL|function|udc_init
r_static
r_int
id|__init
id|udc_init
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;%s: %s version %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|driver_name
comma
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
id|driver_register
c_func
(paren
op_amp
id|udc_driver
)paren
suffix:semicolon
)brace
DECL|function|udc_exit
r_static
r_void
id|__exit
id|udc_exit
c_func
(paren
r_void
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|udc_driver
)paren
suffix:semicolon
)brace
DECL|variable|udc_init
id|module_init
c_func
(paren
id|udc_init
)paren
suffix:semicolon
DECL|variable|udc_exit
id|module_exit
c_func
(paren
id|udc_exit
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Mikko Lahteenmaki, Bo Henriksen&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
