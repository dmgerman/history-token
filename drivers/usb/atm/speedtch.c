multiline_comment|/******************************************************************************&n; *  speedtch.c  -  Alcatel SpeedTouch USB xDSL modem driver&n; *&n; *  Copyright (C) 2001, Alcatel&n; *  Copyright (C) 2003, Duncan Sands&n; *  Copyright (C) 2004, David Woodhouse&n; *&n; *  This program is free software; you can redistribute it and/or modify it&n; *  under the terms of the GNU General Public License as published by the Free&n; *  Software Foundation; either version 2 of the License, or (at your option)&n; *  any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for&n; *  more details.&n; *&n; *  You should have received a copy of the GNU General Public License along with&n; *  this program; if not, write to the Free Software Foundation, Inc., 59&n; *  Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n; *&n; ******************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/gfp.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/atm.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/firmware.h&gt;
macro_line|#include &quot;usb_atm.h&quot;
multiline_comment|/*&n;#define DEBUG&n;#define VERBOSE_DEBUG&n;*/
macro_line|#if !defined (DEBUG) &amp;&amp; defined (CONFIG_USB_DEBUG)
DECL|macro|DEBUG
macro_line|#&t;define DEBUG
macro_line|#endif
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#if defined(CONFIG_FW_LOADER) || defined(CONFIG_FW_LOADER_MODULE)
DECL|macro|USE_FW_LOADER
macro_line|#&t;define USE_FW_LOADER
macro_line|#endif
macro_line|#ifdef VERBOSE_DEBUG
r_static
r_int
id|udsl_print_packet
c_func
(paren
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
DECL|macro|PACKETDEBUG
mdefine_line|#define PACKETDEBUG(arg...)&t;udsl_print_packet (arg)
DECL|macro|vdbg
mdefine_line|#define vdbg(arg...)&t;&t;dbg (arg)
macro_line|#else
DECL|macro|PACKETDEBUG
mdefine_line|#define PACKETDEBUG(arg...)
DECL|macro|vdbg
mdefine_line|#define vdbg(arg...)
macro_line|#endif
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Johan Verrept, Duncan Sands &lt;duncan.sands@free.fr&gt;&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;1.8&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;Alcatel SpeedTouch USB driver version &quot; DRIVER_VERSION
DECL|variable|speedtch_driver_name
r_static
r_const
r_char
id|speedtch_driver_name
(braket
)braket
op_assign
l_string|&quot;speedtch&quot;
suffix:semicolon
DECL|macro|SPEEDTOUCH_VENDORID
mdefine_line|#define SPEEDTOUCH_VENDORID&t;&t;0x06b9
DECL|macro|SPEEDTOUCH_PRODUCTID
mdefine_line|#define SPEEDTOUCH_PRODUCTID&t;&t;0x4061
multiline_comment|/* Timeout in jiffies */
DECL|macro|CTRL_TIMEOUT
mdefine_line|#define CTRL_TIMEOUT (2*HZ)
DECL|macro|DATA_TIMEOUT
mdefine_line|#define DATA_TIMEOUT (2*HZ)
DECL|macro|OFFSET_7
mdefine_line|#define OFFSET_7  0&t;&t;/* size 1 */
DECL|macro|OFFSET_b
mdefine_line|#define OFFSET_b  1&t;&t;/* size 8 */
DECL|macro|OFFSET_d
mdefine_line|#define OFFSET_d  9&t;&t;/* size 4 */
DECL|macro|OFFSET_e
mdefine_line|#define OFFSET_e 13&t;&t;/* size 1 */
DECL|macro|OFFSET_f
mdefine_line|#define OFFSET_f 14&t;&t;/* size 1 */
DECL|macro|TOTAL
mdefine_line|#define TOTAL    15
DECL|macro|SIZE_7
mdefine_line|#define SIZE_7 1
DECL|macro|SIZE_b
mdefine_line|#define SIZE_b 8
DECL|macro|SIZE_d
mdefine_line|#define SIZE_d 4
DECL|macro|SIZE_e
mdefine_line|#define SIZE_e 1
DECL|macro|SIZE_f
mdefine_line|#define SIZE_f 1
DECL|variable|dl_512_first
r_static
r_int
id|dl_512_first
op_assign
l_int|0
suffix:semicolon
DECL|variable|sw_buffering
r_static
r_int
id|sw_buffering
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|dl_512_first
comma
r_bool
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dl_512_first
comma
l_string|&quot;Read 512 bytes before sending firmware&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|sw_buffering
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|sw_buffering
comma
l_string|&quot;Enable software buffering&quot;
)paren
suffix:semicolon
DECL|macro|UDSL_IOCTL_LINE_UP
mdefine_line|#define UDSL_IOCTL_LINE_UP&t;&t;1
DECL|macro|UDSL_IOCTL_LINE_DOWN
mdefine_line|#define UDSL_IOCTL_LINE_DOWN&t;&t;2
DECL|macro|SPEEDTCH_ENDPOINT_INT
mdefine_line|#define SPEEDTCH_ENDPOINT_INT&t;&t;0x81
DECL|macro|SPEEDTCH_ENDPOINT_DATA
mdefine_line|#define SPEEDTCH_ENDPOINT_DATA&t;&t;0x07
DECL|macro|SPEEDTCH_ENDPOINT_FIRMWARE
mdefine_line|#define SPEEDTCH_ENDPOINT_FIRMWARE&t;0x05
DECL|macro|hex2int
mdefine_line|#define hex2int(c) ( (c &gt;= &squot;0&squot;) &amp;&amp; (c &lt;= &squot;9&squot;) ? (c - &squot;0&squot;) : ((c &amp; 0xf) + 9) )
DECL|variable|speedtch_usb_ids
r_static
r_struct
id|usb_device_id
id|speedtch_usb_ids
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|SPEEDTOUCH_VENDORID
comma
id|SPEEDTOUCH_PRODUCTID
)paren
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|usb
comma
id|speedtch_usb_ids
)paren
suffix:semicolon
DECL|struct|speedtch_instance_data
r_struct
id|speedtch_instance_data
(brace
DECL|member|u
r_struct
id|udsl_instance_data
id|u
suffix:semicolon
multiline_comment|/* Status */
DECL|member|int_urb
r_struct
id|urb
op_star
id|int_urb
suffix:semicolon
DECL|member|int_data
r_int
r_char
id|int_data
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|poll_work
r_struct
id|work_struct
id|poll_work
suffix:semicolon
DECL|member|poll_timer
r_struct
id|timer_list
id|poll_timer
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* USB */
r_static
r_int
id|speedtch_usb_probe
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_void
id|speedtch_usb_disconnect
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
suffix:semicolon
r_static
r_int
id|speedtch_usb_ioctl
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_int
r_int
id|code
comma
r_void
op_star
id|user_data
)paren
suffix:semicolon
r_static
r_void
id|speedtch_handle_int
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|speedtch_poll_status
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
)paren
suffix:semicolon
DECL|variable|speedtch_usb_driver
r_static
r_struct
id|usb_driver
id|speedtch_usb_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|speedtch_driver_name
comma
dot
id|probe
op_assign
id|speedtch_usb_probe
comma
dot
id|disconnect
op_assign
id|speedtch_usb_disconnect
comma
dot
id|ioctl
op_assign
id|speedtch_usb_ioctl
comma
dot
id|id_table
op_assign
id|speedtch_usb_ids
comma
)brace
suffix:semicolon
multiline_comment|/***************&n;**  firmware  **&n;***************/
DECL|function|speedtch_got_firmware
r_static
r_void
id|speedtch_got_firmware
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
comma
r_int
id|got_it
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|usb_interface
op_star
id|intf
suffix:semicolon
id|down
c_func
(paren
op_amp
id|instance-&gt;u.serialize
)paren
suffix:semicolon
multiline_comment|/* vs self, speedtch_firmware_start */
r_if
c_cond
(paren
id|instance-&gt;u.status
op_eq
id|UDSL_LOADED_FIRMWARE
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|got_it
)paren
(brace
id|instance-&gt;u.status
op_assign
id|UDSL_NO_FIRMWARE
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_set_interface
c_func
(paren
id|instance-&gt;u.usb_dev
comma
l_int|1
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_got_firmware: usb_set_interface returned %d!&quot;
comma
id|err
)paren
suffix:semicolon
id|instance-&gt;u.status
op_assign
id|UDSL_NO_FIRMWARE
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Set up interrupt endpoint */
id|intf
op_assign
id|usb_ifnum_to_if
c_func
(paren
id|instance-&gt;u.usb_dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intf
op_logical_and
op_logical_neg
id|usb_driver_claim_interface
c_func
(paren
op_amp
id|speedtch_usb_driver
comma
id|intf
comma
l_int|NULL
)paren
)paren
(brace
id|instance-&gt;int_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|instance-&gt;int_urb
)paren
(brace
id|usb_fill_int_urb
c_func
(paren
id|instance-&gt;int_urb
comma
id|instance-&gt;u.usb_dev
comma
id|usb_rcvintpipe
c_func
(paren
id|instance-&gt;u.usb_dev
comma
id|SPEEDTCH_ENDPOINT_INT
)paren
comma
id|instance-&gt;int_data
comma
r_sizeof
(paren
id|instance-&gt;int_data
)paren
comma
id|speedtch_handle_int
comma
id|instance
comma
l_int|50
)paren
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|instance-&gt;int_urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
multiline_comment|/* Doesn&squot;t matter; we&squot;ll poll anyway */
id|dbg
c_func
(paren
l_string|&quot;speedtch_got_firmware: Submission of interrupt URB failed %d&quot;
comma
id|err
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|instance-&gt;int_urb
)paren
suffix:semicolon
id|instance-&gt;int_urb
op_assign
l_int|NULL
suffix:semicolon
id|usb_driver_release_interface
c_func
(paren
op_amp
id|speedtch_usb_driver
comma
id|intf
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Start status polling */
id|mod_timer
c_func
(paren
op_amp
id|instance-&gt;poll_timer
comma
id|jiffies
op_plus
(paren
l_int|1
op_star
id|HZ
)paren
)paren
suffix:semicolon
id|instance-&gt;u.status
op_assign
id|UDSL_LOADED_FIRMWARE
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|instance-&gt;u.receive_tasklet
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|instance-&gt;u.serialize
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|instance-&gt;u.firmware_waiters
)paren
suffix:semicolon
)brace
DECL|function|speedtch_set_swbuff
r_static
r_int
id|speedtch_set_swbuff
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
comma
r_int
id|state
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|instance-&gt;u.usb_dev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x32
comma
l_int|0x40
comma
id|state
ques
c_cond
l_int|0x01
suffix:colon
l_int|0x00
comma
l_int|0x00
comma
l_int|NULL
comma
l_int|0
comma
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Warning: %sabling SW buffering: usb_control_msg returned %d&bslash;n&quot;
comma
id|state
ques
c_cond
l_string|&quot;En&quot;
suffix:colon
l_string|&quot;Dis&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_set_swbuff: %sbled SW buffering&quot;
comma
id|state
ques
c_cond
l_string|&quot;En&quot;
suffix:colon
l_string|&quot;Dis&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|speedtch_test_sequence
r_static
r_void
id|speedtch_test_sequence
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|instance-&gt;u.usb_dev
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|10
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* URB 147 */
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x1c
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x50
suffix:semicolon
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x01
comma
l_int|0x40
comma
l_int|0x0b
comma
l_int|0x00
comma
id|buf
comma
l_int|2
comma
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s failed on URB147: %d&bslash;n&quot;
comma
id|__func__
comma
id|ret
)paren
suffix:semicolon
multiline_comment|/* URB 148 */
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x32
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x01
comma
l_int|0x40
comma
l_int|0x02
comma
l_int|0x00
comma
id|buf
comma
l_int|2
comma
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s failed on URB148: %d&bslash;n&quot;
comma
id|__func__
comma
id|ret
)paren
suffix:semicolon
multiline_comment|/* URB 149 */
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0x01
suffix:semicolon
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x01
comma
l_int|0x40
comma
l_int|0x03
comma
l_int|0x00
comma
id|buf
comma
l_int|3
comma
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s failed on URB149: %d&bslash;n&quot;
comma
id|__func__
comma
id|ret
)paren
suffix:semicolon
multiline_comment|/* URB 150 */
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0x01
suffix:semicolon
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x01
comma
l_int|0x40
comma
l_int|0x04
comma
l_int|0x00
comma
id|buf
comma
l_int|3
comma
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s failed on URB150: %d&bslash;n&quot;
comma
id|__func__
comma
id|ret
)paren
suffix:semicolon
)brace
DECL|function|speedtch_start_synchro
r_static
r_int
id|speedtch_start_synchro
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|instance-&gt;u.usb_dev
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x12
comma
l_int|0xc0
comma
l_int|0x04
comma
l_int|0x00
comma
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|CTRL_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SpeedTouch: Failed to start ADSL synchronisation: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_start_synchro: modem prodded. %d Bytes returned: %02x %02x&quot;
comma
id|ret
comma
id|buf
(braket
l_int|0
)braket
comma
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|speedtch_handle_int
r_static
r_void
id|speedtch_handle_int
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|speedtch_instance_data
op_star
id|instance
op_assign
id|urb-&gt;context
suffix:semicolon
r_int
r_int
id|count
op_assign
id|urb-&gt;actual_length
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* The magic interrupt for &quot;up state&quot; */
r_const
r_static
r_int
r_char
id|up_int
(braket
l_int|6
)braket
op_assign
(brace
l_int|0xa1
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
multiline_comment|/* The magic interrupt for &quot;down state&quot; */
r_const
r_static
r_int
r_char
id|down_int
(braket
l_int|6
)braket
op_assign
(brace
l_int|0xa1
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* success */
r_break
suffix:semicolon
r_case
op_minus
id|ECONNRESET
suffix:colon
r_case
op_minus
id|ENOENT
suffix:colon
r_case
op_minus
id|ESHUTDOWN
suffix:colon
multiline_comment|/* this urb is terminated; clean up */
id|dbg
c_func
(paren
l_string|&quot;%s - urb shutting down with status: %d&quot;
comma
id|__func__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero urb status received: %d&quot;
comma
id|__func__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
l_int|6
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - int packet too short&quot;
comma
id|__func__
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|up_int
comma
id|instance-&gt;int_data
comma
l_int|6
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|instance-&gt;poll_timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;DSL line goes up&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|down_int
comma
id|instance-&gt;int_data
comma
l_int|6
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;DSL line goes down&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Unknown interrupt packet of %d bytes:&quot;
comma
id|count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|instance-&gt;int_data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|schedule_work
c_func
(paren
op_amp
id|instance-&gt;poll_work
)paren
suffix:semicolon
m_exit
suffix:colon
id|rmb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;int_urb
)paren
r_return
suffix:semicolon
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|err
c_func
(paren
l_string|&quot;%s - usb_submit_urb failed with result %d&quot;
comma
id|__func__
comma
id|ret
)paren
suffix:semicolon
)brace
DECL|function|speedtch_get_status
r_static
r_int
id|speedtch_get_status
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
comma
r_int
r_char
op_star
id|buf
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|instance-&gt;u.usb_dev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
id|TOTAL
)paren
suffix:semicolon
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x12
comma
l_int|0xc0
comma
l_int|0x07
comma
l_int|0x00
comma
id|buf
op_plus
id|OFFSET_7
comma
id|SIZE_7
comma
id|CTRL_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;MSG 7 failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x12
comma
l_int|0xc0
comma
l_int|0x0b
comma
l_int|0x00
comma
id|buf
op_plus
id|OFFSET_b
comma
id|SIZE_b
comma
id|CTRL_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;MSG B failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x12
comma
l_int|0xc0
comma
l_int|0x0d
comma
l_int|0x00
comma
id|buf
op_plus
id|OFFSET_d
comma
id|SIZE_d
comma
id|CTRL_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;MSG D failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x01
comma
l_int|0xc0
comma
l_int|0x0e
comma
l_int|0x00
comma
id|buf
op_plus
id|OFFSET_e
comma
id|SIZE_e
comma
id|CTRL_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;MSG E failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x01
comma
l_int|0xc0
comma
l_int|0x0f
comma
l_int|0x00
comma
id|buf
op_plus
id|OFFSET_f
comma
id|SIZE_f
comma
id|CTRL_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;MSG F failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|speedtch_poll_status
r_static
r_void
id|speedtch_poll_status
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
)paren
(brace
r_int
r_char
id|buf
(braket
id|TOTAL
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|speedtch_get_status
c_func
(paren
id|instance
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SpeedTouch: Error %d fetching device status&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Line state %02x&quot;
comma
id|buf
(braket
id|OFFSET_7
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|buf
(braket
id|OFFSET_7
)braket
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|instance-&gt;u.atm_dev-&gt;signal
op_ne
id|ATM_PHY_SIG_LOST
)paren
(brace
id|instance-&gt;u.atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ADSL line is down&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
r_if
c_cond
(paren
id|instance-&gt;u.atm_dev-&gt;signal
op_ne
id|ATM_PHY_SIG_UNKNOWN
)paren
(brace
id|instance-&gt;u.atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_UNKNOWN
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ADSL line is blocked?&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
r_if
c_cond
(paren
id|instance-&gt;u.atm_dev-&gt;signal
op_ne
id|ATM_PHY_SIG_LOST
)paren
(brace
id|instance-&gt;u.atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ADSL line is synchronising&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
r_if
c_cond
(paren
id|instance-&gt;u.atm_dev-&gt;signal
op_ne
id|ATM_PHY_SIG_FOUND
)paren
(brace
r_int
id|down_speed
op_assign
id|buf
(braket
id|OFFSET_b
)braket
op_or
(paren
id|buf
(braket
id|OFFSET_b
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|buf
(braket
id|OFFSET_b
op_plus
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|buf
(braket
id|OFFSET_b
op_plus
l_int|3
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
r_int
id|up_speed
op_assign
id|buf
(braket
id|OFFSET_b
op_plus
l_int|4
)braket
op_or
(paren
id|buf
(braket
id|OFFSET_b
op_plus
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|buf
(braket
id|OFFSET_b
op_plus
l_int|6
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|buf
(braket
id|OFFSET_b
op_plus
l_int|7
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|down_speed
op_amp
l_int|0x0000ffff
)paren
op_logical_and
op_logical_neg
(paren
id|up_speed
op_amp
l_int|0x0000ffff
)paren
)paren
(brace
id|down_speed
op_rshift_assign
l_int|16
suffix:semicolon
id|up_speed
op_rshift_assign
l_int|16
suffix:semicolon
)brace
id|instance-&gt;u.atm_dev-&gt;link_rate
op_assign
id|down_speed
op_star
l_int|1000
op_div
l_int|424
suffix:semicolon
id|instance-&gt;u.atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_FOUND
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ADSL line is up (%d Kib/s down | %d Kib/s up)&bslash;n&quot;
comma
id|down_speed
comma
id|up_speed
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|instance-&gt;u.atm_dev-&gt;signal
op_ne
id|ATM_PHY_SIG_UNKNOWN
)paren
(brace
id|instance-&gt;u.atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_UNKNOWN
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown line state %02x&bslash;n&quot;
comma
id|buf
(braket
id|OFFSET_7
)braket
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
DECL|function|speedtch_timer_poll
r_static
r_void
id|speedtch_timer_poll
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|speedtch_instance_data
op_star
id|instance
op_assign
(paren
r_void
op_star
)paren
id|data
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|instance-&gt;poll_work
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|instance-&gt;poll_timer
comma
id|jiffies
op_plus
(paren
l_int|5
op_star
id|HZ
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef USE_FW_LOADER
DECL|function|speedtch_upload_firmware
r_static
r_void
id|speedtch_upload_firmware
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
comma
r_const
r_struct
id|firmware
op_star
id|fw1
comma
r_const
r_struct
id|firmware
op_star
id|fw2
)paren
(brace
r_int
r_char
op_star
id|buffer
suffix:semicolon
r_struct
id|usb_device
op_star
id|usb_dev
op_assign
id|instance-&gt;u.usb_dev
suffix:semicolon
r_struct
id|usb_interface
op_star
id|intf
suffix:semicolon
r_int
id|actual_length
comma
id|ret
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|intf
op_assign
id|usb_ifnum_to_if
c_func
(paren
id|usb_dev
comma
l_int|2
)paren
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: interface not found!&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|buffer
op_assign
(paren
r_int
r_char
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: no memory for buffer!&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* A user-space firmware loader may already have claimed interface #2 */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_driver_claim_interface
c_func
(paren
op_amp
id|speedtch_usb_driver
comma
id|intf
comma
l_int|NULL
)paren
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: interface in use (%d)!&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|fail_free
suffix:semicolon
)brace
multiline_comment|/* URB 7 */
r_if
c_cond
(paren
id|dl_512_first
)paren
(brace
multiline_comment|/* some modems need a read before writing the firmware */
id|ret
op_assign
id|usb_bulk_msg
c_func
(paren
id|usb_dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|usb_dev
comma
id|SPEEDTCH_ENDPOINT_FIRMWARE
)paren
comma
id|buffer
comma
l_int|0x200
comma
op_amp
id|actual_length
comma
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
op_logical_and
id|ret
op_ne
op_minus
id|ETIMEDOUT
)paren
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: read BLOCK0 from modem failed (%d)!&quot;
comma
id|ret
)paren
suffix:semicolon
r_else
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: BLOCK0 downloaded (%d bytes)&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/* URB 8 : both leds are static green */
r_for
c_loop
(paren
id|offset
op_assign
l_int|0
suffix:semicolon
id|offset
OL
id|fw1-&gt;size
suffix:semicolon
id|offset
op_add_assign
id|PAGE_SIZE
)paren
(brace
r_int
id|thislen
op_assign
id|min_t
c_func
(paren
r_int
comma
id|PAGE_SIZE
comma
id|fw1-&gt;size
op_minus
id|offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|fw1-&gt;data
op_plus
id|offset
comma
id|thislen
)paren
suffix:semicolon
id|ret
op_assign
id|usb_bulk_msg
c_func
(paren
id|usb_dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|usb_dev
comma
id|SPEEDTCH_ENDPOINT_FIRMWARE
)paren
comma
id|buffer
comma
id|thislen
comma
op_amp
id|actual_length
comma
id|DATA_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: write BLOCK1 to modem failed (%d)!&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|fail_release
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: BLOCK1 uploaded (%d bytes)&quot;
comma
id|fw1-&gt;size
)paren
suffix:semicolon
)brace
multiline_comment|/* USB led blinking green, ADSL led off */
multiline_comment|/* URB 11 */
id|ret
op_assign
id|usb_bulk_msg
c_func
(paren
id|usb_dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|usb_dev
comma
id|SPEEDTCH_ENDPOINT_FIRMWARE
)paren
comma
id|buffer
comma
l_int|0x200
comma
op_amp
id|actual_length
comma
id|DATA_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: read BLOCK2 from modem failed (%d)!&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|fail_release
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: BLOCK2 downloaded (%d bytes)&quot;
comma
id|actual_length
)paren
suffix:semicolon
multiline_comment|/* URBs 12 to 139 - USB led blinking green, ADSL led off */
r_for
c_loop
(paren
id|offset
op_assign
l_int|0
suffix:semicolon
id|offset
OL
id|fw2-&gt;size
suffix:semicolon
id|offset
op_add_assign
id|PAGE_SIZE
)paren
(brace
r_int
id|thislen
op_assign
id|min_t
c_func
(paren
r_int
comma
id|PAGE_SIZE
comma
id|fw2-&gt;size
op_minus
id|offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|fw2-&gt;data
op_plus
id|offset
comma
id|thislen
)paren
suffix:semicolon
id|ret
op_assign
id|usb_bulk_msg
c_func
(paren
id|usb_dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|usb_dev
comma
id|SPEEDTCH_ENDPOINT_FIRMWARE
)paren
comma
id|buffer
comma
id|thislen
comma
op_amp
id|actual_length
comma
id|DATA_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: write BLOCK3 to modem failed (%d)!&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|fail_release
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: BLOCK3 uploaded (%d bytes)&quot;
comma
id|fw2-&gt;size
)paren
suffix:semicolon
multiline_comment|/* USB led static green, ADSL led static red */
multiline_comment|/* URB 142 */
id|ret
op_assign
id|usb_bulk_msg
c_func
(paren
id|usb_dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|usb_dev
comma
id|SPEEDTCH_ENDPOINT_FIRMWARE
)paren
comma
id|buffer
comma
l_int|0x200
comma
op_amp
id|actual_length
comma
id|DATA_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: read BLOCK4 from modem failed (%d)!&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|fail_release
suffix:semicolon
)brace
multiline_comment|/* success */
id|dbg
c_func
(paren
l_string|&quot;speedtch_upload_firmware: BLOCK4 downloaded (%d bytes)&quot;
comma
id|actual_length
)paren
suffix:semicolon
multiline_comment|/* Delay to allow firmware to start up. We can do this here&n;&t;   because we&squot;re in our own kernel thread anyway. */
id|msleep
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* Enable software buffering, if requested */
r_if
c_cond
(paren
id|sw_buffering
)paren
id|speedtch_set_swbuff
c_func
(paren
id|instance
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Magic spell; don&squot;t ask us what this does */
id|speedtch_test_sequence
c_func
(paren
id|instance
)paren
suffix:semicolon
multiline_comment|/* Start modem synchronisation */
r_if
c_cond
(paren
id|speedtch_start_synchro
c_func
(paren
id|instance
)paren
)paren
id|dbg
c_func
(paren
l_string|&quot;speedtch_start_synchro: failed&bslash;n&quot;
)paren
suffix:semicolon
id|speedtch_got_firmware
c_func
(paren
id|instance
comma
l_int|1
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|buffer
)paren
suffix:semicolon
r_return
suffix:semicolon
id|fail_release
suffix:colon
multiline_comment|/* Only release interface #2 if uploading failed; we don&squot;t release it&n;&t;   we succeeded.  This prevents the userspace tools from trying to load&n;&t;   the firmware themselves */
id|usb_driver_release_interface
c_func
(paren
op_amp
id|speedtch_usb_driver
comma
id|intf
)paren
suffix:semicolon
id|fail_free
suffix:colon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|fail
suffix:colon
id|speedtch_got_firmware
c_func
(paren
id|instance
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|speedtch_find_firmware
r_static
r_int
id|speedtch_find_firmware
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
comma
r_int
id|phase
comma
r_const
r_struct
id|firmware
op_star
op_star
id|fw_p
)paren
(brace
r_char
id|buf
(braket
l_int|24
)braket
suffix:semicolon
r_const
id|u16
id|bcdDevice
op_assign
id|instance-&gt;u.usb_dev-&gt;descriptor.bcdDevice
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;speedtch-%d.bin.%x.%02x&quot;
comma
id|phase
comma
id|bcdDevice
op_rshift
l_int|8
comma
id|bcdDevice
op_amp
l_int|0xff
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;speedtch_find_firmware: looking for %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_firmware
c_func
(paren
id|fw_p
comma
id|buf
comma
op_amp
id|instance-&gt;u.usb_dev-&gt;dev
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;speedtch-%d.bin.%x&quot;
comma
id|phase
comma
id|bcdDevice
op_rshift
l_int|8
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;speedtch_find_firmware: looking for %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_firmware
c_func
(paren
id|fw_p
comma
id|buf
comma
op_amp
id|instance-&gt;u.usb_dev-&gt;dev
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;speedtch-%d.bin&quot;
comma
id|phase
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;speedtch_find_firmware: looking for %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_firmware
c_func
(paren
id|fw_p
comma
id|buf
comma
op_amp
id|instance-&gt;u.usb_dev-&gt;dev
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|dev_warn
c_func
(paren
op_amp
id|instance-&gt;u.usb_dev-&gt;dev
comma
l_string|&quot;no stage %d firmware found!&quot;
comma
id|phase
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
DECL|function|speedtch_load_firmware
r_static
r_int
id|speedtch_load_firmware
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_const
r_struct
id|firmware
op_star
id|fw1
comma
op_star
id|fw2
suffix:semicolon
r_struct
id|speedtch_instance_data
op_star
id|instance
op_assign
id|arg
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|instance
)paren
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;firmware/speedtch&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|speedtch_find_firmware
c_func
(paren
id|instance
comma
l_int|1
comma
op_amp
id|fw1
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|speedtch_find_firmware
c_func
(paren
id|instance
comma
l_int|2
comma
op_amp
id|fw2
)paren
)paren
(brace
id|speedtch_upload_firmware
c_func
(paren
id|instance
comma
id|fw1
comma
id|fw2
)paren
suffix:semicolon
id|release_firmware
c_func
(paren
id|fw2
)paren
suffix:semicolon
)brace
id|release_firmware
c_func
(paren
id|fw1
)paren
suffix:semicolon
)brace
multiline_comment|/* In case we failed, set state back to NO_FIRMWARE so that&n;&t;   another later attempt may work. Otherwise, we never actually&n;&t;   manage to recover if, for example, the firmware is on /usr and&n;&t;   we look for it too early. */
id|speedtch_got_firmware
c_func
(paren
id|instance
comma
l_int|0
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
id|udsl_put_instance
c_func
(paren
op_amp
id|instance-&gt;u
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* USE_FW_LOADER */
DECL|function|speedtch_firmware_start
r_static
r_void
id|speedtch_firmware_start
c_func
(paren
r_struct
id|speedtch_instance_data
op_star
id|instance
)paren
(brace
macro_line|#ifdef USE_FW_LOADER
r_int
id|ret
suffix:semicolon
macro_line|#endif
id|dbg
c_func
(paren
l_string|&quot;speedtch_firmware_start&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|instance-&gt;u.serialize
)paren
suffix:semicolon
multiline_comment|/* vs self, speedtch_got_firmware */
r_if
c_cond
(paren
id|instance-&gt;u.status
op_ge
id|UDSL_LOADING_FIRMWARE
)paren
(brace
id|up
c_func
(paren
op_amp
id|instance-&gt;u.serialize
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|instance-&gt;u.status
op_assign
id|UDSL_LOADING_FIRMWARE
suffix:semicolon
id|up
c_func
(paren
op_amp
id|instance-&gt;u.serialize
)paren
suffix:semicolon
macro_line|#ifdef USE_FW_LOADER
id|udsl_get_instance
c_func
(paren
op_amp
id|instance-&gt;u
)paren
suffix:semicolon
id|try_module_get
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
id|ret
op_assign
id|kernel_thread
c_func
(paren
id|speedtch_load_firmware
comma
id|instance
comma
id|CLONE_FS
op_or
id|CLONE_FILES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* OK */
id|dbg
c_func
(paren
l_string|&quot;speedtch_firmware_start: kernel_thread failed (%d)!&quot;
comma
id|ret
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
id|udsl_put_instance
c_func
(paren
op_amp
id|instance-&gt;u
)paren
suffix:semicolon
multiline_comment|/* Just pretend it never happened... hope modem_run happens */
macro_line|#endif&t;&t;&t;&t;/* USE_FW_LOADER */
id|speedtch_got_firmware
c_func
(paren
id|instance
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|speedtch_firmware_wait
r_static
r_int
id|speedtch_firmware_wait
c_func
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
(brace
id|speedtch_firmware_start
c_func
(paren
(paren
r_void
op_star
)paren
id|instance
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_event_interruptible
c_func
(paren
id|instance-&gt;firmware_waiters
comma
id|instance-&gt;status
op_ne
id|UDSL_LOADING_FIRMWARE
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
(paren
id|instance-&gt;status
op_eq
id|UDSL_LOADED_FIRMWARE
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/**********&n;**  USB  **&n;**********/
DECL|function|speedtch_usb_ioctl
r_static
r_int
id|speedtch_usb_ioctl
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_int
r_int
id|code
comma
r_void
op_star
id|user_data
)paren
(brace
r_struct
id|speedtch_instance_data
op_star
id|instance
op_assign
id|usb_get_intfdata
c_func
(paren
id|intf
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_ioctl entered&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_ioctl: NULL instance!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|UDSL_IOCTL_LINE_UP
suffix:colon
id|instance-&gt;u.atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_FOUND
suffix:semicolon
id|speedtch_got_firmware
c_func
(paren
id|instance
comma
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|instance-&gt;u.status
op_eq
id|UDSL_LOADED_FIRMWARE
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
r_case
id|UDSL_IOCTL_LINE_DOWN
suffix:colon
id|instance-&gt;u.atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
)brace
DECL|function|speedtch_usb_probe
r_static
r_int
id|speedtch_usb_probe
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|interface_to_usbdev
c_func
(paren
id|intf
)paren
suffix:semicolon
r_int
id|ifnum
op_assign
id|intf-&gt;altsetting-&gt;desc.bInterfaceNumber
suffix:semicolon
r_struct
id|speedtch_instance_data
op_star
id|instance
suffix:semicolon
r_int
r_char
id|mac_str
(braket
l_int|13
)braket
suffix:semicolon
r_int
id|ret
comma
id|i
suffix:semicolon
r_char
id|buf7
(braket
id|SIZE_7
)braket
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_probe: trying device with vendor=0x%x, product=0x%x, ifnum %d&quot;
comma
id|dev-&gt;descriptor.idVendor
comma
id|dev-&gt;descriptor.idProduct
comma
id|ifnum
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;descriptor.bDeviceClass
op_ne
id|USB_CLASS_VENDOR_SPEC
)paren
op_logical_or
(paren
id|dev-&gt;descriptor.idVendor
op_ne
id|SPEEDTOUCH_VENDORID
)paren
op_logical_or
(paren
id|dev-&gt;descriptor.idProduct
op_ne
id|SPEEDTOUCH_PRODUCTID
)paren
op_logical_or
(paren
id|ifnum
op_ne
l_int|1
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_probe: device accepted&quot;
)paren
suffix:semicolon
multiline_comment|/* instance init */
id|instance
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|instance
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_probe: no memory for instance data!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|instance
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|speedtch_instance_data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_set_interface
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_set_interface
c_func
(paren
id|dev
comma
l_int|2
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
id|instance-&gt;u.data_endpoint
op_assign
id|SPEEDTCH_ENDPOINT_DATA
suffix:semicolon
id|instance-&gt;u.firmware_wait
op_assign
id|speedtch_firmware_wait
suffix:semicolon
id|instance-&gt;u.driver_name
op_assign
id|speedtch_driver_name
suffix:semicolon
id|ret
op_assign
id|udsl_instance_setup
c_func
(paren
id|dev
comma
op_amp
id|instance-&gt;u
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|fail
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|instance-&gt;poll_timer
)paren
suffix:semicolon
id|instance-&gt;poll_timer.function
op_assign
id|speedtch_timer_poll
suffix:semicolon
id|instance-&gt;poll_timer.data
op_assign
(paren
r_int
r_int
)paren
id|instance
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|instance-&gt;poll_work
comma
(paren
r_void
op_star
)paren
id|speedtch_poll_status
comma
id|instance
)paren
suffix:semicolon
multiline_comment|/* set MAC address, it is stored in the serial number */
id|memset
c_func
(paren
id|instance-&gt;u.atm_dev-&gt;esi
comma
l_int|0
comma
r_sizeof
(paren
id|instance-&gt;u.atm_dev-&gt;esi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_string
c_func
(paren
id|dev
comma
id|dev-&gt;descriptor.iSerialNumber
comma
id|mac_str
comma
r_sizeof
(paren
id|mac_str
)paren
)paren
op_eq
l_int|12
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|instance-&gt;u.atm_dev-&gt;esi
(braket
id|i
)braket
op_assign
(paren
id|hex2int
c_func
(paren
id|mac_str
(braket
id|i
op_star
l_int|2
)braket
)paren
op_star
l_int|16
)paren
op_plus
(paren
id|hex2int
c_func
(paren
id|mac_str
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* First check whether the modem already seems to be alive */
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x12
comma
l_int|0xc0
comma
l_int|0x07
comma
l_int|0x00
comma
id|buf7
comma
id|SIZE_7
comma
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|SIZE_7
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;firmware appears to be already loaded&quot;
)paren
suffix:semicolon
id|speedtch_got_firmware
c_func
(paren
id|instance
comma
l_int|1
)paren
suffix:semicolon
id|speedtch_poll_status
c_func
(paren
id|instance
)paren
suffix:semicolon
)brace
r_else
(brace
id|speedtch_firmware_start
c_func
(paren
id|instance
)paren
suffix:semicolon
)brace
id|usb_set_intfdata
c_func
(paren
id|intf
comma
id|instance
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|kfree
c_func
(paren
id|instance
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|speedtch_usb_disconnect
r_static
r_void
id|speedtch_usb_disconnect
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
(brace
r_struct
id|speedtch_instance_data
op_star
id|instance
op_assign
id|usb_get_intfdata
c_func
(paren
id|intf
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_disconnect entered&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_disconnect: NULL instance!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*QQ need to handle disconnects on interface #2 while uploading firmware */
multiline_comment|/*QQ and what about interface #1? */
r_if
c_cond
(paren
id|instance-&gt;int_urb
)paren
(brace
r_struct
id|urb
op_star
id|int_urb
op_assign
id|instance-&gt;int_urb
suffix:semicolon
id|instance-&gt;int_urb
op_assign
l_int|NULL
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|int_urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|int_urb
)paren
suffix:semicolon
)brace
id|instance-&gt;int_data
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|instance-&gt;poll_timer
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
id|udsl_instance_disconnect
c_func
(paren
op_amp
id|instance-&gt;u
)paren
suffix:semicolon
multiline_comment|/* clean up */
id|usb_set_intfdata
c_func
(paren
id|intf
comma
l_int|NULL
)paren
suffix:semicolon
id|udsl_put_instance
c_func
(paren
op_amp
id|instance-&gt;u
)paren
suffix:semicolon
)brace
multiline_comment|/***********&n;**  init  **&n;***********/
DECL|function|speedtch_usb_init
r_static
r_int
id|__init
id|speedtch_usb_init
c_func
(paren
r_void
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_init: driver version &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
id|usb_register
c_func
(paren
op_amp
id|speedtch_usb_driver
)paren
suffix:semicolon
)brace
DECL|function|speedtch_usb_cleanup
r_static
r_void
id|__exit
id|speedtch_usb_cleanup
c_func
(paren
r_void
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;speedtch_usb_cleanup entered&quot;
)paren
suffix:semicolon
id|usb_deregister
c_func
(paren
op_amp
id|speedtch_usb_driver
)paren
suffix:semicolon
)brace
DECL|variable|speedtch_usb_init
id|module_init
c_func
(paren
id|speedtch_usb_init
)paren
suffix:semicolon
DECL|variable|speedtch_usb_cleanup
id|module_exit
c_func
(paren
id|speedtch_usb_cleanup
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_VERSION
id|MODULE_VERSION
c_func
(paren
id|DRIVER_VERSION
)paren
suffix:semicolon
eof
