multiline_comment|/* Linux driver for Philips webcam &n;   Decompression frontend.&n;   (C) 1999-2001 Nemosoft Unv. (webcam@smcc.demon.nl)&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License as published by&n;   the Free Software Foundation; either version 2 of the License, or&n;   (at your option) any later version.&n;&n;   This program is distributed in the hope that it will be useful,&n;   but WITHOUT ANY WARRANTY; without even the implied warranty of&n;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;   GNU General Public License for more details.&n;&n;   You should have received a copy of the GNU General Public License&n;   along with this program; if not, write to the Free Software&n;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*&n;   This is where the decompression routines register and unregister &n;   themselves. It also has a decompressor wrapper function.&n;*/
macro_line|#include &quot;ccvt.h&quot;
macro_line|#include &quot;vcvt.h&quot;
macro_line|#include &quot;pwc.h&quot;
macro_line|#include &quot;pwc-uncompress.h&quot;
multiline_comment|/* This contains a list of all registered decompressors */
DECL|variable|pwc_decompressor_list
id|LIST_HEAD
c_func
(paren
id|pwc_decompressor_list
)paren
suffix:semicolon
multiline_comment|/* Should the pwc_decompress structure ever change, we increase the &n;   version number so that we don&squot;t get nasty surprises, or can &n;   dynamicly adjust our structure.&n; */
DECL|variable|pwc_decompressor_version
r_const
r_int
id|pwc_decompressor_version
op_assign
id|PWC_MAJOR
suffix:semicolon
multiline_comment|/* Add decompressor to list, ignoring duplicates */
DECL|function|pwc_register_decompressor
r_void
id|pwc_register_decompressor
c_func
(paren
r_struct
id|pwc_decompressor
op_star
id|pwcd
)paren
(brace
r_if
c_cond
(paren
id|pwc_find_decompressor
c_func
(paren
id|pwcd-&gt;type
)paren
op_eq
l_int|NULL
)paren
(brace
id|Debug
c_func
(paren
l_string|&quot;Adding decompressor for model %d.&bslash;n&quot;
comma
id|pwcd-&gt;type
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|pwcd-&gt;pwcd_list
comma
op_amp
id|pwc_decompressor_list
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Remove decompressor from list */
DECL|function|pwc_unregister_decompressor
r_void
id|pwc_unregister_decompressor
c_func
(paren
r_int
id|type
)paren
(brace
r_struct
id|pwc_decompressor
op_star
id|find
suffix:semicolon
id|find
op_assign
id|pwc_find_decompressor
c_func
(paren
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|find
op_ne
l_int|NULL
)paren
(brace
id|Debug
c_func
(paren
l_string|&quot;Removing decompressor for model %d.&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|find-&gt;pwcd_list
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Find decompressor in list */
DECL|function|pwc_find_decompressor
r_struct
id|pwc_decompressor
op_star
id|pwc_find_decompressor
c_func
(paren
r_int
id|type
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|pwc_decompressor
op_star
id|pwcd
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|pwc_decompressor_list
)paren
(brace
id|pwcd
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|pwc_decompressor
comma
id|pwcd_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pwcd-&gt;type
op_eq
id|type
)paren
r_return
id|pwcd
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|pwc_decompress
r_int
id|pwc_decompress
c_func
(paren
r_struct
id|pwc_device
op_star
id|pdev
)paren
(brace
r_struct
id|pwc_frame_buf
op_star
id|fbuf
suffix:semicolon
r_int
id|n
comma
id|l
comma
id|c
comma
id|w
suffix:semicolon
r_void
op_star
id|yuv
comma
op_star
id|image
comma
op_star
id|dst
suffix:semicolon
r_if
c_cond
(paren
id|pdev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#if defined(__KERNEL__) &amp;&amp; defined(PWC_MAGIC)
r_if
c_cond
(paren
id|pdev-&gt;magic
op_ne
id|PWC_MAGIC
)paren
(brace
id|Err
c_func
(paren
l_string|&quot;pwc_decompress(): magic failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
macro_line|#endif
id|fbuf
op_assign
id|pdev-&gt;read_frame
suffix:semicolon
r_if
c_cond
(paren
id|fbuf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|image
op_assign
id|pdev-&gt;image_ptr
(braket
id|pdev-&gt;fill_image
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|image
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#if PWC_DEBUG
multiline_comment|/* This is a quickie */
r_if
c_cond
(paren
id|pdev-&gt;vpalette
op_eq
id|VIDEO_PALETTE_RAW
)paren
(brace
id|memcpy
c_func
(paren
id|image
comma
id|fbuf-&gt;data
comma
id|pdev-&gt;frame_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Compressed formats are decompressed in decompress_buffer, then &n;&t; * transformed into the desired format &n;&t; */
id|yuv
op_assign
id|pdev-&gt;decompress_buffer
suffix:semicolon
id|n
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;vbandlength
op_eq
l_int|0
)paren
(brace
multiline_comment|/* uncompressed */
id|yuv
op_assign
id|fbuf-&gt;data
op_plus
id|pdev-&gt;frame_header_size
suffix:semicolon
multiline_comment|/* Skip header */
)brace
r_else
(brace
r_if
c_cond
(paren
id|pdev-&gt;decompressor
)paren
id|n
op_assign
id|pdev-&gt;decompressor
op_member_access_from_pointer
id|decompress
c_func
(paren
id|pdev-&gt;decompress_data
comma
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|pdev-&gt;vbandlength
comma
id|yuv
comma
id|fbuf-&gt;data
op_plus
id|pdev-&gt;frame_header_size
comma
l_int|0
)paren
suffix:semicolon
r_else
id|n
op_assign
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* No such device or address: missing decompressor */
)brace
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|Err
c_func
(paren
l_string|&quot;Error in decompression engine: %d&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* At this point &squot;yuv&squot; always points to the uncompressed, non-scaled YUV420I data */
r_if
c_cond
(paren
id|pdev-&gt;image.x
op_eq
id|pdev-&gt;view.x
op_logical_and
id|pdev-&gt;image.y
op_eq
id|pdev-&gt;view.y
)paren
(brace
multiline_comment|/* Sizes matches; make it quick */
r_switch
c_cond
(paren
id|pdev-&gt;vpalette
)paren
(brace
r_case
id|VIDEO_PALETTE_RGB24
op_or
l_int|0x80
suffix:colon
id|ccvt_420i_rgb24
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|yuv
comma
id|image
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
id|ccvt_420i_bgr24
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|yuv
comma
id|image
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
op_or
l_int|0x80
suffix:colon
id|ccvt_420i_rgb32
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|yuv
comma
id|image
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
id|ccvt_420i_bgr32
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|yuv
comma
id|image
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
id|ccvt_420i_yuyv
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|yuv
comma
id|image
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420
suffix:colon
id|memcpy
c_func
(paren
id|image
comma
id|yuv
comma
id|pdev-&gt;image.size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420P
suffix:colon
id|n
op_assign
id|pdev-&gt;image.x
op_star
id|pdev-&gt;image.y
suffix:semicolon
id|ccvt_420i_420p
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|yuv
comma
id|image
comma
id|image
op_plus
id|n
comma
id|image
op_plus
id|n
op_plus
(paren
id|n
op_div
l_int|4
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Size mismatch; use viewport conversion routines */
r_switch
c_cond
(paren
id|pdev-&gt;vpalette
)paren
(brace
r_case
id|VIDEO_PALETTE_RGB24
op_or
l_int|0x80
suffix:colon
id|vcvt_420i_rgb24
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|pdev-&gt;view.x
comma
id|yuv
comma
id|image
op_plus
id|pdev-&gt;offset.size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
id|vcvt_420i_bgr24
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|pdev-&gt;view.x
comma
id|yuv
comma
id|image
op_plus
id|pdev-&gt;offset.size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
op_or
l_int|0x80
suffix:colon
id|vcvt_420i_rgb32
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|pdev-&gt;view.x
comma
id|yuv
comma
id|image
op_plus
id|pdev-&gt;offset.size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
id|vcvt_420i_bgr32
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|pdev-&gt;view.x
comma
id|yuv
comma
id|image
op_plus
id|pdev-&gt;offset.size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
id|vcvt_420i_yuyv
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|pdev-&gt;view.x
comma
id|yuv
comma
id|image
op_plus
id|pdev-&gt;offset.size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420
suffix:colon
id|dst
op_assign
id|image
op_plus
id|pdev-&gt;offset.size
suffix:semicolon
id|w
op_assign
id|pdev-&gt;view.x
op_star
l_int|6
suffix:semicolon
id|c
op_assign
id|pdev-&gt;image.x
op_star
l_int|6
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|pdev-&gt;image.y
suffix:semicolon
id|l
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|dst
comma
id|yuv
comma
id|c
)paren
suffix:semicolon
id|dst
op_add_assign
id|w
suffix:semicolon
id|yuv
op_add_assign
id|c
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420P
suffix:colon
id|n
op_assign
id|pdev-&gt;view.x
op_star
id|pdev-&gt;view.y
suffix:semicolon
id|vcvt_420i_420p
c_func
(paren
id|pdev-&gt;image.x
comma
id|pdev-&gt;image.y
comma
id|pdev-&gt;view.x
comma
id|yuv
comma
id|image
op_plus
id|pdev-&gt;offset.size
comma
id|image
op_plus
id|n
op_plus
id|pdev-&gt;offset.size
op_div
l_int|4
comma
id|image
op_plus
id|n
op_plus
id|n
op_div
l_int|4
op_plus
id|pdev-&gt;offset.size
op_div
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* wrapper functions.&n;   By using these wrapper functions and exporting them with no VERSIONING,&n;   I can be sure the pwcx.o module will load on all systems.&n;*/
DECL|function|pwc_kmalloc
r_void
op_star
id|pwc_kmalloc
c_func
(paren
r_int
id|size
comma
r_int
id|priority
)paren
(brace
r_return
id|kmalloc
c_func
(paren
id|size
comma
id|priority
)paren
suffix:semicolon
)brace
DECL|function|pwc_kfree
r_void
id|pwc_kfree
c_func
(paren
r_const
r_void
op_star
id|pointer
)paren
(brace
id|kfree
c_func
(paren
id|pointer
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure these functions are available for the decompressor plugin&n;   both when this code is compiled into the kernel or as as module.&n;   We are using unversioned names!&n; */
DECL|variable|pwc_decompressor_version
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|pwc_decompressor_version
)paren
suffix:semicolon
DECL|variable|pwc_register_decompressor
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|pwc_register_decompressor
)paren
suffix:semicolon
DECL|variable|pwc_unregister_decompressor
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|pwc_unregister_decompressor
)paren
suffix:semicolon
DECL|variable|pwc_find_decompressor
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|pwc_find_decompressor
)paren
suffix:semicolon
DECL|variable|pwc_kmalloc
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|pwc_kmalloc
)paren
suffix:semicolon
DECL|variable|pwc_kfree
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|pwc_kfree
)paren
suffix:semicolon
eof
