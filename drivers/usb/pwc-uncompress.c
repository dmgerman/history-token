multiline_comment|/* Linux driver for Philips webcam &n;   Decompression frontend.&n;   (C) 1999-2001 Nemosoft Unv. (webcam@smcc.demon.nl)&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License as published by&n;   the Free Software Foundation; either version 2 of the License, or&n;   (at your option) any later version.&n;&n;   This program is distributed in the hope that it will be useful,&n;   but WITHOUT ANY WARRANTY; without even the implied warranty of&n;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;   GNU General Public License for more details.&n;&n;   You should have received a copy of the GNU General Public License&n;   along with this program; if not, write to the Free Software&n;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
multiline_comment|/*&n;   This is where the decompression routines register and unregister &n;   themselves. It also has a decompressor wrapper function.&n;*/
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &quot;pwc.h&quot;
macro_line|#include &quot;pwc-uncompress.h&quot;
multiline_comment|/* This contains a list of all registered decompressors */
r_static
id|LIST_HEAD
c_func
(paren
id|pwc_decompressor_list
)paren
suffix:semicolon
multiline_comment|/* Should the pwc_decompress structure ever change, we increase the &n;   version number so that we don&squot;t get nasty surprises, or can &n;   dynamicly adjust our structure.&n; */
DECL|variable|pwc_decompressor_version
r_const
r_int
id|pwc_decompressor_version
op_assign
id|PWC_MAJOR
suffix:semicolon
multiline_comment|/* Add decompressor to list, ignoring duplicates */
DECL|function|pwc_register_decompressor
r_void
id|pwc_register_decompressor
c_func
(paren
r_struct
id|pwc_decompressor
op_star
id|pwcd
)paren
(brace
r_if
c_cond
(paren
id|pwc_find_decompressor
c_func
(paren
id|pwcd-&gt;type
)paren
op_eq
l_int|NULL
)paren
(brace
id|Trace
c_func
(paren
id|TRACE_PWCX
comma
l_string|&quot;Adding decompressor for model %d.&bslash;n&quot;
comma
id|pwcd-&gt;type
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|pwcd-&gt;pwcd_list
comma
op_amp
id|pwc_decompressor_list
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Remove decompressor from list */
DECL|function|pwc_unregister_decompressor
r_void
id|pwc_unregister_decompressor
c_func
(paren
r_int
id|type
)paren
(brace
r_struct
id|pwc_decompressor
op_star
id|find
suffix:semicolon
id|find
op_assign
id|pwc_find_decompressor
c_func
(paren
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|find
op_ne
l_int|NULL
)paren
(brace
id|Trace
c_func
(paren
id|TRACE_PWCX
comma
l_string|&quot;Removing decompressor for model %d.&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|find-&gt;pwcd_list
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Find decompressor in list */
DECL|function|pwc_find_decompressor
r_struct
id|pwc_decompressor
op_star
id|pwc_find_decompressor
c_func
(paren
r_int
id|type
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|pwc_decompressor
op_star
id|pwcd
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|pwc_decompressor_list
)paren
(brace
id|pwcd
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|pwc_decompressor
comma
id|pwcd_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pwcd-&gt;type
op_eq
id|type
)paren
r_return
id|pwcd
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|pwc_decompress
r_int
id|pwc_decompress
c_func
(paren
r_struct
id|pwc_device
op_star
id|pdev
)paren
(brace
r_struct
id|pwc_frame_buf
op_star
id|fbuf
suffix:semicolon
r_int
id|n
comma
id|line
comma
id|col
comma
id|stride
suffix:semicolon
r_void
op_star
id|yuv
comma
op_star
id|image
comma
op_star
id|dst
suffix:semicolon
id|u16
op_star
id|src
suffix:semicolon
id|u16
op_star
id|dsty
comma
op_star
id|dstu
comma
op_star
id|dstv
suffix:semicolon
r_if
c_cond
(paren
id|pdev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#if defined(__KERNEL__) &amp;&amp; defined(PWC_MAGIC)
r_if
c_cond
(paren
id|pdev-&gt;magic
op_ne
id|PWC_MAGIC
)paren
(brace
id|Err
c_func
(paren
l_string|&quot;pwc_decompress(): magic failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
macro_line|#endif
id|fbuf
op_assign
id|pdev-&gt;read_frame
suffix:semicolon
r_if
c_cond
(paren
id|fbuf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|image
op_assign
id|pdev-&gt;image_ptr
(braket
id|pdev-&gt;fill_image
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|image
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#if PWC_DEBUG
multiline_comment|/* This is a quickie */
r_if
c_cond
(paren
id|pdev-&gt;vpalette
op_eq
id|VIDEO_PALETTE_RAW
)paren
(brace
id|memcpy
c_func
(paren
id|image
comma
id|fbuf-&gt;data
comma
id|pdev-&gt;frame_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|yuv
op_assign
id|fbuf-&gt;data
op_plus
id|pdev-&gt;frame_header_size
suffix:semicolon
multiline_comment|/* Skip header */
r_if
c_cond
(paren
id|pdev-&gt;vbandlength
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Uncompressed mode. We copy the data into the output buffer,&n;&t;&t;   using the viewport size (which may be larger than the image&n;&t;&t;   size). Unfortunately we have to do a bit of byte stuffing&n;&t;&t;   to get the desired output format/size.&n;&t;&t; */
r_switch
c_cond
(paren
id|pdev-&gt;vpalette
)paren
(brace
r_case
id|VIDEO_PALETTE_YUV420
suffix:colon
multiline_comment|/* Calculate byte offsets per line in image &amp; view */
id|n
op_assign
(paren
id|pdev-&gt;image.x
op_star
l_int|3
)paren
op_div
l_int|2
suffix:semicolon
id|col
op_assign
(paren
id|pdev-&gt;view.x
op_star
l_int|3
)paren
op_div
l_int|2
suffix:semicolon
multiline_comment|/* Offset into image */
id|dst
op_assign
id|image
op_plus
(paren
id|pdev-&gt;view.x
op_star
id|pdev-&gt;offset.y
op_plus
id|pdev-&gt;offset.x
)paren
op_star
l_int|3
op_div
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|line
op_assign
l_int|0
suffix:semicolon
id|line
OL
id|pdev-&gt;image.y
suffix:semicolon
id|line
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|dst
comma
id|yuv
comma
id|n
)paren
suffix:semicolon
id|yuv
op_add_assign
id|n
suffix:semicolon
id|dst
op_add_assign
id|col
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420P
suffix:colon
multiline_comment|/* &n;&t;&t;&t; * We do some byte shuffling here to go from the &n;&t;&t;&t; * native format to YUV420P.&n;&t;&t;&t; */
id|src
op_assign
(paren
id|u16
op_star
)paren
id|yuv
suffix:semicolon
id|n
op_assign
id|pdev-&gt;view.x
op_star
id|pdev-&gt;view.y
suffix:semicolon
multiline_comment|/* offset in Y plane */
id|stride
op_assign
id|pdev-&gt;view.x
op_star
id|pdev-&gt;offset.y
op_plus
id|pdev-&gt;offset.x
suffix:semicolon
id|dsty
op_assign
(paren
id|u16
op_star
)paren
(paren
id|image
op_plus
id|stride
)paren
suffix:semicolon
multiline_comment|/* offsets in U/V planes */
id|stride
op_assign
id|pdev-&gt;view.x
op_star
id|pdev-&gt;offset.y
op_div
l_int|4
op_plus
id|pdev-&gt;offset.x
op_div
l_int|2
suffix:semicolon
id|dstu
op_assign
(paren
id|u16
op_star
)paren
(paren
id|image
op_plus
id|n
op_plus
id|stride
)paren
suffix:semicolon
id|dstv
op_assign
(paren
id|u16
op_star
)paren
(paren
id|image
op_plus
id|n
op_plus
id|n
op_div
l_int|4
op_plus
id|stride
)paren
suffix:semicolon
multiline_comment|/* increment after each line */
id|stride
op_assign
(paren
id|pdev-&gt;view.x
op_minus
id|pdev-&gt;image.x
)paren
op_div
l_int|2
suffix:semicolon
multiline_comment|/* u16 is 2 bytes */
r_for
c_loop
(paren
id|line
op_assign
l_int|0
suffix:semicolon
id|line
OL
id|pdev-&gt;image.y
suffix:semicolon
id|line
op_increment
)paren
(brace
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|col
OL
id|pdev-&gt;image.x
suffix:semicolon
id|col
op_add_assign
l_int|4
)paren
(brace
op_star
id|dsty
op_increment
op_assign
op_star
id|src
op_increment
suffix:semicolon
op_star
id|dsty
op_increment
op_assign
op_star
id|src
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|line
op_amp
l_int|1
)paren
op_star
id|dstv
op_increment
op_assign
op_star
id|src
op_increment
suffix:semicolon
r_else
op_star
id|dstu
op_increment
op_assign
op_star
id|src
op_increment
suffix:semicolon
)brace
id|dsty
op_add_assign
id|stride
suffix:semicolon
r_if
c_cond
(paren
id|line
op_amp
l_int|1
)paren
id|dstv
op_add_assign
(paren
id|stride
op_rshift
l_int|1
)paren
suffix:semicolon
r_else
id|dstu
op_add_assign
(paren
id|stride
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Compressed; the decompressor routines will write the data &n;&t;&t;   in interlaced or planar format immediately.&n;&t;&t; */
r_if
c_cond
(paren
id|pdev-&gt;decompressor
)paren
id|pdev-&gt;decompressor
op_member_access_from_pointer
id|decompress
c_func
(paren
op_amp
id|pdev-&gt;image
comma
op_amp
id|pdev-&gt;view
comma
op_amp
id|pdev-&gt;offset
comma
id|yuv
comma
id|image
comma
id|pdev-&gt;vpalette
op_eq
id|VIDEO_PALETTE_YUV420P
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
id|pdev-&gt;decompress_data
comma
id|pdev-&gt;vbandlength
)paren
suffix:semicolon
r_else
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* No such device or address: missing decompressor */
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Make sure these functions are available for the decompressor plugin&n;   both when this code is compiled into the kernel or as as module.&n; */
DECL|variable|pwc_decompressor_version
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|pwc_decompressor_version
)paren
suffix:semicolon
DECL|variable|pwc_register_decompressor
id|EXPORT_SYMBOL
c_func
(paren
id|pwc_register_decompressor
)paren
suffix:semicolon
DECL|variable|pwc_unregister_decompressor
id|EXPORT_SYMBOL
c_func
(paren
id|pwc_unregister_decompressor
)paren
suffix:semicolon
eof
