multiline_comment|/*&n; *  STV0680 USB Camera Driver, by Kevin Sisson (kjsisson@bellsouth.net)&n; *  &n; * Thanks to STMicroelectronics for information on the usb commands, and &n; * to Steve Miller at STM for his help and encouragement while I was &n; * writing this driver.&n; *&n; * This driver is based heavily on the &n; * Endpoints (formerly known as AOX) se401 USB Camera Driver&n; * Copyright (c) 2000 Jeroen B. Vreeken (pe1rxq@amsat.org)&n; *&n; * Still somewhat based on the Linux ov511 driver.&n; * &n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY&n; * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; * for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * History: &n; * ver 0.1 October, 2001. Initial attempt. &n; *&n; * ver 0.2 November, 2001. Fixed asbility to resize, added brightness&n; *                         function, made more stable (?)&n; *&n; * ver 0.21 Nov, 2001.     Added gamma correction and white balance, &n; *                         due to Alexander Schwartz. Still trying to &n; *                         improve stablility. Moved stuff into stv680.h&n; *&n; * ver 0.22 Nov, 2001.&t;   Added sharpen function (by Michael Sweet, &n; *                         mike@easysw.com) from GIMP, also used in pencam. &n; *                         Simple, fast, good integer math routine.&n; *&n; * ver 0.23 Dec, 2001 (gkh)&n; * &t;&t;&t;   Took out sharpen function, ran code through&n; * &t;&t;&t;   Lindent, and did other minor tweaks to get&n; * &t;&t;&t;   things to work properly with 2.5.1&n; *&n; * ver 0.24 Jan, 2002 (kjs) &n; *                         Fixed the problem with webcam crashing after&n; *                         two pictures. Changed the way pic is halved to &n; *                         improve quality. Got rid of green line around &n; *                         frame. Fix brightness reset when changing size &n; *                         bug. Adjusted gamma filters slightly.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;stv680.h&quot;
DECL|variable|video_nr
r_static
r_int
id|video_nr
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|swapRGB
r_static
r_int
id|swapRGB
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default for auto sleect */
DECL|variable|swapRGB_on
r_static
r_int
id|swapRGB_on
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default to allow auto select; -1=swap never, +1= swap always */
DECL|variable|debug
r_static
r_int
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
DECL|macro|PDEBUG
mdefine_line|#define PDEBUG(level, fmt, args...) &bslash;&n;&t;do { &bslash;&n;&t;if (debug &gt;= level)&t;&bslash;&n;&t;&t;info(&quot;[&quot; __PRETTY_FUNCTION__ &quot;:%d] &quot; fmt, __LINE__ , ## args);&t;&bslash;&n;&t;} while (0)
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v0.24&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Kevin Sisson &lt;kjsisson@bellsouth.net&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;STV0680 USB Camera Driver&quot;
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|debug
comma
l_string|&quot;Debug enabled or not&quot;
)paren
suffix:semicolon
id|MODULE_PARM
(paren
id|swapRGB_on
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|swapRGB_on
comma
l_string|&quot;Red/blue swap: 1=always, 0=auto, -1=never&quot;
)paren
suffix:semicolon
id|MODULE_PARM
(paren
id|video_nr
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
multiline_comment|/********************************************************************&n; *&n; * Memory management&n; *&n; * This is a shameless copy from the USB-cpia driver (linux kernel&n; * version 2.3.29 or so, I have no idea what this code actually does ;).&n; * Actually it seems to be a copy of a shameless copy of the bttv-driver.&n; * Or that is a copy of a shameless copy of ... (To the powers: is there&n; * no generic kernel-function to do this sort of stuff?)&n; *&n; * Yes, it was a shameless copy from the bttv-driver. IIRC, Alan says&n; * there will be one, but apparentely not yet -jerdfelt&n; *&n; * So I copied it again for the ov511 driver -claudio&n; *&n; * Same for the se401 driver -Jeroen&n; *&n; * And the STV0680 driver - Kevin&n; ********************************************************************/
multiline_comment|/* Given PGD from the address space&squot;s page table, return the kernel&n; * virtual mapping of the physical memory mapped at ADR.&n; */
DECL|function|uvirt_to_kva
r_static
r_inline
r_int
r_int
id|uvirt_to_kva
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|ret
op_assign
l_int|0UL
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgd_none
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd
op_assign
id|pmd_offset
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd_none
(paren
op_star
id|pmd
)paren
)paren
(brace
id|ptep
op_assign
id|pte_offset
(paren
id|pmd
comma
id|adr
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
(paren
id|pte
)paren
)paren
(brace
id|ret
op_assign
(paren
r_int
r_int
)paren
id|page_address
(paren
id|pte_page
(paren
id|pte
)paren
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Here we want the physical address of the memory. This is used when &n; * initializing the contents of the area and marking the pages as reserved.&n; */
DECL|function|kvirt_to_pa
r_static
r_inline
r_int
r_int
id|kvirt_to_pa
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
(paren
id|pgd_offset_k
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|__pa
(paren
id|kva
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
multiline_comment|/* Round it off to PAGE_SIZE */
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|mem
op_assign
id|vmalloc_32
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
(paren
id|virt_to_page
(paren
id|__va
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
(paren
id|virt_to_page
(paren
id|__va
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|vfree
(paren
id|mem
)paren
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n; * pencam read/write functions&n; ********************************************************************/
DECL|function|stv_sndctrl
r_static
r_int
id|stv_sndctrl
(paren
r_int
id|set
comma
r_struct
id|usb_stv
op_star
id|stv680
comma
r_int
r_int
id|req
comma
r_int
r_int
id|value
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|set
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/*  0xc1  */
id|ret
op_assign
id|usb_control_msg
(paren
id|stv680-&gt;udev
comma
id|usb_rcvctrlpipe
(paren
id|stv680-&gt;udev
comma
l_int|0
)paren
comma
id|req
comma
(paren
id|USB_DIR_IN
op_or
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_ENDPOINT
)paren
comma
id|value
comma
l_int|0
comma
id|buffer
comma
id|size
comma
id|PENCAM_TIMEOUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/*  0x41  */
id|ret
op_assign
id|usb_control_msg
(paren
id|stv680-&gt;udev
comma
id|usb_sndctrlpipe
(paren
id|stv680-&gt;udev
comma
l_int|0
)paren
comma
id|req
comma
(paren
id|USB_DIR_OUT
op_or
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_ENDPOINT
)paren
comma
id|value
comma
l_int|0
comma
id|buffer
comma
id|size
comma
id|PENCAM_TIMEOUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/*  0x80  */
id|ret
op_assign
id|usb_control_msg
(paren
id|stv680-&gt;udev
comma
id|usb_rcvctrlpipe
(paren
id|stv680-&gt;udev
comma
l_int|0
)paren
comma
id|req
comma
(paren
id|USB_DIR_IN
op_or
id|USB_RECIP_DEVICE
)paren
comma
id|value
comma
l_int|0
comma
id|buffer
comma
id|size
comma
id|PENCAM_TIMEOUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/*  0x40  */
id|ret
op_assign
id|usb_control_msg
(paren
id|stv680-&gt;udev
comma
id|usb_sndctrlpipe
(paren
id|stv680-&gt;udev
comma
l_int|0
)paren
comma
id|req
comma
(paren
id|USB_DIR_OUT
op_or
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
comma
id|value
comma
l_int|0
comma
id|buffer
comma
id|size
comma
id|PENCAM_TIMEOUT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
OL
l_int|0
)paren
op_logical_and
(paren
id|req
op_ne
l_int|0x0a
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): usb_control_msg error %i, request = 0x%x, error = %i&quot;
comma
id|set
comma
id|req
comma
id|ret
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|stv_set_config
r_static
r_int
id|stv_set_config
(paren
r_struct
id|usb_stv
op_star
id|dev
comma
r_int
id|configuration
comma
r_int
id|interface
comma
r_int
id|alternate
)paren
(brace
r_if
c_cond
(paren
id|usb_set_configuration
(paren
id|dev-&gt;udev
comma
id|configuration
)paren
OL
l_int|0
)paren
(brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): FAILED to set configuration %i&quot;
comma
id|configuration
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_set_interface
(paren
id|dev-&gt;udev
comma
id|interface
comma
id|alternate
)paren
OL
l_int|0
)paren
(brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): FAILED to set alternate interface %i&quot;
comma
id|alternate
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stv_stop_video
r_static
r_int
id|stv_stop_video
(paren
r_struct
id|usb_stv
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
id|buf
op_assign
id|kmalloc
(paren
l_int|40
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Out of (small buf) memory&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* this is a high priority command; it stops all lower order commands */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|1
comma
id|dev
comma
l_int|0x04
comma
l_int|0x0000
comma
id|buf
comma
l_int|0x0
)paren
)paren
OL
l_int|0
)paren
(brace
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|dev
comma
l_int|0x80
comma
l_int|0
comma
id|buf
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Get Last Error; 2 = busy */
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): last error: %i,  command = 0x%x&quot;
comma
id|buf
(braket
l_int|0
)braket
comma
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): Camera reset to idle mode.&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_set_config
(paren
id|dev
comma
l_int|1
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): Reset config during exit failed&quot;
)paren
suffix:semicolon
multiline_comment|/*  get current mode  */
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xf0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|dev
comma
l_int|0x87
comma
l_int|0
comma
id|buf
comma
l_int|0x08
)paren
)paren
op_ne
l_int|0x08
)paren
multiline_comment|/* get mode */
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Stop_video: problem setting original mode&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;origMode
op_ne
id|buf
(braket
l_int|0
)braket
)paren
(brace
id|memset
(paren
id|buf
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_char
)paren
id|dev-&gt;origMode
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|3
comma
id|dev
comma
l_int|0x07
comma
l_int|0x0100
comma
id|buf
comma
l_int|0x08
)paren
)paren
op_ne
l_int|0x08
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Stop_video: Set_Camera_Mode failed&quot;
)paren
suffix:semicolon
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xf0
suffix:semicolon
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|dev
comma
l_int|0x87
comma
l_int|0
comma
id|buf
comma
l_int|0x08
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_ne
l_int|0x08
)paren
op_logical_or
(paren
id|buf
(braket
l_int|0
)braket
op_ne
id|dev-&gt;origMode
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): camera NOT set to original resolution.&quot;
)paren
suffix:semicolon
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): Camera set to original resolution&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* origMode */
id|kfree
(paren
id|buf
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|stv_set_video_mode
r_static
r_int
id|stv_set_video_mode
(paren
r_struct
id|usb_stv
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|stop_video
op_assign
l_int|1
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
id|buf
op_assign
id|kmalloc
(paren
l_int|40
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Out of (small buf) memory&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_set_config
(paren
id|dev
comma
l_int|1
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|kfree
(paren
id|buf
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|i
op_assign
id|stv_sndctrl
(paren
l_int|2
comma
id|dev
comma
l_int|0x06
comma
l_int|0x0100
comma
id|buf
comma
l_int|0x12
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
OG
l_int|0
)paren
op_logical_and
(paren
id|buf
(braket
l_int|8
)braket
op_eq
l_int|0x53
)paren
op_logical_and
(paren
id|buf
(braket
l_int|9
)braket
op_eq
l_int|0x05
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): Could not get descriptor 0100.&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/*  set alternate interface 1 */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_set_config
(paren
id|dev
comma
l_int|1
comma
l_int|0
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|dev
comma
l_int|0x85
comma
l_int|0
comma
id|buf
comma
l_int|0x10
)paren
)paren
op_ne
l_int|0x10
)paren
r_goto
id|error
suffix:semicolon
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): Setting video mode.&quot;
)paren
suffix:semicolon
multiline_comment|/*  Switch to Video mode: 0x0100 = VGA (640x480), 0x0000 = CIF (352x288) 0x0300 = QVGA (320x240)  */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|1
comma
id|dev
comma
l_int|0x09
comma
id|dev-&gt;VideoMode
comma
id|buf
comma
l_int|0x0
)paren
)paren
OL
l_int|0
)paren
(brace
id|stop_video
op_assign
l_int|0
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_goto
m_exit
suffix:semicolon
id|error
suffix:colon
id|kfree
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stop_video
op_eq
l_int|1
)paren
id|stv_stop_video
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
m_exit
suffix:colon
id|kfree
(paren
id|buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stv_init
r_static
r_int
id|stv_init
(paren
r_struct
id|usb_stv
op_star
id|stv680
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|buffer
suffix:semicolon
r_int
r_int
r_int
id|bufsize
suffix:semicolon
id|buffer
op_assign
id|kmalloc
(paren
l_int|40
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Out of (small buf) memory&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
(paren
id|buffer
comma
l_int|0
comma
l_int|40
)paren
suffix:semicolon
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* set config 1, interface 0, alternate 0 */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_set_config
(paren
id|stv680
comma
l_int|1
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): set config 1,0,0 failed&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ping camera to be sure STV0680 is present */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x88
comma
l_int|0x5678
comma
id|buffer
comma
l_int|0x02
)paren
)paren
op_ne
l_int|0x02
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|0
)braket
op_ne
l_int|0x56
)paren
op_logical_or
(paren
id|buffer
(braket
l_int|1
)braket
op_ne
l_int|0x78
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): camera ping failed!!&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* get camera descriptor */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|2
comma
id|stv680
comma
l_int|0x06
comma
l_int|0x0200
comma
id|buffer
comma
l_int|0x09
)paren
)paren
op_ne
l_int|0x09
)paren
r_goto
id|error
suffix:semicolon
id|i
op_assign
id|stv_sndctrl
(paren
l_int|2
comma
id|stv680
comma
l_int|0x06
comma
l_int|0x0200
comma
id|buffer
comma
l_int|0x22
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_ge
l_int|0
)paren
op_logical_and
(paren
id|buffer
(braket
l_int|7
)braket
op_eq
l_int|0xa0
)paren
op_logical_and
(paren
id|buffer
(braket
l_int|8
)braket
op_eq
l_int|0x23
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): Could not get descriptor 0200.&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x8a
comma
l_int|0
comma
id|buffer
comma
l_int|0x02
)paren
)paren
op_ne
l_int|0x02
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x8b
comma
l_int|0
comma
id|buffer
comma
l_int|0x24
)paren
)paren
op_ne
l_int|0x24
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x85
comma
l_int|0
comma
id|buffer
comma
l_int|0x10
)paren
)paren
op_ne
l_int|0x10
)paren
r_goto
id|error
suffix:semicolon
id|stv680-&gt;SupportedModes
op_assign
id|buffer
(braket
l_int|7
)braket
suffix:semicolon
id|i
op_assign
id|stv680-&gt;SupportedModes
suffix:semicolon
id|stv680-&gt;CIF
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;VGA
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;QVGA
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|1
)paren
id|stv680-&gt;CIF
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|2
)paren
id|stv680-&gt;VGA
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|8
)paren
id|stv680-&gt;QVGA
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;SupportedModes
op_eq
l_int|0
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): There are NO supported STV680 modes!!&quot;
)paren
suffix:semicolon
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|stv680-&gt;CIF
)paren
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): CIF is supported&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;QVGA
)paren
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): QVGA is supported&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* FW rev, ASIC rev, sensor ID  */
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): Firmware rev is %i.%i&quot;
comma
id|buffer
(braket
l_int|0
)braket
comma
id|buffer
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): ASIC rev is %i.%i&quot;
comma
id|buffer
(braket
l_int|2
)braket
comma
id|buffer
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): Sensor ID is %i&quot;
comma
(paren
id|buffer
(braket
l_int|4
)braket
op_star
l_int|16
)paren
op_plus
(paren
id|buffer
(braket
l_int|5
)braket
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/*  set alternate interface 1 */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_set_config
(paren
id|stv680
comma
l_int|1
comma
l_int|0
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x85
comma
l_int|0
comma
id|buffer
comma
l_int|0x10
)paren
)paren
op_ne
l_int|0x10
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x8d
comma
l_int|0
comma
id|buffer
comma
l_int|0x08
)paren
)paren
op_ne
l_int|0x08
)paren
r_goto
id|error
suffix:semicolon
id|i
op_assign
id|buffer
(braket
l_int|3
)braket
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): Camera has %i pictures.&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/*  get current mode */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x87
comma
l_int|0
comma
id|buffer
comma
l_int|0x08
)paren
)paren
op_ne
l_int|0x08
)paren
r_goto
id|error
suffix:semicolon
id|stv680-&gt;origMode
op_assign
id|buffer
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* 01 = VGA, 03 = QVGA, 00 = CIF */
multiline_comment|/* This will attemp CIF mode, if supported. If not, set to QVGA  */
id|memset
(paren
id|buffer
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;CIF
)paren
id|buffer
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stv680-&gt;QVGA
)paren
id|buffer
(braket
l_int|0
)braket
op_assign
l_int|0x03
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|3
comma
id|stv680
comma
l_int|0x07
comma
l_int|0x0100
comma
id|buffer
comma
l_int|0x08
)paren
)paren
op_ne
l_int|0x08
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): Set_Camera_Mode failed&quot;
)paren
suffix:semicolon
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|buffer
(braket
l_int|0
)braket
op_assign
l_int|0xf0
suffix:semicolon
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x87
comma
l_int|0
comma
id|buffer
comma
l_int|0x08
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|stv680-&gt;CIF
op_eq
l_int|1
)paren
op_logical_and
(paren
id|buffer
(braket
l_int|0
)braket
op_ne
l_int|0x00
)paren
)paren
op_logical_or
(paren
(paren
id|stv680-&gt;QVGA
op_eq
l_int|1
)paren
op_logical_and
(paren
id|buffer
(braket
l_int|0
)braket
op_ne
l_int|0x03
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Error setting camera video mode!&quot;
)paren
suffix:semicolon
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|buffer
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
id|stv680-&gt;VideoMode
op_assign
l_int|0x0000
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): Video Mode set to CIF&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buffer
(braket
l_int|0
)braket
op_eq
l_int|0x03
)paren
(brace
id|stv680-&gt;VideoMode
op_assign
l_int|0x0300
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): Video Mode set to QVGA&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x8f
comma
l_int|0
comma
id|buffer
comma
l_int|0x10
)paren
)paren
op_ne
l_int|0x10
)paren
r_goto
id|error
suffix:semicolon
id|bufsize
op_assign
(paren
id|buffer
(braket
l_int|0
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|buffer
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|buffer
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|buffer
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|stv680-&gt;cwidth
op_assign
(paren
id|buffer
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|buffer
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* -&gt;camera = 322, 356, 644  */
id|stv680-&gt;cheight
op_assign
(paren
id|buffer
(braket
l_int|6
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|buffer
(braket
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/* -&gt;camera = 242, 292, 484  */
id|stv680-&gt;origGain
op_assign
id|buffer
(braket
l_int|12
)braket
suffix:semicolon
r_goto
m_exit
suffix:semicolon
id|error
suffix:colon
id|i
op_assign
id|stv_sndctrl
(paren
l_int|0
comma
id|stv680
comma
l_int|0x80
comma
l_int|0
comma
id|buffer
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Get Last Error */
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): last error: %i,  command = 0x%x&quot;
comma
id|buffer
(braket
l_int|0
)braket
comma
id|buffer
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
m_exit
suffix:colon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
multiline_comment|/* video = 320x240, 352x288 */
r_if
c_cond
(paren
id|stv680-&gt;CIF
op_eq
l_int|1
)paren
(brace
id|stv680-&gt;maxwidth
op_assign
l_int|352
suffix:semicolon
id|stv680-&gt;maxheight
op_assign
l_int|288
suffix:semicolon
id|stv680-&gt;vwidth
op_assign
l_int|352
suffix:semicolon
id|stv680-&gt;vheight
op_assign
l_int|288
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stv680-&gt;QVGA
op_eq
l_int|1
)paren
(brace
id|stv680-&gt;maxwidth
op_assign
l_int|320
suffix:semicolon
id|stv680-&gt;maxheight
op_assign
l_int|240
suffix:semicolon
id|stv680-&gt;vwidth
op_assign
l_int|320
suffix:semicolon
id|stv680-&gt;vheight
op_assign
l_int|240
suffix:semicolon
)brace
id|stv680-&gt;rawbufsize
op_assign
id|bufsize
suffix:semicolon
multiline_comment|/* must be ./. by 8 */
id|stv680-&gt;maxframesize
op_assign
id|bufsize
op_star
l_int|3
suffix:semicolon
multiline_comment|/* RGB size */
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(i): cwidth = %i, cheight = %i&quot;
comma
id|stv680-&gt;cwidth
comma
id|stv680-&gt;cheight
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): width = %i, height = %i, rawbufsize = %li&quot;
comma
id|stv680-&gt;vwidth
comma
id|stv680-&gt;vheight
comma
id|stv680-&gt;rawbufsize
)paren
suffix:semicolon
multiline_comment|/* some default values */
id|stv680-&gt;bulk_in_endpointAddr
op_assign
l_int|0x82
suffix:semicolon
id|stv680-&gt;dropped
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;error
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;framecount
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;readcount
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;streaming
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* bright, white, colour, hue, contrast are set by software, not in stv0680 */
id|stv680-&gt;brightness
op_assign
l_int|32767
suffix:semicolon
id|stv680-&gt;chgbright
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;whiteness
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* only for greyscale */
id|stv680-&gt;colour
op_assign
l_int|32767
suffix:semicolon
id|stv680-&gt;contrast
op_assign
l_int|32767
suffix:semicolon
id|stv680-&gt;hue
op_assign
l_int|32767
suffix:semicolon
id|stv680-&gt;palette
op_assign
id|STV_VIDEO_PALETTE
suffix:semicolon
id|stv680-&gt;depth
op_assign
l_int|24
suffix:semicolon
multiline_comment|/* rgb24 bits */
id|swapRGB
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|swapRGB_on
op_eq
l_int|0
)paren
op_logical_and
(paren
id|swapRGB
op_eq
l_int|0
)paren
)paren
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): swapRGB is (auto) OFF&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|swapRGB_on
op_eq
l_int|1
)paren
op_logical_and
(paren
id|swapRGB
op_eq
l_int|1
)paren
)paren
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): swapRGB is (auto) ON&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|swapRGB_on
op_eq
l_int|1
)paren
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): swapRGB is (forced) ON&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|swapRGB_on
op_eq
op_minus
l_int|1
)paren
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): swapRGB is (forced) OFF&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv_set_video_mode
(paren
id|stv680
)paren
OL
l_int|0
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Could not set video mode in stv_init&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************** last of pencam  routines  *******************/
multiline_comment|/********************************************************************&n; * /proc interface&n; *******************************************************************/
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
DECL|variable|stv680_proc_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|stv680_proc_entry
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_struct
id|proc_dir_entry
op_star
id|video_proc_entry
suffix:semicolon
DECL|macro|YES_NO
mdefine_line|#define YES_NO(x) ((x) ? &quot;yes&quot; : &quot;no&quot;)
DECL|macro|ON_OFF
mdefine_line|#define ON_OFF(x) ((x) ? &quot;(auto) on&quot; : &quot;(auto) off&quot;)
DECL|function|stv680_read_proc
r_static
r_int
id|stv680_read_proc
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|out
op_assign
id|page
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|usb_stv
op_star
id|stv680
op_assign
id|data
suffix:semicolon
multiline_comment|/* Stay under PAGE_SIZE or else bla bla bla.... */
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;driver_version  : %s&bslash;n&quot;
comma
id|DRIVER_VERSION
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;model           : %s&bslash;n&quot;
comma
id|stv680-&gt;camera_name
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;in use          : %s&bslash;n&quot;
comma
id|YES_NO
(paren
id|stv680-&gt;user
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;streaming       : %s&bslash;n&quot;
comma
id|YES_NO
(paren
id|stv680-&gt;streaming
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;num_frames      : %d&bslash;n&quot;
comma
id|STV680_NUMFRAMES
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;Current size    : %ix%i&bslash;n&quot;
comma
id|stv680-&gt;vwidth
comma
id|stv680-&gt;vheight
)paren
suffix:semicolon
r_if
c_cond
(paren
id|swapRGB_on
op_eq
l_int|0
)paren
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;swapRGB         : %s&bslash;n&quot;
comma
id|ON_OFF
(paren
id|swapRGB
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|swapRGB_on
op_eq
l_int|1
)paren
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;swapRGB         : (forced) on&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|swapRGB_on
op_eq
op_minus
l_int|1
)paren
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;swapRGB         : (forced) off&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;Palette         : %i&quot;
comma
id|stv680-&gt;palette
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;Frames total    : %d&bslash;n&quot;
comma
id|stv680-&gt;readcount
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;Frames read     : %d&bslash;n&quot;
comma
id|stv680-&gt;framecount
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;Packets dropped : %d&bslash;n&quot;
comma
id|stv680-&gt;dropped
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;Decoding Errors : %d&bslash;n&quot;
comma
id|stv680-&gt;error
)paren
suffix:semicolon
id|len
op_assign
id|out
op_minus
id|page
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|len
op_assign
id|count
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|create_proc_stv680_cam
r_static
r_int
id|create_proc_stv680_cam
(paren
r_struct
id|usb_stv
op_star
id|stv680
)paren
(brace
r_char
id|name
(braket
l_int|9
)braket
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680_proc_entry
op_logical_or
op_logical_neg
id|stv680
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|sprintf
(paren
id|name
comma
l_string|&quot;video%d&quot;
comma
id|stv680-&gt;vdev.minor
)paren
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
(paren
id|name
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|stv680_proc_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
id|stv680
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|stv680_read_proc
suffix:semicolon
id|stv680-&gt;proc_entry
op_assign
id|ent
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|destroy_proc_stv680_cam
r_static
r_void
id|destroy_proc_stv680_cam
(paren
r_struct
id|usb_stv
op_star
id|stv680
)paren
(brace
multiline_comment|/* One to much, just to be sure :) */
r_char
id|name
(braket
l_int|9
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680
op_logical_or
op_logical_neg
id|stv680-&gt;proc_entry
)paren
r_return
suffix:semicolon
id|sprintf
(paren
id|name
comma
l_string|&quot;video%d&quot;
comma
id|stv680-&gt;vdev.minor
)paren
suffix:semicolon
id|remove_proc_entry
(paren
id|name
comma
id|stv680_proc_entry
)paren
suffix:semicolon
id|stv680-&gt;proc_entry
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|proc_stv680_create
r_static
r_int
id|proc_stv680_create
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|video_proc_entry
op_eq
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): /proc/video/ doesn&squot;t exist!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|stv680_proc_entry
op_assign
id|create_proc_entry
(paren
l_string|&quot;stv680&quot;
comma
id|S_IFDIR
comma
id|video_proc_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv680_proc_entry
)paren
(brace
id|stv680_proc_entry-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Unable to initialize /proc/video/stv680&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|proc_stv680_destroy
r_static
r_void
id|proc_stv680_destroy
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|stv680_proc_entry
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;stv&quot;
comma
id|video_proc_entry
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PROC_FS &amp;&amp; CONFIG_VIDEO_PROC_FS */
multiline_comment|/********************************************************************&n; * Camera control&n; *******************************************************************/
DECL|function|stv680_get_pict
r_static
r_int
id|stv680_get_pict
(paren
r_struct
id|usb_stv
op_star
id|stv680
comma
r_struct
id|video_picture
op_star
id|p
)paren
(brace
multiline_comment|/* This sets values for v4l interface. max/min = 65535/0  */
id|p-&gt;brightness
op_assign
id|stv680-&gt;brightness
suffix:semicolon
id|p-&gt;whiteness
op_assign
id|stv680-&gt;whiteness
suffix:semicolon
multiline_comment|/* greyscale */
id|p-&gt;colour
op_assign
id|stv680-&gt;colour
suffix:semicolon
id|p-&gt;contrast
op_assign
id|stv680-&gt;contrast
suffix:semicolon
id|p-&gt;hue
op_assign
id|stv680-&gt;hue
suffix:semicolon
id|p-&gt;palette
op_assign
id|stv680-&gt;palette
suffix:semicolon
id|p-&gt;depth
op_assign
id|stv680-&gt;depth
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stv680_set_pict
r_static
r_int
id|stv680_set_pict
(paren
r_struct
id|usb_stv
op_star
id|stv680
comma
r_struct
id|video_picture
op_star
id|p
)paren
(brace
multiline_comment|/* See above stv680_get_pict  */
r_if
c_cond
(paren
id|p-&gt;palette
op_ne
id|STV_VIDEO_PALETTE
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): Palette set error in _set_pic&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stv680-&gt;brightness
op_ne
id|p-&gt;brightness
)paren
(brace
id|stv680-&gt;chgbright
op_assign
l_int|1
suffix:semicolon
id|stv680-&gt;brightness
op_assign
id|p-&gt;brightness
suffix:semicolon
)brace
id|stv680-&gt;whiteness
op_assign
id|p-&gt;whiteness
suffix:semicolon
multiline_comment|/* greyscale */
id|stv680-&gt;colour
op_assign
id|p-&gt;colour
suffix:semicolon
id|stv680-&gt;contrast
op_assign
id|p-&gt;contrast
suffix:semicolon
id|stv680-&gt;hue
op_assign
id|p-&gt;hue
suffix:semicolon
id|stv680-&gt;palette
op_assign
id|p-&gt;palette
suffix:semicolon
id|stv680-&gt;depth
op_assign
id|p-&gt;depth
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stv680_video_irq
r_static
r_void
id|stv680_video_irq
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_stv
op_star
id|stv680
op_assign
id|urb-&gt;context
suffix:semicolon
r_int
id|length
op_assign
id|urb-&gt;actual_length
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
id|stv680-&gt;rawbufsize
)paren
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(i): Lost data in transfer: exp %li, got %i&quot;
comma
id|stv680-&gt;rawbufsize
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* ohoh... */
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;streaming
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;udev
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): device vapourished in video_irq&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* 0 sized packets happen if we are to fast, but sometimes the camera&n;&t;   keeps sending them forever...&n;&t; */
r_if
c_cond
(paren
id|length
op_logical_and
op_logical_neg
id|urb-&gt;status
)paren
(brace
id|stv680-&gt;nullpackets
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_next
)braket
dot
id|state
)paren
(brace
r_case
id|BUFFER_READY
suffix:colon
r_case
id|BUFFER_BUSY
suffix:colon
id|stv680-&gt;dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUFFER_UNUSED
suffix:colon
id|memcpy
(paren
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_next
)braket
dot
id|data
comma
(paren
r_int
r_char
op_star
)paren
id|urb-&gt;transfer_buffer
comma
id|length
)paren
suffix:semicolon
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_next
)braket
dot
id|state
op_assign
id|BUFFER_READY
suffix:semicolon
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_next
)braket
dot
id|length
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
(paren
op_amp
id|stv680-&gt;wq
)paren
)paren
(brace
id|wake_up_interruptible
(paren
op_amp
id|stv680-&gt;wq
)paren
suffix:semicolon
)brace
id|stv680-&gt;scratch_overflow
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;scratch_next
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;scratch_next
op_ge
id|STV680_NUMSCRATCH
)paren
id|stv680-&gt;scratch_next
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch  */
)brace
r_else
(brace
id|stv680-&gt;nullpackets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;nullpackets
OG
id|STV680_MAX_NULLPACKETS
)paren
(brace
r_if
c_cond
(paren
id|waitqueue_active
(paren
op_amp
id|stv680-&gt;wq
)paren
)paren
(brace
id|wake_up_interruptible
(paren
op_amp
id|stv680-&gt;wq
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*  if - else */
multiline_comment|/* Resubmit urb for new data */
id|urb-&gt;status
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;dev
op_assign
id|stv680-&gt;udev
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
(paren
id|urb
)paren
)paren
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): urb burned down in video irq&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*  _video_irq  */
DECL|function|stv680_start_stream
r_static
r_int
id|stv680_start_stream
(paren
r_struct
id|usb_stv
op_star
id|stv680
)paren
(brace
id|urb_t
op_star
id|urb
suffix:semicolon
r_int
id|err
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|stv680-&gt;streaming
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Do some memory allocation */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stv680-&gt;frame
(braket
id|i
)braket
dot
id|data
op_assign
id|stv680-&gt;fbuf
op_plus
id|i
op_star
id|stv680-&gt;maxframesize
suffix:semicolon
id|stv680-&gt;frame
(braket
id|i
)braket
dot
id|curpix
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* packet size = 4096  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stv680-&gt;sbuf
(braket
id|i
)braket
dot
id|data
op_assign
id|kmalloc
(paren
id|stv680-&gt;rawbufsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;sbuf
(braket
id|i
)braket
dot
id|data
op_eq
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Could not kmalloc raw data buffer %i&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|stv680-&gt;scratch_next
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;scratch_use
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;scratch_overflow
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMSCRATCH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stv680-&gt;scratch
(braket
id|i
)braket
dot
id|data
op_assign
id|kmalloc
(paren
id|stv680-&gt;rawbufsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;scratch
(braket
id|i
)braket
dot
id|data
op_eq
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Could not kmalloc raw scratch buffer %i&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|stv680-&gt;scratch
(braket
id|i
)braket
dot
id|state
op_assign
id|BUFFER_UNUSED
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
r_return
id|ENOMEM
suffix:semicolon
multiline_comment|/* sbuf is urb-&gt;transfer_buffer, later gets memcpyed to scratch */
id|usb_fill_bulk_urb
(paren
id|urb
comma
id|stv680-&gt;udev
comma
id|usb_rcvbulkpipe
(paren
id|stv680-&gt;udev
comma
id|stv680-&gt;bulk_in_endpointAddr
)paren
comma
id|stv680-&gt;sbuf
(braket
id|i
)braket
dot
id|data
comma
id|stv680-&gt;rawbufsize
comma
id|stv680_video_irq
comma
id|stv680
)paren
suffix:semicolon
id|urb-&gt;timeout
op_assign
id|PENCAM_TIMEOUT
op_star
l_int|2
suffix:semicolon
id|urb-&gt;transfer_flags
op_or_assign
id|USB_QUEUE_BULK
suffix:semicolon
id|stv680-&gt;urb
(braket
id|i
)braket
op_assign
id|urb
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
(paren
id|stv680-&gt;urb
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): urb burned down in start stream&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* i STV680_NUMSBUF */
id|stv680-&gt;framecount
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stv680_stop_stream
r_static
r_int
id|stv680_stop_stream
(paren
r_struct
id|usb_stv
op_star
id|stv680
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;streaming
op_logical_or
op_logical_neg
id|stv680-&gt;udev
)paren
r_return
l_int|1
suffix:semicolon
id|stv680-&gt;streaming
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|stv680-&gt;urb
(braket
id|i
)braket
)paren
(brace
id|stv680-&gt;urb
(braket
id|i
)braket
op_member_access_from_pointer
id|next
op_assign
l_int|NULL
suffix:semicolon
id|usb_unlink_urb
(paren
id|stv680-&gt;urb
(braket
id|i
)braket
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|stv680-&gt;urb
(braket
id|i
)braket
)paren
suffix:semicolon
id|stv680-&gt;urb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
(paren
id|stv680-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMSCRATCH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kfree
(paren
id|stv680-&gt;scratch
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
id|stv680-&gt;scratch
(braket
id|i
)braket
dot
id|data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stv680_set_size
r_static
r_int
id|stv680_set_size
(paren
r_struct
id|usb_stv
op_star
id|stv680
comma
r_int
id|width
comma
r_int
id|height
)paren
(brace
r_int
id|wasstreaming
op_assign
id|stv680-&gt;streaming
suffix:semicolon
multiline_comment|/* Check to see if we need to change */
r_if
c_cond
(paren
(paren
id|stv680-&gt;vwidth
op_eq
id|width
)paren
op_logical_and
(paren
id|stv680-&gt;vheight
op_eq
id|height
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): size request for %i x %i&quot;
comma
id|width
comma
id|height
)paren
suffix:semicolon
multiline_comment|/* Check for a valid mode */
r_if
c_cond
(paren
(paren
op_logical_neg
id|width
op_logical_or
op_logical_neg
id|height
)paren
op_logical_or
(paren
(paren
id|width
op_amp
l_int|1
)paren
op_logical_or
(paren
id|height
op_amp
l_int|1
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): set_size error: request: v.width = %i, v.height = %i  actual: stv.width = %i, stv.height = %i&quot;
comma
id|width
comma
id|height
comma
id|stv680-&gt;vwidth
comma
id|stv680-&gt;vheight
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|width
OL
(paren
id|stv680-&gt;maxwidth
op_div
l_int|2
)paren
)paren
op_logical_or
(paren
id|height
OL
(paren
id|stv680-&gt;maxheight
op_div
l_int|2
)paren
)paren
)paren
(brace
id|width
op_assign
id|stv680-&gt;maxwidth
op_div
l_int|2
suffix:semicolon
id|height
op_assign
id|stv680-&gt;maxheight
op_div
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|width
op_ge
l_int|158
)paren
op_logical_and
(paren
id|width
op_le
l_int|166
)paren
)paren
(brace
id|width
op_assign
l_int|160
suffix:semicolon
id|height
op_assign
l_int|120
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|width
op_ge
l_int|172
)paren
op_logical_and
(paren
id|width
op_le
l_int|180
)paren
)paren
(brace
id|width
op_assign
l_int|176
suffix:semicolon
id|height
op_assign
l_int|144
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|width
op_ge
l_int|318
)paren
op_logical_and
(paren
id|width
op_le
l_int|350
)paren
)paren
(brace
id|width
op_assign
l_int|320
suffix:semicolon
id|height
op_assign
l_int|240
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|width
op_ge
l_int|350
)paren
op_logical_and
(paren
id|width
op_le
l_int|358
)paren
)paren
(brace
id|width
op_assign
l_int|352
suffix:semicolon
id|height
op_assign
l_int|288
suffix:semicolon
)brace
multiline_comment|/* Stop a current stream and start it again at the new size */
r_if
c_cond
(paren
id|wasstreaming
)paren
id|stv680_stop_stream
(paren
id|stv680
)paren
suffix:semicolon
id|stv680-&gt;vwidth
op_assign
id|width
suffix:semicolon
id|stv680-&gt;vheight
op_assign
id|height
suffix:semicolon
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(i): size set to %i x %i&quot;
comma
id|stv680-&gt;vwidth
comma
id|stv680-&gt;vheight
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wasstreaming
)paren
id|stv680_start_stream
(paren
id|stv680
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; * Video Decoding&n; **********************************************************************/
multiline_comment|/*******  routines from the pencam program; hey, they work!  ********/
multiline_comment|/*&n; * STV0680 Vision Camera Chipset Driver&n; * Copyright (C) 2000 Adam Harrison &lt;adam@antispin.org&gt; &n;*/
DECL|macro|RED
mdefine_line|#define RED 0
DECL|macro|GREEN
mdefine_line|#define GREEN 1
DECL|macro|BLUE
mdefine_line|#define BLUE 2
DECL|macro|AD
mdefine_line|#define AD(x, y, w) (((y)*(w)+(x))*3)
DECL|function|bayer_unshuffle
r_static
r_void
id|bayer_unshuffle
(paren
r_struct
id|usb_stv
op_star
id|stv680
comma
r_struct
id|stv680_scratch
op_star
id|buffer
)paren
(brace
r_int
id|x
comma
id|y
comma
id|i
suffix:semicolon
r_int
id|w
op_assign
id|stv680-&gt;cwidth
suffix:semicolon
r_int
id|vw
op_assign
id|stv680-&gt;cwidth
comma
id|vh
op_assign
id|stv680-&gt;cheight
suffix:semicolon
r_int
r_int
id|p
op_assign
l_int|0
suffix:semicolon
r_int
id|colour
op_assign
l_int|0
comma
id|bayer
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|raw
op_assign
id|buffer-&gt;data
suffix:semicolon
r_struct
id|stv680_frame
op_star
id|frame
op_assign
op_amp
id|stv680-&gt;frame
(braket
id|stv680-&gt;curframe
)braket
suffix:semicolon
r_int
r_char
op_star
id|output
op_assign
id|frame-&gt;data
suffix:semicolon
r_int
r_char
op_star
id|temp
op_assign
id|frame-&gt;data
suffix:semicolon
r_int
id|offset
op_assign
id|buffer-&gt;offset
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;curpix
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_READY
)paren
(brace
id|frame-&gt;grabstate
op_assign
id|FRAME_GRABBING
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|offset
op_ne
id|frame-&gt;curpix
)paren
(brace
multiline_comment|/* Regard frame as lost :( */
id|frame-&gt;curpix
op_assign
l_int|0
suffix:semicolon
id|stv680-&gt;error
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|stv680-&gt;vwidth
op_eq
l_int|320
)paren
op_logical_or
(paren
id|stv680-&gt;vwidth
op_eq
l_int|160
)paren
)paren
(brace
id|vw
op_assign
l_int|320
suffix:semicolon
id|vh
op_assign
l_int|240
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|stv680-&gt;vwidth
op_eq
l_int|352
)paren
op_logical_or
(paren
id|stv680-&gt;vwidth
op_eq
l_int|176
)paren
)paren
(brace
id|vw
op_assign
l_int|352
suffix:semicolon
id|vh
op_assign
l_int|288
suffix:semicolon
)brace
id|memset
(paren
id|output
comma
l_int|0
comma
l_int|3
op_star
id|vw
op_star
id|vh
)paren
suffix:semicolon
multiline_comment|/* clear output matrix. */
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|vh
suffix:semicolon
id|y
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|vw
suffix:semicolon
id|x
op_increment
)paren
(brace
r_if
c_cond
(paren
id|x
op_amp
l_int|1
)paren
id|p
op_assign
op_star
(paren
id|raw
op_plus
id|y
op_star
id|w
op_plus
(paren
id|x
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
r_else
id|p
op_assign
op_star
(paren
id|raw
op_plus
id|y
op_star
id|w
op_plus
(paren
id|x
op_rshift
l_int|1
)paren
op_plus
(paren
id|w
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|y
op_amp
l_int|1
)paren
id|bayer
op_assign
l_int|2
suffix:semicolon
r_else
id|bayer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|x
op_amp
l_int|1
)paren
id|bayer
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|bayer
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|3
suffix:colon
id|colour
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|colour
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|colour
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_assign
(paren
id|y
op_star
id|vw
op_plus
id|x
)paren
op_star
l_int|3
suffix:semicolon
op_star
(paren
id|output
op_plus
id|i
op_plus
id|colour
)paren
op_assign
(paren
r_int
r_char
)paren
id|p
suffix:semicolon
)brace
multiline_comment|/* for x */
)brace
multiline_comment|/* for y */
multiline_comment|/****** gamma correction plus hardcoded white balance */
multiline_comment|/* Thanks to Alexander Schwartx &lt;alexander.schwartx@gmx.net&gt; for this code.&n;&t;   Correction values red[], green[], blue[], are generated by &n;&t;   (pow(i/256.0, GAMMA)*255.0)*white balanceRGB where GAMMA=0.55, 1&lt;i&lt;255. &n;&t;   White balance (RGB)= 1.0, 1.17, 1.48. Values are calculated as double float and &n;&t;   converted to unsigned char. Values are in stv680.h  */
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|vh
suffix:semicolon
id|y
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|vw
suffix:semicolon
id|x
op_increment
)paren
(brace
id|i
op_assign
(paren
id|y
op_star
id|vw
op_plus
id|x
)paren
op_star
l_int|3
suffix:semicolon
op_star
(paren
id|output
op_plus
id|i
)paren
op_assign
id|red
(braket
op_star
(paren
id|output
op_plus
id|i
)paren
)braket
suffix:semicolon
op_star
(paren
id|output
op_plus
id|i
op_plus
l_int|1
)paren
op_assign
id|green
(braket
op_star
(paren
id|output
op_plus
id|i
op_plus
l_int|1
)paren
)braket
suffix:semicolon
op_star
(paren
id|output
op_plus
id|i
op_plus
l_int|2
)paren
op_assign
id|blue
(braket
op_star
(paren
id|output
op_plus
id|i
op_plus
l_int|2
)paren
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/******  bayer demosaic  ******/
r_for
c_loop
(paren
id|y
op_assign
l_int|1
suffix:semicolon
id|y
OL
(paren
id|vh
op_minus
l_int|1
)paren
suffix:semicolon
id|y
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|1
suffix:semicolon
id|x
OL
(paren
id|vw
op_minus
l_int|1
)paren
suffix:semicolon
id|x
op_increment
)paren
(brace
multiline_comment|/* work out pixel type */
r_if
c_cond
(paren
id|y
op_amp
l_int|1
)paren
id|bayer
op_assign
l_int|0
suffix:semicolon
r_else
id|bayer
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|x
op_amp
l_int|1
)paren
)paren
id|bayer
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|bayer
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* green. blue lr, red tb */
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
comma
id|vw
)paren
op_plus
id|BLUE
)paren
op_assign
(paren
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_minus
l_int|1
comma
id|y
comma
id|vw
)paren
op_plus
id|BLUE
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_plus
l_int|1
comma
id|y
comma
id|vw
)paren
op_plus
id|BLUE
)paren
)paren
op_rshift
l_int|1
suffix:semicolon
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
comma
id|vw
)paren
op_plus
id|RED
)paren
op_assign
(paren
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
op_minus
l_int|1
comma
id|vw
)paren
op_plus
id|RED
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
op_plus
l_int|1
comma
id|vw
)paren
op_plus
id|RED
)paren
)paren
op_rshift
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* blue. green lrtb, red diagonals */
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
comma
id|vw
)paren
op_plus
id|GREEN
)paren
op_assign
(paren
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_minus
l_int|1
comma
id|y
comma
id|vw
)paren
op_plus
id|GREEN
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_plus
l_int|1
comma
id|y
comma
id|vw
)paren
op_plus
id|GREEN
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
op_minus
l_int|1
comma
id|vw
)paren
op_plus
id|GREEN
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
op_plus
l_int|1
comma
id|vw
)paren
op_plus
id|GREEN
)paren
)paren
op_rshift
l_int|2
suffix:semicolon
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
comma
id|vw
)paren
op_plus
id|RED
)paren
op_assign
(paren
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_minus
l_int|1
comma
id|y
op_minus
l_int|1
comma
id|vw
)paren
op_plus
id|RED
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_minus
l_int|1
comma
id|y
op_plus
l_int|1
comma
id|vw
)paren
op_plus
id|RED
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_plus
l_int|1
comma
id|y
op_minus
l_int|1
comma
id|vw
)paren
op_plus
id|RED
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_plus
l_int|1
comma
id|y
op_plus
l_int|1
comma
id|vw
)paren
op_plus
id|RED
)paren
)paren
op_rshift
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* red. green lrtb, blue diagonals */
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
comma
id|vw
)paren
op_plus
id|GREEN
)paren
op_assign
(paren
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_minus
l_int|1
comma
id|y
comma
id|vw
)paren
op_plus
id|GREEN
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_plus
l_int|1
comma
id|y
comma
id|vw
)paren
op_plus
id|GREEN
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
op_minus
l_int|1
comma
id|vw
)paren
op_plus
id|GREEN
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
op_plus
l_int|1
comma
id|vw
)paren
op_plus
id|GREEN
)paren
)paren
op_rshift
l_int|2
suffix:semicolon
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
comma
id|vw
)paren
op_plus
id|BLUE
)paren
op_assign
(paren
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_minus
l_int|1
comma
id|y
op_minus
l_int|1
comma
id|vw
)paren
op_plus
id|BLUE
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_plus
l_int|1
comma
id|y
op_minus
l_int|1
comma
id|vw
)paren
op_plus
id|BLUE
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_minus
l_int|1
comma
id|y
op_plus
l_int|1
comma
id|vw
)paren
op_plus
id|BLUE
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_plus
l_int|1
comma
id|y
op_plus
l_int|1
comma
id|vw
)paren
op_plus
id|BLUE
)paren
)paren
op_rshift
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* green. red lr, blue tb */
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
comma
id|vw
)paren
op_plus
id|RED
)paren
op_assign
(paren
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_minus
l_int|1
comma
id|y
comma
id|vw
)paren
op_plus
id|RED
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
op_plus
l_int|1
comma
id|y
comma
id|vw
)paren
op_plus
id|RED
)paren
)paren
op_rshift
l_int|1
suffix:semicolon
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
comma
id|vw
)paren
op_plus
id|BLUE
)paren
op_assign
(paren
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
op_minus
l_int|1
comma
id|vw
)paren
op_plus
id|BLUE
)paren
op_plus
(paren
r_int
)paren
op_star
(paren
id|output
op_plus
id|AD
(paren
id|x
comma
id|y
op_plus
l_int|1
comma
id|vw
)paren
op_plus
id|BLUE
)paren
)paren
op_rshift
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
)brace
multiline_comment|/* for x */
)brace
multiline_comment|/* for y  - end demosaic  */
multiline_comment|/* fix top and bottom row, left and right side */
id|i
op_assign
id|vw
op_star
l_int|3
suffix:semicolon
id|memcpy
(paren
id|output
comma
(paren
id|output
op_plus
id|i
)paren
comma
id|i
)paren
suffix:semicolon
id|memcpy
(paren
(paren
id|output
op_plus
(paren
id|vh
op_star
id|i
)paren
)paren
comma
(paren
id|output
op_plus
(paren
(paren
id|vh
op_minus
l_int|1
)paren
op_star
id|i
)paren
)paren
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|vh
suffix:semicolon
id|y
op_increment
)paren
(brace
id|i
op_assign
id|y
op_star
id|vw
op_star
l_int|3
suffix:semicolon
id|memcpy
(paren
(paren
id|output
op_plus
id|i
)paren
comma
(paren
id|output
op_plus
id|i
op_plus
l_int|3
)paren
comma
l_int|3
)paren
suffix:semicolon
id|memcpy
(paren
(paren
id|output
op_plus
id|i
op_plus
(paren
id|vw
op_star
l_int|3
)paren
)paren
comma
(paren
id|output
op_plus
id|i
op_plus
(paren
id|vw
op_minus
l_int|1
)paren
op_star
l_int|3
)paren
comma
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/*  process all raw data, then trim to size if necessary */
r_if
c_cond
(paren
(paren
id|stv680-&gt;vwidth
op_eq
l_int|160
)paren
op_logical_or
(paren
id|stv680-&gt;vwidth
op_eq
l_int|176
)paren
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|vh
suffix:semicolon
id|y
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|y
op_amp
l_int|1
)paren
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|vw
suffix:semicolon
id|x
op_increment
)paren
(brace
id|p
op_assign
(paren
id|y
op_star
id|vw
op_plus
id|x
)paren
op_star
l_int|3
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|x
op_amp
l_int|1
)paren
)paren
(brace
op_star
(paren
id|output
op_plus
id|i
)paren
op_assign
op_star
(paren
id|output
op_plus
id|p
)paren
suffix:semicolon
op_star
(paren
id|output
op_plus
id|i
op_plus
l_int|1
)paren
op_assign
op_star
(paren
id|output
op_plus
id|p
op_plus
l_int|1
)paren
suffix:semicolon
op_star
(paren
id|output
op_plus
id|i
op_plus
l_int|2
)paren
op_assign
op_star
(paren
id|output
op_plus
id|p
op_plus
l_int|2
)paren
suffix:semicolon
id|i
op_add_assign
l_int|3
suffix:semicolon
)brace
)brace
multiline_comment|/* for x */
)brace
)brace
multiline_comment|/* for y */
)brace
multiline_comment|/* reset to proper width */
r_if
c_cond
(paren
(paren
id|stv680-&gt;vwidth
op_eq
l_int|160
)paren
)paren
(brace
id|vw
op_assign
l_int|160
suffix:semicolon
id|vh
op_assign
l_int|120
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|stv680-&gt;vwidth
op_eq
l_int|176
)paren
)paren
(brace
id|vw
op_assign
l_int|176
suffix:semicolon
id|vh
op_assign
l_int|144
suffix:semicolon
)brace
multiline_comment|/* output is RGB; some programs want BGR  */
multiline_comment|/* swapRGB_on=0 -&gt; program decides;  swapRGB_on=1, always swap */
multiline_comment|/* swapRGB_on=-1, never swap */
r_if
c_cond
(paren
(paren
(paren
id|swapRGB
op_eq
l_int|1
)paren
op_logical_and
(paren
id|swapRGB_on
op_ne
op_minus
l_int|1
)paren
)paren
op_logical_or
(paren
id|swapRGB_on
op_eq
l_int|1
)paren
)paren
(brace
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|vh
suffix:semicolon
id|y
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|vw
suffix:semicolon
id|x
op_increment
)paren
(brace
id|i
op_assign
(paren
id|y
op_star
id|vw
op_plus
id|x
)paren
op_star
l_int|3
suffix:semicolon
op_star
(paren
id|temp
)paren
op_assign
op_star
(paren
id|output
op_plus
id|i
)paren
suffix:semicolon
op_star
(paren
id|output
op_plus
id|i
)paren
op_assign
op_star
(paren
id|output
op_plus
id|i
op_plus
l_int|2
)paren
suffix:semicolon
op_star
(paren
id|output
op_plus
id|i
op_plus
l_int|2
)paren
op_assign
op_star
(paren
id|temp
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* brightness */
r_if
c_cond
(paren
id|stv680-&gt;chgbright
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|stv680-&gt;brightness
op_ge
l_int|32767
)paren
(brace
id|p
op_assign
(paren
id|stv680-&gt;brightness
op_minus
l_int|32767
)paren
op_div
l_int|256
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
(paren
id|vw
op_star
id|vh
op_star
l_int|3
)paren
suffix:semicolon
id|x
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
(paren
id|output
op_plus
id|x
)paren
op_plus
(paren
r_int
r_char
)paren
id|p
)paren
OG
l_int|255
)paren
op_star
(paren
id|output
op_plus
id|x
)paren
op_assign
l_int|255
suffix:semicolon
r_else
op_star
(paren
id|output
op_plus
id|x
)paren
op_add_assign
(paren
r_int
r_char
)paren
id|p
suffix:semicolon
)brace
multiline_comment|/* for */
)brace
r_else
(brace
id|p
op_assign
(paren
l_int|32767
op_minus
id|stv680-&gt;brightness
)paren
op_div
l_int|256
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
(paren
id|vw
op_star
id|vh
op_star
l_int|3
)paren
suffix:semicolon
id|x
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
r_char
)paren
id|p
OG
op_star
(paren
id|output
op_plus
id|x
)paren
)paren
op_star
(paren
id|output
op_plus
id|x
)paren
op_assign
l_int|0
suffix:semicolon
r_else
op_star
(paren
id|output
op_plus
id|x
)paren
op_sub_assign
(paren
r_int
r_char
)paren
id|p
suffix:semicolon
)brace
multiline_comment|/* for */
)brace
multiline_comment|/* else */
)brace
multiline_comment|/* if */
id|frame-&gt;curpix
op_assign
l_int|0
suffix:semicolon
id|frame-&gt;curlinepix
op_assign
l_int|0
suffix:semicolon
id|frame-&gt;grabstate
op_assign
id|FRAME_DONE
suffix:semicolon
id|stv680-&gt;framecount
op_increment
suffix:semicolon
id|stv680-&gt;readcount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;frame
(braket
(paren
id|stv680-&gt;curframe
op_plus
l_int|1
)paren
op_amp
(paren
id|STV680_NUMFRAMES
op_minus
l_int|1
)paren
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
)paren
(brace
id|stv680-&gt;curframe
op_assign
(paren
id|stv680-&gt;curframe
op_plus
l_int|1
)paren
op_amp
(paren
id|STV680_NUMFRAMES
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* bayer_unshuffle */
multiline_comment|/*******  end routines from the pencam program  *********/
DECL|function|stv680_newframe
r_static
r_int
id|stv680_newframe
(paren
r_struct
id|usb_stv
op_star
id|stv680
comma
r_int
id|framenr
)paren
(brace
r_int
id|errors
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|stv680-&gt;streaming
op_logical_and
(paren
id|stv680-&gt;frame
(braket
id|framenr
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
op_logical_or
id|stv680-&gt;frame
(braket
id|framenr
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;frame
(braket
id|framenr
)braket
dot
id|curpix
)paren
(brace
id|errors
op_increment
suffix:semicolon
)brace
id|wait_event_interruptible
(paren
id|stv680-&gt;wq
comma
(paren
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_use
)braket
dot
id|state
op_eq
id|BUFFER_READY
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;nullpackets
OG
id|STV680_MAX_NULLPACKETS
)paren
(brace
id|stv680-&gt;nullpackets
op_assign
l_int|0
suffix:semicolon
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(i): too many null length packets, restarting capture&quot;
)paren
suffix:semicolon
id|stv680_stop_stream
(paren
id|stv680
)paren
suffix:semicolon
id|stv680_start_stream
(paren
id|stv680
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_use
)braket
dot
id|state
op_ne
id|BUFFER_READY
)paren
(brace
id|stv680-&gt;frame
(braket
id|framenr
)braket
dot
id|grabstate
op_assign
id|FRAME_ERROR
suffix:semicolon
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): FRAME_ERROR in _newframe&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_use
)braket
dot
id|state
op_assign
id|BUFFER_BUSY
suffix:semicolon
id|bayer_unshuffle
(paren
id|stv680
comma
op_amp
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_use
)braket
)paren
suffix:semicolon
id|stv680-&gt;scratch
(braket
id|stv680-&gt;scratch_use
)braket
dot
id|state
op_assign
id|BUFFER_UNUSED
suffix:semicolon
id|stv680-&gt;scratch_use
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;scratch_use
op_ge
id|STV680_NUMSCRATCH
)paren
id|stv680-&gt;scratch_use
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|errors
OG
id|STV680_MAX_ERRORS
)paren
(brace
id|errors
op_assign
l_int|0
suffix:semicolon
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(i): too many errors, restarting capture&quot;
)paren
suffix:semicolon
id|stv680_stop_stream
(paren
id|stv680
)paren
suffix:semicolon
id|stv680_start_stream
(paren
id|stv680
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* else */
)brace
multiline_comment|/* while */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n; * Video4Linux&n; *********************************************************************/
DECL|function|stv_open
r_static
r_int
id|stv_open
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|usb_stv
op_star
id|stv680
op_assign
(paren
r_struct
id|usb_stv
op_star
)paren
id|dev
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we are called with the BKL held */
id|MOD_INC_USE_COUNT
suffix:semicolon
id|stv680-&gt;user
op_assign
l_int|1
suffix:semicolon
id|err
op_assign
id|stv_init
(paren
id|stv680
)paren
suffix:semicolon
multiline_comment|/* main initialization routine for camera */
r_if
c_cond
(paren
id|err
op_ge
l_int|0
)paren
(brace
id|stv680-&gt;fbuf
op_assign
id|rvmalloc
(paren
id|stv680-&gt;maxframesize
op_star
id|STV680_NUMFRAMES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;fbuf
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Could not rvmalloc frame bufer&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|stv680-&gt;user
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|stv_close
r_static
r_void
id|stv_close
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
multiline_comment|/* called with BKL held */
r_struct
id|usb_stv
op_star
id|stv680
op_assign
(paren
r_struct
id|usb_stv
op_star
)paren
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
id|stv680-&gt;frame
(braket
id|i
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;streaming
)paren
id|stv680_stop_stream
(paren
id|stv680
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|stv_stop_video
(paren
id|stv680
)paren
)paren
OL
l_int|0
)paren
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;STV(e): stop_video failed in stv_close&quot;
)paren
suffix:semicolon
id|rvfree
(paren
id|stv680-&gt;fbuf
comma
id|stv680-&gt;maxframesize
op_star
id|STV680_NUMFRAMES
)paren
suffix:semicolon
id|stv680-&gt;user
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;removed
)paren
(brace
id|video_unregister_device
(paren
op_amp
id|stv680-&gt;vdev
)paren
suffix:semicolon
id|kfree
(paren
id|stv680
)paren
suffix:semicolon
id|stv680
op_assign
l_int|NULL
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): device unregistered&quot;
)paren
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|stv680_write
r_static
r_int
id|stv680_write
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|stv680_ioctl
r_static
r_int
id|stv680_ioctl
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|usb_stv
op_star
id|stv680
op_assign
(paren
r_struct
id|usb_stv
op_star
)paren
id|vdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;udev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|strcpy
(paren
id|b.name
comma
id|stv680-&gt;camera_name
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
suffix:semicolon
id|b.channels
op_assign
l_int|1
suffix:semicolon
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
id|stv680-&gt;maxwidth
suffix:semicolon
id|b.maxheight
op_assign
id|stv680-&gt;maxheight
suffix:semicolon
id|b.minwidth
op_assign
id|stv680-&gt;maxwidth
op_div
l_int|2
suffix:semicolon
id|b.minheight
op_assign
id|stv680-&gt;maxheight
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCGGAP failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v.channel
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|strcpy
(paren
id|v.name
comma
l_string|&quot;STV Camera&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCGCHAN failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCSCHAN failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
id|stv680_get_pict
(paren
id|stv680
comma
op_amp
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCGPICT failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCSPICT failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|copy_from_user
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(i): palette set to %i in VIDIOSPICT&quot;
comma
id|p.palette
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv680_set_pict
(paren
id|stv680
comma
op_amp
id|p
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vw.flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.clipcount
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.width
op_ne
id|stv680-&gt;vwidth
)paren
(brace
r_if
c_cond
(paren
id|stv680_set_size
(paren
id|stv680
comma
id|vw.width
comma
id|vw.height
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): failed (from user) set size in VIDIOCSWIN&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|vw.x
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME */
id|vw.y
op_assign
l_int|0
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|0
suffix:semicolon
id|vw.clipcount
op_assign
l_int|0
suffix:semicolon
id|vw.width
op_assign
id|stv680-&gt;vwidth
suffix:semicolon
id|vw.height
op_assign
id|stv680-&gt;vheight
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCGWIN failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
(paren
op_amp
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|STV680_NUMFRAMES
op_star
id|stv680-&gt;maxframesize
suffix:semicolon
id|vm.frames
op_assign
id|STV680_NUMFRAMES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
id|vm.offsets
(braket
id|i
)braket
op_assign
id|stv680-&gt;maxframesize
op_star
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCGMBUF failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|vm
comma
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCMCAPTURE failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vm.format
op_ne
id|STV_VIDEO_PALETTE
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(i): VIDIOCMCAPTURE vm.format (%i) != VIDEO_PALETTE (%i)&quot;
comma
id|vm.format
comma
id|STV_VIDEO_PALETTE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vm.format
op_eq
l_int|3
)paren
op_logical_and
(paren
id|swapRGB_on
op_eq
l_int|0
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(i): VIDIOCMCAPTURE swapRGB is (auto) ON&quot;
)paren
suffix:semicolon
multiline_comment|/* this may fix those apps (e.g., xawtv) that want BGR */
id|swapRGB
op_assign
l_int|1
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vm.frame
op_ge
id|STV680_NUMFRAMES
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCMCAPTURE vm.frame &gt; NUMFRAMES&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|stv680-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_eq
id|FRAME_ERROR
)paren
op_logical_or
(paren
id|stv680-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCMCAPTURE grabstate (%i) error&quot;
comma
id|stv680-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Is this according to the v4l spec??? */
r_if
c_cond
(paren
id|stv680-&gt;vwidth
op_ne
id|vm.width
)paren
(brace
r_if
c_cond
(paren
id|stv680_set_size
(paren
id|stv680
comma
id|vm.width
comma
id|vm.height
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCMCAPTURE set_size failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|stv680-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_assign
id|FRAME_READY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;streaming
)paren
id|stv680_start_stream
(paren
id|stv680
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|frame
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
(paren
r_void
op_star
)paren
op_amp
id|frame
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCSYNC failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|frame
OL
l_int|0
op_logical_or
id|frame
op_ge
id|STV680_NUMFRAMES
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): Bad frame # in VIDIOCSYNC&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ret
op_assign
id|stv680_newframe
(paren
id|stv680
comma
id|frame
)paren
suffix:semicolon
id|stv680-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|vb
suffix:semicolon
id|memset
(paren
op_amp
id|vb
comma
l_int|0
comma
r_sizeof
(paren
id|vb
)paren
)paren
suffix:semicolon
id|vb.base
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* frame buffer not supported, not used */
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vb
comma
r_sizeof
(paren
id|vb
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCSYNC failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|VIDIOCCAPTURE
suffix:colon
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): VIDIOCCAPTURE failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
id|VIDIOCSFBUF
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGTUNER
suffix:colon
r_case
id|VIDIOCSTUNER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGFREQ
suffix:colon
r_case
id|VIDIOCSFREQ
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
multiline_comment|/* end switch */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stv680_mmap
r_static
r_int
id|stv680_mmap
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|usb_stv
op_star
id|stv680
op_assign
(paren
r_struct
id|usb_stv
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
id|down
(paren
op_amp
id|stv680-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stv680-&gt;udev
op_eq
l_int|NULL
)paren
(brace
id|up
(paren
op_amp
id|stv680-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OG
(paren
(paren
(paren
id|STV680_NUMFRAMES
op_star
id|stv680-&gt;maxframesize
)paren
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|up
(paren
op_amp
id|stv680-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pos
op_assign
(paren
r_int
r_int
)paren
id|stv680-&gt;fbuf
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
(paren
id|vma
comma
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
(brace
id|up
(paren
op_amp
id|stv680-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|up
(paren
op_amp
id|stv680-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stv680_read
r_static
r_int
id|stv680_read
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_int
r_int
r_int
id|realcount
op_assign
id|count
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|usb_stv
op_star
id|stv680
op_assign
(paren
r_struct
id|usb_stv
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|STV680_NUMFRAMES
op_ne
l_int|2
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): STV680_NUMFRAMES needs to be 2!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stv680-&gt;udev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|realcount
OG
(paren
id|stv680-&gt;vwidth
op_star
id|stv680-&gt;vheight
op_star
l_int|3
)paren
)paren
id|realcount
op_assign
id|stv680-&gt;vwidth
op_star
id|stv680-&gt;vheight
op_star
l_int|3
suffix:semicolon
multiline_comment|/* Shouldn&squot;t happen: */
r_if
c_cond
(paren
id|stv680-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): FRAME_GRABBING in stv680_read&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|stv680-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_assign
id|FRAME_READY
suffix:semicolon
id|stv680-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
id|stv680-&gt;curframe
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;streaming
)paren
id|stv680_start_stream
(paren
id|stv680
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;streaming
)paren
(brace
id|ret
op_assign
id|stv680_newframe
(paren
id|stv680
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ret should = 0 */
)brace
id|ret
op_assign
id|stv680_newframe
(paren
id|stv680
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|copy_to_user
(paren
id|buf
comma
id|stv680-&gt;frame
(braket
l_int|0
)braket
dot
id|data
comma
id|realcount
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|PDEBUG
(paren
l_int|2
comma
l_string|&quot;STV(e): copy_to_user frame 0 failed, ret count = %li&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_else
(brace
id|realcount
op_assign
id|ret
suffix:semicolon
)brace
id|stv680-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_return
id|realcount
suffix:semicolon
)brace
multiline_comment|/* stv680_read */
DECL|function|stv_init_done
r_static
r_int
id|stv_init_done
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
r_if
c_cond
(paren
id|create_proc_stv680_cam
(paren
(paren
r_struct
id|usb_stv
op_star
)paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|stv680_template
r_static
r_struct
id|video_device
id|stv680_template
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|name
suffix:colon
l_string|&quot;STV0680 USB camera&quot;
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
comma
id|hardware
suffix:colon
id|VID_HARDWARE_SE401
comma
id|open
suffix:colon
id|stv_open
comma
id|close
suffix:colon
id|stv_close
comma
id|read
suffix:colon
id|stv680_read
comma
id|write
suffix:colon
id|stv680_write
comma
id|ioctl
suffix:colon
id|stv680_ioctl
comma
id|mmap
suffix:colon
id|stv680_mmap
comma
id|initialize
suffix:colon
id|stv_init_done
comma
)brace
suffix:semicolon
DECL|function|stv680_probe
r_static
r_void
op_star
id|__devinit
id|stv680_probe
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|ifnum
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_stv
op_star
id|stv680
suffix:semicolon
r_char
op_star
id|camera_name
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-config cameras */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Number of Configurations != 1&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|interface
op_assign
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Is it a STV680? */
r_if
c_cond
(paren
(paren
id|dev-&gt;descriptor.idVendor
op_eq
id|USB_PENCAM_VENDOR_ID
)paren
op_logical_and
(paren
id|dev-&gt;descriptor.idProduct
op_eq
id|USB_PENCAM_PRODUCT_ID
)paren
)paren
(brace
id|camera_name
op_assign
l_string|&quot;STV0680&quot;
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): STV0680 camera found.&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Vendor/Product ID do not match STV0680 values.&quot;
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Check that the STV0680 camera is connected to the computer.&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* We found one */
r_if
c_cond
(paren
(paren
id|stv680
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|stv680
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): couldn&squot;t kmalloc stv680 struct.&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
(paren
id|stv680
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|stv680
)paren
)paren
suffix:semicolon
id|stv680-&gt;udev
op_assign
id|dev
suffix:semicolon
id|stv680-&gt;camera_name
op_assign
id|camera_name
suffix:semicolon
id|memcpy
(paren
op_amp
id|stv680-&gt;vdev
comma
op_amp
id|stv680_template
comma
r_sizeof
(paren
id|stv680_template
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|stv680-&gt;vdev.name
comma
id|stv680-&gt;camera_name
comma
id|strlen
(paren
id|stv680-&gt;camera_name
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|stv680-&gt;wq
)paren
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|stv680-&gt;lock
)paren
suffix:semicolon
id|wmb
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
(paren
op_amp
id|stv680-&gt;vdev
comma
id|VFL_TYPE_GRABBER
comma
id|video_nr
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|kfree
(paren
id|stv680
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): video_register_device failed&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): registered new video device: video%d&quot;
comma
id|stv680-&gt;vdev.minor
)paren
suffix:semicolon
r_return
id|stv680
suffix:semicolon
)brace
DECL|function|usb_stv680_remove_disconnected
r_static
r_inline
r_void
id|usb_stv680_remove_disconnected
(paren
r_struct
id|usb_stv
op_star
id|stv680
)paren
(brace
r_int
id|i
suffix:semicolon
id|stv680-&gt;udev
op_assign
l_int|NULL
suffix:semicolon
id|stv680-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_assign
id|FRAME_ERROR
suffix:semicolon
id|stv680-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_assign
id|FRAME_ERROR
suffix:semicolon
id|stv680-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|stv680-&gt;wq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|stv680-&gt;urb
(braket
id|i
)braket
)paren
(brace
id|stv680-&gt;urb
(braket
id|i
)braket
op_member_access_from_pointer
id|next
op_assign
l_int|NULL
suffix:semicolon
id|usb_unlink_urb
(paren
id|stv680-&gt;urb
(braket
id|i
)braket
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|stv680-&gt;urb
(braket
id|i
)braket
)paren
suffix:semicolon
id|stv680-&gt;urb
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
(paren
id|stv680-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STV680_NUMSCRATCH
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|stv680-&gt;scratch
(braket
id|i
)braket
dot
id|data
)paren
(brace
id|kfree
(paren
id|stv680-&gt;scratch
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): %s disconnected&quot;
comma
id|stv680-&gt;camera_name
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|destroy_proc_stv680_cam
(paren
id|stv680
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Free the memory */
id|kfree
(paren
id|stv680
)paren
suffix:semicolon
)brace
DECL|function|stv680_disconnect
r_static
r_void
id|stv680_disconnect
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|usb_stv
op_star
id|stv680
op_assign
(paren
r_struct
id|usb_stv
op_star
)paren
id|ptr
suffix:semicolon
id|lock_kernel
(paren
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want people trying to open up the device */
r_if
c_cond
(paren
op_logical_neg
id|stv680-&gt;user
)paren
(brace
id|video_unregister_device
(paren
op_amp
id|stv680-&gt;vdev
)paren
suffix:semicolon
id|usb_stv680_remove_disconnected
(paren
id|stv680
)paren
suffix:semicolon
)brace
r_else
(brace
id|stv680-&gt;removed
op_assign
l_int|1
suffix:semicolon
)brace
id|unlock_kernel
(paren
)paren
suffix:semicolon
)brace
DECL|variable|stv680_driver
r_static
r_struct
id|usb_driver
id|stv680_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;stv680&quot;
comma
id|probe
suffix:colon
id|stv680_probe
comma
id|disconnect
suffix:colon
id|stv680_disconnect
comma
id|id_table
suffix:colon
id|device_table
)brace
suffix:semicolon
multiline_comment|/********************************************************************&n; *  Module routines&n; ********************************************************************/
DECL|function|usb_stv680_init
r_static
r_int
id|__init
id|usb_stv680_init
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
r_if
c_cond
(paren
id|proc_stv680_create
(paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|usb_register
(paren
op_amp
id|stv680_driver
)paren
OL
l_int|0
)paren
(brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(e): Could not setup STV0680 driver&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): usb camera driver version %s registering&quot;
comma
id|DRIVER_VERSION
)paren
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_stv680_exit
r_static
r_void
id|__exit
id|usb_stv680_exit
(paren
r_void
)paren
(brace
id|usb_deregister
(paren
op_amp
id|stv680_driver
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|0
comma
l_string|&quot;STV(i): driver deregistered&quot;
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|proc_stv680_destroy
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|usb_stv680_init
id|module_init
(paren
id|usb_stv680_init
)paren
suffix:semicolon
DECL|variable|usb_stv680_exit
id|module_exit
(paren
id|usb_stv680_exit
)paren
suffix:semicolon
eof
