multiline_comment|/*  &n;    UHCI HCD (Host Controller Driver) for USB, UHCI Root Hub&n;    &n;    (c) 1999-2002 &n;    Georg Acher      +    Deti Fliegl    +    Thomas Sailer&n;    georg@acher.org      deti@fliegl.de   sailer@ife.ee.ethz.ch&n;   &n;    with the help of&n;    David Brownell, david-b@pacbell.net&n;    Adam Richter, adam@yggdrasil.com&n;    Roman Weissgaerber, weissg@vienna.at&n;    &n;    HW-initalization based on material of&n;    Randy Dunlap + Johannes Erdfelt + Gregory P. Smith + Linus Torvalds &n;&n;    $Id: usb-uhci-hub.c,v 1.1 2002/05/14 20:36:57 acher Exp $&n;*/
DECL|macro|CLR_RH_PORTSTAT
mdefine_line|#define CLR_RH_PORTSTAT(x) &bslash;&n;&t;&t;status = inw(io_addr+USBPORTSC1+2*(wIndex-1)); &bslash;&n;&t;&t;status = (status &amp; 0xfff5) &amp; ~(x); &bslash;&n;&t;&t;outw(status, io_addr+USBPORTSC1+2*(wIndex-1))
DECL|macro|SET_RH_PORTSTAT
mdefine_line|#define SET_RH_PORTSTAT(x) &bslash;&n;&t;&t;status = inw(io_addr+USBPORTSC1+2*(wIndex-1)); &bslash;&n;&t;&t;status = (status &amp; 0xfff5) | (x); &bslash;&n;&t;&t;outw(status, io_addr+USBPORTSC1+2*(wIndex-1))
DECL|variable|oldval
r_static
r_int
id|oldval
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* build &quot;status change&quot; packet (one or two bytes) from HC registers &n;   Since uhci_hub_status_data is called by a SW timer, it is also used&n;   for monitoring HC health */
DECL|function|uhci_hub_status_data
r_static
r_int
id|uhci_hub_status_data
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
(paren
id|hcd
)paren
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
(paren
r_int
)paren
id|uhci-&gt;hcd.regs
suffix:semicolon
r_int
id|i
comma
id|len
op_assign
l_int|0
comma
id|data
op_assign
l_int|0
comma
id|portstate
suffix:semicolon
r_int
id|changed
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uhci-&gt;maxports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|portstate
op_assign
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC1
op_plus
id|i
op_star
l_int|2
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|i
op_eq
l_int|0
op_logical_and
(paren
id|portstate
op_amp
l_int|0xf
)paren
op_ne
(paren
id|oldval
op_amp
l_int|0xf
)paren
)paren
id|err
c_func
(paren
l_string|&quot;Port %i: %x&quot;
comma
id|i
op_plus
l_int|1
comma
id|portstate
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
id|oldval
op_assign
id|portstate
suffix:semicolon
r_if
c_cond
(paren
(paren
id|portstate
op_amp
l_int|0xa
)paren
OG
l_int|0
)paren
(brace
id|changed
op_assign
l_int|1
suffix:semicolon
)brace
id|data
op_or_assign
(paren
(paren
id|portstate
op_amp
l_int|0xa
)paren
OG
l_int|0
ques
c_cond
(paren
l_int|1
op_lshift
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|len
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
)brace
op_star
(paren
id|__u16
op_star
)paren
id|buf
op_assign
id|cpu_to_le16
(paren
id|data
)paren
suffix:semicolon
singleline_comment|// Watchdog
r_if
c_cond
(paren
id|uhci-&gt;running
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|uhci-&gt;last_hcd_irq
op_plus
id|WATCHDOG_TIMEOUT
)paren
)paren
(brace
r_if
c_cond
(paren
id|uhci-&gt;reanimations
OG
id|MAX_REANIMATIONS
)paren
(brace
id|err
c_func
(paren
l_string|&quot;He&squot;s dead, Jim. Giving up reanimating the UHCI host controller.&bslash;n&quot;
l_string|&quot;Maybe a real module reload helps...&quot;
)paren
suffix:semicolon
id|uhci-&gt;running
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|uhci-&gt;running
op_assign
l_int|0
suffix:semicolon
id|uhci-&gt;need_init
op_assign
l_int|1
suffix:semicolon
singleline_comment|// init done in the next submit_urb
)brace
)brace
r_return
id|changed
ques
c_cond
id|len
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|uhci_hub_descriptor
r_static
r_void
id|uhci_hub_descriptor
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|usb_hub_descriptor
op_star
id|desc
)paren
(brace
r_int
id|ports
op_assign
id|uhci-&gt;maxports
suffix:semicolon
id|u16
id|temp
suffix:semicolon
id|desc-&gt;bDescriptorType
op_assign
l_int|0x29
suffix:semicolon
id|desc-&gt;bPwrOn2PwrGood
op_assign
l_int|1
suffix:semicolon
id|desc-&gt;bHubContrCurrent
op_assign
l_int|0
suffix:semicolon
id|desc-&gt;bNbrPorts
op_assign
id|ports
suffix:semicolon
id|temp
op_assign
l_int|1
op_plus
(paren
id|ports
op_div
l_int|8
)paren
suffix:semicolon
id|desc-&gt;bDescLength
op_assign
l_int|7
op_plus
l_int|2
op_star
id|temp
suffix:semicolon
id|desc-&gt;wHubCharacteristics
op_assign
l_int|0
suffix:semicolon
id|desc
op_member_access_from_pointer
id|bitmap
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|desc
op_member_access_from_pointer
id|bitmap
(braket
l_int|1
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|uhci_hub_control
r_static
r_int
id|uhci_hub_control
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
id|u16
id|typeReq
comma
id|u16
id|wValue
comma
id|u16
id|wIndex
comma
r_char
op_star
id|buf
comma
id|u16
id|wLength
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
(paren
id|hcd
)paren
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
id|cstatus
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
(paren
r_int
)paren
id|uhci-&gt;hcd.regs
suffix:semicolon
r_int
id|ports
op_assign
id|uhci-&gt;maxports
suffix:semicolon
r_switch
c_cond
(paren
id|typeReq
)paren
(brace
r_case
id|ClearHubFeature
suffix:colon
r_break
suffix:semicolon
r_case
id|ClearPortFeature
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wIndex
op_logical_or
id|wIndex
OG
id|ports
)paren
r_goto
id|error
suffix:semicolon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|USB_PORT_FEAT_ENABLE
suffix:colon
id|CLR_RH_PORTSTAT
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_C_ENABLE
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_PEC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_SUSPEND
suffix:colon
id|CLR_RH_PORTSTAT
(paren
id|USBPORTSC_SUSP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_C_SUSPEND
suffix:colon
multiline_comment|/*** WR_RH_PORTSTAT(RH_PS_PSSC); */
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_POWER
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* port power ** */
r_case
id|USB_PORT_FEAT_C_CONNECTION
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_CSC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_C_OVER_CURRENT
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* port power over current ** */
r_case
id|USB_PORT_FEAT_C_RESET
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|error
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|GetHubDescriptor
suffix:colon
id|uhci_hub_descriptor
(paren
id|uhci
comma
(paren
r_struct
id|usb_hub_descriptor
op_star
)paren
id|buf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GetHubStatus
suffix:colon
op_star
(paren
id|u32
op_star
)paren
id|buf
op_assign
id|cpu_to_le32
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GetPortStatus
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wIndex
op_logical_or
id|wIndex
OG
id|ports
)paren
r_goto
id|error
suffix:semicolon
id|status
op_assign
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC1
op_plus
l_int|2
op_star
(paren
id|wIndex
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|cstatus
op_assign
(paren
(paren
id|status
op_amp
id|USBPORTSC_CSC
)paren
op_rshift
(paren
l_int|1
op_minus
l_int|0
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PEC
)paren
op_rshift
(paren
l_int|3
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|status
op_assign
(paren
id|status
op_amp
id|USBPORTSC_CCS
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PE
)paren
op_rshift
(paren
l_int|2
op_minus
l_int|1
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_SUSP
)paren
op_rshift
(paren
l_int|12
op_minus
l_int|2
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PR
)paren
op_rshift
(paren
l_int|9
op_minus
l_int|4
)paren
)paren
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
multiline_comment|/* power on ** */
(paren
(paren
id|status
op_amp
id|USBPORTSC_LSDA
)paren
op_lshift
(paren
op_minus
l_int|8
op_plus
l_int|9
)paren
)paren
suffix:semicolon
op_star
(paren
id|__u16
op_star
)paren
id|buf
op_assign
id|cpu_to_le16
(paren
id|status
)paren
suffix:semicolon
op_star
(paren
id|__u16
op_star
)paren
(paren
id|buf
op_plus
l_int|2
)paren
op_assign
id|cpu_to_le16
(paren
id|cstatus
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SetHubFeature
suffix:colon
singleline_comment|// FIXME
r_break
suffix:semicolon
r_case
id|SetPortFeature
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wIndex
op_logical_or
id|wIndex
OG
id|ports
)paren
r_goto
id|error
suffix:semicolon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|USB_PORT_FEAT_SUSPEND
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_SUSP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_RESET
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_PR
)paren
suffix:semicolon
id|uhci_wait_ms
(paren
l_int|10
)paren
suffix:semicolon
id|CLR_RH_PORTSTAT
(paren
id|USBPORTSC_PR
)paren
suffix:semicolon
id|udelay
(paren
l_int|10
)paren
suffix:semicolon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
id|uhci_wait_ms
(paren
l_int|10
)paren
suffix:semicolon
id|SET_RH_PORTSTAT
(paren
l_int|0xa
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_POWER
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* port power ** */
r_case
id|USB_PORT_FEAT_ENABLE
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|error
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|error
suffix:colon
id|stat
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Root-Hub stat port1: %x port2: %x&quot;
comma
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC1
)paren
comma
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC2
)paren
)paren
suffix:semicolon
r_return
id|stat
suffix:semicolon
)brace
eof
