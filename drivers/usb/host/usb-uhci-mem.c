multiline_comment|/*  &n;    UHCI HCD (Host Controller Driver) for USB&n;    UHCI memory allocation and basic descriptor handling&n;   &n;    (c) 1999-2002 &n;    Georg Acher      +    Deti Fliegl    +    Thomas Sailer&n;    georg@acher.org      deti@fliegl.de   sailer@ife.ee.ethz.ch&n;   &n;    with the help of&n;    David Brownell, david-b@pacbell.net&n;    Adam Richter, adam@yggdrasil.com&n;    Roman Weissgaerber, weissg@vienna.at    &n;    &n;    HW-initalization based on material of&n;    Randy Dunlap + Johannes Erdfelt + Gregory P. Smith + Linus Torvalds &n;&n;    $Id: usb-uhci-mem.c,v 1.1 2002/05/14 20:36:57 acher Exp $&n; */
multiline_comment|/*###########################################################################*/
singleline_comment|//                        UHCI STRUCTURE
multiline_comment|/*###########################################################################*/
DECL|function|uhci_hcd_alloc
r_static
r_struct
id|usb_hcd
op_star
id|uhci_hcd_alloc
(paren
r_void
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
r_struct
id|uhci_hcd
)paren
suffix:semicolon
id|uhci
op_assign
(paren
r_struct
id|uhci_hcd
op_star
)paren
id|kmalloc
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uhci
op_eq
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
(paren
id|uhci
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|init_dbg
c_func
(paren
l_string|&quot;uhci @ %p, hcd @ %p&quot;
comma
id|uhci
comma
op_amp
(paren
id|uhci-&gt;hcd
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|uhci-&gt;free_desc_qh
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|uhci-&gt;free_desc_td
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|uhci-&gt;urb_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|uhci-&gt;urb_unlinked
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|uhci-&gt;urb_list_lock
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|uhci-&gt;qh_lock
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|uhci-&gt;td_lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|uhci-&gt;avoid_bulk
comma
l_int|0
)paren
suffix:semicolon
r_return
op_amp
(paren
id|uhci-&gt;hcd
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_hcd_free
r_static
r_void
id|uhci_hcd_free
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
id|kfree
(paren
id|hcd_to_uhci
(paren
id|hcd
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*###########################################################################*/
singleline_comment|//                   DMA/PCI CONSISTENCY
multiline_comment|/*###########################################################################*/
DECL|function|uhci_urb_dma_sync
r_static
r_void
id|uhci_urb_dma_sync
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
comma
id|urb_priv_t
op_star
id|urb_priv
)paren
(brace
r_if
c_cond
(paren
id|urb_priv-&gt;setup_packet_dma
)paren
id|pci_dma_sync_single
c_func
(paren
id|uhci-&gt;uhci_pci
comma
id|urb_priv-&gt;setup_packet_dma
comma
r_sizeof
(paren
r_struct
id|usb_ctrlrequest
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb_priv-&gt;transfer_buffer_dma
)paren
id|pci_dma_sync_single
c_func
(paren
id|uhci-&gt;uhci_pci
comma
id|urb_priv-&gt;transfer_buffer_dma
comma
id|urb-&gt;transfer_buffer_length
comma
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|PCI_DMA_FROMDEVICE
suffix:colon
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_urb_dma_unmap
r_static
r_void
id|uhci_urb_dma_unmap
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
comma
id|urb_priv_t
op_star
id|urb_priv
)paren
(brace
r_if
c_cond
(paren
id|urb_priv-&gt;setup_packet_dma
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|uhci-&gt;uhci_pci
comma
id|urb_priv-&gt;setup_packet_dma
comma
r_sizeof
(paren
r_struct
id|usb_ctrlrequest
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|urb_priv-&gt;setup_packet_dma
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb_priv-&gt;transfer_buffer_dma
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|uhci-&gt;uhci_pci
comma
id|urb_priv-&gt;transfer_buffer_dma
comma
id|urb-&gt;transfer_buffer_length
comma
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|PCI_DMA_FROMDEVICE
suffix:colon
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|urb_priv-&gt;transfer_buffer_dma
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*###########################################################################*/
singleline_comment|//                       TRANSFER DESCRIPTORS (TD)
multiline_comment|/*###########################################################################*/
DECL|function|fill_td
r_static
r_void
id|fill_td
(paren
id|uhci_desc_t
op_star
id|td
comma
r_int
id|status
comma
r_int
id|info
comma
id|__u32
id|buffer
)paren
(brace
id|td-&gt;hw.td.status
op_assign
id|cpu_to_le32
c_func
(paren
id|status
)paren
suffix:semicolon
id|td-&gt;hw.td.info
op_assign
id|cpu_to_le32
c_func
(paren
id|info
)paren
suffix:semicolon
id|td-&gt;hw.td.buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|buffer
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|alloc_td
r_static
r_int
id|alloc_td
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
op_star
r_new
comma
r_int
id|flags
)paren
(brace
id|dma_addr_t
id|dma_handle
suffix:semicolon
op_star
r_new
op_assign
id|pci_pool_alloc
c_func
(paren
id|uhci-&gt;desc_pool
comma
id|GFP_DMA
op_or
id|GFP_ATOMIC
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
r_new
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
op_star
r_new
comma
l_int|0
comma
r_sizeof
(paren
id|uhci_desc_t
)paren
)paren
suffix:semicolon
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|dma_addr
op_assign
id|dma_handle
suffix:semicolon
id|set_td_link
c_func
(paren
(paren
op_star
r_new
)paren
comma
id|UHCI_PTR_TERM
op_or
(paren
id|flags
op_amp
id|UHCI_PTR_BITS
)paren
)paren
suffix:semicolon
singleline_comment|// last by default
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|type
op_assign
id|TD_TYPE
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|vertical
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|horizontal
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
multiline_comment|/* insert td at last position in td-list of qh (vertical) */
DECL|function|insert_td
r_static
r_int
id|insert_td
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|qh
comma
id|uhci_desc_t
op_star
r_new
comma
r_int
id|flags
)paren
(brace
id|uhci_desc_t
op_star
id|prev
suffix:semicolon
r_int
r_int
id|cpuflags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;td_lock
comma
id|cpuflags
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
r_new
op_member_access_from_pointer
id|vertical
comma
op_amp
id|qh-&gt;vertical
)paren
suffix:semicolon
id|prev
op_assign
id|list_entry
(paren
r_new
op_member_access_from_pointer
id|vertical.prev
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qh
op_eq
id|prev
)paren
(brace
singleline_comment|// virgin qh without any tds
id|set_qh_element
c_func
(paren
id|qh
comma
r_new
op_member_access_from_pointer
id|dma_addr
op_or
id|UHCI_PTR_TERM
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// already tds inserted, implicitely remove TERM bit of prev
id|set_td_link
c_func
(paren
id|prev
comma
r_new
op_member_access_from_pointer
id|dma_addr
op_or
(paren
id|flags
op_amp
id|UHCI_PTR_DEPTH
)paren
)paren
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;td_lock
comma
id|cpuflags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
multiline_comment|/* insert new_td after td (horizontal) */
DECL|function|insert_td_horizontal
r_static
r_int
id|insert_td_horizontal
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|td
comma
id|uhci_desc_t
op_star
r_new
)paren
(brace
id|uhci_desc_t
op_star
id|next
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;td_lock
comma
id|flags
)paren
suffix:semicolon
id|next
op_assign
id|list_entry
(paren
id|td-&gt;horizontal.next
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|list_add
(paren
op_amp
r_new
op_member_access_from_pointer
id|horizontal
comma
op_amp
id|td-&gt;horizontal
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|hw.td.link
op_assign
id|td-&gt;hw.td.link
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|set_td_link
c_func
(paren
id|td
comma
r_new
op_member_access_from_pointer
id|dma_addr
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;td_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|unlink_td
r_static
r_int
id|unlink_td
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|element
comma
r_int
id|phys_unlink
)paren
(brace
id|uhci_desc_t
op_star
id|next
comma
op_star
id|prev
suffix:semicolon
r_int
id|dir
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;td_lock
comma
id|flags
)paren
suffix:semicolon
id|next
op_assign
id|list_entry
(paren
id|element-&gt;vertical.next
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next
op_eq
id|element
)paren
(brace
id|dir
op_assign
l_int|1
suffix:semicolon
id|prev
op_assign
id|list_entry
(paren
id|element-&gt;horizontal.prev
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
)brace
r_else
id|prev
op_assign
id|list_entry
(paren
id|element-&gt;vertical.prev
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phys_unlink
)paren
(brace
singleline_comment|// really remove HW linking
r_if
c_cond
(paren
id|prev-&gt;type
op_eq
id|TD_TYPE
)paren
(brace
id|prev-&gt;hw.td.link
op_assign
id|element-&gt;hw.td.link
suffix:semicolon
)brace
r_else
id|prev-&gt;hw.qh.element
op_assign
id|element-&gt;hw.td.link
suffix:semicolon
)brace
id|mb
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_eq
l_int|0
)paren
id|list_del
(paren
op_amp
id|element-&gt;vertical
)paren
suffix:semicolon
r_else
id|list_del
(paren
op_amp
id|element-&gt;horizontal
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;td_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*###########################################################################*/
singleline_comment|//               QUEUE HEADS (QH)
multiline_comment|/*###########################################################################*/
singleline_comment|// Allocates qh element
DECL|function|alloc_qh
r_static
r_int
id|alloc_qh
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
op_star
r_new
)paren
(brace
id|dma_addr_t
id|dma_handle
suffix:semicolon
op_star
r_new
op_assign
id|pci_pool_alloc
c_func
(paren
id|uhci-&gt;desc_pool
comma
id|GFP_DMA
op_or
id|GFP_ATOMIC
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
r_new
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
op_star
r_new
comma
l_int|0
comma
r_sizeof
(paren
id|uhci_desc_t
)paren
)paren
suffix:semicolon
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|dma_addr
op_assign
id|dma_handle
suffix:semicolon
id|set_qh_head
c_func
(paren
op_star
r_new
comma
id|UHCI_PTR_TERM
)paren
suffix:semicolon
id|set_qh_element
c_func
(paren
op_star
r_new
comma
id|UHCI_PTR_TERM
)paren
suffix:semicolon
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|type
op_assign
id|QH_TYPE
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|horizontal
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|vertical
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Allocated qh @ %p&quot;
comma
op_star
r_new
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// inserts new qh before/after the qh at pos
singleline_comment|// flags: 0: insert before pos, 1: insert after pos (for low speed transfers)
DECL|function|insert_qh
r_static
r_int
id|insert_qh
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|pos
comma
id|uhci_desc_t
op_star
r_new
comma
r_int
id|order
)paren
(brace
id|uhci_desc_t
op_star
id|old
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|order
)paren
(brace
singleline_comment|// (OLD) (POS) -&gt; (OLD) (NEW) (POS)
id|old
op_assign
id|list_entry
(paren
id|pos-&gt;horizontal.prev
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
r_new
op_member_access_from_pointer
id|horizontal
comma
op_amp
id|pos-&gt;horizontal
)paren
suffix:semicolon
id|set_qh_head
c_func
(paren
r_new
comma
id|MAKE_QH_ADDR
(paren
id|pos
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|old-&gt;hw.qh.head
op_amp
id|cpu_to_le32
c_func
(paren
id|UHCI_PTR_TERM
)paren
)paren
)paren
id|set_qh_head
c_func
(paren
id|old
comma
id|MAKE_QH_ADDR
(paren
r_new
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// (POS) (OLD) -&gt; (POS) (NEW) (OLD)
id|old
op_assign
id|list_entry
(paren
id|pos-&gt;horizontal.next
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|list_add
(paren
op_amp
r_new
op_member_access_from_pointer
id|horizontal
comma
op_amp
id|pos-&gt;horizontal
)paren
suffix:semicolon
id|set_qh_head
c_func
(paren
r_new
comma
id|MAKE_QH_ADDR
(paren
id|old
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|set_qh_head
c_func
(paren
id|pos
comma
id|MAKE_QH_ADDR
(paren
r_new
)paren
)paren
suffix:semicolon
)brace
id|mb
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// append a qh to td.link physically, the SW linkage is not affected
DECL|function|append_qh
r_static
r_void
id|append_qh
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|td
comma
id|uhci_desc_t
op_star
id|qh
comma
r_int
id|flags
)paren
(brace
r_int
r_int
id|cpuflags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;td_lock
comma
id|cpuflags
)paren
suffix:semicolon
id|set_td_link
c_func
(paren
id|td
comma
id|qh-&gt;dma_addr
op_or
(paren
id|flags
op_amp
id|UHCI_PTR_DEPTH
)paren
op_or
id|UHCI_PTR_QH
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;td_lock
comma
id|cpuflags
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|unlink_qh
r_static
r_int
id|unlink_qh
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|element
)paren
(brace
id|uhci_desc_t
op_star
id|prev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__u32
id|old_head
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
id|prev
op_assign
id|list_entry
(paren
id|element-&gt;horizontal.prev
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|old_head
op_assign
id|element-&gt;hw.qh.head
suffix:semicolon
id|element-&gt;hw.qh.head
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|prev-&gt;hw.qh.head
op_assign
id|old_head
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;unlink qh %p, pqh %p, nxqh %p, to %08x&quot;
comma
id|element
comma
id|prev
comma
id|list_entry
(paren
id|element-&gt;horizontal.next
comma
id|uhci_desc_t
comma
id|horizontal
)paren
comma
id|le32_to_cpu
c_func
(paren
id|element-&gt;hw.qh.head
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|element-&gt;horizontal
)paren
suffix:semicolon
id|mb
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|delete_desc
r_static
r_int
id|delete_desc
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|element
)paren
(brace
id|pci_pool_free
c_func
(paren
id|uhci-&gt;desc_pool
comma
id|element
comma
id|element-&gt;dma_addr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|delete_qh
r_static
r_int
id|delete_qh
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|qh
)paren
(brace
id|uhci_desc_t
op_star
id|td
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
id|list_del
(paren
op_amp
id|qh-&gt;horizontal
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|qh-&gt;vertical.next
)paren
op_ne
op_amp
id|qh-&gt;vertical
op_logical_and
id|n
OL
l_int|10000
)paren
(brace
id|td
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;unlink td @ %p&quot;
comma
id|td
)paren
suffix:semicolon
id|unlink_td
(paren
id|uhci
comma
id|td
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// no physical unlink
id|delete_desc
(paren
id|uhci
comma
id|td
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
singleline_comment|// never trust any software, not even your own...
r_if
c_cond
(paren
id|n
op_ge
l_int|10000
)paren
id|err
c_func
(paren
l_string|&quot;delete_qh: Garbage in QH list, giving up&quot;
)paren
suffix:semicolon
id|delete_desc
(paren
id|uhci
comma
id|qh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*###########################################################################*/
singleline_comment|//             DESCRIPTOR CHAINING HELPERS
multiline_comment|/*###########################################################################*/
DECL|function|clean_td_chain
r_static
r_void
id|clean_td_chain
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
id|uhci_desc_t
op_star
id|td
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|uhci_desc_t
op_star
id|td1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|td-&gt;horizontal.next
)paren
op_ne
op_amp
id|td-&gt;horizontal
)paren
(brace
id|td1
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|delete_desc
(paren
id|uhci
comma
id|td1
)paren
suffix:semicolon
)brace
id|delete_desc
(paren
id|uhci
comma
id|td
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// Cleans up collected QHs/TDs, but not more than 100 in one go
DECL|function|clean_descs
r_void
id|clean_descs
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_int
id|force
)paren
(brace
r_struct
id|list_head
op_star
id|q
suffix:semicolon
id|uhci_desc_t
op_star
id|qh
comma
op_star
id|td
suffix:semicolon
r_int
id|now
op_assign
id|UHCI_GET_CURRENT_FRAME
c_func
(paren
id|uhci
)paren
comma
id|n
op_assign
l_int|0
suffix:semicolon
id|q
op_assign
id|uhci-&gt;free_desc_qh.prev
suffix:semicolon
r_while
c_loop
(paren
id|q
op_ne
op_amp
id|uhci-&gt;free_desc_qh
op_logical_and
(paren
id|force
op_logical_or
id|n
OL
l_int|100
)paren
)paren
(brace
id|qh
op_assign
id|list_entry
(paren
id|q
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|q
op_assign
id|qh-&gt;horizontal.prev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|qh-&gt;last_used
op_ne
id|now
)paren
op_logical_or
id|force
)paren
(brace
id|delete_qh
c_func
(paren
id|uhci
comma
id|qh
)paren
suffix:semicolon
)brace
id|n
op_increment
suffix:semicolon
)brace
id|q
op_assign
id|uhci-&gt;free_desc_td.prev
suffix:semicolon
id|n
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|q
op_ne
op_amp
id|uhci-&gt;free_desc_td
op_logical_and
(paren
id|force
op_logical_or
id|n
OL
l_int|100
)paren
)paren
(brace
id|td
op_assign
id|list_entry
(paren
id|q
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|q
op_assign
id|td-&gt;horizontal.prev
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|td-&gt;last_used
op_ne
id|now
)paren
op_logical_and
(paren
id|td-&gt;last_used
op_plus
l_int|1
op_ne
id|now
)paren
)paren
op_logical_or
id|force
)paren
(brace
id|list_del
(paren
op_amp
id|td-&gt;horizontal
)paren
suffix:semicolon
id|delete_desc
c_func
(paren
id|uhci
comma
id|td
)paren
suffix:semicolon
)brace
id|n
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_switch_timer_int
r_static
r_void
id|uhci_switch_timer_int
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|uhci-&gt;urb_unlinked
)paren
)paren
id|set_td_ioc
c_func
(paren
id|uhci-&gt;td1ms
)paren
suffix:semicolon
r_else
id|clr_td_ioc
c_func
(paren
id|uhci-&gt;td1ms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;timeout_urbs
)paren
id|set_td_ioc
c_func
(paren
id|uhci-&gt;td32ms
)paren
suffix:semicolon
r_else
id|clr_td_ioc
c_func
(paren
id|uhci-&gt;td32ms
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH
DECL|function|enable_desc_loop
r_static
r_void
id|enable_desc_loop
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_NO_FSBR
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
id|uhci-&gt;chain_end-&gt;hw.qh.head
op_and_assign
id|cpu_to_le32
c_func
(paren
op_complement
id|UHCI_PTR_TERM
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|uhci-&gt;loop_usage
op_increment
suffix:semicolon
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|use_loop
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|disable_desc_loop
r_static
r_void
id|disable_desc_loop
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_NO_FSBR
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|use_loop
)paren
(brace
id|uhci-&gt;loop_usage
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;loop_usage
)paren
(brace
id|uhci-&gt;chain_end-&gt;hw.qh.head
op_or_assign
id|cpu_to_le32
c_func
(paren
id|UHCI_PTR_TERM
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|use_loop
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|queue_urb_unlocked
r_static
r_void
id|queue_urb_unlocked
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|urb_priv_t
op_star
id|priv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH
r_int
id|type
suffix:semicolon
id|type
op_assign
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|type
op_eq
id|PIPE_BULK
)paren
op_logical_or
(paren
id|type
op_eq
id|PIPE_CONTROL
)paren
)paren
id|enable_desc_loop
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
macro_line|#endif
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|priv-&gt;started
op_assign
id|jiffies
suffix:semicolon
id|list_add
(paren
op_amp
id|priv-&gt;urb_list
comma
op_amp
id|uhci-&gt;urb_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;timeout
)paren
id|uhci-&gt;timeout_urbs
op_increment
suffix:semicolon
id|uhci_switch_timer_int
c_func
(paren
id|uhci
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|queue_urb
r_static
r_void
id|queue_urb
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|uhci-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|queue_urb_unlocked
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|uhci-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|dequeue_urb
r_static
r_void
id|dequeue_urb
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|urb_priv_t
op_star
id|priv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH
r_int
id|type
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;dequeue URB %p&quot;
comma
id|urb
)paren
suffix:semicolon
id|type
op_assign
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|type
op_eq
id|PIPE_BULK
)paren
op_logical_or
(paren
id|type
op_eq
id|PIPE_CONTROL
)paren
)paren
id|disable_desc_loop
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
macro_line|#endif
id|list_del
(paren
op_amp
id|priv-&gt;urb_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;timeout
op_logical_and
id|uhci-&gt;timeout_urbs
)paren
id|uhci-&gt;timeout_urbs
op_decrement
suffix:semicolon
)brace
multiline_comment|/*###########################################################################*/
singleline_comment|//                  INIT/FREE FRAME LAYOUT IN MEMORY
multiline_comment|/*###########################################################################*/
singleline_comment|// Removes ALL qhs in chain (paranoia!)
DECL|function|cleanup_skel
r_static
r_void
id|cleanup_skel
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
r_int
id|n
suffix:semicolon
id|uhci_desc_t
op_star
id|td
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;cleanup_skel&quot;
)paren
suffix:semicolon
id|clean_descs
c_func
(paren
id|uhci
comma
l_int|1
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;clean_descs done&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;td32ms
)paren
(brace
id|unlink_td
c_func
(paren
id|uhci
comma
id|uhci-&gt;td32ms
comma
l_int|1
)paren
suffix:semicolon
id|delete_desc
c_func
(paren
id|uhci
comma
id|uhci-&gt;td32ms
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;td128ms
)paren
(brace
id|unlink_td
c_func
(paren
id|uhci
comma
id|uhci-&gt;td128ms
comma
l_int|1
)paren
suffix:semicolon
id|delete_desc
c_func
(paren
id|uhci
comma
id|uhci-&gt;td128ms
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|8
suffix:semicolon
id|n
op_increment
)paren
(brace
id|td
op_assign
id|uhci-&gt;int_chain
(braket
id|n
)braket
suffix:semicolon
id|clean_td_chain
(paren
id|uhci
comma
id|td
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;iso_td
)paren
(brace
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|1024
suffix:semicolon
id|n
op_increment
)paren
(brace
id|td
op_assign
id|uhci-&gt;iso_td
(braket
id|n
)braket
suffix:semicolon
id|clean_td_chain
(paren
id|uhci
comma
id|td
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|uhci-&gt;iso_td
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;framelist
)paren
id|pci_free_consistent
c_func
(paren
id|uhci-&gt;uhci_pci
comma
id|PAGE_SIZE
comma
id|uhci-&gt;framelist
comma
id|uhci-&gt;framelist_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;control_chain
)paren
(brace
singleline_comment|// completed init_skel?
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|uhci_desc_t
op_star
id|qh
comma
op_star
id|qh1
suffix:semicolon
id|qh
op_assign
id|uhci-&gt;control_chain
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|qh-&gt;horizontal.next
)paren
op_ne
op_amp
id|qh-&gt;horizontal
)paren
(brace
id|qh1
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|delete_qh
(paren
id|uhci
comma
id|qh1
)paren
suffix:semicolon
)brace
id|delete_qh
(paren
id|uhci
comma
id|qh
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|uhci-&gt;ls_control_chain
)paren
id|delete_desc
(paren
id|uhci
comma
id|uhci-&gt;ls_control_chain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;control_chain
)paren
id|delete_desc
(paren
id|uhci
comma
id|uhci-&gt;control_chain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;bulk_chain
)paren
id|delete_desc
(paren
id|uhci
comma
id|uhci-&gt;bulk_chain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;chain_end
)paren
id|delete_desc
(paren
id|uhci
comma
id|uhci-&gt;chain_end
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;desc_pool
)paren
(brace
id|pci_pool_destroy
c_func
(paren
id|uhci-&gt;desc_pool
)paren
suffix:semicolon
id|uhci-&gt;desc_pool
op_assign
l_int|NULL
suffix:semicolon
)brace
id|uhci-&gt;ls_control_chain
op_assign
l_int|NULL
suffix:semicolon
id|uhci-&gt;control_chain
op_assign
l_int|NULL
suffix:semicolon
id|uhci-&gt;bulk_chain
op_assign
l_int|NULL
suffix:semicolon
id|uhci-&gt;chain_end
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|8
suffix:semicolon
id|n
op_increment
)paren
id|uhci-&gt;int_chain
(braket
id|n
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;cleanup_skel finished&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// allocates framelist and qh-skeletons
singleline_comment|// only HW-links provide continous linking, SW-links stay in their domain (ISO/INT)
DECL|function|init_skel
r_static
r_int
id|init_skel
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
id|n
comma
id|ret
suffix:semicolon
id|uhci_desc_t
op_star
id|qh
comma
op_star
id|td
suffix:semicolon
id|init_dbg
c_func
(paren
l_string|&quot;init_skel&quot;
)paren
suffix:semicolon
id|uhci-&gt;framelist
op_assign
id|pci_alloc_consistent
c_func
(paren
id|uhci-&gt;uhci_pci
comma
id|PAGE_SIZE
comma
op_amp
id|uhci-&gt;framelist_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;framelist
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
id|uhci-&gt;framelist
comma
l_int|0
comma
l_int|4096
)paren
suffix:semicolon
id|init_dbg
c_func
(paren
l_string|&quot;creating descriptor pci_pool&quot;
)paren
suffix:semicolon
id|uhci-&gt;desc_pool
op_assign
id|pci_pool_create
c_func
(paren
l_string|&quot;uhci_desc&quot;
comma
id|uhci-&gt;uhci_pci
comma
r_sizeof
(paren
id|uhci_desc_t
)paren
comma
l_int|16
comma
l_int|0
comma
id|GFP_DMA
op_or
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;desc_pool
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|init_dbg
c_func
(paren
l_string|&quot;allocating iso desc pointer list&quot;
)paren
suffix:semicolon
id|uhci-&gt;iso_td
op_assign
(paren
id|uhci_desc_t
op_star
op_star
)paren
id|kmalloc
(paren
l_int|1024
op_star
r_sizeof
(paren
id|uhci_desc_t
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;iso_td
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|uhci-&gt;ls_control_chain
op_assign
l_int|NULL
suffix:semicolon
id|uhci-&gt;control_chain
op_assign
l_int|NULL
suffix:semicolon
id|uhci-&gt;bulk_chain
op_assign
l_int|NULL
suffix:semicolon
id|uhci-&gt;chain_end
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|8
suffix:semicolon
id|n
op_increment
)paren
id|uhci-&gt;int_chain
(braket
id|n
)braket
op_assign
l_int|NULL
suffix:semicolon
id|init_dbg
c_func
(paren
l_string|&quot;allocating iso descs&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|1024
suffix:semicolon
id|n
op_increment
)paren
(brace
singleline_comment|// allocate skeleton iso/irq-tds
r_if
c_cond
(paren
id|alloc_td
(paren
id|uhci
comma
op_amp
id|td
comma
l_int|0
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|uhci-&gt;iso_td
(braket
id|n
)braket
op_assign
id|td
suffix:semicolon
id|uhci-&gt;framelist
(braket
id|n
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|__u32
)paren
id|td-&gt;dma_addr
)paren
suffix:semicolon
)brace
id|init_dbg
c_func
(paren
l_string|&quot;allocating qh: chain_end&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alloc_qh
(paren
id|uhci
comma
op_amp
id|qh
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|uhci-&gt;chain_end
op_assign
id|qh
suffix:semicolon
r_if
c_cond
(paren
id|alloc_td
(paren
id|uhci
comma
op_amp
id|td
comma
l_int|0
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|fill_td
(paren
id|td
comma
l_int|0
op_star
id|TD_CTRL_IOC
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// generate 1ms interrupt (enabled on demand)
id|insert_td
(paren
id|uhci
comma
id|qh
comma
id|td
comma
l_int|0
)paren
suffix:semicolon
id|qh-&gt;hw.qh.element
op_and_assign
id|cpu_to_le32
c_func
(paren
op_complement
id|UHCI_PTR_TERM
)paren
suffix:semicolon
singleline_comment|// remove TERM bit
id|uhci-&gt;td1ms
op_assign
id|td
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;allocating qh: bulk_chain&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alloc_qh
(paren
id|uhci
comma
op_amp
id|qh
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|insert_qh
(paren
id|uhci
comma
id|uhci-&gt;chain_end
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
id|uhci-&gt;bulk_chain
op_assign
id|qh
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;allocating qh: control_chain&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|alloc_qh
(paren
id|uhci
comma
op_amp
id|qh
)paren
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|insert_qh
(paren
id|uhci
comma
id|uhci-&gt;bulk_chain
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
id|uhci-&gt;control_chain
op_assign
id|qh
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_UHCI_HIGH_BANDWIDTH
singleline_comment|// disabled reclamation loop
id|set_qh_head
c_func
(paren
id|uhci-&gt;chain_end
comma
id|uhci-&gt;control_chain-&gt;dma_addr
op_or
id|UHCI_PTR_QH
op_or
id|UHCI_PTR_TERM
)paren
suffix:semicolon
macro_line|#endif
id|init_dbg
c_func
(paren
l_string|&quot;allocating qh: ls_control_chain&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alloc_qh
(paren
id|uhci
comma
op_amp
id|qh
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|insert_qh
(paren
id|uhci
comma
id|uhci-&gt;control_chain
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
id|uhci-&gt;ls_control_chain
op_assign
id|qh
suffix:semicolon
id|init_dbg
c_func
(paren
l_string|&quot;allocating skeleton INT-TDs&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|8
suffix:semicolon
id|n
op_increment
)paren
(brace
id|uhci_desc_t
op_star
id|td
suffix:semicolon
r_if
c_cond
(paren
id|alloc_td
(paren
id|uhci
comma
op_amp
id|td
comma
l_int|0
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|uhci-&gt;int_chain
(braket
id|n
)braket
op_assign
id|td
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
(brace
id|set_td_link
c_func
(paren
id|uhci-&gt;int_chain
(braket
l_int|0
)braket
comma
id|uhci-&gt;ls_control_chain-&gt;dma_addr
op_or
id|UHCI_PTR_QH
)paren
suffix:semicolon
)brace
r_else
(brace
id|set_td_link
c_func
(paren
id|uhci-&gt;int_chain
(braket
id|n
)braket
comma
id|uhci-&gt;int_chain
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dma_addr
)paren
suffix:semicolon
)brace
)brace
id|init_dbg
c_func
(paren
l_string|&quot;Linking skeleton INT-TDs&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|1024
suffix:semicolon
id|n
op_increment
)paren
(brace
singleline_comment|// link all iso-tds to the interrupt chains
r_int
id|m
comma
id|o
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;framelist[%i]=%x&quot;
comma
id|n
comma
id|le32_to_cpu
c_func
(paren
id|uhci-&gt;framelist
(braket
id|n
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n
op_amp
l_int|127
)paren
op_eq
l_int|127
)paren
(paren
(paren
id|uhci_desc_t
op_star
)paren
id|uhci-&gt;iso_td
(braket
id|n
)braket
)paren
op_member_access_from_pointer
id|hw.td.link
op_assign
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;int_chain
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dma_addr
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|o
op_assign
l_int|1
comma
id|m
op_assign
l_int|2
suffix:semicolon
id|m
op_le
l_int|128
suffix:semicolon
id|o
op_increment
comma
id|m
op_add_assign
id|m
)paren
r_if
c_cond
(paren
(paren
id|n
op_amp
(paren
id|m
op_minus
l_int|1
)paren
)paren
op_eq
(paren
(paren
id|m
op_minus
l_int|1
)paren
op_div
l_int|2
)paren
)paren
id|set_td_link
c_func
(paren
(paren
(paren
id|uhci_desc_t
op_star
)paren
id|uhci-&gt;iso_td
(braket
id|n
)braket
)paren
comma
id|uhci-&gt;int_chain
(braket
id|o
)braket
op_member_access_from_pointer
id|dma_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|alloc_td
(paren
id|uhci
comma
op_amp
id|td
comma
l_int|0
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|fill_td
(paren
id|td
comma
l_int|0
op_star
id|TD_CTRL_IOC
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// generate 32ms interrupt (activated later)
id|uhci-&gt;td32ms
op_assign
id|td
suffix:semicolon
id|insert_td_horizontal
(paren
id|uhci
comma
id|uhci-&gt;int_chain
(braket
l_int|5
)braket
comma
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alloc_td
(paren
id|uhci
comma
op_amp
id|td
comma
l_int|0
)paren
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|fill_td
(paren
id|td
comma
l_int|0
op_star
id|TD_CTRL_IOC
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// generate 128ms interrupt (activated later)
id|uhci-&gt;td128ms
op_assign
id|td
suffix:semicolon
id|insert_td_horizontal
(paren
id|uhci
comma
id|uhci-&gt;int_chain
(braket
l_int|7
)braket
comma
id|td
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|init_dbg
c_func
(paren
l_string|&quot;init_skel exit&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|init_skel_cleanup
suffix:colon
id|cleanup_skel
(paren
id|uhci
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*###########################################################################*/
singleline_comment|//                 UHCI PRIVATE DATA
multiline_comment|/*###########################################################################*/
DECL|function|uhci_alloc_priv
id|urb_priv_t
op_star
id|uhci_alloc_priv
c_func
(paren
r_int
id|mem_flags
)paren
(brace
id|urb_priv_t
op_star
id|p
suffix:semicolon
macro_line|#ifdef DEBUG_SLAB
id|p
op_assign
id|kmem_cache_alloc
c_func
(paren
id|urb_priv_kmem
comma
id|SLAB_FLAG
)paren
suffix:semicolon
macro_line|#else
id|p
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|urb_priv_t
)paren
comma
id|mem_flags
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|p
)paren
(brace
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
id|urb_priv_t
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|p-&gt;urb_list
)paren
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_free_priv
r_void
id|uhci_free_priv
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
comma
id|urb_priv_t
op_star
id|p
)paren
(brace
id|uhci_urb_dma_unmap
c_func
(paren
id|uhci
comma
id|urb
comma
id|p
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SLAB
id|err
c_func
(paren
l_string|&quot;free_priv %p&quot;
comma
id|p
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|urb_priv_kmem
comma
id|p
)paren
suffix:semicolon
macro_line|#else
id|kfree
(paren
id|p
)paren
suffix:semicolon
macro_line|#endif
id|urb-&gt;hcpriv
op_assign
l_int|NULL
suffix:semicolon
)brace
eof
