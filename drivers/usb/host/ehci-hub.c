multiline_comment|/*&n; * Copyright (c) 2001-2002 by David Brownell&n; * &n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY&n; * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; * for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/* this file is part of ehci-hcd.c */
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/*&n; * EHCI Root Hub ... the nonsharable stuff&n; *&n; * Registers don&squot;t need cpu_to_le32, that happens transparently&n; */
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef&t;CONFIG_PM
DECL|function|ehci_hub_suspend
r_static
r_int
id|ehci_hub_suspend
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|ehci_hcd
op_star
id|ehci
op_assign
id|hcd_to_ehci
(paren
id|hcd
)paren
suffix:semicolon
r_int
id|port
suffix:semicolon
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
comma
id|ehci-&gt;next_statechange
)paren
)paren
id|msleep
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|port
op_assign
id|HCS_N_PORTS
(paren
id|ehci-&gt;hcs_params
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|ehci-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* stop schedules, clean any completed work */
r_if
c_cond
(paren
id|HCD_IS_RUNNING
c_func
(paren
id|hcd-&gt;state
)paren
)paren
(brace
id|ehci_quiesce
(paren
id|ehci
)paren
suffix:semicolon
id|ehci-&gt;hcd.state
op_assign
id|USB_STATE_QUIESCING
suffix:semicolon
)brace
id|ehci-&gt;command
op_assign
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ehci-&gt;reclaim
)paren
id|ehci-&gt;reclaim_ready
op_assign
l_int|1
suffix:semicolon
id|ehci_work
c_func
(paren
id|ehci
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* suspend any active/unsuspended ports, maybe allow wakeup */
r_while
c_loop
(paren
id|port
op_decrement
)paren
(brace
id|u32
id|__iomem
op_star
id|reg
op_assign
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|port
)braket
suffix:semicolon
id|u32
id|t1
op_assign
id|readl
(paren
id|reg
)paren
suffix:semicolon
id|u32
id|t2
op_assign
id|t1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t1
op_amp
id|PORT_PE
)paren
op_logical_and
op_logical_neg
(paren
id|t1
op_amp
id|PORT_OWNER
)paren
)paren
id|t2
op_or_assign
id|PORT_SUSPEND
suffix:semicolon
r_if
c_cond
(paren
id|ehci-&gt;hcd.remote_wakeup
)paren
id|t2
op_or_assign
id|PORT_WKOC_E
op_or
id|PORT_WKDISC_E
op_or
id|PORT_WKCONN_E
suffix:semicolon
r_else
id|t2
op_and_assign
op_complement
(paren
id|PORT_WKOC_E
op_or
id|PORT_WKDISC_E
op_or
id|PORT_WKCONN_E
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t1
op_ne
id|t2
)paren
(brace
id|ehci_vdbg
(paren
id|ehci
comma
l_string|&quot;port %d, %08x -&gt; %08x&bslash;n&quot;
comma
id|port
op_plus
l_int|1
comma
id|t1
comma
id|t2
)paren
suffix:semicolon
id|writel
(paren
id|t2
comma
id|reg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* turn off now-idle HC */
id|ehci_halt
(paren
id|ehci
)paren
suffix:semicolon
id|ehci-&gt;hcd.state
op_assign
id|HCD_STATE_SUSPENDED
suffix:semicolon
id|ehci-&gt;next_statechange
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|ehci-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* caller has locked the root hub, and should reset/reinit on error */
DECL|function|ehci_hub_resume
r_static
r_int
id|ehci_hub_resume
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|ehci_hcd
op_star
id|ehci
op_assign
id|hcd_to_ehci
(paren
id|hcd
)paren
suffix:semicolon
id|u32
id|temp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|intr_enable
suffix:semicolon
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
comma
id|ehci-&gt;next_statechange
)paren
)paren
id|msleep
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|ehci-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* re-init operational registers in case we lost power */
r_if
c_cond
(paren
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;intr_enable
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* at least some APM implementations will try to deliver&n;&t;&t; * IRQs right away, so delay them until we&squot;re ready.&n; &t;&t; */
id|intr_enable
op_assign
l_int|1
suffix:semicolon
id|writel
(paren
l_int|0
comma
op_amp
id|ehci-&gt;regs-&gt;segment
)paren
suffix:semicolon
id|writel
(paren
id|ehci-&gt;periodic_dma
comma
op_amp
id|ehci-&gt;regs-&gt;frame_list
)paren
suffix:semicolon
id|writel
(paren
(paren
id|u32
)paren
id|ehci-&gt;async-&gt;qh_dma
comma
op_amp
id|ehci-&gt;regs-&gt;async_next
)paren
suffix:semicolon
)brace
r_else
id|intr_enable
op_assign
l_int|0
suffix:semicolon
id|ehci_dbg
c_func
(paren
id|ehci
comma
l_string|&quot;resume root hub%s&bslash;n&quot;
comma
id|intr_enable
ques
c_cond
l_string|&quot; after power loss&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* restore CMD_RUN, framelist size, and irq threshold */
id|writel
(paren
id|ehci-&gt;command
comma
op_amp
id|ehci-&gt;regs-&gt;command
)paren
suffix:semicolon
multiline_comment|/* take ports out of suspend */
id|i
op_assign
id|HCS_N_PORTS
(paren
id|ehci-&gt;hcs_params
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
id|temp
op_assign
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|i
)braket
)paren
suffix:semicolon
id|temp
op_and_assign
op_complement
(paren
id|PORT_WKOC_E
op_or
id|PORT_WKDISC_E
op_or
id|PORT_WKCONN_E
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_SUSPEND
)paren
(brace
id|ehci-&gt;reset_done
(braket
id|i
)braket
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
(paren
l_int|20
)paren
suffix:semicolon
id|temp
op_or_assign
id|PORT_RESUME
suffix:semicolon
)brace
id|writel
(paren
id|temp
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|i
op_assign
id|HCS_N_PORTS
(paren
id|ehci-&gt;hcs_params
)paren
suffix:semicolon
id|mdelay
(paren
l_int|20
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
id|temp
op_assign
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|PORT_SUSPEND
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|temp
op_and_assign
op_complement
id|PORT_RESUME
suffix:semicolon
id|writel
(paren
id|temp
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|i
)braket
)paren
suffix:semicolon
id|ehci_vdbg
(paren
id|ehci
comma
l_string|&quot;resumed port %d&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;command
)paren
suffix:semicolon
multiline_comment|/* maybe re-activate the schedule(s) */
id|temp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ehci-&gt;async-&gt;qh_next.qh
)paren
id|temp
op_or_assign
id|CMD_ASE
suffix:semicolon
r_if
c_cond
(paren
id|ehci-&gt;periodic_sched
)paren
id|temp
op_or_assign
id|CMD_PSE
suffix:semicolon
r_if
c_cond
(paren
id|temp
)paren
(brace
id|ehci-&gt;command
op_or_assign
id|temp
suffix:semicolon
id|writel
(paren
id|ehci-&gt;command
comma
op_amp
id|ehci-&gt;regs-&gt;command
)paren
suffix:semicolon
)brace
id|ehci-&gt;next_statechange
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|ehci-&gt;hcd.state
op_assign
id|USB_STATE_RUNNING
suffix:semicolon
multiline_comment|/* Now we can safely re-enable irqs */
r_if
c_cond
(paren
id|intr_enable
)paren
id|writel
(paren
id|INTR_MASK
comma
op_amp
id|ehci-&gt;regs-&gt;intr_enable
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|ehci-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|ehci_hub_suspend
mdefine_line|#define ehci_hub_suspend&t;NULL
DECL|macro|ehci_hub_resume
mdefine_line|#define ehci_hub_resume&t;&t;NULL
macro_line|#endif&t;/* CONFIG_PM */
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|check_reset_complete
r_static
r_int
id|check_reset_complete
(paren
r_struct
id|ehci_hcd
op_star
id|ehci
comma
r_int
id|index
comma
r_int
id|port_status
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|port_status
op_amp
id|PORT_CONNECT
)paren
)paren
(brace
id|ehci-&gt;reset_done
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|port_status
suffix:semicolon
)brace
multiline_comment|/* if reset finished and it&squot;s still not enabled -- handoff */
r_if
c_cond
(paren
op_logical_neg
(paren
id|port_status
op_amp
id|PORT_PE
)paren
)paren
(brace
multiline_comment|/* with integrated TT, there&squot;s nobody to hand it to! */
r_if
c_cond
(paren
id|ehci_is_ARC
c_func
(paren
id|ehci
)paren
)paren
(brace
id|ehci_dbg
(paren
id|ehci
comma
l_string|&quot;Failed to enable port %d on root hub TT&bslash;n&quot;
comma
id|index
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|port_status
suffix:semicolon
)brace
id|ehci_dbg
(paren
id|ehci
comma
l_string|&quot;port %d full speed --&gt; companion&bslash;n&quot;
comma
id|index
op_plus
l_int|1
)paren
suffix:semicolon
singleline_comment|// what happens if HCS_N_CC(params) == 0 ?
id|port_status
op_or_assign
id|PORT_OWNER
suffix:semicolon
id|writel
(paren
id|port_status
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|index
)braket
)paren
suffix:semicolon
)brace
r_else
id|ehci_dbg
(paren
id|ehci
comma
l_string|&quot;port %d high speed&bslash;n&quot;
comma
id|index
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|port_status
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* build &quot;status change&quot; packet (one or two bytes) from HC registers */
r_static
r_int
DECL|function|ehci_hub_status_data
id|ehci_hub_status_data
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ehci_hcd
op_star
id|ehci
op_assign
id|hcd_to_ehci
(paren
id|hcd
)paren
suffix:semicolon
id|u32
id|temp
comma
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|ports
comma
id|i
comma
id|retval
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* if !USB_SUSPEND, root hub timers won&squot;t get shut down ... */
r_if
c_cond
(paren
op_logical_neg
id|HCD_IS_RUNNING
c_func
(paren
id|ehci-&gt;hcd.state
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* init status to no-changes */
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ports
op_assign
id|HCS_N_PORTS
(paren
id|ehci-&gt;hcs_params
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ports
OG
l_int|7
)paren
(brace
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|retval
op_increment
suffix:semicolon
)brace
multiline_comment|/* no hub change reports (bit 0) for now (power, ...) */
multiline_comment|/* port N changes (bit N)? */
id|spin_lock_irqsave
(paren
op_amp
id|ehci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp
op_assign
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_OWNER
)paren
(brace
multiline_comment|/* don&squot;t report this in GetPortStatus */
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_CSC
)paren
(brace
id|temp
op_and_assign
op_complement
id|PORT_CSC
suffix:semicolon
id|writel
(paren
id|temp
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|temp
op_amp
id|PORT_CONNECT
)paren
)paren
id|ehci-&gt;reset_done
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_amp
(paren
id|PORT_CSC
op_or
id|PORT_PEC
op_or
id|PORT_OCC
)paren
)paren
op_ne
l_int|0
singleline_comment|// PORT_STAT_C_SUSPEND?
op_logical_or
(paren
(paren
id|temp
op_amp
id|PORT_RESUME
)paren
op_ne
l_int|0
op_logical_and
id|time_after
(paren
id|jiffies
comma
id|ehci-&gt;reset_done
(braket
id|i
)braket
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|7
)paren
id|buf
(braket
l_int|0
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|i
op_plus
l_int|1
)paren
suffix:semicolon
r_else
id|buf
(braket
l_int|1
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|i
op_minus
l_int|7
)paren
suffix:semicolon
id|status
op_assign
id|STS_PCD
suffix:semicolon
)brace
)brace
multiline_comment|/* FIXME autosuspend idle root hubs */
id|spin_unlock_irqrestore
(paren
op_amp
id|ehci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
ques
c_cond
id|retval
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
DECL|function|ehci_hub_descriptor
id|ehci_hub_descriptor
(paren
r_struct
id|ehci_hcd
op_star
id|ehci
comma
r_struct
id|usb_hub_descriptor
op_star
id|desc
)paren
(brace
r_int
id|ports
op_assign
id|HCS_N_PORTS
(paren
id|ehci-&gt;hcs_params
)paren
suffix:semicolon
id|u16
id|temp
suffix:semicolon
id|desc-&gt;bDescriptorType
op_assign
l_int|0x29
suffix:semicolon
id|desc-&gt;bPwrOn2PwrGood
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* ehci 1.0, 2.3.9 says 20ms max */
id|desc-&gt;bHubContrCurrent
op_assign
l_int|0
suffix:semicolon
id|desc-&gt;bNbrPorts
op_assign
id|ports
suffix:semicolon
id|temp
op_assign
l_int|1
op_plus
(paren
id|ports
op_div
l_int|8
)paren
suffix:semicolon
id|desc-&gt;bDescLength
op_assign
l_int|7
op_plus
l_int|2
op_star
id|temp
suffix:semicolon
multiline_comment|/* two bitmaps:  ports removable, and usb 1.0 legacy PortPwrCtrlMask */
id|memset
(paren
op_amp
id|desc-&gt;bitmap
(braket
l_int|0
)braket
comma
l_int|0
comma
id|temp
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|desc-&gt;bitmap
(braket
id|temp
)braket
comma
l_int|0xff
comma
id|temp
)paren
suffix:semicolon
id|temp
op_assign
l_int|0x0008
suffix:semicolon
multiline_comment|/* per-port overcurrent reporting */
r_if
c_cond
(paren
id|HCS_PPC
(paren
id|ehci-&gt;hcs_params
)paren
)paren
id|temp
op_or_assign
l_int|0x0001
suffix:semicolon
multiline_comment|/* per-port power control */
macro_line|#if 0
singleline_comment|// re-enable when we support USB_PORT_FEAT_INDICATOR below.
r_if
c_cond
(paren
id|HCS_INDICATOR
(paren
id|ehci-&gt;hcs_params
)paren
)paren
id|temp
op_or_assign
l_int|0x0080
suffix:semicolon
multiline_comment|/* per-port indicators (LEDs) */
macro_line|#endif
id|desc-&gt;wHubCharacteristics
op_assign
(paren
id|__force
id|__u16
)paren
id|cpu_to_le16
(paren
id|temp
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|PORT_WAKE_BITS
mdefine_line|#define&t;PORT_WAKE_BITS &t;(PORT_WKOC_E|PORT_WKDISC_E|PORT_WKCONN_E)
DECL|function|ehci_hub_control
r_static
r_int
id|ehci_hub_control
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
id|u16
id|typeReq
comma
id|u16
id|wValue
comma
id|u16
id|wIndex
comma
r_char
op_star
id|buf
comma
id|u16
id|wLength
)paren
(brace
r_struct
id|ehci_hcd
op_star
id|ehci
op_assign
id|hcd_to_ehci
(paren
id|hcd
)paren
suffix:semicolon
r_int
id|ports
op_assign
id|HCS_N_PORTS
(paren
id|ehci-&gt;hcs_params
)paren
suffix:semicolon
id|u32
id|temp
comma
id|status
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME:  support SetPortFeatures USB_PORT_FEAT_INDICATOR.&n;&t; * HCS_INDICATOR may say we can change LEDs to off/amber/green.&n;&t; * (track current state ourselves) ... blink for diagnostics,&n;&t; * power, &quot;this is the one&quot;, etc.  EHCI spec supports this.&n;&t; */
id|spin_lock_irqsave
(paren
op_amp
id|ehci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|typeReq
)paren
(brace
r_case
id|ClearHubFeature
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|C_HUB_LOCAL_POWER
suffix:colon
r_case
id|C_HUB_OVER_CURRENT
suffix:colon
multiline_comment|/* no hub-wide feature/status flags */
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|error
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ClearPortFeature
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wIndex
op_logical_or
id|wIndex
OG
id|ports
)paren
r_goto
id|error
suffix:semicolon
id|wIndex
op_decrement
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_OWNER
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|USB_PORT_FEAT_ENABLE
suffix:colon
id|writel
(paren
id|temp
op_amp
op_complement
id|PORT_PE
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_C_ENABLE
suffix:colon
id|writel
(paren
id|temp
op_or
id|PORT_PEC
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_SUSPEND
suffix:colon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_RESET
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_SUSPEND
)paren
(brace
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|PORT_PE
)paren
op_eq
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* resume signaling for 20 msec */
id|writel
(paren
(paren
id|temp
op_amp
op_complement
id|PORT_WAKE_BITS
)paren
op_or
id|PORT_RESUME
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
id|ehci-&gt;reset_done
(braket
id|wIndex
)braket
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_C_SUSPEND
suffix:colon
multiline_comment|/* we auto-clear this feature */
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_POWER
suffix:colon
r_if
c_cond
(paren
id|HCS_PPC
(paren
id|ehci-&gt;hcs_params
)paren
)paren
id|writel
(paren
id|temp
op_amp
op_complement
id|PORT_POWER
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_C_CONNECTION
suffix:colon
id|writel
(paren
id|temp
op_or
id|PORT_CSC
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_C_OVER_CURRENT
suffix:colon
id|writel
(paren
id|temp
op_or
id|PORT_OCC
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_C_RESET
suffix:colon
multiline_comment|/* GetPortStatus clears reset */
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|error
suffix:semicolon
)brace
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;command
)paren
suffix:semicolon
multiline_comment|/* unblock posted write */
r_break
suffix:semicolon
r_case
id|GetHubDescriptor
suffix:colon
id|ehci_hub_descriptor
(paren
id|ehci
comma
(paren
r_struct
id|usb_hub_descriptor
op_star
)paren
id|buf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GetHubStatus
suffix:colon
multiline_comment|/* no hub-wide feature/status flags */
id|memset
(paren
id|buf
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
singleline_comment|//cpu_to_le32s ((u32 *) buf);
r_break
suffix:semicolon
r_case
id|GetPortStatus
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wIndex
op_logical_or
id|wIndex
OG
id|ports
)paren
r_goto
id|error
suffix:semicolon
id|wIndex
op_decrement
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
singleline_comment|// wPortChange bits
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_CSC
)paren
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_C_CONNECTION
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_PEC
)paren
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_C_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_OCC
)paren
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_C_OVER_CURRENT
suffix:semicolon
multiline_comment|/* whoever resumes must GetPortStatus to complete it!! */
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|PORT_RESUME
)paren
op_logical_and
id|time_after
(paren
id|jiffies
comma
id|ehci-&gt;reset_done
(braket
id|wIndex
)braket
)paren
)paren
(brace
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_C_SUSPEND
suffix:semicolon
id|ehci-&gt;reset_done
(braket
id|wIndex
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stop resume signaling */
id|temp
op_assign
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
id|writel
(paren
id|temp
op_amp
op_complement
id|PORT_RESUME
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
id|retval
op_assign
id|handshake
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
comma
id|PORT_RESUME
comma
l_int|0
comma
l_int|2000
multiline_comment|/* 2msec */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|ehci_err
(paren
id|ehci
comma
l_string|&quot;port %d resume error %d&bslash;n&quot;
comma
id|wIndex
op_plus
l_int|1
comma
id|retval
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|temp
op_and_assign
op_complement
(paren
id|PORT_SUSPEND
op_or
id|PORT_RESUME
op_or
(paren
l_int|3
op_lshift
l_int|10
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* whoever resets must GetPortStatus to complete it!! */
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|PORT_RESET
)paren
op_logical_and
id|time_after
(paren
id|jiffies
comma
id|ehci-&gt;reset_done
(braket
id|wIndex
)braket
)paren
)paren
(brace
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_C_RESET
suffix:semicolon
id|ehci-&gt;reset_done
(braket
id|wIndex
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* force reset to complete */
id|writel
(paren
id|temp
op_amp
op_complement
id|PORT_RESET
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
id|retval
op_assign
id|handshake
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
comma
id|PORT_RESET
comma
l_int|0
comma
l_int|500
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|ehci_err
(paren
id|ehci
comma
l_string|&quot;port %d reset error %d&bslash;n&quot;
comma
id|wIndex
op_plus
l_int|1
comma
id|retval
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* see what we found out */
id|temp
op_assign
id|check_reset_complete
(paren
id|ehci
comma
id|wIndex
comma
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
)paren
suffix:semicolon
)brace
singleline_comment|// don&squot;t show wPortStatus if it&squot;s owned by a companion hc
r_if
c_cond
(paren
op_logical_neg
(paren
id|temp
op_amp
id|PORT_OWNER
)paren
)paren
(brace
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_CONNECT
)paren
(brace
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_CONNECTION
suffix:semicolon
singleline_comment|// status may be from integrated TT
id|status
op_or_assign
id|ehci_port_speed
c_func
(paren
id|ehci
comma
id|temp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_PE
)paren
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
(paren
id|PORT_SUSPEND
op_or
id|PORT_RESUME
)paren
)paren
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_SUSPEND
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_OC
)paren
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_OVER_CURRENT
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_RESET
)paren
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_RESET
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_POWER
)paren
id|status
op_or_assign
l_int|1
op_lshift
id|USB_PORT_FEAT_POWER
suffix:semicolon
)brace
macro_line|#ifndef&t;EHCI_VERBOSE_DEBUG
r_if
c_cond
(paren
id|status
op_amp
op_complement
l_int|0xffff
)paren
multiline_comment|/* only if wPortChange is interesting */
macro_line|#endif
id|dbg_port
(paren
id|ehci
comma
l_string|&quot;GetStatus&quot;
comma
id|wIndex
op_plus
l_int|1
comma
id|temp
)paren
suffix:semicolon
singleline_comment|// we &quot;know&quot; this alignment is good, caller used kmalloc()...
op_star
(paren
(paren
id|__le32
op_star
)paren
id|buf
)paren
op_assign
id|cpu_to_le32
(paren
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SetHubFeature
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|C_HUB_LOCAL_POWER
suffix:colon
r_case
id|C_HUB_OVER_CURRENT
suffix:colon
multiline_comment|/* no hub-wide feature/status flags */
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|error
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SetPortFeature
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wIndex
op_logical_or
id|wIndex
OG
id|ports
)paren
r_goto
id|error
suffix:semicolon
id|wIndex
op_decrement
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_OWNER
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|USB_PORT_FEAT_SUSPEND
suffix:colon
r_if
c_cond
(paren
(paren
id|temp
op_amp
id|PORT_PE
)paren
op_eq
l_int|0
op_logical_or
(paren
id|temp
op_amp
id|PORT_RESET
)paren
op_ne
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ehci-&gt;hcd.remote_wakeup
)paren
id|temp
op_or_assign
id|PORT_WAKE_BITS
suffix:semicolon
id|writel
(paren
id|temp
op_or
id|PORT_SUSPEND
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_POWER
suffix:colon
r_if
c_cond
(paren
id|HCS_PPC
(paren
id|ehci-&gt;hcs_params
)paren
)paren
id|writel
(paren
id|temp
op_or
id|PORT_POWER
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_PORT_FEAT_RESET
suffix:colon
r_if
c_cond
(paren
id|temp
op_amp
id|PORT_RESUME
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* line status bits may report this as low speed,&n;&t;&t;&t; * which can be fine if this root hub has a&n;&t;&t;&t; * transaction translator built in.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|temp
op_amp
(paren
id|PORT_PE
op_or
id|PORT_CONNECT
)paren
)paren
op_eq
id|PORT_CONNECT
op_logical_and
op_logical_neg
id|ehci_is_ARC
c_func
(paren
id|ehci
)paren
op_logical_and
id|PORT_USB11
(paren
id|temp
)paren
)paren
(brace
id|ehci_dbg
(paren
id|ehci
comma
l_string|&quot;port %d low speed --&gt; companion&bslash;n&quot;
comma
id|wIndex
op_plus
l_int|1
)paren
suffix:semicolon
id|temp
op_or_assign
id|PORT_OWNER
suffix:semicolon
)brace
r_else
(brace
id|ehci_vdbg
(paren
id|ehci
comma
l_string|&quot;port %d reset&bslash;n&quot;
comma
id|wIndex
op_plus
l_int|1
)paren
suffix:semicolon
id|temp
op_or_assign
id|PORT_RESET
suffix:semicolon
id|temp
op_and_assign
op_complement
id|PORT_PE
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * caller must wait, then call GetPortStatus&n;&t;&t;&t;&t; * usb 2.0 spec says 50 ms resets on root&n;&t;&t;&t;&t; */
id|ehci-&gt;reset_done
(braket
id|wIndex
)braket
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
(paren
l_int|50
)paren
suffix:semicolon
)brace
id|writel
(paren
id|temp
comma
op_amp
id|ehci-&gt;regs-&gt;port_status
(braket
id|wIndex
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|error
suffix:semicolon
)brace
id|readl
(paren
op_amp
id|ehci-&gt;regs-&gt;command
)paren
suffix:semicolon
multiline_comment|/* unblock posted writes */
r_break
suffix:semicolon
r_default
suffix:colon
id|error
suffix:colon
multiline_comment|/* &quot;stall&quot; on error */
id|retval
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|ehci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
eof
