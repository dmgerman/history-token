multiline_comment|/*&n; * Universal Host Controller Interface driver for USB.&n; *&n; * Maintainer: Alan Stern &lt;stern@rowland.harvard.edu&gt;&n; *&n; * (C) Copyright 1999 Linus Torvalds&n; * (C) Copyright 1999-2002 Johannes Erdfelt, johannes@erdfelt.com&n; * (C) Copyright 1999 Randy Dunlap&n; * (C) Copyright 1999 Georg Acher, acher@in.tum.de&n; * (C) Copyright 1999 Deti Fliegl, deti@fliegl.de&n; * (C) Copyright 1999 Thomas Sailer, sailer@ife.ee.ethz.ch&n; * (C) Copyright 1999 Roman Weissgaerber, weissg@vienna.at&n; * (C) Copyright 2000 Yggdrasil Computing, Inc. (port of new PCI interface&n; *               support from usb-ohci.c by Adam Richter, adam@yggdrasil.com).&n; * (C) Copyright 1999 Gregory P. Smith (from usb-ohci.c)&n; * (C) Copyright 2004 Alan Stern, stern@rowland.harvard.edu&n; *&n; * Intel documents this fairly well, and as far as I know there&n; * are no royalties or anything like that, but even so there are&n; * people who decided that they want to do the same thing in a&n; * completely different way.&n; *&n; * WARNING! The USB documentation is downright evil. Most of it&n; * is just crap, written by a committee. You&squot;re better off ignoring&n; * most of it, the important stuff is:&n; *  - the low-level protocol (fairly simple but lots of small details)&n; *  - working around the horridness of the rest&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_USB_DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#else
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/debugfs.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/dmapool.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;../core/hcd.h&quot;
macro_line|#include &quot;uhci-hcd.h&quot;
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v2.2&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Linus &squot;Frodo Rabbit&squot; Torvalds, Johannes Erdfelt, &bslash;&n;Randy Dunlap, Georg Acher, Deti Fliegl, Thomas Sailer, Roman Weissgaerber, &bslash;&n;Alan Stern&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;USB Universal Host Controller Interface driver&quot;
multiline_comment|/*&n; * debug = 0, no debugging messages&n; * debug = 1, dump failed URB&squot;s except for stalls&n; * debug = 2, dump all failed URB&squot;s (including stalls)&n; *            show all queues in /debug/uhci/[pci_addr]&n; * debug = 3, show all TD&squot;s in URB&squot;s when dumping&n; */
macro_line|#ifdef DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|module_param
c_func
(paren
id|debug
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug level&quot;
)paren
suffix:semicolon
DECL|variable|errbuf
r_static
r_char
op_star
id|errbuf
suffix:semicolon
DECL|macro|ERRBUF_LEN
mdefine_line|#define ERRBUF_LEN    (32 * 1024)
DECL|variable|uhci_up_cachep
r_static
id|kmem_cache_t
op_star
id|uhci_up_cachep
suffix:semicolon
multiline_comment|/* urb_priv */
r_static
r_int
r_int
id|uhci_get_current_frame_number
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
suffix:semicolon
r_static
r_void
id|hc_state_transitions
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
suffix:semicolon
multiline_comment|/* If a transfer is still active after this much time, turn off FSBR */
DECL|macro|IDLE_TIMEOUT
mdefine_line|#define IDLE_TIMEOUT&t;msecs_to_jiffies(50)
DECL|macro|FSBR_DELAY
mdefine_line|#define FSBR_DELAY&t;msecs_to_jiffies(50)
multiline_comment|/* When we timeout an idle transfer for FSBR, we&squot;ll switch it over to */
multiline_comment|/* depth first traversal. We&squot;ll do it in groups of this number of TD&squot;s */
multiline_comment|/* to make sure it doesn&squot;t hog all of the bandwidth */
DECL|macro|DEPTH_INTERVAL
mdefine_line|#define DEPTH_INTERVAL 5
macro_line|#include &quot;uhci-hub.c&quot;
macro_line|#include &quot;uhci-debug.c&quot;
macro_line|#include &quot;uhci-q.c&quot;
r_static
r_int
id|init_stall_timer
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
suffix:semicolon
DECL|function|stall_callback
r_static
r_void
id|stall_callback
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_struct
id|usb_hcd
op_star
id|hcd
op_assign
(paren
r_struct
id|usb_hcd
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
r_struct
id|urb_priv
op_star
id|up
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|called_uhci_finish_completion
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_list
)paren
op_logical_and
id|uhci_get_current_frame_number
c_func
(paren
id|uhci
)paren
op_ne
id|uhci-&gt;urb_remove_age
)paren
(brace
id|uhci_remove_pending_urbps
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|uhci_finish_completion
c_func
(paren
id|hcd
comma
l_int|NULL
)paren
suffix:semicolon
id|called_uhci_finish_completion
op_assign
l_int|1
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|up
comma
op_amp
id|uhci-&gt;urb_list
comma
id|urb_list
)paren
(brace
r_struct
id|urb
op_star
id|u
op_assign
id|up-&gt;urb
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|u-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Check if the FSBR timed out */
r_if
c_cond
(paren
id|up-&gt;fsbr
op_logical_and
op_logical_neg
id|up-&gt;fsbr_timeout
op_logical_and
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|up-&gt;fsbrtime
op_plus
id|IDLE_TIMEOUT
)paren
)paren
id|uhci_fsbr_timeout
c_func
(paren
id|uhci
comma
id|u
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|u-&gt;lock
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Wake up anyone waiting for an URB to complete */
r_if
c_cond
(paren
id|called_uhci_finish_completion
)paren
id|wake_up_all
c_func
(paren
op_amp
id|uhci-&gt;waitqh
)paren
suffix:semicolon
multiline_comment|/* Really disable FSBR */
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;fsbr
op_logical_and
id|uhci-&gt;fsbrtimeout
op_logical_and
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|uhci-&gt;fsbrtimeout
)paren
)paren
(brace
id|uhci-&gt;fsbrtimeout
op_assign
l_int|0
suffix:semicolon
id|uhci-&gt;skel_term_qh-&gt;link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
)brace
multiline_comment|/* Poll for and perform state transitions */
id|hc_state_transitions
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|uhci-&gt;suspended_ports
op_logical_and
id|uhci-&gt;state
op_ne
id|UHCI_SUSPENDED
)paren
)paren
id|uhci_check_resume
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|init_stall_timer
c_func
(paren
id|hcd
)paren
suffix:semicolon
)brace
DECL|function|init_stall_timer
r_static
r_int
id|init_stall_timer
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|uhci-&gt;stall_timer
)paren
suffix:semicolon
id|uhci-&gt;stall_timer.function
op_assign
id|stall_callback
suffix:semicolon
id|uhci-&gt;stall_timer.data
op_assign
(paren
r_int
r_int
)paren
id|hcd
suffix:semicolon
id|uhci-&gt;stall_timer.expires
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|uhci-&gt;stall_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uhci_irq
r_static
id|irqreturn_t
id|uhci_irq
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
comma
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|age
suffix:semicolon
multiline_comment|/*&n;&t; * Read the interrupt status, and write it back to clear the&n;&t; * interrupt cause.  Contrary to the UHCI specification, the&n;&t; * &quot;HC Halted&quot; status bit is persistent: it is RO, not R/WC.&n;&t; */
id|status
op_assign
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBSTS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
op_complement
id|USBSTS_HCH
)paren
)paren
multiline_comment|/* shared interrupt, not mine */
r_return
id|IRQ_NONE
suffix:semicolon
id|outw
c_func
(paren
id|status
comma
id|io_addr
op_plus
id|USBSTS
)paren
suffix:semicolon
multiline_comment|/* Clear it */
r_if
c_cond
(paren
id|status
op_amp
op_complement
(paren
id|USBSTS_USBINT
op_or
id|USBSTS_ERROR
op_or
id|USBSTS_RD
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|USBSTS_HSE
)paren
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;host system error, &quot;
l_string|&quot;PCI problems?&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|USBSTS_HCPE
)paren
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;host controller process &quot;
l_string|&quot;error, something bad happened!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|USBSTS_HCH
)paren
op_logical_and
id|uhci-&gt;state
OG
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;host controller halted, &quot;
l_string|&quot;very bad!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME: Reset the controller, fix the offending TD */
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|USBSTS_RD
)paren
id|uhci-&gt;resume_detect
op_assign
l_int|1
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|uhci-&gt;lock
)paren
suffix:semicolon
id|age
op_assign
id|uhci_get_current_frame_number
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|age
op_ne
id|uhci-&gt;qh_remove_age
)paren
id|uhci_free_pending_qhs
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|age
op_ne
id|uhci-&gt;td_remove_age
)paren
id|uhci_free_pending_tds
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|age
op_ne
id|uhci-&gt;urb_remove_age
)paren
id|uhci_remove_pending_urbps
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_list
)paren
op_logical_and
id|list_empty
c_func
(paren
op_amp
id|uhci-&gt;td_remove_list
)paren
op_logical_and
id|list_empty
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_list
)paren
)paren
id|uhci_clear_next_interrupt
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_else
id|uhci_set_next_interrupt
c_func
(paren
id|uhci
)paren
suffix:semicolon
multiline_comment|/* Walk the list of pending URBs to see which ones completed&n;&t; * (must be _safe because uhci_transfer_result() dequeues URBs) */
id|list_for_each_entry_safe
c_func
(paren
id|urbp
comma
id|tmp
comma
op_amp
id|uhci-&gt;urb_list
comma
id|urb_list
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|urbp-&gt;urb
suffix:semicolon
multiline_comment|/* Checks the status and does all of the magic necessary */
id|uhci_transfer_result
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
)brace
id|uhci_finish_completion
c_func
(paren
id|hcd
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|uhci-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Wake up anyone waiting for an URB to complete */
id|wake_up_all
c_func
(paren
op_amp
id|uhci-&gt;waitqh
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|reset_hc
r_static
r_void
id|reset_hc
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
multiline_comment|/* Turn off PIRQ, SMI, and all interrupts.  This also turns off&n;&t; * the BIOS&squot;s USB Legacy Support.&n;&t; */
id|pci_write_config_word
c_func
(paren
id|to_pci_dev
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
)paren
comma
id|USBLEGSUP
comma
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|uhci-&gt;io_addr
op_plus
id|USBINTR
)paren
suffix:semicolon
multiline_comment|/* Global reset for 50ms */
id|uhci-&gt;state
op_assign
id|UHCI_RESET
suffix:semicolon
id|outw
c_func
(paren
id|USBCMD_GRESET
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
multiline_comment|/* Another 10ms delay */
id|msleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|uhci-&gt;resume_detect
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|suspend_hc
r_static
r_void
id|suspend_hc
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
id|dev_dbg
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|uhci-&gt;state
op_assign
id|UHCI_SUSPENDED
suffix:semicolon
id|uhci-&gt;resume_detect
op_assign
l_int|0
suffix:semicolon
id|outw
c_func
(paren
id|USBCMD_EGSM
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
)brace
DECL|function|wakeup_hc
r_static
r_void
id|wakeup_hc
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
r_switch
c_cond
(paren
id|uhci-&gt;state
)paren
(brace
r_case
id|UHCI_SUSPENDED
suffix:colon
multiline_comment|/* Start the resume */
id|dev_dbg
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Global resume for &gt;= 20ms */
id|outw
c_func
(paren
id|USBCMD_FGR
op_or
id|USBCMD_EGSM
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
id|uhci-&gt;state
op_assign
id|UHCI_RESUMING_1
suffix:semicolon
id|uhci-&gt;state_end
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UHCI_RESUMING_1
suffix:colon
multiline_comment|/* End global resume */
id|uhci-&gt;state
op_assign
id|UHCI_RESUMING_2
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
multiline_comment|/* Falls through */
r_case
id|UHCI_RESUMING_2
suffix:colon
multiline_comment|/* Wait for EOP to be sent */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBCMD
)paren
op_amp
id|USBCMD_FGR
)paren
r_break
suffix:semicolon
multiline_comment|/* Run for at least 1 second, and&n;&t;&t;&t; * mark it configured with a 64-byte max packet */
id|uhci-&gt;state
op_assign
id|UHCI_RUNNING_GRACE
suffix:semicolon
id|uhci-&gt;state_end
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|outw
c_func
(paren
id|USBCMD_RS
op_or
id|USBCMD_CF
op_or
id|USBCMD_MAXP
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UHCI_RUNNING_GRACE
suffix:colon
multiline_comment|/* Now allowed to suspend */
id|uhci-&gt;state
op_assign
id|UHCI_RUNNING
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
DECL|function|ports_active
r_static
r_int
id|ports_active
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
r_int
id|connection
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uhci-&gt;rh_numports
suffix:semicolon
id|i
op_increment
)paren
id|connection
op_or_assign
(paren
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBPORTSC1
op_plus
id|i
op_star
l_int|2
)paren
op_amp
id|USBPORTSC_CCS
)paren
suffix:semicolon
r_return
id|connection
suffix:semicolon
)brace
DECL|function|suspend_allowed
r_static
r_int
id|suspend_allowed
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|to_pci_dev
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
)paren
op_member_access_from_pointer
id|vendor
op_ne
id|PCI_VENDOR_ID_INTEL
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Some of Intel&squot;s USB controllers have a bug that causes false&n;&t; * resume indications if any port has an over current condition.&n;&t; * To prevent problems, we will not allow a global suspend if&n;&t; * any ports are OC.&n;&t; *&n;&t; * Some motherboards using Intel&squot;s chipsets (but not using all&n;&t; * the USB ports) appear to hardwire the over current inputs active&n;&t; * to disable the USB ports.&n;&t; */
multiline_comment|/* check for over current condition on any port */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uhci-&gt;rh_numports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBPORTSC1
op_plus
id|i
op_star
l_int|2
)paren
op_amp
id|USBPORTSC_OC
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|hc_state_transitions
r_static
r_void
id|hc_state_transitions
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_switch
c_cond
(paren
id|uhci-&gt;state
)paren
(brace
r_case
id|UHCI_RUNNING
suffix:colon
multiline_comment|/* global suspend if nothing connected for 1 second */
r_if
c_cond
(paren
op_logical_neg
id|ports_active
c_func
(paren
id|uhci
)paren
op_logical_and
id|suspend_allowed
c_func
(paren
id|uhci
)paren
)paren
(brace
id|uhci-&gt;state
op_assign
id|UHCI_SUSPENDING_GRACE
suffix:semicolon
id|uhci-&gt;state_end
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|UHCI_SUSPENDING_GRACE
suffix:colon
r_if
c_cond
(paren
id|ports_active
c_func
(paren
id|uhci
)paren
)paren
id|uhci-&gt;state
op_assign
id|UHCI_RUNNING
suffix:semicolon
r_else
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|uhci-&gt;state_end
)paren
)paren
id|suspend_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UHCI_SUSPENDED
suffix:colon
multiline_comment|/* wakeup if requested by a device */
r_if
c_cond
(paren
id|uhci-&gt;resume_detect
)paren
id|wakeup_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UHCI_RESUMING_1
suffix:colon
r_case
id|UHCI_RESUMING_2
suffix:colon
r_case
id|UHCI_RUNNING_GRACE
suffix:colon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|uhci-&gt;state_end
)paren
)paren
id|wakeup_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * returns the current frame number for a USB bus/controller.&n; */
DECL|function|uhci_get_current_frame_number
r_static
r_int
r_int
id|uhci_get_current_frame_number
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_return
id|inw
c_func
(paren
id|uhci-&gt;io_addr
op_plus
id|USBFRNUM
)paren
suffix:semicolon
)brace
DECL|function|start_hc
r_static
r_int
id|start_hc
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
r_int
id|timeout
op_assign
l_int|10
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the HC - this will force us to get a&n;&t; * new notification of any already connected&n;&t; * ports due to the virtual disconnect that it&n;&t; * implies.&n;&t; */
id|outw
c_func
(paren
id|USBCMD_HCRESET
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBCMD
)paren
op_amp
id|USBCMD_HCRESET
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;USBCMD_HCRESET timed out!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Mark controller as running before we enable interrupts */
id|uhci_to_hcd
c_func
(paren
id|uhci
)paren
op_member_access_from_pointer
id|state
op_assign
id|HC_STATE_RUNNING
suffix:semicolon
multiline_comment|/* Turn on PIRQ and all interrupts */
id|pci_write_config_word
c_func
(paren
id|to_pci_dev
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
)paren
comma
id|USBLEGSUP
comma
id|USBLEGSUP_DEFAULT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|USBINTR_TIMEOUT
op_or
id|USBINTR_RESUME
op_or
id|USBINTR_IOC
op_or
id|USBINTR_SP
comma
id|io_addr
op_plus
id|USBINTR
)paren
suffix:semicolon
multiline_comment|/* Start at frame 0 */
id|outw
c_func
(paren
l_int|0
comma
id|io_addr
op_plus
id|USBFRNUM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|uhci-&gt;fl-&gt;dma_handle
comma
id|io_addr
op_plus
id|USBFLBASEADD
)paren
suffix:semicolon
multiline_comment|/* Run and mark it configured with a 64-byte max packet */
id|uhci-&gt;state
op_assign
id|UHCI_RUNNING_GRACE
suffix:semicolon
id|uhci-&gt;state_end
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|outw
c_func
(paren
id|USBCMD_RS
op_or
id|USBCMD_CF
op_or
id|USBCMD_MAXP
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * De-allocate all resources&n; */
DECL|function|release_uhci
r_static
r_void
id|release_uhci
c_func
(paren
r_struct
id|uhci_hcd
op_star
id|uhci
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UHCI_NUM_SKELQH
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|uhci-&gt;skelqh
(braket
id|i
)braket
)paren
(brace
id|uhci_free_qh
c_func
(paren
id|uhci
comma
id|uhci-&gt;skelqh
(braket
id|i
)braket
)paren
suffix:semicolon
id|uhci-&gt;skelqh
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;term_td
)paren
(brace
id|uhci_free_td
c_func
(paren
id|uhci
comma
id|uhci-&gt;term_td
)paren
suffix:semicolon
id|uhci-&gt;term_td
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;qh_pool
)paren
(brace
id|dma_pool_destroy
c_func
(paren
id|uhci-&gt;qh_pool
)paren
suffix:semicolon
id|uhci-&gt;qh_pool
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;td_pool
)paren
(brace
id|dma_pool_destroy
c_func
(paren
id|uhci-&gt;td_pool
)paren
suffix:semicolon
id|uhci-&gt;td_pool
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;fl
)paren
(brace
id|dma_free_coherent
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
r_sizeof
(paren
op_star
id|uhci-&gt;fl
)paren
comma
id|uhci-&gt;fl
comma
id|uhci-&gt;fl-&gt;dma_handle
)paren
suffix:semicolon
id|uhci-&gt;fl
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;dentry
)paren
(brace
id|debugfs_remove
c_func
(paren
id|uhci-&gt;dentry
)paren
suffix:semicolon
id|uhci-&gt;dentry
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|uhci_reset
r_static
r_int
id|uhci_reset
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
id|uhci-&gt;io_addr
op_assign
(paren
r_int
r_int
)paren
id|hcd-&gt;rsrc_start
suffix:semicolon
multiline_comment|/* Kick BIOS off this hardware and reset, so we won&squot;t get&n;&t; * interrupts from any previous setup.&n;&t; */
id|reset_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a frame list, and then setup the skeleton&n; *&n; * The hardware doesn&squot;t really know any difference&n; * in the queues, but the order does matter for the&n; * protocols higher up. The order is:&n; *&n; *  - any isochronous events handled before any&n; *    of the queues. We don&squot;t do that here, because&n; *    we&squot;ll create the actual TD entries on demand.&n; *  - The first queue is the interrupt queue.&n; *  - The second queue is the control queue, split into low- and full-speed&n; *  - The third queue is bulk queue.&n; *  - The fourth queue is the bandwidth reclamation queue, which loops back&n; *    to the full-speed control queue.&n; */
DECL|function|uhci_start
r_static
r_int
id|uhci_start
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_int
id|i
comma
id|port
suffix:semicolon
r_int
id|io_size
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
r_struct
id|usb_device
op_star
id|udev
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
id|io_size
op_assign
(paren
r_int
)paren
id|hcd-&gt;rsrc_len
suffix:semicolon
id|dentry
op_assign
id|debugfs_create_file
c_func
(paren
id|hcd-&gt;self.bus_name
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|uhci_debugfs_root
comma
id|uhci
comma
op_amp
id|uhci_debug_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;couldn&squot;t create uhci debugfs entry&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_create_debug_entry
suffix:semicolon
)brace
id|uhci-&gt;dentry
op_assign
id|dentry
suffix:semicolon
id|uhci-&gt;fsbr
op_assign
l_int|0
suffix:semicolon
id|uhci-&gt;fsbrtimeout
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|uhci-&gt;lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|uhci-&gt;td_remove_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|uhci-&gt;urb_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|uhci-&gt;complete_list
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|uhci-&gt;waitqh
)paren
suffix:semicolon
id|uhci-&gt;fl
op_assign
id|dma_alloc_coherent
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
r_sizeof
(paren
op_star
id|uhci-&gt;fl
)paren
comma
op_amp
id|dma_handle
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;fl
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;unable to allocate &quot;
l_string|&quot;consistent memory for frame list&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_alloc_fl
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|uhci-&gt;fl
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|uhci-&gt;fl
)paren
)paren
suffix:semicolon
id|uhci-&gt;fl-&gt;dma_handle
op_assign
id|dma_handle
suffix:semicolon
id|uhci-&gt;td_pool
op_assign
id|dma_pool_create
c_func
(paren
l_string|&quot;uhci_td&quot;
comma
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
r_sizeof
(paren
r_struct
id|uhci_td
)paren
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;td_pool
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;unable to create td dma_pool&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_create_td_pool
suffix:semicolon
)brace
id|uhci-&gt;qh_pool
op_assign
id|dma_pool_create
c_func
(paren
l_string|&quot;uhci_qh&quot;
comma
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
r_sizeof
(paren
r_struct
id|uhci_qh
)paren
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;qh_pool
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;unable to create qh dma_pool&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_create_qh_pool
suffix:semicolon
)brace
multiline_comment|/* Initialize the root hub */
multiline_comment|/* UHCI specs says devices must have 2 ports, but goes on to say */
multiline_comment|/*  they may have more but give no way to determine how many they */
multiline_comment|/*  have. However, according to the UHCI spec, Bit 7 is always set */
multiline_comment|/*  to 1. So we try to use this to our advantage */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
(paren
id|io_size
op_minus
l_int|0x10
)paren
op_div
l_int|2
suffix:semicolon
id|port
op_increment
)paren
(brace
r_int
r_int
id|portstatus
suffix:semicolon
id|portstatus
op_assign
id|inw
c_func
(paren
id|uhci-&gt;io_addr
op_plus
l_int|0x10
op_plus
(paren
id|port
op_star
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|portstatus
op_amp
l_int|0x0080
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
)paren
id|dev_info
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;detected %d ports&bslash;n&quot;
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* This is experimental so anything less than 2 or greater than 8 is */
multiline_comment|/*  something weird and we&squot;ll ignore it */
r_if
c_cond
(paren
id|port
template_param
id|UHCI_RH_MAXCHILD
)paren
(brace
id|dev_info
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;port count misdetected? &quot;
l_string|&quot;forcing to 2 ports&bslash;n&quot;
)paren
suffix:semicolon
id|port
op_assign
l_int|2
suffix:semicolon
)brace
id|uhci-&gt;rh_numports
op_assign
id|port
suffix:semicolon
id|udev
op_assign
id|usb_alloc_dev
c_func
(paren
l_int|NULL
comma
op_amp
id|hcd-&gt;self
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udev
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;unable to allocate root hub&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_alloc_root_hub
suffix:semicolon
)brace
id|uhci-&gt;term_td
op_assign
id|uhci_alloc_td
c_func
(paren
id|uhci
comma
id|udev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;term_td
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;unable to allocate terminating TD&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_alloc_term_td
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UHCI_NUM_SKELQH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|uhci-&gt;skelqh
(braket
id|i
)braket
op_assign
id|uhci_alloc_qh
c_func
(paren
id|uhci
comma
id|udev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;skelqh
(braket
id|i
)braket
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;unable to allocate QH&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_alloc_skelqh
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * 8 Interrupt queues; link all higher int queues to int1,&n;&t; * then link int1 to control and control to bulk&n;&t; */
id|uhci-&gt;skel_int128_qh-&gt;link
op_assign
id|uhci-&gt;skel_int64_qh-&gt;link
op_assign
id|uhci-&gt;skel_int32_qh-&gt;link
op_assign
id|uhci-&gt;skel_int16_qh-&gt;link
op_assign
id|uhci-&gt;skel_int8_qh-&gt;link
op_assign
id|uhci-&gt;skel_int4_qh-&gt;link
op_assign
id|uhci-&gt;skel_int2_qh-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;skel_int1_qh-&gt;dma_handle
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|uhci-&gt;skel_int1_qh-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;skel_ls_control_qh-&gt;dma_handle
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|uhci-&gt;skel_ls_control_qh-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;skel_fs_control_qh-&gt;dma_handle
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|uhci-&gt;skel_fs_control_qh-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;skel_bulk_qh-&gt;dma_handle
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|uhci-&gt;skel_bulk_qh-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;skel_term_qh-&gt;dma_handle
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
multiline_comment|/* This dummy TD is to work around a bug in Intel PIIX controllers */
id|uhci_fill_td
c_func
(paren
id|uhci-&gt;term_td
comma
l_int|0
comma
(paren
id|UHCI_NULL_DATA_SIZE
op_lshift
l_int|21
)paren
op_or
(paren
l_int|0x7f
op_lshift
id|TD_TOKEN_DEVADDR_SHIFT
)paren
op_or
id|USB_PID_IN
comma
l_int|0
)paren
suffix:semicolon
id|uhci-&gt;term_td-&gt;link
op_assign
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;term_td-&gt;dma_handle
)paren
suffix:semicolon
id|uhci-&gt;skel_term_qh-&gt;link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|uhci-&gt;skel_term_qh-&gt;element
op_assign
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;term_td-&gt;dma_handle
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Fill the frame list: make all entries point to the proper&n;&t; * interrupt queue.&n;&t; *&n;&t; * The interrupt queues will be interleaved as evenly as possible.&n;&t; * There&squot;s not much to be done about period-1 interrupts; they have&n;&t; * to occur in every frame.  But we can schedule period-2 interrupts&n;&t; * in odd-numbered frames, period-4 interrupts in frames congruent&n;&t; * to 2 (mod 4), and so on.  This way each frame only has two&n;&t; * interrupt QHs, which will help spread out bandwidth utilization.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UHCI_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|irq
suffix:semicolon
multiline_comment|/*&n;&t;&t; * ffs (Find First bit Set) does exactly what we need:&n;&t;&t; * 1,3,5,...  =&gt; ffs = 0 =&gt; use skel_int2_qh = skelqh[6],&n;&t;&t; * 2,6,10,... =&gt; ffs = 1 =&gt; use skel_int4_qh = skelqh[5], etc.&n;&t;&t; * ffs &gt; 6 =&gt; not on any high-period queue, so use&n;&t;&t; *&t;skel_int1_qh = skelqh[7].&n;&t;&t; * Add UHCI_NUMFRAMES to insure at least one bit is set.&n;&t;&t; */
id|irq
op_assign
l_int|6
op_minus
(paren
r_int
)paren
id|__ffs
c_func
(paren
id|i
op_plus
id|UHCI_NUMFRAMES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* Only place we don&squot;t use the frame list routines */
id|uhci-&gt;fl-&gt;frame
(braket
id|i
)braket
op_assign
id|UHCI_PTR_QH
op_or
id|cpu_to_le32
c_func
(paren
id|uhci-&gt;skelqh
(braket
id|irq
)braket
op_member_access_from_pointer
id|dma_handle
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Some architectures require a full mb() to enforce completion of&n;&t; * the memory writes above before the I/O transfers in start_hc().&n;&t; */
id|mb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|start_hc
c_func
(paren
id|uhci
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|err_alloc_skelqh
suffix:semicolon
id|init_stall_timer
c_func
(paren
id|hcd
)paren
suffix:semicolon
id|udev-&gt;speed
op_assign
id|USB_SPEED_FULL
suffix:semicolon
r_if
c_cond
(paren
id|usb_hcd_register_root_hub
c_func
(paren
id|udev
comma
id|hcd
)paren
op_ne
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
l_string|&quot;unable to start root hub&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_start_root_hub
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n; * error exits:&n; */
id|err_start_root_hub
suffix:colon
id|reset_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|uhci-&gt;stall_timer
)paren
suffix:semicolon
id|err_alloc_skelqh
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UHCI_NUM_SKELQH
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|uhci-&gt;skelqh
(braket
id|i
)braket
)paren
(brace
id|uhci_free_qh
c_func
(paren
id|uhci
comma
id|uhci-&gt;skelqh
(braket
id|i
)braket
)paren
suffix:semicolon
id|uhci-&gt;skelqh
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|uhci_free_td
c_func
(paren
id|uhci
comma
id|uhci-&gt;term_td
)paren
suffix:semicolon
id|uhci-&gt;term_td
op_assign
l_int|NULL
suffix:semicolon
id|err_alloc_term_td
suffix:colon
id|usb_put_dev
c_func
(paren
id|udev
)paren
suffix:semicolon
id|err_alloc_root_hub
suffix:colon
id|dma_pool_destroy
c_func
(paren
id|uhci-&gt;qh_pool
)paren
suffix:semicolon
id|uhci-&gt;qh_pool
op_assign
l_int|NULL
suffix:semicolon
id|err_create_qh_pool
suffix:colon
id|dma_pool_destroy
c_func
(paren
id|uhci-&gt;td_pool
)paren
suffix:semicolon
id|uhci-&gt;td_pool
op_assign
l_int|NULL
suffix:semicolon
id|err_create_td_pool
suffix:colon
id|dma_free_coherent
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
comma
r_sizeof
(paren
op_star
id|uhci-&gt;fl
)paren
comma
id|uhci-&gt;fl
comma
id|uhci-&gt;fl-&gt;dma_handle
)paren
suffix:semicolon
id|uhci-&gt;fl
op_assign
l_int|NULL
suffix:semicolon
id|err_alloc_fl
suffix:colon
id|debugfs_remove
c_func
(paren
id|uhci-&gt;dentry
)paren
suffix:semicolon
id|uhci-&gt;dentry
op_assign
l_int|NULL
suffix:semicolon
id|err_create_debug_entry
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|uhci_stop
r_static
r_void
id|uhci_stop
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|uhci-&gt;stall_timer
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * At this point, we&squot;re guaranteed that no new connects can be made&n;&t; * to this bus since there are no more parents&n;&t; */
id|reset_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|uhci-&gt;lock
)paren
suffix:semicolon
id|uhci_free_pending_qhs
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|uhci_free_pending_tds
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|uhci_remove_pending_urbps
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|uhci_finish_completion
c_func
(paren
id|hcd
comma
l_int|NULL
)paren
suffix:semicolon
id|uhci_free_pending_qhs
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|uhci_free_pending_tds
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|uhci-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Wake up anyone waiting for an URB to complete */
id|wake_up_all
c_func
(paren
op_amp
id|uhci-&gt;waitqh
)paren
suffix:semicolon
id|release_uhci
c_func
(paren
id|uhci
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
DECL|function|uhci_suspend
r_static
r_int
id|uhci_suspend
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
id|u32
id|state
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t try to suspend broken motherboards, reset instead */
r_if
c_cond
(paren
id|suspend_allowed
c_func
(paren
id|uhci
)paren
)paren
(brace
id|suspend_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|uhci-&gt;saved_framenumber
op_assign
id|inw
c_func
(paren
id|uhci-&gt;io_addr
op_plus
id|USBFRNUM
)paren
op_amp
l_int|0x3ff
suffix:semicolon
)brace
r_else
id|reset_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uhci_resume
r_static
r_int
id|uhci_resume
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|pci_set_master
c_func
(paren
id|to_pci_dev
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;state
op_eq
id|UHCI_SUSPENDED
)paren
(brace
multiline_comment|/*&n;&t;&t; * Some systems don&squot;t maintain the UHCI register values&n;&t;&t; * during a PM suspend/resume cycle, so reinitialize&n;&t;&t; * the Frame Number, Framelist Base Address, Interrupt&n;&t;&t; * Enable, and Legacy Support registers.&n;&t;&t; */
id|pci_write_config_word
c_func
(paren
id|to_pci_dev
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
)paren
comma
id|USBLEGSUP
comma
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
id|uhci-&gt;saved_framenumber
comma
id|uhci-&gt;io_addr
op_plus
id|USBFRNUM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|uhci-&gt;fl-&gt;dma_handle
comma
id|uhci-&gt;io_addr
op_plus
id|USBFLBASEADD
)paren
suffix:semicolon
id|outw
c_func
(paren
id|USBINTR_TIMEOUT
op_or
id|USBINTR_RESUME
op_or
id|USBINTR_IOC
op_or
id|USBINTR_SP
comma
id|uhci-&gt;io_addr
op_plus
id|USBINTR
)paren
suffix:semicolon
id|uhci-&gt;resume_detect
op_assign
l_int|1
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|to_pci_dev
c_func
(paren
id|uhci_dev
c_func
(paren
id|uhci
)paren
)paren
comma
id|USBLEGSUP
comma
id|USBLEGSUP_DEFAULT
)paren
suffix:semicolon
)brace
r_else
(brace
id|reset_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|start_hc
c_func
(paren
id|uhci
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
id|hcd-&gt;state
op_assign
id|HC_STATE_RUNNING
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Wait until all the URBs for a particular device/endpoint are gone */
DECL|function|uhci_hcd_endpoint_disable
r_static
r_void
id|uhci_hcd_endpoint_disable
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
r_struct
id|usb_host_endpoint
op_star
id|ep
)paren
(brace
r_struct
id|uhci_hcd
op_star
id|uhci
op_assign
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
suffix:semicolon
id|wait_event_interruptible
c_func
(paren
id|uhci-&gt;waitqh
comma
id|list_empty
c_func
(paren
op_amp
id|ep-&gt;urb_list
)paren
)paren
suffix:semicolon
)brace
DECL|function|uhci_hcd_get_frame_number
r_static
r_int
id|uhci_hcd_get_frame_number
c_func
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_return
id|uhci_get_current_frame_number
c_func
(paren
id|hcd_to_uhci
c_func
(paren
id|hcd
)paren
)paren
suffix:semicolon
)brace
DECL|variable|hcd_name
r_static
r_const
r_char
id|hcd_name
(braket
)braket
op_assign
l_string|&quot;uhci_hcd&quot;
suffix:semicolon
DECL|variable|uhci_driver
r_static
r_const
r_struct
id|hc_driver
id|uhci_driver
op_assign
(brace
dot
id|description
op_assign
id|hcd_name
comma
dot
id|product_desc
op_assign
l_string|&quot;UHCI Host Controller&quot;
comma
dot
id|hcd_priv_size
op_assign
r_sizeof
(paren
r_struct
id|uhci_hcd
)paren
comma
multiline_comment|/* Generic hardware linkage */
dot
id|irq
op_assign
id|uhci_irq
comma
dot
id|flags
op_assign
id|HCD_USB11
comma
multiline_comment|/* Basic lifecycle operations */
dot
id|reset
op_assign
id|uhci_reset
comma
dot
id|start
op_assign
id|uhci_start
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|uhci_suspend
comma
dot
id|resume
op_assign
id|uhci_resume
comma
macro_line|#endif
dot
id|stop
op_assign
id|uhci_stop
comma
dot
id|urb_enqueue
op_assign
id|uhci_urb_enqueue
comma
dot
id|urb_dequeue
op_assign
id|uhci_urb_dequeue
comma
dot
id|endpoint_disable
op_assign
id|uhci_hcd_endpoint_disable
comma
dot
id|get_frame_number
op_assign
id|uhci_hcd_get_frame_number
comma
dot
id|hub_status_data
op_assign
id|uhci_hub_status_data
comma
dot
id|hub_control
op_assign
id|uhci_hub_control
comma
)brace
suffix:semicolon
DECL|variable|uhci_pci_ids
r_static
r_const
r_struct
id|pci_device_id
id|uhci_pci_ids
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* handle any USB UHCI controller */
id|PCI_DEVICE_CLASS
c_func
(paren
(paren
(paren
id|PCI_CLASS_SERIAL_USB
op_lshift
l_int|8
)paren
op_or
l_int|0x00
)paren
comma
op_complement
l_int|0
)paren
comma
dot
id|driver_data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|uhci_driver
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|uhci_pci_ids
)paren
suffix:semicolon
DECL|variable|uhci_pci_driver
r_static
r_struct
id|pci_driver
id|uhci_pci_driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
id|hcd_name
comma
dot
id|id_table
op_assign
id|uhci_pci_ids
comma
dot
id|probe
op_assign
id|usb_hcd_pci_probe
comma
dot
id|remove
op_assign
id|usb_hcd_pci_remove
comma
macro_line|#ifdef&t;CONFIG_PM
dot
id|suspend
op_assign
id|usb_hcd_pci_suspend
comma
dot
id|resume
op_assign
id|usb_hcd_pci_resume
comma
macro_line|#endif&t;/* PM */
)brace
suffix:semicolon
DECL|function|uhci_hcd_init
r_static
r_int
id|__init
id|uhci_hcd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_disabled
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
(brace
id|errbuf
op_assign
id|kmalloc
c_func
(paren
id|ERRBUF_LEN
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|errbuf
)paren
r_goto
id|errbuf_failed
suffix:semicolon
)brace
id|uhci_debugfs_root
op_assign
id|debugfs_create_dir
c_func
(paren
l_string|&quot;uhci&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci_debugfs_root
)paren
r_goto
id|debug_failed
suffix:semicolon
id|uhci_up_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;uhci_urb_priv&quot;
comma
r_sizeof
(paren
r_struct
id|urb_priv
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci_up_cachep
)paren
r_goto
id|up_failed
suffix:semicolon
id|retval
op_assign
id|pci_register_driver
c_func
(paren
op_amp
id|uhci_pci_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|init_failed
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|init_failed
suffix:colon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_up_cachep
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;not all urb_priv&squot;s were freed!&quot;
)paren
suffix:semicolon
id|up_failed
suffix:colon
id|debugfs_remove
c_func
(paren
id|uhci_debugfs_root
)paren
suffix:semicolon
id|debug_failed
suffix:colon
r_if
c_cond
(paren
id|errbuf
)paren
id|kfree
c_func
(paren
id|errbuf
)paren
suffix:semicolon
id|errbuf_failed
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|uhci_hcd_cleanup
r_static
r_void
id|__exit
id|uhci_hcd_cleanup
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|uhci_pci_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_up_cachep
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;not all urb_priv&squot;s were freed!&quot;
)paren
suffix:semicolon
id|debugfs_remove
c_func
(paren
id|uhci_debugfs_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errbuf
)paren
id|kfree
c_func
(paren
id|errbuf
)paren
suffix:semicolon
)brace
DECL|variable|uhci_hcd_init
id|module_init
c_func
(paren
id|uhci_hcd_init
)paren
suffix:semicolon
DECL|variable|uhci_hcd_cleanup
id|module_exit
c_func
(paren
id|uhci_hcd_cleanup
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
