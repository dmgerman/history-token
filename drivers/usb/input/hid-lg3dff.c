multiline_comment|/*&n; * $$&n; *&n; *  Force feedback support for hid-compliant devices of the Logitech *3D family&n; *&n; *  Copyright (c) 2002 Johann Deneux&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * Should you need to contact me, the author, you can do so by&n; * e-mail - mail your message to &lt;deneux@ifrance.com&gt;&n; */
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/circ_buf.h&gt;
macro_line|#include &quot;hid.h&quot;
macro_line|#include &quot;fixp-arith.h&quot;
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(t) (jiffies + (t))
multiline_comment|/* Periodicity of the update */
DECL|macro|PERIOD
mdefine_line|#define PERIOD (HZ/10)
multiline_comment|/* Effect status: lg3d_effect::flags */
DECL|macro|EFFECT_STARTED
mdefine_line|#define EFFECT_STARTED 0     /* Effect is going to play after some time&n;&t;&t;&t;&t;(ff_replay.delay) */
DECL|macro|EFFECT_PLAYING
mdefine_line|#define EFFECT_PLAYING 1     /* Effect is being played */
DECL|macro|EFFECT_USED
mdefine_line|#define EFFECT_USED    2
multiline_comment|/* Check that the current process can access an effect */
DECL|macro|CHECK_OWNERSHIP
mdefine_line|#define CHECK_OWNERSHIP(i, l) &bslash;&n;        (i&gt;=0 &amp;&amp; i&lt;N_EFFECTS &bslash;&n;        &amp;&amp; test_bit(EFFECT_USED, l-&gt;effects[i].flags) &bslash;&n;        &amp;&amp; (current-&gt;pid == 0 &bslash;&n;            || l-&gt;effects[i].owner == current-&gt;pid))
DECL|macro|N_EFFECTS
mdefine_line|#define N_EFFECTS 8
DECL|struct|lg3d_effect
r_struct
id|lg3d_effect
(brace
DECL|member|owner
id|pid_t
id|owner
suffix:semicolon
DECL|member|effect
r_struct
id|ff_effect
id|effect
suffix:semicolon
multiline_comment|/* Description of the effect */
DECL|member|count
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* Number of times left to play */
DECL|member|flags
r_int
r_int
id|flags
(braket
l_int|1
)braket
suffix:semicolon
DECL|member|started_at
r_int
r_int
id|started_at
suffix:semicolon
multiline_comment|/* When the effect started to play */
)brace
suffix:semicolon
singleline_comment|// For lg3d_device::flags
DECL|macro|DEVICE_USB_XMIT
mdefine_line|#define DEVICE_USB_XMIT 0          /* An URB is being sent */
DECL|macro|DEVICE_CLOSING
mdefine_line|#define DEVICE_CLOSING 1           /* The driver is being unitialised */
DECL|struct|lg3d_device
r_struct
id|lg3d_device
(brace
DECL|member|hid
r_struct
id|hid_device
op_star
id|hid
suffix:semicolon
DECL|member|urbffout
r_struct
id|urb
op_star
id|urbffout
suffix:semicolon
multiline_comment|/* Output URB used to send ff commands */
DECL|member|ffcr
r_struct
id|usb_ctrlrequest
id|ffcr
suffix:semicolon
multiline_comment|/* ff commands use control URBs */
DECL|member|buf
r_char
id|buf
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|effects
r_struct
id|lg3d_effect
id|effects
(braket
id|N_EFFECTS
)braket
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* device-level lock. Having locks on&n;&t;&t;&t;&t;&t;a per-effect basis could be nice, but&n;&t;&t;&t;&t;&t;isn&squot;t really necessary */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|last_time
r_int
r_int
id|last_time
suffix:semicolon
multiline_comment|/* Last time the timer handler was&n;&t;&t;&t;&t;&t;executed */
DECL|member|flags
r_int
r_int
id|flags
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Contains various information about the&n;&t;&t;&t;&t;        state of the driver for this device */
)brace
suffix:semicolon
r_static
r_void
id|hid_lg3d_ctrl_out
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|hid_lg3d_exit
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
suffix:semicolon
r_static
r_int
id|hid_lg3d_event
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
comma
r_struct
id|input_dev
op_star
id|input
comma
r_int
r_int
id|type
comma
r_int
r_int
id|code
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|hid_lg3d_flush
c_func
(paren
r_struct
id|input_dev
op_star
id|input
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|hid_lg3d_upload_effect
c_func
(paren
r_struct
id|input_dev
op_star
id|input
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
suffix:semicolon
r_static
r_int
id|hid_lg3d_erase
c_func
(paren
r_struct
id|input_dev
op_star
id|input
comma
r_int
id|id
)paren
suffix:semicolon
r_static
r_void
id|hid_lg3d_timer
c_func
(paren
r_int
r_int
id|timer_data
)paren
suffix:semicolon
DECL|function|hid_lg3d_init
r_int
id|hid_lg3d_init
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
(brace
r_struct
id|lg3d_device
op_star
r_private
suffix:semicolon
multiline_comment|/* Private data */
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|lg3d_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_private
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
r_private
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|lg3d_device
)paren
)paren
suffix:semicolon
id|hid-&gt;ff_private
op_assign
r_private
suffix:semicolon
r_private
op_member_access_from_pointer
id|hid
op_assign
id|hid
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|lock
)paren
suffix:semicolon
multiline_comment|/* Timer for the periodic update task */
id|init_timer
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|timer
)paren
suffix:semicolon
r_private
op_member_access_from_pointer
id|timer.data
op_assign
(paren
r_int
r_int
)paren
r_private
suffix:semicolon
r_private
op_member_access_from_pointer
id|timer.function
op_assign
id|hid_lg3d_timer
suffix:semicolon
multiline_comment|/* Event and exit callbacks */
id|hid-&gt;ff_exit
op_assign
id|hid_lg3d_exit
suffix:semicolon
id|hid-&gt;ff_event
op_assign
id|hid_lg3d_event
suffix:semicolon
multiline_comment|/* USB init */
r_if
c_cond
(paren
op_logical_neg
(paren
r_private
op_member_access_from_pointer
id|urbffout
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|hid-&gt;ff_private
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|usb_fill_control_urb
c_func
(paren
r_private
op_member_access_from_pointer
id|urbffout
comma
id|hid-&gt;dev
comma
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
r_private
op_member_access_from_pointer
id|ffcr
comma
r_private
op_member_access_from_pointer
id|buf
comma
l_int|8
comma
id|hid_lg3d_ctrl_out
comma
id|hid
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Created ff output control urb&quot;
)paren
suffix:semicolon
multiline_comment|/* Input init */
id|hid-&gt;input.upload_effect
op_assign
id|hid_lg3d_upload_effect
suffix:semicolon
id|hid-&gt;input.flush
op_assign
id|hid_lg3d_flush
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_CONSTANT
comma
id|hid-&gt;input.ffbit
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|EV_FF
comma
id|hid-&gt;input.evbit
)paren
suffix:semicolon
id|hid-&gt;input.ff_effects_max
op_assign
id|N_EFFECTS
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Force feedback for Logitech *3D devices by Johann Deneux &lt;deneux@ifrance.com&gt;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Start the update task */
r_private
op_member_access_from_pointer
id|timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|PERIOD
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|timer
)paren
suffix:semicolon
multiline_comment|/*TODO: only run the timer when at least&n;&t;&t;&t;&t;       one effect is playing */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hid_lg3d_exit
r_static
r_void
id|hid_lg3d_exit
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
(brace
r_struct
id|lg3d_device
op_star
id|lg3d
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|DEVICE_CLOSING
comma
id|lg3d-&gt;flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|lg3d-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lg3d-&gt;urbffout
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|lg3d-&gt;urbffout
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|lg3d-&gt;urbffout
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|lg3d
)paren
suffix:semicolon
)brace
DECL|function|hid_lg3d_event
r_static
r_int
id|hid_lg3d_event
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
comma
r_struct
id|input_dev
op_star
id|input
comma
r_int
r_int
id|type
comma
r_int
r_int
id|code
comma
r_int
id|value
)paren
(brace
r_struct
id|lg3d_device
op_star
id|lg3d
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_struct
id|lg3d_effect
op_star
id|effect
op_assign
id|lg3d-&gt;effects
op_plus
id|code
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
id|EV_FF
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|CHECK_OWNERSHIP
c_func
(paren
id|code
comma
id|lg3d
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|value
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|effect-&gt;count
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|effect-&gt;effect.replay.delay
)paren
(brace
id|set_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|set_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
suffix:semicolon
)brace
id|effect-&gt;started_at
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* value == 0 */
id|clear_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Erase all effects this process owns */
DECL|function|hid_lg3d_flush
r_static
r_int
id|hid_lg3d_flush
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hid_device
op_star
id|hid
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|lg3d_device
op_star
id|lg3d
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;ff_effects_max
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/*NOTE: no need to lock here. The only times EFFECT_USED is&n;&t;&t;  modified is when effects are uploaded or when an effect is&n;&t;&t;  erased. But a process cannot close its dev/input/eventX fd&n;&t;&t;  and perform ioctls on the same fd all at the same time */
r_if
c_cond
(paren
id|current-&gt;pid
op_eq
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|owner
op_logical_and
id|test_bit
c_func
(paren
id|EFFECT_USED
comma
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|hid_lg3d_erase
c_func
(paren
id|dev
comma
id|i
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;erase effect %d failed&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hid_lg3d_erase
r_static
r_int
id|hid_lg3d_erase
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_int
id|id
)paren
(brace
r_struct
id|hid_device
op_star
id|hid
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|lg3d_device
op_star
id|lg3d
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|CHECK_OWNERSHIP
c_func
(paren
id|id
comma
id|lg3d
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|lg3d-&gt;effects
(braket
id|id
)braket
dot
id|flags
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hid_lg3d_upload_effect
r_static
r_int
id|hid_lg3d_upload_effect
c_func
(paren
r_struct
id|input_dev
op_star
id|input
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
(brace
r_struct
id|hid_device
op_star
id|hid
op_assign
id|input
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|lg3d_device
op_star
id|lg3d
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_struct
id|lg3d_effect
r_new
suffix:semicolon
r_int
id|id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ioctl upload&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|effect-&gt;type
comma
id|input-&gt;ffbit
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|effect-&gt;type
op_ne
id|FF_CONSTANT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|effect-&gt;id
op_eq
op_minus
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_EFFECTS
op_logical_and
id|test_bit
c_func
(paren
id|EFFECT_USED
comma
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
op_increment
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|N_EFFECTS
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|effect-&gt;id
op_assign
id|i
suffix:semicolon
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|owner
op_assign
id|current-&gt;pid
suffix:semicolon
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|flags
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
id|EFFECT_USED
comma
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|CHECK_OWNERSHIP
c_func
(paren
id|effect-&gt;id
comma
id|lg3d
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
id|id
op_assign
id|effect-&gt;id
suffix:semicolon
r_new
op_assign
id|lg3d-&gt;effects
(braket
id|id
)braket
suffix:semicolon
r_new
dot
id|effect
op_assign
op_star
id|effect
suffix:semicolon
r_new
dot
id|effect.replay
op_assign
id|effect-&gt;replay
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|lg3d-&gt;effects
(braket
id|id
)braket
dot
id|flags
)paren
op_logical_or
id|test_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|lg3d-&gt;effects
(braket
id|id
)braket
dot
id|flags
)paren
)paren
(brace
multiline_comment|/* Changing replay parameters is not allowed (for the time&n;&t;&t;   being) */
r_if
c_cond
(paren
r_new
dot
id|effect.replay.delay
op_ne
id|lg3d-&gt;effects
(braket
id|id
)braket
dot
id|effect.replay.delay
op_logical_or
r_new
dot
id|effect.replay.length
op_ne
id|lg3d-&gt;effects
(braket
id|id
)braket
dot
id|effect.replay.length
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|lg3d-&gt;effects
(braket
id|id
)braket
op_assign
r_new
suffix:semicolon
)brace
r_else
(brace
id|lg3d-&gt;effects
(braket
id|id
)braket
op_assign
r_new
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hid_lg3d_ctrl_out
r_static
r_void
id|hid_lg3d_ctrl_out
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|hid_device
op_star
id|hid
op_assign
id|urb-&gt;context
suffix:semicolon
r_struct
id|lg3d_device
op_star
id|lg3d
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
id|warn
c_func
(paren
l_string|&quot;hid_irq_ffout status %d received&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|DEVICE_USB_XMIT
comma
id|lg3d-&gt;flags
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;xmit = 0&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|hid_lg3d_timer
r_static
r_void
id|hid_lg3d_timer
c_func
(paren
r_int
r_int
id|timer_data
)paren
(brace
r_struct
id|lg3d_device
op_star
id|lg3d
op_assign
(paren
r_struct
id|lg3d_device
op_star
)paren
id|timer_data
suffix:semicolon
r_struct
id|hid_device
op_star
id|hid
op_assign
id|lg3d-&gt;hid
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|x
comma
id|y
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|DEVICE_USB_XMIT
comma
id|lg3d-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|lg3d-&gt;urbffout-&gt;status
op_ne
op_minus
id|EINPROGRESS
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;xmit *not* in progress&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;xmit in progress&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|lg3d-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|PERIOD
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|lg3d-&gt;timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|x
op_assign
l_int|0x7f
suffix:semicolon
id|y
op_assign
l_int|0x7f
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_EFFECTS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|lg3d_effect
op_star
id|effect
op_assign
id|lg3d-&gt;effects
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|effect-&gt;effect.type
op_eq
id|FF_CONSTANT
)paren
(brace
singleline_comment|//TODO: handle envelopes
r_int
id|degrees
op_assign
id|effect-&gt;effect.direction
op_star
l_int|360
op_rshift
l_int|16
suffix:semicolon
id|x
op_add_assign
id|fixp_mult
c_func
(paren
id|fixp_sin
c_func
(paren
id|degrees
)paren
comma
id|fixp_new16
c_func
(paren
id|effect-&gt;effect.u.constant.level
)paren
)paren
suffix:semicolon
id|y
op_add_assign
id|fixp_mult
c_func
(paren
op_minus
id|fixp_cos
c_func
(paren
id|degrees
)paren
comma
id|fixp_new16
c_func
(paren
id|effect-&gt;effect.u.constant.level
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* One run of the effect is finished playing */
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|effect-&gt;started_at
op_plus
id|effect-&gt;effect.replay.delay
op_star
id|HZ
op_div
l_int|1000
op_plus
id|effect-&gt;effect.replay.length
op_star
id|HZ
op_div
l_int|1000
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Finished playing once&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|effect-&gt;count
op_le
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Stopped&quot;
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;Start again&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|effect-&gt;effect.replay.length
op_ne
l_int|0
)paren
(brace
id|clear_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
suffix:semicolon
)brace
id|effect-&gt;started_at
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Started&quot;
)paren
suffix:semicolon
multiline_comment|/* Check if we should start playing the effect */
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|started_at
op_plus
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|effect.replay.delay
op_star
id|HZ
op_div
l_int|1000
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Now playing&quot;
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|lg3d-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|x
OL
l_int|0
)paren
id|x
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|x
OG
l_int|0xff
)paren
id|x
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|y
OL
l_int|0
)paren
id|y
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|y
OG
l_int|0xff
)paren
id|y
op_assign
l_int|0xff
suffix:semicolon
id|lg3d-&gt;urbffout-&gt;pipe
op_assign
id|usb_sndctrlpipe
c_func
(paren
id|hid-&gt;dev
comma
l_int|0
)paren
suffix:semicolon
id|lg3d-&gt;ffcr.bRequestType
op_assign
id|USB_TYPE_CLASS
op_or
id|USB_DIR_OUT
op_or
id|USB_RECIP_INTERFACE
suffix:semicolon
id|lg3d-&gt;urbffout-&gt;transfer_buffer_length
op_assign
id|lg3d-&gt;ffcr.wLength
op_assign
l_int|8
suffix:semicolon
id|lg3d-&gt;ffcr.bRequest
op_assign
l_int|9
suffix:semicolon
id|lg3d-&gt;ffcr.wValue
op_assign
l_int|0x0200
suffix:semicolon
multiline_comment|/*NOTE: Potential problem with &n;&t;&t;&t;&t;&t; little/big endian */
id|lg3d-&gt;ffcr.wIndex
op_assign
l_int|0
suffix:semicolon
id|lg3d-&gt;urbffout-&gt;dev
op_assign
id|hid-&gt;dev
suffix:semicolon
id|lg3d-&gt;buf
(braket
l_int|0
)braket
op_assign
l_int|0x51
suffix:semicolon
id|lg3d-&gt;buf
(braket
l_int|1
)braket
op_assign
l_int|0x08
suffix:semicolon
id|lg3d-&gt;buf
(braket
l_int|2
)braket
op_assign
id|x
suffix:semicolon
id|lg3d-&gt;buf
(braket
l_int|3
)braket
op_assign
id|y
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|lg3d-&gt;urbffout
comma
id|GFP_ATOMIC
)paren
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;usb_submit_urb returned %d&quot;
comma
id|err
)paren
suffix:semicolon
r_else
id|set_bit
c_func
(paren
id|DEVICE_USB_XMIT
comma
id|lg3d-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|DEVICE_CLOSING
comma
id|lg3d-&gt;flags
)paren
)paren
(brace
id|lg3d-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|PERIOD
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|lg3d-&gt;timer
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lg3d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
eof
