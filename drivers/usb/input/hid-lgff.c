multiline_comment|/*&n; * $$&n; *&n; * Force feedback support for hid-compliant for some of the devices from&n; * Logitech, namely:&n; * - WingMan Cordless RumblePad&n; *&n; *  Copyright (c) 2002 Johann Deneux&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * Should you need to contact me, the author, you can do so by&n; * e-mail - mail your message to &lt;deneux@ifrance.com&gt;&n; */
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/circ_buf.h&gt;
macro_line|#include &quot;hid.h&quot;
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(t) (jiffies + (t))
multiline_comment|/* Transmition state */
DECL|macro|XMIT_RUNNING
mdefine_line|#define XMIT_RUNNING 0
multiline_comment|/* Effect status */
DECL|macro|EFFECT_STARTED
mdefine_line|#define EFFECT_STARTED 0     /* Effect is going to play after some time&n;&t;&t;&t;&t;(ff_replay.delay) */
DECL|macro|EFFECT_PLAYING
mdefine_line|#define EFFECT_PLAYING 1     /* Effect is being played */
DECL|macro|EFFECT_USED
mdefine_line|#define EFFECT_USED    2
multiline_comment|/* Check that the current process can access an effect */
DECL|macro|CHECK_OWNERSHIP
mdefine_line|#define CHECK_OWNERSHIP(effect) (current-&gt;pid == 0 &bslash;&n;        || effect.owner == current-&gt;pid)
multiline_comment|/* **************************************************************************/
multiline_comment|/* Implements the protocol used by the Logitech WingMan Cordless RumblePad */
multiline_comment|/* **************************************************************************/
DECL|macro|LGFF_CHECK_OWNERSHIP
mdefine_line|#define LGFF_CHECK_OWNERSHIP(i, l) &bslash;&n;        (i&gt;=0 &amp;&amp; i&lt;LGFF_EFFECTS &bslash;&n;        &amp;&amp; test_bit(EFFECT_USED, l-&gt;effects[i].flags) &bslash;&n;        &amp;&amp; CHECK_OWNERSHIP(l-&gt;effects[i]))
DECL|macro|LGFF_BUFFER_SIZE
mdefine_line|#define LGFF_BUFFER_SIZE 64
DECL|macro|LGFF_EFFECTS
mdefine_line|#define LGFF_EFFECTS 8
DECL|struct|lgff_magnitudes
r_struct
id|lgff_magnitudes
(brace
DECL|member|left
r_int
r_char
id|left
suffix:semicolon
DECL|member|right
r_int
r_char
id|right
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|lgff_effect
r_struct
id|lgff_effect
(brace
DECL|member|id
r_int
id|id
suffix:semicolon
DECL|member|lgff
r_struct
id|hid_ff_logitech
op_star
id|lgff
suffix:semicolon
DECL|member|owner
id|pid_t
id|owner
suffix:semicolon
DECL|member|left
r_int
r_char
id|left
suffix:semicolon
multiline_comment|/* Magnitude of vibration for left motor */
DECL|member|right
r_int
r_char
id|right
suffix:semicolon
multiline_comment|/* Magnitude of vibration for right motor */
DECL|member|replay
r_struct
id|ff_replay
id|replay
suffix:semicolon
DECL|member|count
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* Number of times to play */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
(braket
l_int|1
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|hid_ff_logitech
r_struct
id|hid_ff_logitech
(brace
DECL|member|hid
r_struct
id|hid_device
op_star
id|hid
suffix:semicolon
DECL|member|urbffout
r_struct
id|urb
op_star
id|urbffout
suffix:semicolon
multiline_comment|/* Output URB used to send ff commands */
DECL|member|ffcr
r_struct
id|usb_ctrlrequest
id|ffcr
suffix:semicolon
multiline_comment|/* ff commands use control URBs */
DECL|member|buf
r_char
id|buf
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|xmit_lock
id|spinlock_t
id|xmit_lock
suffix:semicolon
DECL|member|xmit_head
DECL|member|xmit_tail
r_int
r_int
id|xmit_head
comma
id|xmit_tail
suffix:semicolon
DECL|member|xmit_data
r_struct
id|lgff_magnitudes
id|xmit_data
(braket
id|LGFF_BUFFER_SIZE
)braket
suffix:semicolon
DECL|member|xmit_flags
r_int
id|xmit_flags
(braket
l_int|1
)braket
suffix:semicolon
DECL|member|effects
r_struct
id|lgff_effect
id|effects
(braket
id|LGFF_EFFECTS
)braket
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* device-level lock. Having locks on&n;&t;&t;&t;&t;&t;a per-effect basis could be nice, but&n;&t;&t;&t;&t;&t;isn&squot;t really necessary */
)brace
suffix:semicolon
r_static
r_void
id|hid_lgff_ctrl_out
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|hid_lgff_exit
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
suffix:semicolon
r_static
r_int
id|hid_lgff_event
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
comma
r_struct
id|input_dev
op_star
id|input
comma
r_int
r_int
id|type
comma
r_int
r_int
id|code
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_void
id|hid_lgff_make_rumble
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
suffix:semicolon
r_static
r_int
id|hid_lgff_flush
c_func
(paren
r_struct
id|input_dev
op_star
id|input
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|hid_lgff_upload_effect
c_func
(paren
r_struct
id|input_dev
op_star
id|input
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
suffix:semicolon
r_static
r_int
id|hid_lgff_erase
c_func
(paren
r_struct
id|input_dev
op_star
id|input
comma
r_int
id|id
)paren
suffix:semicolon
r_static
r_void
id|hid_lgff_ctrl_playback
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
comma
r_struct
id|lgff_effect
op_star
comma
r_int
id|play
)paren
suffix:semicolon
r_static
r_void
id|hid_lgff_timer
c_func
(paren
r_int
r_int
id|timer_data
)paren
suffix:semicolon
DECL|function|hid_lgff_init
r_int
id|hid_lgff_init
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
(brace
r_struct
id|hid_ff_logitech
op_star
r_private
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Private data */
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hid_ff_logitech
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_private
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
r_private
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hid_ff_logitech
)paren
)paren
suffix:semicolon
id|hid-&gt;ff_private
op_assign
r_private
suffix:semicolon
r_private
op_member_access_from_pointer
id|hid
op_assign
id|hid
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|xmit_lock
)paren
suffix:semicolon
r_private
op_member_access_from_pointer
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x03
suffix:semicolon
r_private
op_member_access_from_pointer
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x42
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LGFF_EFFECTS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|lgff_effect
op_star
id|effect
op_assign
op_amp
r_private
op_member_access_from_pointer
id|effects
(braket
id|i
)braket
suffix:semicolon
r_struct
id|timer_list
op_star
id|timer
op_assign
op_amp
id|effect-&gt;timer
suffix:semicolon
id|init_timer
c_func
(paren
id|timer
)paren
suffix:semicolon
id|effect-&gt;id
op_assign
id|i
suffix:semicolon
id|effect-&gt;lgff
op_assign
r_private
suffix:semicolon
id|timer-&gt;data
op_assign
(paren
r_int
r_int
)paren
id|effect
suffix:semicolon
id|timer-&gt;function
op_assign
id|hid_lgff_timer
suffix:semicolon
)brace
multiline_comment|/* Event and exit callbacks */
id|hid-&gt;ff_exit
op_assign
id|hid_lgff_exit
suffix:semicolon
id|hid-&gt;ff_event
op_assign
id|hid_lgff_event
suffix:semicolon
multiline_comment|/* USB init */
r_if
c_cond
(paren
op_logical_neg
(paren
r_private
op_member_access_from_pointer
id|urbffout
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|hid-&gt;ff_private
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|usb_fill_control_urb
c_func
(paren
r_private
op_member_access_from_pointer
id|urbffout
comma
id|hid-&gt;dev
comma
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
r_private
op_member_access_from_pointer
id|ffcr
comma
r_private
op_member_access_from_pointer
id|buf
comma
l_int|8
comma
id|hid_lgff_ctrl_out
comma
id|hid
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Created ff output control urb&quot;
)paren
suffix:semicolon
multiline_comment|/* Input init */
id|hid-&gt;input.upload_effect
op_assign
id|hid_lgff_upload_effect
suffix:semicolon
id|hid-&gt;input.flush
op_assign
id|hid_lgff_flush
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_RUMBLE
comma
id|hid-&gt;input.ffbit
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|EV_FF
comma
id|hid-&gt;input.evbit
)paren
suffix:semicolon
id|hid-&gt;input.ff_effects_max
op_assign
id|LGFF_EFFECTS
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Force feedback for Logitech rumble devices by Johann Deneux &lt;deneux@ifrance.com&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hid_lgff_exit
r_static
r_void
id|hid_lgff_exit
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
(brace
r_struct
id|hid_ff_logitech
op_star
id|lgff
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_if
c_cond
(paren
id|lgff-&gt;urbffout
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|lgff-&gt;urbffout
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|lgff-&gt;urbffout
)paren
suffix:semicolon
)brace
)brace
DECL|function|hid_lgff_event
r_static
r_int
id|hid_lgff_event
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
comma
r_struct
id|input_dev
op_star
id|input
comma
r_int
r_int
id|type
comma
r_int
r_int
id|code
comma
r_int
id|value
)paren
(brace
r_struct
id|hid_ff_logitech
op_star
id|lgff
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_struct
id|lgff_effect
op_star
id|effect
op_assign
id|lgff-&gt;effects
op_plus
id|code
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
id|EV_FF
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|LGFF_CHECK_OWNERSHIP
c_func
(paren
id|code
comma
id|lgff
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|value
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|effect-&gt;count
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|effect-&gt;replay.delay
)paren
(brace
id|set_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|effect-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|effect-&gt;replay.delay
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|hid_lgff_ctrl_playback
c_func
(paren
id|hid
comma
id|effect
comma
id|value
)paren
suffix:semicolon
id|effect-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|effect-&gt;replay.length
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
)brace
id|add_timer
c_func
(paren
op_amp
id|effect-&gt;timer
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* value == 0 */
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|effect-&gt;timer
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|effect-&gt;timer
)paren
suffix:semicolon
id|hid_lgff_ctrl_playback
c_func
(paren
id|hid
comma
id|effect
comma
id|value
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;Effect %d still playing&quot;
comma
id|code
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Erase all effects this process owns */
DECL|function|hid_lgff_flush
r_static
r_int
id|hid_lgff_flush
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hid_device
op_star
id|hid
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|hid_ff_logitech
op_star
id|lgff
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;ff_effects_max
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/*NOTE: no need to lock here. The only times EFFECT_USED is&n;&t;&t;  modified is when effects are uploaded or when an effect is&n;&t;&t;  erased. But a process cannot close its dev/input/eventX fd&n;&t;&t;  and perform ioctls on the same fd all at the same time */
r_if
c_cond
(paren
id|current-&gt;pid
op_eq
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|owner
op_logical_and
id|test_bit
c_func
(paren
id|EFFECT_USED
comma
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|hid_lgff_erase
c_func
(paren
id|dev
comma
id|i
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;erase effect %d failed&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hid_lgff_erase
r_static
r_int
id|hid_lgff_erase
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_int
id|id
)paren
(brace
r_struct
id|hid_device
op_star
id|hid
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|hid_ff_logitech
op_star
id|lgff
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|LGFF_CHECK_OWNERSHIP
c_func
(paren
id|id
comma
id|lgff
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hid_lgff_ctrl_playback
c_func
(paren
id|hid
comma
id|lgff-&gt;effects
op_plus
id|id
comma
l_int|0
)paren
suffix:semicolon
id|lgff-&gt;effects
(braket
id|id
)braket
dot
id|flags
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hid_lgff_upload_effect
r_static
r_int
id|hid_lgff_upload_effect
c_func
(paren
r_struct
id|input_dev
op_star
id|input
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
(brace
r_struct
id|hid_device
op_star
id|hid
op_assign
id|input
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|hid_ff_logitech
op_star
id|lgff
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_struct
id|lgff_effect
r_new
suffix:semicolon
r_int
id|id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ioctl rumble&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|effect-&gt;type
comma
id|input-&gt;ffbit
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|effect-&gt;type
op_ne
id|FF_RUMBLE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|effect-&gt;id
op_eq
op_minus
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LGFF_EFFECTS
op_logical_and
id|test_bit
c_func
(paren
id|EFFECT_USED
comma
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
op_increment
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|LGFF_EFFECTS
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|effect-&gt;id
op_assign
id|i
suffix:semicolon
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|owner
op_assign
id|current-&gt;pid
suffix:semicolon
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|flags
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
id|EFFECT_USED
comma
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|LGFF_CHECK_OWNERSHIP
c_func
(paren
id|effect-&gt;id
comma
id|lgff
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
id|id
op_assign
id|effect-&gt;id
suffix:semicolon
r_new
op_assign
id|lgff-&gt;effects
(braket
id|id
)braket
suffix:semicolon
r_new
dot
id|right
op_assign
id|effect-&gt;u.rumble.strong_magnitude
op_rshift
l_int|9
suffix:semicolon
r_new
dot
id|left
op_assign
id|effect-&gt;u.rumble.weak_magnitude
op_rshift
l_int|9
suffix:semicolon
r_new
dot
id|replay
op_assign
id|effect-&gt;replay
suffix:semicolon
multiline_comment|/* If we updated an effect that was being played, we need to remake&n;&t;   the rumble effect */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|lgff-&gt;effects
(braket
id|id
)braket
dot
id|flags
)paren
op_logical_or
id|test_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|lgff-&gt;effects
(braket
id|id
)braket
dot
id|flags
)paren
)paren
(brace
multiline_comment|/* Changing replay parameters is not allowed (for the time&n;&t;&t;   being) */
r_if
c_cond
(paren
r_new
dot
id|replay.delay
op_ne
id|lgff-&gt;effects
(braket
id|id
)braket
dot
id|replay.delay
op_logical_or
r_new
dot
id|replay.length
op_ne
id|lgff-&gt;effects
(braket
id|id
)braket
dot
id|replay.length
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|lgff-&gt;effects
(braket
id|id
)braket
op_assign
r_new
suffix:semicolon
id|hid_lgff_make_rumble
c_func
(paren
id|hid
)paren
suffix:semicolon
)brace
r_else
(brace
id|lgff-&gt;effects
(braket
id|id
)braket
op_assign
r_new
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hid_lgff_xmit
r_static
r_void
id|hid_lgff_xmit
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
(brace
r_struct
id|hid_ff_logitech
op_star
id|lgff
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|tail
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lgff-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|tail
op_assign
id|lgff-&gt;xmit_tail
suffix:semicolon
r_if
c_cond
(paren
id|lgff-&gt;xmit_head
op_eq
id|tail
)paren
(brace
id|clear_bit
c_func
(paren
id|XMIT_RUNNING
comma
id|lgff-&gt;xmit_flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lgff-&gt;buf
(braket
l_int|3
)braket
op_assign
id|lgff-&gt;xmit_data
(braket
id|tail
)braket
dot
id|left
suffix:semicolon
id|lgff-&gt;buf
(braket
l_int|4
)braket
op_assign
id|lgff-&gt;xmit_data
(braket
id|tail
)braket
dot
id|right
suffix:semicolon
id|tail
op_increment
suffix:semicolon
id|tail
op_and_assign
id|LGFF_BUFFER_SIZE
op_minus
l_int|1
suffix:semicolon
id|lgff-&gt;xmit_tail
op_assign
id|tail
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|lgff-&gt;urbffout-&gt;pipe
op_assign
id|usb_sndctrlpipe
c_func
(paren
id|hid-&gt;dev
comma
l_int|0
)paren
suffix:semicolon
id|lgff-&gt;ffcr.bRequestType
op_assign
id|USB_TYPE_CLASS
op_or
id|USB_DIR_OUT
op_or
id|USB_RECIP_INTERFACE
suffix:semicolon
id|lgff-&gt;urbffout-&gt;transfer_buffer_length
op_assign
id|lgff-&gt;ffcr.wLength
op_assign
l_int|8
suffix:semicolon
id|lgff-&gt;ffcr.bRequest
op_assign
l_int|9
suffix:semicolon
id|lgff-&gt;ffcr.wValue
op_assign
l_int|0x0203
suffix:semicolon
multiline_comment|/*NOTE: Potential problem with &n;&t;&t;&t;&t;&t; little/big endian */
id|lgff-&gt;ffcr.wIndex
op_assign
l_int|0
suffix:semicolon
id|lgff-&gt;urbffout-&gt;dev
op_assign
id|hid-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|lgff-&gt;urbffout
comma
id|GFP_ATOMIC
)paren
)paren
)paren
id|warn
c_func
(paren
l_string|&quot;usb_submit_urb returned %d&quot;
comma
id|err
)paren
suffix:semicolon
)brace
DECL|function|hid_lgff_make_rumble
r_static
r_void
id|hid_lgff_make_rumble
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
)paren
(brace
r_struct
id|hid_ff_logitech
op_star
id|lgff
op_assign
id|hid-&gt;ff_private
suffix:semicolon
r_int
id|left
op_assign
l_int|0
comma
id|right
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|head
comma
id|tail
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LGFF_EFFECTS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_USED
comma
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
op_logical_and
id|test_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|flags
)paren
)paren
(brace
id|left
op_add_assign
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|left
suffix:semicolon
id|right
op_add_assign
id|lgff-&gt;effects
(braket
id|i
)braket
dot
id|right
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lgff-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|head
op_assign
id|lgff-&gt;xmit_head
suffix:semicolon
id|tail
op_assign
id|lgff-&gt;xmit_tail
suffix:semicolon
r_if
c_cond
(paren
id|CIRC_SPACE
c_func
(paren
id|head
comma
id|tail
comma
id|LGFF_BUFFER_SIZE
)paren
OL
l_int|1
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;not enough space in xmit buffer to send new packet&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|lgff-&gt;xmit_data
(braket
id|head
)braket
dot
id|left
op_assign
id|left
OG
l_int|0x7f
ques
c_cond
l_int|0x7f
suffix:colon
id|left
suffix:semicolon
id|lgff-&gt;xmit_data
(braket
id|head
)braket
dot
id|right
op_assign
id|right
OG
l_int|0x7f
ques
c_cond
l_int|0x7f
suffix:colon
id|right
suffix:semicolon
id|head
op_increment
suffix:semicolon
id|head
op_and_assign
id|LGFF_BUFFER_SIZE
op_minus
l_int|1
suffix:semicolon
id|lgff-&gt;xmit_head
op_assign
id|head
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|XMIT_RUNNING
comma
id|lgff-&gt;xmit_flags
)paren
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|hid_lgff_xmit
c_func
(paren
id|hid
)paren
suffix:semicolon
)brace
)brace
DECL|function|hid_lgff_ctrl_out
r_static
r_void
id|hid_lgff_ctrl_out
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|hid_device
op_star
id|hid
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
id|warn
c_func
(paren
l_string|&quot;hid_irq_ffout status %d received&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|hid_lgff_xmit
c_func
(paren
id|hid
)paren
suffix:semicolon
)brace
multiline_comment|/* Lock must be held by caller */
DECL|function|hid_lgff_ctrl_playback
r_static
r_void
id|hid_lgff_ctrl_playback
c_func
(paren
r_struct
id|hid_device
op_star
id|hid
comma
r_struct
id|lgff_effect
op_star
id|effect
comma
r_int
id|play
)paren
(brace
r_if
c_cond
(paren
id|play
)paren
(brace
id|set_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|hid_lgff_make_rumble
c_func
(paren
id|hid
)paren
suffix:semicolon
)brace
r_else
(brace
id|clear_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|hid_lgff_make_rumble
c_func
(paren
id|hid
)paren
suffix:semicolon
)brace
)brace
DECL|function|hid_lgff_timer
r_static
r_void
id|hid_lgff_timer
c_func
(paren
r_int
r_int
id|timer_data
)paren
(brace
r_struct
id|lgff_effect
op_star
id|effect
op_assign
(paren
r_struct
id|lgff_effect
op_star
)paren
id|timer_data
suffix:semicolon
r_struct
id|hid_ff_logitech
op_star
id|lgff
op_assign
id|effect-&gt;lgff
suffix:semicolon
r_int
id|id
op_assign
id|effect-&gt;id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;in hid_lgff_timer&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
OL
l_int|0
op_logical_or
id|id
op_ge
id|LGFF_EFFECTS
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Bad effect id %d&quot;
comma
id|id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|effect
op_assign
id|lgff-&gt;effects
op_plus
id|id
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|EFFECT_USED
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Unused effect id %d&quot;
comma
id|id
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|hid_lgff_ctrl_playback
c_func
(paren
id|lgff-&gt;hid
comma
id|effect
comma
l_int|1
)paren
suffix:semicolon
id|effect-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|effect-&gt;replay.length
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|effect-&gt;timer
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Effect %d starts playing&quot;
comma
id|id
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|EFFECT_PLAYING
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|hid_lgff_ctrl_playback
c_func
(paren
id|lgff-&gt;hid
comma
id|effect
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|effect-&gt;count
OG
l_int|0
)paren
(brace
multiline_comment|/*TODO: check that replay.delay is non-null */
id|set_bit
c_func
(paren
id|EFFECT_STARTED
comma
id|effect-&gt;flags
)paren
suffix:semicolon
id|effect-&gt;timer.expires
op_assign
id|RUN_AT
c_func
(paren
id|effect-&gt;replay.delay
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|effect-&gt;timer
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Effect %d restarted&quot;
comma
id|id
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;Effect %d stopped&quot;
comma
id|id
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|warn
c_func
(paren
l_string|&quot;Effect %d is not started nor playing&quot;
comma
id|id
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lgff-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
eof
