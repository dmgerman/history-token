macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_USB_DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#endif
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
DECL|macro|USB_MAXALTSETTING
mdefine_line|#define USB_MAXALTSETTING&t;&t;128&t;/* Hard limit */
DECL|macro|USB_MAXENDPOINTS
mdefine_line|#define USB_MAXENDPOINTS&t;&t;30&t;/* Hard limit */
DECL|macro|USB_MAXCONFIG
mdefine_line|#define USB_MAXCONFIG&t;&t;&t;8&t;/* Arbitrary limit */
DECL|function|find_next_descriptor
r_static
r_int
id|find_next_descriptor
c_func
(paren
r_int
r_char
op_star
id|buffer
comma
r_int
id|size
comma
r_int
id|dt1
comma
r_int
id|dt2
comma
r_int
op_star
id|num_skipped
)paren
(brace
r_struct
id|usb_descriptor_header
op_star
id|h
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|buffer0
op_assign
id|buffer
suffix:semicolon
multiline_comment|/* Find the next descriptor of type dt1 or dt2 */
r_while
c_loop
(paren
id|size
op_ge
r_sizeof
(paren
r_struct
id|usb_descriptor_header
)paren
)paren
(brace
id|h
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;bDescriptorType
op_eq
id|dt1
op_logical_or
id|h-&gt;bDescriptorType
op_eq
id|dt2
)paren
r_break
suffix:semicolon
id|buffer
op_add_assign
id|h-&gt;bLength
suffix:semicolon
id|size
op_sub_assign
id|h-&gt;bLength
suffix:semicolon
op_increment
id|n
suffix:semicolon
)brace
multiline_comment|/* Store the number of descriptors skipped and return the&n;&t; * number of bytes skipped */
r_if
c_cond
(paren
id|num_skipped
)paren
op_star
id|num_skipped
op_assign
id|n
suffix:semicolon
r_return
id|buffer
op_minus
id|buffer0
suffix:semicolon
)brace
DECL|function|usb_parse_endpoint
r_static
r_int
id|usb_parse_endpoint
c_func
(paren
r_struct
id|device
op_star
id|ddev
comma
r_int
id|cfgno
comma
r_int
id|inum
comma
r_int
id|asnum
comma
r_struct
id|usb_host_endpoint
op_star
id|endpoint
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
r_int
r_char
op_star
id|buffer0
op_assign
id|buffer
suffix:semicolon
r_struct
id|usb_descriptor_header
op_star
id|header
suffix:semicolon
r_int
id|n
comma
id|i
suffix:semicolon
id|header
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;bDescriptorType
op_ne
id|USB_DT_ENDPOINT
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d interface %d altsetting %d has an &quot;
l_string|&quot;unexpected descriptor of type 0x%X, &quot;
l_string|&quot;expecting endpoint type 0x%X&bslash;n&quot;
comma
id|cfgno
comma
id|inum
comma
id|asnum
comma
id|header-&gt;bDescriptorType
comma
id|USB_DT_ENDPOINT
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|header-&gt;bLength
op_ge
id|USB_DT_ENDPOINT_AUDIO_SIZE
)paren
id|memcpy
c_func
(paren
op_amp
id|endpoint-&gt;desc
comma
id|buffer
comma
id|USB_DT_ENDPOINT_AUDIO_SIZE
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|header-&gt;bLength
op_ge
id|USB_DT_ENDPOINT_SIZE
)paren
id|memcpy
c_func
(paren
op_amp
id|endpoint-&gt;desc
comma
id|buffer
comma
id|USB_DT_ENDPOINT_SIZE
)paren
suffix:semicolon
r_else
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d interface %d altsetting %d has an &quot;
l_string|&quot;invalid endpoint descriptor of length %d&bslash;n&quot;
comma
id|cfgno
comma
id|inum
comma
id|asnum
comma
id|header-&gt;bLength
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|i
op_assign
id|endpoint-&gt;desc.bEndpointAddress
op_amp
op_complement
id|USB_ENDPOINT_DIR_MASK
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|16
op_logical_or
id|i
op_eq
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d interface %d altsetting %d has an &quot;
l_string|&quot;invalid endpoint with address 0x%X&bslash;n&quot;
comma
id|cfgno
comma
id|inum
comma
id|asnum
comma
id|endpoint-&gt;desc.bEndpointAddress
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|le16_to_cpus
c_func
(paren
op_amp
id|endpoint-&gt;desc.wMaxPacketSize
)paren
suffix:semicolon
id|buffer
op_add_assign
id|header-&gt;bLength
suffix:semicolon
id|size
op_sub_assign
id|header-&gt;bLength
suffix:semicolon
multiline_comment|/* Skip over any Class Specific or Vendor Specific descriptors;&n;&t; * find the next endpoint or interface descriptor */
id|endpoint-&gt;extra
op_assign
id|buffer
suffix:semicolon
id|i
op_assign
id|find_next_descriptor
c_func
(paren
id|buffer
comma
id|size
comma
id|USB_DT_ENDPOINT
comma
id|USB_DT_INTERFACE
comma
op_amp
id|n
)paren
suffix:semicolon
id|endpoint-&gt;extralen
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|0
)paren
id|dev_dbg
c_func
(paren
id|ddev
comma
l_string|&quot;skipped %d class/vendor specific endpoint &quot;
l_string|&quot;descriptors&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
r_return
id|buffer
op_minus
id|buffer0
op_plus
id|i
suffix:semicolon
)brace
DECL|function|usb_free_intf
r_static
r_void
id|usb_free_intf
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
(brace
r_int
id|j
suffix:semicolon
r_if
c_cond
(paren
id|intf-&gt;altsetting
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|intf-&gt;num_altsetting
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|usb_host_interface
op_star
id|alt
op_assign
op_amp
id|intf-&gt;altsetting
(braket
id|j
)braket
suffix:semicolon
id|kfree
c_func
(paren
id|alt-&gt;endpoint
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|intf-&gt;altsetting
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|intf
)paren
suffix:semicolon
)brace
DECL|function|usb_parse_interface
r_static
r_int
id|usb_parse_interface
c_func
(paren
r_struct
id|device
op_star
id|ddev
comma
r_int
id|cfgno
comma
r_struct
id|usb_host_config
op_star
id|config
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
r_int
r_char
op_star
id|buffer0
op_assign
id|buffer
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|d
suffix:semicolon
r_int
id|inum
comma
id|asnum
suffix:semicolon
r_struct
id|usb_interface
op_star
id|interface
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|alt
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
r_int
id|len
comma
id|retval
suffix:semicolon
id|d
op_assign
(paren
r_struct
id|usb_interface_descriptor
op_star
)paren
id|buffer
suffix:semicolon
id|buffer
op_add_assign
id|d-&gt;bLength
suffix:semicolon
id|size
op_sub_assign
id|d-&gt;bLength
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;bDescriptorType
op_ne
id|USB_DT_INTERFACE
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d has an unexpected descriptor of type &quot;
l_string|&quot;0x%X, expecting interface type 0x%X&bslash;n&quot;
comma
id|cfgno
comma
id|d-&gt;bDescriptorType
comma
id|USB_DT_INTERFACE
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|inum
op_assign
id|d-&gt;bInterfaceNumber
suffix:semicolon
r_if
c_cond
(paren
id|inum
op_ge
id|config-&gt;desc.bNumInterfaces
)paren
r_goto
id|skip_to_next_interface_descriptor
suffix:semicolon
id|interface
op_assign
id|config-&gt;interface
(braket
id|inum
)braket
suffix:semicolon
id|asnum
op_assign
id|d-&gt;bAlternateSetting
suffix:semicolon
r_if
c_cond
(paren
id|asnum
op_ge
id|interface-&gt;num_altsetting
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d interface %d has an invalid &quot;
l_string|&quot;alternate setting number: %d but max is %d&bslash;n&quot;
comma
id|cfgno
comma
id|inum
comma
id|asnum
comma
id|interface-&gt;num_altsetting
op_minus
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|alt
op_assign
op_amp
id|interface-&gt;altsetting
(braket
id|asnum
)braket
suffix:semicolon
r_if
c_cond
(paren
id|alt-&gt;desc.bLength
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;Duplicate descriptor for config %d &quot;
l_string|&quot;interface %d altsetting %d&bslash;n&quot;
comma
id|cfgno
comma
id|inum
comma
id|asnum
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|alt-&gt;desc
comma
id|d
comma
id|USB_DT_INTERFACE_SIZE
)paren
suffix:semicolon
multiline_comment|/* Skip over any Class Specific or Vendor Specific descriptors;&n;&t; * find the first endpoint or interface descriptor */
id|alt-&gt;extra
op_assign
id|buffer
suffix:semicolon
id|i
op_assign
id|find_next_descriptor
c_func
(paren
id|buffer
comma
id|size
comma
id|USB_DT_ENDPOINT
comma
id|USB_DT_INTERFACE
comma
op_amp
id|n
)paren
suffix:semicolon
id|alt-&gt;extralen
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|0
)paren
id|dev_dbg
c_func
(paren
id|ddev
comma
l_string|&quot;skipped %d class/vendor specific &quot;
l_string|&quot;interface descriptors&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
id|buffer
op_add_assign
id|i
suffix:semicolon
id|size
op_sub_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|alt-&gt;desc.bNumEndpoints
OG
id|USB_MAXENDPOINTS
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;too many endpoints for config %d interface %d &quot;
l_string|&quot;altsetting %d: %d, maximum allowed: %d&bslash;n&quot;
comma
id|cfgno
comma
id|inum
comma
id|asnum
comma
id|alt-&gt;desc.bNumEndpoints
comma
id|USB_MAXENDPOINTS
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|len
op_assign
id|alt-&gt;desc.bNumEndpoints
op_star
r_sizeof
(paren
r_struct
id|usb_host_endpoint
)paren
suffix:semicolon
id|alt-&gt;endpoint
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|alt-&gt;endpoint
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|alt-&gt;endpoint
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|alt-&gt;desc.bNumEndpoints
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|size
OL
id|USB_DT_ENDPOINT_SIZE
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;too few endpoint descriptors for &quot;
l_string|&quot;config %d interface %d altsetting %d&bslash;n&quot;
comma
id|cfgno
comma
id|inum
comma
id|asnum
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|retval
op_assign
id|usb_parse_endpoint
c_func
(paren
id|ddev
comma
id|cfgno
comma
id|inum
comma
id|asnum
comma
id|alt-&gt;endpoint
op_plus
id|i
comma
id|buffer
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
id|buffer
op_add_assign
id|retval
suffix:semicolon
id|size
op_sub_assign
id|retval
suffix:semicolon
)brace
r_return
id|buffer
op_minus
id|buffer0
suffix:semicolon
id|skip_to_next_interface_descriptor
suffix:colon
id|i
op_assign
id|find_next_descriptor
c_func
(paren
id|buffer
comma
id|size
comma
id|USB_DT_INTERFACE
comma
id|USB_DT_INTERFACE
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|buffer
op_minus
id|buffer0
op_plus
id|i
suffix:semicolon
)brace
DECL|function|usb_parse_configuration
r_int
id|usb_parse_configuration
c_func
(paren
r_struct
id|device
op_star
id|ddev
comma
r_int
id|cfgidx
comma
r_struct
id|usb_host_config
op_star
id|config
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
r_int
id|cfgno
suffix:semicolon
r_int
id|nintf
comma
id|nintf_orig
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|n
suffix:semicolon
r_struct
id|usb_interface
op_star
id|interface
suffix:semicolon
r_int
r_char
op_star
id|buffer2
suffix:semicolon
r_int
id|size2
suffix:semicolon
r_struct
id|usb_descriptor_header
op_star
id|header
suffix:semicolon
r_int
id|len
comma
id|retval
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|config-&gt;desc
comma
id|buffer
comma
id|USB_DT_CONFIG_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|config-&gt;desc.bDescriptorType
op_ne
id|USB_DT_CONFIG
op_logical_or
id|config-&gt;desc.bLength
OL
id|USB_DT_CONFIG_SIZE
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;invalid descriptor for config index %d: &quot;
l_string|&quot;type = 0x%X, length = %d&bslash;n&quot;
comma
id|cfgidx
comma
id|config-&gt;desc.bDescriptorType
comma
id|config-&gt;desc.bLength
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|config-&gt;desc.wTotalLength
op_assign
id|size
suffix:semicolon
id|cfgno
op_assign
id|config-&gt;desc.bConfigurationValue
suffix:semicolon
id|buffer
op_add_assign
id|config-&gt;desc.bLength
suffix:semicolon
id|size
op_sub_assign
id|config-&gt;desc.bLength
suffix:semicolon
id|nintf
op_assign
id|nintf_orig
op_assign
id|config-&gt;desc.bNumInterfaces
suffix:semicolon
r_if
c_cond
(paren
id|nintf
OG
id|USB_MAXINTERFACES
)paren
(brace
id|dev_warn
c_func
(paren
id|ddev
comma
l_string|&quot;config %d has too many interfaces: %d, &quot;
l_string|&quot;using maximum allowed: %d&bslash;n&quot;
comma
id|cfgno
comma
id|nintf
comma
id|USB_MAXINTERFACES
)paren
suffix:semicolon
id|config-&gt;desc.bNumInterfaces
op_assign
id|nintf
op_assign
id|USB_MAXINTERFACES
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nintf
suffix:semicolon
op_increment
id|i
)paren
(brace
id|interface
op_assign
id|config-&gt;interface
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|usb_interface
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|interface
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|interface
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|usb_interface
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Go through the descriptors, checking their length and counting the&n;&t; * number of altsettings for each interface */
r_for
c_loop
(paren
(paren
id|buffer2
op_assign
id|buffer
comma
id|size2
op_assign
id|size
)paren
suffix:semicolon
id|size2
op_ge
r_sizeof
(paren
r_struct
id|usb_descriptor_header
)paren
suffix:semicolon
(paren
id|buffer2
op_add_assign
id|header-&gt;bLength
comma
id|size2
op_sub_assign
id|header-&gt;bLength
)paren
)paren
(brace
id|header
op_assign
(paren
r_struct
id|usb_descriptor_header
op_star
)paren
id|buffer2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|header-&gt;bLength
OG
id|size2
)paren
op_logical_or
(paren
id|header-&gt;bLength
OL
l_int|2
)paren
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d has an invalid descriptor &quot;
l_string|&quot;of length %d&bslash;n&quot;
comma
id|cfgno
comma
id|header-&gt;bLength
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|header-&gt;bDescriptorType
op_eq
id|USB_DT_INTERFACE
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|d
suffix:semicolon
id|d
op_assign
(paren
r_struct
id|usb_interface_descriptor
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;bLength
OL
id|USB_DT_INTERFACE_SIZE
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d has an invalid &quot;
l_string|&quot;interface descriptor of length %d&bslash;n&quot;
comma
id|cfgno
comma
id|d-&gt;bLength
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|i
op_assign
id|d-&gt;bInterfaceNumber
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|nintf_orig
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d has an invalid &quot;
l_string|&quot;interface number: %d but max is %d&bslash;n&quot;
comma
id|cfgno
comma
id|i
comma
id|nintf_orig
op_minus
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|nintf
)paren
op_increment
id|config-&gt;interface
(braket
id|i
)braket
op_member_access_from_pointer
id|num_altsetting
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|header-&gt;bDescriptorType
op_eq
id|USB_DT_DEVICE
op_logical_or
id|header-&gt;bDescriptorType
op_eq
id|USB_DT_CONFIG
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d contains an unexpected &quot;
l_string|&quot;descriptor of type 0x%X&bslash;n&quot;
comma
id|cfgno
comma
id|header-&gt;bDescriptorType
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* for ((buffer2 = buffer, size2 = size); ...) */
multiline_comment|/* Allocate the altsetting arrays */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nintf
suffix:semicolon
op_increment
id|i
)paren
(brace
id|interface
op_assign
id|config-&gt;interface
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;num_altsetting
OG
id|USB_MAXALTSETTING
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;too many alternate settings for &quot;
l_string|&quot;config %d interface %d: %d, &quot;
l_string|&quot;maximum allowed: %d&bslash;n&quot;
comma
id|cfgno
comma
id|i
comma
id|interface-&gt;num_altsetting
comma
id|USB_MAXALTSETTING
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|interface-&gt;num_altsetting
op_eq
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d has no interface number &quot;
l_string|&quot;%d&bslash;n&quot;
comma
id|cfgno
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|len
op_assign
r_sizeof
(paren
op_star
id|interface-&gt;altsetting
)paren
op_star
id|interface-&gt;num_altsetting
suffix:semicolon
id|interface-&gt;altsetting
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|interface-&gt;altsetting
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|interface-&gt;altsetting
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* Skip over any Class Specific or Vendor Specific descriptors;&n;&t; * find the first interface descriptor */
id|config-&gt;extra
op_assign
id|buffer
suffix:semicolon
id|i
op_assign
id|find_next_descriptor
c_func
(paren
id|buffer
comma
id|size
comma
id|USB_DT_INTERFACE
comma
id|USB_DT_INTERFACE
comma
op_amp
id|n
)paren
suffix:semicolon
id|config-&gt;extralen
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|0
)paren
id|dev_dbg
c_func
(paren
id|ddev
comma
l_string|&quot;skipped %d class/vendor specific &quot;
l_string|&quot;configuration descriptors&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
id|buffer
op_add_assign
id|i
suffix:semicolon
id|size
op_sub_assign
id|i
suffix:semicolon
multiline_comment|/* Parse all the interface/altsetting descriptors */
r_while
c_loop
(paren
id|size
op_ge
r_sizeof
(paren
r_struct
id|usb_descriptor_header
)paren
)paren
(brace
id|retval
op_assign
id|usb_parse_interface
c_func
(paren
id|ddev
comma
id|cfgno
comma
id|config
comma
id|buffer
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
id|buffer
op_add_assign
id|retval
suffix:semicolon
id|size
op_sub_assign
id|retval
suffix:semicolon
)brace
multiline_comment|/* Check for missing altsettings */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nintf
suffix:semicolon
op_increment
id|i
)paren
(brace
id|interface
op_assign
id|config-&gt;interface
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|interface-&gt;num_altsetting
suffix:semicolon
op_increment
id|j
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|interface-&gt;altsetting
(braket
id|j
)braket
dot
id|desc.bLength
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config %d interface %d has no &quot;
l_string|&quot;altsetting %d&bslash;n&quot;
comma
id|cfgno
comma
id|i
comma
id|j
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
r_return
id|size
suffix:semicolon
)brace
singleline_comment|// hub-only!! ... and only exported for reset/reinit path.
singleline_comment|// otherwise used internally on disconnect/destroy path
DECL|function|usb_destroy_configuration
r_void
id|usb_destroy_configuration
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_int
id|c
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;config
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rawdescriptors
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|i
op_increment
)paren
id|kfree
c_func
(paren
id|dev-&gt;rawdescriptors
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;rawdescriptors
)paren
suffix:semicolon
id|dev-&gt;rawdescriptors
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|c
op_increment
)paren
(brace
r_struct
id|usb_host_config
op_star
id|cf
op_assign
op_amp
id|dev-&gt;config
(braket
id|c
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cf-&gt;desc.bNumInterfaces
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|usb_interface
op_star
id|ifp
op_assign
id|cf-&gt;interface
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ifp
)paren
id|usb_free_intf
c_func
(paren
id|ifp
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|dev-&gt;config
)paren
suffix:semicolon
id|dev-&gt;config
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|// hub-only!! ... and only in reset path, or usb_new_device()
singleline_comment|// (used by real hubs and virtual root hubs)
DECL|function|usb_get_configuration
r_int
id|usb_get_configuration
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|device
op_star
id|ddev
op_assign
op_amp
id|dev-&gt;dev
suffix:semicolon
r_int
id|ncfg
op_assign
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
r_int
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_int
r_int
id|cfgno
comma
id|length
suffix:semicolon
r_int
r_char
op_star
id|buffer
suffix:semicolon
r_int
r_char
op_star
id|bigbuffer
suffix:semicolon
r_struct
id|usb_config_descriptor
op_star
id|desc
suffix:semicolon
r_if
c_cond
(paren
id|ncfg
OG
id|USB_MAXCONFIG
)paren
(brace
id|dev_warn
c_func
(paren
id|ddev
comma
l_string|&quot;too many configurations: %d, &quot;
l_string|&quot;using maximum allowed: %d&bslash;n&quot;
comma
id|ncfg
comma
id|USB_MAXCONFIG
)paren
suffix:semicolon
id|dev-&gt;descriptor.bNumConfigurations
op_assign
id|ncfg
op_assign
id|USB_MAXCONFIG
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ncfg
OL
l_int|1
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;no configurations&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|length
op_assign
id|ncfg
op_star
r_sizeof
(paren
r_struct
id|usb_host_config
)paren
suffix:semicolon
id|dev-&gt;config
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;config
)paren
r_goto
id|err2
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;config
comma
l_int|0
comma
id|length
)paren
suffix:semicolon
id|length
op_assign
id|ncfg
op_star
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
id|dev-&gt;rawdescriptors
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;rawdescriptors
)paren
r_goto
id|err2
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;rawdescriptors
comma
l_int|0
comma
id|length
)paren
suffix:semicolon
id|buffer
op_assign
id|kmalloc
c_func
(paren
l_int|8
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_goto
id|err2
suffix:semicolon
id|desc
op_assign
(paren
r_struct
id|usb_config_descriptor
op_star
)paren
id|buffer
suffix:semicolon
r_for
c_loop
(paren
id|cfgno
op_assign
l_int|0
suffix:semicolon
id|cfgno
OL
id|ncfg
suffix:semicolon
id|cfgno
op_increment
)paren
(brace
multiline_comment|/* We grab the first 8 bytes so we know how long the whole */
multiline_comment|/* configuration is */
id|result
op_assign
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_CONFIG
comma
id|cfgno
comma
id|buffer
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;unable to read config index %d &quot;
l_string|&quot;descriptor&bslash;n&quot;
comma
id|cfgno
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
OL
l_int|8
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config index %d descriptor too short &quot;
l_string|&quot;(expected %i, got %i)&bslash;n&quot;
comma
id|cfgno
comma
l_int|8
comma
id|result
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|length
op_assign
id|max
c_func
(paren
(paren
r_int
)paren
id|le16_to_cpu
c_func
(paren
id|desc-&gt;wTotalLength
)paren
comma
id|USB_DT_CONFIG_SIZE
)paren
suffix:semicolon
multiline_comment|/* Now that we know the length, get the whole thing */
id|bigbuffer
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bigbuffer
)paren
(brace
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|result
op_assign
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_CONFIG
comma
id|cfgno
comma
id|bigbuffer
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;unable to read config index %d &quot;
l_string|&quot;descriptor&bslash;n&quot;
comma
id|cfgno
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bigbuffer
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OL
id|length
)paren
(brace
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;config index %d descriptor too short &quot;
l_string|&quot;(expected %i, got %i)&bslash;n&quot;
comma
id|cfgno
comma
id|length
comma
id|result
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|kfree
c_func
(paren
id|bigbuffer
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|dev-&gt;rawdescriptors
(braket
id|cfgno
)braket
op_assign
id|bigbuffer
suffix:semicolon
id|result
op_assign
id|usb_parse_configuration
c_func
(paren
op_amp
id|dev-&gt;dev
comma
id|cfgno
comma
op_amp
id|dev-&gt;config
(braket
id|cfgno
)braket
comma
id|bigbuffer
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OG
l_int|0
)paren
id|dev_dbg
c_func
(paren
id|ddev
comma
l_string|&quot;config index %d descriptor has %d &quot;
l_string|&quot;excess byte(s)&bslash;n&quot;
comma
id|cfgno
comma
id|result
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
op_increment
id|cfgno
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
)brace
id|result
op_assign
l_int|0
suffix:semicolon
id|err
suffix:colon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|dev-&gt;descriptor.bNumConfigurations
op_assign
id|cfgno
suffix:semicolon
id|err2
suffix:colon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ENOMEM
)paren
id|dev_err
c_func
(paren
id|ddev
comma
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
eof
