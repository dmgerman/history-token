multiline_comment|/*&n; * OHCI HCD (Host Controller Driver) for USB.&n; *&n; * (C) Copyright 1999 Roman Weissgaerber &lt;weissg@vienna.at&gt;&n; * (C) Copyright 2000-2002 David Brownell &lt;dbrownell@users.sourceforge.net&gt;&n; * &n; * [ Initialisation is based on Linus&squot;  ]&n; * [ uhci code and gregs ohci fragments ]&n; * [ (C) Copyright 1999 Linus Torvalds  ]&n; * [ (C) Copyright 1999 Gregory P. Smith]&n; * &n; * &n; * History:&n; * &n; * 2002/01/18 package as a patch for 2.5.3; this should match the&n; *&t;2.4.17 kernel modulo some bugs being fixed.&n; *&n; * 2001/10/18 merge pmac cleanup (Benjamin Herrenschmidt) and bugfixes&n; *&t;from post-2.4.5 patches.&n; * 2001/09/20 USB_ZERO_PACKET support; hcca_dma portability, OPTi warning&n; * 2001/09/07 match PCI PM changes, errnos from Linus&squot; tree&n; * 2001/05/05 fork 2.4.5 version into &quot;hcd&quot; framework, cleanup, simplify;&n; *&t;pbook pci quirks gone (please fix pbook pci sw!) (db)&n; *&n; * 2001/04/08 Identify version on module load (gb)&n; * 2001/03/24 td/ed hashing to remove bus_to_virt (Steve Longerbeam);&n; &t;pci_map_single (db)&n; * 2001/03/21 td and dev/ed allocation uses new pci_pool API (db)&n; * 2001/03/07 hcca allocation uses pci_alloc_consistent (Steve Longerbeam)&n; *&n; * 2000/09/26 fixed races in removing the private portion of the urb&n; * 2000/09/07 disable bulk and control lists when unlinking the last&n; *&t;endpoint descriptor in order to avoid unrecoverable errors on&n; *&t;the Lucent chips. (rwc@sgi)&n; * 2000/08/29 use bandwidth claiming hooks (thanks Randy!), fix some&n; *&t;urb unlink probs, indentation fixes&n; * 2000/08/11 various oops fixes mostly affecting iso and cleanup from&n; *&t;device unplugs.&n; * 2000/06/28 use PCI hotplug framework, for better power management&n; *&t;and for Cardbus support (David Brownell)&n; * 2000/earlier:  fixes for NEC/Lucent chips; suspend/resume handling&n; *&t;when the controller loses power; handle UE; cleanup; ...&n; *&n; * v5.2 1999/12/07 URB 3rd preview, &n; * v5.1 1999/11/30 URB 2nd preview, cpia, (usb-scsi)&n; * v5.0 1999/11/22 URB Technical preview, Paul Mackerras powerbook susp/resume &n; * &t;i386: HUB, Keyboard, Mouse, Printer &n; *&n; * v4.3 1999/10/27 multiple HCs, bulk_request&n; * v4.2 1999/09/05 ISO API alpha, new dev alloc, neg Error-codes&n; * v4.1 1999/08/27 Randy Dunlap&squot;s - ISO API first impl.&n; * v4.0 1999/08/18 &n; * v3.0 1999/06/25 &n; * v2.1 1999/05/09  code clean up&n; * v2.0 1999/05/04 &n; * v1.0 1999/04/27 initial release&n; *&n; * This file is licenced under the GPL.&n; * $Id: ohci-hcd.c,v 1.7 2002/01/19 00:20:56 dbrownell Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;  /* for in_interrupt () */
macro_line|#ifdef CONFIG_USB_DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#else
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#endif
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;../hcd.h&quot;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#ifdef CONFIG_PMAC_PBOOK
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#ifndef CONFIG_PM
DECL|macro|CONFIG_PM
macro_line|#&t;define CONFIG_PM
macro_line|#endif
macro_line|#endif
multiline_comment|/*&n; * TO DO:&n; *&n; *&t;- &quot;disabled&quot; should be the hcd state&n; *&t;- bandwidth alloc to generic code&n; *&t;- lots more testing!!&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;$Revision: 1.7 $&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Roman Weissgaerber &lt;weissg@vienna.at&gt;, David Brownell&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;USB 1.1 &squot;Open&squot; Host Controller (OHCI) Driver&quot;
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|OHCI_USE_NPS
mdefine_line|#define OHCI_USE_NPS&t;&t;
singleline_comment|// force NoPowerSwitching mode
singleline_comment|// #define OHCI_VERBOSE_DEBUG&t;/* not always helpful */
multiline_comment|/* For initializing controller (mask in an HCFS mode too) */
DECL|macro|OHCI_CONTROL_INIT
mdefine_line|#define&t;OHCI_CONTROL_INIT &bslash;&n;&t; (OHCI_CTRL_CBSR &amp; 0x3) | OHCI_CTRL_IE | OHCI_CTRL_PLE
DECL|macro|OHCI_UNLINK_TIMEOUT
mdefine_line|#define OHCI_UNLINK_TIMEOUT&t; (HZ / 10)
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#include &quot;ohci.h&quot;
macro_line|#include &quot;ohci-hub.c&quot;
macro_line|#include &quot;ohci-dbg.c&quot;
macro_line|#include &quot;ohci-mem.c&quot;
macro_line|#include &quot;ohci-q.c&quot;
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/*&n; * queue up an urb for anything except the root hub&n; */
DECL|function|ohci_urb_enqueue
r_static
r_int
id|ohci_urb_enqueue
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
r_struct
id|urb
op_star
id|urb
comma
r_int
id|mem_flags
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
r_struct
id|ed
op_star
id|ed
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
r_int
id|i
comma
id|size
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|bustime
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef OHCI_VERBOSE_DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;SUB&quot;
comma
id|usb_pipein
(paren
id|pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* every endpoint has a ed, locate and fill it */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ed
op_assign
id|ep_add_ed
(paren
id|urb-&gt;dev
comma
id|pipe
comma
id|urb-&gt;interval
comma
l_int|1
comma
id|mem_flags
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* for the private part of the URB we need the number of TDs (size) */
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|pipe
)paren
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
multiline_comment|/* 1 TD for setup, 1 for ACK, plus ... */
id|size
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* FALLTHROUGH */
r_case
id|PIPE_BULK
suffix:colon
multiline_comment|/* one TD for every 4096 Bytes (can be upto 8K) */
id|size
op_add_assign
id|urb-&gt;transfer_buffer_length
op_div
l_int|4096
suffix:semicolon
multiline_comment|/* ... and for any remaining bytes ... */
r_if
c_cond
(paren
(paren
id|urb-&gt;transfer_buffer_length
op_mod
l_int|4096
)paren
op_ne
l_int|0
)paren
id|size
op_increment
suffix:semicolon
multiline_comment|/* ... and maybe a zero length packet to wrap it up */
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
id|size
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ZERO_PACKET
)paren
op_ne
l_int|0
op_logical_and
(paren
id|urb-&gt;transfer_buffer_length
op_mod
id|usb_maxpacket
(paren
id|urb-&gt;dev
comma
id|pipe
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
)paren
op_ne
l_int|0
)paren
id|size
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
multiline_comment|/* number of packets from URB */
id|size
op_assign
id|urb-&gt;number_of_packets
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
op_minus
id|EXDEV
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
multiline_comment|/* one TD */
id|size
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* allocate the private part of the URB */
id|urb_priv
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|urb_priv_t
)paren
op_plus
id|size
op_star
r_sizeof
(paren
r_struct
id|td
op_star
)paren
comma
id|mem_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
id|urb_priv
comma
l_int|0
comma
r_sizeof
(paren
id|urb_priv_t
)paren
op_plus
id|size
op_star
r_sizeof
(paren
r_struct
id|td
op_star
)paren
)paren
suffix:semicolon
multiline_comment|/* fill the private part of the URB */
id|urb_priv-&gt;length
op_assign
id|size
suffix:semicolon
id|urb_priv-&gt;ed
op_assign
id|ed
suffix:semicolon
multiline_comment|/* allocate the TDs (updating hash chains) */
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb_priv-&gt;td
(braket
id|i
)braket
op_assign
id|td_alloc
(paren
id|ohci
comma
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv-&gt;td
(braket
id|i
)braket
)paren
(brace
id|urb_priv-&gt;length
op_assign
id|i
suffix:semicolon
id|urb_free_priv
(paren
id|ohci
comma
id|urb_priv
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
singleline_comment|// FIXME:  much of this switch should be generic, move to hcd code ...
multiline_comment|/* allocate and claim bandwidth if needed; ISO&n;&t; * needs start frame index if it was&squot;t provided.&n;&t; */
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|pipe
)paren
)paren
(brace
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ISO_ASAP
)paren
(brace
id|urb-&gt;start_frame
op_assign
(paren
(paren
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
ques
c_cond
(paren
id|ed-&gt;last_iso
op_plus
l_int|1
)paren
suffix:colon
(paren
id|le16_to_cpu
(paren
id|ohci-&gt;hcca-&gt;frame_no
)paren
op_plus
l_int|10
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
multiline_comment|/* FALLTHROUGH */
r_case
id|PIPE_INTERRUPT
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;bandwidth
op_eq
l_int|0
)paren
(brace
id|bustime
op_assign
id|usb_check_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bustime
OL
l_int|0
)paren
(brace
id|urb_free_priv
(paren
id|ohci
comma
id|urb_priv
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|bustime
suffix:semicolon
)brace
id|usb_claim_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
id|bustime
comma
id|usb_pipeisoc
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
id|urb-&gt;hcpriv
op_assign
id|urb_priv
suffix:semicolon
multiline_comment|/* link the ed into a chain if is not already */
r_if
c_cond
(paren
id|ed-&gt;state
op_ne
id|ED_OPER
)paren
id|ep_link
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
multiline_comment|/* fill the TDs and link them to the ed; and&n;&t; * enable that part of the schedule, if needed&n;&t; */
id|td_submit_urb
(paren
id|urb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * decouple the URB from the HC queues (TDs, urb_priv); it&squot;s&n; * already marked for deletion.  reporting is always done&n; * asynchronously, and we might be dealing with an urb that&squot;s&n; * almost completed anyway...&n; */
DECL|function|ohci_urb_dequeue
r_static
r_int
id|ohci_urb_dequeue
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;UNLINK&quot;
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif&t;&t;  
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;disabled
)paren
(brace
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
multiline_comment|/* flag the urb&squot;s data for deletion in some upcoming&n;&t;&t; * SF interrupt&squot;s delete list processing&n;&t;&t; */
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
op_logical_or
(paren
id|urb_priv-&gt;state
op_eq
id|URB_DEL
)paren
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|urb_priv-&gt;state
op_assign
id|URB_DEL
suffix:semicolon
id|ed_unlink
(paren
id|urb-&gt;dev
comma
id|urb_priv-&gt;ed
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * with HC dead, we won&squot;t respect hc queue pointers&n;&t;&t; * any more ... just clean up every urb&squot;s memory.&n;&t;&t; */
id|finish_urb
(paren
id|ohci
comma
id|urb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
DECL|function|ohci_free_config
id|ohci_free_config
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
r_struct
id|usb_device
op_star
id|udev
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
r_struct
id|hcd_dev
op_star
id|dev
op_assign
(paren
r_struct
id|hcd_dev
op_star
)paren
id|udev-&gt;hcpriv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* free any eds, and dummy tds, still hanging around */
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ed
op_star
id|ed
op_assign
id|dev-&gt;ep
(braket
id|i
)braket
suffix:semicolon
r_struct
id|td
op_star
id|tdTailP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ed
)paren
r_continue
suffix:semicolon
id|ed-&gt;state
op_and_assign
op_complement
id|ED_URB_DEL
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;disabled
op_logical_and
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
id|ed-&gt;state
op_assign
id|ED_UNLINK
suffix:semicolon
r_switch
c_cond
(paren
id|ed-&gt;state
)paren
(brace
r_case
id|ED_NEW
suffix:colon
r_break
suffix:semicolon
r_case
id|ED_UNLINK
suffix:colon
id|tdTailP
op_assign
id|dma_to_td
(paren
id|ohci
comma
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwTailP
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|td_free
(paren
id|ohci
comma
id|tdTailP
)paren
suffix:semicolon
multiline_comment|/* free dummy td */
id|hash_free_ed
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ED_OPER
suffix:colon
r_default
suffix:colon
id|err
(paren
l_string|&quot;illegal ED %d state in free_config, %d&quot;
comma
id|i
comma
id|ed-&gt;state
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|BUG
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
id|ed_free
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ohci_get_frame
r_static
r_int
id|ohci_get_frame
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
r_return
id|le16_to_cpu
(paren
id|ohci-&gt;hcca-&gt;frame_no
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * HC functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* reset the HC and BUS */
DECL|function|hc_reset
r_static
r_int
id|hc_reset
(paren
r_struct
id|ohci_hcd
op_star
id|ohci
)paren
(brace
r_int
id|timeout
op_assign
l_int|30
suffix:semicolon
r_int
id|smm_timeout
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* 0,5 sec */
r_if
c_cond
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
id|OHCI_CTRL_IR
)paren
(brace
multiline_comment|/* SMM owns the HC */
id|writel
(paren
id|OHCI_INTR_OC
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_OCR
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;USB HC TakeOver from SMM&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
id|OHCI_CTRL_IR
)paren
(brace
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|smm_timeout
op_eq
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;USB HC TakeOver failed!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Disable HC interrupts */
id|writel
(paren
id|OHCI_INTR_MIE
comma
op_amp
id|ohci-&gt;regs-&gt;intrdisable
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;USB HC reset_hc %s: ctrl = 0x%x ;&quot;
comma
id|ohci-&gt;hcd.bus_name
comma
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
)paren
suffix:semicolon
multiline_comment|/* Reset USB (needed by some controllers) */
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* HC Reset requires max 10 ms delay */
id|writel
(paren
id|OHCI_HCR
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
op_amp
id|OHCI_HCR
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
op_eq
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;USB HC reset timed out!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|udelay
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Start an OHCI controller, set the BUS operational&n; * enable interrupts &n; * connect the virtual root hub&n; */
DECL|function|hc_start
r_static
r_int
id|hc_start
(paren
r_struct
id|ohci_hcd
op_star
id|ohci
)paren
(brace
id|__u32
id|mask
suffix:semicolon
r_int
r_int
id|fminterval
suffix:semicolon
r_struct
id|usb_device
op_star
id|udev
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|ohci-&gt;lock
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
id|ohci-&gt;sleeping
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Tell the controller where the control and bulk lists are&n;&t; * The lists are empty now. */
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
multiline_comment|/* a reset clears this */
id|writel
(paren
(paren
id|u32
)paren
id|ohci-&gt;hcca_dma
comma
op_amp
id|ohci-&gt;regs-&gt;hcca
)paren
suffix:semicolon
id|fminterval
op_assign
l_int|0x2edf
suffix:semicolon
id|writel
(paren
(paren
id|fminterval
op_star
l_int|9
)paren
op_div
l_int|10
comma
op_amp
id|ohci-&gt;regs-&gt;periodicstart
)paren
suffix:semicolon
id|fminterval
op_or_assign
(paren
(paren
(paren
(paren
id|fminterval
op_minus
l_int|210
)paren
op_star
l_int|6
)paren
op_div
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|writel
(paren
id|fminterval
comma
op_amp
id|ohci-&gt;regs-&gt;fminterval
)paren
suffix:semicolon
id|writel
(paren
l_int|0x628
comma
op_amp
id|ohci-&gt;regs-&gt;lsthresh
)paren
suffix:semicolon
multiline_comment|/* start controller operations */
id|ohci-&gt;hc_control
op_assign
id|OHCI_CONTROL_INIT
op_or
id|OHCI_USB_OPER
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|0
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* Choose the interrupts we care about now, others later on demand */
id|mask
op_assign
id|OHCI_INTR_MIE
op_or
id|OHCI_INTR_UE
op_or
id|OHCI_INTR_WDH
suffix:semicolon
id|writel
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
macro_line|#ifdef&t;OHCI_USE_NPS
multiline_comment|/* required for AMD-756 and some Mac platforms */
id|writel
(paren
(paren
id|roothub_a
(paren
id|ohci
)paren
op_or
id|RH_A_NPS
)paren
op_amp
op_complement
id|RH_A_PSM
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
suffix:semicolon
id|writel
(paren
id|RH_HS_LPSC
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
suffix:semicolon
macro_line|#endif&t;/* OHCI_USE_NPS */
singleline_comment|// POTPGT delay is bits 24-31, in 2 ms units.
id|mdelay
(paren
(paren
id|roothub_a
(paren
id|ohci
)paren
op_rshift
l_int|23
)paren
op_amp
l_int|0x1fe
)paren
suffix:semicolon
multiline_comment|/* connect the virtual root hub */
id|ohci-&gt;hcd.bus-&gt;root_hub
op_assign
id|udev
op_assign
id|usb_alloc_dev
(paren
l_int|NULL
comma
id|ohci-&gt;hcd.bus
)paren
suffix:semicolon
id|ohci-&gt;hcd.state
op_assign
id|USB_STATE_READY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|udev
)paren
(brace
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
singleline_comment|// FIXME cleanup
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|usb_connect
(paren
id|udev
)paren
suffix:semicolon
id|udev-&gt;speed
op_assign
id|USB_SPEED_FULL
suffix:semicolon
r_if
c_cond
(paren
id|usb_register_root_hub
(paren
id|udev
comma
op_amp
id|ohci-&gt;hcd.pdev-&gt;dev
)paren
op_ne
l_int|0
)paren
(brace
id|usb_free_dev
(paren
id|udev
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
singleline_comment|// FIXME cleanup
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* an interrupt happens */
DECL|function|ohci_irq
r_static
r_void
id|ohci_irq
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
r_struct
id|ohci_regs
op_star
id|regs
op_assign
id|ohci-&gt;regs
suffix:semicolon
r_int
id|ints
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ohci-&gt;hcca-&gt;done_head
op_ne
l_int|0
)paren
op_logical_and
op_logical_neg
(paren
id|le32_to_cpup
(paren
op_amp
id|ohci-&gt;hcca-&gt;done_head
)paren
op_amp
l_int|0x01
)paren
)paren
(brace
id|ints
op_assign
id|OHCI_INTR_WDH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ints
op_assign
(paren
id|readl
(paren
op_amp
id|regs-&gt;intrstatus
)paren
op_amp
id|readl
(paren
op_amp
id|regs-&gt;intrenable
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
singleline_comment|// dbg (&quot;Interrupt: %x frame: %x&quot;, ints, le16_to_cpu (ohci-&gt;hcca-&gt;frame_no));
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_UE
)paren
(brace
id|ohci-&gt;disabled
op_increment
suffix:semicolon
id|err
(paren
l_string|&quot;OHCI Unrecoverable Error, %s disabled&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
singleline_comment|// e.g. due to PCI Master/Target Abort
macro_line|#ifdef&t;DEBUG
id|ohci_dump
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|hc_reset
(paren
id|ohci
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_WDH
)paren
(brace
id|writel
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
id|dl_done_list
(paren
id|ohci
comma
id|dl_reverse_done_list
(paren
id|ohci
)paren
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
multiline_comment|/* could track INTR_SO to reduce available PCI/... bandwidth */
singleline_comment|// FIXME:  this assumes SOF (1/ms) interrupts don&squot;t get lost...
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_SF
)paren
(brace
r_int
r_int
id|frame
op_assign
id|le16_to_cpu
(paren
id|ohci-&gt;hcca-&gt;frame_no
)paren
op_amp
l_int|1
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_rm_list
(braket
op_logical_neg
id|frame
)braket
op_ne
l_int|NULL
)paren
(brace
id|dl_del_list
(paren
id|ohci
comma
op_logical_neg
id|frame
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
op_ne
l_int|NULL
)paren
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
id|writel
(paren
id|ints
comma
op_amp
id|regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_MIE
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|ohci_stop
r_static
r_void
id|ohci_stop
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s: stop %s controller%s&quot;
comma
id|hcd-&gt;bus_name
comma
id|hcfs2string
(paren
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
)paren
comma
id|ohci-&gt;disabled
ques
c_cond
l_string|&quot; (disabled)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|ohci_dump
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;disabled
)paren
id|hc_reset
(paren
id|ohci
)paren
suffix:semicolon
id|ohci_mem_cleanup
(paren
id|ohci
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
id|pci_free_consistent
(paren
id|ohci-&gt;hcd.pdev
comma
r_sizeof
op_star
id|ohci-&gt;hcca
comma
id|ohci-&gt;hcca
comma
id|ohci-&gt;hcca_dma
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_int
id|__devinit
DECL|function|ohci_start
id|ohci_start
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
r_if
c_cond
(paren
id|hcd-&gt;pdev
)paren
(brace
id|ohci-&gt;hcca
op_assign
id|pci_alloc_consistent
(paren
id|hcd-&gt;pdev
comma
r_sizeof
op_star
id|ohci-&gt;hcca
comma
op_amp
id|ohci-&gt;hcca_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;hcca
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* AMD 756, for most chips (early revs), corrupts register&n;&t;&t; * values on read ... so enable the vendor workaround.&n;&t;&t; */
r_if
c_cond
(paren
id|hcd-&gt;pdev-&gt;vendor
op_eq
l_int|0x1022
op_logical_and
id|hcd-&gt;pdev-&gt;device
op_eq
l_int|0x740c
)paren
(brace
id|ohci-&gt;flags
op_assign
id|OHCI_QUIRK_AMD756
suffix:semicolon
id|info
(paren
l_string|&quot;%s: AMD756 erratum 4 workaround&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
)brace
multiline_comment|/* Apple&squot;s OHCI driver has a lot of bizarre workarounds&n;&t;&t; * for this chip.  Evidently control and bulk lists&n;&t;&t; * can get confused.  (B&amp;W G3 models, and ...)&n;&t;&t; */
r_else
r_if
c_cond
(paren
id|hcd-&gt;pdev-&gt;vendor
op_eq
l_int|0x1045
op_logical_and
id|hcd-&gt;pdev-&gt;device
op_eq
l_int|0xc861
)paren
(brace
id|info
(paren
l_string|&quot;%s: WARNING: OPTi workarounds unavailable&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
macro_line|#&t;error &quot;where&squot;s hcca coming from?&quot;
macro_line|#endif /* CONFIG_PCI */
id|memset
(paren
id|ohci-&gt;hcca
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ohci_hcca
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ohci_mem_init
(paren
id|ohci
)paren
)paren
OL
l_int|0
)paren
(brace
id|ohci_stop
(paren
id|hcd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ohci-&gt;regs
op_assign
id|hcd-&gt;regs
suffix:semicolon
r_if
c_cond
(paren
id|hc_reset
(paren
id|ohci
)paren
OL
l_int|0
)paren
(brace
id|ohci_stop
(paren
id|hcd
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hc_start
(paren
id|ohci
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;can&squot;t start %s&quot;
comma
id|ohci-&gt;hcd.bus_name
)paren
suffix:semicolon
id|ohci_stop
(paren
id|hcd
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef&t;DEBUG
id|ohci_dump
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef&t;CONFIG_PM
DECL|function|ohci_suspend
r_static
r_int
id|ohci_suspend
(paren
r_struct
id|usb_hcd
op_star
id|hcd
comma
id|u32
id|state
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|cmd
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
)paren
op_ne
id|OHCI_USB_OPER
)paren
(brace
id|dbg
(paren
l_string|&quot;can&squot;t suspend %s (state is %s)&quot;
comma
id|hcd-&gt;bus_name
comma
id|hcfs2string
(paren
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* act as if usb suspend can always be used */
id|dbg
(paren
l_string|&quot;%s: suspend to %d&quot;
comma
id|hcd-&gt;bus_name
comma
id|state
)paren
suffix:semicolon
id|ohci-&gt;sleeping
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* First stop processing */
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ohci-&gt;hc_control
op_and_assign
op_complement
(paren
id|OHCI_CTRL_PLE
op_or
id|OHCI_CTRL_CLE
op_or
id|OHCI_CTRL_BLE
op_or
id|OHCI_CTRL_IE
)paren
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Wait a frame or two */
id|mdelay
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
op_amp
id|OHCI_INTR_SF
)paren
id|mdelay
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
id|disable_irq
(paren
id|hcd-&gt;pdev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* else, 2.4 assumes shared irqs -- don&squot;t disable */
macro_line|#endif
multiline_comment|/* Enable remote wakeup */
id|writel
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
op_or
id|OHCI_INTR_RD
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
multiline_comment|/* Suspend chip and let things settle down a bit */
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_SUSPEND
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|mdelay
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* No schedule here ! */
r_switch
c_cond
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
id|OHCI_CTRL_HCFS
)paren
(brace
r_case
id|OHCI_USB_RESET
suffix:colon
id|dbg
(paren
l_string|&quot;%s suspend-&gt;reset ?&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OHCI_USB_RESUME
suffix:colon
id|dbg
(paren
l_string|&quot;%s suspend-&gt;resume ?&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OHCI_USB_OPER
suffix:colon
id|dbg
(paren
l_string|&quot;%s suspend-&gt;operational ?&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OHCI_USB_SUSPEND
suffix:colon
id|dbg
(paren
l_string|&quot;%s suspended&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* In some rare situations, Apple&squot;s OHCI have happily trashed&n;&t; * memory during sleep. We disable its bus master bit during&n;&t; * suspend&n;&t; */
id|pci_read_config_word
(paren
id|hcd-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_and_assign
op_complement
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_word
(paren
id|hcd-&gt;pdev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
(brace
r_struct
id|device_node
op_star
id|of_node
suffix:semicolon
multiline_comment|/* Disable USB PAD &amp; cell clock */
id|of_node
op_assign
id|pci_device_to_OF_node
(paren
id|hcd-&gt;pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|of_node
)paren
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_USB_ENABLE
comma
id|of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// FIXME:  this restart logic should be generic,
singleline_comment|// and handle full hcd state cleanup
multiline_comment|/* controller died; cleanup debris, then restart */
multiline_comment|/* must not be called from interrupt context */
DECL|function|hc_restart
r_static
r_int
id|hc_restart
(paren
r_struct
id|ohci_hcd
op_star
id|ohci
)paren
(brace
r_int
id|temp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
id|ohci-&gt;sleeping
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;hcd.bus-&gt;root_hub
)paren
id|usb_disconnect
(paren
op_amp
id|ohci-&gt;hcd.bus-&gt;root_hub
)paren
suffix:semicolon
multiline_comment|/* empty the interrupt branches */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;hcca-&gt;int_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EDs to remove */
id|ohci-&gt;ed_rm_list
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_rm_list
(braket
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* empty control and bulk lists */
id|ohci-&gt;ed_isotail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_controltail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_bulktail
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_assign
id|hc_reset
(paren
id|ohci
)paren
)paren
OL
l_int|0
op_logical_or
(paren
id|temp
op_assign
id|hc_start
(paren
id|ohci
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;can&squot;t restart %s, %d&quot;
comma
id|ohci-&gt;hcd.bus_name
comma
id|temp
)paren
suffix:semicolon
r_return
id|temp
suffix:semicolon
)brace
r_else
id|dbg
(paren
l_string|&quot;restart %s completed&quot;
comma
id|ohci-&gt;hcd.bus_name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_resume
r_static
r_int
id|ohci_resume
(paren
r_struct
id|usb_hcd
op_star
id|hcd
)paren
(brace
r_struct
id|ohci_hcd
op_star
id|ohci
op_assign
id|hcd_to_ohci
(paren
id|hcd
)paren
suffix:semicolon
r_int
id|temp
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
(brace
r_struct
id|device_node
op_star
id|of_node
suffix:semicolon
multiline_comment|/* Re-enable USB PAD &amp; cell clock */
id|of_node
op_assign
id|pci_device_to_OF_node
(paren
id|hcd-&gt;pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|of_node
)paren
id|pmac_call_feature
(paren
id|PMAC_FTR_USB_ENABLE
comma
id|of_node
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* did we suspend, or were we powered off? */
id|ohci-&gt;hc_control
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|temp
op_assign
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
suffix:semicolon
macro_line|#ifdef DEBUG
multiline_comment|/* the registers may look crazy here */
id|ohci_dump_status
(paren
id|ohci
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Re-enable bus mastering */
id|pci_set_master
(paren
id|ohci-&gt;hcd.pdev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|temp
)paren
(brace
r_case
id|OHCI_USB_RESET
suffix:colon
singleline_comment|// lost power
id|info
(paren
l_string|&quot;USB restart: %s&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
id|retval
op_assign
id|hc_restart
(paren
id|ohci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OHCI_USB_SUSPEND
suffix:colon
singleline_comment|// host wakeup
r_case
id|OHCI_USB_RESUME
suffix:colon
singleline_comment|// remote wakeup
id|info
(paren
l_string|&quot;USB continue: %s from %s wakeup&quot;
comma
id|hcd-&gt;bus_name
comma
(paren
id|temp
op_eq
id|OHCI_USB_SUSPEND
)paren
ques
c_cond
l_string|&quot;host&quot;
suffix:colon
l_string|&quot;remote&quot;
)paren
suffix:semicolon
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_RESUME
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|mdelay
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* no schedule here ! */
multiline_comment|/* Some controllers (lucent) need a longer delay here */
id|mdelay
(paren
l_int|15
)paren
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|temp
op_assign
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_ne
id|OHCI_USB_RESUME
)paren
(brace
id|err
(paren
l_string|&quot;controller %s won&squot;t resume&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Some chips likes being resumed first */
id|writel
(paren
id|OHCI_USB_OPER
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|mdelay
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Then re-enable operations */
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;sleeping
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;hc_control
op_assign
id|OHCI_CONTROL_INIT
op_or
id|OHCI_USB_OPER
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
l_int|0
)braket
op_logical_and
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
l_int|1
)braket
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
)paren
id|ohci-&gt;hc_control
op_or_assign
id|OHCI_CTRL_CLE
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
)paren
id|ohci-&gt;hc_control
op_or_assign
id|OHCI_CTRL_BLE
suffix:semicolon
)brace
id|hcd-&gt;state
op_assign
id|USB_STATE_READY
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* trigger a start-frame interrupt (why?) */
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
multiline_comment|/* Check for a pending done list */
id|writel
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|ohci-&gt;regs-&gt;intrdisable
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;intrdisable
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
id|enable_irq
(paren
id|hcd-&gt;pdev-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ohci-&gt;hcca-&gt;done_head
)paren
id|dl_done_list
(paren
id|ohci
comma
id|dl_reverse_done_list
(paren
id|ohci
)paren
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
multiline_comment|/* assume there are TDs on the bulk and control lists */
id|writel
(paren
id|OHCI_BLF
op_or
id|OHCI_CLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
singleline_comment|// ohci_dump_status (ohci);
id|dbg
(paren
l_string|&quot;sleeping = %d, disabled = %d&quot;
comma
id|ohci-&gt;sleeping
comma
id|ohci-&gt;disabled
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|warn
(paren
l_string|&quot;odd PCI resume for %s&quot;
comma
id|hcd-&gt;bus_name
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_PM */
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|hcd_name
r_static
r_const
r_char
id|hcd_name
(braket
)braket
op_assign
l_string|&quot;ohci-hcd&quot;
suffix:semicolon
DECL|variable|ohci_driver
r_static
r_const
r_struct
id|hc_driver
id|ohci_driver
op_assign
(brace
id|description
suffix:colon
id|hcd_name
comma
multiline_comment|/*&n;&t; * generic hardware linkage&n;&t; */
id|irq
suffix:colon
id|ohci_irq
comma
id|flags
suffix:colon
id|HCD_MEMORY
op_or
id|HCD_USB11
comma
multiline_comment|/*&n;&t; * basic lifecycle operations&n;&t; */
id|start
suffix:colon
id|ohci_start
comma
macro_line|#ifdef&t;CONFIG_PM
id|suspend
suffix:colon
id|ohci_suspend
comma
id|resume
suffix:colon
id|ohci_resume
comma
macro_line|#endif
id|stop
suffix:colon
id|ohci_stop
comma
multiline_comment|/*&n;&t; * memory lifecycle (except per-request)&n;&t; */
id|hcd_alloc
suffix:colon
id|ohci_hcd_alloc
comma
id|hcd_free
suffix:colon
id|ohci_hcd_free
comma
multiline_comment|/*&n;&t; * managing i/o requests and associated device resources&n;&t; */
id|urb_enqueue
suffix:colon
id|ohci_urb_enqueue
comma
id|urb_dequeue
suffix:colon
id|ohci_urb_dequeue
comma
id|free_config
suffix:colon
id|ohci_free_config
comma
multiline_comment|/*&n;&t; * scheduling support&n;&t; */
id|get_frame_number
suffix:colon
id|ohci_get_frame
comma
multiline_comment|/*&n;&t; * root hub support&n;&t; */
id|hub_status_data
suffix:colon
id|ohci_hub_status_data
comma
id|hub_control
suffix:colon
id|ohci_hub_control
comma
)brace
suffix:semicolon
DECL|macro|DRIVER_INFO
mdefine_line|#define DRIVER_INFO DRIVER_VERSION &quot; &quot; DRIVER_DESC
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_INFO
id|MODULE_DESCRIPTION
(paren
id|DRIVER_INFO
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef CONFIG_PCI
multiline_comment|/* There do exist non-PCI implementations of OHCI ...&n; * Examples include the SA-1111 (ARM) and some MIPS&n; * and related hardware.&n; */
DECL|variable|pci_ids
r_static
r_const
r_struct
id|pci_device_id
id|__devinitdata
id|pci_ids
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* handle any USB OHCI controller */
r_class
suffix:colon
(paren
id|PCI_CLASS_SERIAL_USB
op_lshift
l_int|8
)paren
op_or
l_int|0x10
comma
id|class_mask
suffix:colon
op_complement
l_int|0
comma
id|driver_data
suffix:colon
(paren
r_int
r_int
)paren
op_amp
id|ohci_driver
comma
multiline_comment|/* no matter who makes it */
id|vendor
suffix:colon
id|PCI_ANY_ID
comma
id|device
suffix:colon
id|PCI_ANY_ID
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|pci_ids
)paren
suffix:semicolon
multiline_comment|/* pci driver glue; this is a &quot;new style&quot; PCI driver module */
DECL|variable|ohci_pci_driver
r_static
r_struct
id|pci_driver
id|ohci_pci_driver
op_assign
(brace
id|name
suffix:colon
(paren
r_char
op_star
)paren
id|hcd_name
comma
id|id_table
suffix:colon
id|pci_ids
comma
id|probe
suffix:colon
id|usb_hcd_pci_probe
comma
id|remove
suffix:colon
id|usb_hcd_pci_remove
comma
macro_line|#ifdef&t;CONFIG_PM
id|suspend
suffix:colon
id|usb_hcd_pci_suspend
comma
id|resume
suffix:colon
id|usb_hcd_pci_resume
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|function|ohci_hcd_init
r_static
r_int
id|__init
id|ohci_hcd_init
(paren
r_void
)paren
(brace
id|dbg
(paren
id|DRIVER_INFO
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;block sizes: ed %d td %d&quot;
comma
r_sizeof
(paren
r_struct
id|ed
)paren
comma
r_sizeof
(paren
r_struct
id|td
)paren
)paren
suffix:semicolon
r_return
id|pci_module_init
(paren
op_amp
id|ohci_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|ohci_hcd_init
id|module_init
(paren
id|ohci_hcd_init
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|ohci_hcd_cleanup
r_static
r_void
id|__exit
id|ohci_hcd_cleanup
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|ohci_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|ohci_hcd_cleanup
id|module_exit
(paren
id|ohci_hcd_cleanup
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
eof
