multiline_comment|/*&n; * $Id: konicawc.c,v 1.12 2002/02/07 23:18:53 spse Exp $&n; *&n; * konicawc.c - konica webcam driver&n; *&n; * Author: Simon Evans &lt;spse@secret.org.uk&gt;&n; *&n; * Copyright (C) 2002 Simon Evans&n; *&n; * Licence: GPL&n; * &n; * Driver for USB webcams based on Konica chipset. This&n; * chipset is used in Intel YC76 camera.&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#include &quot;usbvideo.h&quot;
DECL|macro|MAX_BRIGHTNESS
mdefine_line|#define MAX_BRIGHTNESS&t;108
DECL|macro|MAX_CONTRAST
mdefine_line|#define MAX_CONTRAST&t;108
DECL|macro|MAX_SATURATION
mdefine_line|#define MAX_SATURATION&t;108
DECL|macro|MAX_SHARPNESS
mdefine_line|#define MAX_SHARPNESS&t;108
DECL|macro|MAX_WHITEBAL
mdefine_line|#define MAX_WHITEBAL&t;363
DECL|macro|MAX_CAMERAS
mdefine_line|#define MAX_CAMERAS 1
DECL|enum|ctrl_req
r_enum
id|ctrl_req
(brace
DECL|enumerator|SetWhitebal
id|SetWhitebal
op_assign
l_int|0x01
comma
DECL|enumerator|SetBrightness
id|SetBrightness
op_assign
l_int|0x02
comma
DECL|enumerator|SetSharpness
id|SetSharpness
op_assign
l_int|0x03
comma
DECL|enumerator|SetContrast
id|SetContrast
op_assign
l_int|0x04
comma
DECL|enumerator|SetSaturation
id|SetSaturation
op_assign
l_int|0x05
comma
)brace
suffix:semicolon
DECL|enum|frame_sizes
r_enum
id|frame_sizes
(brace
DECL|enumerator|SIZE_160X130
id|SIZE_160X130
op_assign
l_int|0
comma
DECL|enumerator|SIZE_176X144
id|SIZE_176X144
op_assign
l_int|1
comma
DECL|enumerator|SIZE_320X240
id|SIZE_320X240
op_assign
l_int|2
comma
)brace
suffix:semicolon
DECL|variable|cams
r_static
id|usbvideo_t
op_star
id|cams
suffix:semicolon
multiline_comment|/* Some default values for inital camera settings,&n;   can be set by modprobe */
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|variable|size
r_static
r_enum
id|frame_sizes
id|size
suffix:semicolon
DECL|variable|brightness
r_static
r_int
id|brightness
op_assign
id|MAX_BRIGHTNESS
op_div
l_int|2
suffix:semicolon
DECL|variable|contrast
r_static
r_int
id|contrast
op_assign
id|MAX_CONTRAST
op_div
l_int|2
suffix:semicolon
DECL|variable|saturation
r_static
r_int
id|saturation
op_assign
id|MAX_SATURATION
op_div
l_int|2
suffix:semicolon
DECL|variable|sharpness
r_static
r_int
id|sharpness
op_assign
id|MAX_SHARPNESS
op_div
l_int|2
suffix:semicolon
DECL|variable|whitebal
r_static
r_int
id|whitebal
op_assign
l_int|3
op_star
(paren
id|MAX_WHITEBAL
op_div
l_int|4
)paren
suffix:semicolon
DECL|struct|konicawc
r_struct
id|konicawc
(brace
DECL|member|brightness
id|u8
id|brightness
suffix:semicolon
multiline_comment|/* camera uses 0 - 9, x11 for real value */
DECL|member|contrast
id|u8
id|contrast
suffix:semicolon
multiline_comment|/* as above */
DECL|member|saturation
id|u8
id|saturation
suffix:semicolon
multiline_comment|/* as above */
DECL|member|sharpness
id|u8
id|sharpness
suffix:semicolon
multiline_comment|/* as above */
DECL|member|white_bal
id|u8
id|white_bal
suffix:semicolon
multiline_comment|/* 0 - 33, x11 for real value */
DECL|member|fps
id|u8
id|fps
suffix:semicolon
multiline_comment|/* Stored as fps * 3 */
DECL|member|size
id|u8
id|size
suffix:semicolon
multiline_comment|/* Frame Size */
DECL|member|height
r_int
id|height
suffix:semicolon
DECL|member|width
r_int
id|width
suffix:semicolon
DECL|member|sts_urb
r_struct
id|urb
op_star
id|sts_urb
(braket
id|USBVIDEO_NUMFRAMES
)braket
suffix:semicolon
DECL|member|sts_buf
id|u8
id|sts_buf
(braket
id|USBVIDEO_NUMFRAMES
)braket
(braket
id|FRAMES_PER_DESC
)braket
suffix:semicolon
DECL|member|last_data_urb
r_struct
id|urb
op_star
id|last_data_urb
suffix:semicolon
DECL|member|lastframe
r_int
id|lastframe
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|konicawc_set_misc
mdefine_line|#define konicawc_set_misc(uvd, req, value, index)&t;&t;konicawc_ctrl_msg(uvd, USB_DIR_OUT, req, value, index, NULL, 0)
DECL|macro|konicawc_get_misc
mdefine_line|#define konicawc_get_misc(uvd, req, value, index, buf, sz)&t;konicawc_ctrl_msg(uvd, USB_DIR_IN, req, value, index, buf, sz)
DECL|macro|konicawc_set_value
mdefine_line|#define konicawc_set_value(uvd, value, index)&t;&t;&t;konicawc_ctrl_msg(uvd, USB_DIR_OUT, 2, value, index, NULL, 0)
DECL|function|konicawc_ctrl_msg
r_static
r_int
id|konicawc_ctrl_msg
c_func
(paren
id|uvd_t
op_star
id|uvd
comma
id|u8
id|dir
comma
id|u8
id|request
comma
id|u16
id|value
comma
id|u16
id|index
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|retval
op_assign
id|usb_control_msg
c_func
(paren
id|uvd-&gt;dev
comma
id|dir
ques
c_cond
id|usb_rcvctrlpipe
c_func
(paren
id|uvd-&gt;dev
comma
l_int|0
)paren
suffix:colon
id|usb_sndctrlpipe
c_func
(paren
id|uvd-&gt;dev
comma
l_int|0
)paren
comma
id|request
comma
l_int|0x40
op_or
id|dir
comma
id|value
comma
id|index
comma
id|buf
comma
id|len
comma
id|HZ
)paren
suffix:semicolon
r_return
id|retval
OL
l_int|0
ques
c_cond
id|retval
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|konicawc_setup_on_open
r_static
r_int
id|konicawc_setup_on_open
c_func
(paren
id|uvd_t
op_star
id|uvd
)paren
(brace
r_struct
id|konicawc
op_star
id|cam
op_assign
(paren
r_struct
id|konicawc
op_star
)paren
id|uvd-&gt;user_data
suffix:semicolon
id|konicawc_set_misc
c_func
(paren
id|uvd
comma
l_int|0x2
comma
l_int|0
comma
l_int|0x0b
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;setting brightness to %d (%d)&quot;
comma
id|cam-&gt;brightness
comma
id|cam-&gt;brightness
op_star
l_int|11
)paren
suffix:semicolon
id|konicawc_set_value
c_func
(paren
id|uvd
comma
id|cam-&gt;brightness
comma
id|SetBrightness
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;setting white balance to %d (%d)&quot;
comma
id|cam-&gt;white_bal
comma
id|cam-&gt;white_bal
op_star
l_int|11
)paren
suffix:semicolon
id|konicawc_set_value
c_func
(paren
id|uvd
comma
id|cam-&gt;white_bal
comma
id|SetWhitebal
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;setting contrast to %d (%d)&quot;
comma
id|cam-&gt;contrast
comma
id|cam-&gt;contrast
op_star
l_int|11
)paren
suffix:semicolon
id|konicawc_set_value
c_func
(paren
id|uvd
comma
id|cam-&gt;brightness
comma
id|SetBrightness
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;setting saturation to %d (%d)&quot;
comma
id|cam-&gt;saturation
comma
id|cam-&gt;saturation
op_star
l_int|11
)paren
suffix:semicolon
id|konicawc_set_value
c_func
(paren
id|uvd
comma
id|cam-&gt;saturation
comma
id|SetSaturation
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;setting sharpness to %d (%d)&quot;
comma
id|cam-&gt;sharpness
comma
id|cam-&gt;sharpness
op_star
l_int|11
)paren
suffix:semicolon
id|konicawc_set_value
c_func
(paren
id|uvd
comma
id|cam-&gt;sharpness
comma
id|SetSharpness
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;setting size %d&quot;
comma
id|cam-&gt;size
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cam-&gt;size
)paren
(brace
r_case
l_int|0
suffix:colon
id|konicawc_set_misc
c_func
(paren
id|uvd
comma
l_int|0x2
comma
l_int|0xa
comma
l_int|0x08
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|konicawc_set_misc
c_func
(paren
id|uvd
comma
l_int|0x2
comma
l_int|4
comma
l_int|0x08
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|konicawc_set_misc
c_func
(paren
id|uvd
comma
l_int|0x2
comma
l_int|5
comma
l_int|0x08
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|konicawc_set_misc
c_func
(paren
id|uvd
comma
l_int|0x2
comma
l_int|1
comma
l_int|0x0b
)paren
suffix:semicolon
id|cam-&gt;lastframe
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|konicawc_compress_iso
r_static
r_int
id|konicawc_compress_iso
c_func
(paren
id|uvd_t
op_star
id|uvd
comma
r_struct
id|urb
op_star
id|dataurb
comma
r_struct
id|urb
op_star
id|stsurb
)paren
(brace
r_char
op_star
id|cdata
suffix:semicolon
r_int
id|i
comma
id|totlen
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|status
op_assign
id|stsurb-&gt;transfer_buffer
suffix:semicolon
r_int
id|keep
op_assign
l_int|0
comma
id|discard
op_assign
l_int|0
comma
id|bad
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|buttonsts
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dataurb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|button
op_assign
id|buttonsts
suffix:semicolon
r_int
r_char
id|sts
suffix:semicolon
r_int
id|n
op_assign
id|dataurb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
suffix:semicolon
r_int
id|st
op_assign
id|dataurb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|cdata
op_assign
id|dataurb-&gt;transfer_buffer
op_plus
id|dataurb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
multiline_comment|/* Detect and ignore errored packets */
r_if
c_cond
(paren
id|st
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|debug
op_ge
l_int|1
)paren
id|err
c_func
(paren
l_string|&quot;Data error: packet=%d. len=%d. status=%d.&quot;
comma
id|i
comma
id|n
comma
id|st
)paren
suffix:semicolon
id|uvd-&gt;stats.iso_err_count
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Detect and ignore empty packets */
r_if
c_cond
(paren
id|n
op_le
l_int|0
)paren
(brace
id|uvd-&gt;stats.iso_skip_count
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* See what the status data said about the packet */
id|sts
op_assign
op_star
(paren
id|status
op_plus
id|stsurb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
)paren
suffix:semicolon
multiline_comment|/* sts: 0x80-0xff: frame start with frame number (ie 0-7f)&n;&t;&t; * otherwise:&n;&t;&t; * bit 0 0:drop packet (padding data)&n;&t;&t; *&t; 1 keep packet&n;&t;&t; *&n;&t;&t; * bit 4 0 button not clicked&n;&t;&t; *       1 button clicked&n;&t;&t; * button is used to `take a picture&squot; (in software)&n;&t;&t; */
r_if
c_cond
(paren
id|sts
OL
l_int|0x80
)paren
(brace
id|button
op_assign
id|sts
op_amp
l_int|0x40
suffix:semicolon
id|sts
op_and_assign
op_complement
l_int|0x40
suffix:semicolon
)brace
multiline_comment|/* work out the button status, but dont do&n;&t;&t;   anything with it for now */
r_if
c_cond
(paren
id|button
op_ne
id|buttonsts
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;button: %sclicked&quot;
comma
id|button
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;un&quot;
)paren
suffix:semicolon
id|buttonsts
op_assign
id|button
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sts
op_eq
l_int|0x01
)paren
(brace
multiline_comment|/* drop frame */
id|discard
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sts
OG
l_int|0x01
)paren
op_logical_and
(paren
id|sts
OL
l_int|0x80
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;unknown status %2.2x&quot;
comma
id|sts
)paren
suffix:semicolon
id|bad
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|keep
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|status
op_plus
id|i
)paren
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* frame start */
r_int
r_char
id|marker
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0xff
comma
l_int|0
comma
l_int|0x00
)brace
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Adding Marker packet = %d, frame = %2.2x&quot;
comma
id|i
comma
op_star
(paren
id|status
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|marker
(braket
l_int|3
)braket
op_assign
op_star
(paren
id|status
op_plus
id|i
)paren
op_minus
l_int|0x80
suffix:semicolon
id|RingQueue_Enqueue
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
id|marker
comma
l_int|4
)paren
suffix:semicolon
id|totlen
op_add_assign
l_int|4
suffix:semicolon
)brace
id|totlen
op_add_assign
id|n
suffix:semicolon
multiline_comment|/* Little local accounting */
r_if
c_cond
(paren
id|debug
OG
l_int|5
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Adding packet %d, bytes = %d&quot;
comma
id|i
comma
id|n
)paren
suffix:semicolon
)brace
id|RingQueue_Enqueue
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
id|cdata
comma
id|n
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|8
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;finished: keep = %d discard = %d bad = %d added %d bytes&quot;
comma
id|keep
comma
id|discard
comma
id|bad
comma
id|totlen
)paren
suffix:semicolon
)brace
r_return
id|totlen
suffix:semicolon
)brace
DECL|function|konicawc_isoc_irq
r_static
r_void
id|konicawc_isoc_irq
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|i
comma
id|len
op_assign
l_int|0
suffix:semicolon
id|uvd_t
op_star
id|uvd
op_assign
id|urb-&gt;context
suffix:semicolon
r_struct
id|konicawc
op_star
id|cam
op_assign
(paren
r_struct
id|konicawc
op_star
)paren
id|uvd-&gt;user_data
suffix:semicolon
multiline_comment|/* We don&squot;t want to do anything if we are about to be removed! */
r_if
c_cond
(paren
op_logical_neg
id|CAMERA_IS_OPERATIONAL
c_func
(paren
id|uvd
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;actual_length
OG
l_int|32
)paren
(brace
id|cam-&gt;last_data_urb
op_assign
id|urb
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|uvd-&gt;streaming
)paren
(brace
r_if
c_cond
(paren
id|debug
op_ge
l_int|1
)paren
id|info
c_func
(paren
l_string|&quot;Not streaming, but interrupt!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|uvd-&gt;stats.urb_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;actual_length
op_le
l_int|0
)paren
r_goto
id|urb_done_with
suffix:semicolon
multiline_comment|/* Copy the data received into ring queue */
r_if
c_cond
(paren
id|cam-&gt;last_data_urb
)paren
(brace
id|len
op_assign
id|konicawc_compress_iso
c_func
(paren
id|uvd
comma
id|cam-&gt;last_data_urb
comma
id|urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cam-&gt;last_data_urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;last_data_urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
)brace
id|cam-&gt;last_data_urb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|uvd-&gt;stats.urb_length
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
r_goto
id|urb_done_with
suffix:semicolon
)brace
multiline_comment|/* Here we got some data */
id|uvd-&gt;stats.data_count
op_add_assign
id|len
suffix:semicolon
id|RingQueue_WakeUpInterruptible
c_func
(paren
op_amp
id|uvd-&gt;dp
)paren
suffix:semicolon
id|urb_done_with
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|konicawc_start_data
r_static
r_int
id|konicawc_start_data
c_func
(paren
id|uvd_t
op_star
id|uvd
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|uvd-&gt;dev
suffix:semicolon
r_int
id|i
comma
id|errFlag
suffix:semicolon
r_struct
id|konicawc
op_star
id|cam
op_assign
(paren
r_struct
id|konicawc
op_star
)paren
id|uvd-&gt;user_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|CAMERA_IS_OPERATIONAL
c_func
(paren
id|uvd
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Camera is not operational&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|uvd-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Alternate interface 1 is is the biggest frame size */
id|i
op_assign
id|usb_set_interface
c_func
(paren
id|dev
comma
id|uvd-&gt;iface
comma
id|uvd-&gt;ifaceAltActive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;usb_set_interface error&quot;
)paren
suffix:semicolon
id|uvd-&gt;last_error
op_assign
id|i
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* We double buffer the Iso lists */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBVIDEO_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|j
comma
id|k
suffix:semicolon
r_struct
id|urb
op_star
id|urb
op_assign
id|uvd-&gt;sbuf
(braket
id|i
)braket
dot
id|urb
suffix:semicolon
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|urb-&gt;context
op_assign
id|uvd
suffix:semicolon
id|urb-&gt;pipe
op_assign
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
id|uvd-&gt;video_endp
)paren
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|USB_ISO_ASAP
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|uvd-&gt;sbuf
(braket
id|i
)braket
dot
id|data
suffix:semicolon
id|urb-&gt;complete
op_assign
id|konicawc_isoc_irq
suffix:semicolon
id|urb-&gt;number_of_packets
op_assign
id|FRAMES_PER_DESC
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|uvd-&gt;iso_packet_len
op_star
id|FRAMES_PER_DESC
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|k
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|j
op_increment
comma
id|k
op_add_assign
id|uvd-&gt;iso_packet_len
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|j
)braket
dot
id|offset
op_assign
id|k
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|j
)braket
dot
id|length
op_assign
id|uvd-&gt;iso_packet_len
suffix:semicolon
)brace
id|urb
op_assign
id|cam-&gt;sts_urb
(braket
id|i
)braket
suffix:semicolon
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|urb-&gt;context
op_assign
id|uvd
suffix:semicolon
id|urb-&gt;pipe
op_assign
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
id|uvd-&gt;video_endp
op_minus
l_int|1
)paren
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|USB_ISO_ASAP
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|cam-&gt;sts_buf
(braket
id|i
)braket
suffix:semicolon
id|urb-&gt;complete
op_assign
id|konicawc_isoc_irq
suffix:semicolon
id|urb-&gt;number_of_packets
op_assign
id|FRAMES_PER_DESC
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|FRAMES_PER_DESC
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|j
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|j
)braket
dot
id|offset
op_assign
id|j
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|j
)braket
dot
id|length
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Link URBs into a ring so that they invoke each other infinitely */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBVIDEO_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_plus
l_int|1
)paren
OL
id|USBVIDEO_NUMSBUF
)paren
(brace
id|cam-&gt;sts_urb
(braket
id|i
)braket
op_member_access_from_pointer
id|next
op_assign
id|uvd-&gt;sbuf
(braket
id|i
)braket
dot
id|urb
suffix:semicolon
id|uvd-&gt;sbuf
(braket
id|i
)braket
dot
id|urb-&gt;next
op_assign
id|cam-&gt;sts_urb
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
id|cam-&gt;sts_urb
(braket
id|i
)braket
op_member_access_from_pointer
id|next
op_assign
id|uvd-&gt;sbuf
(braket
id|i
)braket
dot
id|urb
suffix:semicolon
id|uvd-&gt;sbuf
(braket
id|i
)braket
dot
id|urb-&gt;next
op_assign
id|cam-&gt;sts_urb
(braket
l_int|0
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/* Submit all URBs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBVIDEO_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|errFlag
op_assign
id|usb_submit_urb
c_func
(paren
id|uvd-&gt;sbuf
(braket
id|i
)braket
dot
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errFlag
)paren
id|err
(paren
l_string|&quot;usb_submit_isoc(%d) ret %d&quot;
comma
id|i
comma
id|errFlag
)paren
suffix:semicolon
id|errFlag
op_assign
id|usb_submit_urb
c_func
(paren
id|cam-&gt;sts_urb
(braket
id|i
)braket
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errFlag
)paren
id|err
c_func
(paren
l_string|&quot;usb_submit_isoc(%d) ret %d&quot;
comma
id|i
comma
id|errFlag
)paren
suffix:semicolon
)brace
id|uvd-&gt;streaming
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|dbg
c_func
(paren
l_string|&quot;streaming=1 video_endp=$%02x&quot;
comma
id|uvd-&gt;video_endp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|konicawc_stop_data
r_static
r_void
id|konicawc_stop_data
c_func
(paren
id|uvd_t
op_star
id|uvd
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|konicawc
op_star
id|cam
op_assign
(paren
r_struct
id|konicawc
op_star
)paren
id|uvd-&gt;user_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|uvd
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|uvd-&gt;streaming
)paren
op_logical_or
(paren
id|uvd-&gt;dev
op_eq
l_int|NULL
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Unschedule all of the iso td&squot;s */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBVIDEO_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|usb_unlink_urb
c_func
(paren
id|uvd-&gt;sbuf
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;usb_unlink_urb() error %d.&quot;
comma
id|j
)paren
suffix:semicolon
id|j
op_assign
id|usb_unlink_urb
c_func
(paren
id|cam-&gt;sts_urb
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;usb_unlink_urb() error %d.&quot;
comma
id|j
)paren
suffix:semicolon
)brace
id|uvd-&gt;streaming
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uvd-&gt;remove_pending
)paren
(brace
multiline_comment|/* Set packet size to 0 */
id|j
op_assign
id|usb_set_interface
c_func
(paren
id|uvd-&gt;dev
comma
id|uvd-&gt;iface
comma
id|uvd-&gt;ifaceAltInactive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;usb_set_interface() error %d.&quot;
comma
id|j
)paren
suffix:semicolon
id|uvd-&gt;last_error
op_assign
id|j
suffix:semicolon
)brace
)brace
)brace
DECL|function|konicawc_process_isoc
r_static
r_void
id|konicawc_process_isoc
c_func
(paren
id|uvd_t
op_star
id|uvd
comma
id|usbvideo_frame_t
op_star
id|frame
)paren
(brace
r_int
id|n
suffix:semicolon
r_int
id|maxline
comma
id|yplanesz
suffix:semicolon
r_struct
id|konicawc
op_star
id|cam
op_assign
(paren
r_struct
id|konicawc
op_star
)paren
id|uvd-&gt;user_data
suffix:semicolon
m_assert
(paren
id|uvd
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|frame
op_ne
l_int|NULL
)paren
suffix:semicolon
id|maxline
op_assign
(paren
id|cam-&gt;height
op_star
id|cam-&gt;width
op_star
l_int|3
)paren
op_div
(paren
l_int|2
op_star
l_int|384
)paren
suffix:semicolon
id|yplanesz
op_assign
id|cam-&gt;height
op_star
id|cam-&gt;width
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|5
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;maxline = %d yplanesz = %d&quot;
comma
id|maxline
comma
id|yplanesz
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|3
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Frame state = %d&quot;
comma
id|frame-&gt;scanstate
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_eq
id|ScanState_Scanning
)paren
(brace
r_int
id|drop
op_assign
l_int|0
suffix:semicolon
r_int
id|curframe
suffix:semicolon
r_int
id|fdrops
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|3
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Searching for marker, queue len = %d&quot;
comma
id|RingQueue_GetLength
c_func
(paren
op_amp
id|uvd-&gt;dp
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|RingQueue_GetLength
c_func
(paren
op_amp
id|uvd-&gt;dp
)paren
op_ge
l_int|4
)paren
(brace
r_if
c_cond
(paren
(paren
id|RING_QUEUE_PEEK
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
l_int|0
)paren
op_eq
l_int|0x00
)paren
op_logical_and
(paren
id|RING_QUEUE_PEEK
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
l_int|1
)paren
op_eq
l_int|0xff
)paren
op_logical_and
(paren
id|RING_QUEUE_PEEK
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
l_int|2
)paren
op_eq
l_int|0x00
)paren
op_logical_and
(paren
id|RING_QUEUE_PEEK
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
l_int|3
)paren
OL
l_int|0x80
)paren
)paren
(brace
id|curframe
op_assign
id|RING_QUEUE_PEEK
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;lastframe
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|curframe
OL
id|cam-&gt;lastframe
)paren
(brace
id|fdrops
op_assign
(paren
id|curframe
op_plus
l_int|0x80
)paren
op_minus
id|cam-&gt;lastframe
suffix:semicolon
)brace
r_else
(brace
id|fdrops
op_assign
id|curframe
op_minus
id|cam-&gt;lastframe
suffix:semicolon
)brace
id|fdrops
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|fdrops
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Dropped %d frames (%d -&gt; %d)&quot;
comma
id|fdrops
comma
id|cam-&gt;lastframe
comma
id|curframe
)paren
suffix:semicolon
)brace
)brace
id|cam-&gt;lastframe
op_assign
id|curframe
suffix:semicolon
id|frame-&gt;curline
op_assign
l_int|0
suffix:semicolon
id|frame-&gt;scanstate
op_assign
id|ScanState_Lines
suffix:semicolon
id|RING_QUEUE_DEQUEUE_BYTES
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|RING_QUEUE_DEQUEUE_BYTES
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
l_int|1
)paren
suffix:semicolon
id|drop
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_eq
id|ScanState_Scanning
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Try to move data from queue into frame buffer &n;&t; * We get data in blocks of 384 bytes made up of:&n;&t; * 256 Y, 64 U, 64 V.&n;&t; * This needs to be written out as a Y plane, a U plane and a V plane.&n;&t; */
r_while
c_loop
(paren
id|frame-&gt;curline
OL
id|maxline
op_logical_and
(paren
id|n
op_assign
id|RingQueue_GetLength
c_func
(paren
op_amp
id|uvd-&gt;dp
)paren
)paren
op_ge
l_int|384
)paren
(brace
multiline_comment|/* Y */
id|RingQueue_Dequeue
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
id|frame-&gt;data
op_plus
(paren
id|frame-&gt;curline
op_star
l_int|256
)paren
comma
l_int|256
)paren
suffix:semicolon
multiline_comment|/* U */
id|RingQueue_Dequeue
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
id|frame-&gt;data
op_plus
id|yplanesz
op_plus
(paren
id|frame-&gt;curline
op_star
l_int|64
)paren
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* V */
id|RingQueue_Dequeue
c_func
(paren
op_amp
id|uvd-&gt;dp
comma
id|frame-&gt;data
op_plus
(paren
l_int|5
op_star
id|yplanesz
)paren
op_div
l_int|4
op_plus
(paren
id|frame-&gt;curline
op_star
l_int|64
)paren
comma
l_int|64
)paren
suffix:semicolon
id|frame-&gt;seqRead_Length
op_add_assign
l_int|384
suffix:semicolon
id|frame-&gt;curline
op_increment
suffix:semicolon
)brace
multiline_comment|/* See if we filled the frame */
r_if
c_cond
(paren
id|frame-&gt;curline
op_eq
id|maxline
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|5
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;got whole frame&quot;
)paren
suffix:semicolon
)brace
id|frame-&gt;frameState
op_assign
id|FrameState_Done_Hold
suffix:semicolon
id|frame-&gt;curline
op_assign
l_int|0
suffix:semicolon
id|uvd-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
id|uvd-&gt;stats.frame_num
op_increment
suffix:semicolon
)brace
)brace
DECL|function|konicawc_calculate_fps
r_static
r_int
id|konicawc_calculate_fps
c_func
(paren
id|uvd_t
op_star
id|uvd
)paren
(brace
r_struct
id|konicawc
op_star
id|t
op_assign
id|uvd-&gt;user_data
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
(paren
id|t-&gt;fps
)paren
op_div
l_int|3
suffix:semicolon
)brace
DECL|function|konicawc_configure_video
r_static
r_void
id|konicawc_configure_video
c_func
(paren
id|uvd_t
op_star
id|uvd
)paren
(brace
r_struct
id|konicawc
op_star
id|cam
op_assign
(paren
r_struct
id|konicawc
op_star
)paren
id|uvd-&gt;user_data
suffix:semicolon
id|u8
id|buf
(braket
l_int|2
)braket
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|uvd-&gt;vpic
comma
l_int|0
comma
r_sizeof
(paren
id|uvd-&gt;vpic
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|uvd-&gt;vpic_old
comma
l_int|0x55
comma
r_sizeof
(paren
id|uvd-&gt;vpic_old
)paren
)paren
suffix:semicolon
id|RESTRICT_TO_RANGE
c_func
(paren
id|brightness
comma
l_int|0
comma
id|MAX_BRIGHTNESS
)paren
suffix:semicolon
id|RESTRICT_TO_RANGE
c_func
(paren
id|contrast
comma
l_int|0
comma
id|MAX_CONTRAST
)paren
suffix:semicolon
id|RESTRICT_TO_RANGE
c_func
(paren
id|saturation
comma
l_int|0
comma
id|MAX_SATURATION
)paren
suffix:semicolon
id|RESTRICT_TO_RANGE
c_func
(paren
id|sharpness
comma
l_int|0
comma
id|MAX_SHARPNESS
)paren
suffix:semicolon
id|RESTRICT_TO_RANGE
c_func
(paren
id|whitebal
comma
l_int|0
comma
id|MAX_WHITEBAL
)paren
suffix:semicolon
id|cam-&gt;brightness
op_assign
id|brightness
op_div
l_int|11
suffix:semicolon
id|cam-&gt;contrast
op_assign
id|contrast
op_div
l_int|11
suffix:semicolon
id|cam-&gt;saturation
op_assign
id|saturation
op_div
l_int|11
suffix:semicolon
id|cam-&gt;sharpness
op_assign
id|sharpness
op_div
l_int|11
suffix:semicolon
id|cam-&gt;white_bal
op_assign
id|whitebal
op_div
l_int|11
suffix:semicolon
id|uvd-&gt;vpic.colour
op_assign
l_int|108
suffix:semicolon
id|uvd-&gt;vpic.hue
op_assign
l_int|108
suffix:semicolon
id|uvd-&gt;vpic.brightness
op_assign
id|brightness
suffix:semicolon
id|uvd-&gt;vpic.contrast
op_assign
id|contrast
suffix:semicolon
id|uvd-&gt;vpic.whiteness
op_assign
id|whitebal
suffix:semicolon
id|uvd-&gt;vpic.depth
op_assign
l_int|6
suffix:semicolon
id|uvd-&gt;vpic.palette
op_assign
id|VIDEO_PALETTE_YUV420P
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|uvd-&gt;vcap
comma
l_int|0
comma
r_sizeof
(paren
id|uvd-&gt;vcap
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|uvd-&gt;vcap.name
comma
l_string|&quot;Konica Webcam&quot;
)paren
suffix:semicolon
id|uvd-&gt;vcap.type
op_assign
id|VID_TYPE_CAPTURE
suffix:semicolon
id|uvd-&gt;vcap.channels
op_assign
l_int|1
suffix:semicolon
id|uvd-&gt;vcap.audios
op_assign
l_int|0
suffix:semicolon
id|uvd-&gt;vcap.maxwidth
op_assign
id|cam-&gt;width
suffix:semicolon
id|uvd-&gt;vcap.maxheight
op_assign
id|cam-&gt;height
suffix:semicolon
id|uvd-&gt;vcap.minwidth
op_assign
id|cam-&gt;width
suffix:semicolon
id|uvd-&gt;vcap.minheight
op_assign
id|cam-&gt;height
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|uvd-&gt;vchan
comma
l_int|0
comma
r_sizeof
(paren
id|uvd-&gt;vchan
)paren
)paren
suffix:semicolon
id|uvd-&gt;vchan.flags
op_assign
l_int|0
suffix:semicolon
id|uvd-&gt;vchan.tuners
op_assign
l_int|0
suffix:semicolon
id|uvd-&gt;vchan.channel
op_assign
l_int|0
suffix:semicolon
id|uvd-&gt;vchan.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|strcpy
c_func
(paren
id|uvd-&gt;vchan.name
comma
l_string|&quot;Camera&quot;
)paren
suffix:semicolon
multiline_comment|/* Talk to device */
id|dbg
c_func
(paren
l_string|&quot;device init&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|konicawc_get_misc
c_func
(paren
id|uvd
comma
l_int|0x3
comma
l_int|0
comma
l_int|0x10
comma
id|buf
comma
l_int|2
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;3,10 -&gt; %2.2x %2.2x&quot;
comma
id|buf
(braket
l_int|0
)braket
comma
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|konicawc_get_misc
c_func
(paren
id|uvd
comma
l_int|0x3
comma
l_int|0
comma
l_int|0x10
comma
id|buf
comma
l_int|2
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;3,10 -&gt; %2.2x %2.2x&quot;
comma
id|buf
(braket
l_int|0
)braket
comma
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|konicawc_set_misc
c_func
(paren
id|uvd
comma
l_int|0x2
comma
l_int|0
comma
l_int|0xd
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;2,0,d failed&quot;
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;setting initial values&quot;
)paren
suffix:semicolon
)brace
DECL|function|konicawc_probe
r_static
r_void
op_star
id|konicawc_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|ifnum
comma
r_const
r_struct
id|usb_device_id
op_star
id|devid
)paren
(brace
id|uvd_t
op_star
id|uvd
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|nas
suffix:semicolon
r_int
id|actInterface
op_assign
op_minus
l_int|1
comma
id|inactInterface
op_assign
op_minus
l_int|1
comma
id|maxPS
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|video_ep
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_ge
l_int|1
)paren
id|dbg
c_func
(paren
l_string|&quot;konicawc_probe(%p,%u.)&quot;
comma
id|dev
comma
id|ifnum
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-config cameras */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
r_return
l_int|NULL
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;Konica Webcam (rev. 0x%04x)&quot;
comma
id|dev-&gt;descriptor.bcdDevice
)paren
suffix:semicolon
multiline_comment|/* Validate found interface: must have one ISO endpoint */
id|nas
op_assign
id|dev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
dot
id|num_altsetting
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|0
)paren
id|info
c_func
(paren
l_string|&quot;Number of alternate settings=%d.&quot;
comma
id|nas
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nas
OL
l_int|8
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Too few alternate settings for this camera!&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Validate all alternate settings */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nas
suffix:semicolon
id|i
op_increment
)paren
(brace
r_const
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
id|interface
op_assign
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bNumEndpoints
op_ne
l_int|2
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Interface %d. has %u. endpoints!&quot;
comma
id|ifnum
comma
(paren
r_int
)paren
(paren
id|interface-&gt;bNumEndpoints
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|1
)braket
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;found endpoint: addr: 0x%2.2x maxps = 0x%4.4x&quot;
comma
id|endpoint-&gt;bEndpointAddress
comma
id|endpoint-&gt;wMaxPacketSize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_ep
op_eq
l_int|0
)paren
id|video_ep
op_assign
id|endpoint-&gt;bEndpointAddress
suffix:semicolon
r_else
r_if
c_cond
(paren
id|video_ep
op_ne
id|endpoint-&gt;bEndpointAddress
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Alternate settings have different endpoint addresses!&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|0x03
)paren
op_ne
l_int|0x01
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Interface %d. has non-ISO endpoint!&quot;
comma
id|ifnum
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Interface %d. has ISO OUT endpoint!&quot;
comma
id|ifnum
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|endpoint-&gt;wMaxPacketSize
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|inactInterface
OL
l_int|0
)paren
id|inactInterface
op_assign
id|i
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;More than one inactive alt. setting!&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|actInterface
OL
l_int|0
)paren
(brace
id|actInterface
op_assign
id|i
suffix:semicolon
id|maxPS
op_assign
id|endpoint-&gt;wMaxPacketSize
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|0
)paren
id|info
c_func
(paren
l_string|&quot;Active setting=%d. maxPS=%d.&quot;
comma
id|i
comma
id|maxPS
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Got another active alt. setting */
r_if
c_cond
(paren
id|maxPS
OL
id|endpoint-&gt;wMaxPacketSize
)paren
(brace
multiline_comment|/* This one is better! */
id|actInterface
op_assign
id|i
suffix:semicolon
id|maxPS
op_assign
id|endpoint-&gt;wMaxPacketSize
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|0
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Even better active setting=%d. maxPS=%d.&quot;
comma
id|i
comma
id|maxPS
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
multiline_comment|/* Code below may sleep, need to lock module while we are here */
id|MOD_INC_USE_COUNT
suffix:semicolon
id|uvd
op_assign
id|usbvideo_AllocateDevice
c_func
(paren
id|cams
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uvd
op_ne
l_int|NULL
)paren
(brace
r_struct
id|konicawc
op_star
id|konicawc_data
op_assign
(paren
r_struct
id|konicawc
op_star
)paren
(paren
id|uvd-&gt;user_data
)paren
suffix:semicolon
multiline_comment|/* Here uvd is a fully allocated uvd_t object */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBVIDEO_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|konicawc_data-&gt;sts_urb
(braket
id|i
)braket
op_assign
id|usb_alloc_urb
c_func
(paren
id|FRAMES_PER_DESC
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
id|SIZE_160X130
suffix:colon
r_default
suffix:colon
id|konicawc_data-&gt;height
op_assign
l_int|136
suffix:semicolon
id|konicawc_data-&gt;width
op_assign
l_int|160
suffix:semicolon
id|konicawc_data-&gt;size
op_assign
id|SIZE_160X130
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIZE_176X144
suffix:colon
id|konicawc_data-&gt;height
op_assign
l_int|144
suffix:semicolon
id|konicawc_data-&gt;width
op_assign
l_int|176
suffix:semicolon
id|konicawc_data-&gt;size
op_assign
id|SIZE_176X144
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIZE_320X240
suffix:colon
id|konicawc_data-&gt;height
op_assign
l_int|240
suffix:semicolon
id|konicawc_data-&gt;width
op_assign
l_int|320
suffix:semicolon
id|konicawc_data-&gt;size
op_assign
id|SIZE_320X240
suffix:semicolon
r_break
suffix:semicolon
)brace
id|uvd-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|uvd-&gt;debug
op_assign
id|debug
suffix:semicolon
id|uvd-&gt;dev
op_assign
id|dev
suffix:semicolon
id|uvd-&gt;iface
op_assign
id|ifnum
suffix:semicolon
id|uvd-&gt;ifaceAltInactive
op_assign
id|inactInterface
suffix:semicolon
id|uvd-&gt;ifaceAltActive
op_assign
id|actInterface
suffix:semicolon
id|uvd-&gt;video_endp
op_assign
id|video_ep
suffix:semicolon
id|uvd-&gt;iso_packet_len
op_assign
id|maxPS
suffix:semicolon
id|uvd-&gt;paletteBits
op_assign
l_int|1L
op_lshift
id|VIDEO_PALETTE_YUV420P
suffix:semicolon
id|uvd-&gt;defaultPalette
op_assign
id|VIDEO_PALETTE_YUV420P
suffix:semicolon
id|uvd-&gt;canvas
op_assign
id|VIDEOSIZE
c_func
(paren
id|konicawc_data-&gt;width
comma
id|konicawc_data-&gt;height
)paren
suffix:semicolon
id|uvd-&gt;videosize
op_assign
id|uvd-&gt;canvas
suffix:semicolon
multiline_comment|/* Initialize konicawc specific data */
id|konicawc_configure_video
c_func
(paren
id|uvd
)paren
suffix:semicolon
id|i
op_assign
id|usbvideo_RegisterVideoDevice
c_func
(paren
id|uvd
)paren
suffix:semicolon
id|uvd-&gt;max_frame_size
op_assign
(paren
id|konicawc_data-&gt;width
op_star
id|konicawc_data-&gt;height
op_star
l_int|3
)paren
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;usbvideo_RegisterVideoDevice() failed.&quot;
)paren
suffix:semicolon
id|uvd
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|uvd
suffix:semicolon
)brace
DECL|function|konicawc_init
r_static
r_int
id|__init
id|konicawc_init
c_func
(paren
r_void
)paren
(brace
id|usbvideo_cb_t
id|cbTbl
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cbTbl
comma
l_int|0
comma
r_sizeof
(paren
id|cbTbl
)paren
)paren
suffix:semicolon
id|cbTbl.probe
op_assign
id|konicawc_probe
suffix:semicolon
id|cbTbl.setupOnOpen
op_assign
id|konicawc_setup_on_open
suffix:semicolon
id|cbTbl.processData
op_assign
id|konicawc_process_isoc
suffix:semicolon
id|cbTbl.getFPS
op_assign
id|konicawc_calculate_fps
suffix:semicolon
id|cbTbl.startDataPump
op_assign
id|konicawc_start_data
suffix:semicolon
id|cbTbl.stopDataPump
op_assign
id|konicawc_stop_data
suffix:semicolon
r_return
id|usbvideo_register
c_func
(paren
op_amp
id|cams
comma
id|MAX_CAMERAS
comma
r_sizeof
(paren
r_struct
id|konicawc
)paren
comma
l_string|&quot;konicawc&quot;
comma
op_amp
id|cbTbl
comma
id|THIS_MODULE
)paren
suffix:semicolon
)brace
DECL|function|konicawc_cleanup
r_static
r_void
id|__exit
id|konicawc_cleanup
c_func
(paren
r_void
)paren
(brace
id|usbvideo_Deregister
c_func
(paren
op_amp
id|cams
)paren
suffix:semicolon
)brace
macro_line|#if defined(usb_device_id_ver)
DECL|variable|id_table
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|id_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x04c8
comma
l_int|0x0720
)paren
)brace
comma
multiline_comment|/* Intel YC 76 */
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|usb
comma
id|id_table
)paren
suffix:semicolon
macro_line|#endif /* defined(usb_device_id_ver) */
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Simon Evans &lt;spse@secret.org.uk&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Konica Webcam driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|size
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|size
comma
l_string|&quot;Frame Size 0: 160x136 1: 176x144 2: 320x240&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|brightness
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|brightness
comma
l_string|&quot;Initial brightness 0 - 108&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|contrast
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|contrast
comma
l_string|&quot;Initial contrast 0 - 108&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|saturation
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|saturation
comma
l_string|&quot;Initial saturation 0 - 108&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sharpness
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|sharpness
comma
l_string|&quot;Initial brightness 0 - 108&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|whitebal
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|whitebal
comma
l_string|&quot;Initial white balance 0 - 363&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug level: 0-9 (default=0)&quot;
)paren
suffix:semicolon
DECL|variable|konicawc_init
id|module_init
c_func
(paren
id|konicawc_init
)paren
suffix:semicolon
DECL|variable|konicawc_cleanup
id|module_exit
c_func
(paren
id|konicawc_cleanup
)paren
suffix:semicolon
eof
