multiline_comment|/*&n; * OmniVision OV511 Camera-to-USB Bridge Driver&n; *&n; * Copyright (c) 1999-2002 Mark W. McClelland&n; * Original decompression code Copyright 1998-2000 OmniVision Technologies&n; * Many improvements by Bret Wallach &lt;bwallac1@san.rr.com&gt;&n; * Color fixes by by Orion Sky Lawlor &lt;olawlor@acm.org&gt; (2/26/2000)&n; * Snapshot code by Kevin Moore&n; * OV7620 fixes by Charl P. Botha &lt;cpbotha@ieee.org&gt;&n; * Changes by Claudio Matsuoka &lt;claudio@conectiva.com&gt;&n; * Original SAA7111A code by Dave Perks &lt;dperks@ibm.net&gt;&n; * Kernel I2C interface adapted from nt1003 driver&n; * URB error messages from pwc driver by Nemosoft&n; * generic_ioctl() code from videodev.c by Gerd Knorr and Alan Cox&n; *&n; * Based on the Linux CPiA driver written by Peter Pregler,&n; * Scott J. Bertin and Johannes Erdfelt.&n; * &n; * Please see the file: linux/Documentation/usb/ov511.txt &n; * and the website at:  http://alpha.dyndns.org/ov511&n; * for more info.&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY&n; * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; * for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#if defined (__i386__)
macro_line|#include &lt;asm/cpufeature.h&gt;
macro_line|#endif
multiline_comment|/* A new implementation of the V4L 1 API exists that gives drivers direct&n; * access to file_operations. The old API is compatible with all 2.2 and 2.4&n; * kernels, and all 2.5 kernels through 2.5.5 (at least).&n; *&n; * Remove this #define to enable the new API&n; *&n; * Note: This has nothing to do with the V4L 2 API.&n; */
DECL|macro|OV511_OLD_V4L
mdefine_line|#define OV511_OLD_V4L
macro_line|#include &quot;ov511.h&quot;
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v1.53 for Linux 2.5&quot;
DECL|macro|EMAIL
mdefine_line|#define EMAIL &quot;mmcclell@bigfoot.com&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Mark McClelland &lt;mmcclell@bigfoot.com&gt; &amp; Bret Wallach &bslash;&n;&t;&amp; Orion Sky Lawlor &lt;olawlor@acm.org&gt; &amp; Kevin Moore &amp; Charl P. Botha &bslash;&n;&t;&lt;cpbotha@ieee.org&gt; &amp; Claudio Matsuoka &lt;claudio@conectiva.com&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;ov511 USB Camera Driver&quot;
DECL|macro|OV511_I2C_RETRIES
mdefine_line|#define OV511_I2C_RETRIES 3
DECL|macro|ENABLE_Y_QUANTABLE
mdefine_line|#define ENABLE_Y_QUANTABLE 1
DECL|macro|ENABLE_UV_QUANTABLE
mdefine_line|#define ENABLE_UV_QUANTABLE 1
multiline_comment|/* If you change this, you must also change the MODULE_PARM definition */
DECL|macro|OV511_MAX_UNIT_VIDEO
mdefine_line|#define OV511_MAX_UNIT_VIDEO 16
multiline_comment|/* Pixel count * 3 bytes for RGB */
DECL|macro|MAX_FRAME_SIZE
mdefine_line|#define MAX_FRAME_SIZE(w, h) ((w) * (h) * 3)
DECL|macro|MAX_DATA_SIZE
mdefine_line|#define MAX_DATA_SIZE(w, h) (MAX_FRAME_SIZE(w, h) + sizeof(struct timeval))
multiline_comment|/* Max size * bytes per YUV420 pixel (1.5) + one extra isoc frame for safety */
DECL|macro|MAX_RAW_DATA_SIZE
mdefine_line|#define MAX_RAW_DATA_SIZE(w, h) ((w) * (h) * 3 / 2 + 1024)
DECL|macro|FATAL_ERROR
mdefine_line|#define FATAL_ERROR(rc) ((rc) &lt; 0 &amp;&amp; (rc) != -EPERM)
multiline_comment|/**********************************************************************&n; * Module Parameters&n; * (See ov511.txt for detailed descriptions of these)&n; **********************************************************************/
multiline_comment|/* These variables (and all static globals) default to zero */
DECL|variable|autobright
r_static
r_int
id|autobright
op_assign
l_int|1
suffix:semicolon
DECL|variable|autogain
r_static
r_int
id|autogain
op_assign
l_int|1
suffix:semicolon
DECL|variable|autoexp
r_static
r_int
id|autoexp
op_assign
l_int|1
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|variable|fix_rgb_offset
r_static
r_int
id|fix_rgb_offset
suffix:semicolon
DECL|variable|snapshot
r_static
r_int
id|snapshot
suffix:semicolon
DECL|variable|force_rgb
r_static
r_int
id|force_rgb
suffix:semicolon
DECL|variable|buf_timeout
r_static
r_int
id|buf_timeout
op_assign
l_int|5
suffix:semicolon
DECL|variable|cams
r_static
r_int
id|cams
op_assign
l_int|1
suffix:semicolon
DECL|variable|compress
r_static
r_int
id|compress
suffix:semicolon
DECL|variable|testpat
r_static
r_int
id|testpat
suffix:semicolon
DECL|variable|sensor_gbr
r_static
r_int
id|sensor_gbr
suffix:semicolon
DECL|variable|dumppix
r_static
r_int
id|dumppix
suffix:semicolon
DECL|variable|led
r_static
r_int
id|led
op_assign
l_int|1
suffix:semicolon
DECL|variable|dump_bridge
r_static
r_int
id|dump_bridge
suffix:semicolon
DECL|variable|dump_sensor
r_static
r_int
id|dump_sensor
suffix:semicolon
DECL|variable|printph
r_static
r_int
id|printph
suffix:semicolon
DECL|variable|phy
r_static
r_int
id|phy
op_assign
l_int|0x1f
suffix:semicolon
DECL|variable|phuv
r_static
r_int
id|phuv
op_assign
l_int|0x05
suffix:semicolon
DECL|variable|pvy
r_static
r_int
id|pvy
op_assign
l_int|0x06
suffix:semicolon
DECL|variable|pvuv
r_static
r_int
id|pvuv
op_assign
l_int|0x06
suffix:semicolon
DECL|variable|qhy
r_static
r_int
id|qhy
op_assign
l_int|0x14
suffix:semicolon
DECL|variable|qhuv
r_static
r_int
id|qhuv
op_assign
l_int|0x03
suffix:semicolon
DECL|variable|qvy
r_static
r_int
id|qvy
op_assign
l_int|0x04
suffix:semicolon
DECL|variable|qvuv
r_static
r_int
id|qvuv
op_assign
l_int|0x04
suffix:semicolon
DECL|variable|lightfreq
r_static
r_int
id|lightfreq
suffix:semicolon
DECL|variable|bandingfilter
r_static
r_int
id|bandingfilter
suffix:semicolon
multiline_comment|/* Pixel clock divisor */
DECL|variable|clockdiv
r_static
r_int
id|clockdiv
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Isoc packet size */
DECL|variable|packetsize
r_static
r_int
id|packetsize
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Frame drop register (16h) */
DECL|variable|framedrop
r_static
r_int
id|framedrop
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|fastset
r_static
r_int
id|fastset
suffix:semicolon
DECL|variable|force_palette
r_static
r_int
id|force_palette
suffix:semicolon
DECL|variable|tuner
r_static
r_int
id|tuner
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|backlight
r_static
r_int
id|backlight
suffix:semicolon
DECL|variable|unit_video
r_static
r_int
id|unit_video
(braket
id|OV511_MAX_UNIT_VIDEO
)braket
suffix:semicolon
DECL|variable|remove_zeros
r_static
r_int
id|remove_zeros
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|autobright
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|autobright
comma
l_string|&quot;Sensor automatically changes brightness&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|autogain
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|autogain
comma
l_string|&quot;Sensor automatically changes gain&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|autoexp
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|autoexp
comma
l_string|&quot;Sensor automatically changes exposure&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug level: 0=none, 1=inits, 2=warning, 3=config, 4=functions, 5=max&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fix_rgb_offset
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|fix_rgb_offset
comma
l_string|&quot;Fix vertical misalignment of red and blue at 640x480&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snapshot
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snapshot
comma
l_string|&quot;Enable snapshot mode&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|force_rgb
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|force_rgb
comma
l_string|&quot;Read RGB instead of BGR&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|buf_timeout
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|buf_timeout
comma
l_string|&quot;Number of seconds before buffer deallocation&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cams
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|cams
comma
l_string|&quot;Number of simultaneous cameras&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|compress
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|compress
comma
l_string|&quot;Turn on compression (not reliable yet)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|testpat
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|testpat
comma
l_string|&quot;Replace image with vertical bar testpattern (only partially working)&quot;
)paren
suffix:semicolon
singleline_comment|// Temporarily removed (needs to be rewritten for new format conversion code)
singleline_comment|// MODULE_PARM(sensor_gbr, &quot;i&quot;);
singleline_comment|// MODULE_PARM_DESC(sensor_gbr, &quot;Make sensor output GBR422 rather than YUV420&quot;);
id|MODULE_PARM
c_func
(paren
id|dumppix
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dumppix
comma
l_string|&quot;Dump raw pixel data&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|led
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|led
comma
l_string|&quot;LED policy (OV511+ or later). 0=off, 1=on (default), 2=auto (on when open)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dump_bridge
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dump_bridge
comma
l_string|&quot;Dump the bridge registers&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dump_sensor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dump_sensor
comma
l_string|&quot;Dump the sensor registers&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|printph
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|printph
comma
l_string|&quot;Print frame start/end headers&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|phy
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|phy
comma
l_string|&quot;Prediction range (horiz. Y)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|phuv
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|phuv
comma
l_string|&quot;Prediction range (horiz. UV)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pvy
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pvy
comma
l_string|&quot;Prediction range (vert. Y)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pvuv
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pvuv
comma
l_string|&quot;Prediction range (vert. UV)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|qhy
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|qhy
comma
l_string|&quot;Quantization threshold (horiz. Y)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|qhuv
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|qhuv
comma
l_string|&quot;Quantization threshold (horiz. UV)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|qvy
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|qvy
comma
l_string|&quot;Quantization threshold (vert. Y)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|qvuv
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|qvuv
comma
l_string|&quot;Quantization threshold (vert. UV)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|lightfreq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|lightfreq
comma
l_string|&quot;Light frequency. Set to 50 or 60 Hz, or zero for default settings&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|bandingfilter
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|bandingfilter
comma
l_string|&quot;Enable banding filter (to reduce effects of fluorescent lighting)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|clockdiv
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|clockdiv
comma
l_string|&quot;Force pixel clock divisor to a specific value&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|packetsize
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|packetsize
comma
l_string|&quot;Force a specific isoc packet size&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|framedrop
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|framedrop
comma
l_string|&quot;Force a specific frame drop register setting&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fastset
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|fastset
comma
l_string|&quot;Allows picture settings to take effect immediately&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|force_palette
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|force_palette
comma
l_string|&quot;Force the palette to a specific value&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tuner
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tuner
comma
l_string|&quot;Set tuner type, if not autodetected&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|backlight
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|backlight
comma
l_string|&quot;For objects that are lit from behind&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|unit_video
comma
l_string|&quot;0-16i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|unit_video
comma
l_string|&quot;Force use of specific minor number(s). 0 is not allowed.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|remove_zeros
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|remove_zeros
comma
l_string|&quot;Remove zero-padding from uncompressed incoming data&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/**********************************************************************&n; * Miscellaneous Globals&n; **********************************************************************/
DECL|variable|ov511_driver
r_static
r_struct
id|usb_driver
id|ov511_driver
suffix:semicolon
DECL|variable|ov511_decomp_ops
r_static
r_struct
id|ov51x_decomp_ops
op_star
id|ov511_decomp_ops
suffix:semicolon
DECL|variable|ov511_mmx_decomp_ops
r_static
r_struct
id|ov51x_decomp_ops
op_star
id|ov511_mmx_decomp_ops
suffix:semicolon
DECL|variable|ov518_decomp_ops
r_static
r_struct
id|ov51x_decomp_ops
op_star
id|ov518_decomp_ops
suffix:semicolon
DECL|variable|ov518_mmx_decomp_ops
r_static
r_struct
id|ov51x_decomp_ops
op_star
id|ov518_mmx_decomp_ops
suffix:semicolon
multiline_comment|/* Number of times to retry a failed I2C transaction. Increase this if you&n; * are getting &quot;Failed to read sensor ID...&quot; */
DECL|variable|i2c_detect_tries
r_static
r_int
id|i2c_detect_tries
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* MMX support is present in kernel and CPU. Checked upon decomp module load. */
DECL|variable|ov51x_mmx_available
r_static
r_int
id|ov51x_mmx_available
suffix:semicolon
DECL|variable|device_table
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|device_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|VEND_OMNIVISION
comma
id|PROD_OV511
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|VEND_OMNIVISION
comma
id|PROD_OV511PLUS
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|VEND_OMNIVISION
comma
id|PROD_OV518
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|VEND_OMNIVISION
comma
id|PROD_OV518PLUS
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|VEND_MATTEL
comma
id|PROD_ME2CAM
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|device_table
)paren
suffix:semicolon
DECL|variable|yQuanTable511
r_static
r_int
r_char
id|yQuanTable511
(braket
)braket
op_assign
id|OV511_YQUANTABLE
suffix:semicolon
DECL|variable|uvQuanTable511
r_static
r_int
r_char
id|uvQuanTable511
(braket
)braket
op_assign
id|OV511_UVQUANTABLE
suffix:semicolon
DECL|variable|yQuanTable518
r_static
r_int
r_char
id|yQuanTable518
(braket
)braket
op_assign
id|OV518_YQUANTABLE
suffix:semicolon
DECL|variable|uvQuanTable518
r_static
r_int
r_char
id|uvQuanTable518
(braket
)braket
op_assign
id|OV518_UVQUANTABLE
suffix:semicolon
multiline_comment|/**********************************************************************&n; * Symbolic Names&n; **********************************************************************/
multiline_comment|/* Known OV511-based cameras */
DECL|variable|camlist
r_static
r_struct
id|symbolic_list
id|camlist
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_string|&quot;Generic Camera (no ID)&quot;
)brace
comma
(brace
l_int|1
comma
l_string|&quot;Mustek WCam 3X&quot;
)brace
comma
(brace
l_int|3
comma
l_string|&quot;D-Link DSB-C300&quot;
)brace
comma
(brace
l_int|4
comma
l_string|&quot;Generic OV511/OV7610&quot;
)brace
comma
(brace
l_int|5
comma
l_string|&quot;Puretek PT-6007&quot;
)brace
comma
(brace
l_int|6
comma
l_string|&quot;Lifeview USB Life TV (NTSC)&quot;
)brace
comma
(brace
l_int|21
comma
l_string|&quot;Creative Labs WebCam 3&quot;
)brace
comma
(brace
l_int|36
comma
l_string|&quot;Koala-Cam&quot;
)brace
comma
(brace
l_int|38
comma
l_string|&quot;Lifeview USB Life TV&quot;
)brace
comma
(brace
l_int|41
comma
l_string|&quot;Samsung Anycam MPC-M10&quot;
)brace
comma
(brace
l_int|43
comma
l_string|&quot;Mtekvision Zeca MV402&quot;
)brace
comma
(brace
l_int|46
comma
l_string|&quot;Suma eON&quot;
)brace
comma
(brace
l_int|100
comma
l_string|&quot;Lifeview RoboCam&quot;
)brace
comma
(brace
l_int|102
comma
l_string|&quot;AverMedia InterCam Elite&quot;
)brace
comma
(brace
l_int|112
comma
l_string|&quot;MediaForte MV300&quot;
)brace
comma
multiline_comment|/* or OV7110 evaluation kit */
(brace
l_int|192
comma
l_string|&quot;Webeye 2000B&quot;
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Video4Linux1 Palettes */
DECL|variable|v4l1_plist
r_static
r_struct
id|symbolic_list
id|v4l1_plist
(braket
)braket
op_assign
(brace
(brace
id|VIDEO_PALETTE_GREY
comma
l_string|&quot;GREY&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_HI240
comma
l_string|&quot;HI240&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RGB565
comma
l_string|&quot;RGB565&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RGB24
comma
l_string|&quot;RGB24&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RGB32
comma
l_string|&quot;RGB32&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RGB555
comma
l_string|&quot;RGB555&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV422
comma
l_string|&quot;YUV422&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUYV
comma
l_string|&quot;YUYV&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_UYVY
comma
l_string|&quot;UYVY&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV420
comma
l_string|&quot;YUV420&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV411
comma
l_string|&quot;YUV411&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RAW
comma
l_string|&quot;RAW&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV422P
comma
l_string|&quot;YUV422P&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV411P
comma
l_string|&quot;YUV411P&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV420P
comma
l_string|&quot;YUV420P&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV410P
comma
l_string|&quot;YUV410P&quot;
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|brglist
r_static
r_struct
id|symbolic_list
id|brglist
(braket
)braket
op_assign
(brace
(brace
id|BRG_OV511
comma
l_string|&quot;OV511&quot;
)brace
comma
(brace
id|BRG_OV511PLUS
comma
l_string|&quot;OV511+&quot;
)brace
comma
(brace
id|BRG_OV518
comma
l_string|&quot;OV518&quot;
)brace
comma
(brace
id|BRG_OV518PLUS
comma
l_string|&quot;OV518+&quot;
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|senlist
r_static
r_struct
id|symbolic_list
id|senlist
(braket
)braket
op_assign
(brace
(brace
id|SEN_OV76BE
comma
l_string|&quot;OV76BE&quot;
)brace
comma
(brace
id|SEN_OV7610
comma
l_string|&quot;OV7610&quot;
)brace
comma
(brace
id|SEN_OV7620
comma
l_string|&quot;OV7620&quot;
)brace
comma
(brace
id|SEN_OV7620AE
comma
l_string|&quot;OV7620AE&quot;
)brace
comma
(brace
id|SEN_OV6620
comma
l_string|&quot;OV6620&quot;
)brace
comma
(brace
id|SEN_OV6630
comma
l_string|&quot;OV6630&quot;
)brace
comma
(brace
id|SEN_OV6630AE
comma
l_string|&quot;OV6630AE&quot;
)brace
comma
(brace
id|SEN_OV6630AF
comma
l_string|&quot;OV6630AF&quot;
)brace
comma
(brace
id|SEN_OV8600
comma
l_string|&quot;OV8600&quot;
)brace
comma
(brace
id|SEN_KS0127
comma
l_string|&quot;KS0127&quot;
)brace
comma
(brace
id|SEN_KS0127B
comma
l_string|&quot;KS0127B&quot;
)brace
comma
(brace
id|SEN_SAA7111A
comma
l_string|&quot;SAA7111A&quot;
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* URB error codes: */
DECL|variable|urb_errlist
r_static
r_struct
id|symbolic_list
id|urb_errlist
(braket
)braket
op_assign
(brace
(brace
op_minus
id|ENOSR
comma
l_string|&quot;Buffer error (overrun)&quot;
)brace
comma
(brace
op_minus
id|EPIPE
comma
l_string|&quot;Stalled (device not responding)&quot;
)brace
comma
(brace
op_minus
id|EOVERFLOW
comma
l_string|&quot;Babble (bad cable?)&quot;
)brace
comma
(brace
op_minus
id|EPROTO
comma
l_string|&quot;Bit-stuff error (bad cable?)&quot;
)brace
comma
(brace
op_minus
id|EILSEQ
comma
l_string|&quot;CRC/Timeout&quot;
)brace
comma
(brace
op_minus
id|ETIMEDOUT
comma
l_string|&quot;NAK (device does not respond)&quot;
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/**********************************************************************&n; * Prototypes&n; **********************************************************************/
r_static
r_void
id|ov51x_clear_snapshot
c_func
(paren
r_struct
id|usb_ov511
op_star
)paren
suffix:semicolon
r_static
r_int
id|ov51x_check_snapshot
c_func
(paren
r_struct
id|usb_ov511
op_star
)paren
suffix:semicolon
r_static
r_inline
r_int
id|sensor_get_picture
c_func
(paren
r_struct
id|usb_ov511
op_star
comma
r_struct
id|video_picture
op_star
)paren
suffix:semicolon
r_static
r_int
id|sensor_get_exposure
c_func
(paren
r_struct
id|usb_ov511
op_star
comma
r_int
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|ov51x_control_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/**********************************************************************&n; *&n; * Memory management&n; *&n; **********************************************************************/
multiline_comment|/* Here we want the physical address of the memory.&n; * This is used when initializing the contents of the area.&n; */
r_static
r_inline
r_int
r_int
DECL|function|kvirt_to_pa
id|kvirt_to_pa
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|kva
comma
id|ret
suffix:semicolon
id|kva
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|vmalloc_to_page
c_func
(paren
(paren
r_void
op_star
)paren
id|adr
)paren
)paren
suffix:semicolon
id|kva
op_or_assign
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* restore the offset */
id|ret
op_assign
id|__pa
c_func
(paren
id|kva
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
op_star
DECL|function|rvmalloc
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
id|mem
op_assign
id|vmalloc_32
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|mem_map_reserve
c_func
(paren
id|vmalloc_to_page
c_func
(paren
(paren
r_void
op_star
)paren
id|adr
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_return
id|mem
suffix:semicolon
)brace
r_static
r_void
DECL|function|rvfree
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
(paren
r_int
)paren
id|size
OG
l_int|0
)paren
(brace
id|mem_map_unreserve
c_func
(paren
id|vmalloc_to_page
c_func
(paren
(paren
r_void
op_star
)paren
id|adr
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; * /proc interface&n; * Based on the CPiA driver version 0.7.4 -claudio&n; **********************************************************************/
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
DECL|variable|ov511_proc_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|ov511_proc_entry
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_struct
id|proc_dir_entry
op_star
id|video_proc_entry
suffix:semicolon
DECL|variable|ov511_control_fops
r_static
r_struct
id|file_operations
id|ov511_control_fops
op_assign
(brace
id|ioctl
suffix:colon
id|ov51x_control_ioctl
comma
)brace
suffix:semicolon
DECL|macro|YES_NO
mdefine_line|#define YES_NO(x) ((x) ? &quot;yes&quot; : &quot;no&quot;)
multiline_comment|/* /proc/video/ov511/&lt;minor#&gt;/info */
r_static
r_int
DECL|function|ov511_read_proc_info
id|ov511_read_proc_info
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|out
op_assign
id|page
suffix:semicolon
r_int
id|i
comma
id|len
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov
op_assign
id|data
suffix:semicolon
r_struct
id|video_picture
id|p
suffix:semicolon
r_int
r_char
id|exp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov
op_logical_or
op_logical_neg
id|ov-&gt;dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sensor_get_picture
c_func
(paren
id|ov
comma
op_amp
id|p
)paren
suffix:semicolon
id|sensor_get_exposure
c_func
(paren
id|ov
comma
op_amp
id|exp
)paren
suffix:semicolon
multiline_comment|/* IMPORTANT: This output MUST be kept under PAGE_SIZE&n;&t; *            or we need to get more sophisticated. */
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;driver_version  : %s&bslash;n&quot;
comma
id|DRIVER_VERSION
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;custom_id       : %d&bslash;n&quot;
comma
id|ov-&gt;customid
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;model           : %s&bslash;n&quot;
comma
id|ov-&gt;desc
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;streaming       : %s&bslash;n&quot;
comma
id|YES_NO
c_func
(paren
id|ov-&gt;streaming
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;grabbing        : %s&bslash;n&quot;
comma
id|YES_NO
c_func
(paren
id|ov-&gt;grabbing
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;compress        : %s&bslash;n&quot;
comma
id|YES_NO
c_func
(paren
id|ov-&gt;compress
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;subcapture      : %s&bslash;n&quot;
comma
id|YES_NO
c_func
(paren
id|ov-&gt;sub_flag
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;sub_size        : %d %d %d %d&bslash;n&quot;
comma
id|ov-&gt;subx
comma
id|ov-&gt;suby
comma
id|ov-&gt;subw
comma
id|ov-&gt;subh
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;data_format     : %s&bslash;n&quot;
comma
id|force_rgb
ques
c_cond
l_string|&quot;RGB&quot;
suffix:colon
l_string|&quot;BGR&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;brightness      : %d&bslash;n&quot;
comma
id|p.brightness
op_rshift
l_int|8
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;colour          : %d&bslash;n&quot;
comma
id|p.colour
op_rshift
l_int|8
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;contrast        : %d&bslash;n&quot;
comma
id|p.contrast
op_rshift
l_int|8
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;hue             : %d&bslash;n&quot;
comma
id|p.hue
op_rshift
l_int|8
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;exposure        : %d&bslash;n&quot;
comma
id|exp
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;num_frames      : %d&bslash;n&quot;
comma
id|OV511_NUMFRAMES
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;frame           : %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;  depth         : %d&bslash;n&quot;
comma
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|depth
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;  size          : %d %d&bslash;n&quot;
comma
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|width
comma
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|height
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;  format        : %s&bslash;n&quot;
comma
id|symbolic
c_func
(paren
id|v4l1_plist
comma
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|format
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;  data_buffer   : 0x%p&bslash;n&quot;
comma
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;snap_enabled    : %s&bslash;n&quot;
comma
id|YES_NO
c_func
(paren
id|ov-&gt;snap_enabled
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;bridge          : %s&bslash;n&quot;
comma
id|symbolic
c_func
(paren
id|brglist
comma
id|ov-&gt;bridge
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;sensor          : %s&bslash;n&quot;
comma
id|symbolic
c_func
(paren
id|senlist
comma
id|ov-&gt;sensor
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;packet_size     : %d&bslash;n&quot;
comma
id|ov-&gt;packet_size
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;framebuffer     : 0x%p&bslash;n&quot;
comma
id|ov-&gt;fbuf
)paren
suffix:semicolon
id|len
op_assign
id|out
op_minus
id|page
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|len
op_assign
id|count
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* /proc/video/ov511/&lt;minor#&gt;/button&n; *&n; * When the camera&squot;s button is pressed, the output of this will change from a&n; * 0 to a 1 (ASCII). It will retain this value until it is read, after which&n; * it will reset to zero.&n; * &n; * SECURITY NOTE: Since reading this file can change the state of the snapshot&n; * status, it is important for applications that open it to keep it locked&n; * against access by other processes, using flock() or a similar mechanism. No&n; * locking is provided by this driver.&n; */
r_static
r_int
DECL|function|ov511_read_proc_button
id|ov511_read_proc_button
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|out
op_assign
id|page
suffix:semicolon
r_int
id|len
comma
id|status
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov
op_logical_or
op_logical_neg
id|ov-&gt;dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|status
op_assign
id|ov51x_check_snapshot
c_func
(paren
id|ov
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;%d&quot;
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|ov51x_clear_snapshot
c_func
(paren
id|ov
)paren
suffix:semicolon
id|len
op_assign
id|out
op_minus
id|page
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|count
suffix:semicolon
)brace
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_void
DECL|function|create_proc_ov511_cam
id|create_proc_ov511_cam
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_char
id|dirname
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511_proc_entry
op_logical_or
op_logical_neg
id|ov
)paren
r_return
suffix:semicolon
multiline_comment|/* Create per-device directory */
id|snprintf
c_func
(paren
id|dirname
comma
l_int|10
comma
l_string|&quot;%d&quot;
comma
id|ov-&gt;vdev.minor
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;creating /proc/video/ov511/%s/&quot;
comma
id|dirname
)paren
suffix:semicolon
id|ov-&gt;proc_devdir
op_assign
id|create_proc_entry
c_func
(paren
id|dirname
comma
id|S_IFDIR
comma
id|ov511_proc_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;proc_devdir
)paren
r_return
suffix:semicolon
id|ov-&gt;proc_devdir-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
multiline_comment|/* Create &quot;info&quot; entry (human readable device information) */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;creating /proc/video/ov511/%s/info&quot;
comma
id|dirname
)paren
suffix:semicolon
id|ov-&gt;proc_info
op_assign
id|create_proc_read_entry
c_func
(paren
l_string|&quot;info&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|ov-&gt;proc_devdir
comma
id|ov511_read_proc_info
comma
id|ov
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;proc_info
)paren
r_return
suffix:semicolon
id|ov-&gt;proc_info-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
multiline_comment|/* Don&squot;t create it if old snapshot mode on (would cause race cond.) */
r_if
c_cond
(paren
op_logical_neg
id|snapshot
)paren
(brace
multiline_comment|/* Create &quot;button&quot; entry (snapshot button status) */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;creating /proc/video/ov511/%s/button&quot;
comma
id|dirname
)paren
suffix:semicolon
id|ov-&gt;proc_button
op_assign
id|create_proc_read_entry
c_func
(paren
l_string|&quot;button&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|ov-&gt;proc_devdir
comma
id|ov511_read_proc_button
comma
id|ov
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;proc_button
)paren
r_return
suffix:semicolon
)brace
id|ov-&gt;proc_button-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
multiline_comment|/* Create &quot;control&quot; entry (ioctl() interface) */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;creating /proc/video/ov511/%s/control&quot;
comma
id|dirname
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ov-&gt;proc_control
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;control&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|ov-&gt;proc_devdir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;proc_control
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ov-&gt;proc_control-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|ov-&gt;proc_control-&gt;data
op_assign
id|ov
suffix:semicolon
id|ov-&gt;proc_control-&gt;proc_fops
op_assign
op_amp
id|ov511_control_fops
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|destroy_proc_ov511_cam
id|destroy_proc_ov511_cam
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_char
id|dirname
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov
op_logical_or
op_logical_neg
id|ov-&gt;proc_devdir
)paren
r_return
suffix:semicolon
id|snprintf
c_func
(paren
id|dirname
comma
l_int|10
comma
l_string|&quot;%d&quot;
comma
id|ov-&gt;vdev.minor
)paren
suffix:semicolon
multiline_comment|/* Destroy &quot;control&quot; entry */
r_if
c_cond
(paren
id|ov-&gt;proc_control
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;destroying /proc/video/ov511/%s/control&quot;
comma
id|dirname
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;control&quot;
comma
id|ov-&gt;proc_devdir
)paren
suffix:semicolon
id|ov-&gt;proc_control
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Destroy &quot;button&quot; entry */
r_if
c_cond
(paren
id|ov-&gt;proc_button
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;destroying /proc/video/ov511/%s/button&quot;
comma
id|dirname
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;button&quot;
comma
id|ov-&gt;proc_devdir
)paren
suffix:semicolon
id|ov-&gt;proc_button
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Destroy &quot;info&quot; entry */
r_if
c_cond
(paren
id|ov-&gt;proc_info
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;destroying /proc/video/ov511/%s/info&quot;
comma
id|dirname
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;info&quot;
comma
id|ov-&gt;proc_devdir
)paren
suffix:semicolon
id|ov-&gt;proc_info
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Destroy per-device directory */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;destroying /proc/video/ov511/%s/&quot;
comma
id|dirname
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|dirname
comma
id|ov511_proc_entry
)paren
suffix:semicolon
id|ov-&gt;proc_devdir
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|proc_ov511_create
id|proc_ov511_create
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* No current standard here. Alan prefers /proc/video/ as it keeps&n;&t; * /proc &quot;less cluttered than /proc/randomcardifoundintheshed/&quot;&n;&t; * -claudio&n;&t; */
r_if
c_cond
(paren
id|video_proc_entry
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error: /proc/video/ does not exist&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ov511_proc_entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ov511&quot;
comma
id|S_IFDIR
comma
id|video_proc_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_proc_entry
)paren
id|ov511_proc_entry-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
r_else
id|err
c_func
(paren
l_string|&quot;Unable to create /proc/video/ov511&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|proc_ov511_destroy
id|proc_ov511_destroy
c_func
(paren
r_void
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;removing /proc/video/ov511&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_proc_entry
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;ov511&quot;
comma
id|video_proc_entry
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS &amp;&amp; CONFIG_VIDEO_PROC_FS */
multiline_comment|/**********************************************************************&n; *&n; * Register I/O&n; *&n; **********************************************************************/
multiline_comment|/* Write an OV51x register */
r_static
r_int
DECL|function|reg_w
id|reg_w
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;0x%02X:0x%02X&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
id|ov-&gt;cbuf
(braket
l_int|0
)braket
op_assign
id|value
suffix:semicolon
id|rc
op_assign
id|usb_control_msg
c_func
(paren
id|ov-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|ov-&gt;dev
comma
l_int|0
)paren
comma
l_int|2
multiline_comment|/* REG_IO */
comma
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
(paren
id|__u16
)paren
id|reg
comma
op_amp
id|ov-&gt;cbuf
(braket
l_int|0
)braket
comma
l_int|1
comma
id|HZ
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;reg write: error %d: %s&quot;
comma
id|rc
comma
id|symbolic
c_func
(paren
id|urb_errlist
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Read from an OV51x register */
multiline_comment|/* returns: negative is error, pos or zero is data */
r_static
r_int
DECL|function|reg_r
id|reg_r
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
id|rc
op_assign
id|usb_control_msg
c_func
(paren
id|ov-&gt;dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|ov-&gt;dev
comma
l_int|0
)paren
comma
l_int|2
multiline_comment|/* REG_IO */
comma
id|USB_DIR_IN
op_or
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
(paren
id|__u16
)paren
id|reg
comma
op_amp
id|ov-&gt;cbuf
(braket
l_int|0
)braket
comma
l_int|1
comma
id|HZ
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;0x%02X:0x%02X&quot;
comma
id|reg
comma
id|ov-&gt;cbuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;reg read: error %d: %s&quot;
comma
id|rc
comma
id|symbolic
c_func
(paren
id|urb_errlist
comma
id|rc
)paren
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|ov-&gt;cbuf
(braket
l_int|0
)braket
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Writes bits at positions specified by mask to an OV51x reg. Bits that are in&n; * the same position as 1&squot;s in &quot;mask&quot; are cleared and set to &quot;value&quot;. Bits&n; * that are in the same position as 0&squot;s in &quot;mask&quot; are preserved, regardless &n; * of their respective state in &quot;value&quot;.&n; */
r_static
r_int
DECL|function|reg_w_mask
id|reg_w_mask
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
comma
r_int
r_char
id|mask
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
r_char
id|oldval
comma
id|newval
suffix:semicolon
id|ret
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|oldval
op_assign
(paren
r_int
r_char
)paren
id|ret
suffix:semicolon
id|oldval
op_and_assign
(paren
op_complement
id|mask
)paren
suffix:semicolon
multiline_comment|/* Clear the masked bits */
id|value
op_and_assign
id|mask
suffix:semicolon
multiline_comment|/* Enforce mask on value */
id|newval
op_assign
id|oldval
op_or
id|value
suffix:semicolon
multiline_comment|/* Set the desired bits */
r_return
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|reg
comma
id|newval
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Writes multiple (n) byte value to a single register. Only valid with certain&n; * registers (0x30 and 0xc4 - 0xce).&n; */
r_static
r_int
DECL|function|ov518_reg_w32
id|ov518_reg_w32
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
comma
id|u32
id|val
comma
r_int
id|n
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;0x%02X:%7d, n=%d&quot;
comma
id|reg
comma
id|val
comma
id|n
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
op_star
(paren
(paren
id|u32
op_star
)paren
id|ov-&gt;cbuf
)paren
op_assign
id|__cpu_to_le32
c_func
(paren
id|val
)paren
suffix:semicolon
id|rc
op_assign
id|usb_control_msg
c_func
(paren
id|ov-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|ov-&gt;dev
comma
l_int|0
)paren
comma
l_int|2
multiline_comment|/* REG_IO */
comma
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
(paren
id|__u16
)paren
id|reg
comma
id|ov-&gt;cbuf
comma
id|n
comma
id|HZ
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;reg write multiple: error %d: %s&quot;
comma
id|rc
comma
id|symbolic
c_func
(paren
id|urb_errlist
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|ov511_upload_quan_tables
id|ov511_upload_quan_tables
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
r_char
op_star
id|pYTable
op_assign
id|yQuanTable511
suffix:semicolon
r_int
r_char
op_star
id|pUVTable
op_assign
id|uvQuanTable511
suffix:semicolon
r_int
r_char
id|val0
comma
id|val1
suffix:semicolon
r_int
id|i
comma
id|rc
comma
id|reg
op_assign
id|R511_COMP_LUT_BEGIN
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Uploading quantization tables&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_QUANTABLESIZE
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ENABLE_Y_QUANTABLE
)paren
(brace
id|val0
op_assign
op_star
id|pYTable
op_increment
suffix:semicolon
id|val1
op_assign
op_star
id|pYTable
op_increment
suffix:semicolon
id|val0
op_and_assign
l_int|0x0f
suffix:semicolon
id|val1
op_and_assign
l_int|0x0f
suffix:semicolon
id|val0
op_or_assign
id|val1
op_lshift
l_int|4
suffix:semicolon
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|reg
comma
id|val0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ENABLE_UV_QUANTABLE
)paren
(brace
id|val0
op_assign
op_star
id|pUVTable
op_increment
suffix:semicolon
id|val1
op_assign
op_star
id|pUVTable
op_increment
suffix:semicolon
id|val0
op_and_assign
l_int|0x0f
suffix:semicolon
id|val1
op_and_assign
l_int|0x0f
suffix:semicolon
id|val0
op_or_assign
id|val1
op_lshift
l_int|4
suffix:semicolon
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|reg
op_plus
id|OV511_QUANTABLESIZE
op_div
l_int|2
comma
id|val0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
id|reg
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* OV518 quantization tables are 8x4 (instead of 8x8) */
r_static
r_int
DECL|function|ov518_upload_quan_tables
id|ov518_upload_quan_tables
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
r_char
op_star
id|pYTable
op_assign
id|yQuanTable518
suffix:semicolon
r_int
r_char
op_star
id|pUVTable
op_assign
id|uvQuanTable518
suffix:semicolon
r_int
r_char
id|val0
comma
id|val1
suffix:semicolon
r_int
id|i
comma
id|rc
comma
id|reg
op_assign
id|R511_COMP_LUT_BEGIN
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Uploading quantization tables&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV518_QUANTABLESIZE
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ENABLE_Y_QUANTABLE
)paren
(brace
id|val0
op_assign
op_star
id|pYTable
op_increment
suffix:semicolon
id|val1
op_assign
op_star
id|pYTable
op_increment
suffix:semicolon
id|val0
op_and_assign
l_int|0x0f
suffix:semicolon
id|val1
op_and_assign
l_int|0x0f
suffix:semicolon
id|val0
op_or_assign
id|val1
op_lshift
l_int|4
suffix:semicolon
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|reg
comma
id|val0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ENABLE_UV_QUANTABLE
)paren
(brace
id|val0
op_assign
op_star
id|pUVTable
op_increment
suffix:semicolon
id|val1
op_assign
op_star
id|pUVTable
op_increment
suffix:semicolon
id|val0
op_and_assign
l_int|0x0f
suffix:semicolon
id|val1
op_and_assign
l_int|0x0f
suffix:semicolon
id|val0
op_or_assign
id|val1
op_lshift
l_int|4
suffix:semicolon
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|reg
op_plus
id|OV518_QUANTABLESIZE
op_div
l_int|2
comma
id|val0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
id|reg
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ov51x_reset
id|ov51x_reset
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reset_type
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/* Setting bit 0 not allowed on 518/518Plus */
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|reset_type
op_and_assign
l_int|0xfe
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Reset: type=0x%X&quot;
comma
id|reset_type
)paren
suffix:semicolon
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_SYS_RESET
comma
id|reset_type
)paren
suffix:semicolon
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_SYS_RESET
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;reset: command failed&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; * I2C (sensor) I/O&n; *&n; **********************************************************************/
multiline_comment|/* NOTE: Do not call this function directly!&n; * The OV518 I2C I/O procedure is different, hence, this function.&n; * This is normally only called from i2c_w(). Note that this function&n; * always succeeds regardless of whether the sensor is present and working.&n; */
r_static
r_int
DECL|function|ov518_i2c_write_internal
id|ov518_i2c_write_internal
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;0x%02X:0x%02X&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* Select camera register */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_SADDR_3
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Write &quot;value&quot; to I2C data port of OV511 */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_DATA
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Initiate 3-byte write cycle */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R518_I2C_CTL
comma
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* NOTE: Do not call this function directly! */
r_static
r_int
DECL|function|ov511_i2c_write_internal
id|ov511_i2c_write_internal
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
id|rc
comma
id|retries
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;0x%02X:0x%02X&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* Three byte write cycle */
r_for
c_loop
(paren
id|retries
op_assign
id|OV511_I2C_RETRIES
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Select camera register */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_SADDR_3
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Write &quot;value&quot; to I2C data port of OV511 */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_DATA
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Initiate 3-byte write cycle */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
comma
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_do
id|rc
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rc
OG
l_int|0
op_logical_and
(paren
(paren
id|rc
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Retry until idle */
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|2
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Ack? */
r_break
suffix:semicolon
macro_line|#if 0
multiline_comment|/* I2C abort */
id|reg_w
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
comma
l_int|0x10
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_decrement
id|retries
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;i2c write retries exhausted&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* NOTE: Do not call this function directly!&n; * The OV518 I2C I/O procedure is different, hence, this function.&n; * This is normally only called from i2c_r(). Note that this function&n; * always succeeds regardless of whether the sensor is present and working.&n; */
r_static
r_int
DECL|function|ov518_i2c_read_internal
id|ov518_i2c_read_internal
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
comma
id|value
suffix:semicolon
multiline_comment|/* Select camera register */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_SADDR_2
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Initiate 2-byte write cycle */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R518_I2C_CTL
comma
l_int|0x03
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Initiate 2-byte read cycle */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R518_I2C_CTL
comma
l_int|0x05
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|value
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|R51x_I2C_DATA
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;0x%02X:0x%02X&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/* NOTE: Do not call this function directly!&n; * returns: negative is error, pos or zero is data */
r_static
r_int
DECL|function|ov511_i2c_read_internal
id|ov511_i2c_read_internal
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
comma
id|value
comma
id|retries
suffix:semicolon
multiline_comment|/* Two byte write cycle */
r_for
c_loop
(paren
id|retries
op_assign
id|OV511_I2C_RETRIES
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Select camera register */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_SADDR_2
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Initiate 2-byte write cycle */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
comma
l_int|0x03
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_do
id|rc
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rc
OG
l_int|0
op_logical_and
(paren
(paren
id|rc
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Retry until idle */
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|2
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Ack? */
r_break
suffix:semicolon
multiline_comment|/* I2C abort */
id|reg_w
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
comma
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;i2c write retries exhausted&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Two byte read cycle */
r_for
c_loop
(paren
id|retries
op_assign
id|OV511_I2C_RETRIES
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Initiate 2-byte read cycle */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
comma
l_int|0x05
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_do
id|rc
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rc
OG
l_int|0
op_logical_and
(paren
(paren
id|rc
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Retry until idle */
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|2
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Ack? */
r_break
suffix:semicolon
multiline_comment|/* I2C abort */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
comma
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;i2c read retries exhausted&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|value
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|R51x_I2C_DATA
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;0x%02X:0x%02X&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* This is needed to make i2c_w() work */
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|R511_I2C_CTL
comma
l_int|0x05
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/* returns: negative is error, pos or zero is data */
r_static
r_int
DECL|function|i2c_r
id|i2c_r
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|rc
op_assign
id|ov518_i2c_read_internal
c_func
(paren
id|ov
comma
id|reg
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|ov511_i2c_read_internal
c_func
(paren
id|ov
comma
id|reg
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|i2c_w
id|i2c_w
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
id|rc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|rc
op_assign
id|ov518_i2c_write_internal
c_func
(paren
id|ov
comma
id|reg
comma
id|value
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|ov511_i2c_write_internal
c_func
(paren
id|ov
comma
id|reg
comma
id|value
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Do not call this function directly! */
r_static
r_int
DECL|function|ov51x_i2c_write_mask_internal
id|ov51x_i2c_write_mask_internal
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
comma
r_int
r_char
id|mask
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_char
id|oldval
comma
id|newval
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|0xff
)paren
(brace
id|newval
op_assign
id|value
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|rc
op_assign
id|ov518_i2c_read_internal
c_func
(paren
id|ov
comma
id|reg
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|ov511_i2c_read_internal
c_func
(paren
id|ov
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|oldval
op_assign
(paren
r_int
r_char
)paren
id|rc
suffix:semicolon
id|oldval
op_and_assign
(paren
op_complement
id|mask
)paren
suffix:semicolon
multiline_comment|/* Clear the masked bits */
id|value
op_and_assign
id|mask
suffix:semicolon
multiline_comment|/* Enforce mask on value */
id|newval
op_assign
id|oldval
op_or
id|value
suffix:semicolon
multiline_comment|/* Set the desired bits */
)brace
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
r_return
(paren
id|ov518_i2c_write_internal
c_func
(paren
id|ov
comma
id|reg
comma
id|newval
)paren
)paren
suffix:semicolon
r_else
r_return
(paren
id|ov511_i2c_write_internal
c_func
(paren
id|ov
comma
id|reg
comma
id|newval
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Writes bits at positions specified by mask to an I2C reg. Bits that are in&n; * the same position as 1&squot;s in &quot;mask&quot; are cleared and set to &quot;value&quot;. Bits&n; * that are in the same position as 0&squot;s in &quot;mask&quot; are preserved, regardless &n; * of their respective state in &quot;value&quot;.&n; */
r_static
r_int
DECL|function|i2c_w_mask
id|i2c_w_mask
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
comma
r_int
r_char
id|mask
)paren
(brace
r_int
id|rc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
id|rc
op_assign
id|ov51x_i2c_write_mask_internal
c_func
(paren
id|ov
comma
id|reg
comma
id|value
comma
id|mask
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Write to a specific I2C slave ID and register, using the specified mask */
r_static
r_int
DECL|function|i2c_w_slave
id|i2c_w_slave
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|slave
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
comma
r_int
r_char
id|mask
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
multiline_comment|/* Set new slave IDs */
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_W_SID
comma
id|slave
)paren
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_R_SID
comma
id|slave
op_plus
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
id|ov51x_i2c_write_mask_internal
c_func
(paren
id|ov
comma
id|reg
comma
id|value
comma
id|mask
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t bail out yet if error; IDs must be restored */
multiline_comment|/* Restore primary IDs */
id|slave
op_assign
id|ov-&gt;primary_i2c_slave
suffix:semicolon
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_W_SID
comma
id|slave
)paren
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_R_SID
comma
id|slave
op_plus
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Read from a specific I2C slave ID and register */
r_static
r_int
DECL|function|i2c_r_slave
id|i2c_r_slave
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|slave
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
multiline_comment|/* Set new slave IDs */
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_W_SID
comma
id|slave
)paren
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_R_SID
comma
id|slave
op_plus
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|rc
op_assign
id|ov518_i2c_read_internal
c_func
(paren
id|ov
comma
id|reg
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|ov511_i2c_read_internal
c_func
(paren
id|ov
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t bail out yet if error; IDs must be restored */
multiline_comment|/* Restore primary IDs */
id|slave
op_assign
id|ov-&gt;primary_i2c_slave
suffix:semicolon
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_W_SID
comma
id|slave
)paren
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_R_SID
comma
id|slave
op_plus
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Sets I2C read and write slave IDs. Returns &lt;0 for error */
r_static
r_int
DECL|function|ov51x_set_slave_ids
id|ov51x_set_slave_ids
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|sid
)paren
(brace
id|down
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_W_SID
comma
id|sid
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_I2C_R_SID
comma
id|sid
op_plus
l_int|1
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_reset
c_func
(paren
id|ov
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|write_regvals
id|write_regvals
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_struct
id|ov511_regvals
op_star
id|pRegvals
)paren
(brace
r_int
id|rc
suffix:semicolon
r_while
c_loop
(paren
id|pRegvals-&gt;bus
op_ne
id|OV511_DONE_BUS
)paren
(brace
r_if
c_cond
(paren
id|pRegvals-&gt;bus
op_eq
id|OV511_REG_BUS
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|reg_w
c_func
(paren
id|ov
comma
id|pRegvals-&gt;reg
comma
id|pRegvals-&gt;val
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pRegvals-&gt;bus
op_eq
id|OV511_I2C_BUS
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
id|pRegvals-&gt;reg
comma
id|pRegvals-&gt;val
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Bad regval array&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pRegvals
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef OV511_DEBUG 
r_static
r_void
DECL|function|dump_i2c_range
id|dump_i2c_range
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|reg1
comma
r_int
id|regn
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|reg1
suffix:semicolon
id|i
op_le
id|regn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
id|i
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;OV7610[0x%X] = 0x%X&quot;
comma
id|i
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|dump_i2c_regs
id|dump_i2c_regs
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
id|info
c_func
(paren
l_string|&quot;I2C REGS&quot;
)paren
suffix:semicolon
id|dump_i2c_range
c_func
(paren
id|ov
comma
l_int|0x00
comma
l_int|0x7C
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dump_reg_range
id|dump_reg_range
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|reg1
comma
r_int
id|regn
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|reg1
suffix:semicolon
id|i
op_le
id|regn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|i
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;OV511[0x%X] = 0x%X&quot;
comma
id|i
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* FIXME: Should there be an OV518 version of this? */
r_static
r_void
DECL|function|ov511_dump_regs
id|ov511_dump_regs
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
id|info
c_func
(paren
l_string|&quot;CAMERA INTERFACE REGS&quot;
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x10
comma
l_int|0x1f
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;DRAM INTERFACE REGS&quot;
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x20
comma
l_int|0x23
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;ISO FIFO REGS&quot;
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x30
comma
l_int|0x31
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;PIO REGS&quot;
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x38
comma
l_int|0x39
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x3e
comma
l_int|0x3e
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;I2C REGS&quot;
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x40
comma
l_int|0x49
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;SYSTEM CONTROL REGS&quot;
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x50
comma
l_int|0x55
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x5e
comma
l_int|0x5f
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;OmniCE REGS&quot;
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x70
comma
l_int|0x79
)paren
suffix:semicolon
multiline_comment|/* NOTE: Quantization tables are not readable. You will get the value&n;&t; * in reg. 0x79 for every table register */
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0x80
comma
l_int|0x9f
)paren
suffix:semicolon
id|dump_reg_range
c_func
(paren
id|ov
comma
l_int|0xa0
comma
l_int|0xbf
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**********************************************************************&n; *&n; * Kernel I2C Interface&n; *&n; **********************************************************************/
multiline_comment|/* For as-yet unimplemented I2C interface */
r_static
r_void
DECL|function|call_i2c_clients
id|call_i2c_clients
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
multiline_comment|/* Do nothing */
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/* Temporarily stops OV511 from functioning. Must do this before changing&n; * registers while the camera is streaming */
r_static
r_inline
r_int
DECL|function|ov51x_stop
id|ov51x_stop
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;stopping&quot;
)paren
suffix:semicolon
id|ov-&gt;stopped
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
r_return
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_SYS_RESET
comma
l_int|0x3a
)paren
)paren
suffix:semicolon
r_else
r_return
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_SYS_RESET
comma
l_int|0x3d
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Restarts OV511 after ov511_stop() is called. Has no effect if it is not&n; * actually stopped (for performance). */
r_static
r_inline
r_int
DECL|function|ov51x_restart
id|ov51x_restart
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_if
c_cond
(paren
id|ov-&gt;stopped
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;restarting&quot;
)paren
suffix:semicolon
id|ov-&gt;stopped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reinitialize the stream */
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2f
comma
l_int|0x80
)paren
suffix:semicolon
r_return
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_SYS_RESET
comma
l_int|0x00
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Resets the hardware snapshot button */
r_static
r_void
DECL|function|ov51x_clear_snapshot
id|ov51x_clear_snapshot
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV511
)paren
(brace
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_SYS_SNAP
comma
l_int|0x01
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_SYS_SNAP
comma
l_int|0x03
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_SYS_SNAP
comma
l_int|0x01
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;snapshot reset not supported yet on OV518(+)&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;clear snap: invalid bridge type&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Checks the status of the snapshot button. Returns 1 if it was pressed since&n; * it was last cleared, and zero in all other cases (including errors) */
r_static
r_int
DECL|function|ov51x_check_snapshot
id|ov51x_check_snapshot
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|ret
comma
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV511
)paren
(brace
id|ret
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|R51x_SYS_SNAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error checking snspshot status (%d)&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
op_amp
l_int|0x08
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;snapshot check not supported yet on OV518(+)&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;check snap: invalid bridge type&quot;
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* This does an initial reset of an OmniVision sensor and ensures that I2C&n; * is synchronized. Returns &lt;0 for failure.&n; */
r_static
r_int
DECL|function|init_ov_sensor
id|init_ov_sensor
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|i
comma
id|success
suffix:semicolon
multiline_comment|/* Reset the sensor */
r_if
c_cond
(paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|schedule_timeout
(paren
l_int|1
op_plus
l_int|150
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|success
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|i2c_detect_tries
op_logical_and
op_logical_neg
id|success
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_ID_HIGH
)paren
op_eq
l_int|0x7F
)paren
op_logical_and
(paren
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_ID_LOW
)paren
op_eq
l_int|0xA2
)paren
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Reset the sensor */
r_if
c_cond
(paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|schedule_timeout
c_func
(paren
l_int|1
op_plus
l_int|150
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* Dummy read to sync I2C */
r_if
c_cond
(paren
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|success
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;I2C synced in %d attempt(s)&quot;
comma
id|i
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ov51x_set_packet_size
id|ov51x_set_packet_size
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|size
)paren
(brace
r_int
id|alt
comma
id|mult
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_stop
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|mult
op_assign
id|size
op_rshift
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bridge
op_eq
id|BRG_OV511
)paren
(brace
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|257
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_257
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|513
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_513
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|769
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_769
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|993
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_993
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: invalid size (%d)&quot;
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;bridge
op_eq
id|BRG_OV511PLUS
)paren
(brace
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|33
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_33
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|129
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_129
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|257
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_257
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|385
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_385
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|513
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_513
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|769
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_769
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|961
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_961
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: invalid size (%d)&quot;
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
(brace
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
id|alt
op_assign
id|OV518_ALT_SIZE_0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|128
)paren
id|alt
op_assign
id|OV518_ALT_SIZE_128
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|256
)paren
id|alt
op_assign
id|OV518_ALT_SIZE_256
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|384
)paren
id|alt
op_assign
id|OV518_ALT_SIZE_384
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|512
)paren
id|alt
op_assign
id|OV518_ALT_SIZE_512
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|640
)paren
id|alt
op_assign
id|OV518_ALT_SIZE_640
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|768
)paren
id|alt
op_assign
id|OV518_ALT_SIZE_768
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|896
)paren
id|alt
op_assign
id|OV518_ALT_SIZE_896
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: invalid size (%d)&quot;
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: Invalid bridge type&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;set packet size: %d, mult=%d, alt=%d&quot;
comma
id|size
comma
id|mult
comma
id|alt
)paren
suffix:semicolon
singleline_comment|// FIXME: Don&squot;t know how to do this on OV518 yet
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV511
)paren
(brace
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
id|R51x_FIFO_PSIZE
comma
id|mult
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|ov-&gt;dev
comma
id|ov-&gt;iface
comma
id|alt
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: set interface error&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Initialize the stream */
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2f
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
singleline_comment|// FIXME - Should we only reset the FIFO?
r_if
c_cond
(paren
id|ov51x_reset
c_func
(paren
id|ov
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|ov-&gt;packet_size
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_restart
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Upload compression params and quantization tables. Returns 0 for success. */
r_static
r_int
DECL|function|ov511_init_compression
id|ov511_init_compression
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;compress_inited
)paren
(brace
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x70
comma
id|phy
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x71
comma
id|phuv
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x72
comma
id|pvy
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x73
comma
id|pvuv
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x74
comma
id|qhy
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x75
comma
id|qhuv
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x76
comma
id|qvy
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x77
comma
id|qvuv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_upload_quan_tables
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error uploading quantization tables&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|ov-&gt;compress_inited
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Upload compression params and quantization tables. Returns 0 for success. */
r_static
r_int
DECL|function|ov518_init_compression
id|ov518_init_compression
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;compress_inited
)paren
(brace
r_if
c_cond
(paren
id|ov518_upload_quan_tables
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error uploading quantization tables&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|ov-&gt;compress_inited
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
multiline_comment|/* Sets sensor&squot;s contrast setting to &quot;val&quot; */
r_static
r_int
DECL|function|sensor_set_contrast
id|sensor_set_contrast
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;stop_during_set
)paren
r_if
c_cond
(paren
id|ov51x_stop
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
(brace
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
id|OV7610_REG_CNT
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SEN_OV7620
suffix:colon
(brace
r_int
r_char
id|ctab
(braket
)braket
op_assign
(brace
l_int|0x01
comma
l_int|0x05
comma
l_int|0x09
comma
l_int|0x11
comma
l_int|0x15
comma
l_int|0x35
comma
l_int|0x37
comma
l_int|0x57
comma
l_int|0x5b
comma
l_int|0xa5
comma
l_int|0xa7
comma
l_int|0xc7
comma
l_int|0xc9
comma
l_int|0xcf
comma
l_int|0xef
comma
l_int|0xff
)brace
suffix:semicolon
multiline_comment|/* Use Y gamma control instead. Bit 0 enables it. */
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x64
comma
id|ctab
(braket
id|val
op_rshift
l_int|12
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SEN_SAA7111A
suffix:colon
(brace
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x0b
comma
id|val
op_rshift
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Success */
id|ov-&gt;contrast
op_assign
id|val
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|ov51x_restart
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Gets sensor&squot;s contrast setting */
r_static
r_int
DECL|function|sensor_get_contrast
id|sensor_get_contrast
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_CNT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_else
op_star
id|val
op_assign
id|rc
op_lshift
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
multiline_comment|/* Use Y gamma reg instead. Bit 0 is the enable bit. */
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_else
op_star
id|val
op_assign
(paren
id|rc
op_amp
l_int|0xfe
)paren
op_lshift
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_SAA7111A
suffix:colon
op_star
id|val
op_assign
id|ov-&gt;contrast
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
op_star
id|val
)paren
suffix:semicolon
id|ov-&gt;contrast
op_assign
op_star
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
multiline_comment|/* Sets sensor&squot;s brightness setting to &quot;val&quot; */
r_static
r_int
DECL|function|sensor_set_brightness
id|sensor_set_brightness
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%d&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;stop_during_set
)paren
r_if
c_cond
(paren
id|ov51x_stop
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
id|OV7610_REG_BRT
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
multiline_comment|/* 7620 doesn&squot;t like manual changes when in auto mode */
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;auto_brt
)paren
(brace
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
id|OV7610_REG_BRT
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SEN_SAA7111A
suffix:colon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x0a
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Success */
id|ov-&gt;brightness
op_assign
id|val
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|ov51x_restart
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Gets sensor&squot;s brightness setting */
r_static
r_int
DECL|function|sensor_get_brightness
id|sensor_get_brightness
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV7620
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_BRT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_else
op_star
id|val
op_assign
id|rc
op_lshift
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_SAA7111A
suffix:colon
op_star
id|val
op_assign
id|ov-&gt;brightness
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
op_star
id|val
)paren
suffix:semicolon
id|ov-&gt;brightness
op_assign
op_star
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
multiline_comment|/* Sets sensor&squot;s saturation (color intensity) setting to &quot;val&quot; */
r_static
r_int
DECL|function|sensor_set_saturation
id|sensor_set_saturation
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;stop_during_set
)paren
r_if
c_cond
(paren
id|ov51x_stop
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
id|OV7610_REG_SAT
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
singleline_comment|//&t;&t;/* Use UV gamma control instead. Bits 0 &amp; 7 are reserved. */
singleline_comment|//&t;&t;rc = ov_i2c_write(ov-&gt;dev, 0x62, (val &gt;&gt; 9) &amp; 0x7e);
singleline_comment|//&t;&t;if (rc &lt; 0)
singleline_comment|//&t;&t;&t;goto out;
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
id|OV7610_REG_SAT
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_SAA7111A
suffix:colon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x0c
comma
id|val
op_rshift
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Success */
id|ov-&gt;colour
op_assign
id|val
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|ov51x_restart
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Gets sensor&squot;s saturation (color intensity) setting */
r_static
r_int
DECL|function|sensor_get_saturation
id|sensor_get_saturation
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_SAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_else
op_star
id|val
op_assign
id|rc
op_lshift
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
singleline_comment|//&t;&t;/* Use UV gamma reg instead. Bits 0 &amp; 7 are reserved. */
singleline_comment|//&t;&t;rc = i2c_r(ov, 0x62);
singleline_comment|//&t;&t;if (rc &lt; 0)
singleline_comment|//&t;&t;&t;return rc;
singleline_comment|//&t;&t;else
singleline_comment|//&t;&t;&t;*val = (rc &amp; 0x7e) &lt;&lt; 9;
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_SAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_else
op_star
id|val
op_assign
id|rc
op_lshift
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_SAA7111A
suffix:colon
op_star
id|val
op_assign
id|ov-&gt;colour
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
op_star
id|val
)paren
suffix:semicolon
id|ov-&gt;colour
op_assign
op_star
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
multiline_comment|/* Sets sensor&squot;s hue (red/blue balance) setting to &quot;val&quot; */
r_static
r_int
DECL|function|sensor_set_hue
id|sensor_set_hue
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;stop_during_set
)paren
r_if
c_cond
(paren
id|ov51x_stop
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
id|OV7610_REG_RED
comma
l_int|0xFF
op_minus
(paren
id|val
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
id|OV7610_REG_BLUE
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
singleline_comment|// Hue control is causing problems. I will enable it once it&squot;s fixed.
macro_line|#if 0
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x7a
comma
(paren
r_int
r_char
)paren
(paren
id|val
op_rshift
l_int|8
)paren
op_plus
l_int|0xb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x79
comma
(paren
r_int
r_char
)paren
(paren
id|val
op_rshift
l_int|8
)paren
op_plus
l_int|0xb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|SEN_SAA7111A
suffix:colon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x0d
comma
(paren
id|val
op_plus
l_int|32768
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Success */
id|ov-&gt;hue
op_assign
id|val
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|ov51x_restart
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Gets sensor&squot;s hue (red/blue balance) setting */
r_static
r_int
DECL|function|sensor_get_hue
id|sensor_get_hue
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_BLUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_else
op_star
id|val
op_assign
id|rc
op_lshift
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x7a
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_else
op_star
id|val
op_assign
id|rc
op_lshift
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_SAA7111A
suffix:colon
op_star
id|val
op_assign
id|ov-&gt;hue
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
op_star
id|val
)paren
suffix:semicolon
id|ov-&gt;hue
op_assign
op_star
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
r_static
r_inline
r_int
DECL|function|sensor_set_picture
id|sensor_set_picture
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_struct
id|video_picture
op_star
id|p
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;sensor_set_picture&quot;
)paren
suffix:semicolon
id|ov-&gt;whiteness
op_assign
id|p-&gt;whiteness
suffix:semicolon
multiline_comment|/* Don&squot;t return error if a setting is unsupported, or rest of settings&n;         * will not be performed */
id|rc
op_assign
id|sensor_set_contrast
c_func
(paren
id|ov
comma
id|p-&gt;contrast
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|sensor_set_brightness
c_func
(paren
id|ov
comma
id|p-&gt;brightness
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|sensor_set_saturation
c_func
(paren
id|ov
comma
id|p-&gt;colour
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|sensor_set_hue
c_func
(paren
id|ov
comma
id|p-&gt;hue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|sensor_get_picture
id|sensor_get_picture
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_struct
id|video_picture
op_star
id|p
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;sensor_get_picture&quot;
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t return error if a setting is unsupported, or rest of settings&n;         * will not be performed */
id|rc
op_assign
id|sensor_get_contrast
c_func
(paren
id|ov
comma
op_amp
(paren
id|p-&gt;contrast
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|sensor_get_brightness
c_func
(paren
id|ov
comma
op_amp
(paren
id|p-&gt;brightness
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|sensor_get_saturation
c_func
(paren
id|ov
comma
op_amp
(paren
id|p-&gt;colour
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|sensor_get_hue
c_func
(paren
id|ov
comma
op_amp
(paren
id|p-&gt;hue
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|p-&gt;whiteness
op_assign
l_int|105
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* Can we get these from frame[0]? -claudio? */
id|p-&gt;depth
op_assign
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|depth
suffix:semicolon
id|p-&gt;palette
op_assign
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|format
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// FIXME: Exposure range is only 0x00-0x7f in interlace mode
multiline_comment|/* Sets current exposure for sensor. This only has an effect if auto-exposure&n; * is off */
r_static
r_inline
r_int
DECL|function|sensor_set_exposure
id|sensor_set_exposure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;stop_during_set
)paren
r_if
c_cond
(paren
id|ov51x_stop
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV8600
suffix:colon
id|rc
op_assign
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x10
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_KS0127
suffix:colon
r_case
id|SEN_KS0127B
suffix:colon
r_case
id|SEN_SAA7111A
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Sensor not supported for set_exposure&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Success */
id|ov-&gt;exposure
op_assign
id|val
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|ov51x_restart
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Gets current exposure level from sensor, regardless of whether it is under&n; * manual control. */
r_static
r_int
DECL|function|sensor_get_exposure
id|sensor_get_exposure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
op_star
id|val
)paren
(brace
r_int
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
r_case
id|SEN_OV7620
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV8600
suffix:colon
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_else
op_star
id|val
op_assign
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_KS0127
suffix:colon
r_case
id|SEN_KS0127B
suffix:colon
r_case
id|SEN_SAA7111A
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Sensor not supported for get_exposure&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%d&quot;
comma
op_star
id|val
)paren
suffix:semicolon
id|ov-&gt;exposure
op_assign
op_star
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Turns on or off the LED. Only has an effect with OV511+/OV518(+) */
r_static
r_inline
r_void
DECL|function|ov51x_led_control
id|ov51x_led_control
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|enable
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot; (%s)&quot;
comma
id|enable
ques
c_cond
l_string|&quot;turn on&quot;
suffix:colon
l_string|&quot;turn off&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bridge
op_eq
id|BRG_OV511PLUS
)paren
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SYS_LED_CTL
comma
id|enable
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|reg_w_mask
c_func
(paren
id|ov
comma
id|R518_GPIO_OUT
comma
id|enable
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x00
comma
l_int|0x02
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Matches the sensor&squot;s internal frame rate to the lighting frequency.&n; * Valid frequencies are:&n; *&t;50 - 50Hz, for European and Asian lighting&n; *&t;60 - 60Hz, for American lighting&n; *&n; * Tested with: OV7610, OV7620, OV7620AE, OV6620&n; * Unsupported: KS0127, KS0127B, SAA7111A&n; * Returns: 0 for success&n; */
r_static
r_int
DECL|function|sensor_set_light_freq
id|sensor_set_light_freq
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|freq
)paren
(brace
r_int
id|sixty
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%d Hz&quot;
comma
id|freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freq
op_eq
l_int|60
)paren
id|sixty
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|freq
op_eq
l_int|50
)paren
id|sixty
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Invalid light freq (%d Hz)&quot;
comma
id|freq
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x2a
comma
id|sixty
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x2b
comma
id|sixty
ques
c_cond
l_int|0x00
suffix:colon
l_int|0xac
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x13
comma
l_int|0x10
comma
l_int|0x10
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x13
comma
l_int|0x00
comma
l_int|0x10
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV8600
suffix:colon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x2a
comma
id|sixty
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x2b
comma
id|sixty
ques
c_cond
l_int|0x00
suffix:colon
l_int|0xac
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x76
comma
l_int|0x01
comma
l_int|0x01
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x2b
comma
id|sixty
ques
c_cond
l_int|0xa8
suffix:colon
l_int|0x28
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x2a
comma
id|sixty
ques
c_cond
l_int|0x84
suffix:colon
l_int|0xa4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_KS0127
suffix:colon
r_case
id|SEN_KS0127B
suffix:colon
r_case
id|SEN_SAA7111A
suffix:colon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Sensor not supported for set_light_freq&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ov-&gt;lightfreq
op_assign
id|freq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If enable is true, turn on the sensor&squot;s banding filter, otherwise turn it&n; * off. This filter tries to reduce the pattern of horizontal light/dark bands&n; * caused by some (usually fluorescent) lighting. The light frequency must be&n; * set either before or after enabling it with ov51x_set_light_freq().&n; *&n; * Tested with: OV7610, OV7620, OV7620AE, OV6620.&n; * Unsupported: KS0127, KS0127B, SAA7111A&n; * Returns: 0 for success&n; */
r_static
r_inline
r_int
DECL|function|sensor_set_banding_filter
id|sensor_set_banding_filter
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|enable
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot; (%s)&quot;
comma
id|enable
ques
c_cond
l_string|&quot;turn on&quot;
suffix:colon
l_string|&quot;turn off&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_KS0127
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_KS0127B
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_SAA7111A
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|rc
op_assign
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x2d
comma
id|enable
ques
c_cond
l_int|0x04
suffix:colon
l_int|0x00
comma
l_int|0x04
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|ov-&gt;bandfilt
op_assign
id|enable
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If enable is true, turn on the sensor&squot;s auto brightness control, otherwise&n; * turn it off.&n; *&n; * Unsupported: KS0127, KS0127B, SAA7111A&n; * Returns: 0 for success&n; */
r_static
r_inline
r_int
DECL|function|sensor_set_auto_brightness
id|sensor_set_auto_brightness
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|enable
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot; (%s)&quot;
comma
id|enable
ques
c_cond
l_string|&quot;turn on&quot;
suffix:colon
l_string|&quot;turn off&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_KS0127
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_KS0127B
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_SAA7111A
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|rc
op_assign
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x2d
comma
id|enable
ques
c_cond
l_int|0x10
suffix:colon
l_int|0x00
comma
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|ov-&gt;auto_brt
op_assign
id|enable
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If enable is true, turn on the sensor&squot;s auto exposure control, otherwise&n; * turn it off.&n; *&n; * Unsupported: KS0127, KS0127B, SAA7111A&n; * Returns: 0 for success&n; */
r_static
r_inline
r_int
DECL|function|sensor_set_auto_exposure
id|sensor_set_auto_exposure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|enable
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot; (%s)&quot;
comma
id|enable
ques
c_cond
l_string|&quot;turn on&quot;
suffix:colon
l_string|&quot;turn off&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x29
comma
id|enable
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV7620
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV8600
suffix:colon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x13
comma
id|enable
ques
c_cond
l_int|0x01
suffix:colon
l_int|0x00
comma
l_int|0x01
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV6630
suffix:colon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x28
comma
id|enable
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x10
comma
l_int|0x10
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_KS0127
suffix:colon
r_case
id|SEN_KS0127B
suffix:colon
r_case
id|SEN_SAA7111A
suffix:colon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Sensor not supported for set_auto_exposure&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ov-&gt;auto_exp
op_assign
id|enable
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Modifies the sensor&squot;s exposure algorithm to allow proper exposure of objects&n; * that are illuminated from behind.&n; *&n; * Tested with: OV6620, OV7620&n; * Unsupported: OV7610, OV7620AE, KS0127, KS0127B, SAA7111A&n; * Returns: 0 for success&n; */
r_static
r_int
DECL|function|sensor_set_backlight
id|sensor_set_backlight
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|enable
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot; (%s)&quot;
comma
id|enable
ques
c_cond
l_string|&quot;turn on&quot;
suffix:colon
l_string|&quot;turn off&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7620
suffix:colon
r_case
id|SEN_OV8600
suffix:colon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x68
comma
id|enable
ques
c_cond
l_int|0xe0
suffix:colon
l_int|0xc0
comma
l_int|0xe0
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x29
comma
id|enable
ques
c_cond
l_int|0x08
suffix:colon
l_int|0x00
comma
l_int|0x08
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x28
comma
id|enable
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x00
comma
l_int|0x02
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV6620
suffix:colon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x4e
comma
id|enable
ques
c_cond
l_int|0xe0
suffix:colon
l_int|0xc0
comma
l_int|0xe0
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x29
comma
id|enable
ques
c_cond
l_int|0x08
suffix:colon
l_int|0x00
comma
l_int|0x08
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x0e
comma
id|enable
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x00
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV6630
suffix:colon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x4e
comma
id|enable
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x60
comma
l_int|0xe0
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x29
comma
id|enable
ques
c_cond
l_int|0x08
suffix:colon
l_int|0x00
comma
l_int|0x08
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x28
comma
id|enable
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x00
comma
l_int|0x02
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_KS0127
suffix:colon
r_case
id|SEN_KS0127B
suffix:colon
r_case
id|SEN_SAA7111A
suffix:colon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;Unsupported with this sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Sensor not supported for set_backlight&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ov-&gt;backlight
op_assign
id|enable
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Returns number of bits per pixel (regardless of where they are located;&n; * planar or not), or zero for unsupported format.&n; */
r_static
r_inline
r_int
DECL|function|get_depth
id|get_depth
c_func
(paren
r_int
id|palette
)paren
(brace
r_switch
c_cond
(paren
id|palette
)paren
(brace
r_case
id|VIDEO_PALETTE_GREY
suffix:colon
r_return
l_int|8
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420
suffix:colon
r_return
l_int|12
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420P
suffix:colon
r_return
l_int|12
suffix:semicolon
multiline_comment|/* Planar */
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
r_return
l_int|16
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
r_return
l_int|24
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
r_return
l_int|16
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
r_return
l_int|16
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422P
suffix:colon
r_return
l_int|16
suffix:semicolon
multiline_comment|/* Planar */
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Invalid format */
)brace
)brace
multiline_comment|/* Bytes per frame. Used by read(). Return of 0 indicates error */
r_static
r_inline
r_int
r_int
DECL|function|get_frame_length
id|get_frame_length
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|frame
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
(paren
(paren
id|frame-&gt;width
op_star
id|frame-&gt;height
op_star
id|get_depth
c_func
(paren
id|frame-&gt;format
)paren
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|mode_init_ov_sensor_regs
id|mode_init_ov_sensor_regs
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|mode
comma
r_int
id|sub_flag
comma
r_int
id|qvga
)paren
(brace
r_int
id|clock
suffix:semicolon
multiline_comment|/******** Mode (VGA/QVGA) and sensor specific regs ********/
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x14
comma
id|qvga
ques
c_cond
l_int|0x24
suffix:colon
l_int|0x04
)paren
suffix:semicolon
singleline_comment|// FIXME: Does this improve the image quality or frame rate?
macro_line|#if 0
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x28
comma
id|qvga
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x20
comma
l_int|0x20
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x24
comma
l_int|0x10
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x25
comma
id|qvga
ques
c_cond
l_int|0x40
suffix:colon
l_int|0x8a
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x2f
comma
id|qvga
ques
c_cond
l_int|0x30
suffix:colon
l_int|0xb0
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x35
comma
id|qvga
ques
c_cond
l_int|0x1c
suffix:colon
l_int|0x9c
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
singleline_comment|//&t;&t;i2c_w(ov, 0x2b, 0x00);
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x14
comma
id|qvga
ques
c_cond
l_int|0xa4
suffix:colon
l_int|0x84
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x28
comma
id|qvga
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x20
comma
l_int|0x20
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x24
comma
id|qvga
ques
c_cond
l_int|0x20
suffix:colon
l_int|0x3a
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x25
comma
id|qvga
ques
c_cond
l_int|0x30
suffix:colon
l_int|0x60
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x2d
comma
id|qvga
ques
c_cond
l_int|0x40
suffix:colon
l_int|0x00
comma
l_int|0x40
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x67
comma
id|qvga
ques
c_cond
l_int|0xf0
suffix:colon
l_int|0x90
comma
l_int|0xf0
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x74
comma
id|qvga
ques
c_cond
l_int|0x20
suffix:colon
l_int|0x00
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620AE
suffix:colon
singleline_comment|//&t;&t;i2c_w(ov, 0x2b, 0x00);
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x14
comma
id|qvga
ques
c_cond
l_int|0xa4
suffix:colon
l_int|0x84
)paren
suffix:semicolon
singleline_comment|// FIXME: Enable this once 7620AE uses 7620 initial settings
macro_line|#if 0
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x28
comma
id|qvga
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x20
comma
l_int|0x20
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x24
comma
id|qvga
ques
c_cond
l_int|0x20
suffix:colon
l_int|0x3a
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x25
comma
id|qvga
ques
c_cond
l_int|0x30
suffix:colon
l_int|0x60
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x2d
comma
id|qvga
ques
c_cond
l_int|0x40
suffix:colon
l_int|0x00
comma
l_int|0x40
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x67
comma
id|qvga
ques
c_cond
l_int|0xb0
suffix:colon
l_int|0x90
comma
l_int|0xf0
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x74
comma
id|qvga
ques
c_cond
l_int|0x20
suffix:colon
l_int|0x00
comma
l_int|0x20
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x14
comma
id|qvga
ques
c_cond
l_int|0x24
suffix:colon
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* No special settings yet */
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Invalid sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/******** Palette-specific regs ********/
r_if
c_cond
(paren
id|mode
op_eq
id|VIDEO_PALETTE_GREY
)paren
(brace
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_OV7610
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_OV7620AE
)paren
(brace
multiline_comment|/* these aren&squot;t valid on the OV6620/OV7620/6630? */
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x0e
comma
l_int|0x40
comma
l_int|0x40
)paren
suffix:semicolon
)brace
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x13
comma
l_int|0x20
comma
l_int|0x20
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_OV7610
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_OV7620AE
)paren
(brace
multiline_comment|/* not valid on the OV6620/OV7620/6630? */
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x0e
comma
l_int|0x00
comma
l_int|0x40
)paren
suffix:semicolon
)brace
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x13
comma
l_int|0x00
comma
l_int|0x20
)paren
suffix:semicolon
)brace
multiline_comment|/******** Clock programming ********/
singleline_comment|// FIXME: Test this with OV6630
multiline_comment|/* The OV6620 needs special handling. This prevents the &n;&t; * severe banding that normally occurs */
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_OV6620
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_OV6630
)paren
(brace
multiline_comment|/* Clock down */
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x2a
comma
l_int|0x04
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;compress
)paren
(brace
singleline_comment|//&t;&t;&t;clock = 0;    /* This ensures the highest frame rate */
id|clock
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|clockdiv
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* If user didn&squot;t override it */
id|clock
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Gives better exposure time */
)brace
r_else
(brace
id|clock
op_assign
id|clockdiv
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Setting clock divisor to %d&quot;
comma
id|clock
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x11
comma
id|clock
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x2a
comma
l_int|0x84
)paren
suffix:semicolon
multiline_comment|/* This next setting is critical. It seems to improve&n;&t;&t; * the gain or the contrast. The &quot;reserved&quot; bits seem&n;&t;&t; * to have some effect in this case. */
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x2d
comma
l_int|0x85
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov-&gt;compress
)paren
(brace
id|clock
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This ensures the highest frame rate */
)brace
r_else
r_if
c_cond
(paren
id|clockdiv
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* If user didn&squot;t override it */
multiline_comment|/* Calculate and set the clock divisor */
id|clock
op_assign
(paren
(paren
id|sub_flag
ques
c_cond
id|ov-&gt;subw
op_star
id|ov-&gt;subh
suffix:colon
id|width
op_star
id|height
)paren
op_star
(paren
id|mode
op_eq
id|VIDEO_PALETTE_GREY
ques
c_cond
l_int|2
suffix:colon
l_int|3
)paren
op_div
l_int|2
)paren
op_div
l_int|66000
suffix:semicolon
)brace
r_else
(brace
id|clock
op_assign
id|clockdiv
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Setting clock divisor to %d&quot;
comma
id|clock
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x11
comma
id|clock
)paren
suffix:semicolon
)brace
multiline_comment|/******** Special Features ********/
r_if
c_cond
(paren
id|framedrop
op_ge
l_int|0
)paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x16
comma
id|framedrop
)paren
suffix:semicolon
multiline_comment|/* We only have code to convert GBR -&gt; RGB24 */
r_if
c_cond
(paren
(paren
id|mode
op_eq
id|VIDEO_PALETTE_RGB24
)paren
op_logical_and
id|sensor_gbr
)paren
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x08
comma
l_int|0x08
)paren
suffix:semicolon
r_else
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x00
comma
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* Test Pattern */
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x12
comma
(paren
id|testpat
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x00
)paren
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Auto white balance */
singleline_comment|//&t;if (awb)
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x04
comma
l_int|0x04
)paren
suffix:semicolon
singleline_comment|//&t;else
singleline_comment|//&t;&t;i2c_w_mask(ov, 0x12, 0x00, 0x04);
singleline_comment|// This will go away as soon as ov51x_mode_init_sensor_regs()
singleline_comment|// is fully tested.
multiline_comment|/* 7620/6620/6630? don&squot;t have register 0x35, so play it safe */
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_OV7610
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_OV7620AE
)paren
(brace
r_if
c_cond
(paren
id|width
op_eq
l_int|640
op_logical_and
id|height
op_eq
l_int|480
)paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x35
comma
l_int|0x9e
)paren
suffix:semicolon
r_else
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x35
comma
l_int|0x1e
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_ov_sensor_window
id|set_ov_sensor_window
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|mode
comma
r_int
id|sub_flag
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|hwsbase
comma
id|hwebase
comma
id|vwsbase
comma
id|vwebase
comma
id|hwsize
comma
id|vwsize
suffix:semicolon
r_int
id|hoffset
comma
id|voffset
comma
id|hwscale
op_assign
l_int|0
comma
id|vwscale
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The different sensor ICs handle setting up of window differently.&n;&t; * IF YOU SET IT WRONG, YOU WILL GET ALL ZERO ISOC DATA FROM OV51x!!! */
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
id|hwsbase
op_assign
l_int|0x38
suffix:semicolon
id|hwebase
op_assign
l_int|0x3a
suffix:semicolon
id|vwsbase
op_assign
id|vwebase
op_assign
l_int|0x05
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
singleline_comment|// FIXME: Is this right?
id|hwsbase
op_assign
l_int|0x38
suffix:semicolon
id|hwebase
op_assign
l_int|0x3a
suffix:semicolon
id|vwsbase
op_assign
l_int|0x05
suffix:semicolon
id|vwebase
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
id|hwsbase
op_assign
l_int|0x2f
suffix:semicolon
multiline_comment|/* From 7620.SET (spec is wrong) */
id|hwebase
op_assign
l_int|0x2f
suffix:semicolon
id|vwsbase
op_assign
id|vwebase
op_assign
l_int|0x05
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Invalid sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_OV6620
op_logical_or
id|ov-&gt;sensor
op_eq
id|SEN_OV6630
)paren
(brace
r_if
c_cond
(paren
id|width
OG
l_int|176
op_logical_and
id|height
OG
l_int|144
)paren
(brace
multiline_comment|/* CIF */
id|ret
op_assign
id|mode_init_ov_sensor_regs
c_func
(paren
id|ov
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|hwscale
op_assign
l_int|1
suffix:semicolon
id|vwscale
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* The datasheet says 0; it&squot;s wrong */
id|hwsize
op_assign
l_int|352
suffix:semicolon
id|vwsize
op_assign
l_int|288
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|width
OG
l_int|176
op_logical_or
id|height
OG
l_int|144
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Illegal dimensions&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* QCIF */
id|ret
op_assign
id|mode_init_ov_sensor_regs
c_func
(paren
id|ov
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|hwsize
op_assign
l_int|176
suffix:semicolon
id|vwsize
op_assign
l_int|144
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|width
OG
l_int|320
op_logical_and
id|height
OG
l_int|240
)paren
(brace
multiline_comment|/* VGA */
id|ret
op_assign
id|mode_init_ov_sensor_regs
c_func
(paren
id|ov
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|hwscale
op_assign
l_int|2
suffix:semicolon
id|vwscale
op_assign
l_int|1
suffix:semicolon
id|hwsize
op_assign
l_int|640
suffix:semicolon
id|vwsize
op_assign
l_int|480
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|width
OG
l_int|320
op_logical_or
id|height
OG
l_int|240
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Illegal dimensions&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* QVGA */
id|ret
op_assign
id|mode_init_ov_sensor_regs
c_func
(paren
id|ov
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|hwscale
op_assign
l_int|1
suffix:semicolon
id|hwsize
op_assign
l_int|320
suffix:semicolon
id|vwsize
op_assign
l_int|240
suffix:semicolon
)brace
)brace
multiline_comment|/* Center the window */
id|hoffset
op_assign
(paren
(paren
id|hwsize
op_minus
id|width
)paren
op_div
l_int|2
)paren
op_rshift
id|hwscale
suffix:semicolon
id|voffset
op_assign
(paren
(paren
id|vwsize
op_minus
id|height
)paren
op_div
l_int|2
)paren
op_rshift
id|vwscale
suffix:semicolon
multiline_comment|/* FIXME! - This needs to be changed to support 160x120 and 6620!!! */
r_if
c_cond
(paren
id|sub_flag
)paren
(brace
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x17
comma
id|hwsbase
op_plus
(paren
id|ov-&gt;subx
op_rshift
id|hwscale
)paren
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x18
comma
id|hwebase
op_plus
(paren
(paren
id|ov-&gt;subx
op_plus
id|ov-&gt;subw
)paren
op_rshift
id|hwscale
)paren
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x19
comma
id|vwsbase
op_plus
(paren
id|ov-&gt;suby
op_rshift
id|vwscale
)paren
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x1a
comma
id|vwebase
op_plus
(paren
(paren
id|ov-&gt;suby
op_plus
id|ov-&gt;subh
)paren
op_rshift
id|vwscale
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x17
comma
id|hwsbase
op_plus
id|hoffset
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x18
comma
id|hwebase
op_plus
id|hoffset
op_plus
(paren
id|hwsize
op_rshift
id|hwscale
)paren
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x19
comma
id|vwsbase
op_plus
id|voffset
)paren
suffix:semicolon
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x1a
comma
id|vwebase
op_plus
id|voffset
op_plus
(paren
id|vwsize
op_rshift
id|vwscale
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef OV511_DEBUG
r_if
c_cond
(paren
id|dump_sensor
)paren
id|dump_i2c_regs
c_func
(paren
id|ov
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set up the OV511/OV511+ with the given image parameters.&n; *&n; * Do not put any sensor-specific code in here (including I2C I/O functions)&n; */
r_static
r_int
DECL|function|ov511_mode_init_regs
id|ov511_mode_init_regs
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|mode
comma
r_int
id|sub_flag
)paren
(brace
r_int
id|lncnt
comma
id|pxcnt
comma
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sub_flag
)paren
(brace
id|width
op_assign
id|ov-&gt;subw
suffix:semicolon
id|height
op_assign
id|ov-&gt;subh
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;width:%d, height:%d, mode:%d, sub:%d&quot;
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
)paren
suffix:semicolon
singleline_comment|// FIXME: This should be moved to a 7111a-specific function once
singleline_comment|// subcapture is dealt with properly
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_SAA7111A
)paren
(brace
r_if
c_cond
(paren
id|width
op_eq
l_int|320
op_logical_and
id|height
op_eq
l_int|240
)paren
(brace
multiline_comment|/* No need to do anything special */
)brace
r_else
r_if
c_cond
(paren
id|width
op_eq
l_int|640
op_logical_and
id|height
op_eq
l_int|480
)paren
(brace
multiline_comment|/* Set the OV511 up as 320x480, but keep the V4L&n;&t;&t;&t; * resolution as 640x480 */
id|width
op_assign
l_int|320
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;SAA7111A only supports 320x240 or 640x480&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Make sure width and height are a multiple of 8 */
r_if
c_cond
(paren
id|width
op_mod
l_int|8
op_logical_or
id|height
op_mod
l_int|8
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid size (%d, %d) (mode = %d)&quot;
comma
id|width
comma
id|height
comma
id|mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|width
OL
id|ov-&gt;minwidth
op_logical_or
id|height
OL
id|ov-&gt;minheight
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Requested dimensions are too small&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov51x_stop
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|VIDEO_PALETTE_GREY
)paren
(brace
id|reg_w
c_func
(paren
id|ov
comma
id|R511_CAM_UV_EN
comma
l_int|0x00
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SNAP_UV_EN
comma
l_int|0x00
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SNAP_OPTS
comma
l_int|0x01
)paren
suffix:semicolon
)brace
r_else
(brace
id|reg_w
c_func
(paren
id|ov
comma
id|R511_CAM_UV_EN
comma
l_int|0x01
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SNAP_UV_EN
comma
l_int|0x01
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SNAP_OPTS
comma
l_int|0x03
)paren
suffix:semicolon
)brace
multiline_comment|/* Here I&squot;m assuming that snapshot size == image size.&n;&t; * I hope that&squot;s always true. --claudio&n;&t; */
id|pxcnt
op_assign
(paren
id|width
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
id|lncnt
op_assign
(paren
id|height
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_CAM_PXCNT
comma
id|pxcnt
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_CAM_LNCNT
comma
id|lncnt
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_CAM_PXDIV
comma
l_int|0x00
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_CAM_LNDIV
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* YUV420, low pass filer on */
id|reg_w
c_func
(paren
id|ov
comma
id|R511_CAM_OPTS
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* Snapshot additions */
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SNAP_PXCNT
comma
id|pxcnt
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SNAP_LNCNT
comma
id|lncnt
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SNAP_PXDIV
comma
l_int|0x00
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_SNAP_LNDIV
comma
l_int|0x00
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;compress
)paren
(brace
multiline_comment|/* Enable Y and UV quantization and compression */
id|reg_w
c_func
(paren
id|ov
comma
id|R511_COMP_EN
comma
l_int|0x07
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
id|R511_COMP_LUT_EN
comma
l_int|0x03
)paren
suffix:semicolon
id|ov51x_reset
c_func
(paren
id|ov
comma
id|OV511_RESET_OMNICE
)paren
suffix:semicolon
)brace
singleline_comment|//out:
r_if
c_cond
(paren
id|ov51x_restart
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|mlist518
r_static
r_struct
id|mode_list_518
id|mlist518
(braket
)braket
op_assign
(brace
multiline_comment|/* W    H   reg28 reg29 reg2a reg2c reg2e reg24 reg25 */
(brace
l_int|352
comma
l_int|288
comma
l_int|0x00
comma
l_int|0x16
comma
l_int|0x48
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x9f
comma
l_int|0x90
)brace
comma
(brace
l_int|320
comma
l_int|240
comma
l_int|0x00
comma
l_int|0x14
comma
l_int|0x3c
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x9f
comma
l_int|0x90
)brace
comma
(brace
l_int|176
comma
l_int|144
comma
l_int|0x05
comma
l_int|0x0b
comma
l_int|0x24
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xff
comma
l_int|0xf0
)brace
comma
(brace
l_int|160
comma
l_int|120
comma
l_int|0x05
comma
l_int|0x0a
comma
l_int|0x1e
comma
l_int|0x08
comma
l_int|0x0c
comma
l_int|0xff
comma
l_int|0xf0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Sets up the OV518/OV518+ with the given image parameters&n; *&n; * OV518 needs a completely different approach, until we can figure out what&n; * the individual registers do. Many register ops are commented out until we&n; * can find out if they are still valid. Also, only 15 FPS is supported now.&n; *&n; * Do not put any sensor-specific code in here (including I2C I/O functions)&n; */
r_static
r_int
DECL|function|ov518_mode_init_regs
id|ov518_mode_init_regs
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|mode
comma
r_int
id|sub_flag
)paren
(brace
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;width:%d, height:%d, mode:%d, sub:%d&quot;
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_stop
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|mlist518
(braket
id|i
)braket
dot
id|width
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|//&t;&t;int lncnt, pxcnt;
r_if
c_cond
(paren
id|width
op_ne
id|mlist518
(braket
id|i
)braket
dot
id|width
op_logical_or
id|height
op_ne
id|mlist518
(braket
id|i
)braket
dot
id|height
)paren
r_continue
suffix:semicolon
singleline_comment|// FIXME: Subcapture won&squot;t be possible until we know what the registers do
singleline_comment|// FIXME: We can&squot;t handle anything but YUV420 so far
singleline_comment|//&t;&t;/* Here I&squot;m assuming that snapshot size == image size.
singleline_comment|//&t;&t; * I hope that&squot;s always true. --claudio
singleline_comment|//&t;&t; */
singleline_comment|//&t;&t;pxcnt = sub_flag ? (ov-&gt;subw &gt;&gt; 3) - 1 : mlist[i].pxcnt;
singleline_comment|//&t;&t;lncnt = sub_flag ? (ov-&gt;subh &gt;&gt; 3) - 1 : mlist[i].lncnt;
singleline_comment|//
singleline_comment|//&t;&t;reg_w(ov, 0x12, pxcnt);
singleline_comment|//&t;&t;reg_w(ov, 0x13, lncnt);
multiline_comment|/******** Set the mode ********/
multiline_comment|/* Mode independent regs */
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2b
comma
l_int|0x00
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2d
comma
l_int|0x00
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x3b
comma
l_int|0x00
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x3d
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Mode dependent regs. Regs 38 - 3e are always the same as&n;&t;&t; * regs 28 - 2e */
id|reg_w_mask
c_func
(paren
id|ov
comma
l_int|0x28
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg28
op_or
(paren
id|mode
op_eq
id|VIDEO_PALETTE_GREY
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x00
comma
l_int|0x8f
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x29
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg29
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2a
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg2a
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2c
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg2c
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2e
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg2e
)paren
suffix:semicolon
id|reg_w_mask
c_func
(paren
id|ov
comma
l_int|0x38
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg28
op_or
(paren
id|mode
op_eq
id|VIDEO_PALETTE_GREY
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x00
comma
l_int|0x8f
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x39
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg29
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x3a
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg2a
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x3c
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg2c
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x3e
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg2e
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x24
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg24
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x25
comma
id|mlist518
(braket
id|i
)braket
dot
id|reg25
)paren
suffix:semicolon
multiline_comment|/* Windows driver does this here; who knows why */
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2f
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/******** Set the framerate (to 15 FPS) ********/
multiline_comment|/* Mode independent, but framerate dependent, regs */
multiline_comment|/* These are for 15 FPS only */
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x51
comma
l_int|0x08
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x22
comma
l_int|0x18
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x23
comma
l_int|0xff
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x71
comma
l_int|0x19
)paren
suffix:semicolon
multiline_comment|/* Compression-related? */
singleline_comment|// FIXME: Sensor-specific
multiline_comment|/* Bit 5 is what matters here. Of course, it is &quot;reserved&quot; */
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x54
comma
l_int|0x23
)paren
suffix:semicolon
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2f
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* Mode dependent regs */
r_if
c_cond
(paren
(paren
id|width
op_eq
l_int|352
op_logical_and
id|height
op_eq
l_int|288
)paren
op_logical_or
(paren
id|width
op_eq
l_int|320
op_logical_and
id|height
op_eq
l_int|240
)paren
)paren
(brace
multiline_comment|/*  640 (280h) byte iso packets */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0x30
comma
l_int|640
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 280h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xc4
comma
l_int|400
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 190h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xc6
comma
l_int|500
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 1f4h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xc7
comma
l_int|500
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 1f4h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xc8
comma
l_int|142
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 8eh    */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xca
comma
l_int|131098
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* 2001ah */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xcb
comma
l_int|532
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 214h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xcc
comma
l_int|2000
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 7d0h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xcd
comma
l_int|32
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 20h    */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xce
comma
l_int|608
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 260h   */
)brace
r_else
r_if
c_cond
(paren
(paren
id|width
op_eq
l_int|176
op_logical_and
id|height
op_eq
l_int|144
)paren
op_logical_or
(paren
id|width
op_eq
l_int|160
op_logical_and
id|height
op_eq
l_int|120
)paren
)paren
(brace
multiline_comment|/*  384 (180h) byte iso packets */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0x30
comma
l_int|384
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 180h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xc4
comma
l_int|200
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* c8h    */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xc6
comma
l_int|320
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 140h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xc7
comma
l_int|320
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 140h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xc8
comma
l_int|96
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 60h    */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xca
comma
l_int|78607
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* 1330fh */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xcb
comma
l_int|320
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 140h   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xcc
comma
l_int|1260
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 4ech   */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xcd
comma
l_int|19
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 13h    */
id|ov518_reg_w32
c_func
(paren
id|ov
comma
l_int|0xce
comma
l_int|365
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16dh   */
)brace
r_else
(brace
multiline_comment|/* Can&squot;t happen, since we already handled this case */
id|err
c_func
(paren
l_string|&quot;ov518_mode_init_regs(): **** logic error ****&quot;
)paren
suffix:semicolon
)brace
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2f
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov51x_restart
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Reset it just for good measure */
r_if
c_cond
(paren
id|ov51x_reset
c_func
(paren
id|ov
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|mlist518
(braket
id|i
)braket
dot
id|width
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Unknown mode (%d, %d): %d&quot;
comma
id|width
comma
id|height
comma
id|mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is a wrapper around the OV511, OV518, and sensor specific functions */
r_static
r_int
DECL|function|mode_init_regs
id|mode_init_regs
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|mode
comma
r_int
id|sub_flag
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov
op_logical_or
op_logical_neg
id|ov-&gt;dev
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
(brace
id|rc
op_assign
id|ov518_mode_init_regs
c_func
(paren
id|ov
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|ov511_mode_init_regs
c_func
(paren
id|ov
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
r_case
id|SEN_OV8600
suffix:colon
r_case
id|SEN_OV6620
suffix:colon
r_case
id|SEN_OV6630
suffix:colon
id|rc
op_assign
id|set_ov_sensor_window
c_func
(paren
id|ov
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_KS0127
suffix:colon
r_case
id|SEN_KS0127B
suffix:colon
id|err
c_func
(paren
l_string|&quot;KS0127-series decoders not supported yet&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_SAA7111A
suffix:colon
singleline_comment|//&t;&t;rc = mode_init_saa_sensor_regs(ov, width, height, mode, 
singleline_comment|//&t;&t;&t;&t;&t;       sub_flag);
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;SAA status = 0X%x&quot;
comma
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x1f
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Unknown sensor&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Sensor-independent settings */
id|rc
op_assign
id|sensor_set_auto_brightness
c_func
(paren
id|ov
comma
id|ov-&gt;auto_brt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|sensor_set_auto_exposure
c_func
(paren
id|ov
comma
id|ov-&gt;auto_exp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|sensor_set_banding_filter
c_func
(paren
id|ov
comma
id|bandingfilter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;lightfreq
)paren
(brace
id|rc
op_assign
id|sensor_set_light_freq
c_func
(paren
id|ov
comma
id|lightfreq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|sensor_set_backlight
c_func
(paren
id|ov
comma
id|ov-&gt;backlight
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FATAL_ERROR
c_func
(paren
id|rc
)paren
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This sets the default image parameters (Size = max, RGB24). This is&n; * useful for apps that use read() and do not set these.&n; */
r_static
r_int
DECL|function|ov51x_set_default_params
id|ov51x_set_default_params
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;%dx%d, RGB24&quot;
comma
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
suffix:semicolon
multiline_comment|/* Set default sizes in case IOCTL (VIDIOCMCAPTURE) is not used&n;&t; * (using read() instead). */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|width
op_assign
id|ov-&gt;maxwidth
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|height
op_assign
id|ov-&gt;maxheight
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|bytes_read
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|force_palette
)paren
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|format
op_assign
id|force_palette
suffix:semicolon
r_else
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|format
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|depth
op_assign
id|get_depth
c_func
(paren
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|format
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize to max width/height, RGB24 */
r_if
c_cond
(paren
id|mode_init_regs
c_func
(paren
id|ov
comma
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
comma
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|format
comma
l_int|0
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; * Video decoder stuff&n; *&n; **********************************************************************/
multiline_comment|/* Set analog input port of decoder */
r_static
r_int
DECL|function|decoder_set_input
id|decoder_set_input
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|input
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;port %d&quot;
comma
id|input
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_SAA7111A
suffix:colon
(brace
multiline_comment|/* Select mode */
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x02
comma
id|input
comma
l_int|0x07
)paren
suffix:semicolon
multiline_comment|/* Bypass chrominance trap for modes 4..7 */
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x09
comma
(paren
id|input
OG
l_int|3
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x00
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get ASCII name of video input */
r_static
r_int
DECL|function|decoder_get_input_name
id|decoder_get_input_name
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|input
comma
r_char
op_star
id|name
)paren
(brace
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_SAA7111A
suffix:colon
(brace
r_if
c_cond
(paren
id|input
template_param
l_int|7
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|input
OL
l_int|4
)paren
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;CVBS-%d&quot;
comma
id|input
)paren
suffix:semicolon
r_else
singleline_comment|// if (input &lt; 8)
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;S-Video-%d&quot;
comma
id|input
op_minus
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Camera&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set norm (NTSC, PAL, SECAM, AUTO) */
r_static
r_int
DECL|function|decoder_set_norm
id|decoder_set_norm
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|norm
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%d&quot;
comma
id|norm
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ov-&gt;sensor
)paren
(brace
r_case
id|SEN_SAA7111A
suffix:colon
(brace
r_int
id|reg_8
comma
id|reg_e
suffix:semicolon
r_if
c_cond
(paren
id|norm
op_eq
id|VIDEO_MODE_NTSC
)paren
(brace
id|reg_8
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* 60 Hz */
id|reg_e
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* NTSC M / PAL BGHI */
)brace
r_else
r_if
c_cond
(paren
id|norm
op_eq
id|VIDEO_MODE_PAL
)paren
(brace
id|reg_8
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* 50 Hz */
id|reg_e
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* NTSC M / PAL BGHI */
)brace
r_else
r_if
c_cond
(paren
id|norm
op_eq
id|VIDEO_MODE_AUTO
)paren
(brace
id|reg_8
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Auto field detect */
id|reg_e
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* NTSC M / PAL BGHI */
)brace
r_else
r_if
c_cond
(paren
id|norm
op_eq
id|VIDEO_MODE_SECAM
)paren
(brace
id|reg_8
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* 50 Hz */
id|reg_e
op_assign
l_int|0x50
suffix:semicolon
multiline_comment|/* SECAM / PAL 4.43 */
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x08
comma
id|reg_8
comma
l_int|0xc0
)paren
suffix:semicolon
id|i2c_w_mask
c_func
(paren
id|ov
comma
l_int|0x0e
comma
id|reg_e
comma
l_int|0x70
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; * Color correction functions&n; *&n; **********************************************************************/
multiline_comment|/*&n; * Turn a YUV4:2:0 block into an RGB block&n; *&n; * Video4Linux seems to use the blue, green, red channel&n; * order convention-- rgb[0] is blue, rgb[1] is green, rgb[2] is red.&n; *&n; * Color space conversion coefficients taken from the excellent&n; * http://www.inforamp.net/~poynton/ColorFAQ.html&n; * In his terminology, this is a CCIR 601.1 YCbCr -&gt; RGB.&n; * Y values are given for all 4 pixels, but the U (Pb)&n; * and V (Pr) are assumed constant over the 2x2 block.&n; *&n; * To avoid floating point arithmetic, the color conversion&n; * coefficients are scaled into 16.16 fixed-point integers.&n; * They were determined as follows:&n; *&n; *&t;double brightness = 1.0;  (0-&gt;black; 1-&gt;full scale) &n; *&t;double saturation = 1.0;  (0-&gt;greyscale; 1-&gt;full color)&n; *&t;double fixScale = brightness * 256 * 256;&n; *&t;int rvScale = (int)(1.402 * saturation * fixScale);&n; *&t;int guScale = (int)(-0.344136 * saturation * fixScale);&n; *&t;int gvScale = (int)(-0.714136 * saturation * fixScale);&n; *&t;int buScale = (int)(1.772 * saturation * fixScale);&n; *&t;int yScale = (int)(fixScale);&t;&n; */
multiline_comment|/* LIMIT: convert a 16.16 fixed-point value to a byte, with clipping. */
DECL|macro|LIMIT
mdefine_line|#define LIMIT(x) ((x)&gt;0xffffff?0xff: ((x)&lt;=0xffff?0:((x)&gt;&gt;16)))
r_static
r_inline
r_void
DECL|function|move_420_block
id|move_420_block
c_func
(paren
r_int
id|yTL
comma
r_int
id|yTR
comma
r_int
id|yBL
comma
r_int
id|yBR
comma
r_int
id|u
comma
r_int
id|v
comma
r_int
id|rowPixels
comma
r_int
r_char
op_star
id|rgb
comma
r_int
id|bits
)paren
(brace
r_const
r_int
id|rvScale
op_assign
l_int|91881
suffix:semicolon
r_const
r_int
id|guScale
op_assign
op_minus
l_int|22553
suffix:semicolon
r_const
r_int
id|gvScale
op_assign
op_minus
l_int|46801
suffix:semicolon
r_const
r_int
id|buScale
op_assign
l_int|116129
suffix:semicolon
r_const
r_int
id|yScale
op_assign
l_int|65536
suffix:semicolon
r_int
id|r
comma
id|g
comma
id|b
suffix:semicolon
id|g
op_assign
id|guScale
op_star
id|u
op_plus
id|gvScale
op_star
id|v
suffix:semicolon
r_if
c_cond
(paren
id|force_rgb
)paren
(brace
id|r
op_assign
id|buScale
op_star
id|u
suffix:semicolon
id|b
op_assign
id|rvScale
op_star
id|v
suffix:semicolon
)brace
r_else
(brace
id|r
op_assign
id|rvScale
op_star
id|v
suffix:semicolon
id|b
op_assign
id|buScale
op_star
id|u
suffix:semicolon
)brace
id|yTL
op_mul_assign
id|yScale
suffix:semicolon
id|yTR
op_mul_assign
id|yScale
suffix:semicolon
id|yBL
op_mul_assign
id|yScale
suffix:semicolon
id|yBR
op_mul_assign
id|yScale
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
l_int|24
)paren
(brace
multiline_comment|/* Write out top two pixels */
id|rgb
(braket
l_int|0
)braket
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|yTL
)paren
suffix:semicolon
id|rgb
(braket
l_int|1
)braket
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTL
)paren
suffix:semicolon
id|rgb
(braket
l_int|2
)braket
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|yTL
)paren
suffix:semicolon
id|rgb
(braket
l_int|3
)braket
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|yTR
)paren
suffix:semicolon
id|rgb
(braket
l_int|4
)braket
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTR
)paren
suffix:semicolon
id|rgb
(braket
l_int|5
)braket
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|yTR
)paren
suffix:semicolon
multiline_comment|/* Skip down to next line to write out bottom two pixels */
id|rgb
op_add_assign
l_int|3
op_star
id|rowPixels
suffix:semicolon
id|rgb
(braket
l_int|0
)braket
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|yBL
)paren
suffix:semicolon
id|rgb
(braket
l_int|1
)braket
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBL
)paren
suffix:semicolon
id|rgb
(braket
l_int|2
)braket
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|yBL
)paren
suffix:semicolon
id|rgb
(braket
l_int|3
)braket
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|yBR
)paren
suffix:semicolon
id|rgb
(braket
l_int|4
)braket
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBR
)paren
suffix:semicolon
id|rgb
(braket
l_int|5
)braket
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|yBR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bits
op_eq
l_int|16
)paren
(brace
multiline_comment|/* Write out top two pixels */
id|rgb
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|yTL
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x1F
)paren
op_or
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTL
)paren
op_lshift
l_int|3
)paren
op_amp
l_int|0xE0
)paren
suffix:semicolon
id|rgb
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTL
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|yTL
)paren
op_amp
l_int|0xF8
)paren
suffix:semicolon
id|rgb
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|yTR
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x1F
)paren
op_or
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTR
)paren
op_lshift
l_int|3
)paren
op_amp
l_int|0xE0
)paren
suffix:semicolon
id|rgb
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTR
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|yTR
)paren
op_amp
l_int|0xF8
)paren
suffix:semicolon
multiline_comment|/* Skip down to next line to write out bottom two pixels */
id|rgb
op_add_assign
l_int|2
op_star
id|rowPixels
suffix:semicolon
id|rgb
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|yBL
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x1F
)paren
op_or
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBL
)paren
op_lshift
l_int|3
)paren
op_amp
l_int|0xE0
)paren
suffix:semicolon
id|rgb
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBL
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|yBL
)paren
op_amp
l_int|0xF8
)paren
suffix:semicolon
id|rgb
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|yBR
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x1F
)paren
op_or
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBR
)paren
op_lshift
l_int|3
)paren
op_amp
l_int|0xE0
)paren
suffix:semicolon
id|rgb
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBR
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|yBR
)paren
op_amp
l_int|0xF8
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**********************************************************************&n; *&n; * Raw data parsing&n; *&n; **********************************************************************/
multiline_comment|/* Copies a 64-byte segment at pIn to an 8x8 block at pOut. The width of the&n; * image at pOut is specified by w.&n; */
r_static
r_inline
r_void
DECL|function|make_8x8
id|make_8x8
c_func
(paren
r_int
r_char
op_star
id|pIn
comma
r_int
r_char
op_star
id|pOut
comma
r_int
id|w
)paren
(brace
r_int
r_char
op_star
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_int
id|x
comma
id|y
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
l_int|8
suffix:semicolon
id|y
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
l_int|8
suffix:semicolon
id|x
op_increment
)paren
(brace
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
)brace
id|pOut
op_add_assign
id|w
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * For RAW BW (YUV400) images, data shows up in 256 byte segments.&n; * The segments represent 4 squares of 8x8 pixels as follows:&n; *&n; *      0  1 ...  7    64  65 ...  71   ...  192 193 ... 199&n; *      8  9 ... 15    72  73 ...  79        200 201 ... 207&n; *           ...              ...                    ...&n; *     56 57 ... 63   120 121 ... 127        248 249 ... 255&n; *&n; */
r_static
r_void
DECL|function|yuv400raw_to_yuv400p
id|yuv400raw_to_yuv400p
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
comma
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
)paren
(brace
r_int
id|x
comma
id|y
suffix:semicolon
r_int
r_char
op_star
id|pIn
comma
op_star
id|pOut
comma
op_star
id|pOutLine
suffix:semicolon
multiline_comment|/* Copy Y */
id|pIn
op_assign
id|pIn0
suffix:semicolon
id|pOutLine
op_assign
id|pOut0
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|frame-&gt;rawheight
op_minus
l_int|1
suffix:semicolon
id|y
op_add_assign
l_int|8
)paren
(brace
id|pOut
op_assign
id|pOutLine
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|frame-&gt;rawwidth
op_minus
l_int|1
suffix:semicolon
id|x
op_add_assign
l_int|8
)paren
(brace
id|make_8x8
c_func
(paren
id|pIn
comma
id|pOut
comma
id|frame-&gt;rawwidth
)paren
suffix:semicolon
id|pIn
op_add_assign
l_int|64
suffix:semicolon
id|pOut
op_add_assign
l_int|8
suffix:semicolon
)brace
id|pOutLine
op_add_assign
l_int|8
op_star
id|frame-&gt;rawwidth
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * For YUV4:2:0 images, the data shows up in 384 byte segments.&n; * The first 64 bytes of each segment are U, the next 64 are V.  The U and&n; * V are arranged as follows:&n; *&n; *      0  1 ...  7&n; *      8  9 ... 15&n; *           ...   &n; *     56 57 ... 63&n; *&n; * U and V are shipped at half resolution (1 U,V sample -&gt; one 2x2 block).&n; *&n; * The next 256 bytes are full resolution Y data and represent 4 squares&n; * of 8x8 pixels as follows:&n; *&n; *      0  1 ...  7    64  65 ...  71   ...  192 193 ... 199&n; *      8  9 ... 15    72  73 ...  79        200 201 ... 207&n; *           ...              ...                    ...&n; *     56 57 ... 63   120 121 ... 127   ...  248 249 ... 255&n; *&n; * Note that the U and V data in one segment represents a 16 x 16 pixel&n; * area, but the Y data represents a 32 x 8 pixel area. If the width is not an&n; * even multiple of 32, the extra 8x8 blocks within a 32x8 block belong to the&n; * next horizontal stripe.&n; *&n; * If dumppix module param is set, _parse_data just dumps the incoming segments,&n; * verbatim, in order, into the frame. When used with vidcat -f ppm -s 640x480&n; * this puts the data on the standard output and can be analyzed with the&n; * parseppm.c utility I wrote.  That&squot;s a much faster way for figuring out how&n; * this data is scrambled.&n; */
multiline_comment|/* Converts from raw, uncompressed segments at pIn0 to a YUV420P frame at pOut0.&n; *&n; * FIXME: Currently only handles width and height that are multiples of 16&n; */
r_static
r_void
DECL|function|yuv420raw_to_yuv420p
id|yuv420raw_to_yuv420p
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
comma
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
)paren
(brace
r_int
id|k
comma
id|x
comma
id|y
suffix:semicolon
r_int
r_char
op_star
id|pIn
comma
op_star
id|pOut
comma
op_star
id|pOutLine
suffix:semicolon
r_const
r_int
r_int
id|a
op_assign
id|frame-&gt;rawwidth
op_star
id|frame-&gt;rawheight
suffix:semicolon
r_const
r_int
r_int
id|w
op_assign
id|frame-&gt;rawwidth
op_div
l_int|2
suffix:semicolon
multiline_comment|/* Copy U and V */
id|pIn
op_assign
id|pIn0
suffix:semicolon
id|pOutLine
op_assign
id|pOut0
op_plus
id|a
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|frame-&gt;rawheight
op_minus
l_int|1
suffix:semicolon
id|y
op_add_assign
l_int|16
)paren
(brace
id|pOut
op_assign
id|pOutLine
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|frame-&gt;rawwidth
op_minus
l_int|1
suffix:semicolon
id|x
op_add_assign
l_int|16
)paren
(brace
id|make_8x8
c_func
(paren
id|pIn
comma
id|pOut
comma
id|w
)paren
suffix:semicolon
id|make_8x8
c_func
(paren
id|pIn
op_plus
l_int|64
comma
id|pOut
op_plus
id|a
op_div
l_int|4
comma
id|w
)paren
suffix:semicolon
id|pIn
op_add_assign
l_int|384
suffix:semicolon
id|pOut
op_add_assign
l_int|8
suffix:semicolon
)brace
id|pOutLine
op_add_assign
l_int|8
op_star
id|w
suffix:semicolon
)brace
multiline_comment|/* Copy Y */
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOutLine
op_assign
id|pOut0
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|frame-&gt;rawheight
op_minus
l_int|1
suffix:semicolon
id|y
op_add_assign
l_int|8
)paren
(brace
id|pOut
op_assign
id|pOutLine
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|frame-&gt;rawwidth
op_minus
l_int|1
suffix:semicolon
id|x
op_add_assign
l_int|8
)paren
(brace
id|make_8x8
c_func
(paren
id|pIn
comma
id|pOut
comma
id|frame-&gt;rawwidth
)paren
suffix:semicolon
id|pIn
op_add_assign
l_int|64
suffix:semicolon
id|pOut
op_add_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
op_increment
id|k
)paren
OG
l_int|3
)paren
(brace
id|k
op_assign
l_int|0
suffix:semicolon
id|pIn
op_add_assign
l_int|128
suffix:semicolon
)brace
)brace
id|pOutLine
op_add_assign
l_int|8
op_star
id|frame-&gt;rawwidth
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * fixFrameRGBoffset--&n; * My camera seems to return the red channel about 1 pixel&n; * low, and the blue channel about 1 pixel high. After YUV-&gt;RGB&n; * conversion, we can correct this easily. OSL 2/24/2000.&n; */
r_static
r_void
DECL|function|fixFrameRGBoffset
id|fixFrameRGBoffset
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
)paren
(brace
r_int
id|x
comma
id|y
suffix:semicolon
r_int
id|rowBytes
op_assign
id|frame-&gt;width
op_star
l_int|3
comma
id|w
op_assign
id|frame-&gt;width
suffix:semicolon
r_int
r_char
op_star
id|rgb
op_assign
id|frame-&gt;data
suffix:semicolon
r_const
r_int
id|shift
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Distance to shift pixels by, vertically */
multiline_comment|/* Don&squot;t bother with little images */
r_if
c_cond
(paren
id|frame-&gt;width
OL
l_int|400
)paren
r_return
suffix:semicolon
multiline_comment|/* This only works with RGB24 */
r_if
c_cond
(paren
id|frame-&gt;format
op_ne
id|VIDEO_PALETTE_RGB24
)paren
r_return
suffix:semicolon
multiline_comment|/* Shift red channel up */
r_for
c_loop
(paren
id|y
op_assign
id|shift
suffix:semicolon
id|y
OL
id|frame-&gt;height
suffix:semicolon
id|y
op_increment
)paren
(brace
r_int
id|lp
op_assign
(paren
id|y
op_minus
id|shift
)paren
op_star
id|rowBytes
suffix:semicolon
multiline_comment|/* Previous line offset */
r_int
id|lc
op_assign
id|y
op_star
id|rowBytes
suffix:semicolon
multiline_comment|/* Current line offset */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|w
suffix:semicolon
id|x
op_increment
)paren
id|rgb
(braket
id|lp
op_plus
id|x
op_star
l_int|3
op_plus
l_int|2
)braket
op_assign
id|rgb
(braket
id|lc
op_plus
id|x
op_star
l_int|3
op_plus
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Shift red up */
)brace
multiline_comment|/* Shift blue channel down */
r_for
c_loop
(paren
id|y
op_assign
id|frame-&gt;height
op_minus
id|shift
op_minus
l_int|1
suffix:semicolon
id|y
op_ge
l_int|0
suffix:semicolon
id|y
op_decrement
)paren
(brace
r_int
id|ln
op_assign
(paren
id|y
op_plus
id|shift
)paren
op_star
id|rowBytes
suffix:semicolon
multiline_comment|/* Next line offset */
r_int
id|lc
op_assign
id|y
op_star
id|rowBytes
suffix:semicolon
multiline_comment|/* Current line offset */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|w
suffix:semicolon
id|x
op_increment
)paren
id|rgb
(braket
id|ln
op_plus
id|x
op_star
l_int|3
op_plus
l_int|0
)braket
op_assign
id|rgb
(braket
id|lc
op_plus
id|x
op_star
l_int|3
op_plus
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Shift blue down */
)brace
)brace
multiline_comment|/**********************************************************************&n; *&n; * Decompression&n; *&n; **********************************************************************/
multiline_comment|/* Chooses a decompression module, locks it, and sets ov-&gt;decomp_ops&n; * accordingly. Returns -ENXIO if decompressor is not available, otherwise&n; * returns 0 if no other error.&n; */
r_static
r_int
DECL|function|request_decompressor
id|request_decompressor
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ov
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;decomp_ops
)paren
(brace
id|err
c_func
(paren
l_string|&quot;ERROR: Decompressor already requested!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Try to get MMX, and fall back on no-MMX if necessary */
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV511
)paren
(brace
r_if
c_cond
(paren
id|ov511_mmx_decomp_ops
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Using OV511 MMX decompressor&quot;
)paren
suffix:semicolon
id|ov-&gt;decomp_ops
op_assign
id|ov511_mmx_decomp_ops
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ov511_decomp_ops
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Using OV511 decompressor&quot;
)paren
suffix:semicolon
id|ov-&gt;decomp_ops
op_assign
id|ov511_decomp_ops
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;No decompressor available&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
(brace
r_if
c_cond
(paren
id|ov518_mmx_decomp_ops
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Using OV518 MMX decompressor&quot;
)paren
suffix:semicolon
id|ov-&gt;decomp_ops
op_assign
id|ov518_mmx_decomp_ops
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ov518_decomp_ops
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Using OV518 decompressor&quot;
)paren
suffix:semicolon
id|ov-&gt;decomp_ops
op_assign
id|ov518_decomp_ops
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;No decompressor available&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Unknown bridge&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;decomp_ops
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;decomp_ops-&gt;decomp_lock
)paren
(brace
id|ov-&gt;decomp_ops
op_assign
l_int|NULL
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|ov-&gt;decomp_ops
op_member_access_from_pointer
id|decomp_lock
c_func
(paren
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
multiline_comment|/* Unlocks decompression module and nulls ov-&gt;decomp_ops. Safe to call even&n; * if ov-&gt;decomp_ops is NULL.&n; */
r_static
r_void
DECL|function|release_decompressor
id|release_decompressor
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|released
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Did we actually do anything? */
r_if
c_cond
(paren
op_logical_neg
id|ov
)paren
r_return
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;decomp_ops
op_logical_and
id|ov-&gt;decomp_ops-&gt;decomp_unlock
)paren
(brace
id|ov-&gt;decomp_ops
op_member_access_from_pointer
id|decomp_unlock
c_func
(paren
)paren
suffix:semicolon
id|released
op_assign
l_int|1
suffix:semicolon
)brace
id|ov-&gt;decomp_ops
op_assign
l_int|NULL
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|released
)paren
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Decompressor released&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|decompress
id|decompress
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_struct
id|ov511_frame
op_star
id|frame
comma
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;decomp_ops
)paren
r_if
c_cond
(paren
id|request_decompressor
c_func
(paren
id|ov
)paren
)paren
r_return
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Decompressing %d bytes&quot;
comma
id|frame-&gt;bytes_recvd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;format
op_eq
id|VIDEO_PALETTE_GREY
op_logical_and
id|ov-&gt;decomp_ops-&gt;decomp_400
)paren
(brace
r_int
id|ret
op_assign
id|ov-&gt;decomp_ops
op_member_access_from_pointer
id|decomp_400
c_func
(paren
id|pIn0
comma
id|pOut0
comma
id|frame-&gt;compbuf
comma
id|frame-&gt;rawwidth
comma
id|frame-&gt;rawheight
comma
id|frame-&gt;bytes_recvd
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;DEBUG: decomp_400 returned %d&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;decomp_ops-&gt;decomp_420
)paren
(brace
r_int
id|ret
op_assign
id|ov-&gt;decomp_ops
op_member_access_from_pointer
id|decomp_420
c_func
(paren
id|pIn0
comma
id|pOut0
comma
id|frame-&gt;compbuf
comma
id|frame-&gt;rawwidth
comma
id|frame-&gt;rawheight
comma
id|frame-&gt;bytes_recvd
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;DEBUG: decomp_420 returned %d&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Decompressor does not support this format&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**********************************************************************&n; *&n; * Format conversion&n; *&n; **********************************************************************/
multiline_comment|/* Converts from planar YUV420 to RGB24. */
r_static
r_void
DECL|function|yuv420p_to_rgb
id|yuv420p_to_rgb
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
comma
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
comma
r_int
id|bits
)paren
(brace
r_const
r_int
id|numpix
op_assign
id|frame-&gt;width
op_star
id|frame-&gt;height
suffix:semicolon
r_const
r_int
id|bytes
op_assign
id|bits
op_rshift
l_int|3
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|y00
comma
id|y01
comma
id|y10
comma
id|y11
comma
id|u
comma
id|v
suffix:semicolon
r_int
r_char
op_star
id|pY
op_assign
id|pIn0
suffix:semicolon
r_int
r_char
op_star
id|pU
op_assign
id|pY
op_plus
id|numpix
suffix:semicolon
r_int
r_char
op_star
id|pV
op_assign
id|pU
op_plus
id|numpix
op_div
l_int|4
suffix:semicolon
r_int
r_char
op_star
id|pOut
op_assign
id|pOut0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|frame-&gt;height
op_minus
l_int|2
suffix:semicolon
id|j
op_add_assign
l_int|2
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|frame-&gt;width
op_minus
l_int|2
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|y00
op_assign
op_star
id|pY
suffix:semicolon
id|y01
op_assign
op_star
(paren
id|pY
op_plus
l_int|1
)paren
suffix:semicolon
id|y10
op_assign
op_star
(paren
id|pY
op_plus
id|frame-&gt;width
)paren
suffix:semicolon
id|y11
op_assign
op_star
(paren
id|pY
op_plus
id|frame-&gt;width
op_plus
l_int|1
)paren
suffix:semicolon
id|u
op_assign
(paren
op_star
id|pU
op_increment
)paren
op_minus
l_int|128
suffix:semicolon
id|v
op_assign
(paren
op_star
id|pV
op_increment
)paren
op_minus
l_int|128
suffix:semicolon
id|move_420_block
c_func
(paren
id|y00
comma
id|y01
comma
id|y10
comma
id|y11
comma
id|u
comma
id|v
comma
id|frame-&gt;width
comma
id|pOut
comma
id|bits
)paren
suffix:semicolon
id|pY
op_add_assign
l_int|2
suffix:semicolon
id|pOut
op_add_assign
l_int|2
op_star
id|bytes
suffix:semicolon
)brace
id|pY
op_add_assign
id|frame-&gt;width
suffix:semicolon
id|pOut
op_add_assign
id|frame-&gt;width
op_star
id|bytes
suffix:semicolon
)brace
)brace
multiline_comment|/* Converts from planar YUV420 to YUV422 (YUYV). */
r_static
r_void
DECL|function|yuv420p_to_yuv422
id|yuv420p_to_yuv422
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
comma
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
)paren
(brace
r_const
r_int
id|numpix
op_assign
id|frame-&gt;width
op_star
id|frame-&gt;height
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_char
op_star
id|pY
op_assign
id|pIn0
suffix:semicolon
r_int
r_char
op_star
id|pU
op_assign
id|pY
op_plus
id|numpix
suffix:semicolon
r_int
r_char
op_star
id|pV
op_assign
id|pU
op_plus
id|numpix
op_div
l_int|4
suffix:semicolon
r_int
r_char
op_star
id|pOut
op_assign
id|pOut0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numpix
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|pOut
op_assign
op_star
(paren
id|pY
op_plus
id|i
)paren
suffix:semicolon
id|pOut
op_add_assign
l_int|2
suffix:semicolon
)brace
id|pOut
op_assign
id|pOut0
op_plus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|frame-&gt;height
op_minus
l_int|2
suffix:semicolon
id|j
op_add_assign
l_int|2
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|frame-&gt;width
op_minus
l_int|2
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
r_int
id|u
op_assign
op_star
id|pU
op_increment
suffix:semicolon
r_int
id|v
op_assign
op_star
id|pV
op_increment
suffix:semicolon
op_star
id|pOut
op_assign
id|u
suffix:semicolon
op_star
(paren
id|pOut
op_plus
l_int|2
)paren
op_assign
id|v
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|frame-&gt;width
op_star
l_int|2
)paren
op_assign
id|u
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|frame-&gt;width
op_star
l_int|2
op_plus
l_int|2
)paren
op_assign
id|v
suffix:semicolon
id|pOut
op_add_assign
l_int|4
suffix:semicolon
)brace
id|pOut
op_add_assign
(paren
id|frame-&gt;width
op_star
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Converts pData from planar YUV420 to planar YUV422 **in place**. */
r_static
r_void
DECL|function|yuv420p_to_yuv422p
id|yuv420p_to_yuv422p
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
comma
r_int
r_char
op_star
id|pData
)paren
(brace
r_const
r_int
id|numpix
op_assign
id|frame-&gt;width
op_star
id|frame-&gt;height
suffix:semicolon
r_const
r_int
id|w
op_assign
id|frame-&gt;width
suffix:semicolon
r_int
id|j
suffix:semicolon
r_int
r_char
op_star
id|pIn
comma
op_star
id|pOut
suffix:semicolon
multiline_comment|/* Clear U and V */
id|memset
c_func
(paren
id|pData
op_plus
id|numpix
op_plus
id|numpix
op_div
l_int|2
comma
l_int|127
comma
id|numpix
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Convert V starting from beginning and working forward */
id|pIn
op_assign
id|pData
op_plus
id|numpix
op_plus
id|numpix
op_div
l_int|4
suffix:semicolon
id|pOut
op_assign
id|pData
op_plus
id|numpix
op_plus
id|numpix
op_div
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|frame-&gt;height
op_minus
l_int|2
suffix:semicolon
id|j
op_add_assign
l_int|2
)paren
(brace
id|memmove
c_func
(paren
id|pOut
comma
id|pIn
comma
id|w
op_div
l_int|2
)paren
suffix:semicolon
id|memmove
c_func
(paren
id|pOut
op_plus
id|w
op_div
l_int|2
comma
id|pIn
comma
id|w
op_div
l_int|2
)paren
suffix:semicolon
id|pIn
op_add_assign
id|w
op_div
l_int|2
suffix:semicolon
id|pOut
op_add_assign
id|w
suffix:semicolon
)brace
multiline_comment|/* Convert U, starting from end and working backward */
id|pIn
op_assign
id|pData
op_plus
id|numpix
op_plus
id|numpix
op_div
l_int|4
suffix:semicolon
id|pOut
op_assign
id|pData
op_plus
id|numpix
op_plus
id|numpix
op_div
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|frame-&gt;height
op_minus
l_int|2
suffix:semicolon
id|j
op_add_assign
l_int|2
)paren
(brace
id|pIn
op_sub_assign
id|w
op_div
l_int|2
suffix:semicolon
id|pOut
op_sub_assign
id|w
suffix:semicolon
id|memmove
c_func
(paren
id|pOut
comma
id|pIn
comma
id|w
op_div
l_int|2
)paren
suffix:semicolon
id|memmove
c_func
(paren
id|pOut
op_plus
id|w
op_div
l_int|2
comma
id|pIn
comma
id|w
op_div
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Fuses even and odd fields together, and doubles width.&n; * INPUT: an odd field followed by an even field at pIn0, in YUV planar format&n; * OUTPUT: a normal YUV planar image, with correct aspect ratio&n; */
r_static
r_void
DECL|function|deinterlace
id|deinterlace
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
comma
r_int
id|rawformat
comma
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
)paren
(brace
r_const
r_int
id|fieldheight
op_assign
id|frame-&gt;rawheight
op_div
l_int|2
suffix:semicolon
r_const
r_int
id|fieldpix
op_assign
id|fieldheight
op_star
id|frame-&gt;rawwidth
suffix:semicolon
r_const
r_int
id|w
op_assign
id|frame-&gt;width
suffix:semicolon
r_int
id|x
comma
id|y
suffix:semicolon
r_int
r_char
op_star
id|pInEven
comma
op_star
id|pInOdd
comma
op_star
id|pOut
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;fieldheight=%d&quot;
comma
id|fieldheight
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;rawheight
op_ne
id|frame-&gt;height
)paren
(brace
id|err
c_func
(paren
l_string|&quot;invalid height&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|frame-&gt;rawwidth
op_star
l_int|2
)paren
op_ne
id|frame-&gt;width
)paren
(brace
id|err
c_func
(paren
l_string|&quot;invalid width&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Y */
id|pInOdd
op_assign
id|pIn0
suffix:semicolon
id|pInEven
op_assign
id|pInOdd
op_plus
id|fieldpix
suffix:semicolon
id|pOut
op_assign
id|pOut0
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|fieldheight
suffix:semicolon
id|y
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|frame-&gt;rawwidth
suffix:semicolon
id|x
op_increment
)paren
(brace
op_star
id|pOut
op_assign
op_star
id|pInEven
suffix:semicolon
op_star
(paren
id|pOut
op_plus
l_int|1
)paren
op_assign
op_star
id|pInEven
op_increment
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|w
)paren
op_assign
op_star
id|pInOdd
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|w
op_plus
l_int|1
)paren
op_assign
op_star
id|pInOdd
op_increment
suffix:semicolon
id|pOut
op_add_assign
l_int|2
suffix:semicolon
)brace
id|pOut
op_add_assign
id|w
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rawformat
op_eq
id|RAWFMT_YUV420
)paren
(brace
multiline_comment|/* U */
id|pInOdd
op_assign
id|pIn0
op_plus
id|fieldpix
op_star
l_int|2
suffix:semicolon
id|pInEven
op_assign
id|pInOdd
op_plus
id|fieldpix
op_div
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|fieldheight
op_div
l_int|2
suffix:semicolon
id|y
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|frame-&gt;rawwidth
op_div
l_int|2
suffix:semicolon
id|x
op_increment
)paren
(brace
op_star
id|pOut
op_assign
op_star
id|pInEven
suffix:semicolon
op_star
(paren
id|pOut
op_plus
l_int|1
)paren
op_assign
op_star
id|pInEven
op_increment
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|w
op_div
l_int|2
)paren
op_assign
op_star
id|pInOdd
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|w
op_div
l_int|2
op_plus
l_int|1
)paren
op_assign
op_star
id|pInOdd
op_increment
suffix:semicolon
id|pOut
op_add_assign
l_int|2
suffix:semicolon
)brace
id|pOut
op_add_assign
id|w
op_div
l_int|2
suffix:semicolon
)brace
multiline_comment|/* V */
id|pInOdd
op_assign
id|pIn0
op_plus
id|fieldpix
op_star
l_int|2
op_plus
id|fieldpix
op_div
l_int|2
suffix:semicolon
id|pInEven
op_assign
id|pInOdd
op_plus
id|fieldpix
op_div
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|0
suffix:semicolon
id|y
OL
id|fieldheight
op_div
l_int|2
suffix:semicolon
id|y
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|frame-&gt;rawwidth
op_div
l_int|2
suffix:semicolon
id|x
op_increment
)paren
(brace
op_star
id|pOut
op_assign
op_star
id|pInEven
suffix:semicolon
op_star
(paren
id|pOut
op_plus
l_int|1
)paren
op_assign
op_star
id|pInEven
op_increment
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|w
op_div
l_int|2
)paren
op_assign
op_star
id|pInOdd
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|w
op_div
l_int|2
op_plus
l_int|1
)paren
op_assign
op_star
id|pInOdd
op_increment
suffix:semicolon
id|pOut
op_add_assign
l_int|2
suffix:semicolon
)brace
id|pOut
op_add_assign
id|w
op_div
l_int|2
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Post-processes the specified frame. This consists of:&n; * &t;1. Decompress frame, if necessary&n; *&t;2. Deinterlace frame and scale to proper size, if necessary&n; * &t;3. Convert from YUV planar to destination format, if necessary&n; * &t;4. Fix the RGB offset, if necessary&n; */
r_static
r_void
DECL|function|ov51x_postprocess
id|ov51x_postprocess
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_struct
id|ov511_frame
op_star
id|frame
)paren
(brace
r_if
c_cond
(paren
id|dumppix
)paren
(brace
id|memset
c_func
(paren
id|frame-&gt;data
comma
l_int|0
comma
id|MAX_DATA_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Dumping %d bytes&quot;
comma
id|frame-&gt;bytes_recvd
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|frame-&gt;data
comma
id|frame-&gt;rawdata
comma
id|frame-&gt;bytes_recvd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* YUV400 must be handled separately */
r_if
c_cond
(paren
id|frame-&gt;format
op_eq
id|VIDEO_PALETTE_GREY
)paren
(brace
multiline_comment|/* Deinterlace frame, if necessary */
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_SAA7111A
op_logical_and
id|frame-&gt;rawheight
op_eq
l_int|480
)paren
(brace
r_if
c_cond
(paren
id|frame-&gt;compressed
)paren
id|decompress
c_func
(paren
id|ov
comma
id|frame
comma
id|frame-&gt;rawdata
comma
id|frame-&gt;tempdata
)paren
suffix:semicolon
r_else
id|yuv400raw_to_yuv400p
c_func
(paren
id|frame
comma
id|frame-&gt;rawdata
comma
id|frame-&gt;tempdata
)paren
suffix:semicolon
id|deinterlace
c_func
(paren
id|frame
comma
id|RAWFMT_YUV400
comma
id|frame-&gt;tempdata
comma
id|frame-&gt;data
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|frame-&gt;compressed
)paren
id|decompress
c_func
(paren
id|ov
comma
id|frame
comma
id|frame-&gt;rawdata
comma
id|frame-&gt;data
)paren
suffix:semicolon
r_else
id|yuv400raw_to_yuv400p
c_func
(paren
id|frame
comma
id|frame-&gt;rawdata
comma
id|frame-&gt;data
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Process frame-&gt;data to frame-&gt;rawdata */
r_if
c_cond
(paren
id|frame-&gt;compressed
)paren
id|decompress
c_func
(paren
id|ov
comma
id|frame
comma
id|frame-&gt;rawdata
comma
id|frame-&gt;tempdata
)paren
suffix:semicolon
r_else
id|yuv420raw_to_yuv420p
c_func
(paren
id|frame
comma
id|frame-&gt;rawdata
comma
id|frame-&gt;tempdata
)paren
suffix:semicolon
multiline_comment|/* Deinterlace frame, if necessary */
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_SAA7111A
op_logical_and
id|frame-&gt;rawheight
op_eq
l_int|480
)paren
(brace
id|memcpy
c_func
(paren
id|frame-&gt;rawdata
comma
id|frame-&gt;tempdata
comma
id|MAX_RAW_DATA_SIZE
c_func
(paren
id|frame-&gt;width
comma
id|frame-&gt;height
)paren
)paren
suffix:semicolon
id|deinterlace
c_func
(paren
id|frame
comma
id|RAWFMT_YUV420
comma
id|frame-&gt;rawdata
comma
id|frame-&gt;tempdata
)paren
suffix:semicolon
)brace
multiline_comment|/* Frame should be (width x height) and not (rawwidth x rawheight) at&n;         * this point. */
macro_line|#if 0
multiline_comment|/* Clear output buffer for testing purposes */
id|memset
c_func
(paren
id|frame-&gt;data
comma
l_int|0
comma
id|MAX_DATA_SIZE
c_func
(paren
id|frame-&gt;width
comma
id|frame-&gt;height
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Process frame-&gt;tempdata to frame-&gt;data */
r_switch
c_cond
(paren
id|frame-&gt;format
)paren
(brace
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
id|yuv420p_to_rgb
c_func
(paren
id|frame
comma
id|frame-&gt;tempdata
comma
id|frame-&gt;data
comma
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
id|yuv420p_to_rgb
c_func
(paren
id|frame
comma
id|frame-&gt;tempdata
comma
id|frame-&gt;data
comma
l_int|24
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
id|yuv420p_to_yuv422
c_func
(paren
id|frame
comma
id|frame-&gt;tempdata
comma
id|frame-&gt;data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420
suffix:colon
r_case
id|VIDEO_PALETTE_YUV420P
suffix:colon
id|memcpy
c_func
(paren
id|frame-&gt;data
comma
id|frame-&gt;tempdata
comma
id|MAX_RAW_DATA_SIZE
c_func
(paren
id|frame-&gt;width
comma
id|frame-&gt;height
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422P
suffix:colon
multiline_comment|/* Data is converted in place, so copy it in advance */
id|memcpy
c_func
(paren
id|frame-&gt;data
comma
id|frame-&gt;tempdata
comma
id|MAX_RAW_DATA_SIZE
c_func
(paren
id|frame-&gt;width
comma
id|frame-&gt;height
)paren
)paren
suffix:semicolon
id|yuv420p_to_yuv422p
c_func
(paren
id|frame
comma
id|frame-&gt;data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Cannot convert data to %s&quot;
comma
id|symbolic
c_func
(paren
id|v4l1_plist
comma
id|frame-&gt;format
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fix_rgb_offset
)paren
id|fixFrameRGBoffset
c_func
(paren
id|frame
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; * OV51x data transfer, IRQ handler&n; *&n; **********************************************************************/
r_static
r_inline
r_void
DECL|function|ov511_move_data
id|ov511_move_data
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
op_star
id|in
comma
r_int
id|n
)paren
(brace
r_int
id|num
comma
id|offset
suffix:semicolon
r_int
id|pnum
op_assign
id|in
(braket
id|ov-&gt;packet_size
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Get packet number */
r_int
id|max_raw
op_assign
id|MAX_RAW_DATA_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
suffix:semicolon
r_struct
id|ov511_frame
op_star
id|frame
op_assign
op_amp
id|ov-&gt;frame
(braket
id|ov-&gt;curframe
)braket
suffix:semicolon
r_struct
id|timeval
op_star
id|ts
suffix:semicolon
multiline_comment|/* SOF/EOF packets have 1st to 8th bytes zeroed and the 9th&n;&t; * byte non-zero. The EOF packet has image width/height in the&n;&t; * 10th and 11th bytes. The 9th byte is given as follows:&n;&t; *&n;&t; * bit 7: EOF&n;&t; *     6: compression enabled&n;&t; *     5: 422/420/400 modes&n;&t; *     4: 422/420/400 modes&n;&t; *     3: 1&n;&t; *     2: snapshot button on&n;&t; *     1: snapshot frame&n;&t; *     0: even/odd field&n;&t; */
r_if
c_cond
(paren
id|printph
)paren
(brace
id|info
c_func
(paren
l_string|&quot;ph(%3d): %2x %2x %2x %2x %2x %2x %2x %2x %2x %2x %2x %2x&quot;
comma
id|pnum
comma
id|in
(braket
l_int|0
)braket
comma
id|in
(braket
l_int|1
)braket
comma
id|in
(braket
l_int|2
)braket
comma
id|in
(braket
l_int|3
)braket
comma
id|in
(braket
l_int|4
)braket
comma
id|in
(braket
l_int|5
)braket
comma
id|in
(braket
l_int|6
)braket
comma
id|in
(braket
l_int|7
)braket
comma
id|in
(braket
l_int|8
)braket
comma
id|in
(braket
l_int|9
)braket
comma
id|in
(braket
l_int|10
)braket
comma
id|in
(braket
l_int|11
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Check for SOF/EOF packet */
r_if
c_cond
(paren
(paren
id|in
(braket
l_int|0
)braket
op_or
id|in
(braket
l_int|1
)braket
op_or
id|in
(braket
l_int|2
)braket
op_or
id|in
(braket
l_int|3
)braket
op_or
id|in
(braket
l_int|4
)braket
op_or
id|in
(braket
l_int|5
)braket
op_or
id|in
(braket
l_int|6
)braket
op_or
id|in
(braket
l_int|7
)braket
)paren
op_logical_or
(paren
op_complement
id|in
(braket
l_int|8
)braket
op_amp
l_int|0x08
)paren
)paren
r_goto
id|check_middle
suffix:semicolon
multiline_comment|/* Frame end */
r_if
c_cond
(paren
id|in
(braket
l_int|8
)braket
op_amp
l_int|0x80
)paren
(brace
id|ts
op_assign
(paren
r_struct
id|timeval
op_star
)paren
(paren
id|frame-&gt;data
op_plus
id|MAX_FRAME_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
id|ts
)paren
suffix:semicolon
multiline_comment|/* Get the actual frame size from the EOF header */
id|frame-&gt;rawwidth
op_assign
(paren
(paren
r_int
)paren
(paren
id|in
(braket
l_int|9
)braket
)paren
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
id|frame-&gt;rawheight
op_assign
(paren
(paren
r_int
)paren
(paren
id|in
(braket
l_int|10
)braket
)paren
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame end, frame=%d, pnum=%d, w=%d, h=%d, recvd=%d&quot;
comma
id|ov-&gt;curframe
comma
id|pnum
comma
id|frame-&gt;rawwidth
comma
id|frame-&gt;rawheight
comma
id|frame-&gt;bytes_recvd
)paren
suffix:semicolon
multiline_comment|/* Validate the header data */
id|RESTRICT_TO_RANGE
c_func
(paren
id|frame-&gt;rawwidth
comma
id|ov-&gt;minwidth
comma
id|ov-&gt;maxwidth
)paren
suffix:semicolon
id|RESTRICT_TO_RANGE
c_func
(paren
id|frame-&gt;rawheight
comma
id|ov-&gt;minheight
comma
id|ov-&gt;maxheight
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t allow byte count to exceed buffer size */
id|RESTRICT_TO_RANGE
c_func
(paren
id|frame-&gt;bytes_recvd
comma
l_int|8
comma
id|max_raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_eq
id|STATE_LINES
)paren
(brace
r_int
id|nextf
suffix:semicolon
id|frame-&gt;grabstate
op_assign
id|FRAME_DONE
suffix:semicolon
singleline_comment|// FIXME: Is this right?
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
)paren
(brace
id|frame-&gt;grabstate
op_assign
id|FRAME_DONE
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
suffix:semicolon
)brace
multiline_comment|/* If next frame is ready or grabbing,&n;&t;&t;&t; * point to it */
id|nextf
op_assign
(paren
id|ov-&gt;curframe
op_plus
l_int|1
)paren
op_mod
id|OV511_NUMFRAMES
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
id|nextf
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
op_logical_or
id|ov-&gt;frame
(braket
id|nextf
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
(brace
id|ov-&gt;curframe
op_assign
id|nextf
suffix:semicolon
id|ov-&gt;frame
(braket
id|nextf
)braket
dot
id|scanstate
op_assign
id|STATE_SCANNING
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_DONE
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;** Frame done **&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame not ready? state = %d&quot;
comma
id|ov-&gt;frame
(braket
id|nextf
)braket
dot
id|grabstate
)paren
suffix:semicolon
)brace
id|ov-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;Frame done, but not scanning&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Image corruption caused by misplaced frame-&gt;segment = 0&n;&t;&t; * fixed by carlosf@conectiva.com.br&n;&t;&t; */
)brace
r_else
(brace
multiline_comment|/* Frame start */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame start, framenum = %d&quot;
comma
id|ov-&gt;curframe
)paren
suffix:semicolon
multiline_comment|/* Check to see if it&squot;s a snapshot frame */
multiline_comment|/* FIXME?? Should the snapshot reset go here? Performance? */
r_if
c_cond
(paren
id|in
(braket
l_int|8
)braket
op_amp
l_int|0x02
)paren
(brace
id|frame-&gt;snapshot
op_assign
l_int|1
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;snapshot detected&quot;
)paren
suffix:semicolon
)brace
id|frame-&gt;scanstate
op_assign
id|STATE_LINES
suffix:semicolon
id|frame-&gt;bytes_recvd
op_assign
l_int|0
suffix:semicolon
id|frame-&gt;compressed
op_assign
id|in
(braket
l_int|8
)braket
op_amp
l_int|0x40
suffix:semicolon
)brace
id|check_middle
suffix:colon
multiline_comment|/* Are we in a frame? */
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_ne
id|STATE_LINES
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;Not in a frame; packet skipped&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* If frame start, skip header */
r_if
c_cond
(paren
id|frame-&gt;bytes_recvd
op_eq
l_int|0
)paren
id|offset
op_assign
l_int|9
suffix:semicolon
r_else
id|offset
op_assign
l_int|0
suffix:semicolon
id|num
op_assign
id|n
op_minus
id|offset
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Dump all data exactly as received */
r_if
c_cond
(paren
id|dumppix
op_eq
l_int|2
)paren
(brace
id|frame-&gt;bytes_recvd
op_add_assign
id|n
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;bytes_recvd
op_le
id|max_raw
)paren
id|memcpy
c_func
(paren
id|frame-&gt;rawdata
op_plus
id|frame-&gt;bytes_recvd
op_minus
(paren
id|n
op_minus
l_int|1
)paren
comma
id|in
comma
id|n
op_minus
l_int|1
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Raw data buffer overrun!! (%d)&quot;
comma
id|frame-&gt;bytes_recvd
op_minus
id|max_raw
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|frame-&gt;compressed
op_logical_and
op_logical_neg
id|remove_zeros
)paren
(brace
id|frame-&gt;bytes_recvd
op_add_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;bytes_recvd
op_le
id|max_raw
)paren
id|memcpy
c_func
(paren
id|frame-&gt;rawdata
op_plus
id|frame-&gt;bytes_recvd
op_minus
id|num
comma
id|in
op_plus
id|offset
comma
id|num
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Raw data buffer overrun!! (%d)&quot;
comma
id|frame-&gt;bytes_recvd
op_minus
id|max_raw
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Remove all-zero FIFO lines (aligned 32-byte blocks) */
r_int
id|b
comma
id|read
op_assign
l_int|0
comma
id|allzero
comma
id|copied
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|offset
)paren
(brace
id|frame-&gt;bytes_recvd
op_add_assign
l_int|32
op_minus
id|offset
suffix:semicolon
singleline_comment|// Bytes out
id|memcpy
c_func
(paren
id|frame-&gt;rawdata
comma
id|in
op_plus
id|offset
comma
l_int|32
op_minus
id|offset
)paren
suffix:semicolon
id|read
op_add_assign
l_int|32
suffix:semicolon
)brace
r_while
c_loop
(paren
id|read
OL
id|n
op_minus
l_int|1
)paren
(brace
id|allzero
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
l_int|32
suffix:semicolon
id|b
op_increment
)paren
(brace
r_if
c_cond
(paren
id|in
(braket
id|read
op_plus
id|b
)braket
)paren
(brace
id|allzero
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|allzero
)paren
(brace
multiline_comment|/* Don&squot;t copy it */
)brace
r_else
(brace
r_if
c_cond
(paren
id|frame-&gt;bytes_recvd
op_plus
id|copied
op_plus
l_int|32
op_le
id|max_raw
)paren
(brace
id|memcpy
c_func
(paren
id|frame-&gt;rawdata
op_plus
id|frame-&gt;bytes_recvd
op_plus
id|copied
comma
id|in
op_plus
id|read
comma
l_int|32
)paren
suffix:semicolon
id|copied
op_add_assign
l_int|32
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Raw data buffer overrun!!&quot;
)paren
suffix:semicolon
)brace
)brace
id|read
op_add_assign
l_int|32
suffix:semicolon
)brace
id|frame-&gt;bytes_recvd
op_add_assign
id|copied
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|ov518_move_data
id|ov518_move_data
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_char
op_star
id|in
comma
r_int
id|n
)paren
(brace
r_int
id|max_raw
op_assign
id|MAX_RAW_DATA_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
suffix:semicolon
r_struct
id|ov511_frame
op_star
id|frame
op_assign
op_amp
id|ov-&gt;frame
(braket
id|ov-&gt;curframe
)braket
suffix:semicolon
r_struct
id|timeval
op_star
id|ts
suffix:semicolon
r_if
c_cond
(paren
id|printph
)paren
(brace
id|info
c_func
(paren
l_string|&quot;ph: %2x %2x %2x %2x %2x %2x %2x %2x %2x %2x %2x %2x&quot;
comma
id|in
(braket
l_int|0
)braket
comma
id|in
(braket
l_int|1
)braket
comma
id|in
(braket
l_int|2
)braket
comma
id|in
(braket
l_int|3
)braket
comma
id|in
(braket
l_int|4
)braket
comma
id|in
(braket
l_int|5
)braket
comma
id|in
(braket
l_int|6
)braket
comma
id|in
(braket
l_int|7
)braket
comma
id|in
(braket
l_int|8
)braket
comma
id|in
(braket
l_int|9
)braket
comma
id|in
(braket
l_int|10
)braket
comma
id|in
(braket
l_int|11
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* A false positive here is likely, until OVT gives me&n;&t; * the definitive SOF/EOF format */
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|in
(braket
l_int|0
)braket
op_or
id|in
(braket
l_int|1
)braket
op_or
id|in
(braket
l_int|2
)braket
op_or
id|in
(braket
l_int|3
)braket
op_or
id|in
(braket
l_int|5
)braket
)paren
)paren
op_logical_and
id|in
(braket
l_int|6
)braket
)paren
(brace
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_eq
id|STATE_LINES
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Detected frame end/start&quot;
)paren
suffix:semicolon
r_goto
id|eof
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//scanstate == STATE_SCANNING
multiline_comment|/* Frame start */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame start, framenum = %d&quot;
comma
id|ov-&gt;curframe
)paren
suffix:semicolon
r_goto
id|sof
suffix:semicolon
)brace
)brace
r_else
(brace
r_goto
id|check_middle
suffix:semicolon
)brace
id|eof
suffix:colon
id|ts
op_assign
(paren
r_struct
id|timeval
op_star
)paren
(paren
id|frame-&gt;data
op_plus
id|MAX_FRAME_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
id|ts
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame end, curframe = %d, hw=%d, vw=%d, recvd=%d&quot;
comma
id|ov-&gt;curframe
comma
(paren
r_int
)paren
(paren
id|in
(braket
l_int|9
)braket
)paren
comma
(paren
r_int
)paren
(paren
id|in
(braket
l_int|10
)braket
)paren
comma
id|frame-&gt;bytes_recvd
)paren
suffix:semicolon
singleline_comment|// FIXME: Since we don&squot;t know the header formats yet,
singleline_comment|// there is no way to know what the actual image size is
id|frame-&gt;rawwidth
op_assign
id|frame-&gt;width
suffix:semicolon
id|frame-&gt;rawheight
op_assign
id|frame-&gt;height
suffix:semicolon
multiline_comment|/* Validate the header data */
id|RESTRICT_TO_RANGE
c_func
(paren
id|frame-&gt;rawwidth
comma
id|ov-&gt;minwidth
comma
id|ov-&gt;maxwidth
)paren
suffix:semicolon
id|RESTRICT_TO_RANGE
c_func
(paren
id|frame-&gt;rawheight
comma
id|ov-&gt;minheight
comma
id|ov-&gt;maxheight
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t allow byte count to exceed buffer size */
id|RESTRICT_TO_RANGE
c_func
(paren
id|frame-&gt;bytes_recvd
comma
l_int|8
comma
id|max_raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_eq
id|STATE_LINES
)paren
(brace
r_int
id|nextf
suffix:semicolon
id|frame-&gt;grabstate
op_assign
id|FRAME_DONE
suffix:semicolon
singleline_comment|// FIXME: Is this right?
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
)paren
(brace
id|frame-&gt;grabstate
op_assign
id|FRAME_DONE
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
suffix:semicolon
)brace
multiline_comment|/* If next frame is ready or grabbing,&n;&t;&t; * point to it */
id|nextf
op_assign
(paren
id|ov-&gt;curframe
op_plus
l_int|1
)paren
op_mod
id|OV511_NUMFRAMES
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
id|nextf
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
op_logical_or
id|ov-&gt;frame
(braket
id|nextf
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
(brace
id|ov-&gt;curframe
op_assign
id|nextf
suffix:semicolon
id|ov-&gt;frame
(braket
id|nextf
)braket
dot
id|scanstate
op_assign
id|STATE_SCANNING
suffix:semicolon
id|frame
op_assign
op_amp
id|ov-&gt;frame
(braket
id|nextf
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_DONE
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;** Frame done **&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame not ready? state = %d&quot;
comma
id|ov-&gt;frame
(braket
id|nextf
)braket
dot
id|grabstate
)paren
suffix:semicolon
)brace
id|ov-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;SOF dropped (no active frame)&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Nowhere to store this frame */
)brace
)brace
id|sof
suffix:colon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Starting capture on frame %d&quot;
comma
id|frame-&gt;framenum
)paren
suffix:semicolon
singleline_comment|// Snapshot not reverse-engineered yet.
macro_line|#if 0
multiline_comment|/* Check to see if it&squot;s a snapshot frame */
multiline_comment|/* FIXME?? Should the snapshot reset go here? Performance? */
r_if
c_cond
(paren
id|in
(braket
l_int|8
)braket
op_amp
l_int|0x02
)paren
(brace
id|frame-&gt;snapshot
op_assign
l_int|1
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;snapshot detected&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|frame-&gt;scanstate
op_assign
id|STATE_LINES
suffix:semicolon
id|frame-&gt;bytes_recvd
op_assign
l_int|0
suffix:semicolon
singleline_comment|//&t;&t;frame-&gt;compressed = 1;
id|check_middle
suffix:colon
multiline_comment|/* Are we in a frame? */
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_ne
id|STATE_LINES
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;scanstate: no SOF yet&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Dump all data exactly as received */
r_if
c_cond
(paren
id|dumppix
op_eq
l_int|2
)paren
(brace
id|frame-&gt;bytes_recvd
op_add_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;bytes_recvd
op_le
id|max_raw
)paren
id|memcpy
c_func
(paren
id|frame-&gt;rawdata
op_plus
id|frame-&gt;bytes_recvd
op_minus
id|n
comma
id|in
comma
id|n
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Raw data buffer overrun!! (%d)&quot;
comma
id|frame-&gt;bytes_recvd
op_minus
id|max_raw
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* All incoming data are divided into 8-byte segments. If the&n;&t;&t; * segment contains all zero bytes, it must be skipped. These&n;&t;&t; * zero-segments allow the OV518 to mainain a constant data rate&n;&t;&t; * regardless of the effectiveness of the compression. Segments&n;&t;&t; * are aligned relative to the beginning of each isochronous&n;&t;&t; * packet. The first segment is a header (the decompressor&n;&t;&t; * skips it later).&n;&t;&t; */
r_int
id|b
comma
id|read
op_assign
l_int|0
comma
id|allzero
comma
id|copied
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|read
OL
id|n
)paren
(brace
id|allzero
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
l_int|8
suffix:semicolon
id|b
op_increment
)paren
(brace
r_if
c_cond
(paren
id|in
(braket
id|read
op_plus
id|b
)braket
)paren
(brace
id|allzero
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|allzero
)paren
(brace
multiline_comment|/* Don&squot;t copy it */
)brace
r_else
(brace
r_if
c_cond
(paren
id|frame-&gt;bytes_recvd
op_plus
id|copied
op_plus
l_int|8
op_le
id|max_raw
)paren
(brace
id|memcpy
c_func
(paren
id|frame-&gt;rawdata
op_plus
id|frame-&gt;bytes_recvd
op_plus
id|copied
comma
id|in
op_plus
id|read
comma
l_int|8
)paren
suffix:semicolon
id|copied
op_add_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Raw data buffer overrun!!&quot;
)paren
suffix:semicolon
)brace
)brace
id|read
op_add_assign
l_int|8
suffix:semicolon
)brace
id|frame-&gt;bytes_recvd
op_add_assign
id|copied
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ov51x_isoc_irq
id|ov51x_isoc_irq
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov
suffix:semicolon
r_struct
id|ov511_sbuf
op_star
id|sbuf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;context
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;no context&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sbuf
op_assign
id|urb-&gt;context
suffix:semicolon
id|ov
op_assign
id|sbuf-&gt;ov
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov
op_logical_or
op_logical_neg
id|ov-&gt;dev
op_logical_or
op_logical_neg
id|ov-&gt;user
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;no device, or not open&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;streaming
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;hmmm... not streaming, but got interrupt&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|ENOENT
op_logical_or
id|urb-&gt;status
op_eq
op_minus
id|ECONNRESET
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;URB unlinked&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
op_ne
op_minus
id|EINPROGRESS
op_logical_and
id|urb-&gt;status
op_ne
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;ERROR: urb-&gt;status=%d: %s&quot;
comma
id|urb-&gt;status
comma
id|symbolic
c_func
(paren
id|urb_errlist
comma
id|urb-&gt;status
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Copy the data received into our frame buffer */
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;sbuf[%d]: Moving %d packets&quot;
comma
id|sbuf-&gt;n
comma
id|urb-&gt;number_of_packets
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Warning: Don&squot;t call *_move_data() if no frame active! */
r_if
c_cond
(paren
id|ov-&gt;curframe
op_ge
l_int|0
)paren
(brace
r_int
id|n
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
suffix:semicolon
r_int
id|st
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
suffix:semicolon
r_int
r_char
op_star
id|cdata
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|cdata
op_assign
id|urb-&gt;transfer_buffer
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Zero-length packet&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st
)paren
id|PDEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;data error: [%d] len=%d, status=%d&quot;
comma
id|i
comma
id|n
comma
id|st
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV511
)paren
id|ov511_move_data
c_func
(paren
id|ov
comma
id|cdata
comma
id|n
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|ov518_move_data
c_func
(paren
id|ov
comma
id|cdata
comma
id|n
)paren
suffix:semicolon
r_else
id|err
c_func
(paren
l_string|&quot;Unknown bridge device (%d)&quot;
comma
id|ov-&gt;bridge
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|ov-&gt;wq
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|ov-&gt;wq
)paren
suffix:semicolon
)brace
)brace
id|urb-&gt;dev
op_assign
id|ov-&gt;dev
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Stream initialization and termination&n; *&n; ***************************************************************************/
r_static
r_int
DECL|function|ov51x_init_isoc
id|ov51x_init_isoc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|fx
comma
id|err
comma
id|n
comma
id|size
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;*** Initializing capture ***&quot;
)paren
suffix:semicolon
id|ov-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bridge
op_eq
id|BRG_OV511
)paren
(brace
r_if
c_cond
(paren
id|cams
op_eq
l_int|1
)paren
id|size
op_assign
l_int|993
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|2
)paren
id|size
op_assign
l_int|513
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|3
op_logical_or
id|cams
op_eq
l_int|4
)paren
id|size
op_assign
l_int|257
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;&bslash;&quot;cams&bslash;&quot; parameter too high!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;bridge
op_eq
id|BRG_OV511PLUS
)paren
(brace
r_if
c_cond
(paren
id|cams
op_eq
l_int|1
)paren
id|size
op_assign
l_int|961
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|2
)paren
id|size
op_assign
l_int|513
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|3
op_logical_or
id|cams
op_eq
l_int|4
)paren
id|size
op_assign
l_int|257
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_ge
l_int|5
op_logical_and
id|cams
op_le
l_int|8
)paren
id|size
op_assign
l_int|129
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_ge
l_int|9
op_logical_and
id|cams
op_le
l_int|31
)paren
id|size
op_assign
l_int|33
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;&bslash;&quot;cams&bslash;&quot; parameter too high!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
(brace
r_if
c_cond
(paren
id|cams
op_eq
l_int|1
)paren
id|size
op_assign
l_int|896
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|2
)paren
id|size
op_assign
l_int|512
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|3
op_logical_or
id|cams
op_eq
l_int|4
)paren
id|size
op_assign
l_int|256
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_ge
l_int|5
op_logical_and
id|cams
op_le
l_int|8
)paren
id|size
op_assign
l_int|128
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;&bslash;&quot;cams&bslash;&quot; parameter too high!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;invalid bridge type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|packetsize
op_eq
op_minus
l_int|1
)paren
(brace
singleline_comment|// FIXME: OV518 is hardcoded to 15 FPS (alternate 5) for now
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|ov51x_set_packet_size
c_func
(paren
id|ov
comma
l_int|640
)paren
suffix:semicolon
r_else
id|ov51x_set_packet_size
c_func
(paren
id|ov
comma
id|size
)paren
suffix:semicolon
)brace
r_else
(brace
id|info
c_func
(paren
l_string|&quot;Forcing packet size to %d&quot;
comma
id|packetsize
)paren
suffix:semicolon
id|ov51x_set_packet_size
c_func
(paren
id|ov
comma
id|packetsize
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMSBUF
suffix:semicolon
id|n
op_increment
)paren
(brace
id|urb
op_assign
id|usb_alloc_urb
c_func
(paren
id|FRAMES_PER_DESC
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;init isoc: usb_alloc_urb ret. NULL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
op_assign
id|urb
suffix:semicolon
id|urb-&gt;dev
op_assign
id|ov-&gt;dev
suffix:semicolon
id|urb-&gt;context
op_assign
op_amp
id|ov-&gt;sbuf
(braket
id|n
)braket
suffix:semicolon
id|urb-&gt;pipe
op_assign
id|usb_rcvisocpipe
c_func
(paren
id|ov-&gt;dev
comma
id|OV511_ENDPOINT_ADDRESS
)paren
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|USB_ISO_ASAP
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|data
suffix:semicolon
id|urb-&gt;complete
op_assign
id|ov51x_isoc_irq
suffix:semicolon
id|urb-&gt;number_of_packets
op_assign
id|FRAMES_PER_DESC
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|ov-&gt;packet_size
op_star
id|FRAMES_PER_DESC
suffix:semicolon
r_for
c_loop
(paren
id|fx
op_assign
l_int|0
suffix:semicolon
id|fx
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|fx
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|fx
)braket
dot
id|offset
op_assign
id|ov-&gt;packet_size
op_star
id|fx
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|fx
)braket
dot
id|length
op_assign
id|ov-&gt;packet_size
suffix:semicolon
)brace
)brace
id|ov-&gt;streaming
op_assign
l_int|1
suffix:semicolon
id|ov-&gt;sbuf
(braket
id|OV511_NUMSBUF
op_minus
l_int|1
)braket
dot
id|urb-&gt;next
op_assign
id|ov-&gt;sbuf
(braket
l_int|0
)braket
dot
id|urb
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMSBUF
op_minus
l_int|1
suffix:semicolon
id|n
op_increment
)paren
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|urb-&gt;next
op_assign
id|ov-&gt;sbuf
(braket
id|n
op_plus
l_int|1
)braket
dot
id|urb
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMSBUF
suffix:semicolon
id|n
op_increment
)paren
(brace
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|urb-&gt;dev
op_assign
id|ov-&gt;dev
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|err
c_func
(paren
l_string|&quot;init isoc: usb_submit_urb(%d) ret %d&quot;
comma
id|n
comma
id|err
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ov51x_unlink_isoc
id|ov51x_unlink_isoc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|n
suffix:semicolon
multiline_comment|/* Unschedule all of the iso td&squot;s */
r_for
c_loop
(paren
id|n
op_assign
id|OV511_NUMSBUF
op_minus
l_int|1
suffix:semicolon
id|n
op_ge
l_int|0
suffix:semicolon
id|n
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
suffix:semicolon
id|ov-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|ov51x_stop_isoc
id|ov51x_stop_isoc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;streaming
op_logical_or
op_logical_neg
id|ov-&gt;dev
)paren
r_return
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;*** Stopping capture ***&quot;
)paren
suffix:semicolon
id|ov51x_set_packet_size
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
id|ov-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|ov51x_unlink_isoc
c_func
(paren
id|ov
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ov51x_new_frame
id|ov51x_new_frame
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|framenum
)paren
(brace
r_struct
id|ov511_frame
op_star
id|frame
suffix:semicolon
r_int
id|newnum
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ov-&gt;curframe = %d, framenum = %d&quot;
comma
id|ov-&gt;curframe
comma
id|framenum
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;dev
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* If we&squot;re not grabbing a frame right now and the other frame is */
multiline_comment|/* ready to be grabbed into, then use it instead */
r_if
c_cond
(paren
id|ov-&gt;curframe
op_eq
op_minus
l_int|1
)paren
(brace
id|newnum
op_assign
(paren
id|framenum
op_minus
l_int|1
op_plus
id|OV511_NUMFRAMES
)paren
op_mod
id|OV511_NUMFRAMES
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
id|newnum
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
)paren
id|framenum
op_assign
id|newnum
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
id|frame
op_assign
op_amp
id|ov-&gt;frame
(braket
id|framenum
)braket
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;framenum = %d, width = %d, height = %d&quot;
comma
id|framenum
comma
id|frame-&gt;width
comma
id|frame-&gt;height
)paren
suffix:semicolon
id|frame-&gt;grabstate
op_assign
id|FRAME_GRABBING
suffix:semicolon
id|frame-&gt;scanstate
op_assign
id|STATE_SCANNING
suffix:semicolon
id|frame-&gt;snapshot
op_assign
l_int|0
suffix:semicolon
id|ov-&gt;curframe
op_assign
id|framenum
suffix:semicolon
multiline_comment|/* Make sure it&squot;s not too big */
r_if
c_cond
(paren
id|frame-&gt;width
OG
id|ov-&gt;maxwidth
)paren
id|frame-&gt;width
op_assign
id|ov-&gt;maxwidth
suffix:semicolon
id|frame-&gt;width
op_and_assign
op_complement
l_int|7L
suffix:semicolon
multiline_comment|/* Multiple of 8 */
r_if
c_cond
(paren
id|frame-&gt;height
OG
id|ov-&gt;maxheight
)paren
id|frame-&gt;height
op_assign
id|ov-&gt;maxheight
suffix:semicolon
id|frame-&gt;height
op_and_assign
op_complement
l_int|3L
suffix:semicolon
multiline_comment|/* Multiple of 4 */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Buffer management&n; *&n; ***************************************************************************/
multiline_comment|/* &n; * - You must acquire buf_lock before entering this function.&n; * - Because this code will free any non-null pointer, you must be sure to null&n; *   them if you explicitly free them somewhere else!&n; */
r_static
r_void
DECL|function|ov51x_do_dealloc
id|ov51x_do_dealloc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;entered&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;fbuf
)paren
(brace
id|rvfree
c_func
(paren
id|ov-&gt;fbuf
comma
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
)paren
suffix:semicolon
id|ov-&gt;fbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;rawfbuf
)paren
(brace
id|vfree
c_func
(paren
id|ov-&gt;rawfbuf
)paren
suffix:semicolon
id|ov-&gt;rawfbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;tempfbuf
)paren
(brace
id|vfree
c_func
(paren
id|ov-&gt;tempfbuf
)paren
suffix:semicolon
id|ov-&gt;tempfbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
(brace
id|kfree
c_func
(paren
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|data
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|data
op_assign
l_int|NULL
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|rawdata
op_assign
l_int|NULL
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|tempdata
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|compbuf
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|compbuf
)paren
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|compbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;buffer memory deallocated&quot;
)paren
suffix:semicolon
id|ov-&gt;buf_state
op_assign
id|BUF_NOT_ALLOCATED
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;leaving&quot;
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ov51x_alloc
id|ov51x_alloc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|i
suffix:semicolon
r_const
r_int
id|w
op_assign
id|ov-&gt;maxwidth
suffix:semicolon
r_const
r_int
id|h
op_assign
id|ov-&gt;maxheight
suffix:semicolon
r_const
r_int
id|data_bufsize
op_assign
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
c_func
(paren
id|w
comma
id|h
)paren
suffix:semicolon
r_const
r_int
id|raw_bufsize
op_assign
id|OV511_NUMFRAMES
op_star
id|MAX_RAW_DATA_SIZE
c_func
(paren
id|w
comma
id|h
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;entered&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;buf_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;buf_state
op_eq
id|BUF_PEND_DEALLOC
)paren
(brace
id|ov-&gt;buf_state
op_assign
id|BUF_ALLOCATED
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ov-&gt;buf_timer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;buf_state
op_eq
id|BUF_ALLOCATED
)paren
r_goto
id|out
suffix:semicolon
id|ov-&gt;fbuf
op_assign
id|rvmalloc
c_func
(paren
id|data_bufsize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;fbuf
)paren
r_goto
id|error
suffix:semicolon
id|ov-&gt;rawfbuf
op_assign
id|vmalloc
c_func
(paren
id|raw_bufsize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;rawfbuf
)paren
r_goto
id|error
suffix:semicolon
id|memset
c_func
(paren
id|ov-&gt;rawfbuf
comma
l_int|0
comma
id|raw_bufsize
)paren
suffix:semicolon
id|ov-&gt;tempfbuf
op_assign
id|vmalloc
c_func
(paren
id|raw_bufsize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;tempfbuf
)paren
r_goto
id|error
suffix:semicolon
id|memset
c_func
(paren
id|ov-&gt;tempfbuf
comma
l_int|0
comma
id|raw_bufsize
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|data
op_assign
id|kmalloc
c_func
(paren
id|FRAMES_PER_DESC
op_star
id|MAX_FRAME_SIZE_PER_DESC
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
r_goto
id|error
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;sbuf[%d] @ %p&quot;
comma
id|i
comma
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|data
op_assign
id|ov-&gt;fbuf
op_plus
id|i
op_star
id|MAX_DATA_SIZE
c_func
(paren
id|w
comma
id|h
)paren
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|rawdata
op_assign
id|ov-&gt;rawfbuf
op_plus
id|i
op_star
id|MAX_RAW_DATA_SIZE
c_func
(paren
id|w
comma
id|h
)paren
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|tempdata
op_assign
id|ov-&gt;tempfbuf
op_plus
id|i
op_star
id|MAX_RAW_DATA_SIZE
c_func
(paren
id|w
comma
id|h
)paren
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|compbuf
op_assign
(paren
r_int
r_char
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|compbuf
)paren
r_goto
id|error
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;frame[%d] @ %p&quot;
comma
id|i
comma
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
id|ov-&gt;buf_state
op_assign
id|BUF_ALLOCATED
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|ov-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;leaving&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|ov51x_do_dealloc
c_func
(paren
id|ov
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;errored&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_static
r_void
DECL|function|ov51x_buf_callback
id|ov51x_buf_callback
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|data
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;entered&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;buf_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;buf_state
op_eq
id|BUF_PEND_DEALLOC
)paren
id|ov51x_do_dealloc
c_func
(paren
id|ov
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;leaving&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ov51x_dealloc
id|ov51x_dealloc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
id|now
)paren
(brace
r_struct
id|timer_list
op_star
id|bt
op_assign
op_amp
(paren
id|ov-&gt;buf_timer
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;entered&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;deallocating buffer memory %s&quot;
comma
id|now
ques
c_cond
l_string|&quot;now&quot;
suffix:colon
l_string|&quot;later&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;buf_state
op_eq
id|BUF_PEND_DEALLOC
)paren
(brace
id|ov-&gt;buf_state
op_assign
id|BUF_ALLOCATED
suffix:semicolon
id|del_timer
c_func
(paren
id|bt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|now
)paren
id|ov51x_do_dealloc
c_func
(paren
id|ov
)paren
suffix:semicolon
r_else
(brace
id|ov-&gt;buf_state
op_assign
id|BUF_PEND_DEALLOC
suffix:semicolon
id|init_timer
c_func
(paren
id|bt
)paren
suffix:semicolon
id|bt-&gt;function
op_assign
id|ov51x_buf_callback
suffix:semicolon
id|bt-&gt;data
op_assign
(paren
r_int
r_int
)paren
id|ov
suffix:semicolon
id|bt-&gt;expires
op_assign
id|jiffies
op_plus
id|buf_timeout
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
id|bt
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|ov-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;leaving&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * V4L 1 API&n; *&n; ***************************************************************************/
macro_line|#ifdef OV511_OLD_V4L
r_static
r_int
DECL|function|ov51x_v4l1_open
id|ov51x_v4l1_open
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_int
id|flags
)paren
(brace
macro_line|#else
r_static
r_int
id|ov51x_v4l1_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|video_device
op_star
id|vdev
op_assign
id|video_devdata
c_func
(paren
id|file
)paren
suffix:semicolon
macro_line|#endif
r_struct
id|usb_ov511
op_star
id|ov
op_assign
id|vdev-&gt;priv
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;opening&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;user
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_alloc
c_func
(paren
id|ov
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ov-&gt;sub_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* In case app doesn&squot;t set them... */
r_if
c_cond
(paren
id|ov51x_set_default_params
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Make sure frames are reset */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|bytes_read
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If compression is on, make sure now that a &n;&t; * decompressor can be loaded */
r_if
c_cond
(paren
id|ov-&gt;compress
op_logical_and
op_logical_neg
id|ov-&gt;decomp_ops
)paren
(brace
id|err
op_assign
id|request_decompressor
c_func
(paren
id|ov
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_and
op_logical_neg
id|dumppix
)paren
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|ov51x_init_isoc
c_func
(paren
id|ov
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ov51x_dealloc
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ov-&gt;user
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;led_policy
op_eq
id|LED_AUTO
)paren
id|ov51x_led_control
c_func
(paren
id|ov
comma
l_int|1
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#ifdef OV511_OLD_V4L
r_static
r_void
DECL|function|ov51x_v4l1_close
id|ov51x_v4l1_close
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
)paren
(brace
macro_line|#else
r_static
r_int
id|ov51x_v4l1_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|video_device
op_star
id|vdev
op_assign
id|video_devdata
c_func
(paren
id|file
)paren
suffix:semicolon
macro_line|#endif
r_struct
id|usb_ov511
op_star
id|ov
op_assign
id|vdev-&gt;priv
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ov511_close&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
id|ov-&gt;user
op_decrement
suffix:semicolon
id|ov51x_stop_isoc
c_func
(paren
id|ov
)paren
suffix:semicolon
id|release_decompressor
c_func
(paren
id|ov
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;led_policy
op_eq
id|LED_AUTO
)paren
id|ov51x_led_control
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;dev
)paren
id|ov51x_dealloc
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Device unplugged while open. Only a minimum of unregistration is done&n;&t; * here; the disconnect callback already did the rest. */
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;dev
)paren
(brace
id|down
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov-&gt;cbuf
)paren
suffix:semicolon
id|ov-&gt;cbuf
op_assign
l_int|NULL
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
id|ov51x_dealloc
c_func
(paren
id|ov
comma
l_int|1
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|ov-&gt;vdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov
)paren
suffix:semicolon
id|ov
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef OV511_OLD_V4L
r_return
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Do not call this function directly! */
r_static
r_int
DECL|function|ov51x_v4l1_ioctl_internal
id|ov51x_v4l1_ioctl_internal
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;IOCtl: 0x%X&quot;
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;dev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
op_star
id|b
op_assign
id|arg
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGCAP&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|b
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_capability
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|b-&gt;name
comma
l_string|&quot;%s USB Camera&quot;
comma
id|symbolic
c_func
(paren
id|brglist
comma
id|ov-&gt;bridge
)paren
)paren
suffix:semicolon
id|b-&gt;type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_SUBCAPTURE
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;has_tuner
)paren
id|b-&gt;type
op_or_assign
id|VID_TYPE_TUNER
suffix:semicolon
id|b-&gt;channels
op_assign
id|ov-&gt;num_inputs
suffix:semicolon
id|b-&gt;audios
op_assign
id|ov-&gt;has_audio_proc
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|b-&gt;maxwidth
op_assign
id|ov-&gt;maxwidth
suffix:semicolon
id|b-&gt;maxheight
op_assign
id|ov-&gt;maxheight
suffix:semicolon
id|b-&gt;minwidth
op_assign
id|ov-&gt;minwidth
suffix:semicolon
id|b-&gt;minheight
op_assign
id|ov-&gt;minheight
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
op_star
id|v
op_assign
id|arg
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGCHAN&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|v-&gt;channel
)paren
op_ge
id|ov-&gt;num_inputs
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid channel (%d)&quot;
comma
id|v-&gt;channel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|v-&gt;norm
op_assign
id|ov-&gt;norm
suffix:semicolon
id|v-&gt;type
op_assign
(paren
id|ov-&gt;has_tuner
)paren
ques
c_cond
id|VIDEO_TYPE_TV
suffix:colon
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|v-&gt;flags
op_assign
(paren
id|ov-&gt;has_tuner
)paren
ques
c_cond
id|VIDEO_VC_TUNER
suffix:colon
l_int|0
suffix:semicolon
id|v-&gt;flags
op_or_assign
(paren
id|ov-&gt;has_audio_proc
)paren
ques
c_cond
id|VIDEO_VC_AUDIO
suffix:colon
l_int|0
suffix:semicolon
singleline_comment|//&t;&t;v-&gt;flags |= (ov-&gt;has_decoder) ? VIDEO_VC_NORM : 0;
id|v-&gt;tuners
op_assign
(paren
id|ov-&gt;has_tuner
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|decoder_get_input_name
c_func
(paren
id|ov
comma
id|v-&gt;channel
comma
id|v-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_struct
id|video_channel
op_star
id|v
op_assign
id|arg
suffix:semicolon
r_int
id|err
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCSCHAN&quot;
)paren
suffix:semicolon
multiline_comment|/* Make sure it&squot;s not a camera */
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;has_decoder
)paren
(brace
r_if
c_cond
(paren
id|v-&gt;channel
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v-&gt;norm
op_ne
id|VIDEO_MODE_PAL
op_logical_and
id|v-&gt;norm
op_ne
id|VIDEO_MODE_NTSC
op_logical_and
id|v-&gt;norm
op_ne
id|VIDEO_MODE_SECAM
op_logical_and
id|v-&gt;norm
op_ne
id|VIDEO_MODE_AUTO
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid norm (%d)&quot;
comma
id|v-&gt;norm
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|v-&gt;channel
)paren
op_ge
id|ov-&gt;num_inputs
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid channel (%d)&quot;
comma
id|v-&gt;channel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|decoder_set_input
c_func
(paren
id|ov
comma
id|v-&gt;channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|err
op_assign
id|decoder_set_norm
c_func
(paren
id|ov
comma
id|v-&gt;norm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
op_star
id|p
op_assign
id|arg
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGPICT&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_picture
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sensor_get_picture
c_func
(paren
id|ov
comma
id|p
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
op_star
id|p
op_assign
id|arg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCSPICT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_depth
c_func
(paren
id|p-&gt;palette
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sensor_set_picture
c_func
(paren
id|ov
comma
id|p
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|force_palette
op_logical_and
id|p-&gt;palette
op_ne
id|force_palette
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Palette rejected (%s)&quot;
comma
id|symbolic
c_func
(paren
id|v4l1_plist
comma
id|p-&gt;palette
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// FIXME: Format should be independent of frames
r_if
c_cond
(paren
id|p-&gt;palette
op_ne
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|format
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Detected format change&quot;
)paren
suffix:semicolon
multiline_comment|/* If we&squot;re collecting previous frame wait&n;&t;&t;&t;   before changing modes */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ov-&gt;wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|mode_init_regs
c_func
(paren
id|ov
comma
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|width
comma
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|height
comma
id|p-&gt;palette
comma
id|ov-&gt;sub_flag
)paren
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Setting depth=%d, palette=%s&quot;
comma
id|p-&gt;depth
comma
id|symbolic
c_func
(paren
id|v4l1_plist
comma
id|p-&gt;palette
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|depth
op_assign
id|p-&gt;depth
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|format
op_assign
id|p-&gt;palette
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCAPTURE
suffix:colon
(brace
r_int
op_star
id|vf
op_assign
id|arg
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGCAPTURE&quot;
)paren
suffix:semicolon
id|ov-&gt;sub_flag
op_assign
op_star
id|vf
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCAPTURE
suffix:colon
(brace
r_struct
id|video_capture
op_star
id|vc
op_assign
id|arg
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCSCAPTURE&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vc-&gt;flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vc-&gt;decimation
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|vc-&gt;x
op_and_assign
op_complement
l_int|3L
suffix:semicolon
id|vc-&gt;y
op_and_assign
op_complement
l_int|1L
suffix:semicolon
id|vc-&gt;y
op_and_assign
op_complement
l_int|31L
suffix:semicolon
r_if
c_cond
(paren
id|vc-&gt;width
op_eq
l_int|0
)paren
id|vc-&gt;width
op_assign
l_int|32
suffix:semicolon
id|vc-&gt;height
op_div_assign
l_int|16
suffix:semicolon
id|vc-&gt;height
op_mul_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|vc-&gt;height
op_eq
l_int|0
)paren
id|vc-&gt;height
op_assign
l_int|16
suffix:semicolon
id|ov-&gt;subx
op_assign
id|vc-&gt;x
suffix:semicolon
id|ov-&gt;suby
op_assign
id|vc-&gt;y
suffix:semicolon
id|ov-&gt;subw
op_assign
id|vc-&gt;width
suffix:semicolon
id|ov-&gt;subh
op_assign
id|vc-&gt;height
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
op_star
id|vw
op_assign
id|arg
suffix:semicolon
r_int
id|i
comma
id|result
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCSWIN: %dx%d&quot;
comma
id|vw-&gt;width
comma
id|vw-&gt;height
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|vw-&gt;flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw-&gt;clipcount
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw-&gt;height
op_ne
id|ov-&gt;maxheight
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw-&gt;width
op_ne
id|ov-&gt;maxwidth
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
multiline_comment|/* If we&squot;re collecting previous frame wait&n;&t;&t;   before changing modes */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ov-&gt;wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|result
op_assign
id|mode_init_regs
c_func
(paren
id|ov
comma
id|vw-&gt;width
comma
id|vw-&gt;height
comma
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|format
comma
id|ov-&gt;sub_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|width
op_assign
id|vw-&gt;width
suffix:semicolon
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|height
op_assign
id|vw-&gt;height
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
op_star
id|vw
op_assign
id|arg
suffix:semicolon
id|memset
c_func
(paren
id|vw
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_window
)paren
)paren
suffix:semicolon
id|vw-&gt;x
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME */
id|vw-&gt;y
op_assign
l_int|0
suffix:semicolon
id|vw-&gt;width
op_assign
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|width
suffix:semicolon
id|vw-&gt;height
op_assign
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|height
suffix:semicolon
id|vw-&gt;flags
op_assign
l_int|30
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGWIN: %dx%d&quot;
comma
id|vw-&gt;width
comma
id|vw-&gt;height
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
op_star
id|vm
op_assign
id|arg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGMBUF&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vm
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_mbuf
)paren
)paren
suffix:semicolon
id|vm-&gt;size
op_assign
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
suffix:semicolon
id|vm-&gt;frames
op_assign
id|OV511_NUMFRAMES
suffix:semicolon
id|vm-&gt;offsets
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vm-&gt;offsets
(braket
id|i
)braket
op_assign
id|vm-&gt;offsets
(braket
id|i
op_minus
l_int|1
)braket
op_plus
id|MAX_DATA_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
op_star
id|vm
op_assign
id|arg
suffix:semicolon
r_int
id|ret
comma
id|depth
suffix:semicolon
r_int
r_int
id|f
op_assign
id|vm-&gt;frame
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCMCAPTURE: frame: %d, %dx%d, %s&quot;
comma
id|f
comma
id|vm-&gt;width
comma
id|vm-&gt;height
comma
id|symbolic
c_func
(paren
id|v4l1_plist
comma
id|vm-&gt;format
)paren
)paren
suffix:semicolon
id|depth
op_assign
id|get_depth
c_func
(paren
id|vm-&gt;format
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|depth
)paren
(brace
id|err
c_func
(paren
l_string|&quot;VIDIOCMCAPTURE: invalid format (%s)&quot;
comma
id|symbolic
c_func
(paren
id|v4l1_plist
comma
id|vm-&gt;format
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|f
op_ge
id|OV511_NUMFRAMES
)paren
(brace
id|err
c_func
(paren
l_string|&quot;VIDIOCMCAPTURE: invalid frame (%d)&quot;
comma
id|f
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vm-&gt;width
OG
id|ov-&gt;maxwidth
op_logical_or
id|vm-&gt;height
OG
id|ov-&gt;maxheight
)paren
(brace
id|err
c_func
(paren
l_string|&quot;VIDIOCMCAPTURE: requested dimensions too big&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCMCAPTURE: already grabbing&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|force_palette
op_logical_and
(paren
id|vm-&gt;format
op_ne
id|force_palette
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;palette rejected (%s)&quot;
comma
id|symbolic
c_func
(paren
id|v4l1_plist
comma
id|vm-&gt;format
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|width
op_ne
id|vm-&gt;width
)paren
op_logical_or
(paren
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|height
op_ne
id|vm-&gt;height
)paren
op_logical_or
(paren
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|format
op_ne
id|vm-&gt;format
)paren
op_logical_or
(paren
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|sub_flag
op_ne
id|ov-&gt;sub_flag
)paren
op_logical_or
(paren
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|depth
op_ne
id|depth
)paren
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCMCAPTURE: change in image parameters&quot;
)paren
suffix:semicolon
multiline_comment|/* If we&squot;re collecting previous frame wait&n;&t;&t;&t;   before changing modes */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ov-&gt;wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|ret
op_assign
id|mode_init_regs
c_func
(paren
id|ov
comma
id|vm-&gt;width
comma
id|vm-&gt;height
comma
id|vm-&gt;format
comma
id|ov-&gt;sub_flag
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Got error while initializing regs &quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|width
op_assign
id|vm-&gt;width
suffix:semicolon
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|height
op_assign
id|vm-&gt;height
suffix:semicolon
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|format
op_assign
id|vm-&gt;format
suffix:semicolon
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|sub_flag
op_assign
id|ov-&gt;sub_flag
suffix:semicolon
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|depth
op_assign
id|depth
suffix:semicolon
)brace
multiline_comment|/* Mark it as ready */
id|ov-&gt;frame
(braket
id|f
)braket
dot
id|grabstate
op_assign
id|FRAME_READY
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCMCAPTURE: renewing frame %d&quot;
comma
id|f
)paren
suffix:semicolon
r_return
id|ov51x_new_frame
c_func
(paren
id|ov
comma
id|f
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
r_int
id|fnum
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_struct
id|ov511_frame
op_star
id|frame
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|fnum
op_ge
id|OV511_NUMFRAMES
)paren
(brace
id|err
c_func
(paren
l_string|&quot;VIDIOCSYNC: invalid frame (%d)&quot;
comma
id|fnum
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|frame
op_assign
op_amp
id|ov-&gt;frame
(braket
id|fnum
)braket
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;syncing to frame %d, grabstate = %d&quot;
comma
id|fnum
comma
id|frame-&gt;grabstate
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|frame-&gt;grabstate
)paren
(brace
r_case
id|FRAME_UNUSED
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|FRAME_READY
suffix:colon
r_case
id|FRAME_GRABBING
suffix:colon
r_case
id|FRAME_ERROR
suffix:colon
id|redo
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;dev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|rc
op_assign
id|wait_event_interruptible
c_func
(paren
id|frame-&gt;wq
comma
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_DONE
)paren
op_logical_or
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_ERROR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_ERROR
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov51x_new_frame
c_func
(paren
id|ov
comma
id|fnum
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_goto
id|redo
suffix:semicolon
)brace
multiline_comment|/* Fall through */
r_case
id|FRAME_DONE
suffix:colon
r_if
c_cond
(paren
id|ov-&gt;snap_enabled
op_logical_and
op_logical_neg
id|frame-&gt;snapshot
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov51x_new_frame
c_func
(paren
id|ov
comma
id|fnum
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_goto
id|redo
suffix:semicolon
)brace
id|frame-&gt;grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
multiline_comment|/* Reset the hardware snapshot button */
multiline_comment|/* FIXME - Is this the best place for this? */
r_if
c_cond
(paren
(paren
id|ov-&gt;snap_enabled
)paren
op_logical_and
(paren
id|frame-&gt;snapshot
)paren
)paren
(brace
id|frame-&gt;snapshot
op_assign
l_int|0
suffix:semicolon
id|ov51x_clear_snapshot
c_func
(paren
id|ov
)paren
suffix:semicolon
)brace
multiline_comment|/* Decompression, format conversion, etc... */
id|ov51x_postprocess
c_func
(paren
id|ov
comma
id|frame
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
op_star
id|vb
op_assign
id|arg
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGFBUF&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_buffer
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGUNIT
suffix:colon
(brace
r_struct
id|video_unit
op_star
id|vu
op_assign
id|arg
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGUNIT&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vu
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_unit
)paren
)paren
suffix:semicolon
id|vu-&gt;video
op_assign
id|ov-&gt;vdev.minor
suffix:semicolon
id|vu-&gt;vbi
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu-&gt;radio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu-&gt;audio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu-&gt;teletext
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGTUNER
suffix:colon
(brace
r_struct
id|video_tuner
op_star
id|v
op_assign
id|arg
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGTUNER&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;has_tuner
op_logical_or
id|v-&gt;tuner
)paren
singleline_comment|// Only tuner 0
r_return
op_minus
id|EINVAL
suffix:semicolon
id|strcpy
c_func
(paren
id|v-&gt;name
comma
l_string|&quot;Television&quot;
)paren
suffix:semicolon
singleline_comment|// FIXME: Need a way to get the real values
id|v-&gt;rangelow
op_assign
l_int|0
suffix:semicolon
id|v-&gt;rangehigh
op_assign
op_complement
l_int|0
suffix:semicolon
id|v-&gt;flags
op_assign
id|VIDEO_TUNER_PAL
op_or
id|VIDEO_TUNER_NTSC
op_or
id|VIDEO_TUNER_SECAM
suffix:semicolon
id|v-&gt;mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME:  Not sure what this is yet */
id|v-&gt;signal
op_assign
l_int|0xFFFF
suffix:semicolon
multiline_comment|/* unknown */
id|call_i2c_clients
c_func
(paren
id|ov
comma
id|cmd
comma
id|v
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSTUNER
suffix:colon
(brace
r_struct
id|video_tuner
op_star
id|v
op_assign
id|arg
suffix:semicolon
r_int
id|err
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCSTUNER&quot;
)paren
suffix:semicolon
multiline_comment|/* Only no or one tuner for now */
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;has_tuner
op_logical_or
id|v-&gt;tuner
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* and it only has certain valid modes */
r_if
c_cond
(paren
id|v-&gt;mode
op_ne
id|VIDEO_MODE_PAL
op_logical_and
id|v-&gt;mode
op_ne
id|VIDEO_MODE_NTSC
op_logical_and
id|v-&gt;mode
op_ne
id|VIDEO_MODE_SECAM
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
multiline_comment|/* Is this right/necessary? */
id|err
op_assign
id|decoder_set_norm
c_func
(paren
id|ov
comma
id|v-&gt;mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|call_i2c_clients
c_func
(paren
id|ov
comma
id|cmd
comma
id|v
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFREQ
suffix:colon
(brace
r_int
r_int
id|v
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCGFREQ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;has_tuner
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|v
op_assign
id|ov-&gt;freq
suffix:semicolon
macro_line|#if 0
multiline_comment|/* FIXME: this is necessary for testing */
id|v
op_assign
l_int|46
op_star
l_int|16
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSFREQ
suffix:colon
(brace
r_int
r_int
id|v
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;VIDIOCSFREQ: %lx&quot;
comma
id|v
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;has_tuner
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ov-&gt;freq
op_assign
id|v
suffix:semicolon
id|call_i2c_clients
c_func
(paren
id|ov
comma
id|cmd
comma
op_amp
id|v
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
multiline_comment|/* FIXME: Implement this... */
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Unsupported IOCtl: 0x%X&quot;
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
multiline_comment|/* end switch */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef OV511_OLD_V4L
multiline_comment|/* This is implemented as video_generic_ioctl() in the new V4L&squot;s videodev.c */
r_int
DECL|function|ov51x_v4l1_generic_ioctl
id|ov51x_v4l1_generic_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_char
id|sbuf
(braket
l_int|128
)braket
suffix:semicolon
r_void
op_star
id|mbuf
op_assign
l_int|NULL
suffix:semicolon
r_void
op_star
id|parg
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*  Copy arguments into temp kernel buffer  */
r_switch
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|_IOC_NONE
suffix:colon
id|parg
op_assign
id|arg
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_IOC_READ
suffix:colon
multiline_comment|/* some v4l ioctls are marked wrong ... */
r_case
id|_IOC_WRITE
suffix:colon
r_case
(paren
id|_IOC_WRITE
op_or
id|_IOC_READ
)paren
suffix:colon
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
op_le
r_sizeof
(paren
id|sbuf
)paren
)paren
(brace
id|parg
op_assign
id|sbuf
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* too big to allocate from stack */
id|mbuf
op_assign
id|kmalloc
c_func
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|mbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|parg
op_assign
id|mbuf
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|parg
comma
id|arg
comma
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
)brace
id|err
op_assign
id|ov51x_v4l1_ioctl_internal
c_func
(paren
id|vdev-&gt;priv
comma
id|cmd
comma
id|parg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|ENOIOCTLCMD
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*  Copy results into user buffer  */
r_switch
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|_IOC_READ
suffix:colon
r_case
(paren
id|_IOC_WRITE
op_or
id|_IOC_READ
)paren
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
id|parg
comma
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|mbuf
)paren
id|kfree
c_func
(paren
id|mbuf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|ov51x_v4l1_ioctl
id|ov51x_v4l1_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov
op_assign
id|vdev-&gt;priv
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|rc
op_assign
id|ov51x_v4l1_generic_ioctl
c_func
(paren
id|vdev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#else&t;/* If new V4L API */
r_static
r_int
DECL|function|ov51x_v4l1_ioctl
id|ov51x_v4l1_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|video_device
op_star
id|vdev
op_assign
id|video_devdata
c_func
(paren
id|file
)paren
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov
op_assign
id|vdev-&gt;priv
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|rc
op_assign
id|ov51x_v4l1_ioctl_internal
c_func
(paren
id|ov
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif&t;/* OV511_OLD_V4L */
macro_line|#ifdef OV511_OLD_V4L
r_static
r_inline
r_int
DECL|function|ov51x_v4l1_read
id|ov51x_v4l1_read
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
macro_line|#else
r_static
r_inline
r_int
id|ov51x_v4l1_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|cnt
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|video_device
op_star
id|vdev
op_assign
id|video_devdata
c_func
(paren
id|file
)paren
suffix:semicolon
r_int
id|noblock
op_assign
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
suffix:semicolon
r_int
r_int
id|count
op_assign
id|cnt
suffix:semicolon
macro_line|#endif
r_struct
id|usb_ov511
op_star
id|ov
op_assign
id|vdev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|rc
op_assign
l_int|0
comma
id|frmx
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|ov511_frame
op_star
id|frame
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%ld bytes, noblock=%d&quot;
comma
id|count
comma
id|noblock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vdev
op_logical_or
op_logical_neg
id|buf
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;dev
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
singleline_comment|// FIXME: Only supports two frames
multiline_comment|/* See if a frame is completed, then use it. */
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_ge
id|FRAME_DONE
)paren
multiline_comment|/* _DONE or _ERROR */
id|frmx
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_ge
id|FRAME_DONE
)paren
multiline_comment|/* _DONE or _ERROR */
id|frmx
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* If nonblocking we return immediately */
r_if
c_cond
(paren
id|noblock
op_logical_and
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* If no FRAME_DONE, look for a FRAME_GRABBING state. */
multiline_comment|/* See if a frame is in process (grabbing), then use it. */
r_if
c_cond
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
id|frmx
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
id|frmx
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If no frame is active, start one. */
r_if
c_cond
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ov51x_new_frame
c_func
(paren
id|ov
comma
id|frmx
op_assign
l_int|0
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;read: ov51x_new_frame error&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
id|frame
op_assign
op_amp
id|ov-&gt;frame
(braket
id|frmx
)braket
suffix:semicolon
id|restart
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;dev
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Wait while we&squot;re grabbing the image */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Waiting image grabbing&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|wait_event_interruptible
c_func
(paren
id|frame-&gt;wq
comma
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_DONE
)paren
op_logical_or
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_ERROR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|error
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got image, frame-&gt;grabstate = %d&quot;
comma
id|frame-&gt;grabstate
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;bytes_recvd = %d&quot;
comma
id|frame-&gt;bytes_recvd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_ERROR
)paren
(brace
id|frame-&gt;bytes_read
op_assign
l_int|0
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;** ick! ** Errored frame %d&quot;
comma
id|ov-&gt;curframe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_new_frame
c_func
(paren
id|ov
comma
id|frmx
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;read: ov51x_new_frame error&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_goto
id|restart
suffix:semicolon
)brace
multiline_comment|/* Repeat until we get a snapshot frame */
r_if
c_cond
(paren
id|ov-&gt;snap_enabled
)paren
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Waiting snapshot frame&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;snap_enabled
op_logical_and
op_logical_neg
id|frame-&gt;snapshot
)paren
(brace
id|frame-&gt;bytes_read
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ov51x_new_frame
c_func
(paren
id|ov
comma
id|frmx
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;read: ov51x_new_frame error&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_goto
id|restart
suffix:semicolon
)brace
multiline_comment|/* Clear the snapshot */
r_if
c_cond
(paren
id|ov-&gt;snap_enabled
op_logical_and
id|frame-&gt;snapshot
)paren
(brace
id|frame-&gt;snapshot
op_assign
l_int|0
suffix:semicolon
id|ov51x_clear_snapshot
c_func
(paren
id|ov
)paren
suffix:semicolon
)brace
multiline_comment|/* Decompression, format conversion, etc... */
id|ov51x_postprocess
c_func
(paren
id|ov
comma
id|frame
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;frmx=%d, bytes_read=%ld, length=%ld&quot;
comma
id|frmx
comma
id|frame-&gt;bytes_read
comma
id|get_frame_length
c_func
(paren
id|frame
)paren
)paren
suffix:semicolon
multiline_comment|/* copy bytes to user space; we allow for partials reads */
singleline_comment|//&t;if ((count + frame-&gt;bytes_read) 
singleline_comment|//&t;    &gt; get_frame_length((struct ov511_frame *)frame))
singleline_comment|//&t;&t;count = frame-&gt;scanlength - frame-&gt;bytes_read;
multiline_comment|/* FIXME - count hardwired to be one frame... */
id|count
op_assign
id|get_frame_length
c_func
(paren
id|frame
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Copy to user space: %ld bytes&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|frame-&gt;data
op_plus
id|frame-&gt;bytes_read
comma
id|count
)paren
)paren
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Copy failed! %d bytes not copied&quot;
comma
id|i
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|frame-&gt;bytes_read
op_add_assign
id|count
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;{copy} count used=%ld, new bytes_read=%ld&quot;
comma
id|count
comma
id|frame-&gt;bytes_read
)paren
suffix:semicolon
multiline_comment|/* If all data has been read... */
r_if
c_cond
(paren
id|frame-&gt;bytes_read
op_ge
id|get_frame_length
c_func
(paren
id|frame
)paren
)paren
(brace
id|frame-&gt;bytes_read
op_assign
l_int|0
suffix:semicolon
singleline_comment|// FIXME: Only supports two frames
multiline_comment|/* Mark it as available to be used again. */
id|ov-&gt;frame
(braket
id|frmx
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ov51x_new_frame
c_func
(paren
id|ov
comma
op_logical_neg
id|frmx
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;ov51x_new_frame returned error&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;read finished, returning %ld (sweet)&quot;
comma
id|count
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
id|error
suffix:colon
id|up
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
macro_line|#ifdef OV511_OLD_V4L
DECL|function|ov51x_v4l1_mmap
id|ov51x_v4l1_mmap
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|video_device
op_star
id|vdev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
macro_line|#else&t;/* New V4L API */
id|ov51x_v4l1_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|video_device
op_star
id|vdev
op_assign
id|video_devdata
c_func
(paren
id|file
)paren
suffix:semicolon
r_int
r_int
id|start
op_assign
id|vma-&gt;vm_start
suffix:semicolon
r_int
r_int
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
macro_line|#endif&t;/* OV511_OLD_V4L */
r_struct
id|usb_ov511
op_star
id|ov
op_assign
id|vdev-&gt;priv
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;mmap: %ld (%lX) bytes&quot;
comma
id|size
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
(paren
(paren
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
c_func
(paren
id|ov-&gt;maxwidth
comma
id|ov-&gt;maxheight
)paren
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|pos
op_assign
(paren
r_int
r_int
)paren
id|ov-&gt;fbuf
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma
comma
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef OV511_OLD_V4L
DECL|variable|vdev_template
r_static
r_struct
id|video_device
id|vdev_template
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|name
suffix:colon
l_string|&quot;OV511 USB Camera&quot;
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
comma
id|hardware
suffix:colon
id|VID_HARDWARE_OV511
comma
id|open
suffix:colon
id|ov51x_v4l1_open
comma
id|close
suffix:colon
id|ov51x_v4l1_close
comma
id|read
suffix:colon
id|ov51x_v4l1_read
comma
id|ioctl
suffix:colon
id|ov51x_v4l1_ioctl
comma
id|mmap
suffix:colon
id|ov51x_v4l1_mmap
comma
)brace
suffix:semicolon
macro_line|#else&t;/* New V4L API */
DECL|variable|ov511_fops
r_static
r_struct
id|file_operations
id|ov511_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|ov51x_v4l1_open
comma
id|release
suffix:colon
id|ov51x_v4l1_close
comma
id|read
suffix:colon
id|ov51x_v4l1_read
comma
id|mmap
suffix:colon
id|ov51x_v4l1_mmap
comma
id|ioctl
suffix:colon
id|video_generic_ioctl
comma
id|llseek
suffix:colon
id|no_llseek
comma
)brace
suffix:semicolon
DECL|variable|vdev_template
r_static
r_struct
id|video_device
id|vdev_template
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|name
suffix:colon
l_string|&quot;OV511 USB Camera&quot;
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
comma
id|hardware
suffix:colon
id|VID_HARDWARE_OV511
comma
id|fops
suffix:colon
op_amp
id|ov511_fops
comma
id|kernel_ioctl
suffix:colon
id|ov51x_v4l1_ioctl
comma
)brace
suffix:semicolon
macro_line|#endif&t;/* OV511_OLD_V4L */
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
r_static
r_int
DECL|function|ov51x_control_ioctl
id|ov51x_control_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|ularg
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|pde
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov
suffix:semicolon
r_void
op_star
id|arg
op_assign
(paren
r_void
op_star
)paren
id|ularg
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|pde
op_assign
id|PDE
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pde
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|ov
op_assign
id|pde-&gt;data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;dev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Should we pass through standard V4L IOCTLs? */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OV511IOC_GINTVER
suffix:colon
(brace
r_int
id|ver
op_assign
id|OV511_INTERFACE_VER
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Get interface version: %d&quot;
comma
id|ver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|ver
comma
r_sizeof
(paren
id|ver
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|OV511IOC_GUSHORT
suffix:colon
(brace
r_struct
id|ov511_ushort_opt
id|opt
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|opt
comma
id|arg
comma
r_sizeof
(paren
id|opt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|opt.optnum
)paren
(brace
r_case
id|OV511_USOPT_BRIGHT
suffix:colon
id|rc
op_assign
id|sensor_get_brightness
c_func
(paren
id|ov
comma
op_amp
(paren
id|opt.val
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_USOPT_SAT
suffix:colon
id|rc
op_assign
id|sensor_get_saturation
c_func
(paren
id|ov
comma
op_amp
(paren
id|opt.val
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_USOPT_HUE
suffix:colon
id|rc
op_assign
id|sensor_get_hue
c_func
(paren
id|ov
comma
op_amp
(paren
id|opt.val
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_USOPT_CONTRAST
suffix:colon
id|rc
op_assign
id|sensor_get_contrast
c_func
(paren
id|ov
comma
op_amp
(paren
id|opt.val
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Invalid get short option number&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|opt
comma
r_sizeof
(paren
id|opt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|OV511IOC_SUSHORT
suffix:colon
(brace
r_struct
id|ov511_ushort_opt
id|opt
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|opt
comma
id|arg
comma
r_sizeof
(paren
id|opt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|opt.optnum
)paren
(brace
r_case
id|OV511_USOPT_BRIGHT
suffix:colon
id|rc
op_assign
id|sensor_set_brightness
c_func
(paren
id|ov
comma
id|opt.val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_USOPT_SAT
suffix:colon
id|rc
op_assign
id|sensor_set_saturation
c_func
(paren
id|ov
comma
id|opt.val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_USOPT_HUE
suffix:colon
id|rc
op_assign
id|sensor_set_hue
c_func
(paren
id|ov
comma
id|opt.val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_USOPT_CONTRAST
suffix:colon
id|rc
op_assign
id|sensor_set_contrast
c_func
(paren
id|ov
comma
id|opt.val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Invalid set short option number&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|OV511IOC_GUINT
suffix:colon
(brace
r_struct
id|ov511_uint_opt
id|opt
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|opt
comma
id|arg
comma
r_sizeof
(paren
id|opt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|opt.optnum
)paren
(brace
r_case
id|OV511_UIOPT_POWER_FREQ
suffix:colon
id|opt.val
op_assign
id|ov-&gt;lightfreq
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_UIOPT_BFILTER
suffix:colon
id|opt.val
op_assign
id|ov-&gt;bandfilt
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_UIOPT_LED
suffix:colon
id|opt.val
op_assign
id|ov-&gt;led_policy
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_UIOPT_DEBUG
suffix:colon
id|opt.val
op_assign
id|debug
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_UIOPT_COMPRESS
suffix:colon
id|opt.val
op_assign
id|ov-&gt;compress
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Invalid get int option number&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|opt
comma
r_sizeof
(paren
id|opt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|OV511IOC_SUINT
suffix:colon
(brace
r_struct
id|ov511_uint_opt
id|opt
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|opt
comma
id|arg
comma
r_sizeof
(paren
id|opt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|opt.optnum
)paren
(brace
r_case
id|OV511_UIOPT_POWER_FREQ
suffix:colon
id|rc
op_assign
id|sensor_set_light_freq
c_func
(paren
id|ov
comma
id|opt.val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_UIOPT_BFILTER
suffix:colon
id|rc
op_assign
id|sensor_set_banding_filter
c_func
(paren
id|ov
comma
id|opt.val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_UIOPT_LED
suffix:colon
r_if
c_cond
(paren
id|opt.val
op_le
l_int|2
)paren
(brace
id|ov-&gt;led_policy
op_assign
id|opt.val
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;led_policy
op_eq
id|LED_OFF
)paren
id|ov51x_led_control
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov-&gt;led_policy
op_eq
id|LED_ON
)paren
id|ov51x_led_control
c_func
(paren
id|ov
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|OV511_UIOPT_DEBUG
suffix:colon
r_if
c_cond
(paren
id|opt.val
op_le
l_int|5
)paren
id|debug
op_assign
id|opt.val
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OV511_UIOPT_COMPRESS
suffix:colon
id|ov-&gt;compress
op_assign
id|opt.val
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;compress
)paren
(brace
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV511
)paren
id|ov511_init_compression
c_func
(paren
id|ov
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
id|ov518_init_compression
c_func
(paren
id|ov
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Invalid get int option number&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|OV511IOC_WI2C
suffix:colon
(brace
r_struct
id|ov511_i2c_struct
id|w
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|w
comma
id|arg
comma
r_sizeof
(paren
id|w
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|i2c_w_slave
c_func
(paren
id|ov
comma
id|w.slave
comma
id|w.reg
comma
id|w.value
comma
id|w.mask
)paren
suffix:semicolon
)brace
r_case
id|OV511IOC_RI2C
suffix:colon
(brace
r_struct
id|ov511_i2c_struct
id|r
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|r
comma
id|arg
comma
r_sizeof
(paren
id|r
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|rc
op_assign
id|i2c_r_slave
c_func
(paren
id|ov
comma
id|r.slave
comma
id|r.reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|r.value
op_assign
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|r
comma
r_sizeof
(paren
id|r
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* end switch */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/****************************************************************************&n; *&n; * OV511 and sensor configuration&n; *&n; ***************************************************************************/
multiline_comment|/* This initializes the OV7610, OV7620, or OV7620AE sensor. The OV7620AE uses&n; * the same register settings as the OV7610, since they are very similar.&n; */
r_static
r_int
DECL|function|ov7xx0_configure
id|ov7xx0_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|i
comma
id|success
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Lawrence Glaister &lt;lg@jfm.bc.ca&gt; reports:&n;&t; *&n;&t; * Register 0x0f in the 7610 has the following effects:&n;&t; *&n;&t; * 0x85 (AEC method 1): Best overall, good contrast range&n;&t; * 0x45 (AEC method 2): Very overexposed&n;&t; * 0xa5 (spec sheet default): Ok, but the black level is&n;&t; *&t;shifted resulting in loss of contrast&n;&t; * 0x05 (old driver setting): very overexposed, too much&n;&t; *&t;contrast&n;&t; */
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm7610
(braket
)braket
op_assign
(brace
(brace
id|OV511_I2C_BUS
comma
l_int|0x10
comma
l_int|0xff
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x16
comma
l_int|0x06
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2b
comma
l_int|0xac
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x38
comma
l_int|0x81
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x24
)brace
comma
multiline_comment|/* 0c */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0f
comma
l_int|0x85
)brace
comma
multiline_comment|/* lg&squot;s setting */
(brace
id|OV511_I2C_BUS
comma
l_int|0x15
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x20
comma
l_int|0x1c
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x23
comma
l_int|0x2a
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x24
comma
l_int|0x10
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x25
comma
l_int|0x8a
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x26
comma
l_int|0xa2
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x27
comma
l_int|0xc2
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2a
comma
l_int|0x04
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2c
comma
l_int|0xfe
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2d
comma
l_int|0x93
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x30
comma
l_int|0x71
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x31
comma
l_int|0x60
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x32
comma
l_int|0x26
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x33
comma
l_int|0x20
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x34
comma
l_int|0x48
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x11
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0d
comma
l_int|0x24
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm7620
(braket
)braket
op_assign
(brace
(brace
id|OV511_I2C_BUS
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x01
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x02
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x03
comma
l_int|0xc0
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x06
comma
l_int|0x60
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x07
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0d
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x11
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x13
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x14
comma
l_int|0x84
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x15
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x16
comma
l_int|0x03
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x17
comma
l_int|0x2f
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x18
comma
l_int|0xcf
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x19
comma
l_int|0x06
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x1a
comma
l_int|0xf5
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x1b
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x20
comma
l_int|0x18
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x21
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x22
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x23
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x26
comma
l_int|0xa2
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x27
comma
l_int|0xea
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x20
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x29
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2a
comma
l_int|0x10
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2b
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2c
comma
l_int|0x88
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2d
comma
l_int|0x91
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2e
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2f
comma
l_int|0x44
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x60
comma
l_int|0x27
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x61
comma
l_int|0x02
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x62
comma
l_int|0x5f
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x63
comma
l_int|0xd5
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x64
comma
l_int|0x57
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x65
comma
l_int|0x83
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x66
comma
l_int|0x55
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x67
comma
l_int|0x92
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x68
comma
l_int|0xcf
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x69
comma
l_int|0x76
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x6a
comma
l_int|0x22
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x6b
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x6c
comma
l_int|0x02
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x6d
comma
l_int|0x44
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x6e
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x6f
comma
l_int|0x1d
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x70
comma
l_int|0x8b
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x71
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x72
comma
l_int|0x14
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x73
comma
l_int|0x54
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x74
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x75
comma
l_int|0x8e
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x76
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x77
comma
l_int|0xff
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x78
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x79
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x7a
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x7b
comma
l_int|0xe2
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x7c
comma
l_int|0x00
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;starting configuration&quot;
)paren
suffix:semicolon
multiline_comment|/* This looks redundant, but is necessary for WebCam 3 */
id|ov-&gt;primary_i2c_slave
op_assign
id|OV7xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|OV7xx0_SID
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|init_ov_sensor
c_func
(paren
id|ov
)paren
op_ge
l_int|0
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;OV7xx0 sensor initalized (method 1)&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Reset the 76xx */
r_if
c_cond
(paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|schedule_timeout
c_func
(paren
l_int|1
op_plus
l_int|150
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
op_le
id|i2c_detect_tries
)paren
(brace
r_if
c_cond
(paren
(paren
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_ID_HIGH
)paren
op_eq
l_int|0x7F
)paren
op_logical_and
(paren
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_ID_LOW
)paren
op_eq
l_int|0xA2
)paren
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|i
op_increment
suffix:semicolon
)brace
)brace
singleline_comment|// Was (i == i2c_detect_tries) previously. This obviously used to always report
singleline_comment|// success. Whether anyone actually depended on that bug is unknown
r_if
c_cond
(paren
(paren
id|i
op_ge
id|i2c_detect_tries
)paren
op_logical_and
(paren
id|success
op_eq
l_int|0
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to read sensor ID. You might not have an&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;OV7610/20, or it may be not responding. Report&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;this to &quot;
id|EMAIL
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;This is only a warning. You can attempt to use&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;your camera anyway&quot;
)paren
suffix:semicolon
singleline_comment|// Only issue a warning for now  
singleline_comment|//&t;&t;&t;return -1;
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;OV7xx0 initialized (method 2, %dx)&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Detect sensor (sub)type */
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_COM_I
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error detecting sensor type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|3
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is an OV7610&quot;
)paren
suffix:semicolon
id|ov-&gt;sensor
op_assign
id|SEN_OV7610
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* I don&squot;t know what&squot;s different about the 76BE yet */
r_if
c_cond
(paren
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x15
)paren
op_amp
l_int|1
)paren
id|info
c_func
(paren
l_string|&quot;Sensor is an OV7620AE&quot;
)paren
suffix:semicolon
r_else
id|info
c_func
(paren
l_string|&quot;Sensor is an OV76BE&quot;
)paren
suffix:semicolon
multiline_comment|/* OV511+ will return all zero isoc data unless we&n;&t;&t; * configure the sensor as a 7620. Someone needs to&n;&t;&t; * find the exact reg. setting that causes this. */
r_if
c_cond
(paren
id|ov-&gt;bridge
op_eq
id|BRG_OV511PLUS
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Enabling 511+/7620AE workaround&quot;
)paren
suffix:semicolon
id|ov-&gt;sensor
op_assign
id|SEN_OV7620
suffix:semicolon
)brace
r_else
(brace
id|ov-&gt;sensor
op_assign
id|SEN_OV7620AE
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is an OV7620&quot;
)paren
suffix:semicolon
id|ov-&gt;sensor
op_assign
id|SEN_OV7620
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Unknown image sensor version: %d&quot;
comma
id|rc
op_amp
l_int|3
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_OV7620
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Writing 7620 registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsNorm7620
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Writing 7610 registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsNorm7610
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set sensor-specific vars */
id|ov-&gt;maxwidth
op_assign
l_int|640
suffix:semicolon
id|ov-&gt;maxheight
op_assign
l_int|480
suffix:semicolon
id|ov-&gt;minwidth
op_assign
l_int|64
suffix:semicolon
id|ov-&gt;minheight
op_assign
l_int|48
suffix:semicolon
singleline_comment|// FIXME: These do not match the actual settings yet
id|ov-&gt;brightness
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;contrast
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;colour
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;hue
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This initializes the OV6620, OV6630, OV6630AE, or OV6630AF sensor. */
r_static
r_int
DECL|function|ov6xx0_configure
id|ov6xx0_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|rc
suffix:semicolon
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm6x20
(braket
)braket
op_assign
(brace
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x80
)brace
comma
multiline_comment|/* reset */
(brace
id|OV511_I2C_BUS
comma
l_int|0x11
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x03
comma
l_int|0x60
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x05
comma
l_int|0x7f
)brace
comma
multiline_comment|/* For when autoadjust is off */
(brace
id|OV511_I2C_BUS
comma
l_int|0x07
comma
l_int|0xa8
)brace
comma
multiline_comment|/* The ratio of 0x0c and 0x0d  controls the white point */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0d
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x24
)brace
comma
multiline_comment|/* Enable AGC */
(brace
id|OV511_I2C_BUS
comma
l_int|0x14
comma
l_int|0x04
)brace
comma
multiline_comment|/* 0x16: 0x06 helps frame stability with moving objects */
(brace
id|OV511_I2C_BUS
comma
l_int|0x16
comma
l_int|0x06
)brace
comma
singleline_comment|//&t;&t;{ OV511_I2C_BUS, 0x20, 0x30 }, /* Aperture correction enable */
(brace
id|OV511_I2C_BUS
comma
l_int|0x26
comma
l_int|0xb2
)brace
comma
multiline_comment|/* BLC enable */
multiline_comment|/* 0x28: 0x05 Selects RGB format if RGB on */
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x05
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2a
comma
l_int|0x04
)brace
comma
multiline_comment|/* Disable framerate adjust */
singleline_comment|//&t;&t;{ OV511_I2C_BUS, 0x2b, 0xac }, /* Framerate; Set 2a[7] first */
(brace
id|OV511_I2C_BUS
comma
l_int|0x2d
comma
l_int|0x99
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x34
comma
l_int|0xd2
)brace
comma
multiline_comment|/* Max A/D range */
(brace
id|OV511_I2C_BUS
comma
l_int|0x38
comma
l_int|0x8b
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x39
comma
l_int|0x40
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x3c
comma
l_int|0x39
)brace
comma
multiline_comment|/* Enable AEC mode changing */
(brace
id|OV511_I2C_BUS
comma
l_int|0x3c
comma
l_int|0x3c
)brace
comma
multiline_comment|/* Change AEC mode */
(brace
id|OV511_I2C_BUS
comma
l_int|0x3c
comma
l_int|0x24
)brace
comma
multiline_comment|/* Disable AEC mode changing */
(brace
id|OV511_I2C_BUS
comma
l_int|0x3d
comma
l_int|0x80
)brace
comma
multiline_comment|/* These next two registers (0x4a, 0x4b) are undocumented. They&n;&t;&t; * control the color balance */
(brace
id|OV511_I2C_BUS
comma
l_int|0x4a
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x4b
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x4d
comma
l_int|0xd2
)brace
comma
multiline_comment|/* This reduces noise a bit */
(brace
id|OV511_I2C_BUS
comma
l_int|0x4e
comma
l_int|0xc1
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x4f
comma
l_int|0x04
)brace
comma
singleline_comment|// Do 50-53 have any effect?
singleline_comment|// Toggle 0x12[2] off and on here?
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* This chip is undocumented so many of these are guesses. OK=verified,&n;&t; * A=Added since 6620, U=unknown function (not a 6620 reg) */
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm6x30
(braket
)braket
op_assign
(brace
multiline_comment|/*OK*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x80
)brace
comma
multiline_comment|/* reset */
multiline_comment|/*00?*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x11
comma
l_int|0x01
)brace
comma
multiline_comment|/*OK*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x03
comma
l_int|0x60
)brace
comma
multiline_comment|/*0A?*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x05
comma
l_int|0x7f
)brace
comma
multiline_comment|/* For when autoadjust is off */
(brace
id|OV511_I2C_BUS
comma
l_int|0x07
comma
l_int|0xa8
)brace
comma
multiline_comment|/* The ratio of 0x0c and 0x0d  controls the white point */
multiline_comment|/*OK*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x24
)brace
comma
multiline_comment|/*OK*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x0d
comma
l_int|0x24
)brace
comma
multiline_comment|/*A*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x0e
comma
l_int|0x20
)brace
comma
singleline_comment|//&t;/*24?*/&t;{ OV511_I2C_BUS, 0x12, 0x28 }, /* Enable AGC */
singleline_comment|//&t;&t;{ OV511_I2C_BUS, 0x12, 0x24 }, /* Enable AGC */
singleline_comment|//&t;/*A*/&t;{ OV511_I2C_BUS, 0x13, 0x21 },
singleline_comment|//&t;/*A*/&t;{ OV511_I2C_BUS, 0x13, 0x25 }, /* Tristate Y and UV busses */
singleline_comment|//&t;/*04?*/&t;{ OV511_I2C_BUS, 0x14, 0x80 },
multiline_comment|/* 0x16: 0x06 helps frame stability with moving objects */
multiline_comment|/*03?*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x16
comma
l_int|0x06
)brace
comma
singleline_comment|//&t;/*OK*/&t;{ OV511_I2C_BUS, 0x20, 0x30 }, /* Aperture correction enable */
singleline_comment|// 21 &amp; 22? The suggested values look wrong. Go with default
multiline_comment|/*A*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x23
comma
l_int|0xc0
)brace
comma
multiline_comment|/*A*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x25
comma
l_int|0x9a
)brace
comma
singleline_comment|// Check this against default
singleline_comment|//&t;/*OK*/&t;{ OV511_I2C_BUS, 0x26, 0xb2 }, /* BLC enable */
multiline_comment|/* 0x28: 0x05 Selects RGB format if RGB on */
singleline_comment|//&t;/*04?*/&t;{ OV511_I2C_BUS, 0x28, 0x05 },
singleline_comment|//&t;/*04?*/&t;{ OV511_I2C_BUS, 0x28, 0x45 }, // DEBUG: Tristate UV bus
multiline_comment|/*OK*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x2a
comma
l_int|0x04
)brace
comma
multiline_comment|/* Disable framerate adjust */
singleline_comment|//&t;/*OK*/&t;{ OV511_I2C_BUS, 0x2b, 0xac }, /* Framerate; Set 2a[7] first */
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x2c, 0xa0 },
(brace
id|OV511_I2C_BUS
comma
l_int|0x2d
comma
l_int|0x99
)brace
comma
singleline_comment|//&t;/*A*/&t;{ OV511_I2C_BUS, 0x33, 0x26 }, // Reserved bits on 6620
singleline_comment|//&t;/*d2?*/&t;{ OV511_I2C_BUS, 0x34, 0x03 }, /* Max A/D range */
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x36, 0x8f }, // May not be necessary
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x37, 0x80 }, // May not be necessary
singleline_comment|//&t;/*8b?*/&t;{ OV511_I2C_BUS, 0x38, 0x83 },
singleline_comment|//&t;/*40?*/&t;{ OV511_I2C_BUS, 0x39, 0xc0 }, // 6630 adds bit 7
singleline_comment|//&t;&t;{ OV511_I2C_BUS, 0x3c, 0x39 }, /* Enable AEC mode changing */
singleline_comment|//&t;&t;{ OV511_I2C_BUS, 0x3c, 0x3c }, /* Change AEC mode */
singleline_comment|//&t;&t;{ OV511_I2C_BUS, 0x3c, 0x24 }, /* Disable AEC mode changing */
multiline_comment|/*OK*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x3d
comma
l_int|0x80
)brace
comma
singleline_comment|//&t;/*A*/&t;{ OV511_I2C_BUS, 0x3f, 0x0e },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x40, 0x00 },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x41, 0x00 },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x42, 0x80 },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x43, 0x3f },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x44, 0x80 },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x45, 0x20 },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x46, 0x20 },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x47, 0x80 },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x48, 0x7f },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x49, 0x00 },
multiline_comment|/* These next two registers (0x4a, 0x4b) are undocumented. They&n;&t;&t; * control the color balance */
singleline_comment|//&t;/*OK?*/&t;{ OV511_I2C_BUS, 0x4a, 0x80 }, // Check these
singleline_comment|//&t;/*OK?*/&t;{ OV511_I2C_BUS, 0x4b, 0x80 },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x4c, 0xd0 }, 
multiline_comment|/*d2?*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x4d
comma
l_int|0x10
)brace
comma
multiline_comment|/* This reduces noise a bit */
multiline_comment|/*c1?*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x4e
comma
l_int|0x40
)brace
comma
multiline_comment|/*04?*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x4f
comma
l_int|0x07
)brace
comma
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x50, 0xff },
multiline_comment|/*U*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x54
comma
l_int|0x23
)brace
comma
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x55, 0xff },
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x56, 0x12 },
multiline_comment|/*U*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x57
comma
l_int|0x81
)brace
comma
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x58, 0x75 },
multiline_comment|/*U*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x59
comma
l_int|0x01
)brace
comma
multiline_comment|/*U*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x5a
comma
l_int|0x2c
)brace
comma
multiline_comment|/*U*/
(brace
id|OV511_I2C_BUS
comma
l_int|0x5b
comma
l_int|0x0f
)brace
comma
singleline_comment|//&t;/*U*/&t;{ OV511_I2C_BUS, 0x5c, 0x10 },
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;starting sensor configuration&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|init_ov_sensor
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to read sensor ID. You might not have an OV6xx0,&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;or it may be not responding. Report this to &quot;
id|EMAIL
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;OV6xx0 sensor detected&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Detect sensor (sub)type */
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
id|OV7610_REG_COM_I
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error detecting sensor type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|0
)paren
id|ov-&gt;sensor
op_assign
id|SEN_OV6630
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|1
)paren
id|ov-&gt;sensor
op_assign
id|SEN_OV6620
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|2
)paren
id|ov-&gt;sensor
op_assign
id|SEN_OV6630
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|3
)paren
id|ov-&gt;sensor
op_assign
id|SEN_OV6630
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;Sensor is an %s&quot;
comma
id|symbolic
c_func
(paren
id|senlist
comma
id|ov-&gt;sensor
)paren
)paren
suffix:semicolon
multiline_comment|/* Set sensor-specific vars */
id|ov-&gt;maxwidth
op_assign
l_int|352
suffix:semicolon
id|ov-&gt;maxheight
op_assign
l_int|288
suffix:semicolon
id|ov-&gt;minwidth
op_assign
l_int|64
suffix:semicolon
id|ov-&gt;minheight
op_assign
l_int|48
suffix:semicolon
singleline_comment|// FIXME: These do not match the actual settings yet
id|ov-&gt;brightness
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;contrast
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;colour
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;hue
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;sensor
op_eq
id|SEN_OV6620
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Writing 6x20 registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsNorm6x20
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Writing 6x30 registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsNorm6x30
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This initializes the KS0127 and KS0127B video decoders. */
r_static
r_int
DECL|function|ks0127_configure
id|ks0127_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|rc
suffix:semicolon
singleline_comment|// FIXME: I don&squot;t know how to sync or reset it yet
macro_line|#if 0
r_if
c_cond
(paren
id|ov51x_init_ks_sensor
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to initialize the KS0127&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;KS012x(B) sensor detected&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Detect decoder subtype */
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x00
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error detecting sensor type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_amp
l_int|0x08
)paren
(brace
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x3d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error detecting sensor type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|0x0f
)paren
op_eq
l_int|0
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is a KS0127&quot;
)paren
suffix:semicolon
id|ov-&gt;sensor
op_assign
id|SEN_KS0127
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|0x0f
)paren
op_eq
l_int|9
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is a KS0127B Rev. A&quot;
)paren
suffix:semicolon
id|ov-&gt;sensor
op_assign
id|SEN_KS0127B
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Error: Sensor is an unsupported KS0122&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set sensor-specific vars */
id|ov-&gt;maxwidth
op_assign
l_int|640
suffix:semicolon
id|ov-&gt;maxheight
op_assign
l_int|480
suffix:semicolon
id|ov-&gt;minwidth
op_assign
l_int|64
suffix:semicolon
id|ov-&gt;minheight
op_assign
l_int|48
suffix:semicolon
singleline_comment|// FIXME: These do not match the actual settings yet
id|ov-&gt;brightness
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;contrast
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;colour
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;hue
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* This device is not supported yet. Bail out now... */
id|err
c_func
(paren
l_string|&quot;This sensor is not supported yet.&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This initializes the SAA7111A video decoder. */
r_static
r_int
DECL|function|saa7111a_configure
id|saa7111a_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/* Since there is no register reset command, all registers must be&n;&t; * written, otherwise gives erratic results */
r_static
r_struct
id|ov511_regvals
id|aRegvalsNormSAA7111A
(braket
)braket
op_assign
(brace
(brace
id|OV511_I2C_BUS
comma
l_int|0x06
comma
l_int|0xce
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x07
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x10
comma
l_int|0x44
)brace
comma
multiline_comment|/* YUV422, 240/286 lines */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0e
comma
l_int|0x01
)brace
comma
multiline_comment|/* NTSC M or PAL BGHI */
(brace
id|OV511_I2C_BUS
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x01
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x03
comma
l_int|0x23
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x04
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x05
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x08
comma
l_int|0xc8
)brace
comma
multiline_comment|/* Auto field freq */
(brace
id|OV511_I2C_BUS
comma
l_int|0x09
comma
l_int|0x01
)brace
comma
multiline_comment|/* Chrom. trap off, APER=0.25 */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0a
comma
l_int|0x80
)brace
comma
multiline_comment|/* BRIG=128 */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0b
comma
l_int|0x40
)brace
comma
multiline_comment|/* CONT=1.0 */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x40
)brace
comma
multiline_comment|/* SATN=1.0 */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0d
comma
l_int|0x00
)brace
comma
multiline_comment|/* HUE=0 */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0f
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x11
comma
l_int|0x0c
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x13
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x14
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x15
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x16
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x17
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x02
comma
l_int|0xc0
)brace
comma
multiline_comment|/* Composite input 0 */
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
singleline_comment|// FIXME: I don&squot;t know how to sync or reset it yet
macro_line|#if 0
r_if
c_cond
(paren
id|ov51x_init_saa_sensor
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to initialize the SAA7111A&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;SAA7111A sensor detected&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Set sensor-specific vars */
id|ov-&gt;maxwidth
op_assign
l_int|640
suffix:semicolon
id|ov-&gt;maxheight
op_assign
l_int|480
suffix:semicolon
multiline_comment|/* Even/Odd fields */
id|ov-&gt;minwidth
op_assign
l_int|320
suffix:semicolon
id|ov-&gt;minheight
op_assign
l_int|240
suffix:semicolon
multiline_comment|/* Even field only */
id|ov-&gt;has_decoder
op_assign
l_int|1
suffix:semicolon
id|ov-&gt;num_inputs
op_assign
l_int|8
suffix:semicolon
id|ov-&gt;norm
op_assign
id|VIDEO_MODE_AUTO
suffix:semicolon
id|ov-&gt;stop_during_set
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Decoder guarantees stable image */
multiline_comment|/* Decoder doesn&squot;t change these values, so we use these instead of&n;&t; * acutally reading the registers (which doesn&squot;t work) */
id|ov-&gt;brightness
op_assign
l_int|0x80
op_lshift
l_int|8
suffix:semicolon
id|ov-&gt;contrast
op_assign
l_int|0x40
op_lshift
l_int|9
suffix:semicolon
id|ov-&gt;colour
op_assign
l_int|0x40
op_lshift
l_int|9
suffix:semicolon
id|ov-&gt;hue
op_assign
l_int|32768
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Writing SAA7111A registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsNormSAA7111A
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Detect version of decoder. This must be done after writing the&n;         * initial regs or the decoder will lock up. */
id|rc
op_assign
id|i2c_r
c_func
(paren
id|ov
comma
l_int|0x00
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error detecting sensor version&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is an SAA7111A (version 0x%x)&quot;
comma
id|rc
)paren
suffix:semicolon
id|ov-&gt;sensor
op_assign
id|SEN_SAA7111A
suffix:semicolon
)brace
singleline_comment|// FIXME: Fix this for OV518(+)
multiline_comment|/* Latch to negative edge of clock. Otherwise, we get incorrect&n;&t; * colors and jitter in the digital signal. */
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV511
)paren
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x11
comma
l_int|0x00
)paren
suffix:semicolon
r_else
id|warn
c_func
(paren
l_string|&quot;SAA7111A not yet supported with OV518/OV518+&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This initializes the OV511/OV511+ and the sensor */
r_static
r_int
DECL|function|ov511_configure
id|ov511_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_static
r_struct
id|ov511_regvals
id|aRegvalsInit511
(braket
)braket
op_assign
(brace
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_RESET
comma
l_int|0x7f
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_INIT
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_RESET
comma
l_int|0x7f
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_INIT
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_RESET
comma
l_int|0x3f
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_INIT
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_RESET
comma
l_int|0x3d
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm511
(braket
)braket
op_assign
(brace
(brace
id|OV511_REG_BUS
comma
id|R511_DRAM_FLOW_CTL
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_SNAP
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_SNAP
comma
l_int|0x03
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_SNAP
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R511_FIFO_OPTS
comma
l_int|0x1f
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R511_COMP_EN
comma
l_int|0x00
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R511_COMP_LUT_EN
comma
l_int|0x03
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm511Plus
(braket
)braket
op_assign
(brace
(brace
id|OV511_REG_BUS
comma
id|R511_DRAM_FLOW_CTL
comma
l_int|0xff
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_SNAP
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_SNAP
comma
l_int|0x03
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_SNAP
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R511_FIFO_OPTS
comma
l_int|0xff
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R511_COMP_EN
comma
l_int|0x00
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R511_COMP_LUT_EN
comma
l_int|0x03
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
id|ov-&gt;customid
op_assign
id|reg_r
c_func
(paren
id|ov
comma
id|R511_SYS_CUST_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;customid
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Unable to read camera bridge registers&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|PDEBUG
(paren
l_int|1
comma
l_string|&quot;CustomID = %d&quot;
comma
id|ov-&gt;customid
)paren
suffix:semicolon
id|ov-&gt;desc
op_assign
id|symbolic
c_func
(paren
id|camlist
comma
id|ov-&gt;customid
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;model: %s&quot;
comma
id|ov-&gt;desc
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|strcmp
c_func
(paren
id|ov-&gt;desc
comma
id|NOT_DEFINED_STR
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Camera type (%d) not recognized&quot;
comma
id|ov-&gt;customid
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;Please notify &quot;
id|EMAIL
l_string|&quot; of the name,&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;manufacturer, model, and this number of your camera.&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;Also include the output of the detection process.&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;customid
op_eq
l_int|6
)paren
(brace
multiline_comment|/* USB Life TV (NTSC) */
id|ov-&gt;tuner_type
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Temic 4036FY5 3X 1981 */
)brace
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsInit511
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;led_policy
op_eq
id|LED_OFF
op_logical_or
id|ov-&gt;led_policy
op_eq
id|LED_AUTO
)paren
id|ov51x_led_control
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* The OV511+ has undocumented bits in the flow control register.&n;&t; * Setting it to 0xff fixes the corruption with moving objects. */
r_if
c_cond
(paren
id|ov-&gt;bridge
op_eq
id|BRG_OV511
)paren
(brace
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsNorm511
)paren
)paren
r_goto
id|error
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ov-&gt;bridge
op_eq
id|BRG_OV511PLUS
)paren
(brace
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsNorm511Plus
)paren
)paren
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Invalid bridge&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov511_init_compression
c_func
(paren
id|ov
)paren
)paren
r_goto
id|error
suffix:semicolon
id|ov51x_set_packet_size
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
id|ov-&gt;snap_enabled
op_assign
id|snapshot
suffix:semicolon
multiline_comment|/* Test for 7xx0 */
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Testing for 0V7xx0&quot;
)paren
suffix:semicolon
id|ov-&gt;primary_i2c_slave
op_assign
id|OV7xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|OV7xx0_SID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Test for 6xx0 */
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Testing for 0V6xx0&quot;
)paren
suffix:semicolon
id|ov-&gt;primary_i2c_slave
op_assign
id|OV6xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|OV6xx0_SID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Test for 8xx0 */
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Testing for 0V8xx0&quot;
)paren
suffix:semicolon
id|ov-&gt;primary_i2c_slave
op_assign
id|OV8xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|OV8xx0_SID
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Test for SAA7111A */
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Testing for SAA7111A&quot;
)paren
suffix:semicolon
id|ov-&gt;primary_i2c_slave
op_assign
id|SAA7111A_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|SAA7111A_SID
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x0d
comma
l_int|0x00
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Test for KS0127 */
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Testing for KS0127&quot;
)paren
suffix:semicolon
id|ov-&gt;primary_i2c_slave
op_assign
id|KS0127_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|KS0127_SID
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|i2c_w
c_func
(paren
id|ov
comma
l_int|0x10
comma
l_int|0x00
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t determine sensor slave IDs&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ks0127_configure
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to configure KS0127&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|saa7111a_configure
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to configure SAA7111A&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Detected unsupported OV8xx0 sensor&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov6xx0_configure
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to configure OV6xx0&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov7xx0_configure
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to configure OV7xx0&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|err
c_func
(paren
l_string|&quot;OV511 Config failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* This initializes the OV518/OV518+ and the sensor */
r_static
r_int
DECL|function|ov518_configure
id|ov518_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov
)paren
(brace
r_static
r_struct
id|ov511_regvals
id|aRegvalsInit518
(braket
)braket
op_assign
(brace
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_RESET
comma
l_int|0x40
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_INIT
comma
l_int|0xe1
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_RESET
comma
l_int|0x3e
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_INIT
comma
l_int|0xe1
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_RESET
comma
l_int|0x00
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_INIT
comma
l_int|0xe1
)brace
comma
(brace
id|OV511_REG_BUS
comma
l_int|0x46
comma
l_int|0x00
)brace
comma
(brace
id|OV511_REG_BUS
comma
l_int|0x5d
comma
l_int|0x03
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* New values, based on Windows driver. Since what they do is not&n;&t; * known yet, this may be incorrect. */
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm518
(braket
)braket
op_assign
(brace
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_SNAP
comma
l_int|0x02
)brace
comma
multiline_comment|/* Reset */
(brace
id|OV511_REG_BUS
comma
id|R51x_SYS_SNAP
comma
l_int|0x01
)brace
comma
multiline_comment|/* Enable */
(brace
id|OV511_REG_BUS
comma
l_int|0x31
comma
l_int|0x0f
)brace
comma
(brace
id|OV511_REG_BUS
comma
l_int|0x5d
comma
l_int|0x03
)brace
comma
(brace
id|OV511_REG_BUS
comma
l_int|0x24
comma
l_int|0x9f
)brace
comma
(brace
id|OV511_REG_BUS
comma
l_int|0x25
comma
l_int|0x90
)brace
comma
(brace
id|OV511_REG_BUS
comma
l_int|0x20
comma
l_int|0x00
)brace
comma
multiline_comment|/* Was 0x08 */
(brace
id|OV511_REG_BUS
comma
l_int|0x51
comma
l_int|0x04
)brace
comma
(brace
id|OV511_REG_BUS
comma
l_int|0x71
comma
l_int|0x19
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* First 5 bits of custom ID reg are a revision ID on OV518 */
id|info
c_func
(paren
l_string|&quot;Device revision %d&quot;
comma
l_int|0x1F
op_amp
id|reg_r
c_func
(paren
id|ov
comma
id|R511_SYS_CUST_ID
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsInit518
)paren
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* Set LED GPIO pin to output mode */
r_if
c_cond
(paren
id|reg_w_mask
c_func
(paren
id|ov
comma
l_int|0x57
comma
l_int|0x00
comma
l_int|0x02
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* LED is off by default with OV518; have to explicitly turn it on */
r_if
c_cond
(paren
id|ov-&gt;led_policy
op_eq
id|LED_OFF
op_logical_or
id|ov-&gt;led_policy
op_eq
id|LED_AUTO
)paren
id|ov51x_led_control
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
r_else
id|ov51x_led_control
c_func
(paren
id|ov
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t require compression if dumppix is enabled; otherwise it&squot;s&n;&t; * required. OV518 has no uncompressed mode, to save RAM. */
r_if
c_cond
(paren
op_logical_neg
id|dumppix
op_logical_and
op_logical_neg
id|ov-&gt;compress
)paren
(brace
id|ov-&gt;compress
op_assign
l_int|1
suffix:semicolon
id|warn
c_func
(paren
l_string|&quot;Compression required with OV518...enabling&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|write_regvals
c_func
(paren
id|ov
comma
id|aRegvalsNorm518
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|reg_w
c_func
(paren
id|ov
comma
l_int|0x2f
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov518_init_compression
c_func
(paren
id|ov
)paren
)paren
r_goto
id|error
suffix:semicolon
id|ov51x_set_packet_size
c_func
(paren
id|ov
comma
l_int|0
)paren
suffix:semicolon
id|ov-&gt;snap_enabled
op_assign
id|snapshot
suffix:semicolon
multiline_comment|/* Test for 76xx */
id|ov-&gt;primary_i2c_slave
op_assign
id|OV7xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|OV7xx0_SID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* The OV518 must be more aggressive about sensor detection since&n;&t; * I2C write will never fail if the sensor is not present. We have&n;&t; * to try to initialize the sensor to detect its presence */
r_if
c_cond
(paren
id|init_ov_sensor
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Test for 6xx0 */
id|ov-&gt;primary_i2c_slave
op_assign
id|OV6xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|OV6xx0_SID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|init_ov_sensor
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Test for 8xx0 */
id|ov-&gt;primary_i2c_slave
op_assign
id|OV8xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|ov51x_set_slave_ids
c_func
(paren
id|ov
comma
id|OV8xx0_SID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|init_ov_sensor
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t determine sensor slave IDs&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Detected unsupported OV8xx0 sensor&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov6xx0_configure
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to configure OV6xx0&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov7xx0_configure
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to configure OV7xx0&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
singleline_comment|// FIXME: Sizes &gt; 320x240 are not working yet
id|ov-&gt;maxwidth
op_assign
l_int|320
suffix:semicolon
id|ov-&gt;maxheight
op_assign
l_int|240
suffix:semicolon
singleline_comment|// The OV518 cannot go as low as the sensor can
id|ov-&gt;minwidth
op_assign
l_int|160
suffix:semicolon
id|ov-&gt;minheight
op_assign
l_int|120
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|err
c_func
(paren
l_string|&quot;OV518 Config failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  USB routines&n; *&n; ***************************************************************************/
r_static
r_void
op_star
DECL|function|ov51x_probe
id|ov51x_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|ifnum
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|registered
op_assign
l_int|0
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;probing for device...&quot;
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-config cameras */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
r_return
l_int|NULL
suffix:semicolon
id|interface
op_assign
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Checking vendor/product should be enough, but what the hell */
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|0xFF
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|0x00
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ov
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ov
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;couldn&squot;t kmalloc ov struct&quot;
)paren
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ov
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ov
)paren
)paren
suffix:semicolon
id|ov-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ov-&gt;iface
op_assign
id|interface-&gt;bInterfaceNumber
suffix:semicolon
id|ov-&gt;led_policy
op_assign
id|led
suffix:semicolon
id|ov-&gt;compress
op_assign
id|compress
suffix:semicolon
id|ov-&gt;lightfreq
op_assign
id|lightfreq
suffix:semicolon
id|ov-&gt;num_inputs
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Video decoder init functs. change this */
id|ov-&gt;stop_during_set
op_assign
op_logical_neg
id|fastset
suffix:semicolon
id|ov-&gt;tuner_type
op_assign
id|tuner
suffix:semicolon
id|ov-&gt;backlight
op_assign
id|backlight
suffix:semicolon
id|ov-&gt;auto_brt
op_assign
id|autobright
suffix:semicolon
id|ov-&gt;auto_gain
op_assign
id|autogain
suffix:semicolon
id|ov-&gt;auto_exp
op_assign
id|autoexp
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;descriptor.idProduct
)paren
(brace
r_case
id|PROD_OV511
suffix:colon
id|ov-&gt;bridge
op_assign
id|BRG_OV511
suffix:semicolon
id|ov-&gt;bclass
op_assign
id|BCL_OV511
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PROD_OV511PLUS
suffix:colon
id|ov-&gt;bridge
op_assign
id|BRG_OV511PLUS
suffix:semicolon
id|ov-&gt;bclass
op_assign
id|BCL_OV511
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PROD_OV518
suffix:colon
id|ov-&gt;bridge
op_assign
id|BRG_OV518
suffix:semicolon
id|ov-&gt;bclass
op_assign
id|BCL_OV518
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PROD_OV518PLUS
suffix:colon
id|ov-&gt;bridge
op_assign
id|BRG_OV518PLUS
suffix:semicolon
id|ov-&gt;bclass
op_assign
id|BCL_OV518
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PROD_ME2CAM
suffix:colon
r_if
c_cond
(paren
id|dev-&gt;descriptor.idVendor
op_ne
id|VEND_MATTEL
)paren
r_goto
id|error
suffix:semicolon
id|ov-&gt;bridge
op_assign
id|BRG_OV511PLUS
suffix:semicolon
id|ov-&gt;bclass
op_assign
id|BCL_OV511
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Unknown product ID 0x%x&quot;
comma
id|dev-&gt;descriptor.idProduct
)paren
suffix:semicolon
r_goto
id|error_dealloc
suffix:semicolon
)brace
id|info
c_func
(paren
l_string|&quot;USB %s video device found&quot;
comma
id|symbolic
c_func
(paren
id|brglist
comma
id|ov-&gt;bridge
)paren
)paren
suffix:semicolon
multiline_comment|/* Workaround for some applications that want data in RGB&n;&t; * instead of BGR. */
r_if
c_cond
(paren
id|force_rgb
)paren
id|info
c_func
(paren
l_string|&quot;data format set to RGB&quot;
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ov-&gt;wq
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ov-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* to 1 == available */
id|init_MUTEX
c_func
(paren
op_amp
id|ov-&gt;buf_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ov-&gt;param_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ov-&gt;i2c_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
id|ov-&gt;buf_state
op_assign
id|BUF_NOT_ALLOCATED
suffix:semicolon
multiline_comment|/* Must be kmalloc()&squot;ed, for DMA accessibility */
id|ov-&gt;cbuf
op_assign
id|kmalloc
c_func
(paren
id|OV511_CBUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;cbuf
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;bclass
op_eq
id|BCL_OV518
)paren
(brace
r_if
c_cond
(paren
id|ov518_configure
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov511_configure
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|framenum
op_assign
id|i
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ov-&gt;frame
(braket
id|i
)braket
dot
id|wq
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMSBUF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|ov
op_assign
id|ov
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|lock
)paren
suffix:semicolon
id|ov-&gt;sbuf
(braket
id|i
)braket
dot
id|n
op_assign
id|i
suffix:semicolon
)brace
multiline_comment|/* Unnecessary? (This is done on open(). Need to make sure variables&n;&t; * are properly initialized without this before removing it, though). */
r_if
c_cond
(paren
id|ov51x_set_default_params
c_func
(paren
id|ov
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
macro_line|#ifdef OV511_DEBUG
r_if
c_cond
(paren
id|dump_bridge
)paren
id|ov511_dump_regs
c_func
(paren
id|ov
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
op_amp
id|ov-&gt;vdev
comma
op_amp
id|vdev_template
comma
r_sizeof
(paren
id|vdev_template
)paren
)paren
suffix:semicolon
id|ov-&gt;vdev.priv
op_assign
id|ov
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_MAX_UNIT_VIDEO
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Minor 0 cannot be specified; assume user wants autodetect */
r_if
c_cond
(paren
id|unit_video
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|ov-&gt;vdev
comma
id|VFL_TYPE_GRABBER
comma
id|unit_video
(braket
id|i
)braket
)paren
op_ge
l_int|0
)paren
(brace
id|registered
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Use the next available one */
r_if
c_cond
(paren
op_logical_neg
id|registered
op_logical_and
id|video_register_device
c_func
(paren
op_amp
id|ov-&gt;vdev
comma
id|VFL_TYPE_GRABBER
comma
op_minus
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;video_register_device failed&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|info
c_func
(paren
l_string|&quot;Device registered on minor %d&quot;
comma
id|ov-&gt;vdev.minor
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|create_proc_ov511_cam
c_func
(paren
id|ov
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ov
suffix:semicolon
id|error
suffix:colon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
multiline_comment|/* Safe to call even if entry doesn&squot;t exist */
id|destroy_proc_ov511_cam
c_func
(paren
id|ov
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ov-&gt;cbuf
)paren
(brace
id|down
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov-&gt;cbuf
)paren
suffix:semicolon
id|ov-&gt;cbuf
op_assign
l_int|NULL
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
)brace
id|error_dealloc
suffix:colon
r_if
c_cond
(paren
id|ov
)paren
(brace
id|kfree
c_func
(paren
id|ov
)paren
suffix:semicolon
id|ov
op_assign
l_int|NULL
suffix:semicolon
)brace
id|error_out
suffix:colon
id|err
c_func
(paren
l_string|&quot;Camera initialization failed&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|ov51x_disconnect
id|ov51x_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|ptr
suffix:semicolon
r_int
id|n
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want people trying to open up the device */
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;user
)paren
id|video_unregister_device
c_func
(paren
op_amp
id|ov-&gt;vdev
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Device open...deferring video_unregister_device&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|n
op_increment
)paren
id|ov-&gt;frame
(braket
id|n
)braket
dot
id|grabstate
op_assign
id|FRAME_ERROR
suffix:semicolon
id|ov-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* This will cause the process to request another frame */
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|n
op_increment
)paren
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|ov-&gt;frame
(braket
id|n
)braket
dot
id|wq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ov-&gt;frame
(braket
id|n
)braket
dot
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|ov-&gt;wq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ov-&gt;wq
)paren
suffix:semicolon
id|ov-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|ov51x_unlink_isoc
c_func
(paren
id|ov
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|destroy_proc_ov511_cam
c_func
(paren
id|ov
)paren
suffix:semicolon
macro_line|#endif
id|ov-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Free the memory */
r_if
c_cond
(paren
id|ov
op_logical_and
op_logical_neg
id|ov-&gt;user
)paren
(brace
id|down
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov-&gt;cbuf
)paren
suffix:semicolon
id|ov-&gt;cbuf
op_assign
l_int|NULL
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov-&gt;cbuf_lock
)paren
suffix:semicolon
id|ov51x_dealloc
c_func
(paren
id|ov
comma
l_int|1
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov
)paren
suffix:semicolon
id|ov
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|variable|ov511_driver
r_static
r_struct
id|usb_driver
id|ov511_driver
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|name
suffix:colon
l_string|&quot;ov511&quot;
comma
id|id_table
suffix:colon
id|device_table
comma
id|probe
suffix:colon
id|ov51x_probe
comma
id|disconnect
suffix:colon
id|ov51x_disconnect
)brace
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; *  Module routines&n; *&n; ***************************************************************************/
multiline_comment|/* Returns 0 for success */
r_int
DECL|function|ov511_register_decomp_module
id|ov511_register_decomp_module
c_func
(paren
r_int
id|ver
comma
r_struct
id|ov51x_decomp_ops
op_star
id|ops
comma
r_int
id|ov518
comma
r_int
id|mmx
)paren
(brace
r_if
c_cond
(paren
id|ver
op_ne
id|DECOMP_INTERFACE_VER
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Decompression module has incompatible&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;interface version %d&quot;
comma
id|ver
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;Interface version %d is required&quot;
comma
id|DECOMP_INTERFACE_VER
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ops
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|mmx
op_logical_and
op_logical_neg
id|ov51x_mmx_available
)paren
(brace
id|err
c_func
(paren
l_string|&quot;MMX not available on this system or kernel&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov518
)paren
(brace
r_if
c_cond
(paren
id|mmx
)paren
(brace
r_if
c_cond
(paren
id|ov518_mmx_decomp_ops
)paren
r_goto
id|err_in_use
suffix:semicolon
r_else
id|ov518_mmx_decomp_ops
op_assign
id|ops
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov518_decomp_ops
)paren
r_goto
id|err_in_use
suffix:semicolon
r_else
id|ov518_decomp_ops
op_assign
id|ops
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|mmx
)paren
(brace
r_if
c_cond
(paren
id|ov511_mmx_decomp_ops
)paren
r_goto
id|err_in_use
suffix:semicolon
r_else
id|ov511_mmx_decomp_ops
op_assign
id|ops
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov511_decomp_ops
)paren
r_goto
id|err_in_use
suffix:semicolon
r_else
id|ov511_decomp_ops
op_assign
id|ops
suffix:semicolon
)brace
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_in_use
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_void
DECL|function|ov511_deregister_decomp_module
id|ov511_deregister_decomp_module
c_func
(paren
r_int
id|ov518
comma
r_int
id|mmx
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov518
)paren
(brace
r_if
c_cond
(paren
id|mmx
)paren
id|ov518_mmx_decomp_ops
op_assign
l_int|NULL
suffix:semicolon
r_else
id|ov518_decomp_ops
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mmx
)paren
id|ov511_mmx_decomp_ops
op_assign
l_int|NULL
suffix:semicolon
r_else
id|ov511_decomp_ops
op_assign
l_int|NULL
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|usb_ov511_init
id|usb_ov511_init
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|proc_ov511_create
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|usb_register
c_func
(paren
op_amp
id|ov511_driver
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// FIXME: Don&squot;t know how to determine this yet
id|ov51x_mmx_available
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined (__i386__)
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|X86_FEATURE_MMX
comma
op_amp
id|boot_cpu_data.x86_capability
)paren
)paren
id|ov51x_mmx_available
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|info
c_func
(paren
id|DRIVER_VERSION
l_string|&quot; : &quot;
id|DRIVER_DESC
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|usb_ov511_exit
id|usb_ov511_exit
c_func
(paren
r_void
)paren
(brace
id|usb_deregister
c_func
(paren
op_amp
id|ov511_driver
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;driver deregistered&quot;
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|proc_ov511_destroy
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|usb_ov511_init
id|module_init
c_func
(paren
id|usb_ov511_init
)paren
suffix:semicolon
DECL|variable|usb_ov511_exit
id|module_exit
c_func
(paren
id|usb_ov511_exit
)paren
suffix:semicolon
multiline_comment|/* No version, for compatibility with binary-only modules */
DECL|variable|ov511_register_decomp_module
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|ov511_register_decomp_module
)paren
suffix:semicolon
DECL|variable|ov511_deregister_decomp_module
id|EXPORT_SYMBOL_NOVERS
c_func
(paren
id|ov511_deregister_decomp_module
)paren
suffix:semicolon
eof
