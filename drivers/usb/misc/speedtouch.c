multiline_comment|/******************************************************************************&n; *  speedtouch.c  --  Alcatel SpeedTouch USB xDSL modem driver.&n; *&n; *  Copyright (C) 2001, Alcatel&n; *&n; *  This program is free software; you can redistribute it and/or modify it&n; *  under the terms of the GNU General Public License as published by the Free&n; *  Software Foundation; either version 2 of the License, or (at your option)&n; *  any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for&n; *  more details.&n; *&n; *  You should have received a copy of the GNU General Public License along with&n; *  this program; if not, write to the Free Software Foundation, Inc., 59&n; *  Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n; *&n; ******************************************************************************/
multiline_comment|/*&n; *  Written by Johan Verrept (Johan.Verrept@advalvas.be)&n; *&n; *  1.5A:&t;- Version for inclusion in 2.5 series kernel&n; *&t;&t;- Modifications by Richard Purdie (rpurdie@rpsys.net)&n; *&t;&t;- made compatible with kernel 2.5.6 onwards by changing&n; *&t;&t;udsl_usb_send_data_context-&gt;urb to a pointer and adding code&n; *&t;&t;to alloc and free it&n; *&t;&t;- remove_wait_queue() added to udsl_atm_processqueue_thread()&n; *&n; *  1.5:&t;- fixed memory leak when atmsar_decode_aal5 returned NULL.&n; *&t;&t;(reported by stephen.robinson@zen.co.uk)&n; *&n; *  1.4:&t;- changed the spin_lock() under interrupt to spin_lock_irqsave()&n; *&t;&t;- unlink all active send urbs of a vcc that is being closed.&n; *&n; *  1.3.1:&t;- added the version number&n; *&n; *  1.3:&t;- Added multiple send urb support&n; *&t;&t;- fixed memory leak and vcc-&gt;tx_inuse starvation bug&n; *&t;&t;  when not enough memory left in vcc.&n; *&n; *  1.2:&t;- Fixed race condition in udsl_usb_send_data()&n; *  1.1:&t;- Turned off packet debugging&n; *&n; */
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/atm.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &quot;atmsar.h&quot;
multiline_comment|/*&n;#define DEBUG 1&n;#define DEBUG_PACKET 1&n;*/
macro_line|#ifdef DEBUG
DECL|macro|PDEBUG
mdefine_line|#define PDEBUG(arg...)  printk(KERN_DEBUG &quot;SpeedTouch USB: &quot; arg)
macro_line|#else
DECL|macro|PDEBUG
mdefine_line|#define PDEBUG(arg...)
macro_line|#endif
macro_line|#ifdef DEBUG_PACKET
DECL|macro|PACKETDEBUG
mdefine_line|#define PACKETDEBUG(arg...) udsl_print_packet ( arg )
macro_line|#else
DECL|macro|PACKETDEBUG
mdefine_line|#define PACKETDEBUG(arg...)
macro_line|#endif
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Johan Verrept, Johan.Verrept@advalvas.be&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;Driver for the Alcatel SpeedTouch USB ADSL modem&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;1.5A&quot;
DECL|macro|SPEEDTOUCH_VENDORID
mdefine_line|#define SPEEDTOUCH_VENDORID&t;&t;0x06b9
DECL|macro|SPEEDTOUCH_PRODUCTID
mdefine_line|#define SPEEDTOUCH_PRODUCTID&t;&t;0x4061
DECL|macro|UDSL_NUMBER_RCV_URBS
mdefine_line|#define UDSL_NUMBER_RCV_URBS&t;&t;1
DECL|macro|UDSL_NUMBER_SND_URBS
mdefine_line|#define UDSL_NUMBER_SND_URBS&t;&t;1
DECL|macro|UDSL_NUMBER_SND_BUFS
mdefine_line|#define UDSL_NUMBER_SND_BUFS&t;&t;(2*UDSL_NUMBER_SND_URBS)
DECL|macro|UDSL_RCV_BUFFER_SIZE
mdefine_line|#define UDSL_RCV_BUFFER_SIZE&t;&t;(1*64) /* ATM cells */
DECL|macro|UDSL_SND_BUFFER_SIZE
mdefine_line|#define UDSL_SND_BUFFER_SIZE&t;&t;(2*64) /* ATM cells */
multiline_comment|/* max should be (1500 IP mtu + 2 ppp bytes + 32 * 5 cellheader overhead) for&n; * PPPoA and (1500 + 14 + 32*5 cellheader overhead) for PPPoE */
DECL|macro|UDSL_MAX_AAL5_MRU
mdefine_line|#define UDSL_MAX_AAL5_MRU&t;&t;2048
DECL|macro|UDSL_IOCTL_START
mdefine_line|#define UDSL_IOCTL_START&t;&t;1
DECL|macro|UDSL_IOCTL_STOP
mdefine_line|#define UDSL_IOCTL_STOP&t;&t;&t;2
multiline_comment|/* endpoint declarations */
DECL|macro|UDSL_ENDPOINT_DATA_OUT
mdefine_line|#define UDSL_ENDPOINT_DATA_OUT&t;&t;0x07
DECL|macro|UDSL_ENDPOINT_DATA_IN
mdefine_line|#define UDSL_ENDPOINT_DATA_IN&t;&t;0x87
DECL|macro|hex2int
mdefine_line|#define hex2int(c) ( (c &gt;= &squot;0&squot;)&amp;&amp;(c &lt;= &squot;9&squot;) ?  (c - &squot;0&squot;) : ((c &amp; 0xf)+9) )
multiline_comment|/* usb_device_id struct */
DECL|variable|udsl_usb_ids
r_static
r_struct
id|usb_device_id
id|udsl_usb_ids
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
(paren
id|SPEEDTOUCH_VENDORID
comma
id|SPEEDTOUCH_PRODUCTID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|udsl_usb_ids
)paren
suffix:semicolon
multiline_comment|/* context declarations */
DECL|struct|udsl_receiver
r_struct
id|udsl_receiver
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
DECL|member|instance
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udsl_send_buffer
r_struct
id|udsl_send_buffer
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|base
r_int
r_char
op_star
id|base
suffix:semicolon
DECL|member|free_start
r_int
r_char
op_star
id|free_start
suffix:semicolon
DECL|member|free_cells
r_int
r_int
id|free_cells
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udsl_sender
r_struct
id|udsl_sender
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|buffer
r_struct
id|udsl_send_buffer
op_star
id|buffer
suffix:semicolon
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
DECL|member|instance
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udsl_control
r_struct
id|udsl_control
(brace
DECL|member|atm_data
r_struct
id|atm_skb_data
id|atm_data
suffix:semicolon
DECL|member|num_cells
r_int
r_int
id|num_cells
suffix:semicolon
DECL|member|num_entire
r_int
r_int
id|num_entire
suffix:semicolon
DECL|member|cell_header
r_int
r_char
id|cell_header
(braket
id|ATM_CELL_HEADER
)braket
suffix:semicolon
DECL|member|pdu_padding
r_int
r_int
id|pdu_padding
suffix:semicolon
DECL|member|aal5_trailer
r_int
r_char
id|aal5_trailer
(braket
id|ATM_AAL5_TRAILER
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|UDSL_SKB
mdefine_line|#define UDSL_SKB(x)&t;&t;((struct udsl_control *)(x)-&gt;cb)
multiline_comment|/*&n; * UDSL main driver data&n; */
DECL|struct|udsl_instance_data
r_struct
id|udsl_instance_data
(brace
DECL|member|serialize
r_struct
id|semaphore
id|serialize
suffix:semicolon
multiline_comment|/* usb device part */
DECL|member|usb_dev
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
DECL|member|firmware_loaded
r_int
id|firmware_loaded
suffix:semicolon
multiline_comment|/* atm device part */
DECL|member|atm_dev
r_struct
id|atm_dev
op_star
id|atm_dev
suffix:semicolon
DECL|member|atmsar_vcc_list
r_struct
id|atmsar_vcc_data
op_star
id|atmsar_vcc_list
suffix:semicolon
multiline_comment|/* receiving */
DECL|member|all_receivers
r_struct
id|udsl_receiver
id|all_receivers
(braket
id|UDSL_NUMBER_RCV_URBS
)braket
suffix:semicolon
DECL|member|spare_receivers_lock
id|spinlock_t
id|spare_receivers_lock
suffix:semicolon
DECL|member|spare_receivers
r_struct
id|list_head
id|spare_receivers
suffix:semicolon
DECL|member|completed_receivers_lock
id|spinlock_t
id|completed_receivers_lock
suffix:semicolon
DECL|member|completed_receivers
r_struct
id|list_head
id|completed_receivers
suffix:semicolon
DECL|member|receive_tasklet
r_struct
id|tasklet_struct
id|receive_tasklet
suffix:semicolon
multiline_comment|/* sending */
DECL|member|all_senders
r_struct
id|udsl_sender
id|all_senders
(braket
id|UDSL_NUMBER_SND_URBS
)braket
suffix:semicolon
DECL|member|all_buffers
r_struct
id|udsl_send_buffer
id|all_buffers
(braket
id|UDSL_NUMBER_SND_BUFS
)braket
suffix:semicolon
DECL|member|sndqueue
r_struct
id|sk_buff_head
id|sndqueue
suffix:semicolon
DECL|member|send_lock
id|spinlock_t
id|send_lock
suffix:semicolon
DECL|member|spare_senders
r_struct
id|list_head
id|spare_senders
suffix:semicolon
DECL|member|spare_buffers
r_struct
id|list_head
id|spare_buffers
suffix:semicolon
DECL|member|send_tasklet
r_struct
id|tasklet_struct
id|send_tasklet
suffix:semicolon
DECL|member|current_skb
r_struct
id|sk_buff
op_star
id|current_skb
suffix:semicolon
DECL|member|current_buffer
r_struct
id|udsl_send_buffer
op_star
id|current_buffer
suffix:semicolon
DECL|member|filled_buffers
r_struct
id|list_head
id|filled_buffers
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|udsl_driver_name
r_static
r_const
r_char
id|udsl_driver_name
(braket
)braket
op_assign
l_string|&quot;Alcatel SpeedTouch USB&quot;
suffix:semicolon
macro_line|#ifdef DEBUG_PACKET
r_static
r_int
id|udsl_print_packet
(paren
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * atm driver prototypes and stuctures&n; */
r_static
r_int
id|udsl_atm_open
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
suffix:semicolon
r_static
r_void
id|udsl_atm_close
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_ioctl
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_send
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_proc_read
(paren
r_struct
id|atm_dev
op_star
id|atm_dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
suffix:semicolon
DECL|variable|udsl_atm_devops
r_static
r_struct
id|atmdev_ops
id|udsl_atm_devops
op_assign
(brace
dot
id|open
op_assign
id|udsl_atm_open
comma
dot
id|close
op_assign
id|udsl_atm_close
comma
dot
id|ioctl
op_assign
id|udsl_atm_ioctl
comma
dot
id|send
op_assign
id|udsl_atm_send
comma
dot
id|proc_read
op_assign
id|udsl_atm_proc_read
comma
)brace
suffix:semicolon
DECL|struct|udsl_atm_dev_data
r_struct
id|udsl_atm_dev_data
(brace
DECL|member|atmsar_vcc
r_struct
id|atmsar_vcc_data
op_star
id|atmsar_vcc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * usb driver prototypes and structures&n; */
r_static
r_int
id|udsl_usb_probe
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_void
id|udsl_usb_disconnect
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
suffix:semicolon
r_static
r_int
id|udsl_usb_ioctl
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_int
r_int
id|code
comma
r_void
op_star
id|user_data
)paren
suffix:semicolon
DECL|variable|udsl_usb_driver
r_static
r_struct
id|usb_driver
id|udsl_usb_driver
op_assign
(brace
dot
id|name
op_assign
id|udsl_driver_name
comma
dot
id|probe
op_assign
id|udsl_usb_probe
comma
dot
id|disconnect
op_assign
id|udsl_usb_disconnect
comma
dot
id|ioctl
op_assign
id|udsl_usb_ioctl
comma
dot
id|id_table
op_assign
id|udsl_usb_ids
comma
)brace
suffix:semicolon
multiline_comment|/*************&n;**  encode  **&n;*************/
DECL|function|udsl_groom_skb
r_static
r_void
id|udsl_groom_skb
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|udsl_control
op_star
id|ctrl
op_assign
id|UDSL_SKB
(paren
id|skb
)paren
suffix:semicolon
r_int
r_int
id|zero_padding
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|crc
suffix:semicolon
id|ctrl-&gt;atm_data.vcc
op_assign
id|vcc
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|0
)braket
op_assign
id|vcc-&gt;vpi
op_rshift
l_int|4
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|1
)braket
op_assign
(paren
id|vcc-&gt;vpi
op_lshift
l_int|4
)paren
op_or
(paren
id|vcc-&gt;vci
op_rshift
l_int|12
)paren
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|2
)braket
op_assign
id|vcc-&gt;vci
op_rshift
l_int|4
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|3
)braket
op_assign
id|vcc-&gt;vci
op_lshift
l_int|4
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|4
)braket
op_assign
l_int|0xec
suffix:semicolon
id|ctrl-&gt;num_cells
op_assign
(paren
id|skb-&gt;len
op_plus
id|ATM_AAL5_TRAILER
op_plus
id|ATM_CELL_PAYLOAD
op_minus
l_int|1
)paren
op_div
id|ATM_CELL_PAYLOAD
suffix:semicolon
id|ctrl-&gt;num_entire
op_assign
id|skb-&gt;len
op_div
id|ATM_CELL_PAYLOAD
suffix:semicolon
id|zero_padding
op_assign
id|ctrl-&gt;num_cells
op_star
id|ATM_CELL_PAYLOAD
op_minus
id|skb-&gt;len
op_minus
id|ATM_AAL5_TRAILER
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;num_entire
op_plus
l_int|1
OL
id|ctrl-&gt;num_cells
)paren
id|ctrl-&gt;pdu_padding
op_assign
id|zero_padding
op_minus
(paren
id|ATM_CELL_PAYLOAD
op_minus
id|ATM_AAL5_TRAILER
)paren
suffix:semicolon
r_else
id|ctrl-&gt;pdu_padding
op_assign
id|zero_padding
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* UU = 0 */
id|ctrl-&gt;aal5_trailer
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CPI = 0 */
id|ctrl-&gt;aal5_trailer
(braket
l_int|2
)braket
op_assign
id|skb-&gt;len
op_rshift
l_int|8
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|3
)braket
op_assign
id|skb-&gt;len
suffix:semicolon
id|crc
op_assign
id|crc32
(paren
op_complement
l_int|0
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zero_padding
suffix:semicolon
id|i
op_increment
)paren
id|crc
op_assign
id|CRC32
(paren
l_int|0
comma
id|crc
)paren
suffix:semicolon
id|crc
op_assign
id|crc32
(paren
id|crc
comma
id|ctrl-&gt;aal5_trailer
comma
l_int|4
)paren
suffix:semicolon
id|crc
op_assign
op_complement
id|crc
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|4
)braket
op_assign
id|crc
op_rshift
l_int|24
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|5
)braket
op_assign
id|crc
op_rshift
l_int|16
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|6
)braket
op_assign
id|crc
op_rshift
l_int|8
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|7
)braket
op_assign
id|crc
suffix:semicolon
)brace
DECL|function|udsl_write_cell
r_static
r_char
op_star
id|udsl_write_cell
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|target
)paren
(brace
r_struct
id|udsl_control
op_star
id|ctrl
op_assign
id|UDSL_SKB
(paren
id|skb
)paren
suffix:semicolon
id|ctrl-&gt;num_cells
op_decrement
suffix:semicolon
id|memcpy
(paren
id|target
comma
id|ctrl-&gt;cell_header
comma
id|ATM_CELL_HEADER
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_CELL_HEADER
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;num_entire
)paren
(brace
id|ctrl-&gt;num_entire
op_decrement
suffix:semicolon
id|memcpy
(paren
id|target
comma
id|skb-&gt;data
comma
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_CELL_PAYLOAD
suffix:semicolon
id|__skb_pull
(paren
id|skb
comma
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
r_return
id|target
suffix:semicolon
)brace
id|memcpy
(paren
id|target
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|target
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|__skb_pull
(paren
id|skb
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|memset
(paren
id|target
comma
l_int|0
comma
id|ctrl-&gt;pdu_padding
)paren
suffix:semicolon
id|target
op_add_assign
id|ctrl-&gt;pdu_padding
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;num_cells
)paren
(brace
id|ctrl-&gt;pdu_padding
op_assign
id|ATM_CELL_PAYLOAD
op_minus
id|ATM_AAL5_TRAILER
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|target
comma
id|ctrl-&gt;aal5_trailer
comma
id|ATM_AAL5_TRAILER
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_AAL5_TRAILER
suffix:semicolon
multiline_comment|/* set pti bit in last cell */
op_star
(paren
id|target
op_plus
l_int|3
op_minus
id|ATM_CELL_SIZE
)paren
op_or_assign
l_int|0x2
suffix:semicolon
)brace
r_return
id|target
suffix:semicolon
)brace
multiline_comment|/**************&n;**  receive  **&n;**************/
DECL|function|udsl_complete_receive
r_static
r_void
id|udsl_complete_receive
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
r_struct
id|udsl_receiver
op_star
id|rcv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_complete_receive entered&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
op_logical_or
op_logical_neg
(paren
id|rcv
op_assign
id|urb-&gt;context
)paren
op_logical_or
op_logical_neg
(paren
id|instance
op_assign
id|rcv-&gt;instance
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;udsl_complete_receive: bad urb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* may not be in_interrupt() */
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;completed_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|rcv-&gt;list
comma
op_amp
id|instance-&gt;completed_receivers
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;completed_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_complete_receive: scheduling tasklet&bslash;n&quot;
)paren
suffix:semicolon
id|tasklet_schedule
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
)brace
DECL|function|udsl_process_receive
r_static
r_void
id|udsl_process_receive
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
(paren
r_struct
id|udsl_instance_data
op_star
)paren
id|data
suffix:semicolon
r_struct
id|udsl_receiver
op_star
id|rcv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|data_start
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_struct
id|atmsar_vcc_data
op_star
id|atmsar_vcc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
r_new
op_assign
l_int|NULL
comma
op_star
id|tmp
op_assign
l_int|NULL
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_process_receive entered&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;completed_receivers_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|instance-&gt;completed_receivers
)paren
)paren
(brace
id|rcv
op_assign
id|list_entry
(paren
id|instance-&gt;completed_receivers.next
comma
r_struct
id|udsl_receiver
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|rcv-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;completed_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|urb
op_assign
id|rcv-&gt;urb
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_process_receive: got packet %p with length %d and status %d&bslash;n&quot;
comma
id|urb
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
id|PDEBUG
(paren
l_string|&quot;udsl_process_receive: processing urb with rcv %p, urb %p, skb %p&bslash;n&quot;
comma
id|rcv
comma
id|urb
comma
id|rcv-&gt;skb
)paren
suffix:semicolon
multiline_comment|/* update the skb structure */
id|skb
op_assign
id|rcv-&gt;skb
suffix:semicolon
id|skb_trim
(paren
id|skb
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
(paren
id|skb
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
id|data_start
op_assign
id|skb-&gt;data
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;skb-&gt;len = %d&bslash;n&quot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|PACKETDEBUG
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
r_new
op_assign
id|atmsar_decode_rawcell
(paren
id|instance-&gt;atmsar_vcc_list
comma
id|skb
comma
op_amp
id|atmsar_vcc
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;(after cell processing)skb-&gt;len = %d&bslash;n&quot;
comma
r_new
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|atmsar_vcc-&gt;type
)paren
(brace
r_case
id|ATMSAR_TYPE_AAL5
suffix:colon
id|tmp
op_assign
r_new
suffix:semicolon
r_new
op_assign
id|atmsar_decode_aal5
(paren
id|atmsar_vcc
comma
r_new
)paren
suffix:semicolon
multiline_comment|/* we can&squot;t send NULL skbs upstream, the ATM layer would try to close the vcc... */
r_if
c_cond
(paren
r_new
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;(after aal5 decap) skb-&gt;len = %d&bslash;n&quot;
comma
r_new
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
op_member_access_from_pointer
id|len
op_logical_and
id|atm_charge
(paren
id|atmsar_vcc-&gt;vcc
comma
r_new
op_member_access_from_pointer
id|truesize
)paren
)paren
(brace
id|PACKETDEBUG
(paren
r_new
op_member_access_from_pointer
id|data
comma
r_new
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
id|atmsar_vcc-&gt;vcc-&gt;push
(paren
id|atmsar_vcc-&gt;vcc
comma
r_new
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
(paren
l_string|&quot;dropping incoming packet : rx_inuse = %d, vcc-&gt;sk-&gt;rcvbuf = %d, skb-&gt;true_size = %d&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|atmsar_vcc-&gt;vcc-&gt;rx_inuse
)paren
comma
id|atmsar_vcc-&gt;vcc-&gt;sk-&gt;rcvbuf
comma
r_new
op_member_access_from_pointer
id|truesize
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
r_new
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|PDEBUG
(paren
l_string|&quot;atmsar_decode_aal5 returned NULL!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* not supported. we delete the skb. */
id|printk
(paren
id|KERN_INFO
l_string|&quot;SpeedTouch USB: illegal vcc type. Dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
r_new
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* restore skb */
id|skb_push
(paren
id|skb
comma
id|skb-&gt;data
op_minus
id|data_start
)paren
suffix:semicolon
id|usb_fill_bulk_urb
(paren
id|urb
comma
id|instance-&gt;usb_dev
comma
id|usb_rcvbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_IN
)paren
comma
(paren
r_int
r_char
op_star
)paren
id|rcv-&gt;skb-&gt;data
comma
id|UDSL_RCV_BUFFER_SIZE
op_star
id|ATM_CELL_SIZE
comma
id|udsl_complete_receive
comma
id|rcv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
)paren
r_break
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_process_receive: submission failed&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_default
suffix:colon
multiline_comment|/* error or urb unlinked */
id|PDEBUG
(paren
l_string|&quot;udsl_process_receive: adding to spare_receivers&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;spare_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|rcv-&gt;list
comma
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;spare_receivers_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;completed_receivers_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* while */
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;completed_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_process_receive successful&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|udsl_fire_receivers
r_static
r_void
id|udsl_fire_receivers
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
(brace
r_struct
id|list_head
id|receivers
comma
op_star
id|pos
comma
op_star
id|n
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|receivers
)paren
suffix:semicolon
id|down
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;spare_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|list_splice_init
(paren
op_amp
id|instance-&gt;spare_receivers
comma
op_amp
id|receivers
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;spare_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_safe
(paren
id|pos
comma
id|n
comma
op_amp
id|receivers
)paren
(brace
r_struct
id|udsl_receiver
op_star
id|rcv
op_assign
id|list_entry
(paren
id|pos
comma
r_struct
id|udsl_receiver
comma
id|list
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_fire_receivers: firing urb %p&bslash;n&quot;
comma
id|rcv-&gt;urb
)paren
suffix:semicolon
id|usb_fill_bulk_urb
(paren
id|rcv-&gt;urb
comma
id|instance-&gt;usb_dev
comma
id|usb_rcvbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_IN
)paren
comma
(paren
r_int
r_char
op_star
)paren
id|rcv-&gt;skb-&gt;data
comma
id|UDSL_RCV_BUFFER_SIZE
op_star
id|ATM_CELL_SIZE
comma
id|udsl_complete_receive
comma
id|rcv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
(paren
id|rcv-&gt;urb
comma
id|GFP_KERNEL
)paren
OL
l_int|0
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;udsl_fire_receivers: submit failed!&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;spare_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|list_move
(paren
id|pos
comma
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;spare_receivers_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
)brace
multiline_comment|/***********&n;**  send  **&n;***********/
DECL|function|udsl_complete_send
r_static
r_void
id|udsl_complete_send
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
r_struct
id|udsl_sender
op_star
id|snd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_complete_send entered&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
op_logical_or
op_logical_neg
(paren
id|snd
op_assign
id|urb-&gt;context
)paren
op_logical_or
op_logical_neg
(paren
id|instance
op_assign
id|snd-&gt;instance
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;udsl_complete_send: bad urb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* may not be in_interrupt() */
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|snd-&gt;list
comma
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|snd-&gt;buffer-&gt;list
comma
op_amp
id|instance-&gt;spare_buffers
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_complete_send: scheduling tasklet&bslash;n&quot;
)paren
suffix:semicolon
id|tasklet_schedule
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
)brace
DECL|function|udsl_process_send
r_static
r_void
id|udsl_process_send
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
(paren
r_struct
id|udsl_instance_data
op_star
)paren
id|data
suffix:semicolon
r_struct
id|udsl_sender
op_star
id|snd
suffix:semicolon
r_struct
id|udsl_send_buffer
op_star
id|buf
suffix:semicolon
r_int
r_int
id|cells_to_write
comma
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|target
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_process_send entered&bslash;n&quot;
)paren
suffix:semicolon
id|made_progress
suffix:colon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|instance-&gt;spare_senders
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|instance-&gt;filled_buffers
)paren
)paren
(brace
id|buf
op_assign
id|list_entry
(paren
id|instance-&gt;filled_buffers.next
comma
r_struct
id|udsl_send_buffer
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|buf-&gt;list
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;sending filled buffer&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|buf
op_assign
id|instance-&gt;current_buffer
)paren
)paren
(brace
id|instance-&gt;current_buffer
op_assign
l_int|NULL
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;sending current buffer&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* all buffers empty */
r_break
suffix:semicolon
id|snd
op_assign
id|list_entry
(paren
id|instance-&gt;spare_senders.next
comma
r_struct
id|udsl_sender
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|snd-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|snd-&gt;buffer
op_assign
id|buf
suffix:semicolon
id|usb_fill_bulk_urb
(paren
id|snd-&gt;urb
comma
id|instance-&gt;usb_dev
comma
id|usb_sndbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_OUT
)paren
comma
id|buf-&gt;base
comma
(paren
id|UDSL_SND_BUFFER_SIZE
op_minus
id|buf-&gt;free_cells
)paren
op_star
id|ATM_CELL_SIZE
comma
id|udsl_complete_send
comma
id|snd
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;submitting urb, contains %d cells&bslash;n&quot;
comma
id|UDSL_SND_BUFFER_SIZE
op_minus
id|buf-&gt;free_cells
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|snd-&gt;urb
comma
id|GFP_ATOMIC
)paren
OL
l_int|0
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;submission failed!&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|snd-&gt;list
comma
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;filled_buffers
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* while */
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;current_skb
op_logical_and
op_logical_neg
(paren
id|instance-&gt;current_skb
op_assign
id|skb_dequeue
(paren
op_amp
id|instance-&gt;sndqueue
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;done - no more skbs&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb
op_assign
id|instance-&gt;current_skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_assign
id|instance-&gt;current_buffer
)paren
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
op_amp
id|instance-&gt;spare_buffers
)paren
)paren
(brace
id|instance-&gt;current_buffer
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;done - no more buffers&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|buf
op_assign
id|list_entry
(paren
id|instance-&gt;spare_buffers.next
comma
r_struct
id|udsl_send_buffer
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|buf-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|buf-&gt;free_start
op_assign
id|buf-&gt;base
suffix:semicolon
id|buf-&gt;free_cells
op_assign
id|UDSL_SND_BUFFER_SIZE
suffix:semicolon
id|instance-&gt;current_buffer
op_assign
id|buf
suffix:semicolon
)brace
id|cells_to_write
op_assign
id|min
(paren
id|buf-&gt;free_cells
comma
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|num_cells
)paren
suffix:semicolon
id|target
op_assign
id|buf-&gt;free_start
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;writing %u cells from skb 0x%p to buffer 0x%p&bslash;n&quot;
comma
id|cells_to_write
comma
id|skb
comma
id|buf
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cells_to_write
suffix:semicolon
id|i
op_increment
)paren
id|target
op_assign
id|udsl_write_cell
(paren
id|skb
comma
id|target
)paren
suffix:semicolon
id|buf-&gt;free_start
op_assign
id|target
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf-&gt;free_cells
op_sub_assign
id|cells_to_write
)paren
)paren
(brace
id|list_add_tail
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;filled_buffers
)paren
suffix:semicolon
id|instance-&gt;current_buffer
op_assign
l_int|NULL
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;queued filled buffer&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|PDEBUG
(paren
l_string|&quot;buffer contains %d cells, %d left&bslash;n&quot;
comma
id|UDSL_SND_BUFFER_SIZE
op_minus
id|buf-&gt;free_cells
comma
id|buf-&gt;free_cells
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|num_cells
)paren
(brace
r_struct
id|atm_vcc
op_star
id|vcc
op_assign
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_data.vcc
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;discarding empty skb&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc-&gt;pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|instance-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;stats
)paren
id|atomic_inc
(paren
op_amp
id|vcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
)brace
r_goto
id|made_progress
suffix:semicolon
)brace
DECL|function|udsl_cancel_send
r_static
r_void
id|udsl_cancel_send
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|n
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_cancel_send entered&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;sndqueue.lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|skb
op_assign
id|instance-&gt;sndqueue.next
comma
id|n
op_assign
id|skb-&gt;next
suffix:semicolon
id|skb
op_ne
(paren
r_struct
id|sk_buff
op_star
)paren
op_amp
id|instance-&gt;sndqueue
suffix:semicolon
id|skb
op_assign
id|n
comma
id|n
op_assign
id|skb-&gt;next
)paren
r_if
c_cond
(paren
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_data.vcc
op_eq
id|vcc
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;popping skb 0x%p&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
id|__skb_unlink
(paren
id|skb
comma
op_amp
id|instance-&gt;sndqueue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc-&gt;pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|kfree_skb
(paren
id|skb
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;sndqueue.lock
comma
id|flags
)paren
suffix:semicolon
id|tasklet_disable
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|instance-&gt;current_skb
)paren
op_logical_and
(paren
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_data.vcc
op_eq
id|vcc
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;popping current skb (0x%p)&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
id|instance-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc-&gt;pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|kfree_skb
(paren
id|skb
)paren
suffix:semicolon
)brace
id|tasklet_enable
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_cancel_send done&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|udsl_atm_send
r_static
r_int
id|udsl_atm_send
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_send called (skb 0x%p, skb-&gt;len %u)&bslash;n&quot;
comma
id|skb
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;NULL instance!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;firmware_loaded
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;unsupported ATM type %d!&bslash;n&quot;
comma
id|vcc-&gt;qos.aal
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|ATM_MAX_AAL5_PDU
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;packet too long (%d vs %d)!&bslash;n&quot;
comma
id|skb-&gt;len
comma
id|ATM_MAX_AAL5_PDU
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|PACKETDEBUG
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|udsl_groom_skb
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|skb_queue_tail
(paren
op_amp
id|instance-&gt;sndqueue
comma
id|skb
)paren
suffix:semicolon
id|tasklet_schedule
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************&n;**   ATM   **&n;************/
multiline_comment|/***************************************************************************&n;*&n;* init functions&n;*&n;****************************************************************************/
DECL|function|udsl_atm_stopdevice
r_static
r_void
id|udsl_atm_stopdevice
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
(brace
r_struct
id|atm_vcc
op_star
id|walk
suffix:semicolon
r_struct
id|atm_dev
op_star
id|atm_dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;atm_dev
)paren
r_return
suffix:semicolon
id|atm_dev
op_assign
id|instance-&gt;atm_dev
suffix:semicolon
id|atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
id|walk
op_assign
id|atm_dev-&gt;vccs
suffix:semicolon
id|shutdown_atm_dev
(paren
id|atm_dev
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|walk
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|wake_up
(paren
op_amp
id|walk-&gt;sleep
)paren
suffix:semicolon
id|instance-&gt;atm_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n;*&n;* ATM helper functions&n;*&n;****************************************************************************/
DECL|function|udsl_atm_proc_read
r_static
r_int
id|udsl_atm_proc_read
(paren
r_struct
id|atm_dev
op_star
id|atm_dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|atm_dev-&gt;dev_data
suffix:semicolon
r_int
id|left
op_assign
op_star
id|pos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;NULL instance!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
(paren
id|page
comma
l_string|&quot;SpeedTouch USB %s-%s (%02x:%02x:%02x:%02x:%02x:%02x)&bslash;n&quot;
comma
id|instance-&gt;usb_dev-&gt;bus-&gt;bus_name
comma
id|instance-&gt;usb_dev-&gt;devpath
comma
id|atm_dev-&gt;esi
(braket
l_int|0
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|1
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|2
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|3
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|4
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
(paren
id|page
comma
l_string|&quot;AAL5: tx %d ( %d err ), rx %d ( %d err, %d drop )&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.tx
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.tx_err
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx_err
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx_drop
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n;*&n;* SAR driver entries&n;*&n;****************************************************************************/
DECL|function|udsl_atm_open
r_static
r_int
id|udsl_atm_open
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
(brace
r_struct
id|udsl_atm_dev_data
op_star
id|dev_data
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_open called&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;NULL instance!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* at the moment only AAL5 support */
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dev_data
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|udsl_atm_dev_data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev_data-&gt;atmsar_vcc
op_assign
id|atmsar_open
(paren
op_amp
(paren
id|instance-&gt;atmsar_vcc_list
)paren
comma
id|vcc
comma
id|ATMSAR_TYPE_AAL5
comma
id|vpi
comma
id|vci
comma
l_int|0
comma
l_int|0
comma
id|ATMSAR_USE_53BYTE_CELL
op_or
id|ATMSAR_SET_PTI
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_data-&gt;atmsar_vcc
)paren
(brace
id|kfree
(paren
id|dev_data
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* this is the only reason atmsar_open can fail... */
)brace
id|vcc-&gt;vpi
op_assign
id|vpi
suffix:semicolon
id|vcc-&gt;vci
op_assign
id|vci
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|vcc-&gt;dev_data
op_assign
id|dev_data
suffix:semicolon
id|dev_data-&gt;atmsar_vcc-&gt;mtu
op_assign
id|UDSL_MAX_AAL5_MRU
suffix:semicolon
r_if
c_cond
(paren
id|instance-&gt;firmware_loaded
)paren
id|udsl_fire_receivers
(paren
id|instance
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_open successfull&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udsl_atm_close
r_static
r_void
id|udsl_atm_close
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|udsl_atm_dev_data
op_star
id|dev_data
op_assign
id|vcc-&gt;dev_data
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_close called&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_data
op_logical_or
op_logical_neg
id|instance
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;NULL data!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* freeing resources */
multiline_comment|/* cancel all sends on this vcc */
id|udsl_cancel_send
(paren
id|instance
comma
id|vcc
)paren
suffix:semicolon
id|atmsar_close
(paren
op_amp
(paren
id|instance-&gt;atmsar_vcc_list
)paren
comma
id|dev_data-&gt;atmsar_vcc
)paren
suffix:semicolon
id|kfree
(paren
id|dev_data
)paren
suffix:semicolon
id|vcc-&gt;dev_data
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* freeing address */
id|vcc-&gt;vpi
op_assign
id|ATM_VPI_UNSPEC
suffix:semicolon
id|vcc-&gt;vci
op_assign
id|ATM_VCI_UNSPEC
suffix:semicolon
id|clear_bit
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_close successfull&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|udsl_atm_ioctl
r_static
r_int
id|udsl_atm_ioctl
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ATM_QUERYLOOP
suffix:colon
r_return
id|put_user
(paren
id|ATM_LM_NONE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
multiline_comment|/************&n;**   USB   **&n;************/
DECL|function|udsl_usb_ioctl
r_static
r_int
id|udsl_usb_ioctl
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_int
r_int
id|code
comma
r_void
op_star
id|user_data
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|usb_get_intfdata
(paren
id|intf
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_ioctl entered&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;NULL instance!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|UDSL_IOCTL_START
suffix:colon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_FOUND
suffix:semicolon
id|down
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
multiline_comment|/* vs self */
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;firmware_loaded
)paren
(brace
id|usb_set_interface
(paren
id|instance-&gt;usb_dev
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
id|instance-&gt;firmware_loaded
op_assign
l_int|1
suffix:semicolon
)brace
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
id|udsl_fire_receivers
(paren
id|instance
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|UDSL_IOCTL_STOP
suffix:colon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
)brace
DECL|function|udsl_usb_probe
r_static
r_int
id|udsl_usb_probe
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|interface_to_usbdev
c_func
(paren
id|intf
)paren
suffix:semicolon
r_int
id|ifnum
op_assign
id|intf-&gt;altsetting-&gt;desc.bInterfaceNumber
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
r_int
r_char
id|mac_str
(braket
l_int|13
)braket
suffix:semicolon
r_int
r_char
id|mac
(braket
l_int|6
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;Trying device with Vendor=0x%x, Product=0x%x, ifnum %d&bslash;n&quot;
comma
id|dev-&gt;descriptor.idVendor
comma
id|dev-&gt;descriptor.idProduct
comma
id|ifnum
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;descriptor.bDeviceClass
op_ne
id|USB_CLASS_VENDOR_SPEC
)paren
op_logical_or
(paren
id|dev-&gt;descriptor.idVendor
op_ne
id|SPEEDTOUCH_VENDORID
)paren
op_logical_or
(paren
id|dev-&gt;descriptor.idProduct
op_ne
id|SPEEDTOUCH_PRODUCTID
)paren
op_logical_or
(paren
id|ifnum
op_ne
l_int|1
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;Device Accepted&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* instance init */
r_if
c_cond
(paren
op_logical_neg
(paren
id|instance
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|udsl_instance_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;No memory for Instance data!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|instance
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|udsl_instance_data
)paren
)paren
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
id|instance-&gt;usb_dev
op_assign
id|dev
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|instance-&gt;spare_receivers_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|instance-&gt;completed_receivers_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;completed_receivers
)paren
suffix:semicolon
id|tasklet_init
(paren
op_amp
id|instance-&gt;receive_tasklet
comma
id|udsl_process_receive
comma
(paren
r_int
r_int
)paren
id|instance
)paren
suffix:semicolon
id|skb_queue_head_init
(paren
op_amp
id|instance-&gt;sndqueue
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_buffers
)paren
suffix:semicolon
id|tasklet_init
(paren
op_amp
id|instance-&gt;send_tasklet
comma
id|udsl_process_send
comma
(paren
r_int
r_int
)paren
id|instance
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;filled_buffers
)paren
suffix:semicolon
multiline_comment|/* receive init */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_RCV_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_receiver
op_star
id|rcv
op_assign
op_amp
(paren
id|instance-&gt;all_receivers
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rcv-&gt;skb
op_assign
id|dev_alloc_skb
(paren
id|UDSL_RCV_BUFFER_SIZE
op_star
id|ATM_CELL_SIZE
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;No memory for skb %d!&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rcv-&gt;urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;No memory for receive urb %d!&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|rcv-&gt;instance
op_assign
id|instance
suffix:semicolon
id|list_add
(paren
op_amp
id|rcv-&gt;list
comma
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;skb-&gt;truesize = %d (asked for %d)&bslash;n&quot;
comma
id|rcv-&gt;skb-&gt;truesize
comma
id|UDSL_RCV_BUFFER_SIZE
op_star
id|ATM_CELL_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* send init */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_sender
op_star
id|snd
op_assign
op_amp
(paren
id|instance-&gt;all_senders
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|snd-&gt;urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;No memory for send urb %d!&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|snd-&gt;instance
op_assign
id|instance
suffix:semicolon
id|list_add
(paren
op_amp
id|snd-&gt;list
comma
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_BUFS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_send_buffer
op_star
id|buf
op_assign
op_amp
(paren
id|instance-&gt;all_buffers
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf-&gt;base
op_assign
id|kmalloc
(paren
id|UDSL_SND_BUFFER_SIZE
op_star
id|ATM_CELL_SIZE
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;No memory for send buffer %d!&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|list_add
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;spare_buffers
)paren
suffix:semicolon
)brace
multiline_comment|/* atm init */
r_if
c_cond
(paren
op_logical_neg
(paren
id|instance-&gt;atm_dev
op_assign
id|atm_dev_register
(paren
id|udsl_driver_name
comma
op_amp
id|udsl_atm_devops
comma
op_minus
l_int|1
comma
l_int|0
)paren
)paren
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;failed to register ATM device!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|instance-&gt;atm_dev-&gt;ci_range.vpi_bits
op_assign
id|ATM_CI_MAX
suffix:semicolon
id|instance-&gt;atm_dev-&gt;ci_range.vci_bits
op_assign
id|ATM_CI_MAX
suffix:semicolon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
multiline_comment|/* tmp init atm device, set to 128kbit */
id|instance-&gt;atm_dev-&gt;link_rate
op_assign
l_int|128
op_star
l_int|1000
op_div
l_int|424
suffix:semicolon
multiline_comment|/* set MAC address, it is stored in the serial number */
id|usb_string
(paren
id|instance-&gt;usb_dev
comma
id|instance-&gt;usb_dev-&gt;descriptor.iSerialNumber
comma
id|mac_str
comma
l_int|13
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|mac
(braket
id|i
)braket
op_assign
(paren
id|hex2int
(paren
id|mac_str
(braket
id|i
op_star
l_int|2
)braket
)paren
op_star
l_int|16
)paren
op_plus
(paren
id|hex2int
(paren
id|mac_str
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;MAC is %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|mac
(braket
l_int|0
)braket
comma
id|mac
(braket
l_int|1
)braket
comma
id|mac
(braket
l_int|2
)braket
comma
id|mac
(braket
l_int|3
)braket
comma
id|mac
(braket
l_int|4
)braket
comma
id|mac
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|memcpy
(paren
id|instance-&gt;atm_dev-&gt;esi
comma
id|mac
comma
l_int|6
)paren
suffix:semicolon
id|wmb
(paren
)paren
suffix:semicolon
id|instance-&gt;atm_dev-&gt;dev_data
op_assign
id|instance
suffix:semicolon
id|usb_set_intfdata
(paren
id|intf
comma
id|instance
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_BUFS
suffix:semicolon
id|i
op_increment
)paren
id|kfree
(paren
id|instance-&gt;all_buffers
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_URBS
suffix:semicolon
id|i
op_increment
)paren
id|usb_free_urb
(paren
id|instance-&gt;all_senders
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_RCV_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_receiver
op_star
id|rcv
op_assign
op_amp
(paren
id|instance-&gt;all_receivers
(braket
id|i
)braket
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|rcv-&gt;urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcv-&gt;skb
)paren
id|kfree_skb
(paren
id|rcv-&gt;skb
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|instance
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|udsl_usb_disconnect
r_static
r_void
id|udsl_usb_disconnect
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|usb_get_intfdata
(paren
id|intf
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|pos
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|result
comma
id|i
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;disconnecting&bslash;n&quot;
)paren
suffix:semicolon
id|usb_set_intfdata
(paren
id|intf
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;NULL instance!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tasklet_disable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
multiline_comment|/* flush spare receivers */
id|down
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
multiline_comment|/* vs udsl_fire_receivers */
multiline_comment|/* no need to take the spinlock */
id|list_for_each
(paren
id|pos
comma
op_amp
id|instance-&gt;spare_receivers
)paren
r_if
c_cond
(paren
op_increment
id|count
OG
id|UDSL_NUMBER_RCV_URBS
)paren
id|panic
(paren
id|__FILE__
l_string|&quot;: memory corruption detected at line %d!&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: flushed %u spare receivers&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|count
op_assign
id|UDSL_NUMBER_RCV_URBS
op_minus
id|count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_RCV_URBS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|result
op_assign
id|usb_unlink_urb
(paren
id|instance-&gt;all_receivers
(braket
id|i
)braket
dot
id|urb
)paren
)paren
OL
l_int|0
)paren
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: usb_unlink_urb on receive urb %d returned %d&bslash;n&quot;
comma
id|i
comma
id|result
)paren
suffix:semicolon
multiline_comment|/* wait for completion handlers to finish */
r_do
(brace
r_int
r_int
id|completed
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;completed_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
(paren
id|pos
comma
op_amp
id|instance-&gt;completed_receivers
)paren
r_if
c_cond
(paren
op_increment
id|completed
OG
id|count
)paren
id|panic
(paren
id|__FILE__
l_string|&quot;: memory corruption detected at line %d!&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;completed_receivers_lock
comma
id|flags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: found %u completed receivers&bslash;n&quot;
comma
id|completed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|completed
op_eq
id|count
)paren
r_break
suffix:semicolon
id|yield
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: flushing&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* no need to take the spinlock */
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;completed_receivers
)paren
suffix:semicolon
id|tasklet_enable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|tasklet_kill
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: freeing receivers&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_RCV_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_receiver
op_star
id|rcv
op_assign
op_amp
(paren
id|instance-&gt;all_receivers
(braket
id|i
)braket
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|rcv-&gt;urb
)paren
suffix:semicolon
id|kfree_skb
(paren
id|rcv-&gt;skb
)paren
suffix:semicolon
)brace
id|udsl_atm_stopdevice
(paren
id|instance
)paren
suffix:semicolon
id|tasklet_disable
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_URBS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|result
op_assign
id|usb_unlink_urb
(paren
id|instance-&gt;all_senders
(braket
id|i
)braket
dot
id|urb
)paren
)paren
OL
l_int|0
)paren
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: usb_unlink_urb on send urb %d returned %d&bslash;n&quot;
comma
id|i
comma
id|result
)paren
suffix:semicolon
multiline_comment|/* wait for completion handlers to finish */
r_do
(brace
id|count
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
(paren
id|pos
comma
op_amp
id|instance-&gt;spare_senders
)paren
r_if
c_cond
(paren
op_increment
id|count
OG
id|UDSL_NUMBER_SND_URBS
)paren
id|panic
(paren
id|__FILE__
l_string|&quot;: memory corruption detected at line %d!&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: found %u spare senders&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
id|UDSL_NUMBER_SND_URBS
)paren
r_break
suffix:semicolon
id|yield
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: flushing&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* no need to take the spinlock */
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_buffers
)paren
suffix:semicolon
id|instance-&gt;current_buffer
op_assign
l_int|NULL
suffix:semicolon
id|tasklet_enable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|tasklet_kill
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: freeing senders&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_URBS
suffix:semicolon
id|i
op_increment
)paren
id|usb_free_urb
(paren
id|instance-&gt;all_senders
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: freeing buffers&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_BUFS
suffix:semicolon
id|i
op_increment
)paren
id|kfree
(paren
id|instance-&gt;all_buffers
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_disconnect: freeing instance&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|instance
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n;*&n;* Driver Init&n;*&n;****************************************************************************/
DECL|function|udsl_usb_init
r_static
r_int
id|__init
id|udsl_usb_init
(paren
r_void
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* dummy for sizeof */
id|PDEBUG
(paren
l_string|&quot;udsl_usb_init: driver version &quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|udsl_control
)paren
OG
r_sizeof
(paren
id|skb-&gt;cb
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|__FILE__
l_string|&quot;: unusable with this kernel!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|usb_register
(paren
op_amp
id|udsl_usb_driver
)paren
suffix:semicolon
)brace
DECL|function|udsl_usb_cleanup
r_static
r_void
id|__exit
id|udsl_usb_cleanup
(paren
r_void
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;udsl_usb_cleanup&bslash;n&quot;
)paren
suffix:semicolon
id|usb_deregister
(paren
op_amp
id|udsl_usb_driver
)paren
suffix:semicolon
)brace
DECL|variable|udsl_usb_init
id|module_init
(paren
id|udsl_usb_init
)paren
suffix:semicolon
DECL|variable|udsl_usb_cleanup
id|module_exit
(paren
id|udsl_usb_cleanup
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_PACKET
multiline_comment|/*******************************************************************************&n;*&n;* Debug&n;*&n;*******************************************************************************/
DECL|function|udsl_print_packet
r_static
r_int
id|udsl_print_packet
(paren
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
r_char
id|buffer
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
)paren
(brace
id|buffer
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%.3d :&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
l_int|16
)paren
op_logical_and
(paren
id|i
OL
id|len
)paren
suffix:semicolon
id|j
op_increment
comma
id|i
op_increment
)paren
(brace
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%s %2.2x&quot;
comma
id|buffer
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|PDEBUG
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* PACKETDEBUG */
eof
