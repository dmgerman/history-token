multiline_comment|/*&n; *  Driver Module for Alcatel SpeedTouch USB xDSL modem&n; *  Copyright 2001, Alcatel&n; *  Written by Johan Verrept (Johan.Verrept@advalvas.be)&n; *&n;&n;1.5A:   - Version for inclusion in 2.5 series kernel&n;        - Modifcations by Richard Purdie (rpurdie@rpsys.net)&n;        - made compatible with kernel 2.5.6 onwards by changing&n;&t;  udsl_usb_send_data_context-&gt;urb changed to a pointer &n;&t;  and adding code to alloc and free it&n;        - remove_wait_queue() added to udsl_atm_processqueue_thread() &n;&n;1.5:&t;- fixed memory leak when atmsar_decode_aal5 returned NULL.&n;&t; (reported by stephen.robinson@zen.co.uk)&n;&n;1.4:&t;- changed the spin_lock() under interrupt to spin_lock_irqsave()&n;&t;- unlink all active send urbs of a vcc that is being closed.&n;&n;1.3.1:&t;- added the version number&n;&n;1.3:&t;- Added multiple send urb support&n;&t;- fixed memory leak and vcc-&gt;tx_inuse starvation bug&n;&t;  when not enough memory left in vcc.&n;&n;1.2:&t;- Fixed race condition in udsl_usb_send_data()&n;1.1:&t;- Turned off packet debugging&n; &n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/atm.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &quot;atmsar.h&quot;
DECL|variable|udsl_version
r_const
r_char
op_star
id|udsl_version
op_assign
l_string|&quot;1.5A&quot;
suffix:semicolon
multiline_comment|/*&n;#define DEBUG 1&n;#define DEBUG_PACKET 1&n;*/
macro_line|#ifdef DEBUG
DECL|macro|PDEBUG
mdefine_line|#define PDEBUG(arg...)  printk(KERN_DEBUG &quot;SpeedTouch USB: &quot; arg)
macro_line|#else
DECL|macro|PDEBUG
mdefine_line|#define PDEBUG(arg...)
macro_line|#endif
macro_line|#ifdef DEBUG_PACKET
DECL|macro|PACKETDEBUG
mdefine_line|#define PACKETDEBUG(arg...) udsl_print_packet ( arg )
macro_line|#else
DECL|macro|PACKETDEBUG
mdefine_line|#define PACKETDEBUG(arg...)
macro_line|#endif
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Johan Verrept, Johan.Verrept@advalvas.be&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;Driver for the Alcatel Speed Touch USB ADSL modem&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;1.5A&quot;
DECL|macro|SPEEDTOUCH_VENDORID
mdefine_line|#define SPEEDTOUCH_VENDORID&t;&t;0x06b9
DECL|macro|SPEEDTOUCH_PRODUCTID
mdefine_line|#define SPEEDTOUCH_PRODUCTID&t;&t;0x4061
DECL|macro|MAX_UDSL
mdefine_line|#define MAX_UDSL&t;&t;&t;1
DECL|macro|UDSL_OBUF_SIZE
mdefine_line|#define UDSL_OBUF_SIZE&t;&t;&t;32768
DECL|macro|UDSL_MINOR
mdefine_line|#define UDSL_MINOR&t;&t;&t;48
DECL|macro|UDSL_NUMBER_RCV_URBS
mdefine_line|#define UDSL_NUMBER_RCV_URBS&t;&t;1
DECL|macro|UDSL_NUMBER_SND_URBS
mdefine_line|#define UDSL_NUMBER_SND_URBS&t;&t;1
DECL|macro|UDSL_RECEIVE_BUFFER_SIZE
mdefine_line|#define UDSL_RECEIVE_BUFFER_SIZE&t;64*53
multiline_comment|/* max should be (1500 IP mtu + 2 ppp bytes + 32 * 5 cellheader overhead) for&n; * PPPoA and (1500 + 14 + 32*5 cellheader overhead) for PPPoE */
DECL|macro|UDSL_MAX_AAL5_MRU
mdefine_line|#define UDSL_MAX_AAL5_MRU&t;&t;2048
DECL|macro|UDSL_SEND_CONTEXTS
mdefine_line|#define UDSL_SEND_CONTEXTS&t;&t;8
DECL|macro|UDSL_IOCTL_START
mdefine_line|#define UDSL_IOCTL_START&t;&t;1
DECL|macro|UDSL_IOCTL_STOP
mdefine_line|#define UDSL_IOCTL_STOP&t;&t;&t;2
multiline_comment|/* endpoint declarations */
DECL|macro|UDSL_ENDPOINT_DATA_OUT
mdefine_line|#define UDSL_ENDPOINT_DATA_OUT&t;&t;0x07
DECL|macro|UDSL_ENDPOINT_DATA_IN
mdefine_line|#define UDSL_ENDPOINT_DATA_IN&t;&t;0x87
multiline_comment|/* usb_device_id struct */
DECL|variable|udsl_usb_ids
r_static
r_struct
id|usb_device_id
id|udsl_usb_ids
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
(paren
id|SPEEDTOUCH_VENDORID
comma
id|SPEEDTOUCH_PRODUCTID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* list terminator */
)brace
suffix:semicolon
multiline_comment|/* not exporting this prevents the depmod from generating the map that causes the modules to be isnserted as driver.&n; * we do not want this, we want the script run.&n;MODULE_DEVICE_TABLE ( usb, udsl_usb_ids);&n;*/
multiline_comment|/* context declarations */
DECL|struct|udsl_data_ctx
r_struct
id|udsl_data_ctx
(brace
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
DECL|member|instance
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udsl_usb_send_data_context
r_struct
id|udsl_usb_send_data_context
(brace
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|member|vcc
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
DECL|member|instance
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * UDSL main driver data&n; */
DECL|struct|udsl_instance_data
r_struct
id|udsl_instance_data
(brace
DECL|member|minor
r_int
id|minor
suffix:semicolon
multiline_comment|/* usb device part */
DECL|member|usb_dev
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
DECL|member|rcvbufs
r_struct
id|udsl_data_ctx
op_star
id|rcvbufs
suffix:semicolon
DECL|member|sndqueue
r_struct
id|sk_buff_head
id|sndqueue
suffix:semicolon
DECL|member|sndqlock
id|spinlock_t
id|sndqlock
suffix:semicolon
DECL|member|send_ctx
r_struct
id|udsl_usb_send_data_context
id|send_ctx
(braket
id|UDSL_NUMBER_SND_URBS
)braket
suffix:semicolon
DECL|member|data_started
r_int
id|data_started
suffix:semicolon
multiline_comment|/* atm device part */
DECL|member|atm_dev
r_struct
id|atm_dev
op_star
id|atm_dev
suffix:semicolon
DECL|member|recvqueue
r_struct
id|sk_buff_head
id|recvqueue
suffix:semicolon
DECL|member|recvqlock
id|spinlock_t
id|recvqlock
suffix:semicolon
DECL|member|atmsar_vcc_list
r_struct
id|atmsar_vcc_data
op_star
id|atmsar_vcc_list
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|minor_data
r_struct
id|udsl_instance_data
op_star
id|minor_data
(braket
id|MAX_UDSL
)braket
suffix:semicolon
DECL|variable|udsl_driver_name
r_static
r_const
r_char
id|udsl_driver_name
(braket
)braket
op_assign
l_string|&quot;Alcatel SpeedTouch USB&quot;
suffix:semicolon
multiline_comment|/* data thread */
DECL|variable|udsl_wqh
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|udsl_wqh
)paren
suffix:semicolon
r_static
id|DECLARE_COMPLETION
c_func
(paren
id|thread_grave
)paren
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|udsl_usb_ioctl_lock
)paren
suffix:semicolon
DECL|variable|datapid
r_static
r_int
r_int
id|datapid
suffix:semicolon
macro_line|#ifdef DEBUG_PACKET
r_int
id|udsl_print_packet
(paren
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * atm driver prototypes and stuctures&n; */
r_static
r_int
id|udsl_atm_open
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
suffix:semicolon
r_static
r_void
id|udsl_atm_close
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_ioctl
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_send
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_int
id|udsl_atm_proc_read
(paren
r_struct
id|atm_dev
op_star
id|atm_dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
suffix:semicolon
r_void
id|udsl_atm_processqueue
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
suffix:semicolon
DECL|variable|udsl_atm_devops
r_static
r_struct
id|atmdev_ops
id|udsl_atm_devops
op_assign
(brace
dot
id|open
op_assign
id|udsl_atm_open
comma
dot
id|close
op_assign
id|udsl_atm_close
comma
dot
id|ioctl
op_assign
id|udsl_atm_ioctl
comma
dot
id|send
op_assign
id|udsl_atm_send
comma
dot
id|proc_read
op_assign
id|udsl_atm_proc_read
comma
)brace
suffix:semicolon
DECL|struct|udsl_atm_dev_data
r_struct
id|udsl_atm_dev_data
(brace
DECL|member|atmsar_vcc
r_struct
id|atmsar_vcc_data
op_star
id|atmsar_vcc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * usb driver prototypes and structures&n; */
r_static
r_int
id|udsl_usb_probe
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_void
id|udsl_usb_disconnect
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
suffix:semicolon
r_int
id|udsl_usb_send_data
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|udsl_usb_ioctl
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_int
r_int
id|code
comma
r_void
op_star
id|user_data
)paren
suffix:semicolon
r_static
r_int
id|udsl_usb_cancelsends
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_struct
id|atm_vcc
op_star
id|vcc
)paren
suffix:semicolon
DECL|variable|udsl_usb_driver
r_static
r_struct
id|usb_driver
id|udsl_usb_driver
op_assign
(brace
dot
id|name
op_assign
id|udsl_driver_name
comma
dot
id|probe
op_assign
id|udsl_usb_probe
comma
dot
id|disconnect
op_assign
id|udsl_usb_disconnect
comma
dot
id|ioctl
op_assign
id|udsl_usb_ioctl
comma
dot
id|id_table
op_assign
id|udsl_usb_ids
comma
)brace
suffix:semicolon
multiline_comment|/************&n;**   ATM   **&n;************/
multiline_comment|/***************************************************************************&n;*&n;* init functions&n;*&n;****************************************************************************/
DECL|function|udsl_atm_startdevice
r_struct
id|atm_dev
op_star
id|udsl_atm_startdevice
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_struct
id|atmdev_ops
op_star
id|devops
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|instance-&gt;atm_dev
op_assign
id|atm_dev_register
(paren
id|udsl_driver_name
comma
id|devops
comma
op_minus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|instance-&gt;atm_dev-&gt;dev_data
op_assign
id|instance
suffix:semicolon
id|instance-&gt;atm_dev-&gt;ci_range.vpi_bits
op_assign
id|ATM_CI_MAX
suffix:semicolon
id|instance-&gt;atm_dev-&gt;ci_range.vci_bits
op_assign
id|ATM_CI_MAX
suffix:semicolon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
id|skb_queue_head_init
(paren
op_amp
id|instance-&gt;recvqueue
)paren
suffix:semicolon
multiline_comment|/* tmp init atm device, set to 128kbit */
id|instance-&gt;atm_dev-&gt;link_rate
op_assign
l_int|128
op_star
l_int|1000
op_div
l_int|424
suffix:semicolon
r_return
id|instance-&gt;atm_dev
suffix:semicolon
)brace
DECL|function|udsl_atm_stopdevice
r_void
id|udsl_atm_stopdevice
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
(brace
r_struct
id|atm_vcc
op_star
id|walk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|atm_dev
op_star
id|atm_dev
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;atm_dev
)paren
r_return
suffix:semicolon
id|atm_dev
op_assign
id|instance-&gt;atm_dev
suffix:semicolon
multiline_comment|/* clean queue */
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;recvqlock
comma
id|iflags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|skb_queue_empty
(paren
op_amp
id|instance-&gt;recvqueue
)paren
)paren
(brace
id|skb
op_assign
id|skb_dequeue
(paren
op_amp
id|instance-&gt;recvqueue
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
)brace
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;recvqlock
comma
id|iflags
)paren
suffix:semicolon
id|atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
id|walk
op_assign
id|atm_dev-&gt;vccs
suffix:semicolon
id|shutdown_atm_dev
(paren
id|atm_dev
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|walk
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|wake_up
(paren
op_amp
id|walk-&gt;sleep
)paren
suffix:semicolon
id|instance-&gt;atm_dev
op_assign
l_int|NULL
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|udsl_atm_set_mac
r_void
id|udsl_atm_set_mac
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_const
r_char
id|mac
(braket
l_int|6
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;atm_dev
)paren
r_return
suffix:semicolon
id|memcpy
(paren
id|instance-&gt;atm_dev-&gt;esi
comma
id|mac
comma
l_int|6
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n;*&n;* ATM helper functions&n;*&n;****************************************************************************/
DECL|function|udsl_atm_alloc_tx
r_struct
id|sk_buff
op_star
id|udsl_atm_alloc_tx
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|atmsar_vcc_data
op_star
id|atmsar_vcc
op_assign
(paren
(paren
r_struct
id|udsl_atm_dev_data
op_star
)paren
id|vcc-&gt;dev_data
)paren
op_member_access_from_pointer
id|atmsar_vcc
suffix:semicolon
r_if
c_cond
(paren
id|atmsar_vcc
)paren
r_return
id|atmsar_alloc_tx
(paren
id|atmsar_vcc
comma
id|size
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;SpeedTouch USB: udsl_atm_alloc_tx could not find correct alloc_tx function !&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|udsl_atm_proc_read
r_int
id|udsl_atm_proc_read
(paren
r_struct
id|atm_dev
op_star
id|atm_dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
(paren
r_struct
id|udsl_instance_data
op_star
)paren
id|atm_dev-&gt;dev_data
suffix:semicolon
r_int
id|left
op_assign
op_star
id|pos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
(paren
id|page
comma
l_string|&quot;Speed Touch USB:%d (%02x:%02x:%02x:%02x:%02x:%02x)&bslash;n&quot;
comma
id|instance-&gt;minor
comma
id|atm_dev-&gt;esi
(braket
l_int|0
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|1
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|2
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|3
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|4
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
(paren
id|page
comma
l_string|&quot;AAL0: tx %d ( %d err ), rx %d ( %d err, %d drop )&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal0.tx
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal0.tx_err
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal0.rx
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal0.rx_err
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal0.rx_drop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
(paren
id|page
comma
l_string|&quot;AAL5: tx %d ( %d err ), rx %d ( %d err, %d drop )&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.tx
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.tx_err
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx_err
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx_drop
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n;*&n;* ATM DATA functions&n;*&n;****************************************************************************/
DECL|function|udsl_atm_send
r_int
id|udsl_atm_send
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|udsl_atm_dev_data
op_star
id|dev_data
op_assign
(paren
r_struct
id|udsl_atm_dev_data
op_star
)paren
id|vcc-&gt;dev_data
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
(paren
r_struct
id|udsl_instance_data
op_star
)paren
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
r_struct
id|sk_buff
op_star
r_new
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_send called&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_data
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|vcc-&gt;qos.aal
)paren
(brace
r_case
id|ATM_AAL5
suffix:colon
r_new
op_assign
id|atmsar_encode_aal5
(paren
id|dev_data-&gt;atmsar_vcc
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
r_goto
id|nomem
suffix:semicolon
r_if
c_cond
(paren
r_new
op_ne
id|skb
)paren
(brace
id|vcc-&gt;pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|skb
op_assign
r_new
suffix:semicolon
)brace
r_new
op_assign
id|atmsar_encode_rawcell
(paren
id|dev_data-&gt;atmsar_vcc
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
r_goto
id|nomem
suffix:semicolon
r_if
c_cond
(paren
r_new
op_ne
id|skb
)paren
(brace
id|vcc-&gt;pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|skb
op_assign
r_new
suffix:semicolon
)brace
id|err
op_assign
id|udsl_usb_send_data
(paren
id|instance
comma
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_send successfull (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_send unsuccessfull&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|nomem
suffix:colon
id|vcc-&gt;pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
suffix:semicolon
DECL|function|udsl_atm_processqueue
r_void
id|udsl_atm_processqueue
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
(brace
r_struct
id|atmsar_vcc_data
op_star
id|atmsar_vcc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
r_new
op_assign
l_int|NULL
comma
op_star
id|skb
op_assign
l_int|NULL
comma
op_star
id|tmp
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
multiline_comment|/* quick check */
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;recvqlock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_empty
(paren
op_amp
id|instance-&gt;recvqueue
)paren
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;recvqlock
comma
id|iflags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|PDEBUG
(paren
l_string|&quot;udsl_atm_processqueue entered&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|skb_queue_empty
(paren
op_amp
id|instance-&gt;recvqueue
)paren
)paren
(brace
id|skb
op_assign
id|skb_dequeue
(paren
op_amp
id|instance-&gt;recvqueue
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;recvqlock
comma
id|iflags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;skb = %p, skb-&gt;len = %d&bslash;n&quot;
comma
id|skb
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|PACKETDEBUG
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
r_new
op_assign
id|atmsar_decode_rawcell
(paren
id|instance-&gt;atmsar_vcc_list
comma
id|skb
comma
op_amp
id|atmsar_vcc
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;(after cell processing)skb-&gt;len = %d&bslash;n&quot;
comma
r_new
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|atmsar_vcc-&gt;type
)paren
(brace
r_case
id|ATMSAR_TYPE_AAL5
suffix:colon
id|tmp
op_assign
r_new
suffix:semicolon
r_new
op_assign
id|atmsar_decode_aal5
(paren
id|atmsar_vcc
comma
r_new
)paren
suffix:semicolon
multiline_comment|/* we can&squot;t send NULL skbs upstream, the ATM layer would try to close the vcc... */
r_if
c_cond
(paren
r_new
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;(after aal5 decap) skb-&gt;len = %d&bslash;n&quot;
comma
r_new
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
op_member_access_from_pointer
id|len
op_logical_and
id|atm_charge
(paren
id|atmsar_vcc-&gt;vcc
comma
r_new
op_member_access_from_pointer
id|truesize
)paren
)paren
(brace
id|PACKETDEBUG
(paren
r_new
op_member_access_from_pointer
id|data
comma
r_new
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
id|atmsar_vcc-&gt;vcc-&gt;push
(paren
id|atmsar_vcc-&gt;vcc
comma
r_new
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
(paren
l_string|&quot;dropping incoming packet : rx_inuse = %d, vcc-&gt;sk-&gt;rcvbuf = %d, skb-&gt;true_size = %d&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|atmsar_vcc-&gt;vcc-&gt;rx_inuse
)paren
comma
id|atmsar_vcc-&gt;vcc-&gt;sk-&gt;rcvbuf
comma
r_new
op_member_access_from_pointer
id|truesize
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
r_new
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|PDEBUG
(paren
l_string|&quot;atmsar_decode_aal5 returned NULL!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* not supported. we delete the skb. */
id|printk
(paren
id|KERN_INFO
l_string|&quot;SpeedTouch USB: illegal vcc type. Dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
r_new
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;recvqlock
comma
id|iflags
)paren
suffix:semicolon
)brace
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;recvqlock
comma
id|iflags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_processqueue successfull&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|udsl_atm_processqueue_thread
r_int
id|udsl_atm_processqueue_thread
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|lock_kernel
(paren
)paren
suffix:semicolon
id|daemonize
(paren
)paren
suffix:semicolon
multiline_comment|/* Setup a nice name */
id|strcpy
(paren
id|current-&gt;comm
comma
l_string|&quot;kSpeedSARd&quot;
)paren
suffix:semicolon
id|add_wait_queue
(paren
op_amp
id|udsl_wqh
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;SpeedSARd awoke&bslash;n&quot;
)paren
suffix:semicolon
id|retry
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_UDSL
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|minor_data
(braket
id|i
)braket
)paren
id|udsl_atm_processqueue
(paren
id|minor_data
(braket
id|i
)braket
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
multiline_comment|/* we must check for data recieved and restart processing if there&squot;s any */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_UDSL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|minor_data
(braket
id|i
)braket
op_member_access_from_pointer
id|recvqlock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|minor_data
(braket
id|i
)braket
op_member_access_from_pointer
id|recvqueue
)paren
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|minor_data
(braket
id|i
)braket
op_member_access_from_pointer
id|recvqlock
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|minor_data
(braket
id|i
)braket
op_member_access_from_pointer
id|recvqlock
)paren
suffix:semicolon
)brace
)brace
)brace
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
(paren
op_amp
id|udsl_wqh
comma
op_amp
id|wait
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;SpeedSARd is exiting&bslash;n&quot;
)paren
suffix:semicolon
id|complete_and_exit
c_func
(paren
op_amp
id|thread_grave
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
singleline_comment|//never reached
)brace
DECL|function|udsl_atm_sar_start
r_void
id|udsl_atm_sar_start
(paren
r_void
)paren
(brace
id|datapid
op_assign
id|kernel_thread
(paren
id|udsl_atm_processqueue_thread
comma
(paren
r_void
op_star
)paren
l_int|NULL
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
)brace
DECL|function|udsl_atm_sar_stop
r_void
id|udsl_atm_sar_stop
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* Kill the thread */
id|ret
op_assign
id|kill_proc
(paren
id|datapid
comma
id|SIGTERM
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|wait_for_completion
c_func
(paren
op_amp
id|thread_grave
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************&n;*&n;* SAR driver entries&n;*&n;****************************************************************************/
DECL|function|udsl_atm_open
r_int
id|udsl_atm_open
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
(brace
r_struct
id|udsl_atm_dev_data
op_star
id|dev_data
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
(paren
r_struct
id|udsl_instance_data
op_star
)paren
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_open called&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* at the moment only AAL5 support */
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dev_data
op_assign
(paren
r_struct
id|udsl_atm_dev_data
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|udsl_atm_dev_data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev_data-&gt;atmsar_vcc
op_assign
id|atmsar_open
(paren
op_amp
(paren
id|instance-&gt;atmsar_vcc_list
)paren
comma
id|vcc
comma
id|ATMSAR_TYPE_AAL5
comma
id|vpi
comma
id|vci
comma
l_int|0
comma
l_int|0
comma
id|ATMSAR_USE_53BYTE_CELL
op_or
id|ATMSAR_SET_PTI
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_data-&gt;atmsar_vcc
)paren
(brace
id|kfree
(paren
id|dev_data
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* this is the only reason atmsar_open can fail... */
)brace
id|vcc-&gt;vpi
op_assign
id|vpi
suffix:semicolon
id|vcc-&gt;vci
op_assign
id|vci
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|vcc-&gt;dev_data
op_assign
id|dev_data
suffix:semicolon
id|vcc-&gt;alloc_tx
op_assign
id|udsl_atm_alloc_tx
suffix:semicolon
id|dev_data-&gt;atmsar_vcc-&gt;mtu
op_assign
id|UDSL_MAX_AAL5_MRU
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_open successfull&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udsl_atm_close
r_void
id|udsl_atm_close
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|udsl_atm_dev_data
op_star
id|dev_data
op_assign
(paren
r_struct
id|udsl_atm_dev_data
op_star
)paren
id|vcc-&gt;dev_data
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
(paren
r_struct
id|udsl_instance_data
op_star
)paren
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_close called&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* freeing resources */
multiline_comment|/* cancel all sends on this vcc */
id|udsl_usb_cancelsends
(paren
id|instance
comma
id|vcc
)paren
suffix:semicolon
id|atmsar_close
(paren
op_amp
(paren
id|instance-&gt;atmsar_vcc_list
)paren
comma
id|dev_data-&gt;atmsar_vcc
)paren
suffix:semicolon
id|kfree
(paren
id|dev_data
)paren
suffix:semicolon
id|vcc-&gt;dev_data
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* freeing address */
id|vcc-&gt;vpi
op_assign
id|ATM_VPI_UNSPEC
suffix:semicolon
id|vcc-&gt;vci
op_assign
id|ATM_VCI_UNSPEC
suffix:semicolon
id|clear_bit
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_atm_close successfull&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
DECL|function|udsl_atm_ioctl
r_int
id|udsl_atm_ioctl
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ATM_QUERYLOOP
suffix:colon
r_return
id|put_user
(paren
id|ATM_LM_NONE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
suffix:semicolon
multiline_comment|/************&n;**   USB   **&n;************/
multiline_comment|/***************************************************************************&n;*&n;* usb data functions&n;*&n;****************************************************************************/
DECL|struct|udsl_cb
r_struct
id|udsl_cb
(brace
DECL|member|vcc
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
)brace
suffix:semicolon
DECL|function|udsl_usb_send_data_complete
r_static
r_void
id|udsl_usb_send_data_complete
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|udsl_usb_send_data_context
op_star
id|ctx
op_assign
(paren
r_struct
id|udsl_usb_send_data_context
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|ctx-&gt;instance
suffix:semicolon
r_int
id|err
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_send_data_completion (vcc = %p, skb = %p, status %d)&bslash;n&quot;
comma
id|ctx-&gt;vcc
comma
id|ctx-&gt;skb
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|ctx-&gt;vcc-&gt;pop
(paren
id|ctx-&gt;vcc
comma
id|ctx-&gt;skb
)paren
suffix:semicolon
id|ctx-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
(paren
op_amp
id|instance-&gt;sndqlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_empty
(paren
op_amp
id|instance-&gt;sndqueue
)paren
)paren
(brace
id|spin_unlock
(paren
op_amp
id|instance-&gt;sndqlock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* submit next skb */
id|ctx-&gt;skb
op_assign
id|skb_dequeue
(paren
op_amp
(paren
id|instance-&gt;sndqueue
)paren
)paren
suffix:semicolon
id|ctx-&gt;vcc
op_assign
(paren
(paren
r_struct
id|udsl_cb
op_star
)paren
(paren
id|ctx-&gt;skb-&gt;cb
)paren
)paren
op_member_access_from_pointer
id|vcc
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|instance-&gt;sndqlock
)paren
suffix:semicolon
id|usb_fill_bulk_urb
(paren
id|urb
comma
id|instance-&gt;usb_dev
comma
id|usb_sndbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_OUT
)paren
comma
(paren
r_int
r_char
op_star
)paren
id|ctx-&gt;skb-&gt;data
comma
id|ctx-&gt;skb-&gt;len
comma
id|udsl_usb_send_data_complete
comma
id|ctx
)paren
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_send_data_completion (send packet %p with length %d), retval = %d&bslash;n&quot;
comma
id|ctx-&gt;skb
comma
id|ctx-&gt;skb-&gt;len
comma
id|err
)paren
suffix:semicolon
)brace
DECL|function|udsl_usb_cancelsends
r_int
id|udsl_usb_cancelsends
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|skb
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|vcc
op_eq
id|vcc
)paren
(brace
id|usb_unlink_urb
(paren
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|vcc-&gt;pop
(paren
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|vcc
comma
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|skb
)paren
suffix:semicolon
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**** send ******/
DECL|function|udsl_usb_send_data
r_int
id|udsl_usb_send_data
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|err
comma
id|i
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_send_data entered, sending packet %p with length %d&bslash;n&quot;
comma
id|skb
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;data_started
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|PACKETDEBUG
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;sndqlock
comma
id|flags
)paren
suffix:semicolon
(paren
(paren
r_struct
id|udsl_cb
op_star
)paren
id|skb-&gt;cb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
multiline_comment|/* we are already queueing */
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
(paren
op_amp
id|instance-&gt;sndqueue
)paren
)paren
(brace
id|skb_queue_tail
(paren
op_amp
id|instance-&gt;sndqueue
comma
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;sndqlock
comma
id|flags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_send_data: already queing, skb (0x%p) queued&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_URBS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* we must start queueing */
r_if
c_cond
(paren
id|i
op_eq
id|UDSL_NUMBER_SND_URBS
)paren
(brace
id|skb_queue_tail
(paren
op_amp
id|instance-&gt;sndqueue
comma
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;sndqlock
comma
id|flags
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_send_data: skb (0x%p) queued&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* init context */
id|urb
op_assign
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|urb
suffix:semicolon
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|skb
op_assign
id|skb
suffix:semicolon
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|vcc
op_assign
id|vcc
suffix:semicolon
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|instance
op_assign
id|instance
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;sndqlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* submit packet */
id|usb_fill_bulk_urb
(paren
id|urb
comma
id|instance-&gt;usb_dev
comma
id|usb_sndbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_OUT
)paren
comma
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|udsl_usb_send_data_complete
comma
op_amp
(paren
id|instance-&gt;send_ctx
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
id|skb_unlink
(paren
id|skb
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_send_data done (retval = %d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/********* receive *******/
DECL|function|udsl_usb_data_receive
r_void
id|udsl_usb_data_receive
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|udsl_data_ctx
op_star
id|ctx
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
r_return
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_receive_data entered, got packet %p with length %d an status %d&bslash;n&quot;
comma
id|urb
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|ctx
op_assign
(paren
r_struct
id|udsl_data_ctx
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctx
op_logical_or
op_logical_neg
id|ctx-&gt;skb
)paren
r_return
suffix:semicolon
id|instance
op_assign
id|ctx-&gt;instance
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_data_receive: processing urb with ctx %p, urb %p (%p), skb %p&bslash;n&quot;
comma
id|ctx
comma
id|ctx
ques
c_cond
id|ctx-&gt;urb
suffix:colon
l_int|NULL
comma
id|urb
comma
id|ctx
ques
c_cond
id|ctx-&gt;skb
suffix:colon
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* update the skb structure */
id|skb_put
(paren
id|ctx-&gt;skb
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
multiline_comment|/* queue the skb for processing and wake the SAR */
id|spin_lock
(paren
op_amp
id|instance-&gt;recvqlock
)paren
suffix:semicolon
id|skb_queue_tail
(paren
op_amp
id|instance-&gt;recvqueue
comma
id|ctx-&gt;skb
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|instance-&gt;recvqlock
)paren
suffix:semicolon
id|wake_up
(paren
op_amp
id|udsl_wqh
)paren
suffix:semicolon
multiline_comment|/* get a new skb */
id|ctx-&gt;skb
op_assign
id|dev_alloc_skb
(paren
id|UDSL_RECEIVE_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctx-&gt;skb
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;No skb, loosing urb.&bslash;n&quot;
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|ctx-&gt;urb
)paren
suffix:semicolon
id|ctx-&gt;urb
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
op_minus
id|ENOENT
suffix:colon
multiline_comment|/* buffer was unlinked */
r_case
op_minus
id|EILSEQ
suffix:colon
multiline_comment|/* unplug or timeout */
r_case
op_minus
id|ETIMEDOUT
suffix:colon
multiline_comment|/* unplug or timeout */
multiline_comment|/* &n;&t;&t; * we don&squot;t do anything here and we don&squot;t resubmit&n;&t;&t; */
r_return
suffix:semicolon
)brace
id|usb_fill_bulk_urb
(paren
id|urb
comma
id|instance-&gt;usb_dev
comma
id|usb_rcvbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_IN
)paren
comma
(paren
r_int
r_char
op_star
)paren
id|ctx-&gt;skb-&gt;data
comma
id|UDSL_RECEIVE_BUFFER_SIZE
comma
id|udsl_usb_data_receive
comma
id|ctx
)paren
suffix:semicolon
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
DECL|function|udsl_usb_data_init
r_int
id|udsl_usb_data_init
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
(brace
r_int
id|i
comma
id|succes
suffix:semicolon
r_if
c_cond
(paren
id|instance-&gt;data_started
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* set alternate setting 1 on interface 1 */
id|usb_set_interface
(paren
id|instance-&gt;usb_dev
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;max packet size on endpoint %d is %d&bslash;n&quot;
comma
id|UDSL_ENDPOINT_DATA_OUT
comma
id|usb_maxpacket
(paren
id|instance-&gt;usb_dev
comma
id|usb_sndbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_OUT
)paren
comma
l_int|0
)paren
)paren
suffix:semicolon
id|instance-&gt;rcvbufs
op_assign
(paren
r_struct
id|udsl_data_ctx
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|udsl_data_ctx
)paren
op_star
id|UDSL_NUMBER_RCV_URBS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;rcvbufs
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
id|instance-&gt;rcvbufs
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|udsl_data_ctx
)paren
op_star
id|UDSL_NUMBER_RCV_URBS
)paren
suffix:semicolon
id|skb_queue_head_init
(paren
op_amp
id|instance-&gt;sndqueue
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|succes
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_RCV_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_data_ctx
op_star
id|ctx
op_assign
op_amp
(paren
id|instance-&gt;rcvbufs
(braket
id|i
)braket
)paren
suffix:semicolon
id|ctx-&gt;urb
op_assign
l_int|NULL
suffix:semicolon
id|ctx-&gt;skb
op_assign
id|dev_alloc_skb
(paren
id|UDSL_RECEIVE_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctx-&gt;skb
)paren
r_continue
suffix:semicolon
id|ctx-&gt;urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctx-&gt;urb
)paren
(brace
id|kfree_skb
(paren
id|ctx-&gt;skb
)paren
suffix:semicolon
id|ctx-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|usb_fill_bulk_urb
(paren
id|ctx-&gt;urb
comma
id|instance-&gt;usb_dev
comma
id|usb_rcvbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_IN
)paren
comma
(paren
r_int
r_char
op_star
)paren
id|ctx-&gt;skb-&gt;data
comma
id|UDSL_RECEIVE_BUFFER_SIZE
comma
id|udsl_usb_data_receive
comma
id|ctx
)paren
suffix:semicolon
id|ctx-&gt;instance
op_assign
id|instance
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_data_init: usb with skb-&gt;truesize = %d (Asked for %d)&bslash;n&quot;
comma
id|ctx-&gt;skb-&gt;truesize
comma
id|UDSL_RECEIVE_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
(paren
id|ctx-&gt;urb
comma
id|GFP_KERNEL
)paren
OL
l_int|0
)paren
id|PDEBUG
(paren
l_string|&quot;udsl_usb_data_init: Submit failed, loosing urb.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|succes
op_increment
suffix:semicolon
)brace
id|PDEBUG
(paren
l_string|&quot;udsl_usb_data_init %d urb%s queued for receive&bslash;n&quot;
comma
id|succes
comma
(paren
id|succes
op_ne
l_int|1
)paren
ques
c_cond
l_string|&quot;s&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|succes
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;udsl_usb_data_init: send urb allocted address %p&bslash;n&quot;
comma
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|instance-&gt;send_ctx
(braket
id|i
)braket
dot
id|urb
)paren
id|succes
op_increment
suffix:semicolon
)brace
id|PDEBUG
(paren
l_string|&quot;udsl_usb_data_init %d urb%s queued for send&bslash;n&quot;
comma
id|succes
comma
(paren
id|succes
op_ne
l_int|1
)paren
ques
c_cond
l_string|&quot;s&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|instance-&gt;data_started
op_assign
l_int|1
suffix:semicolon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_FOUND
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udsl_usb_data_exit
r_static
r_int
id|udsl_usb_data_exit
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;data_started
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;rcvbufs
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* destroy urbs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_RCV_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_data_ctx
op_star
id|ctx
op_assign
op_amp
(paren
id|instance-&gt;rcvbufs
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|ctx-&gt;urb
)paren
op_logical_or
(paren
op_logical_neg
id|ctx-&gt;skb
)paren
)paren
r_continue
suffix:semicolon
id|usb_unlink_urb
(paren
id|ctx-&gt;urb
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|ctx-&gt;urb
)paren
suffix:semicolon
id|kfree_skb
(paren
id|ctx-&gt;skb
)paren
suffix:semicolon
id|ctx-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UDSL_NUMBER_SND_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_usb_send_data_context
op_star
id|ctx
op_assign
op_amp
(paren
id|instance-&gt;send_ctx
(braket
id|i
)braket
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|ctx-&gt;urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctx-&gt;skb
)paren
id|ctx-&gt;vcc-&gt;pop
(paren
id|ctx-&gt;vcc
comma
id|ctx-&gt;skb
)paren
suffix:semicolon
id|ctx-&gt;skb
op_assign
l_int|NULL
suffix:semicolon
id|usb_free_urb
(paren
id|ctx-&gt;urb
)paren
suffix:semicolon
)brace
multiline_comment|/* free receive contexts */
id|kfree
(paren
id|instance-&gt;rcvbufs
)paren
suffix:semicolon
id|instance-&gt;rcvbufs
op_assign
l_int|NULL
suffix:semicolon
id|instance-&gt;data_started
op_assign
l_int|0
suffix:semicolon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/***************************************************************************&n;*&n;* usb driver entries&n;*&n;****************************************************************************/
DECL|macro|hex2int
mdefine_line|#define hex2int(c) ( (c &gt;= &squot;0&squot;)&amp;&amp;(c &lt;= &squot;9&squot;) ?  (c - &squot;0&squot;) : ((c &amp; 0xf)+9) )
DECL|function|udsl_usb_ioctl
r_static
r_int
id|udsl_usb_ioctl
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_int
r_int
id|code
comma
r_void
op_star
id|user_data
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|interface_to_usbdev
(paren
id|intf
)paren
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
r_int
id|i
comma
id|retval
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_UDSL
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|minor_data
(braket
id|i
)braket
op_logical_and
(paren
id|minor_data
(braket
id|i
)braket
op_member_access_from_pointer
id|usb_dev
op_eq
id|dev
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|MAX_UDSL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|instance
op_assign
id|minor_data
(braket
id|i
)braket
suffix:semicolon
id|down
c_func
(paren
op_amp
id|udsl_usb_ioctl_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|UDSL_IOCTL_START
suffix:colon
id|retval
op_assign
id|udsl_usb_data_init
(paren
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UDSL_IOCTL_STOP
suffix:colon
id|retval
op_assign
id|udsl_usb_data_exit
(paren
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|ENOTTY
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|udsl_usb_ioctl_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|udsl_usb_probe
r_static
r_int
id|udsl_usb_probe
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|interface_to_usbdev
c_func
(paren
id|intf
)paren
suffix:semicolon
r_int
id|ifnum
op_assign
id|intf-&gt;altsetting-&gt;desc.bInterfaceNumber
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|mac
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_char
id|mac_str
(braket
l_int|13
)braket
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
l_int|NULL
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;Trying device with Vendor=0x%x, Product=0x%x, ifnum %d&bslash;n&quot;
comma
id|dev-&gt;descriptor.idVendor
comma
id|dev-&gt;descriptor.idProduct
comma
id|ifnum
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;descriptor.bDeviceClass
op_ne
id|USB_CLASS_VENDOR_SPEC
)paren
op_logical_or
(paren
id|dev-&gt;descriptor.idVendor
op_ne
id|SPEEDTOUCH_VENDORID
)paren
op_logical_or
(paren
id|dev-&gt;descriptor.idProduct
op_ne
id|SPEEDTOUCH_PRODUCTID
)paren
op_logical_or
(paren
id|ifnum
op_ne
l_int|1
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_UDSL
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|minor_data
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|MAX_UDSL
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;No minor table space available for SpeedTouch USB&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;Device Accepted, assigning minor %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* device init */
id|instance
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|udsl_instance_data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|PDEBUG
(paren
l_string|&quot;No memory for Instance data!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* initialize structure */
id|memset
(paren
id|instance
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|udsl_instance_data
)paren
)paren
suffix:semicolon
id|instance-&gt;minor
op_assign
id|i
suffix:semicolon
id|instance-&gt;usb_dev
op_assign
id|dev
suffix:semicolon
id|instance-&gt;rcvbufs
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|instance-&gt;sndqlock
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|instance-&gt;recvqlock
)paren
suffix:semicolon
id|udsl_atm_startdevice
(paren
id|instance
comma
op_amp
id|udsl_atm_devops
)paren
suffix:semicolon
multiline_comment|/* set MAC address, it is stored in the serial number */
id|usb_string
(paren
id|instance-&gt;usb_dev
comma
id|instance-&gt;usb_dev-&gt;descriptor.iSerialNumber
comma
id|mac_str
comma
l_int|13
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|mac
(braket
id|i
)braket
op_assign
(paren
id|hex2int
(paren
id|mac_str
(braket
id|i
op_star
l_int|2
)braket
)paren
op_star
l_int|16
)paren
op_plus
(paren
id|hex2int
(paren
id|mac_str
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;MAC is %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|mac
(braket
l_int|0
)braket
comma
id|mac
(braket
l_int|1
)braket
comma
id|mac
(braket
l_int|2
)braket
comma
id|mac
(braket
l_int|3
)braket
comma
id|mac
(braket
l_int|4
)braket
comma
id|mac
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|udsl_atm_set_mac
(paren
id|instance
comma
id|mac
)paren
suffix:semicolon
id|minor_data
(braket
id|instance-&gt;minor
)braket
op_assign
id|instance
suffix:semicolon
id|usb_set_intfdata
(paren
id|intf
comma
id|instance
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udsl_usb_disconnect
r_static
r_void
id|udsl_usb_disconnect
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|usb_get_intfdata
(paren
id|intf
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|usb_set_intfdata
(paren
id|intf
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|instance
)paren
(brace
id|i
op_assign
id|instance-&gt;minor
suffix:semicolon
multiline_comment|/* unlinking receive buffers */
id|udsl_usb_data_exit
(paren
id|instance
)paren
suffix:semicolon
multiline_comment|/* removing atm device */
r_if
c_cond
(paren
id|instance-&gt;atm_dev
)paren
id|udsl_atm_stopdevice
(paren
id|instance
)paren
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;disconnecting minor %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|kfree
(paren
id|instance
)paren
suffix:semicolon
id|minor_data
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************&n;*&n;* Driver Init&n;*&n;****************************************************************************/
DECL|function|udsl_usb_init
r_int
id|udsl_usb_init
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|PDEBUG
(paren
l_string|&quot;Initializing SpeedTouch Driver Version %s&bslash;n&quot;
comma
id|udsl_version
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_UDSL
suffix:semicolon
id|i
op_increment
)paren
id|minor_data
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|udsl_wqh
)paren
suffix:semicolon
id|udsl_atm_sar_start
(paren
)paren
suffix:semicolon
r_return
id|usb_register
(paren
op_amp
id|udsl_usb_driver
)paren
suffix:semicolon
)brace
DECL|function|udsl_usb_cleanup
r_int
id|udsl_usb_cleanup
(paren
r_void
)paren
(brace
multiline_comment|/* killing threads */
id|udsl_atm_sar_stop
(paren
)paren
suffix:semicolon
id|usb_deregister
(paren
op_amp
id|udsl_usb_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
(paren
r_void
)paren
(brace
r_return
id|udsl_usb_init
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_int
id|cleanup_module
(paren
r_void
)paren
(brace
r_return
id|udsl_usb_cleanup
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef DEBUG_PACKET
multiline_comment|/*******************************************************************************&n;*&n;* Debug &n;*&n;*******************************************************************************/
DECL|function|udsl_print_packet
r_int
id|udsl_print_packet
(paren
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
r_char
id|buffer
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
)paren
(brace
id|buffer
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%.3d :&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
l_int|16
)paren
op_logical_and
(paren
id|i
OL
id|len
)paren
suffix:semicolon
id|j
op_increment
comma
id|i
op_increment
)paren
(brace
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%s %2.2x&quot;
comma
id|buffer
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|PDEBUG
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* PACKETDEBUG */
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
