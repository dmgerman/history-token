multiline_comment|/******************************************************************************&n; *  speedtouch.c  -  Alcatel SpeedTouch USB xDSL modem driver&n; *&n; *  Copyright (C) 2001, Alcatel&n; *  Copyright (C) 2003, Duncan Sands&n; *&n; *  This program is free software; you can redistribute it and/or modify it&n; *  under the terms of the GNU General Public License as published by the Free&n; *  Software Foundation; either version 2 of the License, or (at your option)&n; *  any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for&n; *  more details.&n; *&n; *  You should have received a copy of the GNU General Public License along with&n; *  this program; if not, write to the Free Software Foundation, Inc., 59&n; *  Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n; *&n; ******************************************************************************/
multiline_comment|/*&n; *  Written by Johan Verrept, maintained by Duncan Sands (duncan.sands@free.fr)&n; *&n; *  1.7+:&t;- See the check-in logs&n; *&n; *  1.6:&t;- No longer opens a connection if the firmware is not loaded&n; *  &t;&t;- Added support for the speedtouch 330&n; *  &t;&t;- Removed the limit on the number of devices&n; *  &t;&t;- Module now autoloads on device plugin&n; *  &t;&t;- Merged relevant parts of sarlib&n; *  &t;&t;- Replaced the kernel thread with a tasklet&n; *  &t;&t;- New packet transmission code&n; *  &t;&t;- Changed proc file contents&n; *  &t;&t;- Fixed all known SMP races&n; *  &t;&t;- Many fixes and cleanups&n; *  &t;&t;- Various fixes by Oliver Neukum (oliver@neukum.name)&n; *&n; *  1.5A:&t;- Version for inclusion in 2.5 series kernel&n; *&t;&t;- Modifications by Richard Purdie (rpurdie@rpsys.net)&n; *&t;&t;- made compatible with kernel 2.5.6 onwards by changing&n; *&t;&t;udsl_usb_send_data_context-&gt;urb to a pointer and adding code&n; *&t;&t;to alloc and free it&n; *&t;&t;- remove_wait_queue() added to udsl_atm_processqueue_thread()&n; *&n; *  1.5:&t;- fixed memory leak when atmsar_decode_aal5 returned NULL.&n; *&t;&t;(reported by stephen.robinson@zen.co.uk)&n; *&n; *  1.4:&t;- changed the spin_lock() under interrupt to spin_lock_irqsave()&n; *&t;&t;- unlink all active send urbs of a vcc that is being closed.&n; *&n; *  1.3.1:&t;- added the version number&n; *&n; *  1.3:&t;- Added multiple send urb support&n; *&t;&t;- fixed memory leak and vcc-&gt;tx_inuse starvation bug&n; *&t;&t;  when not enough memory left in vcc.&n; *&n; *  1.2:&t;- Fixed race condition in udsl_usb_send_data()&n; *  1.1:&t;- Turned off packet debugging&n; *&n; */
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/atm.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/init.h&gt;
multiline_comment|/*&n;#define DEBUG&n;#define VERBOSE_DEBUG&n;*/
macro_line|#if !defined (DEBUG) &amp;&amp; defined (CONFIG_USB_DEBUG)
DECL|macro|DEBUG
macro_line|#&t;define DEBUG
macro_line|#endif
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#ifdef DEBUG
DECL|macro|DEBUG_ON
mdefine_line|#define DEBUG_ON(x)&t;BUG_ON(x)
macro_line|#else
DECL|macro|DEBUG_ON
mdefine_line|#define DEBUG_ON(x)
macro_line|#endif
macro_line|#ifdef VERBOSE_DEBUG
r_static
r_int
id|udsl_print_packet
(paren
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
DECL|macro|PACKETDEBUG
mdefine_line|#define PACKETDEBUG(arg...)&t;udsl_print_packet (arg)
DECL|macro|vdbg
mdefine_line|#define vdbg(arg...)&t;&t;dbg (arg)
macro_line|#else
DECL|macro|PACKETDEBUG
mdefine_line|#define PACKETDEBUG(arg...)
DECL|macro|vdbg
mdefine_line|#define vdbg(arg...)
macro_line|#endif
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Johan Verrept, Duncan Sands &lt;duncan.sands@free.fr&gt;&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;1.8&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;Alcatel SpeedTouch USB driver version &quot; DRIVER_VERSION
DECL|variable|udsl_driver_name
r_static
r_const
r_char
id|udsl_driver_name
(braket
)braket
op_assign
l_string|&quot;speedtch&quot;
suffix:semicolon
DECL|macro|SPEEDTOUCH_VENDORID
mdefine_line|#define SPEEDTOUCH_VENDORID&t;&t;0x06b9
DECL|macro|SPEEDTOUCH_PRODUCTID
mdefine_line|#define SPEEDTOUCH_PRODUCTID&t;&t;0x4061
DECL|macro|UDSL_MAX_RCV_URBS
mdefine_line|#define UDSL_MAX_RCV_URBS&t;&t;4
DECL|macro|UDSL_MAX_SND_URBS
mdefine_line|#define UDSL_MAX_SND_URBS&t;&t;4
DECL|macro|UDSL_MAX_RCV_BUFS
mdefine_line|#define UDSL_MAX_RCV_BUFS&t;&t;8
DECL|macro|UDSL_MAX_SND_BUFS
mdefine_line|#define UDSL_MAX_SND_BUFS&t;&t;8
DECL|macro|UDSL_MAX_RCV_BUF_SIZE
mdefine_line|#define UDSL_MAX_RCV_BUF_SIZE&t;&t;1024 /* ATM cells */
DECL|macro|UDSL_MAX_SND_BUF_SIZE
mdefine_line|#define UDSL_MAX_SND_BUF_SIZE&t;&t;1024 /* ATM cells */
DECL|macro|UDSL_DEFAULT_RCV_URBS
mdefine_line|#define UDSL_DEFAULT_RCV_URBS&t;&t;2
DECL|macro|UDSL_DEFAULT_SND_URBS
mdefine_line|#define UDSL_DEFAULT_SND_URBS&t;&t;2
DECL|macro|UDSL_DEFAULT_RCV_BUFS
mdefine_line|#define UDSL_DEFAULT_RCV_BUFS&t;&t;4
DECL|macro|UDSL_DEFAULT_SND_BUFS
mdefine_line|#define UDSL_DEFAULT_SND_BUFS&t;&t;4
DECL|macro|UDSL_DEFAULT_RCV_BUF_SIZE
mdefine_line|#define UDSL_DEFAULT_RCV_BUF_SIZE&t;64 /* ATM cells */
DECL|macro|UDSL_DEFAULT_SND_BUF_SIZE
mdefine_line|#define UDSL_DEFAULT_SND_BUF_SIZE&t;64 /* ATM cells */
DECL|variable|num_rcv_urbs
r_static
r_int
r_int
id|num_rcv_urbs
op_assign
id|UDSL_DEFAULT_RCV_URBS
suffix:semicolon
DECL|variable|num_snd_urbs
r_static
r_int
r_int
id|num_snd_urbs
op_assign
id|UDSL_DEFAULT_SND_URBS
suffix:semicolon
DECL|variable|num_rcv_bufs
r_static
r_int
r_int
id|num_rcv_bufs
op_assign
id|UDSL_DEFAULT_RCV_BUFS
suffix:semicolon
DECL|variable|num_snd_bufs
r_static
r_int
r_int
id|num_snd_bufs
op_assign
id|UDSL_DEFAULT_SND_BUFS
suffix:semicolon
DECL|variable|rcv_buf_size
r_static
r_int
r_int
id|rcv_buf_size
op_assign
id|UDSL_DEFAULT_RCV_BUF_SIZE
suffix:semicolon
DECL|variable|snd_buf_size
r_static
r_int
r_int
id|snd_buf_size
op_assign
id|UDSL_DEFAULT_SND_BUF_SIZE
suffix:semicolon
id|module_param
(paren
id|num_rcv_urbs
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|num_rcv_urbs
comma
l_string|&quot;Number of urbs used for reception (range: 0-&quot;
id|__MODULE_STRING
(paren
id|UDSL_MAX_RCV_URBS
)paren
l_string|&quot;, default: &quot;
id|__MODULE_STRING
(paren
id|UDSL_DEFAULT_RCV_URBS
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
id|module_param
(paren
id|num_snd_urbs
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|num_snd_urbs
comma
l_string|&quot;Number of urbs used for transmission (range: 0-&quot;
id|__MODULE_STRING
(paren
id|UDSL_MAX_SND_URBS
)paren
l_string|&quot;, default: &quot;
id|__MODULE_STRING
(paren
id|UDSL_DEFAULT_SND_URBS
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
id|module_param
(paren
id|num_rcv_bufs
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|num_rcv_bufs
comma
l_string|&quot;Number of buffers used for reception (range: 0-&quot;
id|__MODULE_STRING
(paren
id|UDSL_MAX_RCV_BUFS
)paren
l_string|&quot;, default: &quot;
id|__MODULE_STRING
(paren
id|UDSL_DEFAULT_RCV_BUFS
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
id|module_param
(paren
id|num_snd_bufs
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|num_snd_bufs
comma
l_string|&quot;Number of buffers used for transmission (range: 0-&quot;
id|__MODULE_STRING
(paren
id|UDSL_MAX_SND_BUFS
)paren
l_string|&quot;, default: &quot;
id|__MODULE_STRING
(paren
id|UDSL_DEFAULT_SND_BUFS
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
id|module_param
(paren
id|rcv_buf_size
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|rcv_buf_size
comma
l_string|&quot;Size of the buffers used for reception (range: 0-&quot;
id|__MODULE_STRING
(paren
id|UDSL_MAX_RCV_BUF_SIZE
)paren
l_string|&quot;, default: &quot;
id|__MODULE_STRING
(paren
id|UDSL_DEFAULT_RCV_BUF_SIZE
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
id|module_param
(paren
id|snd_buf_size
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|snd_buf_size
comma
l_string|&quot;Size of the buffers used for transmission (range: 0-&quot;
id|__MODULE_STRING
(paren
id|UDSL_MAX_SND_BUF_SIZE
)paren
l_string|&quot;, default: &quot;
id|__MODULE_STRING
(paren
id|UDSL_DEFAULT_SND_BUF_SIZE
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
DECL|macro|UDSL_IOCTL_LINE_UP
mdefine_line|#define UDSL_IOCTL_LINE_UP&t;&t;1
DECL|macro|UDSL_IOCTL_LINE_DOWN
mdefine_line|#define UDSL_IOCTL_LINE_DOWN&t;&t;2
DECL|macro|UDSL_ENDPOINT_DATA_OUT
mdefine_line|#define UDSL_ENDPOINT_DATA_OUT&t;&t;0x07
DECL|macro|UDSL_ENDPOINT_DATA_IN
mdefine_line|#define UDSL_ENDPOINT_DATA_IN&t;&t;0x87
DECL|macro|ATM_CELL_HEADER
mdefine_line|#define ATM_CELL_HEADER&t;&t;&t;(ATM_CELL_SIZE - ATM_CELL_PAYLOAD)
DECL|macro|UDSL_NUM_CELLS
mdefine_line|#define UDSL_NUM_CELLS(x)&t;&t;(((x) + ATM_AAL5_TRAILER + ATM_CELL_PAYLOAD - 1) / ATM_CELL_PAYLOAD)
DECL|macro|hex2int
mdefine_line|#define hex2int(c) ( (c &gt;= &squot;0&squot;) &amp;&amp; (c &lt;= &squot;9&squot;) ? (c - &squot;0&squot;) : ((c &amp; 0xf) + 9) )
DECL|variable|udsl_usb_ids
r_static
r_struct
id|usb_device_id
id|udsl_usb_ids
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
(paren
id|SPEEDTOUCH_VENDORID
comma
id|SPEEDTOUCH_PRODUCTID
)paren
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|udsl_usb_ids
)paren
suffix:semicolon
multiline_comment|/* receive */
DECL|struct|udsl_receive_buffer
r_struct
id|udsl_receive_buffer
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|base
r_int
r_char
op_star
id|base
suffix:semicolon
DECL|member|filled_cells
r_int
r_int
id|filled_cells
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udsl_receiver
r_struct
id|udsl_receiver
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|buffer
r_struct
id|udsl_receive_buffer
op_star
id|buffer
suffix:semicolon
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
DECL|member|instance
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udsl_vcc_data
r_struct
id|udsl_vcc_data
(brace
multiline_comment|/* vpi/vci lookup */
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|vpi
r_int
id|vpi
suffix:semicolon
DECL|member|vci
r_int
id|vci
suffix:semicolon
DECL|member|vcc
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
multiline_comment|/* raw cell reassembly */
DECL|member|sarb
r_struct
id|sk_buff
op_star
id|sarb
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* send */
DECL|struct|udsl_send_buffer
r_struct
id|udsl_send_buffer
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|base
r_int
r_char
op_star
id|base
suffix:semicolon
DECL|member|free_start
r_int
r_char
op_star
id|free_start
suffix:semicolon
DECL|member|free_cells
r_int
r_int
id|free_cells
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udsl_sender
r_struct
id|udsl_sender
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|buffer
r_struct
id|udsl_send_buffer
op_star
id|buffer
suffix:semicolon
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
DECL|member|instance
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udsl_control
r_struct
id|udsl_control
(brace
DECL|member|atm_data
r_struct
id|atm_skb_data
id|atm_data
suffix:semicolon
DECL|member|num_cells
r_int
r_int
id|num_cells
suffix:semicolon
DECL|member|num_entire
r_int
r_int
id|num_entire
suffix:semicolon
DECL|member|pdu_padding
r_int
r_int
id|pdu_padding
suffix:semicolon
DECL|member|cell_header
r_int
r_char
id|cell_header
(braket
id|ATM_CELL_HEADER
)braket
suffix:semicolon
DECL|member|aal5_trailer
r_int
r_char
id|aal5_trailer
(braket
id|ATM_AAL5_TRAILER
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|UDSL_SKB
mdefine_line|#define UDSL_SKB(x)&t;&t;((struct udsl_control *)(x)-&gt;cb)
multiline_comment|/* main driver data */
DECL|struct|udsl_instance_data
r_struct
id|udsl_instance_data
(brace
DECL|member|serialize
r_struct
id|semaphore
id|serialize
suffix:semicolon
multiline_comment|/* USB device part */
DECL|member|usb_dev
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
DECL|member|description
r_char
id|description
(braket
l_int|64
)braket
suffix:semicolon
DECL|member|firmware_loaded
r_int
id|firmware_loaded
suffix:semicolon
multiline_comment|/* ATM device part */
DECL|member|atm_dev
r_struct
id|atm_dev
op_star
id|atm_dev
suffix:semicolon
DECL|member|vcc_list
r_struct
id|list_head
id|vcc_list
suffix:semicolon
multiline_comment|/* receive */
DECL|member|receivers
r_struct
id|udsl_receiver
id|receivers
(braket
id|UDSL_MAX_RCV_URBS
)braket
suffix:semicolon
DECL|member|receive_buffers
r_struct
id|udsl_receive_buffer
id|receive_buffers
(braket
id|UDSL_MAX_RCV_BUFS
)braket
suffix:semicolon
DECL|member|receive_lock
id|spinlock_t
id|receive_lock
suffix:semicolon
DECL|member|spare_receivers
r_struct
id|list_head
id|spare_receivers
suffix:semicolon
DECL|member|filled_receive_buffers
r_struct
id|list_head
id|filled_receive_buffers
suffix:semicolon
DECL|member|receive_tasklet
r_struct
id|tasklet_struct
id|receive_tasklet
suffix:semicolon
DECL|member|spare_receive_buffers
r_struct
id|list_head
id|spare_receive_buffers
suffix:semicolon
multiline_comment|/* send */
DECL|member|senders
r_struct
id|udsl_sender
id|senders
(braket
id|UDSL_MAX_SND_URBS
)braket
suffix:semicolon
DECL|member|send_buffers
r_struct
id|udsl_send_buffer
id|send_buffers
(braket
id|UDSL_MAX_SND_BUFS
)braket
suffix:semicolon
DECL|member|sndqueue
r_struct
id|sk_buff_head
id|sndqueue
suffix:semicolon
DECL|member|send_lock
id|spinlock_t
id|send_lock
suffix:semicolon
DECL|member|spare_senders
r_struct
id|list_head
id|spare_senders
suffix:semicolon
DECL|member|spare_send_buffers
r_struct
id|list_head
id|spare_send_buffers
suffix:semicolon
DECL|member|send_tasklet
r_struct
id|tasklet_struct
id|send_tasklet
suffix:semicolon
DECL|member|current_skb
r_struct
id|sk_buff
op_star
id|current_skb
suffix:semicolon
multiline_comment|/* being emptied */
DECL|member|current_buffer
r_struct
id|udsl_send_buffer
op_star
id|current_buffer
suffix:semicolon
multiline_comment|/* being filled */
DECL|member|filled_send_buffers
r_struct
id|list_head
id|filled_send_buffers
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* ATM */
r_static
r_void
id|udsl_atm_dev_close
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_open
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
suffix:semicolon
r_static
r_void
id|udsl_atm_close
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_ioctl
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
id|__user
op_star
id|arg
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_send
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|udsl_atm_proc_read
(paren
r_struct
id|atm_dev
op_star
id|atm_dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
suffix:semicolon
DECL|variable|udsl_atm_devops
r_static
r_struct
id|atmdev_ops
id|udsl_atm_devops
op_assign
(brace
dot
id|dev_close
op_assign
id|udsl_atm_dev_close
comma
dot
id|open
op_assign
id|udsl_atm_open
comma
dot
id|close
op_assign
id|udsl_atm_close
comma
dot
id|ioctl
op_assign
id|udsl_atm_ioctl
comma
dot
id|send
op_assign
id|udsl_atm_send
comma
dot
id|proc_read
op_assign
id|udsl_atm_proc_read
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
multiline_comment|/* USB */
r_static
r_int
id|udsl_usb_probe
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_void
id|udsl_usb_disconnect
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
suffix:semicolon
r_static
r_int
id|udsl_usb_ioctl
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_int
r_int
id|code
comma
r_void
op_star
id|user_data
)paren
suffix:semicolon
DECL|variable|udsl_usb_driver
r_static
r_struct
id|usb_driver
id|udsl_usb_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|udsl_driver_name
comma
dot
id|probe
op_assign
id|udsl_usb_probe
comma
dot
id|disconnect
op_assign
id|udsl_usb_disconnect
comma
dot
id|ioctl
op_assign
id|udsl_usb_ioctl
comma
dot
id|id_table
op_assign
id|udsl_usb_ids
comma
)brace
suffix:semicolon
multiline_comment|/***********&n;**  misc  **&n;***********/
DECL|function|udsl_pop
r_static
r_inline
r_void
id|udsl_pop
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|vcc-&gt;pop
)paren
id|vcc-&gt;pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*************&n;**  decode  **&n;*************/
DECL|function|udsl_find_vcc
r_static
r_inline
r_struct
id|udsl_vcc_data
op_star
id|udsl_find_vcc
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
(brace
r_struct
id|udsl_vcc_data
op_star
id|vcc
suffix:semicolon
id|list_for_each_entry
(paren
id|vcc
comma
op_amp
id|instance-&gt;vcc_list
comma
id|list
)paren
r_if
c_cond
(paren
(paren
id|vcc-&gt;vci
op_eq
id|vci
)paren
op_logical_and
(paren
id|vcc-&gt;vpi
op_eq
id|vpi
)paren
)paren
r_return
id|vcc
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|udsl_extract_cells
r_static
r_void
id|udsl_extract_cells
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_int
r_char
op_star
id|source
comma
r_int
r_int
id|howmany
)paren
(brace
r_struct
id|udsl_vcc_data
op_star
id|cached_vcc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|atm_vcc
op_star
id|vcc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|sarb
suffix:semicolon
r_struct
id|udsl_vcc_data
op_star
id|vcc_data
suffix:semicolon
r_int
id|cached_vci
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
id|pti
suffix:semicolon
r_int
id|vci
suffix:semicolon
r_int
id|cached_vpi
op_assign
l_int|0
suffix:semicolon
r_int
id|vpi
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|howmany
suffix:semicolon
id|i
op_increment
comma
id|source
op_add_assign
id|ATM_CELL_SIZE
)paren
(brace
id|vpi
op_assign
(paren
(paren
id|source
(braket
l_int|0
)braket
op_amp
l_int|0x0f
)paren
op_lshift
l_int|4
)paren
op_or
(paren
id|source
(braket
l_int|1
)braket
op_rshift
l_int|4
)paren
suffix:semicolon
id|vci
op_assign
(paren
(paren
id|source
(braket
l_int|1
)braket
op_amp
l_int|0x0f
)paren
op_lshift
l_int|12
)paren
op_or
(paren
id|source
(braket
l_int|2
)braket
op_lshift
l_int|4
)paren
op_or
(paren
id|source
(braket
l_int|3
)braket
op_rshift
l_int|4
)paren
suffix:semicolon
id|pti
op_assign
(paren
id|source
(braket
l_int|3
)braket
op_amp
l_int|0x2
)paren
op_ne
l_int|0
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_extract_cells: vpi %hd, vci %d, pti %d&quot;
comma
id|vpi
comma
id|vci
comma
id|pti
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cached_vcc
op_logical_and
(paren
id|vci
op_eq
id|cached_vci
)paren
op_logical_and
(paren
id|vpi
op_eq
id|cached_vpi
)paren
)paren
id|vcc_data
op_assign
id|cached_vcc
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|vcc_data
op_assign
id|udsl_find_vcc
(paren
id|instance
comma
id|vpi
comma
id|vci
)paren
)paren
)paren
(brace
id|cached_vcc
op_assign
id|vcc_data
suffix:semicolon
id|cached_vpi
op_assign
id|vpi
suffix:semicolon
id|cached_vci
op_assign
id|vci
suffix:semicolon
)brace
r_else
(brace
id|dbg
(paren
l_string|&quot;udsl_extract_cells: unknown vpi/vci (%hd/%d)!&quot;
comma
id|vpi
comma
id|vci
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|vcc
op_assign
id|vcc_data-&gt;vcc
suffix:semicolon
id|sarb
op_assign
id|vcc_data-&gt;sarb
suffix:semicolon
r_if
c_cond
(paren
id|sarb-&gt;tail
op_plus
id|ATM_CELL_PAYLOAD
OG
id|sarb-&gt;end
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_extract_cells: buffer overrun (sarb-&gt;len %u, vcc: 0x%p)!&quot;
comma
id|sarb-&gt;len
comma
id|vcc
)paren
suffix:semicolon
multiline_comment|/* discard cells already received */
id|skb_trim
(paren
id|sarb
comma
l_int|0
)paren
suffix:semicolon
)brace
id|memcpy
(paren
id|sarb-&gt;tail
comma
id|source
op_plus
id|ATM_CELL_HEADER
comma
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
id|__skb_put
(paren
id|sarb
comma
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pti
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|length
suffix:semicolon
r_int
r_int
id|pdu_length
suffix:semicolon
id|length
op_assign
(paren
id|source
(braket
id|ATM_CELL_SIZE
op_minus
l_int|6
)braket
op_lshift
l_int|8
)paren
op_plus
id|source
(braket
id|ATM_CELL_SIZE
op_minus
l_int|5
)braket
suffix:semicolon
multiline_comment|/* guard against overflow */
r_if
c_cond
(paren
id|length
OG
id|ATM_MAX_AAL5_PDU
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_extract_cells: bogus length %u (vcc: 0x%p)!&quot;
comma
id|length
comma
id|vcc
)paren
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|pdu_length
op_assign
id|UDSL_NUM_CELLS
(paren
id|length
)paren
op_star
id|ATM_CELL_PAYLOAD
suffix:semicolon
r_if
c_cond
(paren
id|sarb-&gt;len
OL
id|pdu_length
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_extract_cells: bogus pdu_length %u (sarb-&gt;len: %u, vcc: 0x%p)!&quot;
comma
id|pdu_length
comma
id|sarb-&gt;len
comma
id|vcc
)paren
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|crc32_be
(paren
op_complement
l_int|0
comma
id|sarb-&gt;tail
op_minus
id|pdu_length
comma
id|pdu_length
)paren
op_ne
l_int|0xc704dd7b
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_extract_cells: packet failed crc check (vcc: 0x%p)!&quot;
comma
id|vcc
)paren
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|vdbg
(paren
l_string|&quot;udsl_extract_cells: got packet (length: %u, pdu_length: %u, vcc: 0x%p)&quot;
comma
id|length
comma
id|pdu_length
comma
id|vcc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
(paren
id|length
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_extract_cells: no memory for skb (length: %u)!&quot;
comma
id|length
)paren
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|vcc-&gt;stats-&gt;rx_drop
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|vdbg
(paren
l_string|&quot;udsl_extract_cells: allocated new sk_buff (skb: 0x%p, skb-&gt;truesize: %u)&quot;
comma
id|skb
comma
id|skb-&gt;truesize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atm_charge
(paren
id|vcc
comma
id|skb-&gt;truesize
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_extract_cells: failed atm_charge (skb-&gt;truesize: %u)!&quot;
comma
id|skb-&gt;truesize
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
multiline_comment|/* atm_charge increments rx_drop */
)brace
id|memcpy
(paren
id|skb-&gt;data
comma
id|sarb-&gt;tail
op_minus
id|pdu_length
comma
id|length
)paren
suffix:semicolon
id|__skb_put
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_extract_cells: sending skb 0x%p, skb-&gt;len %u, skb-&gt;truesize %u&quot;
comma
id|skb
comma
id|skb-&gt;len
comma
id|skb-&gt;truesize
)paren
suffix:semicolon
id|PACKETDEBUG
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|vcc-&gt;push
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|vcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
id|out
suffix:colon
id|skb_trim
(paren
id|sarb
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*************&n;**  encode  **&n;*************/
DECL|variable|zeros
r_static
r_const
r_int
r_char
id|zeros
(braket
id|ATM_CELL_PAYLOAD
)braket
suffix:semicolon
DECL|function|udsl_groom_skb
r_static
r_void
id|udsl_groom_skb
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|udsl_control
op_star
id|ctrl
op_assign
id|UDSL_SKB
(paren
id|skb
)paren
suffix:semicolon
r_int
r_int
id|zero_padding
suffix:semicolon
id|u32
id|crc
suffix:semicolon
id|ctrl-&gt;atm_data.vcc
op_assign
id|vcc
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|0
)braket
op_assign
id|vcc-&gt;vpi
op_rshift
l_int|4
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|1
)braket
op_assign
(paren
id|vcc-&gt;vpi
op_lshift
l_int|4
)paren
op_or
(paren
id|vcc-&gt;vci
op_rshift
l_int|12
)paren
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|2
)braket
op_assign
id|vcc-&gt;vci
op_rshift
l_int|4
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|3
)braket
op_assign
id|vcc-&gt;vci
op_lshift
l_int|4
suffix:semicolon
id|ctrl-&gt;cell_header
(braket
l_int|4
)braket
op_assign
l_int|0xec
suffix:semicolon
id|ctrl-&gt;num_cells
op_assign
id|UDSL_NUM_CELLS
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|ctrl-&gt;num_entire
op_assign
id|skb-&gt;len
op_div
id|ATM_CELL_PAYLOAD
suffix:semicolon
id|zero_padding
op_assign
id|ctrl-&gt;num_cells
op_star
id|ATM_CELL_PAYLOAD
op_minus
id|skb-&gt;len
op_minus
id|ATM_AAL5_TRAILER
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;num_entire
op_plus
l_int|1
OL
id|ctrl-&gt;num_cells
)paren
id|ctrl-&gt;pdu_padding
op_assign
id|zero_padding
op_minus
(paren
id|ATM_CELL_PAYLOAD
op_minus
id|ATM_AAL5_TRAILER
)paren
suffix:semicolon
r_else
id|ctrl-&gt;pdu_padding
op_assign
id|zero_padding
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* UU = 0 */
id|ctrl-&gt;aal5_trailer
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CPI = 0 */
id|ctrl-&gt;aal5_trailer
(braket
l_int|2
)braket
op_assign
id|skb-&gt;len
op_rshift
l_int|8
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|3
)braket
op_assign
id|skb-&gt;len
suffix:semicolon
id|crc
op_assign
id|crc32_be
(paren
op_complement
l_int|0
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|crc
op_assign
id|crc32_be
(paren
id|crc
comma
id|zeros
comma
id|zero_padding
)paren
suffix:semicolon
id|crc
op_assign
id|crc32_be
(paren
id|crc
comma
id|ctrl-&gt;aal5_trailer
comma
l_int|4
)paren
suffix:semicolon
id|crc
op_assign
op_complement
id|crc
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|4
)braket
op_assign
id|crc
op_rshift
l_int|24
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|5
)braket
op_assign
id|crc
op_rshift
l_int|16
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|6
)braket
op_assign
id|crc
op_rshift
l_int|8
suffix:semicolon
id|ctrl-&gt;aal5_trailer
(braket
l_int|7
)braket
op_assign
id|crc
suffix:semicolon
)brace
DECL|function|udsl_write_cells
r_static
r_int
r_int
id|udsl_write_cells
(paren
r_int
r_int
id|howmany
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_char
op_star
op_star
id|target_p
)paren
(brace
r_struct
id|udsl_control
op_star
id|ctrl
op_assign
id|UDSL_SKB
(paren
id|skb
)paren
suffix:semicolon
r_int
r_char
op_star
id|target
op_assign
op_star
id|target_p
suffix:semicolon
r_int
r_int
id|nc
comma
id|ne
comma
id|i
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_write_cells: howmany=%u, skb-&gt;len=%d, num_cells=%u, num_entire=%u, pdu_padding=%u&quot;
comma
id|howmany
comma
id|skb-&gt;len
comma
id|ctrl-&gt;num_cells
comma
id|ctrl-&gt;num_entire
comma
id|ctrl-&gt;pdu_padding
)paren
suffix:semicolon
id|nc
op_assign
id|ctrl-&gt;num_cells
suffix:semicolon
id|ne
op_assign
id|min
(paren
id|howmany
comma
id|ctrl-&gt;num_entire
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ne
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
(paren
id|target
comma
id|ctrl-&gt;cell_header
comma
id|ATM_CELL_HEADER
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_CELL_HEADER
suffix:semicolon
id|memcpy
(paren
id|target
comma
id|skb-&gt;data
comma
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_CELL_PAYLOAD
suffix:semicolon
id|__skb_pull
(paren
id|skb
comma
id|ATM_CELL_PAYLOAD
)paren
suffix:semicolon
)brace
id|ctrl-&gt;num_entire
op_sub_assign
id|ne
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctrl-&gt;num_cells
op_sub_assign
id|ne
)paren
op_logical_or
op_logical_neg
(paren
id|howmany
op_sub_assign
id|ne
)paren
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
(paren
id|target
comma
id|ctrl-&gt;cell_header
comma
id|ATM_CELL_HEADER
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_CELL_HEADER
suffix:semicolon
id|memcpy
(paren
id|target
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|target
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|__skb_pull
(paren
id|skb
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|memset
(paren
id|target
comma
l_int|0
comma
id|ctrl-&gt;pdu_padding
)paren
suffix:semicolon
id|target
op_add_assign
id|ctrl-&gt;pdu_padding
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|ctrl-&gt;num_cells
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|howmany
)paren
(brace
id|ctrl-&gt;pdu_padding
op_assign
id|ATM_CELL_PAYLOAD
op_minus
id|ATM_AAL5_TRAILER
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memcpy
(paren
id|target
comma
id|ctrl-&gt;cell_header
comma
id|ATM_CELL_HEADER
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_CELL_HEADER
suffix:semicolon
id|memset
(paren
id|target
comma
l_int|0
comma
id|ATM_CELL_PAYLOAD
op_minus
id|ATM_AAL5_TRAILER
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_CELL_PAYLOAD
op_minus
id|ATM_AAL5_TRAILER
suffix:semicolon
op_decrement
id|ctrl-&gt;num_cells
suffix:semicolon
id|DEBUG_ON
(paren
id|ctrl-&gt;num_cells
)paren
suffix:semicolon
)brace
id|memcpy
(paren
id|target
comma
id|ctrl-&gt;aal5_trailer
comma
id|ATM_AAL5_TRAILER
)paren
suffix:semicolon
id|target
op_add_assign
id|ATM_AAL5_TRAILER
suffix:semicolon
multiline_comment|/* set pti bit in last cell */
op_star
(paren
id|target
op_plus
l_int|3
op_minus
id|ATM_CELL_SIZE
)paren
op_or_assign
l_int|0x2
suffix:semicolon
id|out
suffix:colon
op_star
id|target_p
op_assign
id|target
suffix:semicolon
r_return
id|nc
op_minus
id|ctrl-&gt;num_cells
suffix:semicolon
)brace
multiline_comment|/**************&n;**  receive  **&n;**************/
DECL|function|udsl_complete_receive
r_static
r_void
id|udsl_complete_receive
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|udsl_receive_buffer
op_star
id|buf
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
r_struct
id|udsl_receiver
op_star
id|rcv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
op_logical_or
op_logical_neg
(paren
id|rcv
op_assign
id|urb-&gt;context
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_complete_receive: bad urb!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|instance
op_assign
id|rcv-&gt;instance
suffix:semicolon
id|buf
op_assign
id|rcv-&gt;buffer
suffix:semicolon
id|buf-&gt;filled_cells
op_assign
id|urb-&gt;actual_length
op_div
id|ATM_CELL_SIZE
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_complete_receive: urb 0x%p, status %d, actual_length %d, filled_cells %u, rcv 0x%p, buf 0x%p&quot;
comma
id|urb
comma
id|urb-&gt;status
comma
id|urb-&gt;actual_length
comma
id|buf-&gt;filled_cells
comma
id|rcv
comma
id|buf
)paren
suffix:semicolon
id|DEBUG_ON
(paren
id|buf-&gt;filled_cells
OG
id|rcv_buf_size
)paren
suffix:semicolon
multiline_comment|/* may not be in_interrupt() */
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;receive_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|rcv-&gt;list
comma
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;filled_receive_buffers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
(paren
op_logical_neg
id|urb-&gt;status
)paren
)paren
id|tasklet_schedule
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;receive_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|udsl_process_receive
r_static
r_void
id|udsl_process_receive
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|udsl_receive_buffer
op_star
id|buf
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
(paren
r_struct
id|udsl_instance_data
op_star
)paren
id|data
suffix:semicolon
r_struct
id|udsl_receiver
op_star
id|rcv
suffix:semicolon
r_int
id|err
suffix:semicolon
id|made_progress
suffix:colon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|instance-&gt;spare_receive_buffers
)paren
)paren
(brace
id|spin_lock_irq
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
op_amp
id|instance-&gt;spare_receivers
)paren
)paren
(brace
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rcv
op_assign
id|list_entry
(paren
id|instance-&gt;spare_receivers.next
comma
r_struct
id|udsl_receiver
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|rcv-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
id|buf
op_assign
id|list_entry
(paren
id|instance-&gt;spare_receive_buffers.next
comma
r_struct
id|udsl_receive_buffer
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|buf-&gt;list
)paren
suffix:semicolon
id|rcv-&gt;buffer
op_assign
id|buf
suffix:semicolon
id|usb_fill_bulk_urb
(paren
id|rcv-&gt;urb
comma
id|instance-&gt;usb_dev
comma
id|usb_rcvbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_IN
)paren
comma
id|buf-&gt;base
comma
id|rcv_buf_size
op_star
id|ATM_CELL_SIZE
comma
id|udsl_complete_receive
comma
id|rcv
)paren
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_process_receive: sending urb 0x%p, rcv 0x%p, buf 0x%p&quot;
comma
id|rcv-&gt;urb
comma
id|rcv
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|rcv-&gt;urb
comma
id|GFP_ATOMIC
)paren
)paren
OL
l_int|0
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_process_receive: urb submission failed (%d)!&quot;
comma
id|err
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;spare_receive_buffers
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|rcv-&gt;list
comma
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_lock_irq
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
op_amp
id|instance-&gt;filled_receive_buffers
)paren
)paren
(brace
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* done - no more buffers */
)brace
id|buf
op_assign
id|list_entry
(paren
id|instance-&gt;filled_receive_buffers.next
comma
r_struct
id|udsl_receive_buffer
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|buf-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_process_receive: processing buf 0x%p&quot;
comma
id|buf
)paren
suffix:semicolon
id|udsl_extract_cells
(paren
id|instance
comma
id|buf-&gt;base
comma
id|buf-&gt;filled_cells
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;spare_receive_buffers
)paren
suffix:semicolon
r_goto
id|made_progress
suffix:semicolon
)brace
multiline_comment|/***********&n;**  send  **&n;***********/
DECL|function|udsl_complete_send
r_static
r_void
id|udsl_complete_send
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
r_struct
id|udsl_sender
op_star
id|snd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
op_logical_or
op_logical_neg
(paren
id|snd
op_assign
id|urb-&gt;context
)paren
op_logical_or
op_logical_neg
(paren
id|instance
op_assign
id|snd-&gt;instance
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_complete_send: bad urb!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vdbg
(paren
l_string|&quot;udsl_complete_send: urb 0x%p, status %d, snd 0x%p, buf 0x%p&quot;
comma
id|urb
comma
id|urb-&gt;status
comma
id|snd
comma
id|snd-&gt;buffer
)paren
suffix:semicolon
multiline_comment|/* may not be in_interrupt() */
id|spin_lock_irqsave
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|snd-&gt;list
comma
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|snd-&gt;buffer-&gt;list
comma
op_amp
id|instance-&gt;spare_send_buffers
)paren
suffix:semicolon
id|tasklet_schedule
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|instance-&gt;send_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|udsl_process_send
r_static
r_void
id|udsl_process_send
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|udsl_send_buffer
op_star
id|buf
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
(paren
r_struct
id|udsl_instance_data
op_star
)paren
id|data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|udsl_sender
op_star
id|snd
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_int
id|num_written
suffix:semicolon
id|made_progress
suffix:colon
id|spin_lock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|instance-&gt;spare_senders
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|instance-&gt;filled_send_buffers
)paren
)paren
(brace
id|buf
op_assign
id|list_entry
(paren
id|instance-&gt;filled_send_buffers.next
comma
r_struct
id|udsl_send_buffer
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|buf-&gt;list
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|buf
op_assign
id|instance-&gt;current_buffer
)paren
)paren
(brace
id|instance-&gt;current_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
multiline_comment|/* all buffers empty */
r_break
suffix:semicolon
id|snd
op_assign
id|list_entry
(paren
id|instance-&gt;spare_senders.next
comma
r_struct
id|udsl_sender
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|snd-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
id|snd-&gt;buffer
op_assign
id|buf
suffix:semicolon
id|usb_fill_bulk_urb
(paren
id|snd-&gt;urb
comma
id|instance-&gt;usb_dev
comma
id|usb_sndbulkpipe
(paren
id|instance-&gt;usb_dev
comma
id|UDSL_ENDPOINT_DATA_OUT
)paren
comma
id|buf-&gt;base
comma
(paren
id|snd_buf_size
op_minus
id|buf-&gt;free_cells
)paren
op_star
id|ATM_CELL_SIZE
comma
id|udsl_complete_send
comma
id|snd
)paren
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_process_send: submitting urb 0x%p (%d cells), snd 0x%p, buf 0x%p&quot;
comma
id|snd-&gt;urb
comma
id|snd_buf_size
op_minus
id|buf-&gt;free_cells
comma
id|snd
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|snd-&gt;urb
comma
id|GFP_ATOMIC
)paren
)paren
OL
l_int|0
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_process_send: urb submission failed (%d)!&quot;
comma
id|err
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|snd-&gt;list
comma
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;filled_send_buffers
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* bail out */
)brace
id|spin_lock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* while */
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;current_skb
op_logical_and
op_logical_neg
(paren
id|instance-&gt;current_skb
op_assign
id|skb_dequeue
(paren
op_amp
id|instance-&gt;sndqueue
)paren
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* done - no more skbs */
id|skb
op_assign
id|instance-&gt;current_skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_assign
id|instance-&gt;current_buffer
)paren
)paren
(brace
id|spin_lock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
op_amp
id|instance-&gt;spare_send_buffers
)paren
)paren
(brace
id|instance-&gt;current_buffer
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* done - no more buffers */
)brace
id|buf
op_assign
id|list_entry
(paren
id|instance-&gt;spare_send_buffers.next
comma
r_struct
id|udsl_send_buffer
comma
id|list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|buf-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
id|buf-&gt;free_start
op_assign
id|buf-&gt;base
suffix:semicolon
id|buf-&gt;free_cells
op_assign
id|snd_buf_size
suffix:semicolon
id|instance-&gt;current_buffer
op_assign
id|buf
suffix:semicolon
)brace
id|num_written
op_assign
id|udsl_write_cells
(paren
id|buf-&gt;free_cells
comma
id|skb
comma
op_amp
id|buf-&gt;free_start
)paren
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_process_send: wrote %u cells from skb 0x%p to buffer 0x%p&quot;
comma
id|num_written
comma
id|skb
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf-&gt;free_cells
op_sub_assign
id|num_written
)paren
)paren
(brace
id|list_add_tail
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;filled_send_buffers
)paren
suffix:semicolon
id|instance-&gt;current_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
id|vdbg
(paren
l_string|&quot;udsl_process_send: buffer contains %d cells, %d left&quot;
comma
id|snd_buf_size
op_minus
id|buf-&gt;free_cells
comma
id|buf-&gt;free_cells
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|num_cells
)paren
(brace
r_struct
id|atm_vcc
op_star
id|vcc
op_assign
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_data.vcc
suffix:semicolon
id|udsl_pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|instance-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|vcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
)brace
r_goto
id|made_progress
suffix:semicolon
)brace
DECL|function|udsl_cancel_send
r_static
r_void
id|udsl_cancel_send
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
comma
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|n
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_cancel_send entered&quot;
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|instance-&gt;sndqueue.lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|skb
op_assign
id|instance-&gt;sndqueue.next
comma
id|n
op_assign
id|skb-&gt;next
suffix:semicolon
id|skb
op_ne
(paren
r_struct
id|sk_buff
op_star
)paren
op_amp
id|instance-&gt;sndqueue
suffix:semicolon
id|skb
op_assign
id|n
comma
id|n
op_assign
id|skb-&gt;next
)paren
r_if
c_cond
(paren
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_data.vcc
op_eq
id|vcc
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_cancel_send: popping skb 0x%p&quot;
comma
id|skb
)paren
suffix:semicolon
id|__skb_unlink
(paren
id|skb
comma
op_amp
id|instance-&gt;sndqueue
)paren
suffix:semicolon
id|udsl_pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|instance-&gt;sndqueue.lock
)paren
suffix:semicolon
id|tasklet_disable
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|instance-&gt;current_skb
)paren
op_logical_and
(paren
id|UDSL_SKB
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_data.vcc
op_eq
id|vcc
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_cancel_send: popping current skb (0x%p)&quot;
comma
id|skb
)paren
suffix:semicolon
id|instance-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
id|udsl_pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
)brace
id|tasklet_enable
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_cancel_send done&quot;
)paren
suffix:semicolon
)brace
DECL|function|udsl_atm_send
r_static
r_int
id|udsl_atm_send
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
r_int
id|err
suffix:semicolon
id|vdbg
(paren
l_string|&quot;udsl_atm_send called (skb 0x%p, len %u)&quot;
comma
id|skb
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
op_logical_or
op_logical_neg
id|instance-&gt;usb_dev
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_send: NULL data!&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_send: unsupported ATM type %d!&quot;
comma
id|vcc-&gt;qos.aal
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|ATM_MAX_AAL5_PDU
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_send: packet too long (%d vs %d)!&quot;
comma
id|skb-&gt;len
comma
id|ATM_MAX_AAL5_PDU
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|PACKETDEBUG
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|udsl_groom_skb
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
id|skb_queue_tail
(paren
op_amp
id|instance-&gt;sndqueue
comma
id|skb
)paren
suffix:semicolon
id|tasklet_schedule
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|udsl_pop
(paren
id|vcc
comma
id|skb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/**********&n;**  ATM  **&n;**********/
DECL|function|udsl_atm_dev_close
r_static
r_void
id|udsl_atm_dev_close
(paren
r_struct
id|atm_dev
op_star
id|dev
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|dev-&gt;dev_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_dev_close: NULL instance!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;udsl_atm_dev_close: queue has %u elements&quot;
comma
id|instance-&gt;sndqueue.qlen
)paren
suffix:semicolon
id|tasklet_kill
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|tasklet_kill
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
id|kfree
(paren
id|instance
)paren
suffix:semicolon
id|dev-&gt;dev_data
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|udsl_atm_proc_read
r_static
r_int
id|udsl_atm_proc_read
(paren
r_struct
id|atm_dev
op_star
id|atm_dev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|atm_dev-&gt;dev_data
suffix:semicolon
r_int
id|left
op_assign
op_star
id|pos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_proc_read: NULL instance!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
(paren
id|page
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|instance-&gt;description
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
(paren
id|page
comma
l_string|&quot;MAC: %02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|atm_dev-&gt;esi
(braket
l_int|0
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|1
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|2
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|3
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|4
)braket
comma
id|atm_dev-&gt;esi
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
r_return
id|sprintf
(paren
id|page
comma
l_string|&quot;AAL5: tx %d ( %d err ), rx %d ( %d err, %d drop )&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.tx
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.tx_err
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx_err
)paren
comma
id|atomic_read
(paren
op_amp
id|atm_dev-&gt;stats.aal5.rx_drop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
op_decrement
)paren
(brace
r_switch
c_cond
(paren
id|atm_dev-&gt;signal
)paren
(brace
r_case
id|ATM_PHY_SIG_FOUND
suffix:colon
id|sprintf
(paren
id|page
comma
l_string|&quot;Line up&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATM_PHY_SIG_LOST
suffix:colon
id|sprintf
(paren
id|page
comma
l_string|&quot;Line down&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
(paren
id|page
comma
l_string|&quot;Line state unknown&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|instance-&gt;usb_dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;firmware_loaded
)paren
id|strcat
(paren
id|page
comma
l_string|&quot;, no firmware&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|strcat
(paren
id|page
comma
l_string|&quot;, firmware loaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|strcat
(paren
id|page
comma
l_string|&quot;, disconnected&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|strlen
(paren
id|page
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udsl_atm_open
r_static
r_int
id|udsl_atm_open
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
r_struct
id|udsl_vcc_data
op_star
r_new
suffix:semicolon
r_int
r_int
id|max_pdu
suffix:semicolon
r_int
id|vci
op_assign
id|vcc-&gt;vci
suffix:semicolon
r_int
id|vpi
op_assign
id|vcc-&gt;vpi
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_atm_open: vpi %hd, vci %d&quot;
comma
id|vpi
comma
id|vci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
op_logical_or
op_logical_neg
id|instance-&gt;usb_dev
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_open: NULL data!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* only support AAL5 */
r_if
c_cond
(paren
(paren
id|vcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
op_logical_or
(paren
id|vcc-&gt;qos.rxtp.max_sdu
OL
l_int|0
)paren
op_logical_or
(paren
id|vcc-&gt;qos.rxtp.max_sdu
OG
id|ATM_MAX_AAL5_PDU
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_open: unsupported ATM type %d!&quot;
comma
id|vcc-&gt;qos.aal
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;firmware_loaded
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_open: firmware not loaded!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|down
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
multiline_comment|/* vs self, udsl_atm_close */
r_if
c_cond
(paren
id|udsl_find_vcc
(paren
id|instance
comma
id|vpi
comma
id|vci
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_open: %hd/%d already in use!&quot;
comma
id|vpi
comma
id|vci
)paren
suffix:semicolon
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
r_new
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|udsl_vcc_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_open: no memory for vcc_data!&quot;
)paren
suffix:semicolon
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
r_new
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|udsl_vcc_data
)paren
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|vcc
op_assign
id|vcc
suffix:semicolon
r_new
op_member_access_from_pointer
id|vpi
op_assign
id|vpi
suffix:semicolon
r_new
op_member_access_from_pointer
id|vci
op_assign
id|vci
suffix:semicolon
multiline_comment|/* udsl_extract_cells requires at least one cell */
id|max_pdu
op_assign
id|max
(paren
l_int|1
comma
id|UDSL_NUM_CELLS
(paren
id|vcc-&gt;qos.rxtp.max_sdu
)paren
)paren
op_star
id|ATM_CELL_PAYLOAD
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
r_new
op_member_access_from_pointer
id|sarb
op_assign
id|alloc_skb
(paren
id|max_pdu
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_open: no memory for SAR buffer!&quot;
)paren
suffix:semicolon
id|kfree
(paren
r_new
)paren
suffix:semicolon
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|vcc-&gt;dev_data
op_assign
r_new
suffix:semicolon
id|tasklet_disable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|list_add
(paren
op_amp
r_new
op_member_access_from_pointer
id|list
comma
op_amp
id|instance-&gt;vcc_list
)paren
suffix:semicolon
id|tasklet_enable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|set_bit
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
id|tasklet_schedule
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_atm_open: allocated vcc data 0x%p (max_pdu: %u)&quot;
comma
r_new
comma
id|max_pdu
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udsl_atm_close
r_static
r_void
id|udsl_atm_close
(paren
r_struct
id|atm_vcc
op_star
id|vcc
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|vcc-&gt;dev-&gt;dev_data
suffix:semicolon
r_struct
id|udsl_vcc_data
op_star
id|vcc_data
op_assign
id|vcc-&gt;dev_data
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_atm_close called&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
op_logical_or
op_logical_neg
id|vcc_data
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_atm_close: NULL data!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;udsl_atm_close: deallocating vcc 0x%p with vpi %d vci %d&quot;
comma
id|vcc_data
comma
id|vcc_data-&gt;vpi
comma
id|vcc_data-&gt;vci
)paren
suffix:semicolon
id|udsl_cancel_send
(paren
id|instance
comma
id|vcc
)paren
suffix:semicolon
id|down
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
multiline_comment|/* vs self, udsl_atm_open */
id|tasklet_disable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|vcc_data-&gt;list
)paren
suffix:semicolon
id|tasklet_enable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
id|kfree_skb
(paren
id|vcc_data-&gt;sarb
)paren
suffix:semicolon
id|vcc_data-&gt;sarb
op_assign
l_int|NULL
suffix:semicolon
id|kfree
(paren
id|vcc_data
)paren
suffix:semicolon
id|vcc-&gt;dev_data
op_assign
l_int|NULL
suffix:semicolon
id|vcc-&gt;vpi
op_assign
id|ATM_VPI_UNSPEC
suffix:semicolon
id|vcc-&gt;vci
op_assign
id|ATM_VCI_UNSPEC
suffix:semicolon
id|clear_bit
(paren
id|ATM_VF_READY
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
(paren
id|ATM_VF_ADDR
comma
op_amp
id|vcc-&gt;flags
)paren
suffix:semicolon
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_atm_close successful&quot;
)paren
suffix:semicolon
)brace
DECL|function|udsl_atm_ioctl
r_static
r_int
id|udsl_atm_ioctl
(paren
r_struct
id|atm_dev
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ATM_QUERYLOOP
suffix:colon
r_return
id|put_user
(paren
id|ATM_LM_NONE
comma
(paren
r_int
id|__user
op_star
)paren
id|arg
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
multiline_comment|/**********&n;**  USB  **&n;**********/
DECL|function|udsl_set_alternate
r_static
r_int
id|udsl_set_alternate
(paren
r_struct
id|udsl_instance_data
op_star
id|instance
)paren
(brace
id|down
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
multiline_comment|/* vs self */
r_if
c_cond
(paren
op_logical_neg
id|instance-&gt;firmware_loaded
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_set_interface
(paren
id|instance-&gt;usb_dev
comma
l_int|1
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_set_alternate: usb_set_interface returned %d!&quot;
comma
id|ret
)paren
suffix:semicolon
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|instance-&gt;firmware_loaded
op_assign
l_int|1
suffix:semicolon
)brace
id|up
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
id|tasklet_schedule
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udsl_usb_ioctl
r_static
r_int
id|udsl_usb_ioctl
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_int
r_int
id|code
comma
r_void
op_star
id|user_data
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|usb_get_intfdata
(paren
id|intf
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_usb_ioctl entered&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_ioctl: NULL instance!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|UDSL_IOCTL_LINE_UP
suffix:colon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_FOUND
suffix:semicolon
r_return
id|udsl_set_alternate
(paren
id|instance
)paren
suffix:semicolon
r_case
id|UDSL_IOCTL_LINE_DOWN
suffix:colon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_LOST
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
)brace
DECL|function|udsl_usb_probe
r_static
r_int
id|udsl_usb_probe
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|interface_to_usbdev
c_func
(paren
id|intf
)paren
suffix:semicolon
r_int
id|ifnum
op_assign
id|intf-&gt;altsetting-&gt;desc.bInterfaceNumber
suffix:semicolon
r_struct
id|udsl_instance_data
op_star
id|instance
suffix:semicolon
r_int
r_char
id|mac_str
(braket
l_int|13
)braket
suffix:semicolon
r_int
id|i
comma
id|length
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_usb_probe: trying device with vendor=0x%x, product=0x%x, ifnum %d&quot;
comma
id|dev-&gt;descriptor.idVendor
comma
id|dev-&gt;descriptor.idProduct
comma
id|ifnum
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;descriptor.bDeviceClass
op_ne
id|USB_CLASS_VENDOR_SPEC
)paren
op_logical_or
(paren
id|dev-&gt;descriptor.idVendor
op_ne
id|SPEEDTOUCH_VENDORID
)paren
op_logical_or
(paren
id|dev-&gt;descriptor.idProduct
op_ne
id|SPEEDTOUCH_PRODUCTID
)paren
op_logical_or
(paren
id|ifnum
op_ne
l_int|1
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_usb_probe: device accepted&quot;
)paren
suffix:semicolon
multiline_comment|/* instance init */
r_if
c_cond
(paren
op_logical_neg
(paren
id|instance
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|udsl_instance_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_probe: no memory for instance data!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|instance
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|udsl_instance_data
)paren
)paren
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|instance-&gt;serialize
)paren
suffix:semicolon
id|instance-&gt;usb_dev
op_assign
id|dev
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;vcc_list
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|instance-&gt;receive_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;filled_receive_buffers
)paren
suffix:semicolon
id|tasklet_init
(paren
op_amp
id|instance-&gt;receive_tasklet
comma
id|udsl_process_receive
comma
(paren
r_int
r_int
)paren
id|instance
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_receive_buffers
)paren
suffix:semicolon
id|skb_queue_head_init
(paren
op_amp
id|instance-&gt;sndqueue
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|instance-&gt;send_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_send_buffers
)paren
suffix:semicolon
id|tasklet_init
(paren
op_amp
id|instance-&gt;send_tasklet
comma
id|udsl_process_send
comma
(paren
r_int
r_int
)paren
id|instance
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;filled_send_buffers
)paren
suffix:semicolon
multiline_comment|/* receive init */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_rcv_urbs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_receiver
op_star
id|rcv
op_assign
op_amp
(paren
id|instance-&gt;receivers
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rcv-&gt;urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_probe: no memory for receive urb %d!&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|rcv-&gt;instance
op_assign
id|instance
suffix:semicolon
id|list_add
(paren
op_amp
id|rcv-&gt;list
comma
op_amp
id|instance-&gt;spare_receivers
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_rcv_bufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_receive_buffer
op_star
id|buf
op_assign
op_amp
(paren
id|instance-&gt;receive_buffers
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf-&gt;base
op_assign
id|kmalloc
(paren
id|rcv_buf_size
op_star
id|ATM_CELL_SIZE
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_probe: no memory for receive buffer %d!&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|list_add
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;spare_receive_buffers
)paren
suffix:semicolon
)brace
multiline_comment|/* send init */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_snd_urbs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_sender
op_star
id|snd
op_assign
op_amp
(paren
id|instance-&gt;senders
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|snd-&gt;urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_probe: no memory for send urb %d!&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|snd-&gt;instance
op_assign
id|instance
suffix:semicolon
id|list_add
(paren
op_amp
id|snd-&gt;list
comma
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_snd_bufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|udsl_send_buffer
op_star
id|buf
op_assign
op_amp
(paren
id|instance-&gt;send_buffers
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf-&gt;base
op_assign
id|kmalloc
(paren
id|snd_buf_size
op_star
id|ATM_CELL_SIZE
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_probe: no memory for send buffer %d!&quot;
comma
id|i
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|list_add
(paren
op_amp
id|buf-&gt;list
comma
op_amp
id|instance-&gt;spare_send_buffers
)paren
suffix:semicolon
)brace
multiline_comment|/* ATM init */
r_if
c_cond
(paren
op_logical_neg
(paren
id|instance-&gt;atm_dev
op_assign
id|atm_dev_register
(paren
id|udsl_driver_name
comma
op_amp
id|udsl_atm_devops
comma
op_minus
l_int|1
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_probe: failed to register ATM device!&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|instance-&gt;atm_dev-&gt;ci_range.vpi_bits
op_assign
id|ATM_CI_MAX
suffix:semicolon
id|instance-&gt;atm_dev-&gt;ci_range.vci_bits
op_assign
id|ATM_CI_MAX
suffix:semicolon
id|instance-&gt;atm_dev-&gt;signal
op_assign
id|ATM_PHY_SIG_UNKNOWN
suffix:semicolon
multiline_comment|/* temp init ATM device, set to 128kbit */
id|instance-&gt;atm_dev-&gt;link_rate
op_assign
l_int|128
op_star
l_int|1000
op_div
l_int|424
suffix:semicolon
multiline_comment|/* set MAC address, it is stored in the serial number */
id|memset
(paren
id|instance-&gt;atm_dev-&gt;esi
comma
l_int|0
comma
r_sizeof
(paren
id|instance-&gt;atm_dev-&gt;esi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_string
(paren
id|dev
comma
id|dev-&gt;descriptor.iSerialNumber
comma
id|mac_str
comma
r_sizeof
(paren
id|mac_str
)paren
)paren
op_eq
l_int|12
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|instance-&gt;atm_dev-&gt;esi
(braket
id|i
)braket
op_assign
(paren
id|hex2int
(paren
id|mac_str
(braket
id|i
op_star
l_int|2
)braket
)paren
op_star
l_int|16
)paren
op_plus
(paren
id|hex2int
(paren
id|mac_str
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* device description */
id|buf
op_assign
id|instance-&gt;description
suffix:semicolon
id|length
op_assign
r_sizeof
(paren
id|instance-&gt;description
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|usb_string
(paren
id|dev
comma
id|dev-&gt;descriptor.iProduct
comma
id|buf
comma
id|length
)paren
)paren
OL
l_int|0
)paren
r_goto
id|finish
suffix:semicolon
id|buf
op_add_assign
id|i
suffix:semicolon
id|length
op_sub_assign
id|i
suffix:semicolon
id|i
op_assign
id|scnprintf
(paren
id|buf
comma
id|length
comma
l_string|&quot; (&quot;
)paren
suffix:semicolon
id|buf
op_add_assign
id|i
suffix:semicolon
id|length
op_sub_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|length
op_le
l_int|0
op_logical_or
(paren
id|i
op_assign
id|usb_make_path
(paren
id|dev
comma
id|buf
comma
id|length
)paren
)paren
OL
l_int|0
)paren
r_goto
id|finish
suffix:semicolon
id|buf
op_add_assign
id|i
suffix:semicolon
id|length
op_sub_assign
id|i
suffix:semicolon
id|snprintf
(paren
id|buf
comma
id|length
comma
l_string|&quot;)&quot;
)paren
suffix:semicolon
id|finish
suffix:colon
multiline_comment|/* ready for ATM callbacks */
id|wmb
(paren
)paren
suffix:semicolon
id|instance-&gt;atm_dev-&gt;dev_data
op_assign
id|instance
suffix:semicolon
id|usb_set_intfdata
(paren
id|intf
comma
id|instance
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_snd_bufs
suffix:semicolon
id|i
op_increment
)paren
id|kfree
(paren
id|instance-&gt;send_buffers
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_snd_urbs
suffix:semicolon
id|i
op_increment
)paren
id|usb_free_urb
(paren
id|instance-&gt;senders
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_rcv_bufs
suffix:semicolon
id|i
op_increment
)paren
id|kfree
(paren
id|instance-&gt;receive_buffers
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_rcv_urbs
suffix:semicolon
id|i
op_increment
)paren
id|usb_free_urb
(paren
id|instance-&gt;receivers
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
id|kfree
(paren
id|instance
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|udsl_usb_disconnect
r_static
r_void
id|udsl_usb_disconnect
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
(brace
r_struct
id|udsl_instance_data
op_star
id|instance
op_assign
id|usb_get_intfdata
(paren
id|intf
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dbg
(paren
l_string|&quot;udsl_usb_disconnect entered&quot;
)paren
suffix:semicolon
id|usb_set_intfdata
(paren
id|intf
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instance
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_disconnect: NULL instance!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* receive finalize */
id|tasklet_disable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_rcv_urbs
suffix:semicolon
id|i
op_increment
)paren
id|usb_kill_urb
(paren
id|instance-&gt;receivers
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
multiline_comment|/* no need to take the spinlock */
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;filled_receive_buffers
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_receive_buffers
)paren
suffix:semicolon
id|tasklet_enable
(paren
op_amp
id|instance-&gt;receive_tasklet
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_rcv_urbs
suffix:semicolon
id|i
op_increment
)paren
id|usb_free_urb
(paren
id|instance-&gt;receivers
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_rcv_bufs
suffix:semicolon
id|i
op_increment
)paren
id|kfree
(paren
id|instance-&gt;receive_buffers
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
multiline_comment|/* send finalize */
id|tasklet_disable
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_snd_urbs
suffix:semicolon
id|i
op_increment
)paren
id|usb_kill_urb
(paren
id|instance-&gt;senders
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
multiline_comment|/* no need to take the spinlock */
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_senders
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|instance-&gt;spare_send_buffers
)paren
suffix:semicolon
id|instance-&gt;current_buffer
op_assign
l_int|NULL
suffix:semicolon
id|tasklet_enable
(paren
op_amp
id|instance-&gt;send_tasklet
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_snd_urbs
suffix:semicolon
id|i
op_increment
)paren
id|usb_free_urb
(paren
id|instance-&gt;senders
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_snd_bufs
suffix:semicolon
id|i
op_increment
)paren
id|kfree
(paren
id|instance-&gt;send_buffers
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
id|wmb
(paren
)paren
suffix:semicolon
id|instance-&gt;usb_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* ATM finalize */
id|shutdown_atm_dev
(paren
id|instance-&gt;atm_dev
)paren
suffix:semicolon
multiline_comment|/* frees instance, kills tasklets */
)brace
multiline_comment|/***********&n;**  init  **&n;***********/
DECL|function|udsl_usb_init
r_static
r_int
id|__init
id|udsl_usb_init
(paren
r_void
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_init: driver version &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|udsl_control
)paren
OG
r_sizeof
(paren
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
l_int|0
)paren
op_member_access_from_pointer
id|cb
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|__FILE__
l_string|&quot;: unusable with this kernel!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|num_rcv_urbs
OG
id|UDSL_MAX_RCV_URBS
)paren
op_logical_or
(paren
id|num_snd_urbs
OG
id|UDSL_MAX_SND_URBS
)paren
op_logical_or
(paren
id|num_rcv_bufs
OG
id|UDSL_MAX_RCV_BUFS
)paren
op_logical_or
(paren
id|num_snd_bufs
OG
id|UDSL_MAX_SND_BUFS
)paren
op_logical_or
(paren
id|rcv_buf_size
OG
id|UDSL_MAX_RCV_BUF_SIZE
)paren
op_logical_or
(paren
id|snd_buf_size
OG
id|UDSL_MAX_SND_BUF_SIZE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|usb_register
(paren
op_amp
id|udsl_usb_driver
)paren
suffix:semicolon
)brace
DECL|function|udsl_usb_cleanup
r_static
r_void
id|__exit
id|udsl_usb_cleanup
(paren
r_void
)paren
(brace
id|dbg
(paren
l_string|&quot;udsl_usb_cleanup entered&quot;
)paren
suffix:semicolon
id|usb_deregister
(paren
op_amp
id|udsl_usb_driver
)paren
suffix:semicolon
)brace
DECL|variable|udsl_usb_init
id|module_init
(paren
id|udsl_usb_init
)paren
suffix:semicolon
DECL|variable|udsl_usb_cleanup
id|module_exit
(paren
id|udsl_usb_cleanup
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_VERSION
id|MODULE_VERSION
(paren
id|DRIVER_VERSION
)paren
suffix:semicolon
multiline_comment|/************&n;**  debug  **&n;************/
macro_line|#ifdef VERBOSE_DEBUG
DECL|function|udsl_print_packet
r_static
r_int
id|udsl_print_packet
(paren
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
r_char
id|buffer
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
)paren
(brace
id|buffer
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%.3d :&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
l_int|16
)paren
op_logical_and
(paren
id|i
OL
id|len
)paren
suffix:semicolon
id|j
op_increment
comma
id|i
op_increment
)paren
(brace
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%s %2.2x&quot;
comma
id|buffer
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
macro_line|#endif
eof
