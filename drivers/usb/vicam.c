multiline_comment|/* -*- linux-c -*-&n; * USB ViCAM driver&n; *&n; * Copyright (c) 2001 Christopher L Cheney (ccheney@cheney.cx)&n; * Copyright (c) 2001 Pavel Machek (pavel@suse.cz) sponsored by SuSE&n; *&n; *      This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License as&n; *      published by the Free Software Foundation; either version 2 of&n; *      the License, or (at your option) any later version.&n; *&n; * This driver is for the Vista Imaging ViCAM and 3Com HomeConnect USB&n; *&n; * Thanks to Greg Kroah-Hartman for the USB Skeleton driver&n; *&n; * TODO:&n; *&t;- find out the ids for the Vista Imaging ViCAM&n; *&n; * History:&n; *&n; * 2001_07_07 - 0.1 - christopher: first version&n; * 2001_08_28 - 0.2 - pavel: messed it up, but for some fun, try &n; &t;&t;&t;while true; do dd if=/dev/video of=/dev/fb0 bs=$[0x1e480] count=1 2&gt; /dev/null; done&n;&t;&t;      yep, moving pictures.&n; * 2001_08_29 - 0.3 - pavel: played a little bit more. Experimental mmap support. For some fun,&n; &t;&t;&t;get gqcam-0.9, compile it and run. Better than dd ;-).&n; * 2001_08_29 - 0.4 - pavel: added shutter speed control (not much functional)&n; &t;&t;&t;kill update_params if it does not seem to work for you.&n; * 2001_08_30 - 0.5 - pavel: fixed stupid bug with update_params &amp; vicam_bulk&n;&n; *&n; * FIXME: It crashes on rmmod with camera plugged.&n; */
DECL|macro|DEBUG
mdefine_line|#define DEBUG 1
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &quot;vicam.h&quot;
macro_line|#include &quot;vicamurbs.h&quot;
multiline_comment|/* Version Information */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v0&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Christopher L Cheney &lt;ccheney@cheney.cx&gt;, Pavel Machek &lt;pavel@suse.cz&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;USB ViCAM Driver&quot;
multiline_comment|/* Define these values to match your device */
DECL|macro|USB_VICAM_VENDOR_ID
mdefine_line|#define USB_VICAM_VENDOR_ID&t;0x04C1
DECL|macro|USB_VICAM_PRODUCT_ID
mdefine_line|#define USB_VICAM_PRODUCT_ID&t;0x009D
multiline_comment|/* table of devices that work with this driver */
DECL|variable|vicam_table
r_static
r_struct
id|usb_device_id
id|vicam_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VICAM_VENDOR_ID
comma
id|USB_VICAM_PRODUCT_ID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|vicam_table
)paren
suffix:semicolon
DECL|variable|video_nr
r_static
r_int
id|video_nr
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* next avail video device */
DECL|variable|vicam_driver
r_static
r_struct
id|usb_driver
id|vicam_driver
suffix:semicolon
DECL|variable|buf
DECL|variable|buf2
r_static
r_char
op_star
id|buf
comma
op_star
id|buf2
suffix:semicolon
DECL|variable|change_pending
r_static
r_volatile
r_int
id|change_pending
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|vicam_parameters
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
)paren
suffix:semicolon
multiline_comment|/******************************************************************************&n; *&n; *  Memory management functions&n; *&n; *  Taken from bttv-drivers.c 2.4.7-pre3&n; *&n; ******************************************************************************/
multiline_comment|/* [DaveM] I&squot;ve recoded most of this so that:&n; * 1) It&squot;s easier to tell what is happening&n; * 2) It&squot;s more portable, especially for translating things&n; *    out of vmalloc mapped areas in the kernel.&n; * 3) Less unnecessary translations happen.&n; *&n; * The code used to assume that the kernel vmalloc mappings&n; * existed in the page tables of every process, this is simply&n; * not guarenteed.  We now use pgd_offset_k which is the&n; * defined way to get at the kernel page tables.&n; */
multiline_comment|/* Given PGD from the address space&squot;s page table, return the kernel&n; * virtual mapping of the physical memory mapped at ADR.&n; */
DECL|function|uvirt_to_kva
r_static
r_inline
r_int
r_int
id|uvirt_to_kva
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|ret
op_assign
l_int|0UL
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
id|ret
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|uvirt_to_bus
r_static
r_inline
r_int
r_int
id|uvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|kva
comma
id|ret
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|adr
)paren
comma
id|adr
)paren
suffix:semicolon
id|ret
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|kva
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|kvirt_to_bus
r_static
r_inline
r_int
r_int
id|kvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|kva
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Here we want the physical address of the memory.&n; * This is used when initializing the contents of the&n; * area and marking the pages as reserved.&n; */
DECL|function|kvirt_to_pa
r_static
r_inline
r_int
r_int
id|kvirt_to_pa
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|__pa
c_func
(paren
id|kva
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
id|mem
op_assign
id|vmalloc_32
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; *  Foo Bar&n; *&n; ******************************************************************************/
multiline_comment|/**&n; *&t;usb_vicam_debug_data&n; */
DECL|function|usb_vicam_debug_data
r_static
r_inline
r_void
id|usb_vicam_debug_data
(paren
r_const
r_char
op_star
id|function
comma
r_int
id|size
comma
r_const
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|debug
)paren
r_return
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: %s - length = %d, data = &quot;
comma
id|function
comma
id|size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
op_increment
id|i
)paren
(brace
id|printk
(paren
l_string|&quot;%.2x &quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; *  Send command to vicam&n; *&n; *****************************************************************************/
DECL|function|vicam_sndctrl
r_static
r_int
id|vicam_sndctrl
c_func
(paren
r_int
id|set
comma
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_int
r_int
id|req
comma
r_int
r_int
id|value
comma
r_int
r_char
op_star
id|cp
comma
r_int
id|size
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
r_char
op_star
id|transfer_buffer
op_assign
id|kmalloc
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Needs to return data I think, works for sending though */
id|memcpy
c_func
(paren
id|transfer_buffer
comma
id|cp
comma
id|size
)paren
suffix:semicolon
id|ret
op_assign
id|usb_control_msg
(paren
id|vicam-&gt;udev
comma
id|set
ques
c_cond
id|usb_sndctrlpipe
c_func
(paren
id|vicam-&gt;udev
comma
l_int|0
)paren
suffix:colon
id|usb_rcvctrlpipe
c_func
(paren
id|vicam-&gt;udev
comma
l_int|0
)paren
comma
id|req
comma
(paren
id|set
ques
c_cond
id|USB_DIR_OUT
suffix:colon
id|USB_DIR_IN
)paren
op_or
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
id|value
comma
l_int|0
comma
id|transfer_buffer
comma
id|size
comma
id|HZ
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|transfer_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
l_string|&quot;vicam: error: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; *  Video4Linux Helpers&n; * &n; *****************************************************************************/
DECL|function|vicam_get_capability
r_static
r_int
id|vicam_get_capability
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_capability
op_star
id|b
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;vicam_get_capability&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|b-&gt;name
comma
id|vicam-&gt;camera_name
)paren
suffix:semicolon
id|b-&gt;type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_MONOCHROME
suffix:semicolon
id|b-&gt;channels
op_assign
l_int|1
suffix:semicolon
id|b-&gt;audios
op_assign
l_int|0
suffix:semicolon
id|b-&gt;maxwidth
op_assign
id|vicam-&gt;width
(braket
id|vicam-&gt;sizes
op_minus
l_int|1
)braket
suffix:semicolon
id|b-&gt;maxheight
op_assign
id|vicam-&gt;height
(braket
id|vicam-&gt;sizes
op_minus
l_int|1
)braket
suffix:semicolon
id|b-&gt;minwidth
op_assign
id|vicam-&gt;width
(braket
l_int|0
)braket
suffix:semicolon
id|b-&gt;minheight
op_assign
id|vicam-&gt;height
(braket
l_int|0
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vicam_get_channel
r_static
r_int
id|vicam_get_channel
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_channel
op_star
id|v
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;vicam_get_channel&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;channel
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|v-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tuners
op_assign
l_int|0
suffix:semicolon
id|v-&gt;type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|strcpy
c_func
(paren
id|v-&gt;name
comma
l_string|&quot;Camera&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vicam_set_channel
r_static
r_int
id|vicam_set_channel
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_channel
op_star
id|v
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;vicam_set_channel&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;channel
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vicam_get_mmapbuffer
r_static
r_int
id|vicam_get_mmapbuffer
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_mbuf
op_star
id|vm
)paren
(brace
r_int
id|i
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;vicam_get_mmapbuffer&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm-&gt;size
op_assign
id|VICAM_NUMFRAMES
op_star
id|vicam-&gt;maxframesize
suffix:semicolon
id|vm-&gt;frames
op_assign
id|VICAM_NUMFRAMES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VICAM_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
id|vm-&gt;offsets
(braket
id|i
)braket
op_assign
id|vicam-&gt;maxframesize
op_star
id|i
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vicam_get_picture
r_static
r_int
id|vicam_get_picture
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_picture
op_star
id|p
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;vicam_get_picture&quot;
)paren
suffix:semicolon
multiline_comment|/* This is probably where that weird 0x56 call goes */
id|p-&gt;brightness
op_assign
id|vicam-&gt;win.brightness
suffix:semicolon
id|p-&gt;hue
op_assign
id|vicam-&gt;win.hue
suffix:semicolon
id|p-&gt;colour
op_assign
id|vicam-&gt;win.colour
suffix:semicolon
id|p-&gt;contrast
op_assign
id|vicam-&gt;win.contrast
suffix:semicolon
id|p-&gt;whiteness
op_assign
id|vicam-&gt;win.whiteness
suffix:semicolon
id|p-&gt;depth
op_assign
id|vicam-&gt;win.depth
suffix:semicolon
id|p-&gt;palette
op_assign
id|vicam-&gt;win.palette
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|synchronize
r_static
r_void
id|synchronize
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|change_pending
op_assign
l_int|1
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|vicam-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|change_pending
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|vicam-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_CAMERA_POWER
comma
l_int|0x00
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_LED_CONTROL
comma
l_int|0x00
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
DECL|function|params_changed
r_static
r_void
id|params_changed
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
)paren
(brace
macro_line|#if 1
id|synchronize
c_func
(paren
id|vicam
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|vicam_parameters
c_func
(paren
id|vicam
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Submiting urb: %d&bslash;n&quot;
comma
id|usb_submit_urb
c_func
(paren
id|vicam-&gt;readurb
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|vicam_set_picture
r_static
r_int
id|vicam_set_picture
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_picture
op_star
id|p
)paren
(brace
r_int
id|changed
op_assign
l_int|0
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;vicam_set_picture (%d)&quot;
comma
id|p-&gt;brightness
)paren
suffix:semicolon
DECL|macro|SET
mdefine_line|#define SET(x) &bslash;&n;&t;if (vicam-&gt;win.x != p-&gt;x) &bslash;&n;&t;&t;vicam-&gt;win.x = p-&gt;x, changed = 1;
id|SET
c_func
(paren
id|brightness
)paren
suffix:semicolon
id|SET
c_func
(paren
id|hue
)paren
suffix:semicolon
id|SET
c_func
(paren
id|colour
)paren
suffix:semicolon
id|SET
c_func
(paren
id|contrast
)paren
suffix:semicolon
id|SET
c_func
(paren
id|whiteness
)paren
suffix:semicolon
id|SET
c_func
(paren
id|depth
)paren
suffix:semicolon
id|SET
c_func
(paren
id|palette
)paren
suffix:semicolon
r_if
c_cond
(paren
id|changed
)paren
id|params_changed
c_func
(paren
id|vicam
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Investigate what should be done maybe 0x56 type call */
r_if
c_cond
(paren
id|p-&gt;depth
op_ne
l_int|8
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;palette
op_ne
id|VIDEO_PALETTE_GREY
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME - vicam_sync_frame - important */
DECL|function|vicam_sync_frame
r_static
r_int
id|vicam_sync_frame
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_int
id|frame
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;vicam_sync_frame&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame
OL
l_int|0
op_logical_or
id|frame
op_ge
id|VICAM_NUMFRAMES
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Probably need to handle various cases */
multiline_comment|/*&t;ret=vicam_newframe(vicam, frame);&n;&t;vicam-&gt;frame[frame].grabstate=FRAME_UNUSED;&n;*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vicam_get_window
r_static
r_int
id|vicam_get_window
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_window
op_star
id|vw
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;vicam_get_window&quot;
)paren
suffix:semicolon
id|vw-&gt;x
op_assign
l_int|0
suffix:semicolon
id|vw-&gt;y
op_assign
l_int|0
suffix:semicolon
id|vw-&gt;chromakey
op_assign
l_int|0
suffix:semicolon
id|vw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|vw-&gt;clipcount
op_assign
l_int|0
suffix:semicolon
id|vw-&gt;width
op_assign
id|vicam-&gt;win.width
suffix:semicolon
id|vw-&gt;height
op_assign
id|vicam-&gt;win.height
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vicam_set_window
r_static
r_int
id|vicam_set_window
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_window
op_star
id|vw
)paren
(brace
id|info
c_func
(paren
l_string|&quot;vicam_set_window&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vw-&gt;flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw-&gt;clipcount
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vicam-&gt;win.width
op_eq
id|vw-&gt;width
op_logical_and
id|vicam-&gt;win.height
op_eq
id|vw-&gt;height
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Pick largest mode that is smaller than specified res */
multiline_comment|/* If specified res is too small reject                 */
multiline_comment|/* Add urb send to device... */
id|vicam-&gt;win.width
op_assign
id|vw-&gt;width
suffix:semicolon
id|vicam-&gt;win.height
op_assign
id|vw-&gt;height
suffix:semicolon
id|params_changed
c_func
(paren
id|vicam
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME - vicam_mmap_capture - important */
DECL|function|vicam_mmap_capture
r_static
r_int
id|vicam_mmap_capture
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
comma
r_struct
id|video_mmap
op_star
id|vm
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;vicam_mmap_capture&quot;
)paren
suffix:semicolon
multiline_comment|/* usbvideo.c looks good for using here */
multiline_comment|/* &n;&t;if (vm-&gt;frame &gt;= VICAM_NUMFRAMES)&n;&t;&t;return -EINVAL;&n;&t;if (vicam-&gt;frame[vm-&gt;frame].grabstate != FRAME_UNUSED)&n;&t;&t;return -EBUSY;&n;&t;vicam-&gt;frame[vm-&gt;frame].grabstate=FRAME_READY;&n;&t;*/
multiline_comment|/* No need to vicam_set_window here according to Alan */
multiline_comment|/*&n;&t;if (!vicam-&gt;streaming)&n;&t;&t;vicam_start_stream(vicam);&n;&t;*/
multiline_comment|/* set frame as ready */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; *  Video4Linux&n; * &n; *****************************************************************************/
DECL|function|vicam_v4l_open
r_static
r_int
id|vicam_v4l_open
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_int
id|flags
)paren
(brace
r_struct
id|usb_vicam
op_star
id|vicam
op_assign
(paren
r_struct
id|usb_vicam
op_star
)paren
id|vdev
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;vicam_v4l_open&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
id|vicam-&gt;fbuf
op_assign
id|rvmalloc
c_func
(paren
id|vicam-&gt;maxframesize
op_star
id|VICAM_NUMFRAMES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vicam-&gt;fbuf
)paren
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
id|vicam-&gt;open_count
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef BLINKING
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_CAMERA_POWER
comma
l_int|0x01
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|info
(paren
l_string|&quot;led on&quot;
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_LED_CONTROL
comma
l_int|0x01
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|up
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|vicam_v4l_close
r_static
r_void
id|vicam_v4l_close
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
)paren
(brace
r_struct
id|usb_vicam
op_star
id|vicam
op_assign
(paren
r_struct
id|usb_vicam
op_star
)paren
id|vdev
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;vicam_v4l_close&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
macro_line|#ifdef BLINKING
id|info
(paren
l_string|&quot;led off&quot;
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_LED_CONTROL
comma
l_int|0x00
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|//&t;vicam_sndctrl(1, vicam, VICAM_REQ_CAMERA_POWER, 0x00, NULL, 0); Leave it on
macro_line|#endif
id|rvfree
c_func
(paren
id|vicam-&gt;fbuf
comma
id|vicam-&gt;maxframesize
op_star
id|VICAM_NUMFRAMES
)paren
suffix:semicolon
id|vicam-&gt;fbuf
op_assign
l_int|0
suffix:semicolon
id|vicam-&gt;open_count
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
multiline_comment|/* Why does se401.c have a usbdevice check here? */
multiline_comment|/* If device is unplugged while open, I guess we only may unregister now */
)brace
DECL|function|vicam_v4l_read
r_static
r_int
id|vicam_v4l_read
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_char
op_star
id|user_buf
comma
r_int
r_int
id|buflen
comma
r_int
id|noblock
)paren
(brace
singleline_comment|//struct usb_vicam *vicam = (struct usb_vicam *)vdev;
id|dbg
c_func
(paren
l_string|&quot;vicam_v4l_read(%ld)&quot;
comma
id|buflen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vdev
op_logical_or
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user_buf
comma
id|buf2
comma
id|buflen
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|buflen
suffix:semicolon
)brace
DECL|function|vicam_v4l_write
r_static
r_int
id|vicam_v4l_write
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
id|info
c_func
(paren
l_string|&quot;vicam_v4l_write&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|vicam_v4l_ioctl
r_static
r_int
id|vicam_v4l_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|usb_vicam
op_star
id|vicam
op_assign
(paren
r_struct
id|usb_vicam
op_star
)paren
id|vdev
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EL3RST
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vicam-&gt;udev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|down
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|ret
op_assign
id|vicam_get_capability
c_func
(paren
id|vicam
comma
op_amp
id|b
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;name %s&quot;
comma
id|b.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|vb
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;vicam_v4l_ioctl - VIDIOCGBUF - query frame buffer param&quot;
)paren
suffix:semicolon
multiline_comment|/* frame buffer not supported, not used */
id|memset
c_func
(paren
op_amp
id|vb
comma
l_int|0
comma
r_sizeof
(paren
id|vb
)paren
)paren
suffix:semicolon
id|vb.base
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* FIXME - VIDIOCGFBUF - why the void */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vb
comma
r_sizeof
(paren
id|vb
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|ret
op_assign
id|vicam_get_window
c_func
(paren
id|vicam
comma
op_amp
id|vw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_else
id|ret
op_assign
id|vicam_set_window
c_func
(paren
id|vicam
comma
op_amp
id|vw
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_else
(brace
id|ret
op_assign
id|vicam_get_channel
c_func
(paren
id|vicam
comma
op_amp
id|v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_else
id|ret
op_assign
id|vicam_set_channel
c_func
(paren
id|vicam
comma
op_amp
id|v
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
id|ret
op_assign
id|vicam_get_picture
c_func
(paren
id|vicam
comma
op_amp
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_else
id|ret
op_assign
id|vicam_set_picture
c_func
(paren
id|vicam
comma
op_amp
id|p
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
id|ret
op_assign
id|vicam_get_mmapbuffer
c_func
(paren
id|vicam
comma
op_amp
id|vm
)paren
suffix:semicolon
multiline_comment|/* FIXME - VIDIOCGMBUF - why the void */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
id|ret
op_assign
id|vicam_mmap_capture
c_func
(paren
id|vicam
comma
op_amp
id|vm
)paren
suffix:semicolon
multiline_comment|/* FIXME: This is probably not right */
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|frame
suffix:semicolon
multiline_comment|/* FIXME - VIDIOCSYNC - why the void */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|frame
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_else
id|ret
op_assign
id|vicam_sync_frame
c_func
(paren
id|vicam
comma
id|frame
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
id|ret
op_assign
l_int|0
suffix:semicolon
r_case
id|VIDIOCCAPTURE
suffix:colon
r_case
id|VIDIOCSFBUF
suffix:colon
r_case
id|VIDIOCGTUNER
suffix:colon
r_case
id|VIDIOCSTUNER
suffix:colon
r_case
id|VIDIOCGFREQ
suffix:colon
r_case
id|VIDIOCSFREQ
suffix:colon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_case
id|VIDIOCGUNIT
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
(brace
)brace
(brace
id|info
c_func
(paren
l_string|&quot;vicam_v4l_ioctl - %ui&quot;
comma
id|cmd
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
multiline_comment|/* end switch */
id|up
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vicam_v4l_mmap
r_static
r_int
id|vicam_v4l_mmap
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|usb_vicam
op_star
id|vicam
op_assign
(paren
r_struct
id|usb_vicam
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
id|down
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vicam-&gt;udev
op_eq
l_int|NULL
)paren
(brace
id|up
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|size
OG
(paren
(paren
(paren
id|VICAM_NUMFRAMES
op_star
id|vicam-&gt;maxframesize
)paren
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
id|pos
op_assign
(paren
r_int
r_int
)paren
id|vicam-&gt;fbuf
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma
comma
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME - vicam_v4l_init */
DECL|function|vicam_v4l_init
r_static
r_int
id|vicam_v4l_init
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
multiline_comment|/* stick proc fs stuff in here if wanted */
id|dbg
c_func
(paren
l_string|&quot;vicam_v4l_init&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME - vicam_template - important */
DECL|variable|vicam_template
r_static
r_struct
id|video_device
id|vicam_template
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|name
suffix:colon
l_string|&quot;vicam USB camera&quot;
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
comma
id|hardware
suffix:colon
id|VID_HARDWARE_SE401
comma
multiline_comment|/* need to ask for own id */
id|open
suffix:colon
id|vicam_v4l_open
comma
id|close
suffix:colon
id|vicam_v4l_close
comma
id|read
suffix:colon
id|vicam_v4l_read
comma
id|write
suffix:colon
id|vicam_v4l_write
comma
id|ioctl
suffix:colon
id|vicam_v4l_ioctl
comma
id|mmap
suffix:colon
id|vicam_v4l_mmap
comma
id|initialize
suffix:colon
id|vicam_v4l_init
comma
)brace
suffix:semicolon
multiline_comment|/******************************************************************************&n; *&n; *  Some Routines&n; *&n; ******************************************************************************/
multiline_comment|/*&n;Flash the led&n;vicam_sndctrl(1, vicam, VICAM_REQ_CAMERA_POWER, 0x01, NULL, 0);&n;info (&quot;led on&quot;);&n;vicam_sndctrl(1, vicam, VICAM_REQ_LED_CONTROL, 0x01, NULL, 0);&n;info (&quot;led off&quot;);&n;vicam_sndctrl(1, vicam, VICAM_REQ_LED_CONTROL, 0x00, NULL, 0);&n;vicam_sndctrl(1, vicam, VICAM_REQ_CAMERA_POWER, 0x00, NULL, 0);&n;*/
DECL|function|vicam_bulk
r_static
r_void
id|vicam_bulk
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_vicam
op_star
id|vicam
op_assign
id|urb-&gt;context
suffix:semicolon
multiline_comment|/*&t;if (!vicam || !vicam-&gt;dev || !vicam-&gt;used)&n;&t;&t;return;&n;&t;*/
r_if
c_cond
(paren
id|urb-&gt;status
)paren
id|printk
c_func
(paren
l_string|&quot;vicam%d: nonzero read/write bulk status received: %d&quot;
comma
l_int|0
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;dev
op_assign
id|vicam-&gt;udev
suffix:semicolon
id|memcpy
c_func
(paren
id|buf2
comma
id|buf
op_plus
l_int|64
comma
l_int|0x1e480
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vicam-&gt;fbuf
)paren
id|memcpy
c_func
(paren
id|vicam-&gt;fbuf
comma
id|buf
op_plus
l_int|64
comma
l_int|0x1e480
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|change_pending
)paren
(brace
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
id|dbg
c_func
(paren
l_string|&quot;failed resubmitting read urb&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|change_pending
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|vicam-&gt;wait
)paren
suffix:semicolon
)brace
)brace
DECL|function|vicam_parameters
r_static
r_int
id|vicam_parameters
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
)paren
(brace
r_int
r_char
id|req
(braket
l_int|0x10
)braket
suffix:semicolon
r_int
r_int
id|shutter
suffix:semicolon
id|shutter
op_assign
l_int|10
suffix:semicolon
r_switch
c_cond
(paren
id|vicam-&gt;win.width
)paren
(brace
r_case
l_int|512
suffix:colon
r_default
suffix:colon
id|memcpy
c_func
(paren
id|req
comma
id|s512x242bw
comma
l_int|0x10
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|256
suffix:colon
id|memcpy
c_func
(paren
id|req
comma
id|s256x242bw
comma
l_int|0x10
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|128
suffix:colon
id|memcpy
c_func
(paren
id|req
comma
id|s128x122bw
comma
l_int|0x10
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_CAMERA_POWER
comma
l_int|0x01
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|info
(paren
l_string|&quot;led on&quot;
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_LED_CONTROL
comma
l_int|0x01
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|shutter
op_assign
id|vicam-&gt;win.contrast
op_div
l_int|256
suffix:semicolon
r_if
c_cond
(paren
id|shutter
op_eq
l_int|0
)paren
id|shutter
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;vicam_parameters: brightness %d, shutter %d&bslash;n&quot;
comma
id|vicam-&gt;win.brightness
comma
id|shutter
)paren
suffix:semicolon
id|req
(braket
l_int|0
)braket
op_assign
id|vicam-&gt;win.brightness
op_div
l_int|256
suffix:semicolon
id|shutter
op_assign
l_int|15600
op_div
id|shutter
op_minus
l_int|1
suffix:semicolon
id|req
(braket
l_int|6
)braket
op_assign
id|shutter
op_amp
l_int|0xff
suffix:semicolon
id|req
(braket
l_int|7
)braket
op_assign
(paren
id|shutter
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_CAPTURE
comma
l_int|0x80
comma
id|req
comma
l_int|0x10
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|0
comma
id|vicam
comma
id|VICAM_REQ_GET_SOMETHIN
comma
l_int|0
comma
id|buf
comma
l_int|0x10
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vicam_init
r_static
r_int
id|vicam_init
c_func
(paren
r_struct
id|usb_vicam
op_star
id|vicam
)paren
(brace
r_int
id|width
(braket
)braket
op_assign
(brace
l_int|128
comma
l_int|256
comma
l_int|512
)brace
suffix:semicolon
r_int
id|height
(braket
)braket
op_assign
(brace
l_int|122
comma
l_int|242
comma
l_int|242
)brace
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;vicam_init&quot;
)paren
suffix:semicolon
id|buf
op_assign
id|kmalloc
c_func
(paren
l_int|0x1e480
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|buf2
op_assign
id|kmalloc
c_func
(paren
l_int|0x1e480
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|buf
)paren
op_logical_or
(paren
op_logical_neg
id|buf2
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Not enough memory for vicam!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* do we do aspect correction in kernel or not? */
id|vicam-&gt;sizes
op_assign
l_int|3
suffix:semicolon
id|vicam-&gt;width
op_assign
id|kmalloc
c_func
(paren
id|vicam-&gt;sizes
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|vicam-&gt;height
op_assign
id|kmalloc
c_func
(paren
id|vicam-&gt;sizes
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|vicam-&gt;width
comma
op_amp
id|width
comma
r_sizeof
(paren
id|width
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|vicam-&gt;height
comma
op_amp
id|height
comma
r_sizeof
(paren
id|height
)paren
)paren
suffix:semicolon
id|vicam-&gt;maxframesize
op_assign
id|vicam-&gt;width
(braket
id|vicam-&gt;sizes
op_minus
l_int|1
)braket
op_star
id|vicam-&gt;height
(braket
id|vicam-&gt;sizes
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Download firmware to camera */
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_VENDOR
comma
l_int|0
comma
id|firmware1
comma
r_sizeof
(paren
id|firmware1
)paren
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_VENDOR
comma
l_int|0
comma
id|findex1
comma
r_sizeof
(paren
id|findex1
)paren
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_VENDOR
comma
l_int|0
comma
id|fsetup
comma
r_sizeof
(paren
id|fsetup
)paren
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_VENDOR
comma
l_int|0
comma
id|firmware2
comma
r_sizeof
(paren
id|firmware2
)paren
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_VENDOR
comma
l_int|0
comma
id|findex2
comma
r_sizeof
(paren
id|findex2
)paren
)paren
suffix:semicolon
id|vicam_sndctrl
c_func
(paren
l_int|1
comma
id|vicam
comma
id|VICAM_REQ_VENDOR
comma
l_int|0
comma
id|fsetup
comma
r_sizeof
(paren
id|fsetup
)paren
)paren
suffix:semicolon
id|vicam_parameters
c_func
(paren
id|vicam
)paren
suffix:semicolon
id|FILL_BULK_URB
c_func
(paren
id|vicam-&gt;readurb
comma
id|vicam-&gt;udev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|vicam-&gt;udev
comma
l_int|0x81
)paren
comma
id|buf
comma
l_int|0x1e480
comma
id|vicam_bulk
comma
id|vicam
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Submiting urb: %d&bslash;n&quot;
comma
id|usb_submit_urb
c_func
(paren
id|vicam-&gt;readurb
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|buf
)paren
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf2
)paren
id|kfree
c_func
(paren
id|buf2
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|vicam_probe
r_static
r_void
op_star
id|__devinit
id|vicam_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|udev
comma
r_int
r_int
id|ifnum
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_vicam
op_star
id|vicam
suffix:semicolon
r_char
op_star
id|camera_name
op_assign
l_int|NULL
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;vicam_probe&quot;
)paren
suffix:semicolon
multiline_comment|/* See if the device offered us matches what we can accept */
r_if
c_cond
(paren
(paren
id|udev-&gt;descriptor.idVendor
op_ne
id|USB_VICAM_VENDOR_ID
)paren
op_logical_or
(paren
id|udev-&gt;descriptor.idProduct
op_ne
id|USB_VICAM_PRODUCT_ID
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|camera_name
op_assign
l_string|&quot;3Com HomeConnect USB&quot;
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;ViCAM camera found: %s&quot;
comma
id|camera_name
)paren
suffix:semicolon
id|vicam
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|usb_vicam
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vicam
op_eq
l_int|NULL
)paren
(brace
id|err
(paren
l_string|&quot;couldn&squot;t kmalloc vicam struct&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|vicam
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|vicam
)paren
)paren
suffix:semicolon
id|vicam-&gt;readurb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vicam-&gt;readurb
)paren
(brace
id|kfree
c_func
(paren
id|vicam
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|vicam-&gt;udev
op_assign
id|udev
suffix:semicolon
id|vicam-&gt;camera_name
op_assign
id|camera_name
suffix:semicolon
id|vicam-&gt;win.brightness
op_assign
l_int|128
suffix:semicolon
id|vicam-&gt;win.contrast
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* FIXME */
r_if
c_cond
(paren
id|vicam_init
c_func
(paren
id|vicam
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|vicam-&gt;vdev
comma
op_amp
id|vicam_template
comma
r_sizeof
(paren
id|vicam_template
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|vicam-&gt;vdev.name
comma
id|vicam-&gt;camera_name
comma
id|strlen
c_func
(paren
id|vicam-&gt;camera_name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|vicam-&gt;vdev
comma
id|VFL_TYPE_GRABBER
comma
id|video_nr
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;video_register_device&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|info
c_func
(paren
l_string|&quot;registered new video device: video%d&quot;
comma
id|vicam-&gt;vdev.minor
)paren
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|vicam-&gt;sem
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|vicam-&gt;wait
)paren
suffix:semicolon
r_return
id|vicam
suffix:semicolon
)brace
multiline_comment|/* FIXME - vicam_disconnect - important */
DECL|function|vicam_disconnect
r_static
r_void
id|vicam_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|udev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|usb_vicam
op_star
id|vicam
suffix:semicolon
id|vicam
op_assign
(paren
r_struct
id|usb_vicam
op_star
)paren
id|ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vicam-&gt;open_count
)paren
id|video_unregister_device
c_func
(paren
op_amp
id|vicam-&gt;vdev
)paren
suffix:semicolon
id|vicam-&gt;udev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;vicam-&gt;frame[0].grabstate = FRAME_ERROR;&n;&t;vicam-&gt;frame[1].grabstate = FRAME_ERROR;&n;*/
multiline_comment|/* Free buffers and shit */
id|info
c_func
(paren
l_string|&quot;%s disconnected&quot;
comma
id|vicam-&gt;camera_name
)paren
suffix:semicolon
id|synchronize
c_func
(paren
id|vicam
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vicam-&gt;open_count
)paren
(brace
multiline_comment|/* Other random junk */
id|usb_free_urb
c_func
(paren
id|vicam-&gt;readurb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|vicam
)paren
suffix:semicolon
id|vicam
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* usb specific object needed to register this driver with the usb subsystem */
DECL|variable|vicam_driver
r_static
r_struct
id|usb_driver
id|vicam_driver
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|name
suffix:colon
l_string|&quot;vicam&quot;
comma
id|probe
suffix:colon
id|vicam_probe
comma
id|disconnect
suffix:colon
id|vicam_disconnect
comma
id|id_table
suffix:colon
id|vicam_table
comma
)brace
suffix:semicolon
multiline_comment|/******************************************************************************&n; *&n; *  Module Routines&n; *&n; ******************************************************************************/
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Module paramaters */
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug enabled or not&quot;
)paren
suffix:semicolon
DECL|function|usb_vicam_init
r_static
r_int
id|__init
id|usb_vicam_init
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VICAM: initializing&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* register this driver with the USB subsystem */
id|result
op_assign
id|usb_register
c_func
(paren
op_amp
id|vicam_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;usb_register failed for the &quot;
id|__FILE__
l_string|&quot; driver. Error number %d&quot;
comma
id|result
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|info
c_func
(paren
id|DRIVER_VERSION
l_string|&quot; &quot;
id|DRIVER_AUTHOR
)paren
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_vicam_exit
r_static
r_void
id|__exit
id|usb_vicam_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* deregister this driver with the USB subsystem */
id|usb_deregister
c_func
(paren
op_amp
id|vicam_driver
)paren
suffix:semicolon
)brace
DECL|variable|usb_vicam_init
id|module_init
c_func
(paren
id|usb_vicam_init
)paren
suffix:semicolon
DECL|variable|usb_vicam_exit
id|module_exit
c_func
(paren
id|usb_vicam_exit
)paren
suffix:semicolon
eof
