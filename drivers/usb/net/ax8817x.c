multiline_comment|/*&n; * ASIX AX8817x USB 2.0 10/100/HomePNA Ethernet controller driver&n; *&n; * $Id: ax8817x.c,v 1.11 2003/06/15 19:00:02 dhollis Exp $&n; *&n; * Copyright (c) 2002-2003 TiVo Inc.&n; *&n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; * History &n; *&n; *&t;2003-06-15 - Dave Hollis &lt;dhollis@davehollis.com&gt;  2.0.0&n; *&t;&t;* Remove crc32 inline function, use core kernel instead&n; *&t;&t;* Set sane defaults for rx_buffers&n; *&t;&t;* Fix ethtool GETDRVINFO bits - use strlcpy and&n; *&t;&t;  usb_make_path&n; *&n; *&t;2003-06-05 - Dave Hollis &lt;dhollis@davehollis.com&gt;  0.10.0&n; *&t;&t;* Port to 2.5 series kernels&n; *&t;&t;* Remove #if 0 blocks that are confirmed&n; *&t;&t;  unnecessary&n; *&t;&t;* Re-did tx routines based off pegasus driver.&n; *&t;&t;  This resolved hard crashes and greatly simplified&n; *&t;&t;  things.&n; *&t;&t;* Redo mii/ethtool routines&n; *&n; *&t;2003-05-31 - Dave Hollis &lt;dhollis@davehollis.com&gt;  0.9.8&n; *&t;&t;* Don&squot;t stop/start the queue in start_xmit&n; *&t;&t;* Swallow URB status upon hard removal&n; *&t;&t;* Cleanup remaining comments (kill // style)&n; *&n; *&t;2003-05-29 - Dave Hollis &lt;dhollis@davehollis.com&gt;  0.9.7&n; *&t;&t;* Set module owner&n; *&t;&t;* Follow-up on suggestions from David Brownell &amp;&n; *&t;&t;  Oliver Neukum which should help with robustness&n; *&t;&t;* Use ether_crc from stock kernel if available&n; *&n; *&t;2003-05-28 - Dave Hollis &lt;dhollis@davehollis.com&gt;  0.9.6&n; *&t;&t;* Added basic ethtool &amp; mii support&n; *&n; *&t;2003-05-28 - Dave Hollis &lt;dhollis@davehollis.com&gt;  0.9.5&n; *&t;&t;* Workout devrequest change to usb_ctrlrequest structure&n; *&t;&t;* Replace FILL_BULK_URB macros to non-deprecated &n; *&t;&t;  usb_fill_bulk_urb macros&n; *&t;&t;* Replace printks with equivalent macros&n; *&t;&t;* Use defines for module description, version, author to&n; *&t;&t;  simplify future changes&n; *&n; * Known Issues&n; *&n; * Todo&n; *&t;Fix mii/ethtool output&n;*/
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/version.h&gt;
multiline_comment|/* Version Information */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v2.0.0&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;TiVo, Inc.&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;ASIX AX8817x USB Ethernet driver&quot;
DECL|macro|DRIVER_NAME
mdefine_line|#define DRIVER_NAME &quot;ax8817x&quot;
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|AX_REQ_READ
mdefine_line|#define AX_REQ_READ         ( USB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE )
DECL|macro|AX_REQ_WRITE
mdefine_line|#define AX_REQ_WRITE        ( USB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE )
DECL|macro|AX_CMD_SET_SW_MII
mdefine_line|#define AX_CMD_SET_SW_MII           0x06
DECL|macro|AX_CMD_READ_MII_REG
mdefine_line|#define AX_CMD_READ_MII_REG         0x07
DECL|macro|AX_CMD_WRITE_MII_REG
mdefine_line|#define AX_CMD_WRITE_MII_REG        0x08
DECL|macro|AX_CMD_SET_HW_MII
mdefine_line|#define AX_CMD_SET_HW_MII           0x0a
DECL|macro|AX_CMD_WRITE_RX_CTL
mdefine_line|#define AX_CMD_WRITE_RX_CTL         0x10
DECL|macro|AX_CMD_WRITE_MULTI_FILTER
mdefine_line|#define AX_CMD_WRITE_MULTI_FILTER   0x16
DECL|macro|AX_CMD_READ_NODE_ID
mdefine_line|#define AX_CMD_READ_NODE_ID         0x17
DECL|macro|AX_CMD_READ_PHY_ID
mdefine_line|#define AX_CMD_READ_PHY_ID          0x19
DECL|macro|AX_CMD_WRITE_MEDIUM_MODE
mdefine_line|#define AX_CMD_WRITE_MEDIUM_MODE    0x1b
DECL|macro|AX_CMD_WRITE_GPIOS
mdefine_line|#define AX_CMD_WRITE_GPIOS          0x1f
DECL|macro|AX_RX_MAX
mdefine_line|#define AX_RX_MAX                   ETH_FRAME_LEN
DECL|macro|AX_TIMEOUT_CMD
mdefine_line|#define AX_TIMEOUT_CMD              ( HZ / 10 )
DECL|macro|AX_TIMEOUT_TX
mdefine_line|#define AX_TIMEOUT_TX               ( HZ * 2 )
DECL|macro|AX_MAX_MCAST
mdefine_line|#define AX_MAX_MCAST                64
DECL|macro|AX_DRV_STATE_INITIALIZING
mdefine_line|#define AX_DRV_STATE_INITIALIZING   0x00
DECL|macro|AX_DRV_STATE_RUNNING
mdefine_line|#define AX_DRV_STATE_RUNNING        0x01
DECL|macro|AX_DRV_STATE_EXITING
mdefine_line|#define AX_DRV_STATE_EXITING        0x02
DECL|macro|AX_PHY_STATE_INITIALIZING
mdefine_line|#define AX_PHY_STATE_INITIALIZING   0x00
DECL|macro|AX_PHY_STATE_NO_LINK
mdefine_line|#define AX_PHY_STATE_NO_LINK        0x01
DECL|macro|AX_PHY_STATE_POLLING_1
mdefine_line|#define AX_PHY_STATE_POLLING_1      0x02
DECL|macro|AX_PHY_STATE_POLLING_2
mdefine_line|#define AX_PHY_STATE_POLLING_2      0x03
DECL|macro|AX_PHY_STATE_POLLING_3
mdefine_line|#define AX_PHY_STATE_POLLING_3      0x04
DECL|macro|AX_PHY_STATE_POLLING_4
mdefine_line|#define AX_PHY_STATE_POLLING_4      0x05
DECL|macro|AX_PHY_STATE_SETTING_MAC
mdefine_line|#define AX_PHY_STATE_SETTING_MAC    0x06
DECL|macro|AX_PHY_STATE_LINK
mdefine_line|#define AX_PHY_STATE_LINK           0x07
DECL|macro|AX_PHY_STATE_ABORT_POLL
mdefine_line|#define AX_PHY_STATE_ABORT_POLL     0x08
DECL|macro|AX_PHY_STATE_ABORTING
mdefine_line|#define AX_PHY_STATE_ABORTING       0x09
DECL|macro|AX_MAX_PHY_RETRY
mdefine_line|#define AX_MAX_PHY_RETRY            50
DECL|macro|AX_RX_URBS_DEFAULT
mdefine_line|#define AX_RX_URBS_DEFAULT&t;    2
DECL|variable|n_rx_urbs
r_static
r_int
id|n_rx_urbs
op_assign
id|AX_RX_URBS_DEFAULT
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|n_rx_urbs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|n_rx_urbs
comma
l_string|&quot;Number of rx buffers to queue at once (def 2)&quot;
)paren
suffix:semicolon
r_struct
id|ax8817x_info
suffix:semicolon
r_struct
id|ax_cmd_req
suffix:semicolon
DECL|typedef|ax_cmd_callback_t
r_typedef
r_int
(paren
op_star
id|ax_cmd_callback_t
)paren
(paren
r_struct
id|ax8817x_info
op_star
comma
r_struct
id|ax_cmd_req
op_star
)paren
suffix:semicolon
DECL|struct|ax_cmd_req
r_struct
id|ax_cmd_req
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|cmd_callback
id|ax_cmd_callback_t
id|cmd_callback
suffix:semicolon
DECL|member|priv
r_void
op_star
id|priv
suffix:semicolon
DECL|member|status
r_int
id|status
suffix:semicolon
DECL|member|data
r_void
op_star
id|data
suffix:semicolon
DECL|member|data_size
r_int
id|data_size
suffix:semicolon
DECL|member|timeout
r_int
id|timeout
suffix:semicolon
DECL|member|devreq
r_struct
id|usb_ctrlrequest
id|devreq
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ax8817x_info
r_struct
id|ax8817x_info
(brace
DECL|member|usb
r_struct
id|usb_device
op_star
id|usb
suffix:semicolon
DECL|member|net
r_struct
id|net_device
op_star
id|net
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|mii
r_struct
id|mii_if_info
id|mii
suffix:semicolon
DECL|member|rx_urbs
r_struct
id|urb
op_star
op_star
id|rx_urbs
suffix:semicolon
DECL|member|int_urb
r_struct
id|urb
op_star
id|int_urb
suffix:semicolon
DECL|member|tx_urb
r_struct
id|urb
op_star
id|tx_urb
suffix:semicolon
DECL|member|int_buf
id|u8
op_star
id|int_buf
suffix:semicolon
DECL|member|ctl_urb
r_struct
id|urb
op_star
id|ctl_urb
suffix:semicolon
DECL|member|ctl_queue
r_struct
id|list_head
id|ctl_queue
suffix:semicolon
DECL|member|ctl_lock
id|spinlock_t
id|ctl_lock
suffix:semicolon
DECL|member|rx_refill_cnt
id|atomic_t
id|rx_refill_cnt
suffix:semicolon
DECL|member|phy_req
r_struct
id|ax_cmd_req
id|phy_req
suffix:semicolon
DECL|member|phy_id
id|u8
id|phy_id
suffix:semicolon
DECL|member|phy_state
id|u8
id|phy_state
suffix:semicolon
DECL|member|drv_state
id|u8
id|drv_state
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_const
r_struct
id|usb_device_id
id|ax8817x_id_table
(braket
)braket
id|__devinitdata
op_assign
(brace
multiline_comment|/* Linksys USB200M */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x077b
comma
l_int|0x2226
)paren
comma
id|driver_info
suffix:colon
l_int|0x00130103
)brace
comma
multiline_comment|/* Hawking UF200, TRENDnet TU2-ET100 */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x07b8
comma
l_int|0x420a
)paren
comma
id|driver_info
suffix:colon
l_int|0x001f1d1f
)brace
comma
multiline_comment|/* NETGEAR FA120 */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x0846
comma
l_int|0x1040
)paren
comma
id|driver_info
suffix:colon
l_int|0x00130103
)brace
comma
multiline_comment|/* D-Link DUB-E100 */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x2001
comma
l_int|0x1a00
)paren
comma
id|driver_info
suffix:colon
l_int|0x009f9d9f
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|usb
comma
id|ax8817x_id_table
)paren
suffix:semicolon
r_static
r_void
id|ax_run_ctl_queue
c_func
(paren
r_struct
id|ax8817x_info
op_star
comma
r_struct
id|ax_cmd_req
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ax_rx_callback
c_func
(paren
r_struct
id|urb
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|function|ax_ctl_callback
r_static
r_void
id|ax_ctl_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
(paren
r_struct
id|ax8817x_info
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|ax_run_ctl_queue
c_func
(paren
id|ax_info
comma
l_int|NULL
comma
id|urb-&gt;status
ques
c_cond
id|urb-&gt;status
suffix:colon
id|urb-&gt;actual_length
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Queue a new ctl request, or dequeue the first in the list&n;*/
DECL|function|ax_run_ctl_queue
r_static
r_void
id|ax_run_ctl_queue
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
r_struct
id|ax_cmd_req
op_star
id|req
comma
r_int
id|status
)paren
(brace
r_struct
id|ax_cmd_req
op_star
id|next_req
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ax_cmd_req
op_star
id|last_req
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Need to lock around queue list manipulation */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ax_info-&gt;ctl_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
id|last_req
op_assign
id|list_entry
c_func
(paren
id|ax_info-&gt;ctl_queue.next
comma
r_struct
id|ax_cmd_req
comma
id|list
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ax_info-&gt;ctl_queue
)paren
)paren
(brace
id|next_req
op_assign
id|req
suffix:semicolon
)brace
id|req-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|ax_info-&gt;ctl_queue
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|last_req
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* dequeue completed entry */
id|list_del
c_func
(paren
op_amp
id|last_req-&gt;list
)paren
suffix:semicolon
id|last_req-&gt;status
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
id|last_req
op_member_access_from_pointer
id|cmd_callback
c_func
(paren
id|ax_info
comma
id|last_req
)paren
)paren
(brace
multiline_comment|/* requeue if told to do so */
id|last_req-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|last_req-&gt;list
comma
op_amp
id|ax_info-&gt;ctl_queue
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ax_info-&gt;ctl_queue
)paren
)paren
(brace
id|next_req
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|next_req
op_assign
id|list_entry
c_func
(paren
id|ax_info-&gt;ctl_queue.next
comma
r_struct
id|ax_cmd_req
comma
id|list
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ax_info-&gt;ctl_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_req
op_eq
l_int|NULL
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* XXX: do something with timeout */
id|usb_fill_control_urb
c_func
(paren
id|ax_info-&gt;ctl_urb
comma
id|ax_info-&gt;usb
comma
id|next_req-&gt;devreq
dot
id|bRequestType
op_amp
id|USB_DIR_IN
ques
c_cond
id|usb_rcvctrlpipe
c_func
(paren
id|ax_info-&gt;usb
comma
l_int|0
)paren
suffix:colon
id|usb_sndctrlpipe
c_func
(paren
id|ax_info-&gt;usb
comma
l_int|0
)paren
comma
(paren
r_void
op_star
)paren
op_amp
id|next_req-&gt;devreq
comma
id|next_req-&gt;data
comma
id|next_req-&gt;data_size
comma
id|ax_ctl_callback
comma
id|ax_info
)paren
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|ax_info-&gt;ctl_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ge
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|last_req
op_assign
id|next_req
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ax_info-&gt;ctl_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|ax_sync_cmd_callback
r_static
r_int
id|ax_sync_cmd_callback
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|unused
comma
r_struct
id|ax_cmd_req
op_star
id|req
)paren
(brace
id|wait_queue_head_t
op_star
id|wq
op_assign
(paren
id|wait_queue_head_t
op_star
)paren
id|req-&gt;priv
suffix:semicolon
id|wake_up
c_func
(paren
id|wq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ax_async_cmd_callback
r_static
r_int
id|ax_async_cmd_callback
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|unused
comma
r_struct
id|ax_cmd_req
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;status
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Async command %d failed: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|req-&gt;devreq.bRequest
comma
id|req-&gt;status
)paren
suffix:semicolon
)brace
multiline_comment|/* Nothing else to do here, just need to free the request (and its&n;&t;   allocated data) */
r_if
c_cond
(paren
id|req-&gt;data
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|req-&gt;data
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This is mostly the same as usb_control_msg(), except that it is able&n; * to queue control messages&n;*/
DECL|function|ax_control_msg
r_static
r_int
id|ax_control_msg
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
id|u8
id|requesttype
comma
id|u8
id|request
comma
id|u16
id|value
comma
id|u16
id|index
comma
r_void
op_star
id|data
comma
id|u16
id|size
comma
r_int
id|timeout
)paren
(brace
r_struct
id|ax_cmd_req
op_star
id|req
suffix:semicolon
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|wq
)paren
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|req
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ax_cmd_req
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|req-&gt;devreq.bRequestType
op_assign
id|requesttype
suffix:semicolon
id|req-&gt;devreq.bRequest
op_assign
id|request
suffix:semicolon
id|req-&gt;devreq.wValue
op_assign
id|cpu_to_le16
c_func
(paren
id|value
)paren
suffix:semicolon
id|req-&gt;devreq.wIndex
op_assign
id|cpu_to_le16
c_func
(paren
id|index
)paren
suffix:semicolon
id|req-&gt;devreq.wLength
op_assign
id|cpu_to_le16
c_func
(paren
id|size
)paren
suffix:semicolon
id|req-&gt;data
op_assign
id|data
suffix:semicolon
id|req-&gt;data_size
op_assign
id|size
suffix:semicolon
id|req-&gt;timeout
op_assign
id|timeout
suffix:semicolon
id|req-&gt;priv
op_assign
op_amp
id|wq
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|req-&gt;cmd_callback
op_assign
id|ax_sync_cmd_callback
suffix:semicolon
id|ax_run_ctl_queue
c_func
(paren
id|ax_info
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|req-&gt;status
suffix:semicolon
id|kfree
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Same, but can be used asynchronously, may fail, and returns no exit&n; * status&n;*/
DECL|function|ax_control_msg_async
r_static
r_void
id|ax_control_msg_async
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
id|u8
id|requesttype
comma
id|u8
id|request
comma
id|u16
id|value
comma
id|u16
id|index
comma
r_void
op_star
id|data
comma
id|u16
id|size
comma
r_int
id|timeout
)paren
(brace
r_struct
id|ax_cmd_req
op_star
id|req
suffix:semicolon
id|req
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ax_cmd_req
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* There&squot;s not much else we can do here... */
id|err
c_func
(paren
l_string|&quot;%s: Failed alloc&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|req-&gt;devreq.bRequestType
op_assign
id|requesttype
suffix:semicolon
id|req-&gt;devreq.bRequest
op_assign
id|request
suffix:semicolon
id|req-&gt;devreq.wValue
op_assign
id|cpu_to_le16
c_func
(paren
id|value
)paren
suffix:semicolon
id|req-&gt;devreq.wIndex
op_assign
id|cpu_to_le16
c_func
(paren
id|index
)paren
suffix:semicolon
id|req-&gt;devreq.wLength
op_assign
id|cpu_to_le16
c_func
(paren
id|size
)paren
suffix:semicolon
id|req-&gt;data
op_assign
id|data
suffix:semicolon
id|req-&gt;data_size
op_assign
id|size
suffix:semicolon
id|req-&gt;timeout
op_assign
id|timeout
suffix:semicolon
id|req-&gt;cmd_callback
op_assign
id|ax_async_cmd_callback
suffix:semicolon
id|ax_run_ctl_queue
c_func
(paren
id|ax_info
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ax_read_cmd
r_static
r_inline
r_int
id|ax_read_cmd
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
id|u8
id|cmd
comma
id|u16
id|value
comma
id|u16
id|index
comma
id|u16
id|size
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|ax_control_msg
c_func
(paren
id|ax_info
comma
id|AX_REQ_READ
comma
id|cmd
comma
id|value
comma
id|index
comma
id|data
comma
id|size
comma
id|AX_TIMEOUT_CMD
)paren
suffix:semicolon
)brace
DECL|function|ax_write_cmd
r_static
r_inline
r_int
id|ax_write_cmd
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
id|u8
id|cmd
comma
id|u16
id|value
comma
id|u16
id|index
comma
id|u16
id|size
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|ax_control_msg
c_func
(paren
id|ax_info
comma
id|AX_REQ_WRITE
comma
id|cmd
comma
id|value
comma
id|index
comma
id|data
comma
id|size
comma
id|AX_TIMEOUT_CMD
)paren
suffix:semicolon
)brace
DECL|function|ax_write_cmd_async
r_static
r_inline
r_void
id|ax_write_cmd_async
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
id|u8
id|cmd
comma
id|u16
id|value
comma
id|u16
id|index
comma
id|u16
id|size
comma
r_void
op_star
id|data
)paren
(brace
id|ax_control_msg_async
c_func
(paren
id|ax_info
comma
id|AX_REQ_WRITE
comma
id|cmd
comma
id|value
comma
id|index
comma
id|data
comma
id|size
comma
id|AX_TIMEOUT_CMD
)paren
suffix:semicolon
)brace
DECL|function|ax_refill_rx_urb
r_static
r_int
id|ax_refill_rx_urb
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|AX_RX_MAX
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* for IP header alignment */
id|skb-&gt;dev
op_assign
id|ax_info-&gt;net
suffix:semicolon
id|usb_fill_bulk_urb
c_func
(paren
id|urb
comma
id|ax_info-&gt;usb
comma
id|usb_rcvbulkpipe
c_func
(paren
id|ax_info-&gt;usb
comma
l_int|3
)paren
comma
id|skb-&gt;data
comma
id|AX_RX_MAX
comma
id|ax_rx_callback
comma
id|skb
)paren
suffix:semicolon
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed submit rx URB (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|urb-&gt;context
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* this just means we&squot;re low on memory at the moment. Try to&n;&t;&t;   handle it gracefully. */
id|urb-&gt;context
op_assign
l_int|NULL
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ax_phy_cmd_callback
r_static
r_int
id|ax_phy_cmd_callback
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
r_struct
id|ax_cmd_req
op_star
id|req
)paren
(brace
r_int
id|full_duplex
suffix:semicolon
r_int
id|flow_control
suffix:semicolon
id|u16
id|mii_data_le
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;status
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Failed at state %d: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ax_info-&gt;phy_state
comma
id|req-&gt;status
)paren
suffix:semicolon
multiline_comment|/* Not sure what else we can do, so just bail */
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_ABORTING
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ax_info-&gt;phy_state
)paren
(brace
multiline_comment|/* Now that we&squot;re in software MII mode, read the BMSR */
r_case
id|AX_PHY_STATE_POLLING_1
suffix:colon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_POLLING_2
suffix:semicolon
id|req-&gt;devreq.bRequestType
op_assign
id|AX_REQ_READ
suffix:semicolon
id|req-&gt;devreq.bRequest
op_assign
id|AX_CMD_READ_MII_REG
suffix:semicolon
id|req-&gt;devreq.wValue
op_assign
id|cpu_to_le16
c_func
(paren
id|ax_info-&gt;phy_id
)paren
suffix:semicolon
id|req-&gt;devreq.wIndex
op_assign
id|cpu_to_le16
c_func
(paren
id|MII_BMSR
)paren
suffix:semicolon
id|req-&gt;devreq.wLength
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|req-&gt;data_size
op_assign
l_int|2
suffix:semicolon
id|req-&gt;priv
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This is the retry count */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Done reading BMSR */
r_case
id|AX_PHY_STATE_POLLING_2
suffix:colon
id|mii_data_le
op_assign
op_star
(paren
id|u16
op_star
)paren
id|req-&gt;data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mii_data_le
op_amp
id|cpu_to_le16
c_func
(paren
id|BMSR_LSTATUS
op_or
id|BMSR_ANEGCAPABLE
)paren
)paren
op_eq
id|cpu_to_le16
c_func
(paren
id|BMSR_LSTATUS
op_or
id|BMSR_ANEGCAPABLE
)paren
)paren
(brace
r_if
c_cond
(paren
id|mii_data_le
op_amp
id|cpu_to_le16
c_func
(paren
id|BMSR_ANEGCOMPLETE
)paren
)paren
(brace
multiline_comment|/* Autonegotiation done, go on to read LPA */
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_POLLING_3
suffix:semicolon
id|req-&gt;devreq.wIndex
op_assign
id|cpu_to_le16
c_func
(paren
id|MII_LPA
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
r_int
)paren
id|req-&gt;priv
op_increment
OL
id|AX_MAX_PHY_RETRY
)paren
(brace
multiline_comment|/* Reread BMSR if it&squot;s still autonegotiating. This is&n;&t;&t;&t;&t;   probably unnecessary logic, I&squot;ve never seen it take&n;&t;&t;&t;&t;   more than 1 try... */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* else fall through to abort */
)brace
multiline_comment|/* XXX: should probably handle auto-neg failure better,&n;&t;&t;   by reverting to manual setting of something safe. (?) */
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_ABORT_POLL
suffix:semicolon
multiline_comment|/* and then fall through to set hw MII */
multiline_comment|/* Got what we needed from PHY, set back to hardware MII mode&n;&t;&t;   (Do same for abort in mid-poll) */
r_case
id|AX_PHY_STATE_POLLING_3
suffix:colon
r_case
id|AX_PHY_STATE_ABORT_POLL
suffix:colon
id|ax_info-&gt;phy_state
op_add_assign
l_int|1
suffix:semicolon
id|req-&gt;devreq.bRequestType
op_assign
id|AX_REQ_WRITE
suffix:semicolon
id|req-&gt;devreq.bRequest
op_assign
id|AX_CMD_SET_HW_MII
suffix:semicolon
id|req-&gt;devreq.wValue
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|req-&gt;devreq.wIndex
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|req-&gt;devreq.wLength
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|req-&gt;data_size
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* The end result, set the right duplex and flow control mode in the&n;&t;&t;   MAC (based on the PHY&squot;s LPA reg, which should still be in the data&n;&t;&t;   buffer) */
r_case
id|AX_PHY_STATE_POLLING_4
suffix:colon
id|mii_data_le
op_assign
op_star
(paren
id|u16
op_star
)paren
id|req-&gt;data
suffix:semicolon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_SETTING_MAC
suffix:semicolon
id|req-&gt;devreq.bRequest
op_assign
id|AX_CMD_WRITE_MEDIUM_MODE
suffix:semicolon
id|full_duplex
op_assign
id|mii_data_le
op_amp
id|cpu_to_le16
c_func
(paren
id|LPA_DUPLEX
)paren
suffix:semicolon
id|flow_control
op_assign
id|full_duplex
op_logical_and
(paren
id|mii_data_le
op_amp
id|cpu_to_le16
c_func
(paren
l_int|0x0400
)paren
)paren
suffix:semicolon
id|req-&gt;devreq.wValue
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0x04
)paren
op_or
(paren
id|full_duplex
ques
c_cond
id|cpu_to_le16
c_func
(paren
l_int|0x02
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
id|flow_control
ques
c_cond
id|cpu_to_le16
c_func
(paren
l_int|0x10
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;%s: Link established, %s duplex, flow control %sabled&bslash;n&quot;
comma
id|ax_info-&gt;net-&gt;name
comma
id|full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
comma
id|flow_control
ques
c_cond
l_string|&quot;en&quot;
suffix:colon
l_string|&quot;dis&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* All done */
r_case
id|AX_PHY_STATE_SETTING_MAC
suffix:colon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_LINK
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|ax_info-&gt;net
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;%s: Unknown state %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ax_info-&gt;phy_state
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|AX_PHY_STATE_ABORTING
suffix:colon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_NO_LINK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ax_int_callback
r_static
r_void
id|ax_int_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
(paren
r_struct
id|ax8817x_info
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|u8
id|phy_link
suffix:semicolon
r_if
c_cond
(paren
id|ax_info-&gt;drv_state
op_eq
id|AX_DRV_STATE_EXITING
op_logical_or
id|urb-&gt;actual_length
OL
l_int|3
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Ignore the first PHY link report, it will sometimes be reported as&n;&t;   link active, even though we just told the PHY to reset. If it&n;&t;   really has link, we&squot;ll pick it up next int callback.&n;&t; */
r_if
c_cond
(paren
id|ax_info-&gt;phy_state
op_eq
id|AX_PHY_STATE_INITIALIZING
)paren
(brace
id|netif_carrier_off
c_func
(paren
id|ax_info-&gt;net
)paren
suffix:semicolon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_NO_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Assume we&squot;re only interested in the primary PHY for now. */
id|phy_link
op_assign
id|ax_info-&gt;int_buf
(braket
l_int|2
)braket
op_amp
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|phy_link
op_eq
(paren
id|ax_info-&gt;phy_state
op_eq
id|AX_PHY_STATE_NO_LINK
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
(brace
multiline_comment|/* Common case, no change */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|phy_link
op_eq
l_int|0
)paren
(brace
id|netif_carrier_off
c_func
(paren
id|ax_info-&gt;net
)paren
suffix:semicolon
multiline_comment|/* Abort an in-progress poll of the PHY if necessary */
r_switch
c_cond
(paren
id|ax_info-&gt;phy_state
)paren
(brace
r_case
id|AX_PHY_STATE_POLLING_1
suffix:colon
r_case
id|AX_PHY_STATE_POLLING_2
suffix:colon
r_case
id|AX_PHY_STATE_POLLING_3
suffix:colon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_ABORT_POLL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AX_PHY_STATE_POLLING_4
suffix:colon
r_case
id|AX_PHY_STATE_SETTING_MAC
suffix:colon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_ABORTING
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AX_PHY_STATE_LINK
suffix:colon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_NO_LINK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* If we&squot;re already aborting, continue aborting */
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Note that we only fall into this case if previous phy_state was&n;&t;&t;   AX_PHY_STATE_NO_LINK. When the link is reported active while&n;&t;&t;   we&squot;re still polling, or when we&squot;re aborting, the logic above&n;&t;&t;   will just return, and we&squot;ll check again next int callback. */
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_POLLING_1
suffix:semicolon
id|ax_info-&gt;phy_req.devreq.bRequestType
op_assign
id|AX_REQ_WRITE
suffix:semicolon
id|ax_info-&gt;phy_req.devreq.bRequest
op_assign
id|AX_CMD_SET_SW_MII
suffix:semicolon
id|ax_info-&gt;phy_req.devreq.wValue
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ax_info-&gt;phy_req.devreq.wIndex
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ax_info-&gt;phy_req.devreq.wLength
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ax_info-&gt;phy_req.data_size
op_assign
l_int|0
suffix:semicolon
id|ax_info-&gt;phy_req.timeout
op_assign
id|AX_TIMEOUT_CMD
suffix:semicolon
id|ax_info-&gt;phy_req.cmd_callback
op_assign
id|ax_phy_cmd_callback
suffix:semicolon
id|ax_run_ctl_queue
c_func
(paren
id|ax_info
comma
op_amp
id|ax_info-&gt;phy_req
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|ax_rx_callback
r_static
r_void
id|ax_rx_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|net_device
op_star
id|net
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
(paren
r_struct
id|ax8817x_info
op_star
)paren
id|net-&gt;priv
suffix:semicolon
r_int
id|ret
comma
id|len
comma
id|refill
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;%s: URB status %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
multiline_comment|/* It&squot;s not clear that we can do much in this case, the rx pipe&n;&t;&t;   doesn&squot;t ever seem to stall, so if we got -ETIMEDOUT, that&n;&t;&t;   usually means the device was unplugged, and we just haven&squot;t&n;&t;&t;   noticed yet.&n;&t;&t;   Just fall through and free skb without resubmitting urb. */
r_case
op_minus
id|ENOENT
suffix:colon
multiline_comment|/* */
r_case
op_minus
id|ECONNRESET
suffix:colon
multiline_comment|/* Async unlink */
r_case
op_minus
id|ESHUTDOWN
suffix:colon
multiline_comment|/* Hardware gone */
r_case
op_minus
id|EILSEQ
suffix:colon
multiline_comment|/* Get this when you yank it out on UHCI */
r_case
op_minus
id|ETIMEDOUT
suffix:colon
multiline_comment|/* OHCI */
r_case
op_minus
id|EPROTO
suffix:colon
multiline_comment|/* EHCI */
r_case
op_minus
id|EPIPE
suffix:colon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|urb-&gt;context
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ax_info-&gt;drv_state
op_eq
id|AX_DRV_STATE_INITIALIZING
)paren
(brace
multiline_comment|/* Not really expecting this to ever happen, since we haven&squot;t yet&n;&t;&t;   enabled receive in the rx_ctl register, but ya never know... */
r_goto
id|refill_same
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ax_info-&gt;drv_state
op_eq
id|AX_DRV_STATE_EXITING
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|urb-&gt;context
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
id|len
op_assign
id|urb-&gt;actual_length
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
multiline_comment|/* this shouldn&squot;t happen... */
r_goto
id|refill_same
suffix:semicolon
)brace
id|refill
op_assign
id|ax_refill_rx_urb
c_func
(paren
id|ax_info
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|refill
op_eq
l_int|0
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|ax_info-&gt;rx_refill_cnt
)paren
OL
id|n_rx_urbs
)paren
(brace
multiline_comment|/* Send the receive buffer up the network stack */
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|net
)paren
suffix:semicolon
id|net-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|ax_info-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|ax_info-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|refill
op_eq
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* This is the common case. This URB got refilled OK, and&n;&t;&t;&t;   no other URBs need to be refilled. */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ax_info-&gt;rx_refill_cnt
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n_rx_urbs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|ax_info-&gt;rx_urbs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;context
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|ax_refill_rx_urb
c_func
(paren
id|ax_info
comma
id|urb
)paren
op_eq
l_int|0
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|ax_info
op_member_access_from_pointer
id|rx_refill_cnt
)paren
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* remember to refill this one later */
id|atomic_inc
c_func
(paren
op_amp
id|ax_info-&gt;rx_refill_cnt
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_else
(brace
id|ax_info-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|refill
OL
l_int|0
)paren
(brace
multiline_comment|/* the error code was already printk&squot;ed in ax_refill_rx_urb()&n;&t;&t;&t;   so just note the consequences here: */
id|warn
c_func
(paren
l_string|&quot;Halting rx due to error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* fall through to resubmit this URB with the existing skb&n;&t;&t;   will try to reallocate skb&squot;s on next rx callback */
)brace
id|refill_same
suffix:colon
id|usb_fill_bulk_urb
c_func
(paren
id|urb
comma
id|ax_info-&gt;usb
comma
id|usb_rcvbulkpipe
c_func
(paren
id|ax_info-&gt;usb
comma
l_int|3
)paren
comma
id|skb-&gt;data
comma
id|AX_RX_MAX
comma
id|ax_rx_callback
comma
id|skb
)paren
suffix:semicolon
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed submit rx URB (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
)brace
DECL|function|ax8817x_open
r_static
r_int
id|ax8817x_open
c_func
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
(paren
r_struct
id|ax8817x_info
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|u8
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_RX_CTL
comma
l_int|0x80
comma
l_int|0
comma
l_int|0
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|ax_info-&gt;tx_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ax_info-&gt;tx_urb
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error allocating tx_urb!&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|ax_info-&gt;rx_refill_cnt
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n_rx_urbs
op_logical_and
id|ret
op_eq
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|ax_info-&gt;rx_urbs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|urb
op_eq
l_int|NULL
)paren
(brace
id|urb
op_assign
id|ax_info-&gt;rx_urbs
(braket
id|i
)braket
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n_rx_urbs
OG
l_int|1
)paren
(brace
id|urb-&gt;transfer_flags
op_or_assign
id|URB_NO_INTERRUPT
suffix:semicolon
multiline_comment|/* FIXME: Was USB_QUEUE_BULK */
)brace
)brace
id|ret
op_assign
id|ax_refill_rx_urb
c_func
(paren
id|ax_info
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|1
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|ax_info-&gt;rx_refill_cnt
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* XXX: should handle the case where we couldn&squot;t allocate any skb&squot;s&n;&t;   better. They get allocated with GFP_ATOMIC, so they may all fail... */
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|ax_info-&gt;rx_refill_cnt
)paren
OL
id|n_rx_urbs
)paren
(brace
id|netif_start_queue
c_func
(paren
id|net
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Error: clean up anything we allocated and bail. */
id|usb_free_urb
c_func
(paren
id|ax_info-&gt;tx_urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n_rx_urbs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|ax_info-&gt;rx_urbs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|urb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* skb gets freed in the URB callback */
id|usb_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
id|err
c_func
(paren
l_string|&quot;%s: Failed start rx queue (%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ret
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ax8817x_stop
r_static
r_int
id|ax8817x_stop
c_func
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
(paren
r_struct
id|ax8817x_info
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|u8
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|net
)paren
suffix:semicolon
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_RX_CTL
comma
l_int|0x80
comma
l_int|0
comma
l_int|0
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
op_logical_and
id|ax_info-&gt;drv_state
op_ne
id|AX_DRV_STATE_EXITING
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Failed cmd (%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ret
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ax_info-&gt;tx_urb
op_ne
l_int|NULL
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|ax_info-&gt;tx_urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ax_info-&gt;tx_urb
)paren
suffix:semicolon
id|ax_info-&gt;tx_urb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n_rx_urbs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|ax_info-&gt;rx_urbs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|urb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* skb gets freed in the URB callback */
id|usb_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|ax_info-&gt;rx_urbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|write_bulk_callback
r_static
r_void
id|write_bulk_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ax_info
op_logical_or
(paren
id|ax_info-&gt;drv_state
op_eq
id|AX_DRV_STATE_EXITING
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_device_present
c_func
(paren
id|ax_info-&gt;net
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
id|info
c_func
(paren
l_string|&quot;%s: TX status %d&quot;
comma
id|ax_info-&gt;net-&gt;name
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|ax_info-&gt;net-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|ax_info-&gt;net
)paren
suffix:semicolon
)brace
DECL|function|ax8817x_start_xmit
r_static
r_int
id|ax8817x_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
id|net-&gt;priv
suffix:semicolon
r_int
id|res
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|net
)paren
suffix:semicolon
id|ax_info-&gt;tx_urb-&gt;transfer_flags
op_or_assign
id|URB_ZERO_PACKET
suffix:semicolon
id|usb_fill_bulk_urb
c_func
(paren
id|ax_info-&gt;tx_urb
comma
id|ax_info-&gt;usb
comma
id|usb_sndbulkpipe
c_func
(paren
id|ax_info-&gt;usb
comma
l_int|2
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|write_bulk_callback
comma
id|ax_info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|usb_submit_urb
c_func
(paren
id|ax_info-&gt;tx_urb
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Failed tx_urb %d&quot;
comma
id|res
)paren
suffix:semicolon
id|ax_info-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|net
)paren
suffix:semicolon
)brace
r_else
(brace
id|ax_info-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|ax_info-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|net-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ax8817x_tx_timeout
r_static
r_void
id|ax8817x_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
id|net-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ax_info
)paren
r_return
suffix:semicolon
id|warn
c_func
(paren
l_string|&quot;%s: Tx timed out.&quot;
comma
id|net-&gt;name
)paren
suffix:semicolon
id|ax_info-&gt;tx_urb-&gt;transfer_flags
op_or_assign
id|URB_ASYNC_UNLINK
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|ax_info-&gt;tx_urb
)paren
suffix:semicolon
id|ax_info-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
DECL|function|ax8817x_stats
r_static
r_struct
id|net_device_stats
op_star
id|ax8817x_stats
c_func
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
(paren
r_struct
id|ax8817x_info
op_star
)paren
id|net-&gt;priv
suffix:semicolon
r_return
op_amp
id|ax_info-&gt;stats
suffix:semicolon
)brace
DECL|function|ax8817x_set_multicast
r_static
r_void
id|ax8817x_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
(paren
r_struct
id|ax8817x_info
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|u8
id|rx_ctl
op_assign
l_int|0x8c
suffix:semicolon
r_if
c_cond
(paren
id|net-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|rx_ctl
op_or_assign
l_int|0x01
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|net-&gt;flags
op_amp
id|IFF_ALLMULTI
op_logical_or
id|net-&gt;mc_count
OG
id|AX_MAX_MCAST
)paren
(brace
id|rx_ctl
op_or_assign
l_int|0x02
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|net-&gt;mc_count
op_eq
l_int|0
)paren
(brace
multiline_comment|/* just broadcast and directed */
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|mc_list
op_assign
id|net-&gt;mc_list
suffix:semicolon
id|u8
op_star
id|multi_filter
suffix:semicolon
id|u32
id|crc_bits
suffix:semicolon
r_int
id|i
suffix:semicolon
id|multi_filter
op_assign
id|kmalloc
c_func
(paren
l_int|8
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|multi_filter
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Oops, couldn&squot;t allocate a DMA buffer for setting the multicast&n;&t;&t;&t;   filter. Try all multi mode, although the ax_write_cmd_async&n;&t;&t;&t;   will almost certainly fail, too... (but it will printk). */
id|rx_ctl
op_or_assign
l_int|0x02
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|multi_filter
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Build the multicast hash filter. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|net-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|crc_bits
op_assign
id|ether_crc
c_func
(paren
id|ETH_ALEN
comma
id|mc_list-&gt;dmi_addr
)paren
op_rshift
l_int|26
suffix:semicolon
id|multi_filter
(braket
id|crc_bits
op_rshift
l_int|3
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc_bits
op_amp
l_int|7
)paren
suffix:semicolon
id|mc_list
op_assign
id|mc_list-&gt;next
suffix:semicolon
)brace
id|ax_write_cmd_async
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_MULTI_FILTER
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
id|multi_filter
)paren
suffix:semicolon
id|rx_ctl
op_or_assign
l_int|0x10
suffix:semicolon
)brace
)brace
id|ax_write_cmd_async
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_RX_CTL
comma
id|rx_ctl
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|read_mii_word
r_static
r_int
id|read_mii_word
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
id|__u8
id|phy
comma
id|__u8
id|indx
comma
id|__u16
op_star
id|regd
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_SET_SW_MII
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|ret
op_assign
id|ax_read_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_READ_MII_REG
comma
id|phy
comma
id|indx
comma
l_int|2
comma
id|regd
)paren
suffix:semicolon
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_SET_HW_MII
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|write_mii_word
r_static
r_int
id|write_mii_word
c_func
(paren
r_struct
id|ax8817x_info
op_star
id|ax_info
comma
id|__u8
id|phy
comma
id|__u8
id|indx
comma
id|__u16
id|regd
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;write_mii_word - not implemented!&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|loc
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|res
suffix:semicolon
id|read_mii_word
c_func
(paren
id|ax_info
comma
id|phy_id
comma
id|loc
comma
(paren
id|u16
op_star
)paren
op_amp
id|res
)paren
suffix:semicolon
r_return
id|res
op_amp
l_int|0xffff
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|loc
comma
r_int
id|val
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
id|dev-&gt;priv
suffix:semicolon
id|write_mii_word
c_func
(paren
id|ax_info
comma
id|phy_id
comma
id|loc
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|ax8817x_ethtool_ioctl
r_static
r_int
id|ax8817x_ethtool_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|net
comma
r_void
id|__user
op_star
id|uaddr
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
suffix:semicolon
r_int
id|cmd
suffix:semicolon
id|ax_info
op_assign
id|net-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|cmd
comma
(paren
r_int
op_star
)paren
id|uaddr
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
r_struct
id|ethtool_drvinfo
id|info
op_assign
(brace
id|ETHTOOL_GDRVINFO
)brace
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.driver
comma
id|DRIVER_NAME
comma
id|ETHTOOL_BUSINFO_LEN
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.version
comma
id|DRIVER_VERSION
comma
id|ETHTOOL_BUSINFO_LEN
)paren
suffix:semicolon
id|usb_make_path
c_func
(paren
id|ax_info-&gt;usb
comma
id|info.bus_info
comma
r_sizeof
id|info.bus_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|uaddr
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ETHTOOL_GSET
suffix:colon
(brace
r_struct
id|ethtool_cmd
id|ecmd
suffix:semicolon
id|mii_ethtool_gset
c_func
(paren
op_amp
id|ax_info-&gt;mii
comma
op_amp
id|ecmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|uaddr
comma
op_amp
id|ecmd
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ETHTOOL_SSET
suffix:colon
(brace
r_int
id|r
suffix:semicolon
r_struct
id|ethtool_cmd
id|ecmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ecmd
comma
id|uaddr
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|r
op_assign
id|mii_ethtool_sset
c_func
(paren
op_amp
id|ax_info-&gt;mii
comma
op_amp
id|ecmd
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
r_case
id|ETHTOOL_NWAY_RST
suffix:colon
(brace
r_return
id|mii_nway_restart
c_func
(paren
op_amp
id|ax_info-&gt;mii
)paren
suffix:semicolon
)brace
r_case
id|ETHTOOL_GLINK
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GLINK
)brace
suffix:semicolon
id|edata.data
op_assign
id|ax_info-&gt;phy_state
op_eq
id|AX_PHY_STATE_LINK
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|uaddr
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ETHTOOL_GMSGLVL
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|ETHTOOL_GMSGLVL
)brace
suffix:semicolon
multiline_comment|/* edata.data = ax_info-&gt;msg_enable; FIXME */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|uaddr
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ETHTOOL_SMSGLVL
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|edata
comma
id|uaddr
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* sp-&gt;msg_enable = edata.data;  FIXME */
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|ax8817x_mii_ioctl
r_static
r_int
id|ax8817x_mii_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|net
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
suffix:semicolon
r_struct
id|mii_ioctl_data
op_star
id|data_ptr
op_assign
(paren
r_struct
id|mii_ioctl_data
op_star
)paren
op_amp
(paren
id|ifr-&gt;ifr_data
)paren
suffix:semicolon
id|ax_info
op_assign
id|net-&gt;priv
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGMIIPHY
suffix:colon
id|data_ptr-&gt;phy_id
op_assign
id|ax_info-&gt;phy_id
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGMIIREG
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|ax_read_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_READ_MII_REG
comma
l_int|0
comma
id|data_ptr-&gt;reg_num
op_amp
l_int|0x1f
comma
l_int|2
comma
op_amp
(paren
id|data_ptr-&gt;val_out
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ax8817x_ioctl
r_static
r_int
id|ax8817x_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|net
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
suffix:semicolon
r_int
id|res
suffix:semicolon
id|ax_info
op_assign
id|net-&gt;priv
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
id|res
op_assign
id|ax8817x_ethtool_ioctl
c_func
(paren
id|net
comma
(paren
r_void
id|__user
op_star
)paren
id|ifr-&gt;ifr_data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGMIIPHY
suffix:colon
multiline_comment|/* Get address of PHY in use */
r_case
id|SIOCGMIIREG
suffix:colon
multiline_comment|/* Read from MII PHY register */
r_case
id|SIOCSMIIREG
suffix:colon
multiline_comment|/* Write to MII PHY register */
r_return
id|ax8817x_mii_ioctl
c_func
(paren
id|net
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
r_default
suffix:colon
id|res
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|ax8817x_net_init
r_static
r_int
id|ax8817x_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|net
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
(paren
r_struct
id|ax8817x_info
op_star
)paren
id|net-&gt;priv
suffix:semicolon
id|u8
id|buf
(braket
l_int|6
)braket
suffix:semicolon
id|u16
op_star
id|buf16
op_assign
(paren
id|u16
op_star
)paren
id|buf
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_RX_CTL
comma
l_int|0x80
comma
l_int|0
comma
l_int|0
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Get the MAC address */
id|ret
op_assign
id|ax_read_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_READ_NODE_ID
comma
l_int|0
comma
l_int|0
comma
l_int|6
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|net-&gt;dev_addr
comma
id|buf
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Get the PHY id */
id|ret
op_assign
id|ax_read_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_READ_PHY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
OL
l_int|2
)paren
(brace
multiline_comment|/* this should always return 2 bytes */
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Reset the PHY, and drop it into auto-negotiation mode */
id|ax_info-&gt;phy_id
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
id|ax_info-&gt;phy_state
op_assign
id|AX_PHY_STATE_INITIALIZING
suffix:semicolon
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_SET_SW_MII
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
op_star
id|buf16
op_assign
id|cpu_to_le16
c_func
(paren
id|BMCR_RESET
)paren
suffix:semicolon
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_MII_REG
comma
id|ax_info-&gt;phy_id
comma
id|MII_BMCR
comma
l_int|2
comma
id|buf16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Advertise that we can do full-duplex pause */
op_star
id|buf16
op_assign
id|cpu_to_le16
c_func
(paren
id|ADVERTISE_ALL
op_or
id|ADVERTISE_CSMA
op_or
l_int|0x0400
)paren
suffix:semicolon
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_MII_REG
comma
id|ax_info-&gt;phy_id
comma
id|MII_ADVERTISE
comma
l_int|2
comma
id|buf16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
op_star
id|buf16
op_assign
id|cpu_to_le16
c_func
(paren
id|BMCR_ANENABLE
op_or
id|BMCR_ANRESTART
)paren
suffix:semicolon
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_MII_REG
comma
id|ax_info-&gt;phy_id
comma
id|MII_BMCR
comma
l_int|2
comma
id|buf16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_SET_HW_MII
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|net-&gt;open
op_assign
id|ax8817x_open
suffix:semicolon
id|net-&gt;stop
op_assign
id|ax8817x_stop
suffix:semicolon
id|net-&gt;hard_start_xmit
op_assign
id|ax8817x_start_xmit
suffix:semicolon
id|net-&gt;tx_timeout
op_assign
id|ax8817x_tx_timeout
suffix:semicolon
id|net-&gt;watchdog_timeo
op_assign
id|AX_TIMEOUT_TX
suffix:semicolon
id|net-&gt;get_stats
op_assign
id|ax8817x_stats
suffix:semicolon
id|net-&gt;do_ioctl
op_assign
id|ax8817x_ioctl
suffix:semicolon
id|net-&gt;set_multicast_list
op_assign
id|ax8817x_set_multicast
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ax8817x_bind
r_static
r_int
id|ax8817x_bind
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_device
op_star
id|usb
op_assign
id|interface_to_usbdev
c_func
(paren
id|intf
)paren
suffix:semicolon
r_struct
id|ax8817x_info
op_star
id|ax_info
suffix:semicolon
r_struct
id|net_device
op_star
id|net
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
r_int
r_int
id|gpio_bits
op_assign
id|id-&gt;driver_info
suffix:semicolon
id|u8
id|buf
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Allocate the URB lists along with the device info struct */
id|ax_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ax8817x_info
)paren
op_plus
id|n_rx_urbs
op_star
r_sizeof
(paren
r_struct
id|urb
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ax_info
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Failed ax alloc&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|exit_err
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ax_info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ax8817x_info
)paren
op_plus
id|n_rx_urbs
op_star
r_sizeof
(paren
r_struct
id|urb
op_star
)paren
)paren
suffix:semicolon
id|ax_info-&gt;drv_state
op_assign
id|AX_DRV_STATE_INITIALIZING
suffix:semicolon
id|ax_info-&gt;rx_urbs
op_assign
(paren
r_struct
id|urb
op_star
op_star
)paren
(paren
id|ax_info
op_plus
l_int|1
)paren
suffix:semicolon
id|ax_info-&gt;usb
op_assign
id|usb
suffix:semicolon
multiline_comment|/* Set up the control URB queue */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ax_info-&gt;ctl_queue
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ax_info-&gt;ctl_lock
)paren
suffix:semicolon
id|ax_info-&gt;ctl_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ax_info-&gt;ctl_urb
op_eq
l_int|NULL
)paren
(brace
r_goto
id|exit_err_free_ax
suffix:semicolon
)brace
multiline_comment|/* Toggle the GPIOs in a manufacturer/model specific way */
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|ret
op_assign
id|ax_write_cmd
c_func
(paren
id|ax_info
comma
id|AX_CMD_WRITE_GPIOS
comma
(paren
id|gpio_bits
op_rshift
(paren
id|i
op_star
l_int|8
)paren
)paren
op_amp
l_int|0xff
comma
l_int|0
comma
l_int|0
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_goto
id|exit_err_free_ax
suffix:semicolon
)brace
id|wait_ms
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up the net device */
id|net
op_assign
id|alloc_etherdev
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Failed net alloc&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|exit_err_free_ax
suffix:semicolon
)brace
id|ax_info-&gt;net
op_assign
id|net
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|net
)paren
suffix:semicolon
id|net-&gt;init
op_assign
id|ax8817x_net_init
suffix:semicolon
id|net-&gt;priv
op_assign
id|ax_info
suffix:semicolon
id|ret
op_assign
id|register_netdev
c_func
(paren
id|net
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Failed net init (%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ret
)paren
suffix:semicolon
r_goto
id|exit_err_free_net
suffix:semicolon
)brace
multiline_comment|/* Setup mii structure */
id|ax_info-&gt;mii.dev
op_assign
id|net
suffix:semicolon
id|ax_info-&gt;mii.mdio_read
op_assign
id|mdio_read
suffix:semicolon
id|ax_info-&gt;mii.mdio_write
op_assign
id|mdio_write
suffix:semicolon
id|ax_info-&gt;mii.phy_id_mask
op_assign
l_int|0x1f
suffix:semicolon
id|ax_info-&gt;mii.reg_num_mask
op_assign
l_int|0x1f
suffix:semicolon
multiline_comment|/* Set up the interrupt URB, and start PHY state monitoring */
id|ax_info-&gt;int_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ax_info-&gt;int_urb
op_eq
l_int|NULL
)paren
(brace
r_goto
id|exit_err_unregister_net
suffix:semicolon
)brace
id|ax_info-&gt;int_buf
op_assign
id|kmalloc
c_func
(paren
l_int|8
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ax_info-&gt;int_buf
op_eq
l_int|NULL
)paren
(brace
r_goto
id|exit_err_free_int_urb
suffix:semicolon
)brace
id|ax_info-&gt;phy_req.data
op_assign
id|kmalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ax_info-&gt;phy_req.data
op_eq
l_int|NULL
)paren
(brace
r_goto
id|exit_err_free_int_buf
suffix:semicolon
)brace
id|usb_fill_int_urb
c_func
(paren
id|ax_info-&gt;int_urb
comma
id|usb
comma
id|usb_rcvintpipe
c_func
(paren
id|usb
comma
l_int|1
)paren
comma
id|ax_info-&gt;int_buf
comma
l_int|8
comma
id|ax_int_callback
comma
id|ax_info
comma
l_int|100
)paren
suffix:semicolon
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|ax_info-&gt;int_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Failed int URB submit (%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ret
)paren
suffix:semicolon
r_goto
id|exit_err_free_phy_buf
suffix:semicolon
)brace
id|ax_info-&gt;drv_state
op_assign
id|AX_DRV_STATE_RUNNING
suffix:semicolon
id|usb_set_intfdata
c_func
(paren
id|intf
comma
id|ax_info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|exit_err_free_phy_buf
suffix:colon
id|kfree
c_func
(paren
id|ax_info-&gt;phy_req.data
)paren
suffix:semicolon
id|exit_err_free_int_buf
suffix:colon
id|kfree
c_func
(paren
id|ax_info-&gt;int_buf
)paren
suffix:semicolon
id|exit_err_free_int_urb
suffix:colon
id|usb_free_urb
c_func
(paren
id|ax_info-&gt;int_urb
)paren
suffix:semicolon
id|exit_err_unregister_net
suffix:colon
id|ax_info-&gt;drv_state
op_assign
id|AX_DRV_STATE_EXITING
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|net
)paren
suffix:semicolon
id|exit_err_free_net
suffix:colon
id|kfree
c_func
(paren
id|net
)paren
suffix:semicolon
id|exit_err_free_ax
suffix:colon
r_if
c_cond
(paren
id|ax_info-&gt;ctl_urb
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* no need to unlink, since there should not be any ctl URBs&n;&t;&t;   pending at this point */
id|usb_free_urb
c_func
(paren
id|ax_info-&gt;ctl_urb
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ax_info
)paren
suffix:semicolon
id|exit_err
suffix:colon
id|err
c_func
(paren
l_string|&quot;%s: Failed to initialize&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|ax8817x_disconnect
r_static
r_void
id|ax8817x_disconnect
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
(brace
r_struct
id|ax8817x_info
op_star
id|ax_info
op_assign
id|usb_get_intfdata
c_func
(paren
id|intf
)paren
suffix:semicolon
id|usb_set_intfdata
c_func
(paren
id|intf
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ax_info
)paren
(brace
id|ax_info-&gt;drv_state
op_assign
id|AX_DRV_STATE_EXITING
suffix:semicolon
r_if
c_cond
(paren
id|ax_info-&gt;int_urb
op_ne
l_int|NULL
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|ax_info-&gt;int_urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ax_info-&gt;int_urb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ax_info-&gt;int_buf
)paren
suffix:semicolon
)brace
id|unregister_netdev
c_func
(paren
id|ax_info-&gt;net
)paren
suffix:semicolon
multiline_comment|/* XXX: hmmm... need to go through and clear out the ctl queue, too... */
r_if
c_cond
(paren
id|ax_info-&gt;ctl_urb
op_ne
l_int|NULL
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|ax_info-&gt;ctl_urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ax_info-&gt;ctl_urb
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ax_info
)paren
suffix:semicolon
)brace
)brace
DECL|variable|ax8817x_driver
r_static
r_struct
id|usb_driver
id|ax8817x_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|DRIVER_NAME
comma
dot
id|probe
op_assign
id|ax8817x_bind
comma
dot
id|disconnect
op_assign
id|ax8817x_disconnect
comma
dot
id|id_table
op_assign
id|ax8817x_id_table
comma
)brace
suffix:semicolon
DECL|function|ax8817x_init
r_static
r_int
id|__init
id|ax8817x_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|n_rx_urbs
OL
l_int|1
)paren
id|n_rx_urbs
op_assign
id|AX_RX_URBS_DEFAULT
suffix:semicolon
id|ret
op_assign
id|usb_register
c_func
(paren
op_amp
id|ax8817x_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Failed to register&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_else
(brace
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ax8817x_exit
r_static
r_void
id|__exit
id|ax8817x_exit
c_func
(paren
r_void
)paren
(brace
id|usb_deregister
c_func
(paren
op_amp
id|ax8817x_driver
)paren
suffix:semicolon
)brace
DECL|variable|ax8817x_init
id|module_init
c_func
(paren
id|ax8817x_init
)paren
suffix:semicolon
DECL|variable|ax8817x_exit
id|module_exit
c_func
(paren
id|ax8817x_exit
)paren
suffix:semicolon
eof
