multiline_comment|/*&n; * IPWireless 3G UMTS TDD Modem driver (USB connected)&n; *&n; *   Copyright (C) 2004 Roelf Diedericks &lt;roelfd@inet.co.za&gt;&n; *   Copyright (C) 2004 Greg Kroah-Hartman &lt;greg@kroah.com&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; * All information about the device was acquired using SnoopyPro&n; * on MSFT&squot;s O/S, and examing the MSFT drivers&squot; debug output &n; * (insanely left _on_ in the enduser version)&n; *&n; * It was written out of frustration with the IPWireless USB modem&n; * supplied by Axity3G/Sentech South Africa not supporting&n; * Linux whatsoever.&n; *&n; * Nobody provided any proprietary information that was not already &n; * available for this device.&n; * &n; * The modem adheres to the &quot;3GPP TS  27.007 AT command set for 3G &n; * User Equipment (UE)&quot; standard, available from &n; * http://www.3gpp.org/ftp/Specs/html-info/27007.htm&n; *&n; * The code was only tested the IPWireless handheld modem distributed&n; * in South Africa by Sentech.&n; * &n; * It may work for Woosh Inc in .nz too, as it appears they use the&n; * same kit.&n; *&n; * There is still some work to be done in terms of handling &n; * DCD, DTR, RTS, CTS which are currently faked.&n; * It&squot;s good enough for PPP at this point. It&squot;s based off all kinds of&n; * code found in usb/serial and usb/class&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;usb-serial.h&quot;
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;v0.3&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Roelf Diedericks&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;IPWireless tty driver&quot;
DECL|macro|IPW_TTY_MAJOR
mdefine_line|#define IPW_TTY_MAJOR&t;240&t;/* real device node major id, experimental range */
DECL|macro|IPW_TTY_MINORS
mdefine_line|#define IPW_TTY_MINORS&t;256&t;/* we support 256 devices, dunno why, it&squot;d be insane :) */
DECL|macro|USB_IPW_MAGIC
mdefine_line|#define USB_IPW_MAGIC&t;0x6d02&t;/* magic number for ipw struct */
multiline_comment|/* Message sizes */
DECL|macro|EVENT_BUFFER_SIZE
mdefine_line|#define EVENT_BUFFER_SIZE&t;0xFF
DECL|macro|CHAR2INT16
mdefine_line|#define CHAR2INT16(c1,c0)&t;(((u32)((c1) &amp; 0xff) &lt;&lt; 8) + (u32)((c0) &amp; 0xff))
DECL|macro|NUM_BULK_URBS
mdefine_line|#define NUM_BULK_URBS&t;&t;24
DECL|macro|NUM_CONTROL_URBS
mdefine_line|#define NUM_CONTROL_URBS&t;16
multiline_comment|/* vendor/product pairs that are known work with this driver*/
DECL|macro|IPW_VID
mdefine_line|#define IPW_VID&t;&t;0x0bc3
DECL|macro|IPW_PID
mdefine_line|#define IPW_PID&t;&t;0x0001
multiline_comment|/* Vendor commands: */
multiline_comment|/* baud rates */
r_enum
(brace
DECL|enumerator|ipw_sio_b256000
id|ipw_sio_b256000
op_assign
l_int|0x000e
comma
DECL|enumerator|ipw_sio_b128000
id|ipw_sio_b128000
op_assign
l_int|0x001d
comma
DECL|enumerator|ipw_sio_b115200
id|ipw_sio_b115200
op_assign
l_int|0x0020
comma
DECL|enumerator|ipw_sio_b57600
id|ipw_sio_b57600
op_assign
l_int|0x0040
comma
DECL|enumerator|ipw_sio_b56000
id|ipw_sio_b56000
op_assign
l_int|0x0042
comma
DECL|enumerator|ipw_sio_b38400
id|ipw_sio_b38400
op_assign
l_int|0x0060
comma
DECL|enumerator|ipw_sio_b19200
id|ipw_sio_b19200
op_assign
l_int|0x00c0
comma
DECL|enumerator|ipw_sio_b14400
id|ipw_sio_b14400
op_assign
l_int|0x0100
comma
DECL|enumerator|ipw_sio_b9600
id|ipw_sio_b9600
op_assign
l_int|0x0180
comma
DECL|enumerator|ipw_sio_b4800
id|ipw_sio_b4800
op_assign
l_int|0x0300
comma
DECL|enumerator|ipw_sio_b2400
id|ipw_sio_b2400
op_assign
l_int|0x0600
comma
DECL|enumerator|ipw_sio_b1200
id|ipw_sio_b1200
op_assign
l_int|0x0c00
comma
DECL|enumerator|ipw_sio_b600
id|ipw_sio_b600
op_assign
l_int|0x1800
)brace
suffix:semicolon
multiline_comment|/* data bits */
DECL|macro|ipw_dtb_7
mdefine_line|#define ipw_dtb_7&t;&t;0x700
DECL|macro|ipw_dtb_8
mdefine_line|#define ipw_dtb_8&t;&t;0x810&t;
singleline_comment|// ok so the define is misleading, I know, but forces 8,n,1
singleline_comment|// I mean, is there a point to any other setting these days? :)&t;
multiline_comment|/* usb control request types : */
DECL|macro|IPW_SIO_RXCTL
mdefine_line|#define IPW_SIO_RXCTL&t;&t;0x00&t;
singleline_comment|// control bulk rx channel transmissions, value=1/0 (on/off)
DECL|macro|IPW_SIO_SET_BAUD
mdefine_line|#define IPW_SIO_SET_BAUD&t;0x01&t;
singleline_comment|// set baud, value=requested ipw_sio_bxxxx
DECL|macro|IPW_SIO_SET_LINE
mdefine_line|#define IPW_SIO_SET_LINE&t;0x03&t;
singleline_comment|// set databits, parity. value=ipw_dtb_x
DECL|macro|IPW_SIO_SET_PIN
mdefine_line|#define IPW_SIO_SET_PIN&t;&t;0x03&t;
singleline_comment|// set/clear dtr/rts value=ipw_pin_xxx
DECL|macro|IPW_SIO_POLL
mdefine_line|#define IPW_SIO_POLL&t;&t;0x08&t;
singleline_comment|// get serial port status byte, call with value=0
DECL|macro|IPW_SIO_INIT
mdefine_line|#define IPW_SIO_INIT&t;&t;0x11&t;
singleline_comment|// initializes ? value=0 (appears as first thing todo on open)
DECL|macro|IPW_SIO_PURGE
mdefine_line|#define IPW_SIO_PURGE&t;&t;0x12&t;
singleline_comment|// purge all transmissions?, call with value=numchar_to_purge
DECL|macro|IPW_SIO_HANDFLOW
mdefine_line|#define IPW_SIO_HANDFLOW&t;0x13&t;
singleline_comment|// set xon/xoff limits value=0, and a buffer of 0x10 bytes
DECL|macro|IPW_SIO_SETCHARS
mdefine_line|#define IPW_SIO_SETCHARS&t;0x13&t;
singleline_comment|// set the flowcontrol special chars, value=0, buf=6 bytes, 
singleline_comment|// last 2 bytes contain flowcontrol chars e.g. 00 00 00 00 11 13
multiline_comment|/* values used for request IPW_SIO_SET_PIN */
DECL|macro|IPW_PIN_SETDTR
mdefine_line|#define IPW_PIN_SETDTR&t;&t;0x101
DECL|macro|IPW_PIN_SETRTS
mdefine_line|#define IPW_PIN_SETRTS&t;&t;0x202
DECL|macro|IPW_PIN_CLRDTR
mdefine_line|#define IPW_PIN_CLRDTR&t;&t;0x100
DECL|macro|IPW_PIN_CLRRTS
mdefine_line|#define IPW_PIN_CLRRTS&t;&t;0x200 
singleline_comment|// unconfirmed
multiline_comment|/* values used for request IPW_SIO_RXCTL */
DECL|macro|IPW_RXBULK_ON
mdefine_line|#define IPW_RXBULK_ON&t;&t;1
DECL|macro|IPW_RXBULK_OFF
mdefine_line|#define IPW_RXBULK_OFF&t;&t;0
multiline_comment|/* various 16 byte hardcoded transferbuffers used by flow control */
DECL|macro|IPW_BYTES_FLOWINIT
mdefine_line|#define IPW_BYTES_FLOWINIT&t;{ 0x01, 0, 0, 0, 0x40, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }
multiline_comment|/* Interpretation of modem status lines */
multiline_comment|/* These need sorting out by individually connecting pins and checking&n; * results. FIXME!&n; * When data is being sent we see 0x30 in the lower byte; this must&n; * contain DSR and CTS ...&n; */
DECL|macro|IPW_DSR
mdefine_line|#define IPW_DSR&t;&t;&t;((1&lt;&lt;4) | (1&lt;&lt;5))
DECL|macro|IPW_CTS
mdefine_line|#define IPW_CTS&t;&t;&t;((1&lt;&lt;5) | (1&lt;&lt;4))
DECL|macro|IPW_WANTS_TO_SEND
mdefine_line|#define IPW_WANTS_TO_SEND&t;0x30
singleline_comment|//#define IPW_DTR&t;&t;&t;/* Data Terminal Ready */
singleline_comment|//#define IPW_CTS&t;&t;&t;/* Clear To Send */
singleline_comment|//#define IPW_CD&t;&t;&t;/* Carrier Detect */
singleline_comment|//#define IPW_DSR&t;&t;&t;/* Data Set Ready */
singleline_comment|//#define IPW_RxD&t;&t;&t;/* Receive pin */
singleline_comment|//#define IPW_LE
singleline_comment|//#define IPW_RTS&t;&t;
singleline_comment|//#define IPW_ST&t;&t;
singleline_comment|//#define IPW_SR&t;&t;
singleline_comment|//#define IPW_RI&t;&t;&t;/* Ring Indicator */
DECL|variable|usb_ipw_ids
r_static
r_struct
id|usb_device_id
id|usb_ipw_ids
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|IPW_VID
comma
id|IPW_PID
)paren
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|usb
comma
id|usb_ipw_ids
)paren
suffix:semicolon
DECL|variable|usb_ipw_driver
r_static
r_struct
id|usb_driver
id|usb_ipw_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;ipwtty&quot;
comma
dot
id|probe
op_assign
id|usb_serial_probe
comma
dot
id|disconnect
op_assign
id|usb_serial_disconnect
comma
dot
id|id_table
op_assign
id|usb_ipw_ids
comma
)brace
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|function|ipw_read_bulk_callback
r_static
r_void
id|ipw_read_bulk_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|urb-&gt;context
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero read bulk status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_serial_debug_data
c_func
(paren
id|debug
comma
op_amp
id|port-&gt;dev
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|data
)paren
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_logical_and
id|urb-&gt;actual_length
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/* if we insert more than TTY_FLIPBUF_SIZE characters, we drop them. */
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* this doesn&squot;t actually push the data through unless tty-&gt;low_latency is set */
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* Continue trying to always read  */
id|usb_fill_bulk_urb
(paren
id|port-&gt;read_urb
comma
id|port-&gt;serial-&gt;dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|port-&gt;serial-&gt;dev
comma
id|port-&gt;bulk_in_endpointAddress
)paren
comma
id|port-&gt;read_urb-&gt;transfer_buffer
comma
id|port-&gt;read_urb-&gt;transfer_buffer_length
comma
id|ipw_read_bulk_callback
comma
id|port
)paren
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;read_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - failed resubmitting read urb, error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ipw_open
r_static
r_int
id|ipw_open
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|u8
id|buf_flow_static
(braket
l_int|16
)braket
op_assign
id|IPW_BYTES_FLOWINIT
suffix:semicolon
id|u8
op_star
id|buf_flow_init
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|buf_flow_init
op_assign
id|kmalloc
c_func
(paren
l_int|16
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf_flow_init
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|buf_flow_init
comma
id|buf_flow_static
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty
)paren
id|port-&gt;tty-&gt;low_latency
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* --1: Tell the modem to initialize (we think) From sniffs this is always the&n;&t; * first thing that gets sent to the modem during opening of the device */
id|dbg
c_func
(paren
l_string|&quot;%s: Sending SIO_INIT (we guess)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_INIT
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* index */
l_int|NULL
comma
l_int|0
comma
l_int|100
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;Init of modem failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/* reset the bulk pipes */
id|usb_clear_halt
c_func
(paren
id|dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|dev
comma
id|port-&gt;bulk_in_endpointAddress
)paren
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|dev
comma
id|port-&gt;bulk_out_endpointAddress
)paren
)paren
suffix:semicolon
multiline_comment|/*--2: Start reading from the device */
id|dbg
c_func
(paren
l_string|&quot;%s: setting up bulk read callback&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_fill_bulk_urb
c_func
(paren
id|port-&gt;read_urb
comma
id|dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|dev
comma
id|port-&gt;bulk_in_endpointAddress
)paren
comma
id|port-&gt;bulk_in_buffer
comma
id|port-&gt;bulk_in_size
comma
id|ipw_read_bulk_callback
comma
id|port
)paren
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;read_urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dbg
c_func
(paren
l_string|&quot;%s - usb_submit_urb(read bulk) failed with status %d&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
multiline_comment|/*--3: Tell the modem to open the floodgates on the rx bulk channel */
id|dbg
c_func
(paren
l_string|&quot;%s:asking modem for RxRead (RXBULK_ON)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_RXCTL
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
id|IPW_RXBULK_ON
comma
l_int|0
comma
multiline_comment|/* index */
l_int|NULL
comma
l_int|0
comma
l_int|100
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;Enabling bulk RxRead failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/*--4: setup the initial flowcontrol */
id|dbg
c_func
(paren
l_string|&quot;%s:setting init flowcontrol (%s)&quot;
comma
id|__FUNCTION__
comma
id|buf_flow_init
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_HANDFLOW
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
l_int|0
comma
l_int|0
comma
id|buf_flow_init
comma
l_int|0x10
comma
l_int|200
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;initial flowcontrol failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/*--5: raise the dtr */
id|dbg
c_func
(paren
l_string|&quot;%s:raising dtr&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_SET_PIN
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
id|IPW_PIN_SETDTR
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|200
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;setting dtr failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/*--6: raise the rts */
id|dbg
c_func
(paren
l_string|&quot;%s:raising rts&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_SET_PIN
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
id|IPW_PIN_SETRTS
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|200
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;setting dtr failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf_flow_init
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipw_close
r_static
r_void
id|ipw_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s: tty_hung_up_p ...&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*--1: drop the dtr */
id|dbg
c_func
(paren
l_string|&quot;%s:dropping dtr&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_SET_PIN
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
id|IPW_PIN_CLRDTR
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|200
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;dropping dtr failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/*--2: drop the rts */
id|dbg
c_func
(paren
l_string|&quot;%s:dropping rts&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_SET_PIN
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
id|IPW_PIN_CLRRTS
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|200
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;dropping rts failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/*--3: purge */
id|dbg
c_func
(paren
l_string|&quot;%s:sending purge&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_PURGE
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
l_int|0x03
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|200
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;purge failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/* send RXBULK_off (tell modem to stop transmitting bulk data on rx chan) */
id|result
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|IPW_SIO_RXCTL
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_DIR_OUT
comma
id|IPW_RXBULK_OFF
comma
l_int|0
comma
multiline_comment|/* index */
l_int|NULL
comma
l_int|0
comma
l_int|100
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;Disabling bulk RxRead failed (error = %d)&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/* shutdown any in-flight urbs that we know about */
id|usb_kill_urb
c_func
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
id|usb_kill_urb
c_func
(paren
id|port-&gt;write_urb
)paren
suffix:semicolon
)brace
DECL|function|ipw_write_bulk_callback
r_static
r_void
id|ipw_write_bulk_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|urb-&gt;context
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero write bulk status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|port-&gt;work
)paren
suffix:semicolon
)brace
DECL|function|ipw_write
r_static
r_int
id|ipw_write
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s: TOP: count=%d, from_user=%d, in_interrupt=%ld&quot;
comma
id|__FUNCTION__
comma
id|count
comma
id|from_user
comma
id|in_interrupt
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - write request of 0 bytes&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Racy and broken, FIXME properly! */
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
r_return
l_int|0
suffix:semicolon
id|count
op_assign
id|min
c_func
(paren
id|count
comma
id|port-&gt;bulk_out_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|port-&gt;bulk_out_buffer
comma
id|buf
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|port-&gt;bulk_out_buffer
comma
id|buf
comma
id|count
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s count now:%d&quot;
comma
id|__FUNCTION__
comma
id|count
)paren
suffix:semicolon
id|usb_fill_bulk_urb
c_func
(paren
id|port-&gt;write_urb
comma
id|dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|dev
comma
id|port-&gt;bulk_out_endpointAddress
)paren
comma
id|port-&gt;write_urb-&gt;transfer_buffer
comma
id|count
comma
id|ipw_write_bulk_callback
comma
id|port
)paren
suffix:semicolon
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;write_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - usb_submit_urb(write bulk) failed with error = %d&quot;
comma
id|__FUNCTION__
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s returning %d&quot;
comma
id|__FUNCTION__
comma
id|count
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|ipw_probe
r_static
r_int
id|ipw_probe
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ipw_disconnect
r_static
r_int
id|ipw_disconnect
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
id|usb_set_serial_port_data
c_func
(paren
id|port
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ipw_device
r_static
r_struct
id|usb_serial_device_type
id|ipw_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;IPWireless converter&quot;
comma
dot
id|short_name
op_assign
l_string|&quot;ipw&quot;
comma
dot
id|id_table
op_assign
id|usb_ipw_ids
comma
dot
id|num_interrupt_in
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_bulk_in
op_assign
l_int|1
comma
dot
id|num_bulk_out
op_assign
l_int|1
comma
dot
id|num_ports
op_assign
l_int|1
comma
dot
id|open
op_assign
id|ipw_open
comma
dot
id|close
op_assign
id|ipw_close
comma
dot
id|port_probe
op_assign
id|ipw_probe
comma
dot
id|port_remove
op_assign
id|ipw_disconnect
comma
dot
id|write
op_assign
id|ipw_write
comma
dot
id|write_bulk_callback
op_assign
id|ipw_write_bulk_callback
comma
dot
id|read_bulk_callback
op_assign
id|ipw_read_bulk_callback
comma
)brace
suffix:semicolon
DECL|function|usb_ipw_init
r_int
id|usb_ipw_init
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|usb_serial_register
c_func
(paren
op_amp
id|ipw_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|retval
op_assign
id|usb_register
c_func
(paren
op_amp
id|usb_ipw_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|usb_serial_deregister
c_func
(paren
op_amp
id|ipw_device
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_ipw_exit
r_void
id|usb_ipw_exit
c_func
(paren
r_void
)paren
(brace
id|usb_deregister
c_func
(paren
op_amp
id|usb_ipw_driver
)paren
suffix:semicolon
id|usb_serial_deregister
c_func
(paren
op_amp
id|ipw_device
)paren
suffix:semicolon
)brace
DECL|variable|usb_ipw_init
id|module_init
c_func
(paren
id|usb_ipw_init
)paren
suffix:semicolon
DECL|variable|usb_ipw_exit
id|module_exit
c_func
(paren
id|usb_ipw_exit
)paren
suffix:semicolon
multiline_comment|/* Module information */
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_bool
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug enabled or not&quot;
)paren
suffix:semicolon
eof
