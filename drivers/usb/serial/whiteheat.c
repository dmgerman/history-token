multiline_comment|/*&n; * USB ConnectTech WhiteHEAT driver&n; *&n; *&t;Copyright (C) 2002&n; *&t;    Connect Tech Inc.&n; *&n; *&t;Copyright (C) 1999 - 2001&n; *&t;    Greg Kroah-Hartman (greg@kroah.com)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; * See Documentation/usb/usb-serial.txt for more information on using this driver&n; *&n; * (10/09/2002) Stuart MacDonald (stuartm@connecttech.com)&n; *&t;Upgrade to full working driver&n; *&n; * (05/30/2001) gkh&n; *&t;switched from using spinlock to a semaphore, which fixes lots of problems.&n; *&n; * (04/08/2001) gb&n; *&t;Identify version on module load.&n; * &n; * 2001_Mar_19 gkh&n; *&t;Fixed MOD_INC and MOD_DEC logic, the ability to open a port more &n; *&t;than once, and the got the proper usb_device_id table entries so&n; *&t;the driver works again.&n; *&n; * (11/01/2000) Adam J. Richter&n; *&t;usb_device_id table support&n; * &n; * (10/05/2000) gkh&n; *&t;Fixed bug with urb-&gt;dev not being set properly, now that the usb&n; *&t;core needs it.&n; * &n; * (10/03/2000) smd&n; *&t;firmware is improved to guard against crap sent to device&n; *&t;firmware now replies CMD_FAILURE on bad things&n; *&t;read_callback fix you provided for private info struct&n; *&t;command_finished now indicates success or fail&n; *&t;setup_port struct now packed to avoid gcc padding&n; *&t;firmware uses 1 based port numbering, driver now handles that&n; *&n; * (09/11/2000) gkh&n; *&t;Removed DEBUG #ifdefs with call to usb_serial_debug_data&n; *&n; * (07/19/2000) gkh&n; *&t;Added module_init and module_exit functions to handle the fact that this&n; *&t;driver is a loadable module now.&n; *&t;Fixed bug with port-&gt;minor that was found by Al Borchers&n; *&n; * (07/04/2000) gkh&n; *&t;Added support for port settings. Baud rate can now be changed. Line signals&n; *&t;are not transferred to and from the tty layer yet, but things seem to be &n; *&t;working well now.&n; *&n; * (05/04/2000) gkh&n; *&t;First cut at open and close commands. Data can flow through the ports at&n; *&t;default speeds now.&n; *&n; * (03/26/2000) gkh&n; *&t;Split driver up into device specific pieces.&n; * &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/serial_reg.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
macro_line|#endif
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;whiteheat_fw.h&quot;&t;&t;/* firmware for the ConnectTech WhiteHEAT device */
macro_line|#include &quot;whiteheat.h&quot;&t;&t;&t;/* WhiteHEAT specific commands */
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v2.0&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Greg Kroah-Hartman &lt;greg@kroah.com&gt;, Stuart MacDonald &lt;stuartm@connecttech.com&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;USB ConnectTech WhiteHEAT driver&quot;
DECL|macro|CONNECT_TECH_VENDOR_ID
mdefine_line|#define CONNECT_TECH_VENDOR_ID&t;&t;0x0710
DECL|macro|CONNECT_TECH_FAKE_WHITE_HEAT_ID
mdefine_line|#define CONNECT_TECH_FAKE_WHITE_HEAT_ID&t;0x0001
DECL|macro|CONNECT_TECH_WHITE_HEAT_ID
mdefine_line|#define CONNECT_TECH_WHITE_HEAT_ID&t;0x8001
multiline_comment|/*&n;   ID tables for whiteheat are unusual, because we want to different&n;   things for different versions of the device.  Eventually, this&n;   will be doable from a single table.  But, for now, we define two&n;   separate ID tables, and then a third table that combines them&n;   just for the purpose of exporting the autoloading information.&n;*/
DECL|variable|id_table_std
r_static
r_struct
id|usb_device_id
id|id_table_std
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|CONNECT_TECH_VENDOR_ID
comma
id|CONNECT_TECH_WHITE_HEAT_ID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|id_table_prerenumeration
r_static
r_struct
id|usb_device_id
id|id_table_prerenumeration
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|CONNECT_TECH_VENDOR_ID
comma
id|CONNECT_TECH_FAKE_WHITE_HEAT_ID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|id_table_combined
r_static
r_struct
id|usb_device_id
id|id_table_combined
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|CONNECT_TECH_VENDOR_ID
comma
id|CONNECT_TECH_WHITE_HEAT_ID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|CONNECT_TECH_VENDOR_ID
comma
id|CONNECT_TECH_FAKE_WHITE_HEAT_ID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|id_table_combined
)paren
suffix:semicolon
DECL|variable|whiteheat_driver
r_static
r_struct
id|usb_driver
id|whiteheat_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;whiteheat&quot;
comma
dot
id|probe
op_assign
id|usb_serial_probe
comma
dot
id|disconnect
op_assign
id|usb_serial_disconnect
comma
dot
id|id_table
op_assign
id|id_table_combined
comma
)brace
suffix:semicolon
multiline_comment|/* function prototypes for the Connect Tech WhiteHEAT prerenumeration device */
r_static
r_int
id|whiteheat_firmware_download
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_int
id|whiteheat_firmware_attach
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
multiline_comment|/* function prototypes for the Connect Tech WhiteHEAT serial converter */
r_static
r_int
id|whiteheat_attach
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|whiteheat_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_int
id|whiteheat_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|whiteheat_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|whiteheat_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|whiteheat_write_room
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|whiteheat_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|whiteheat_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old
)paren
suffix:semicolon
r_static
r_int
id|whiteheat_tiocmget
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|whiteheat_tiocmset
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
suffix:semicolon
r_static
r_void
id|whiteheat_break_ctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
suffix:semicolon
r_static
r_int
id|whiteheat_chars_in_buffer
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|whiteheat_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|whiteheat_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|whiteheat_read_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|whiteheat_write_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|variable|whiteheat_fake_device
r_static
r_struct
id|usb_serial_device_type
id|whiteheat_fake_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;Connect Tech - WhiteHEAT - (prerenumeration)&quot;
comma
dot
id|short_name
op_assign
l_string|&quot;whiteheatnofirm&quot;
comma
dot
id|id_table
op_assign
id|id_table_prerenumeration
comma
dot
id|num_interrupt_in
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_bulk_in
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_bulk_out
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_ports
op_assign
l_int|1
comma
dot
id|probe
op_assign
id|whiteheat_firmware_download
comma
dot
id|attach
op_assign
id|whiteheat_firmware_attach
comma
)brace
suffix:semicolon
DECL|variable|whiteheat_device
r_static
r_struct
id|usb_serial_device_type
id|whiteheat_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;Connect Tech - WhiteHEAT&quot;
comma
dot
id|short_name
op_assign
l_string|&quot;whiteheat&quot;
comma
dot
id|id_table
op_assign
id|id_table_std
comma
dot
id|num_interrupt_in
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_bulk_in
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_bulk_out
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_ports
op_assign
l_int|4
comma
dot
id|attach
op_assign
id|whiteheat_attach
comma
dot
id|shutdown
op_assign
id|whiteheat_shutdown
comma
dot
id|open
op_assign
id|whiteheat_open
comma
dot
id|close
op_assign
id|whiteheat_close
comma
dot
id|write
op_assign
id|whiteheat_write
comma
dot
id|write_room
op_assign
id|whiteheat_write_room
comma
dot
id|ioctl
op_assign
id|whiteheat_ioctl
comma
dot
id|set_termios
op_assign
id|whiteheat_set_termios
comma
dot
id|break_ctl
op_assign
id|whiteheat_break_ctl
comma
dot
id|tiocmget
op_assign
id|whiteheat_tiocmget
comma
dot
id|tiocmset
op_assign
id|whiteheat_tiocmset
comma
dot
id|chars_in_buffer
op_assign
id|whiteheat_chars_in_buffer
comma
dot
id|throttle
op_assign
id|whiteheat_throttle
comma
dot
id|unthrottle
op_assign
id|whiteheat_unthrottle
comma
dot
id|read_bulk_callback
op_assign
id|whiteheat_read_callback
comma
dot
id|write_bulk_callback
op_assign
id|whiteheat_write_callback
comma
)brace
suffix:semicolon
DECL|struct|whiteheat_command_private
r_struct
id|whiteheat_command_private
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|port_running
id|__u8
id|port_running
suffix:semicolon
DECL|member|command_finished
id|__u8
id|command_finished
suffix:semicolon
DECL|member|wait_command
id|wait_queue_head_t
id|wait_command
suffix:semicolon
multiline_comment|/* for handling sleeping while waiting for a command to finish */
DECL|member|result_buffer
id|__u8
id|result_buffer
(braket
l_int|64
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|THROTTLED
mdefine_line|#define THROTTLED&t;&t;0x01
DECL|macro|ACTUALLY_THROTTLED
mdefine_line|#define ACTUALLY_THROTTLED&t;0x02
DECL|variable|urb_pool_size
r_static
r_int
id|urb_pool_size
op_assign
l_int|8
suffix:semicolon
DECL|struct|whiteheat_urb_wrap
r_struct
id|whiteheat_urb_wrap
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|whiteheat_private
r_struct
id|whiteheat_private
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|flags
id|__u8
id|flags
suffix:semicolon
DECL|member|mcr
id|__u8
id|mcr
suffix:semicolon
DECL|member|rx_urbs_free
r_struct
id|list_head
id|rx_urbs_free
suffix:semicolon
DECL|member|rx_urbs_submitted
r_struct
id|list_head
id|rx_urbs_submitted
suffix:semicolon
DECL|member|rx_urb_q
r_struct
id|list_head
id|rx_urb_q
suffix:semicolon
DECL|member|rx_work
r_struct
id|work_struct
id|rx_work
suffix:semicolon
DECL|member|tx_urbs_free
r_struct
id|list_head
id|tx_urbs_free
suffix:semicolon
DECL|member|tx_urbs_submitted
r_struct
id|list_head
id|tx_urbs_submitted
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* local function prototypes */
r_static
r_int
id|start_command_port
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|stop_command_port
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|command_port_write_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|command_port_read_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|start_port_read
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_struct
id|whiteheat_urb_wrap
op_star
id|urb_to_wrap
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|list_head
op_star
id|head
)paren
suffix:semicolon
r_static
r_struct
id|list_head
op_star
id|list_first
c_func
(paren
r_struct
id|list_head
op_star
id|head
)paren
suffix:semicolon
r_static
r_void
id|rx_data_softint
c_func
(paren
r_void
op_star
r_private
)paren
suffix:semicolon
r_static
r_int
id|firm_send_command
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|command
comma
id|__u8
op_star
id|data
comma
id|__u8
id|datasize
)paren
suffix:semicolon
r_static
r_int
id|firm_open
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|firm_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|firm_setup_port
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|firm_set_rts
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|onoff
)paren
suffix:semicolon
r_static
r_int
id|firm_set_dtr
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|onoff
)paren
suffix:semicolon
r_static
r_int
id|firm_set_break
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|onoff
)paren
suffix:semicolon
r_static
r_int
id|firm_purge
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|rxtx
)paren
suffix:semicolon
r_static
r_int
id|firm_get_dtr_rts
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|firm_report_tx_done
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
DECL|macro|COMMAND_PORT
mdefine_line|#define COMMAND_PORT&t;&t;4
DECL|macro|COMMAND_TIMEOUT
mdefine_line|#define COMMAND_TIMEOUT&t;&t;(2*HZ)&t;/* 2 second timeout for a command */
DECL|macro|CLOSING_DELAY
mdefine_line|#define CLOSING_DELAY&t;&t;(30 * HZ)
multiline_comment|/*****************************************************************************&n; * Connect Tech&squot;s White Heat prerenumeration driver functions&n; *****************************************************************************/
multiline_comment|/* steps to download the firmware to the WhiteHEAT device:&n; - hold the reset (by writing to the reset bit of the CPUCS register)&n; - download the VEND_AX.HEX file to the chip using VENDOR_REQUEST-ANCHOR_LOAD&n; - release the reset (by writing to the CPUCS register)&n; - download the WH.HEX file for all addresses greater than 0x1b3f using&n;   VENDOR_REQUEST-ANCHOR_EXTERNAL_RAM_LOAD&n; - hold the reset&n; - download the WH.HEX file for all addresses less than 0x1b40 using&n;   VENDOR_REQUEST_ANCHOR_LOAD&n; - release the reset&n; - device renumerated itself and comes up as new device id with all&n;   firmware download completed.&n;*/
DECL|function|whiteheat_firmware_download
r_static
r_int
id|whiteheat_firmware_download
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_int
id|response
suffix:semicolon
r_const
r_struct
id|whiteheat_hex_record
op_star
id|record
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|response
op_assign
id|ezusb_set_reset
(paren
id|serial
comma
l_int|1
)paren
suffix:semicolon
id|record
op_assign
op_amp
id|whiteheat_loader
(braket
l_int|0
)braket
suffix:semicolon
r_while
c_loop
(paren
id|record-&gt;address
op_ne
l_int|0xffff
)paren
(brace
id|response
op_assign
id|ezusb_writememory
(paren
id|serial
comma
id|record-&gt;address
comma
(paren
r_int
r_char
op_star
)paren
id|record-&gt;data
comma
id|record-&gt;data_size
comma
l_int|0xa0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - ezusb_writememory failed for loader (%d %04X %p %d)&quot;
comma
id|__FUNCTION__
comma
id|response
comma
id|record-&gt;address
comma
id|record-&gt;data
comma
id|record-&gt;data_size
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_increment
id|record
suffix:semicolon
)brace
id|response
op_assign
id|ezusb_set_reset
(paren
id|serial
comma
l_int|0
)paren
suffix:semicolon
id|record
op_assign
op_amp
id|whiteheat_firmware
(braket
l_int|0
)braket
suffix:semicolon
r_while
c_loop
(paren
id|record-&gt;address
OL
l_int|0x1b40
)paren
(brace
op_increment
id|record
suffix:semicolon
)brace
r_while
c_loop
(paren
id|record-&gt;address
op_ne
l_int|0xffff
)paren
(brace
id|response
op_assign
id|ezusb_writememory
(paren
id|serial
comma
id|record-&gt;address
comma
(paren
r_int
r_char
op_star
)paren
id|record-&gt;data
comma
id|record-&gt;data_size
comma
l_int|0xa3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - ezusb_writememory failed for first firmware step (%d %04X %p %d)&quot;
comma
id|__FUNCTION__
comma
id|response
comma
id|record-&gt;address
comma
id|record-&gt;data
comma
id|record-&gt;data_size
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_increment
id|record
suffix:semicolon
)brace
id|response
op_assign
id|ezusb_set_reset
(paren
id|serial
comma
l_int|1
)paren
suffix:semicolon
id|record
op_assign
op_amp
id|whiteheat_firmware
(braket
l_int|0
)braket
suffix:semicolon
r_while
c_loop
(paren
id|record-&gt;address
OL
l_int|0x1b40
)paren
(brace
id|response
op_assign
id|ezusb_writememory
(paren
id|serial
comma
id|record-&gt;address
comma
(paren
r_int
r_char
op_star
)paren
id|record-&gt;data
comma
id|record-&gt;data_size
comma
l_int|0xa0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - ezusb_writememory failed for second firmware step (%d %04X %p %d)&quot;
comma
id|__FUNCTION__
comma
id|response
comma
id|record-&gt;address
comma
id|record-&gt;data
comma
id|record-&gt;data_size
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_increment
id|record
suffix:semicolon
)brace
id|response
op_assign
id|ezusb_set_reset
(paren
id|serial
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|whiteheat_firmware_attach
r_static
r_int
id|whiteheat_firmware_attach
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
multiline_comment|/* We want this device to fail to have a driver assigned to it */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Connect Tech&squot;s White Heat serial driver functions&n; *****************************************************************************/
DECL|function|whiteheat_attach
r_static
r_int
id|whiteheat_attach
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|command_port
suffix:semicolon
r_struct
id|whiteheat_command_private
op_star
id|command_info
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|whiteheat_private
op_star
id|info
suffix:semicolon
r_struct
id|whiteheat_hw_info
op_star
id|hw_info
suffix:semicolon
r_int
id|pipe
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|alen
suffix:semicolon
id|__u8
id|command
(braket
l_int|2
)braket
op_assign
(brace
id|WHITEHEAT_GET_HW_INFO
comma
l_int|0
)brace
suffix:semicolon
id|__u8
id|result
(braket
r_sizeof
(paren
op_star
id|hw_info
)paren
op_plus
l_int|1
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|buf_size
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|command_port
op_assign
id|serial-&gt;port
(braket
id|COMMAND_PORT
)braket
suffix:semicolon
id|pipe
op_assign
id|usb_sndbulkpipe
(paren
id|serial-&gt;dev
comma
id|command_port-&gt;bulk_out_endpointAddress
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * When the module is reloaded the firmware is still there and&n;&t; * the endpoints are still in the usb core unchanged. This is the&n;         * unlinking bug in disguise. Same for the call below.&n;         */
id|usb_clear_halt
c_func
(paren
id|serial-&gt;dev
comma
id|pipe
)paren
suffix:semicolon
id|ret
op_assign
id|usb_bulk_msg
(paren
id|serial-&gt;dev
comma
id|pipe
comma
id|command
comma
r_sizeof
(paren
id|command
)paren
comma
op_amp
id|alen
comma
id|COMMAND_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Couldn&squot;t send command [%d]&quot;
comma
id|serial-&gt;type-&gt;name
comma
id|ret
)paren
suffix:semicolon
r_goto
id|no_firmware
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|alen
op_ne
r_sizeof
(paren
id|command
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Send command incomplete [%d]&quot;
comma
id|serial-&gt;type-&gt;name
comma
id|alen
)paren
suffix:semicolon
r_goto
id|no_firmware
suffix:semicolon
)brace
id|pipe
op_assign
id|usb_rcvbulkpipe
(paren
id|serial-&gt;dev
comma
id|command_port-&gt;bulk_in_endpointAddress
)paren
suffix:semicolon
multiline_comment|/* See the comment on the usb_clear_halt() above */
id|usb_clear_halt
c_func
(paren
id|serial-&gt;dev
comma
id|pipe
)paren
suffix:semicolon
id|ret
op_assign
id|usb_bulk_msg
(paren
id|serial-&gt;dev
comma
id|pipe
comma
id|result
comma
r_sizeof
(paren
id|result
)paren
comma
op_amp
id|alen
comma
id|COMMAND_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Couldn&squot;t get results [%d]&quot;
comma
id|serial-&gt;type-&gt;name
comma
id|ret
)paren
suffix:semicolon
r_goto
id|no_firmware
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|alen
op_ne
r_sizeof
(paren
id|result
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Get results incomplete [%d]&quot;
comma
id|serial-&gt;type-&gt;name
comma
id|alen
)paren
suffix:semicolon
r_goto
id|no_firmware
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
(braket
l_int|0
)braket
op_ne
id|command
(braket
l_int|0
)braket
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Command failed [%d]&quot;
comma
id|serial-&gt;type-&gt;name
comma
id|result
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_goto
id|no_firmware
suffix:semicolon
)brace
id|hw_info
op_assign
(paren
r_struct
id|whiteheat_hw_info
op_star
)paren
op_amp
id|result
(braket
l_int|1
)braket
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;%s: Driver %s: Firmware v%d.%02d&quot;
comma
id|serial-&gt;type-&gt;name
comma
id|DRIVER_VERSION
comma
id|hw_info-&gt;sw_major_rev
comma
id|hw_info-&gt;sw_minor_rev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port
op_assign
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|whiteheat_private
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|whiteheat_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Out of memory for port structures&bslash;n&quot;
comma
id|serial-&gt;type-&gt;name
)paren
suffix:semicolon
r_goto
id|no_private
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|info-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|info-&gt;mcr
op_assign
l_int|0
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|info-&gt;rx_work
comma
id|rx_data_softint
comma
id|port
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|info-&gt;rx_urbs_submitted
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|info-&gt;rx_urb_q
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|info-&gt;tx_urbs_free
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|info-&gt;tx_urbs_submitted
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|urb_pool_size
suffix:semicolon
id|j
op_increment
)paren
(brace
id|urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;No free urbs available&quot;
)paren
suffix:semicolon
r_goto
id|no_rx_urb
suffix:semicolon
)brace
id|buf_size
op_assign
id|port-&gt;read_urb-&gt;transfer_buffer_length
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|kmalloc
c_func
(paren
id|buf_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;transfer_buffer
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Couldn&squot;t allocate urb buffer&quot;
)paren
suffix:semicolon
r_goto
id|no_rx_buf
suffix:semicolon
)brace
id|wrap
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|wrap
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wrap
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Couldn&squot;t allocate urb wrapper&quot;
)paren
suffix:semicolon
r_goto
id|no_rx_wrap
suffix:semicolon
)brace
id|usb_fill_bulk_urb
c_func
(paren
id|urb
comma
id|serial-&gt;dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|serial-&gt;dev
comma
id|port-&gt;bulk_in_endpointAddress
)paren
comma
id|urb-&gt;transfer_buffer
comma
id|buf_size
comma
id|whiteheat_read_callback
comma
id|port
)paren
suffix:semicolon
id|wrap-&gt;urb
op_assign
id|urb
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|wrap-&gt;list
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
id|urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;No free urbs available&quot;
)paren
suffix:semicolon
r_goto
id|no_tx_urb
suffix:semicolon
)brace
id|buf_size
op_assign
id|port-&gt;write_urb-&gt;transfer_buffer_length
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|kmalloc
c_func
(paren
id|buf_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;transfer_buffer
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Couldn&squot;t allocate urb buffer&quot;
)paren
suffix:semicolon
r_goto
id|no_tx_buf
suffix:semicolon
)brace
id|wrap
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|wrap
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wrap
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Couldn&squot;t allocate urb wrapper&quot;
)paren
suffix:semicolon
r_goto
id|no_tx_wrap
suffix:semicolon
)brace
id|usb_fill_bulk_urb
c_func
(paren
id|urb
comma
id|serial-&gt;dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|serial-&gt;dev
comma
id|port-&gt;bulk_out_endpointAddress
)paren
comma
id|urb-&gt;transfer_buffer
comma
id|buf_size
comma
id|whiteheat_write_callback
comma
id|port
)paren
suffix:semicolon
id|wrap-&gt;urb
op_assign
id|urb
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|wrap-&gt;list
comma
op_amp
id|info-&gt;tx_urbs_free
)paren
suffix:semicolon
)brace
id|usb_set_serial_port_data
c_func
(paren
id|port
comma
id|info
)paren
suffix:semicolon
)brace
id|command_info
op_assign
(paren
r_struct
id|whiteheat_command_private
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|whiteheat_command_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command_info
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s: Out of memory for port structures&bslash;n&quot;
comma
id|serial-&gt;type-&gt;name
)paren
suffix:semicolon
r_goto
id|no_command_private
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|command_info-&gt;lock
)paren
suffix:semicolon
id|command_info-&gt;port_running
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|command_info-&gt;wait_command
)paren
suffix:semicolon
id|usb_set_serial_port_data
c_func
(paren
id|command_port
comma
id|command_info
)paren
suffix:semicolon
id|command_port-&gt;write_urb-&gt;complete
op_assign
id|command_port_write_callback
suffix:semicolon
id|command_port-&gt;read_urb-&gt;complete
op_assign
id|command_port_read_callback
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|no_firmware
suffix:colon
multiline_comment|/* Firmware likely not running */
id|err
c_func
(paren
l_string|&quot;%s: Unable to retrieve firmware version, try replugging&bslash;n&quot;
comma
id|serial-&gt;type-&gt;name
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s: If the firmware is not running (status led not blinking)&bslash;n&quot;
comma
id|serial-&gt;type-&gt;name
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s: please contact support@connecttech.com&bslash;n&quot;
comma
id|serial-&gt;type-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
id|no_command_private
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
id|serial-&gt;num_ports
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|port
op_assign
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|urb_pool_size
op_minus
l_int|1
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|tmp
op_assign
id|list_first
c_func
(paren
op_amp
id|info-&gt;tx_urbs_free
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|kfree
c_func
(paren
id|wrap
)paren
suffix:semicolon
id|no_tx_wrap
suffix:colon
id|kfree
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|no_tx_buf
suffix:colon
id|usb_free_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|no_tx_urb
suffix:colon
id|tmp
op_assign
id|list_first
c_func
(paren
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|kfree
c_func
(paren
id|wrap
)paren
suffix:semicolon
id|no_rx_wrap
suffix:colon
id|kfree
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|no_rx_buf
suffix:colon
id|usb_free_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|no_rx_urb
suffix:colon
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
id|no_private
suffix:colon
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|whiteheat_shutdown
r_static
r_void
id|whiteheat_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|command_port
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|whiteheat_private
op_star
id|info
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp2
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* free up our private data for our command port */
id|command_port
op_assign
id|serial-&gt;port
(braket
id|COMMAND_PORT
)braket
suffix:semicolon
id|kfree
(paren
id|usb_get_serial_port_data
c_func
(paren
id|command_port
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port
op_assign
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp2
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
(brace
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|kfree
c_func
(paren
id|wrap
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp2
comma
op_amp
id|info-&gt;tx_urbs_free
)paren
(brace
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|kfree
c_func
(paren
id|wrap
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|whiteheat_open
r_static
r_int
id|whiteheat_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|termios
id|old_term
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|retval
op_assign
id|start_command_port
c_func
(paren
id|port-&gt;serial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty
)paren
id|port-&gt;tty-&gt;low_latency
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* send an open port command */
id|retval
op_assign
id|firm_open
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|stop_command_port
c_func
(paren
id|port-&gt;serial
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|retval
op_assign
id|firm_purge
c_func
(paren
id|port
comma
id|WHITEHEAT_PURGE_RX
op_or
id|WHITEHEAT_PURGE_TX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|firm_close
c_func
(paren
id|port
)paren
suffix:semicolon
id|stop_command_port
c_func
(paren
id|port-&gt;serial
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|old_term.c_cflag
op_assign
op_complement
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|old_term.c_iflag
op_assign
op_complement
id|port-&gt;tty-&gt;termios-&gt;c_iflag
suffix:semicolon
id|whiteheat_set_termios
c_func
(paren
id|port
comma
op_amp
id|old_term
)paren
suffix:semicolon
multiline_comment|/* Work around HCD bugs */
id|usb_clear_halt
c_func
(paren
id|port-&gt;serial-&gt;dev
comma
id|port-&gt;read_urb-&gt;pipe
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|port-&gt;serial-&gt;dev
comma
id|port-&gt;write_urb-&gt;pipe
)paren
suffix:semicolon
multiline_comment|/* Start reading from the device */
id|retval
op_assign
id|start_port_read
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed submitting read urb, error %d&quot;
comma
id|__FUNCTION__
comma
id|retval
)paren
suffix:semicolon
id|firm_close
c_func
(paren
id|port
)paren
suffix:semicolon
id|stop_command_port
c_func
(paren
id|port-&gt;serial
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
m_exit
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - exit, retval = %d&quot;
comma
id|__FUNCTION__
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|whiteheat_close
r_static
r_void
id|whiteheat_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* filp is NULL when called from usb_serial_disconnect */
r_if
c_cond
(paren
id|filp
op_logical_and
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|port-&gt;tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n; * Not currently in use; tty_wait_until_sent() calls&n; * serial_chars_in_buffer() which deadlocks on the second semaphore&n; * acquisition. This should be fixed at some point. Greg&squot;s been&n; * notified.&n;&t;if ((filp-&gt;f_flags &amp; (O_NDELAY | O_NONBLOCK)) == 0) {&n;&t;&t;tty_wait_until_sent(port-&gt;tty, CLOSING_DELAY);&n;&t;}&n;*/
r_if
c_cond
(paren
id|port-&gt;tty-&gt;driver-&gt;flush_buffer
)paren
id|port-&gt;tty-&gt;driver
op_member_access_from_pointer
id|flush_buffer
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty-&gt;ldisc.flush_buffer
)paren
id|port-&gt;tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
id|firm_report_tx_done
c_func
(paren
id|port
)paren
suffix:semicolon
id|firm_close
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* shutdown our bulk reads and writes */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp2
comma
op_amp
id|info-&gt;rx_urbs_submitted
)paren
(brace
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
)brace
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp2
comma
op_amp
id|info-&gt;rx_urb_q
)paren
(brace
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
)brace
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp2
comma
op_amp
id|info-&gt;tx_urbs_submitted
)paren
(brace
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;tx_urbs_free
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|stop_command_port
c_func
(paren
id|port-&gt;serial
)paren
suffix:semicolon
id|port-&gt;tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|whiteheat_write
r_static
r_int
id|whiteheat_write
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|bytes
suffix:semicolon
r_int
id|sent
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - write request of 0 bytes&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|info-&gt;tx_urbs_free
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tmp
op_assign
id|list_first
c_func
(paren
op_amp
id|info-&gt;tx_urbs_free
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|bytes
op_assign
(paren
id|count
OG
id|port-&gt;bulk_out_size
)paren
ques
c_cond
id|port-&gt;bulk_out_size
suffix:colon
id|count
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|urb-&gt;transfer_buffer
comma
id|buf
op_plus
id|sent
comma
id|bytes
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|urb-&gt;transfer_buffer
comma
id|buf
op_plus
id|sent
comma
id|bytes
)paren
suffix:semicolon
)brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|bytes
comma
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|bytes
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed submitting write urb, error %d&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
id|sent
op_assign
id|result
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;tx_urbs_free
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|sent
op_add_assign
id|bytes
suffix:semicolon
id|count
op_sub_assign
id|bytes
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;tx_urbs_submitted
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
id|sent
suffix:semicolon
)brace
DECL|function|whiteheat_write_room
r_static
r_int
id|whiteheat_write_room
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_int
id|room
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;tx_urbs_free
)paren
id|room
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|room
op_mul_assign
id|port-&gt;bulk_out_size
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - returns %d&quot;
comma
id|__FUNCTION__
comma
id|room
)paren
suffix:semicolon
r_return
(paren
id|room
)paren
suffix:semicolon
)brace
DECL|function|whiteheat_tiocmget
r_static
r_int
id|whiteheat_tiocmget
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|modem_signals
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|firm_get_dtr_rts
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;mcr
op_amp
id|UART_MCR_DTR
)paren
id|modem_signals
op_or_assign
id|TIOCM_DTR
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;mcr
op_amp
id|UART_MCR_RTS
)paren
id|modem_signals
op_or_assign
id|TIOCM_RTS
suffix:semicolon
r_return
id|modem_signals
suffix:semicolon
)brace
DECL|function|whiteheat_tiocmset
r_static
r_int
id|whiteheat_tiocmset
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
)paren
id|info-&gt;mcr
op_or_assign
id|UART_MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DTR
)paren
id|info-&gt;mcr
op_or_assign
id|UART_MCR_DTR
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
)paren
id|info-&gt;mcr
op_and_assign
op_complement
id|UART_MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DTR
)paren
id|info-&gt;mcr
op_and_assign
op_complement
id|UART_MCR_DTR
suffix:semicolon
id|firm_set_dtr
c_func
(paren
id|port
comma
id|info-&gt;mcr
op_amp
id|UART_MCR_DTR
)paren
suffix:semicolon
id|firm_set_rts
c_func
(paren
id|port
comma
id|info-&gt;mcr
op_amp
id|UART_MCR_RTS
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|whiteheat_ioctl
r_static
r_int
id|whiteheat_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|serial_struct
id|serstruct
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d, cmd 0x%.4x&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCGSERIAL
suffix:colon
id|memset
c_func
(paren
op_amp
id|serstruct
comma
l_int|0
comma
r_sizeof
(paren
id|serstruct
)paren
)paren
suffix:semicolon
id|serstruct.type
op_assign
id|PORT_16654
suffix:semicolon
id|serstruct.line
op_assign
id|port-&gt;serial-&gt;minor
suffix:semicolon
id|serstruct.port
op_assign
id|port-&gt;number
suffix:semicolon
id|serstruct.flags
op_assign
id|ASYNC_SKIP_TEST
op_or
id|ASYNC_AUTO_IRQ
suffix:semicolon
id|serstruct.xmit_fifo_size
op_assign
id|port-&gt;bulk_out_size
suffix:semicolon
id|serstruct.custom_divisor
op_assign
l_int|0
suffix:semicolon
id|serstruct.baud_base
op_assign
l_int|460800
suffix:semicolon
id|serstruct.close_delay
op_assign
id|CLOSING_DELAY
suffix:semicolon
id|serstruct.closing_wait
op_assign
id|CLOSING_DELAY
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|serstruct
comma
r_sizeof
(paren
id|serstruct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|serstruct
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|serstruct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * For now this is ignored. dip sets the ASYNC_[V]HI flags&n;&t;&t;&t; * but this isn&squot;t used by us at all. Maybe someone somewhere&n;&t;&t;&t; * will need the custom_divisor setting.&n;&t;&t;&t; */
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|function|whiteheat_set_termios
r_static
r_void
id|whiteheat_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s -port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|port-&gt;tty
)paren
op_logical_or
(paren
op_logical_neg
id|port-&gt;tty-&gt;termios
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - no tty structures&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* check that they really want us to change something */
r_if
c_cond
(paren
id|old_termios
)paren
(brace
r_if
c_cond
(paren
(paren
id|port-&gt;tty-&gt;termios-&gt;c_cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
op_logical_and
(paren
id|port-&gt;tty-&gt;termios-&gt;c_iflag
op_eq
id|old_termios-&gt;c_iflag
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nothing to change...&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
id|firm_setup_port
c_func
(paren
id|port
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
suffix:semicolon
)brace
DECL|function|whiteheat_break_ctl
r_static
r_void
id|whiteheat_break_ctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
id|firm_set_break
c_func
(paren
id|port
comma
id|break_state
)paren
suffix:semicolon
)brace
DECL|function|whiteheat_chars_in_buffer
r_static
r_int
id|whiteheat_chars_in_buffer
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_int
id|chars
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;tx_urbs_submitted
)paren
(brace
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|chars
op_add_assign
id|wrap-&gt;urb-&gt;transfer_buffer_length
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - returns %d&quot;
comma
id|__FUNCTION__
comma
id|chars
)paren
suffix:semicolon
r_return
(paren
id|chars
)paren
suffix:semicolon
)brace
DECL|function|whiteheat_throttle
r_static
r_void
id|whiteheat_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|THROTTLED
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|whiteheat_unthrottle
r_static
r_void
id|whiteheat_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|actually_throttled
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|actually_throttled
op_assign
id|info-&gt;flags
op_amp
id|ACTUALLY_THROTTLED
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|THROTTLED
op_or
id|ACTUALLY_THROTTLED
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|actually_throttled
)paren
id|rx_data_softint
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Connect Tech&squot;s White Heat callback routines&n; *****************************************************************************/
DECL|function|command_port_write_callback
r_static
r_void
id|command_port_write_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
(paren
l_string|&quot;nonzero urb status: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|command_port_read_callback
r_static
r_void
id|command_port_read_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|command_port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|get_usb_serial
(paren
id|command_port
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_struct
id|whiteheat_command_private
op_star
id|command_info
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero urb status: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|serial
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - bad serial pointer, exiting&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|data
)paren
suffix:semicolon
id|command_info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|command_port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|command_info
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - command_info is NULL, exiting.&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|WHITEHEAT_CMD_COMPLETE
)paren
(brace
id|command_info-&gt;command_finished
op_assign
id|WHITEHEAT_CMD_COMPLETE
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|command_info-&gt;wait_command
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|WHITEHEAT_CMD_FAILURE
)paren
(brace
id|command_info-&gt;command_finished
op_assign
id|WHITEHEAT_CMD_FAILURE
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|command_info-&gt;wait_command
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|WHITEHEAT_EVENT
)paren
(brace
multiline_comment|/* These are unsolicited reports from the firmware, hence no waiting command to wakeup */
id|dbg
c_func
(paren
l_string|&quot;%s - event received&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|WHITEHEAT_GET_DTR_RTS
)paren
(brace
id|memcpy
c_func
(paren
id|command_info-&gt;result_buffer
comma
op_amp
id|data
(braket
l_int|1
)braket
comma
id|urb-&gt;actual_length
op_minus
l_int|1
)paren
suffix:semicolon
id|command_info-&gt;command_finished
op_assign
id|WHITEHEAT_CMD_COMPLETE
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|command_info-&gt;wait_command
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - bad reply from firmware&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/* Continue trying to always read */
id|command_port-&gt;read_urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|command_port-&gt;read_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|dbg
c_func
(paren
l_string|&quot;%s - failed resubmitting read urb, error %d&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
)brace
DECL|function|whiteheat_read_callback
r_static
r_void
id|whiteheat_read_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|get_usb_serial
(paren
id|port
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|wrap
op_assign
id|urb_to_wrap
c_func
(paren
id|urb
comma
op_amp
id|info-&gt;rx_urbs_submitted
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wrap
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s - Not my urb!&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|wrap-&gt;list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - bad serial pointer, exiting&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|wrap-&gt;list
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero read bulk status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|wrap-&gt;list
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|data
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|wrap-&gt;list
comma
op_amp
id|info-&gt;rx_urb_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|THROTTLED
)paren
(brace
id|info-&gt;flags
op_or_assign
id|ACTUALLY_THROTTLED
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|info-&gt;rx_work
)paren
suffix:semicolon
)brace
DECL|function|whiteheat_write_callback
r_static
r_void
id|whiteheat_write_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|get_usb_serial
(paren
id|port
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|wrap
op_assign
id|urb_to_wrap
c_func
(paren
id|urb
comma
op_amp
id|info-&gt;tx_urbs_submitted
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wrap
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;%s - Not my urb!&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|wrap-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|wrap-&gt;list
comma
op_amp
id|info-&gt;tx_urbs_free
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - bad serial pointer, exiting&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero write bulk status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_serial_port_softint
c_func
(paren
(paren
r_void
op_star
)paren
id|port
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|port-&gt;work
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Connect Tech&squot;s White Heat firmware interface&n; *****************************************************************************/
DECL|function|firm_send_command
r_static
r_int
id|firm_send_command
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|command
comma
id|__u8
op_star
id|data
comma
id|__u8
id|datasize
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|command_port
suffix:semicolon
r_struct
id|whiteheat_command_private
op_star
id|command_info
suffix:semicolon
r_struct
id|whiteheat_private
op_star
id|info
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|__u8
op_star
id|transfer_buffer
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - command %d&quot;
comma
id|__FUNCTION__
comma
id|command
)paren
suffix:semicolon
id|command_port
op_assign
id|port-&gt;serial-&gt;port
(braket
id|COMMAND_PORT
)braket
suffix:semicolon
id|command_info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|command_port
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|command_info-&gt;command_finished
op_assign
id|FALSE
suffix:semicolon
id|transfer_buffer
op_assign
(paren
id|__u8
op_star
)paren
id|command_port-&gt;write_urb-&gt;transfer_buffer
suffix:semicolon
id|transfer_buffer
(braket
l_int|0
)braket
op_assign
id|command
suffix:semicolon
id|memcpy
(paren
op_amp
id|transfer_buffer
(braket
l_int|1
)braket
comma
id|data
comma
id|datasize
)paren
suffix:semicolon
id|command_port-&gt;write_urb-&gt;transfer_buffer_length
op_assign
id|datasize
op_plus
l_int|1
suffix:semicolon
id|command_port-&gt;write_urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|retval
op_assign
id|usb_submit_urb
(paren
id|command_port-&gt;write_urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - submit urb failed&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* wait for the command to complete */
id|timeout
op_assign
id|COMMAND_TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_logical_and
(paren
id|command_info-&gt;command_finished
op_eq
id|FALSE
)paren
)paren
(brace
id|timeout
op_assign
id|interruptible_sleep_on_timeout
(paren
op_amp
id|command_info-&gt;wait_command
comma
id|timeout
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command_info-&gt;command_finished
op_eq
id|FALSE
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - command timed out.&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_info-&gt;command_finished
op_eq
id|WHITEHEAT_CMD_FAILURE
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - command failed.&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_info-&gt;command_finished
op_eq
id|WHITEHEAT_CMD_COMPLETE
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - command completed.&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|WHITEHEAT_GET_DTR_RTS
suffix:colon
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|info-&gt;mcr
comma
id|command_info-&gt;result_buffer
comma
r_sizeof
(paren
r_struct
id|whiteheat_dr_info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
m_exit
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|firm_open
r_static
r_int
id|firm_open
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_simple
id|open_command
suffix:semicolon
id|open_command.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
op_plus
l_int|1
suffix:semicolon
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_OPEN
comma
(paren
id|__u8
op_star
)paren
op_amp
id|open_command
comma
r_sizeof
(paren
id|open_command
)paren
)paren
suffix:semicolon
)brace
DECL|function|firm_close
r_static
r_int
id|firm_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_simple
id|close_command
suffix:semicolon
id|close_command.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
op_plus
l_int|1
suffix:semicolon
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_CLOSE
comma
(paren
id|__u8
op_star
)paren
op_amp
id|close_command
comma
r_sizeof
(paren
id|close_command
)paren
)paren
suffix:semicolon
)brace
DECL|function|firm_setup_port
r_static
r_int
id|firm_setup_port
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_port_settings
id|port_settings
suffix:semicolon
r_int
r_int
id|cflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|port_settings.port
op_assign
id|port-&gt;number
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* get the byte size */
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|port_settings.bits
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|port_settings.bits
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|port_settings.bits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|CS8
suffix:colon
id|port_settings.bits
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - data bits = %d&quot;
comma
id|__FUNCTION__
comma
id|port_settings.bits
)paren
suffix:semicolon
multiline_comment|/* determine the parity */
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
r_if
c_cond
(paren
id|cflag
op_amp
id|CMSPAR
)paren
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
id|port_settings.parity
op_assign
id|WHITEHEAT_PAR_MARK
suffix:semicolon
r_else
id|port_settings.parity
op_assign
id|WHITEHEAT_PAR_SPACE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
id|port_settings.parity
op_assign
id|WHITEHEAT_PAR_ODD
suffix:semicolon
r_else
id|port_settings.parity
op_assign
id|WHITEHEAT_PAR_EVEN
suffix:semicolon
r_else
id|port_settings.parity
op_assign
id|WHITEHEAT_PAR_NONE
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - parity = %c&quot;
comma
id|__FUNCTION__
comma
id|port_settings.parity
)paren
suffix:semicolon
multiline_comment|/* figure out the stop bits requested */
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|port_settings.stop
op_assign
l_int|2
suffix:semicolon
r_else
id|port_settings.stop
op_assign
l_int|1
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - stop bits = %d&quot;
comma
id|__FUNCTION__
comma
id|port_settings.stop
)paren
suffix:semicolon
multiline_comment|/* figure out the flow control settings */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|port_settings.hflow
op_assign
(paren
id|WHITEHEAT_HFLOW_CTS
op_or
id|WHITEHEAT_HFLOW_RTS
)paren
suffix:semicolon
r_else
id|port_settings.hflow
op_assign
id|WHITEHEAT_HFLOW_NONE
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - hardware flow control = %s %s %s %s&quot;
comma
id|__FUNCTION__
comma
(paren
id|port_settings.hflow
op_amp
id|WHITEHEAT_HFLOW_CTS
)paren
ques
c_cond
l_string|&quot;CTS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|port_settings.hflow
op_amp
id|WHITEHEAT_HFLOW_RTS
)paren
ques
c_cond
l_string|&quot;RTS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|port_settings.hflow
op_amp
id|WHITEHEAT_HFLOW_DSR
)paren
ques
c_cond
l_string|&quot;DSR&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|port_settings.hflow
op_amp
id|WHITEHEAT_HFLOW_DTR
)paren
ques
c_cond
l_string|&quot;DTR&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* determine software flow control */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|port-&gt;tty
)paren
)paren
id|port_settings.sflow
op_assign
id|WHITEHEAT_SFLOW_RXTX
suffix:semicolon
r_else
id|port_settings.sflow
op_assign
id|WHITEHEAT_SFLOW_NONE
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - software flow control = %c&quot;
comma
id|__FUNCTION__
comma
id|port_settings.sflow
)paren
suffix:semicolon
id|port_settings.xon
op_assign
id|START_CHAR
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
id|port_settings.xoff
op_assign
id|STOP_CHAR
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - XON = %2x, XOFF = %2x&quot;
comma
id|__FUNCTION__
comma
id|port_settings.xon
comma
id|port_settings.xoff
)paren
suffix:semicolon
multiline_comment|/* get the baud rate wanted */
id|port_settings.baud
op_assign
id|tty_get_baud_rate
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - baud rate = %d&quot;
comma
id|__FUNCTION__
comma
id|port_settings.baud
)paren
suffix:semicolon
multiline_comment|/* handle any settings that aren&squot;t specified in the tty structure */
id|port_settings.lloop
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* now send the message to the device */
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_SETUP_PORT
comma
(paren
id|__u8
op_star
)paren
op_amp
id|port_settings
comma
r_sizeof
(paren
id|port_settings
)paren
)paren
suffix:semicolon
)brace
DECL|function|firm_set_rts
r_static
r_int
id|firm_set_rts
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|onoff
)paren
(brace
r_struct
id|whiteheat_set_rdb
id|rts_command
suffix:semicolon
id|rts_command.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
op_plus
l_int|1
suffix:semicolon
id|rts_command.state
op_assign
id|onoff
suffix:semicolon
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_SET_RTS
comma
(paren
id|__u8
op_star
)paren
op_amp
id|rts_command
comma
r_sizeof
(paren
id|rts_command
)paren
)paren
suffix:semicolon
)brace
DECL|function|firm_set_dtr
r_static
r_int
id|firm_set_dtr
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|onoff
)paren
(brace
r_struct
id|whiteheat_set_rdb
id|dtr_command
suffix:semicolon
id|dtr_command.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
op_plus
l_int|1
suffix:semicolon
id|dtr_command.state
op_assign
id|onoff
suffix:semicolon
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_SET_RTS
comma
(paren
id|__u8
op_star
)paren
op_amp
id|dtr_command
comma
r_sizeof
(paren
id|dtr_command
)paren
)paren
suffix:semicolon
)brace
DECL|function|firm_set_break
r_static
r_int
id|firm_set_break
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|onoff
)paren
(brace
r_struct
id|whiteheat_set_rdb
id|break_command
suffix:semicolon
id|break_command.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
op_plus
l_int|1
suffix:semicolon
id|break_command.state
op_assign
id|onoff
suffix:semicolon
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_SET_RTS
comma
(paren
id|__u8
op_star
)paren
op_amp
id|break_command
comma
r_sizeof
(paren
id|break_command
)paren
)paren
suffix:semicolon
)brace
DECL|function|firm_purge
r_static
r_int
id|firm_purge
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u8
id|rxtx
)paren
(brace
r_struct
id|whiteheat_purge
id|purge_command
suffix:semicolon
id|purge_command.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
op_plus
l_int|1
suffix:semicolon
id|purge_command.what
op_assign
id|rxtx
suffix:semicolon
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_PURGE
comma
(paren
id|__u8
op_star
)paren
op_amp
id|purge_command
comma
r_sizeof
(paren
id|purge_command
)paren
)paren
suffix:semicolon
)brace
DECL|function|firm_get_dtr_rts
r_static
r_int
id|firm_get_dtr_rts
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_simple
id|get_dr_command
suffix:semicolon
id|get_dr_command.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
op_plus
l_int|1
suffix:semicolon
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_GET_DTR_RTS
comma
(paren
id|__u8
op_star
)paren
op_amp
id|get_dr_command
comma
r_sizeof
(paren
id|get_dr_command
)paren
)paren
suffix:semicolon
)brace
DECL|function|firm_report_tx_done
r_static
r_int
id|firm_report_tx_done
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_simple
id|close_command
suffix:semicolon
id|close_command.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
op_plus
l_int|1
suffix:semicolon
r_return
id|firm_send_command
c_func
(paren
id|port
comma
id|WHITEHEAT_REPORT_TX_DONE
comma
(paren
id|__u8
op_star
)paren
op_amp
id|close_command
comma
r_sizeof
(paren
id|close_command
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Connect Tech&squot;s White Heat utility functions&n; *****************************************************************************/
DECL|function|start_command_port
r_static
r_int
id|start_command_port
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|command_port
suffix:semicolon
r_struct
id|whiteheat_command_private
op_star
id|command_info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|command_port
op_assign
id|serial-&gt;port
(braket
id|COMMAND_PORT
)braket
suffix:semicolon
id|command_info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|command_port
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|command_info-&gt;port_running
)paren
(brace
multiline_comment|/* Work around HCD bugs */
id|usb_clear_halt
c_func
(paren
id|serial-&gt;dev
comma
id|command_port-&gt;read_urb-&gt;pipe
)paren
suffix:semicolon
id|command_port-&gt;read_urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
id|retval
op_assign
id|usb_submit_urb
c_func
(paren
id|command_port-&gt;read_urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed submitting read urb, error %d&quot;
comma
id|__FUNCTION__
comma
id|retval
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
id|command_info-&gt;port_running
op_increment
suffix:semicolon
m_exit
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|stop_command_port
r_static
r_void
id|stop_command_port
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|command_port
suffix:semicolon
r_struct
id|whiteheat_command_private
op_star
id|command_info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|command_port
op_assign
id|serial-&gt;port
(braket
id|COMMAND_PORT
)braket
suffix:semicolon
id|command_info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|command_port
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|command_info-&gt;port_running
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|command_info-&gt;port_running
)paren
id|usb_unlink_urb
c_func
(paren
id|command_port-&gt;read_urb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|command_info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_port_read
r_static
r_int
id|start_port_read
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp2
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp2
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
(brace
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|retval
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp2
comma
op_amp
id|info-&gt;rx_urbs_submitted
)paren
(brace
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;rx_urbs_submitted
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|urb_to_wrap
r_static
r_struct
id|whiteheat_urb_wrap
op_star
id|urb_to_wrap
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|list_head
op_star
id|head
)paren
(brace
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
id|head
)paren
(brace
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wrap-&gt;urb
op_eq
id|urb
)paren
r_return
id|wrap
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|list_first
r_static
r_struct
id|list_head
op_star
id|list_first
c_func
(paren
r_struct
id|list_head
op_star
id|head
)paren
(brace
r_return
id|head-&gt;next
suffix:semicolon
)brace
DECL|function|rx_data_softint
r_static
r_void
id|rx_data_softint
c_func
(paren
r_void
op_star
r_private
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
r_private
suffix:semicolon
r_struct
id|whiteheat_private
op_star
id|info
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_struct
id|whiteheat_urb_wrap
op_star
id|wrap
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp2
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|sent
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|THROTTLED
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp2
comma
op_amp
id|info-&gt;rx_urb_q
)paren
(brace
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|wrap
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|whiteheat_urb_wrap
comma
id|list
)paren
suffix:semicolon
id|urb
op_assign
id|wrap-&gt;urb
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_logical_and
id|urb-&gt;actual_length
)paren
(brace
r_if
c_cond
(paren
id|urb-&gt;actual_length
OG
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;rx_urb_q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|info-&gt;rx_work
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|tty-&gt;flip.char_buf_ptr
comma
id|urb-&gt;transfer_buffer
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|urb-&gt;actual_length
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|urb-&gt;actual_length
suffix:semicolon
id|sent
op_add_assign
id|urb-&gt;actual_length
suffix:semicolon
)brace
id|urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed resubmitting read urb, error %d&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;rx_urbs_free
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|tmp
comma
op_amp
id|info-&gt;rx_urbs_submitted
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sent
)paren
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Connect Tech&squot;s White Heat module functions&n; *****************************************************************************/
DECL|function|whiteheat_init
r_static
r_int
id|__init
id|whiteheat_init
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|usb_serial_register
c_func
(paren
op_amp
id|whiteheat_fake_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|failed_fake_register
suffix:semicolon
id|retval
op_assign
id|usb_serial_register
c_func
(paren
op_amp
id|whiteheat_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|failed_device_register
suffix:semicolon
id|retval
op_assign
id|usb_register
c_func
(paren
op_amp
id|whiteheat_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|failed_usb_register
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed_usb_register
suffix:colon
id|usb_serial_deregister
c_func
(paren
op_amp
id|whiteheat_device
)paren
suffix:semicolon
id|failed_device_register
suffix:colon
id|usb_serial_deregister
c_func
(paren
op_amp
id|whiteheat_fake_device
)paren
suffix:semicolon
id|failed_fake_register
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|whiteheat_exit
r_static
r_void
id|__exit
id|whiteheat_exit
(paren
r_void
)paren
(brace
id|usb_deregister
(paren
op_amp
id|whiteheat_driver
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|whiteheat_fake_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|whiteheat_device
)paren
suffix:semicolon
)brace
DECL|variable|whiteheat_init
id|module_init
c_func
(paren
id|whiteheat_init
)paren
suffix:semicolon
DECL|variable|whiteheat_exit
id|module_exit
c_func
(paren
id|whiteheat_exit
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|urb_pool_size
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|urb_pool_size
comma
l_string|&quot;Number of urbs to use for buffering&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug enabled or not&quot;
)paren
suffix:semicolon
eof
