multiline_comment|/*&n; * Edgeport USB Serial Converter driver&n; *&n; * Copyright(c) 2000 Inside Out Networks, All rights reserved.&n; * Copyright(c) 2001-2002 Greg Kroah-Hartman &lt;greg@kroah.com&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; * Supports the following devices:&n; *&t;Edgeport/4&n; *&t;Edgeport/4t&n; *&t;Edgeport/2&n; *&t;Edgeport/4i&n; *&t;Edgeport/2i&n; *&t;Edgeport/421&n; *&t;Edgeport/21&n; *&t;Rapidport/4&n; *&t;Edgeport/8&n; *&t;Edgeport/2D8&n; *&t;Edgeport/4D8&n; *&t;Edgeport/8i&n; *&n; * Version history:&n; * &n; * 2.3 2002_03_08 greg kroah-hartman&n; *&t;- fixed bug when multiple devices were attached at the same time.&n; *&n; * 2.2 2001_11_14 greg kroah-hartman&n; *&t;- fixed bug in edge_close that kept the port from being used more&n; *&t;  than once.&n; *&t;- fixed memory leak on device removal.&n; *&t;- fixed potential double free of memory when command urb submitting&n; *&t;  failed.&n; *&t;- other small cleanups when the device is removed&n; *&t;&n; * 2.1 2001_07_09 greg kroah-hartman&n; *&t;- added support for TIOCMBIS and TIOCMBIC.&n; *&n; *     (04/08/2001) gb&n; *&t;- Identify version on module load.&n; *&n; * 2.0 2001_03_05 greg kroah-hartman&n; *&t;- reworked entire driver to fit properly in with the other usb-serial&n; *&t;  drivers.  Occasional oopses still happen, but it&squot;s a good start.&n; *&n; * 1.2.3 (02/23/2001) greg kroah-hartman&n; *&t;- changed device table to work properly for 2.4.x final format.&n; *&t;- fixed problem with dropping data at high data rates.&n; *&n; * 1.2.2 (11/27/2000) greg kroah-hartman&n; *&t;- cleaned up more NTisms.&n; *&t;- Added device table for 2.4.0-test11&n; *&n; * 1.2.1 (11/08/2000) greg kroah-hartman&n; *&t;- Started to clean up NTisms.&n; *&t;- Fixed problem with dev field of urb for kernels &gt;= 2.4.0-test9&n; *&n; * 1.2 (10/17/2000) David Iacovelli&n; * &t;Remove all EPIC code and GPL source&n; *  Fix RELEVANT_IFLAG macro to include flow control &n; *  changes port configuration changes.&n; *  Fix redefinition of SERIAL_MAGIC&n; *  Change all timeout values to 5 seconds&n; *  Tried to fix the UHCI multiple urb submission, but failed miserably.&n; *  it seems to work fine with OHCI.&n; *  ( Greg take a look at the #if 0 at end of WriteCmdUsb() we must &n; *    find a way to work arount this UHCI bug )&n; *&n; * 1.1 (10/11/2000) David Iacovelli&n; *  Fix XON/XOFF flow control to support both IXON and IXOFF&n; *&n; * 0.9.27 (06/30/2000) David Iacovelli&n; *  Added transmit queue and now allocate urb for command writes.&n; *&n; * 0.9.26 (06/29/2000) David Iacovelli&n; *  Add support for 80251 based edgeport&n; *&n; * 0.9.25 (06/27/2000) David Iacovelli&n; *  Do not close the port if it has multiple opens.&n; *&n; * 0.9.24 (05/26/2000) David Iacovelli&n; *  Add IOCTLs to support RXTX and JAVA POS &n; *  and first cut at running BlackBox Demo&n; *&n; * 0.9.23 (05/24/2000) David Iacovelli&n; *  Add IOCTLs to support RXTX and JAVA POS&n; *&n; * 0.9.22 (05/23/2000) David Iacovelli&n; *  fixed bug in enumeration.  If epconfig turns on mapping by&n; *  path after a device is already plugged in, we now update&n; *  the mapping correctly&n; *&n; * 0.9.21 (05/16/2000) David Iacovelli&n; *  Added BlockUntilChaseResp() to also wait for txcredits&n; *  Updated the way we allocate and handle write URBs &n; *&t;Add debug code to dump buffers&n; *&n; * 0.9.20 (05/01/2000) David Iacovelli&n; *&t;change driver to use usb/tts/&n; *&n; * 0.9.19 (05/01/2000) David Iacovelli&n; *  Update code to compile if DEBUG is off&n; *&n; * 0.9.18 (04/28/2000) David Iacovelli&n; *  cleanup and test tty_register with devfs&n; *&n; * 0.9.17 (04/27/2000) greg kroah-hartman&n; * &t;changed tty_register around to be like the way it&n; * &t;was before, but now it works properly with devfs.&n; *&n; * 0.9.16 (04/26/2000) david iacovelli&n; *  Fixed bug in GetProductInfo()&n; *&n; * 0.9.15 (04/25/2000) david iacovelli&n; *&t;Updated enumeration&n; *&n; * 0.9.14 (04/24/2000) david iacovelli&n; *  Removed all config/status IOCTLS and &n; *  converted to using /proc/edgeport&n; *  still playing with devfs&n; *&n; * 0.9.13 (04/24/2000) david iacovelli&n; *  Removed configuration based on ttyUSB0&n; *  Added support for configuration using /prod/edgeport&n; *  first attempt at using devfs (not working yet!)&n; *  Added IOCTL to GetProductInfo()&n; *  Added support for custom baud rates&n; *&t;Add support for random port numbers&n; *&n; * 0.9.12 (04/18/2000) david iacovelli&n; *&t;added additional configuration IOCTLs&n; *  use ttyUSB0 for configuration&n; *&n; * 0.9.11 (04/17/2000) greg kroah-hartman&n; *&t;fixed module initialization race conditions.&n; *&t;made all urbs dynamically allocated.&n; *&t;made driver devfs compatible. now it only registers the tty device&n; *&t;when the device is actually plugged in.&n; *&n; * 0.9.10 (04/13/2000) greg kroah-hartman&n; *&t;added proc interface framework.&n; *&n; * 0.9.9 (04/13/2000) david iacovelli&n; *&t;added enumeration code and ioctls to configure the device&n; *&n; * 0.9.8 (04/12/2000) david iacovelli&n; *  Change interrupt read start when device is plugged in&n; *  and stop when device is removed&n; *&t;process interrupt reads when all ports are closed &n; *  (keep value of rxBytesAvail consistent with the edgeport)&n; *  set the USB_BULK_QUEUE flag so that we can shove a bunch &n; *  of urbs at once down the pipe &n; *&n; * 0.9.7 (04/10/2000) david iacovelli&n; * &t;start to add enumeration code.&n; *  generate serial number for epic devices&n; *  add support for kdb&n; *&n; * 0.9.6 (03/30/2000) david iacovelli&n; *  add IOCTL to get string, manufacture, and boot descriptors&n; *&n; * 0.9.5 (03/14/2000) greg kroah-hartman&n; *&t;more error checking added to SerialOpen to try to fix UHCI open problem&n; *&n; * 0.9.4 (03/09/2000) greg kroah-hartman&n; *&t;added more error checking to handle oops when data is hanging&n; *&t;around and tty is abruptly closed.&n; *&n; * 0.9.3 (03/09/2000) david iacovelli&n; *&t;Add epic support for xon/xoff chars&n; *&t;play with performance&n; *&n; * 0.9.2 (03/08/2000) greg kroah-hartman&n; *&t;changed most &quot;info&quot; calls to &quot;dbg&quot;&n; *&t;implemented flow control properly in the termios call&n; *&n; * 0.9.1 (03/08/2000) david iacovelli&n; *&t;added EPIC support&n; *&t;enabled bootloader update&n; *&n; * 0.9 (03/08/2000) greg kroah-hartman&n; *&t;Release to IO networks.&n; *&t;Integrated changes that David made&n; *  made getting urbs for writing SMP safe&n; *&n; * 0.8 (03/07/2000) greg kroah-hartman&n; *&t;Release to IO networks.&n; *&t;Fixed problems that were seen in code by David.&n; *  Now both Edgeport/4 and Edgeport/2 works properly.&n; *  Changed most of the functions to use port instead of serial.&n; *&n; * 0.7 (02/27/2000) greg kroah-hartman&n; *&t;Milestone 3 release.&n; *&t;Release to IO Networks&n; *&t;ioctl for waiting on line change implemented.&n; *&t;ioctl for getting statistics implemented.&n; *&t;multiport support working.&n; *&t;lsr and msr registers are now handled properly.&n; *&t;change break now hooked up and working.&n; *&t;support for all known Edgeport devices.&n; *&n; * 0.6 (02/22/2000) greg kroah-hartman&n; *&t;Release to IO networks.&n; *&t;CHASE is implemented correctly when port is closed.&n; *&t;SerialOpen now blocks correctly until port is fully opened.&n; *&n; * 0.5 (02/20/2000) greg kroah-hartman&n; *&t;Release to IO networks.&n; *&t;Known problems:&n; *&t;&t;modem status register changes are not sent on to the user&n; *&t;&t;CHASE is not implemented when the port is closed.&n; *&n; * 0.4 (02/16/2000) greg kroah-hartman&n; *&t;Second cut at the CeBit demo.&n; *&t;Doesn&squot;t leak memory on every write to the port&n; *&t;Still small leaks on startup.&n; *&t;Added support for Edgeport/2 and Edgeport/8&n; *&n; * 0.3 (02/15/2000) greg kroah-hartman&n; *&t;CeBit demo release.&n; *&t;Force the line settings to 4800, 8, 1, e for the demo.&n; *&t;Warning! This version leaks memory like crazy!&n; *&n; * 0.2 (01/30/2000) greg kroah-hartman&n; *&t;Milestone 1 release.&n; *&t;Device is found by USB subsystem, enumerated, fimware is downloaded&n; *&t;and the descriptors are printed to the debug log, config is set, and&n; *&t;green light starts to blink. Open port works, and data can be sent&n; *&t;and received at the default settings of the UART. Loopback connector&n; *&t;and debug log confirms this.&n; * &n; * 0.1 (01/23/2000) greg kroah-hartman&n; *&t;Initial release to help IO Networks try to set up their test system. &n; *&t;Edgeport4 is recognized, firmware is downloaded, config is set so &n; *&t;device blinks green light every 3 sec. Port is bound, but opening,&n; *&t;closing, and sending data do not work properly.&n; * &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
macro_line|#endif
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;io_edgeport.h&quot;
macro_line|#include &quot;io_ionsp.h&quot;&t;&t;/* info for the iosp messages */
macro_line|#include &quot;io_16654.h&quot;&t;&t;/* 16654 UART defines */
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v2.2&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Greg Kroah-Hartman &lt;greg@kroah.com&gt; and David Iacovelli&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;Edgeport USB Serial Driver&quot;
multiline_comment|/* First, the latest boot code - for first generation edgeports */
DECL|macro|IMAGE_ARRAY_NAME
mdefine_line|#define IMAGE_ARRAY_NAME&t;BootCodeImage_GEN1
DECL|macro|IMAGE_VERSION_NAME
mdefine_line|#define IMAGE_VERSION_NAME&t;BootCodeImageVersion_GEN1
macro_line|#include &quot;io_fw_boot.h&quot;&t;&t;/* the bootloader firmware to download to a device, if it needs it */
multiline_comment|/* for second generation edgeports */
DECL|macro|IMAGE_ARRAY_NAME
mdefine_line|#define IMAGE_ARRAY_NAME&t;BootCodeImage_GEN2
DECL|macro|IMAGE_VERSION_NAME
mdefine_line|#define IMAGE_VERSION_NAME&t;BootCodeImageVersion_GEN2
macro_line|#include &quot;io_fw_boot2.h&quot;&t;/* the bootloader firmware to download to a device, if it needs it */
multiline_comment|/* Then finally the main run-time operational code - for first generation edgeports */
DECL|macro|IMAGE_ARRAY_NAME
mdefine_line|#define IMAGE_ARRAY_NAME&t;OperationalCodeImage_GEN1
DECL|macro|IMAGE_VERSION_NAME
mdefine_line|#define IMAGE_VERSION_NAME&t;OperationalCodeImageVersion_GEN1
macro_line|#include &quot;io_fw_down.h&quot;&t;&t;/* Define array OperationalCodeImage[] */
multiline_comment|/* for second generation edgeports */
DECL|macro|IMAGE_ARRAY_NAME
mdefine_line|#define IMAGE_ARRAY_NAME&t;OperationalCodeImage_GEN2
DECL|macro|IMAGE_VERSION_NAME
mdefine_line|#define IMAGE_VERSION_NAME&t;OperationalCodeImageVersion_GEN2
macro_line|#include &quot;io_fw_down2.h&quot;&t;/* Define array OperationalCodeImage[] */
DECL|macro|MAX_NAME_LEN
mdefine_line|#define MAX_NAME_LEN&t;&t;64
DECL|macro|CHASE_TIMEOUT
mdefine_line|#define CHASE_TIMEOUT&t;&t;(5*HZ)&t;&t;/* 5 seconds */
DECL|macro|OPEN_TIMEOUT
mdefine_line|#define OPEN_TIMEOUT&t;&t;(5*HZ)&t;&t;/* 5 seconds */
DECL|macro|COMMAND_TIMEOUT
mdefine_line|#define COMMAND_TIMEOUT&t;&t;(5*HZ)&t;&t;/* 5 seconds */
macro_line|#ifndef SERIAL_MAGIC
DECL|macro|SERIAL_MAGIC
mdefine_line|#define SERIAL_MAGIC&t;0x6702
macro_line|#endif
DECL|macro|PORT_MAGIC
mdefine_line|#define PORT_MAGIC&t;&t;0x7301
multiline_comment|/* receive port state */
DECL|enum|RXSTATE
r_enum
id|RXSTATE
(brace
DECL|enumerator|EXPECT_HDR1
id|EXPECT_HDR1
op_assign
l_int|0
comma
multiline_comment|/* Expect header byte 1 */
DECL|enumerator|EXPECT_HDR2
id|EXPECT_HDR2
op_assign
l_int|1
comma
multiline_comment|/* Expect header byte 2 */
DECL|enumerator|EXPECT_DATA
id|EXPECT_DATA
op_assign
l_int|2
comma
multiline_comment|/* Expect &squot;RxBytesRemaining&squot; data */
DECL|enumerator|EXPECT_HDR3
id|EXPECT_HDR3
op_assign
l_int|3
comma
multiline_comment|/* Expect header byte 3 (for status hdrs only) */
)brace
suffix:semicolon
multiline_comment|/* Transmit Fifo &n; * This Transmit queue is an extension of the edgeport Rx buffer. &n; * The maximum amount of data buffered in both the edgeport &n; * Rx buffer (maxTxCredits) and this buffer will never exceed maxTxCredits.&n; */
DECL|struct|TxFifo
r_struct
id|TxFifo
(brace
DECL|member|head
r_int
r_int
id|head
suffix:semicolon
multiline_comment|/* index to head pointer (write) */
DECL|member|tail
r_int
r_int
id|tail
suffix:semicolon
multiline_comment|/* index to tail pointer (read)  */
DECL|member|count
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* Bytes in queue */
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
multiline_comment|/* Max size of queue (equal to Max number of TxCredits) */
DECL|member|fifo
r_int
r_char
op_star
id|fifo
suffix:semicolon
multiline_comment|/* allocated Buffer */
)brace
suffix:semicolon
multiline_comment|/* This structure holds all of the local port information */
DECL|struct|edgeport_port
r_struct
id|edgeport_port
(brace
DECL|member|txCredits
id|__u16
id|txCredits
suffix:semicolon
multiline_comment|/* our current credits for this port */
DECL|member|maxTxCredits
id|__u16
id|maxTxCredits
suffix:semicolon
multiline_comment|/* the max size of the port */
DECL|member|txfifo
r_struct
id|TxFifo
id|txfifo
suffix:semicolon
multiline_comment|/* transmit fifo -- size will be maxTxCredits */
DECL|member|write_urb
r_struct
id|urb
op_star
id|write_urb
suffix:semicolon
multiline_comment|/* write URB for this port */
DECL|member|write_in_progress
r_char
id|write_in_progress
suffix:semicolon
multiline_comment|/* TRUE while a write URB is outstanding */
DECL|member|shadowLCR
id|__u8
id|shadowLCR
suffix:semicolon
multiline_comment|/* last LCR value received */
DECL|member|shadowMCR
id|__u8
id|shadowMCR
suffix:semicolon
multiline_comment|/* last MCR value received */
DECL|member|shadowMSR
id|__u8
id|shadowMSR
suffix:semicolon
multiline_comment|/* last MSR value received */
DECL|member|shadowLSR
id|__u8
id|shadowLSR
suffix:semicolon
multiline_comment|/* last LSR value received */
DECL|member|shadowXonChar
id|__u8
id|shadowXonChar
suffix:semicolon
multiline_comment|/* last value set as XON char in Edgeport */
DECL|member|shadowXoffChar
id|__u8
id|shadowXoffChar
suffix:semicolon
multiline_comment|/* last value set as XOFF char in Edgeport */
DECL|member|validDataMask
id|__u8
id|validDataMask
suffix:semicolon
DECL|member|baudRate
id|__u32
id|baudRate
suffix:semicolon
DECL|member|open
r_char
id|open
suffix:semicolon
DECL|member|openPending
r_char
id|openPending
suffix:semicolon
DECL|member|commandPending
r_char
id|commandPending
suffix:semicolon
DECL|member|closePending
r_char
id|closePending
suffix:semicolon
DECL|member|chaseResponsePending
r_char
id|chaseResponsePending
suffix:semicolon
DECL|member|wait_chase
id|wait_queue_head_t
id|wait_chase
suffix:semicolon
multiline_comment|/* for handling sleeping while waiting for chase to finish */
DECL|member|wait_open
id|wait_queue_head_t
id|wait_open
suffix:semicolon
multiline_comment|/* for handling sleeping while waiting for open to finish */
DECL|member|wait_command
id|wait_queue_head_t
id|wait_command
suffix:semicolon
multiline_comment|/* for handling sleeping while waiting for command to finish */
DECL|member|delta_msr_wait
id|wait_queue_head_t
id|delta_msr_wait
suffix:semicolon
multiline_comment|/* for handling sleeping while waiting for msr change to happen */
DECL|member|icount
r_struct
id|async_icount
id|icount
suffix:semicolon
DECL|member|port
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
multiline_comment|/* loop back to the owner of this object */
)brace
suffix:semicolon
multiline_comment|/* This structure holds all of the individual device information */
DECL|struct|edgeport_serial
r_struct
id|edgeport_serial
(brace
DECL|member|name
r_char
id|name
(braket
id|MAX_NAME_LEN
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* string name of this device */
DECL|member|manuf_descriptor
r_struct
id|edge_manuf_descriptor
id|manuf_descriptor
suffix:semicolon
multiline_comment|/* the manufacturer descriptor */
DECL|member|boot_descriptor
r_struct
id|edge_boot_descriptor
id|boot_descriptor
suffix:semicolon
multiline_comment|/* the boot firmware descriptor */
DECL|member|product_info
r_struct
id|edgeport_product_info
id|product_info
suffix:semicolon
multiline_comment|/* Product Info */
DECL|member|interrupt_in_endpoint
id|__u8
id|interrupt_in_endpoint
suffix:semicolon
multiline_comment|/* the interrupt endpoint handle */
DECL|member|interrupt_in_buffer
r_int
r_char
op_star
id|interrupt_in_buffer
suffix:semicolon
multiline_comment|/* the buffer we use for the interrupt endpoint */
DECL|member|interrupt_read_urb
r_struct
id|urb
op_star
id|interrupt_read_urb
suffix:semicolon
multiline_comment|/* our interrupt urb */
DECL|member|bulk_in_endpoint
id|__u8
id|bulk_in_endpoint
suffix:semicolon
multiline_comment|/* the bulk in endpoint handle */
DECL|member|bulk_in_buffer
r_int
r_char
op_star
id|bulk_in_buffer
suffix:semicolon
multiline_comment|/* the buffer we use for the bulk in endpoint */
DECL|member|read_urb
r_struct
id|urb
op_star
id|read_urb
suffix:semicolon
multiline_comment|/* our bulk read urb */
DECL|member|bulk_out_endpoint
id|__u8
id|bulk_out_endpoint
suffix:semicolon
multiline_comment|/* the bulk out endpoint handle */
DECL|member|rxBytesAvail
id|__s16
id|rxBytesAvail
suffix:semicolon
multiline_comment|/* the number of bytes that we need to read from this device */
DECL|member|rxState
r_enum
id|RXSTATE
id|rxState
suffix:semicolon
multiline_comment|/* the current state of the bulk receive processor */
DECL|member|rxHeader1
id|__u8
id|rxHeader1
suffix:semicolon
multiline_comment|/* receive header byte 1 */
DECL|member|rxHeader2
id|__u8
id|rxHeader2
suffix:semicolon
multiline_comment|/* receive header byte 2 */
DECL|member|rxHeader3
id|__u8
id|rxHeader3
suffix:semicolon
multiline_comment|/* receive header byte 3 */
DECL|member|rxPort
id|__u8
id|rxPort
suffix:semicolon
multiline_comment|/* the port that we are currently receiving data for */
DECL|member|rxStatusCode
id|__u8
id|rxStatusCode
suffix:semicolon
multiline_comment|/* the receive status code */
DECL|member|rxStatusParam
id|__u8
id|rxStatusParam
suffix:semicolon
multiline_comment|/* the receive status paramater */
DECL|member|rxBytesRemaining
id|__s16
id|rxBytesRemaining
suffix:semicolon
multiline_comment|/* the number of port bytes left to read */
DECL|member|serial
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
multiline_comment|/* loop back to the owner of this object */
)brace
suffix:semicolon
multiline_comment|/* baud rate information */
DECL|struct|divisor_table_entry
r_struct
id|divisor_table_entry
(brace
DECL|member|BaudRate
id|__u32
id|BaudRate
suffix:semicolon
DECL|member|Divisor
id|__u16
id|Divisor
suffix:semicolon
)brace
suffix:semicolon
singleline_comment|//
singleline_comment|// Define table of divisors for Rev A EdgePort/4 hardware
singleline_comment|// These assume a 3.6864MHz crystal, the standard /16, and
singleline_comment|// MCR.7 = 0.
singleline_comment|//
DECL|variable|divisor_table
r_static
r_struct
id|divisor_table_entry
id|divisor_table
(braket
)braket
op_assign
(brace
(brace
l_int|75
comma
l_int|3072
)brace
comma
(brace
l_int|110
comma
l_int|2095
)brace
comma
multiline_comment|/* 2094.545455 =&gt; 230450   =&gt; .0217 % over */
(brace
l_int|134
comma
l_int|1713
)brace
comma
multiline_comment|/* 1713.011152 =&gt; 230398.5 =&gt; .00065% under */
(brace
l_int|150
comma
l_int|1536
)brace
comma
(brace
l_int|300
comma
l_int|768
)brace
comma
(brace
l_int|600
comma
l_int|384
)brace
comma
(brace
l_int|1200
comma
l_int|192
)brace
comma
(brace
l_int|1800
comma
l_int|128
)brace
comma
(brace
l_int|2400
comma
l_int|96
)brace
comma
(brace
l_int|4800
comma
l_int|48
)brace
comma
(brace
l_int|7200
comma
l_int|32
)brace
comma
(brace
l_int|9600
comma
l_int|24
)brace
comma
(brace
l_int|14400
comma
l_int|16
)brace
comma
(brace
l_int|19200
comma
l_int|12
)brace
comma
(brace
l_int|38400
comma
l_int|6
)brace
comma
(brace
l_int|57600
comma
l_int|4
)brace
comma
(brace
l_int|115200
comma
l_int|2
)brace
comma
(brace
l_int|230400
comma
l_int|1
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* local variables */
DECL|variable|CmdUrbs
r_static
r_int
id|CmdUrbs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Number of outstanding Command Write Urbs */
multiline_comment|/* local function prototypes */
multiline_comment|/* function prototypes for all URB callbacks */
r_static
r_void
id|edge_interrupt_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|edge_bulk_in_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|edge_bulk_out_data_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|edge_bulk_out_cmd_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
multiline_comment|/* function prototypes for the usbserial callbacks */
r_static
r_int
id|edge_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|edge_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|edge_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|edge_write_room
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|edge_chars_in_buffer
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|edge_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|edge_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|edge_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
suffix:semicolon
r_static
r_int
id|edge_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|edge_break
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
suffix:semicolon
r_static
r_int
id|edge_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|edge_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
macro_line|#include &quot;io_tables.h&quot;&t;/* all of the devices that this driver supports */
multiline_comment|/* function prototypes for all of our local functions */
r_static
r_int
id|process_rcvd_data
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
comma
r_int
r_char
op_star
id|buffer
comma
id|__u16
id|bufferLength
)paren
suffix:semicolon
r_static
r_void
id|process_rcvd_status
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
comma
id|__u8
id|byte2
comma
id|__u8
id|byte3
)paren
suffix:semicolon
r_static
r_void
id|handle_new_msr
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|newMsr
)paren
suffix:semicolon
r_static
r_void
id|handle_new_lsr
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|lsrData
comma
id|__u8
id|lsr
comma
id|__u8
id|data
)paren
suffix:semicolon
r_static
r_int
id|send_iosp_ext_cmd
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|command
comma
id|__u8
id|param
)paren
suffix:semicolon
r_static
r_int
id|calc_baud_rate_divisor
(paren
r_int
id|baud_rate
comma
r_int
op_star
id|divisor
)paren
suffix:semicolon
r_static
r_int
id|send_cmd_write_baud_rate
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
id|baudRate
)paren
suffix:semicolon
r_static
r_void
id|change_port_settings
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
suffix:semicolon
r_static
r_int
id|send_cmd_write_uart_register
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|regNum
comma
id|__u8
id|regValue
)paren
suffix:semicolon
r_static
r_int
id|write_cmd_usb
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|writeLength
)paren
suffix:semicolon
r_static
r_void
id|send_more_port_data
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
comma
r_struct
id|edgeport_port
op_star
id|edge_port
)paren
suffix:semicolon
r_static
r_int
id|sram_write
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
id|__u16
id|extAddr
comma
id|__u16
id|addr
comma
id|__u16
id|length
comma
id|__u8
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|rom_read
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
id|__u16
id|extAddr
comma
id|__u16
id|addr
comma
id|__u16
id|length
comma
id|__u8
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|rom_write
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
id|__u16
id|extAddr
comma
id|__u16
id|addr
comma
id|__u16
id|length
comma
id|__u8
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|get_manufacturing_desc
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
)paren
suffix:semicolon
r_static
r_void
id|get_boot_desc
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
)paren
suffix:semicolon
r_static
r_void
id|load_application_firmware
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
)paren
suffix:semicolon
r_static
r_void
id|unicode_to_ascii
(paren
r_char
op_star
id|string
comma
r_int
op_star
id|unicode
comma
r_int
id|unicode_size
)paren
suffix:semicolon
singleline_comment|// ************************************************************************
singleline_comment|// ************************************************************************
singleline_comment|// ************************************************************************
singleline_comment|// ************************************************************************
multiline_comment|/************************************************************************&n; *&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n; * update_edgeport_E2PROM()&t;Compare current versions of&t;&t;*&n; *&t;&t;&t;&t;Boot ROM and Manufacture &t;&t;*&n; *&t;&t;&t;&t;Descriptors with versions&t;&t;*&n; *&t;&t;&t;&t;embedded in this driver&t;&t;&t;*&n; *&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n; ************************************************************************/
DECL|function|update_edgeport_E2PROM
r_static
r_void
id|update_edgeport_E2PROM
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
)paren
(brace
id|__u32
id|BootCurVer
suffix:semicolon
id|__u32
id|BootNewVer
suffix:semicolon
id|__u8
id|BootMajorVersion
suffix:semicolon
id|__u8
id|BootMinorVersion
suffix:semicolon
id|__u16
id|BootBuildNumber
suffix:semicolon
id|__u8
op_star
id|BootImage
suffix:semicolon
id|__u32
id|BootSize
suffix:semicolon
r_struct
id|edge_firmware_image_record
op_star
id|record
suffix:semicolon
r_int
r_char
op_star
id|firmware
suffix:semicolon
r_int
id|response
suffix:semicolon
r_switch
c_cond
(paren
id|edge_serial-&gt;product_info.iDownloadFile
)paren
(brace
r_case
id|EDGE_DOWNLOAD_FILE_I930
suffix:colon
id|BootMajorVersion
op_assign
id|BootCodeImageVersion_GEN1.MajorVersion
suffix:semicolon
id|BootMinorVersion
op_assign
id|BootCodeImageVersion_GEN1.MinorVersion
suffix:semicolon
id|BootBuildNumber
op_assign
id|BootCodeImageVersion_GEN1.BuildNumber
suffix:semicolon
id|BootImage
op_assign
op_amp
id|BootCodeImage_GEN1
(braket
l_int|0
)braket
suffix:semicolon
id|BootSize
op_assign
r_sizeof
(paren
id|BootCodeImage_GEN1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EDGE_DOWNLOAD_FILE_80251
suffix:colon
id|BootMajorVersion
op_assign
id|BootCodeImageVersion_GEN2.MajorVersion
suffix:semicolon
id|BootMinorVersion
op_assign
id|BootCodeImageVersion_GEN2.MinorVersion
suffix:semicolon
id|BootBuildNumber
op_assign
id|BootCodeImageVersion_GEN2.BuildNumber
suffix:semicolon
id|BootImage
op_assign
op_amp
id|BootCodeImage_GEN2
(braket
l_int|0
)braket
suffix:semicolon
id|BootSize
op_assign
r_sizeof
(paren
id|BootCodeImage_GEN2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
singleline_comment|// Check Boot Image Version
id|BootCurVer
op_assign
(paren
id|edge_serial-&gt;boot_descriptor.MajorVersion
op_lshift
l_int|24
)paren
op_plus
(paren
id|edge_serial-&gt;boot_descriptor.MinorVersion
op_lshift
l_int|16
)paren
op_plus
id|edge_serial-&gt;boot_descriptor.BuildNumber
suffix:semicolon
id|BootNewVer
op_assign
(paren
id|BootMajorVersion
op_lshift
l_int|24
)paren
op_plus
(paren
id|BootMinorVersion
op_lshift
l_int|16
)paren
op_plus
id|BootBuildNumber
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Current Boot Image version %d.%d.%d&quot;
comma
id|edge_serial-&gt;boot_descriptor.MajorVersion
comma
id|edge_serial-&gt;boot_descriptor.MinorVersion
comma
id|edge_serial-&gt;boot_descriptor.BuildNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BootNewVer
OG
id|BootCurVer
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;**Update Boot Image from %d.%d.%d to %d.%d.%d&quot;
comma
id|edge_serial-&gt;boot_descriptor.MajorVersion
comma
id|edge_serial-&gt;boot_descriptor.MinorVersion
comma
id|edge_serial-&gt;boot_descriptor.BuildNumber
comma
id|BootMajorVersion
comma
id|BootMinorVersion
comma
id|BootBuildNumber
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Downloading new Boot Image&quot;
)paren
suffix:semicolon
id|firmware
op_assign
id|BootImage
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|record
op_assign
(paren
r_struct
id|edge_firmware_image_record
op_star
)paren
id|firmware
suffix:semicolon
id|response
op_assign
id|rom_write
(paren
id|edge_serial-&gt;serial
comma
id|record-&gt;ExtAddr
comma
id|record-&gt;Addr
comma
id|record-&gt;Len
comma
op_amp
id|record-&gt;Data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;sram_write failed (%x, %x, %d)&quot;
comma
id|record-&gt;ExtAddr
comma
id|record-&gt;Addr
comma
id|record-&gt;Len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|firmware
op_add_assign
r_sizeof
(paren
r_struct
id|edge_firmware_image_record
)paren
op_plus
id|record-&gt;Len
suffix:semicolon
r_if
c_cond
(paren
id|firmware
op_ge
op_amp
id|BootImage
(braket
id|BootSize
)braket
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;Boot Image -- already up to date&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/************************************************************************&n; *&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n; *  Get string descriptor from device&t;&t;&t;&t;&t;*&n; *&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n; ************************************************************************/
DECL|function|get_string
r_static
r_int
id|get_string
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|Id
comma
r_char
op_star
id|string
)paren
(brace
r_struct
id|usb_string_descriptor
id|StringDesc
suffix:semicolon
r_struct
id|usb_string_descriptor
op_star
id|pStringDesc
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - USB String ID = %d&quot;
comma
id|Id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_STRING
comma
id|Id
comma
op_amp
id|StringDesc
comma
r_sizeof
(paren
id|StringDesc
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|pStringDesc
op_assign
id|kmalloc
(paren
id|StringDesc.bLength
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pStringDesc
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_STRING
comma
id|Id
comma
id|pStringDesc
comma
id|StringDesc.bLength
)paren
)paren
(brace
id|kfree
c_func
(paren
id|pStringDesc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|unicode_to_ascii
c_func
(paren
id|string
comma
id|pStringDesc-&gt;wData
comma
id|pStringDesc-&gt;bLength
op_div
l_int|2
op_minus
l_int|1
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pStringDesc
)paren
suffix:semicolon
r_return
id|strlen
c_func
(paren
id|string
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/************************************************************************&n; *&n; *  Get string descriptor from device&n; *&n; ************************************************************************/
r_static
r_int
id|get_string_desc
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|Id
comma
r_struct
id|usb_string_descriptor
op_star
op_star
id|pRetDesc
)paren
(brace
r_struct
id|usb_string_descriptor
id|StringDesc
suffix:semicolon
r_struct
id|usb_string_descriptor
op_star
id|pStringDesc
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - USB String ID = %d&quot;
comma
id|Id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_STRING
comma
id|Id
comma
op_amp
id|StringDesc
comma
r_sizeof
(paren
id|StringDesc
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|pStringDesc
op_assign
id|kmalloc
(paren
id|StringDesc.bLength
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pStringDesc
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_STRING
comma
id|Id
comma
id|pStringDesc
comma
id|StringDesc.bLength
)paren
)paren
(brace
id|kfree
c_func
(paren
id|pStringDesc
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|pRetDesc
op_assign
id|pStringDesc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|get_product_info
r_static
r_void
id|get_product_info
c_func
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
)paren
(brace
r_struct
id|edgeport_product_info
op_star
id|product_info
op_assign
op_amp
id|edge_serial-&gt;product_info
suffix:semicolon
id|memset
(paren
id|product_info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|edgeport_product_info
)paren
)paren
suffix:semicolon
id|product_info-&gt;ProductId
op_assign
(paren
id|__u16
)paren
(paren
id|edge_serial-&gt;serial-&gt;dev-&gt;descriptor.idProduct
op_amp
op_complement
id|ION_DEVICE_ID_GENERATION_2
)paren
suffix:semicolon
id|product_info-&gt;NumPorts
op_assign
id|edge_serial-&gt;manuf_descriptor.NumPorts
suffix:semicolon
id|product_info-&gt;ProdInfoVer
op_assign
l_int|0
suffix:semicolon
id|product_info-&gt;RomSize
op_assign
id|edge_serial-&gt;manuf_descriptor.RomSize
suffix:semicolon
id|product_info-&gt;RamSize
op_assign
id|edge_serial-&gt;manuf_descriptor.RamSize
suffix:semicolon
id|product_info-&gt;CpuRev
op_assign
id|edge_serial-&gt;manuf_descriptor.CpuRev
suffix:semicolon
id|product_info-&gt;BoardRev
op_assign
id|edge_serial-&gt;manuf_descriptor.BoardRev
suffix:semicolon
id|product_info-&gt;BootMajorVersion
op_assign
id|edge_serial-&gt;boot_descriptor.MajorVersion
suffix:semicolon
id|product_info-&gt;BootMinorVersion
op_assign
id|edge_serial-&gt;boot_descriptor.MinorVersion
suffix:semicolon
id|product_info-&gt;BootBuildNumber
op_assign
id|edge_serial-&gt;boot_descriptor.BuildNumber
suffix:semicolon
id|memcpy
c_func
(paren
id|product_info-&gt;ManufactureDescDate
comma
id|edge_serial-&gt;manuf_descriptor.DescDate
comma
r_sizeof
(paren
id|edge_serial-&gt;manuf_descriptor.DescDate
)paren
)paren
suffix:semicolon
singleline_comment|// check if this is 2nd generation hardware
r_if
c_cond
(paren
id|edge_serial-&gt;serial-&gt;dev-&gt;descriptor.idProduct
op_amp
id|ION_DEVICE_ID_GENERATION_2
)paren
(brace
id|product_info-&gt;FirmwareMajorVersion
op_assign
id|OperationalCodeImageVersion_GEN2.MajorVersion
suffix:semicolon
id|product_info-&gt;FirmwareMinorVersion
op_assign
id|OperationalCodeImageVersion_GEN2.MinorVersion
suffix:semicolon
id|product_info-&gt;FirmwareBuildNumber
op_assign
id|OperationalCodeImageVersion_GEN2.BuildNumber
suffix:semicolon
id|product_info-&gt;iDownloadFile
op_assign
id|EDGE_DOWNLOAD_FILE_80251
suffix:semicolon
)brace
r_else
(brace
id|product_info-&gt;FirmwareMajorVersion
op_assign
id|OperationalCodeImageVersion_GEN1.MajorVersion
suffix:semicolon
id|product_info-&gt;FirmwareMinorVersion
op_assign
id|OperationalCodeImageVersion_GEN1.MinorVersion
suffix:semicolon
id|product_info-&gt;FirmwareBuildNumber
op_assign
id|OperationalCodeImageVersion_GEN1.BuildNumber
suffix:semicolon
id|product_info-&gt;iDownloadFile
op_assign
id|EDGE_DOWNLOAD_FILE_I930
suffix:semicolon
)brace
singleline_comment|// Determine Product type and set appropriate flags
r_switch
c_cond
(paren
id|DEVICE_ID_FROM_USB_PRODUCT_ID
c_func
(paren
id|product_info-&gt;ProductId
)paren
)paren
(brace
r_case
id|ION_DEVICE_ID_EDGEPORT_COMPATIBLE
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_4T
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_4
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_2
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_8_DUAL_CPU
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_8
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_421
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_21
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_2_DIN
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_4_DIN
suffix:colon
r_case
id|ION_DEVICE_ID_EDGEPORT_16_DUAL_CPU
suffix:colon
id|product_info-&gt;IsRS232
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ION_DEVICE_ID_EDGEPORT_2I
suffix:colon
singleline_comment|// Edgeport/2 RS422/RS485
id|product_info-&gt;IsRS422
op_assign
l_int|1
suffix:semicolon
id|product_info-&gt;IsRS485
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ION_DEVICE_ID_EDGEPORT_8I
suffix:colon
singleline_comment|// Edgeport/4 RS422
r_case
id|ION_DEVICE_ID_EDGEPORT_4I
suffix:colon
singleline_comment|// Edgeport/4 RS422
id|product_info-&gt;IsRS422
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// Dump Product Info structure
id|dbg
c_func
(paren
l_string|&quot;**Product Information:&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  ProductId             %x&quot;
comma
id|product_info-&gt;ProductId
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  NumPorts              %d&quot;
comma
id|product_info-&gt;NumPorts
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  ProdInfoVer           %d&quot;
comma
id|product_info-&gt;ProdInfoVer
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  IsServer              %d&quot;
comma
id|product_info-&gt;IsServer
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  IsRS232               %d&quot;
comma
id|product_info-&gt;IsRS232
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  IsRS422               %d&quot;
comma
id|product_info-&gt;IsRS422
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  IsRS485               %d&quot;
comma
id|product_info-&gt;IsRS485
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  RomSize               %d&quot;
comma
id|product_info-&gt;RomSize
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  RamSize               %d&quot;
comma
id|product_info-&gt;RamSize
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  CpuRev                %x&quot;
comma
id|product_info-&gt;CpuRev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  BoardRev              %x&quot;
comma
id|product_info-&gt;BoardRev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  BootMajorVersion      %d.%d.%d&quot;
comma
id|product_info-&gt;BootMajorVersion
comma
id|product_info-&gt;BootMinorVersion
comma
id|product_info-&gt;BootBuildNumber
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  FirmwareMajorVersion  %d.%d.%d&quot;
comma
id|product_info-&gt;FirmwareMajorVersion
comma
id|product_info-&gt;FirmwareMinorVersion
comma
id|product_info-&gt;FirmwareBuildNumber
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  ManufactureDescDate   %d/%d/%d&quot;
comma
id|product_info-&gt;ManufactureDescDate
(braket
l_int|0
)braket
comma
id|product_info-&gt;ManufactureDescDate
(braket
l_int|1
)braket
comma
id|product_info-&gt;ManufactureDescDate
(braket
l_int|2
)braket
op_plus
l_int|1900
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  iDownloadFile         0x%x&quot;
comma
id|product_info-&gt;iDownloadFile
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/************************************************************************/
multiline_comment|/*            U S B  C A L L B A C K   F U N C T I O N S                */
multiline_comment|/*            U S B  C A L L B A C K   F U N C T I O N S                */
multiline_comment|/************************************************************************/
multiline_comment|/************************************************************************/
multiline_comment|/*****************************************************************************&n; * edge_interrupt_callback&n; *&t;this is the callback function for when we have received data on the &n; *&t;interrupt endpoint.&n; *****************************************************************************/
DECL|function|edge_interrupt_callback
r_static
r_void
id|edge_interrupt_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|edgeport_serial
op_star
id|edge_serial
op_assign
(paren
r_struct
id|edgeport_serial
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|length
op_assign
id|urb-&gt;actual_length
suffix:semicolon
r_int
id|bytes_avail
suffix:semicolon
r_int
id|position
suffix:semicolon
r_int
id|txCredits
suffix:semicolon
r_int
id|portNumber
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
(paren
id|edge_serial-&gt;serial
comma
id|__FUNCTION__
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - nonzero control read status received: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// process this interrupt-read even if there are no ports open
r_if
c_cond
(paren
id|length
)paren
(brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|length
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
l_int|1
)paren
(brace
id|bytes_avail
op_assign
id|data
(braket
l_int|0
)braket
op_or
(paren
id|data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes_avail
)paren
(brace
id|edge_serial-&gt;rxBytesAvail
op_add_assign
id|bytes_avail
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - bytes_avail = %d, rxBytesAvail %d&quot;
comma
id|bytes_avail
comma
id|edge_serial-&gt;rxBytesAvail
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|edge_serial-&gt;rxBytesAvail
OG
l_int|0
)paren
op_logical_and
(paren
id|edge_serial-&gt;read_urb-&gt;status
op_ne
op_minus
id|EINPROGRESS
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot; --- Posting a read&quot;
)paren
suffix:semicolon
multiline_comment|/* we have pending bytes on the bulk in pipe, send a request */
id|edge_serial-&gt;read_urb-&gt;dev
op_assign
id|edge_serial-&gt;serial-&gt;dev
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|edge_serial-&gt;read_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - usb_submit_urb(read bulk) failed with result = %d&quot;
comma
id|result
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* grab the txcredits for the ports if available */
id|position
op_assign
l_int|2
suffix:semicolon
id|portNumber
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|position
OL
id|length
)paren
op_logical_and
(paren
id|portNumber
OL
id|edge_serial-&gt;serial-&gt;num_ports
)paren
)paren
(brace
id|txCredits
op_assign
id|data
(braket
id|position
)braket
op_or
(paren
id|data
(braket
id|position
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txCredits
)paren
(brace
id|port
op_assign
op_amp
id|edge_serial-&gt;serial-&gt;port
(braket
id|portNumber
)braket
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
id|__FUNCTION__
)paren
op_eq
l_int|0
)paren
(brace
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;open
)paren
(brace
id|edge_port-&gt;txCredits
op_add_assign
id|txCredits
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - txcredits for port%d = %d&quot;
comma
id|portNumber
comma
id|edge_port-&gt;txCredits
)paren
suffix:semicolon
multiline_comment|/* tell the tty driver that something has changed */
id|wake_up_interruptible
c_func
(paren
op_amp
id|edge_port-&gt;port-&gt;tty-&gt;write_wait
)paren
suffix:semicolon
singleline_comment|// Since we have more credit, check if more data can be sent
id|send_more_port_data
c_func
(paren
id|edge_serial
comma
id|edge_port
)paren
suffix:semicolon
)brace
)brace
)brace
id|position
op_add_assign
l_int|2
suffix:semicolon
op_increment
id|portNumber
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*****************************************************************************&n; * edge_bulk_in_callback&n; *&t;this is the callback function for when we have received data on the &n; *&t;bulk in endpoint.&n; *****************************************************************************/
DECL|function|edge_bulk_in_callback
r_static
r_void
id|edge_bulk_in_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|edgeport_serial
op_star
id|edge_serial
op_assign
(paren
r_struct
id|edgeport_serial
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|status
suffix:semicolon
id|__u16
id|raw_data_length
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
(paren
id|edge_serial-&gt;serial
comma
id|__FUNCTION__
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - nonzero read bulk status received: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;actual_length
)paren
(brace
id|raw_data_length
op_assign
id|urb-&gt;actual_length
suffix:semicolon
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|raw_data_length
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* decrement our rxBytes available by the number that we just got */
id|edge_serial-&gt;rxBytesAvail
op_sub_assign
id|raw_data_length
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Received = %d, rxBytesAvail %d&quot;
comma
id|raw_data_length
comma
id|edge_serial-&gt;rxBytesAvail
)paren
suffix:semicolon
id|process_rcvd_data
(paren
id|edge_serial
comma
id|data
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
multiline_comment|/* check to see if there&squot;s any more data for us to read */
r_if
c_cond
(paren
(paren
id|edge_serial-&gt;rxBytesAvail
OG
l_int|0
)paren
op_logical_and
(paren
id|edge_serial-&gt;read_urb-&gt;status
op_ne
op_minus
id|EINPROGRESS
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot; --- Posting a read&quot;
)paren
suffix:semicolon
multiline_comment|/* there is, so resubmit our urb */
id|edge_serial-&gt;read_urb-&gt;dev
op_assign
id|edge_serial-&gt;serial-&gt;dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|edge_serial-&gt;read_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - usb_submit_urb(read bulk) failed, status = %d&quot;
comma
id|status
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*****************************************************************************&n; * edge_bulk_out_data_callback&n; *&t;this is the callback function for when we have finished sending serial data&n; *&t;on the bulk out endpoint.&n; *****************************************************************************/
DECL|function|edge_bulk_out_data_callback
r_static
r_void
id|edge_bulk_out_data_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|edge_port-&gt;port
comma
id|__FUNCTION__
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - nonzero write bulk status received: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
)brace
id|tty
op_assign
id|edge_port-&gt;port-&gt;tty
suffix:semicolon
multiline_comment|/* let the tty driver wakeup if it has a special write_wakeup function */
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(brace
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* tell the tty driver that something has changed */
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
singleline_comment|// Release the Write URB
id|edge_port-&gt;write_in_progress
op_assign
id|FALSE
suffix:semicolon
singleline_comment|// Check if more data needs to be sent
id|send_more_port_data
c_func
(paren
(paren
r_struct
id|edgeport_serial
op_star
)paren
(paren
id|edge_port-&gt;port-&gt;serial
op_member_access_from_pointer
r_private
)paren
comma
id|edge_port
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * BulkOutCmdCallback&n; *&t;this is the callback function for when we have finished sending a command&n; *&t;on the bulk out endpoint.&n; *****************************************************************************/
DECL|function|edge_bulk_out_cmd_callback
r_static
r_void
id|edge_bulk_out_cmd_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|status
op_assign
id|urb-&gt;status
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
id|CmdUrbs
op_decrement
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - FREE URB %p (outstanding %d)&quot;
comma
id|urb
comma
id|CmdUrbs
)paren
suffix:semicolon
multiline_comment|/* clean up the transfer buffer */
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
)brace
singleline_comment|// Free the command urb
id|usb_unlink_urb
(paren
id|urb
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|edge_port-&gt;port
comma
id|__FUNCTION__
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - nonzero write bulk status received: %d&quot;
comma
id|status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Get pointer to tty */
id|tty
op_assign
id|edge_port-&gt;port-&gt;tty
suffix:semicolon
multiline_comment|/* tell the tty driver that something has changed */
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
multiline_comment|/* we have completed the command */
id|edge_port-&gt;commandPending
op_assign
id|FALSE
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|edge_port-&gt;wait_command
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Driver tty interface functions&n; *****************************************************************************/
multiline_comment|/*****************************************************************************&n; * SerialOpen&n; *&t;this function is called by the tty driver when a port is opened&n; *&t;If successful, we return 0&n; *&t;Otherwise we return a negative error number.&n; *****************************************************************************/
DECL|function|edge_open
r_static
r_int
id|edge_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|edgeport_serial
op_star
id|edge_serial
suffix:semicolon
r_int
id|response
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
id|__FUNCTION__
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* force low_latency on so that our tty_push actually forces the data through, &n;&t;   otherwise it is scheduled, and with high data rates (like with OHCI) data&n;&t;   can get lost. */
id|port-&gt;tty-&gt;low_latency
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* see if we&squot;ve set up our endpoint info yet (can&squot;t set it up in edge_startup&n;&t;   as the structures were not set up at that time.) */
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
id|edge_serial
op_assign
(paren
r_struct
id|edgeport_serial
op_star
)paren
id|serial
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|edge_serial
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|edge_serial-&gt;interrupt_in_buffer
op_eq
l_int|NULL
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port0
op_assign
op_amp
id|serial-&gt;port
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* not set up yet, so do it now */
id|edge_serial-&gt;interrupt_in_buffer
op_assign
id|port0-&gt;interrupt_in_buffer
suffix:semicolon
id|edge_serial-&gt;interrupt_in_endpoint
op_assign
id|port0-&gt;interrupt_in_endpointAddress
suffix:semicolon
id|edge_serial-&gt;interrupt_read_urb
op_assign
id|port0-&gt;interrupt_in_urb
suffix:semicolon
id|edge_serial-&gt;bulk_in_buffer
op_assign
id|port0-&gt;bulk_in_buffer
suffix:semicolon
id|edge_serial-&gt;bulk_in_endpoint
op_assign
id|port0-&gt;bulk_in_endpointAddress
suffix:semicolon
id|edge_serial-&gt;read_urb
op_assign
id|port0-&gt;read_urb
suffix:semicolon
id|edge_serial-&gt;bulk_out_endpoint
op_assign
id|port0-&gt;bulk_out_endpointAddress
suffix:semicolon
multiline_comment|/* set up our interrupt urb */
id|FILL_INT_URB
c_func
(paren
id|edge_serial-&gt;interrupt_read_urb
comma
id|serial-&gt;dev
comma
id|usb_rcvintpipe
c_func
(paren
id|serial-&gt;dev
comma
id|port0-&gt;interrupt_in_endpointAddress
)paren
comma
id|port0-&gt;interrupt_in_buffer
comma
id|edge_serial-&gt;interrupt_read_urb-&gt;transfer_buffer_length
comma
id|edge_interrupt_callback
comma
id|edge_serial
comma
id|edge_serial-&gt;interrupt_read_urb-&gt;interval
)paren
suffix:semicolon
multiline_comment|/* set up our bulk in urb */
id|FILL_BULK_URB
c_func
(paren
id|edge_serial-&gt;read_urb
comma
id|serial-&gt;dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|serial-&gt;dev
comma
id|port0-&gt;bulk_in_endpointAddress
)paren
comma
id|port0-&gt;bulk_in_buffer
comma
id|edge_serial-&gt;read_urb-&gt;transfer_buffer_length
comma
id|edge_bulk_in_callback
comma
id|edge_serial
)paren
suffix:semicolon
multiline_comment|/* start interrupt read for this edgeport&n;&t;&t; * this interrupt will continue as long as the edgeport is connected */
id|response
op_assign
id|usb_submit_urb
(paren
id|edge_serial-&gt;interrupt_read_urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Error %d submitting control urb&quot;
comma
id|response
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* initialize our wait queues */
id|init_waitqueue_head
c_func
(paren
op_amp
id|edge_port-&gt;wait_open
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|edge_port-&gt;wait_chase
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|edge_port-&gt;delta_msr_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|edge_port-&gt;wait_command
)paren
suffix:semicolon
multiline_comment|/* initialize our icount structure */
id|memset
(paren
op_amp
(paren
id|edge_port-&gt;icount
)paren
comma
l_int|0x00
comma
r_sizeof
(paren
id|edge_port-&gt;icount
)paren
)paren
suffix:semicolon
multiline_comment|/* initialize our port settings */
id|edge_port-&gt;txCredits
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Can&squot;t send any data yet */
id|edge_port-&gt;shadowMCR
op_assign
id|MCR_MASTER_IE
suffix:semicolon
multiline_comment|/* Must always set this bit to enable ints! */
id|edge_port-&gt;chaseResponsePending
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* send a open port command */
id|edge_port-&gt;openPending
op_assign
id|TRUE
suffix:semicolon
id|edge_port-&gt;open
op_assign
id|FALSE
suffix:semicolon
id|response
op_assign
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_OPEN_PORT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - error sending open port command&quot;
)paren
suffix:semicolon
id|edge_port-&gt;openPending
op_assign
id|FALSE
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* now wait for the port to be completly opened */
id|timeout
op_assign
id|OPEN_TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_logical_and
id|edge_port-&gt;openPending
op_eq
id|TRUE
)paren
(brace
id|timeout
op_assign
id|interruptible_sleep_on_timeout
(paren
op_amp
id|edge_port-&gt;wait_open
comma
id|timeout
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|edge_port-&gt;open
op_eq
id|FALSE
)paren
(brace
multiline_comment|/* open timed out */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - open timedout&quot;
)paren
suffix:semicolon
id|edge_port-&gt;openPending
op_assign
id|FALSE
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* create the txfifo */
id|edge_port-&gt;txfifo.head
op_assign
l_int|0
suffix:semicolon
id|edge_port-&gt;txfifo.tail
op_assign
l_int|0
suffix:semicolon
id|edge_port-&gt;txfifo.count
op_assign
l_int|0
suffix:semicolon
id|edge_port-&gt;txfifo.size
op_assign
id|edge_port-&gt;maxTxCredits
suffix:semicolon
id|edge_port-&gt;txfifo.fifo
op_assign
id|kmalloc
(paren
id|edge_port-&gt;maxTxCredits
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edge_port-&gt;txfifo.fifo
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - no memory&quot;
)paren
suffix:semicolon
id|edge_close
(paren
id|port
comma
id|filp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Allocate a URB for the write */
id|edge_port-&gt;write_urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edge_port-&gt;write_urb
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - no memory&quot;
)paren
suffix:semicolon
id|edge_close
(paren
id|port
comma
id|filp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;(%d) - Initialize TX fifo to %d bytes&quot;
comma
id|port-&gt;number
comma
id|edge_port-&gt;maxTxCredits
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; exited&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; *&n; * block_until_chase_response&n; *&n; *&t;This function will block the close until one of the following:&n; *&t;&t;1. Response to our Chase comes from Edgeport&n; *&t;&t;2. A timout of 10 seconds without activity has expired&n; *&t;&t;   (1K of Edgeport data @ 2400 baud ==&gt; 4 sec to empty)&n; *&n; ************************************************************************/
DECL|function|block_until_chase_response
r_static
r_void
id|block_until_chase_response
c_func
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
)paren
(brace
id|__u16
id|lastCredits
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1
op_star
id|HZ
suffix:semicolon
r_int
id|wait
op_assign
l_int|10
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
singleline_comment|// Save Last credits
id|lastCredits
op_assign
id|edge_port-&gt;txCredits
suffix:semicolon
singleline_comment|// Did we get our Chase response
r_if
c_cond
(paren
id|edge_port-&gt;chaseResponsePending
op_eq
id|FALSE
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Got Chase Response&quot;
)paren
suffix:semicolon
singleline_comment|// did we get all of our credit back?
r_if
c_cond
(paren
id|edge_port-&gt;txCredits
op_eq
id|edge_port-&gt;maxTxCredits
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Got all credits&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
singleline_comment|// Block the thread for a while
id|interruptible_sleep_on_timeout
(paren
op_amp
id|edge_port-&gt;wait_chase
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lastCredits
op_eq
id|edge_port-&gt;txCredits
)paren
(brace
singleline_comment|// No activity.. count down.
id|wait
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|wait
op_eq
l_int|0
)paren
(brace
id|edge_port-&gt;chaseResponsePending
op_assign
id|FALSE
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Chase TIMEOUT&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// Reset timout value back to 10 seconds
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Last %d, Current %d&quot;
comma
id|lastCredits
comma
id|edge_port-&gt;txCredits
)paren
suffix:semicolon
id|wait
op_assign
l_int|10
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/************************************************************************&n; *&n; * block_until_tx_empty&n; *&n; *&t;This function will block the close until one of the following:&n; *&t;&t;1. TX count are 0&n; *&t;&t;2. The edgeport has stopped&n; *&t;&t;3. A timout of 3 seconds without activity has expired&n; *&n; ************************************************************************/
DECL|function|block_until_tx_empty
r_static
r_void
id|block_until_tx_empty
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
)paren
(brace
r_struct
id|TxFifo
op_star
id|fifo
op_assign
op_amp
id|edge_port-&gt;txfifo
suffix:semicolon
id|__u32
id|lastCount
suffix:semicolon
r_int
id|timeout
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
r_int
id|wait
op_assign
l_int|30
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
singleline_comment|// Save Last count
id|lastCount
op_assign
id|fifo-&gt;count
suffix:semicolon
singleline_comment|// Is the Edgeport Buffer empty?
r_if
c_cond
(paren
id|lastCount
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - TX Buffer Empty&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// Block the thread for a while
id|interruptible_sleep_on_timeout
(paren
op_amp
id|edge_port-&gt;wait_chase
comma
id|timeout
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; wait&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lastCount
op_eq
id|fifo-&gt;count
)paren
(brace
singleline_comment|// No activity.. count down.
id|wait
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|wait
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - TIMEOUT&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// Reset timout value back to seconds
id|wait
op_assign
l_int|30
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*****************************************************************************&n; * edge_close&n; *&t;this function is called by the tty driver when a port is closed&n; *****************************************************************************/
DECL|function|edge_close
r_static
r_void
id|edge_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|edgeport_serial
op_star
id|edge_serial
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
id|__FUNCTION__
)paren
)paren
r_return
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
id|serial
op_assign
id|get_usb_serial
(paren
id|port
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial
)paren
r_return
suffix:semicolon
id|edge_serial
op_assign
(paren
r_struct
id|edgeport_serial
op_star
)paren
id|serial
op_member_access_from_pointer
r_private
suffix:semicolon
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
(paren
id|edge_serial
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|edge_port
op_eq
l_int|NULL
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|serial-&gt;dev
)paren
(brace
singleline_comment|// block until tx is empty
id|block_until_tx_empty
c_func
(paren
id|edge_port
)paren
suffix:semicolon
id|edge_port-&gt;closePending
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* flush and chase */
id|edge_port-&gt;chaseResponsePending
op_assign
id|TRUE
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Sending IOSP_CMD_CHASE_PORT&quot;
)paren
suffix:semicolon
id|status
op_assign
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_CHASE_PORT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
singleline_comment|// block until chase finished
id|block_until_chase_response
c_func
(paren
id|edge_port
)paren
suffix:semicolon
)brace
r_else
(brace
id|edge_port-&gt;chaseResponsePending
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* close the port */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Sending IOSP_CMD_CLOSE_PORT&quot;
)paren
suffix:semicolon
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_CLOSE_PORT
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|//port-&gt;close = TRUE;
id|edge_port-&gt;closePending
op_assign
id|FALSE
suffix:semicolon
id|edge_port-&gt;open
op_assign
id|FALSE
suffix:semicolon
id|edge_port-&gt;openPending
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;write_urb
)paren
(brace
id|usb_unlink_urb
(paren
id|edge_port-&gt;write_urb
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|edge_port-&gt;write_urb
)paren
(brace
multiline_comment|/* if this urb had a transfer buffer already (old transfer) free it */
r_if
c_cond
(paren
id|edge_port-&gt;write_urb-&gt;transfer_buffer
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|edge_port-&gt;write_urb-&gt;transfer_buffer
)paren
suffix:semicolon
)brace
id|usb_free_urb
(paren
id|edge_port-&gt;write_urb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|edge_port-&gt;txfifo.fifo
)paren
(brace
id|kfree
c_func
(paren
id|edge_port-&gt;txfifo.fifo
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; exited&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * SerialWrite&n; *&t;this function is called by the tty driver when data should be written to&n; *&t;the port.&n; *&t;If successful, we return the number of bytes written, otherwise we return&n; *&t;a negative error number.&n; *****************************************************************************/
DECL|function|edge_write
r_static
r_int
id|edge_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|count
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|TxFifo
op_star
id|fifo
suffix:semicolon
r_int
id|copySize
suffix:semicolon
r_int
id|bytesleft
suffix:semicolon
r_int
id|firsthalf
suffix:semicolon
r_int
id|secondhalf
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
singleline_comment|// get a pointer to the Tx fifo
id|fifo
op_assign
op_amp
id|edge_port-&gt;txfifo
suffix:semicolon
singleline_comment|// calculate number of bytes to put in fifo
id|copySize
op_assign
id|min
(paren
(paren
r_int
r_int
)paren
id|count
comma
(paren
id|edge_port-&gt;txCredits
op_minus
id|fifo-&gt;count
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;(%d) of %d byte(s) Fifo room  %d -- will copy %d bytes&quot;
comma
id|port-&gt;number
comma
id|count
comma
id|edge_port-&gt;txCredits
op_minus
id|fifo-&gt;count
comma
id|copySize
)paren
suffix:semicolon
multiline_comment|/* catch writes of 0 bytes which the tty driver likes to give us, and when txCredits is empty */
r_if
c_cond
(paren
id|copySize
op_eq
l_int|0
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - copySize = Zero&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// queue the data&t;
singleline_comment|// since we can never overflow the buffer we do not have to check for full condition
singleline_comment|// the copy is done is two parts -- first fill to the end of the buffer
singleline_comment|// then copy the reset from the start of the buffer 
id|bytesleft
op_assign
id|fifo-&gt;size
op_minus
id|fifo-&gt;head
suffix:semicolon
id|firsthalf
op_assign
id|min
(paren
id|bytesleft
comma
id|copySize
)paren
suffix:semicolon
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - copy %d bytes of %d into fifo &quot;
comma
id|firsthalf
comma
id|bytesleft
)paren
suffix:semicolon
multiline_comment|/* now copy our data */
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|fifo-&gt;fifo
(braket
id|fifo-&gt;head
)braket
comma
id|data
comma
id|firsthalf
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|fifo-&gt;fifo
(braket
id|fifo-&gt;head
)braket
comma
id|data
comma
id|firsthalf
)paren
suffix:semicolon
)brace
singleline_comment|// update the index and size
id|fifo-&gt;head
op_add_assign
id|firsthalf
suffix:semicolon
id|fifo-&gt;count
op_add_assign
id|firsthalf
suffix:semicolon
singleline_comment|// wrap the index
r_if
c_cond
(paren
id|fifo-&gt;head
op_eq
id|fifo-&gt;size
)paren
(brace
id|fifo-&gt;head
op_assign
l_int|0
suffix:semicolon
)brace
id|secondhalf
op_assign
id|copySize
op_minus
id|firsthalf
suffix:semicolon
r_if
c_cond
(paren
id|secondhalf
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - copy rest of data %d&quot;
comma
id|secondhalf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|fifo-&gt;fifo
(braket
id|fifo-&gt;head
)braket
comma
op_amp
id|data
(braket
id|firsthalf
)braket
comma
id|secondhalf
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|fifo-&gt;fifo
(braket
id|fifo-&gt;head
)braket
comma
op_amp
id|data
(braket
id|firsthalf
)braket
comma
id|secondhalf
)paren
suffix:semicolon
)brace
singleline_comment|// update the index and size
id|fifo-&gt;count
op_add_assign
id|secondhalf
suffix:semicolon
id|fifo-&gt;head
op_add_assign
id|secondhalf
suffix:semicolon
singleline_comment|// No need to check for wrap since we can not get to end of fifo in this part
)brace
r_if
c_cond
(paren
id|copySize
)paren
(brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|copySize
comma
id|data
)paren
suffix:semicolon
)brace
id|send_more_port_data
c_func
(paren
(paren
r_struct
id|edgeport_serial
op_star
)paren
id|port-&gt;serial
op_member_access_from_pointer
r_private
comma
id|edge_port
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; wrote %d byte(s) TxCredits %d, Fifo %d&quot;
comma
id|copySize
comma
id|edge_port-&gt;txCredits
comma
id|fifo-&gt;count
)paren
suffix:semicolon
r_return
id|copySize
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; *&n; * send_more_port_data()&n; *&n; *&t;This routine attempts to write additional UART transmit data&n; *&t;to a port over the USB bulk pipe. It is called (1) when new&n; *&t;data has been written to a port&squot;s TxBuffer from higher layers&n; *&t;(2) when the peripheral sends us additional TxCredits indicating&n; *&t;that it can accept more&t;Tx data for a given port; and (3) when&n; *&t;a bulk write completes successfully and we want to see if we&n; *&t;can transmit more.&n; *&n; ************************************************************************/
DECL|function|send_more_port_data
r_static
r_void
id|send_more_port_data
c_func
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
comma
r_struct
id|edgeport_port
op_star
id|edge_port
)paren
(brace
r_struct
id|TxFifo
op_star
id|fifo
op_assign
op_amp
id|edge_port-&gt;txfifo
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
r_char
op_star
id|buffer
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|bytesleft
suffix:semicolon
r_int
id|firsthalf
suffix:semicolon
r_int
id|secondhalf
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;(%d)&quot;
comma
id|edge_port-&gt;port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;write_in_progress
op_logical_or
op_logical_neg
id|edge_port-&gt;open
op_logical_or
(paren
id|fifo-&gt;count
op_eq
l_int|0
)paren
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;(%d) EXIT - fifo %d, PendingWrite = %d&quot;
comma
id|edge_port-&gt;port-&gt;number
comma
id|fifo-&gt;count
comma
id|edge_port-&gt;write_in_progress
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// since the amount of data in the fifo will always fit into the
singleline_comment|// edgeport buffer we do not need to check the write length
singleline_comment|//&t;Do we have enough credits for this port to make it worthwhile
singleline_comment|//&t;to bother queueing a write. If it&squot;s too small, say a few bytes,
singleline_comment|//&t;it&squot;s better to wait for more credits so we can do a larger
singleline_comment|//&t;write.
r_if
c_cond
(paren
id|edge_port-&gt;txCredits
OL
id|EDGE_FW_GET_TX_CREDITS_SEND_THRESHOLD
c_func
(paren
id|edge_port-&gt;maxTxCredits
)paren
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;(%d) Not enough credit - fifo %d TxCredit %d&quot;
comma
id|edge_port-&gt;port-&gt;number
comma
id|fifo-&gt;count
comma
id|edge_port-&gt;txCredits
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// lock this write
id|edge_port-&gt;write_in_progress
op_assign
id|TRUE
suffix:semicolon
singleline_comment|// get a pointer to the write_urb
id|urb
op_assign
id|edge_port-&gt;write_urb
suffix:semicolon
multiline_comment|/* if this urb had a transfer buffer already (old transfer) free it */
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* build the data header for the buffer and port that we are about to send out */
id|count
op_assign
id|fifo-&gt;count
suffix:semicolon
id|buffer
op_assign
id|kmalloc
(paren
id|count
op_plus
l_int|2
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - no more kernel memory...&quot;
)paren
suffix:semicolon
id|edge_port-&gt;write_in_progress
op_assign
id|FALSE
suffix:semicolon
r_return
suffix:semicolon
)brace
id|buffer
(braket
l_int|0
)braket
op_assign
id|IOSP_BUILD_DATA_HDR1
(paren
id|edge_port-&gt;port-&gt;number
op_minus
id|edge_port-&gt;port-&gt;serial-&gt;minor
comma
id|count
)paren
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
id|IOSP_BUILD_DATA_HDR2
(paren
id|edge_port-&gt;port-&gt;number
op_minus
id|edge_port-&gt;port-&gt;serial-&gt;minor
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* now copy our data */
id|bytesleft
op_assign
id|fifo-&gt;size
op_minus
id|fifo-&gt;tail
suffix:semicolon
id|firsthalf
op_assign
id|min
(paren
id|bytesleft
comma
id|count
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|buffer
(braket
l_int|2
)braket
comma
op_amp
id|fifo-&gt;fifo
(braket
id|fifo-&gt;tail
)braket
comma
id|firsthalf
)paren
suffix:semicolon
id|fifo-&gt;tail
op_add_assign
id|firsthalf
suffix:semicolon
id|fifo-&gt;count
op_sub_assign
id|firsthalf
suffix:semicolon
r_if
c_cond
(paren
id|fifo-&gt;tail
op_eq
id|fifo-&gt;size
)paren
(brace
id|fifo-&gt;tail
op_assign
l_int|0
suffix:semicolon
)brace
id|secondhalf
op_assign
id|count
op_minus
id|firsthalf
suffix:semicolon
r_if
c_cond
(paren
id|secondhalf
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|buffer
(braket
l_int|2
op_plus
id|firsthalf
)braket
comma
op_amp
id|fifo-&gt;fifo
(braket
id|fifo-&gt;tail
)braket
comma
id|secondhalf
)paren
suffix:semicolon
id|fifo-&gt;tail
op_add_assign
id|secondhalf
suffix:semicolon
id|fifo-&gt;count
op_sub_assign
id|secondhalf
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
)paren
(brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|count
comma
op_amp
id|buffer
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* fill up the urb with all of our data and submit it */
id|FILL_BULK_URB
(paren
id|urb
comma
id|edge_serial-&gt;serial-&gt;dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|edge_serial-&gt;serial-&gt;dev
comma
id|edge_serial-&gt;bulk_out_endpoint
)paren
comma
id|buffer
comma
id|count
op_plus
l_int|2
comma
id|edge_bulk_out_data_callback
comma
id|edge_port
)paren
suffix:semicolon
multiline_comment|/* set the USB_BULK_QUEUE flag so that we can shove a bunch of urbs at once down the pipe */
id|urb-&gt;transfer_flags
op_or_assign
id|USB_QUEUE_BULK
suffix:semicolon
id|urb-&gt;dev
op_assign
id|edge_serial-&gt;serial-&gt;dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* something went wrong */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - usb_submit_urb(write bulk) failed&quot;
)paren
suffix:semicolon
id|edge_port-&gt;write_in_progress
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decrement the number of credits we have by the number we just sent */
id|edge_port-&gt;txCredits
op_sub_assign
id|count
suffix:semicolon
id|edge_port-&gt;icount.tx
op_add_assign
id|count
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; wrote %d byte(s) TxCredit %d, Fifo %d&quot;
comma
id|count
comma
id|edge_port-&gt;txCredits
comma
id|fifo-&gt;count
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * edge_write_room&n; *&t;this function is called by the tty driver when it wants to know how many&n; *&t;bytes of data we can accept for a specific port.&n; *&t;If successful, we return the amount of room that we have for this port&n; *&t;(the txCredits), &n; *&t;Otherwise we return a negative error number.&n; *****************************************************************************/
DECL|function|edge_write_room
r_static
r_int
id|edge_write_room
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_int
id|room
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;closePending
op_eq
id|TRUE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edge_port-&gt;open
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - port not opened&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// total of both buffers is still txCredit
id|room
op_assign
id|edge_port-&gt;txCredits
op_minus
id|edge_port-&gt;txfifo.count
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - returns %d&quot;
comma
id|room
)paren
suffix:semicolon
r_return
id|room
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * edge_chars_in_buffer&n; *&t;this function is called by the tty driver when it wants to know how many&n; *&t;bytes of data we currently have outstanding in the port (data that has&n; *&t;been written, but hasn&squot;t made it out the port yet)&n; *&t;If successful, we return the number of bytes left to be written in the &n; *&t;system, &n; *&t;Otherwise we return a negative error number.&n; *****************************************************************************/
DECL|function|edge_chars_in_buffer
r_static
r_int
id|edge_chars_in_buffer
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_int
id|num_chars
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;closePending
op_eq
id|TRUE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edge_port-&gt;open
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - port not opened&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|num_chars
op_assign
id|edge_port-&gt;maxTxCredits
op_minus
id|edge_port-&gt;txCredits
op_plus
id|edge_port-&gt;txfifo.count
suffix:semicolon
r_if
c_cond
(paren
id|num_chars
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;(port %d) - returns %d&quot;
comma
id|port-&gt;number
comma
id|num_chars
)paren
suffix:semicolon
)brace
r_return
id|num_chars
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * SerialThrottle&n; *&t;this function is called by the tty driver when it wants to stop the data&n; *&t;being read from the port.&n; *****************************************************************************/
DECL|function|edge_throttle
r_static
r_void
id|edge_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edge_port-&gt;open
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - port not opened&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
multiline_comment|/* if we are implementing XON/XOFF, send the stop character */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_int
r_char
id|stop_char
op_assign
id|STOP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|status
op_assign
id|edge_write
(paren
id|port
comma
l_int|0
comma
op_amp
id|stop_char
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_le
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* if we are implementing RTS/CTS, toggle that line */
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|edge_port-&gt;shadowMCR
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
id|status
op_assign
id|send_cmd_write_uart_register
c_func
(paren
id|edge_port
comma
id|MCR
comma
id|edge_port-&gt;shadowMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * edge_unthrottle&n; *&t;this function is called by the tty driver when it wants to resume the data&n; *&t;being read from the port (called after SerialThrottle is called)&n; *****************************************************************************/
DECL|function|edge_unthrottle
r_static
r_void
id|edge_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edge_port-&gt;open
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - port not opened&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
multiline_comment|/* if we are implementing XON/XOFF, send the start character */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_int
r_char
id|start_char
op_assign
id|START_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|status
op_assign
id|edge_write
(paren
id|port
comma
l_int|0
comma
op_amp
id|start_char
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_le
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* if we are implementing RTS/CTS, toggle that line */
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|edge_port-&gt;shadowMCR
op_or_assign
id|MCR_RTS
suffix:semicolon
id|status
op_assign
id|send_cmd_write_uart_register
c_func
(paren
id|edge_port
comma
id|MCR
comma
id|edge_port-&gt;shadowMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * SerialSetTermios&n; *&t;this function is called by the tty driver when it wants to change the termios structure&n; *****************************************************************************/
DECL|function|edge_set_termios
r_static
r_void
id|edge_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_int
r_int
id|cflag
op_assign
id|tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - clfag %08x %08x iflag %08x %08x&quot;
comma
id|tty-&gt;termios-&gt;c_cflag
comma
id|old_termios-&gt;c_cflag
comma
id|RELEVANT_IFLAG
c_func
(paren
id|tty-&gt;termios-&gt;c_iflag
)paren
comma
id|RELEVANT_IFLAG
c_func
(paren
id|old_termios-&gt;c_iflag
)paren
)paren
suffix:semicolon
multiline_comment|/* check that they really want us to change something */
r_if
c_cond
(paren
id|old_termios
)paren
(brace
r_if
c_cond
(paren
(paren
id|cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
op_logical_and
(paren
id|RELEVANT_IFLAG
c_func
(paren
id|tty-&gt;termios-&gt;c_iflag
)paren
op_eq
id|RELEVANT_IFLAG
c_func
(paren
id|old_termios-&gt;c_iflag
)paren
)paren
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - nothing to change&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edge_port-&gt;open
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - port not opened&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* change the port settings to the new ones specified */
id|change_port_settings
(paren
id|edge_port
comma
id|old_termios
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * get_lsr_info - get line status register info&n; *&n; * Purpose: Let user call ioctl() to get info when the UART physically&n; * &t;    is emptied.  On bus types like RS485, the transmitter must&n; * &t;    release the bus after transmitting. This must be done when&n; * &t;    the transmit shift register is empty, not be done when the&n; * &t;    transmit holding register is empty.  This functionality&n; * &t;    allows an RS485 driver to be written in user space. &n; *****************************************************************************/
DECL|function|get_lsr_info
r_static
r_int
id|get_lsr_info
c_func
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;maxTxCredits
op_eq
id|edge_port-&gt;txCredits
op_logical_and
id|edge_port-&gt;txfifo.count
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; -- Empty&quot;
)paren
suffix:semicolon
id|result
op_assign
id|TIOCSER_TEMT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|value
comma
op_amp
id|result
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_number_bytes_avail
r_static
r_int
id|get_number_bytes_avail
c_func
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|edge_port-&gt;port-&gt;tty
suffix:semicolon
id|result
op_assign
id|tty-&gt;read_cnt
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;(%d) = %d&quot;
comma
id|edge_port-&gt;port-&gt;number
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|value
comma
op_amp
id|result
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
singleline_comment|//return 0;
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|function|set_modem_info
r_static
r_int
id|set_modem_info
c_func
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
r_int
id|cmd
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_int
id|mcr
op_assign
id|edge_port-&gt;shadowMCR
suffix:semicolon
r_int
r_int
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|arg
comma
id|value
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMBIS
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
id|mcr
op_or_assign
id|MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
id|mcr
op_or_assign
id|MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_LOOP
)paren
id|mcr
op_or_assign
id|MCR_LOOPBACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
id|mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
id|mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_LOOP
)paren
id|mcr
op_and_assign
op_complement
id|MCR_LOOPBACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
multiline_comment|/* turn off the RTS and DTR and LOOPBACK &n;&t;&t;&t; * and then only turn on what was asked to */
id|mcr
op_and_assign
op_complement
(paren
id|MCR_RTS
op_or
id|MCR_DTR
op_or
id|MCR_LOOPBACK
)paren
suffix:semicolon
id|mcr
op_or_assign
(paren
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
id|MCR_RTS
suffix:colon
l_int|0
)paren
suffix:semicolon
id|mcr
op_or_assign
(paren
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
id|MCR_DTR
suffix:colon
l_int|0
)paren
suffix:semicolon
id|mcr
op_or_assign
(paren
(paren
id|arg
op_amp
id|TIOCM_LOOP
)paren
ques
c_cond
id|MCR_LOOPBACK
suffix:colon
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|edge_port-&gt;shadowMCR
op_assign
id|mcr
suffix:semicolon
id|send_cmd_write_uart_register
c_func
(paren
id|edge_port
comma
id|MCR
comma
id|edge_port-&gt;shadowMCR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_modem_info
r_static
r_int
id|get_modem_info
c_func
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|msr
op_assign
id|edge_port-&gt;shadowMSR
suffix:semicolon
r_int
r_int
id|mcr
op_assign
id|edge_port-&gt;shadowMCR
suffix:semicolon
id|result
op_assign
(paren
(paren
id|mcr
op_amp
id|MCR_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x002 */
op_or
(paren
(paren
id|mcr
op_amp
id|MCR_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x004 */
op_or
(paren
(paren
id|msr
op_amp
id|MSR_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x020 */
op_or
(paren
(paren
id|msr
op_amp
id|MSR_CD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x040 */
op_or
(paren
(paren
id|msr
op_amp
id|MSR_RI
)paren
ques
c_cond
id|TIOCM_RI
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x080 */
op_or
(paren
(paren
id|msr
op_amp
id|MSR_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 0x100 */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; -- %x&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|value
comma
op_amp
id|result
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_serial_info
r_static
r_int
id|get_serial_info
c_func
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_struct
id|serial_struct
op_star
id|retinfo
)paren
(brace
r_struct
id|serial_struct
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retinfo
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp
comma
l_int|0
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|tmp.type
op_assign
id|PORT_16550A
suffix:semicolon
id|tmp.line
op_assign
id|edge_port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|tmp.port
op_assign
id|edge_port-&gt;port-&gt;number
suffix:semicolon
id|tmp.irq
op_assign
l_int|0
suffix:semicolon
id|tmp.flags
op_assign
id|ASYNC_SKIP_TEST
op_or
id|ASYNC_AUTO_IRQ
suffix:semicolon
id|tmp.xmit_fifo_size
op_assign
id|edge_port-&gt;maxTxCredits
suffix:semicolon
id|tmp.baud_base
op_assign
l_int|9600
suffix:semicolon
id|tmp.close_delay
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|tmp.closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
singleline_comment|//&t;tmp.custom_divisor&t;= state-&gt;custom_divisor;
singleline_comment|//&t;tmp.hub6&t;&t;= state-&gt;hub6;
singleline_comment|//&t;tmp.io_type&t;&t;= state-&gt;io_type;
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|retinfo
comma
op_amp
id|tmp
comma
r_sizeof
(paren
op_star
id|retinfo
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * SerialIoctl&n; *&t;this function handles any ioctl calls to the driver&n; *****************************************************************************/
DECL|function|edge_ioctl
r_static
r_int
id|edge_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_struct
id|async_icount
id|cnow
suffix:semicolon
r_struct
id|async_icount
id|cprev
suffix:semicolon
r_struct
id|serial_icounter_struct
id|icount
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d, cmd = 0x%x&quot;
comma
id|port-&gt;number
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
singleline_comment|// return number of bytes available
r_case
id|TIOCINQ
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; (%d) TIOCINQ&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
id|get_number_bytes_avail
c_func
(paren
id|edge_port
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSERGETLSR
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; (%d) TIOCSERGETLSR&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
id|get_lsr_info
c_func
(paren
id|edge_port
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_case
id|TIOCMSET
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; (%d) TIOCMSET/TIOCMBIC/TIOCMSET&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
id|set_modem_info
c_func
(paren
id|edge_port
comma
id|cmd
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCMGET
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; (%d) TIOCMGET&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
id|get_modem_info
c_func
(paren
id|edge_port
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; (%d) TIOCGSERIAL&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
id|get_serial_info
c_func
(paren
id|edge_port
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; (%d) TIOCSSERIAL&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMIWAIT
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; (%d) TIOCMIWAIT&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
id|cprev
op_assign
id|edge_port-&gt;icount
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|edge_port-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* see if a signal did it */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|cnow
op_assign
id|edge_port-&gt;icount
suffix:semicolon
r_if
c_cond
(paren
id|cnow.rng
op_eq
id|cprev.rng
op_logical_and
id|cnow.dsr
op_eq
id|cprev.dsr
op_logical_and
id|cnow.dcd
op_eq
id|cprev.dcd
op_logical_and
id|cnow.cts
op_eq
id|cprev.cts
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* no change =&gt; error */
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
)paren
op_logical_and
(paren
id|cnow.rng
op_ne
id|cprev.rng
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DSR
)paren
op_logical_and
(paren
id|cnow.dsr
op_ne
id|cprev.dsr
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
id|cnow.dcd
op_ne
id|cprev.dcd
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CTS
)paren
op_logical_and
(paren
id|cnow.cts
op_ne
id|cprev.cts
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|cprev
op_assign
id|cnow
suffix:semicolon
)brace
multiline_comment|/* NOTREACHED */
r_break
suffix:semicolon
r_case
id|TIOCGICOUNT
suffix:colon
id|cnow
op_assign
id|edge_port-&gt;icount
suffix:semicolon
id|icount.cts
op_assign
id|cnow.cts
suffix:semicolon
id|icount.dsr
op_assign
id|cnow.dsr
suffix:semicolon
id|icount.rng
op_assign
id|cnow.rng
suffix:semicolon
id|icount.dcd
op_assign
id|cnow.dcd
suffix:semicolon
id|icount.rx
op_assign
id|cnow.rx
suffix:semicolon
id|icount.tx
op_assign
id|cnow.tx
suffix:semicolon
id|icount.frame
op_assign
id|cnow.frame
suffix:semicolon
id|icount.overrun
op_assign
id|cnow.overrun
suffix:semicolon
id|icount.parity
op_assign
id|cnow.parity
suffix:semicolon
id|icount.brk
op_assign
id|cnow.brk
suffix:semicolon
id|icount.buf_overrun
op_assign
id|cnow.buf_overrun
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; (%d) TIOCGICOUNT RX=%d, TX=%d&quot;
comma
id|port-&gt;number
comma
id|icount.rx
comma
id|icount.tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|icount
comma
r_sizeof
(paren
id|icount
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * SerialBreak&n; *&t;this function sends a break to the port&n; *****************************************************************************/
DECL|function|edge_break
r_static
r_void
id|edge_break
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/* flush and chase */
id|edge_port-&gt;chaseResponsePending
op_assign
id|TRUE
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Sending IOSP_CMD_CHASE_PORT&quot;
)paren
suffix:semicolon
id|status
op_assign
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_CHASE_PORT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
singleline_comment|// block until chase finished
id|block_until_chase_response
c_func
(paren
id|edge_port
)paren
suffix:semicolon
)brace
r_else
(brace
id|edge_port-&gt;chaseResponsePending
op_assign
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|break_state
op_eq
op_minus
l_int|1
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Sending IOSP_CMD_SET_BREAK&quot;
)paren
suffix:semicolon
id|status
op_assign
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_SET_BREAK
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Sending IOSP_CMD_CLEAR_BREAK&quot;
)paren
suffix:semicolon
id|status
op_assign
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_CLEAR_BREAK
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - error sending break set/clear command.&quot;
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * process_rcvd_data&n; *&t;this function handles the data received on the bulk in pipe.&n; *****************************************************************************/
DECL|function|process_rcvd_data
r_static
r_int
id|process_rcvd_data
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
comma
r_int
r_char
op_star
id|buffer
comma
id|__u16
id|bufferLength
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|__u16
id|lastBufferLength
suffix:semicolon
id|__u16
id|rxLen
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
id|lastBufferLength
op_assign
id|bufferLength
op_plus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|bufferLength
OG
l_int|0
)paren
(brace
multiline_comment|/* failsafe incase we get a message that we don&squot;t understand */
r_if
c_cond
(paren
id|lastBufferLength
op_eq
id|bufferLength
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - stuck in loop, exiting it.&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|lastBufferLength
op_assign
id|bufferLength
suffix:semicolon
r_switch
c_cond
(paren
id|edge_serial-&gt;rxState
)paren
(brace
r_case
id|EXPECT_HDR1
suffix:colon
id|edge_serial-&gt;rxHeader1
op_assign
op_star
id|buffer
suffix:semicolon
op_increment
id|buffer
suffix:semicolon
op_decrement
id|bufferLength
suffix:semicolon
r_if
c_cond
(paren
id|bufferLength
op_eq
l_int|0
)paren
(brace
id|edge_serial-&gt;rxState
op_assign
id|EXPECT_HDR2
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* otherwise, drop on through */
r_case
id|EXPECT_HDR2
suffix:colon
id|edge_serial-&gt;rxHeader2
op_assign
op_star
id|buffer
suffix:semicolon
op_increment
id|buffer
suffix:semicolon
op_decrement
id|bufferLength
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Hdr1=%02X Hdr2=%02X&quot;
comma
id|edge_serial-&gt;rxHeader1
comma
id|edge_serial-&gt;rxHeader2
)paren
suffix:semicolon
singleline_comment|// Process depending on whether this header is
singleline_comment|// data or status
r_if
c_cond
(paren
id|IS_CMD_STAT_HDR
c_func
(paren
id|edge_serial-&gt;rxHeader1
)paren
)paren
(brace
singleline_comment|// Decode this status header and goto EXPECT_HDR1 (if we
singleline_comment|// can process the status with only 2 bytes), or goto
singleline_comment|// EXPECT_HDR3 to get the third byte.
id|edge_serial-&gt;rxPort
op_assign
id|IOSP_GET_HDR_PORT
c_func
(paren
id|edge_serial-&gt;rxHeader1
)paren
suffix:semicolon
id|edge_serial-&gt;rxStatusCode
op_assign
id|IOSP_GET_STATUS_CODE
c_func
(paren
id|edge_serial-&gt;rxHeader1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IOSP_STATUS_IS_2BYTE
c_func
(paren
id|edge_serial-&gt;rxStatusCode
)paren
)paren
(brace
singleline_comment|// This status needs additional bytes. Save what we have
singleline_comment|// and then wait for more data.
id|edge_serial-&gt;rxStatusParam
op_assign
id|edge_serial-&gt;rxHeader2
suffix:semicolon
id|edge_serial-&gt;rxState
op_assign
id|EXPECT_HDR3
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// We have all the header bytes, process the status now
id|process_rcvd_status
(paren
id|edge_serial
comma
id|edge_serial-&gt;rxHeader2
comma
l_int|0
)paren
suffix:semicolon
id|edge_serial-&gt;rxState
op_assign
id|EXPECT_HDR1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|edge_serial-&gt;rxPort
op_assign
id|IOSP_GET_HDR_PORT
c_func
(paren
id|edge_serial-&gt;rxHeader1
)paren
suffix:semicolon
id|edge_serial-&gt;rxBytesRemaining
op_assign
id|IOSP_GET_HDR_DATA_LEN
c_func
(paren
id|edge_serial-&gt;rxHeader1
comma
id|edge_serial-&gt;rxHeader2
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Data for Port %u Len %u&quot;
comma
id|edge_serial-&gt;rxPort
comma
id|edge_serial-&gt;rxBytesRemaining
)paren
suffix:semicolon
singleline_comment|//ASSERT( DevExt-&gt;RxPort &lt; DevExt-&gt;NumPorts );
singleline_comment|//ASSERT( DevExt-&gt;RxBytesRemaining &lt; IOSP_MAX_DATA_LENGTH );
r_if
c_cond
(paren
id|bufferLength
op_eq
l_int|0
)paren
(brace
id|edge_serial-&gt;rxState
op_assign
id|EXPECT_DATA
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// Else, drop through
)brace
r_case
id|EXPECT_DATA
suffix:colon
singleline_comment|// Expect data
r_if
c_cond
(paren
id|bufferLength
OL
id|edge_serial-&gt;rxBytesRemaining
)paren
(brace
id|rxLen
op_assign
id|bufferLength
suffix:semicolon
id|edge_serial-&gt;rxState
op_assign
id|EXPECT_DATA
suffix:semicolon
singleline_comment|// Expect data to start next buffer
)brace
r_else
(brace
singleline_comment|// BufLen &gt;= RxBytesRemaining
id|rxLen
op_assign
id|edge_serial-&gt;rxBytesRemaining
suffix:semicolon
id|edge_serial-&gt;rxState
op_assign
id|EXPECT_HDR1
suffix:semicolon
singleline_comment|// Start another header next time
)brace
id|bufferLength
op_sub_assign
id|rxLen
suffix:semicolon
id|edge_serial-&gt;rxBytesRemaining
op_sub_assign
id|rxLen
suffix:semicolon
multiline_comment|/* spit this data back into the tty driver if this port is open */
r_if
c_cond
(paren
id|rxLen
)paren
(brace
id|port
op_assign
op_amp
id|edge_serial-&gt;serial-&gt;port
(braket
id|edge_serial-&gt;rxPort
)braket
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
id|__FUNCTION__
)paren
op_eq
l_int|0
)paren
(brace
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;open
)paren
(brace
id|tty
op_assign
id|edge_port-&gt;port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - Sending %d bytes to TTY for port %d&quot;
comma
id|rxLen
comma
id|edge_serial-&gt;rxPort
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rxLen
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/* if we insert more than TTY_FLIPBUF_SIZE characters, we drop them. */
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* this doesn&squot;t actually push the data through unless tty-&gt;low_latency is set */
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|buffer
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
id|edge_port-&gt;icount.rx
op_add_assign
id|rxLen
suffix:semicolon
)brace
)brace
id|buffer
op_add_assign
id|rxLen
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXPECT_HDR3
suffix:colon
singleline_comment|// Expect 3rd byte of status header
id|edge_serial-&gt;rxHeader3
op_assign
op_star
id|buffer
suffix:semicolon
op_increment
id|buffer
suffix:semicolon
op_decrement
id|bufferLength
suffix:semicolon
singleline_comment|// We have all the header bytes, process the status now
id|process_rcvd_status
(paren
id|edge_serial
comma
id|edge_serial-&gt;rxStatusParam
comma
id|edge_serial-&gt;rxHeader3
)paren
suffix:semicolon
id|edge_serial-&gt;rxState
op_assign
id|EXPECT_HDR1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * process_rcvd_status&n; *&t;this function handles the any status messages received on the bulk in pipe.&n; *****************************************************************************/
DECL|function|process_rcvd_status
r_static
r_void
id|process_rcvd_status
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
comma
id|__u8
id|byte2
comma
id|__u8
id|byte3
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
suffix:semicolon
id|__u8
id|code
op_assign
id|edge_serial-&gt;rxStatusCode
suffix:semicolon
multiline_comment|/* switch the port pointer to the one being currently talked about */
id|port
op_assign
op_amp
id|edge_serial-&gt;serial-&gt;port
(braket
id|edge_serial-&gt;rxPort
)braket
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
id|__FUNCTION__
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
(brace
id|err
(paren
id|__FUNCTION__
l_string|&quot; - edge_port == NULL for port %d&quot;
comma
id|edge_serial-&gt;rxPort
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|edge_serial-&gt;rxPort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|IOSP_EXT_STATUS
)paren
(brace
r_switch
c_cond
(paren
id|byte2
)paren
(brace
r_case
id|IOSP_EXT_STATUS_CHASE_RSP
suffix:colon
singleline_comment|// we want to do EXT status regardless of port open/closed 
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Port %u EXT CHASE_RSP Data = %02x&quot;
comma
id|edge_serial-&gt;rxPort
comma
id|byte3
)paren
suffix:semicolon
singleline_comment|// Currently, the only EXT_STATUS is Chase, so process here instead of one more call
singleline_comment|// to one more subroutine. If/when more EXT_STATUS, there&squot;ll be more work to do.
singleline_comment|// Also, we currently clear flag and close the port regardless of content of above&squot;s Byte3.
singleline_comment|// We could choose to do something else when Byte3 says Timeout on Chase from Edgeport,
singleline_comment|// like wait longer in block_until_chase_response, but for now we don&squot;t. 
id|edge_port-&gt;chaseResponsePending
op_assign
id|FALSE
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|edge_port-&gt;wait_chase
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|IOSP_EXT_STATUS_RX_CHECK_RSP
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; ========== Port %u CHECK_RSP Sequence = %02x =============&bslash;n&quot;
comma
id|edge_serial-&gt;rxPort
comma
id|byte3
)paren
suffix:semicolon
singleline_comment|//Port-&gt;RxCheckRsp = TRUE;
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|code
op_eq
id|IOSP_STATUS_OPEN_RSP
)paren
(brace
id|edge_port-&gt;txCredits
op_assign
id|GET_TX_BUFFER_SIZE
c_func
(paren
id|byte3
)paren
suffix:semicolon
id|edge_port-&gt;maxTxCredits
op_assign
id|edge_port-&gt;txCredits
suffix:semicolon
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - Port %u Open Response Inital MSR = %02x TxBufferSize = %d&quot;
comma
id|edge_serial-&gt;rxPort
comma
id|byte2
comma
id|edge_port-&gt;txCredits
)paren
suffix:semicolon
id|handle_new_msr
(paren
id|edge_port
comma
id|byte2
)paren
suffix:semicolon
multiline_comment|/* send the current line settings to the port so we are in sync with any further termios calls */
id|change_port_settings
(paren
id|edge_port
comma
id|edge_port-&gt;port-&gt;tty-&gt;termios
)paren
suffix:semicolon
multiline_comment|/* we have completed the open */
id|edge_port-&gt;openPending
op_assign
id|FALSE
suffix:semicolon
id|edge_port-&gt;open
op_assign
id|TRUE
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|edge_port-&gt;wait_open
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// If port is closed, silently discard all rcvd status. We can
singleline_comment|// have cases where buffered status is received AFTER the close
singleline_comment|// port command is sent to the Edgeport.
r_if
c_cond
(paren
(paren
op_logical_neg
id|edge_port-&gt;open
)paren
op_logical_or
(paren
id|edge_port-&gt;closePending
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|code
)paren
(brace
singleline_comment|// Not currently sent by Edgeport
r_case
id|IOSP_STATUS_LSR
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Port %u LSR Status = %02x&quot;
comma
id|edge_serial-&gt;rxPort
comma
id|byte2
)paren
suffix:semicolon
id|handle_new_lsr
(paren
id|edge_port
comma
id|FALSE
comma
id|byte2
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IOSP_STATUS_LSR_DATA
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Port %u LSR Status = %02x, Data = %02x&quot;
comma
id|edge_serial-&gt;rxPort
comma
id|byte2
comma
id|byte3
)paren
suffix:semicolon
singleline_comment|// byte2 is LSR Register
singleline_comment|// byte3 is broken data byte
id|handle_new_lsr
(paren
id|edge_port
comma
id|TRUE
comma
id|byte2
comma
id|byte3
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|//
singleline_comment|//&t;case IOSP_EXT_4_STATUS:
singleline_comment|//&t;&t;dbg(__FUNCTION__&quot; - Port %u LSR Status = %02x Data = %02x&quot;, edge_serial-&gt;rxPort, byte2, byte3);
singleline_comment|//&t;&t;break;
singleline_comment|//
r_case
id|IOSP_STATUS_MSR
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Port %u MSR Status = %02x&quot;
comma
id|edge_serial-&gt;rxPort
comma
id|byte2
)paren
suffix:semicolon
singleline_comment|// Process this new modem status and generate appropriate
singleline_comment|// events, etc, based on the new status. This routine
singleline_comment|// also saves the MSR in Port-&gt;ShadowMsr.
id|handle_new_msr
c_func
(paren
id|edge_port
comma
id|byte2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Unrecognized IOSP status code %u&bslash;n&quot;
comma
id|code
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * handle_new_msr&n; *&t;this function handles any change to the msr register for a port.&n; *****************************************************************************/
DECL|function|handle_new_msr
r_static
r_void
id|handle_new_msr
c_func
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|newMsr
)paren
(brace
r_struct
id|async_icount
op_star
id|icount
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; %02x&quot;
comma
id|newMsr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newMsr
op_amp
(paren
id|MSR_DELTA_CTS
op_or
id|MSR_DELTA_DSR
op_or
id|MSR_DELTA_RI
op_or
id|MSR_DELTA_CD
)paren
)paren
(brace
id|icount
op_assign
op_amp
id|edge_port-&gt;icount
suffix:semicolon
multiline_comment|/* update input line counters */
r_if
c_cond
(paren
id|newMsr
op_amp
id|MSR_DELTA_CTS
)paren
(brace
id|icount-&gt;cts
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newMsr
op_amp
id|MSR_DELTA_DSR
)paren
(brace
id|icount-&gt;dsr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newMsr
op_amp
id|MSR_DELTA_CD
)paren
(brace
id|icount-&gt;dcd
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newMsr
op_amp
id|MSR_DELTA_RI
)paren
(brace
id|icount-&gt;rng
op_increment
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|edge_port-&gt;delta_msr_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* Save the new modem status */
id|edge_port-&gt;shadowMSR
op_assign
id|newMsr
op_amp
l_int|0xf0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * handle_new_lsr&n; *&t;this function handles any change to the lsr register for a port.&n; *****************************************************************************/
DECL|function|handle_new_lsr
r_static
r_void
id|handle_new_lsr
c_func
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|lsrData
comma
id|__u8
id|lsr
comma
id|__u8
id|data
)paren
(brace
id|__u8
id|newLsr
op_assign
(paren
id|__u8
)paren
(paren
id|lsr
op_amp
(paren
id|__u8
)paren
(paren
id|LSR_OVER_ERR
op_or
id|LSR_PAR_ERR
op_or
id|LSR_FRM_ERR
op_or
id|LSR_BREAK
)paren
)paren
suffix:semicolon
r_struct
id|async_icount
op_star
id|icount
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - %02x&quot;
comma
id|newLsr
)paren
suffix:semicolon
id|edge_port-&gt;shadowLSR
op_assign
id|lsr
suffix:semicolon
r_if
c_cond
(paren
id|newLsr
op_amp
id|LSR_BREAK
)paren
(brace
singleline_comment|//
singleline_comment|// Parity and Framing errors only count if they
singleline_comment|// occur exclusive of a break being
singleline_comment|// received.
singleline_comment|//
id|newLsr
op_and_assign
(paren
id|__u8
)paren
(paren
id|LSR_OVER_ERR
op_or
id|LSR_BREAK
)paren
suffix:semicolon
)brace
multiline_comment|/* Place LSR data byte into Rx buffer */
r_if
c_cond
(paren
id|lsrData
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|edge_port-&gt;port-&gt;tty
comma
id|data
comma
l_int|0
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|edge_port-&gt;port-&gt;tty
)paren
suffix:semicolon
)brace
multiline_comment|/* update input line counters */
id|icount
op_assign
op_amp
id|edge_port-&gt;icount
suffix:semicolon
r_if
c_cond
(paren
id|newLsr
op_amp
id|LSR_BREAK
)paren
(brace
id|icount-&gt;brk
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newLsr
op_amp
id|LSR_OVER_ERR
)paren
(brace
id|icount-&gt;overrun
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newLsr
op_amp
id|LSR_PAR_ERR
)paren
(brace
id|icount-&gt;parity
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newLsr
op_amp
id|LSR_FRM_ERR
)paren
(brace
id|icount-&gt;frame
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * sram_write&n; *&t;writes a number of bytes to the Edgeport device&squot;s sram starting at the &n; *&t;given address.&n; *&t;If successful returns the number of bytes written, otherwise it returns&n; *&t;a negative error number of the problem.&n; ****************************************************************************/
DECL|function|sram_write
r_static
r_int
id|sram_write
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
id|__u16
id|extAddr
comma
id|__u16
id|addr
comma
id|__u16
id|length
comma
id|__u8
op_star
id|data
)paren
(brace
r_int
id|result
suffix:semicolon
id|__u16
id|current_length
suffix:semicolon
r_int
r_char
op_star
id|transfer_buffer
suffix:semicolon
singleline_comment|//&t;dbg (__FUNCTION__&quot; - %x, %x, %d&quot;, extAddr, addr, length);
id|transfer_buffer
op_assign
id|kmalloc
(paren
l_int|64
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|transfer_buffer
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - kmalloc(%d) failed.&bslash;n&quot;
comma
l_int|64
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* need to split these writes up into 64 byte chunks */
id|result
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|length
OG
l_int|64
)paren
(brace
id|current_length
op_assign
l_int|64
suffix:semicolon
)brace
r_else
(brace
id|current_length
op_assign
id|length
suffix:semicolon
)brace
singleline_comment|//&t;&t;dbg (__FUNCTION__&quot; - writing %x, %x, %d&quot;, extAddr, addr, current_length);
id|memcpy
(paren
id|transfer_buffer
comma
id|data
comma
id|current_length
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|USB_REQUEST_ION_WRITE_RAM
comma
l_int|0x40
comma
id|addr
comma
id|extAddr
comma
id|transfer_buffer
comma
id|current_length
comma
l_int|300
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_break
suffix:semicolon
id|length
op_sub_assign
id|current_length
suffix:semicolon
id|addr
op_add_assign
id|current_length
suffix:semicolon
id|data
op_add_assign
id|current_length
suffix:semicolon
)brace
id|kfree
(paren
id|transfer_buffer
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * rom_write&n; *&t;writes a number of bytes to the Edgeport device&squot;s ROM starting at the&n; *&t;given address.&n; *&t;If successful returns the number of bytes written, otherwise it returns&n; *&t;a negative error number of the problem.&n; ****************************************************************************/
DECL|function|rom_write
r_static
r_int
id|rom_write
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
id|__u16
id|extAddr
comma
id|__u16
id|addr
comma
id|__u16
id|length
comma
id|__u8
op_star
id|data
)paren
(brace
r_int
id|result
suffix:semicolon
id|__u16
id|current_length
suffix:semicolon
r_int
r_char
op_star
id|transfer_buffer
suffix:semicolon
singleline_comment|//&t;dbg (__FUNCTION__&quot; - %x, %x, %d&quot;, extAddr, addr, length);
id|transfer_buffer
op_assign
id|kmalloc
(paren
l_int|64
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|transfer_buffer
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - kmalloc(%d) failed.&bslash;n&quot;
comma
l_int|64
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* need to split these writes up into 64 byte chunks */
id|result
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|length
OG
l_int|64
)paren
(brace
id|current_length
op_assign
l_int|64
suffix:semicolon
)brace
r_else
(brace
id|current_length
op_assign
id|length
suffix:semicolon
)brace
singleline_comment|//&t;&t;dbg (__FUNCTION__&quot; - writing %x, %x, %d&quot;, extAddr, addr, current_length);
id|memcpy
(paren
id|transfer_buffer
comma
id|data
comma
id|current_length
)paren
suffix:semicolon
id|result
op_assign
id|usb_control_msg
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|USB_REQUEST_ION_WRITE_ROM
comma
l_int|0x40
comma
id|addr
comma
id|extAddr
comma
id|transfer_buffer
comma
id|current_length
comma
l_int|300
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_break
suffix:semicolon
id|length
op_sub_assign
id|current_length
suffix:semicolon
id|addr
op_add_assign
id|current_length
suffix:semicolon
id|data
op_add_assign
id|current_length
suffix:semicolon
)brace
id|kfree
(paren
id|transfer_buffer
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * rom_read&n; *&t;reads a number of bytes from the Edgeport device starting at the given&n; *&t;address.&n; *&t;If successful returns the number of bytes read, otherwise it returns&n; *&t;a negative error number of the problem.&n; ****************************************************************************/
DECL|function|rom_read
r_static
r_int
id|rom_read
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
id|__u16
id|extAddr
comma
id|__u16
id|addr
comma
id|__u16
id|length
comma
id|__u8
op_star
id|data
)paren
(brace
r_int
id|result
suffix:semicolon
id|__u16
id|current_length
suffix:semicolon
r_int
r_char
op_star
id|transfer_buffer
suffix:semicolon
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - %x, %x, %d&quot;
comma
id|extAddr
comma
id|addr
comma
id|length
)paren
suffix:semicolon
id|transfer_buffer
op_assign
id|kmalloc
(paren
l_int|64
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|transfer_buffer
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - kmalloc(%d) failed.&bslash;n&quot;
comma
l_int|64
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* need to split these reads up into 64 byte chunks */
id|result
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|length
OG
l_int|64
)paren
(brace
id|current_length
op_assign
l_int|64
suffix:semicolon
)brace
r_else
(brace
id|current_length
op_assign
id|length
suffix:semicolon
)brace
singleline_comment|//&t;&t;dbg (__FUNCTION__&quot; - %x, %x, %d&quot;, extAddr, addr, current_length);
id|result
op_assign
id|usb_control_msg
(paren
id|serial-&gt;dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|USB_REQUEST_ION_READ_ROM
comma
l_int|0xC0
comma
id|addr
comma
id|extAddr
comma
id|transfer_buffer
comma
id|current_length
comma
l_int|300
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_break
suffix:semicolon
id|memcpy
(paren
id|data
comma
id|transfer_buffer
comma
id|current_length
)paren
suffix:semicolon
id|length
op_sub_assign
id|current_length
suffix:semicolon
id|addr
op_add_assign
id|current_length
suffix:semicolon
id|data
op_add_assign
id|current_length
suffix:semicolon
)brace
id|kfree
(paren
id|transfer_buffer
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * send_iosp_ext_cmd&n; *&t;Is used to send a IOSP message to the Edgeport device&n; ****************************************************************************/
DECL|function|send_iosp_ext_cmd
r_static
r_int
id|send_iosp_ext_cmd
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|command
comma
id|__u8
id|param
)paren
(brace
r_int
r_char
op_star
id|buffer
suffix:semicolon
r_int
r_char
op_star
id|currentCommand
suffix:semicolon
r_int
id|length
op_assign
l_int|0
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - %d, %d&quot;
comma
id|command
comma
id|param
)paren
suffix:semicolon
id|buffer
op_assign
id|kmalloc
(paren
l_int|10
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - kmalloc(%d) failed.&bslash;n&quot;
comma
l_int|10
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|currentCommand
op_assign
id|buffer
suffix:semicolon
id|MAKE_CMD_EXT_CMD
(paren
op_amp
id|currentCommand
comma
op_amp
id|length
comma
id|edge_port-&gt;port-&gt;number
op_minus
id|edge_port-&gt;port-&gt;serial-&gt;minor
comma
id|command
comma
id|param
)paren
suffix:semicolon
id|status
op_assign
id|write_cmd_usb
(paren
id|edge_port
comma
id|buffer
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* something bad happened, let&squot;s free up the memory */
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * write_cmd_usb&n; *&t;this function writes the given buffer out to the bulk write endpoint.&n; *****************************************************************************/
DECL|function|write_cmd_usb
r_static
r_int
id|write_cmd_usb
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|length
)paren
(brace
r_struct
id|edgeport_serial
op_star
id|edge_serial
op_assign
(paren
r_struct
id|edgeport_serial
op_star
)paren
id|edge_port-&gt;port-&gt;serial
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|length
comma
id|buffer
)paren
suffix:semicolon
multiline_comment|/* Allocate our next urb */
id|urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|CmdUrbs
op_increment
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - ALLOCATE URB %p (outstanding %d)&quot;
comma
id|urb
comma
id|CmdUrbs
)paren
suffix:semicolon
id|FILL_BULK_URB
(paren
id|urb
comma
id|edge_serial-&gt;serial-&gt;dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|edge_serial-&gt;serial-&gt;dev
comma
id|edge_serial-&gt;bulk_out_endpoint
)paren
comma
id|buffer
comma
id|length
comma
id|edge_bulk_out_cmd_callback
comma
id|edge_port
)paren
suffix:semicolon
multiline_comment|/* set the USB_BULK_QUEUE flag so that we can shove a bunch of urbs at once down the pipe */
id|urb-&gt;transfer_flags
op_or_assign
id|USB_QUEUE_BULK
suffix:semicolon
id|edge_port-&gt;commandPending
op_assign
id|TRUE
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* something went wrong */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - usb_submit_urb(write bulk) failed&quot;
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|urb
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|urb
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// wait for command to finish
id|timeout
op_assign
id|COMMAND_TIMEOUT
suffix:semicolon
macro_line|#if 0
r_while
c_loop
(paren
id|timeout
op_logical_and
id|edge_port-&gt;commandPending
op_eq
id|TRUE
)paren
(brace
id|timeout
op_assign
id|interruptible_sleep_on_timeout
(paren
op_amp
id|edge_port-&gt;wait_command
comma
id|timeout
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|edge_port-&gt;commandPending
op_eq
id|TRUE
)paren
(brace
multiline_comment|/* command timed out */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - command timed out&quot;
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * send_cmd_write_baud_rate&n; *&t;this function sends the proper command to change the baud rate of the&n; *&t;specified port.&n; *****************************************************************************/
DECL|function|send_cmd_write_baud_rate
r_static
r_int
id|send_cmd_write_baud_rate
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
id|baudRate
)paren
(brace
r_int
r_char
op_star
id|cmdBuffer
suffix:semicolon
r_int
r_char
op_star
id|currCmd
suffix:semicolon
r_int
id|cmdLen
op_assign
l_int|0
suffix:semicolon
r_int
id|divisor
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
r_char
id|number
op_assign
id|edge_port-&gt;port-&gt;number
op_minus
id|edge_port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port = %d, baud = %d&quot;
comma
id|edge_port-&gt;port-&gt;number
comma
id|baudRate
)paren
suffix:semicolon
id|status
op_assign
id|calc_baud_rate_divisor
(paren
id|baudRate
comma
op_amp
id|divisor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - bad baud rate&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// Alloc memory for the string of commands.
id|cmdBuffer
op_assign
id|kmalloc
(paren
l_int|0x100
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmdBuffer
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - kmalloc(%d) failed.&bslash;n&quot;
comma
l_int|0x100
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|currCmd
op_assign
id|cmdBuffer
suffix:semicolon
singleline_comment|// Enable access to divisor latch
id|MAKE_CMD_WRITE_REG
c_func
(paren
op_amp
id|currCmd
comma
op_amp
id|cmdLen
comma
id|number
comma
id|LCR
comma
id|LCR_DL_ENABLE
)paren
suffix:semicolon
singleline_comment|// Write the divisor itself
id|MAKE_CMD_WRITE_REG
c_func
(paren
op_amp
id|currCmd
comma
op_amp
id|cmdLen
comma
id|number
comma
id|DLL
comma
id|LOW8
(paren
id|divisor
)paren
)paren
suffix:semicolon
id|MAKE_CMD_WRITE_REG
c_func
(paren
op_amp
id|currCmd
comma
op_amp
id|cmdLen
comma
id|number
comma
id|DLM
comma
id|HIGH8
c_func
(paren
id|divisor
)paren
)paren
suffix:semicolon
singleline_comment|// Restore original value to disable access to divisor latch
id|MAKE_CMD_WRITE_REG
c_func
(paren
op_amp
id|currCmd
comma
op_amp
id|cmdLen
comma
id|number
comma
id|LCR
comma
id|edge_port-&gt;shadowLCR
)paren
suffix:semicolon
id|status
op_assign
id|write_cmd_usb
c_func
(paren
id|edge_port
comma
id|cmdBuffer
comma
id|cmdLen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* something bad happened, let&squot;s free up the memory */
id|kfree
(paren
id|cmdBuffer
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * calc_baud_rate_divisor&n; *&t;this function calculates the proper baud rate divisor for the specified&n; *&t;baud rate.&n; *****************************************************************************/
DECL|function|calc_baud_rate_divisor
r_static
r_int
id|calc_baud_rate_divisor
(paren
r_int
id|baudrate
comma
r_int
op_star
id|divisor
)paren
(brace
r_int
id|i
suffix:semicolon
id|__u16
id|custom
suffix:semicolon
id|__u16
id|round1
suffix:semicolon
id|__u16
id|round
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - %d&quot;
comma
id|baudrate
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ENTRIES
c_func
(paren
id|divisor_table
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|divisor_table
(braket
id|i
)braket
dot
id|BaudRate
op_eq
id|baudrate
)paren
(brace
op_star
id|divisor
op_assign
id|divisor_table
(braket
id|i
)braket
dot
id|Divisor
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
singleline_comment|// We have tried all of the standard baud rates
singleline_comment|// lets try to calculate the divisor for this baud rate
singleline_comment|// Make sure the baud rate is reasonable
r_if
c_cond
(paren
id|baudrate
OG
l_int|75
op_logical_and
id|baudrate
OL
l_int|230400
)paren
(brace
singleline_comment|// get divisor
id|custom
op_assign
(paren
id|__u16
)paren
(paren
l_int|230400L
op_div
id|baudrate
)paren
suffix:semicolon
singleline_comment|// Check for round off
id|round1
op_assign
(paren
id|__u16
)paren
(paren
l_int|2304000L
op_div
id|baudrate
)paren
suffix:semicolon
id|round
op_assign
(paren
id|__u16
)paren
(paren
id|round1
op_minus
(paren
id|custom
op_star
l_int|10
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|round
OG
l_int|4
)paren
(brace
id|custom
op_increment
suffix:semicolon
)brace
op_star
id|divisor
op_assign
id|custom
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Baud %d = %d&bslash;n&quot;
comma
id|baudrate
comma
id|custom
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * send_cmd_write_uart_register&n; *&t;this function builds up a uart register message and sends to to the device.&n; *****************************************************************************/
DECL|function|send_cmd_write_uart_register
r_static
r_int
id|send_cmd_write_uart_register
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|regNum
comma
id|__u8
id|regValue
)paren
(brace
r_int
r_char
op_star
id|cmdBuffer
suffix:semicolon
r_int
r_char
op_star
id|currCmd
suffix:semicolon
r_int
r_int
id|cmdLen
op_assign
l_int|0
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; - write to %s register 0x%02x&quot;
comma
(paren
id|regNum
op_eq
id|MCR
)paren
ques
c_cond
l_string|&quot;MCR&quot;
suffix:colon
l_string|&quot;LCR&quot;
comma
id|regValue
)paren
suffix:semicolon
singleline_comment|// Alloc memory for the string of commands.
id|cmdBuffer
op_assign
id|kmalloc
(paren
l_int|0x10
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdBuffer
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|currCmd
op_assign
id|cmdBuffer
suffix:semicolon
singleline_comment|// Build a cmd in the buffer to write the given register
id|MAKE_CMD_WRITE_REG
(paren
op_amp
id|currCmd
comma
op_amp
id|cmdLen
comma
id|edge_port-&gt;port-&gt;number
op_minus
id|edge_port-&gt;port-&gt;serial-&gt;minor
comma
id|regNum
comma
id|regValue
)paren
suffix:semicolon
id|status
op_assign
id|write_cmd_usb
c_func
(paren
id|edge_port
comma
id|cmdBuffer
comma
id|cmdLen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* something bad happened, let&squot;s free up the memory */
id|kfree
(paren
id|cmdBuffer
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * change_port_settings&n; *&t;This routine is called to set the UART on the device to match the specified&n; *&t;new settings.&n; *****************************************************************************/
DECL|function|change_port_settings
r_static
r_void
id|change_port_settings
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|baud
suffix:semicolon
r_int
id|cflag
suffix:semicolon
id|__u8
id|mask
op_assign
l_int|0xff
suffix:semicolon
id|__u8
id|lData
suffix:semicolon
id|__u8
id|lParity
suffix:semicolon
id|__u8
id|lStop
suffix:semicolon
id|__u8
id|rxFlow
suffix:semicolon
id|__u8
id|txFlow
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port %d&quot;
comma
id|edge_port-&gt;port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|edge_port-&gt;open
)paren
op_logical_and
(paren
op_logical_neg
id|edge_port-&gt;openPending
)paren
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - port not opened&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tty
op_assign
id|edge_port-&gt;port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|tty
)paren
op_logical_or
(paren
op_logical_neg
id|tty-&gt;termios
)paren
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - no tty structures&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cflag
op_assign
id|tty-&gt;termios-&gt;c_cflag
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|lData
op_assign
id|LCR_BITS_5
suffix:semicolon
id|mask
op_assign
l_int|0x1f
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - data bits = 5&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|lData
op_assign
id|LCR_BITS_6
suffix:semicolon
id|mask
op_assign
l_int|0x3f
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - data bits = 6&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|lData
op_assign
id|LCR_BITS_7
suffix:semicolon
id|mask
op_assign
l_int|0x7f
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - data bits = 7&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|CS8
suffix:colon
id|lData
op_assign
id|LCR_BITS_8
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - data bits = 8&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|lParity
op_assign
id|LCR_PAR_NONE
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
(brace
id|lParity
op_assign
id|LCR_PAR_ODD
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - parity = odd&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|lParity
op_assign
id|LCR_PAR_EVEN
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - parity = even&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - parity = none&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
(brace
id|lStop
op_assign
id|LCR_STOP_2
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - stop bits = 2&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|lStop
op_assign
id|LCR_STOP_1
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - stop bits = 1&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* figure out the flow control settings */
id|rxFlow
op_assign
id|txFlow
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|rxFlow
op_or_assign
id|IOSP_RX_FLOW_RTS
suffix:semicolon
id|txFlow
op_or_assign
id|IOSP_TX_FLOW_CTS
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - RTS/CTS is enabled&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - RTS/CTS is disabled&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* if we are implementing XON/XOFF, set the start and stop character in the device */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
op_logical_or
id|I_IXON
c_func
(paren
id|tty
)paren
)paren
(brace
r_int
r_char
id|stop_char
op_assign
id|STOP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
r_int
r_char
id|start_char
op_assign
id|START_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_SET_XON_CHAR
comma
id|start_char
)paren
suffix:semicolon
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_SET_XOFF_CHAR
comma
id|stop_char
)paren
suffix:semicolon
multiline_comment|/* if we are implementing INBOUND XON/XOFF */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
id|rxFlow
op_or_assign
id|IOSP_RX_FLOW_XON_XOFF
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - INBOUND XON/XOFF is enabled, XON = %2x, XOFF = %2x&quot;
comma
id|start_char
comma
id|stop_char
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - INBOUND XON/XOFF is disabled&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* if we are implementing OUTBOUND XON/XOFF */
r_if
c_cond
(paren
id|I_IXON
c_func
(paren
id|tty
)paren
)paren
(brace
id|txFlow
op_or_assign
id|IOSP_TX_FLOW_XON_XOFF
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - OUTBOUND XON/XOFF is enabled, XON = %2x, XOFF = %2x&quot;
comma
id|start_char
comma
id|stop_char
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - OUTBOUND XON/XOFF is disabled&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Set flow control to the configured value */
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_SET_RX_FLOW
comma
id|rxFlow
)paren
suffix:semicolon
id|send_iosp_ext_cmd
(paren
id|edge_port
comma
id|IOSP_CMD_SET_TX_FLOW
comma
id|txFlow
)paren
suffix:semicolon
id|edge_port-&gt;shadowLCR
op_and_assign
op_complement
(paren
id|LCR_BITS_MASK
op_or
id|LCR_STOP_MASK
op_or
id|LCR_PAR_MASK
)paren
suffix:semicolon
id|edge_port-&gt;shadowLCR
op_or_assign
(paren
id|lData
op_or
id|lParity
op_or
id|lStop
)paren
suffix:semicolon
id|edge_port-&gt;validDataMask
op_assign
id|mask
suffix:semicolon
multiline_comment|/* Send the updated LCR value to the EdgePort */
id|status
op_assign
id|send_cmd_write_uart_register
c_func
(paren
id|edge_port
comma
id|LCR
comma
id|edge_port-&gt;shadowLCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* set up the MCR register and send it to the EdgePort */
id|edge_port-&gt;shadowMCR
op_assign
id|MCR_MASTER_IE
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
(brace
id|edge_port-&gt;shadowMCR
op_or_assign
(paren
id|MCR_DTR
op_or
id|MCR_RTS
)paren
suffix:semicolon
)brace
id|status
op_assign
id|send_cmd_write_uart_register
c_func
(paren
id|edge_port
comma
id|MCR
comma
id|edge_port-&gt;shadowMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Determine divisor based on baud rate */
id|baud
op_assign
id|tty_get_baud_rate
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|baud
)paren
(brace
multiline_comment|/* pick a default, any default... */
id|baud
op_assign
l_int|9600
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - baud rate = %d&quot;
comma
id|baud
)paren
suffix:semicolon
id|status
op_assign
id|send_cmd_write_baud_rate
(paren
id|edge_port
comma
id|baud
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * unicode_to_ascii&n; *&t;Turns a string from Unicode into ASCII.&n; *&t;Doesn&squot;t do a good job with any characters that are outside the normal&n; *&t;ASCII range, but it&squot;s only for debugging...&n; ****************************************************************************/
DECL|function|unicode_to_ascii
r_static
r_void
id|unicode_to_ascii
(paren
r_char
op_star
id|string
comma
r_int
op_star
id|unicode
comma
r_int
id|unicode_size
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|unicode_size
suffix:semicolon
op_increment
id|i
)paren
(brace
id|string
(braket
id|i
)braket
op_assign
(paren
r_char
)paren
(paren
id|unicode
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|string
(braket
id|unicode_size
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * get_manufacturing_desc&n; *&t;reads in the manufacturing descriptor and stores it into the serial &n; *&t;structure.&n; ****************************************************************************/
DECL|function|get_manufacturing_desc
r_static
r_void
id|get_manufacturing_desc
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
)paren
(brace
r_int
id|response
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;getting manufacturer descriptor&quot;
)paren
suffix:semicolon
id|response
op_assign
id|rom_read
(paren
id|edge_serial-&gt;serial
comma
(paren
id|EDGE_MANUF_DESC_ADDR
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|16
comma
(paren
id|__u16
)paren
(paren
id|EDGE_MANUF_DESC_ADDR
op_amp
l_int|0x0000ffff
)paren
comma
id|EDGE_MANUF_DESC_LEN
comma
(paren
id|__u8
op_star
)paren
(paren
op_amp
id|edge_serial-&gt;manuf_descriptor
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;error in getting manufacturer descriptor&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_char
id|string
(braket
l_int|30
)braket
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;**Manufacturer Descriptor&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  RomSize:        %dK&quot;
comma
id|edge_serial-&gt;manuf_descriptor.RomSize
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  RamSize:        %dK&quot;
comma
id|edge_serial-&gt;manuf_descriptor.RamSize
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  CpuRev:         %d&quot;
comma
id|edge_serial-&gt;manuf_descriptor.CpuRev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  BoardRev:       %d&quot;
comma
id|edge_serial-&gt;manuf_descriptor.BoardRev
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  NumPorts:       %d&quot;
comma
id|edge_serial-&gt;manuf_descriptor.NumPorts
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  DescDate:       %d/%d/%d&quot;
comma
id|edge_serial-&gt;manuf_descriptor.DescDate
(braket
l_int|0
)braket
comma
id|edge_serial-&gt;manuf_descriptor.DescDate
(braket
l_int|1
)braket
comma
id|edge_serial-&gt;manuf_descriptor.DescDate
(braket
l_int|2
)braket
op_plus
l_int|1900
)paren
suffix:semicolon
id|unicode_to_ascii
(paren
id|string
comma
id|edge_serial-&gt;manuf_descriptor.SerialNumber
comma
id|edge_serial-&gt;manuf_descriptor.SerNumLength
op_div
l_int|2
op_minus
l_int|1
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  SerialNumber: %s&quot;
comma
id|string
)paren
suffix:semicolon
id|unicode_to_ascii
(paren
id|string
comma
id|edge_serial-&gt;manuf_descriptor.AssemblyNumber
comma
id|edge_serial-&gt;manuf_descriptor.AssemblyNumLength
op_div
l_int|2
op_minus
l_int|1
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  AssemblyNumber: %s&quot;
comma
id|string
)paren
suffix:semicolon
id|unicode_to_ascii
(paren
id|string
comma
id|edge_serial-&gt;manuf_descriptor.OemAssyNumber
comma
id|edge_serial-&gt;manuf_descriptor.OemAssyNumLength
op_div
l_int|2
op_minus
l_int|1
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  OemAssyNumber:  %s&quot;
comma
id|string
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  UartType:       %d&quot;
comma
id|edge_serial-&gt;manuf_descriptor.UartType
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  IonPid:         %d&quot;
comma
id|edge_serial-&gt;manuf_descriptor.IonPid
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  IonConfig:      %d&quot;
comma
id|edge_serial-&gt;manuf_descriptor.IonConfig
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************&n; * get_boot_desc&n; *&t;reads in the bootloader descriptor and stores it into the serial &n; *&t;structure.&n; ****************************************************************************/
DECL|function|get_boot_desc
r_static
r_void
id|get_boot_desc
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
)paren
(brace
r_int
id|response
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;getting boot descriptor&quot;
)paren
suffix:semicolon
id|response
op_assign
id|rom_read
(paren
id|edge_serial-&gt;serial
comma
(paren
id|EDGE_BOOT_DESC_ADDR
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|16
comma
(paren
id|__u16
)paren
(paren
id|EDGE_BOOT_DESC_ADDR
op_amp
l_int|0x0000ffff
)paren
comma
id|EDGE_BOOT_DESC_LEN
comma
(paren
id|__u8
op_star
)paren
(paren
op_amp
id|edge_serial-&gt;boot_descriptor
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;error in getting boot descriptor&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;**Boot Descriptor:&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  BootCodeLength: %d&quot;
comma
id|edge_serial-&gt;boot_descriptor.BootCodeLength
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  MajorVersion:   %d&quot;
comma
id|edge_serial-&gt;boot_descriptor.MajorVersion
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  MinorVersion:   %d&quot;
comma
id|edge_serial-&gt;boot_descriptor.MinorVersion
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  BuildNumber:    %d&quot;
comma
id|edge_serial-&gt;boot_descriptor.BuildNumber
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  Capabilities:   0x%x&quot;
comma
id|edge_serial-&gt;boot_descriptor.Capabilities
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  UConfig0:       %d&quot;
comma
id|edge_serial-&gt;boot_descriptor.UConfig0
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;  UConfig1:       %d&quot;
comma
id|edge_serial-&gt;boot_descriptor.UConfig1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************&n; * load_application_firmware&n; *&t;This is called to load the application firmware to the device&n; ****************************************************************************/
DECL|function|load_application_firmware
r_static
r_void
id|load_application_firmware
(paren
r_struct
id|edgeport_serial
op_star
id|edge_serial
)paren
(brace
r_struct
id|edge_firmware_image_record
op_star
id|record
suffix:semicolon
r_int
r_char
op_star
id|firmware
suffix:semicolon
r_int
r_char
op_star
id|FirmwareImage
suffix:semicolon
r_int
id|ImageSize
suffix:semicolon
r_int
id|response
suffix:semicolon
r_switch
c_cond
(paren
id|edge_serial-&gt;product_info.iDownloadFile
)paren
(brace
r_case
id|EDGE_DOWNLOAD_FILE_I930
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;downloading firmware version (930) %d.%d.%d&quot;
comma
id|OperationalCodeImageVersion_GEN1.MajorVersion
comma
id|OperationalCodeImageVersion_GEN1.MinorVersion
comma
id|OperationalCodeImageVersion_GEN1.BuildNumber
)paren
suffix:semicolon
id|firmware
op_assign
op_amp
id|OperationalCodeImage_GEN1
(braket
l_int|0
)braket
suffix:semicolon
id|FirmwareImage
op_assign
op_amp
id|OperationalCodeImage_GEN1
(braket
l_int|0
)braket
suffix:semicolon
id|ImageSize
op_assign
r_sizeof
(paren
id|OperationalCodeImage_GEN1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EDGE_DOWNLOAD_FILE_80251
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;downloading firmware version (80251) %d.%d.%d&quot;
comma
id|OperationalCodeImageVersion_GEN2.MajorVersion
comma
id|OperationalCodeImageVersion_GEN2.MinorVersion
comma
id|OperationalCodeImageVersion_GEN2.BuildNumber
)paren
suffix:semicolon
id|firmware
op_assign
op_amp
id|OperationalCodeImage_GEN2
(braket
l_int|0
)braket
suffix:semicolon
id|FirmwareImage
op_assign
op_amp
id|OperationalCodeImage_GEN2
(braket
l_int|0
)braket
suffix:semicolon
id|ImageSize
op_assign
r_sizeof
(paren
id|OperationalCodeImage_GEN2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EDGE_DOWNLOAD_FILE_NONE
suffix:colon
id|dbg
(paren
l_string|&quot;No download file specified, skipping download&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|record
op_assign
(paren
r_struct
id|edge_firmware_image_record
op_star
)paren
id|firmware
suffix:semicolon
id|response
op_assign
id|sram_write
(paren
id|edge_serial-&gt;serial
comma
id|record-&gt;ExtAddr
comma
id|record-&gt;Addr
comma
id|record-&gt;Len
comma
op_amp
id|record-&gt;Data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;sram_write failed (%x, %x, %d)&quot;
comma
id|record-&gt;ExtAddr
comma
id|record-&gt;Addr
comma
id|record-&gt;Len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|firmware
op_add_assign
r_sizeof
(paren
r_struct
id|edge_firmware_image_record
)paren
op_plus
id|record-&gt;Len
suffix:semicolon
r_if
c_cond
(paren
id|firmware
op_ge
op_amp
id|FirmwareImage
(braket
id|ImageSize
)braket
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;sending exec_dl_code&quot;
)paren
suffix:semicolon
id|response
op_assign
id|usb_control_msg
(paren
id|edge_serial-&gt;serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|edge_serial-&gt;serial-&gt;dev
comma
l_int|0
)paren
comma
id|USB_REQUEST_ION_EXEC_DL_CODE
comma
l_int|0x40
comma
l_int|0x4000
comma
l_int|0x0001
comma
l_int|NULL
comma
l_int|0
comma
l_int|3000
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * edge_startup&n; ****************************************************************************/
DECL|function|edge_startup
r_static
r_int
id|edge_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|edgeport_serial
op_star
id|edge_serial
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev
op_assign
id|serial-&gt;dev
suffix:semicolon
multiline_comment|/* create our private serial structure */
id|edge_serial
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|edgeport_serial
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_serial
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Out of memory&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|edge_serial
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|edgeport_serial
)paren
)paren
suffix:semicolon
id|edge_serial-&gt;serial
op_assign
id|serial
suffix:semicolon
id|serial
op_member_access_from_pointer
r_private
op_assign
id|edge_serial
suffix:semicolon
multiline_comment|/* get the name for the device from the device */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|get_string
c_func
(paren
id|dev
comma
id|dev-&gt;descriptor.iManufacturer
comma
op_amp
id|edge_serial-&gt;name
(braket
l_int|0
)braket
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|edge_serial-&gt;name
(braket
id|i
op_minus
l_int|1
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
id|get_string
c_func
(paren
id|dev
comma
id|dev-&gt;descriptor.iProduct
comma
op_amp
id|edge_serial-&gt;name
(braket
id|i
)braket
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;%s detected&quot;
comma
id|edge_serial-&gt;name
)paren
suffix:semicolon
multiline_comment|/* get the manufacturing descriptor for this device */
id|get_manufacturing_desc
(paren
id|edge_serial
)paren
suffix:semicolon
multiline_comment|/* get the boot descriptor */
id|get_boot_desc
(paren
id|edge_serial
)paren
suffix:semicolon
id|get_product_info
c_func
(paren
id|edge_serial
)paren
suffix:semicolon
multiline_comment|/* set the number of ports from the manufacturing description */
multiline_comment|/* serial-&gt;num_ports = serial-&gt;product_info.NumPorts; */
r_if
c_cond
(paren
id|edge_serial-&gt;product_info.NumPorts
op_ne
id|serial-&gt;num_ports
)paren
(brace
id|warn
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Device Reported %d serial ports vs core &quot;
l_string|&quot;thinking we have %d ports, email greg@kroah.com this info.&quot;
comma
id|edge_serial-&gt;product_info.NumPorts
comma
id|serial-&gt;num_ports
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - time 1 %ld&quot;
comma
id|jiffies
)paren
suffix:semicolon
multiline_comment|/* now load the application firmware into this device */
id|load_application_firmware
(paren
id|edge_serial
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - time 2 %ld&quot;
comma
id|jiffies
)paren
suffix:semicolon
multiline_comment|/* Check current Edgeport EEPROM and update if necessary */
id|update_edgeport_E2PROM
(paren
id|edge_serial
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; - time 3 %ld&quot;
comma
id|jiffies
)paren
suffix:semicolon
multiline_comment|/* set the configuration to use #1 */
singleline_comment|//&t;dbg(&quot;set_configuration 1&quot;);
singleline_comment|//&t;usb_set_configuration (dev, 1);
multiline_comment|/* we set up the pointers to the endpoints in the edge_open function, &n;&t; * as the structures aren&squot;t created yet. */
multiline_comment|/* set up our port private structures */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|edge_port
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|edgeport_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - Out of memory&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|edge_port
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|edgeport_port
)paren
)paren
suffix:semicolon
id|edge_port-&gt;port
op_assign
op_amp
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|serial-&gt;port
(braket
id|i
)braket
dot
r_private
op_assign
id|edge_port
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * edge_shutdown&n; *&t;This function is called whenever the device is removed from the usb bus.&n; ****************************************************************************/
DECL|function|edge_shutdown
r_static
r_void
id|edge_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
suffix:semicolon
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* stop reads and writes on all ports */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|kfree
(paren
id|serial-&gt;port
(braket
id|i
)braket
dot
r_private
)paren
suffix:semicolon
id|serial-&gt;port
(braket
id|i
)braket
dot
r_private
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|serial
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * edgeport_init&n; *&t;This is called by the module subsystem, or on startup to initialize us&n; ****************************************************************************/
DECL|function|edgeport_init
r_int
id|__init
id|edgeport_init
c_func
(paren
r_void
)paren
(brace
id|usb_serial_register
(paren
op_amp
id|edgeport_1port_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|edgeport_2port_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|edgeport_4port_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|edgeport_8port_device
)paren
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * edgeport_exit&n; *&t;Called when the driver is about to be unloaded.&n; ****************************************************************************/
DECL|function|edgeport_exit
r_void
id|__exit
id|edgeport_exit
(paren
r_void
)paren
(brace
id|usb_serial_deregister
(paren
op_amp
id|edgeport_1port_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|edgeport_2port_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|edgeport_4port_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|edgeport_8port_device
)paren
suffix:semicolon
)brace
DECL|variable|edgeport_init
id|module_init
c_func
(paren
id|edgeport_init
)paren
suffix:semicolon
DECL|variable|edgeport_exit
id|module_exit
c_func
(paren
id|edgeport_exit
)paren
suffix:semicolon
multiline_comment|/* Module information */
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug enabled or not&quot;
)paren
suffix:semicolon
eof
