multiline_comment|/* vi: ts=8 sw=8&n; *&n; * TI 3410/5052 USB Serial Driver&n; *&n; * Copyright (C) 2004 Texas Instruments&n; *&n; * This driver is based on the Linux io_ti driver, which is&n; *   Copyright (C) 2000-2002 Inside Out Networks&n; *   Copyright (C) 2001-2002 Greg Kroah-Hartman&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * For questions or problems with this driver, contact Texas Instruments&n; * technical support, or Al Borchers &lt;alborchers@steinerpoint.com&gt;, or&n; * Peter Berger &lt;pberger@brimson.com&gt;.&n; * &n; * This driver needs this hotplug script in /etc/hotplug/usb/ti_usb_3410_5052&n; * or in /etc/hotplug.d/usb/ti_usb_3410_5052.hotplug to set the device&n; * configuration.&n; *&n; * #!/bin/bash&n; *&n; * BOOT_CONFIG=1&n; * ACTIVE_CONFIG=2&n; *&n; * if [[ &quot;$ACTION&quot; != &quot;add&quot; ]]&n; * then&n; * &t;exit&n; * fi&n; *&n; * CONFIG_PATH=/sys${DEVPATH%/?*}/bConfigurationValue&n; *&n; * if [[ 0`cat $CONFIG_PATH` -ne $BOOT_CONFIG ]]&n; * then&n; * &t;exit&n; * fi&n; *&n; * PRODUCT=${PRODUCT%/?*}&t;&t;# delete version&n; * VENDOR_ID=`printf &quot;%d&quot; 0x${PRODUCT%/?*}`&n; * PRODUCT_ID=`printf &quot;%d&quot; 0x${PRODUCT#*?/}`&n; *&n; * PARAM_PATH=/sys/module/ti_usb_3410_5052/parameters&n; *&n; * function scan() {&n; * &t;s=$1&n; * &t;shift&n; * &t;for i&n; * &t;do&n; * &t;&t;if [[ $s -eq $i ]]&n; * &t;&t;then&n; * &t;&t;&t;return 0&n; * &t;&t;fi&n; * &t;done&n; * &t;return 1&n; * }&n; *&n; * IFS=$IFS,&n; *&n; * if (scan $VENDOR_ID 1105 `cat $PARAM_PATH/vendor_3410` &amp;&amp;&n; * scan $PRODUCT_ID 13328 `cat $PARAM_PATH/product_3410`) ||&n; * (scan $VENDOR_ID 1105 `cat $PARAM_PATH/vendor_5052` &amp;&amp;&n; * scan $PRODUCT_ID 20562 20818 20570 20575 `cat $PARAM_PATH/product_5052`)&n; * then&n; * &t;echo $ACTIVE_CONFIG &gt; $CONFIG_PATH&n; * fi&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/circ_buf.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;ti_usb_3410_5052.h&quot;
macro_line|#include &quot;ti_fw_3410.h&quot;&t;&t;/* firmware image for 3410 */
macro_line|#include &quot;ti_fw_5052.h&quot;&t;&t;/* firmware image for 5052 */
multiline_comment|/* Defines */
DECL|macro|TI_DRIVER_VERSION
mdefine_line|#define TI_DRIVER_VERSION&t;&quot;v0.9&quot;
DECL|macro|TI_DRIVER_AUTHOR
mdefine_line|#define TI_DRIVER_AUTHOR&t;&quot;Al Borchers &lt;alborchers@steinerpoint.com&gt;&quot;
DECL|macro|TI_DRIVER_DESC
mdefine_line|#define TI_DRIVER_DESC&t;&t;&quot;TI USB 3410/5052 Serial Driver&quot;
DECL|macro|TI_FIRMWARE_BUF_SIZE
mdefine_line|#define TI_FIRMWARE_BUF_SIZE&t;16284
DECL|macro|TI_WRITE_BUF_SIZE
mdefine_line|#define TI_WRITE_BUF_SIZE&t;1024
DECL|macro|TI_TRANSFER_TIMEOUT
mdefine_line|#define TI_TRANSFER_TIMEOUT&t;2
DECL|macro|TI_DEFAULT_LOW_LATENCY
mdefine_line|#define TI_DEFAULT_LOW_LATENCY&t;0
DECL|macro|TI_DEFAULT_CLOSING_WAIT
mdefine_line|#define TI_DEFAULT_CLOSING_WAIT&t;4000&t;&t;/* in .01 secs */
multiline_comment|/* supported setserial flags */
DECL|macro|TI_SET_SERIAL_FLAGS
mdefine_line|#define TI_SET_SERIAL_FLAGS&t;(ASYNC_LOW_LATENCY)
multiline_comment|/* read urb states */
DECL|macro|TI_READ_URB_RUNNING
mdefine_line|#define TI_READ_URB_RUNNING&t;0
DECL|macro|TI_READ_URB_STOPPING
mdefine_line|#define TI_READ_URB_STOPPING&t;1
DECL|macro|TI_READ_URB_STOPPED
mdefine_line|#define TI_READ_URB_STOPPED&t;2
DECL|macro|TI_EXTRA_VID_PID_COUNT
mdefine_line|#define TI_EXTRA_VID_PID_COUNT&t;5
multiline_comment|/* Structures */
DECL|struct|ti_port
r_struct
id|ti_port
(brace
DECL|member|tp_is_open
r_int
id|tp_is_open
suffix:semicolon
DECL|member|tp_msr
id|__u8
id|tp_msr
suffix:semicolon
DECL|member|tp_lsr
id|__u8
id|tp_lsr
suffix:semicolon
DECL|member|tp_shadow_mcr
id|__u8
id|tp_shadow_mcr
suffix:semicolon
DECL|member|tp_uart_mode
id|__u8
id|tp_uart_mode
suffix:semicolon
multiline_comment|/* 232 or 485 modes */
DECL|member|tp_uart_base_addr
r_int
r_int
id|tp_uart_base_addr
suffix:semicolon
DECL|member|tp_flags
r_int
id|tp_flags
suffix:semicolon
DECL|member|tp_closing_wait
r_int
id|tp_closing_wait
suffix:semicolon
multiline_comment|/* in .01 secs */
DECL|member|tp_icount
r_struct
id|async_icount
id|tp_icount
suffix:semicolon
DECL|member|tp_msr_wait
id|wait_queue_head_t
id|tp_msr_wait
suffix:semicolon
multiline_comment|/* wait for msr change */
DECL|member|tp_write_wait
id|wait_queue_head_t
id|tp_write_wait
suffix:semicolon
DECL|member|tp_tdev
r_struct
id|ti_device
op_star
id|tp_tdev
suffix:semicolon
DECL|member|tp_port
r_struct
id|usb_serial_port
op_star
id|tp_port
suffix:semicolon
DECL|member|tp_lock
id|spinlock_t
id|tp_lock
suffix:semicolon
DECL|member|tp_read_urb_state
r_int
id|tp_read_urb_state
suffix:semicolon
DECL|member|tp_write_urb_in_use
r_int
id|tp_write_urb_in_use
suffix:semicolon
DECL|member|tp_write_buf
r_struct
id|circ_buf
op_star
id|tp_write_buf
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ti_device
r_struct
id|ti_device
(brace
DECL|member|td_open_close_sem
r_struct
id|semaphore
id|td_open_close_sem
suffix:semicolon
DECL|member|td_open_port_count
r_int
id|td_open_port_count
suffix:semicolon
DECL|member|td_serial
r_struct
id|usb_serial
op_star
id|td_serial
suffix:semicolon
DECL|member|td_is_3410
r_int
id|td_is_3410
suffix:semicolon
DECL|member|td_urb_error
r_int
id|td_urb_error
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Function Declarations */
r_static
r_int
id|ti_startup
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|ti_shutdown
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_int
id|ti_open
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_void
id|ti_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|ti_write
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|ti_write_room
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|ti_chars_in_buffer
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ti_throttle
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|ti_unthrottle
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|ti_ioctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|ti_set_termios
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
suffix:semicolon
r_static
r_int
id|ti_tiocmget
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|ti_tiocmset
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
suffix:semicolon
r_static
r_void
id|ti_break
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
suffix:semicolon
r_static
r_void
id|ti_interrupt_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ti_bulk_in_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ti_bulk_out_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ti_recv
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
op_star
id|data
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_void
id|ti_send
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
)paren
suffix:semicolon
r_static
r_int
id|ti_set_mcr
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_int
r_int
id|mcr
)paren
suffix:semicolon
r_static
r_int
id|ti_get_lsr
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
)paren
suffix:semicolon
r_static
r_int
id|ti_get_serial_info
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_struct
id|serial_struct
id|__user
op_star
id|ret_arg
)paren
suffix:semicolon
r_static
r_int
id|ti_set_serial_info
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_struct
id|serial_struct
id|__user
op_star
id|new_arg
)paren
suffix:semicolon
r_static
r_void
id|ti_handle_new_msr
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
id|__u8
id|msr
)paren
suffix:semicolon
r_static
r_void
id|ti_drain
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_int
r_int
id|timeout
comma
r_int
id|flush
)paren
suffix:semicolon
r_static
r_void
id|ti_stop_read
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|ti_restart_read
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|ti_command_out_sync
c_func
(paren
r_struct
id|ti_device
op_star
id|tdev
comma
id|__u8
id|command
comma
id|__u16
id|moduleid
comma
id|__u16
id|value
comma
id|__u8
op_star
id|data
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|ti_command_in_sync
c_func
(paren
r_struct
id|ti_device
op_star
id|tdev
comma
id|__u8
id|command
comma
id|__u16
id|moduleid
comma
id|__u16
id|value
comma
id|__u8
op_star
id|data
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|ti_write_byte
c_func
(paren
r_struct
id|ti_device
op_star
id|tdev
comma
r_int
r_int
id|addr
comma
id|__u8
id|mask
comma
id|__u8
id|byte
)paren
suffix:semicolon
r_static
r_int
id|ti_download_firmware
c_func
(paren
r_struct
id|ti_device
op_star
id|tdev
comma
r_int
r_char
op_star
id|firmware
comma
r_int
r_int
id|firmware_size
)paren
suffix:semicolon
multiline_comment|/* circular buffer */
r_static
r_struct
id|circ_buf
op_star
id|ti_buf_alloc
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ti_buf_free
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
)paren
suffix:semicolon
r_static
r_void
id|ti_buf_clear
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
)paren
suffix:semicolon
r_static
r_int
id|ti_buf_data_avail
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
)paren
suffix:semicolon
r_static
r_int
id|ti_buf_space_avail
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
)paren
suffix:semicolon
r_static
r_int
id|ti_buf_put
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|ti_buf_get
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
multiline_comment|/* Data */
multiline_comment|/* module parameters */
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|variable|low_latency
r_static
r_int
id|low_latency
op_assign
id|TI_DEFAULT_LOW_LATENCY
suffix:semicolon
DECL|variable|closing_wait
r_static
r_int
id|closing_wait
op_assign
id|TI_DEFAULT_CLOSING_WAIT
suffix:semicolon
DECL|variable|vendor_3410
r_static
id|ushort
id|vendor_3410
(braket
id|TI_EXTRA_VID_PID_COUNT
)braket
suffix:semicolon
DECL|variable|vendor_3410_count
r_static
r_int
id|vendor_3410_count
suffix:semicolon
DECL|variable|product_3410
r_static
id|ushort
id|product_3410
(braket
id|TI_EXTRA_VID_PID_COUNT
)braket
suffix:semicolon
DECL|variable|product_3410_count
r_static
r_int
id|product_3410_count
suffix:semicolon
DECL|variable|vendor_5052
r_static
id|ushort
id|vendor_5052
(braket
id|TI_EXTRA_VID_PID_COUNT
)braket
suffix:semicolon
DECL|variable|vendor_5052_count
r_static
r_int
id|vendor_5052_count
suffix:semicolon
DECL|variable|product_5052
r_static
id|ushort
id|product_5052
(braket
id|TI_EXTRA_VID_PID_COUNT
)braket
suffix:semicolon
DECL|variable|product_5052_count
r_static
r_int
id|product_5052_count
suffix:semicolon
multiline_comment|/* supported devices */
multiline_comment|/* the array dimension is the number of default entries plus */
multiline_comment|/* TI_EXTRA_VID_PID_COUNT user defined entries plus 1 terminating */
multiline_comment|/* null entry */
DECL|variable|ti_id_table_3410
r_static
r_struct
id|usb_device_id
id|ti_id_table_3410
(braket
l_int|1
op_plus
id|TI_EXTRA_VID_PID_COUNT
op_plus
l_int|1
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_3410_PRODUCT_ID
)paren
)brace
comma
)brace
suffix:semicolon
DECL|variable|ti_id_table_5052
r_static
r_struct
id|usb_device_id
id|ti_id_table_5052
(braket
l_int|4
op_plus
id|TI_EXTRA_VID_PID_COUNT
op_plus
l_int|1
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_5052_BOOT_PRODUCT_ID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_5152_BOOT_PRODUCT_ID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_5052_EEPROM_PRODUCT_ID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_5052_FIRMWARE_PRODUCT_ID
)paren
)brace
comma
)brace
suffix:semicolon
DECL|variable|ti_id_table_combined
r_static
r_struct
id|usb_device_id
id|ti_id_table_combined
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_3410_PRODUCT_ID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_5052_BOOT_PRODUCT_ID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_5152_BOOT_PRODUCT_ID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_5052_EEPROM_PRODUCT_ID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|TI_VENDOR_ID
comma
id|TI_5052_FIRMWARE_PRODUCT_ID
)paren
)brace
comma
(brace
)brace
)brace
suffix:semicolon
DECL|variable|ti_usb_driver
r_static
r_struct
id|usb_driver
id|ti_usb_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;ti_usb_3410_5052&quot;
comma
dot
id|probe
op_assign
id|usb_serial_probe
comma
dot
id|disconnect
op_assign
id|usb_serial_disconnect
comma
dot
id|id_table
op_assign
id|ti_id_table_combined
comma
)brace
suffix:semicolon
DECL|variable|ti_1port_device
r_static
r_struct
id|usb_serial_device_type
id|ti_1port_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;TI USB 3410 1 port adapter&quot;
comma
dot
id|id_table
op_assign
id|ti_id_table_3410
comma
dot
id|num_interrupt_in
op_assign
l_int|1
comma
dot
id|num_bulk_in
op_assign
l_int|1
comma
dot
id|num_bulk_out
op_assign
l_int|1
comma
dot
id|num_ports
op_assign
l_int|1
comma
dot
id|attach
op_assign
id|ti_startup
comma
dot
id|shutdown
op_assign
id|ti_shutdown
comma
dot
id|open
op_assign
id|ti_open
comma
dot
id|close
op_assign
id|ti_close
comma
dot
id|write
op_assign
id|ti_write
comma
dot
id|write_room
op_assign
id|ti_write_room
comma
dot
id|chars_in_buffer
op_assign
id|ti_chars_in_buffer
comma
dot
id|throttle
op_assign
id|ti_throttle
comma
dot
id|unthrottle
op_assign
id|ti_unthrottle
comma
dot
id|ioctl
op_assign
id|ti_ioctl
comma
dot
id|set_termios
op_assign
id|ti_set_termios
comma
dot
id|tiocmget
op_assign
id|ti_tiocmget
comma
dot
id|tiocmset
op_assign
id|ti_tiocmset
comma
dot
id|break_ctl
op_assign
id|ti_break
comma
dot
id|read_int_callback
op_assign
id|ti_interrupt_callback
comma
dot
id|read_bulk_callback
op_assign
id|ti_bulk_in_callback
comma
dot
id|write_bulk_callback
op_assign
id|ti_bulk_out_callback
comma
)brace
suffix:semicolon
DECL|variable|ti_2port_device
r_static
r_struct
id|usb_serial_device_type
id|ti_2port_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;TI USB 5052 2 port adapter&quot;
comma
dot
id|id_table
op_assign
id|ti_id_table_5052
comma
dot
id|num_interrupt_in
op_assign
l_int|1
comma
dot
id|num_bulk_in
op_assign
l_int|2
comma
dot
id|num_bulk_out
op_assign
l_int|2
comma
dot
id|num_ports
op_assign
l_int|2
comma
dot
id|attach
op_assign
id|ti_startup
comma
dot
id|shutdown
op_assign
id|ti_shutdown
comma
dot
id|open
op_assign
id|ti_open
comma
dot
id|close
op_assign
id|ti_close
comma
dot
id|write
op_assign
id|ti_write
comma
dot
id|write_room
op_assign
id|ti_write_room
comma
dot
id|chars_in_buffer
op_assign
id|ti_chars_in_buffer
comma
dot
id|throttle
op_assign
id|ti_throttle
comma
dot
id|unthrottle
op_assign
id|ti_unthrottle
comma
dot
id|ioctl
op_assign
id|ti_ioctl
comma
dot
id|set_termios
op_assign
id|ti_set_termios
comma
dot
id|tiocmget
op_assign
id|ti_tiocmget
comma
dot
id|tiocmset
op_assign
id|ti_tiocmset
comma
dot
id|break_ctl
op_assign
id|ti_break
comma
dot
id|read_int_callback
op_assign
id|ti_interrupt_callback
comma
dot
id|read_bulk_callback
op_assign
id|ti_bulk_in_callback
comma
dot
id|write_bulk_callback
op_assign
id|ti_bulk_out_callback
comma
)brace
suffix:semicolon
multiline_comment|/* Module */
DECL|variable|TI_DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|TI_DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|TI_DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|TI_DRIVER_DESC
)paren
suffix:semicolon
DECL|variable|TI_DRIVER_VERSION
id|MODULE_VERSION
c_func
(paren
id|TI_DRIVER_VERSION
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_bool
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Enable debugging, 0=no, 1=yes&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|low_latency
comma
r_bool
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|low_latency
comma
l_string|&quot;TTY low_latency flag, 0=off, 1=on, default is off&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|closing_wait
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|closing_wait
comma
l_string|&quot;Maximum wait for data to drain in close, in .01 secs, default is 4000&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|vendor_3410
comma
id|ushort
comma
op_amp
id|vendor_3410_count
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|vendor_3410
comma
l_string|&quot;Vendor ids for 3410 based devices, 1-5 short integers&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|product_3410
comma
id|ushort
comma
op_amp
id|product_3410_count
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|product_3410
comma
l_string|&quot;Product ids for 3410 based devices, 1-5 short integers&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|vendor_5052
comma
id|ushort
comma
op_amp
id|vendor_5052_count
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|vendor_5052
comma
l_string|&quot;Vendor ids for 5052 based devices, 1-5 short integers&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|product_5052
comma
id|ushort
comma
op_amp
id|product_5052_count
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|product_5052
comma
l_string|&quot;Product ids for 5052 based devices, 1-5 short integers&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|usb
comma
id|ti_id_table_combined
)paren
suffix:semicolon
multiline_comment|/* Functions */
DECL|function|ti_init
r_static
r_int
id|__init
id|ti_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* insert extra vendor and product ids */
id|j
op_assign
r_sizeof
(paren
id|ti_id_table_3410
)paren
op_div
r_sizeof
(paren
r_struct
id|usb_device_id
)paren
op_minus
id|TI_EXTRA_VID_PID_COUNT
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|min
c_func
(paren
id|vendor_3410_count
comma
id|product_3410_count
)paren
suffix:semicolon
id|i
op_increment
comma
id|j
op_increment
)paren
(brace
id|ti_id_table_3410
(braket
id|j
)braket
dot
id|idVendor
op_assign
id|vendor_3410
(braket
id|i
)braket
suffix:semicolon
id|ti_id_table_3410
(braket
id|j
)braket
dot
id|idProduct
op_assign
id|product_3410
(braket
id|i
)braket
suffix:semicolon
id|ti_id_table_3410
(braket
id|j
)braket
dot
id|match_flags
op_assign
id|USB_DEVICE_ID_MATCH_DEVICE
suffix:semicolon
)brace
id|j
op_assign
r_sizeof
(paren
id|ti_id_table_5052
)paren
op_div
r_sizeof
(paren
r_struct
id|usb_device_id
)paren
op_minus
id|TI_EXTRA_VID_PID_COUNT
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|min
c_func
(paren
id|vendor_5052_count
comma
id|product_5052_count
)paren
suffix:semicolon
id|i
op_increment
comma
id|j
op_increment
)paren
(brace
id|ti_id_table_5052
(braket
id|j
)braket
dot
id|idVendor
op_assign
id|vendor_5052
(braket
id|i
)braket
suffix:semicolon
id|ti_id_table_5052
(braket
id|j
)braket
dot
id|idProduct
op_assign
id|product_5052
(braket
id|i
)braket
suffix:semicolon
id|ti_id_table_5052
(braket
id|j
)braket
dot
id|match_flags
op_assign
id|USB_DEVICE_ID_MATCH_DEVICE
suffix:semicolon
)brace
id|ret
op_assign
id|usb_serial_register
c_func
(paren
op_amp
id|ti_1port_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|failed_1port
suffix:semicolon
id|ret
op_assign
id|usb_serial_register
c_func
(paren
op_amp
id|ti_2port_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|failed_2port
suffix:semicolon
id|ret
op_assign
id|usb_register
c_func
(paren
op_amp
id|ti_usb_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|failed_usb
suffix:semicolon
id|info
c_func
(paren
id|TI_DRIVER_DESC
l_string|&quot; &quot;
id|TI_DRIVER_VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed_usb
suffix:colon
id|usb_serial_deregister
c_func
(paren
op_amp
id|ti_2port_device
)paren
suffix:semicolon
id|failed_2port
suffix:colon
id|usb_serial_deregister
c_func
(paren
op_amp
id|ti_1port_device
)paren
suffix:semicolon
id|failed_1port
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ti_exit
r_static
r_void
id|__exit
id|ti_exit
c_func
(paren
r_void
)paren
(brace
id|usb_serial_deregister
c_func
(paren
op_amp
id|ti_1port_device
)paren
suffix:semicolon
id|usb_serial_deregister
c_func
(paren
op_amp
id|ti_2port_device
)paren
suffix:semicolon
id|usb_deregister
c_func
(paren
op_amp
id|ti_usb_driver
)paren
suffix:semicolon
)brace
DECL|variable|ti_init
id|module_init
c_func
(paren
id|ti_init
)paren
suffix:semicolon
DECL|variable|ti_exit
id|module_exit
c_func
(paren
id|ti_exit
)paren
suffix:semicolon
DECL|function|ti_startup
r_static
r_int
id|ti_startup
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|ti_device
op_star
id|tdev
suffix:semicolon
r_struct
id|ti_port
op_star
id|tport
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - product 0x%4X, num configurations %d, configuration value %d&quot;
comma
id|__FUNCTION__
comma
id|le16_to_cpu
c_func
(paren
id|dev-&gt;descriptor.idProduct
)paren
comma
id|dev-&gt;descriptor.bNumConfigurations
comma
id|dev-&gt;actconfig-&gt;desc.bConfigurationValue
)paren
suffix:semicolon
multiline_comment|/* create device structure */
id|tdev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ti_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tdev
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tdev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ti_device
)paren
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|tdev-&gt;td_open_close_sem
comma
l_int|1
)paren
suffix:semicolon
id|tdev-&gt;td_serial
op_assign
id|serial
suffix:semicolon
id|usb_set_serial_data
c_func
(paren
id|serial
comma
id|tdev
)paren
suffix:semicolon
multiline_comment|/* determine device type */
r_if
c_cond
(paren
id|usb_match_id
c_func
(paren
id|serial-&gt;interface
comma
id|ti_id_table_3410
)paren
)paren
id|tdev-&gt;td_is_3410
op_assign
l_int|1
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - device type is %s&quot;
comma
id|__FUNCTION__
comma
id|tdev-&gt;td_is_3410
ques
c_cond
l_string|&quot;3410&quot;
suffix:colon
l_string|&quot;5052&quot;
)paren
suffix:semicolon
multiline_comment|/* if we have only 1 configuration, download firmware */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|tdev-&gt;td_is_3410
)paren
id|status
op_assign
id|ti_download_firmware
c_func
(paren
id|tdev
comma
id|ti_fw_3410
comma
r_sizeof
(paren
id|ti_fw_3410
)paren
)paren
suffix:semicolon
r_else
id|status
op_assign
id|ti_download_firmware
c_func
(paren
id|tdev
comma
id|ti_fw_5052
comma
r_sizeof
(paren
id|ti_fw_5052
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|free_tdev
suffix:semicolon
multiline_comment|/* 3410 must be reset, 5052 resets itself */
r_if
c_cond
(paren
id|tdev-&gt;td_is_3410
)paren
(brace
id|msleep_interruptible
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|usb_reset_device
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_tdev
suffix:semicolon
)brace
multiline_comment|/* the second configuration must be set (in sysfs by hotplug script) */
r_if
c_cond
(paren
id|dev-&gt;actconfig-&gt;desc.bConfigurationValue
op_eq
id|TI_BOOT_CONFIG
)paren
(brace
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_tdev
suffix:semicolon
)brace
multiline_comment|/* set up port structures */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|tport
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ti_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_tports
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tport
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ti_port
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|tport-&gt;tp_lock
)paren
suffix:semicolon
id|tport-&gt;tp_uart_base_addr
op_assign
(paren
id|i
op_eq
l_int|0
ques
c_cond
id|TI_UART1_BASE_ADDR
suffix:colon
id|TI_UART2_BASE_ADDR
)paren
suffix:semicolon
id|tport-&gt;tp_flags
op_assign
id|low_latency
ques
c_cond
id|ASYNC_LOW_LATENCY
suffix:colon
l_int|0
suffix:semicolon
id|tport-&gt;tp_closing_wait
op_assign
id|closing_wait
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|tport-&gt;tp_msr_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|tport-&gt;tp_write_wait
)paren
suffix:semicolon
id|tport-&gt;tp_write_buf
op_assign
id|ti_buf_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport-&gt;tp_write_buf
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tport
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_tports
suffix:semicolon
)brace
id|tport-&gt;tp_port
op_assign
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|tport-&gt;tp_tdev
op_assign
id|tdev
suffix:semicolon
id|usb_set_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
id|i
)braket
comma
id|tport
)paren
suffix:semicolon
id|tport-&gt;tp_uart_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default is RS232 */
)brace
r_return
l_int|0
suffix:semicolon
id|free_tports
suffix:colon
r_for
c_loop
(paren
op_decrement
id|i
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
id|i
)braket
)paren
suffix:semicolon
id|ti_buf_free
c_func
(paren
id|tport-&gt;tp_write_buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tport
)paren
suffix:semicolon
id|usb_set_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|free_tdev
suffix:colon
id|kfree
c_func
(paren
id|tdev
)paren
suffix:semicolon
id|usb_set_serial_data
c_func
(paren
id|serial
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ti_shutdown
r_static
r_void
id|ti_shutdown
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ti_device
op_star
id|tdev
op_assign
id|usb_get_serial_data
c_func
(paren
id|serial
)paren
suffix:semicolon
r_struct
id|ti_port
op_star
id|tport
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
)paren
(brace
id|ti_buf_free
c_func
(paren
id|tport-&gt;tp_write_buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tport
)paren
suffix:semicolon
id|usb_set_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tdev
)paren
id|kfree
c_func
(paren
id|tdev
)paren
suffix:semicolon
id|usb_set_serial_data
c_func
(paren
id|serial
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|ti_open
r_static
r_int
id|ti_open
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|ti_device
op_star
id|tdev
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|port_number
suffix:semicolon
r_int
id|status
suffix:semicolon
id|__u16
id|open_settings
op_assign
(paren
id|__u8
)paren
(paren
id|TI_PIPE_MODE_CONTINOUS
op_or
id|TI_PIPE_TIMEOUT_ENABLE
op_or
(paren
id|TI_TRANSFER_TIMEOUT
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|tdev
op_assign
id|tport-&gt;tp_tdev
suffix:semicolon
multiline_comment|/* only one open on any port on a device at a time */
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|tdev-&gt;td_open_close_sem
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty
)paren
id|port-&gt;tty-&gt;low_latency
op_assign
(paren
id|tport-&gt;tp_flags
op_amp
id|ASYNC_LOW_LATENCY
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|port_number
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|tport-&gt;tp_icount
)paren
comma
l_int|0x00
comma
r_sizeof
(paren
id|tport-&gt;tp_icount
)paren
)paren
suffix:semicolon
id|tport-&gt;tp_msr
op_assign
l_int|0
suffix:semicolon
id|tport-&gt;tp_shadow_mcr
op_or_assign
(paren
id|TI_MCR_RTS
op_or
id|TI_MCR_DTR
)paren
suffix:semicolon
multiline_comment|/* start interrupt urb the first time a port is opened on this device */
r_if
c_cond
(paren
id|tdev-&gt;td_open_port_count
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - start interrupt in urb&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|urb
op_assign
id|tdev-&gt;td_serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_in_urb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - no interrupt urb&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|up_sem
suffix:semicolon
)brace
id|urb-&gt;complete
op_assign
id|ti_interrupt_callback
suffix:semicolon
id|urb-&gt;context
op_assign
id|tdev
suffix:semicolon
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - submit interrupt urb failed, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|up_sem
suffix:semicolon
)brace
)brace
id|ti_set_termios
c_func
(paren
id|port
comma
l_int|NULL
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - sending TI_OPEN_PORT&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tdev
comma
id|TI_OPEN_PORT
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
id|open_settings
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot send open command, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|unlink_int_urb
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - sending TI_START_PORT&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tdev
comma
id|TI_START_PORT
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot send start command, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|unlink_int_urb
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - sending TI_PURGE_PORT&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tdev
comma
id|TI_PURGE_PORT
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
id|TI_PURGE_INPUT
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot clear input buffers, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|unlink_int_urb
suffix:semicolon
)brace
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tdev
comma
id|TI_PURGE_PORT
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
id|TI_PURGE_OUTPUT
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot clear output buffers, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|unlink_int_urb
suffix:semicolon
)brace
multiline_comment|/* reset the data toggle on the bulk endpoints to work around bug in&n;&t; * host controllers where things get out of sync some times */
id|usb_clear_halt
c_func
(paren
id|dev
comma
id|port-&gt;write_urb-&gt;pipe
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|dev
comma
id|port-&gt;read_urb-&gt;pipe
)paren
suffix:semicolon
id|ti_set_termios
c_func
(paren
id|port
comma
l_int|NULL
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - sending TI_OPEN_PORT (2)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tdev
comma
id|TI_OPEN_PORT
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
id|open_settings
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot send open command (2), %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|unlink_int_urb
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - sending TI_START_PORT (2)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tdev
comma
id|TI_START_PORT
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot send start command (2), %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|unlink_int_urb
suffix:semicolon
)brace
multiline_comment|/* start read urb */
id|dbg
c_func
(paren
l_string|&quot;%s - start read urb&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|urb
op_assign
id|port-&gt;read_urb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - no read urb&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|unlink_int_urb
suffix:semicolon
)brace
id|tport-&gt;tp_read_urb_state
op_assign
id|TI_READ_URB_RUNNING
suffix:semicolon
id|urb-&gt;complete
op_assign
id|ti_bulk_in_callback
suffix:semicolon
id|urb-&gt;context
op_assign
id|tport
suffix:semicolon
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - submit read urb failed, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|unlink_int_urb
suffix:semicolon
)brace
id|tport-&gt;tp_is_open
op_assign
l_int|1
suffix:semicolon
op_increment
id|tdev-&gt;td_open_port_count
suffix:semicolon
r_goto
id|up_sem
suffix:semicolon
id|unlink_int_urb
suffix:colon
r_if
c_cond
(paren
id|tdev-&gt;td_open_port_count
op_eq
l_int|0
)paren
id|usb_kill_urb
c_func
(paren
id|port-&gt;serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_in_urb
)paren
suffix:semicolon
id|up_sem
suffix:colon
id|up
c_func
(paren
op_amp
id|tdev-&gt;td_open_close_sem
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - exit %d&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ti_close
r_static
r_void
id|ti_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|ti_device
op_star
id|tdev
suffix:semicolon
r_struct
id|ti_port
op_star
id|tport
suffix:semicolon
r_int
id|port_number
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|do_up
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|tdev
op_assign
id|usb_get_serial_data
c_func
(paren
id|port-&gt;serial
)paren
suffix:semicolon
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tdev
op_eq
l_int|NULL
op_logical_or
id|tport
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|tport-&gt;tp_is_open
op_assign
l_int|0
suffix:semicolon
id|ti_drain
c_func
(paren
id|tport
comma
(paren
id|tport-&gt;tp_closing_wait
op_star
id|HZ
)paren
op_div
l_int|100
comma
l_int|1
)paren
suffix:semicolon
id|usb_kill_urb
c_func
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
id|usb_kill_urb
c_func
(paren
id|port-&gt;write_urb
)paren
suffix:semicolon
id|tport-&gt;tp_write_urb_in_use
op_assign
l_int|0
suffix:semicolon
id|port_number
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - sending TI_CLOSE_PORT&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tdev
comma
id|TI_CLOSE_PORT
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot send close port command, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* if down is interrupted, continue anyway */
id|do_up
op_assign
op_logical_neg
id|down_interruptible
c_func
(paren
op_amp
id|tdev-&gt;td_open_close_sem
)paren
suffix:semicolon
op_decrement
id|tport-&gt;tp_tdev-&gt;td_open_port_count
suffix:semicolon
r_if
c_cond
(paren
id|tport-&gt;tp_tdev-&gt;td_open_port_count
op_le
l_int|0
)paren
(brace
multiline_comment|/* last port is closed, shut down interrupt urb */
id|usb_kill_urb
c_func
(paren
id|port-&gt;serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_in_urb
)paren
suffix:semicolon
id|tport-&gt;tp_tdev-&gt;td_open_port_count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_up
)paren
id|up
c_func
(paren
op_amp
id|tdev-&gt;td_open_close_sem
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - exit&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|ti_write
r_static
r_int
id|ti_write
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|count
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - write request of 0 bytes&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
op_logical_or
op_logical_neg
id|tport-&gt;tp_is_open
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
id|ti_buf_put
c_func
(paren
id|tport-&gt;tp_write_buf
comma
id|data
comma
id|count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|ti_send
c_func
(paren
id|tport
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|ti_write_room
r_static
r_int
id|ti_write_room
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|room
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|room
op_assign
id|ti_buf_space_avail
c_func
(paren
id|tport-&gt;tp_write_buf
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - returns %d&quot;
comma
id|__FUNCTION__
comma
id|room
)paren
suffix:semicolon
r_return
id|room
suffix:semicolon
)brace
DECL|function|ti_chars_in_buffer
r_static
r_int
id|ti_chars_in_buffer
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|chars
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|chars
op_assign
id|ti_buf_data_avail
c_func
(paren
id|tport-&gt;tp_write_buf
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - returns %d&quot;
comma
id|__FUNCTION__
comma
id|chars
)paren
suffix:semicolon
r_return
id|chars
suffix:semicolon
)brace
DECL|function|ti_throttle
r_static
r_void
id|ti_throttle
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - no tty&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
op_logical_or
id|C_CRTSCTS
c_func
(paren
id|tty
)paren
)paren
id|ti_stop_read
c_func
(paren
id|tport
comma
id|tty
)paren
suffix:semicolon
)brace
DECL|function|ti_unthrottle
r_static
r_void
id|ti_unthrottle
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - no tty&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
op_logical_or
id|C_CRTSCTS
c_func
(paren
id|tty
)paren
)paren
(brace
id|status
op_assign
id|ti_restart_read
c_func
(paren
id|tport
comma
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot restart read, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
)brace
DECL|function|ti_ioctl
r_static
r_int
id|ti_ioctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|async_icount
id|cnow
suffix:semicolon
r_struct
id|async_icount
id|cprev
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d, cmd = 0x%04X&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCGSERIAL
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCGSERIAL&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
id|ti_get_serial_info
c_func
(paren
id|tport
comma
(paren
r_struct
id|serial_struct
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCSSERIAL&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
id|ti_set_serial_info
c_func
(paren
id|tport
comma
(paren
r_struct
id|serial_struct
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMIWAIT
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCMIWAIT&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|cprev
op_assign
id|tport-&gt;tp_icount
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|tport-&gt;tp_msr_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|cnow
op_assign
id|tport-&gt;tp_icount
suffix:semicolon
r_if
c_cond
(paren
id|cnow.rng
op_eq
id|cprev.rng
op_logical_and
id|cnow.dsr
op_eq
id|cprev.dsr
op_logical_and
id|cnow.dcd
op_eq
id|cprev.dcd
op_logical_and
id|cnow.cts
op_eq
id|cprev.cts
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* no change =&gt; error */
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
)paren
op_logical_and
(paren
id|cnow.rng
op_ne
id|cprev.rng
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DSR
)paren
op_logical_and
(paren
id|cnow.dsr
op_ne
id|cprev.dsr
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
id|cnow.dcd
op_ne
id|cprev.dcd
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CTS
)paren
op_logical_and
(paren
id|cnow.cts
op_ne
id|cprev.cts
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|cprev
op_assign
id|cnow
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCGICOUNT
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCGICOUNT RX=%d, TX=%d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
comma
id|tport-&gt;tp_icount.rx
comma
id|tport-&gt;tp_icount.tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
op_amp
id|tport-&gt;tp_icount
comma
r_sizeof
(paren
id|tport-&gt;tp_icount
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|function|ti_set_termios
r_static
r_void
id|ti_set_termios
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_struct
id|ti_uart_config
op_star
id|config
suffix:semicolon
id|tcflag_t
id|cflag
comma
id|iflag
suffix:semicolon
r_int
id|baud
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|port_number
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
suffix:semicolon
r_int
r_int
id|mcr
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tty-&gt;termios
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - no tty or termios&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cflag
op_assign
id|tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|iflag
op_assign
id|tty-&gt;termios-&gt;c_iflag
suffix:semicolon
r_if
c_cond
(paren
id|old_termios
op_logical_and
id|cflag
op_eq
id|old_termios-&gt;c_cflag
op_logical_and
id|iflag
op_eq
id|old_termios-&gt;c_iflag
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nothing to change&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - clfag %08x, iflag %08x&quot;
comma
id|__FUNCTION__
comma
id|cflag
comma
id|iflag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_termios
)paren
id|dbg
c_func
(paren
l_string|&quot;%s - old clfag %08x, old iflag %08x&quot;
comma
id|__FUNCTION__
comma
id|old_termios-&gt;c_cflag
comma
id|old_termios-&gt;c_iflag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|config
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|config
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|config
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|config-&gt;wFlags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* these flags must be set */
id|config-&gt;wFlags
op_or_assign
id|TI_UART_ENABLE_MS_INTS
suffix:semicolon
id|config-&gt;wFlags
op_or_assign
id|TI_UART_ENABLE_AUTO_START_DMA
suffix:semicolon
id|config-&gt;bUartMode
op_assign
(paren
id|__u8
)paren
(paren
id|tport-&gt;tp_uart_mode
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|config-&gt;bDataBits
op_assign
id|TI_UART_5_DATA_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|config-&gt;bDataBits
op_assign
id|TI_UART_6_DATA_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|config-&gt;bDataBits
op_assign
id|TI_UART_7_DATA_BITS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|CS8
suffix:colon
id|config-&gt;bDataBits
op_assign
id|TI_UART_8_DATA_BITS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
(brace
id|config-&gt;wFlags
op_or_assign
id|TI_UART_ENABLE_PARITY_CHECKING
suffix:semicolon
id|config-&gt;bParity
op_assign
id|TI_UART_ODD_PARITY
suffix:semicolon
)brace
r_else
(brace
id|config-&gt;wFlags
op_or_assign
id|TI_UART_ENABLE_PARITY_CHECKING
suffix:semicolon
id|config-&gt;bParity
op_assign
id|TI_UART_EVEN_PARITY
suffix:semicolon
)brace
)brace
r_else
(brace
id|config-&gt;wFlags
op_and_assign
op_complement
id|TI_UART_ENABLE_PARITY_CHECKING
suffix:semicolon
id|config-&gt;bParity
op_assign
id|TI_UART_NO_PARITY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|config-&gt;bStopBits
op_assign
id|TI_UART_2_STOP_BITS
suffix:semicolon
r_else
id|config-&gt;bStopBits
op_assign
id|TI_UART_1_STOP_BITS
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
multiline_comment|/* RTS flow control must be off to drop RTS for baud rate B0 */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CBAUD
)paren
op_ne
id|B0
)paren
id|config-&gt;wFlags
op_or_assign
id|TI_UART_ENABLE_RTS_IN
suffix:semicolon
id|config-&gt;wFlags
op_or_assign
id|TI_UART_ENABLE_CTS_OUT
suffix:semicolon
)brace
r_else
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|ti_restart_read
c_func
(paren
id|tport
comma
id|tty
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
op_logical_or
id|I_IXON
c_func
(paren
id|tty
)paren
)paren
(brace
id|config-&gt;cXon
op_assign
id|START_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|config-&gt;cXoff
op_assign
id|STOP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|config-&gt;wFlags
op_or_assign
id|TI_UART_ENABLE_X_IN
suffix:semicolon
r_else
id|ti_restart_read
c_func
(paren
id|tport
comma
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|I_IXON
c_func
(paren
id|tty
)paren
)paren
id|config-&gt;wFlags
op_or_assign
id|TI_UART_ENABLE_X_OUT
suffix:semicolon
)brace
id|baud
op_assign
id|tty_get_baud_rate
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|baud
)paren
id|baud
op_assign
l_int|9600
suffix:semicolon
r_if
c_cond
(paren
id|tport-&gt;tp_tdev-&gt;td_is_3410
)paren
id|config-&gt;wBaudRate
op_assign
(paren
id|__u16
)paren
(paren
(paren
l_int|923077
op_plus
id|baud
op_div
l_int|2
)paren
op_div
id|baud
)paren
suffix:semicolon
r_else
id|config-&gt;wBaudRate
op_assign
(paren
id|__u16
)paren
(paren
(paren
l_int|461538
op_plus
id|baud
op_div
l_int|2
)paren
op_div
id|baud
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - BaudRate=%d, wBaudRate=%d, wFlags=0x%04X, bDataBits=%d, bParity=%d, bStopBits=%d, cXon=%d, cXoff=%d, bUartMode=%d&quot;
comma
id|__FUNCTION__
comma
id|baud
comma
id|config-&gt;wBaudRate
comma
id|config-&gt;wFlags
comma
id|config-&gt;bDataBits
comma
id|config-&gt;bParity
comma
id|config-&gt;bStopBits
comma
id|config-&gt;cXon
comma
id|config-&gt;cXoff
comma
id|config-&gt;bUartMode
)paren
suffix:semicolon
id|cpu_to_be16s
c_func
(paren
op_amp
id|config-&gt;wBaudRate
)paren
suffix:semicolon
id|cpu_to_be16s
c_func
(paren
op_amp
id|config-&gt;wFlags
)paren
suffix:semicolon
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tport-&gt;tp_tdev
comma
id|TI_SET_CONFIG
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
(paren
id|__u8
op_star
)paren
id|config
comma
r_sizeof
(paren
op_star
id|config
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot set config on port %d, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* SET_CONFIG asserts RTS and DTR, reset them correctly */
id|mcr
op_assign
id|tport-&gt;tp_shadow_mcr
suffix:semicolon
multiline_comment|/* if baud rate is B0, clear RTS and DTR */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CBAUD
)paren
op_eq
id|B0
)paren
id|mcr
op_and_assign
op_complement
(paren
id|TI_MCR_DTR
op_or
id|TI_MCR_RTS
)paren
suffix:semicolon
id|status
op_assign
id|ti_set_mcr
c_func
(paren
id|tport
comma
id|mcr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - cannot set modem control on port %d, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|status
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|config
)paren
suffix:semicolon
)brace
DECL|function|ti_tiocmget
r_static
r_int
id|ti_tiocmget
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|result
suffix:semicolon
r_int
r_int
id|msr
suffix:semicolon
r_int
r_int
id|mcr
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|msr
op_assign
id|tport-&gt;tp_msr
suffix:semicolon
id|mcr
op_assign
id|tport-&gt;tp_shadow_mcr
suffix:semicolon
id|result
op_assign
(paren
(paren
id|mcr
op_amp
id|TI_MCR_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|mcr
op_amp
id|TI_MCR_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|mcr
op_amp
id|TI_MCR_LOOP
)paren
ques
c_cond
id|TIOCM_LOOP
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|msr
op_amp
id|TI_MSR_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|msr
op_amp
id|TI_MSR_CD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|msr
op_amp
id|TI_MSR_RI
)paren
ques
c_cond
id|TIOCM_RI
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|msr
op_amp
id|TI_MSR_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - 0x%04X&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ti_tiocmset
r_static
r_int
id|ti_tiocmset
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|mcr
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|mcr
op_assign
id|tport-&gt;tp_shadow_mcr
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
)paren
id|mcr
op_or_assign
id|TI_MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DTR
)paren
id|mcr
op_or_assign
id|TI_MCR_DTR
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_LOOP
)paren
id|mcr
op_or_assign
id|TI_MCR_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
)paren
id|mcr
op_and_assign
op_complement
id|TI_MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DTR
)paren
id|mcr
op_and_assign
op_complement
id|TI_MCR_DTR
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_LOOP
)paren
id|mcr
op_and_assign
op_complement
id|TI_MCR_LOOP
suffix:semicolon
r_return
id|ti_set_mcr
c_func
(paren
id|tport
comma
id|mcr
)paren
suffix:semicolon
)brace
DECL|function|ti_break
r_static
r_void
id|ti_break
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - state = %d&quot;
comma
id|__FUNCTION__
comma
id|break_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|ti_drain
c_func
(paren
id|tport
comma
(paren
id|tport-&gt;tp_closing_wait
op_star
id|HZ
)paren
op_div
l_int|100
comma
l_int|0
)paren
suffix:semicolon
id|status
op_assign
id|ti_write_byte
c_func
(paren
id|tport-&gt;tp_tdev
comma
id|tport-&gt;tp_uart_base_addr
op_plus
id|TI_UART_OFFSET_LCR
comma
id|TI_LCR_BREAK
comma
id|break_state
op_eq
op_minus
l_int|1
ques
c_cond
id|TI_LCR_BREAK
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dbg
c_func
(paren
l_string|&quot;%s - error setting break, %d&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|ti_interrupt_callback
r_static
r_void
id|ti_interrupt_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ti_device
op_star
id|tdev
op_assign
(paren
r_struct
id|ti_device
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|tdev-&gt;td_serial
suffix:semicolon
r_struct
id|ti_port
op_star
id|tport
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|urb-&gt;dev-&gt;dev
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|length
op_assign
id|urb-&gt;actual_length
suffix:semicolon
r_int
id|port_number
suffix:semicolon
r_int
id|function
suffix:semicolon
r_int
id|status
suffix:semicolon
id|__u8
id|msr
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
op_minus
id|ECONNRESET
suffix:colon
r_case
op_minus
id|ENOENT
suffix:colon
r_case
op_minus
id|ESHUTDOWN
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - urb shutting down, %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|tdev-&gt;td_urb_error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - nonzero urb status, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|tdev-&gt;td_urb_error
op_assign
l_int|1
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
op_ne
l_int|2
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - bad packet size, %d&quot;
comma
id|__FUNCTION__
comma
id|length
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
id|TI_CODE_HARDWARE_ERROR
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - hardware error, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|port_number
op_assign
id|TI_GET_PORT_FROM_CODE
c_func
(paren
id|data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|function
op_assign
id|TI_GET_FUNC_FROM_CODE
c_func
(paren
id|data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port_number %d, function %d, data 0x%02X&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|function
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_number
op_ge
id|serial-&gt;num_ports
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - bad port number, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|port_number
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|port
op_assign
id|serial-&gt;port
(braket
id|port_number
)braket
suffix:semicolon
id|tport
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tport
)paren
r_goto
m_exit
suffix:semicolon
r_switch
c_cond
(paren
id|function
)paren
(brace
r_case
id|TI_CODE_DATA_ERROR
suffix:colon
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - DATA ERROR, port %d, data 0x%02X&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TI_CODE_MODEM_STATUS
suffix:colon
id|msr
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d, msr 0x%02X&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|msr
)paren
suffix:semicolon
id|ti_handle_new_msr
c_func
(paren
id|tport
comma
id|msr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - unknown interrupt code, 0x%02X&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
m_exit
suffix:colon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - resubmit interrupt urb failed, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|ti_bulk_in_callback
r_static
r_void
id|ti_bulk_in_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
(paren
r_struct
id|ti_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|tport-&gt;tp_port
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|urb-&gt;dev-&gt;dev
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
op_minus
id|ECONNRESET
suffix:colon
r_case
op_minus
id|ENOENT
suffix:colon
r_case
op_minus
id|ESHUTDOWN
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - urb shutting down, %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|tport-&gt;tp_tdev-&gt;td_urb_error
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tport-&gt;tp_write_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - nonzero urb status, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|tport-&gt;tp_tdev-&gt;td_urb_error
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tport-&gt;tp_write_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|EPIPE
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - stopping read!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port-&gt;tty
op_logical_and
id|urb-&gt;actual_length
)paren
(brace
id|usb_serial_debug_data
c_func
(paren
id|debug
comma
id|dev
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tport-&gt;tp_is_open
)paren
id|dbg
c_func
(paren
l_string|&quot;%s - port closed, dropping data&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_else
id|ti_recv
c_func
(paren
op_amp
id|urb-&gt;dev-&gt;dev
comma
id|port-&gt;tty
comma
id|urb-&gt;transfer_buffer
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|tport-&gt;tp_lock
)paren
suffix:semicolon
id|tport-&gt;tp_icount.rx
op_add_assign
id|urb-&gt;actual_length
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tport-&gt;tp_lock
)paren
suffix:semicolon
)brace
m_exit
suffix:colon
multiline_comment|/* continue to read unless stopping */
id|spin_lock
c_func
(paren
op_amp
id|tport-&gt;tp_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport-&gt;tp_read_urb_state
op_eq
id|TI_READ_URB_RUNNING
)paren
(brace
id|urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tport-&gt;tp_read_urb_state
op_eq
id|TI_READ_URB_STOPPING
)paren
(brace
id|tport-&gt;tp_read_urb_state
op_assign
id|TI_READ_URB_STOPPED
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|tport-&gt;tp_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - resubmit read urb failed, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|ti_bulk_out_callback
r_static
r_void
id|ti_bulk_out_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ti_port
op_star
id|tport
op_assign
(paren
r_struct
id|ti_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|tport-&gt;tp_port
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|urb-&gt;dev-&gt;dev
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|tport-&gt;tp_write_urb_in_use
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
op_minus
id|ECONNRESET
suffix:colon
r_case
op_minus
id|ENOENT
suffix:colon
r_case
op_minus
id|ESHUTDOWN
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - urb shutting down, %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|tport-&gt;tp_tdev-&gt;td_urb_error
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tport-&gt;tp_write_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - nonzero urb status, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|tport-&gt;tp_tdev-&gt;td_urb_error
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tport-&gt;tp_write_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* send any buffered data */
id|ti_send
c_func
(paren
id|tport
)paren
suffix:semicolon
)brace
DECL|function|ti_recv
r_static
r_void
id|ti_recv
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
op_star
id|data
comma
r_int
id|length
)paren
(brace
r_int
id|cnt
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - dropping data, %d bytes lost&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|length
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|cnt
op_assign
id|min
c_func
(paren
id|length
comma
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tty-&gt;flip.char_buf_ptr
comma
id|data
comma
id|cnt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
l_int|0
comma
id|cnt
)paren
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|cnt
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|cnt
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|cnt
suffix:semicolon
id|data
op_add_assign
id|cnt
suffix:semicolon
id|length
op_sub_assign
id|cnt
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|ti_send
r_static
r_void
id|ti_send
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
)paren
(brace
r_int
id|count
comma
id|result
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|tport-&gt;tp_port
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport-&gt;tp_write_urb_in_use
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|count
op_assign
id|ti_buf_get
c_func
(paren
id|tport-&gt;tp_write_buf
comma
id|port-&gt;write_urb-&gt;transfer_buffer
comma
id|port-&gt;bulk_out_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tport-&gt;tp_write_urb_in_use
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|usb_serial_debug_data
c_func
(paren
id|debug
comma
op_amp
id|port-&gt;dev
comma
id|__FUNCTION__
comma
id|count
comma
id|port-&gt;write_urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|usb_fill_bulk_urb
c_func
(paren
id|port-&gt;write_urb
comma
id|port-&gt;serial-&gt;dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|port-&gt;serial-&gt;dev
comma
id|port-&gt;bulk_out_endpointAddress
)paren
comma
id|port-&gt;write_urb-&gt;transfer_buffer
comma
id|count
comma
id|ti_bulk_out_callback
comma
id|tport
)paren
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;write_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - submit write urb failed, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
id|tport-&gt;tp_write_urb_in_use
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* TODO: reschedule ti_send */
)brace
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|tport-&gt;tp_icount.tx
op_add_assign
id|count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* more room in the buffer for new writes, wakeup */
r_if
c_cond
(paren
id|tty
)paren
id|tty_wakeup
c_func
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tport-&gt;tp_write_wait
)paren
suffix:semicolon
)brace
DECL|function|ti_set_mcr
r_static
r_int
id|ti_set_mcr
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_int
r_int
id|mcr
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|ti_write_byte
c_func
(paren
id|tport-&gt;tp_tdev
comma
id|tport-&gt;tp_uart_base_addr
op_plus
id|TI_UART_OFFSET_MCR
comma
id|TI_MCR_RTS
op_or
id|TI_MCR_DTR
op_or
id|TI_MCR_LOOP
comma
id|mcr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
id|tport-&gt;tp_shadow_mcr
op_assign
id|mcr
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ti_get_lsr
r_static
r_int
id|ti_get_lsr
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
)paren
(brace
r_int
id|size
comma
id|status
suffix:semicolon
r_struct
id|ti_device
op_star
id|tdev
op_assign
id|tport-&gt;tp_tdev
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|tport-&gt;tp_port
suffix:semicolon
r_int
id|port_number
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
suffix:semicolon
r_struct
id|ti_port_status
op_star
id|data
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|ti_port_status
)paren
suffix:semicolon
id|data
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|status
op_assign
id|ti_command_in_sync
c_func
(paren
id|tdev
comma
id|TI_GET_PORT_STATUS
comma
(paren
id|__u8
)paren
(paren
id|TI_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
(paren
id|__u8
op_star
)paren
id|data
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - get port status command failed, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_goto
id|free_data
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - lsr 0x%02X&quot;
comma
id|__FUNCTION__
comma
id|data-&gt;bLSR
)paren
suffix:semicolon
id|tport-&gt;tp_lsr
op_assign
id|data-&gt;bLSR
suffix:semicolon
id|free_data
suffix:colon
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ti_get_serial_info
r_static
r_int
id|ti_get_serial_info
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_struct
id|serial_struct
id|__user
op_star
id|ret_arg
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|tport-&gt;tp_port
suffix:semicolon
r_struct
id|serial_struct
id|ret_serial
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret_arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ret_serial
comma
l_int|0
comma
r_sizeof
(paren
id|ret_serial
)paren
)paren
suffix:semicolon
id|ret_serial.type
op_assign
id|PORT_16550A
suffix:semicolon
id|ret_serial.line
op_assign
id|port-&gt;serial-&gt;minor
suffix:semicolon
id|ret_serial.port
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
suffix:semicolon
id|ret_serial.flags
op_assign
id|tport-&gt;tp_flags
suffix:semicolon
id|ret_serial.xmit_fifo_size
op_assign
id|TI_WRITE_BUF_SIZE
suffix:semicolon
id|ret_serial.baud_base
op_assign
id|tport-&gt;tp_tdev-&gt;td_is_3410
ques
c_cond
l_int|921600
suffix:colon
l_int|460800
suffix:semicolon
id|ret_serial.closing_wait
op_assign
id|tport-&gt;tp_closing_wait
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ret_arg
comma
op_amp
id|ret_serial
comma
r_sizeof
(paren
op_star
id|ret_arg
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ti_set_serial_info
r_static
r_int
id|ti_set_serial_info
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_struct
id|serial_struct
id|__user
op_star
id|new_arg
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|tport-&gt;tp_port
suffix:semicolon
r_struct
id|serial_struct
id|new_serial
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|new_serial
comma
id|new_arg
comma
r_sizeof
(paren
id|new_serial
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|tport-&gt;tp_flags
op_assign
id|new_serial.flags
op_amp
id|TI_SET_SERIAL_FLAGS
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty
)paren
id|port-&gt;tty-&gt;low_latency
op_assign
(paren
id|tport-&gt;tp_flags
op_amp
id|ASYNC_LOW_LATENCY
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|tport-&gt;tp_closing_wait
op_assign
id|new_serial.closing_wait
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ti_handle_new_msr
r_static
r_void
id|ti_handle_new_msr
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
id|__u8
id|msr
)paren
(brace
r_struct
id|async_icount
op_star
id|icount
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - msr 0x%02X&quot;
comma
id|__FUNCTION__
comma
id|msr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
id|TI_MSR_DELTA_MASK
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|icount
op_assign
op_amp
id|tport-&gt;tp_icount
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
id|TI_MSR_DELTA_CTS
)paren
id|icount-&gt;cts
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
id|TI_MSR_DELTA_DSR
)paren
id|icount-&gt;dsr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
id|TI_MSR_DELTA_CD
)paren
id|icount-&gt;dcd
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
id|TI_MSR_DELTA_RI
)paren
id|icount-&gt;rng
op_increment
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tport-&gt;tp_msr_wait
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|tport-&gt;tp_msr
op_assign
id|msr
op_amp
id|TI_MSR_MASK
suffix:semicolon
multiline_comment|/* handle CTS flow control */
id|tty
op_assign
id|tport-&gt;tp_port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_logical_and
id|C_CRTSCTS
c_func
(paren
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|msr
op_amp
id|TI_MSR_CTS
)paren
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|tty_wakeup
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
DECL|function|ti_drain
r_static
r_void
id|ti_drain
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_int
r_int
id|timeout
comma
r_int
id|flush
)paren
(brace
r_struct
id|ti_device
op_star
id|tdev
op_assign
id|tport-&gt;tp_tdev
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
op_assign
id|tport-&gt;tp_port
suffix:semicolon
id|wait_queue_t
id|wait
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* wait for data to drain from the buffer */
id|tdev-&gt;td_urb_error
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_entry
c_func
(paren
op_amp
id|wait
comma
id|current
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|tport-&gt;tp_write_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti_buf_data_avail
c_func
(paren
id|tport-&gt;tp_write_buf
)paren
op_eq
l_int|0
op_logical_or
id|timeout
op_eq
l_int|0
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_or
id|tdev-&gt;td_urb_error
op_logical_or
op_logical_neg
id|usb_get_intfdata
c_func
(paren
id|port-&gt;serial-&gt;interface
)paren
)paren
multiline_comment|/* disconnect */
r_break
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
id|timeout
op_assign
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|tport-&gt;tp_write_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
multiline_comment|/* flush any remaining data in the buffer */
r_if
c_cond
(paren
id|flush
)paren
id|ti_buf_clear
c_func
(paren
id|tport-&gt;tp_write_buf
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* wait for data to drain from the device */
multiline_comment|/* wait for empty tx register, plus 20 ms */
id|timeout
op_add_assign
id|jiffies
suffix:semicolon
id|tport-&gt;tp_lsr
op_and_assign
op_complement
id|TI_LSR_TX_EMPTY
suffix:semicolon
r_while
c_loop
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OL
l_int|0
op_logical_and
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_and
op_logical_neg
(paren
id|tport-&gt;tp_lsr
op_amp
id|TI_LSR_TX_EMPTY
)paren
op_logical_and
op_logical_neg
id|tdev-&gt;td_urb_error
op_logical_and
id|usb_get_intfdata
c_func
(paren
id|port-&gt;serial-&gt;interface
)paren
)paren
(brace
multiline_comment|/* not disconnected */
r_if
c_cond
(paren
id|ti_get_lsr
c_func
(paren
id|tport
)paren
)paren
r_break
suffix:semicolon
id|msleep_interruptible
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
)brace
DECL|function|ti_stop_read
r_static
r_void
id|ti_stop_read
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport-&gt;tp_read_urb_state
op_eq
id|TI_READ_URB_RUNNING
)paren
id|tport-&gt;tp_read_urb_state
op_assign
id|TI_READ_URB_STOPPING
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ti_restart_read
r_static
r_int
id|ti_restart_read
c_func
(paren
r_struct
id|ti_port
op_star
id|tport
comma
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tport-&gt;tp_read_urb_state
op_eq
id|TI_READ_URB_STOPPED
)paren
(brace
id|urb
op_assign
id|tport-&gt;tp_port-&gt;read_urb
suffix:semicolon
id|urb-&gt;complete
op_assign
id|ti_bulk_in_callback
suffix:semicolon
id|urb-&gt;context
op_assign
id|tport
suffix:semicolon
id|urb-&gt;dev
op_assign
id|tport-&gt;tp_port-&gt;serial-&gt;dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
id|tport-&gt;tp_read_urb_state
op_assign
id|TI_READ_URB_RUNNING
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tport-&gt;tp_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ti_command_out_sync
r_static
r_int
id|ti_command_out_sync
c_func
(paren
r_struct
id|ti_device
op_star
id|tdev
comma
id|__u8
id|command
comma
id|__u16
id|moduleid
comma
id|__u16
id|value
comma
id|__u8
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|usb_control_msg
c_func
(paren
id|tdev-&gt;td_serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|tdev-&gt;td_serial-&gt;dev
comma
l_int|0
)paren
comma
id|command
comma
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
op_or
id|USB_DIR_OUT
)paren
comma
id|value
comma
id|moduleid
comma
id|data
comma
id|size
comma
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|size
)paren
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
id|status
op_assign
op_minus
id|ECOMM
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ti_command_in_sync
r_static
r_int
id|ti_command_in_sync
c_func
(paren
r_struct
id|ti_device
op_star
id|tdev
comma
id|__u8
id|command
comma
id|__u16
id|moduleid
comma
id|__u16
id|value
comma
id|__u8
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|usb_control_msg
c_func
(paren
id|tdev-&gt;td_serial-&gt;dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|tdev-&gt;td_serial-&gt;dev
comma
l_int|0
)paren
comma
id|command
comma
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
op_or
id|USB_DIR_IN
)paren
comma
id|value
comma
id|moduleid
comma
id|data
comma
id|size
comma
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|size
)paren
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
id|status
op_assign
op_minus
id|ECOMM
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ti_write_byte
r_static
r_int
id|ti_write_byte
c_func
(paren
r_struct
id|ti_device
op_star
id|tdev
comma
r_int
r_int
id|addr
comma
id|__u8
id|mask
comma
id|__u8
id|byte
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_struct
id|ti_write_data_bytes
op_star
id|data
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|tdev-&gt;td_serial-&gt;dev-&gt;dev
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - addr 0x%08lX, mask 0x%02X, byte 0x%02X&quot;
comma
id|__FUNCTION__
comma
id|addr
comma
id|mask
comma
id|byte
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|ti_write_data_bytes
)paren
op_plus
l_int|2
suffix:semicolon
id|data
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|data-&gt;bAddrType
op_assign
id|TI_RW_DATA_ADDR_XDATA
suffix:semicolon
id|data-&gt;bDataType
op_assign
id|TI_RW_DATA_BYTE
suffix:semicolon
id|data-&gt;bDataCounter
op_assign
l_int|1
suffix:semicolon
id|data-&gt;wBaseAddrHi
op_assign
id|cpu_to_be16
c_func
(paren
id|addr
op_rshift
l_int|16
)paren
suffix:semicolon
id|data-&gt;wBaseAddrLo
op_assign
id|cpu_to_be16
c_func
(paren
id|addr
)paren
suffix:semicolon
id|data-&gt;bData
(braket
l_int|0
)braket
op_assign
id|mask
suffix:semicolon
id|data-&gt;bData
(braket
l_int|1
)braket
op_assign
id|byte
suffix:semicolon
id|status
op_assign
id|ti_command_out_sync
c_func
(paren
id|tdev
comma
id|TI_WRITE_DATA
comma
id|TI_RAM_PORT
comma
l_int|0
comma
(paren
id|__u8
op_star
)paren
id|data
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s - failed, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|ti_download_firmware
r_static
r_int
id|ti_download_firmware
c_func
(paren
r_struct
id|ti_device
op_star
id|tdev
comma
r_int
r_char
op_star
id|firmware
comma
r_int
r_int
id|firmware_size
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|buffer_size
suffix:semicolon
r_int
id|pos
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|done
suffix:semicolon
id|__u8
id|cs
op_assign
l_int|0
suffix:semicolon
id|__u8
op_star
id|buffer
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|tdev-&gt;td_serial-&gt;dev
suffix:semicolon
r_struct
id|ti_firmware_header
op_star
id|header
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|usb_sndbulkpipe
c_func
(paren
id|dev
comma
id|tdev-&gt;td_serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|bulk_out_endpointAddress
)paren
suffix:semicolon
id|buffer_size
op_assign
id|TI_FIRMWARE_BUF_SIZE
op_plus
r_sizeof
(paren
r_struct
id|ti_firmware_header
)paren
suffix:semicolon
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|buffer_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buffer
comma
id|firmware
comma
id|firmware_size
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buffer
op_plus
id|firmware_size
comma
l_int|0xff
comma
id|buffer_size
op_minus
id|firmware_size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pos
op_assign
r_sizeof
(paren
r_struct
id|ti_firmware_header
)paren
suffix:semicolon
id|pos
OL
id|buffer_size
suffix:semicolon
id|pos
op_increment
)paren
(brace
id|cs
op_assign
(paren
id|__u8
)paren
(paren
id|cs
op_plus
id|buffer
(braket
id|pos
)braket
)paren
suffix:semicolon
)brace
id|header
op_assign
(paren
r_struct
id|ti_firmware_header
op_star
)paren
id|buffer
suffix:semicolon
id|header-&gt;wLength
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|__u16
)paren
(paren
id|buffer_size
op_minus
r_sizeof
(paren
r_struct
id|ti_firmware_header
)paren
)paren
)paren
suffix:semicolon
id|header-&gt;bCheckSum
op_assign
id|cs
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - downloading firmware&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pos
op_assign
l_int|0
suffix:semicolon
id|pos
OL
id|buffer_size
suffix:semicolon
id|pos
op_add_assign
id|done
)paren
(brace
id|len
op_assign
id|min
c_func
(paren
id|buffer_size
op_minus
id|pos
comma
id|TI_DOWNLOAD_MAX_PACKET_SIZE
)paren
suffix:semicolon
id|status
op_assign
id|usb_bulk_msg
c_func
(paren
id|dev
comma
id|pipe
comma
id|buffer
op_plus
id|pos
comma
id|len
comma
op_amp
id|done
comma
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s - error downloading firmware, %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - download successful&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Circular Buffer Functions */
multiline_comment|/*&n; * ti_buf_alloc&n; *&n; * Allocate a circular buffer and all associated memory.&n; */
DECL|function|ti_buf_alloc
r_static
r_struct
id|circ_buf
op_star
id|ti_buf_alloc
c_func
(paren
r_void
)paren
(brace
r_struct
id|circ_buf
op_star
id|cb
suffix:semicolon
id|cb
op_assign
(paren
r_struct
id|circ_buf
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|circ_buf
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cb
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|cb-&gt;buf
op_assign
id|kmalloc
c_func
(paren
id|TI_WRITE_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cb-&gt;buf
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|cb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ti_buf_clear
c_func
(paren
id|cb
)paren
suffix:semicolon
r_return
id|cb
suffix:semicolon
)brace
multiline_comment|/*&n; * ti_buf_free&n; *&n; * Free the buffer and all associated memory.&n; */
DECL|function|ti_buf_free
r_static
r_void
id|ti_buf_free
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
)paren
(brace
id|kfree
c_func
(paren
id|cb-&gt;buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ti_buf_clear&n; *&n; * Clear out all data in the circular buffer.&n; */
DECL|function|ti_buf_clear
r_static
r_void
id|ti_buf_clear
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
)paren
(brace
id|cb-&gt;head
op_assign
id|cb-&gt;tail
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ti_buf_data_avail&n; *&n; * Return the number of bytes of data available in the circular&n; * buffer.&n; */
DECL|function|ti_buf_data_avail
r_static
r_int
id|ti_buf_data_avail
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
)paren
(brace
r_return
id|CIRC_CNT
c_func
(paren
id|cb-&gt;head
comma
id|cb-&gt;tail
comma
id|TI_WRITE_BUF_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ti_buf_space_avail&n; *&n; * Return the number of bytes of space available in the circular&n; * buffer.&n; */
DECL|function|ti_buf_space_avail
r_static
r_int
id|ti_buf_space_avail
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
)paren
(brace
r_return
id|CIRC_SPACE
c_func
(paren
id|cb-&gt;head
comma
id|cb-&gt;tail
comma
id|TI_WRITE_BUF_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ti_buf_put&n; *&n; * Copy data data from a user buffer and put it into the circular buffer.&n; * Restrict to the amount of space available.&n; *&n; * Return the number of bytes copied.&n; */
DECL|function|ti_buf_put
r_static
r_int
id|ti_buf_put
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|c
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c
op_assign
id|CIRC_SPACE_TO_END
c_func
(paren
id|cb-&gt;head
comma
id|cb-&gt;tail
comma
id|TI_WRITE_BUF_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|c
)paren
id|c
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|memcpy
c_func
(paren
id|cb-&gt;buf
op_plus
id|cb-&gt;head
comma
id|buf
comma
id|c
)paren
suffix:semicolon
id|cb-&gt;head
op_assign
(paren
id|cb-&gt;head
op_plus
id|c
)paren
op_amp
(paren
id|TI_WRITE_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|buf
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|ret
op_add_assign
id|c
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * ti_buf_get&n; *&n; * Get data from the circular buffer and copy to the given buffer.&n; * Restrict to the amount of data available.&n; *&n; * Return the number of bytes copied.&n; */
DECL|function|ti_buf_get
r_static
r_int
id|ti_buf_get
c_func
(paren
r_struct
id|circ_buf
op_star
id|cb
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|c
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c
op_assign
id|CIRC_CNT_TO_END
c_func
(paren
id|cb-&gt;head
comma
id|cb-&gt;tail
comma
id|TI_WRITE_BUF_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|c
)paren
id|c
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|cb-&gt;buf
op_plus
id|cb-&gt;tail
comma
id|c
)paren
suffix:semicolon
id|cb-&gt;tail
op_assign
(paren
id|cb-&gt;tail
op_plus
id|c
)paren
op_amp
(paren
id|TI_WRITE_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|buf
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|ret
op_add_assign
id|c
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
eof
